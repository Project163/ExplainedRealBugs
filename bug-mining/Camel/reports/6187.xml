<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:56:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-18255] Memory Leak with MDCUnitOfWork</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-18255</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;We realized a sever memory leak in a standard route:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I reproduced it and made a simple MemoryAllocation Check.&lt;/p&gt;

&lt;p&gt;Just for curiosity i made another test with:&#160; (&lt;font color=&quot;#00875a&quot;&gt;.errorhandler(no errorhandler)&lt;/font&gt;) and the memory leak does not occure.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Sample route to reproduce:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;from(&quot;scheduler:testScheduler?repeatCount=1&quot;)&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; .log(&quot;Starting route test-route&quot;)&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; .process(exchange -&amp;gt; {&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; Iterator&amp;lt;String&amp;gt; infiniteIter = new Iterator&amp;lt;&amp;gt;() {&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; private int integer = 0;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; @Override public boolean hasNext()&lt;/p&gt;

{ &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; return true; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; }

&lt;p&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; @Override public String next()&lt;/p&gt;

{ &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; return String.valueOf(integer++); &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; }

&lt;p&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; };&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; exchange.getMessage().setBody(infiniteIter);&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; })&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; .split().body().streaming()&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; .log(&quot;inside split: ${body}&quot;)&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; .end()&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; .log(&quot;test-route never finishes&quot;);&lt;/p&gt;</description>
                <environment></environment>
        <key id="13469690">CAMEL-18255</key>
            <summary>Memory Leak with MDCUnitOfWork</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="rambichler">Michael Rambichler</reporter>
                        <labels>
                    </labels>
                <created>Fri, 1 Jul 2022 15:51:33 +0000</created>
                <updated>Sat, 29 Oct 2022 06:43:22 +0000</updated>
                            <resolved>Mon, 18 Jul 2022 08:18:37 +0000</resolved>
                                    <version>3.14.1</version>
                    <version>3.17.0</version>
                                    <fixVersion>3.14.6</fixVersion>
                    <fixVersion>3.18.4</fixVersion>
                    <fixVersion>3.19.0</fixVersion>
                                    <component>camel-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17561555" author="davsclaus" created="Fri, 1 Jul 2022 17:08:00 +0000"  >&lt;p&gt;Can you maybe put together this as an unit test or something that is ready to try so we can more quickly jump on this&lt;/p&gt;</comment>
                            <comment id="17561562" author="davsclaus" created="Fri, 1 Jul 2022 17:30:48 +0000"  >&lt;p&gt;I cannot reproduce any leak with your sample route above. The objects are allocated but can be GC so you can go down to &amp;lt; 30mb when GC kicks in.&lt;/p&gt;</comment>
                            <comment id="17561567" author="davsclaus" created="Fri, 1 Jul 2022 17:38:51 +0000"  >&lt;p&gt;Running as unit test then there is some additonal overhead with the NotifyBuilder that comes out of the box with camel-core tests, but these objects are not leaking.&lt;/p&gt;</comment>
                            <comment id="17561592" author="rambichler" created="Fri, 1 Jul 2022 19:20:29 +0000"  >&lt;p&gt;I have added a example project in github: &lt;a href=&quot;https://github.com/michael-salzburg/splitMemoryTest.git&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/michael-salzburg/splitMemoryTest.git&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The issue is the mdc logging:&#160;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#FF0000&quot;&gt;camel.springboot.use-mdc-logging=true&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;Without: Memory Consumption around 100MB. with mdc-logging=true Consumption goes up till END. GC does not work.&lt;/p&gt;</comment>
                            <comment id="17561608" author="davsclaus" created="Fri, 1 Jul 2022 20:22:47 +0000"  >&lt;p&gt;Thanks for spotting its MDC - MDC is low priority and candidate for deprecation and removal in the future.&lt;/p&gt;</comment>
                            <comment id="17561919" author="rambichler" created="Sun, 3 Jul 2022 18:25:05 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;The issue is quite independent of MDC.&lt;/p&gt;

&lt;p&gt;See my example in &lt;a href=&quot;https://github.com/michael-salzburg/splitMemoryTest.git&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/michael-salzburg/splitMemoryTest.git&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I spend some time to analyse it further:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;If you override the method of the DefaultUnitOfWork or MDCUnitOfWork and return &lt;font color=&quot;#de350b&quot;&gt;true&lt;/font&gt;: Then the Memory Leak occurs.&#160;&lt;/p&gt;

&lt;p&gt;@Override&lt;br/&gt;
public boolean isBeforeAfterProcess() {&lt;br/&gt;
&lt;font color=&quot;#de350b&quot;&gt;return true; //like its set e.g. in MDCUnitOfWork&lt;/font&gt;&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The current MDCUnitOfWork returns true in this case.&lt;/p&gt;

&lt;p&gt;But i wasn&apos;t able to analyse the impact in deep of this change, yet.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Btw. You mentioned MDC is low prio/candidate for dprecation: We use MDC logging of especially the breadcrumbId heavily in our system. That would have major impact in our environment.&lt;/p&gt;</comment>
                            <comment id="17563245" author="klease78" created="Wed, 6 Jul 2022 13:49:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rambichler&quot; class=&quot;user-hover&quot; rel=&quot;rambichler&quot;&gt;rambichler&lt;/a&gt; The root of the problem seems to be in these lines: &lt;a href=&quot;https://github.com/apache/camel/blob/8f94758145dd26e52b335da6765c46a9d0b95482/core/camel-base-engine/src/main/java/org/apache/camel/impl/engine/CamelInternalProcessor.java#L405-L411&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CamelInternalProcessor.java#L405-L411&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This puts a lambda to run the afterProcess method on the queue of the ReactiveExecutor. Each Exchange produced by the splitter is wrapped in a DefaultErrorHandler but there is already a DefaultErrorHandler wrapping the processor(s) following the split(). The ErrorHandler queues a SimpleTask using scheduleMain which backs up any other elements on the queue to a backup queue. The sequence is a bit difficult to follow but the end result is that the backed-up queue containing the lambda to run the MDCUnitOfWork.afterProcess() method is not run when the processing of the Exchange finishes but only when all Exchanges produced by the split() have been processed. Then they are all run, but in the reverse order in which they where added to the scheduler! This causes the memory leak.&lt;/p&gt;

&lt;p&gt;The use of the scheduler to run afterProcess() was added back in &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-17153&quot; title=&quot;afterprocess of UnitOfWork doesn&amp;#39;t work properly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-17153&quot;&gt;&lt;del&gt;CAMEL-17153&lt;/del&gt;&lt;/a&gt; to resolve a problem caused by removing it in &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-16034&quot; title=&quot;MDC Logging causing OutOfMemory with large split&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-16034&quot;&gt;&lt;del&gt;CAMEL-16034&lt;/del&gt;&lt;/a&gt; (which is exactly the problem you are experiencing.)&lt;/p&gt;

&lt;p&gt;I think it might work to invoke the uow.afterProcess() in the async callback itself, since that task is run at the correct point in the process, so I&apos;m going to test this approach.&lt;/p&gt;</comment>
                            <comment id="17563253" author="rambichler" created="Wed, 6 Jul 2022 14:12:02 +0000"  >&lt;p&gt;Great &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=klease78&quot; class=&quot;user-hover&quot; rel=&quot;klease78&quot;&gt;klease78&lt;/a&gt; for this analysis. I got stucked in debugging at exactly your position.&lt;/p&gt;</comment>
                            <comment id="17563312" author="klease78" created="Wed, 6 Jul 2022 15:52:02 +0000"  >&lt;p&gt;Unfortunately my idea fixes your issue but causes test failures, so I need to search for a better solution.&lt;/p&gt;</comment>
                            <comment id="17624325" author="rastislav.papp" created="Wed, 26 Oct 2022 09:42:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=klease78&quot; class=&quot;user-hover&quot; rel=&quot;klease78&quot;&gt;klease78&lt;/a&gt;, could we get a fix for 3.14.x LTS?&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="13352238">CAMEL-16034</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13409319">CAMEL-17153</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13046165" name="Screenshot 2022-07-01 at 19.30.44.png" size="365015" author="davsclaus" created="Fri, 1 Jul 2022 17:30:57 +0000"/>
                            <attachment id="13046167" name="screenshot-1.png" size="46141" author="rambichler" created="Fri, 1 Jul 2022 19:24:32 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 3 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z16jig:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>