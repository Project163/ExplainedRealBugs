<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:47:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-16567] Mocking of consul producers fails</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-16567</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;It is not possible to mock consul producers, at least I have tried with the catalog and agent producers. Test:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;MockAgentTest &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; CamelTestSupport {

    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testMockAgent() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        MockEndpoint mockConsulAgent = getMockEndpoint(&lt;span class=&quot;code-quote&quot;&gt;&quot;mock:consul:agent&quot;&lt;/span&gt;);

        AdviceWith.adviceWith(context, &lt;span class=&quot;code-quote&quot;&gt;&quot;servicesRoute&quot;&lt;/span&gt;, a -&amp;gt; {
            a.mockEndpointsAndSkip(&lt;span class=&quot;code-quote&quot;&gt;&quot;consul:agent*&quot;&lt;/span&gt;);
        });
        mockConsulAgent.returnReplyBody(constant(ImmutableMap.of(&lt;span class=&quot;code-quote&quot;&gt;&quot;foo-1&quot;&lt;/span&gt;, ImmutableService.builder()
            .id(&lt;span class=&quot;code-quote&quot;&gt;&quot;foo-1&quot;&lt;/span&gt;)
            .service(&lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt;)
            .address(&lt;span class=&quot;code-quote&quot;&gt;&quot;localhost&quot;&lt;/span&gt;)
            .port(80)
            .build())));

        @SuppressWarnings(&lt;span class=&quot;code-quote&quot;&gt;&quot;unchecked&quot;&lt;/span&gt;)
        Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, Service&amp;gt; result = fluentTemplate.to(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:start&quot;&lt;/span&gt;).request(Map.class);
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; RoutesBuilder createRouteBuilder() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RouteBuilder() {
            @Override
            &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void configure() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
                from(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:start&quot;&lt;/span&gt;).to(&lt;span class=&quot;code-quote&quot;&gt;&quot;consul:agent?action=&quot;&lt;/span&gt; + ConsulAgentActions.SERVICES);
            }
        };
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Error:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
org.apache.camel.FailedToStartRouteException: Failed to start route servicesRoute because of &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
 at org.apache.camel.impl.engine.RouteService.warmUp(RouteService.java:123) 
...
Caused by: java.lang.NullPointerException at org.apache.camel.support.HeaderSelectorProducer.doBuild(HeaderSelectorProducer.java:150) at org.apache.camel.support.service.BaseService.build(BaseService.java:63) at org.apache.camel.support.service.ServiceHelper.buildService(ServiceHelper.java:55) at org.apache.camel.support.service.ServiceHelper.buildService(ServiceHelper.java:72) at org.apache.camel.processor.InterceptSendToEndpointProcessor.doBuild(InterceptSendToEndpointProcessor.java:151) at org.apache.camel.support.service.BaseService.build(BaseService.java:63) at org.apache.camel.support.service.BaseService.init(BaseService.java:79) at org.apache.camel.support.service.BaseService.start(BaseService.java:111) at org.apache.camel.support.service.ServiceHelper.startService(ServiceHelper.java:113) at org.apache.camel.impl.engine.AbstractCamelContext.internalAddService(AbstractCamelContext.java:1465) at org.apache.camel.impl.engine.AbstractCamelContext.addService(AbstractCamelContext.java:1383) at org.apache.camel.processor.SendProcessor.doStart(SendProcessor.java:247) at org.apache.camel.support.service.BaseService.start(BaseService.java:119) at org.apache.camel.support.service.ServiceHelper.startService(ServiceHelper.java:113) at org.apache.camel.support.service.ServiceHelper.startService(ServiceHelper.java:130) at org.apache.camel.processor.errorhandler.RedeliveryErrorHandler.doStart(RedeliveryErrorHandler.java:1638) at org.apache.camel.support.ChildServiceSupport.start(ChildServiceSupport.java:60) ... 92 more&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The reason is that &lt;tt&gt;camelContext&lt;/tt&gt; is &lt;tt&gt;null&lt;/tt&gt;&#160;in &lt;tt&gt;HeaderSelectorProducer&lt;/tt&gt;, but I am still unsure why that is:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Override
&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void doBuild() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.doBuild();

    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; key = &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.getClass().getName();
    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; fqn = RESOURCE_PATH + key;
    &lt;span class=&quot;code-comment&quot;&gt;// -------- camelContext is &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; here:
&lt;/span&gt;    strategy = camelContext.adapt(ExtendedCamelContext.class).getBootstrapFactoryFinder(RESOURCE_PATH)
            .newInstance(key, InvokeOnHeaderStrategy.class)
            .orElseThrow(() -&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IllegalArgumentException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Cannot find &quot;&lt;/span&gt; + fqn + &lt;span class=&quot;code-quote&quot;&gt;&quot; in classpath.&quot;&lt;/span&gt;)); 
    ...&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Same with catalog:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;MockCatalogTest &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; CamelTestSupport {

    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testMockCatalog() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        MockEndpoint mockConsulAgent = getMockEndpoint(&lt;span class=&quot;code-quote&quot;&gt;&quot;mock:consul:catalog&quot;&lt;/span&gt;);

        AdviceWith.adviceWith(context, &lt;span class=&quot;code-quote&quot;&gt;&quot;servicesRoute&quot;&lt;/span&gt;, a -&amp;gt; {
            a.mockEndpointsAndSkip(&lt;span class=&quot;code-quote&quot;&gt;&quot;consul:catalog*&quot;&lt;/span&gt;);
        });
        mockConsulAgent.returnReplyBody(constant(singletonList(ImmutableNode.builder().node(&lt;span class=&quot;code-quote&quot;&gt;&quot;node-1&quot;&lt;/span&gt;).build())));

        @SuppressWarnings(&lt;span class=&quot;code-quote&quot;&gt;&quot;unchecked&quot;&lt;/span&gt;)
        Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, Service&amp;gt; result = fluentTemplate.to(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:start&quot;&lt;/span&gt;).request(Map.class);
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; RoutesBuilder createRouteBuilder() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RouteBuilder() {
            @Override
            &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void configure() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
                from(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:start&quot;&lt;/span&gt;).to(&lt;span class=&quot;code-quote&quot;&gt;&quot;consul:catalog?action=&quot;&lt;/span&gt; + ConsulCatalogActions.LIST_NODES);
            }
        };
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Why this fails is not clear to me. Two instances of &lt;tt&gt;ConsulAgentProducer&lt;/tt&gt;&#160;are being created. At runtime the method &lt;tt&gt;setCamelContext&lt;/tt&gt; of the failing instance never gets called, although it is a &lt;tt&gt;CamelContextAware&lt;/tt&gt;. I suspect that it is the mock or the real object behind the mock which is not a &lt;tt&gt;CamelContextAware&lt;/tt&gt; so that it receives no &lt;tt&gt;camelContext&lt;/tt&gt;. My assumption is that a mock is a kind of wrapper around the real thing, but I wasn&apos;t able to understand the relationship between the two enough to fix this. The instances look very similar, the failing instance appears not to be a Java proxy.&lt;/p&gt;

&lt;p&gt;Anyone who understands the mocking mechanics better than me: what might go wrong here? Any hints how it &lt;b&gt;should&lt;/b&gt; work? Is the mock a proxy or what exactly is the relationship between mock and mocked?&lt;/p&gt;

&lt;p&gt;&lt;b&gt;UPDATE&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;The failing instance is the delegate &lt;tt&gt;ConsulAgentProducer&lt;/tt&gt;&#160;inside an &lt;tt&gt;InterceptSendToEndpointProcessor&lt;/tt&gt;. The latter is not a &lt;tt&gt;CamelContextAware&lt;/tt&gt;, hence it receives no &lt;tt&gt;camelContext.&lt;/tt&gt;&#160;I see two different approaches:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;The delegate inside the &lt;tt&gt;InterceptSendToEndpointProcessor&lt;/tt&gt;&#160;could be made to receive a camelContext, e.g. by making the &lt;tt&gt;InterceptSendToEndpointProcess&lt;/tt&gt; a &lt;tt&gt;CamelContextAware&lt;/tt&gt;&#160;and setting the &lt;tt&gt;camelContext&lt;/tt&gt;&#160;on the delegate&lt;/li&gt;
	&lt;li&gt;The method invocation&#160;&lt;tt&gt;HeaderSelectorProducer.doBuild()&lt;/tt&gt;&#160;could be skipped somehow&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Advice would be very much appreciated.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;UPDATE 2&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;Turns out, it is not the &lt;tt&gt;delegate&lt;/tt&gt;&#160;(ConsulEndpoint) member nor the &lt;tt&gt;endpoint&lt;/tt&gt;&#160;(DefaultInterceptorSendToEndpoint) member inside InterceptSendToEndpointProcessor which has no CamelContext, but the &lt;tt&gt;producer&lt;/tt&gt;&#160;(ConsulAgentProducer) member, which holds a second instance of the producer. Again, two approaches:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Let InterceptSendToEndpointProcessor set the camelContext on the producer when it receives the camelContext.&lt;/li&gt;
	&lt;li&gt;Find out why the second producer inside InterceptSendToEndpointProcessor does not receive a camelContext when it gets constructed&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&lt;b&gt;UPDATE 3&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;DefaultInterceptSendToEndpoint is responsible to create the producer in createAsyncProducer. One could call camelContext.addService(producer) there, in order to initialize the delegate producer like any other component. It does fix the problem, but I am unsure if the delegate producer should be added as a service or if it is the whole point not to add it.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;DefaultInterceptSendToEndpoint.java&lt;/em&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Override
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; AsyncProducer createAsyncProducer() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    AsyncProducer producer = delegate.createAsyncProducer();
    camelContext.addService(producer); &lt;span class=&quot;code-comment&quot;&gt;// &amp;lt;-- insert &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; to initialize the producer with camelContext
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; camelContext.adapt(ExtendedCamelContext.class).getInternalProcessorFactory()
            .createInterceptSendToEndpointProcessor(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;, delegate, producer, skip);
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The alternative would still be to make &lt;tt&gt;InterceptSendToEndpointProcessor&lt;/tt&gt; a &lt;tt&gt;CamelContextAware&lt;/tt&gt; and if its&#160;&lt;tt&gt;producer&lt;/tt&gt;&#160;is a &lt;tt&gt;CamelContextAware&lt;/tt&gt; in turn, set the camelContext on the &lt;tt&gt;producer&lt;/tt&gt;, hold it in the &lt;tt&gt;InterceptSendToEndpointProcessor&lt;/tt&gt; and get it from there in &lt;tt&gt;getCamelContext&lt;/tt&gt;. Somehow this feels less intrusive than adding the producer as a service.&lt;/p&gt;

&lt;p&gt;What would you recommend?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13376205">CAMEL-16567</key>
            <summary>Mocking of consul producers fails</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="dschulten">Dietrich Schulten</reporter>
                        <labels>
                    </labels>
                <created>Sat, 1 May 2021 11:12:17 +0000</created>
                <updated>Tue, 26 Apr 2022 06:00:03 +0000</updated>
                            <resolved>Wed, 5 May 2021 07:47:51 +0000</resolved>
                                    <version>3.9.0</version>
                                    <fixVersion>3.10.0</fixVersion>
                                    <component>camel-consul</component>
                    <component>tests</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="17337815" author="dschulten" created="Sat, 1 May 2021 14:30:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/camel/pull/5484&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/5484&lt;/a&gt; makes the InterceptSendToEndpointProcessor CamelContextAware.&lt;/p&gt;</comment>
                            <comment id="17527905" author="dschulten" created="Tue, 26 Apr 2022 05:59:14 +0000"  >&lt;p&gt;To mock a consul response, look for the proper &lt;tt&gt;ImmutableXXX.builder()&lt;/tt&gt; for the model interfaces of the respective consul api at &lt;a href=&quot;https://github.com/rickfast/consul-client/tree/master/src/main/java/com/orbitz/consul/model&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/rickfast/consul-client/tree/master/src/main/java/com/orbitz/consul/model&lt;/a&gt;. E.g. kv uses a &lt;tt&gt;Value&lt;/tt&gt; model interface, hence you need the &lt;tt&gt;ImmutableValue.builder()&lt;/tt&gt;. Those builders are generated, you don&apos;t find them in the source code, only in the jars.&lt;/p&gt;

&lt;p&gt;Mocking a kv response:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
consulMock.returnReplyBody(
  constant(
    ImmutableValue.builder()
      .value(&lt;span class=&quot;code-quote&quot;&gt;&quot;bm90aGluZyB0byBzZWUgaGVyZQ==&quot;&lt;/span&gt;)
      .createIndex(1)
      .modifyIndex(1)
      .lockIndex(1)
      .key(&lt;span class=&quot;code-quote&quot;&gt;&quot;key&quot;&lt;/span&gt;)
      .flags(1)
      .build()));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 29 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0qnd4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>