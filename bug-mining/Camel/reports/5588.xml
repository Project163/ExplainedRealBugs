<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:45:25 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-16103] Stack size increases in split with transacted</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-16103</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;I have run into an anomalous stack usage with this simple route:&lt;/p&gt;

&lt;p&gt;	&amp;lt;route id=&quot;split-stack-test&quot; autoStartup=&quot;true&quot;&amp;gt;&lt;br/&gt;
		&amp;lt;from uri=&quot;quartz://split-stack-test?cron=0+16+15+?&lt;ins&gt;&lt;b&gt;&lt;/ins&gt;&lt;/b&gt;&quot;/&amp;gt;&lt;br/&gt;
		&amp;lt;transacted/&amp;gt;&lt;br/&gt;
&amp;lt;!-- creates a list of 500 integers --&amp;gt;&lt;br/&gt;
		&amp;lt;setBody&amp;gt;&amp;lt;groovy&amp;gt;(0..499).collect &lt;/p&gt;
{ it }
&lt;p&gt;&amp;lt;/groovy&amp;gt;&amp;lt;/setBody&amp;gt;&lt;br/&gt;
		&amp;lt;split&amp;gt;&lt;br/&gt;
			&amp;lt;simple&amp;gt;${body}&amp;lt;/simple&amp;gt;&lt;br/&gt;
			&amp;lt;setBody&amp;gt;&amp;lt;groovy&amp;gt;&quot;${body} ${Thread.currentThread().getStackTrace().size()}&quot;&amp;lt;/groovy&amp;gt;&amp;lt;/setBody&amp;gt;&lt;br/&gt;
			&amp;lt;log message=&quot;STACKTRACE *** ${body}&quot;/&amp;gt;&lt;br/&gt;
		&amp;lt;/split&amp;gt;&lt;br/&gt;
		&amp;lt;to uri=&quot;mock:done?retainLast=0&quot;/&amp;gt;&lt;br/&gt;
	&amp;lt;/route&amp;gt;&lt;/p&gt;

&lt;p&gt;As you can see it prints the iteration number and the stack size (limited to 1024) and the output I get at the end is&lt;/p&gt;

&lt;p&gt;STACKTRACE *** 499 1024&lt;/p&gt;

&lt;p&gt;(The size of the stack reaches 1024 at 117)&lt;/p&gt;

&lt;p&gt;The stack is filled with these calls:&lt;/p&gt;

&lt;p&gt;	at org.apache.camel.spring.spi.TransactionErrorHandler.process(TransactionErrorHandler.java:138) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-spring-3.7.1.jar:3.7.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.impl.engine.CamelInternalProcessor.process(CamelInternalProcessor.java:312) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-base-engine-3.7.1.jar:3.7.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.processor.MulticastProcessor$MulticastTask.lambda$run$1(MulticastProcessor.java:384) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-processor-3.7.1.jar:3.7.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.util.concurrent.AsyncCompletionService$Task.run(AsyncCompletionService.java:150) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-util-3.7.1.jar:3.7.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.impl.engine.DefaultReactiveExecutor$Worker.schedule(DefaultReactiveExecutor.java:148) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-base-engine-3.7.1.jar:3.7.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.impl.engine.DefaultReactiveExecutor.schedule(DefaultReactiveExecutor.java:55) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-base-engine-3.7.1.jar:3.7.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.impl.engine.CamelInternalProcessor$AsyncAfterTask.done(CamelInternalProcessor.java:211) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-base-engine-3.7.1.jar:3.7.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.impl.engine.MDCUnitOfWork$MDCCallback.done(MDCUnitOfWork.java:292) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-base-engine-3.7.1.jar:3.7.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.spring.spi.TransactionErrorHandler.process(TransactionErrorHandler.java:138) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-spring-3.7.1.jar:3.7.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.impl.engine.CamelInternalProcessor.process(CamelInternalProcessor.java:312) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-base-engine-3.7.1.jar:3.7.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.processor.MulticastProcessor$MulticastTask.lambda$run$1(MulticastProcessor.java:384) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-processor-3.7.1.jar:3.7.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.util.concurrent.AsyncCompletionService$Task.run(AsyncCompletionService.java:150) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-util-3.7.1.jar:3.7.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.impl.engine.DefaultReactiveExecutor$Worker.schedule(DefaultReactiveExecutor.java:148) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-base-engine-3.7.1.jar:3.7.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.impl.engine.DefaultReactiveExecutor.schedule(DefaultReactiveExecutor.java:55) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-base-engine-3.7.1.jar:3.7.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.impl.engine.CamelInternalProcessor$AsyncAfterTask.done(CamelInternalProcessor.java:211) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-base-engine-3.7.1.jar:3.7.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.impl.engine.MDCUnitOfWork$MDCCallback.done(MDCUnitOfWork.java:292) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-base-engine-3.7.1.jar:3.7.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.camel.spring.spi.TransactionErrorHandler.process(TransactionErrorHandler.java:138) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-spring-3.7.1.jar:3.7.1&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;If I remove transacted, the stack size remains at 15.&lt;/p&gt;

&lt;p&gt;STACKTRACE *** 499 15&lt;/p&gt;

&lt;p&gt;If I run this route in camel 2.22.1 at the end I see this (transacted is present!):&lt;/p&gt;

&lt;p&gt;STACKTRACE *** 499 51&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment>&lt;p&gt;OS: Windows 10&lt;/p&gt;

&lt;p&gt;Java: OpenJDK jdk-8.0.282.8-hotspot&lt;/p&gt;

&lt;p&gt;Camel: 3.6.0 and 3.7.1&lt;/p&gt;

&lt;p&gt;I&apos;m using camel-spring and Spring version is 5.1.5.RELEASE&lt;/p&gt;</environment>
        <key id="13355210">CAMEL-16103</key>
            <summary>Stack size increases in split with transacted</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="s.rocca@oandsi.it">Stefano Rocca</reporter>
                        <labels>
                    </labels>
                <created>Thu, 28 Jan 2021 14:36:06 +0000</created>
                <updated>Fri, 23 Apr 2021 07:20:28 +0000</updated>
                            <resolved>Sun, 31 Jan 2021 15:55:19 +0000</resolved>
                                    <version>3.6.0</version>
                    <version>3.7.1</version>
                                    <fixVersion>3.7.2</fixVersion>
                    <fixVersion>3.8.0</fixVersion>
                                    <component>camel-core</component>
                    <component>camel-spring</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17273785" author="ancosen" created="Thu, 28 Jan 2021 15:00:28 +0000"  >&lt;p&gt;Did you set up the transaction manager in your camel context?&lt;/p&gt;</comment>
                            <comment id="17273812" author="s.rocca@oandsi.it" created="Thu, 28 Jan 2021 15:43:58 +0000"  >&lt;p&gt;Hi Andrea,&lt;br/&gt;
I have a transaction manager in my spring beans&lt;/p&gt;

&lt;p&gt;&amp;lt;bean id=&quot;transactionManager&quot; class=&quot;org.springframework.orm.jpa.JpaTransactionManager&quot;&lt;br/&gt;
				p:entityManagerFactory-ref=&quot;entityManagerFactory&quot;/&amp;gt;&lt;/p&gt;

&lt;p&gt;Is it sufficient?&lt;br/&gt;
Consider that this same configuration is working as expected with 2.22.1, have I missed something during the upgrade to Camel 3.6?&lt;/p&gt;</comment>
                            <comment id="17273821" author="s.rocca@oandsi.it" created="Thu, 28 Jan 2021 16:04:41 +0000"  >&lt;p&gt;I forgot to mention that the CamelContext is a SpringCamelContext&lt;/p&gt;</comment>
                            <comment id="17275922" author="davsclaus" created="Sun, 31 Jan 2021 15:56:23 +0000"  >&lt;p&gt;Thanks for reporting. Took a bit to dive into this, and its the nature of the multicast that needs to have a different control flow in transacted mode to keep using the same thread but also use a loop control structure to flatten the straksize.&lt;/p&gt;

&lt;p&gt;There is a fix in Camel 3.8 onwards.&lt;/p&gt;</comment>
                            <comment id="17276144" author="s.rocca@oandsi.it" created="Mon, 1 Feb 2021 08:41:59 +0000"  >&lt;p&gt;Hi Claus, thank you.&lt;br/&gt;
Are you going to backport the fix to the 3.7.x branch also?&lt;/p&gt;</comment>
                            <comment id="17276352" author="davsclaus" created="Mon, 1 Feb 2021 14:20:08 +0000"  >&lt;p&gt;Oh its a bit bigger fix but I will take a look&lt;/p&gt;</comment>
                            <comment id="17276388" author="davsclaus" created="Mon, 1 Feb 2021 15:00:45 +0000"  >&lt;p&gt;Okay backported to 3.7.2&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13374568">CAMEL-16550</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10431"><![CDATA[Important]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 41 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0n3dc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>