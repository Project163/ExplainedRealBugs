<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:29:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-12415] Camel-jaxb option &quot;encoding&quot; with option &quot;filterNonXmlChars&quot; generate wrong data</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-12415</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;When using the jaxb-component to marshal.&lt;/p&gt;

&lt;p&gt;The properties:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Encoding&lt;/li&gt;
	&lt;li&gt;FilterNonXmlChars&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;do&#160;not work&#160;together correctly.&lt;/p&gt;

&lt;p&gt;FilterNonXmlChars will ignore the set encoding, and make&#160;the output bytes UTF-8 encoded.&lt;br/&gt;
 I would either expect this to just work, and by that I mean bytes should be&#160;encoded as the set encoding,&#160;or minimally fail during startup of the route with an exception explaining that these properties does not work together. I&apos;d really prefer the first, since I&#160;want&#160;to use the&#160;functionality of both.&lt;/p&gt;

&lt;p&gt;I have provided a patch which makes this work.I have done a small&#160;refactoring to not have to duplicate more code. I can rewrite this if it is a problem.&lt;/p&gt;

&lt;p&gt;Below is a test which will reproduce the problem.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;ExplicitEncodingAndXMLCharFilteringTest &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; CamelTestSupport {

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void setUp() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        deleteDirectory(&lt;span class=&quot;code-quote&quot;&gt;&quot;target/charset&quot;&lt;/span&gt;);
        &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.setUp();
    }

    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testIsoAndCharacterFiltering() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        PurchaseOrder order = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PurchaseOrder();
        &lt;span class=&quot;code-comment&quot;&gt;//Data containing characters &#198;&#216;&#197;&#230;&#248;&#229; that differ in utf-8 and iso + a spouting whale
&lt;/span&gt;        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name = &lt;span class=&quot;code-quote&quot;&gt;&quot;\u00c6\u00d8\u00C5\u00e6\u00f8\u00e5\uD83D\uDC33\uFFFD&quot;&lt;/span&gt;;
        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; expected = &lt;span class=&quot;code-quote&quot;&gt;&quot;\u00c6\u00d8\u00C5\u00e6\u00f8\u00e5  \uFFFD&quot;&lt;/span&gt;; &lt;span class=&quot;code-comment&quot;&gt;//Spouting whale has become spaces
&lt;/span&gt;        order.setName(name);
        order.setAmount(123.45);
        order.setPrice(2.22);

        MockEndpoint result = getMockEndpoint(&lt;span class=&quot;code-quote&quot;&gt;&quot;mock:file&quot;&lt;/span&gt;);
        result.expectedFileExists(&lt;span class=&quot;code-quote&quot;&gt;&quot;target/charset/output.xml&quot;&lt;/span&gt;);

        template.sendBody(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:start&quot;&lt;/span&gt;, order);
        assertMockEndpointsSatisfied();

        JAXBContext jaxbContext = JAXBContext.newInstance(&lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.camel.example&quot;&lt;/span&gt;);
        Unmarshaller unmarshaller = jaxbContext.createUnmarshaller();
        InputStream inputStream = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FileInputStream(&lt;span class=&quot;code-quote&quot;&gt;&quot;target/charset/output.xml&quot;&lt;/span&gt;);
        Reader reader = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; InputStreamReader(inputStream, &lt;span class=&quot;code-quote&quot;&gt;&quot;ISO-8859-1&quot;&lt;/span&gt;);
        PurchaseOrder obj = (PurchaseOrder) unmarshaller.unmarshal(reader);
        assertEquals(expected, obj.getName());
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; RouteBuilder createRouteBuilder() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RouteBuilder() {
            @Override
            &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void configure() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
                JaxbDataFormat jaxb = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; JaxbDataFormat(&lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.camel.example&quot;&lt;/span&gt;);
                jaxb.setFilterNonXmlChars(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
                jaxb.setEncoding(&lt;span class=&quot;code-quote&quot;&gt;&quot;iso-8859-1&quot;&lt;/span&gt;);

                from(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:start&quot;&lt;/span&gt;)
                        .marshal(jaxb)
                        .to(&lt;span class=&quot;code-quote&quot;&gt;&quot;file:target/charset/?fileName=output.xml&amp;amp;charset=iso-8859-1&quot;&lt;/span&gt;);
            }
        };
    }

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment>&lt;p&gt;OS X 13.3, Java 8&lt;/p&gt;</environment>
        <key id="13148933">CAMEL-12415</key>
            <summary>Camel-jaxb option &quot;encoding&quot; with option &quot;filterNonXmlChars&quot; generate wrong data</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="aldettinger">Alex Dettinger</assignee>
                                    <reporter username="MadMod">Jonas Waage</reporter>
                        <labels>
                    </labels>
                <created>Thu, 29 Mar 2018 16:28:38 +0000</created>
                <updated>Sat, 7 Apr 2018 15:46:26 +0000</updated>
                            <resolved>Sat, 7 Apr 2018 15:46:26 +0000</resolved>
                                    <version>2.21.0</version>
                                    <fixVersion>2.21.1</fixVersion>
                    <fixVersion>2.22.0</fixVersion>
                                    <component>camel-jaxb</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16419361" author="githubbot" created="Thu, 29 Mar 2018 16:54:35 +0000"  >&lt;p&gt;IIlllII opened a new pull request #2276: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12415&quot; title=&quot;Camel-jaxb option &amp;quot;encoding&amp;quot; with option &amp;quot;filterNonXmlChars&amp;quot; generate wrong data&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12415&quot;&gt;&lt;del&gt;CAMEL-12415&lt;/del&gt;&lt;/a&gt; - camel-jaxb, fix options combination: encoding,filterNonXmlChars&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2276&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2276&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Please tell me if anything needs to be changed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16419362" author="githubbot" created="Thu, 29 Mar 2018 16:54:36 +0000"  >&lt;p&gt;GitHub user IIlllII opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/2276&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2276&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12415&quot; title=&quot;Camel-jaxb option &amp;quot;encoding&amp;quot; with option &amp;quot;filterNonXmlChars&amp;quot; generate wrong data&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12415&quot;&gt;&lt;del&gt;CAMEL-12415&lt;/del&gt;&lt;/a&gt; - camel-jaxb, fix options combination: encoding,filterNonXmlChars&lt;/p&gt;

&lt;p&gt;    Please tell me if anything needs to be changed.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/IIlllII/camel&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/IIlllII/camel&lt;/a&gt; master&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/2276.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2276.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #2276&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 64169aed7e0c8f07853565fac4e9822f26c83647&lt;br/&gt;
Author: Jonas Waage &amp;lt;jonas.h.waage@...&amp;gt;&lt;br/&gt;
Date:   2017-12-04T23:34:55Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12062&quot; title=&quot;Jaxb component does not communicate charset when explicitly set&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12062&quot;&gt;&lt;del&gt;CAMEL-12062&lt;/del&gt;&lt;/a&gt; Propagate encoding in property&lt;/p&gt;

&lt;p&gt;commit 8c387e4f40ea13f61fe7cb6c87ea3d6f4f91f4b1&lt;br/&gt;
Author: Jonas Waage &amp;lt;jonas.h.waage@...&amp;gt;&lt;br/&gt;
Date:   2018-03-20T19:13:40Z&lt;/p&gt;

&lt;p&gt;    Merge remote-tracking branch &apos;upstream/master&apos;&lt;/p&gt;

&lt;p&gt;commit ae41f78bb38f3402fbbf386057f14bd4187cf768&lt;br/&gt;
Author: Jonas Waage &amp;lt;jonas.h.waage@...&amp;gt;&lt;br/&gt;
Date:   2018-03-29T16:33:44Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12415&quot; title=&quot;Camel-jaxb option &amp;quot;encoding&amp;quot; with option &amp;quot;filterNonXmlChars&amp;quot; generate wrong data&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12415&quot;&gt;&lt;del&gt;CAMEL-12415&lt;/del&gt;&lt;/a&gt; - camel-jaxb, fix options combination: encoding,filterNonXmlChars&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16419398" author="githubbot" created="Thu, 29 Mar 2018 17:06:59 +0000"  >&lt;p&gt;IIlllII commented on issue #2276: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12415&quot; title=&quot;Camel-jaxb option &amp;quot;encoding&amp;quot; with option &amp;quot;filterNonXmlChars&amp;quot; generate wrong data&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12415&quot;&gt;&lt;del&gt;CAMEL-12415&lt;/del&gt;&lt;/a&gt; - camel-jaxb, fix options combination: encoding,filterNonXmlChars&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2276#issuecomment-377304454&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2276#issuecomment-377304454&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Got some other commits in here, sorry I&apos;ll make a new one&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16419399" author="githubbot" created="Thu, 29 Mar 2018 17:06:59 +0000"  >&lt;p&gt;IIlllII closed pull request #2276: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12415&quot; title=&quot;Camel-jaxb option &amp;quot;encoding&amp;quot; with option &amp;quot;filterNonXmlChars&amp;quot; generate wrong data&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12415&quot;&gt;&lt;del&gt;CAMEL-12415&lt;/del&gt;&lt;/a&gt; - camel-jaxb, fix options combination: encoding,filterNonXmlChars&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2276&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2276&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/components/camel-jaxb/src/main/java/org/apache/camel/converter/jaxb/FallbackTypeConverter.java b/components/camel-jaxb/src/main/java/org/apache/camel/converter/jaxb/FallbackTypeConverter.java&lt;br/&gt;
index 8283af650a4..24e51ed537f 100644&lt;br/&gt;
&amp;#8212; a/components/camel-jaxb/src/main/java/org/apache/camel/converter/jaxb/FallbackTypeConverter.java&lt;br/&gt;
+++ b/components/camel-jaxb/src/main/java/org/apache/camel/converter/jaxb/FallbackTypeConverter.java&lt;br/&gt;
@@ -295,11 +295,13 @@ protected void doStop() throws Exception {&lt;br/&gt;
             Marshaller marshaller = context.createMarshaller();&lt;br/&gt;
             Writer buffer = new StringWriter();&lt;/p&gt;

&lt;p&gt;+&lt;br/&gt;
             if (isPrettyPrint()) &lt;/p&gt;
{
                 marshaller.setProperty(Marshaller.JAXB_FORMATTED_OUTPUT, Boolean.TRUE);
             }
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (exchange != null &amp;amp;&amp;amp; exchange.getProperty(Exchange.CHARSET_NAME, String.class) != null) {&lt;/li&gt;
	&lt;li&gt;marshaller.setProperty(Marshaller.JAXB_ENCODING, exchange.getProperty(Exchange.CHARSET_NAME, String.class));&lt;br/&gt;
+            String charset = exchange != null ? exchange.getProperty(Exchange.CHARSET_NAME, String.class) : null;&lt;br/&gt;
+            if (charset != null) 
{
+                marshaller.setProperty(Marshaller.JAXB_ENCODING, charset);
             }
&lt;p&gt;             Object toMarshall = value;&lt;br/&gt;
             if (objectFactoryMethod != null) {&lt;br/&gt;
@@ -314,7 +316,7 @@ protected void doStop() throws Exception {&lt;br/&gt;
             }&lt;br/&gt;
             if (needFiltering(exchange)) &lt;/p&gt;
{
                 XMLStreamWriter writer = parentTypeConverter.convertTo(XMLStreamWriter.class, buffer);
-                FilteringXmlStreamWriter filteringWriter = new FilteringXmlStreamWriter(writer);
+                FilteringXmlStreamWriter filteringWriter = new FilteringXmlStreamWriter(writer, charset);
                 marshaller.marshal(toMarshall, filteringWriter);
             }
&lt;p&gt; else {&lt;br/&gt;
                 marshaller.marshal(toMarshall, buffer);&lt;br/&gt;
diff --git a/components/camel-jaxb/src/main/java/org/apache/camel/converter/jaxb/FilteringXmlStreamWriter.java b/components/camel-jaxb/src/main/java/org/apache/camel/converter/jaxb/FilteringXmlStreamWriter.java&lt;br/&gt;
index 7af3d727702..49e0df3c2cc 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/components/camel-jaxb/src/main/java/org/apache/camel/converter/jaxb/FilteringXmlStreamWriter.java&lt;br/&gt;
+++ b/components/camel-jaxb/src/main/java/org/apache/camel/converter/jaxb/FilteringXmlStreamWriter.java&lt;br/&gt;
@@ -36,13 +36,18 @@&lt;br/&gt;
     NonXmlCharFilterer nonXmlCharFilterer = new NonXmlCharFilterer();&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     private XMLStreamWriter writer;&lt;br/&gt;
+    private String encoding;&lt;/p&gt;

&lt;p&gt;     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;@param writer&lt;/li&gt;
	&lt;li&gt;target writer to wrap.&lt;br/&gt;
+     * @param encoding&lt;br/&gt;
+     *            the encoding to write in header&lt;br/&gt;
+     *&lt;br/&gt;
      */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public FilteringXmlStreamWriter(XMLStreamWriter writer) {&lt;br/&gt;
+    public FilteringXmlStreamWriter(XMLStreamWriter writer, String encoding) 
{
         this.writer = writer;
+        this.encoding = encoding != null ? encoding.toUpperCase() : null;
     }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     /**&lt;br/&gt;
@@ -181,7 +186,11 @@ public void writeProcessingInstruction(String target) throws XMLStreamException&lt;br/&gt;
     }&lt;/p&gt;

&lt;p&gt;     public void writeStartDocument() throws XMLStreamException {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;writer.writeStartDocument();&lt;br/&gt;
+        if (encoding != null) 
{
+            this.writeStartDocument(encoding, null);
+        }
&lt;p&gt; else &lt;/p&gt;
{
+            writer.writeStartDocument();
+        }
&lt;p&gt;     }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     public void writeStartDocument(String encoding, String version) throws XMLStreamException &lt;/p&gt;
{
@@ -189,7 +198,11 @@ public void writeStartDocument(String encoding, String version) throws XMLStream
     }

&lt;p&gt;     public void writeStartDocument(String version) throws XMLStreamException {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;writer.writeStartDocument(version);&lt;br/&gt;
+        if (encoding != null) 
{
+            this.writeStartDocument(encoding, version);
+        }
&lt;p&gt; else &lt;/p&gt;
{
+            writer.writeStartDocument(version);
+        }
&lt;p&gt;     }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     public void writeStartElement(String prefix, String localName, String namespaceURI)&lt;br/&gt;
diff --git a/components/camel-jaxb/src/main/java/org/apache/camel/converter/jaxb/JaxbDataFormat.java b/components/camel-jaxb/src/main/java/org/apache/camel/converter/jaxb/JaxbDataFormat.java&lt;br/&gt;
index ea74d37dad5..0500210261c 100644&lt;br/&gt;
&amp;#8212; a/components/camel-jaxb/src/main/java/org/apache/camel/converter/jaxb/JaxbDataFormat.java&lt;br/&gt;
+++ b/components/camel-jaxb/src/main/java/org/apache/camel/converter/jaxb/JaxbDataFormat.java&lt;br/&gt;
@@ -205,18 +205,8 @@ void doMarshal(Exchange exchange, Object graph, OutputStream stream, Marshaller&lt;/p&gt;

&lt;p&gt;         // only marshal if its possible&lt;br/&gt;
         if (introspector.isElement(element)) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (asXmlStreamWriter(exchange)) {&lt;/li&gt;
	&lt;li&gt;XMLStreamWriter writer = typeConverter.convertTo(XMLStreamWriter.class, stream);&lt;/li&gt;
	&lt;li&gt;if (needFiltering(exchange)) 
{
-                    writer = new FilteringXmlStreamWriter(writer);
-                }&lt;/li&gt;
	&lt;li&gt;if (xmlStreamWriterWrapper != null) 
{
-                    writer = xmlStreamWriterWrapper.wrapWriter(writer);
-                }&lt;/li&gt;
	&lt;li&gt;marshaller.marshal(element, writer);&lt;/li&gt;
	&lt;li&gt;} else 
{
-                marshaller.marshal(element, stream);
-            }
&lt;p&gt;+            XMLStreamWriter writer = getWriter(exchange, stream);&lt;br/&gt;
+            performWrite(exchange, stream, writer, marshaller, element);&lt;br/&gt;
             return;&lt;br/&gt;
         } else if (objectFactory &amp;amp;&amp;amp; element != null) {&lt;br/&gt;
             Method objectFactoryMethod = JaxbHelper.getJaxbElementFactoryMethod(camelContext, element.getClass());&lt;br/&gt;
@@ -225,18 +215,8 @@ void doMarshal(Exchange exchange, Object graph, OutputStream stream, Marshaller&lt;br/&gt;
                     Object instance = objectFactoryMethod.getDeclaringClass().newInstance();&lt;br/&gt;
                     if (instance != null) {&lt;br/&gt;
                         Object toMarshall = objectFactoryMethod.invoke(instance, element);&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;if (asXmlStreamWriter(exchange)) {&lt;/li&gt;
	&lt;li&gt;XMLStreamWriter writer = typeConverter.convertTo(XMLStreamWriter.class, stream);&lt;/li&gt;
	&lt;li&gt;if (needFiltering(exchange)) 
{
-                                writer = new FilteringXmlStreamWriter(writer);
-                            }&lt;/li&gt;
	&lt;li&gt;if (xmlStreamWriterWrapper != null) 
{
-                                writer = xmlStreamWriterWrapper.wrapWriter(writer);
-                            }&lt;/li&gt;
	&lt;li&gt;marshaller.marshal(toMarshall, writer);&lt;/li&gt;
	&lt;li&gt;} else 
{
-                            marshaller.marshal(toMarshall, stream);
-                        }
&lt;p&gt;+                        XMLStreamWriter writer = getWriter(exchange, stream);&lt;br/&gt;
+                        performWrite(exchange, stream, writer, marshaller, toMarshall);&lt;br/&gt;
                         return;&lt;br/&gt;
                     }&lt;br/&gt;
                 } catch (Exception e) &lt;/p&gt;
{
@@ -258,6 +238,27 @@ void doMarshal(Exchange exchange, Object graph, OutputStream stream, Marshaller
         }
&lt;p&gt;     }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+    private void performWrite(Exchange exchange, OutputStream stream, XMLStreamWriter writer, Marshaller marshaller, Object toMarshall) throws JAXBException {&lt;br/&gt;
+        if (asXmlStreamWriter(exchange)) &lt;/p&gt;
{
+            marshaller.marshal(toMarshall, writer);
+        }
&lt;p&gt; else &lt;/p&gt;
{
+            marshaller.marshal(toMarshall, stream);
+        }
&lt;p&gt;+    }&lt;br/&gt;
+&lt;br/&gt;
+    private XMLStreamWriter getWriter(Exchange exchange, OutputStream stream) {&lt;br/&gt;
+        XMLStreamWriter writer = typeConverter.convertTo(XMLStreamWriter.class, exchange, stream);&lt;br/&gt;
+        if (needFiltering(exchange)) &lt;/p&gt;
{
+            String charset = exchange.getProperty(Exchange.CHARSET_NAME, String.class);
+            writer = new FilteringXmlStreamWriter(writer, charset);
+        }
&lt;p&gt;+        if (xmlStreamWriterWrapper != null) &lt;/p&gt;
{
+            writer = xmlStreamWriterWrapper.wrapWriter(writer);
+        }
&lt;p&gt;+        return writer;&lt;br/&gt;
+    }&lt;br/&gt;
+&lt;br/&gt;
+&lt;br/&gt;
     private boolean asXmlStreamWriter(Exchange exchange) &lt;/p&gt;
{
         return needFiltering(exchange) || (xmlStreamWriterWrapper != null);
     }
&lt;p&gt;diff --git a/components/camel-jaxb/src/test/java/org/apache/camel/converter/jaxb/FilteringXmlStreamWriterTest.java b/components/camel-jaxb/src/test/java/org/apache/camel/converter/jaxb/FilteringXmlStreamWriterTest.java&lt;br/&gt;
index b8b38016783..59d164bc5f9 100644&lt;br/&gt;
&amp;#8212; a/components/camel-jaxb/src/test/java/org/apache/camel/converter/jaxb/FilteringXmlStreamWriterTest.java&lt;br/&gt;
+++ b/components/camel-jaxb/src/test/java/org/apache/camel/converter/jaxb/FilteringXmlStreamWriterTest.java&lt;br/&gt;
@@ -42,7 +42,7 @@&lt;/p&gt;

&lt;p&gt;     @Before&lt;br/&gt;
     public void setUp() {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;filteringXmlStreamWriter = new FilteringXmlStreamWriter(xmlStreamWriterMock);&lt;br/&gt;
+        filteringXmlStreamWriter = new FilteringXmlStreamWriter(xmlStreamWriterMock, null);&lt;br/&gt;
         filteringXmlStreamWriter.nonXmlCharFilterer = nonXmlCharFiltererMock;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         when(nonXmlCharFiltererMock.filter(&quot;value&quot;)).thenReturn(&quot;filteredValue&quot;);&lt;br/&gt;
diff --git a/components/camel-jaxb/src/test/java/org/apache/camel/example/ExplicitEncodingAndXMLCharFilteringTest.java b/components/camel-jaxb/src/test/java/org/apache/camel/example/ExplicitEncodingAndXMLCharFilteringTest.java&lt;br/&gt;
new file mode 100644&lt;br/&gt;
index 00000000000..3adb9c3b252&lt;br/&gt;
&amp;#8212; /dev/null&lt;br/&gt;
+++ b/components/camel-jaxb/src/test/java/org/apache/camel/example/ExplicitEncodingAndXMLCharFilteringTest.java&lt;br/&gt;
@@ -0,0 +1,85 @@&lt;br/&gt;
+/**&lt;br/&gt;
+ * Licensed to the Apache Software Foundation (ASF) under one or more&lt;br/&gt;
+ * contributor license agreements.  See the NOTICE file distributed with&lt;br/&gt;
+ * this work for additional information regarding copyright ownership.&lt;br/&gt;
+ * The ASF licenses this file to You under the Apache License, Version 2.0&lt;br/&gt;
+ * (the &quot;License&quot;); you may not use this file except in compliance with&lt;br/&gt;
+ * the License.  You may obtain a copy of the License at&lt;br/&gt;
+ *&lt;br/&gt;
+ *      &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
+ *&lt;br/&gt;
+ * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
+ * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
+ * See the License for the specific language governing permissions and&lt;br/&gt;
+ * limitations under the License.&lt;br/&gt;
+ */&lt;br/&gt;
+package org.apache.camel.example;&lt;br/&gt;
+&lt;br/&gt;
+import java.io.FileInputStream;&lt;br/&gt;
+import java.io.InputStream;&lt;br/&gt;
+import java.io.InputStreamReader;&lt;br/&gt;
+import java.io.Reader;&lt;br/&gt;
+&lt;br/&gt;
+import javax.xml.bind.JAXBContext;&lt;br/&gt;
+import javax.xml.bind.Unmarshaller;&lt;br/&gt;
+&lt;br/&gt;
+import org.apache.camel.builder.RouteBuilder;&lt;br/&gt;
+import org.apache.camel.component.mock.MockEndpoint;&lt;br/&gt;
+import org.apache.camel.converter.jaxb.JaxbDataFormat;&lt;br/&gt;
+import org.apache.camel.test.junit4.CamelTestSupport;&lt;br/&gt;
+import org.junit.Test;&lt;br/&gt;
+&lt;br/&gt;
+&lt;br/&gt;
+/**&lt;br/&gt;
+ * @version &lt;br/&gt;
+ */&lt;br/&gt;
+public class ExplicitEncodingAndXMLCharFilteringTest extends CamelTestSupport {&lt;br/&gt;
+&lt;br/&gt;
+    @Override&lt;br/&gt;
+    public void setUp() throws Exception &lt;/p&gt;
{
+        deleteDirectory(&quot;target/charset&quot;);
+        super.setUp();
+    }
&lt;p&gt;+&lt;br/&gt;
+    @Test&lt;br/&gt;
+    public void testIsoAndCharacterFiltering() throws Exception &lt;/p&gt;
{
+        PurchaseOrder order = new PurchaseOrder();
+        //Data containing characters &#198;&#216;&#197;&#230;&#248;&#229; that differ in utf-8 and iso + a spouting whale
+        String name = &quot;\u00c6\u00d8\u00C5\u00e6\u00f8\u00e5\uD83D\uDC33\uFFFD&quot;;
+        String expected = &quot;\u00c6\u00d8\u00C5\u00e6\u00f8\u00e5  \uFFFD&quot;; //Spouting whale has become spaces
+        order.setName(name);
+        order.setAmount(123.45);
+        order.setPrice(2.22);
+
+        MockEndpoint result = getMockEndpoint(&quot;mock:file&quot;);
+        result.expectedFileExists(&quot;target/charset/output.xml&quot;);
+
+        template.sendBody(&quot;direct:start&quot;, order);
+        assertMockEndpointsSatisfied();
+
+        JAXBContext jaxbContext = JAXBContext.newInstance(&quot;org.apache.camel.example&quot;);
+        Unmarshaller unmarshaller = jaxbContext.createUnmarshaller();
+        InputStream inputStream = new FileInputStream(&quot;target/charset/output.xml&quot;);
+        Reader reader = new InputStreamReader(inputStream, &quot;ISO-8859-1&quot;);
+        PurchaseOrder obj = (PurchaseOrder) unmarshaller.unmarshal(reader);
+        assertEquals(expected, obj.getName());
+    }
&lt;p&gt;+&lt;br/&gt;
+    @Override&lt;br/&gt;
+    protected RouteBuilder createRouteBuilder() throws Exception {&lt;br/&gt;
+        return new RouteBuilder() {&lt;br/&gt;
+            @Override&lt;br/&gt;
+            public void configure() throws Exception &lt;/p&gt;
{
+                JaxbDataFormat jaxb = new JaxbDataFormat(&quot;org.apache.camel.example&quot;);
+                jaxb.setFilterNonXmlChars(true);
+                jaxb.setEncoding(&quot;iso-8859-1&quot;);
+
+                from(&quot;direct:start&quot;)
+                        .marshal(jaxb)
+                        .to(&quot;file:target/charset/?fileName=output.xml&amp;amp;charset=iso-8859-1&quot;);
+            }
&lt;p&gt;+        };&lt;br/&gt;
+    }&lt;br/&gt;
+&lt;br/&gt;
+}&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16419400" author="githubbot" created="Thu, 29 Mar 2018 17:07:00 +0000"  >&lt;p&gt;Github user IIlllII closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/2276&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2276&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16419588" author="githubbot" created="Thu, 29 Mar 2018 19:01:04 +0000"  >&lt;p&gt;IIlllII opened a new pull request #2277: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12415&quot; title=&quot;Camel-jaxb option &amp;quot;encoding&amp;quot; with option &amp;quot;filterNonXmlChars&amp;quot; generate wrong data&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12415&quot;&gt;&lt;del&gt;CAMEL-12415&lt;/del&gt;&lt;/a&gt; - camel-jaxb, fix options combination: encoding,filterNon&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2277&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2277&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16419589" author="githubbot" created="Thu, 29 Mar 2018 19:01:05 +0000"  >&lt;p&gt;GitHub user IIlllII opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/2277&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2277&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12415&quot; title=&quot;Camel-jaxb option &amp;quot;encoding&amp;quot; with option &amp;quot;filterNonXmlChars&amp;quot; generate wrong data&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12415&quot;&gt;&lt;del&gt;CAMEL-12415&lt;/del&gt;&lt;/a&gt; - camel-jaxb, fix options combination: encoding,filterNon&#8230;&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/IIlllII/camel&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/IIlllII/camel&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12415&quot; title=&quot;Camel-jaxb option &amp;quot;encoding&amp;quot; with option &amp;quot;filterNonXmlChars&amp;quot; generate wrong data&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12415&quot;&gt;&lt;del&gt;CAMEL-12415&lt;/del&gt;&lt;/a&gt;-2&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/2277.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2277.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #2277&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 9e1b372bc8cff1b9189bd4319ea8ea6b085a7e56&lt;br/&gt;
Author: Jonas Waage &amp;lt;jonas.h.waage@...&amp;gt;&lt;br/&gt;
Date:   2018-03-29T16:33:44Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12415&quot; title=&quot;Camel-jaxb option &amp;quot;encoding&amp;quot; with option &amp;quot;filterNonXmlChars&amp;quot; generate wrong data&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12415&quot;&gt;&lt;del&gt;CAMEL-12415&lt;/del&gt;&lt;/a&gt; - camel-jaxb, fix options combination: encoding,filterNonXmlChars&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16420811" author="githubbot" created="Fri, 30 Mar 2018 18:29:56 +0000"  >&lt;p&gt;aldettinger commented on a change in pull request #2277: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12415&quot; title=&quot;Camel-jaxb option &amp;quot;encoding&amp;quot; with option &amp;quot;filterNonXmlChars&amp;quot; generate wrong data&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12415&quot;&gt;&lt;del&gt;CAMEL-12415&lt;/del&gt;&lt;/a&gt; - camel-jaxb, fix options combination: encoding,filterNon&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2277#discussion_r178342671&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2277#discussion_r178342671&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: components/camel-jaxb/src/main/java/org/apache/camel/converter/jaxb/FallbackTypeConverter.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -295,11 +295,13 @@ protected void doStop() throws Exception {&lt;br/&gt;
             Marshaller marshaller = context.createMarshaller();&lt;br/&gt;
             Writer buffer = new StringWriter();&lt;/p&gt;

&lt;p&gt;+&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   No big deal, but if you could avoid introducing blank line.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16420812" author="githubbot" created="Fri, 30 Mar 2018 18:29:56 +0000"  >&lt;p&gt;aldettinger commented on a change in pull request #2277: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12415&quot; title=&quot;Camel-jaxb option &amp;quot;encoding&amp;quot; with option &amp;quot;filterNonXmlChars&amp;quot; generate wrong data&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12415&quot;&gt;&lt;del&gt;CAMEL-12415&lt;/del&gt;&lt;/a&gt; - camel-jaxb, fix options combination: encoding,filterNon&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2277#discussion_r178341639&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2277#discussion_r178341639&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: components/camel-jaxb/src/test/java/org/apache/camel/converter/jaxb/FilteringXmlStreamWriterTest.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -42,7 +42,7 @@&lt;/p&gt;

&lt;p&gt;     @Before&lt;br/&gt;
     public void setUp() {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;filteringXmlStreamWriter = new FilteringXmlStreamWriter(xmlStreamWriterMock);&lt;br/&gt;
+        filteringXmlStreamWriter = new FilteringXmlStreamWriter(xmlStreamWriterMock, null);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   Could be avoided by removing the API break mentioned earlier.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16420813" author="githubbot" created="Fri, 30 Mar 2018 18:29:56 +0000"  >&lt;p&gt;aldettinger commented on a change in pull request #2277: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12415&quot; title=&quot;Camel-jaxb option &amp;quot;encoding&amp;quot; with option &amp;quot;filterNonXmlChars&amp;quot; generate wrong data&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12415&quot;&gt;&lt;del&gt;CAMEL-12415&lt;/del&gt;&lt;/a&gt; - camel-jaxb, fix options combination: encoding,filterNon&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2277#discussion_r178342501&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2277#discussion_r178342501&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: components/camel-jaxb/src/main/java/org/apache/camel/converter/jaxb/FilteringXmlStreamWriter.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -36,13 +36,18 @@&lt;br/&gt;
     NonXmlCharFilterer nonXmlCharFilterer = new NonXmlCharFilterer();&lt;/p&gt;

&lt;p&gt;     private XMLStreamWriter writer;&lt;br/&gt;
+    private String encoding;&lt;/p&gt;

&lt;p&gt;     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;@param writer&lt;/li&gt;
	&lt;li&gt;target writer to wrap.&lt;br/&gt;
+     * @param encoding&lt;br/&gt;
+     *            the encoding to write in header&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   At first read, I interpreted &apos;header&apos; as &apos;camel header&apos;. Did you mean xml prolog instead ?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16420814" author="githubbot" created="Fri, 30 Mar 2018 18:29:56 +0000"  >&lt;p&gt;aldettinger commented on a change in pull request #2277: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12415&quot; title=&quot;Camel-jaxb option &amp;quot;encoding&amp;quot; with option &amp;quot;filterNonXmlChars&amp;quot; generate wrong data&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12415&quot;&gt;&lt;del&gt;CAMEL-12415&lt;/del&gt;&lt;/a&gt; - camel-jaxb, fix options combination: encoding,filterNon&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2277#discussion_r178341246&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2277#discussion_r178341246&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: components/camel-jaxb/src/main/java/org/apache/camel/converter/jaxb/JaxbDataFormat.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -258,6 +238,27 @@ void doMarshal(Exchange exchange, Object graph, OutputStream stream, Marshaller&lt;br/&gt;
         }&lt;br/&gt;
     }&lt;/p&gt;

&lt;p&gt;+    private void performWrite(Exchange exchange, OutputStream stream, XMLStreamWriter writer, Marshaller marshaller, Object toMarshall) throws JAXBException {&lt;br/&gt;
+        if (asXmlStreamWriter(exchange)) &lt;/p&gt;
{
+            marshaller.marshal(toMarshall, writer);
+        }
&lt;p&gt; else &lt;/p&gt;
{
+            marshaller.marshal(toMarshall, stream);
+        }
&lt;p&gt;+    }&lt;br/&gt;
+&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   With the proposed refactoring, getWriter is called at each marshall attempt (performance) and even when `asXmlStreamWriter(exchange)` is false (behavior change). I would not include this change.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16420815" author="githubbot" created="Fri, 30 Mar 2018 18:29:56 +0000"  >&lt;p&gt;aldettinger commented on a change in pull request #2277: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12415&quot; title=&quot;Camel-jaxb option &amp;quot;encoding&amp;quot; with option &amp;quot;filterNonXmlChars&amp;quot; generate wrong data&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12415&quot;&gt;&lt;del&gt;CAMEL-12415&lt;/del&gt;&lt;/a&gt; - camel-jaxb, fix options combination: encoding,filterNon&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2277#discussion_r178340769&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2277#discussion_r178340769&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: components/camel-jaxb/src/main/java/org/apache/camel/converter/jaxb/FilteringXmlStreamWriter.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -36,13 +36,18 @@&lt;br/&gt;
     NonXmlCharFilterer nonXmlCharFilterer = new NonXmlCharFilterer();&lt;/p&gt;

&lt;p&gt;     private XMLStreamWriter writer;&lt;br/&gt;
+    private String encoding;&lt;/p&gt;

&lt;p&gt;     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;@param writer&lt;/li&gt;
	&lt;li&gt;target writer to wrap.&lt;br/&gt;
+     * @param encoding&lt;br/&gt;
+     *            the encoding to write in header&lt;br/&gt;
+     *&lt;br/&gt;
      */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public FilteringXmlStreamWriter(XMLStreamWriter writer) {&lt;br/&gt;
+    public FilteringXmlStreamWriter(XMLStreamWriter writer, String encoding) {&lt;br/&gt;
         this.writer = writer;&lt;br/&gt;
+        this.encoding = encoding != null ? encoding.toUpperCase() : null;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   Could you please explain why we would need to store it upper case please ?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16420816" author="githubbot" created="Fri, 30 Mar 2018 18:29:56 +0000"  >&lt;p&gt;aldettinger commented on a change in pull request #2277: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12415&quot; title=&quot;Camel-jaxb option &amp;quot;encoding&amp;quot; with option &amp;quot;filterNonXmlChars&amp;quot; generate wrong data&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12415&quot;&gt;&lt;del&gt;CAMEL-12415&lt;/del&gt;&lt;/a&gt; - camel-jaxb, fix options combination: encoding,filterNon&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2277#discussion_r178340643&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2277#discussion_r178340643&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: components/camel-jaxb/src/main/java/org/apache/camel/converter/jaxb/FilteringXmlStreamWriter.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -36,13 +36,18 @@&lt;br/&gt;
     NonXmlCharFilterer nonXmlCharFilterer = new NonXmlCharFilterer();&lt;/p&gt;

&lt;p&gt;     private XMLStreamWriter writer;&lt;br/&gt;
+    private String encoding;&lt;/p&gt;

&lt;p&gt;     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;@param writer&lt;/li&gt;
	&lt;li&gt;target writer to wrap.&lt;br/&gt;
+     * @param encoding&lt;br/&gt;
+     *            the encoding to write in header&lt;br/&gt;
+     *&lt;br/&gt;
      */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public FilteringXmlStreamWriter(XMLStreamWriter writer) {&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   Keeping the old constructor along with the new one would avoid an API break. This way you would leverage the good implementation you have done in `writeStartDocument` overloads.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16420817" author="githubbot" created="Fri, 30 Mar 2018 18:29:56 +0000"  >&lt;p&gt;aldettinger commented on a change in pull request #2277: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12415&quot; title=&quot;Camel-jaxb option &amp;quot;encoding&amp;quot; with option &amp;quot;filterNonXmlChars&amp;quot; generate wrong data&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12415&quot;&gt;&lt;del&gt;CAMEL-12415&lt;/del&gt;&lt;/a&gt; - camel-jaxb, fix options combination: encoding,filterNon&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2277#discussion_r178341934&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2277#discussion_r178341934&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: components/camel-jaxb/src/test/java/org/apache/camel/example/ExplicitEncodingAndXMLCharFilteringTest.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -0,0 +1,85 @@&lt;br/&gt;
+/**&lt;br/&gt;
+ * Licensed to the Apache Software Foundation (ASF) under one or more&lt;br/&gt;
+ * contributor license agreements.  See the NOTICE file distributed with&lt;br/&gt;
+ * this work for additional information regarding copyright ownership.&lt;br/&gt;
+ * The ASF licenses this file to You under the Apache License, Version 2.0&lt;br/&gt;
+ * (the &quot;License&quot;); you may not use this file except in compliance with&lt;br/&gt;
+ * the License.  You may obtain a copy of the License at&lt;br/&gt;
+ *&lt;br/&gt;
+ *      &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
+ *&lt;br/&gt;
+ * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
+ * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
+ * See the License for the specific language governing permissions and&lt;br/&gt;
+ * limitations under the License.&lt;br/&gt;
+ */&lt;br/&gt;
+package org.apache.camel.example;&lt;br/&gt;
+&lt;br/&gt;
+import java.io.FileInputStream;&lt;br/&gt;
+import java.io.InputStream;&lt;br/&gt;
+import java.io.InputStreamReader;&lt;br/&gt;
+import java.io.Reader;&lt;br/&gt;
+&lt;br/&gt;
+import javax.xml.bind.JAXBContext;&lt;br/&gt;
+import javax.xml.bind.Unmarshaller;&lt;br/&gt;
+&lt;br/&gt;
+import org.apache.camel.builder.RouteBuilder;&lt;br/&gt;
+import org.apache.camel.component.mock.MockEndpoint;&lt;br/&gt;
+import org.apache.camel.converter.jaxb.JaxbDataFormat;&lt;br/&gt;
+import org.apache.camel.test.junit4.CamelTestSupport;&lt;br/&gt;
+import org.junit.Test;&lt;br/&gt;
+&lt;br/&gt;
+&lt;br/&gt;
+/**&lt;br/&gt;
+ * @version &lt;br/&gt;
+ */&lt;br/&gt;
+public class ExplicitEncodingAndXMLCharFilteringTest extends CamelTestSupport {&lt;br/&gt;
+&lt;br/&gt;
+    @Override&lt;br/&gt;
+    public void setUp() throws Exception &lt;/p&gt;
{
+        deleteDirectory(&quot;target/charset&quot;);
+        super.setUp();
+    }
&lt;p&gt;+&lt;br/&gt;
+    @Test&lt;br/&gt;
+    public void testIsoAndCharacterFiltering() throws Exception {&lt;br/&gt;
+        PurchaseOrder order = new PurchaseOrder();&lt;br/&gt;
+        //Data containing characters &#198;&#216;&#197;&#230;&#248;&#229; that differ in utf-8 and iso + a spouting whale&lt;br/&gt;
+        String name = &quot;\u00c6\u00d8\u00C5\u00e6\u00f8\u00e5\uD83D\uDC33\uFFFD&quot;;&lt;br/&gt;
+        String expected = &quot;\u00c6\u00d8\u00C5\u00e6\u00f8\u00e5  \uFFFD&quot;; //Spouting whale has become spaces&lt;br/&gt;
+        order.setName(name);&lt;br/&gt;
+        order.setAmount(123.45);&lt;br/&gt;
+        order.setPrice(2.22);&lt;br/&gt;
+&lt;br/&gt;
+        MockEndpoint result = getMockEndpoint(&quot;mock:file&quot;);&lt;br/&gt;
+        result.expectedFileExists(&quot;target/charset/output.xml&quot;);&lt;br/&gt;
+&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   And indeed the resulting file does not contain the spouting whale anymore with your fix. Seems that it was UTF-8 encoded before. Good catch :+1:.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16420818" author="githubbot" created="Fri, 30 Mar 2018 18:29:56 +0000"  >&lt;p&gt;aldettinger commented on a change in pull request #2277: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12415&quot; title=&quot;Camel-jaxb option &amp;quot;encoding&amp;quot; with option &amp;quot;filterNonXmlChars&amp;quot; generate wrong data&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12415&quot;&gt;&lt;del&gt;CAMEL-12415&lt;/del&gt;&lt;/a&gt; - camel-jaxb, fix options combination: encoding,filterNon&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2277#discussion_r178341456&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2277#discussion_r178341456&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: components/camel-jaxb/src/main/java/org/apache/camel/converter/jaxb/JaxbDataFormat.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -258,6 +238,27 @@ void doMarshal(Exchange exchange, Object graph, OutputStream stream, Marshaller&lt;br/&gt;
         }&lt;br/&gt;
     }&lt;/p&gt;

&lt;p&gt;+    private void performWrite(Exchange exchange, OutputStream stream, XMLStreamWriter writer, Marshaller marshaller, Object toMarshall) throws JAXBException {&lt;br/&gt;
+        if (asXmlStreamWriter(exchange)) &lt;/p&gt;
{
+            marshaller.marshal(toMarshall, writer);
+        }
&lt;p&gt; else &lt;/p&gt;
{
+            marshaller.marshal(toMarshall, stream);
+        }
&lt;p&gt;+    }&lt;br/&gt;
+&lt;br/&gt;
+    private XMLStreamWriter getWriter(Exchange exchange, OutputStream stream) {&lt;br/&gt;
+        XMLStreamWriter writer = typeConverter.convertTo(XMLStreamWriter.class, exchange, stream);&lt;br/&gt;
+        if (needFiltering(exchange)) {&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   Moreover, it hides the interesting changes (I mean the 2 lines above)&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16420916" author="githubbot" created="Fri, 30 Mar 2018 20:42:10 +0000"  >&lt;p&gt;IIlllII commented on a change in pull request #2277: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12415&quot; title=&quot;Camel-jaxb option &amp;quot;encoding&amp;quot; with option &amp;quot;filterNonXmlChars&amp;quot; generate wrong data&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12415&quot;&gt;&lt;del&gt;CAMEL-12415&lt;/del&gt;&lt;/a&gt; - camel-jaxb, fix options combination: encoding,filterNon&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2277#discussion_r178374103&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2277#discussion_r178374103&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: components/camel-jaxb/src/main/java/org/apache/camel/converter/jaxb/FilteringXmlStreamWriter.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -36,13 +36,18 @@&lt;br/&gt;
     NonXmlCharFilterer nonXmlCharFilterer = new NonXmlCharFilterer();&lt;/p&gt;

&lt;p&gt;     private XMLStreamWriter writer;&lt;br/&gt;
+    private String encoding;&lt;/p&gt;

&lt;p&gt;     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;@param writer&lt;/li&gt;
	&lt;li&gt;target writer to wrap.&lt;br/&gt;
+     * @param encoding&lt;br/&gt;
+     *            the encoding to write in header&lt;br/&gt;
+     *&lt;br/&gt;
      */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public FilteringXmlStreamWriter(XMLStreamWriter writer) {&lt;br/&gt;
+    public FilteringXmlStreamWriter(XMLStreamWriter writer, String encoding) {&lt;br/&gt;
         this.writer = writer;&lt;br/&gt;
+        this.encoding = encoding != null ? encoding.toUpperCase() : null;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   It is nicer for consumers of the produced XML. While lowercase is allowed by the standard and parsers should support it, there are parsers that break on lowercase. None I know of that break on uppercase.&lt;/p&gt;

&lt;p&gt;   Standard also uses uppercase.&lt;br/&gt;
   &lt;a href=&quot;https://www.iana.org/assignments/character-sets/character-sets.xhtml&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://www.iana.org/assignments/character-sets/character-sets.xhtml&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;   This might break the users expectation though, but in this case it might be nice to help the user do what will cause them the least pain. What do you think?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16420921" author="githubbot" created="Fri, 30 Mar 2018 20:50:07 +0000"  >&lt;p&gt;IIlllII commented on a change in pull request #2277: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12415&quot; title=&quot;Camel-jaxb option &amp;quot;encoding&amp;quot; with option &amp;quot;filterNonXmlChars&amp;quot; generate wrong data&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12415&quot;&gt;&lt;del&gt;CAMEL-12415&lt;/del&gt;&lt;/a&gt; - camel-jaxb, fix options combination: encoding,filterNon&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2277#discussion_r178376173&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2277#discussion_r178376173&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: components/camel-jaxb/src/main/java/org/apache/camel/converter/jaxb/JaxbDataFormat.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -258,6 +238,27 @@ void doMarshal(Exchange exchange, Object graph, OutputStream stream, Marshaller&lt;br/&gt;
         }&lt;br/&gt;
     }&lt;/p&gt;

&lt;p&gt;+    private void performWrite(Exchange exchange, OutputStream stream, XMLStreamWriter writer, Marshaller marshaller, Object toMarshall) throws JAXBException {&lt;br/&gt;
+        if (asXmlStreamWriter(exchange)) &lt;/p&gt;
{
+            marshaller.marshal(toMarshall, writer);
+        }
&lt;p&gt; else &lt;/p&gt;
{
+            marshaller.marshal(toMarshall, stream);
+        }
&lt;p&gt;+    }&lt;br/&gt;
+&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   Thanks, missed that. I&apos;ll revert it.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16421033" author="githubbot" created="Fri, 30 Mar 2018 22:45:50 +0000"  >&lt;p&gt;IIlllII commented on a change in pull request #2277: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12415&quot; title=&quot;Camel-jaxb option &amp;quot;encoding&amp;quot; with option &amp;quot;filterNonXmlChars&amp;quot; generate wrong data&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12415&quot;&gt;&lt;del&gt;CAMEL-12415&lt;/del&gt;&lt;/a&gt; - camel-jaxb, fix options combination: encoding,filterNon&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2277#discussion_r178374103&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2277#discussion_r178374103&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: components/camel-jaxb/src/main/java/org/apache/camel/converter/jaxb/FilteringXmlStreamWriter.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -36,13 +36,18 @@&lt;br/&gt;
     NonXmlCharFilterer nonXmlCharFilterer = new NonXmlCharFilterer();&lt;/p&gt;

&lt;p&gt;     private XMLStreamWriter writer;&lt;br/&gt;
+    private String encoding;&lt;/p&gt;

&lt;p&gt;     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;@param writer&lt;/li&gt;
	&lt;li&gt;target writer to wrap.&lt;br/&gt;
+     * @param encoding&lt;br/&gt;
+     *            the encoding to write in header&lt;br/&gt;
+     *&lt;br/&gt;
      */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public FilteringXmlStreamWriter(XMLStreamWriter writer) {&lt;br/&gt;
+    public FilteringXmlStreamWriter(XMLStreamWriter writer, String encoding) {&lt;br/&gt;
         this.writer = writer;&lt;br/&gt;
+        this.encoding = encoding != null ? encoding.toUpperCase() : null;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   I thought it would nicer for consumers of the produced XML. While lowercase is allowed by the standard and parsers should support it, there are parsers that break on lowercase. None I know of that break on uppercase (this could be because I never have used Shift_JIS, or other encodings with lowercase IANA names, so I can see why forcing uppercase might be a bad idea).&lt;/p&gt;

&lt;p&gt;   I originally thought all IANA names were uppercase, which they are not. And this will take the choice out of the users hands. I&apos;ll remove it.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16422818" author="githubbot" created="Mon, 2 Apr 2018 17:26:08 +0000"  >&lt;p&gt;aldettinger commented on a change in pull request #2277: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12415&quot; title=&quot;Camel-jaxb option &amp;quot;encoding&amp;quot; with option &amp;quot;filterNonXmlChars&amp;quot; generate wrong data&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12415&quot;&gt;&lt;del&gt;CAMEL-12415&lt;/del&gt;&lt;/a&gt; - camel-jaxb, fix options combination: encoding,filterNon&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2277#discussion_r178595397&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2277#discussion_r178595397&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: components/camel-jaxb/src/main/java/org/apache/camel/converter/jaxb/JaxbDataFormat.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -226,9 +227,10 @@ void doMarshal(Exchange exchange, Object graph, OutputStream stream, Marshaller&lt;br/&gt;
                     if (instance != null) {&lt;br/&gt;
                         Object toMarshall = objectFactoryMethod.invoke(instance, element);&lt;br/&gt;
                         if (asXmlStreamWriter(exchange)) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;XMLStreamWriter writer = typeConverter.convertTo(XMLStreamWriter.class, stream);&lt;br/&gt;
+                            XMLStreamWriter writer = typeConverter.convertTo(XMLStreamWriter.class, exchange, stream);&lt;br/&gt;
                             if (needFiltering(exchange)) {&lt;/li&gt;
	&lt;li&gt;writer = new FilteringXmlStreamWriter(writer);&lt;br/&gt;
+                                String charset = exchange.getProperty(Exchange.CHARSET_NAME, String.class);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   Same here , we could also remove this line.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16422819" author="githubbot" created="Mon, 2 Apr 2018 17:26:08 +0000"  >&lt;p&gt;aldettinger commented on a change in pull request #2277: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12415&quot; title=&quot;Camel-jaxb option &amp;quot;encoding&amp;quot; with option &amp;quot;filterNonXmlChars&amp;quot; generate wrong data&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12415&quot;&gt;&lt;del&gt;CAMEL-12415&lt;/del&gt;&lt;/a&gt; - camel-jaxb, fix options combination: encoding,filterNon&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2277#discussion_r178595038&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2277#discussion_r178595038&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: components/camel-jaxb/src/main/java/org/apache/camel/converter/jaxb/JaxbDataFormat.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -206,9 +206,10 @@ void doMarshal(Exchange exchange, Object graph, OutputStream stream, Marshaller&lt;br/&gt;
         // only marshal if its possible&lt;br/&gt;
         if (introspector.isElement(element)) {&lt;br/&gt;
             if (asXmlStreamWriter(exchange)) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;XMLStreamWriter writer = typeConverter.convertTo(XMLStreamWriter.class, stream);&lt;br/&gt;
+                XMLStreamWriter writer = typeConverter.convertTo(XMLStreamWriter.class, exchange, stream);&lt;br/&gt;
                 if (needFiltering(exchange)) {&lt;/li&gt;
	&lt;li&gt;writer = new FilteringXmlStreamWriter(writer);&lt;br/&gt;
+                    String charset = exchange.getProperty(Exchange.CHARSET_NAME, String.class);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   Could you please change the method signature to `doMarshal(..., OutputStream stream, String charset, ...)` and get the charset from there ?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16423061" author="githubbot" created="Mon, 2 Apr 2018 20:09:14 +0000"  >&lt;p&gt;IIlllII commented on issue #2277: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12415&quot; title=&quot;Camel-jaxb option &amp;quot;encoding&amp;quot; with option &amp;quot;filterNonXmlChars&amp;quot; generate wrong data&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12415&quot;&gt;&lt;del&gt;CAMEL-12415&lt;/del&gt;&lt;/a&gt; - camel-jaxb, fix options combination: encoding,filterNon&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2277#issuecomment-378029387&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2277#issuecomment-378029387&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Added requested changes.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16423941" author="githubbot" created="Tue, 3 Apr 2018 12:29:36 +0000"  >&lt;p&gt;oscerd commented on issue #2277: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12415&quot; title=&quot;Camel-jaxb option &amp;quot;encoding&amp;quot; with option &amp;quot;filterNonXmlChars&amp;quot; generate wrong data&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12415&quot;&gt;&lt;del&gt;CAMEL-12415&lt;/del&gt;&lt;/a&gt; - camel-jaxb, fix options combination: encoding,filterNon&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2277#issuecomment-378232536&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2277#issuecomment-378232536&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   @aldettinger can you review? It looks good to me.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16424544" author="githubbot" created="Tue, 3 Apr 2018 20:23:58 +0000"  >&lt;p&gt;aldettinger commented on issue #2277: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12415&quot; title=&quot;Camel-jaxb option &amp;quot;encoding&amp;quot; with option &amp;quot;filterNonXmlChars&amp;quot; generate wrong data&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12415&quot;&gt;&lt;del&gt;CAMEL-12415&lt;/del&gt;&lt;/a&gt; - camel-jaxb, fix options combination: encoding,filterNon&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2277#issuecomment-378385093&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2277#issuecomment-378385093&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Merged into master. Thanks for contribution :+1: .&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16424545" author="githubbot" created="Tue, 3 Apr 2018 20:23:58 +0000"  >&lt;p&gt;aldettinger closed pull request #2277: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12415&quot; title=&quot;Camel-jaxb option &amp;quot;encoding&amp;quot; with option &amp;quot;filterNonXmlChars&amp;quot; generate wrong data&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12415&quot;&gt;&lt;del&gt;CAMEL-12415&lt;/del&gt;&lt;/a&gt; - camel-jaxb, fix options combination: encoding,filterNon&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2277&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2277&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/components/camel-jaxb/src/main/java/org/apache/camel/converter/jaxb/FallbackTypeConverter.java b/components/camel-jaxb/src/main/java/org/apache/camel/converter/jaxb/FallbackTypeConverter.java&lt;br/&gt;
index 8283af650a4..b2ec41bd23f 100644&lt;br/&gt;
&amp;#8212; a/components/camel-jaxb/src/main/java/org/apache/camel/converter/jaxb/FallbackTypeConverter.java&lt;br/&gt;
+++ b/components/camel-jaxb/src/main/java/org/apache/camel/converter/jaxb/FallbackTypeConverter.java&lt;br/&gt;
@@ -298,8 +298,9 @@ protected void doStop() throws Exception {&lt;br/&gt;
             if (isPrettyPrint()) &lt;/p&gt;
{
                 marshaller.setProperty(Marshaller.JAXB_FORMATTED_OUTPUT, Boolean.TRUE);
             }
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (exchange != null &amp;amp;&amp;amp; exchange.getProperty(Exchange.CHARSET_NAME, String.class) != null) {&lt;/li&gt;
	&lt;li&gt;marshaller.setProperty(Marshaller.JAXB_ENCODING, exchange.getProperty(Exchange.CHARSET_NAME, String.class));&lt;br/&gt;
+            String charset = exchange != null ? exchange.getProperty(Exchange.CHARSET_NAME, String.class) : null;&lt;br/&gt;
+            if (charset != null) 
{
+                marshaller.setProperty(Marshaller.JAXB_ENCODING, charset);
             }
&lt;p&gt;             Object toMarshall = value;&lt;br/&gt;
             if (objectFactoryMethod != null) {&lt;br/&gt;
@@ -314,7 +315,7 @@ protected void doStop() throws Exception {&lt;br/&gt;
             }&lt;br/&gt;
             if (needFiltering(exchange)) &lt;/p&gt;
{
                 XMLStreamWriter writer = parentTypeConverter.convertTo(XMLStreamWriter.class, buffer);
-                FilteringXmlStreamWriter filteringWriter = new FilteringXmlStreamWriter(writer);
+                FilteringXmlStreamWriter filteringWriter = new FilteringXmlStreamWriter(writer, charset);
                 marshaller.marshal(toMarshall, filteringWriter);
             }
&lt;p&gt; else {&lt;br/&gt;
                 marshaller.marshal(toMarshall, buffer);&lt;br/&gt;
diff --git a/components/camel-jaxb/src/main/java/org/apache/camel/converter/jaxb/FilteringXmlStreamWriter.java b/components/camel-jaxb/src/main/java/org/apache/camel/converter/jaxb/FilteringXmlStreamWriter.java&lt;br/&gt;
index 7af3d727702..3a82b1443cd 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/components/camel-jaxb/src/main/java/org/apache/camel/converter/jaxb/FilteringXmlStreamWriter.java&lt;br/&gt;
+++ b/components/camel-jaxb/src/main/java/org/apache/camel/converter/jaxb/FilteringXmlStreamWriter.java&lt;br/&gt;
@@ -36,6 +36,7 @@&lt;br/&gt;
     NonXmlCharFilterer nonXmlCharFilterer = new NonXmlCharFilterer();&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     private XMLStreamWriter writer;&lt;br/&gt;
+    private String encoding;&lt;/p&gt;

&lt;p&gt;     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;@param writer&lt;br/&gt;
@@ -45,6 +46,18 @@ public FilteringXmlStreamWriter(XMLStreamWriter writer) 
{
         this.writer = writer;
     }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+    /**&lt;br/&gt;
+     * @param writer&lt;br/&gt;
+     *            target writer to wrap.&lt;br/&gt;
+     * @param encoding&lt;br/&gt;
+     *            the encoding to write in the xml prolog.&lt;br/&gt;
+     *&lt;br/&gt;
+     */&lt;br/&gt;
+    public FilteringXmlStreamWriter(XMLStreamWriter writer, String encoding) &lt;/p&gt;
{
+        this.writer = writer;
+        this.encoding = encoding;
+    }
&lt;p&gt;+&lt;br/&gt;
     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;This method applies filtering before delegating call to 
{@link #writer}
&lt;p&gt;.&lt;br/&gt;
      */&lt;br/&gt;
@@ -181,7 +194,11 @@ public void writeProcessingInstruction(String target) throws XMLStreamException&lt;br/&gt;
     }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     public void writeStartDocument() throws XMLStreamException {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;writer.writeStartDocument();&lt;br/&gt;
+        if (encoding != null) 
{
+            this.writeStartDocument(encoding, null);
+        }
&lt;p&gt; else &lt;/p&gt;
{
+            writer.writeStartDocument();
+        }
&lt;p&gt;     }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     public void writeStartDocument(String encoding, String version) throws XMLStreamException &lt;/p&gt;
{
@@ -189,7 +206,11 @@ public void writeStartDocument(String encoding, String version) throws XMLStream
     }

&lt;p&gt;     public void writeStartDocument(String version) throws XMLStreamException {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;writer.writeStartDocument(version);&lt;br/&gt;
+        if (encoding != null) 
{
+            this.writeStartDocument(encoding, version);
+        }
&lt;p&gt; else &lt;/p&gt;
{
+            writer.writeStartDocument(version);
+        }
&lt;p&gt;     }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     public void writeStartElement(String prefix, String localName, String namespaceURI)&lt;br/&gt;
diff --git a/components/camel-jaxb/src/main/java/org/apache/camel/converter/jaxb/JaxbDataFormat.java b/components/camel-jaxb/src/main/java/org/apache/camel/converter/jaxb/JaxbDataFormat.java&lt;br/&gt;
index ea74d37dad5..35a208aa4e2 100644&lt;br/&gt;
&amp;#8212; a/components/camel-jaxb/src/main/java/org/apache/camel/converter/jaxb/JaxbDataFormat.java&lt;br/&gt;
+++ b/components/camel-jaxb/src/main/java/org/apache/camel/converter/jaxb/JaxbDataFormat.java&lt;br/&gt;
@@ -168,7 +168,7 @@ public void marshal(Exchange exchange, Object graph, OutputStream stream) throws&lt;br/&gt;
                     marshaller.setProperty(property.getKey(), property.getValue());&lt;br/&gt;
                 }&lt;br/&gt;
             }&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;doMarshal(exchange, graph, stream, marshaller);&lt;br/&gt;
+            doMarshal(exchange, graph, stream, marshaller, charset);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;             if (contentTypeHeader) {&lt;br/&gt;
                 if (exchange.hasOut()) &lt;/p&gt;
{
@@ -182,7 +182,7 @@ public void marshal(Exchange exchange, Object graph, OutputStream stream) throws
         }
&lt;p&gt;     }&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;void doMarshal(Exchange exchange, Object graph, OutputStream stream, Marshaller marshaller) throws Exception {&lt;br/&gt;
+    void doMarshal(Exchange exchange, Object graph, OutputStream stream, Marshaller marshaller, String charset) throws Exception {&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         Object element = graph;&lt;br/&gt;
         QName partNamespaceOnDataFormat = getPartNamespace();&lt;br/&gt;
@@ -206,9 +206,9 @@ void doMarshal(Exchange exchange, Object graph, OutputStream stream, Marshaller&lt;br/&gt;
         // only marshal if its possible&lt;br/&gt;
         if (introspector.isElement(element)) {&lt;br/&gt;
             if (asXmlStreamWriter(exchange)) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;XMLStreamWriter writer = typeConverter.convertTo(XMLStreamWriter.class, stream);&lt;br/&gt;
+                XMLStreamWriter writer = typeConverter.convertTo(XMLStreamWriter.class, exchange, stream);&lt;br/&gt;
                 if (needFiltering(exchange)) 
{
-                    writer = new FilteringXmlStreamWriter(writer);
+                    writer = new FilteringXmlStreamWriter(writer, charset);
                 }
&lt;p&gt;                 if (xmlStreamWriterWrapper != null) {&lt;br/&gt;
                     writer = xmlStreamWriterWrapper.wrapWriter(writer);&lt;br/&gt;
@@ -226,9 +226,9 @@ void doMarshal(Exchange exchange, Object graph, OutputStream stream, Marshaller&lt;br/&gt;
                     if (instance != null) {&lt;br/&gt;
                         Object toMarshall = objectFactoryMethod.invoke(instance, element);&lt;br/&gt;
                         if (asXmlStreamWriter(exchange)) {&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;XMLStreamWriter writer = typeConverter.convertTo(XMLStreamWriter.class, stream);&lt;br/&gt;
+                            XMLStreamWriter writer = typeConverter.convertTo(XMLStreamWriter.class, exchange, stream);&lt;br/&gt;
                             if (needFiltering(exchange)) 
{
-                                writer = new FilteringXmlStreamWriter(writer);
+                                writer = new FilteringXmlStreamWriter(writer, charset);
                             }
&lt;p&gt;                             if (xmlStreamWriterWrapper != null) &lt;/p&gt;
{
                                 writer = xmlStreamWriterWrapper.wrapWriter(writer);
@@ -257,7 +257,7 @@ void doMarshal(Exchange exchange, Object graph, OutputStream stream, Marshaller
             throw new InvalidPayloadException(exchange, JAXBElement.class);
         }
&lt;p&gt;     }&lt;br/&gt;
-&lt;br/&gt;
+    &lt;br/&gt;
     private boolean asXmlStreamWriter(Exchange exchange) &lt;/p&gt;
{
         return needFiltering(exchange) || (xmlStreamWriterWrapper != null);
     }
&lt;p&gt;diff --git a/components/camel-jaxb/src/test/java/org/apache/camel/example/ExplicitEncodingAndXMLCharFilteringTest.java b/components/camel-jaxb/src/test/java/org/apache/camel/example/ExplicitEncodingAndXMLCharFilteringTest.java&lt;br/&gt;
new file mode 100644&lt;br/&gt;
index 00000000000..3adb9c3b252&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;/dev/null&lt;br/&gt;
+++ b/components/camel-jaxb/src/test/java/org/apache/camel/example/ExplicitEncodingAndXMLCharFilteringTest.java&lt;br/&gt;
@@ -0,0 +1,85 @@&lt;br/&gt;
+/**&lt;br/&gt;
+ * Licensed to the Apache Software Foundation (ASF) under one or more&lt;br/&gt;
+ * contributor license agreements.  See the NOTICE file distributed with&lt;br/&gt;
+ * this work for additional information regarding copyright ownership.&lt;br/&gt;
+ * The ASF licenses this file to You under the Apache License, Version 2.0&lt;br/&gt;
+ * (the &quot;License&quot;); you may not use this file except in compliance with&lt;br/&gt;
+ * the License.  You may obtain a copy of the License at&lt;br/&gt;
+ *&lt;br/&gt;
+ *      &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
+ *&lt;br/&gt;
+ * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
+ * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
+ * See the License for the specific language governing permissions and&lt;br/&gt;
+ * limitations under the License.&lt;br/&gt;
+ */&lt;br/&gt;
+package org.apache.camel.example;&lt;br/&gt;
+&lt;br/&gt;
+import java.io.FileInputStream;&lt;br/&gt;
+import java.io.InputStream;&lt;br/&gt;
+import java.io.InputStreamReader;&lt;br/&gt;
+import java.io.Reader;&lt;br/&gt;
+&lt;br/&gt;
+import javax.xml.bind.JAXBContext;&lt;br/&gt;
+import javax.xml.bind.Unmarshaller;&lt;br/&gt;
+&lt;br/&gt;
+import org.apache.camel.builder.RouteBuilder;&lt;br/&gt;
+import org.apache.camel.component.mock.MockEndpoint;&lt;br/&gt;
+import org.apache.camel.converter.jaxb.JaxbDataFormat;&lt;br/&gt;
+import org.apache.camel.test.junit4.CamelTestSupport;&lt;br/&gt;
+import org.junit.Test;&lt;br/&gt;
+&lt;br/&gt;
+&lt;br/&gt;
+/**&lt;br/&gt;
+ * @version &lt;br/&gt;
+ */&lt;br/&gt;
+public class ExplicitEncodingAndXMLCharFilteringTest extends CamelTestSupport {&lt;br/&gt;
+&lt;br/&gt;
+    @Override&lt;br/&gt;
+    public void setUp() throws Exception 
{
+        deleteDirectory(&quot;target/charset&quot;);
+        super.setUp();
+    }
&lt;p&gt;+&lt;br/&gt;
+    @Test&lt;br/&gt;
+    public void testIsoAndCharacterFiltering() throws Exception &lt;/p&gt;
{
+        PurchaseOrder order = new PurchaseOrder();
+        //Data containing characters &#198;&#216;&#197;&#230;&#248;&#229; that differ in utf-8 and iso + a spouting whale
+        String name = &quot;\u00c6\u00d8\u00C5\u00e6\u00f8\u00e5\uD83D\uDC33\uFFFD&quot;;
+        String expected = &quot;\u00c6\u00d8\u00C5\u00e6\u00f8\u00e5  \uFFFD&quot;; //Spouting whale has become spaces
+        order.setName(name);
+        order.setAmount(123.45);
+        order.setPrice(2.22);
+
+        MockEndpoint result = getMockEndpoint(&quot;mock:file&quot;);
+        result.expectedFileExists(&quot;target/charset/output.xml&quot;);
+
+        template.sendBody(&quot;direct:start&quot;, order);
+        assertMockEndpointsSatisfied();
+
+        JAXBContext jaxbContext = JAXBContext.newInstance(&quot;org.apache.camel.example&quot;);
+        Unmarshaller unmarshaller = jaxbContext.createUnmarshaller();
+        InputStream inputStream = new FileInputStream(&quot;target/charset/output.xml&quot;);
+        Reader reader = new InputStreamReader(inputStream, &quot;ISO-8859-1&quot;);
+        PurchaseOrder obj = (PurchaseOrder) unmarshaller.unmarshal(reader);
+        assertEquals(expected, obj.getName());
+    }
&lt;p&gt;+&lt;br/&gt;
+    @Override&lt;br/&gt;
+    protected RouteBuilder createRouteBuilder() throws Exception {&lt;br/&gt;
+        return new RouteBuilder() &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+            @Override+            public void configure() throws Exception {
+                JaxbDataFormat jaxb = new JaxbDataFormat(&quot;org.apache.camel.example&quot;);
+                jaxb.setFilterNonXmlChars(true);
+                jaxb.setEncoding(&quot;iso-8859-1&quot;);
+
+                from(&quot;direct:start&quot;)
+                        .marshal(jaxb)
+                        .to(&quot;file:target/charset/?fileName=output.xml&amp;amp;charset=iso-8859-1&quot;);
+            }+        }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;;&lt;br/&gt;
+    }&lt;br/&gt;
+&lt;br/&gt;
+}&lt;/p&gt;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16424546" author="githubbot" created="Tue, 3 Apr 2018 20:23:59 +0000"  >&lt;p&gt;Github user aldettinger closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/2277&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2277&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16429276" author="davsclaus" created="Sat, 7 Apr 2018 07:41:34 +0000"  >&lt;p&gt;I wonder if this is a candidate to backport to 2.21.x branch ?&lt;/p&gt;</comment>
                            <comment id="16429421" author="aldettinger" created="Sat, 7 Apr 2018 15:35:43 +0000"  >&lt;p&gt;Indeed, it&apos;s safe. I will backport.&lt;/p&gt;</comment>
                            <comment id="16429423" author="aldettinger" created="Sat, 7 Apr 2018 15:41:22 +0000"  >&lt;p&gt;Will backport to maintenance branches 2.21.x.&lt;/p&gt;</comment>
                            <comment id="16429430" author="aldettinger" created="Sat, 7 Apr 2018 15:46:26 +0000"  >&lt;p&gt;ok, merged into master and camel-2.21.x&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 32 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3rybj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>