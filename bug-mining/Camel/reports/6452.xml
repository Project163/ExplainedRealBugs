<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 11:01:04 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-19359] camel-spring-boot - When camel start graceful shutdown, it still receive new request during graceful shutdown.</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-19359</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;&amp;lt; camel graceful shutdown time = 20s, the service thread.sleep = 10s &amp;gt;&lt;br/&gt;
In my test case, at first I started the application, send the first request and then stop the JVM to run the camel graceful shutdown, in the console show that there have 2 infilght messages pending to complete, after about 4 sec, I send the second request, in theroy, camel shouldn&apos;t accept the second request, unfortunately, it still receive new request.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/chen19980/GracefulShutdown-test&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;TestCode&lt;/a&gt;&lt;/p&gt;</description>
                <environment>&lt;p&gt;I use the DefaultShutdownStrategy.&lt;/p&gt;

&lt;p&gt;&amp;lt; the module is camel-base-engine 3.20.4 &amp;gt;&lt;/p&gt;</environment>
        <key id="13536367">CAMEL-19359</key>
            <summary>camel-spring-boot - When camel start graceful shutdown, it still receive new request during graceful shutdown.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="chen19980">adam chen</reporter>
                        <labels>
                    </labels>
                <created>Tue, 16 May 2023 07:07:40 +0000</created>
                <updated>Thu, 31 Aug 2023 02:06:17 +0000</updated>
                            <resolved>Tue, 23 May 2023 04:53:42 +0000</resolved>
                                    <version>3.20.4</version>
                                    <fixVersion>3.21.0</fixVersion>
                    <fixVersion>4.0-RC1</fixVersion>
                    <fixVersion>4.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="432000">120h</timeoriginalestimate>
                            <timeestimate seconds="432000">120h</timeestimate>
                                        <comments>
                            <comment id="17723023" author="davsclaus" created="Tue, 16 May 2023 07:21:28 +0000"  >&lt;p&gt;Are you talking about this in the chat room, if so add a link to that conversation.&lt;/p&gt;</comment>
                            <comment id="17723024" author="davsclaus" created="Tue, 16 May 2023 07:22:36 +0000"  >&lt;p&gt;You need to put together a sample project that reproduces what you try to do, you can attach this this JIRA as .zip or put the code in github etc.&lt;/p&gt;</comment>
                            <comment id="17723025" author="JIRAUSER298919" created="Tue, 16 May 2023 07:22:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt; Yesss, I already add the link in the conversation.&lt;/p&gt;</comment>
                            <comment id="17724584" author="JIRAUSER298919" created="Sun, 21 May 2023 04:34:37 +0000"  >&lt;p&gt;Is there have any solutions to solve this issue ?&lt;/p&gt;</comment>
                            <comment id="17724591" author="davsclaus" created="Sun, 21 May 2023 07:43:34 +0000"  >&lt;p&gt;This is a big example, can it run database and whatnot. We don&apos;t have a lot of time to investigate end user applications if they can&apos;t easily be run standalone and demonstrate what your problem is.&lt;/p&gt;</comment>
                            <comment id="17724639" author="JIRAUSER298919" created="Sun, 21 May 2023 12:15:43 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt; OK, I will offer another simple example.&lt;/p&gt;</comment>
                            <comment id="17724667" author="JIRAUSER298919" created="Sun, 21 May 2023 14:16:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt; Here is a simple code for test graceful shutdown. &lt;a href=&quot;https://github.com/chen19980/GracefulShutdown-test&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Simple code&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17724685" author="davsclaus" created="Sun, 21 May 2023 15:43:16 +0000"  >&lt;p&gt;Thank you for the smaller example&lt;/p&gt;</comment>
                            <comment id="17724687" author="davsclaus" created="Sun, 21 May 2023 15:46:20 +0000"  >&lt;p&gt;Okay if I run this with &lt;/p&gt;

&lt;p&gt;mvn spring-boot:run&lt;/p&gt;

&lt;p&gt;And I can call the service via that curl command.&lt;/p&gt;

&lt;p&gt;And then if I stop the spring boot application (ctrl + c) then it stops nicely. So we need to find a way to simulate a shutdown that is taking time, and let Spring Boot still send messages into Camel.&lt;/p&gt;</comment>
                            <comment id="17724689" author="JIRAUSER298919" created="Sun, 21 May 2023 15:52:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt; Yes. I have set a thread.sleep() method in the service to simulate a shutdown in taking time.&lt;/p&gt;

&lt;p&gt;If I stop the SB application and send the second request, the camel still receive request.&lt;/p&gt;</comment>
                            <comment id="17724693" author="davsclaus" created="Sun, 21 May 2023 16:11:54 +0000"  >&lt;p&gt;Okay I can simulate this by just doing a kill -sigint &amp;lt;pid&amp;gt; and then have breakpoints in shutdown code in SB and Camel.&lt;/p&gt;
</comment>
                            <comment id="17724694" author="JIRAUSER298919" created="Sun, 21 May 2023 16:22:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt;&#160; Ok. If you fix this problem, let me know what to do. Thanks&lt;/p&gt;</comment>
                            <comment id="17724892" author="davsclaus" created="Mon, 22 May 2023 11:11:28 +0000"  >&lt;p&gt;so spring boot graceful shutdown is only its own http server.&lt;/p&gt;

&lt;p&gt;In camel you always have graceful shutdown, and Camel takes care of processing inflight in graceful manner.&lt;br/&gt;
So if you turn of spring boot graceful shutdown, then SB will stop HTTP server quickly, and Camel will let inflight messages complete and shutdown gracefully.&lt;/p&gt;

&lt;p&gt;So it only makes sense to use SB graceful if you use other non Camel HTTP services with SB and want those to graceful shutdown.&lt;/p&gt;
</comment>
                            <comment id="17724893" author="davsclaus" created="Mon, 22 May 2023 11:18:23 +0000"  >&lt;p&gt;Okay I have changed the shutdown order in camel-spring so its done a bit later, this allows SB tomcat http server to shutdown first&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2023-05-22T13:17:16.168+02:00  INFO 39155 --- [ionShutdownHook] o.s.b.w.e.tomcat.GracefulShutdown        : Commencing graceful shutdown. Waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; active requests to complete
2023-05-22T13:17:16.960+02:00  INFO 39155 --- [tomcat-shutdown] o.s.b.w.e.tomcat.GracefulShutdown        : Graceful shutdown complete
2023-05-22T13:17:17.954+02:00  INFO 39155 --- [ionShutdownHook] o.a.c.c.s.CamelHttpTransportServlet      : Destroyed CamelHttpTransportServlet[CamelServlet]
2023-05-22T13:17:18.446+02:00  INFO 39155 --- [ionShutdownHook] o.a.c.impl.engine.AbstractCamelContext   : Apache Camel 4.0.0-SNAPSHOT (TestCamelSaga) is shutting down (timeout:20s)
2023-05-22T13:17:21.295+02:00  INFO 39155 --- [ionShutdownHook] o.a.c.i.engine.DefaultShutdownStrategy   : Starting to graceful shutdown 13 routes (timeout 20 seconds)
...
2023-05-22T13:17:21.318+02:00  INFO 39155 --- [ionShutdownHook] o.a.c.impl.engine.AbstractCamelContext   :     Stopped route1 (&lt;span class=&quot;code-keyword&quot;&gt;rest&lt;/span&gt;-api:&lt;span class=&quot;code-comment&quot;&gt;///api-doc)
&lt;/span&gt;2023-05-22T13:17:21.318+02:00  INFO 39155 --- [ionShutdownHook] o.a.c.impl.engine.AbstractCamelContext   :     Stopped route2 (direct:&lt;span class=&quot;code-comment&quot;&gt;//databases)
&lt;/span&gt;2023-05-22T13:17:21.321+02:00  INFO 39155 --- [ionShutdownHook] o.a.c.impl.engine.AbstractCamelContext   : Apache Camel 4.0.0-SNAPSHOT (TestCamelSaga) shutdown in 2s874ms (uptime:33s)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17724897" author="JIRAUSER298919" created="Mon, 22 May 2023 11:25:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt; Amazing!!! Thanks for you help. In my past test, when SB start graceful shutdown, it can&apos;t receive new request during shutdownning. But in SB with camel, I found that SB will start graceful shutdown after camel executing so it always not block the new request. And what time does the fix version will release ? Thanks.&lt;/p&gt;</comment>
                            <comment id="17724899" author="davsclaus" created="Mon, 22 May 2023 11:28:28 +0000"  >&lt;p&gt;You can try NOT to use SB graceful shutdown with your example, and only use Camel shutdown.&lt;/p&gt;

&lt;p&gt;A fix is pending for Camel v4, and potentially backported to Camel 3.21&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/camel/pull/10184&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/10184&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17724902" author="davsclaus" created="Mon, 22 May 2023 11:32:44 +0000"  >&lt;p&gt;I created &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-19377&quot; title=&quot;camel-platform-http - Return 503 if consumer is suspended&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-19377&quot;&gt;&lt;del&gt;CAMEL-19377&lt;/del&gt;&lt;/a&gt; as Camel should ideally also handled graceful shutdown by not accepting incoming http traffic. We do this in the older servlet based, but not the newer platform-http&lt;/p&gt;</comment>
                            <comment id="17724915" author="davsclaus" created="Mon, 22 May 2023 11:49:10 +0000"  >&lt;p&gt;Okay so in your example, then camel-servlet is in use, and it will suspend when Camel does graceful shutdown, and calling it will return 503&lt;/p&gt;

&lt;p&gt;~/workspace &#10095; curl --location --request GET &apos;http://localhost:9090/camel/databases&apos;                                                                                          4s&lt;/p&gt;
{&quot;timestamp&quot;:&quot;2023-05-22T11:48:05.078+00:00&quot;,&quot;status&quot;:503,&quot;error&quot;:&quot;Service Unavailable&quot;,&quot;path&quot;:&quot;/camel/databases&quot;}
&lt;p&gt;%&lt;/p&gt;</comment>
                            <comment id="17724924" author="JIRAUSER298919" created="Mon, 22 May 2023 12:05:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt; So in my TestCode, use camel-servlet is a right desicion? It can block the second request when camel during graceful shutdownning. Right?&lt;/p&gt;</comment>
                            <comment id="17724925" author="davsclaus" created="Mon, 22 May 2023 12:10:03 +0000"  >&lt;p&gt;yes camel-servlet will block 2nd request as shown above with the 503 response code (that is from camel, without spring boot graceful shutdown)&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13537159">CAMEL-19377</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13058238" name="2023-05-16 10 24 30.jpg" size="259724" author="chen19980" created="Tue, 16 May 2023 07:07:13 +0000"/>
                            <attachment id="13058239" name="2023-05-16 10 26 23.jpg" size="260108" author="chen19980" created="Tue, 16 May 2023 07:07:13 +0000"/>
                            <attachment id="13058240" name="2023-05-16 10 27 58.jpg" size="535533" author="chen19980" created="Tue, 16 May 2023 07:07:16 +0000"/>
                            <attachment id="13058241" name="2023-05-16 15 13 59.jpg" size="31384" author="chen19980" created="Tue, 16 May 2023 07:15:19 +0000"/>
                            <attachment id="13058407" name="&#25130;&#22294; 2023-05-22 20.23.23.png" size="107632" author="chen19980" created="Mon, 22 May 2023 12:26:42 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10062"><![CDATA[Moderate]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10431"><![CDATA[Important]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12314421" key="com.atlassian.jira.plugin.system.customfieldtypes:labels">
                        <customfieldname>Language</customfieldname>
                        <customfieldvalues>
                                        <label>Java</label>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 25 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1hx60:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>