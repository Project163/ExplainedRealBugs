<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 11:01:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-19491] Failing healthcheck on aws2-* polling consumers causes readiness check to be stuck</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-19491</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;update: First observed on SQS component, but other aws polling consumers affected as well.&lt;/p&gt;

&lt;p&gt;If a Sqs2ConsumerHealthCheck returns DOWN, then it will not recover back to UP, despite the consumer polling messages and processing them successfully.&lt;/p&gt;

&lt;p&gt;Detected on SQS, but likely all aws2 components are affected by this.&lt;/p&gt;

&lt;p&gt;We have experienced this a few times in production now (on various camel 2.20.x versions), including 3.20.5.&lt;/p&gt;

&lt;p&gt;Actual output from our readiness check:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;{&quot;status&quot;:&quot;DOWN&quot;,&quot;components&quot;:{&quot;camelHealth&quot;:{&quot;status&quot;:&quot;DOWN&quot;,&quot;details&quot;:{&quot;name&quot;:&quot;camel-health-check&quot;,&quot;consumer:queue_name&quot;:&quot;DOWN&quot;}},&quot;db&quot;:{&quot;status&quot;:&quot;UP&quot;,&quot;details&quot;:{&quot;database&quot;:&quot;MariaDB&quot;,&quot;validationQuery&quot;:&quot;isValid()&quot;}},&quot;diskSpace&quot;:{&quot;status&quot;:&quot;UP&quot;,&quot;details&quot;:{&quot;total&quot;:64411906048,&quot;free&quot;:13194371072,&quot;threshold&quot;:10485760,&quot;exists&quot;:true}},&quot;ping&quot;:{&quot;status&quot;:&quot;UP&quot;},&quot;readinessState&quot;:{&quot;status&quot;:&quot;UP&quot;}}}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Notice how the health check prefix is absent: aws2-sqs-consumer-&lt;/p&gt;

&lt;p&gt;I noticed that the tests of this functionality are manually plumbing the setup.&lt;/p&gt;

&lt;p&gt;I also see that Sqs2ConsumerHealthCheck extends AbstractHealthCheck, but shouldn&apos;t this be ConsumerHealthCheck instead?&lt;/p&gt;

&lt;p&gt;My availability does not allow for attempting to fix this myself, thus I&apos;ve just created this ticket for now, maybe someone else is up for grabbing it.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13541149">CAMEL-19491</key>
            <summary>Failing healthcheck on aws2-* polling consumers causes readiness check to be stuck</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="smox">Simon Rasmussen</reporter>
                        <labels>
                            <label>easy</label>
                            <label>help-wanted</label>
                    </labels>
                <created>Fri, 23 Jun 2023 09:57:41 +0000</created>
                <updated>Thu, 27 Jul 2023 16:10:51 +0000</updated>
                            <resolved>Thu, 27 Jul 2023 16:10:51 +0000</resolved>
                                    <version>3.20.5</version>
                                    <fixVersion>3.20.7</fixVersion>
                    <fixVersion>3.21.1</fixVersion>
                    <fixVersion>3.22.0</fixVersion>
                    <fixVersion>4.0.0</fixVersion>
                                    <component>camel-aws2</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17736438" author="smox" created="Fri, 23 Jun 2023 10:00:05 +0000"  >&lt;p&gt;Linking to &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-19281&quot; title=&quot;Aws2- healthchecks not closing resources for awsClient&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-19281&quot;&gt;&lt;del&gt;CAMEL-19281&lt;/del&gt;&lt;/a&gt; as this could be the actual cause of that bug (mistakenly observed as a connection leak).&lt;/p&gt;</comment>
                            <comment id="17736443" author="ancosen" created="Fri, 23 Jun 2023 10:17:34 +0000"  >&lt;p&gt;Also &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-19314&quot; title=&quot;camel-aws - Connection pool shutdown when aws health checks are used&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-19314&quot;&gt;&lt;del&gt;CAMEL-19314&lt;/del&gt;&lt;/a&gt; is involved I suppose. &lt;/p&gt;</comment>
                            <comment id="17737521" author="davsclaus" created="Tue, 27 Jun 2023 08:17:39 +0000"  >&lt;p&gt;Can you try with 3.20.6&lt;/p&gt;</comment>
                            <comment id="17737790" author="JIRAUSER297305" created="Tue, 27 Jun 2023 16:58:49 +0000"  >&lt;p&gt;Hi,&#160;&lt;/p&gt;

&lt;p&gt;Looking at code source, looks like the reconnect is not called until the consumer polling messages and processing them successfully. Thus, the health check uses an invalid client/connection.&lt;/p&gt;</comment>
                            <comment id="17743669" author="smox" created="Mon, 17 Jul 2023 08:17:33 +0000"  >&lt;p&gt;We will try to upgrade to 3.20.6, but judging from &lt;a href=&quot;https://camel.apache.org/releases/release-3.20.6/,&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://camel.apache.org/releases/release-3.20.6&lt;/a&gt; release notes, there are no changes which could have fixed this...&lt;/p&gt;

&lt;p&gt;It is not easy to reproduce this as it requires a call to `listQueues` to actually fail. Maybe we can instruct `AmazonSQSClientMock` to fail in this way, or test this by temporarily revoking the permissions to `listQueue` for the user calling it.&lt;/p&gt;

&lt;p&gt;We will do a bit more digging on this issue and report back.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rhuanrocha&quot; class=&quot;user-hover&quot; rel=&quot;rhuanrocha&quot;&gt;rhuanrocha&lt;/a&gt; , I don&apos;t think your analysis on this issue is correct. The reConnectToQueue() is used only in case of&#160; QueueDoesNotExistException which occurs when a queue is not created yet. It is then attempted to be created (if there is enough permissions to do so). This is definitely not what we are being hit by. We have our application running for days, and then a single request to listQueues fails in the health check, this causes the health check to not be called ever again, and camel is reported as DOWN. I&apos;m guessing that something in the health check infrastructure is incorrect in camel itself which causes it to not retry the health check. Meanwhile, polling happily continues...&lt;/p&gt;</comment>
                            <comment id="17743817" author="JIRAUSER297305" created="Mon, 17 Jul 2023 14:04:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=smox&quot; class=&quot;user-hover&quot; rel=&quot;smox&quot;&gt;smox&lt;/a&gt; thank you for the explanation.&#160;&lt;/p&gt;</comment>
                            <comment id="17747358" author="davsclaus" created="Wed, 26 Jul 2023 07:59:22 +0000"  >&lt;p&gt;Health checks are executed on-demand, eg on SB via calling the /actuator/health.&lt;/p&gt;

&lt;p&gt;There is no periodical job that performs checks inside Camel.&lt;br/&gt;
So if last check was DOWN, then your platform should call SB /acutuator/health periodically to check what is the latest status.&lt;/p&gt;</comment>
                            <comment id="17747387" author="smox" created="Wed, 26 Jul 2023 08:40:29 +0000"  >&lt;p&gt;We do call it, but it remains DOWN.&lt;/p&gt;</comment>
                            <comment id="17747399" author="davsclaus" created="Wed, 26 Jul 2023 09:00:56 +0000"  >&lt;p&gt;Yeah since the sqs consumer is polling batched, then it could use the default health check instead, which is based on last poll was success or error. &lt;/p&gt;

&lt;p&gt;So Sqs2ConsumerHealthCheck is not really needed. If you have a chance then you can try a custom build JAR where you remove the Sqs2ConsumerHealthCheck and use the default check instead.&lt;/p&gt;</comment>
                            <comment id="17747416" author="smox" created="Wed, 26 Jul 2023 09:32:22 +0000"  >&lt;p&gt;You mean to use &lt;font color=&quot;#000000&quot;&gt;ScheduledPollConsumerHealthCheck&lt;/font&gt;, right? This solution is much more logical to me as well rather than arbitary listQueues which doesn&apos;t actually tell if polling works or not!&lt;/p&gt;</comment>
                            <comment id="17747421" author="ancosen" created="Wed, 26 Jul 2023 09:38:03 +0000"  >&lt;p&gt;This is also for validating the credentials. How would you call the api? The aim of this health check is also to validate your creds &lt;/p&gt;</comment>
                            <comment id="17747431" author="smox" created="Wed, 26 Jul 2023 10:02:10 +0000"  >&lt;p&gt;Isn&apos;t the first poll enough to know if authentication works?&#160; getClient().receiveMessage(requestBuild) won&apos;t succeed without proper authentication, thus the result of the next health check query will be DOWN&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17747433" author="davsclaus" created="Wed, 26 Jul 2023 10:04:05 +0000"  >&lt;p&gt;Yes correct. Its also due to that the polling health check was added later than aws, so we had to make special checks for aws.&lt;br/&gt;
And IMHO its also better to make the health check the same api as the consumer would do (receive messages).&lt;/p&gt;
</comment>
                            <comment id="17747438" author="smox" created="Wed, 26 Jul 2023 10:12:35 +0000"  >&lt;p&gt;I will make this experiment in our system, and then report back if our assumptions are correct (and make PR once confirmed).&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13401295">CAMEL-16975</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13533264">CAMEL-19281</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10061"><![CDATA[Novice]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 16 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1iqls:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>