<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:48:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-16794] camel-core - race condition in LoopProcessor</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-16794</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;I get random errors when using the Loop EIP with more than one concurrent request. It started happening from release 3.8.0.&lt;br/&gt;
 This reproduces it:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
from(&lt;span class=&quot;code-quote&quot;&gt;&quot;servlet:test&quot;&lt;/span&gt;)
    .log(&lt;span class=&quot;code-quote&quot;&gt;&quot;test.exchangeId=${exchangeId}&quot;&lt;/span&gt;)
    .loop(1)
        .log(&lt;span class=&quot;code-quote&quot;&gt;&quot;loop.exchangeId=${exchangeId}&quot;&lt;/span&gt;)
.end();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;When testing with the following the client times out:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ab -n1000 -c 2 http:&lt;span class=&quot;code-comment&quot;&gt;//localhost:8080/camel/test&lt;/span&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Note in the logs below how thread 4 starts working on exchange&#160;&lt;tt&gt;0FBD82C2E690DA5-0000000000000018&lt;/tt&gt; but then switches to exchange &lt;tt&gt;0FBD82C2E690DA5-0000000000000017&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;This is because the state is created and then scheduled in a non atomic way, so by the time it gets scheduled another thread has changed it:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
state = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; LoopState(exchange, callback);

&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (exchange.isTransacted()) {
   reactiveExecutor.scheduleSync(state);
} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
   reactiveExecutor.scheduleMain(state);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2021-07-08 10:04:28.717 TRACE 18495 --- [nio-8080-exec-4] o.a.c.i.engine.CamelInternalProcessor    : Processing exchange &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; exchangeId: 0FBD82C2E690DA5-0000000000000018 -&amp;gt; Exchange[0FBD82C2E690DA5-0000000000000018]
2021-07-08 10:04:28.717 TRACE 18495 --- [nio-8080-exec-5] o.a.c.i.engine.CamelInternalProcessor    : Processing exchange &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; exchangeId: 0FBD82C2E690DA5-0000000000000017 -&amp;gt; Exchange[0FBD82C2E690DA5-0000000000000017]
2021-07-08 10:04:28.717 TRACE 18495 --- [nio-8080-exec-4] o.a.c.i.engine.DefaultReactiveExecutor   : Schedule [first=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, main=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, sync=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;]: SimpleTask
2021-07-08 10:04:28.717 TRACE 18495 --- [nio-8080-exec-5] o.a.c.i.engine.DefaultReactiveExecutor   : Schedule [first=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, main=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, sync=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;]: SimpleTask
2021-07-08 10:04:28.717 TRACE 18495 --- [nio-8080-exec-4] o.a.c.i.engine.DefaultReactiveExecutor   : Queuing reactive work: SimpleTask
2021-07-08 10:04:28.717 TRACE 18495 --- [nio-8080-exec-5] o.a.c.i.engine.DefaultReactiveExecutor   : Queuing reactive work: SimpleTask
2021-07-08 10:04:28.717 TRACE 18495 --- [nio-8080-exec-4] o.a.c.i.engine.CamelInternalProcessor    : Exchange processed and is continued routed asynchronously &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; exchangeId: 0FBD82C2E690DA5-0000000000000018 -&amp;gt; Exchange[0FBD82C2E690DA5-0000000000000018]
2021-07-08 10:04:28.717 TRACE 18495 --- [nio-8080-exec-5] o.a.c.i.engine.CamelInternalProcessor    : Exchange processed and is continued routed asynchronously &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; exchangeId: 0FBD82C2E690DA5-0000000000000017 -&amp;gt; Exchange[0FBD82C2E690DA5-0000000000000017]
2021-07-08 10:04:28.717 TRACE 18495 --- [nio-8080-exec-4] o.a.c.i.engine.DefaultReactiveExecutor   : Worker #4 running: org.apache.camel.processor.Pipeline$PipelineTask@3a83e1b8
2021-07-08 10:04:28.717 TRACE 18495 --- [nio-8080-exec-5] o.a.c.i.engine.DefaultReactiveExecutor   : Worker #5 running: org.apache.camel.processor.Pipeline$PipelineTask@74d4d21
2021-07-08 10:04:28.717 TRACE 18495 --- [nio-8080-exec-5] o.a.c.i.c.CoreTypeConverterRegistry      : Finding type converter to convert java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; -&amp;gt; java.lang.&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt; with value: 1
2021-07-08 10:04:28.717 TRACE 18495 --- [nio-8080-exec-4] o.a.c.i.c.CoreTypeConverterRegistry      : Finding type converter to convert java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; -&amp;gt; java.lang.&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt; with value: 1
2021-07-08 10:04:28.717 TRACE 18495 --- [nio-8080-exec-5] o.a.c.i.c.CoreTypeConverterRegistry      : Using bulk converter: CamelBaseBulkConverterLoader to convert [&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;=&amp;gt;&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;java.lang.&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;]
2021-07-08 10:04:28.717 TRACE 18495 --- [nio-8080-exec-4] o.a.c.i.c.CoreTypeConverterRegistry      : Using bulk converter: CamelBaseBulkConverterLoader to convert [&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;=&amp;gt;&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;java.lang.&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;]
2021-07-08 10:04:28.718 TRACE 18495 --- [nio-8080-exec-4] o.a.c.i.engine.DefaultReactiveExecutor   : Schedule [first=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, main=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, sync=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;]: LoopState
2021-07-08 10:04:28.718 TRACE 18495 --- [nio-8080-exec-5] o.a.c.i.engine.DefaultReactiveExecutor   : Schedule [first=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, main=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, sync=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;]: LoopState
2021-07-08 10:04:28.718 TRACE 18495 --- [nio-8080-exec-4] o.a.c.i.engine.DefaultReactiveExecutor   : Queuing reactive work: LoopState
2021-07-08 10:04:28.718 TRACE 18495 --- [nio-8080-exec-5] o.a.c.i.engine.DefaultReactiveExecutor   : Queuing reactive work: LoopState
2021-07-08 10:04:28.718 TRACE 18495 --- [nio-8080-exec-4] o.a.c.i.engine.DefaultReactiveExecutor   : Worker #4 running: org.apache.camel.processor.Pipeline$PipelineTask@3a83e1b8
2021-07-08 10:04:28.718 TRACE 18495 --- [nio-8080-exec-5] o.a.c.i.engine.DefaultReactiveExecutor   : Worker #5 running: org.apache.camel.processor.Pipeline$PipelineTask@74d4d21
2021-07-08 10:04:28.718 DEBUG 18495 --- [nio-8080-exec-4] o.apache.camel.processor.LoopProcessor   : LoopProcessor: iteration #0
2021-07-08 10:04:28.718 DEBUG 18495 --- [nio-8080-exec-5] o.apache.camel.processor.LoopProcessor   : LoopProcessor: iteration #0
2021-07-08 10:04:28.718 TRACE 18495 --- [nio-8080-exec-4] o.a.c.i.engine.CamelInternalProcessor    : Processing exchange &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; exchangeId: 0FBD82C2E690DA5-0000000000000017 -&amp;gt; Exchange[0FBD82C2E690DA5-0000000000000017]
2021-07-08 10:04:28.718 TRACE 18495 --- [nio-8080-exec-4] o.a.c.i.engine.DefaultReactiveExecutor   : Schedule [first=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, main=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, sync=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;]: SimpleTask
2021-07-08 10:04:28.718 TRACE 18495 --- [nio-8080-exec-4] o.a.c.i.engine.DefaultReactiveExecutor   : Queuing reactive work: SimpleTask
2021-07-08 10:04:28.718 TRACE 18495 --- [nio-8080-exec-5] o.a.c.i.engine.CamelInternalProcessor    : Processing exchange &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; exchangeId: 0FBD82C2E690DA5-0000000000000017 -&amp;gt; Exchange[0FBD82C2E690DA5-0000000000000017]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13388361">CAMEL-16794</key>
            <summary>camel-core - race condition in LoopProcessor</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="spenkale">Sergio Penkale</reporter>
                        <labels>
                    </labels>
                <created>Thu, 8 Jul 2021 10:36:02 +0000</created>
                <updated>Thu, 8 Jul 2021 14:23:19 +0000</updated>
                            <resolved>Thu, 8 Jul 2021 14:23:19 +0000</resolved>
                                    <version>3.8.0</version>
                    <version>3.11.0</version>
                                    <fixVersion>3.11.1</fixVersion>
                    <fixVersion>3.12.0</fixVersion>
                                    <component>came-core</component>
                    <component>eip</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="17377303" author="spenkale" created="Thu, 8 Jul 2021 10:38:13 +0000"  >&lt;p&gt;please review the proposed fix: &lt;a href=&quot;https://github.com/apache/camel/pull/5813&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/5813&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 18 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0sq7s:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>