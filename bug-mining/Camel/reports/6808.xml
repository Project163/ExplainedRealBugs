<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 11:06:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-20889] camel-core: Stream is not reset when Message.getBody(class) is invoked ans stream caching is enabled</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-20889</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;Having the following Camel route on Camel&#160; 2.x&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
from(&lt;span class=&quot;code-quote&quot;&gt;&quot;timer:mytimer2?repeatCount=1&amp;amp;delay=1000&quot;&lt;/span&gt;)
&#160; &#160; .routeId(&lt;span class=&quot;code-quote&quot;&gt;&quot;generate-route-marshall&quot;&lt;/span&gt;)
&#160; &#160; .streamCaching()
&#160; &#160; .transform(constant(&lt;span class=&quot;code-quote&quot;&gt;&quot;\{\&quot;&lt;/span&gt;maskme\&lt;span class=&quot;code-quote&quot;&gt;&quot;:\&quot;&lt;/span&gt;json payload\&lt;span class=&quot;code-quote&quot;&gt;&quot;}&quot;&lt;/span&gt;))
&#160; &#160; .marshal().json(JsonLibrary.Jackson)
&#160; &#160; .process(exchange -&amp;gt;
&#160; &#160; {
&#160; &#160; &#160; &#160; &#160;LOGGER.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;body &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;name -&amp;gt; &quot;&lt;/span&gt; + exchange.getIn().getBody().getClass().getName());
&#160; &#160; &#160; &#160; &#160;LOGGER.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;consumed once &#160;using .getBody(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.class) -&amp;gt; &quot;&lt;/span&gt; + exchange.getIn().getBody(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.class));
&#160; &#160; &#160; &#160; LOGGER.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;consumed twice using .getBody(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.class) -&amp;gt; &quot;&lt;/span&gt; + exchange.getIn().getBody(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.class));
&#160; &#160; })
&#160; &#160; .to(&lt;span class=&quot;code-quote&quot;&gt;&quot;jms:queue:INCOMING&quot;&lt;/span&gt;);

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Shows that the consumption of the message payload &#160;in the processor via&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
exchange.getIn().getBody(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.class));\{code}
&#160;works as expected, as the body is shown twice on the logs, as follows.
{code:java}
body &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;name -&amp;gt; org.apache.camel.converter.stream.InputStreamCache
consumed once &#160;using .getBody(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.class) -&amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;\{\&quot;&lt;/span&gt;maskme\&lt;span class=&quot;code-quote&quot;&gt;&quot;:\&quot;&lt;/span&gt;json payload\&lt;span class=&quot;code-quote&quot;&gt;&quot;}&quot;&lt;/span&gt;
consumed twice using .getBody(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.class) -&amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;\{\&quot;&lt;/span&gt;maskme\&lt;span class=&quot;code-quote&quot;&gt;&quot;:\&quot;&lt;/span&gt;json payload\&lt;span class=&quot;code-quote&quot;&gt;&quot;}&quot;&lt;/span&gt;

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;But if you run this same route from&#160; Camel 3.x to the latest 4.x one,&#160; you will get the following output:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
body &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;name -&amp;gt; org.apache.camel.converter.stream.InputStreamCache
consumed once &#160;using .getBody(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.class) -&amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;\{\&quot;&lt;/span&gt;maskme\&lt;span class=&quot;code-quote&quot;&gt;&quot;:\&quot;&lt;/span&gt;json payload\&lt;span class=&quot;code-quote&quot;&gt;&quot;}&quot;&lt;/span&gt;
consumed once &#160;using .getBody(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.class) -&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The problem is that on Camel 2.x, when&lt;br/&gt;
{{ exchange.getIn().getBody(String.class))}}&lt;br/&gt;
is called,&#160; the &lt;a href=&quot;https://github.com/apache/camel/blob/camel-2.x/camel-core/src/main/java/org/apache/camel/converter/IOConverterOptimised.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;org.apache.camel.converter.IOConverterOptimised&lt;/a&gt; is triggered to convert the body from &lt;tt&gt;org.apache.camel.converter.stream.InputStreamCache&lt;/tt&gt; to &lt;tt&gt;java.lang.String&lt;/tt&gt;, which at the beginning of the convertion, &lt;a href=&quot;https://github.com/apache/camel/blob/a05826ece32fbb8e2ba6df0e0ac2a3d5903f9572/camel-core/src/main/java/org/apache/camel/converter/IOConverterOptimised.java#L50&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;it reset the stream&lt;/a&gt;:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;IOConverterOptimised.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;IOConverterOptimised {
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; IOConverterOptimised() {
    }

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; convertTo(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;?&amp;gt; type, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Exchange exchange, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; value) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt; fromType = value.getClass();
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (value &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; StreamCache) {
            ((StreamCache)value).reset();      &lt;span class=&quot;code-comment&quot;&gt;// &amp;lt;------ HERE
&lt;/span&gt;        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;From Camel 3.x, &lt;a href=&quot;https://github.com/apache/camel/blob/camel-2.x/camel-core/src/main/java/org/apache/camel/converter/IOConverterOptimised.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;org.apache.camel.converter.IOConverterOptimised&lt;/a&gt; has been dropped, and &lt;a href=&quot;https://github.com/apache/camel/blob/4c41ebcb73af761dcebf6e4ebb9a68e768e505a1/core/camel-base/src/main/java/org/apache/camel/converter/IOConverter.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;org.apache.camel.converter.IOConverter&lt;/a&gt; is used instead, which doesn&apos;t reset the stream.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13583032">CAMEL-20889</key>
            <summary>camel-core: Stream is not reset when Message.getBody(class) is invoked ans stream caching is enabled</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ldemasi">Luigi De Masi</assignee>
                                    <reporter username="ldemasi">Luigi De Masi</reporter>
                        <labels>
                    </labels>
                <created>Tue, 18 Jun 2024 10:26:34 +0000</created>
                <updated>Wed, 26 Jun 2024 13:54:32 +0000</updated>
                            <resolved>Wed, 26 Jun 2024 13:54:32 +0000</resolved>
                                                    <fixVersion>4.7.0</fixVersion>
                                    <component>came-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17855900" author="davsclaus" created="Tue, 18 Jun 2024 11:50:33 +0000"  >&lt;p&gt;See the documentation&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
/**
 * Returns the body as the specified type
 * &amp;lt;p/&amp;gt;
 * Notice &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the message body is stream based then calling &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; method multiple times may lead to the stream not
 * being able to be re-read again. You can enable stream caching and call the {@link StreamCache#reset()} method to
 * reset the stream to be able to re-read again (&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; possible). See more details about
 * &amp;lt;a href=&lt;span class=&quot;code-quote&quot;&gt;&quot;http:&lt;span class=&quot;code-comment&quot;&gt;//camel.apache.org/stream-caching.html&quot;&lt;/span&gt;&amp;gt;stream caching&amp;lt;/a&amp;gt;.
&lt;/span&gt; *
 * @param  type                    the type that the body
 * @&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;                         the body of the message as the specified type, or &amp;lt;tt&amp;gt;&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;&amp;lt;/tt&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; no body exists
 * @&lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; TypeConversionException is thrown &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; error during type conversion
 */
&amp;lt;T&amp;gt; T getBody(&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;T&amp;gt; type);
 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17855905" author="davsclaus" created="Tue, 18 Jun 2024 12:04:22 +0000"  >&lt;p&gt;However we can consider to change camel 4.7 onwards to reset the stream in the following methods&lt;/p&gt;

&lt;p&gt;&#160;&lt;br/&gt;
&amp;lt;T&amp;gt; T getBody(Class&amp;lt;T&amp;gt; type);&lt;br/&gt;
&amp;lt;T&amp;gt; T getMandatoryBody(Class&amp;lt;T&amp;gt; type) throws InvalidPayloadException;&lt;br/&gt;
&#160;&lt;br/&gt;
So before returning the result, the stream is reset. Then your example should work.&lt;br/&gt;
&#160;&lt;br/&gt;
And then the following methods should likely be changed as well to be consistent&lt;br/&gt;
&#160;&lt;br/&gt;
Object getBody();&lt;br/&gt;
Object getMandatoryBody() throws InvalidPayloadException;&lt;br/&gt;
&#160;&lt;br/&gt;
And we would need to document this in the 4.7 upgrade guide, and change the javadoc of these methods.&lt;br/&gt;
&#160;&lt;/p&gt;</comment>
                            <comment id="17855923" author="orpiske" created="Tue, 18 Jun 2024 12:39:29 +0000"  >&lt;p&gt;IMHO, we shouldn&apos;t change this, as it would incur a performance penalty for all the well-behaved applications that don&apos;t call the method twice.&#160;&lt;/p&gt;</comment>
                            <comment id="17855930" author="davsclaus" created="Tue, 18 Jun 2024 12:54:15 +0000"  >&lt;p&gt;Yeah its a trade-off and affect everyone else and hence why the documentation is also telling the user to reset the stream themselves if they get the body again.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Also you should not do as in that sample code, you get the body once in a local varaible and use that&lt;/p&gt;

&lt;p&gt;String myBody = exchange.getBody(String.class);&lt;/p&gt;

&lt;p&gt;And then use `myBody` if you need to access it again from the Processor&lt;/p&gt;</comment>
                            <comment id="17855931" author="orpiske" created="Tue, 18 Jun 2024 13:01:19 +0000"  >&lt;p&gt;I think we could discuss reworking the code so that read-operations don&apos;t have side effects, but that needs time and planning.&lt;/p&gt;</comment>
                            <comment id="17856127" author="davsclaus" created="Wed, 19 Jun 2024 05:20:11 +0000"  >&lt;p&gt;Yeah its a critical code path to get the body. The doc says you need to handle this by resetting yourself.&lt;/p&gt;

&lt;p&gt;We could also consider adding methods on ExchangeHelper/MessageHelper that can do this.&#160;&lt;/p&gt;

&lt;p&gt;Then its not in the critical path, and users that want to get the body multiple times in a processor can/must use these methods.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;String s = ExchangeHelper.getBodyAndResetStreamCache(exchange, String.class);&lt;/p&gt;

&lt;p&gt;Or&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;String s = ExchangeHelper.getBody(exchange, String.class);&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17856130" author="orpiske" created="Wed, 19 Jun 2024 05:31:52 +0000"  >&lt;p&gt;I like this idea with the ExchangeHelper. It would do the trick without polluting the API without impacting the performance on the critical path.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 21 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1pv6g:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>