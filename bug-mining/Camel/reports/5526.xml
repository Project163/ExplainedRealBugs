<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:44:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-15903] Master component do not retry endpoint startup on failure</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-15903</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;The cluster view implementations have a listener attribute where the master component hooks itself to receive leadership change events. &lt;/p&gt;

&lt;p&gt;When the app instance becomes leader the cluster view will mark that instance as leader then it will trigger the leadershipchangedevent, this will trigger the master component event handler and it will start the delegated consumer and endpoint.&lt;/p&gt;

&lt;p&gt;The issue happens when the delegated consumer or endpoint fail to start. The exception throw by them will go up in the stack, however, this exception does not affect the leadership, i.e., once the app instance becomes leader it will stay so even if the delegated components fail to start.&lt;/p&gt;

&lt;p&gt;Both KubernetesClusterView and FileLockClusterView have this issue.&lt;/p&gt;

&lt;p&gt;KubernetesClusterView uses KubernetesLeadershipController to run the leadership check at an interval. When it acquires the leadership it updates the configmap with that info and call TimedLeaderNotifier refreshLeadership method to check if the leadership has changed. The issue here is that it will mark itself as leader before firing the leadership changed event. Another issue is that the event is fired in a separete thread, so, when the start of the delegated components fail the exception will &quot;die&quot; together with the thread. When the next scheduled leadership check runs the app instance is already the leader and it will not fire the leadership changed event and the delegated component will never start.&lt;/p&gt;

&lt;p&gt;FileLockClusterView has a similar issue, it acquires the file lock prior to firing the event, even if the event processing fails it does not rollback the leader selection.&lt;/p&gt;

&lt;p&gt;Other cluster view implementations might have the same issue.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13343002">CAMEL-15903</key>
            <summary>Master component do not retry endpoint startup on failure</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="edgarcher">EDGAR CHERNICK</reporter>
                        <labels>
                    </labels>
                <created>Fri, 27 Nov 2020 13:48:01 +0000</created>
                <updated>Wed, 3 Jul 2024 13:45:13 +0000</updated>
                            <resolved>Wed, 3 Jul 2024 13:45:13 +0000</resolved>
                                                    <fixVersion>4.7.0</fixVersion>
                                    <component>camel-master</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17239688" author="edgarcher" created="Fri, 27 Nov 2020 13:51:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt; I wanted to fix this issue myself but I&apos;m afraid I might fix it for my scenario and keep others uncovered, since I think this issue might be related with all cluster view implementations.&lt;/p&gt;

&lt;p&gt;Would you mind giving some direction on how this could fixed ? &lt;/p&gt;

&lt;p&gt;I may try to submit a PR based on this direction then.&lt;/p&gt;</comment>
                            <comment id="17239693" author="davsclaus" created="Fri, 27 Nov 2020 13:59:19 +0000"  >&lt;p&gt;Edgar, I wonder if you have or can get a stacktrace of that error that is silently ignored. Or can pin point to where it happens in the current code.&lt;/p&gt;</comment>
                            <comment id="17239698" author="edgarcher" created="Fri, 27 Nov 2020 14:12:35 +0000"  >&lt;p&gt;I&apos;m using camel to consume from SF streaming api and I got this error when trying to creating a push topic with a name with more than 25 characters. This is the stack trace using FileLockClusterView:&lt;/p&gt;

&lt;p&gt;org.apache.camel.CamelException: Error creating Topic proposalOpportunityInjectionSync: {errors:[&lt;/p&gt;
{&quot;errorCode&quot;:&quot;STRING_TOO_LONG&quot;,&quot;message&quot;:&quot;Topic Name: data value too large: proposalOpportunityInjectionSync (max length=25)&quot;,&quot;fields&quot;:[&quot;Name&quot;]}
&lt;p&gt;],statusCode:400}&lt;br/&gt;
	at org.apache.camel.component.salesforce.internal.streaming.PushTopicHelper.createTopic(PushTopicHelper.java:169)&lt;br/&gt;
	at org.apache.camel.component.salesforce.internal.streaming.PushTopicHelper.createOrUpdateTopic(PushTopicHelper.java:112)&lt;br/&gt;
	at org.apache.camel.component.salesforce.SalesforceConsumer.doStart(SalesforceConsumer.java:312)&lt;br/&gt;
	at org.apache.camel.support.service.BaseService.start(BaseService.java:115)&lt;br/&gt;
	at org.apache.camel.support.service.ServiceHelper.startService(ServiceHelper.java:84)&lt;br/&gt;
	at org.apache.camel.component.master.MasterConsumer.onLeadershipTaken(MasterConsumer.java:133)&lt;br/&gt;
	at org.apache.camel.component.master.MasterConsumer.access$100(MasterConsumer.java:43)&lt;br/&gt;
	at org.apache.camel.component.master.MasterConsumer$LeadershipListener.leadershipChanged(MasterConsumer.java:160)&lt;br/&gt;
	at org.apache.camel.support.cluster.AbstractCamelClusterView.lambda$fireLeadershipChangedEvent$4(AbstractCamelClusterView.java:129)&lt;br/&gt;
	at org.apache.camel.support.cluster.AbstractCamelClusterView.lambda$doWithListener$3(AbstractCamelClusterView.java:119)&lt;br/&gt;
	at org.apache.camel.util.concurrent.LockHelper.doWithReadLock(LockHelper.java:34)&lt;br/&gt;
	at org.apache.camel.support.cluster.AbstractCamelClusterView.doWithListener(AbstractCamelClusterView.java:112)&lt;br/&gt;
	at org.apache.camel.support.cluster.AbstractCamelClusterView.fireLeadershipChangedEvent(AbstractCamelClusterView.java:127)&lt;br/&gt;
	at org.apache.camel.component.file.cluster.FileLockClusterView.tryLock(FileLockClusterView.java:146)&lt;br/&gt;
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)&lt;br/&gt;
	at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:308)&lt;br/&gt;
	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$301(ScheduledThreadPoolExecutor.java:180)&lt;br/&gt;
	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:294)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:748)&lt;br/&gt;
Caused by: org.apache.camel.component.salesforce.api.SalesforceException: {errors:[&lt;/p&gt;
{&quot;errorCode&quot;:&quot;STRING_TOO_LONG&quot;,&quot;message&quot;:&quot;Topic Name: data value too large: proposalOpportunityInjectionSync (max length=25)&quot;,&quot;fields&quot;:[&quot;Name&quot;]}
&lt;p&gt;],statusCode:400}&lt;br/&gt;
	at org.apache.camel.component.salesforce.internal.client.DefaultRestClient.createRestException(DefaultRestClient.java:113)&lt;br/&gt;
	at org.apache.camel.component.salesforce.internal.client.AbstractClientBase$1.onComplete(AbstractClientBase.java:231)&lt;br/&gt;
	at org.eclipse.jetty.client.ResponseNotifier.notifyComplete(ResponseNotifier.java:202)&lt;br/&gt;
	at org.eclipse.jetty.client.ResponseNotifier.notifyComplete(ResponseNotifier.java:194)&lt;br/&gt;
	at org.eclipse.jetty.client.ResponseNotifier.forwardSuccessComplete(ResponseNotifier.java:228)&lt;br/&gt;
	at org.apache.camel.component.salesforce.internal.client.SalesforceSecurityHandler$SecurityListener.forwardSuccessComplete(SalesforceSecurityHandler.java:269)&lt;br/&gt;
	at org.apache.camel.component.salesforce.internal.client.SalesforceSecurityHandler$SecurityListener.onComplete(SalesforceSecurityHandler.java:182)&lt;br/&gt;
	at org.eclipse.jetty.client.ResponseNotifier.notifyComplete(ResponseNotifier.java:202)&lt;br/&gt;
	at org.eclipse.jetty.client.ResponseNotifier.notifyComplete(ResponseNotifier.java:194)&lt;br/&gt;
	at org.eclipse.jetty.client.HttpReceiver.terminateResponse(HttpReceiver.java:470)&lt;br/&gt;
	at org.eclipse.jetty.client.HttpReceiver.responseSuccess(HttpReceiver.java:416)&lt;br/&gt;
	at org.eclipse.jetty.client.http.HttpReceiverOverHTTP.messageComplete(HttpReceiverOverHTTP.java:316)&lt;br/&gt;
	at org.eclipse.jetty.http.HttpParser.parseFields(HttpParser.java:1165)&lt;br/&gt;
	at org.eclipse.jetty.http.HttpParser.parseNext(HttpParser.java:1525)&lt;br/&gt;
	at org.eclipse.jetty.client.http.HttpReceiverOverHTTP.parse(HttpReceiverOverHTTP.java:172)&lt;br/&gt;
	at org.eclipse.jetty.client.http.HttpReceiverOverHTTP.process(HttpReceiverOverHTTP.java:135)&lt;br/&gt;
	at org.eclipse.jetty.client.http.HttpReceiverOverHTTP.receive(HttpReceiverOverHTTP.java:73)&lt;br/&gt;
	at org.eclipse.jetty.client.http.HttpChannelOverHTTP.receive(HttpChannelOverHTTP.java:133)&lt;br/&gt;
	at org.eclipse.jetty.client.http.HttpConnectionOverHTTP.onFillable(HttpConnectionOverHTTP.java:155)&lt;br/&gt;
	at org.eclipse.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:305)&lt;br/&gt;
	at org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:103)&lt;br/&gt;
	at org.eclipse.jetty.io.ssl.SslConnection$DecryptedEndPoint.onFillable(SslConnection.java:411)&lt;br/&gt;
	at org.eclipse.jetty.io.ssl.SslConnection.onFillable(SslConnection.java:305)&lt;br/&gt;
	at org.eclipse.jetty.io.ssl.SslConnection$2.succeeded(SslConnection.java:159)&lt;br/&gt;
	at org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:103)&lt;br/&gt;
	at org.eclipse.jetty.io.ChannelEndPoint$2.run(ChannelEndPoint.java:118)&lt;br/&gt;
	at org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.runTask(EatWhatYouKill.java:333)&lt;br/&gt;
	at org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.doProduce(EatWhatYouKill.java:310)&lt;br/&gt;
	at org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.tryProduce(EatWhatYouKill.java:168)&lt;br/&gt;
	at org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.run(EatWhatYouKill.java:126)&lt;br/&gt;
	at org.eclipse.jetty.util.thread.ReservedThreadExecutor$ReservedThread.run(ReservedThreadExecutor.java:366)&lt;br/&gt;
	at org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:765)&lt;br/&gt;
	at org.eclipse.jetty.util.thread.QueuedThreadPool$2.run(QueuedThreadPool.java:683)&lt;br/&gt;
	... 1 more&lt;/p&gt;</comment>
                            <comment id="17243860" author="lb" created="Fri, 4 Dec 2020 09:03:40 +0000"  >&lt;p&gt;As far as I remember the idea was that there should be something on top of the master component to deal with routes failures and decide what to do as example, if there&apos;s a connectivity glitch and your route either don&apos;t even start or report failures, it should be up to the specific routes supervisor to decide to retry or to give up and release the leadership. &lt;/p&gt;

&lt;p&gt;But I think we should have some configuration option to configure the behaviour of the master component and i.e. auto release the leadership in case of failures.&lt;/p&gt;</comment>
                            <comment id="17244173" author="edgarcher" created="Fri, 4 Dec 2020 18:00:29 +0000"  >&lt;p&gt;I think I could have something monitoring the master component but I don&apos;t think it would help in this scenario actually. In all app instances the master component route is started (and the route it is in as well). The thing that is not started is the &quot;wrapped by master&quot; component/endpoint, that wrapped component starts when master component receives leadership changed events and trigger its start.&lt;/p&gt;

&lt;p&gt;One thing that I was thinking is, what if the actual error surfaced to the exception handling mechanism (something similar to what bridgeErrorHandler does). This won&apos;t fix the issue of not retrying the startup of it on leadership changes but at least will give users visibility that something is going on (they might even be able to &quot;force&quot; the restart of the route on their own based on the exception that was thrown)&lt;/p&gt;</comment>
                            <comment id="17246355" author="lb" created="Wed, 9 Dec 2020 08:31:19 +0000"  >&lt;p&gt;Yes I know that the route is started but many things may fail so there should be something to supervise the routes so I guess the master policy should install a dedicate error handler or the reoute policy should provide an hook for error related to the route itself and the master component can hook there&lt;/p&gt;</comment>
                            <comment id="17246823" author="edgarcher" created="Wed, 9 Dec 2020 21:04:54 +0000"  >&lt;p&gt;The Master Consumer does not have a try catch block on leadership taken event handler (&lt;a href=&quot;https://github.com/apache/camel/blob/master/components/camel-master/src/main/java/org/apache/camel/component/master/MasterConsumer.java#L118&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/blob/master/components/camel-master/src/main/java/org/apache/camel/component/master/MasterConsumer.java#L118&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;would it be okay If I just added that and then call super.handleException in the catch block ? If the route has bridgeErrorHandler=true this should at least surface the exception for handling, right ?&lt;/p&gt;

&lt;p&gt;This won&apos;t solve the issue by itself but at least end users will have an exception indicating that something is going on.&lt;/p&gt;</comment>
                            <comment id="17247106" author="davsclaus" created="Thu, 10 Dec 2020 09:06:54 +0000"  >&lt;p&gt;Yes Edgar lets add some logging details if there is an exception with the leader taken/lost situation.&lt;/p&gt;
</comment>
                            <comment id="17247116" author="davsclaus" created="Thu, 10 Dec 2020 09:22:30 +0000"  >&lt;p&gt;There is nothing today that can monitor and retry starting the consumer et all, as this is done internally in the master consumer itself (not via Camels route controller).&lt;/p&gt;

&lt;p&gt;I think if starting the consumer fails, then we now do a logging of the exception. And I think we should then loose the leader - and it looks like for this to happen then we would need to restart, eg stop the view, and create the view again. Luca any thoughts?&lt;/p&gt;</comment>
                            <comment id="17247125" author="lb" created="Thu, 10 Dec 2020 09:36:56 +0000"  >&lt;p&gt;I think the clean solution would be to add a method to the CamelClusterView and/or CamelClusterMember interface to release the leadership, as workaround we may invoke clusterService.releaseView(view) directly or maybe using a custom exception handler ?&lt;/p&gt;</comment>
                            <comment id="17247213" author="davsclaus" created="Thu, 10 Dec 2020 12:27:11 +0000"  >&lt;p&gt;Yeah good idea with a release API (I was looking for that)&lt;/p&gt;</comment>
                            <comment id="17862792" author="davsclaus" created="Wed, 3 Jul 2024 13:44:42 +0000"  >&lt;p&gt;Okay so camel-master will now retry creating and starting the consumer when it is becoming the leader. There are options you can set delay/max attempts to avoid keeping for long time.&lt;br/&gt;
There is no rules for giving up so for example if starting keeps failing, then the leader is given up. That would require some more general work.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 18 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0kzwg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>