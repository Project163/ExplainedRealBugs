<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 11:10:23 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-21947] GenericFileConsumer with eager idempotence and read lock stop processing file</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-21947</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;Hello,&lt;/p&gt;

&lt;p&gt;We have found a problem with the SftpConsumer (that applies for all file cosumers).&lt;/p&gt;

&lt;p&gt;When it has been configured with &quot;readLock=changed&quot; and &quot;idempotentEager=true&quot; the&#160;&lt;em&gt;GenericFileConsumer&lt;/em&gt;&#160;will in the&#160;&lt;em&gt;poll&lt;/em&gt;&#160;method:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;On the call to the&#160;&lt;em&gt;pollDirectory&lt;/em&gt;&#160;method store the idempotence key in the idempotence repository (using the notUnique method)&lt;/li&gt;
	&lt;li&gt;On the call to the&#160;&lt;em&gt;processBatch&lt;/em&gt;&#160;method it may fail to acquire a read lock before the specified&#160;&lt;em&gt;readLockTimeout&lt;/em&gt;&#160;has been reached.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;When this occurs the file is silently left on the SFTP server and will not be picked up.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13614798">CAMEL-21947</key>
            <summary>GenericFileConsumer with eager idempotence and read lock stop processing file</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="lantzen">H&#229;kan Lantz</reporter>
                        <labels>
                    </labels>
                <created>Thu, 10 Apr 2025 06:23:34 +0000</created>
                <updated>Sat, 12 Apr 2025 09:00:00 +0000</updated>
                            <resolved>Fri, 11 Apr 2025 15:31:16 +0000</resolved>
                                    <version>4.8.6</version>
                    <version>4.10.3</version>
                    <version>4.11.0</version>
                                    <fixVersion>4.8.7</fixVersion>
                    <fixVersion>4.10.4</fixVersion>
                    <fixVersion>4.12.0</fixVersion>
                                    <component>camel-file</component>
                    <component>camel-ftp</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17943216" author="JIRAUSER309141" created="Thu, 10 Apr 2025 13:18:38 +0000"  >&lt;p&gt;We believe that this is not desirable behavior and the proposed fix is &#8203;&#8203;to remove the idempotence key from the idempotence repository if the &lt;a href=&quot;https://github.com/apache/camel/blob/eb4a1ea7543aa172d7cd662a7dfa5867616aec13/components/camel-file/src/main/java/org/apache/camel/component/file/GenericFileConsumer.java#L255&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;GenericFileConsumer&lt;/a&gt; here detects that it failed to start the processing of the file.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!started) {
        &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; we did not start process the file then decrement the counter
&lt;/span&gt;        answer--;

        &lt;span class=&quot;code-comment&quot;&gt;// If the idempotence of the endpoint is eager then
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// Remove the idempotent key from the repository
&lt;/span&gt;	GenericFile file = exchange.getMessage().getBody(GenericFile.class);
	&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; != file) {
		removeExcessiveIdempotentFile(file, exchange);
	}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17943527" author="davsclaus" created="Fri, 11 Apr 2025 11:42:02 +0000"  >&lt;p&gt;Can you maybe try to patch with this PR and test on your system&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/camel/pull/17731&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/17731&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17943528" author="JIRAUSER309141" created="Fri, 11 Apr 2025 11:45:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt; I have now added a PR for this issue with the proposed fix and a unit-test to validate it.&lt;/p&gt;

&lt;p&gt;I&apos;m not sure how (and if) I should add my unit-test to the list of unit-tests that run on maven build.&lt;/p&gt;

&lt;p&gt;I placed the unit-test in the &quot;org.apache.camel.component.file.consumer&quot; package since I wanted it to test both with a file and sftp Endpoint and I was not able to add the &apos;camel-test-junit5&apos; (to subclass CamelTestSupport) in the &apos;components/camel-file&apos; module.&lt;/p&gt;

&lt;p&gt;Regards,&lt;br/&gt;
H&#229;kan.&lt;/p&gt;</comment>
                            <comment id="17943588" author="JIRAUSER309141" created="Fri, 11 Apr 2025 14:13:35 +0000"  >&lt;p&gt;Your PR seems to work fine for us &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/thumbs_up.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Do you think it is possible to get that in the 4.8.7 release with &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-21892&quot; title=&quot;Stopped producer in DefaultProducerCache.lastUsedProducer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-21892&quot;&gt;&lt;del&gt;CAMEL-21892&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17943593" author="davsclaus" created="Fri, 11 Apr 2025 14:31:44 +0000"  >&lt;p&gt;Yeah we will backport. I will look at to see if I can reuse your unit test. We can use a custom read lock that return false to simulate not started&lt;/p&gt;</comment>
                            <comment id="17943596" author="JIRAUSER309141" created="Fri, 11 Apr 2025 14:38:49 +0000"  >&lt;p&gt;Yes our unit-test simulates writing to the file that poll to fail getting a read lock, however that probably takes a bit to long to run (15s)&lt;/p&gt;</comment>
                            <comment id="17943765" author="JIRAUSER309141" created="Sat, 12 Apr 2025 09:00:00 +0000"  >&lt;p&gt;Yes my unit-test simulates writing to the file that poll to fail getting a&lt;br/&gt;
read lock, however that probably takes a bit to long to run (15s)&lt;/p&gt;

&lt;p&gt;Mvh / Best regards,&lt;/p&gt;

&lt;p&gt;&lt;b&gt;H&#229;kan Lantz&lt;/b&gt;&lt;/p&gt;



&lt;p&gt;+46 (0)736 840 870&lt;br/&gt;
hakan.lantz@replyto.se&lt;br/&gt;
www.replyto.se&lt;/p&gt;


</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            30 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1va7s:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>