<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 11:05:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-20563] camel-kafka - breakOnFirstError causes thread and memory leaks</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-20563</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;This has got fixed in &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-16857&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;CAMEL-16857&lt;/a&gt;. But Facing same issue with 3.18.5, is it reintroduced at some point?&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13571752">CAMEL-20563</key>
            <summary>camel-kafka - breakOnFirstError causes thread and memory leaks</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="aniketjadhav840">Aniket Jadhav</reporter>
                        <labels>
                    </labels>
                <created>Wed, 13 Mar 2024 13:23:06 +0000</created>
                <updated>Mon, 15 Apr 2024 06:00:45 +0000</updated>
                            <resolved>Mon, 18 Mar 2024 10:23:20 +0000</resolved>
                                    <version>3.18.5</version>
                    <version>3.22.1</version>
                                    <fixVersion>3.21.5</fixVersion>
                    <fixVersion>3.22.2</fixVersion>
                    <fixVersion>4.0.5</fixVersion>
                    <fixVersion>4.4.2</fixVersion>
                    <fixVersion>4.5.0</fixVersion>
                                    <component>camel-kafka</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17826055" author="davsclaus" created="Wed, 13 Mar 2024 13:32:29 +0000"  >&lt;p&gt;Camel 3.18 is EOL and not supported&lt;/p&gt;</comment>
                            <comment id="17826066" author="JIRAUSER293402" created="Wed, 13 Mar 2024 13:59:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt; facing same issue in 3.22 also&lt;/p&gt;</comment>
                            <comment id="17826077" author="davsclaus" created="Wed, 13 Mar 2024 14:21:28 +0000"  >&lt;p&gt;Try with 4.4.0 and 4.4.1 release (soon)&lt;/p&gt;</comment>
                            <comment id="17827081" author="davsclaus" created="Thu, 14 Mar 2024 12:49:17 +0000"  >&lt;p&gt;Also if you can put together a sample project that reproduces this and attach as .zip file&lt;/p&gt;</comment>
                            <comment id="17827098" author="samipeltola" created="Thu, 14 Mar 2024 13:48:06 +0000"  >&lt;p&gt;Attached an example project, instructions in the README.md.&lt;/p&gt;

&lt;p&gt;Seems that using breakOnFirstError option for Kafka component creates a new heartbeat thread every time KafkaFetchRecords is set to reconnect, which happens when there an exception is allowed to propagate back from the route.&lt;/p&gt;

&lt;p&gt;In KafkaFetchRecords, the task is set to reconnection state every time an exception bubbles back from the route:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
                &lt;span class=&quot;code-comment&quot;&gt;// when breakOnFirstError we want to unsubscribe from Kafka
&lt;/span&gt;                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (result != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; result.isBreakOnErrorHit() &amp;amp;&amp;amp; !&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.state.equals(State.PAUSED)) {
                    LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;We hit an error ... setting flags to force reconnect&quot;&lt;/span&gt;);
                    &lt;span class=&quot;code-comment&quot;&gt;// force re-connect
&lt;/span&gt;                    setReconnect(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
                    setConnected(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
                }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This will lead to kafka-client &lt;b&gt;kafkaConsumer.getEndpoint().getKafkaClientFactory().getConsumer&lt;/b&gt; being called again in KafkaFetchRecords.createConsumer(), which in turn creates ConsumerCoordinator again. The problem is that the heartbeat-thread created for the previous ConsumerCoordinator is never shutdown. &lt;/p&gt;

&lt;p&gt;The new ConsumerCoordinator will have class member heartbeatThread set to null and the next time ensureActiveGroup is called, a new heartbeat-thread is created:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; void startHeartbeatThreadIfNeeded() {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (heartbeatThread == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            heartbeatThread = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HeartbeatThread();
            heartbeatThread.start();
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

</comment>
                            <comment id="17827102" author="davsclaus" created="Thu, 14 Mar 2024 14:01:09 +0000"  >&lt;p&gt;Thanks for the sample and analysis. Yeah we should see if we can find a way to cancel the old thread. You are welcome to attempt doing a fix and test it, and if fixed then send as PR or attach the code here&lt;/p&gt;</comment>
                            <comment id="17827667" author="samipeltola" created="Sat, 16 Mar 2024 07:52:36 +0000"  >&lt;p&gt;Yeah, I think I have a fix for this, I&apos;ll open a PR later today.&lt;/p&gt;</comment>
                            <comment id="17827907" author="davsclaus" created="Mon, 18 Mar 2024 10:23:20 +0000"  >&lt;p&gt;Thanks for reporting and the PR with unit test&lt;/p&gt;</comment>
                            <comment id="17834885" author="JIRAUSER293402" created="Mon, 8 Apr 2024 11:15:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt; any estimates when 3.22.2 will be release?&lt;/p&gt;</comment>
                            <comment id="17836687" author="davsclaus" created="Fri, 12 Apr 2024 16:39:43 +0000"  >&lt;p&gt;&lt;a href=&quot;https://camel.apache.org/blog/2023/12/camel3ending/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://camel.apache.org/blog/2023/12/camel3ending/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;We will do a set of releases of 3.x in may/june &lt;/p&gt;</comment>
                            <comment id="17837082" author="JIRAUSER293402" created="Mon, 15 Apr 2024 06:00:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt; Thanks &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/thumbs_up.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13394159">CAMEL-16857</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13067421" name="KafkaHeartBeatLeakThread.PNG" size="65390" author="aniketjadhav840" created="Wed, 13 Mar 2024 13:58:09 +0000"/>
                            <attachment id="13067445" name="heartbeat-threading-problem.zip" size="11122" author="samipeltola" created="Thu, 14 Mar 2024 13:37:22 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 30 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1ny3k:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>