<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:32:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-12969] camel-core-osgi: Slow Memory Leak in OsgiServiceRegistry</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-12969</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;The OsgiServiceRegistry has a slow memory leak in the serviceReferenceQueue.&#160; Currently every time a service is looked up by any method an item is added to the serviceReferenceQueue.&#160; This is required because of OSGi ServiceReference counting.&#160; However left unchecked the system just continues to add ConcurrentLinkedQueue$Node objects until memory is exhausted.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12950174/12950174_ServiceReferenceQueueLeak.PNG&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; .&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;There is also a second problem with how the registry is being managed within the OsgiDefaultCamelContext.&#160; OsgiServiceRegistry is currently extends LifecycleStrategySupport which is suppose to unload the serviceReferenceQueue onContextStop.&#160; However the registry is never getting added to the CamelContext to manage the Lifecycle because the overridden createRegistry method in OsgiDefaultCamelContext is not being called.&#160; This is because the registry is being set in the constructor of OsgiDefaultCamelContext with&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;(registry);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;this calls the DefaultCamelContext implementation of createRegistry which does not add the registry to lifecyclemanagement since&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
OsgiCamelContextHelper.wrapRegistry(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;, registry, bundleContext);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;is never called.&#160;&lt;/p&gt;

&lt;p&gt;See serviceReferenceQueue&#160; pre context stop&lt;/p&gt;

&lt;p&gt;&#160; &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12950175/12950175_ServiceReferenceQueuePreContextStop.PNG&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12950176/12950176_karafCamelContextStop.PNG&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;See serviceReferenceQueue&#160;&#160; post context stop (still contain objects)&lt;/p&gt;

&lt;p&gt;&#160; &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12950177/12950177_ServiceReferenceQueuePostContextStop.PNG&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Both issues would have existed for some time but may have gone unnoticed because the leak was so slow (ConcurrentLinkedQueue$Node takes up very little memory).&#160; It appears the removal of the cache in &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-9631&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CAMEL-9631&lt;/a&gt; makes the leak occur more quickly.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I have a patch that involves reintroducing the cache but with an invalidation strategy using the OSGi ServiceListener that leverages a single clean up thread to remain non-blocking.&#160; I&apos;m working on an upstream adaptation and will post a PR for community review.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment>&lt;p&gt;Java 10&lt;/p&gt;

&lt;p&gt;Karaf 4.2.1&lt;/p&gt;

&lt;p&gt;Camel 2.22.0&lt;/p&gt;</environment>
        <key id="13201658">CAMEL-12969</key>
            <summary>camel-core-osgi: Slow Memory Leak in OsgiServiceRegistry</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="bobpaulin">Bob Paulin</reporter>
                        <labels>
                    </labels>
                <created>Fri, 30 Nov 2018 15:46:00 +0000</created>
                <updated>Sun, 30 Dec 2018 19:38:51 +0000</updated>
                            <resolved>Sun, 30 Dec 2018 18:46:07 +0000</resolved>
                                    <version>2.18.0</version>
                    <version>2.19.0</version>
                    <version>2.20.0</version>
                    <version>2.21.0</version>
                    <version>2.22.0</version>
                    <version>2.23.0</version>
                                    <fixVersion>2.21.4</fixVersion>
                    <fixVersion>2.22.3</fixVersion>
                    <fixVersion>2.23.1</fixVersion>
                    <fixVersion>2.24.0</fixVersion>
                                    <component>camel-osgi</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="16705062" author="githubbot" created="Fri, 30 Nov 2018 17:37:24 +0000"  >&lt;p&gt;bobpaulin opened a new pull request #2647: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12969&quot; title=&quot;camel-core-osgi: Slow Memory Leak in OsgiServiceRegistry&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12969&quot;&gt;&lt;del&gt;CAMEL-12969&lt;/del&gt;&lt;/a&gt;: Adding ServiceReference Cache to prevent memory leak.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2647&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2647&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16709942" author="githubbot" created="Wed, 5 Dec 2018 11:26:13 +0000"  >&lt;p&gt;davsclaus commented on issue #2647: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12969&quot; title=&quot;camel-core-osgi: Slow Memory Leak in OsgiServiceRegistry&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12969&quot;&gt;&lt;del&gt;CAMEL-12969&lt;/del&gt;&lt;/a&gt;: Adding ServiceReference Cache to prevent memory leak.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2647#issuecomment-444452864&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2647#issuecomment-444452864&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Thanks for the PR. I wonder if we can avoid the extra background thread. Can&apos;t we just use the service listener directly and in the serviceChanged method with unregister service, then remove the item from the osgi service registry directly. &lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16709945" author="githubbot" created="Wed, 5 Dec 2018 11:28:27 +0000"  >&lt;p&gt;davsclaus commented on issue #2647: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12969&quot; title=&quot;camel-core-osgi: Slow Memory Leak in OsgiServiceRegistry&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12969&quot;&gt;&lt;del&gt;CAMEL-12969&lt;/del&gt;&lt;/a&gt;: Adding ServiceReference Cache to prevent memory leak.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2647#issuecomment-444453399&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2647#issuecomment-444453399&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Also if the leak is due to `onContextStop` is not called on OsgiServiceRegistry where it unregisters and clears its own cache, then we should try to fix this first and see if the current code is not okay as-is. I am not keen on adding extra complexity with this PR introduces.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16709947" author="davsclaus" created="Wed, 5 Dec 2018 11:29:28 +0000"  >&lt;p&gt;Thanks for reporting the memory leak and providing details and screenshots etc, much appreciated.&lt;/p&gt;</comment>
                            <comment id="16710187" author="githubbot" created="Wed, 5 Dec 2018 15:09:55 +0000"  >&lt;p&gt;bobpaulin commented on issue #2647: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12969&quot; title=&quot;camel-core-osgi: Slow Memory Leak in OsgiServiceRegistry&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12969&quot;&gt;&lt;del&gt;CAMEL-12969&lt;/del&gt;&lt;/a&gt;: Adding ServiceReference Cache to prevent memory leak.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2647#issuecomment-444518591&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2647#issuecomment-444518591&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   @davsclaus Yes I would also like to avoid the background thread if possible.  The problem I ran into with removing the service reference on the unregister event is per the OSGi spec&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; (and in the Felix implementation) the event is fired at the beginning of the service being unregistered not at the end.  So it is possible that if the service is looked up after the event firing but before the service registration is invalidated and removed from Felix&apos;s registry &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; it could be re-cached without any other means to remove it other than stopping the camel context.  This gap between the unregistered event firing and the service actually being removed causes some problems for trying to invalidate the cache in a synchronous way.  The thread allows the code to check the ungetService return value which switches to false when the service is actually gone.  That allows the invalidation to work properly without locking but trades the extra resources that get allocated to the thread.&lt;/p&gt;

&lt;p&gt;   To your point of just applying the fix to the onContextStop being called.  I believe that could be applied separately which would improve the situation for users that are using the lookup calls conservatively.  Without the other parts of the patch (such as the cache reintroduction and invalidation strategy) the ConcurrentLinkedQueue$Node objects would continue to accumulate with each lookup call.  I&apos;d prefer an approach that shields developers from the OSGi runtime and allows them make lookup calls as liberally as they can be with the  SimpleRegistry and JndiRegistry.&lt;/p&gt;

&lt;p&gt;   I agree with your point about complexity and I&apos;m open to ideas to address the issue in a way that allows developers to use the Camel Registries in a uniform way.  Also sorry for the length of this note.  I wish I could have made it shorter but I think the issue is a bit tricky.&lt;/p&gt;

&lt;p&gt;   &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://osgi.org/specification/osgi.core/7.0.0/framework.api.html#org.osgi.framework.ServiceEvent&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://osgi.org/specification/osgi.core/7.0.0/framework.api.html#org.osgi.framework.ServiceEvent&lt;/a&gt;&lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/felix/blob/trunk/framework/src/main/java/org/apache/felix/framework/ServiceRegistry.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/felix/blob/trunk/framework/src/main/java/org/apache/felix/framework/ServiceRegistry.java&lt;/a&gt; (specfically the unregisterService method.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16713099" author="githubbot" created="Fri, 7 Dec 2018 17:10:52 +0000"  >&lt;p&gt;bobpaulin commented on issue #2647: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12969&quot; title=&quot;camel-core-osgi: Slow Memory Leak in OsgiServiceRegistry&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12969&quot;&gt;&lt;del&gt;CAMEL-12969&lt;/del&gt;&lt;/a&gt;: Adding ServiceReference Cache to prevent memory leak.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2647#issuecomment-445300110&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2647#issuecomment-445300110&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   If it makes sense I can split this PR into 2 separate PRs.  One with the changes to the code that ensures the onContextStop gets called and another including the re-adding of cache and invalidation strategy.  It seems like the onContextStop change is uncontroversial while the cache and invalidation strategy will take require more consideration.  &lt;/p&gt;

&lt;p&gt;   In my application the onContextStop fix without the other changes will not be of much benefit to me.  But it may benefit others in the community that call the lookup method less frequently and stop the context more frequently.  &lt;/p&gt;

&lt;p&gt;   If there are suggestions to this pull request that would reduce the complexity to an acceptable level without adding race conditions and managing OSGi reference counting properly I&apos;m happy to adapt this PR as well.  Let me know what approach makes the most sense.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16713182" author="githubbot" created="Fri, 7 Dec 2018 18:41:42 +0000"  >&lt;p&gt;davsclaus commented on issue #2647: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12969&quot; title=&quot;camel-core-osgi: Slow Memory Leak in OsgiServiceRegistry&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12969&quot;&gt;&lt;del&gt;CAMEL-12969&lt;/del&gt;&lt;/a&gt;: Adding ServiceReference Cache to prevent memory leak.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2647#issuecomment-445326215&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2647#issuecomment-445326215&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   @bobpaulin yeah it would be good to separate this into 2 PRs. The onContextStop is a good fix IMHO.&lt;/p&gt;

&lt;p&gt;   For the other I would like to get more feedback and ideas, eg if you have 100 Camel bundles in a JVM, then you now get 100 more JVM threads which is pita. &lt;br/&gt;
   Maybe the background thread can be created on-demand or on when camel context is being shutdown. &lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16713839" author="bobpaulin" created="Sun, 9 Dec 2018 03:00:53 +0000"  >&lt;p&gt;Created a second issue to separate the onContextStop not called issue &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12987&quot; title=&quot;camel-core-osgi: OsgiServiceRegistry.onContextStop never gets called.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12987&quot;&gt;&lt;del&gt;CAMEL-12987&lt;/del&gt;&lt;/a&gt; .&#160; This issue will be for tracking the memory leak caused by adding to the serviceReferenceQueue with each lookup call.&lt;/p&gt;</comment>
                            <comment id="16713841" author="githubbot" created="Sun, 9 Dec 2018 03:09:53 +0000"  >&lt;p&gt;bobpaulin commented on issue #2647: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12969&quot; title=&quot;camel-core-osgi: Slow Memory Leak in OsgiServiceRegistry&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12969&quot;&gt;&lt;del&gt;CAMEL-12969&lt;/del&gt;&lt;/a&gt;: Adding ServiceReference Cache to prevent memory leak.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2647#issuecomment-445507171&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2647#issuecomment-445507171&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Split this into &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12987&quot; title=&quot;camel-core-osgi: OsgiServiceRegistry.onContextStop never gets called.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12987&quot;&gt;&lt;del&gt;CAMEL-12987&lt;/del&gt;&lt;/a&gt;.  Closing this PR will open a new one that does not include the &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12987&quot; title=&quot;camel-core-osgi: OsgiServiceRegistry.onContextStop never gets called.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12987&quot;&gt;&lt;del&gt;CAMEL-12987&lt;/del&gt;&lt;/a&gt; changes.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16713842" author="githubbot" created="Sun, 9 Dec 2018 03:09:53 +0000"  >&lt;p&gt;bobpaulin closed pull request #2647: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12969&quot; title=&quot;camel-core-osgi: Slow Memory Leak in OsgiServiceRegistry&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12969&quot;&gt;&lt;del&gt;CAMEL-12969&lt;/del&gt;&lt;/a&gt;: Adding ServiceReference Cache to prevent memory leak.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2647&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2647&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/components/camel-core-osgi/src/main/java/org/apache/camel/core/osgi/OsgiCamelContextHelper.java b/components/camel-core-osgi/src/main/java/org/apache/camel/core/osgi/OsgiCamelContextHelper.java&lt;br/&gt;
index 08ff669c59f..2b9b1fc4e60 100644&lt;br/&gt;
&amp;#8212; a/components/camel-core-osgi/src/main/java/org/apache/camel/core/osgi/OsgiCamelContextHelper.java&lt;br/&gt;
+++ b/components/camel-core-osgi/src/main/java/org/apache/camel/core/osgi/OsgiCamelContextHelper.java&lt;br/&gt;
@@ -56,14 +56,23 @@ public static void osgiUpdate(DefaultCamelContext camelContext, BundleContext bu&lt;br/&gt;
     public static Registry wrapRegistry(CamelContext camelContext, Registry registry, BundleContext bundleContext) {&lt;br/&gt;
         ObjectHelper.notNull(bundleContext, &quot;BundleContext&quot;);&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;LOG.debug(&quot;Setting up OSGi ServiceRegistry&quot;);&lt;/li&gt;
	&lt;li&gt;OsgiServiceRegistry osgiServiceRegistry = new OsgiServiceRegistry(bundleContext);&lt;br/&gt;
+        OsgiServiceRegistry osgiServiceRegistry = null;&lt;br/&gt;
+        Registry resultingRegistry = registry;&lt;br/&gt;
+        if(registry instanceof OsgiServiceRegistry) 
{
+            osgiServiceRegistry = (OsgiServiceRegistry)registry;
+        }
&lt;p&gt; else &lt;/p&gt;
{
+            LOG.debug(&quot;Wrapping Registry in OsgiServiceRegistry&quot;);
+            osgiServiceRegistry = new OsgiServiceRegistry(bundleContext);
+            CompositeRegistry compositeRegistry = new CompositeRegistry();
+            compositeRegistry.addRegistry(osgiServiceRegistry);
+            compositeRegistry.addRegistry(registry);
+            resultingRegistry = compositeRegistry;
+        }
&lt;p&gt;+        &lt;br/&gt;
         // Need to clean up the OSGi service when camel context is closed.&lt;br/&gt;
         camelContext.addLifecycleStrategy(osgiServiceRegistry);&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;CompositeRegistry compositeRegistry = new CompositeRegistry();&lt;/li&gt;
	&lt;li&gt;compositeRegistry.addRegistry(osgiServiceRegistry);&lt;/li&gt;
	&lt;li&gt;compositeRegistry.addRegistry(registry);&lt;/li&gt;
	&lt;li&gt;return compositeRegistry;&lt;br/&gt;
+        &lt;br/&gt;
+        return resultingRegistry;&lt;br/&gt;
     }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; }&lt;br/&gt;
diff --git a/components/camel-core-osgi/src/main/java/org/apache/camel/core/osgi/OsgiDefaultCamelContext.java b/components/camel-core-osgi/src/main/java/org/apache/camel/core/osgi/OsgiDefaultCamelContext.java&lt;br/&gt;
index 20e3a21eca0..821ef5d7978 100644&lt;br/&gt;
&amp;#8212; a/components/camel-core-osgi/src/main/java/org/apache/camel/core/osgi/OsgiDefaultCamelContext.java&lt;br/&gt;
+++ b/components/camel-core-osgi/src/main/java/org/apache/camel/core/osgi/OsgiDefaultCamelContext.java&lt;br/&gt;
@@ -32,7 +32,6 @@&lt;br/&gt;
 public class OsgiDefaultCamelContext extends DefaultCamelContext {&lt;/p&gt;

&lt;p&gt;     private final BundleContext bundleContext;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private final Registry registry;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     public OsgiDefaultCamelContext(BundleContext bundleContext) {&lt;br/&gt;
         this(bundleContext, new OsgiServiceRegistry(bundleContext));&lt;br/&gt;
@@ -41,7 +40,7 @@ public OsgiDefaultCamelContext(BundleContext bundleContext) {&lt;br/&gt;
     public OsgiDefaultCamelContext(BundleContext bundleContext, Registry registry) {&lt;br/&gt;
         super(registry);&lt;br/&gt;
         this.bundleContext = bundleContext;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;this.registry = registry;&lt;br/&gt;
+        setRegistry(OsgiCamelContextHelper.wrapRegistry(this, registry, bundleContext));&lt;br/&gt;
         OsgiCamelContextHelper.osgiUpdate(this, bundleContext);&lt;br/&gt;
         // setup the application context classloader with the bundle classloader&lt;br/&gt;
         setApplicationContextClassLoader(new BundleDelegatingClassLoader(bundleContext.getBundle()));&lt;br/&gt;
@@ -52,15 +51,6 @@ public OsgiDefaultCamelContext(BundleContext bundleContext, Registry registry) 
{
         return BundleContextUtils.findComponents(bundleContext, this);
     }&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;@Override&lt;/li&gt;
	&lt;li&gt;protected Registry createRegistry() {&lt;/li&gt;
	&lt;li&gt;if (registry != null) 
{
-            return OsgiCamelContextHelper.wrapRegistry(this, registry, bundleContext);
-        }
&lt;p&gt; else &lt;/p&gt;
{
-            return OsgiCamelContextHelper.wrapRegistry(this, super.createRegistry(), bundleContext);
-        }&lt;/li&gt;
	&lt;li&gt;}&lt;br/&gt;
-&lt;br/&gt;
     @Override&lt;br/&gt;
     protected TypeConverter createTypeConverter() {&lt;br/&gt;
         // &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-3614&quot; title=&quot;When the OsgiTypeConverter looks for TypeConverterLoader services in the OSGi registry, it should use its own BundleContext instead of the one from the client bundle so that class space consistency can be fully enforced&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-3614&quot;&gt;&lt;del&gt;CAMEL-3614&lt;/del&gt;&lt;/a&gt;: make sure we use a bundle context which imports org.apache.camel.impl.converter package&lt;br/&gt;
diff --git a/components/camel-core-osgi/src/main/java/org/apache/camel/core/osgi/OsgiServiceRegistry.java b/components/camel-core-osgi/src/main/java/org/apache/camel/core/osgi/OsgiServiceRegistry.java&lt;br/&gt;
index 4569962da2d..3cbbad8e2fb 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/components/camel-core-osgi/src/main/java/org/apache/camel/core/osgi/OsgiServiceRegistry.java&lt;br/&gt;
+++ b/components/camel-core-osgi/src/main/java/org/apache/camel/core/osgi/OsgiServiceRegistry.java&lt;br/&gt;
@@ -21,15 +21,24 @@&lt;br/&gt;
 import java.util.Map;&lt;br/&gt;
 import java.util.Queue;&lt;br/&gt;
 import java.util.Set;&lt;br/&gt;
+import java.util.concurrent.BlockingQueue;&lt;br/&gt;
+import java.util.concurrent.ConcurrentHashMap;&lt;br/&gt;
 import java.util.concurrent.ConcurrentLinkedQueue;&lt;br/&gt;
+import java.util.concurrent.ExecutorService;&lt;br/&gt;
+import java.util.concurrent.Executors;&lt;br/&gt;
+import java.util.concurrent.LinkedBlockingQueue;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; import org.apache.camel.CamelContext;&lt;br/&gt;
+import org.apache.camel.VetoCamelContextStartException;&lt;br/&gt;
 import org.apache.camel.spi.Registry;&lt;br/&gt;
 import org.apache.camel.support.LifecycleStrategySupport;&lt;br/&gt;
 import org.apache.camel.util.ObjectHelper;&lt;br/&gt;
+import org.apache.camel.util.concurrent.CamelThreadFactory;&lt;br/&gt;
 import org.osgi.framework.BundleContext;&lt;br/&gt;
 import org.osgi.framework.Constants;&lt;br/&gt;
 import org.osgi.framework.InvalidSyntaxException;&lt;br/&gt;
+import org.osgi.framework.ServiceEvent;&lt;br/&gt;
+import org.osgi.framework.ServiceListener;&lt;br/&gt;
 import org.osgi.framework.ServiceReference;&lt;br/&gt;
 import org.slf4j.Logger;&lt;br/&gt;
 import org.slf4j.LoggerFactory;&lt;br/&gt;
@@ -37,13 +46,25 @@&lt;br/&gt;
 /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;The OsgiServiceRegistry support to get the service object from the bundle context&lt;br/&gt;
  */&lt;br/&gt;
-public class OsgiServiceRegistry extends LifecycleStrategySupport implements Registry {&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private static final Logger LOG = LoggerFactory.getLogger(OsgiCamelContextHelper.class);&lt;br/&gt;
+public class OsgiServiceRegistry extends LifecycleStrategySupport implements Registry, ServiceListener {&lt;br/&gt;
+    private static final Logger LOG = LoggerFactory.getLogger(OsgiServiceRegistry.class);&lt;br/&gt;
     private final BundleContext bundleContext;&lt;br/&gt;
     private final Queue&amp;lt;ServiceReference&amp;lt;?&amp;gt;&amp;gt; serviceReferenceQueue = new ConcurrentLinkedQueue&amp;lt;&amp;gt;();&lt;br/&gt;
+    private final BlockingQueue&amp;lt;ServiceReference&amp;lt;?&amp;gt;&amp;gt; unregisteredServiceReferenceQueue = new LinkedBlockingQueue&amp;lt;&amp;gt;();&lt;br/&gt;
+    private final Map&amp;lt;ServiceReference&amp;lt;?&amp;gt;, Object&amp;gt; serviceCacheMap = new ConcurrentHashMap&amp;lt;&amp;gt;();&lt;br/&gt;
+    private ExecutorService executorService;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     public OsgiServiceRegistry(BundleContext bc) &lt;/p&gt;
{
         bundleContext = bc;
+        bundleContext.addServiceListener(this);
+    }
&lt;p&gt;+    &lt;br/&gt;
+    @Override&lt;br/&gt;
+    public void onContextStart(CamelContext context) throws VetoCamelContextStartException &lt;/p&gt;
{
+        //Start the ServiceReference Cleanup Task.
+        executorService = Executors.newSingleThreadExecutor(new CamelThreadFactory(&quot;Camel (&quot; + context.getName() + &quot;) thread ##counter# - #name#&quot;, &quot;OSGiServiceReferenceCleanupThread&quot;, true));
+
+        executorService.execute(new OsgiServiceReferenceCleanupTask());
     }

&lt;p&gt;     /**&lt;br/&gt;
@@ -57,8 +78,7 @@ public OsgiServiceRegistry(BundleContext bc) {&lt;br/&gt;
             if (refs != null &amp;amp;&amp;amp; refs.length &amp;gt; 0) &lt;/p&gt;
{
                 // just return the first one
                 sr = refs[0];
-                serviceReferenceQueue.add(sr);
-                service = bundleContext.getService(sr);
+                service = getService(sr);
             }
&lt;p&gt;         } catch (Exception ex) {&lt;br/&gt;
             throw ObjectHelper.wrapRuntimeCamelException(ex);&lt;br/&gt;
@@ -90,8 +110,7 @@ public Object lookupByName(String name) {&lt;br/&gt;
         if (sr != null) &lt;/p&gt;
{
             // Need to keep the track of Service
             // and call ungetService when the camel context is closed 
-            serviceReferenceQueue.add(sr);
-            service = bundleContext.getService(sr);
+            service = getService(sr);
         }
&lt;p&gt;         return service;&lt;br/&gt;
     }&lt;br/&gt;
@@ -104,8 +123,7 @@ public Object lookupByName(String name) {&lt;br/&gt;
             if (refs != null) {&lt;br/&gt;
                 for (ServiceReference&amp;lt;?&amp;gt; sr : refs) {&lt;br/&gt;
                     if (sr != null) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Object service = bundleContext.getService(sr);&lt;/li&gt;
	&lt;li&gt;serviceReferenceQueue.add(sr);&lt;br/&gt;
+                        Object service = getService(sr);&lt;br/&gt;
                         if (service != null) {&lt;br/&gt;
                             String name = (String)sr.getProperty(&quot;name&quot;);&lt;br/&gt;
                             if (name != null) {&lt;br/&gt;
@@ -152,6 +170,48 @@ public void onContextStop(CamelContext context) {&lt;br/&gt;
         }&lt;br/&gt;
         // Clean up the OSGi Service Cache&lt;br/&gt;
         serviceReferenceQueue.clear();&lt;br/&gt;
+        serviceCacheMap.clear();&lt;br/&gt;
+        unregisteredServiceReferenceQueue.clear();&lt;br/&gt;
+        executorService.shutdownNow();&lt;br/&gt;
+        executorService = null;&lt;br/&gt;
+    }&lt;br/&gt;
+    &lt;br/&gt;
+    @Override&lt;br/&gt;
+    public void serviceChanged(ServiceEvent event) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+        if( event.getType() == ServiceEvent.UNREGISTERING) {
+                this.unregisteredServiceReferenceQueue.add(event.getServiceReference());
+        }+    }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;+    &lt;br/&gt;
+    private Object getService(ServiceReference&amp;lt;?&amp;gt; sr) {&lt;br/&gt;
+        Object service = this.serviceCacheMap.get(sr);&lt;br/&gt;
+        if(service == null) &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+            service = this.bundleContext.getService(sr);+            serviceReferenceQueue.add(sr);+            if(service != null) {
+                this.serviceCacheMap.put(sr, service);
+            }+        }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;+        return service;&lt;br/&gt;
+    }&lt;br/&gt;
+    &lt;br/&gt;
+    class OsgiServiceReferenceCleanupTask implements Runnable {&lt;br/&gt;
+        @Override&lt;br/&gt;
+        public void run() {&lt;br/&gt;
+            ServiceReference&amp;lt;?&amp;gt; serviceReference = null;&lt;br/&gt;
+            try {&lt;br/&gt;
+                while((serviceReference = unregisteredServiceReferenceQueue.take()) != null) &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+                    if(!bundleContext.ungetService(serviceReference)) {
+                        serviceCacheMap.remove(serviceReference);
+                        serviceReferenceQueue.remove(serviceReference);
+                    }+                    else {
+                        unregisteredServiceReferenceQueue.add(serviceReference);
+                    }+                }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;+            } catch (InterruptedException e) &lt;/p&gt;
{
+                LOG.info(&quot;Camel Osgi Service Reference Clean up Interrupted&quot;, e);
+            }
&lt;p&gt;+        }&lt;br/&gt;
     }&lt;br/&gt;
-&lt;br/&gt;
 }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16731048" author="davsclaus" created="Sun, 30 Dec 2018 18:45:08 +0000"  >&lt;p&gt;Thanks Bob, for all the work on this, much appreciated.&lt;/p&gt;</comment>
                            <comment id="16731057" author="bobpaulin" created="Sun, 30 Dec 2018 19:38:51 +0000"  >&lt;p&gt;Thank you for backporting.&#160; Looking forward to picking it up in the next release!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12950174" name="ServiceReferenceQueueLeak.PNG" size="13387" author="bobpaulin" created="Fri, 30 Nov 2018 15:46:34 +0000"/>
                            <attachment id="12950177" name="ServiceReferenceQueuePostContextStop.PNG" size="50985" author="bobpaulin" created="Fri, 30 Nov 2018 15:51:27 +0000"/>
                            <attachment id="12950175" name="ServiceReferenceQueuePreContextStop.PNG" size="51631" author="bobpaulin" created="Fri, 30 Nov 2018 15:50:40 +0000"/>
                            <attachment id="12950176" name="karafCamelContextStop.PNG" size="4891" author="bobpaulin" created="Fri, 30 Nov 2018 15:51:09 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 46 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|s011rc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>