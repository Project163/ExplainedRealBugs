<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:52:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-5225] camel-netty can&apos;t distinguish between Sharable and Unsharable codecs</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-5225</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;Camel-netty uses general configuration model for referenced encoders/decoders for channel pipelines, see DefaultServerPipelineFactory. That is, create encoder/decoder objects at configuration parsing time and store them in a list, then use them when a pipeline is established. However, this will make encoder/decoder objects shared among different pipelines, that may cause data conflicts, when the encoder/decoder is not Sharable(has object status/not annotated as @Sharable), e.g. a LengthFieldBasedFrameDecoder.&lt;/p&gt;

&lt;p&gt;Although we can avoid the problem by totally writing a new serverpipelinefactory for our apps, several problem still remains, please see detailed description and testcase for this bug at:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://camel.465427.n5.nabble.com/camel-netty-bug-and-the-need-of-best-practice-for-creating-referenced-parameter-object-on-looking-up-td5627926.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://camel.465427.n5.nabble.com/camel-netty-bug-and-the-need-of-best-practice-for-creating-referenced-parameter-object-on-looking-up-td5627926.html&lt;/a&gt;&lt;/p&gt;</description>
                <environment>&lt;p&gt;ALL&lt;/p&gt;</environment>
        <key id="12552870">CAMEL-5225</key>
            <summary>camel-netty can&apos;t distinguish between Sharable and Unsharable codecs</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="edge">edge wang</reporter>
                        <labels>
                            <label>netty</label>
                    </labels>
                <created>Thu, 26 Apr 2012 16:03:53 +0000</created>
                <updated>Wed, 13 Jun 2012 09:33:13 +0000</updated>
                            <resolved>Fri, 8 Jun 2012 15:30:28 +0000</resolved>
                                    <version>2.9.2</version>
                                    <fixVersion>2.9.3</fixVersion>
                    <fixVersion>2.10.0</fixVersion>
                                    <component>camel-netty</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13262762" author="edge" created="Thu, 26 Apr 2012 17:22:50 +0000"  >&lt;p&gt;here is the test for showing this bug, as mentioned in the post at nabble, you can get random results each time you run the testcase when this bug exists.&lt;/p&gt;</comment>
                            <comment id="13263408" author="davsclaus" created="Fri, 27 Apr 2012 06:57:55 +0000"  >&lt;p&gt;camel-netty have been improved for Camel 2.10.&lt;/p&gt;

&lt;p&gt;And if you use decoders/encoders that cannot be shared with multiple consumers, then you need to enlist 2 in the registry etc.&lt;br/&gt;
This is &lt;b&gt;not&lt;/b&gt; a bug, but how its designed. You as the end user must configure the endpoints/components correctly.&lt;/p&gt;

&lt;p&gt;I have added your test to the source and it passes on trunk.&lt;/p&gt;</comment>
                            <comment id="13263790" author="edge" created="Fri, 27 Apr 2012 16:56:13 +0000"  >&lt;p&gt;Thank you very much for your response and adding my testcase to the trunk. However, your answer makes me aware of two things:&lt;/p&gt;

&lt;p&gt;1.My testcase is very very misleading (so sorry for that), makes people think the problem is due to sharing decoders among consumers, but that&apos;s not the case, as I explained very clearly in the posts, it is because you share them among &lt;b&gt;pipelines&lt;/b&gt;, not consumers.&lt;/p&gt;

&lt;p&gt;2.Camel-netty in version 2.10 (as well as 2.9.2) introduced a new bug, severe than the one I reported, breaks netty&apos;s pipeline model more than before. Hence even I correct the implementation of DefaultServerPipelineFactory, the testcase still breaks.&lt;/p&gt;

&lt;p&gt;So here I attach the correct testcase, and do some reference to show the problem I reported as well as the new bug introduced.&lt;/p&gt;

&lt;p&gt;sorry again for the previous misleading testcase &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13263804" author="edge" created="Fri, 27 Apr 2012 17:10:45 +0000"  >&lt;p&gt;Here is the correct testcase and the patch to pass the testing. The patch simply creates a new decoder(by hard coding that matches the testcase) each time when getpipeline is called, when you run the testcase against patched 2.9.1 version of cammel-netty, you get it passed, but not for 2.9.2 and 2.10.&lt;/p&gt;</comment>
                            <comment id="13263813" author="edge" created="Fri, 27 Apr 2012 17:20:07 +0000"  >&lt;p&gt;Here are some references:&lt;/p&gt;

&lt;p&gt;1.showing that unsharable decoders should not be shared among channels(pipelines)&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://stackoverflow.com/questions/9254800/is-framedecoder-not-safe-in-non-single-connection-situation&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://stackoverflow.com/questions/9254800/is-framedecoder-not-safe-in-non-single-connection-situation&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;and of course the mentioned url:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://netty.io/docs/stable/api/org/jboss/netty/channel/ChannelHandler.Sharable.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://netty.io/docs/stable/api/org/jboss/netty/channel/ChannelHandler.Sharable.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;2.the evidence showing the new bug&lt;/p&gt;

&lt;p&gt;Line 183-185 of NettyConsumer.java in version 2.9.2 ant 2.10:&lt;br/&gt;
---------------------------------------------------------------------------------------------------&lt;br/&gt;
        // must get the pipeline from the factory when opening a new connection&lt;br/&gt;
        ChannelPipeline serverPipeline = pipelineFactory.getPipeline(this);&lt;br/&gt;
        serverBootstrap.setPipeline(serverPipeline);&lt;br/&gt;
---------------------------------------------------------------------------------------------------&lt;/p&gt;

&lt;p&gt;The netty javadoc for ServerBootStrap.setPipeline:&lt;br/&gt;
---------------------------------------------------------------------------------------&lt;br/&gt;
public void setPipeline(ChannelPipeline pipeline)&lt;br/&gt;
Sets the default ChannelPipeline which is cloned when a new Channel is created. Bootstrap creates a new pipeline which has the same entries with the specified pipeline for a new channel.&lt;br/&gt;
Calling this method also sets the pipelineFactory property to an internal ChannelPipelineFactory implementation which returns a shallow copy of the specified pipeline.&lt;/p&gt;

&lt;p&gt;Please note that this method is a convenience method that works only when 1) you create only one channel from this bootstrap (e.g. one-time client-side or connectionless channel) or 2) the ChannelPipelineCoverage of all handlers in the pipeline is &quot;all&quot;. You have to use setPipelineFactory(ChannelPipelineFactory) if 1) your pipeline contains a ChannelHandler whose ChannelPipelineCoverage is &quot;one&quot; and 2) one or more channels are going to be created by this bootstrap (e.g. server-side channels).&lt;br/&gt;
----------------------------------------------------------------------------------------&lt;/p&gt;

&lt;p&gt;So you are setting the pipeline to the serverbootstrap for netty consumer (which opens server-side channels), simply breaks the second situation when &quot;You have to use setPipelineFactory(ChannelPipelineFactory)&quot;. However, the implementation in 2.9.1 and before is correct.&lt;/p&gt;
</comment>
                            <comment id="13291821" author="davsclaus" created="Fri, 8 Jun 2012 15:30:28 +0000"  >&lt;p&gt;Thanks for reporting.&lt;/p&gt;

&lt;p&gt;I have refactored to use the pipeline factory, so we support stateful codecs&lt;/p&gt;</comment>
                            <comment id="13292466" author="edge" created="Sun, 10 Jun 2012 03:01:31 +0000"  >&lt;p&gt;Would you please adopt my revised UnsharableCodecsConflictsTest.java and run the test? I only saw the code somewhat reverted to version 2.9.1, but didn&apos;t solve the problem I reported. The problem exists as long as you use code like this(DefaultServerPipelineFactory.java):&lt;/p&gt;

&lt;p&gt;        List&amp;lt;ChannelUpstreamHandler&amp;gt; decoders = consumer.getConfiguration().getDecoders();&lt;br/&gt;
        for (int x = 0; x &amp;lt; decoders.size(); x++) &lt;/p&gt;
{
            channelPipeline.addLast(&quot;decoder-&quot; + x, decoders.get(x));
        }

&lt;p&gt;this configuration model causes the decoders(created and cached in consumer.getConfiguration().getDecoders()) to be shared among pinelines and then lead to conflicts on stateful codecs.&lt;/p&gt;</comment>
                            <comment id="13294291" author="davsclaus" created="Wed, 13 Jun 2012 09:33:13 +0000"  >&lt;p&gt;Okay I have further improved the code to support for shareable and non-shareable encoders/decoders.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12524889" name="DefaultServerPipelineFactory.java.patch" size="1808" author="edge" created="Fri, 27 Apr 2012 17:06:04 +0000"/>
                            <attachment id="12524888" name="UnsharableCodecsConflictsTest.java" size="3843" author="edge" created="Fri, 27 Apr 2012 17:03:23 +0000"/>
                            <attachment id="12524467" name="UnsharableCodecsConflictsTest.java" size="4699" author="edge" created="Thu, 26 Apr 2012 17:22:50 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10063"><![CDATA[Advanced]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>236809</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 24 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i025rz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>10537</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>