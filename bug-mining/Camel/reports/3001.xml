<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:05:53 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-8086] Possible memoryleak when convertBodyTo is used in a dynamicRouter</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-8086</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;We have implemented a while loop using a dynamicRouter.&lt;br/&gt;
The dynamicRouter looks like this:&lt;br/&gt;
&amp;lt;dynamicRouter&amp;gt;&lt;br/&gt;
  &amp;lt;header&amp;gt;someheadername&amp;lt;/header&amp;gt;&lt;br/&gt;
&amp;lt;/dynamicRouter&amp;gt;&lt;br/&gt;
where someheadername refers to another route using direct:routename&lt;/p&gt;

&lt;p&gt;The route that handles direct:routename looks like this:&lt;br/&gt;
&amp;lt;bean ref=&quot;someref&quot;/&amp;gt;&lt;br/&gt;
&amp;lt;convertBodyTo type=&quot;java.lang.String&quot;/&amp;gt;&lt;/p&gt;

&lt;p&gt;The someref-bean just puts some data in the body and header and would also be responsible to set the value of someheadername=null to exit the dynamicRouter.&lt;br/&gt;
During execution of these routes we see that heapusage increases until OOM if the dynamicRouter does not exit before OOM. The number of instances of DefaultMessage also keeps increasing.&lt;/p&gt;

&lt;p&gt;If we remove the &amp;lt;convertBodyTo&amp;gt; from the route we do not get OOM and the number of instances of DefaultMessage is stable and low.&lt;br/&gt;
The same also happens if we replace &amp;lt;convertBodyTo&amp;gt; with a &amp;lt;transform&amp;gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12758236">CAMEL-8086</key>
            <summary>Possible memoryleak when convertBodyTo is used in a dynamicRouter</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="bjorn.hilstad">Bj&#248;rn Hilstad</reporter>
                        <labels>
                    </labels>
                <created>Thu, 27 Nov 2014 15:12:26 +0000</created>
                <updated>Wed, 3 Dec 2014 16:40:58 +0000</updated>
                            <resolved>Wed, 3 Dec 2014 16:40:58 +0000</resolved>
                                    <version>2.13.2</version>
                                    <fixVersion>2.13.4</fixVersion>
                    <fixVersion>2.14.1</fixVersion>
                    <fixVersion>2.15.0</fixVersion>
                                    <component>camel-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14227808" author="davsclaus" created="Thu, 27 Nov 2014 16:29:00 +0000"  >&lt;p&gt;You should likely use recipient list instead. That only runs one time. The dynamic router repeats itself until the expression returns null. &lt;/p&gt;</comment>
                            <comment id="14227951" author="bjorn.hilstad" created="Thu, 27 Nov 2014 20:37:24 +0000"  >&lt;p&gt;I&apos;m not quite sure that we could use a recipient list in this case.&lt;br/&gt;
What we are trying to do is to make a while-loop, where we in the bean get one message from an external service and process that. If there are no more messages the bean will return null to exit from the dynamic router.&lt;/p&gt;</comment>
                            <comment id="14227956" author="davsclaus" created="Thu, 27 Nov 2014 20:43:20 +0000"  >&lt;p&gt;You are doing it wrong as the expression in the dynamic router is a header, not a method call expression.&lt;/p&gt;

&lt;p&gt;Please use the mailing list for help this is not a Camel bug&lt;/p&gt;</comment>
                            <comment id="14231416" author="bjorn.hilstad" created="Tue, 2 Dec 2014 12:44:07 +0000"  >&lt;p&gt;I have tried implementing it the way you suggested but the issue is the same. As long as the convertBodyTo is in the route we get the OOM, if I remove it the while loop can run indefinitely without OOM.&lt;br/&gt;
I am attaching a route (in a spring context) and a simple processor implementation to illustrate this. I can also upload a working application (or maven projects you can build yourself) if required.&lt;/p&gt;</comment>
                            <comment id="14231417" author="bjorn.hilstad" created="Tue, 2 Dec 2014 12:44:44 +0000"  >&lt;p&gt;Spring context and Processor&lt;/p&gt;</comment>
                            <comment id="14232993" author="davsclaus" created="Wed, 3 Dec 2014 13:32:26 +0000"  >&lt;p&gt;&amp;gt; The same also happens if we replace &amp;lt;convertBodyTo&amp;gt; with a &amp;lt;transform&amp;gt;.&lt;/p&gt;

&lt;p&gt;What do you mean by this? That using transform also causes a OOME issue for you?&lt;/p&gt;

</comment>
                            <comment id="14233013" author="davsclaus" created="Wed, 3 Dec 2014 14:09:20 +0000"  >&lt;p&gt;I found the issue, the problem is that the old message that the covertBodyTo creates a new message to replace the old message, and the old message has a reference to the live exchange, so it cannot be GC (even its no longer in use). So we need to de-referrence that, and it works.&lt;/p&gt;</comment>
                            <comment id="14233024" author="davsclaus" created="Wed, 3 Dec 2014 14:18:34 +0000"  >&lt;p&gt;I also found an optimization we can do in convertBodyTo/transform/setBody to avoid the message copy if its not a specialized message, as in those case we can just set the replace body directly.&lt;/p&gt;</comment>
                            <comment id="14233173" author="davsclaus" created="Wed, 3 Dec 2014 16:40:58 +0000"  >&lt;p&gt;Thanks for the test case.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12684635" name="SomeProcessor.java" size="1008" author="bjorn.hilstad" created="Tue, 2 Dec 2014 12:44:44 +0000"/>
                            <attachment id="12684634" name="applicationContext.xml" size="1125" author="bjorn.hilstad" created="Tue, 2 Dec 2014 12:44:44 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 50 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i22uqn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>