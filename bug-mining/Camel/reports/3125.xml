<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:07:21 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-7644] Scala camel DSL creates numerous DefaultCamelContext instances</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-7644</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;Since the camel DSL is invoked prior to `.addRoutesToCamelContext(CamelContext)` being invoked there is no camel context set on the delegate java RouteBuilder which causes it to create a new context when the first dsl method is invoked.&lt;/p&gt;

&lt;p&gt;With the implementation of &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-7327&quot; title=&quot;Improve Container.Instance API to deal with setting a Container after CamelContexts have been created. There is a big risk CamelContext&amp;#39;s won&amp;#39;t get managed right now&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-7327&quot;&gt;&lt;del&gt;CAMEL-7327&lt;/del&gt;&lt;/a&gt; introduced in 2.13.1 which stores created camel contexts in a set in `Container.Instance#CONTEXT`; this causes instances of DefaultCamelContext to be leaked, they are never removed from the static set. This is especially aparrent during unit testing.&lt;/p&gt;

&lt;p&gt;The following test shows that an additional context is registered for the scala route builder as opposed to java. Verification of the leak can be requires profiler and capturing of heap after termination of the test case (in ParentRunner.java).&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt; org.apache.camel.scala.dsl.builder;

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; com.google.common.collect.Sets;

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.camel.CamelContext;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.camel.ProducerTemplate;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.camel.builder.RouteBuilder;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.camel.impl.DefaultCamelContext;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.camel.spi.Container;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.junit.After;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.junit.Before;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.junit.Test;

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.lang.ref.WeakReference;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.util.Set;

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; org.junit.Assert.assertEquals;

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;BuggyScalaTest &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; Container {

  Set&amp;lt;CamelContext&amp;gt; managed = Sets.newHashSet();

  @Before
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void setUp() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    Container.Instance.set(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;);
  }

  @After
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void tearDown() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    Container.Instance.set(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
  }

  @Test
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testNameJava() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    DefaultCamelContext defaultCamelContext = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DefaultCamelContext();
    defaultCamelContext.addRoutes(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RouteBuilder() {
      @Override
      &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void configure() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        from(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:start&quot;&lt;/span&gt;).log(&lt;span class=&quot;code-quote&quot;&gt;&quot;a message&quot;&lt;/span&gt;);
      }
    });
    defaultCamelContext.start();

    ProducerTemplate producerTemplate = defaultCamelContext.createProducerTemplate();
    producerTemplate.start();
    producerTemplate.sendBody(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:start&quot;&lt;/span&gt;, &quot;&quot;);
    producerTemplate.stop();
    defaultCamelContext.stop();

    assertEquals(1, managed.size());
  }

  @Test
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testNameScala() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    DefaultCamelContext defaultCamelContext = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DefaultCamelContext();
    defaultCamelContext.addRoutes(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SimpleRouteBuilder());
    defaultCamelContext.start();

    ProducerTemplate producerTemplate = defaultCamelContext.createProducerTemplate();
    producerTemplate.start();
    producerTemplate.sendBody(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:start&quot;&lt;/span&gt;, &quot;&quot;);
    producerTemplate.stop();
    defaultCamelContext.stop();

    assertEquals(1, managed.size()); &lt;span class=&quot;code-comment&quot;&gt;// will equal 2
&lt;/span&gt;  }

  @Override
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void manage(CamelContext camelContext) {
    managed.add(camelContext);
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  &lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt; org.apache.camel.scala.dsl.builder

  &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.camel.scala.dsl.builder.RouteBuilder

  &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;SimpleRouteBuilder &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; RouteBuilder {
    from(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:start&quot;&lt;/span&gt;).log(&lt;span class=&quot;code-quote&quot;&gt;&quot;a message&quot;&lt;/span&gt;)
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12730246">CAMEL-7644</key>
            <summary>Scala camel DSL creates numerous DefaultCamelContext instances</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="ukcrpb6">Bob Browning</reporter>
                        <labels>
                    </labels>
                <created>Mon, 28 Jul 2014 16:39:53 +0000</created>
                <updated>Tue, 3 Mar 2015 09:12:32 +0000</updated>
                            <resolved>Tue, 3 Mar 2015 09:12:32 +0000</resolved>
                                    <version>2.13.1</version>
                                    <fixVersion>2.15.0</fixVersion>
                                    <component>camel-scala</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14077662" author="njiang" created="Tue, 29 Jul 2014 12:31:41 +0000"  >&lt;p&gt;I just dug the code and found out all the unit tests which extends the CamelTestSupport has the same problem which lets the RouteBuilder creates a default camel context when the first dsl method is used.  &lt;/p&gt;

&lt;p&gt;To resolve this, we need to pass the camel context instance to the RouteBuilder to avoid create the default camel context there.&lt;/p&gt;

&lt;p&gt;For adding the created camel context into the static set, I think maybe we can do it when the camel context is start the &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-7327&quot; title=&quot;Improve Container.Instance API to deal with setting a Container after CamelContexts have been created. There is a big risk CamelContext&amp;#39;s won&amp;#39;t get managed right now&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-7327&quot;&gt;&lt;del&gt;CAMEL-7327&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="14321934" author="davsclaus" created="Sun, 15 Feb 2015 11:35:56 +0000"  >&lt;p&gt;What is the status of this ticket?&lt;/p&gt;</comment>
                            <comment id="14344623" author="davsclaus" created="Tue, 3 Mar 2015 06:39:24 +0000"  >&lt;p&gt;Okay so the problem is that camel-scala RouteBuilder runs the route configure in its constructor, it should use a configure method just like java does.&lt;/p&gt;
</comment>
                            <comment id="14344763" author="davsclaus" created="Tue, 3 Mar 2015 09:01:41 +0000"  >&lt;p&gt;We are adding a ScalaRouteBuilder ppl should use that requires to pass in a CamelContext, then its a fairly easy migration effort.&lt;/p&gt;</comment>
                            <comment id="14344777" author="davsclaus" created="Tue, 3 Mar 2015 09:12:17 +0000"  >&lt;p&gt;See this unit test how to use the new ScalaRouteBuilder and with lazy modifier when using ScalaTestSupport&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/camel/commit/01f08a6267232089adba90a380050ba5dc9c43d2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/commit/01f08a6267232089adba90a380050ba5dc9c43d2&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310040">
                    <name>Required</name>
                                                                <inwardlinks description="is required by">
                                        <issuelink>
            <issuekey id="12778899">CAMEL-8427</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>408319</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 38 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1y9cv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>408323</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>