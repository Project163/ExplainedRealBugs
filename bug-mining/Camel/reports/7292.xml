<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 11:13:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-22658] [camel-google-pubsub] GooglePubsubProducer fails with INVALID_ARGUMENT</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-22658</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;Since the change for &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-22403&quot; title=&quot;[camel-google-pubsub] Extend headers with some HeaderFilterStrategy&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-22403&quot;&gt;&lt;del&gt;CAMEL-22403&lt;/del&gt;&lt;/a&gt; was applied, we have had issues where the Camel PubSub producer fails to send messages to a Google Pub Sub topic.&lt;/p&gt;

&lt;p&gt;The scenario is:&lt;/p&gt;

&lt;p&gt;1. PubSub message received by the consumer&lt;br/&gt;
2. Processing occurs&lt;br/&gt;
3. Attempt to send response message to a different topic.&lt;/p&gt;

&lt;p&gt;The exception seen is:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.util.concurrent.ExecutionException: com.google.api.gax.rpc.InvalidArgumentException: io.grpc.StatusRuntimeException: INVALID_ARGUMENT: The request contains an attribute key that is not valid (key=googclient_deliveryattempt). Attribute keys must be non-empty and must not begin with &lt;span class=&quot;code-quote&quot;&gt;&apos;goog&apos;&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt;-insensitive).
	at com.google.common.util.concurrent.AbstractFuture.getDoneValue(AbstractFuture.java:292)
	at com.google.common.util.concurrent.AbstractFutureState.blockingGet(AbstractFutureState.java:255)
	at com.google.common.util.concurrent.Platform.get(Platform.java:54)
	at com.google.common.util.concurrent.AbstractFuture.get(AbstractFuture.java:253)
	at com.google.api.core.AbstractApiFuture.get(AbstractApiFuture.java:53)
	at org.apache.camel.component.google.pubsub.GooglePubsubProducer.send(GooglePubsubProducer.java:138)
	at org.apache.camel.component.google.pubsub.GooglePubsubProducer.process(GooglePubsubProducer.java:84)
	at org.apache.camel.support.AsyncProcessorConverterHelper$ProcessorToAsyncProcessorBridge.process(AsyncProcessorConverterHelper.java:65)
	at org.apache.camel.processor.SendProcessor.sendUsingProducer(SendProcessor.java:251)
	at org.apache.camel.processor.SendProcessor.process(SendProcessor.java:156)
	at org.apache.camel.processor.errorhandler.RedeliveryErrorHandler$RedeliveryTask.doRun(RedeliveryErrorHandler.java:777)
	at org.apache.camel.processor.errorhandler.RedeliveryErrorHandler$RedeliveryTask.run(RedeliveryErrorHandler.java:720)
	at org.apache.camel.impl.engine.DefaultReactiveExecutor$Worker.doRun(DefaultReactiveExecutor.java:199)
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I believe the issue is in the new GooglePubsubHeaderFilterStrategy class: &lt;a href=&quot;https://github.com/apache/camel/blob/camel-4.14.x/components/camel-google/camel-google-pubsub/src/main/java/org/apache/camel/component/google/pubsub/GooglePubsubHeaderFilterStrategy.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/blob/camel-4.14.x/components/camel-google/camel-google-pubsub/src/main/java/org/apache/camel/component/google/pubsub/GooglePubsubHeaderFilterStrategy.java&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This filters only headers starting with &lt;tt&gt;x-goog&lt;/tt&gt; or &lt;tt&gt;X-GOOG&lt;/tt&gt; and not &lt;tt&gt;goog&lt;/tt&gt;.  The legacy code is still there to filter those headers:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/camel/blob/811f38029a858fa5e35ae6f9979c614b19600f00/components/camel-google/camel-google-pubsub/src/main/java/org/apache/camel/component/google/pubsub/GooglePubsubProducer.java#L113&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/blob/811f38029a858fa5e35ae6f9979c614b19600f00/components/camel-google/camel-google-pubsub/src/main/java/org/apache/camel/component/google/pubsub/GooglePubsubProducer.java#L113&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;but then when the header filter is applied - it allows the &lt;tt&gt;goog&lt;/tt&gt; headers back in again&lt;/p&gt;

&lt;p&gt;We cannot configure the HeaderFilterStrategy on the GooglePubsubProducer, so can&apos;t override this behaviour&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=squakez&quot; class=&quot;user-hover&quot; rel=&quot;squakez&quot;&gt;squakez&lt;/a&gt; FYI&lt;/p&gt;</description>
                <environment></environment>
        <key id="13633417">CAMEL-22658</key>
            <summary>[camel-google-pubsub] GooglePubsubProducer fails with INVALID_ARGUMENT</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="daveroa">Dave Riseley</reporter>
                        <labels>
                    </labels>
                <created>Wed, 5 Nov 2025 12:53:34 +0000</created>
                <updated>Thu, 6 Nov 2025 15:15:17 +0000</updated>
                            <resolved>Thu, 6 Nov 2025 15:15:17 +0000</resolved>
                                    <version>4.14.2</version>
                                    <fixVersion>4.14.3</fixVersion>
                    <fixVersion>4.17.0</fixVersion>
                                    <component>camel-google-pubsub</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="18035576" author="davsclaus" created="Wed, 5 Nov 2025 13:11:36 +0000"  >&lt;p&gt;Thanks so create a google header filter strategy that extends the default and filter out those google headers also&lt;/p&gt;</comment>
                            <comment id="18035578" author="daveroa" created="Wed, 5 Nov 2025 13:17:12 +0000"  >&lt;p&gt;We&apos;d be happy to do so - but I don&apos;t see how that can be configured on the producer:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; HeaderFilterStrategy headerFilterStrategy;

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; GooglePubsubProducer(GooglePubsubEndpoint endpoint) {
        &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;(endpoint);

        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; loggerId = endpoint.getLoggerId();

        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (Strings.isNullOrEmpty(loggerId)) {
            loggerId = &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.getClass().getName();
        }

        logger = LoggerFactory.getLogger(loggerId);
        headerFilterStrategy = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; GooglePubsubHeaderFilterStrategy(endpoint.isIncludeAllGoogleProperties());
    }

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Also, it feels like a regression to me as this worked out of the box in 4.10.x&lt;/p&gt;</comment>
                            <comment id="18035579" author="davsclaus" created="Wed, 5 Nov 2025 13:20:26 +0000"  >&lt;p&gt;I am talking about if you want to work on a fix and submit as PR&lt;/p&gt;</comment>
                            <comment id="18035582" author="daveroa" created="Wed, 5 Nov 2025 13:23:23 +0000"  >&lt;p&gt;Ok - there is `GooglePubsubHeaderFilterStrategy` , so I&apos;ll just propose fixing that (and updating some tests)&lt;/p&gt;</comment>
                            <comment id="18035583" author="davsclaus" created="Wed, 5 Nov 2025 13:24:20 +0000"  >&lt;p&gt;the strategy is on the endpoint and the producer uses that like the consumer. And then add code in the producer that uses the strategy to filter. Maybe look elsewhere in camel codebase that does that.&#160;&lt;/p&gt;

&lt;p&gt;git grep is good for finding code&lt;/p&gt;</comment>
                            <comment id="18035596" author="squakez" created="Wed, 5 Nov 2025 14:48:32 +0000"  >&lt;p&gt;Yeah, we likely need to add also the old legacy header in the strategy. &lt;/p&gt;</comment>
                            <comment id="18035675" author="daveroa" created="Wed, 5 Nov 2025 22:36:29 +0000"  >&lt;p&gt;I&apos;ve added a PR: &lt;a href=&quot;https://github.com/apache/camel/pull/19823&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/19823&lt;/a&gt; that adds {goog*} to the header filter strategy and allows the header filter strategy to be configured on the endpoint (I hope!)&lt;/p&gt;</comment>
                            <comment id="18035866" author="davsclaus" created="Thu, 6 Nov 2025 15:15:17 +0000"  >&lt;p&gt;Thanks for reporting and the PR&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1ygrc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>