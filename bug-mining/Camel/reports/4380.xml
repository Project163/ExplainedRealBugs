<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:27:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-12103] Camel unable to shutdown gracefully because Netty4 consumer keep receiving and adding inflight exchanges</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-12103</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;I&apos;m using this URI: &lt;tt&gt;netty4:tcp://localhost:8888?sync=false&amp;amp;textline=true&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;And I have this issue when initiating Camel shutdown using &lt;tt&gt;DefaultShutdownStrategy&lt;/tt&gt;:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Camel suspends &lt;tt&gt;NettyConsumer&lt;/tt&gt; (&lt;tt&gt;SingleTCPNettyServerBootstrapFactory&lt;/tt&gt;), which only stops the &quot;main&quot; Netty channel, but &lt;em&gt;not&lt;/em&gt; the other Netty channels (i.e. socket connections)&lt;/li&gt;
	&lt;li&gt;Camel waits for routes to be empty of inflight &amp;amp; pending exchanges&lt;/li&gt;
	&lt;li&gt;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/warning.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Those other Netty channels kept receiving data, which are turned into new exchanges
	&lt;ul&gt;
		&lt;li&gt;As long as the TCP clients keep sending data into the channels + exchanges completing slower than send rate, routes will &lt;em&gt;never&lt;/em&gt; be empty of inflight &amp;amp; pending exchanges&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;Forced shutdown after 5 minutes (timed out)&lt;/li&gt;
&lt;/ol&gt;


&lt;h2&gt;&lt;a name=&quot;Tosimulatetheissue&quot;&gt;&lt;/a&gt;To simulate the issue&lt;/h2&gt;
&lt;ol&gt;
	&lt;li&gt;Run the attached &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12903781/12903781_tcp-server.camel&quot; title=&quot;tcp-server.camel attached to CAMEL-12103&quot;&gt;tcp-server.camel&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; Groovy script: &lt;tt&gt;groovy tcp-server.camel&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;After that has started, run the attached &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12903780/12903780_tcp-client.groovy&quot; title=&quot;tcp-client.groovy attached to CAMEL-12103&quot;&gt;tcp-client.groovy&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;: &lt;tt&gt;groovy tcp-client.groovy&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;After tcp-client starts sending data over, stop the tcp-server (CTRL+C in Windows)&lt;/li&gt;
	&lt;li&gt;You should see something like this:
&lt;div class=&quot;panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;cmd&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;panelContent&quot;&gt;
&lt;p&gt;INFO  - Apache Camel 2.15.2 (CamelContext: camel-1) started in 1.015 seconds&lt;br/&gt;
INFO  - Hey 0&lt;br/&gt;
INFO  - Hey 1&lt;br/&gt;
INFO  - Hey 2&lt;br/&gt;
INFO  - Hey 3&lt;br/&gt;
INFO  - Apache Camel 2.15.2 (CamelContext: camel-1) is shutting down&lt;br/&gt;
INFO  - Starting to graceful shutdown 1 routes (timeout 300 seconds)&lt;br/&gt;
INFO  - Waiting as there are still 1 inflight and pending exchanges to complete,&lt;br/&gt;
 timeout in 300 seconds.&lt;br/&gt;
INFO  - Hey 4&lt;br/&gt;
INFO  - Waiting as there are still 1 inflight and pending exchanges to complete,&lt;br/&gt;
 timeout in 299 seconds.&lt;br/&gt;
INFO  - Waiting as there are still 1 inflight and pending exchanges to complete,&lt;br/&gt;
 timeout in 298 seconds.&lt;br/&gt;
INFO  - Hey 5&lt;br/&gt;
INFO  - Waiting as there are still 1 inflight and pending exchanges to complete,&lt;br/&gt;
 timeout in 297 seconds.&lt;br/&gt;
INFO  - Waiting as there are still 1 inflight and pending exchanges to complete,&lt;br/&gt;
 timeout in 296 seconds.&lt;br/&gt;
INFO  - Hey 6&lt;br/&gt;
INFO  - Waiting as there are still 1 inflight and pending exchanges to complete,&lt;br/&gt;
 timeout in 295 seconds.&lt;br/&gt;
INFO  - Waiting as there are still 1 inflight and pending exchanges to complete,&lt;br/&gt;
 timeout in 294 seconds.&lt;br/&gt;
...&lt;/p&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ol&gt;
</description>
                <environment></environment>
        <key id="13127355">CAMEL-12103</key>
            <summary>Camel unable to shutdown gracefully because Netty4 consumer keep receiving and adding inflight exchanges</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="yihtserns">Yih Tsern</reporter>
                        <labels>
                    </labels>
                <created>Wed, 27 Dec 2017 09:36:58 +0000</created>
                <updated>Wed, 3 Jan 2018 08:57:44 +0000</updated>
                            <resolved>Wed, 3 Jan 2018 08:57:44 +0000</resolved>
                                    <version>2.15.2</version>
                                    <fixVersion>2.21.0</fixVersion>
                                    <component>camel-netty4</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16304399" author="yihtserns" created="Wed, 27 Dec 2017 09:47:34 +0000"  >&lt;p&gt;I just &lt;a href=&quot;http://camel.apache.org/support.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;read&lt;/a&gt; that I&apos;m not supposed to create a JIRA ticket directly.&lt;/p&gt;

&lt;p&gt;Sorry for the faux pas. :/&lt;/p&gt;
</comment>
                            <comment id="16309317" author="davsclaus" created="Wed, 3 Jan 2018 08:50:25 +0000"  >&lt;p&gt;Okay reproduced this with your sample code, thanks.&lt;/p&gt;

&lt;p&gt;And have a fix&lt;/p&gt;

&lt;p&gt;The client is sending:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
davsclaus:/Users/davsclaus/Downloads/$ groovy tcp-client.groovy
Sent 0
Sent 1
Sent 2
Sent 3
Sent 4
Sent 5
Caught: java.net.SocketException: Broken pipe (Write failed)
java.net.SocketException: Broken pipe (Write failed)
	at tcp-client$_run_closure1_closure2.doCall(tcp-client.groovy:6)
	at tcp-client$_run_closure1.doCall(tcp-client.groovy:2)
	at tcp-client.run(tcp-client.groovy:1)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And the server is being stopped:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
INFO  - Apache Camel 2.21.0-SNAPSHOT (CamelContext: camel-1) is starting
INFO  - JMX is enabled
INFO  - Type converters loaded (core: 193, classpath: 11)
INFO  - StreamCaching is not in use. If using streams then its recommended to enable stream caching. See more details at http:&lt;span class=&quot;code-comment&quot;&gt;//camel.apache.org/stream-caching.html
&lt;/span&gt;INFO  - ServerBootstrap binding to localhost:8888
INFO  - Netty consumer bound to: localhost:8888
INFO  - Route: route1 started and consuming from: tcp:&lt;span class=&quot;code-comment&quot;&gt;//localhost:8888
&lt;/span&gt;INFO  - Total 1 routes, of which 1 are started
INFO  - Apache Camel 2.21.0-SNAPSHOT (CamelContext: camel-1) started in 0.573 seconds
INFO  - Hey 0
INFO  - Hey 1
INFO  - Hey 2
^CINFO  - Apache Camel 2.21.0-SNAPSHOT (CamelContext: camel-1) is shutting down
INFO  - Starting to graceful shutdown 1 routes (timeout 300 seconds)
INFO  - ServerBootstrap unbinding from localhost:8888
INFO  - Netty consumer unbound from: localhost:8888
INFO  - Route: route1 shutdown complete, was consuming from: tcp:&lt;span class=&quot;code-comment&quot;&gt;//localhost:8888
&lt;/span&gt;INFO  - Waiting as there are still 1 inflight and pending exchanges to complete, timeout in 300 seconds. Inflights per route: [route1 = 1]
INFO  - There are 1 inflight exchanges:
	InflightExchange: [exchangeId=ID-davsclaus-pro-local-1514969347001-0-3, fromRouteId=route1, routeId=route1, nodeId=process1, elapsed=0, duration=345]
INFO  - Waiting as there are still 1 inflight and pending exchanges to complete, timeout in 299 seconds. Inflights per route: [route1 = 1]
INFO  - There are 1 inflight exchanges:
	InflightExchange: [exchangeId=ID-davsclaus-pro-local-1514969347001-0-3, fromRouteId=route1, routeId=route1, nodeId=process1, elapsed=0, duration=1351]
INFO  - Graceful shutdown of 1 routes completed in 2 seconds
INFO  - Apache Camel 2.21.0-SNAPSHOT (CamelContext: camel-1) uptime 11.935 seconds
INFO  - Apache Camel 2.21.0-SNAPSHOT (CamelContext: camel-1) is shutdown in 2.058 seconds
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12903780" name="tcp-client.groovy" size="321" author="yihtserns" created="Wed, 27 Dec 2017 09:32:52 +0000"/>
                            <attachment id="12903781" name="tcp-server.camel" size="274" author="yihtserns" created="Wed, 27 Dec 2017 09:32:52 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 46 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3obbr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>