<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:26:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-11628] MQTT Connection loop</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-11628</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;Hello everyone, i found an particular bug situation&lt;/p&gt;

&lt;p&gt;I have same mqtt producer with high volume traffic. When my application losts tcp connection to mqtt server i have follow connection loop error. This bug is sometime verified because it depend by multiple factors (load machine, load mqtt server, payload, etc)&lt;/p&gt;

&lt;p&gt;I am reading source code and i suppose that the bug is introduced by volatile variable connected (it isn&apos;t thread-safe)&lt;/p&gt;

&lt;p&gt;To resolve this bug you must refactoring all MQTTEndpoint connection code.&lt;/p&gt;


&lt;p&gt;[        hawtdispatch-DEFAULT-3] MQTTEndpoint                   INFO  MQTT Connection connected to tcp://mqtt:1883&lt;br/&gt;
[        hawtdispatch-DEFAULT-3] MQTTEndpoint                   INFO  MQTT Connection connected to tcp://mqtt:1883&lt;br/&gt;
[        hawtdispatch-DEFAULT-3] MQTTEndpoint                   INFO  MQTT Connection connected to tcp://mqtt:1883&lt;br/&gt;
[        hawtdispatch-DEFAULT-3] MQTTEndpoint                   INFO  MQTT Connection connected to tcp://mqtt:1883&lt;br/&gt;
[        hawtdispatch-DEFAULT-3] MQTTEndpoint                   INFO  MQTT Connection connected to tcp://mqtt:1883&lt;br/&gt;
[        hawtdispatch-DEFAULT-3] MQTTEndpoint                   INFO  MQTT Connection connected to tcp://mqtt:1883&lt;br/&gt;
[        hawtdispatch-DEFAULT-3] MQTTEndpoint                   INFO  MQTT Connection connected to tcp://mqtt:1883&lt;br/&gt;
[        hawtdispatch-DEFAULT-3] MQTTEndpoint                   INFO  MQTT Connection connected to tcp://mqtt:1883&lt;br/&gt;
[        hawtdispatch-DEFAULT-3] MQTTEndpoint                   INFO  MQTT Connection connected to tcp://mqtt:1883&lt;br/&gt;
[        hawtdispatch-DEFAULT-3] MQTTEndpoint                   INFO  MQTT Connection connected to tcp://mqtt:1883&lt;br/&gt;
[        hawtdispatch-DEFAULT-3] MQTTEndpoint                   INFO  MQTT Connection connected to tcp://mqtt:1883&lt;br/&gt;
[        hawtdispatch-DEFAULT-3] MQTTEndpoint                   INFO  MQTT Connection connected to tcp://mqtt:1883&lt;br/&gt;
[        hawtdispatch-DEFAULT-3] MQTTEndpoint                   INFO  MQTT Connection connected to tcp://mqtt:1883&lt;br/&gt;
[        hawtdispatch-DEFAULT-3] MQTTEndpoint                   INFO  MQTT Connection connected to tcp://mqtt:1883&lt;br/&gt;
[        hawtdispatch-DEFAULT-3] MQTTEndpoint                   INFO  MQTT Connection connected to tcp://mqtt:1883&lt;br/&gt;
[        hawtdispatch-DEFAULT-3] MQTTEndpoint                   INFO  MQTT Connection connected to tcp://mqtt:1883&lt;br/&gt;
[        hawtdispatch-DEFAULT-3] MQTTEndpoint                   INFO  MQTT Connection connected to tcp://mqtt:1883&lt;br/&gt;
[        hawtdispatch-DEFAULT-3] MQTTEndpoint                   INFO  MQTT Connection connected to tcp://mqtt:1883&lt;br/&gt;
[        hawtdispatch-DEFAULT-3] MQTTEndpoint                   INFO  MQTT Connection connected to tcp://mqtt:1883&lt;br/&gt;
[        hawtdispatch-DEFAULT-3] MQTTEndpoint                   INFO  MQTT Connection connected to tcp://mqtt:1883&lt;br/&gt;
[        hawtdispatch-DEFAULT-3] MQTTEndpoint                   INFO  MQTT Connection connected to tcp://mqtt:1883&lt;br/&gt;
[        hawtdispatch-DEFAULT-3] MQTTEndpoint                   INFO  MQTT Connection connected to tcp://mqtt:1883&lt;br/&gt;
[        hawtdispatch-DEFAULT-3] MQTTEndpoint                   INFO  MQTT Connection connected to tcp://mqtt:1883&lt;br/&gt;
[        hawtdispatch-DEFAULT-3] MQTTEndpoint                   INFO  MQTT Connection connected to tcp://mqtt:1883&lt;br/&gt;
[        hawtdispatch-DEFAULT-3] MQTTEndpoint                   INFO  MQTT Connection connected to tcp://mqtt:1883&lt;br/&gt;
[        hawtdispatch-DEFAULT-3] MQTTEndpoint                   INFO  MQTT Connection connected to tcp://mqtt:1883&lt;br/&gt;
[        hawtdispatch-DEFAULT-3] MQTTEndpoint                   INFO  MQTT Connection connected to tcp://mqtt:1883&lt;br/&gt;
[        hawtdispatch-DEFAULT-3] MQTTEndpoint                   INFO  MQTT Connection connected to tcp://mqtt:1883&lt;br/&gt;
[        hawtdispatch-DEFAULT-3] MQTTEndpoint                   INFO  MQTT Connection connected to tcp://mqtt:1883&lt;br/&gt;
[        hawtdispatch-DEFAULT-3] MQTTEndpoint                   INFO  MQTT Connection connected to tcp://mqtt:1883&lt;br/&gt;
[        hawtdispatch-DEFAULT-3] MQTTEndpoint                   INFO  MQTT Connection connected to tcp://mqtt:1883&lt;/p&gt;</description>
                <environment></environment>
        <key id="13092122">CAMEL-11628</key>
            <summary>MQTT Connection loop</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="fabryprog">Fabrizio Spataro</reporter>
                        <labels>
                    </labels>
                <created>Thu, 3 Aug 2017 08:34:19 +0000</created>
                <updated>Sat, 4 Nov 2017 13:20:22 +0000</updated>
                            <resolved>Sat, 4 Nov 2017 09:45:55 +0000</resolved>
                                    <version>2.17.0</version>
                                    <fixVersion>2.19.5</fixVersion>
                    <fixVersion>2.20.1</fixVersion>
                    <fixVersion>2.21.0</fixVersion>
                                    <component>camel-mqtt</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16122687" author="davsclaus" created="Fri, 11 Aug 2017 01:54:33 +0000"  >&lt;p&gt;Was there some code changes contributed as PR that fixes this?&lt;/p&gt;</comment>
                            <comment id="16123022" author="fabryprog" created="Fri, 11 Aug 2017 08:22:19 +0000"  >&lt;p&gt;No.&lt;/p&gt;

&lt;p&gt;I tried to fix it but the bug is on the fuse library!!!!&lt;/p&gt;</comment>
                            <comment id="16162886" author="davsclaus" created="Tue, 12 Sep 2017 12:54:29 +0000"  >&lt;p&gt;Have you been able to re-produce this? Also there is camel-paho as MQTT component which possible is a better library to use than camel-mqtt.&lt;/p&gt;</comment>
                            <comment id="16197563" author="bapowell" created="Mon, 9 Oct 2017 19:22:57 +0000"  >&lt;p&gt;I, too, could really use a fix for this bug.&lt;/p&gt;

&lt;p&gt;By the way, camel-paho isn&apos;t always an option, due to things like the lack of ability to dynamically specify the topic for a producer endpoint. With the mqtt component this is possible via the CamelMQTTPublishTopic header.&lt;/p&gt;

&lt;p&gt;As for reproducing this bug:&lt;/p&gt;

&lt;p&gt;1. Use the route listed below.&lt;br/&gt;
2. Start an MQTT broker.&lt;br/&gt;
    2.a. I&apos;ve tried Mosquitto 1.4.14 under RHEL 7.2 as well as Mosquitto 1.4.11 under Windows 7.&lt;br/&gt;
3. Start the route.&lt;br/&gt;
4. After a few seconds, kill the MQTT broker.&lt;br/&gt;
5. Wait roughly 30 seconds, at which point you&apos;ll start gettting &quot;Failed delivery...&quot; errors (and &quot;camel:route-list&quot; will start showing failed exchanges).&lt;br/&gt;
6. Start the MQTT broker back up.&lt;br/&gt;
7. Bug shows up:&lt;/p&gt;

&lt;p&gt;Camel log starts outputting tons of the following messages:&lt;br/&gt;
    INFO  | spatch-DEFAULT-1 | MQTTEndpoint                     | 153 - org.apache.camel.camel-mqtt - 2.17.0 | MQTT Connection connected to tcp://localhost:1883&lt;/p&gt;

&lt;p&gt;Mosquitto repeatedly outputs the following set of message:&lt;br/&gt;
    New client connected from 127.0.0.1 as tmr2mqttClient (c1, k30).&lt;br/&gt;
    Sending CONNACK to tmr2mqttClient (0, 0)&lt;br/&gt;
    New connection from 127.0.0.1 on port 1883.&lt;br/&gt;
    Client tmr2mqttClient already connected, closing old connection.&lt;br/&gt;
    Client tmr2mqttClient disconnected.&lt;/p&gt;

&lt;p&gt;Mosquitto&apos;s behavior is indicative of an MQTT client process (Camel in this case) using the same clientID to establish a new connection, when a connection using that same clientID already exists. Per MQTT spec, Mosquitto will disconnect the current connection with that clientID, and then accept the new connection.&lt;/p&gt;

&lt;p&gt;&lt;ins&gt;Route to use&lt;/ins&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-xml&quot;&gt;
  &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;camelContext id=&lt;span class=&quot;code-quote&quot;&gt;&quot;blueprint-ctx-for-mqtt&quot;&lt;/span&gt; xmlns=&lt;span class=&quot;code-quote&quot;&gt;&quot;http://camel.apache.org/schema/blueprint&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;route id=&lt;span class=&quot;code-quote&quot;&gt;&quot;timerToMqtt&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;from uri=&lt;span class=&quot;code-quote&quot;&gt;&quot;timer:toMqtt?period=1000&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;setHeader headerName=&lt;span class=&quot;code-quote&quot;&gt;&quot;CamelMQTTPublishTopic&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
          &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;simple&amp;gt;&lt;/span&gt;camelTopic-${date:now:ss}&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/simple&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/setHeader&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;setBody&amp;gt;&lt;/span&gt;
          &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;simple&amp;gt;&lt;/span&gt;${date:now:yyyyMMdd-HH:mm:ss.SSS}&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/simple&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/setBody&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;log message=&lt;span class=&quot;code-quote&quot;&gt;&quot;The message contains ${body}&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;to uri=&lt;span class=&quot;code-quote&quot;&gt;&quot;mqtt://tmr2mqttPublisher?host=tcp://localhost:1883&amp;amp;amp;clientId=tmr2mqttClient&amp;amp;amp;cleanSession=true&amp;amp;amp;qualityOfService=AtMostOnce&amp;amp;amp;connectWaitInSeconds=5&amp;amp;amp;reconnectAttemptsMax=5&amp;amp;amp;reconnectDelay=500&amp;amp;amp;reconnectDelayMax=5000&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/route&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/camelContext&amp;gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16237403" author="davsclaus" created="Fri, 3 Nov 2017 10:24:44 +0000"  >&lt;p&gt;In Camel 2.21 you can now use a header to override the topic in camel-paho&lt;/p&gt;</comment>
                            <comment id="16237782" author="bapowell" created="Fri, 3 Nov 2017 15:37:16 +0000"  >&lt;p&gt;That&apos;s good to know, Claus. Thanks for the inform.&lt;/p&gt;

&lt;p&gt;The Fusesource MQTT client still seems to be a bit more &quot;robust&quot; than paho, after rudimentary testing on my part, but I suspect the paho component is the one we should focus on using going forward, as it has the full Eclipse IoT effort behind it.&lt;/p&gt;</comment>
                            <comment id="16237789" author="bapowell" created="Fri, 3 Nov 2017 15:42:22 +0000"  >&lt;p&gt;I investigated this bug, found what I believe is the culprit, fixed it, and tested successfully.&lt;/p&gt;

&lt;p&gt;I&apos;ll submit a PR with the fix.&lt;/p&gt;

&lt;p&gt;But in a nutshell, the fix was to add this at the top of the MQTTEndpoint createConnection() method:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void createConnection() {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (connection != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            &lt;span class=&quot;code-comment&quot;&gt;// In connect(), in the connection.connect() callback, onFailure() doesn&apos;t seem to ever be called, so forcing the disconnect here.
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// Without &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;, the fusesource MQTT client seems to be holding the old connection object, and connection contention can ensue.
&lt;/span&gt;            connection.disconnect(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</comment>
                            <comment id="16237885" author="githubbot" created="Fri, 3 Nov 2017 16:42:51 +0000"  >&lt;p&gt;bapowell opened a new pull request #2077: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-11628&quot; title=&quot;MQTT Connection loop&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-11628&quot;&gt;&lt;del&gt;CAMEL-11628&lt;/del&gt;&lt;/a&gt;: camel-mqtt - Fix in MQTTEndpoint for connection loop bug.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2077&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2077&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-11628&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CAMEL-11628&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16237886" author="githubbot" created="Fri, 3 Nov 2017 16:42:52 +0000"  >&lt;p&gt;GitHub user bapowell opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/2077&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2077&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-11628&quot; title=&quot;MQTT Connection loop&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-11628&quot;&gt;&lt;del&gt;CAMEL-11628&lt;/del&gt;&lt;/a&gt;: camel-mqtt - Fix in MQTTEndpoint for connection loop bug.&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-11628&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CAMEL-11628&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/bapowell/camel&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/bapowell/camel&lt;/a&gt; camel-2.17.x-mqtt-fix-11628&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/2077.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2077.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #2077&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit f88506c28585ede9eec6ed5eccc82f1eb977597f&lt;br/&gt;
Author: Brad Powell &amp;lt;bapowell@sbcglobal.net&amp;gt;&lt;br/&gt;
Date:   2017-11-03T16:36:56Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-11628&quot; title=&quot;MQTT Connection loop&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-11628&quot;&gt;&lt;del&gt;CAMEL-11628&lt;/del&gt;&lt;/a&gt;: camel-mqtt - Fix in MQTTEndpoint for connection loop bug.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16238875" author="davsclaus" created="Sat, 4 Nov 2017 09:45:55 +0000"  >&lt;p&gt;Thanks for the PR&lt;/p&gt;</comment>
                            <comment id="16238876" author="githubbot" created="Sat, 4 Nov 2017 09:46:30 +0000"  >&lt;p&gt;davsclaus commented on issue #2077: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-11628&quot; title=&quot;MQTT Connection loop&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-11628&quot;&gt;&lt;del&gt;CAMEL-11628&lt;/del&gt;&lt;/a&gt;: camel-mqtt - Fix in MQTTEndpoint for connection loop bug.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2077#issuecomment-341884407&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2077#issuecomment-341884407&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Thanks for the PR it has been merged. Do you mind closing this?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16239002" author="githubbot" created="Sat, 4 Nov 2017 13:20:22 +0000"  >&lt;p&gt;bapowell closed pull request #2077: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-11628&quot; title=&quot;MQTT Connection loop&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-11628&quot;&gt;&lt;del&gt;CAMEL-11628&lt;/del&gt;&lt;/a&gt;: camel-mqtt - Fix in MQTTEndpoint for connection loop bug.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2077&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2077&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/components/camel-mqtt/src/main/java/org/apache/camel/component/mqtt/MQTTEndpoint.java b/components/camel-mqtt/src/main/java/org/apache/camel/component/mqtt/MQTTEndpoint.java&lt;br/&gt;
index d0797782997..c9b38701041 100644&lt;br/&gt;
&amp;#8212; a/components/camel-mqtt/src/main/java/org/apache/camel/component/mqtt/MQTTEndpoint.java&lt;br/&gt;
+++ b/components/camel-mqtt/src/main/java/org/apache/camel/component/mqtt/MQTTEndpoint.java&lt;br/&gt;
@@ -230,6 +230,12 @@ protected void doStart() throws Exception {&lt;br/&gt;
     }&lt;/p&gt;

&lt;p&gt;     protected void createConnection() {&lt;br/&gt;
+        if (connection != null) &lt;/p&gt;
{
+            // In connect(), in the connection.connect() callback, onFailure() doesn&apos;t seem to ever be called, so forcing the disconnect here.
+            // Without this, the fusesource MQTT client seems to be holding the old connection object, and connection contention can ensue.
+            connection.disconnect(null);
+        }
&lt;p&gt;+    	&lt;br/&gt;
         connection = configuration.callbackConnection();&lt;/p&gt;

&lt;p&gt;         connection.listener(new Listener() {&lt;br/&gt;
@@ -328,7 +334,7 @@ public void onFailure(Throwable value) {&lt;/p&gt;

&lt;p&gt;             }&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void onFailure(Throwable value) {&lt;br/&gt;
+            public void onFailure(Throwable value) {  // this doesn&apos;t appear to ever be called&lt;br/&gt;
                 LOG.warn(&quot;Failed to connect to &quot; + configuration.getHost() + &quot; due &quot; + value.getMessage());&lt;br/&gt;
                 promise.onFailure(value);&lt;br/&gt;
                 connection.disconnect(null);&lt;/li&gt;
&lt;/ul&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16239003" author="githubbot" created="Sat, 4 Nov 2017 13:20:22 +0000"  >&lt;p&gt;Github user bapowell closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/2077&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2077&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13115875">CAMEL-11989</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 2 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3id3j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>