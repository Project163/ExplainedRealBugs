<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:21:21 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-10542] DataFormat from registry is used for every dataformat operation (marshal/unmarshal)</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-10542</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;While working on an issue related to spring-boot I found out that if a data format is registered in camel registry with the same name as the one camel looks-up with the help of DefaultDataFormatResolver, this object is then re-configured for each data format definition so one definition may override previous configuration with an undefined behavior.&lt;/p&gt;

&lt;p&gt;So assume you have an xml route definitions as:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-xml&quot;&gt;&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;routes xmlns=&lt;span class=&quot;code-quote&quot;&gt;&quot;http://camel.apache.org/schema/spring&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;route&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;from uri=&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:unmarshal&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;unmarshal&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;csv delimiter=&lt;span class=&quot;code-quote&quot;&gt;&quot;;&quot;&lt;/span&gt; headerDisabled=&lt;span class=&quot;code-quote&quot;&gt;&quot;true&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/unmarshal&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/route&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;route&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;from uri=&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:marshal&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;marshal&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;csv headerDisabled=&lt;span class=&quot;code-quote&quot;&gt;&quot;true&quot;&lt;/span&gt; quoteDisabled=&lt;span class=&quot;code-quote&quot;&gt;&quot;true&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/marshal&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/route&amp;gt;&lt;/span&gt;
&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/routes&amp;gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And some code like:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;InputStream is = getClass().getResourceAsStream(&lt;span class=&quot;code-quote&quot;&gt;&quot;...&quot;&lt;/span&gt;);

SimpleRegistry reg = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SimpleRegistry();
reg.put(&lt;span class=&quot;code-quote&quot;&gt;&quot;csv-dataformat&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CsvDataFormat());

DefaultCamelContext ctx = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DefaultCamelContext(reg);
ctx.addRouteDefinitions(ctx.loadRoutesDefinition(is).getRoutes());
ctx.start();

ProducerTemplate template = ctx.createProducerTemplate();
&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; result = template.requestBody(
    &lt;span class=&quot;code-quote&quot;&gt;&quot;direct:marshal&quot;&lt;/span&gt;,
    Arrays.asList(Arrays.asList( &lt;span class=&quot;code-quote&quot;&gt;&quot;A1&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;B1&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;C1&quot;&lt;/span&gt; )),
    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.class);

assertEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;A1,B1,C1&quot;&lt;/span&gt;, result);

ctx.stop
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then this test fails with:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Expected :A1,B1,C1
Actual   :A1;B1;C1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It fails because the object added to the SimpleRegistry is shared among the two csv dataformats  so it is configured to have delimiter = &apos;;&apos; &lt;/p&gt;

&lt;p&gt;For spring-boot this causes some issues as it registers data formats beans as part of its auto-configuration magic thus if you do not set your own instance of data format, any data format operation like marshal/unmarshal may not work as expected. &lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;for spring-boot a solution would be to annotate auto configured data format beans with prototype scope.&lt;/li&gt;
	&lt;li&gt;a more generic solution would be to make DataFormat Cloneable and clone the bean found in the registry&lt;/li&gt;
&lt;/ul&gt;

</description>
                <environment></environment>
        <key id="13023792">CAMEL-10542</key>
            <summary>DataFormat from registry is used for every dataformat operation (marshal/unmarshal)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="lb">Luca Burgazzoli</assignee>
                                    <reporter username="lb">Luca Burgazzoli</reporter>
                        <labels>
                    </labels>
                <created>Mon, 28 Nov 2016 17:08:49 +0000</created>
                <updated>Wed, 1 Feb 2017 10:50:17 +0000</updated>
                            <resolved>Wed, 1 Feb 2017 10:50:17 +0000</resolved>
                                                    <fixVersion>2.19.0</fixVersion>
                                    <component>camel-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15707944" author="davsclaus" created="Wed, 30 Nov 2016 08:29:22 +0000"  >&lt;p&gt;So if you change the name from &quot;csv-dataformat&quot; to &quot;foo&quot; then you dont have this problem?&lt;/p&gt;</comment>
                            <comment id="15707999" author="lb" created="Wed, 30 Nov 2016 09:02:04 +0000"  >&lt;p&gt;Yes you don&apos;t as in such case the dataformat instance is created using &quot;service-loader&quot; style thus a new instance is created each time DefaultDataFormatResolver::resolveDataFormat is invoked. I have experimentedd with @Scope(&quot;prototype&quot;) and it solves the issue for Spring Boot, but I do not know what could be optimal solution that would cover all the cases and containers.&lt;/p&gt;</comment>
                            <comment id="15711779" author="davsclaus" created="Thu, 1 Dec 2016 11:54:03 +0000"  >&lt;p&gt;You could argue that &amp;lt;marshal&amp;gt;&amp;lt;csv&amp;gt; ... should use its own instance as there is no reference to a named data format, where as using &amp;lt;marshal ref=&quot;csv-dataformat&quot;&amp;gt; then you are using that shared your add to the registry.&lt;/p&gt;

&lt;p&gt;So its maybe more in how &amp;lt;marshal&amp;gt;&amp;lt;csv&amp;gt; creates the dataformat that needs to be looked at / fixed.&lt;/p&gt;</comment>
                            <comment id="15711833" author="lb" created="Thu, 1 Dec 2016 12:22:56 +0000"  >&lt;p&gt;Going to have a look, thx &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15712219" author="lb" created="Thu, 1 Dec 2016 15:14:55 +0000"  >&lt;p&gt;Thinking a little bit more if we do so we may have other issues in spring-boot as I may want to do:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;from(...)
  .marshal()
    .csv()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And have the csv marshal leveraging spring-boot auto configuration but if we require to use a reference, the spring-configuration magic won&apos;t happen any more, am I missing something ?&lt;/p&gt;</comment>
                            <comment id="15712504" author="lb" created="Thu, 1 Dec 2016 17:13:02 +0000"  >&lt;p&gt;Maybe a better way would be:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if a ref is set, look it up and use it as it is&lt;/li&gt;
	&lt;li&gt;if ref is not set, search for a DataFormatFactory instead of DataFormat&lt;/li&gt;
	&lt;li&gt;if factory is not found go ahead with standard resolution&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;So that spring-boot or any other container can safely register its factory as i.e. csv-factory or csv-dataformat-factory&lt;/p&gt;</comment>
                            <comment id="15712923" author="davsclaus" created="Thu, 1 Dec 2016 20:01:13 +0000"  >&lt;p&gt;By DataFormatFactory do you mean DataFormatResolver?&lt;/p&gt;</comment>
                            <comment id="15713012" author="lb" created="Thu, 1 Dec 2016 20:37:34 +0000"  >&lt;p&gt;I was thinking about a real factory that can create an instance of a dataformat, like what you can achieve by annotate a method with prototype scope in spring and similar to what happen when we create an instance from a resource file except you can provide a data format with your own defaults.&lt;/p&gt;</comment>
                            <comment id="15714387" author="davsclaus" created="Fri, 2 Dec 2016 08:01:01 +0000"  >&lt;p&gt;Ah okay, yeah give that a try and see how that goes.&lt;/p&gt;</comment>
                            <comment id="15800736" author="davsclaus" created="Thu, 5 Jan 2017 08:27:32 +0000"  >&lt;p&gt;Luca, did you implement this or is there more work to do here?&lt;/p&gt;</comment>
                            <comment id="15800781" author="lb" created="Thu, 5 Jan 2017 08:45:50 +0000"  >&lt;p&gt;There is more work to do, I&apos;m doing some experiment at the moment&lt;/p&gt;</comment>
                            <comment id="15847140" author="githubbot" created="Tue, 31 Jan 2017 17:09:23 +0000"  >&lt;p&gt;GitHub user lburgazzoli opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/1436&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/1436&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-10542&quot; title=&quot;DataFormat from registry is used for every dataformat operation (marshal/unmarshal)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-10542&quot;&gt;&lt;del&gt;CAMEL-10542&lt;/del&gt;&lt;/a&gt;: DataFormat from registry is used for every dataformat operation (marshal/unmarshal)&lt;/p&gt;

&lt;p&gt;    I&apos;m opening this PR for review as there are some changes on CamelContext level so I&apos;d like to gather some feedback.&lt;/p&gt;

&lt;p&gt;    As today the DataFormat resolution works as follow:&lt;br/&gt;
    1. search int the registry if a DataFormat instance exists for a given name&lt;br/&gt;
    2. if not found in registry create a new one from the resources (META-INF/services/...)&lt;/p&gt;

&lt;p&gt;    This my cause issues as per &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-10542&quot; title=&quot;DataFormat from registry is used for every dataformat operation (marshal/unmarshal)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-10542&quot;&gt;&lt;del&gt;CAMEL-10542&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    The proposed solution introduces a new DataFormatFactory and a new method to DataFormatResolver to have a way to explicit request for a new instance so it looks like:&lt;/p&gt;

&lt;p&gt;    ```java&lt;br/&gt;
    public interface DataFormatResolver &lt;/p&gt;
{
        // Resolve using registry then fallback to createDataFormat
        DataFormat resolveDataFormat(String name, CamelContext context);
    
        // Resolve factory using registry or fallback to resources
        DataFormat createDataFormat(String name, CamelContext context);
    }
&lt;p&gt; &lt;br/&gt;
    ```&lt;/p&gt;

&lt;p&gt;    Model&apos;s DataFormatDefinition is now using createDataFormat except for CustomDataFormat which indeed is supposed to eventually share the same data format. &lt;/p&gt;

&lt;p&gt;    I still need to implement some stuffs but the basic concept is here.&lt;br/&gt;
    Any feedback would be really appreciated.&lt;/p&gt;


&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/lburgazzoli/apache-camel&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/lburgazzoli/apache-camel&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-10542&quot; title=&quot;DataFormat from registry is used for every dataformat operation (marshal/unmarshal)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-10542&quot;&gt;&lt;del&gt;CAMEL-10542&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/1436.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/1436.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1436&lt;/p&gt;

&lt;hr /&gt;

&lt;hr /&gt;</comment>
                            <comment id="15848214" author="githubbot" created="Wed, 1 Feb 2017 10:40:59 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/1436&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/1436&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13023791">CAMEL-10541</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 41 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i36urj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>