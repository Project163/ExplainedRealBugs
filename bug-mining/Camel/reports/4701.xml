<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:32:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-12973] AbstractCamelWorkItemHandler init fails when WIH is loaded before CamelContext is created.</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-12973</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;When the AbstractCamelWorkItemHandler is created before the referenced CamelContext is created and registered, deployment of a KJAR fails with an IllegalArgumentException.&lt;/p&gt;

&lt;p&gt;This can happen when the deployment uses a combination of a Singleton RuntimeStrategy and a Deployment-scoped CamelContext. This is due to the fact that the jBPM KIE-Server extension runs after the jBPM extension.&lt;/p&gt;

&lt;p&gt;In such a situation we need to defer the creation of the ProducerTemplate until the first call to WIH.execute.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13201953">CAMEL-12973</key>
            <summary>AbstractCamelWorkItemHandler init fails when WIH is loaded before CamelContext is created.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="swiderski.maciej">Maciej Swiderski</assignee>
                                    <reporter username="ddoyle">Duncan Doyle</reporter>
                        <labels>
                    </labels>
                <created>Mon, 3 Dec 2018 10:37:50 +0000</created>
                <updated>Tue, 4 Dec 2018 13:09:10 +0000</updated>
                            <resolved>Tue, 4 Dec 2018 13:07:34 +0000</resolved>
                                    <version>2.23.0</version>
                                    <fixVersion>2.23.1</fixVersion>
                    <fixVersion>2.24.0</fixVersion>
                                    <component>camel-jbpm</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16706991" author="githubbot" created="Mon, 3 Dec 2018 10:58:06 +0000"  >&lt;p&gt;DuncanDoyle opened a new pull request #2649: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12973&quot; title=&quot;AbstractCamelWorkItemHandler init fails when WIH is loaded before CamelContext is created.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12973&quot;&gt;&lt;del&gt;CAMEL-12973&lt;/del&gt;&lt;/a&gt;: Init deferred to first call when WIH uses Deployment-sco&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2649&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2649&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   &#8230;ped context in combination with Singleton RuntimeStrategy. Removed redundant double slash from &apos;direct&apos; URL.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16708672" author="githubbot" created="Tue, 4 Dec 2018 13:07:54 +0000"  >&lt;p&gt;oscerd commented on issue #2649: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12973&quot; title=&quot;AbstractCamelWorkItemHandler init fails when WIH is loaded before CamelContext is created.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12973&quot;&gt;&lt;del&gt;CAMEL-12973&lt;/del&gt;&lt;/a&gt;: Init deferred to first call when WIH uses Deployment-sco&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2649#issuecomment-444093483&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2649#issuecomment-444093483&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Thanks, I fixed the CS a bit. Merged on master and 2.23.x&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16708673" author="githubbot" created="Tue, 4 Dec 2018 13:08:53 +0000"  >&lt;p&gt;mswiderski commented on issue #2649: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12973&quot; title=&quot;AbstractCamelWorkItemHandler init fails when WIH is loaded before CamelContext is created.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12973&quot;&gt;&lt;del&gt;CAMEL-12973&lt;/del&gt;&lt;/a&gt;: Init deferred to first call when WIH uses Deployment-sco&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2649#issuecomment-444093777&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2649#issuecomment-444093777&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   excellent, thanks a lot @oscerd and @DuncanDoyle &lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16708674" author="githubbot" created="Tue, 4 Dec 2018 13:09:10 +0000"  >&lt;p&gt;oscerd closed pull request #2649: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12973&quot; title=&quot;AbstractCamelWorkItemHandler init fails when WIH is loaded before CamelContext is created.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12973&quot;&gt;&lt;del&gt;CAMEL-12973&lt;/del&gt;&lt;/a&gt;: Init deferred to first call when WIH uses Deployment-sco&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2649&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2649&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/components/camel-jbpm/src/main/java/org/apache/camel/component/jbpm/workitem/AbstractCamelCommand.java b/components/camel-jbpm/src/main/java/org/apache/camel/component/jbpm/workitem/AbstractCamelCommand.java&lt;br/&gt;
index 1900960ed2b..212dd7156e2 100644&lt;br/&gt;
&amp;#8212; a/components/camel-jbpm/src/main/java/org/apache/camel/component/jbpm/workitem/AbstractCamelCommand.java&lt;br/&gt;
+++ b/components/camel-jbpm/src/main/java/org/apache/camel/component/jbpm/workitem/AbstractCamelCommand.java&lt;br/&gt;
@@ -35,7 +35,7 @@&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;The command passes the 
{@WorkItem} retrieved from the {@link CommandContext} to the route that has a consumer on the endpoint-id &lt;br/&gt;
  * that can be passed with the &amp;lt;code&amp;gt;camel-endpoint-id&amp;lt;/code&amp;gt; {@link WorkItem} parameter. E.g. when a the value &quot;myCamelEndpoint&quot; is passed to the &lt;br/&gt;
  * {link WorkItem} via the &amp;lt;code&amp;gt;camel-endpoint-id&amp;lt;/code&amp;gt; parameter, this {@link Command} will send the {@link WorkItem} to &lt;br/&gt;
- * the Camel URI &amp;lt;code&amp;gt;direct://myCamelEndpoint&amp;lt;/code&amp;gt;.  &lt;br/&gt;
+ * the Camel URI &amp;lt;code&amp;gt;direct:myCamelEndpoint&amp;lt;/code&amp;gt;.  &lt;br/&gt;
  * &amp;lt;p/&amp;gt;&lt;br/&gt;
  * The body of the result {@link Message} of the invocation is returned via the &amp;lt;code&amp;gt;Response&amp;lt;/code&amp;gt; parameter. Access to the raw response &lt;br/&gt;
  * {@link Message} is provided via the &amp;lt;code&amp;gt;Message&amp;lt;/code&amp;gt; parameter. This gives the user access to more advanced fields like message headers &lt;br/&gt;
@@ -55,7 +55,7 @@ public ExecutionResults execute(CommandContext ctx) throws Exception {&lt;br/&gt;
         String camelEndpointId = (String) workItem.getParameter(JBPMConstants.CAMEL_ENDPOINT_ID_WI_PARAM);&lt;br/&gt;
 &lt;br/&gt;
         // We only support direct. We don&apos;t need to support more, as direct simply gives us the entrypoint into the actual Camel Routes.&lt;br/&gt;
-        String camelUri = &quot;direct://&quot; + camelEndpointId;&lt;br/&gt;
+        String camelUri = &quot;direct:&quot; + camelEndpointId;&lt;br/&gt;
         &lt;br/&gt;
         ProducerTemplate producerTemplate = getProducerTemplate(ctx);&lt;br/&gt;
         Exchange inExchange = ExchangeBuilder.anExchange(producerTemplate.getCamelContext()).withBody(workItem).build();&lt;br/&gt;
diff --git a/components/camel-jbpm/src/main/java/org/apache/camel/component/jbpm/workitem/AbstractCamelWorkItemHandler.java b/components/camel-jbpm/src/main/java/org/apache/camel/component/jbpm/workitem/AbstractCamelWorkItemHandler.java&lt;br/&gt;
index d5ea7df9092..1361889f26c 100644&lt;br/&gt;
&amp;#8212; a/components/camel-jbpm/src/main/java/org/apache/camel/component/jbpm/workitem/AbstractCamelWorkItemHandler.java&lt;br/&gt;
+++ b/components/camel-jbpm/src/main/java/org/apache/camel/component/jbpm/workitem/AbstractCamelWorkItemHandler.java&lt;br/&gt;
@@ -35,9 +35,9 @@&lt;br/&gt;
  * Camel jBPM {@link WorkItemHandler} which allows to call Camel routes with a &amp;lt;code&amp;gt;direct&amp;lt;/code&amp;gt; endpoint.&lt;br/&gt;
  * &amp;lt;p/&amp;gt;&lt;br/&gt;
  * The handler passes the {@WorkItem}
&lt;p&gt; to the route that has a consumer on the endpoint-id that can be passed with the&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* &amp;lt;code&amp;gt;CamelEndpointId&amp;lt;/code&amp;gt;
{@link WorkItem} parameter. E.g. when a the value &quot;myCamelEndpoint&quot; is passed to the {link WorkItem} via&lt;br/&gt;
- * the &amp;lt;code&amp;gt;CamelEndpointId&amp;lt;/code&amp;gt; parameter, this command will send the {@link WorkItem}
&lt;p&gt; to the Camel URI&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;* &amp;lt;code&amp;gt;direct://myCamelEndpoint&amp;lt;/code&amp;gt;.&lt;br/&gt;
+ * &amp;lt;code&amp;gt;CamelEndpointId&amp;lt;/code&amp;gt;
{@link WorkItem} parameter. E.g. when a the value &quot;myCamelEndpoint&quot; is passed to the {link WorkItem} via the&lt;br/&gt;
+ * &amp;lt;code&amp;gt;CamelEndpointId&amp;lt;/code&amp;gt; parameter, this command will send the {@link WorkItem}
&lt;p&gt; to the Camel URI&lt;br/&gt;
+ * &amp;lt;code&amp;gt;direct:myCamelEndpoint&amp;lt;/code&amp;gt;.&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;ul&gt;
	&lt;li&gt;&amp;lt;p/&amp;gt;&lt;/li&gt;
	&lt;li&gt;The body of the result 
{@link Message} of the invocation is returned via the &amp;lt;code&amp;gt;Response&amp;lt;/code&amp;gt; parameter. Access to the raw response&lt;br/&gt;
  * {@link Message}
&lt;p&gt; is provided via the &amp;lt;code&amp;gt;Message&amp;lt;/code&amp;gt; parameter. This gives the user access to more advanced fields like message&lt;br/&gt;
@@ -47,18 +47,22 @@&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;to find the global KIE 
{@link CamelContext} from the &amp;lt;code&amp;gt;jBPM&amp;lt;/code&amp;gt; {@link ServiceRegistry}. When the {@link RuntimeManager} is passed&lt;br/&gt;
  * to the constructor, the handler will retrieve and use the {@link CamelContext}
&lt;p&gt; bound to the &lt;/p&gt;
{@link RuntimeManage}
&lt;p&gt; from the&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;{@link ServiceRegistry}
&lt;p&gt;. When a &amp;lt;code&amp;gt;CamelEndpointId&amp;lt;/code&amp;gt; is passed to the constructor, the handler will send all requests to the&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* Camel route that is consuming from that endpoint, unless the endpoint is overridden by passing a the &amp;lt;code&amp;gt;CamelEndpointId&amp;lt;/code&amp;gt; in&lt;/li&gt;
	&lt;li&gt;* the 
{@link WorkItem} parameters.&lt;br/&gt;
+ * Camel route that is consuming from that endpoint, unless the endpoint is overridden by passing a the &amp;lt;code&amp;gt;CamelEndpointId&amp;lt;/code&amp;gt; in the&lt;br/&gt;
+ * {@link WorkItem}
&lt;p&gt; parameters.&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;p&gt;  */&lt;br/&gt;
 public abstract class AbstractCamelWorkItemHandler extends AbstractLogOrThrowWorkItemHandler implements Cacheable {&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     private static Logger logger = LoggerFactory.getLogger(AbstractCamelWorkItemHandler.class);&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private final ProducerTemplate producerTemplate;&lt;br/&gt;
+    private ProducerTemplate producerTemplate;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     private final String camelEndpointId;&lt;br/&gt;
-&lt;br/&gt;
+    &lt;br/&gt;
+    private final String camelContextKey;&lt;br/&gt;
+    &lt;br/&gt;
+    private boolean initialized = false;&lt;br/&gt;
+    &lt;br/&gt;
     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Default Constructor. This creates a 
{@link ProducerTemplate}
&lt;p&gt; for the global &lt;/p&gt;
{@link CamelContext}
&lt;p&gt;.&lt;br/&gt;
      */&lt;br/&gt;
@@ -67,9 +71,10 @@ public AbstractCamelWorkItemHandler() {&lt;br/&gt;
     }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     public AbstractCamelWorkItemHandler(String camelEndointId) &lt;/p&gt;
{
-        CamelContext globalCamelContext = (CamelContext) ServiceRegistry.get().service(JBPMConstants.GLOBAL_CAMEL_CONTEXT_SERVICE_KEY);
-        this.producerTemplate = globalCamelContext.createProducerTemplate();
         this.camelEndpointId = camelEndointId;
+        this.camelContextKey = JBPMConstants.GLOBAL_CAMEL_CONTEXT_SERVICE_KEY;
+        this.producerTemplate = buildProducerTemplate(camelContextKey);
+        this.initialized = true;
     }

&lt;p&gt;     /**&lt;br/&gt;
@@ -81,18 +86,38 @@ public AbstractCamelWorkItemHandler(RuntimeManager runtimeManager) {&lt;br/&gt;
     }&lt;/p&gt;

&lt;p&gt;     public AbstractCamelWorkItemHandler(RuntimeManager runtimeManager, String camelEndpointId) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;String runtimeCamelContextKey = runtimeManager.getIdentifier() + JBPMConstants.DEPLOYMENT_CAMEL_CONTEXT_SERVICE_KEY_POSTFIX;&lt;/li&gt;
	&lt;li&gt;CamelContext runtimeCamelContext = (CamelContext) ServiceRegistry.get().service(runtimeCamelContextKey);&lt;/li&gt;
	&lt;li&gt;this.producerTemplate = runtimeCamelContext.createProducerTemplate();&lt;br/&gt;
         this.camelEndpointId = camelEndpointId;&lt;br/&gt;
+        this.camelContextKey = runtimeManager.getIdentifier() + JBPMConstants.DEPLOYMENT_CAMEL_CONTEXT_SERVICE_KEY_POSTFIX;&lt;br/&gt;
+        /*&lt;br/&gt;
+         * Depending on the order of session creation and CamelContext creation and registration, the CamelContext might not yet be&lt;br/&gt;
+         * available. Hence, when we deal with a Deployment scoped CamelContext, we can lazy-init when the context is not yet available.&lt;br/&gt;
+         */&lt;br/&gt;
+        try 
{
+            this.producerTemplate = buildProducerTemplate(camelContextKey);
+            this.initialized = true;
+        }
&lt;p&gt; catch (IllegalArgumentException iae) &lt;/p&gt;
{
+            String message = &quot;CamelContext with identifier &apos;&quot; + camelContextKey
+                    + &quot;&apos; not found in ServiceRegistry. This can be caused by the order in which the platform extensions are initialized. Deferring Camel ProducerTemplate creation until the first WorkItemHandler call.&quot;;
+            logger.info(message, iae);
+        }
&lt;p&gt;     }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+    private ProducerTemplate buildProducerTemplate(String key) &lt;/p&gt;
{
+        CamelContext camelContext = (CamelContext) ServiceRegistry.get().service(key);
+        return this.producerTemplate = camelContext.createProducerTemplate();
+    }
&lt;p&gt;+    &lt;br/&gt;
+    &lt;br/&gt;
     public void executeWorkItem(WorkItem workItem, final WorkItemManager manager) {&lt;br/&gt;
+        if (!initialized) &lt;/p&gt;
{
+            this.producerTemplate = buildProducerTemplate(camelContextKey);
+            initialized = true;
+        }

&lt;p&gt;         String workItemCamelEndpointId = getCamelEndpointId(workItem);&lt;/p&gt;

&lt;p&gt;         // We only support direct. We don&apos;t need to support more, as direct simply gives us the entrypoint into the actual Camel Routes.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;String camelUri = &quot;direct://&quot; + workItemCamelEndpointId;&lt;br/&gt;
+        String camelUri = &quot;direct:&quot; + workItemCamelEndpointId;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         try {&lt;br/&gt;
             Exchange requestExchange = buildExchange(producerTemplate, workItem);&lt;br/&gt;
diff --git a/components/camel-jbpm/src/test/java/org/apache/camel/component/jbpm/workitem/CamelWorkItemHandlerIntegrationTests.java b/components/camel-jbpm/src/test/java/org/apache/camel/component/jbpm/workitem/CamelWorkItemHandlerIntegrationTests.java&lt;br/&gt;
index 67d54fb69bb..a0fcee5de56 100644&lt;br/&gt;
&amp;#8212; a/components/camel-jbpm/src/test/java/org/apache/camel/component/jbpm/workitem/CamelWorkItemHandlerIntegrationTests.java&lt;br/&gt;
+++ b/components/camel-jbpm/src/test/java/org/apache/camel/component/jbpm/workitem/CamelWorkItemHandlerIntegrationTests.java&lt;br/&gt;
@@ -79,6 +79,7 @@ public void configure() throws Exception {&lt;br/&gt;
         } finally &lt;/p&gt;
{
             // Cleanup
             context.removeRoute(routeId);
+            ServiceRegistry.get().remove(JBPMConstants.GLOBAL_CAMEL_CONTEXT_SERVICE_KEY);
         }&lt;br/&gt;
     }&lt;br/&gt;
 &lt;br/&gt;
@@ -120,6 +121,7 @@ public void configure() throws Exception {&lt;br/&gt;
         } finally {             // Cleanup             context.removeRoute(routeId);+            ServiceRegistry.get().remove(JBPMConstants.GLOBAL_CAMEL_CONTEXT_SERVICE_KEY);         }
&lt;p&gt;     }&lt;/p&gt;

&lt;p&gt;@@ -160,6 +162,7 @@ public void configure() throws Exception {&lt;br/&gt;
         } finally &lt;/p&gt;
{
             // Cleanup
             context.removeRoute(routeId);
+            ServiceRegistry.get().remove(JBPMConstants.GLOBAL_CAMEL_CONTEXT_SERVICE_KEY);
         }&lt;br/&gt;
 &lt;br/&gt;
     }&lt;br/&gt;
@@ -198,6 +201,7 @@ public void configure() throws Exception {&lt;br/&gt;
         } finally {             // Cleanup             context.removeRoute(routeId);+            ServiceRegistry.get().remove(JBPMConstants.GLOBAL_CAMEL_CONTEXT_SERVICE_KEY);         }
&lt;p&gt;     }&lt;/p&gt;

&lt;p&gt;diff --git a/components/camel-jbpm/src/test/java/org/apache/camel/component/jbpm/workitem/DeploymentContextCamelCommandTest.java b/components/camel-jbpm/src/test/java/org/apache/camel/component/jbpm/workitem/DeploymentContextCamelCommandTest.java&lt;br/&gt;
index b0086b9f602..d2d3d94ce36 100644&lt;br/&gt;
&amp;#8212; a/components/camel-jbpm/src/test/java/org/apache/camel/component/jbpm/workitem/DeploymentContextCamelCommandTest.java&lt;br/&gt;
+++ b/components/camel-jbpm/src/test/java/org/apache/camel/component/jbpm/workitem/DeploymentContextCamelCommandTest.java&lt;br/&gt;
@@ -38,58 +38,62 @@&lt;/p&gt;

&lt;p&gt; @RunWith(MockitoJUnitRunner.class)&lt;br/&gt;
 public class DeploymentContextCamelCommandTest {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;p&gt;+&lt;br/&gt;
     @Mock&lt;br/&gt;
     ProducerTemplate producerTemplate;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     @Mock&lt;br/&gt;
     Exchange outExchange;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;p&gt;+&lt;br/&gt;
     @Mock&lt;br/&gt;
     Message outMessage;&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;&lt;p&gt;+&lt;br/&gt;
     @Mock&lt;br/&gt;
     CamelContext camelContext;&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;&lt;p&gt;+&lt;br/&gt;
     @Mock&lt;br/&gt;
     RuntimeManager runtimeManager;&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;&lt;p&gt;+&lt;br/&gt;
     @Mock&lt;br/&gt;
     CommandContext commandContext;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     @Test&lt;br/&gt;
     public void testExecuteCommandDeploymentCamelContext() throws Exception {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;p&gt;+&lt;br/&gt;
         String camelEndpointId = &quot;testCamelRoute&quot;;&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;String camelRouteUri = &quot;direct://&quot; + camelEndpointId;&lt;/li&gt;
	&lt;li&gt;&lt;p&gt;+        String camelRouteUri = &quot;direct:&quot; + camelEndpointId;&lt;br/&gt;
+&lt;br/&gt;
         String testReponse = &quot;testResponse&quot;;&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;&lt;p&gt;+&lt;br/&gt;
         String deploymentId = &quot;testDeployment&quot;;&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;&lt;p&gt;+&lt;br/&gt;
         when(producerTemplate.send(eq(camelRouteUri), any(Exchange.class))).thenReturn(outExchange);&lt;br/&gt;
         when(producerTemplate.getCamelContext()).thenReturn(camelContext);&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;&lt;p&gt;+&lt;br/&gt;
         when(camelContext.createProducerTemplate()).thenReturn(producerTemplate);&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;&lt;p&gt;+&lt;br/&gt;
         when(outExchange.getOut()).thenReturn(outMessage);&lt;br/&gt;
         when(outMessage.getBody()).thenReturn(testReponse);&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;&lt;/li&gt;
	&lt;li&gt;//Register the RuntimeManager bound camelcontext.&lt;/li&gt;
	&lt;li&gt;ServiceRegistry.get().register(deploymentId + JBPMConstants.DEPLOYMENT_CAMEL_CONTEXT_SERVICE_KEY_POSTFIX, camelContext);&lt;/li&gt;
	&lt;li&gt;&lt;/li&gt;
	&lt;li&gt;WorkItemImpl workItem = new WorkItemImpl();&lt;/li&gt;
	&lt;li&gt;workItem.setParameter(JBPMConstants.CAMEL_ENDPOINT_ID_WI_PARAM, camelEndpointId);&lt;/li&gt;
	&lt;li&gt;workItem.setParameter(&quot;Request&quot;, &quot;someRequest&quot;);&lt;/li&gt;
	&lt;li&gt;&lt;/li&gt;
	&lt;li&gt;when(commandContext.getData(&quot;workItem&quot;)).thenReturn(workItem);&lt;/li&gt;
	&lt;li&gt;when(commandContext.getData(&quot;deploymentId&quot;)).thenReturn(deploymentId);&lt;/li&gt;
	&lt;li&gt;&lt;/li&gt;
	&lt;li&gt;Command command = new DeploymentContextCamelCommand();&lt;/li&gt;
	&lt;li&gt;ExecutionResults results = command.execute(commandContext);&lt;/li&gt;
	&lt;li&gt;&lt;/li&gt;
	&lt;li&gt;assertNotNull(results);&lt;/li&gt;
	&lt;li&gt;assertEquals(2, results.getData().size());&lt;/li&gt;
	&lt;li&gt;assertEquals(testReponse, results.getData().get(JBPMConstants.RESPONSE_WI_PARAM));&lt;br/&gt;
+&lt;br/&gt;
+        // Register the RuntimeManager bound camelcontext.&lt;br/&gt;
+        try 
{
+            ServiceRegistry.get().register(deploymentId + JBPMConstants.DEPLOYMENT_CAMEL_CONTEXT_SERVICE_KEY_POSTFIX, camelContext);
+
+            WorkItemImpl workItem = new WorkItemImpl();
+            workItem.setParameter(JBPMConstants.CAMEL_ENDPOINT_ID_WI_PARAM, camelEndpointId);
+            workItem.setParameter(&quot;Request&quot;, &quot;someRequest&quot;);
+
+            when(commandContext.getData(&quot;workItem&quot;)).thenReturn(workItem);
+            when(commandContext.getData(&quot;deploymentId&quot;)).thenReturn(deploymentId);
+
+            Command command = new DeploymentContextCamelCommand();
+            ExecutionResults results = command.execute(commandContext);
+
+            assertNotNull(results);
+            assertEquals(2, results.getData().size());
+            assertEquals(testReponse, results.getData().get(JBPMConstants.RESPONSE_WI_PARAM));
+        }
&lt;p&gt; finally &lt;/p&gt;
{
+            ServiceRegistry.get().remove(deploymentId + JBPMConstants.DEPLOYMENT_CAMEL_CONTEXT_SERVICE_KEY_POSTFIX);
+        }
&lt;p&gt;     }&lt;br/&gt;
 }&lt;br/&gt;
diff --git a/components/camel-jbpm/src/test/java/org/apache/camel/component/jbpm/workitem/GlobalContextCamelCommandTest.java b/components/camel-jbpm/src/test/java/org/apache/camel/component/jbpm/workitem/GlobalContextCamelCommandTest.java&lt;br/&gt;
index 031bc69e30b..0d0db7cab8a 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/components/camel-jbpm/src/test/java/org/apache/camel/component/jbpm/workitem/GlobalContextCamelCommandTest.java&lt;br/&gt;
+++ b/components/camel-jbpm/src/test/java/org/apache/camel/component/jbpm/workitem/GlobalContextCamelCommandTest.java&lt;br/&gt;
@@ -44,16 +44,16 @@&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     @Mock&lt;br/&gt;
     Exchange outExchange;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;p&gt;+&lt;br/&gt;
     @Mock&lt;br/&gt;
     Message outMessage;&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;&lt;p&gt;+&lt;br/&gt;
     @Mock&lt;br/&gt;
     CamelContext camelContext;&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;&lt;p&gt;+&lt;br/&gt;
     @Mock&lt;br/&gt;
     RuntimeManager runtimeManager;&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;&lt;p&gt;+&lt;br/&gt;
     @Mock&lt;br/&gt;
     CommandContext commandContext;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;@@ -61,7 +61,7 @@&lt;br/&gt;
     public void testExecuteGlobalCommand() throws Exception {&lt;/p&gt;

&lt;p&gt;         String camelEndpointId = &quot;testCamelRoute&quot;;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;String camelRouteUri = &quot;direct://&quot; + camelEndpointId;&lt;br/&gt;
+        String camelRouteUri = &quot;direct:&quot; + camelEndpointId;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         String testReponse = &quot;testResponse&quot;;&lt;/p&gt;

&lt;p&gt;@@ -76,20 +76,24 @@ public void testExecuteGlobalCommand() throws Exception {&lt;br/&gt;
         when(outExchange.getOut()).thenReturn(outMessage);&lt;br/&gt;
         when(outMessage.getBody()).thenReturn(testReponse);&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;//Register the RuntimeManager bound camelContext.&lt;/li&gt;
	&lt;li&gt;ServiceRegistry.get().register(JBPMConstants.GLOBAL_CAMEL_CONTEXT_SERVICE_KEY, camelContext);&lt;br/&gt;
+        // Register the RuntimeManager bound camelcontext.&lt;br/&gt;
+        try 
{
+            ServiceRegistry.get().register(JBPMConstants.GLOBAL_CAMEL_CONTEXT_SERVICE_KEY, camelContext);
 
-        WorkItemImpl workItem = new WorkItemImpl();
-        workItem.setParameter(JBPMConstants.CAMEL_ENDPOINT_ID_WI_PARAM, camelEndpointId);
-        workItem.setParameter(&quot;Request&quot;, &quot;someRequest&quot;);
+            WorkItemImpl workItem = new WorkItemImpl();
+            workItem.setParameter(JBPMConstants.CAMEL_ENDPOINT_ID_WI_PARAM, camelEndpointId);
+            workItem.setParameter(&quot;Request&quot;, &quot;someRequest&quot;);
 
-        when(commandContext.getData(anyString())).thenReturn(workItem);
+            when(commandContext.getData(anyString())).thenReturn(workItem);
 
-        Command command = new GlobalContextCamelCommand();
-        ExecutionResults results = command.execute(commandContext);
+            Command command = new GlobalContextCamelCommand();
+            ExecutionResults results = command.execute(commandContext);
 
-        assertNotNull(results);
-        assertEquals(2, results.getData().size());
-        assertEquals(testReponse, results.getData().get(JBPMConstants.RESPONSE_WI_PARAM));
+            assertNotNull(results);
+            assertEquals(2, results.getData().size());
+            assertEquals(testReponse, results.getData().get(JBPMConstants.RESPONSE_WI_PARAM));
+        }
&lt;p&gt; finally &lt;/p&gt;
{
+            ServiceRegistry.get().remove(JBPMConstants.GLOBAL_CAMEL_CONTEXT_SERVICE_KEY);
+        }
&lt;p&gt;     }&lt;br/&gt;
 }&lt;br/&gt;
\ No newline at end of file&lt;br/&gt;
diff --git a/components/camel-jbpm/src/test/java/org/apache/camel/component/jbpm/workitem/InOnlyCamelWorkItemHandlerTest.java b/components/camel-jbpm/src/test/java/org/apache/camel/component/jbpm/workitem/InOnlyCamelWorkItemHandlerTest.java&lt;br/&gt;
index b97822ead63..324f04cf3f9 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/components/camel-jbpm/src/test/java/org/apache/camel/component/jbpm/workitem/InOnlyCamelWorkItemHandlerTest.java&lt;br/&gt;
+++ b/components/camel-jbpm/src/test/java/org/apache/camel/component/jbpm/workitem/InOnlyCamelWorkItemHandlerTest.java&lt;br/&gt;
@@ -60,7 +60,7 @@&lt;br/&gt;
     public void testExecuteInOnlyLocalCamelContext() throws Exception {&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         String camelEndpointId = &quot;testCamelRoute&quot;;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;String camelRouteUri = &quot;direct://&quot; + camelEndpointId;&lt;br/&gt;
+        String camelRouteUri = &quot;direct:&quot; + camelEndpointId;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         String testReponse = &quot;testResponse&quot;;&lt;/p&gt;

&lt;p&gt;@@ -76,22 +76,26 @@ public void testExecuteInOnlyLocalCamelContext() throws Exception {&lt;br/&gt;
         when(camelContext.getHeadersMapFactory()).thenReturn(hmf);&lt;/p&gt;

&lt;p&gt;         // Register the RuntimeManager bound camelcontext.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;ServiceRegistry.get().register(runtimeManagerId + &quot;_CamelService&quot;, camelContext);&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;WorkItemImpl workItem = new WorkItemImpl();&lt;/li&gt;
	&lt;li&gt;workItem.setParameter(JBPMConstants.CAMEL_ENDPOINT_ID_WI_PARAM, camelEndpointId);&lt;/li&gt;
	&lt;li&gt;workItem.setParameter(&quot;Request&quot;, &quot;someRequest&quot;);&lt;/li&gt;
	&lt;li&gt;workItem.setDeploymentId(&quot;testDeploymentId&quot;);&lt;/li&gt;
	&lt;li&gt;workItem.setProcessInstanceId(1L);&lt;/li&gt;
	&lt;li&gt;workItem.setId(1L);&lt;/li&gt;
	&lt;li&gt;&lt;/li&gt;
	&lt;li&gt;AbstractCamelWorkItemHandler handler = new InOnlyCamelWorkItemHandler(runtimeManager);&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;TestWorkItemManager manager = new TestWorkItemManager();&lt;/li&gt;
	&lt;li&gt;handler.executeWorkItem(workItem,&lt;/li&gt;
	&lt;li&gt;manager);&lt;/li&gt;
	&lt;li&gt;assertThat(manager.getResults(), is(notNullValue()));&lt;/li&gt;
	&lt;li&gt;//InOnly does not complete WorkItem.&lt;/li&gt;
	&lt;li&gt;assertThat(manager.getResults().size(), equalTo(0));&lt;br/&gt;
+        try 
{
+            ServiceRegistry.get().register(runtimeManagerId + &quot;_CamelService&quot;, camelContext);
+
+            WorkItemImpl workItem = new WorkItemImpl();
+            workItem.setParameter(JBPMConstants.CAMEL_ENDPOINT_ID_WI_PARAM, camelEndpointId);
+            workItem.setParameter(&quot;Request&quot;, &quot;someRequest&quot;);
+            workItem.setDeploymentId(&quot;testDeploymentId&quot;);
+            workItem.setProcessInstanceId(1L);
+            workItem.setId(1L);
+
+            AbstractCamelWorkItemHandler handler = new InOnlyCamelWorkItemHandler(runtimeManager);
+
+            TestWorkItemManager manager = new TestWorkItemManager();
+            handler.executeWorkItem(workItem,
+                    manager);
+            assertThat(manager.getResults(), is(notNullValue()));
+            // InOnly does not complete WorkItem.
+            assertThat(manager.getResults().size(), equalTo(0));
+        }
&lt;p&gt; finally &lt;/p&gt;
{
+            ServiceRegistry.get().remove(runtimeManagerId + &quot;_CamelService&quot;);
+        }&lt;br/&gt;
     }&lt;br/&gt;
 }&lt;br/&gt;
diff --git a/components/camel-jbpm/src/test/java/org/apache/camel/component/jbpm/workitem/InOutCamelWorkItemHandlerTest.java b/components/camel-jbpm/src/test/java/org/apache/camel/component/jbpm/workitem/InOutCamelWorkItemHandlerTest.java&lt;br/&gt;
index 578de782f36..8453f09cd35 100644&lt;br/&gt;
&amp;#8212; a/components/camel-jbpm/src/test/java/org/apache/camel/component/jbpm/workitem/InOutCamelWorkItemHandlerTest.java&lt;br/&gt;
+++ b/components/camel-jbpm/src/test/java/org/apache/camel/component/jbpm/workitem/InOutCamelWorkItemHandlerTest.java&lt;br/&gt;
@@ -63,7 +63,7 @@&lt;br/&gt;
     public void testExecuteInOutGlobalCamelContext() throws Exception {&lt;br/&gt;
 &lt;br/&gt;
         String camelEndpointId = &quot;testCamelRoute&quot;;&lt;br/&gt;
-        String camelRouteUri = &quot;direct://&quot; + camelEndpointId;&lt;br/&gt;
+        String camelRouteUri = &quot;direct:&quot; + camelEndpointId;&lt;br/&gt;
 &lt;br/&gt;
         String testReponse = &quot;testResponse&quot;;&lt;br/&gt;
 &lt;br/&gt;
@@ -77,6 +77,7 @@ public void testExecuteInOutGlobalCamelContext() throws Exception {&lt;br/&gt;
         when(outExchange.getOut()).thenReturn(outMessage);&lt;br/&gt;
         when(outMessage.getBody()).thenReturn(testReponse);&lt;br/&gt;
 &lt;br/&gt;
+        try {&lt;br/&gt;
         ServiceRegistry.get().register(&quot;GlobalCamelService&quot;, camelContext);&lt;br/&gt;
 &lt;br/&gt;
         TestWorkItemManager manager = new TestWorkItemManager();&lt;br/&gt;
@@ -97,13 +98,18 @@ public void testExecuteInOutGlobalCamelContext() throws Exception {
         Map&amp;lt;String, Object&amp;gt; results = manager.getResults(workItem.getId());
         assertThat(results.size(), equalTo(2));
         assertThat(results.get(&quot;Response&quot;), equalTo(testReponse));
+        
+        } finally {
+            ServiceRegistry.get().remove(&quot;GlobalCamelService&quot;);
+        }&lt;br/&gt;
+        &lt;br/&gt;
     }&lt;br/&gt;
 &lt;br/&gt;
     @Test&lt;br/&gt;
     public void testExecuteInOutLocalCamelContext() throws Exception {&lt;br/&gt;
 &lt;br/&gt;
         String camelEndpointId = &quot;testCamelRoute&quot;;&lt;br/&gt;
-        String camelRouteUri = &quot;direct://&quot; + camelEndpointId;&lt;br/&gt;
+        String camelRouteUri = &quot;direct:&quot; + camelEndpointId;&lt;br/&gt;
 &lt;br/&gt;
         String testReponse = &quot;testResponse&quot;;&lt;br/&gt;
 &lt;br/&gt;
@@ -122,7 +128,94 @@ public void testExecuteInOutLocalCamelContext() throws Exception {&lt;br/&gt;
         when(outMessage.getBody()).thenReturn(testReponse);&lt;br/&gt;
 &lt;br/&gt;
         // Register the RuntimeManager bound camelcontext.&lt;br/&gt;
-        ServiceRegistry.get().register(runtimeManagerId + &quot;_CamelService&quot;, camelContext);&lt;br/&gt;
+        try {
+            ServiceRegistry.get().register(runtimeManagerId + &quot;_CamelService&quot;, camelContext);
+
+            WorkItemImpl workItem = new WorkItemImpl();
+            workItem.setParameter(JBPMConstants.CAMEL_ENDPOINT_ID_WI_PARAM, camelEndpointId);
+            workItem.setParameter(&quot;Request&quot;, &quot;someRequest&quot;);
+            workItem.setDeploymentId(&quot;testDeploymentId&quot;);
+            workItem.setProcessInstanceId(1L);
+            workItem.setId(1L);
+
+            AbstractCamelWorkItemHandler handler = new InOutCamelWorkItemHandler(runtimeManager);
+
+            TestWorkItemManager manager = new TestWorkItemManager();
+            handler.executeWorkItem(workItem,
+                    manager);
+            assertThat(manager.getResults(), is(notNullValue()));
+            assertThat(manager.getResults().size(), equalTo(1));
+            assertThat(manager.getResults().containsKey(workItem.getId()), is(true));
+
+            Map&amp;lt;String, Object&amp;gt; results = manager.getResults(workItem.getId());
+            assertThat(results.size(), equalTo(2));
+            assertThat(results.get(JBPMConstants.RESPONSE_WI_PARAM), equalTo(testReponse));
+        } finally {+            ServiceRegistry.get().remove(runtimeManagerId + &quot;_CamelService&quot;);+        }
&lt;p&gt;+    }&lt;br/&gt;
+&lt;br/&gt;
+    @Test&lt;br/&gt;
+    public void testExecuteInOutLocalCamelContextLazyInit() throws Exception &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {++        String camelEndpointId = &amp;quot;testCamelRoute&amp;quot;;+        String camelRouteUri = &amp;quot;direct}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;+&lt;br/&gt;
+    @Test(expected = IllegalArgumentException.class)&lt;br/&gt;
+    public void testExecuteInOutLocalCamelContextLazyInitFail() throws Exception {&lt;br/&gt;
+&lt;br/&gt;
+        String camelEndpointId = &quot;testCamelRoute&quot;;&lt;br/&gt;
+        String camelRouteUri = &quot;direct:&quot; + camelEndpointId;&lt;br/&gt;
+&lt;br/&gt;
+        String testReponse = &quot;testResponse&quot;;&lt;br/&gt;
+&lt;br/&gt;
+        String runtimeManagerId = &quot;testRuntimeManager&quot;;&lt;br/&gt;
+&lt;br/&gt;
+        when(runtimeManager.getIdentifier()).thenReturn(runtimeManagerId);&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         WorkItemImpl workItem = new WorkItemImpl();&lt;br/&gt;
         workItem.setParameter(JBPMConstants.CAMEL_ENDPOINT_ID_WI_PARAM, camelEndpointId);&lt;br/&gt;
@@ -134,15 +227,9 @@ public void testExecuteInOutLocalCamelContext() throws Exception &lt;/p&gt;
{
         AbstractCamelWorkItemHandler handler = new InOutCamelWorkItemHandler(runtimeManager);
 
         TestWorkItemManager manager = new TestWorkItemManager();
-        handler.executeWorkItem(workItem,
-                manager);
-        assertThat(manager.getResults(), is(notNullValue()));
-        assertThat(manager.getResults().size(), equalTo(1));
-        assertThat(manager.getResults().containsKey(workItem.getId()), is(true));
-        
-        Map&amp;lt;String, Object&amp;gt; results = manager.getResults(workItem.getId());
-        assertThat(results.size(), equalTo(2));
-        assertThat(results.get(JBPMConstants.RESPONSE_WI_PARAM), equalTo(testReponse));
+        // This is expected to throw an exception.
+        handler.executeWorkItem(workItem, manager);
+
     }
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;p&gt;+&lt;br/&gt;
 }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 50 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|s013ko:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>