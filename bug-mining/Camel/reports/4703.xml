<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:32:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-12987] camel-core-osgi: OsgiServiceRegistry.onContextStop never gets called.</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-12987</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;There is also a second problem with how the registry is being managed within the OsgiDefaultCamelContext.&#160; OsgiServiceRegistry is currently extends LifecycleStrategySupport which is suppose to unload the serviceReferenceQueue onContextStop.&#160; However the registry is never getting added to the CamelContext to manage the Lifecycle because the overridden createRegistry method in OsgiDefaultCamelContext is not being called.&#160; This is because the registry is being set in the constructor of OsgiDefaultCamelContext with&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;(registry);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;this calls the DefaultCamelContext implementation of createRegistry which does not add the registry to lifecyclemanagement since&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
OsgiCamelContextHelper.wrapRegistry(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;, registry, bundleContext);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;is never called.&#160;&lt;/p&gt;

&lt;p&gt;See &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12969&quot; title=&quot;camel-core-osgi: Slow Memory Leak in OsgiServiceRegistry&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12969&quot;&gt;&lt;del&gt;CAMEL-12969&lt;/del&gt;&lt;/a&gt; for screen captures.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment>&lt;p&gt;Java 10&lt;/p&gt;

&lt;p&gt;Karaf 4.2.1&lt;/p&gt;

&lt;p&gt;Camel 2.22.0&lt;/p&gt;</environment>
        <key id="13203243">CAMEL-12987</key>
            <summary>camel-core-osgi: OsgiServiceRegistry.onContextStop never gets called.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="bobpaulin">Bob Paulin</reporter>
                        <labels>
                    </labels>
                <created>Sun, 9 Dec 2018 02:58:57 +0000</created>
                <updated>Tue, 11 Dec 2018 13:22:37 +0000</updated>
                            <resolved>Tue, 11 Dec 2018 13:22:37 +0000</resolved>
                                    <version>2.18.0</version>
                    <version>2.19.0</version>
                    <version>2.20.0</version>
                    <version>2.21.0</version>
                    <version>2.22.0</version>
                    <version>2.23.0</version>
                    <version>2.24.0</version>
                                    <fixVersion>2.22.3</fixVersion>
                    <fixVersion>2.23.1</fixVersion>
                    <fixVersion>2.24.0</fixVersion>
                                    <component>camel-osgi</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16713840" author="githubbot" created="Sun, 9 Dec 2018 03:06:29 +0000"  >&lt;p&gt;bobpaulin opened a new pull request #2660: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12987&quot; title=&quot;camel-core-osgi: OsgiServiceRegistry.onContextStop never gets called.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12987&quot;&gt;&lt;del&gt;CAMEL-12987&lt;/del&gt;&lt;/a&gt;: Ensure onContextStop is called on the OsgiServiceRegistry.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2660&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2660&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Split the onContextStop issue out of &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12969&quot; title=&quot;camel-core-osgi: Slow Memory Leak in OsgiServiceRegistry&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12969&quot;&gt;&lt;del&gt;CAMEL-12969&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16713911" author="githubbot" created="Sun, 9 Dec 2018 09:52:29 +0000"  >&lt;p&gt;davsclaus closed pull request #2660: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12987&quot; title=&quot;camel-core-osgi: OsgiServiceRegistry.onContextStop never gets called.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12987&quot;&gt;&lt;del&gt;CAMEL-12987&lt;/del&gt;&lt;/a&gt;: Ensure onContextStop is called on the OsgiServiceRegistry.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2660&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2660&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/components/camel-core-osgi/src/main/java/org/apache/camel/core/osgi/OsgiCamelContextHelper.java b/components/camel-core-osgi/src/main/java/org/apache/camel/core/osgi/OsgiCamelContextHelper.java&lt;br/&gt;
index 08ff669c59f..2b9b1fc4e60 100644&lt;br/&gt;
&amp;#8212; a/components/camel-core-osgi/src/main/java/org/apache/camel/core/osgi/OsgiCamelContextHelper.java&lt;br/&gt;
+++ b/components/camel-core-osgi/src/main/java/org/apache/camel/core/osgi/OsgiCamelContextHelper.java&lt;br/&gt;
@@ -56,14 +56,23 @@ public static void osgiUpdate(DefaultCamelContext camelContext, BundleContext bu&lt;br/&gt;
     public static Registry wrapRegistry(CamelContext camelContext, Registry registry, BundleContext bundleContext) {&lt;br/&gt;
         ObjectHelper.notNull(bundleContext, &quot;BundleContext&quot;);&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;LOG.debug(&quot;Setting up OSGi ServiceRegistry&quot;);&lt;/li&gt;
	&lt;li&gt;OsgiServiceRegistry osgiServiceRegistry = new OsgiServiceRegistry(bundleContext);&lt;br/&gt;
+        OsgiServiceRegistry osgiServiceRegistry = null;&lt;br/&gt;
+        Registry resultingRegistry = registry;&lt;br/&gt;
+        if(registry instanceof OsgiServiceRegistry) 
{
+            osgiServiceRegistry = (OsgiServiceRegistry)registry;
+        }
&lt;p&gt; else &lt;/p&gt;
{
+            LOG.debug(&quot;Wrapping Registry in OsgiServiceRegistry&quot;);
+            osgiServiceRegistry = new OsgiServiceRegistry(bundleContext);
+            CompositeRegistry compositeRegistry = new CompositeRegistry();
+            compositeRegistry.addRegistry(osgiServiceRegistry);
+            compositeRegistry.addRegistry(registry);
+            resultingRegistry = compositeRegistry;
+        }
&lt;p&gt;+        &lt;br/&gt;
         // Need to clean up the OSGi service when camel context is closed.&lt;br/&gt;
         camelContext.addLifecycleStrategy(osgiServiceRegistry);&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;CompositeRegistry compositeRegistry = new CompositeRegistry();&lt;/li&gt;
	&lt;li&gt;compositeRegistry.addRegistry(osgiServiceRegistry);&lt;/li&gt;
	&lt;li&gt;compositeRegistry.addRegistry(registry);&lt;/li&gt;
	&lt;li&gt;return compositeRegistry;&lt;br/&gt;
+        &lt;br/&gt;
+        return resultingRegistry;&lt;br/&gt;
     }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; }&lt;br/&gt;
diff --git a/components/camel-core-osgi/src/main/java/org/apache/camel/core/osgi/OsgiDefaultCamelContext.java b/components/camel-core-osgi/src/main/java/org/apache/camel/core/osgi/OsgiDefaultCamelContext.java&lt;br/&gt;
index 20e3a21eca0..821ef5d7978 100644&lt;br/&gt;
&amp;#8212; a/components/camel-core-osgi/src/main/java/org/apache/camel/core/osgi/OsgiDefaultCamelContext.java&lt;br/&gt;
+++ b/components/camel-core-osgi/src/main/java/org/apache/camel/core/osgi/OsgiDefaultCamelContext.java&lt;br/&gt;
@@ -32,7 +32,6 @@&lt;br/&gt;
 public class OsgiDefaultCamelContext extends DefaultCamelContext {&lt;/p&gt;

&lt;p&gt;     private final BundleContext bundleContext;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private final Registry registry;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     public OsgiDefaultCamelContext(BundleContext bundleContext) {&lt;br/&gt;
         this(bundleContext, new OsgiServiceRegistry(bundleContext));&lt;br/&gt;
@@ -41,7 +40,7 @@ public OsgiDefaultCamelContext(BundleContext bundleContext) {&lt;br/&gt;
     public OsgiDefaultCamelContext(BundleContext bundleContext, Registry registry) {&lt;br/&gt;
         super(registry);&lt;br/&gt;
         this.bundleContext = bundleContext;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;this.registry = registry;&lt;br/&gt;
+        setRegistry(OsgiCamelContextHelper.wrapRegistry(this, registry, bundleContext));&lt;br/&gt;
         OsgiCamelContextHelper.osgiUpdate(this, bundleContext);&lt;br/&gt;
         // setup the application context classloader with the bundle classloader&lt;br/&gt;
         setApplicationContextClassLoader(new BundleDelegatingClassLoader(bundleContext.getBundle()));&lt;br/&gt;
@@ -52,15 +51,6 @@ public OsgiDefaultCamelContext(BundleContext bundleContext, Registry registry) 
{
         return BundleContextUtils.findComponents(bundleContext, this);
     }&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;@Override&lt;/li&gt;
	&lt;li&gt;protected Registry createRegistry() {&lt;/li&gt;
	&lt;li&gt;if (registry != null) 
{
-            return OsgiCamelContextHelper.wrapRegistry(this, registry, bundleContext);
-        }
&lt;p&gt; else &lt;/p&gt;
{
-            return OsgiCamelContextHelper.wrapRegistry(this, super.createRegistry(), bundleContext);
-        }&lt;/li&gt;
	&lt;li&gt;}&lt;br/&gt;
-&lt;br/&gt;
     @Override&lt;br/&gt;
     protected TypeConverter createTypeConverter() {&lt;br/&gt;
         // &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-3614&quot; title=&quot;When the OsgiTypeConverter looks for TypeConverterLoader services in the OSGi registry, it should use its own BundleContext instead of the one from the client bundle so that class space consistency can be fully enforced&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-3614&quot;&gt;&lt;del&gt;CAMEL-3614&lt;/del&gt;&lt;/a&gt;: make sure we use a bundle context which imports org.apache.camel.impl.converter package&lt;/li&gt;
&lt;/ul&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717116" author="davsclaus" created="Tue, 11 Dec 2018 13:22:37 +0000"  >&lt;p&gt;Thanks for the PR&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 49 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|s01bf4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>