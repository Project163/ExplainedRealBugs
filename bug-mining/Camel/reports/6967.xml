<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 11:08:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-21400] StackOverflowError when processing files</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-21400</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;Hello everyone,&lt;/p&gt;

&lt;p&gt;I just discovered a &lt;tt&gt;StackOverflowError&lt;/tt&gt; when using reading files. Here&apos;s the smallest reprocase I could find.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// Create a temp directory with a CSV file
&lt;/span&gt;Path tempDirectory = Files.createTempDirectory(&lt;span class=&quot;code-quote&quot;&gt;&quot;camel-test&quot;&lt;/span&gt;);
&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (BufferedWriter writer = Files.newBufferedWriter(tempDirectory.resolve(&lt;span class=&quot;code-quote&quot;&gt;&quot;file1.csv&quot;&lt;/span&gt;))) {
    writer.write(&lt;span class=&quot;code-quote&quot;&gt;&quot;fieldA,fieldB,fieldC,fieldD\n&quot;&lt;/span&gt;);
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; 20000; i++) {
        writer.write(&lt;span class=&quot;code-quote&quot;&gt;&quot;fieldA&quot;&lt;/span&gt; + i + &lt;span class=&quot;code-quote&quot;&gt;&quot;,fieldB&quot;&lt;/span&gt; + i + &lt;span class=&quot;code-quote&quot;&gt;&quot;,fieldC&quot;&lt;/span&gt; + i + &lt;span class=&quot;code-quote&quot;&gt;&quot;,fieldD&quot;&lt;/span&gt; + i + &lt;span class=&quot;code-quote&quot;&gt;&quot;\n&quot;&lt;/span&gt;);
    }
}

&lt;span class=&quot;code-comment&quot;&gt;// Seems to fail &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the target producer &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; DefaultProducer and works &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; it &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; DefaultAsyncProducer
&lt;/span&gt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; target = &lt;span class=&quot;code-quote&quot;&gt;&quot;file:&lt;span class=&quot;code-comment&quot;&gt;//output&quot;&lt;/span&gt;; // &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; fails
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; target = &lt;span class=&quot;code-quote&quot;&gt;&quot;log://speed?groupSize=1000&quot;&lt;/span&gt;; // &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; works
&lt;/span&gt;
DefaultCamelContext context = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DefaultCamelContext();
context.addRoutes(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RouteBuilder() {
    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void configure() {
        from(&lt;span class=&quot;code-quote&quot;&gt;&quot;file:&lt;span class=&quot;code-comment&quot;&gt;//&quot;&lt;/span&gt; + tempDirectory.toAbsolutePath() + &lt;span class=&quot;code-quote&quot;&gt;&quot;?noop=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;).to(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:read&quot;&lt;/span&gt;).log(&lt;span class=&quot;code-quote&quot;&gt;&quot;Done!&quot;&lt;/span&gt;);
&lt;/span&gt;        from(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:read&quot;&lt;/span&gt;).unmarshal().csv().split(body()).to(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:agg&quot;&lt;/span&gt;);
         from(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:agg&quot;&lt;/span&gt;).aggregate(constant(&lt;span class=&quot;code-quote&quot;&gt;&quot;SINGLE_GROUP&quot;&lt;/span&gt;), &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; GroupedExchangeAggregationStrategy())
                .completionSize(1)
                .setBody((Exchange exchange) -&amp;gt; {
                    List&amp;lt;Exchange&amp;gt; list = (List&amp;lt;Exchange&amp;gt;) exchange.getMessage().getBody();
                    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; list.stream().map(e -&amp;gt; e.getMessage().getBody().toString()).collect(joining(&lt;span class=&quot;code-quote&quot;&gt;&quot;\n&quot;&lt;/span&gt;));
                })
                .to(target);
    }
});
context.start();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;del&gt;As mentioned in the example, it only seems to fail if the processor in the aggregation is a &lt;tt&gt;DefaultProcessor&lt;/tt&gt; and not a &lt;tt&gt;DefaultAsyncProcessor&lt;/tt&gt;&lt;/del&gt;&lt;br/&gt;
It still fails after converting my component to &lt;tt&gt;DefaultAsyncProcessor&lt;/tt&gt;, so it&apos;s unrelated.&lt;/p&gt;

&lt;p&gt;Can you have a look? Thank you&lt;/p&gt;</description>
                <environment></environment>
        <key id="13597059">CAMEL-21400</key>
            <summary>StackOverflowError when processing files</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="10008">Information Provided</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="antoine.dessaigne">Antoine DESSAIGNE</reporter>
                        <labels>
                    </labels>
                <created>Tue, 29 Oct 2024 11:41:46 +0000</created>
                <updated>Fri, 13 Dec 2024 08:30:04 +0000</updated>
                            <resolved>Sat, 30 Nov 2024 16:53:48 +0000</resolved>
                                    <version>4.7.0</version>
                                    <fixVersion>4.10.0</fixVersion>
                                    <component>camel-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17893936" author="antoine.dessaigne" created="Tue, 29 Oct 2024 17:42:47 +0000"  >&lt;p&gt;Thanks to a git bisect, the regression is due to &lt;a href=&quot;https://github.com/apache/camel/commit/6324bc0a6dae05650b851a9524407c5382d3ff6e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;commit 6324bc0a6da&lt;/a&gt; from &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-16829&quot; title=&quot;camel-core - Stuck processing with nested parallel splits and custom thread pool&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-16829&quot;&gt;&lt;del&gt;CAMEL-16829&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Unfortunately, I don&apos;t understand this part of the code. Please let me know if there&apos;s anything I can do to help. Thank you.&lt;/p&gt;</comment>
                            <comment id="17894187" author="davsclaus" created="Wed, 30 Oct 2024 12:23:30 +0000"  >&lt;p&gt;Can you put together this example as either a standalone project that is easy to run, or an unit test class, thanks.&lt;/p&gt;</comment>
                            <comment id="17894197" author="antoine.dessaigne" created="Wed, 30 Oct 2024 12:54:59 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;I&apos;ll be able to do that tonight.&lt;/p&gt;

&lt;p&gt;If you want to check it earlier, you need a project with camel-core and camel-csv, copy/paste the code into a main java method, add a bit of sleep at the end and you&apos;re done.&lt;/p&gt;

&lt;p&gt;This relies on CSV because it&apos;s how I found it, maybe there&apos;s a way without CSV to reproduce the issue.&lt;/p&gt;</comment>
                            <comment id="17894349" author="antoine.dessaigne" created="Wed, 30 Oct 2024 19:58:57 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Thank you for looking into it.&lt;/p&gt;

&lt;p&gt;I attached &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13072504/13072504_SplitAggregateTest.java&quot; title=&quot;SplitAggregateTest.java attached to CAMEL-21400&quot;&gt;SplitAggregateTest.java&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; to this ticket. You need to save it in &lt;tt&gt;components/camel-csv/src/test/java/org/apache/camel/dataformat/csv/&lt;/tt&gt; and run it.&lt;/p&gt;

&lt;p&gt;If you run it with 4.6.0 it will work but if you run it with 4.7.0 it will fail.&lt;/p&gt;</comment>
                            <comment id="17902023" author="davsclaus" created="Sat, 30 Nov 2024 09:56:18 +0000"  >&lt;p&gt;Your example is also bad that you split and aggregate and have a completion size of 1 that is bad design.&lt;/p&gt;

&lt;p&gt;This can lead to this situation as you have.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17902024" author="antoine.dessaigne" created="Sat, 30 Nov 2024 10:14:35 +0000"  >&lt;p&gt;Hello &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Thank you for looking at it.&lt;/p&gt;

&lt;p&gt;Yes, it makes little sense but it&apos;s the simplest reprocase with public components and data I could find. We have the stackoverflowerror with a split then aggregate to batch process a CSV file.&lt;/p&gt;</comment>
                            <comment id="17902026" author="davsclaus" created="Sat, 30 Nov 2024 10:52:04 +0000"  >&lt;p&gt;The issue is the aggregator in completion size = 1 mode, will always trigger completion and it will reusing the incoming thread to continue.&lt;/p&gt;

&lt;p&gt;And because the incoming thread is doing a giant split, its stack-depth grows bigger and bigger.&lt;/p&gt;

&lt;p&gt;You need to make the aggregator output using its own thread, such as adding&lt;/p&gt;

&lt;p&gt;&#160;&lt;br/&gt;
.executorService(Executors.newSingleThreadExecutor())&lt;br/&gt;
&#160;&lt;br/&gt;
Or turn on parallel processing&lt;br/&gt;
&#160;&lt;br/&gt;
.parallelProcessing()&lt;br/&gt;
&#160;&lt;/p&gt;</comment>
                            <comment id="17902054" author="davsclaus" created="Sat, 30 Nov 2024 16:53:48 +0000"  >&lt;p&gt;update the aggregate eip doc with some pointers about this&lt;/p&gt;</comment>
                            <comment id="17905403" author="antoine.dessaigne" created="Fri, 13 Dec 2024 08:30:04 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Thank you for taking the time to investigate this.&lt;/p&gt;

&lt;p&gt;If someone else encounters the same issue: I&apos;m going another way to solve this. As the completion size comes for a property {{&lt;tt&gt;aggregationSize&lt;/tt&gt;}}, I&apos;ll wrap the &lt;tt&gt;aggregate&lt;/tt&gt; in a &lt;tt&gt;choice&lt;/tt&gt; with {{&lt;tt&gt;aggregationSize&lt;/tt&gt; == 1}}&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13600446">CAMEL-21494</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13072504" name="SplitAggregateTest.java" size="3298" author="antoine.dessaigne" created="Wed, 30 Oct 2024 19:56:28 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            47 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1s9lc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310080" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Regression</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10091"><![CDATA[Regression]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>