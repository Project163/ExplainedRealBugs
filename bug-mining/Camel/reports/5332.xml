<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:41:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-14935] KafkaConsumer commits old offset values in a failure scenario causing message replays and offset reset error</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-14935</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;We are experiencing unexpected offset reset errors occasionally, as well as occasional replay of messages (without an offset reset error).&lt;/p&gt;

&lt;p&gt;The cause seems to be a failed commit on rebalance, leaving an old value in the hashMap used to store the latest processed offset for a partition. This old value is then re-read and re-committed across rebalances in certain situations.&lt;/p&gt;

&lt;p&gt;Our relevant configuration details are:&lt;/p&gt;

&lt;p&gt;autoCommitEnable=false&lt;br/&gt;
 allowManualCommit=true&lt;br/&gt;
 autoOffsetReset=earliest&lt;/p&gt;

&lt;p&gt;It seems when the KafkaConsumer experiences an Exception committing the offset (CommitFailedException) upon a rebalance, this leaves the&#160;old offset value in the lastProcessedOffset hashMap.&lt;/p&gt;

&lt;p&gt;A subsequent rebalance that assigns the same partition to the same consumer, that then thereafter experiences another rebalance (before any messages have been processed successfully as this will over write the invalid value and self correct the problem) will commit this old offset again.&#160; This offset may be very old if there have been many rebalances in between the original rebalance that failed to commit its offset.&lt;/p&gt;

&lt;p&gt;If the old offset is beyond the retention period and the message is no longer available the outcome is an offset reset error.&#160; If the offset is within the retention period all messages are replayed from that offset without an error being thrown.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13299838">CAMEL-14935</key>
            <summary>KafkaConsumer commits old offset values in a failure scenario causing message replays and offset reset error</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="10">Implemented</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="Chris McCarthy">Chris McCarthy</reporter>
                        <labels>
                    </labels>
                <created>Tue, 21 Apr 2020 01:06:42 +0000</created>
                <updated>Tue, 7 Nov 2023 10:08:05 +0000</updated>
                            <resolved>Sat, 2 May 2020 07:06:06 +0000</resolved>
                                    <version>2.24.0</version>
                                    <fixVersion>2.25.2</fixVersion>
                    <fixVersion>3.x</fixVersion>
                                    <component>camel-kafka</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17092103" author="davsclaus" created="Sat, 25 Apr 2020 07:27:49 +0000"  >&lt;p&gt;Yeah Kafka pushes all the complexities from them to the end users ;(&lt;/p&gt;

&lt;p&gt;So what can we do? Can we maybe remove/clear that map in case of CommitFailedException so there are no offset stored at all?&lt;/p&gt;

&lt;p&gt;You are welcome to dive into the code and see if you can provide a fix/improvement as patch or github PR&lt;/p&gt;</comment>
                            <comment id="17097182" author="chris mccarthy" created="Fri, 1 May 2020 05:33:21 +0000"  >&lt;p&gt;Thanks Claus,&lt;/p&gt;

&lt;p&gt;Yes performing the delete of the map in a finally block would address this specific vulnerability, or clearing out the map on assignment,&lt;/p&gt;

&lt;p&gt;We may be better off to upgrade to a newer version first I think.&#160; &#160;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17097843" author="davsclaus" created="Sat, 2 May 2020 07:05:46 +0000"  >&lt;p&gt;Okay yeah I would also suggest to upgrade if possible as older Camel 2.x releases are not active maintained. Only 2.25.x is and its only for serious bugs or security issues.&lt;/p&gt;</comment>
                            <comment id="17117186" author="dariusx" created="Wed, 27 May 2020 00:12:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt;&#160;is this a change that has been made in v3.x? &lt;br/&gt;
It is &quot;Resolved&quot;, but I don&apos;t see a PR attached, and you also mentioned that you&apos;d welcome a patch.&lt;br/&gt;
 So, wasn&apos;t sure if there&apos;s a resolution without such a patch... some work-around?&lt;/p&gt;</comment>
                            <comment id="17118010" author="dariusx" created="Wed, 27 May 2020 18:46:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Chris+McCarthy&quot; class=&quot;user-hover&quot; rel=&quot;Chris McCarthy&quot;&gt;Chris McCarthy&lt;/a&gt;, we ran into this too (v2.24.3) and were planning on either patching or overriding the Kafka Consumer.&lt;br/&gt;
If you&apos;ve looked at the code and have any pointers about where best to catch that exception, or where best to put the finally, your feedback will be valuable. Thx.&#160;&lt;/p&gt;</comment>
                            <comment id="17119160" author="chris mccarthy" created="Thu, 28 May 2020 23:31:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dariusx&quot; class=&quot;user-hover&quot; rel=&quot;dariusx&quot;&gt;dariusx&lt;/a&gt;&#160;I think the vulnerability would be well handled by a change in the KafkaConsumer (the camel component) in the method onPartitionsRevoked that implements the rebalance listener.&#160; Wrapping the call to the commitOffset in a try block and removing the offsetKey from the Map lastProcesssedOffset in the corresponding finally block, so exceptions on commit do not prevent the Map being cleaned up. Hope that helps and is clear.&#160; &#160;&lt;/p&gt;</comment>
                            <comment id="17119740" author="dariusx" created="Fri, 29 May 2020 16:13:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Chris+McCarthy&quot; class=&quot;user-hover&quot; rel=&quot;Chris McCarthy&quot;&gt;Chris McCarthy&lt;/a&gt;&#160;Very clear, thank you.&#160;&lt;br/&gt;
 If you can review &lt;a href=&quot;https://github.com/DariusX/camel/pull/1/commits/9df63769d4ed9ffcc0f2d7aa6bd04955ccf15e2f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this PR on my personal fork&lt;/a&gt;, and check that it matches what you were thinking, that&apos;ll be helpful.&lt;/p&gt;

&lt;p&gt;As a next step, I&apos;ll work on sending it back into the Camel base repo.&lt;br/&gt;
 Thx.&lt;/p&gt;</comment>
                            <comment id="17120207" author="chris mccarthy" created="Sat, 30 May 2020 10:58:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dariusx&quot; class=&quot;user-hover&quot; rel=&quot;dariusx&quot;&gt;dariusx&lt;/a&gt;&#160;Yes that&apos;s what I was thinking.&#160; I would be inclined to throw the exception as there is useful information in the default handler that prints the below which is useful I think.&#160; Also a useful addition may be if you logged the offsetkey and the offset as it may be helpful for diagnostics when searching the log tracing issues with a particular partition or offset.&#160; But nice one as this is the fix needed!&lt;/p&gt;

&lt;p&gt;&quot;org.apache.kafka.clients.consumer.CommitFailedException: Commit cannot be completed since the group has already rebalanced and assigned the partitions to another member. This means that the time between subsequent calls to poll() was longer than the configured max.poll.interval.ms, which typically implies that the poll loop is spending too much time message processing. You can address this either by increasing max.poll.interval.ms or by reducing the maximum size of batches returned in poll() with max.poll.records.&quot;&lt;/p&gt;</comment>
                            <comment id="17120548" author="dariusx" created="Sun, 31 May 2020 14:08:43 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Chris+McCarthy&quot; class=&quot;user-hover&quot; rel=&quot;Chris McCarthy&quot;&gt;Chris McCarthy&lt;/a&gt;, please [see my PR to Camel here|&lt;a href=&quot;https://github.com/apache/camel/pull/3877&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/3877&lt;/a&gt;].&#160;&lt;br/&gt;
In particular, Claus&apos;s question as to whether it is okay to clear in the finally (rather than when we catch an exception).&lt;br/&gt;
Thanks.&lt;/p&gt;</comment>
                            <comment id="17123576" author="dariusx" created="Tue, 2 Jun 2020 09:49:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Chris+McCarthy&quot; class=&quot;user-hover&quot; rel=&quot;Chris McCarthy&quot;&gt;Chris McCarthy&lt;/a&gt;&#160;Claus [suggested the following|&lt;a href=&quot;https://github.com/apache/camel/pull/3877&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/3877&lt;/a&gt;], which sounds good to me:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;On Exception, we clear&lt;/li&gt;
	&lt;li&gt;In the Finally, we remove the current offset key&lt;br/&gt;
 The existing code had:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
lastProcessedOffset.remove(offsetKey);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;So, we&apos;d be putting that in the finally block&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Indeed, I have a question: do we really need to clear within the catch block?&lt;br/&gt;
Removing the offset for the current partition, within the finally block ought to do it, right?&lt;br/&gt;
That&apos;s the code that was being skipped originally...so, we just need to move it to the finally block?&lt;/p&gt;</comment>
                            <comment id="17124469" author="chris mccarthy" created="Wed, 3 Jun 2020 00:10:57 +0000"  >&lt;p&gt;Yes agreed, we dont want to clear as other consumers use that map and we will lose their state&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13557008">CAMEL-20089</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13555368">CAMEL-20044</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 24 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0dvg8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>