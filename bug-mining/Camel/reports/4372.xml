<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:27:16 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-11792] New ftp connection for each file transfer with tempFileName option in URI</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-11792</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;When we have &lt;tt&gt;tempFilename&lt;/tt&gt; in camel uri and we use producer template to write file to remote ftp location , camel opens new connection for every file transfer. Though disconnect option is set to false in uri.&lt;br/&gt;
If we take out tempFilename from uri connections are reused&lt;/p&gt;

&lt;p&gt;We can verify it by running attached sample. &lt;br/&gt;
Check the connections made from camel server to ftp server . Fire {{netstat -an|grep 10.80.14.56|wc -l]] &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;When we have tempFileName in uri it will show 1 connection per file transfer&lt;/li&gt;
	&lt;li&gt;Without tempFileName it will show only 1 connection for all files transfer.&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="13103508">CAMEL-11792</key>
            <summary>New ftp connection for each file transfer with tempFileName option in URI</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="himanshu">Himanshu Mittal</reporter>
                        <labels>
                    </labels>
                <created>Wed, 20 Sep 2017 06:06:35 +0000</created>
                <updated>Mon, 18 Dec 2017 13:37:56 +0000</updated>
                            <resolved>Mon, 18 Dec 2017 13:37:56 +0000</resolved>
                                    <version>2.14.0</version>
                    <version>2.19.2</version>
                                    <fixVersion>2.20.2</fixVersion>
                    <fixVersion>2.21.0</fixVersion>
                                    <component>camel-ftp</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16172785" author="himanshu" created="Wed, 20 Sep 2017 06:10:19 +0000"  >&lt;p&gt;Sample program to reproduce the issue&lt;/p&gt;</comment>
                            <comment id="16172787" author="gzres" created="Wed, 20 Sep 2017 06:10:39 +0000"  >&lt;p&gt;In relation to &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-8860&quot; title=&quot;Too many connection in TIME_WAIT when tempfilename is set in the FTP producer URI.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-8860&quot;&gt;&lt;del&gt;CAMEL-8860&lt;/del&gt;&lt;/a&gt; - thanks for verifying.&lt;/p&gt;</comment>
                            <comment id="16266276" author="sermojohn" created="Mon, 27 Nov 2017 00:46:06 +0000"  >&lt;p&gt;Hello! I spent some time on this issue. &lt;/p&gt;

&lt;p&gt;I searched a bit how Camel creates new endpoints and when running the example code, it does not create multiple endpoints. So IMHO a single endpoint instance that uses a single FTP client instance is used for all ftp calls.&lt;/p&gt;

&lt;p&gt;So I ended up checking the Apache FTP client on which the camel-ftp component depends. The library seems to intentionally open two (control &amp;amp; data) connections for each FTP command, while a Camel endpoint might require one or more FTP command to complete. So, to me, it is clear that this is a limitation of the library.&lt;/p&gt;

&lt;p&gt;Maybe this could be made possible by implementing a wrapper SocketFactory and ServerSocketFactory that would reuse the connections instead of closing them. But this seems more like a work-around. Maybe other FTP client implementations do not have this limitation.&lt;/p&gt;

&lt;p&gt;On the other side, I am wondering if such an approach of unifying all the FTP connections into one connection, is a good idea. This will probably affect the throughput because all the socket reads and writes will need to be serialized (socket not thread-safe). Or maybe this is a limitation of the FTP protocol itself.&lt;/p&gt;

&lt;p&gt;What do you think? I would volunteer to work on an agreed solution/fix/work-around.&lt;/p&gt;</comment>
                            <comment id="16276311" author="himanshu" created="Mon, 4 Dec 2017 05:34:06 +0000"  >&lt;p&gt;I debugged this camel-ftp code further and figured out the root cause. &lt;br/&gt;
In &lt;tt&gt;org.apache.camel.component.file.GenericFileProducer&lt;/tt&gt; &apos;s &lt;tt&gt;processExchange&lt;/tt&gt; method.&lt;br/&gt;
During temp file creation there is a check to delete pre existing temp file. &lt;br/&gt;
operation.existFile(tempTarget)  will invoke client.listNames(name) from commons.net. And it creates a connection internally &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 &lt;span class=&quot;code-comment&quot;&gt;// delete any pre existing temp file
&lt;/span&gt;                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (operations.existsFile(tempTarget)) {
                    log.trace(&lt;span class=&quot;code-quote&quot;&gt;&quot;Deleting existing temp file: {}&quot;&lt;/span&gt;, tempTarget);
                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!operations.deleteFile(tempTarget)) {
                        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; GenericFileOperationFailedException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Cannot delete file: &quot;&lt;/span&gt; + tempTarget);
                    }
                }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; Now if this check is conditional based on &lt;tt&gt;fileExist&lt;/tt&gt; check in endpoint. We can avoid additional connection and socket in TIME_WAIT&lt;/p&gt;</comment>
                            <comment id="16294932" author="davsclaus" created="Mon, 18 Dec 2017 12:58:32 +0000"  >&lt;p&gt;Thanks for digging into this&lt;/p&gt;</comment>
                            <comment id="16294938" author="davsclaus" created="Mon, 18 Dec 2017 13:02:35 +0000"  >&lt;p&gt;Yeah it looks like we should skip that part of code if the fileExists=TryRename as this is what the option was intended for, just to try without any exists check. &lt;/p&gt;</comment>
                            <comment id="16294982" author="davsclaus" created="Mon, 18 Dec 2017 13:37:56 +0000"  >&lt;p&gt;Use fileExists=TryRename and the new connection should not happen&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12837120">CAMEL-8860</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12888020" name="TestFTPConnection.java" size="1063" author="himanshu" created="Wed, 20 Sep 2017 06:10:00 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 48 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ka5b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>