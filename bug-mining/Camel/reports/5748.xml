<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:47:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-16658] AmbiguousMethodCallException when using Mockito mock as bean for camel-bean component.</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-16658</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;In Camel 2.x camel-bean component considered only public methods when trying to choose a method to call.&lt;/p&gt;

&lt;p&gt;In Camel 3.x this behaviour was changed and now protected and package methods are also considered (it was implemented in the &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-13298&quot; title=&quot;Allow bean component to invoke methods with package modifier in the same class&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-13298&quot;&gt;&lt;del&gt;CAMEL-13298&lt;/del&gt;&lt;/a&gt; task).&lt;/p&gt;

&lt;p&gt;Unfortunately this change causes that using Mockito mocks as beans for camel-bean components (for example to test some Camel routes) causes an AmbiguousMethodCallException to be thrown.&lt;/p&gt;

&lt;p&gt;Here is an example of such exception:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
org.apache.camel.component.bean.AmbiguousMethodCallException: Ambiguous method invocations possible:
[&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; org.apache.camel.component.bean.MockitoMockForClassTest$MyService$MockitoMock$1368359973.doSomething(java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;),
&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; org.apache.camel.component.bean.MockitoMockForClassTest$MyService$MockitoMock$1368359973.doSomething$accessor$MJMz0OHK(java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;)]
on the exchange: Exchange[]
  at org.apache.camel.component.bean.BeanInfo.chooseBestPossibleMethodInfo(BeanInfo.java:887)
  ...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This is caused by the fact that Mockito adds package level methods with the same argument list to created mock/spy.&lt;/p&gt;

&lt;p&gt;Additional complication is added by the fact that Mockito 1.x (which uses CGLIB underneath) adds different methods than Mockito 2.x and 3.x (which uses Byte Buddy).&lt;/p&gt;

&lt;p&gt;Here are 3 JUnit tests that reproduce this problem:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// NOTE: fails &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; Mockito 3.x and 2.x, but passes &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; Mockito 1.x
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;MockitoMockForClassTest &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; ContextTestSupport {

    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testCallingMock() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; response = template.requestBody(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:start&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;anything&quot;&lt;/span&gt;);
        assertEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;mocked answer&quot;&lt;/span&gt;, response);
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; Registry createRegistry() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        MyService mockService = Mockito.mock(MyService.class);
        when(mockService.doSomething(any())).thenReturn(&lt;span class=&quot;code-quote&quot;&gt;&quot;mocked answer&quot;&lt;/span&gt;);

        Registry answer = &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.createRegistry();
        answer.bind(&lt;span class=&quot;code-quote&quot;&gt;&quot;myService&quot;&lt;/span&gt;, mockService);
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; answer;
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; RouteBuilder createRouteBuilder() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RouteBuilder() {
            &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void configure() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
                from(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:start&quot;&lt;/span&gt;).bean(&lt;span class=&quot;code-quote&quot;&gt;&quot;bean:myService&quot;&lt;/span&gt;);
            }
        };
    }

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;MyService {
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; doSomething(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; body) {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;real answer&quot;&lt;/span&gt;;
        }
    }

}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// NOTE: fails &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; Mockito 3.x and 2.x, but passes &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; Mockito 1.x
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;MockitoSpyForClassTest &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; ContextTestSupport {

    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testCallingSpy() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; response = template.requestBody(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:start&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;anything&quot;&lt;/span&gt;);
        assertEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;mocked answer&quot;&lt;/span&gt;, response);
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; Registry createRegistry() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        MyService mockService = Mockito.spy(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MyService());
        when(mockService.doSomething(any())).thenReturn(&lt;span class=&quot;code-quote&quot;&gt;&quot;mocked answer&quot;&lt;/span&gt;);

        Registry answer = &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.createRegistry();
        answer.bind(&lt;span class=&quot;code-quote&quot;&gt;&quot;myService&quot;&lt;/span&gt;, mockService);
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; answer;
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; RouteBuilder createRouteBuilder() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RouteBuilder() {
            &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void configure() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
                from(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:start&quot;&lt;/span&gt;).bean(&lt;span class=&quot;code-quote&quot;&gt;&quot;bean:myService&quot;&lt;/span&gt;);
            }
        };
    }

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;MyService {
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; doSomething(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; body) {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;real answer&quot;&lt;/span&gt;;
        }
    }

}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// NOTE: fails &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; Mockito 1.x, but passes &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; Mockito 3.x and 2.x
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;MockitoMockForInterfaceTest &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; ContextTestSupport {

    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testCallingMock() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; response = template.requestBody(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:start&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;anything&quot;&lt;/span&gt;);
        assertEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;mocked answer&quot;&lt;/span&gt;, response);
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; Registry createRegistry() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        MyService mockService = Mockito.mock(MyService.class);
        when(mockService.doSomething(any())).thenReturn(&lt;span class=&quot;code-quote&quot;&gt;&quot;mocked answer&quot;&lt;/span&gt;);

        Registry answer = &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.createRegistry();
        answer.bind(&lt;span class=&quot;code-quote&quot;&gt;&quot;myService&quot;&lt;/span&gt;, mockService);
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; answer;
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; RouteBuilder createRouteBuilder() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RouteBuilder() {
            &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void configure() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
                from(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:start&quot;&lt;/span&gt;).bean(&lt;span class=&quot;code-quote&quot;&gt;&quot;bean:myService&quot;&lt;/span&gt;);
            }
        };
    }

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;interface&lt;/span&gt; MyService {
        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; doSomething(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; body);
    }

}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13380364">CAMEL-16658</key>
            <summary>AmbiguousMethodCallException when using Mockito mock as bean for camel-bean component.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="kmackowiak">Krzysztof Mackowiak</reporter>
                        <labels>
                    </labels>
                <created>Tue, 25 May 2021 14:52:32 +0000</created>
                <updated>Wed, 26 May 2021 06:52:36 +0000</updated>
                            <resolved>Wed, 26 May 2021 05:12:50 +0000</resolved>
                                    <version>3.x</version>
                                    <fixVersion>3.7.5</fixVersion>
                    <fixVersion>3.11.0</fixVersion>
                                    <component>camel-bean</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="17351118" author="kmackowiak" created="Tue, 25 May 2021 15:00:38 +0000"  >&lt;p&gt;I&apos;m attaching 2 patches for master branch which contains tests and a proposed fix for this bug.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13025941/13025941_Tests_-_AmbiguousMethodCallException_when_using_Mockito_mock_as_bean_for_camel-bean_compon.patch&quot; title=&quot;Tests_-_AmbiguousMethodCallException_when_using_Mockito_mock_as_bean_for_camel-bean_compon.patch attached to CAMEL-16658&quot;&gt;Tests_-_AmbiguousMethodCallException_when_using_Mockito_mock_as_bean_for_camel-bean_compon.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13025942/13025942_Fix_-_AmbiguousMethodCallException_when_using_Mockito_mock_as_bean_for_camel-bean_componen.patch&quot; title=&quot;Fix_-_AmbiguousMethodCallException_when_using_Mockito_mock_as_bean_for_camel-bean_componen.patch attached to CAMEL-16658&quot;&gt;Fix_-_AmbiguousMethodCallException_when_using_Mockito_mock_as_bean_for_camel-bean_componen.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="17351488" author="davsclaus" created="Wed, 26 May 2021 05:12:50 +0000"  >&lt;p&gt;Thanks for reporting and providing a patch with tests&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13025942" name="Fix_-_AmbiguousMethodCallException_when_using_Mockito_mock_as_bean_for_camel-bean_componen.patch" size="1723" author="kmackowiak" created="Tue, 25 May 2021 14:59:42 +0000"/>
                            <attachment id="13025941" name="Tests_-_AmbiguousMethodCallException_when_using_Mockito_mock_as_bean_for_camel-bean_compon.patch" size="6347" author="kmackowiak" created="Tue, 25 May 2021 14:52:16 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 25 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0rczs:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>