<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:27:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-12131] CacheProducer should not put services in Camel context, that are not singletons and are not ServicePoolAware</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-12131</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;When the org.apache.camel.impl.ProducerCache &lt;b&gt;doGetProducer&lt;/b&gt; method is called from &lt;b&gt;org.apache.camel.processor.SendProcessor&apos;s doStart()&lt;/b&gt; method, it will create new instance of a Producer, and put it into Camel context by calling &lt;b&gt;getCamelContext().addService(answer, false);&lt;/b&gt;. However, it will not put the object into producers or the pool map, because it is not ServicePoolAware and is not a singleton. This results in a service that will later be started by &lt;b&gt;DeferServiceStartupListener&lt;/b&gt; and will stay started until the whole context is closed. &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; Producer doGetProducer(Endpoint endpoint, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; pooled) {
        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; key = endpoint.getEndpointUri();
        Producer answer = producers.get(key);
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (pooled &amp;amp;&amp;amp; answer == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; acquire from connection pool
&lt;/span&gt;            answer = pool.acquire(endpoint);
        }

        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (answer == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            &lt;span class=&quot;code-comment&quot;&gt;// create a &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; producer
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                answer = endpoint.createProducer();
                &lt;span class=&quot;code-comment&quot;&gt;// add as service which will also start the service
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;// (&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt; =&amp;gt; we and handling the lifecycle of the producer in &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; cache)
&lt;/span&gt;                getCamelContext().addService(answer, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
            } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Throwable e) {
                &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FailedToCreateProducerException(endpoint, e);
            }

            &lt;span class=&quot;code-comment&quot;&gt;// add producer to cache or pool &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; applicable
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (pooled &amp;amp;&amp;amp; answer &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; ServicePoolAware) {
                LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Adding to producer service pool with key: {} &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; producer: {}&quot;&lt;/span&gt;, endpoint, answer);
                answer = pool.addAndAcquire(endpoint, answer);
            } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (answer.isSingleton()) {
                LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Adding to producer cache with key: {} &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; producer: {}&quot;&lt;/span&gt;, endpoint, answer);
                producers.put(key, answer);
            }
        }

        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (answer != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            &lt;span class=&quot;code-comment&quot;&gt;// record statistics
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (extendedStatistics) {
                statistics.onHit(key);
            }
        }

        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; answer;
    }

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Here is the part of &lt;b&gt;doStart()&lt;/b&gt; method from &lt;b&gt;SendProcessor&lt;/b&gt; class. The producer is acquired and after that is immediately released in &lt;b&gt;ProducerCache&lt;/b&gt;, however it is not removed from Camel context and stays there as a Service and will later by started by &lt;b&gt;DeferServiceStartupListener&lt;/b&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        Producer producer = producerCache.acquireProducer(destination);
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (producer &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; ServicePoolAware || !producer.isSingleton()) {
            &lt;span class=&quot;code-comment&quot;&gt;// no we cannot optimize it - so release the producer back to the producer cache
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// and use the producer cache &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; sending
&lt;/span&gt;            producerCache.releaseProducer(destination, producer);
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
            &lt;span class=&quot;code-comment&quot;&gt;// yes we can optimize and use the producer directly &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; sending
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.producer = AsyncProcessorConverterHelper.convert(producer);
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;



</description>
                <environment></environment>
        <key id="13129507">CAMEL-12131</key>
            <summary>CacheProducer should not put services in Camel context, that are not singletons and are not ServicePoolAware</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="rgala">Rafa&#322; Ga&#322;a</reporter>
                        <labels>
                    </labels>
                <created>Tue, 9 Jan 2018 12:04:39 +0000</created>
                <updated>Wed, 10 Jan 2018 14:02:07 +0000</updated>
                            <resolved>Wed, 10 Jan 2018 14:02:07 +0000</resolved>
                                                    <fixVersion>2.19.5</fixVersion>
                    <fixVersion>2.20.2</fixVersion>
                    <fixVersion>2.21.0</fixVersion>
                                    <component>camel-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16320160" author="davsclaus" created="Wed, 10 Jan 2018 12:24:19 +0000"  >&lt;p&gt;Do you have a custom component or what use-case do you have for a producer that is neither singleton, nor service poll aware?&lt;/p&gt;</comment>
                            <comment id="16320164" author="rgala" created="Wed, 10 Jan 2018 12:31:36 +0000"  >&lt;p&gt;This issue occurs for me on jt400 component used as destination endpoint (Jt400Endpoint class). It uses Jt400PgmProducer class as a producer.&lt;/p&gt;</comment>
                            <comment id="16320172" author="davsclaus" created="Wed, 10 Jan 2018 12:40:39 +0000"  >&lt;p&gt;Ah thanks, yeah that component is a bit unusual, ideally it should have been implemented a bit different so the endpoint could be singleton and producers thread-safe or something.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 44 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3oojb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>