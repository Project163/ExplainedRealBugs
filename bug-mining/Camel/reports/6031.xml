<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:52:04 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-17426] microprofile healt checks: do not conflate camel checks</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-17426</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;While running the &lt;a href=&quot;https://github.com/apache/camel-quarkus-examples/tree/main/health&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;camel quarkus healt example&lt;/a&gt;, I noticed that the health checks from camel are conflated so as example, the liveness block looks as follow:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-json&quot;&gt;
{
    &lt;span class=&quot;code-quote&quot;&gt;&quot;checks&quot;&lt;/span&gt;: [
        {
            &lt;span class=&quot;code-quote&quot;&gt;&quot;data&quot;&lt;/span&gt;: {
                &lt;span class=&quot;code-quote&quot;&gt;&quot;consumer:netty&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;DOWN&quot;&lt;/span&gt;,
                &lt;span class=&quot;code-quote&quot;&gt;&quot;consumer:timer&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;UP&quot;&lt;/span&gt;,
                &lt;span class=&quot;code-quote&quot;&gt;&quot;context&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;UP&quot;&lt;/span&gt;,
                &lt;span class=&quot;code-quote&quot;&gt;&quot;context.name&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;camel-7&quot;&lt;/span&gt;,
                &lt;span class=&quot;code-quote&quot;&gt;&quot;context.status&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;Started&quot;&lt;/span&gt;,
                &lt;span class=&quot;code-quote&quot;&gt;&quot;context.version&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;3.14.0&quot;&lt;/span&gt;,
                &lt;span class=&quot;code-quote&quot;&gt;&quot;failure.count&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;0&quot;&lt;/span&gt;,
                &lt;span class=&quot;code-quote&quot;&gt;&quot;invocation.count&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;5&quot;&lt;/span&gt;,
                &lt;span class=&quot;code-quote&quot;&gt;&quot;invocation.time&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;2022-01-04T11:32:56.024411+01:00[Europe/Rome]&quot;&lt;/span&gt;,
                &lt;span class=&quot;code-quote&quot;&gt;&quot;route.context.name&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;camel-7&quot;&lt;/span&gt;,
                &lt;span class=&quot;code-quote&quot;&gt;&quot;route.id&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;netty&quot;&lt;/span&gt;,
                &lt;span class=&quot;code-quote&quot;&gt;&quot;route.status&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;Stopped&quot;&lt;/span&gt;,
                &lt;span class=&quot;code-quote&quot;&gt;&quot;route:netty&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;UP&quot;&lt;/span&gt;,
                &lt;span class=&quot;code-quote&quot;&gt;&quot;route:timer&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;UP&quot;&lt;/span&gt;,
                &lt;span class=&quot;code-quote&quot;&gt;&quot;success.count&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;5&quot;&lt;/span&gt;,
                &lt;span class=&quot;code-quote&quot;&gt;&quot;toolong&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;UP&quot;&lt;/span&gt;
            },
            &lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;camel-readiness-checks&quot;&lt;/span&gt;,
            &lt;span class=&quot;code-quote&quot;&gt;&quot;status&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;DOWN&quot;&lt;/span&gt;
        }
    ],
    &lt;span class=&quot;code-quote&quot;&gt;&quot;status&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;DOWN&quot;&lt;/span&gt;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;As you may notice, there are inconsistencies, like, multiple routes are conflated and only the latest one appears: &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-json&quot;&gt;
{
  &lt;span class=&quot;code-quote&quot;&gt;&quot;route.id&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;netty&quot;&lt;/span&gt;,
  &lt;span class=&quot;code-quote&quot;&gt;&quot;route.status&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;Stopped&quot;&lt;/span&gt;,
  &lt;span class=&quot;code-quote&quot;&gt;&quot;route:netty&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;UP&quot;&lt;/span&gt;,
  &lt;span class=&quot;code-quote&quot;&gt;&quot;route:timer&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;UP&quot;&lt;/span&gt;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The issue seems to be cause by the fact that the camel-microprofile-health component does not mirrors the checks from camel but instead it aggregate them (see &lt;a href=&quot;https://github.com/apache/camel/blob/main/components/camel-microprofile/camel-microprofile-health/src/main/java/org/apache/camel/microprofile/health/AbstractCamelMicroProfileHealthCheck.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;AbstractCamelMicroProfileHealthCheck.java&lt;/a&gt;) &lt;/p&gt;

&lt;p&gt;SmallRye offers a sort of &lt;a href=&quot;https://github.com/smallrye/smallrye-health/tree/main/implementation/src/main/java/io/smallrye/health/registry&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;registry&lt;/a&gt; so we should probably register the camel health checks to the SmallRye registry (this may have the side effect to make the camel-microprofile-health smallrye dependant)&lt;/p&gt;

&lt;p&gt;In addition, it would be nice of SmallRye would allow to discovery registries&lt;/p&gt;</description>
                <environment></environment>
        <key id="13420566">CAMEL-17426</key>
            <summary>microprofile healt checks: do not conflate camel checks</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jamesnetherton">James Netherton</assignee>
                                    <reporter username="lb">Luca Burgazzoli</reporter>
                        <labels>
                    </labels>
                <created>Tue, 4 Jan 2022 10:48:26 +0000</created>
                <updated>Tue, 18 Jan 2022 17:09:09 +0000</updated>
                            <resolved>Tue, 18 Jan 2022 17:09:09 +0000</resolved>
                                                    <fixVersion>3.15.0</fixVersion>
                                    <component>camel-microprofile-health</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17468570" author="lb" created="Tue, 4 Jan 2022 10:48:58 +0000"  >&lt;p&gt;/cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jamesnetherton&quot; class=&quot;user-hover&quot; rel=&quot;jamesnetherton&quot;&gt;jamesnetherton&lt;/a&gt; what do you think ?&lt;/p&gt;</comment>
                            <comment id="17468668" author="lb" created="Tue, 4 Jan 2022 15:00:49 +0000"  >&lt;p&gt;As alternative we could have a quarkus specific implementation&lt;/p&gt;</comment>
                            <comment id="17469221" author="jamesnetherton" created="Wed, 5 Jan 2022 11:30:13 +0000"  >&lt;p&gt;We could perhaps have a custom Camel HealthCheckRegistry (extending DefaultHealthCheckRegistry) which intercepts the register and unregister events, and then does the same action on the SmallRye registry. WDYT?&lt;/p&gt;

&lt;p&gt;I notice the SmallRye Health registry APIs are marked as experimental, so not sure if there&apos;s an element of risk if we decide to use them. &lt;/p&gt;

&lt;p&gt;Maybe it&apos;s not such a big deal if we made the component dependent on SmallRye Health. Seems we already made the fault tolerance component dependent on the SmallRye impl anyway.&lt;/p&gt;</comment>
                            <comment id="17469235" author="lb" created="Wed, 5 Jan 2022 11:45:06 +0000"  >&lt;p&gt;Yep that is one of the option I was thinking about.&lt;/p&gt;

&lt;p&gt;Another alternative is to have two impl:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;a pure microprofile one, that for example either report UP or DOWN but in case of DOWN it just report the details of the first occurrence.&lt;/li&gt;
	&lt;li&gt;a smallrye one in which the Camel HealthCheckRegistry wraps the SmallRye registries as you suggested (but I&apos;m not sure if it is worth haviong a separate component for smallrye)&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17469314" author="jamesnetherton" created="Wed, 5 Jan 2022 13:36:21 +0000"  >&lt;p&gt;Yeah maybe having another separate component is overkill. It depends on whether we really need to keep a generic solution based on the pure MP spec.&lt;/p&gt;

&lt;p&gt;I&apos;m thinking we should go with leveraging the SmallRye registries. The output produced by the health reporter is more intuitive and simpler to read compared to how it shows with the current aggregated way, where everything is grouped under &apos;camel-liveness-checks&apos; &amp;amp; &apos;camel-readiness-checks&apos;.&lt;/p&gt;

&lt;p&gt;If we think this an acceptable way forwards, I could take a look at making the required modifications to the code.&lt;/p&gt;</comment>
                            <comment id="17469315" author="lb" created="Wed, 5 Jan 2022 13:38:35 +0000"  >&lt;p&gt;I&apos;m +1 with that so if you have any spare time, please go ahead &lt;/p&gt;</comment>
                            <comment id="17469317" author="davsclaus" created="Wed, 5 Jan 2022 13:39:35 +0000"  >&lt;p&gt;+1 good plan&lt;/p&gt;</comment>
                            <comment id="17469825" author="jamesnetherton" created="Thu, 6 Jan 2022 10:32:15 +0000"  >&lt;p&gt;One small issue I encountered is what happens if a Camel health check is enabled / disabled at runtime.&lt;/p&gt;

&lt;p&gt;There&apos;s currently no way of knowing that the health check configuration was updated in order to add / remove it on the SmallRye registry.&lt;/p&gt;</comment>
                            <comment id="17471811" author="lb" created="Mon, 10 Jan 2022 09:47:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jamesnetherton&quot; class=&quot;user-hover&quot; rel=&quot;jamesnetherton&quot;&gt;jamesnetherton&lt;/a&gt; would be enough to return UNKNOWN for disabled checks ? &lt;/p&gt;</comment>
                            <comment id="17471812" author="lb" created="Mon, 10 Jan 2022 09:48:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=astefanutti&quot; class=&quot;user-hover&quot; rel=&quot;astefanutti&quot;&gt;astefanutti&lt;/a&gt; not sure but this change may affect the work you have done on camel&lt;/p&gt;</comment>
                            <comment id="17471897" author="jamesnetherton" created="Mon, 10 Jan 2022 11:36:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lb&quot; class=&quot;user-hover&quot; rel=&quot;lb&quot;&gt;lb&lt;/a&gt; There is no UNKOWN status in MicroProfile Health unfortunately. I can propose that it&apos;s added though.&lt;/p&gt;

&lt;p&gt;There is a &apos;check.enabled&apos; metadata element added by Camel which will get propagated into the SmallRye health output. So that could be a way to determine that the health check is disabled and was not invoked and we leave the status as UP. Conceptually not 100% perfect, but I think it&apos;s probably acceptable initially.&lt;/p&gt;</comment>
                            <comment id="17471906" author="lb" created="Mon, 10 Jan 2022 11:53:33 +0000"  >&lt;p&gt;Agree, we could probably do something like&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
registry.enable(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; id)
registry.disable(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; id)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And delegate the actual implementation to the registry&lt;/p&gt;</comment>
                            <comment id="17471907" author="jamesnetherton" created="Mon, 10 Jan 2022 11:54:12 +0000"  >&lt;p&gt;I guess it depends on how important supporting enabling / disabling checks at runtime is. Because if it&apos;s not critical, then we can just avoid adding the check to the SmallRye registries if it&apos;s disabled.&lt;/p&gt;</comment>
                            <comment id="17471924" author="jamesnetherton" created="Mon, 10 Jan 2022 11:59:03 +0000"  >&lt;p&gt;Also to clarify - SmallRye health currently has no concept of disabled health checks at runtime.&lt;/p&gt;</comment>
                            <comment id="17471928" author="lb" created="Mon, 10 Jan 2022 12:04:14 +0000"  >&lt;p&gt;Yes, I don&apos;t recall the reason for enabled/disabled checks at runtime &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;/p&gt;</comment>
                            <comment id="17472583" author="antonin.stefanutti" created="Tue, 11 Jan 2022 09:12:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lb&quot; class=&quot;user-hover&quot; rel=&quot;lb&quot;&gt;lb&lt;/a&gt; Camel K currently looks up for the check named &lt;tt&gt;camel-readiness-checks&lt;/tt&gt;, and reads its status, as well as the presence of the &lt;tt&gt;.data&lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;quot;error.message&amp;quot;&amp;#93;&lt;/span&gt;&lt;/tt&gt;. The &lt;tt&gt;data&lt;/tt&gt; is reported as is in the integration status, so it&apos;s more for consumers of the integration statuses that conflation is an issue. I haven&apos;t checked the type of the &lt;tt&gt;data&lt;/tt&gt; field, but maybe it&apos;s possible to have a more structured form, that would avoid loosing information and maintain a bijection with the routes.&lt;/p&gt;</comment>
                            <comment id="17472600" author="lb" created="Tue, 11 Jan 2022 09:26:37 +0000"  >&lt;p&gt;The data block should be Map&amp;lt;String, Object&amp;gt; so it could be possible to use a structured &quot;payload&quot;, see &lt;a href=&quot;https://github.com/eclipse/microprofile-health/blob/master/api/src/main/java/org/eclipse/microprofile/health/HealthCheckResponse.java#L53&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/eclipse/microprofile-health/blob/master/api/src/main/java/org/eclipse/microprofile/health/HealthCheckResponse.java#L53&lt;/a&gt;&lt;br/&gt;
However I think the issue may still be present as you may have a number of &quot;error.message&quot;, like we may have one error per check, can we maybe translate the readiness error in conditions ?&lt;/p&gt;</comment>
                            <comment id="17472604" author="jamesnetherton" created="Tue, 11 Jan 2022 09:37:40 +0000"  >&lt;p&gt;SmallRye health can only handle data values of types Boolean, Long &amp;amp; String so it&apos;s not really possible to structure the data.&lt;/p&gt;</comment>
                            <comment id="17472611" author="antonin.stefanutti" created="Tue, 11 Jan 2022 09:48:59 +0000"  >&lt;p&gt;Right, I remember now and mapped the type to Golang accordingly: &lt;a href=&quot;https://github.com/apache/camel-k/blob/27ea823b6997d8b1a4477944739b578e07b487f7/pkg/controller/integration/health.go#L47&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel-k/blob/27ea823b6997d8b1a4477944739b578e07b487f7/pkg/controller/integration/health.go#L47&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Yet it&apos;s polymorphism for primitive types, not object. That being said, it could be loosely structured, as it kinda is already, but improved to guarantee a bijection. &lt;/p&gt;

&lt;p&gt;For the &lt;tt&gt;error.message&lt;/tt&gt;, it&apos;s only checked to move the integration to the &lt;tt&gt;Error&lt;/tt&gt; phase. So there could be a message per route, and Camel K would move the integration in &lt;tt&gt;Error&lt;/tt&gt; phase as soon as there is at least one error message.&lt;/p&gt;

&lt;p&gt;Currently, Camel K passes the data as is. It would totally be possible to parse further these data into conditions for example, once that conflation issue is solved.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 44 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0y85k:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>