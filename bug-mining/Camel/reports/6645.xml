<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 11:04:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-20044] camel-kafka - On rejoining consumer group Camel can set offset incorrectly causing messages to be replayed</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-20044</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;&lt;b&gt;Reproducing (intermittent)&lt;/b&gt;:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Configure camel kafka consumer with following:
	&lt;ul&gt;
		&lt;li&gt;autoCommitEnable = false&lt;/li&gt;
		&lt;li&gt;allowManualCommit = true&lt;/li&gt;
		&lt;li&gt;autoOffsetReset = earliest&lt;/li&gt;
		&lt;li&gt;maxPollRecords = 1&lt;/li&gt;
		&lt;li&gt;breakOnFirstError = true&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;Produce a series of records to kafka record to both partitions.&lt;/li&gt;
	&lt;li&gt;Throw an exception that is unhandled&lt;/li&gt;
	&lt;li&gt;commit the offset in the onException block&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;b&gt;Expected behavior:&lt;/b&gt;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Application should consume the record 1 more time, then move on to the next offset in the partition&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;b&gt;Actual behavior:&lt;/b&gt;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Application will often work. Occasionally will use the offset from another partition and assign that to the partition where the record failed. This can then result in the consumer replaying messages instead of moving forward.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I put together a sample that can recreate the error. However, given its intermittent nature it may not fail on each run. I have included the logs from 3 different runs on my laptop from this test. Two of them show the error occurring. One of the them has a successful run. I have also provided more details in the README.&#160;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/CodeSmell/CamelKafkaOffset&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/CodeSmell/CamelKafkaOffset&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This seems related to other issues with how Camel processes the&#160;&lt;em&gt;breakOnFirstError&lt;/em&gt;&#160;attribute.&#160;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-14935&quot; title=&quot;KafkaConsumer commits old offset values in a failure scenario causing message replays and offset reset error&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-14935&quot;&gt;&lt;del&gt;CAMEL-14935&lt;/del&gt;&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-17925&quot; title=&quot;camel-kafka: &amp;quot;breakOnFirstError&amp;quot; option is not respected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-17925&quot;&gt;&lt;del&gt;CAMEL-17925&lt;/del&gt;&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-18350&quot; title=&quot;camel-kafka: enabling &amp;quot;breakOnFirstError&amp;quot; causes camel to reconsume all records on error&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-18350&quot;&gt;&lt;del&gt;CAMEL-18350&lt;/del&gt;&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-19894&quot; title=&quot;camel-kafka: enabling &amp;quot;breakOnFirstError&amp;quot; causes to skip records on exception&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-19894&quot;&gt;&lt;del&gt;CAMEL-19894&lt;/del&gt;&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment>&lt;ul&gt;
	&lt;li&gt;Rocky Linux 8.7&lt;/li&gt;
	&lt;li&gt;Open JDK 11.0.8&lt;/li&gt;
	&lt;li&gt;Camel 3.21.0&lt;/li&gt;
	&lt;li&gt;Spring Boot 2.7.14&lt;/li&gt;
	&lt;li&gt;Strimzi Kafka 0.28.0/3.0.0&lt;/li&gt;
&lt;/ul&gt;
</environment>
        <key id="13555368">CAMEL-20044</key>
            <summary>camel-kafka - On rejoining consumer group Camel can set offset incorrectly causing messages to be replayed</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="orpiske">Otavio Rodolfo Piske</assignee>
                                    <reporter username="g1antfan">Mike Barlotta</reporter>
                        <labels>
                    </labels>
                <created>Tue, 24 Oct 2023 15:35:27 +0000</created>
                <updated>Wed, 10 Jan 2024 09:24:00 +0000</updated>
                            <resolved>Mon, 20 Nov 2023 16:15:08 +0000</resolved>
                                    <version>3.21.0</version>
                                    <fixVersion>3.21.3</fixVersion>
                    <fixVersion>3.22.0</fixVersion>
                    <fixVersion>4.3.0</fixVersion>
                                    <component>camel-kafka</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17780420" author="g1antfan" created="Fri, 27 Oct 2023 15:16:13 +0000"  >&lt;p&gt;Downgraded to Camel 3.14.5, a version prior to the fix of &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-18350&quot; title=&quot;camel-kafka: enabling &amp;quot;breakOnFirstError&amp;quot; causes camel to reconsume all records on error&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-18350&quot;&gt;&lt;del&gt;CAMEL-18350&lt;/del&gt;&lt;/a&gt;&#160;&lt;br/&gt;
The processing of the payloads looks like this&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Consumed NORETRY-ERROR 2 times&lt;/li&gt;
	&lt;li&gt;Consumed 1 1 times&lt;/li&gt;
	&lt;li&gt;Consumed 2 1 times&lt;/li&gt;
	&lt;li&gt;...&lt;/li&gt;
	&lt;li&gt;Consumed 11 1 times&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;What is interesting here is that the revoke from the consumer group is not logged, nor is there a seek.&#160;&lt;/p&gt;

&lt;p&gt;This behavior is different than the way these messages are being processed in 3.21&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Consumed NORETRY-ERROR 4 times&lt;/li&gt;
	&lt;li&gt;Consumed 1 1 times&lt;/li&gt;
	&lt;li&gt;Consumed 2 1 times&lt;/li&gt;
	&lt;li&gt;...&lt;/li&gt;
	&lt;li&gt;Consumed 11 1 times&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;A scan of the various releases and related issues suggests that behavior was changed based on this issue&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-17925&quot; title=&quot;camel-kafka: &amp;quot;breakOnFirstError&amp;quot; option is not respected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-17925&quot;&gt;&lt;del&gt;CAMEL-17925&lt;/del&gt;&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The &lt;a href=&quot;https://camel.apache.org/components/3.14.x/kafka-component.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.14 documentation &lt;/a&gt;has this for `breakOnFirstError`&lt;br/&gt;
&lt;em&gt;This options controls what happens when a consumer is processing an exchange and it fails. If the option is false then the consumer continues to the next message and processes it. If the option is true then the consumer breaks out, and will seek back to offset of the message that caused a failure, and then re-attempt to process this message. However this can lead to endless processing of the same message if its bound to fail every time, eg a poison message. Therefore its recommended to deal with that for example by using Camel&#8217;s error handler.&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;I could not find older documentation to see how the documentation described the behavior prior to that release.&lt;/p&gt;

&lt;p&gt;One other observation, running the test provided with a RETRY error instead on NONRETRY, using 14.5 does result in that payload NOT being retried.&lt;/p&gt;

&lt;p&gt;Wondering if &lt;em&gt;breakOnFirstError&lt;/em&gt; (when true) should break out and then seek back to the last committed offset (instead of the offset on the &lt;em&gt;lastResult&lt;/em&gt;). In the test app provided that would mean that a NORETRY would not be processed again (b/c we committed the offset). However a RETRY would be processed repeatedly (b/c we had not committed the offset). It likley means that a batch would be replayed in its entirety leaving the Camel app to have to handle the messages were already processed successfully.&lt;/p&gt;

&lt;p&gt;Any thoughts?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17783278" author="g1antfan" created="Mon, 6 Nov 2023 16:46:21 +0000"  >&lt;p&gt;Got some time and I&apos;ve added some extra logging statements to &lt;em&gt;KafkaRecordProcessor&lt;/em&gt; in the 3.21.x branch&lt;/p&gt;

&lt;p&gt;in this run there are 3 consumer threads&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;thread 1 processes partition 2
	&lt;ul&gt;
		&lt;li&gt;handles offset 0 and 1 fine&lt;/li&gt;
		&lt;li&gt;2:2 has an error&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;thread 2 processes partition 1
	&lt;ul&gt;
		&lt;li&gt;handles offset 0 and 1 fine&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;thread 3 processes partition 0
	&lt;ul&gt;
		&lt;li&gt;handles offset 0, 1, 2 fine&lt;/li&gt;
		&lt;li&gt;0:3 has an error&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;thread 1 and 3 both unsubscribe&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2023-11-06 | 10:23:12.774 | WARN &#160;| [Camel (camel-1) thread #3 - KafkaConsumer[foobarTopic]] | o.a.c.c.k.c.s.KafkaRecordProcessor (KafkaRecordProcessor.java:144) | Will seek consumer to offset 2 on partition 0 and start polling again.
2023-11-06 | 10:23:12.782 | TRACE | [Camel (camel-1) thread #3 - KafkaConsumer[foobarTopic]] | o.a.c.c.kafka.KafkaFetchRecords (KafkaFetchRecords.java:354) | the polling iteration had a result returned &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition 0 and offset 2
2023-11-06 | 10:23:12.784 | TRACE | [Camel (camel-1) thread #1 - KafkaConsumer[foobarTopic]] | o.a.c.c.kafka.KafkaFetchRecords (KafkaFetchRecords.java:354) | the polling iteration had a result returned &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition 2 and offset 1
2023-11-06 | 10:23:12.784 | DEBUG | [Camel (camel-1) thread #3 - KafkaConsumer[foobarTopic]] | o.a.c.c.kafka.KafkaFetchRecords (KafkaFetchRecords.java:366) | We hit an error ... setting flags to force reconnect
2023-11-06 | 10:23:12.785 | DEBUG | [Camel (camel-1) thread #1 - KafkaConsumer[foobarTopic]] | o.a.c.c.kafka.KafkaFetchRecords (KafkaFetchRecords.java:366) | We hit an error ... setting flags to force reconnect
2023-11-06 | 10:23:12.785 | DEBUG | [Camel (camel-1) thread #3 - KafkaConsumer[foobarTopic]] | o.a.c.c.kafka.KafkaFetchRecords (KafkaFetchRecords.java:382) | Not reconnecting, check whether to auto-commit or not ...
2023-11-06 | 10:23:12.785 | DEBUG | [Camel (camel-1) thread #1 - KafkaConsumer[foobarTopic]] | o.a.c.c.kafka.KafkaFetchRecords (KafkaFetchRecords.java:382) | Not reconnecting, check whether to auto-commit or not ...
2023-11-06 | 10:23:12.785 | INFO &#160;| [Camel (camel-1) thread #3 - KafkaConsumer[foobarTopic]] | o.a.c.c.k.consumer.NoopCommitManager (NoopCommitManager.java:35) | Auto commit on foobarTopic-&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; 2 from topic foobarTopic is enabled via Kafka consumer (NO-OP)
2023-11-06 | 10:23:12.785 | INFO &#160;| [Camel (camel-1) thread #1 - KafkaConsumer[foobarTopic]] | o.a.c.c.k.consumer.NoopCommitManager (NoopCommitManager.java:35) | Auto commit on foobarTopic-&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; 0 from topic foobarTopic is enabled via Kafka consumer (NO-OP)
2023-11-06 | 10:23:12.785 | DEBUG | [Camel (camel-1) thread #3 - KafkaConsumer[foobarTopic]] | o.a.c.c.kafka.KafkaFetchRecords (KafkaFetchRecords.java:468) | Unsubscribing from Kafka
2023-11-06 | 10:23:12.785 | DEBUG | [Camel (camel-1) thread #1 - KafkaConsumer[foobarTopic]] | o.a.c.c.kafka.KafkaFetchRecords (KafkaFetchRecords.java:468) | Unsubscribing from Kafka &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The last we heard from thread #2 is that it had processed 1:1 and was manually committing&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2023-11-06 | 10:23:12.636 | INFO &#160;| [Camel (camel-1) thread #2 - KafkaConsumer[foobarTopic]] | c.c.k.KafkaOffsetManagerProcessor (KafkaOffsetManagerProcessor.java:49) | manually committing the offset &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; batch
Message consumed from foobarTopic
The Partition:Offset is 1:1
The Key is &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
10 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;b&gt;The &lt;em&gt;lastResult&lt;/em&gt; of 1:1 on thread #2 will end up causing the problem&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;When Camel resubscribes we get this&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;thread 1 processes partition 2
	&lt;ul&gt;
		&lt;li&gt;based on Camel logic it reprocesses 2:2&lt;/li&gt;
		&lt;li&gt;2:2 has an error&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The other threads don&apos;t have a chance to do anything before Camel unsubscribes&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2023-11-06 | 10:23:15.421 | WARN &#160;| [Camel (camel-1) thread #1 - KafkaConsumer[foobarTopic]] | o.a.c.c.k.c.s.KafkaRecordProcessor (KafkaRecordProcessor.java:144) | Will seek consumer to offset -1 on partition -1 and start polling again.
2023-11-06 | 10:23:15.421 | TRACE | [Camel (camel-1) thread #1 - KafkaConsumer[foobarTopic]] | o.a.c.c.kafka.KafkaFetchRecords (KafkaFetchRecords.java:354) | the polling iteration had a result returned &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; partition -1 and offset -1
2023-11-06 | 10:23:15.421 | DEBUG | [Camel (camel-1) thread #1 - KafkaConsumer[foobarTopic]] | o.a.c.c.kafka.KafkaFetchRecords (KafkaFetchRecords.java:366) | We hit an error ... setting flags to force reconnect
2023-11-06 | 10:23:15.421 | DEBUG | [Camel (camel-1) thread #1 - KafkaConsumer[foobarTopic]] | o.a.c.c.kafka.KafkaFetchRecords (KafkaFetchRecords.java:382) | Not reconnecting, check whether to auto-commit or not ...
2023-11-06 | 10:23:15.421 | INFO &#160;| [Camel (camel-1) thread #1 - KafkaConsumer[foobarTopic]] | o.a.c.c.k.consumer.NoopCommitManager (NoopCommitManager.java:35) | Auto commit on foobarTopic-&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; 0 from topic foobarTopic is enabled via Kafka consumer (NO-OP)
2023-11-06 | 10:23:15.422 | DEBUG | [Camel (camel-1) thread #1 - KafkaConsumer[foobarTopic]] | o.a.c.c.kafka.KafkaFetchRecords (KafkaFetchRecords.java:468) | Unsubscribing from Kafka
2023-11-06 | 10:23:15.422 | DEBUG | [Camel (camel-1) thread #1 - KafkaConsumer[foobarTopic]] | o.a.c.c.k.consumer.NoopCommitManager (NoopCommitManager.java:42) | Auto commit to offset foobarTopic-&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; 0 from topic foobarTopic is disabled (NO-OP)
2023-11-06 | 10:23:15.425 | INFO &#160;| [Camel (camel-1) thread #1 - KafkaConsumer[foobarTopic]] | o.a.k.clients.consumer.KafkaConsumer (KafkaConsumer.java:1075) | [Consumer clientId=consumer-test_group_id-5, groupId=test_group_id] Unsubscribed all topics or patterns and assigned partitions
2023-11-06 | 10:23:15.426 | DEBUG | [Camel (camel-1) thread #1 - KafkaConsumer[foobarTopic]] | o.a.c.c.kafka.KafkaFetchRecords (KafkaFetchRecords.java:470) | Done unsubscribing from Kafka
2023-11-06 | 10:23:15.426 | DEBUG | [Camel (camel-1) thread #1 - KafkaConsumer[foobarTopic]] | o.a.c.c.kafka.KafkaFetchRecords (KafkaFetchRecords.java:117) | not connected so will initialize consumer task
2023-11-06 | 10:23:15.426 | INFO &#160;| [Camel (camel-1) thread #1 - KafkaConsumer[foobarTopic]] | o.a.c.c.kafka.KafkaFetchRecords (KafkaFetchRecords.java:250) | Reconnecting Kafka consumer thread ID foobarTopic-&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; 0 with poll timeout of 5000 ms
...
2023-11-06 | 10:23:15.443 | INFO &#160;| [Camel (camel-1) thread #1 - KafkaConsumer[foobarTopic]] | o.a.c.c.kafka.KafkaFetchRecords (KafkaFetchRecords.java:297) | Subscribing foobarTopic-&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; 0 to topic foobarTopic&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;When Camel resubscribes we get this:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;thread 2 is assigned partition 0&lt;/li&gt;
	&lt;li&gt;&lt;b&gt;the problem is lastResult is 1:1 which is from the last time it ran&lt;/b&gt;&lt;b&gt;{&lt;/b&gt;}
	&lt;ul&gt;
		&lt;li&gt;&lt;b&gt;this should have been reset to null&lt;/b&gt;&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;it processes 0:3 which has an error&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2023-11-06 | 10:23:15.870 | TRACE | [Camel (camel-1) thread #2 - KafkaConsumer[foobarTopic]] | o.a.c.c.kafka.KafkaFetchRecords (KafkaFetchRecords.java:340) | &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; polling iteration is using lastresult with partition 1 and offset 1 
...
2023-11-06 | 10:23:15.871 | DEBUG | [Camel (camel-1) thread #2 - KafkaConsumer[foobarTopic]] | o.a.c.c.k.c.s.KafkaRecordProcessor (KafkaRecordProcessor.java:68) | setting up the exchange &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; message from partition 0 and offset 3
...
2023-11-06 | 10:23:15.881 | DEBUG | [Camel (camel-1) thread #2 - KafkaConsumer[foobarTopic]] | o.a.c.c.k.c.s.KafkaRecordProcessor (KafkaRecordProcessor.java:118) | an exception was thrown &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; record at partition 0 and offset 3
2023-11-06 | 10:23:15.881 | WARN&#160; | [Camel (camel-1) thread #2 - KafkaConsumer[foobarTopic]] | o.a.c.c.k.c.s.KafkaRecordProcessor (KafkaRecordProcessor.java:122) | about to process an exception with UNEXPECTED offset 1 on partition 1 was expecting offset 3 on partition 0&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Then &lt;em&gt;KafkaRecordProcessor&lt;/em&gt; will call &lt;em&gt;processException&lt;/em&gt; and call &lt;em&gt;commitManager.forceCommit.&lt;/em&gt; This __ uses the values in lastResult.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2023-11-06 | 10:23:15.881 | WARN &#160;| [Camel (camel-1) thread #2 - KafkaConsumer[foobarTopic]] | o.a.c.c.k.c.s.KafkaRecordProcessor (KafkaRecordProcessor.java:144) | Will seek consumer to offset 1 on partition 1 and start polling again. &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;b&gt;At this point the consumer is pointing in the wrong place as&lt;/b&gt; &lt;b&gt;partition 0 is moved back to offset 1&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;After Camel unsubscribes and then reconnects we find this on thread #3 (which was assigned partition 0)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2023-11-06 | 10:23:18.553 | TRACE | [Camel (camel-1) thread #3 - KafkaConsumer[foobarTopic]] | o.a.c.c.k.c.s.KafkaRecordProcessorFacade (KafkaRecordProcessorFacade.java:140) | Partition = 0, offset = 2, key = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, value = 6
2023-11-06 | 10:23:18.553 | DEBUG | [Camel (camel-1) thread #3 - KafkaConsumer[foobarTopic]] | o.a.c.c.k.c.s.KafkaRecordProcessor (KafkaRecordProcessor.java:68) | setting up the exchange &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; message from partition 0 and offset 2
 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;At this point all of the messages on partition 0 will be reprocessed&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;It appears that when the initial errors (&lt;em&gt;breakOnFirstError&lt;/em&gt;) occurred that thread #2 never had lastResult set back to null (which seems it should have if &lt;em&gt;KafkaFetchRecords&lt;/em&gt; broke out of its loop in &lt;em&gt;startPolling.&lt;/em&gt;&#160; However, I didn&apos;t see the following log for &lt;em&gt;KafkaFetchRecords&lt;/em&gt; for that thread as I did for threads 1 and 3.&lt;/p&gt;

&lt;p&gt;thread 1&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2023-11-06 | 10:23:12.789 | INFO &#160;| [Camel (camel-1) thread #1 - KafkaConsumer[foobarTopic]] | o.a.c.c.kafka.KafkaFetchRecords (KafkaFetchRecords.java:250) | Reconnecting Kafka consumer thread ID foobarTopic-&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; 0 with poll timeout of 5000 ms
...
2023-11-06 | 10:23:12.808 | TRACE | [Camel (camel-1) thread #1 - KafkaConsumer[foobarTopic]] | o.a.c.c.kafka.KafkaFetchRecords (KafkaFetchRecords.java:320) | Polling foobarTopic-&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; 0 from topic foobarTopic with timeout: 5000


&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;thread 3&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2023-11-06 | 10:23:12.789 | INFO &#160;| [Camel (camel-1) thread #3 - KafkaConsumer[foobarTopic]] | o.a.c.c.kafka.KafkaFetchRecords (KafkaFetchRecords.java:250) | Reconnecting Kafka consumer thread ID foobarTopic-&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; 2 with poll timeout of 5000 ms&#160;
...
2023-11-06 | 10:23:12.809 | TRACE | [Camel (camel-1) thread #3 - KafkaConsumer[foobarTopic]] | o.a.c.c.kafka.KafkaFetchRecords (KafkaFetchRecords.java:320) | Polling foobarTopic-&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; 2 from topic foobarTopic with timeout: 5000&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;the only entry for thread 2 at this time was&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2023-11-06 | 10:23:15.339 | DEBUG | [Camel (camel-1) thread #2 - KafkaConsumer[foobarTopic]] | o.a.c.c.k.consumer.NoopCommitManager (NoopCommitManager.java:42) | Auto commit to offset foobarTopic-&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; 1 from topic foobarTopic is disabled (NO-OP) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;this suggests it never was unsubscribed. But not totally sure.&#160;&lt;/p&gt;

&lt;p&gt;I attached the log for this test run (camel-kafka-offset.11-06-2023.log)&lt;br/&gt;
I can create a PR with the extra logging.&#160;&lt;/p&gt;

&lt;p&gt;I am willing to try and patch this, but wanted to make sure had a path forward as to what to change.&lt;/p&gt;

&lt;p&gt;Some thoughts:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;don&apos;t use current Camel retry attempt when breakOnFirstError and manualCommit are both true&#160;
	&lt;ul&gt;
		&lt;li&gt;this won&apos;t fix the problem but will let consumer handle offset committing&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;when UNEXPECTED occurs&#160;
	&lt;ul&gt;
		&lt;li&gt;can avoid the force commit&#160;&lt;/li&gt;
		&lt;li&gt;can force commit but not sure what else to use except the current record values
		&lt;ul&gt;
			&lt;li&gt;this seems like the right way to go&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;other?
	&lt;ul&gt;
		&lt;li&gt;open to suggestions&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17783355" author="g1antfan" created="Mon, 6 Nov 2023 19:53:18 +0000"  >&lt;p&gt;In the &lt;em&gt;KafkaRecordProcessor&lt;/em&gt; it seems that using &lt;em&gt;record.offset&lt;/em&gt; for the forceCommit is avoiding the problem in this issue (line #158 in PR)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;note: can still result in the &lt;em&gt;lastResult&lt;/em&gt; being wrong (as described above) but now we are not using it to force a commit
	&lt;ul&gt;
		&lt;li&gt;when &lt;em&gt;lastResult&lt;/em&gt; is wrong then the message with the error is tried more than 1x&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;if we go with this fix, may want to evaluate whether we need to pass along &lt;em&gt;IastResult&lt;/em&gt;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;that was added as part of fix in &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-18350&quot; title=&quot;camel-kafka: enabling &amp;quot;breakOnFirstError&amp;quot; causes camel to reconsume all records on error&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-18350&quot;&gt;&lt;del&gt;CAMEL-18350&lt;/del&gt;&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;UPDATE: I ran the sample provided with &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-19894&quot; title=&quot;camel-kafka: enabling &amp;quot;breakOnFirstError&amp;quot; causes to skip records on exception&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-19894&quot;&gt;&lt;del&gt;CAMEL-19894&lt;/del&gt;&lt;/a&gt;&lt;/em&gt;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;em&gt;ran 2x without the fix and test failed&lt;/em&gt;&lt;/li&gt;
	&lt;li&gt;&lt;em&gt;ran 3x with this fix and passed each time&lt;/em&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17783555" author="orpiske" created="Tue, 7 Nov 2023 10:00:12 +0000"  >&lt;p&gt;Adding likely related issues.&lt;/p&gt;</comment>
                            <comment id="17783558" author="orpiske" created="Tue, 7 Nov 2023 10:06:27 +0000"  >&lt;p&gt;Also created a task for future investigations related to how we can improve the behavior/feature set related to breakOnFirstError, as as there are multiple requests for it (sometimes conflicting requests): &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-20089&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CAMEL-20089&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17783622" author="g1antfan" created="Tue, 7 Nov 2023 13:13:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=orpiske&quot; class=&quot;user-hover&quot; rel=&quot;orpiske&quot;&gt;orpiske&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;Would you like me to create a PR with the fix?&lt;br/&gt;
The current PR is just the logging and the fix is commented out for now.&lt;/p&gt;


&lt;p&gt;It seems this helps w/ 2 existing issues and at our company there is some concern about moving some applications forward w/ this issue.&lt;/p&gt;

&lt;p&gt;It will take me some time to get adequate tests in place.&lt;br/&gt;
I had been doing local builds and running my mini app as well as the app from the other issue&lt;/p&gt;

&lt;p&gt;I am happy to take a look at some of the other ways &lt;em&gt;breakOnFirstError&lt;/em&gt; could work as well&lt;/p&gt;</comment>
                            <comment id="17783671" author="g1antfan" created="Tue, 7 Nov 2023 15:25:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=orpiske&quot; class=&quot;user-hover&quot; rel=&quot;orpiske&quot;&gt;orpiske&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;QQ&lt;br/&gt;
Was trying to get integration test up and running for the fix&lt;br/&gt;
However, it seems that the IT in Camel are using test containers .&#160;&lt;/p&gt;


&lt;p&gt;&lt;a href=&quot;https://java.testcontainers.org/error_missing_container_runtime_environment/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://java.testcontainers.org/error_missing_container_runtime_environment/&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Unfortunately, my employer doesn&apos;t allow us to use Docker Desktop.&#160;&lt;br/&gt;
We are using Podman. I&apos;ve tried to get that working but keep getting &quot;Container startup failed&quot;&lt;/p&gt;

&lt;p&gt;Any issue with using Spring&apos;s &lt;em&gt;EmbeddedKafka?&lt;/em&gt;&lt;br/&gt;
That is what several of the sample apps have used to demonstrate the issues&lt;/p&gt;</comment>
                            <comment id="17783698" author="orpiske" created="Tue, 7 Nov 2023 16:48:27 +0000"  >&lt;p&gt;That&apos;s strange: I am a podman user myself and it works just fine. &lt;/p&gt;

&lt;p&gt;At the moment we would rather avoid Spring&apos;s Embedded Kafka.&lt;/p&gt;</comment>
                            <comment id="17783702" author="orpiske" created="Tue, 7 Nov 2023 16:59:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=g1antfan&quot; class=&quot;user-hover&quot; rel=&quot;g1antfan&quot;&gt;g1antfan&lt;/a&gt; BTW, if you are having some troubles with the Kafka tests, feel free to reach out on the Zulip chat. It should be fine, in general, but if you are having specific problems we can try to advise. &lt;/p&gt;</comment>
                            <comment id="17788070" author="orpiske" created="Mon, 20 Nov 2023 16:15:08 +0000"  >&lt;p&gt;The issue was resolved with the fixes provided by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=g1antfan&quot; class=&quot;user-hover&quot; rel=&quot;g1antfan&quot;&gt;g1antfan&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13557008">CAMEL-20089</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13561844">CAMEL-20235</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13299838">CAMEL-14935</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13438389">CAMEL-17925</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13475171">CAMEL-18350</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13505916">CAMEL-18760</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13551455">CAMEL-19894</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13064214" name="camel-kafka-offset.11-06-2023.log" size="176801" author="g1antfan" created="Mon, 6 Nov 2023 16:58:51 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 51 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1l5uo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>