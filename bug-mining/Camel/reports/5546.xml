<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:44:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-15928] TimeoutException does not trigger Resilience4j circuit breaker</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-15928</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;Currently Timeout exceptions does not trigger circuit breaker. But they should. I don&apos;t want to continue spam my server, if it slightly started dying.&lt;/p&gt;

&lt;p&gt;I tried to hot-fix in the next way -&#160;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13016698/13016698_hot_fix.diff&quot; title=&quot;hot_fix.diff attached to CAMEL-15928&quot;&gt;hot_fix.diff&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;The idea behind patch is next. Currently we wrap our call with circuit breaker and only after that with time limiter. So, circuit breaker doesn&apos;t know anything about time-outs.&#160;&lt;/p&gt;

&lt;p&gt;And basically I do opposite - initially wrap call with time limiter and only after that, wrap it with circuit breaker. So circuit breaker will aware about time-out exception and can react properly.&lt;/p&gt;

&lt;p&gt;The issue which I have afterward, that, for cases when circuit breaker was open, I started receiving blank 200 OK response.&lt;/p&gt;

&lt;p&gt;I tried to fix it by removing recover(fallbackTask) part at all:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// Try.ofCallable(task).recover(fallbackTask).andFinally(() -&amp;gt; callback.done(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)).get(); //old code
&lt;/span&gt;Try.ofCallable(task).andFinally(() -&amp;gt; callback.done(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)).get(); &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; line of code&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;And seems like it works fine. But tests are failing, and I&apos;m not sure how exactly it should be fixed.&#160;&lt;/p&gt;

&lt;p&gt;Also another fix, which seems like works fine and tests are not failing:&lt;/p&gt;

&lt;p&gt;CircuitBreakerFallbackTask&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (throwable &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; CallNotPermittedException) {
    &lt;span class=&quot;code-comment&quot;&gt;// the circuit breaker triggered a call rejected
&lt;/span&gt;    exchange.setProperty(CircuitBreakerConstants.RESPONSE_SUCCESSFUL_EXECUTION, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
    exchange.setProperty(CircuitBreakerConstants.RESPONSE_FROM_FALLBACK, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
    exchange.setProperty(CircuitBreakerConstants.RESPONSE_SHORT_CIRCUITED, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
    exchange.setProperty(CircuitBreakerConstants.RESPONSE_REJECTED, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
    &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; RuntimeExchangeException.wrapRuntimeException(throwable); &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; line of code
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;//&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; exchange; // old code&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Please, assist.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13344853">CAMEL-15928</key>
            <summary>TimeoutException does not trigger Resilience4j circuit breaker</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="Liroyd">Alex Liroyd</reporter>
                        <labels>
                    </labels>
                <created>Tue, 8 Dec 2020 14:53:04 +0000</created>
                <updated>Wed, 23 Dec 2020 09:47:53 +0000</updated>
                            <resolved>Wed, 23 Dec 2020 08:32:06 +0000</resolved>
                                    <version>3.4.4</version>
                                    <fixVersion>3.7.1</fixVersion>
                    <fixVersion>3.4.6</fixVersion>
                    <fixVersion>3.8.0</fixVersion>
                                    <component>came-core</component>
                    <component>eip</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17246298" author="davsclaus" created="Wed, 9 Dec 2020 06:00:48 +0000"  >&lt;p&gt;How do you wrap your call with timeout, eg show us what you do&lt;/p&gt;</comment>
                            <comment id="17246300" author="liroyd" created="Wed, 9 Dec 2020 06:10:54 +0000"  >&lt;p&gt;Did you mean, how to reproduce?&lt;/p&gt;

&lt;p&gt;Currently I have simple camel route&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-xml&quot;&gt;
&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;circuitBreaker configurationRef=&lt;span class=&quot;code-quote&quot;&gt;&quot;{{myName}}&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
       &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;to uri=&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:someUri&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/circuitBreaker&amp;gt;&lt;/span&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In config, I have timeout:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Resilience4jConfigurationDefinition config = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Resilience4jConfigurationDefinition();
config.circuitBreakerRef(cbName)
        .timeoutEnabled(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
        .timeoutDuration(100)
        .timeoutCancelRunningFuture(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;If you ment, how did I fix it, then please check attached patch&#160;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13016698/13016698_hot_fix.diff&quot; title=&quot;hot_fix.diff attached to CAMEL-15928&quot;&gt;hot_fix.diff&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;sup&gt;Note: fix for fallback is not included.&lt;/sup&gt;&lt;/p&gt;</comment>
                            <comment id="17246417" author="davsclaus" created="Wed, 9 Dec 2020 10:17:57 +0000"  >&lt;p&gt;Okay so you want in case of a timeout, the fallback task to not run? On top of my head a fallback is only run if you have &amp;lt;onFallback&amp;gt; in the route, and you do not have that.&lt;/p&gt;

&lt;p&gt;Or do you say that only if there is a timeout exception than skip any kind of fallback and fail the call? &lt;/p&gt;</comment>
                            <comment id="17246431" author="liroyd" created="Wed, 9 Dec 2020 10:38:01 +0000"  >&lt;p&gt;I don&apos;t have fallback for my particular case, but I have routes with fallback in general. And it somehow supposed to work.&lt;/p&gt;

&lt;p&gt;What I&apos;m saying, that time-out exception should trigger circuit breaker,&#160;regardless of existence of fallback.&#160;&lt;/p&gt;

&lt;p&gt;If in my route I have fallback configuration and time-out exception occurred, I would expect next behavior:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Circuit breaker counter should be increased (added one more failed call to statistic)&lt;/li&gt;
	&lt;li&gt;Fallback logic should be executed&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17246438" author="liroyd" created="Wed, 9 Dec 2020 10:41:59 +0000"  >&lt;p&gt;From the other side, it also should depends on which level fallback is configured. Later on will come up with examples&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17246629" author="liroyd" created="Wed, 9 Dec 2020 15:59:28 +0000"  >&lt;p&gt;E.g. Case#1:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-xml&quot;&gt;
&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;route id=&lt;span class=&quot;code-quote&quot;&gt;&quot;routeName&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
   &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;circuitBreaker configurationRef=&lt;span class=&quot;code-quote&quot;&gt;&quot;{{config}}&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
       &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;to uri=&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:route1&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
       &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;onFallback&amp;gt;&lt;/span&gt;
           &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;to uri=&lt;span class=&quot;code-quote&quot;&gt;&quot;route2&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
       &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/onFallback&amp;gt;&lt;/span&gt;
   &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/circuitBreaker&amp;gt;&lt;/span&gt;
&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/route&amp;gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Time-out configuration should be applied to both &amp;lt;to uri&amp;gt; and &amp;lt;onFallback&amp;gt; logic. So, if I set 10sec for time-out, it doesn&apos;t matter on which step I&apos;m currently on, execution should be interrupted.&lt;/p&gt;

&lt;p&gt;E.g. &amp;gt;10 sec on main uri = interrupt.&lt;/p&gt;

&lt;p&gt;5 sec on&#160; main uri + &amp;gt;5sec on fallback = interrupt.&lt;/p&gt;

&lt;p&gt;Case#2&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-xml&quot;&gt;
&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;route id=&lt;span class=&quot;code-quote&quot;&gt;&quot;routeName&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
   &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;circuitBreaker configurationRef=&lt;span class=&quot;code-quote&quot;&gt;&quot;{{config}}&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;to uri=&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:route#1&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
   &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/circuitBreaker&amp;gt;&lt;/span&gt;
   &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;onFallback&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;to uri=&lt;span class=&quot;code-quote&quot;&gt;&quot;rout#2&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
   &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/onFallback&amp;gt;&lt;/span&gt;
&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/route&amp;gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;If time-out exception, onFallback should be still executed, because it&apos;s outside of time-out configuration&lt;/p&gt;

&lt;p&gt;E.g. Case#3:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-xml&quot;&gt;
&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;route id=&lt;span class=&quot;code-quote&quot;&gt;&quot;routeName&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
   &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;circuitBreaker configurationRef=&lt;span class=&quot;code-quote&quot;&gt;&quot;{{config}}&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
       &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;to uri=&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:route1&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
   &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/circuitBreaker&amp;gt;&lt;/span&gt;
&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/route&amp;gt;&lt;/span&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Current case from ticket - no fallback, time-out applied to main uri.&lt;/p&gt;

&lt;p&gt;Note: I didn&apos;t test first two cases, but based on xml definition, they should work.&lt;/p&gt;</comment>
                            <comment id="17246636" author="davsclaus" created="Wed, 9 Dec 2020 16:07:29 +0000"  >&lt;p&gt;I would actually not think this is how circuit breakers work. The timeout is on the normal task, the fallback runs indepently and is not under timeout or the likes. The goal of the fallback is to do some simpler task that you can use instead, such as returning a fixed response, or last known good response (from a cache) or something.&lt;/p&gt;</comment>
                            <comment id="17246652" author="liroyd" created="Wed, 9 Dec 2020 16:28:11 +0000"  >&lt;p&gt;Currently we have logic like, go to the system#1, on fallback go to the system#2. Both calls should be wrapped in different circuit breakers. So, fallback in my case could take a while.&lt;/p&gt;

&lt;p&gt;Moreover, I would like to have one time-out for operation itself (e.g. 10 sec for this route in total) and separate time-outs for each of its parts. Not sure, how it should be properly configured.&lt;/p&gt;</comment>
                            <comment id="17249774" author="liroyd" created="Tue, 15 Dec 2020 16:15:23 +0000"  >&lt;p&gt;Any suggestions, how fallback issue can be solved? I would gladly provide PR for this, but not sure how to fix it correctly.&lt;/p&gt;</comment>
                            <comment id="17251773" author="liroyd" created="Fri, 18 Dec 2020 13:53:45 +0000"  >&lt;p&gt;Hello, I did a small investigation, and I want to insist that it&apos;s a critical bug and not a major improvement&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Regarding initial issues - resilience4J provides ability to select explicitly, which errors should trigger circuit breaker and which should not.&#160;&lt;/p&gt;

&lt;p&gt;And you can specify TimeoutException as one of those. And it works perfectly, when using pure resilience4J. If you specifies TimeoutException, it will trigger CB, if no, then no.&lt;/p&gt;

&lt;p&gt;Camel-resilience4j also provides ability to select list off exceptions. But it&apos;s not possible to select TimeoutException as one for triggering CB. Yes, you can provide it for config, but camel itself will never treat it correctly.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;And I found another issue with fallback.&lt;/b&gt; Basically fallback for such camel routes will be executed only in one case - yes, only in case of TimeoutException. Example:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&amp;lt;route id=&lt;span class=&quot;code-quote&quot;&gt;&quot;myROute&quot;&lt;/span&gt;&amp;gt;
    &amp;lt;from uri=&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:myURI&quot;&lt;/span&gt;/&amp;gt;
    &amp;lt;circuitBreaker configurationRef=&lt;span class=&quot;code-quote&quot;&gt;&quot;{{myConfig}}&quot;&lt;/span&gt;&amp;gt;
        &amp;lt;to uri=&lt;span class=&quot;code-quote&quot;&gt;&quot;myExecutionRoute&quot;&lt;/span&gt;/&amp;gt;
        &amp;lt;onFallback&amp;gt;
            &amp;lt;bean method=&lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt; ref=&lt;span class=&quot;code-quote&quot;&gt;&quot;myFallbackBean&quot;&lt;/span&gt;/&amp;gt;
        &amp;lt;/onFallback&amp;gt;
    &amp;lt;/circuitBreaker&amp;gt;
&amp;lt;/route&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;For such configuration, onFallback will be executed only when we receive TimeoutException.&lt;/p&gt;

&lt;p&gt;The rootcause for both issue is the same - currently ResilienceProcessor wraps task CB first, and only after that wraps it in TimeLimiter.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Regarding fallback - currently it&apos;s called like:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Try.ofCallable(task).recover(fallbackTask).andFinally(() -&amp;gt; callback.done(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)).get();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;recover&lt;/em&gt; executes &lt;em&gt;fallback&lt;/em&gt; only if - &lt;em&gt;this.isFailure()&lt;/em&gt;,&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Try.ofCallable(task)&lt;/em&gt; returns &lt;em&gt;Failure&lt;/em&gt; only for TimeoutExceptions. &lt;del&gt;All other exceptions will be catched by&#160;&lt;em&gt;MethodInfo#MethodInvocation#proceed&lt;/em&gt; - therefore it will be success for every other exception.&lt;/del&gt; Updated: see my last comment regarding rootcause.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I will try to find a solution, but any help would be&#160;appreciable.&lt;/p&gt;</comment>
                            <comment id="17251979" author="liroyd" created="Fri, 18 Dec 2020 19:59:45 +0000"  >&lt;p&gt;Please check attached patch:&#160;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13017392/13017392_camel_fix_for_fallback.diff&quot; title=&quot;camel_fix_for_fallback.diff attached to CAMEL-15928&quot;&gt;camel_fix_for_fallback.diff&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Some explanation for fix:&lt;/b&gt;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;The idea is the same : wrap in time-out, then wrap in circuit-breaker&lt;/li&gt;
	&lt;li&gt;I had to remove - CircuitBreakerTimeoutTask, because fallback was not triggered for regular exceptions&lt;/li&gt;
	&lt;li&gt;processInCopy - it&apos;s just copy-paste, what u had in task&lt;/li&gt;
	&lt;li&gt;throw exception is added to fallback(where we don&apos;t have registered any fallback)&lt;br/&gt;
 throw RuntimeExchangeException.wrapRuntimeException(throwable);&lt;br/&gt;
 because, otherwise for case when CB is OPEN, I would not able to receive target exception as result of route execution&lt;br/&gt;
 Note: probably&#160;//exchange.setException(throwable); would be enough, but in this case&#160;ResilienceRouteRejectedTest is failing, and I decided to not touch it&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;That&apos;s pretty much it.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Cases which tested:&lt;/b&gt;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;No fallback configured:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&amp;lt;route id=&lt;span class=&quot;code-quote&quot;&gt;&quot;myRoute&quot;&lt;/span&gt;&amp;gt;
    &amp;lt;from uri=&lt;span class=&quot;code-quote&quot;&gt;&quot;myRouteID&quot;&lt;/span&gt;/&amp;gt;
    &amp;lt;circuitBreaker configurationRef=&lt;span class=&quot;code-quote&quot;&gt;&quot;{{myCB}}&quot;&lt;/span&gt;&amp;gt;
        &amp;lt;to uri=&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:myExecute&quot;&lt;/span&gt;/&amp;gt;
    &amp;lt;/circuitBreaker&amp;gt;
&amp;lt;/route&amp;gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
	&lt;ol&gt;
		&lt;li&gt;Throw exception, which is not in &quot;recordException&quot; for CB&lt;br/&gt;
 AR=ER - received exception on client, CB is not triggered&lt;/li&gt;
		&lt;li&gt;Throw exception, which is in &quot;recordException&quot; for CB&lt;br/&gt;
 AR=ER - received exception on client, CB is triggered&#160;&lt;br/&gt;
 AR2=ER2 - if CB is open - get CB open exception right away&lt;/li&gt;
		&lt;li&gt;Set time-out
		&lt;ol&gt;
			&lt;li&gt;If time-out exception is in recorded for CB&lt;br/&gt;
 AR=ER CB is triggered&lt;/li&gt;
			&lt;li&gt;if time-out is not in recorded for CB&lt;br/&gt;
 AR=ER CB is not triggered&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
	&lt;li&gt;Fallback is configured:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&amp;lt;route id=&lt;span class=&quot;code-quote&quot;&gt;&quot;myRoute&quot;&lt;/span&gt;&amp;gt;
    &amp;lt;from uri=&lt;span class=&quot;code-quote&quot;&gt;&quot;myRouteID&quot;&lt;/span&gt;/&amp;gt;
    &amp;lt;circuitBreaker configurationRef=&lt;span class=&quot;code-quote&quot;&gt;&quot;{{myCB}}&quot;&lt;/span&gt;&amp;gt;
        &amp;lt;to uri=&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:myExecute&quot;&lt;/span&gt;/&amp;gt;
        &amp;lt;onFallback&amp;gt;
            &amp;lt;bean method=&lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt; ref=&lt;span class=&quot;code-quote&quot;&gt;&quot;myFallback&quot;&lt;/span&gt;/&amp;gt;
        &amp;lt;/onFallback&amp;gt;
    &amp;lt;/circuitBreaker&amp;gt;
&amp;lt;/route&amp;gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
	&lt;ol&gt;
		&lt;li&gt;Throw exception, which is not in &quot;recordException&quot; for CB&lt;br/&gt;
 AR=ER - CB is not triggered. Fallback executed&lt;/li&gt;
		&lt;li&gt;Throw exception, which is in &quot;recordException&quot; for CB&lt;br/&gt;
 AR=ER - CB is triggered. Fallback is executed&lt;br/&gt;
 AR2=ER2 - if CB is open - initial call falls right away without any execution + fallback is executed&lt;/li&gt;
		&lt;li&gt;Set time-out
		&lt;ol&gt;
			&lt;li&gt;If time-out exception is in recorded for CB&lt;br/&gt;
 AR=ER CB is triggered + fallback is executed&lt;/li&gt;
			&lt;li&gt;if time-out is not in recorded for CB&lt;br/&gt;
 AR=ER CB is not triggered, fallback is executed&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Note: so basically fallback is executed for every case&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt;, please check patch and my explanation.&lt;/p&gt;

&lt;p&gt;I really need this fix in 3.4.5. I will be able to create PR on Monday. Just take a look, and say, what do you think. I basically tested all existing cases + change itself is not really huge.&lt;/p&gt;</comment>
                            <comment id="17252776" author="liroyd" created="Mon, 21 Dec 2020 11:13:54 +0000"  >&lt;p&gt;I wanted to write a test, which proofs my patch, and I was surprised, that there are already tests, which actually works. E.g. for fallback ResilienceRouteFallbackTest.&lt;br/&gt;
 And now I finally found a rootcause. In my previous comment I wrote:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;All other exceptions will be catched by MethodInfo#MethodInvocation#proceed - therefore it will be success for every other exception.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;It&apos;s not quite correct. All other exceptions will be catched by CircuitBreakerTimeoutTask&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Exchange get() {
            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;future&lt;/span&gt;.call();
            } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
                exchange.setException(e);
            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;And &lt;em&gt;Try.ofCallable(task)&lt;/em&gt; will return true.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;The reason, why tests aren&apos;t failing,&lt;/b&gt; that almost all of them are executed without time-out configuration, e.g.:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
.circuitBreaker().inheritErrorHandler(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;).to(&lt;span class=&quot;code-quote&quot;&gt;&quot;mock:a&quot;&lt;/span&gt;).throwException(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IllegalArgumentException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Forced&quot;&lt;/span&gt;)).end().to(&lt;span class=&quot;code-quote&quot;&gt;&quot;log:result&quot;&lt;/span&gt;).to(&lt;span class=&quot;code-quote&quot;&gt;&quot;mock:result&quot;&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;So, code is not wrapped in CircuitBreakerTimeoutTask, which catches exception:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (timeLimiterConfig != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            &lt;span class=&quot;code-comment&quot;&gt;// timeout handling is more complex with thread-pools
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; CircuitBreakerTimeoutTask timeoutTask = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CircuitBreakerTimeoutTask(task, exchange);
            Supplier&amp;lt;CompletableFuture&amp;lt;Exchange&amp;gt;&amp;gt; futureSupplier;
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I basically added time-outs to every test -&#160;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13017465/13017465_failed_tests_with_time_out.patch&quot; title=&quot;failed_tests_with_time_out.patch attached to CAMEL-15928&quot;&gt;failed_tests_with_time_out.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;, and now,&#160;as I expected, 4 of them are failing (actually 5 - SpringResilienceRouteFallbackTest - will also fail -after changing it in spring config):&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13017466/13017466_image-2020-12-21-13-10-40-893.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Stack Trace is attached -&#160;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13017467/13017467_test_errors_stackTrace.txt&quot; title=&quot;test_errors_stackTrace.txt attached to CAMEL-15928&quot;&gt;test_errors_stackTrace.txt&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;With my patch all tested executed successfully. Hope, the issue is clear now and I am waiting for you comment&lt;/p&gt;</comment>
                            <comment id="17252952" author="liroyd" created="Mon, 21 Dec 2020 16:27:23 +0000"  >&lt;p&gt;Please check &lt;a href=&quot;https://github.com/apache/camel/pull/4809&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/4809&lt;/a&gt;&#160;for 3.4.x. If everything is ok, I will create separate for master.&lt;/p&gt;</comment>
                            <comment id="17253017" author="liroyd" created="Mon, 21 Dec 2020 17:59:46 +0000"  >&lt;p&gt;PR for master -&#160;&lt;a href=&quot;https://github.com/apache/camel/pull/4810&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/4810&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17253954" author="davsclaus" created="Wed, 23 Dec 2020 08:32:37 +0000"  >&lt;p&gt;Thanks for the detailed analysis and the PRs to fix this on our branches.&lt;/p&gt;</comment>
                            <comment id="17253958" author="liroyd" created="Wed, 23 Dec 2020 08:47:28 +0000"  >&lt;p&gt;You are welcome. Is there any way, how I can get it in 3.4.5?&lt;/p&gt;</comment>
                            <comment id="17253999" author="davsclaus" created="Wed, 23 Dec 2020 09:47:53 +0000"  >&lt;p&gt;No 3.4.5 was built before and will be released today&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13017392" name="camel_fix_for_fallback.diff" size="8207" author="Liroyd" created="Fri, 18 Dec 2020 19:02:17 +0000"/>
                            <attachment id="13017465" name="failed_tests_with_time_out.patch" size="11720" author="Liroyd" created="Mon, 21 Dec 2020 11:09:53 +0000"/>
                            <attachment id="13016698" name="hot_fix.diff" size="1628" author="Liroyd" created="Tue, 8 Dec 2020 14:22:44 +0000"/>
                            <attachment id="13017466" name="image-2020-12-21-13-10-40-893.png" size="32912" author="Liroyd" created="Mon, 21 Dec 2020 11:10:41 +0000"/>
                            <attachment id="13017467" name="test_errors_stackTrace.txt" size="24356" author="Liroyd" created="Mon, 21 Dec 2020 11:11:44 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 47 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0lbbc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>