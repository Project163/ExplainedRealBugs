<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:57:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-18275] onCompletion tasks don&apos;t get executed in a pipeline with several SEDA queues</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-18275</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;I stumbled upon a problem with not working &lt;tt&gt;onCompletion&lt;/tt&gt; between the routes that pass a message over SEDA queues.&lt;/p&gt;

&lt;p&gt;The route configuration is similar to this simplified version:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
from(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:a&quot;&lt;/span&gt;)
  .onCompletion().log(&lt;span class=&quot;code-quote&quot;&gt;&quot;a - done&quot;&lt;/span&gt;).end()
  .to(&lt;span class=&quot;code-quote&quot;&gt;&quot;seda:b&quot;&lt;/span&gt;);

from(&lt;span class=&quot;code-quote&quot;&gt;&quot;seda:b&quot;&lt;/span&gt;)
  .onCompletion().log(&lt;span class=&quot;code-quote&quot;&gt;&quot;b - done&quot;&lt;/span&gt;).end()
  .to(&lt;span class=&quot;code-quote&quot;&gt;&quot;seda:c&quot;&lt;/span&gt;);

from(&lt;span class=&quot;code-quote&quot;&gt;&quot;seda:c&quot;&lt;/span&gt;)
  .onCompletion().log(&lt;span class=&quot;code-quote&quot;&gt;&quot;c - done&quot;&lt;/span&gt;).end()
  .to(&lt;span class=&quot;code-quote&quot;&gt;&quot;seda:d&quot;&lt;/span&gt;);

from(&lt;span class=&quot;code-quote&quot;&gt;&quot;seda:d&quot;&lt;/span&gt;)
  .onCompletion().log(&lt;span class=&quot;code-quote&quot;&gt;&quot;d - done&quot;&lt;/span&gt;).end()
  .to(&lt;span class=&quot;code-quote&quot;&gt;&quot;mock:end&quot;&lt;/span&gt;); &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;With this configuration, I get only &lt;tt&gt;&quot;d - done&quot;&lt;/tt&gt; logging.&lt;/p&gt;

&lt;p&gt;I debugged the execution and noticed that the &lt;tt&gt;onCompletion&lt;/tt&gt; handler from &quot;a&quot;, &quot;b&quot;, and &quot;c&quot; don&apos;t get executed because they are route-scoped and get attempted to be executed in the scope of the next route.&lt;/p&gt;

&lt;p&gt;This happens because they get handed over from the initial exchange to an exchange prepared for the next route. It happens in the &lt;tt&gt;SedaProducer::addToQueue&lt;/tt&gt; method with &lt;tt&gt;copy&lt;/tt&gt;parameter defined as &lt;tt&gt;true&lt;/tt&gt;, which makes the &lt;tt&gt;::prepareCopy&lt;/tt&gt; method being called, which in its turn calls &lt;tt&gt;ExchangeHelper.createCorrelatedCopy&lt;/tt&gt; with &lt;tt&gt;handover&lt;/tt&gt; defined as &lt;tt&gt;true&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;It seems to me like a bug, because looking at the routes configuration I&apos;d expect different behavior: all the &lt;tt&gt;onCompletion&lt;/tt&gt; tasks get executed reporting on routes finalization. Though maybe I&apos;m missing something here, and if this is the case then I would appreciate you guys helping me to find out the missing details.&lt;/p&gt;

&lt;p&gt;Here is a &lt;a href=&quot;https://gist.github.com/Gems/7555776feae619ac71ed8d9dd9d4d33e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;unit test reproducing the problem&lt;/a&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13471925">CAMEL-18275</key>
            <summary>onCompletion tasks don&apos;t get executed in a pipeline with several SEDA queues</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="klease78">Karen Lease</assignee>
                                    <reporter username="Gomoliako">Eduard Gomoliako</reporter>
                        <labels>
                    </labels>
                <created>Sun, 17 Jul 2022 15:05:15 +0000</created>
                <updated>Sat, 24 Dec 2022 21:46:44 +0000</updated>
                            <resolved>Thu, 4 Aug 2022 16:09:42 +0000</resolved>
                                    <version>3.18.0</version>
                                    <fixVersion>3.19.0</fixVersion>
                                    <component>came-core</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17568429" author="JIRAUSER292949" created="Tue, 19 Jul 2022 08:57:52 +0000"  >&lt;p&gt;I&apos;d love to contribute and provide a PR with the solution, and I&apos;d need some input.&lt;/p&gt;

&lt;p&gt;In particular, I&apos;d like to learn what was the design idea by making `SedaProducer` handing over competitions to the exchange cope passed to the SEDA route.&lt;/p&gt;</comment>
                            <comment id="17568592" author="klease78" created="Tue, 19 Jul 2022 14:36:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Gomoliako&quot; class=&quot;user-hover&quot; rel=&quot;Gomoliako&quot;&gt;Gomoliako&lt;/a&gt; According to the &lt;a href=&quot;https://camel.apache.org/components/3.18.x/seda-component.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;documentation&lt;/a&gt; you can change this behavior with the option &lt;b&gt;waitForTaskToComplete=always.&lt;/b&gt;&lt;br/&gt;
This is handled in the &lt;a href=&quot;https://github.com/apache/camel/blob/bf06cd9533ebd0d3ed5472e4fd6bd6095f317339/components/camel-seda/src/main/java/org/apache/camel/component/seda/SedaProducer.java#L62-L66&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;SedaProducer.&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Using this option, all the messages in your onCompletion handlers are logged. But this is probably not what you want. I would agree that the completions should be executed in any case.&lt;/p&gt;

&lt;p&gt;I believe the root cause is that the method UnitOfWork.afterRoute() finds no Synchronizations on the UnitOfWork so the onAfterRoute() method is not called for the Synchronizations (i.e. the completions) which were handed over and then removed from the original UoW. This method is what updates the property ExchangePropertyKey.ON_COMPLETION_ROUTE_IDS to remember all the routes which have been visited by the Exchange. If this contains all the route Ids, then the completion methods are all executed even when they are all called when the last route is completed.&lt;/p&gt;

&lt;p&gt;I have an idea to address this, and will submit a PR for review by Camel gurus.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17568694" author="JIRAUSER292949" created="Tue, 19 Jul 2022 19:10:25 +0000"  >&lt;p&gt;Thank you for your response. I&apos;ll try the `waitForTaskToComplete` options and see if any of the corresponding behaviors suit the requirements I got.&lt;/p&gt;

&lt;p&gt;I&apos;d appreciate it if you share a link to the PR once you have it.&lt;/p&gt;</comment>
                            <comment id="17651800" author="bvahdat" created="Sat, 24 Dec 2022 16:27:19 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=klease78&quot; class=&quot;user-hover&quot; rel=&quot;klease78&quot;&gt;klease78&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;As I was back-porting &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-18835&quot; title=&quot;camel-core-processor: OnCompletionProcessor#onFailure callback fires more than once&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-18835&quot;&gt;&lt;del&gt;CAMEL-18835&lt;/del&gt;&lt;/a&gt; I noticed that this fix in not back-ported into the&#160;&lt;tt&gt;camel-3.18.x&lt;/tt&gt; or&#160;&lt;tt&gt;camel-3.14.x&lt;/tt&gt; LTS branches, but maybe that was on purpose?&lt;/p&gt;</comment>
                            <comment id="17651829" author="klease78" created="Sat, 24 Dec 2022 21:46:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bvahdat&quot; class=&quot;user-hover&quot; rel=&quot;bvahdat&quot;&gt;bvahdat&lt;/a&gt; I suspect it was because no one suggested that it should be back-ported. Possibly also because the changes were in several different packages including a change in an interface.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 46 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z16x6w:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>