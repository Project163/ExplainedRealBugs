<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 11:07:56 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-21216] Apache Camel LRA does not work with Oracle MicroTX LRA coordinator</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-21216</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;&lt;font color=&quot;#000000&quot;&gt;Hi Team,&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#000000&quot;&gt;we are using the Apache Camel LRA components within Java Springboot projects to implement saga services.&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#000000&quot;&gt;Till now, we are using Narayana as an LRA-Coordinator. Now we want to switch to Oracl MicroTX &lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;#000000&quot;&gt;(&lt;a href=&quot;https://docs.oracle.com/en/database/oracle/transaction-manager-for-microservices/24.2/tmmdg/lra-transaction-protocol.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://docs.oracle.com/en/database/oracle/transaction-manager-for-microservices/24.2/tmmdg/lra-transaction-protocol.html&lt;/a&gt;).&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#000000&quot;&gt;After configuring Oracle MircoTX instead of Narayana, we are facing two problems within the &lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;#000000&quot;&gt;Apache Camel LRA component code.&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#0451a5&quot;&gt;1)&lt;/font&gt;&lt;font color=&quot;#000000&quot;&gt; While joining an LRA Transaction, the payload sent by Apache Camel is URL encoded&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;#0451a5&quot;&gt;2)&lt;/font&gt;&lt;font color=&quot;#000000&quot;&gt; The Query parameter sent by Oracle LRA coordinator are url encoded, but will not be decoded by Apache Camal LRA (see also: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-21197&quot; title=&quot;URISupport.parseQuery is not decoding correctly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-21197&quot;&gt;&lt;del&gt;CAMEL-21197&lt;/del&gt;&lt;/a&gt;)&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#000000&quot;&gt;I will set up a branch with my suggested code changes and link this afterwards to this jira bug.&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;#000000&quot;&gt;The code changes are completely backwards compatible with Narayana (already tested).&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#0451a5&quot;&gt;1)&lt;/font&gt;&lt;font color=&quot;#000000&quot;&gt; Joining an LRA Transaction&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#000000&quot;&gt;The class &apos;LRAClient&apos; is using &apos;LRAUrlBuilder&apos; inside Method &apos;join&apos;. All parts of the http put body are url encoded. &lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;#000000&quot;&gt;Within Oracle LRA Coordinator log i can see the incomming request from Apache Camel:&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&amp;lt;https:&lt;span class=&quot;code-comment&quot;&gt;//k5-mmeeasysaga.qa-servicebuilder-dev.svc.cluster.local/camel/compensate?Camel-Saga-Complete=direct%3A%2F%2Fsaga1_sagaService_complete&amp;gt;; rel=compensate,&amp;lt;https://k5-mmeeasysaga.qa-servicebuilder-dev.svc.cluster.local/camel/complete?Camel-Saga-Complete=direct%3A%2F%2Fsaga1_sagaService_complete&amp;gt;; rel=complete&lt;/span&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;&lt;font color=&quot;#000000&quot;&gt;This url encoded query param &apos;Camel-Saga-Complete=direct%3A%2F%2Fsaga1_sagaService_complete&apos; will be encoded again on Oracle LRA Coordinator side.&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;#000000&quot;&gt;This is causing the error message within Apache Camel LRA:&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
o.a.c.RuntimeCamelException: Cannot join LRA  at o.a.c.s.l.LRAClient.lambda$join$2(LRAClient.java:138)  ... 10 common frames omitted Wrapped by: j.u.c.CompletionException: org.apache.camel.RuntimeCamelException: Cannot join LRA  at j.u.c.CompletableFuture.encodeThrowable(Unknown Source)  at j.u.c.CompletableFuture.completeThrowable(Unknown Source)  at j.u.c.CompletableFuture$UniApply.tryFire(Unknown Source)  at j.u.c.CompletableFuture.postComplete(Unknown Source)  at j.u.c.CompletableFuture.postFire(Unknown Source)  at j.u.c.CompletableFuture$UniWhenComplete.tryFire(Unknown Source)  at j.u.c.CompletableFuture$Completion.exec(Unknown Source)  at j.u.c.ForkJoinTask.doExec(Unknown Source)  at j.u.c.ForkJoinPool$WorkQueue.topLevelExec(Unknown Source)  at j.u.c.ForkJoinPool.scan(Unknown Source)  at j.u.c.ForkJoinPool.runWorker(Unknown Source)  at j.u.c.ForkJoinWorkerThread.run(Unknown Source)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;


&lt;p&gt;&lt;font color=&quot;#000000&quot;&gt;When logging the result http code and body&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
LOG.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; joining LRA: {} / {}&quot;&lt;/span&gt;, response.statusCode(), response.body());&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;&lt;font color=&quot;#000000&quot;&gt;i am getting this:&lt;/font&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; joining LRA: 400 / error: URL is &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; encoded&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;&lt;font color=&quot;#000000&quot;&gt;The problem can be solved by not url encoding the given urls within the joinLRA payload.&lt;/font&gt;&lt;br/&gt;
&#160;&lt;br/&gt;
org.apache.camel.service.lra.LRAUrlBuilder -&amp;gt; query:&lt;br/&gt;
&#160;&lt;br/&gt;
This code should not be executed:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
key = URLEncoder.encode(toNonnullString(key), StandardCharsets.UTF_8.name());  value = URLEncoder.encode(toNonnullString(value), StandardCharsets.UTF_8.name()); 
&#160;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;br/&gt;
&lt;font color=&quot;#0451a5&quot;&gt;2)&lt;/font&gt;&lt;font color=&quot;#000000&quot;&gt; Decode given query parameter from Oracle LRA-Coordinator call&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#000000&quot;&gt;After solving 1), i am getting a new exception:&lt;/font&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;

j.l.IllegalArgumentException: URI direct%3A%2F%2Fsaga1_sagaService_complete is not allowed  at o.a.c.s.l.LRASagaRoutes.verifyRequest(LRASagaRoutes.java:107)  at o.a.c.s.p.DelegateSyncProcessor.process(DelegateSyncProcessor.java:65)  at o.a.c.p.e.RedeliveryErrorHandler$SimpleTask.handleFirst(RedeliveryErrorHandler.java:440)  at o.a.c.p.e.RedeliveryErrorHandler$SimpleTask.run(RedeliveryErrorHandler.java:416)  at o.a.c.i.e.DefaultReactiveExecutor$Worker.doRun(DefaultReactiveExecutor.java:199)  at o.a.c.i.e.DefaultReactiveExecutor$Worker.executeReactiveWork(DefaultReactiveExecutor.java:189)  at o.a.c.i.e.DefaultReactiveExecutor$Worker.tryExecuteReactiveWork(DefaultReactiveExecutor.java:166)  at o.a.c.i.e.DefaultReactiveExecutor$Worker.schedule(DefaultReactiveExecutor.java:148)  at o.a.c.i.e.DefaultReactiveExecutor.scheduleMain(DefaultReactiveExecutor.java:59)  at o.a.c.p.Pipeline.process(Pipeline.java:163)  at o.a.c.i.e.CamelInternalProcessor.processNonTransacted(CamelInternalProcessor.java:346)  at o.a.c.i.e.CamelInternalProcessor.process(CamelInternalProcessor.java:322)  at o.a.c.i.e.DefaultAsyncProcessorAwaitManager.process(DefaultAsyncProcessorAwaitManager.java:82)  at o.a.c.s.AsyncProcessorSupport.process(AsyncProcessorSupport.java:32)  at o.a.c.h.c.CamelServlet.doExecute(CamelServlet.java:313)  at o.a.c.h.c.CamelServlet.doService(CamelServlet.java:235)  at o.a.c.h.c.CamelServlet.handleService(CamelServlet.java:111)  at o.a.c.h.c.CamelServlet.service(CamelServlet.java:97)  at j.s.h.HttpServlet.service(HttpServlet.java:614)  ... 5 frames excluded  at k.s.s.s.c.SagaContextFilter.doFilterInternal(SagaContextFilter.java:52)  ... 4 frames excluded  at o.s.s.w.FilterChainProxy.lambda$doFilterInternal$3(FilterChainProxy.java:231)  at o.s.s.w.ObservationFilterChainDecorator$FilterObservation$SimpleFilterObservation.lambda$wrap$1(ObservationFilterChainDecorator.java:479)  at o.s.s.w.ObservationFilterChainDecorator$AroundFilterObservation$SimpleAroundFilterObservation.lambda$wrap$1(ObservationFilterChainDecorator.java:340)  at o.s.s.w.ObservationFilterChainDecorator.lambda$wrapSecured$0(ObservationFilterChainDecorator.java:82)  ... 2 frames excluded  at o.s.s.w.ObservationFilterChainDecorator$ObservationFilter.wrapFilter(ObservationFilterChainDecorator.java:240)  ... 110 frames truncated&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#000000&quot;&gt;After finalizing the saga, the Oracle LRA-Coordinator is calling the &apos;onComplete&apos; for all participants and the service.&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 PUT /camel/complete?Camel-Saga-Compensate=direct%3A%2F%2Fsaga1_participant1_compensate&amp;amp;Camel-Saga-Complete=direct%3A%2F%2Fsaga1_participant1_complete&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;&lt;font color=&quot;#000000&quot;&gt;Within o.a.c.s.l.LRASagaRoutes.verifyRequest(LRASagaRoutes.java:107) the extracted query param &apos;Camel-Saga-Compensate&apos; is still url encoded:&lt;/font&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 direct%3A%2F%2Fsaga1_sagaService_complete&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;&lt;font color=&quot;#000000&quot;&gt;Therefore the check within LRASagaRoutes.verifyRequest fails, because the valid (indexed) uri is&lt;/font&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 direct:&lt;span class=&quot;code-comment&quot;&gt;//saga1_sagaService_complete&lt;/span&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;&lt;font color=&quot;#000000&quot;&gt;The problem can completely solved by &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-21197&quot; title=&quot;URISupport.parseQuery is not decoding correctly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-21197&quot;&gt;&lt;del&gt;CAMEL-21197&lt;/del&gt;&lt;/a&gt;. In the meantime in will provide a suggestion for an workaround.&lt;/font&gt;&lt;/p&gt;


&lt;p&gt;&lt;font color=&quot;#000000&quot;&gt;best regards&lt;/font&gt;&lt;br/&gt;
&lt;font color=&quot;#000000&quot;&gt;Dirk&lt;/font&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13592071">CAMEL-21216</key>
            <summary>Apache Camel LRA does not work with Oracle MicroTX LRA coordinator</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="zhfeng">Zheng Feng</assignee>
                                    <reporter username="dfiedler">Dirk Fiedler</reporter>
                        <labels>
                    </labels>
                <created>Fri, 13 Sep 2024 13:07:24 +0000</created>
                <updated>Wed, 25 Sep 2024 05:13:13 +0000</updated>
                            <resolved>Wed, 25 Sep 2024 05:13:13 +0000</resolved>
                                    <version>4.7.0</version>
                                    <fixVersion>4.8.1</fixVersion>
                    <fixVersion>4.9.0</fixVersion>
                                    <component>camel-lra</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="17881582" author="JIRAUSER306992" created="Fri, 13 Sep 2024 13:53:43 +0000"  >&lt;p&gt;i have created a pull request with my change: &lt;a href=&quot;https://github.com/apache/camel/pull/15558&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/15558&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13591757">CAMEL-21197</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 8 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1revc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>