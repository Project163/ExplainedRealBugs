<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:25:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-11698] S3 Consumer does not close S3 Object Input Streams and this causes HTTP connection leaks</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-11698</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;It looks like S3Consumer does nothing to prevent HTTP Connection leaks that can easily happen if some exception is thrown while it is generates a batch of exchanges and sends them for processing. Also we can lose HTTP Connections if our route does not close S3 Object Input Streams which can easily happen.&lt;/p&gt;

&lt;p&gt;Due to this issue s3 consumer may works some time and then start failing with the following exceptions:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;com.amazonaws.AmazonClientException: Unable to execute HTTP request: Timeout waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; connection from pool
	at com.amazonaws.http.AmazonHttpClient.executeHelper(AmazonHttpClient.java:544)
	at com.amazonaws.http.AmazonHttpClient.execute(AmazonHttpClient.java:273)
	at com.amazonaws.services.s3.AmazonS3Client.invoke(AmazonS3Client.java:3660)
	at com.amazonaws.services.s3.AmazonS3Client.getObject(AmazonS3Client.java:1133)
	at com.amazonaws.services.s3.AmazonS3EncryptionClient.access$201(AmazonS3EncryptionClient.java:65)
	at com.amazonaws.services.s3.AmazonS3EncryptionClient$S3DirectImpl.getObject(AmazonS3EncryptionClient.java:524)
	at com.amazonaws.services.s3.internal.crypto.S3CryptoModuleAE.getObjectSecurely(S3CryptoModuleAE.java:106)
	at com.amazonaws.services.s3.internal.crypto.CryptoModuleDispatcher.getObjectSecurely(CryptoModuleDispatcher.java:114)
	at com.amazonaws.services.s3.AmazonS3EncryptionClient.getObject(AmazonS3EncryptionClient.java:427)
	at com.amazonaws.services.s3.AmazonS3Client.getObject(AmazonS3Client.java:1005)
	at org.apache.camel.component.aws.s3.S3Consumer.createExchanges(S3Consumer.java:112)
	at org.apache.camel.component.aws.s3.S3Consumer.poll(S3Consumer.java:93)
	at org.apache.camel.impl.ScheduledPollConsumer.doRun(ScheduledPollConsumer.java:187)
	at org.apache.camel.impl.ScheduledPollConsumer.run(ScheduledPollConsumer.java:114)
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
	at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:308)
	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$301(ScheduledThreadPoolExecutor.java:180)
	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:294)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I found 3 week points in the way S3Consumer is implemented:&lt;br/&gt;
1. It does not handle exceptions in the poll() method where it reads a single s3 object which means that s3 object stream can be left opened forever in case of some fault;&lt;br/&gt;
2. It also does not handle exceptions in the createExchanges method where it populates a list of exchanges based on the list of s3 objects available in the bucket. If for example we want to consumer 10 files in a pool and getObject call for the file 10 failed due to whatever reason steams for 9 objects that are already opened will be lost;&lt;br/&gt;
3. In order to make sure that we always close all the streams and to not force user to do this all the time the implementation of the processBatch method should be also improved to close all the opened streams in the finally block.&lt;/p&gt;

&lt;p&gt;In order to resolve issues 2 and 3 in my current project (the issue 1 is not affecting me because I do not use that feature) I implemented a custom extension of the native S3Consumer that I want to share with you. It will give you the idea of the required changes that need to be applied to fix these issues. I hope it will be useful.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13096968">CAMEL-11698</key>
            <summary>S3 Consumer does not close S3 Object Input Streams and this causes HTTP connection leaks</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="acosentino">Andrea Cosentino</assignee>
                                    <reporter username="mvlakh">MykhailoVlakh</reporter>
                        <labels>
                    </labels>
                <created>Wed, 23 Aug 2017 09:12:04 +0000</created>
                <updated>Tue, 12 Sep 2017 07:52:00 +0000</updated>
                            <resolved>Tue, 12 Sep 2017 07:52:00 +0000</resolved>
                                    <version>2.14.3</version>
                    <version>2.19.2</version>
                                    <fixVersion>2.18.5</fixVersion>
                    <fixVersion>2.19.4</fixVersion>
                    <fixVersion>2.20.0</fixVersion>
                                    <component>camel-aws</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16138270" author="ancosen" created="Wed, 23 Aug 2017 12:15:08 +0000"  >&lt;p&gt;We add this in the past &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-11697&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CAMEL-11697&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;With the autocloseBody option true we close the s3Object when the exchange is complete:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Exchange createExchange(ExchangePattern pattern, S3Object s3Object) {
        LOG.trace(&lt;span class=&quot;code-quote&quot;&gt;&quot;Getting object with key [{}] from bucket [{}]...&quot;&lt;/span&gt;, s3Object.getKey(), s3Object.getBucketName());

        ObjectMetadata objectMetadata = s3Object.getObjectMetadata();

        LOG.trace(&lt;span class=&quot;code-quote&quot;&gt;&quot;Got object [{}]&quot;&lt;/span&gt;, s3Object);

        Exchange exchange = &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.createExchange(pattern);
        Message message = exchange.getIn();

        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (configuration.isIncludeBody()) {
            message.setBody(s3Object.getObjectContent());
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
            message.setBody(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
        }

        message.setHeader(S3Constants.KEY, s3Object.getKey());
        message.setHeader(S3Constants.BUCKET_NAME, s3Object.getBucketName());
        message.setHeader(S3Constants.E_TAG, objectMetadata.getETag());
        message.setHeader(S3Constants.LAST_MODIFIED, objectMetadata.getLastModified());
        message.setHeader(S3Constants.VERSION_ID, objectMetadata.getVersionId());
        message.setHeader(S3Constants.CONTENT_TYPE, objectMetadata.getContentType());
        message.setHeader(S3Constants.CONTENT_MD5, objectMetadata.getContentMD5());
        message.setHeader(S3Constants.CONTENT_LENGTH, objectMetadata.getContentLength());
        message.setHeader(S3Constants.CONTENT_ENCODING, objectMetadata.getContentEncoding());
        message.setHeader(S3Constants.CONTENT_DISPOSITION, objectMetadata.getContentDisposition());
        message.setHeader(S3Constants.CACHE_CONTROL, objectMetadata.getCacheControl());
        message.setHeader(S3Constants.S3_HEADERS, objectMetadata.getRawMetadata());
        message.setHeader(S3Constants.SERVER_SIDE_ENCRYPTION, objectMetadata.getSSEAlgorithm());

        /**
         * If includeBody != &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, it is safe to close the object here.  If includeBody == &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;,
         * the caller is responsible &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; closing the stream and object once the body has been fully consumed.
         * As of 2.17, the consumer does not close the stream or object on commit.
         */
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!configuration.isIncludeBody()) {
            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                s3Object.close();
            } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
            }
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (configuration.isAutocloseBody()) {
                exchange.addOnCompletion(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SynchronizationAdapter() {
                    @Override
                    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void onDone(Exchange exchange) {
                        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                            s3Object.close();
                        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
                        }
                    }
                });
            }
        }

        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; exchange;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We need to improve error handling somewhere by the way&lt;/p&gt;</comment>
                            <comment id="16138273" author="ancosen" created="Wed, 23 Aug 2017 12:17:01 +0000"  >&lt;p&gt;By the way you&apos;re welcome to work on a PR or a patch for improving this.&lt;br/&gt;
&lt;a href=&quot;http://camel.apache.org/contributing.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://camel.apache.org/contributing.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16139900" author="stevel@apache.org" created="Thu, 24 Aug 2017 11:18:30 +0000"  >&lt;p&gt;Don&apos;t know if its relevant here, but in Hadoop s3a we decide whether to abort or close the connection based on the amount of remaining data. In close() then AWS s3 client will read() to the end of the data, to recycle the HTTP1.1 connection. This is OK for small files, but not multi-GB files where you are closing things to jump around in seek&lt;/p&gt;</comment>
                            <comment id="16162635" author="davsclaus" created="Tue, 12 Sep 2017 07:52:00 +0000"  >&lt;p&gt;Thanks. I added the suggestion of closing the s3 objects in that create exchanges method. The autoClose option that Andreas talk about is default enabled and will ensure the s3 object is closed for each exchange being routed by Camel.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12883296" name="CustomS3Consumer.java" size="3187" author="mvlakh" created="Wed, 23 Aug 2017 09:14:08 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 10 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3j6jr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>