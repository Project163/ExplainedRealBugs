<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:59:03 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-18661] Camel  OpenTelemtery instrumentation does not make spans current</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-18661</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;I have the following application:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Component
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;SourceRoute &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; EndpointRouteBuilder {
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; cs = &lt;span class=&quot;code-quote&quot;&gt;&quot;...&quot;&lt;/span&gt;;
    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void configure() {

       from(timer(&lt;span class=&quot;code-quote&quot;&gt;&quot;tick&quot;&lt;/span&gt;).period(1000).repeatCount(1))
                .log(&lt;span class=&quot;code-quote&quot;&gt;&quot;Timer triggered&quot;&lt;/span&gt;)
                .setBody(simple(&lt;span class=&quot;code-quote&quot;&gt;&quot;hello&quot;&lt;/span&gt;))
                .to(azureServicebus(&lt;span class=&quot;code-quote&quot;&gt;&quot;testme&quot;&lt;/span&gt;).
                        serviceBusType(&lt;span class=&quot;code-quote&quot;&gt;&quot;topic&quot;&lt;/span&gt;).
                        connectionString(cs));
    }
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;And I run it with &lt;a href=&quot;https://github.com/open-telemetry/opentelemetry-java-instrumentation/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;OpenTelemtery Java agent&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Camel creates &quot;tick&quot; and &quot;testme&quot; spans.&lt;br/&gt;
ServiceBus SDK is instrumented too and it creates it&apos;s own spans.&lt;/p&gt;

&lt;h2&gt;&lt;a name=&quot;Actualbehavior%3A&quot;&gt;&lt;/a&gt;Actual behavior:&lt;/h2&gt;

&lt;p&gt;Spans created by ServiceBus SDK are unrelated to Camel spans. I.e. ServiceBus spans and Camel spans are in different traces (check out the attached screenshot).&lt;/p&gt;

&lt;h2&gt;&lt;a name=&quot;Expectedbehavior%3A&quot;&gt;&lt;/a&gt;Expected behavior:&lt;/h2&gt;

&lt;p&gt;Camel &quot;testme&quot; span is a parent of ServiceBus spans:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;tick
	&lt;ul&gt;
		&lt;li&gt;testme
		&lt;ul&gt;
			&lt;li&gt;ServiceBus.message&lt;/li&gt;
			&lt;li&gt;ServiceBus.send&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;h2&gt;&lt;a name=&quot;Investigation&quot;&gt;&lt;/a&gt;Investigation&lt;/h2&gt;

&lt;p&gt;If I look into the OTel instrumentation code (and debug my application). I can see that OTel span starts here&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/camel/blob/1175c2666821457dcb6cf0921f4076508459341a/components/camel-opentelemetry/src/main/java/org/apache/camel/opentelemetry/OpenTelemetryTracer.java#L92&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/blob/1175c2666821457dcb6cf0921f4076508459341a/components/camel-opentelemetry/src/main/java/org/apache/camel/opentelemetry/OpenTelemetryTracer.java#L92&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;and then is &apos;activated&apos; here &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/camel/blob/main/components/camel-tracing/src/main/java/org/apache/camel/tracing/Tracer.java#L248&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/blob/main/components/camel-tracing/src/main/java/org/apache/camel/tracing/Tracer.java#L248&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;But the activation code only puts trace_id and span_id on MDC.&lt;/p&gt;

&lt;p&gt;The proposal for Camel is to make OpenTelemtery span active (using Span.makeCurrent()).&lt;br/&gt;
This is the only way underlying traces can be correlated to Camel spans.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (Scope s = span.makeCurrent()) {
   &lt;span class=&quot;code-comment&quot;&gt;// wrap processing, but always clean up the scope to avoid leaks
&lt;/span&gt;} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;OTel instrumentation will take care of propagating this context anywhere else.&lt;/p&gt;

</description>
                <environment>&lt;p&gt;any, functional issue&lt;/p&gt;</environment>
        <key id="13492600">CAMEL-18661</key>
            <summary>Camel  OpenTelemtery instrumentation does not make spans current</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="Molkova">Liudmila </reporter>
                        <labels>
                    </labels>
                <created>Thu, 27 Oct 2022 21:06:04 +0000</created>
                <updated>Tue, 27 Dec 2022 19:56:34 +0000</updated>
                            <resolved>Fri, 16 Dec 2022 08:31:15 +0000</resolved>
                                    <version>3.19.0</version>
                                    <fixVersion>3.20.0</fixVersion>
                                    <component>camel-opentelemetry</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17625425" author="davsclaus" created="Fri, 28 Oct 2022 05:02:33 +0000"  >&lt;p&gt;Thanks for reporting, if you can then you are welcome to send your suggested fix as a PR against main branch&lt;/p&gt;</comment>
                            <comment id="17632570" author="JIRAUSER297604" created="Fri, 11 Nov 2022 22:58:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt; I prototyped some changes here &lt;a href=&quot;https://github.com/apache/camel/pull/8713,&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/8713,&lt;/a&gt; but it&apos;s not as trivial as I expected (for async calls), and I would appreciate any guidance on the approach I&apos;ve done in the PR or alternatives. Thanks!&lt;/p&gt;</comment>
                            <comment id="17648412" author="davsclaus" created="Fri, 16 Dec 2022 08:31:15 +0000"  >&lt;p&gt;Thanks for reporting and the excellent work on fixing/improving this&lt;/p&gt;</comment>
                            <comment id="17648427" author="bvahdat" created="Fri, 16 Dec 2022 09:27:36 +0000"  >&lt;p&gt;Should we look into backporting this for the upcoming &lt;tt&gt;3.18.5&lt;/tt&gt; LTS release?&lt;/p&gt;</comment>
                            <comment id="17648429" author="davsclaus" created="Fri, 16 Dec 2022 09:36:00 +0000"  >&lt;p&gt;No its a bit too invasive in the core (not isolated to opentelemetry only)&lt;/p&gt;</comment>
                            <comment id="17648599" author="bvahdat" created="Fri, 16 Dec 2022 12:22:20 +0000"  >&lt;p&gt;Please review: &lt;a href=&quot;https://github.com/apache/camel/pull/8911&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/8911&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17649455" author="bvahdat" created="Mon, 19 Dec 2022 19:46:31 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Molkova&quot; class=&quot;user-hover&quot; rel=&quot;Molkova&quot;&gt;Molkova&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;As per conversation &lt;a href=&quot;https://github.com/apache/camel/pull/8911#issuecomment-1355233167&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; just to let you know that the flaky test has popped up on Jenkins build as well:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://ci-builds.apache.org/job/Camel/job/Camel%20JDK11%20Build%20(S390x)/job/main/409/testReport/junit/org.apache.camel.opentelemetry/CurrentSpanTest/testContextDoesNotLeak/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-builds.apache.org/job/Camel/job/Camel%20JDK11%20Build%20(S390x)/job/main/409/testReport/junit/org.apache.camel.opentelemetry/CurrentSpanTest/testContextDoesNotLeak/&lt;/a&gt;&lt;br/&gt;
&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
org.apache.camel.CamelExecutionException: Exception occurred during execution on the exchange: Exchange[1E6AD74DFFAFE6E-000000000000000A]
	at org.apache.camel.CamelExecutionException.wrapCamelExecutionException(CamelExecutionException.java:45)
	at org.apache.camel.support.AbstractExchange.setException(AbstractExchange.java:597)
	at org.apache.camel.support.DefaultExchange.setException(DefaultExchange.java:27)
	at org.apache.camel.processor.MulticastProcessor$MulticastTask.aggregate(MulticastProcessor.java:445)
	at org.apache.camel.processor.MulticastProcessor$MulticastReactiveTask.lambda$run$0(MulticastProcessor.java:570)
	at org.apache.camel.AsyncCallback.run(AsyncCallback.java:44)
	at org.apache.camel.impl.engine.DefaultReactiveExecutor$Worker.schedule(DefaultReactiveExecutor.java:181)
	at org.apache.camel.impl.engine.DefaultReactiveExecutor.schedule(DefaultReactiveExecutor.java:54)
	at org.apache.camel.processor.MulticastProcessor.lambda$schedule$1(MulticastProcessor.java:336)
	at java.base/java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:515)
	at java.base/java.util.concurrent.FutureTask.run(FutureTask.java:264)
	at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)
	at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)
	at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:829)
Caused by: org.opentest4j.AssertionFailedError: expected: &amp;lt;&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&amp;gt; but was: &amp;lt;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;gt;
	at org.junit.jupiter.api.AssertionFailureBuilder.build(AssertionFailureBuilder.java:151)
	at org.junit.jupiter.api.AssertionFailureBuilder.buildAndThrow(AssertionFailureBuilder.java:132)
	at org.junit.jupiter.api.AssertFalse.failNotFalse(AssertFalse.java:63)
	at org.junit.jupiter.api.AssertFalse.assertFalse(AssertFalse.java:36)
	at org.junit.jupiter.api.AssertFalse.assertFalse(AssertFalse.java:31)
	at org.junit.jupiter.api.Assertions.assertFalse(Assertions.java:228)
	at org.apache.camel.opentelemetry.CurrentSpanTest$1.lambda$configure$0(CurrentSpanTest.java:221)
	at org.apache.camel.AggregationStrategy.aggregate(AggregationStrategy.java:86)
	at org.apache.camel.processor.MulticastProcessor.doAggregateInternal(MulticastProcessor.java:882)
	at org.apache.camel.processor.MulticastProcessor.doAggregateSync(MulticastProcessor.java:863)
	at org.apache.camel.processor.MulticastProcessor.doAggregate(MulticastProcessor.java:848)
	at org.apache.camel.processor.MulticastProcessor$MulticastTask.aggregate(MulticastProcessor.java:439)
	... 10 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13515763">CAMEL-18845</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13051525" name="camel_and_service_bus.png" size="99000" author="Molkova" created="Thu, 27 Oct 2022 20:54:16 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 47 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1ag1s:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>