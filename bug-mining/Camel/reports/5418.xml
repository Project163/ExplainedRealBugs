<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:42:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-15457] camel-micrometer: NullPointer exception triggered by MicrometerExchangeEventNotifier</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-15457</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;A recent&#160;[comit|&lt;a href=&quot;https://github.com/apache/camel/pull/3976&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/3976&lt;/a&gt;] causes NullPointer exceptions in some circumstances, though they are caught and logged as &quot;WARN&quot;.&lt;/p&gt;

&lt;p&gt;Output from the test testCamelRouteEvents() in MicrometerExchangeEventNotifierTest in master branch:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
11:44:32.741 [main] WARN org.apache.camel.support.EventHelper - Error notifying event ID-devbox-1598261669122-0-1 exchange Exchange[ID-devbox-1598261669122-0-1] sending to: direct:&lt;span class=&quot;code-comment&quot;&gt;//in. This exception will be ignored.11:44:32.741 [main] WARN org.apache.camel.support.EventHelper - Error notifying event ID-devbox-1598261669122-0-1 exchange Exchange[ID-devbox-1598261669122-0-1] sending to: direct://in. This exception will be ignored.java.lang.NullPointerException: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; at java.util.Objects.requireNonNull(Objects.java:221) ~[?:?] at io.micrometer.core.instrument.ImmutableTag.&amp;lt;init&amp;gt;(ImmutableTag.java:35) ~[micrometer-core-1.5.4.jar:1.5.4] at io.micrometer.core.instrument.Tag.of(Tag.java:29) ~[micrometer-core-1.5.4.jar:1.5.4] at io.micrometer.core.instrument.Tags.of(Tags.java:254) ~[micrometer-core-1.5.4.jar:1.5.4] at org.apache.camel.component.micrometer.eventnotifier.MicrometerExchangeEventNotifierNamingStrategy.getInflightExchangesTags(MicrometerExchangeEventNotifierNamingStrategy.java:58) ~[classes/:?] at org.apache.camel.component.micrometer.eventnotifier.MicrometerExchangeEventNotifier.handleExchangeEvent(MicrometerExchangeEventNotifier.java:80) ~[classes/:?] at org.apache.camel.component.micrometer.eventnotifier.MicrometerExchangeEventNotifier.notify(MicrometerExchangeEventNotifier.java:65) ~[classes/:?] at org.apache.camel.support.EventHelper.doNotifyEvent(EventHelper.java:1236) ~[classes/:?] at org.apache.camel.support.EventHelper.notifyExchangeSending(EventHelper.java:700) ~[classes/:?]&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The problem is that the&#160;MicrometerExchangeEventNotifier tries to build/update a metric on inflight exchanges in a route based on an ExchangeEvent with no associated fromRoute/fromRouteId. Events such as &quot;ExchangeSendingEvent&quot;, as is created in the test, is an example of such an ExchangeEvent.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13324232">CAMEL-15457</key>
            <summary>camel-micrometer: NullPointer exception triggered by MicrometerExchangeEventNotifier</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="eandre">Espen Andreassen</reporter>
                        <labels>
                    </labels>
                <created>Mon, 24 Aug 2020 09:43:11 +0000</created>
                <updated>Mon, 24 Aug 2020 17:43:20 +0000</updated>
                            <resolved>Mon, 24 Aug 2020 17:43:20 +0000</resolved>
                                    <version>3.5.0</version>
                                    <fixVersion>3.5.0</fixVersion>
                                    <component>camel-micrometer</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17183119" author="davsclaus" created="Mon, 24 Aug 2020 09:55:11 +0000"  >&lt;p&gt;What version of Camel do you use?&lt;/p&gt;</comment>
                            <comment id="17183125" author="davsclaus" created="Mon, 24 Aug 2020 10:02:14 +0000"  >&lt;p&gt;Thanks found out its only related to upcoming 3.5 release.&lt;/p&gt;</comment>
                            <comment id="17183322" author="eandre" created="Mon, 24 Aug 2020 14:11:44 +0000"  >&lt;p&gt;Hi! I see you implemented a fix and resolved the issue, thank you for the prompt effort! Unfortionatly, the fix is somewhat incompatible with prometheus it seems:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Prometheus requires that all meters with the same name have the same set of tag keys. There is already an existing meter named &lt;span class=&quot;code-quote&quot;&gt;&apos;CamelExchangesInflight&apos;&lt;/span&gt; containing tag keys [camelContext, serviceName]. The meter you are attempting to register has keys [camelContext, routeId, serviceName].
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;My suggestion is to add/move the check you introduced in the MicrometerExchangeEventNotifierNamingStrategy to the method&#160;handleExchangeEvent() in&#160;MicrometerExchangeEventNotifier. That way we don&apos;t create the inflight metric at all in cases where no fromRouteId() can be extracted, which isn&apos;t really usefull in my opinion any way. Could be an idea to check for the precense of fromEndpoint as well, as this can also potentially return null. Something like this:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void handleExchangeEvent(ExchangeEvent exchangeEvent) {
        Exchange exchange = exchangeEvent.getExchange();
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (exchange.getFromRouteId() != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; exchange.getFromEndpoint() != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name = namingStrategy.getInflightExchangesName(exchange, exchange.getFromEndpoint());
            Tags tags = namingStrategy.getInflightExchangesTags(exchangeEvent, exchange.getFromEndpoint());
            Gauge.builder(name, () -&amp;gt; getInflightExchangesInRoute(exchangeEvent))
                .tags(tags)
                .register(getMeterRegistry());
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17183324" author="davsclaus" created="Mon, 24 Aug 2020 14:14:32 +0000"  >&lt;p&gt;Can you provide a PR with your suggested fix thanks&lt;/p&gt;</comment>
                            <comment id="17183331" author="eandre" created="Mon, 24 Aug 2020 14:18:12 +0000"  >&lt;p&gt;Yes, I will provide no later than by the end of tomorrow.&lt;/p&gt;</comment>
                            <comment id="17183502" author="davsclaus" created="Mon, 24 Aug 2020 17:43:20 +0000"  >&lt;p&gt;Thanks for the fast PR with the fix&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13313997">CAMEL-15255</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 12 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0i168:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>