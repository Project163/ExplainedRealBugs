<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:40:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-3193] request/reply over JMS using temporary queues - if connection lost the temporary queue is not re-created which causes the producer to not work anymore</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-3193</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;To recreate the problem you need a route with a jms inout endpoint that is configured to use a temporary destination for replies. Till now I was only able to show the problem with tibco ems.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Start broker&lt;/li&gt;
	&lt;li&gt;Start the jms consumer that replies to the request&lt;/li&gt;
	&lt;li&gt;Start the route&lt;/li&gt;
	&lt;li&gt;Send a request/reoply exchange (should work)&lt;/li&gt;
	&lt;li&gt;Stop the broker&lt;/li&gt;
	&lt;li&gt;Wait long enough for the client to do a full reconnect (I used connectionFactory.setReconnAttemptCount(1) on the client so I do not have to wait so long)&lt;/li&gt;
	&lt;li&gt;Start the broker -&amp;gt; The jms component will do a full new connect&lt;/li&gt;
	&lt;li&gt;Send a request/reoply exchange -&amp;gt; Now a InvalidDestination Exception happens&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The client route will not work anymore until a restart as it creates the temporary destination only once and it is invalid now.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12487430">CAMEL-3193</key>
            <summary>request/reply over JMS using temporary queues - if connection lost the temporary queue is not re-created which causes the producer to not work anymore</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                            <parent id="12487853">CAMEL-3194</parent>
                                    <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cschneider">Christian Schneider</assignee>
                                    <reporter username="cschneider">Christian Schneider</reporter>
                        <labels>
                    </labels>
                <created>Mon, 4 Oct 2010 06:24:15 +0000</created>
                <updated>Tue, 5 Oct 2010 12:55:12 +0000</updated>
                            <resolved>Tue, 5 Oct 2010 12:54:48 +0000</resolved>
                                    <version>2.4.0</version>
                                    <fixVersion>2.5.0</fixVersion>
                                    <component>camel-jms</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12957087" author="chris@die-schneider.net" created="Mon, 4 Oct 2010 06:30:02 +0000"  >&lt;p&gt;Adding a patch that contains a unit test for the problem. Unfortunately the test is not yet working unattended. I was only able to recreate the problem in Tibco EMS. As the EMS server is external it has to be stopped / started by hand.&lt;/p&gt;

&lt;p&gt;So my first goal is to recreate the problem in ActiveMQ and make the test run fully unattended.&lt;/p&gt;

&lt;p&gt; Any ideas how to achieve this?&lt;/p&gt;</comment>
                            <comment id="12957086" author="davsclaus" created="Mon, 4 Oct 2010 06:46:43 +0000"  >&lt;p&gt;Chrsitian the title of this ticket is misleading. Could you change it.&lt;/p&gt;

&lt;p&gt;Its a problem with failover/re-connection on some brokers such as Tibco EMS which doesn&apos;t automatic failover temporary queues.&lt;br/&gt;
It ought to be the brokers problem to ensure this works out of the box.&lt;/p&gt;

&lt;p&gt;What happens when the &lt;em&gt;other&lt;/em&gt; side returns back a reply on that &lt;em&gt;old&lt;/em&gt; temporary queue? You can&apos;t just create a new temporary queue on re-connection/failover.&lt;br/&gt;
Hence I think its more a broker problem than the camel-jms component.&lt;/p&gt;</comment>
                            <comment id="12956995" author="chris@die-schneider.net" created="Mon, 4 Oct 2010 06:49:03 +0000"  >&lt;p&gt;Adding a small sample client with pure spring jms (without camel) that shows an attempt how we can fix the problem. &lt;br/&gt;
The idea is to use setExceptionListener for the MessageListenerComntainer. It catches the InvalidDestinationException and then &lt;br/&gt;
recreates the temp queue and the Listener. I think we will need something similar in camel.&lt;/p&gt;

&lt;p&gt;listener.setExceptionListener(new ExceptionListener() {&lt;/p&gt;

&lt;p&gt;            @Override&lt;br/&gt;
            public void onException(JMSException exception) {&lt;br/&gt;
                exception.printStackTrace();&lt;br/&gt;
                if (exception instanceof InvalidDestinationException) &lt;/p&gt;
{
                    listener.stop();
                    setupListener(connectionFactory, jmsTemplate);
                }
&lt;p&gt;            }&lt;/p&gt;

&lt;p&gt;        });&lt;/p&gt;

&lt;p&gt;After looking into the code of camel jms I think the right place is in the TemporaryQueueReplyManager. I will attach a patch shortly.&lt;/p&gt;</comment>
                            <comment id="12956994" author="davsclaus" created="Mon, 4 Oct 2010 06:50:29 +0000"  >&lt;p&gt;Maybe you can used a fixed reply to queue instead? Just to see if that works for you with re-connection/failover. Then you have a workaround/solution. &lt;/p&gt;</comment>
                            <comment id="12957062" author="chris@die-schneider.net" created="Mon, 4 Oct 2010 06:57:52 +0000"  >&lt;p&gt;A fixed reply queue will work but has more adminsitrative overhead. I also never have used fixed reply queues with more than one consumer on them but I guess camel will handle this case.&lt;/p&gt;

&lt;p&gt;I will try to work out a patch in any case. If we do not get it into the 2.5.0 then I can still create a small branch for EnBW that contains the fix. But I only do these things as soon as a fix is in trunk so I am sure the next release will contain it. &lt;/p&gt;

&lt;p&gt;Thanks for the fast reply. Btw. What is your estimation for the 2.5.0 release date?&lt;/p&gt;</comment>
                            <comment id="12956992" author="davsclaus" created="Mon, 4 Oct 2010 07:06:49 +0000"  >&lt;p&gt;Yeah fixed queues on brokers which may not be able to automatic create the queues on demand often causes admin overhead &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I can see one issue if a patch will create a new temporary queue, if there was an exception using the old one. &lt;br/&gt;
In that cause I think you could lose messages which are in-flight (eg replies are expected on the old temporary queue)&lt;/p&gt;

&lt;p&gt;However it would fix the issue of new messages as they just use the newly created temporary queue and it ought to just work.&lt;br/&gt;
But I bet this is better than &lt;em&gt;nothing&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;I will try to touch base with some AMQ committers and hear their point of view.&lt;/p&gt;

&lt;p&gt;We are talking about Camel 2.5 on the dev forum. We are waiting for scalate 1.3 to be released. But with good luck we may be able to start the release this week or start of next.&lt;/p&gt;</comment>
                            <comment id="12957083" author="davsclaus" created="Mon, 4 Oct 2010 09:28:23 +0000"  >&lt;p&gt;Had a chat with the AMQ people. Temporary queues is only associated with a jms connection. So when that connection dies the pending messages on the temporary queue as well.&lt;/p&gt;

&lt;p&gt;The best option is to use real queues if you want to be absolute sure that a reply message is not lost.&lt;/p&gt;

&lt;p&gt;Anyway I think your idea of using an exception listener and then catch the invalid destination and then restart the listener is a good idea.&lt;/p&gt;</comment>
                            <comment id="12957061" author="davsclaus" created="Mon, 4 Oct 2010 10:01:58 +0000"  >&lt;p&gt;Christian it is maybe something like this patch you need to resolve your problem?&lt;/p&gt;

&lt;p&gt;Maybe you can take a look at it and try it out on your system.&lt;/p&gt;</comment>
                            <comment id="12956525" author="chris@die-schneider.net" created="Mon, 4 Oct 2010 12:40:27 +0000"  >&lt;p&gt;Hi Claus,&lt;/p&gt;

&lt;p&gt;I have to wait till I am at home to be able to test the patch. From what I tested in the morning I think you will also need to do &quot;setReplyTo(null)&quot; to let camel forget the old destination.&lt;/p&gt;

&lt;p&gt;Thanks for the quick help&lt;/p&gt;

&lt;p&gt;Christian&lt;/p&gt;</comment>
                            <comment id="12956549" author="chris@die-schneider.net" created="Mon, 4 Oct 2010 12:43:35 +0000"  >&lt;p&gt;Hi Claus,&lt;/p&gt;

&lt;p&gt;did the ActiveMQ folks have any idea how to reproduce the problem in ActiveMQ. I tried to shutdown the broker and restart it but the Temporary queue was still valid. So it almost seems the temp queue outlives a connection in ActiveMQ. It would be great to have a automatic test for this problem to test the fix and document the issue in code. &lt;/p&gt;

&lt;p&gt;Thanks &lt;/p&gt;

&lt;p&gt;Christian&lt;/p&gt;</comment>
                            <comment id="12956548" author="davsclaus" created="Mon, 4 Oct 2010 13:17:02 +0000"  >&lt;p&gt;The AMQ people use a SocketProxy when testing various network issues.&lt;/p&gt;

&lt;p&gt;For example:&lt;br/&gt;
&lt;a href=&quot;https://fisheye6.atlassian.com/browse/activemq/trunk/activemq-core/src/test/java/org/apache/activemq/transport/SoWriteTimeoutTest.java?r=HEAD&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://fisheye6.atlassian.com/browse/activemq/trunk/activemq-core/src/test/java/org/apache/activemq/transport/SoWriteTimeoutTest.java?r=HEAD&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12956696" author="chris@die-schneider.net" created="Tue, 5 Oct 2010 07:29:04 +0000"  >&lt;p&gt;I tested your patch yesterday and found we can solve this even much easier. The current code of TemporaryQueueReplyManager uses SimpleMessageListenerContainer. I just needed to switch to the DefaultMessageListenerContainer to achieve the same effect. I noticed this when I merged your patch with mine and tried to recreate the error. The problem did  not occur anymore even when I switched off your exceptionListener. &lt;/p&gt;

&lt;p&gt;So I looked into DefaultMessageListenerContainer and found that they support reconnections. They even do a fresh resolve of the temporary queue so it is recreated automatically. So I propose we simply go this way.&lt;/p&gt;

&lt;p&gt;I just committed this change. Feel free to roll back if you see any problem with this aproach for the 2.5.0 release. I also committed the test but disabled it as it does not run unattended.&lt;/p&gt;</comment>
                            <comment id="12956656" author="davsclaus" created="Tue, 5 Oct 2010 08:38:06 +0000"  >&lt;p&gt;Ah that is perfect. Why didn&apos;t we consider this before, its after all the spring DMLC that is used to consume the reply messages from the temporary queue.&lt;/p&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12463410" name="CAMEL-3193.patch" size="2781" author="davsclaus" created="Mon, 4 Oct 2010 10:01:58 +0000"/>
                            <attachment id="12463408" name="ClientTest.java" size="4527" author="cschneider" created="Mon, 4 Oct 2010 06:49:03 +0000"/>
                            <attachment id="12463407" name="patch.txt" size="3724" author="cschneider" created="Mon, 4 Oct 2010 06:30:02 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>76319</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 8 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i01t8f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8505</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>