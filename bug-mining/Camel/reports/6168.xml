<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:56:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-17424] camel-kafka - Shutdown issues when attempting to consume from topic without authorization</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-17424</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;Hello &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Something has been introduced in 3.14.0 that causes long Camel shutdown when there has been an attempt to consume form a topic without necessary authorizations. The more consumers has been started the longer Camel takes to shut down.&lt;/p&gt;

&lt;p&gt;Below is what is logged many times after a shutdown has been initiated (I masked some parts I did not want to share). In this case I consumed from two topics: &lt;b&gt;some-other-topic-that-consumer-was-authorized-to&lt;/b&gt;&#160; and &lt;b&gt;e2k-test-bledu.&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2022-01-03 18:27:05.032 &#160;WARN 25556 --- [rdReplaceEvent]] o.a.c.component.kafka.KafkaFetchRecords &#160;: Exception org.apache.kafka.common.errors.TopicAuthorizationException caught while polling some-other-topic-that-consumer-was-authorized-to-Thread 0 from kafka topic some-other-topic-that-consumer-was-authorized-to at offset {}: Not authorized to access topics: [e2k-test-bledu]
2022-01-03 18:27:05.032 &#160;WARN 25556 --- [rdReplaceEvent]] o.a.c.component.kafka.KafkaFetchRecords &#160;: Deferring processing to the exception handler based on polling exception strategy
2022-01-03 18:27:05.032 &#160;INFO 25556 --- [rdReplaceEvent]] o.a.k.c.c.internals.AbstractCoordinator &#160;: [Consumer clientId=consumer-event2kafka_test3-12, groupId=event2kafka_test3] (Re-)joining group
2022-01-03 18:27:05.051 &#160;INFO 25556 --- [rdReplaceEvent]] o.a.k.c.c.internals.AbstractCoordinator &#160;: [Consumer clientId=consumer-event2kafka_test3-12, groupId=event2kafka_test3] Successfully joined group with generation Generation{generationId=83, memberId=&apos;consumer-event2kafka_test3-12-74747411-96e8-4111-bab3-224cf754018f&apos;, protocol=&apos;range&apos;}
2022-01-03 18:27:05.066 &#160;INFO 25556 --- [-PZOdmowaTrans]] o.a.k.c.c.internals.ConsumerCoordinator &#160;: [Consumer clientId=consumer-event2kafka_test3-13, groupId=event2kafka_test3] Requesting to re-join the group and trigger rebalance since the assignment metadata has changed from (***masked***)
2022-01-03 18:27:05.066 &#160;INFO 25556 --- [-PZOdmowaTrans]] o.a.k.c.c.internals.ConsumerCoordinator &#160;: [Consumer clientId=consumer-event2kafka_test3-13, groupId=event2kafka_test3] Requesting to re-join the group and trigger rebalance since the assignment metadata has changed from (***masked***)
2022-01-03 18:27:05.071 &#160;WARN 25556 --- [rdReplaceEvent]] org.apache.kafka.clients.NetworkClient &#160; : [Consumer clientId=consumer-event2kafka_test3-12, groupId=event2kafka_test3] Error while fetching metadata with correlation id 133 : {e2k-test-bledu=TOPIC_AUTHORIZATION_FAILED}
2022-01-03 18:27:05.071 ERROR 25556 --- [rdReplaceEvent]] org.apache.kafka.clients.Metadata &#160; &#160; &#160; &#160;: [Consumer clientId=consumer-event2kafka_test3-12, groupId=event2kafka_test3] Topic authorization failed for topics [e2k-test-bledu]
2022-01-03 18:27:05.071 &#160;INFO 25556 --- [rdReplaceEvent]] o.a.k.c.c.internals.AbstractCoordinator &#160;: [Consumer clientId=consumer-event2kafka_test3-12, groupId=event2kafka_test3] Rebalance failed.

org.apache.kafka.common.errors.TopicAuthorizationException: Not authorized to access topics: [e2k-test-bledu] &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;My use case may be specific because I start a separate route for every topic I want to consume from (I do not want to have a shared consumer for all topics because I need different prameters for selected topics, like offset reset etc.). Currently I consume from 44 topics and the Camel takes like four minutes to shut down.&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13420418">CAMEL-17424</key>
            <summary>camel-kafka - Shutdown issues when attempting to consume from topic without authorization</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="orpiske">Otavio Rodolfo Piske</assignee>
                                    <reporter username="rgala">Rafa&#322; Ga&#322;a</reporter>
                        <labels>
                    </labels>
                <created>Mon, 3 Jan 2022 18:09:34 +0000</created>
                <updated>Fri, 10 Jun 2022 07:33:14 +0000</updated>
                            <resolved>Fri, 10 Jun 2022 07:33:14 +0000</resolved>
                                    <version>3.14.0</version>
                                    <fixVersion>3.18.0</fixVersion>
                                    <component>camel-kafka</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17468138" author="rgala" created="Mon, 3 Jan 2022 18:20:23 +0000"  >&lt;p&gt;Looks like this is more serious. I just noticed that lack of authorization to a single topic is preventing consumption from all other topics &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; I had similar issue on 3.5.0 but it disappeared when I upgraded do 3.13.0 (unsure which version between 3.5.0 and 3.13.0 fixed this though).&lt;/p&gt;</comment>
                            <comment id="17468582" author="rgala" created="Tue, 4 Jan 2022 11:33:27 +0000"  >&lt;p&gt;I debugged a bit and it looks like the issue may be related to the loop in &lt;b&gt;run&lt;/b&gt; method of &lt;b&gt;KafkaFetchRecords&lt;/b&gt;. Prior to 3.14.0 there was no loop and when an exception occured inside &lt;b&gt;{&lt;/b&gt;}&lt;b&gt;startPolling&lt;/b&gt; method, the run method exited and the thread ended. Now it keeps retrying all the time and failing due to lack of authorization which may have some impact on the shutdown process.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Also I noticed that when all consumers share the same consumer group id, authorization error is causing errors in &lt;b&gt;org.apache.kafka.clients.consumer.KafkaConsumer&lt;/b&gt; instances that have nothing to do with the topic there are no authorizations to. Looks like internally Kafka client shares some components per consumer group and I think nothing can be done on Camel side about this &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Why did it not cause issues prior to 3.14.0 is because just before the &lt;b&gt;run&lt;/b&gt; method ended the &lt;b&gt;safeUnsubscribe&lt;/b&gt; was called.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I will try to solve this using custom &lt;b&gt;pollExceptionStrategy&lt;/b&gt; to force consumer to stop when TopicAuthorizationException occured.&lt;/p&gt;</comment>
                            <comment id="17547925" author="davsclaus" created="Sat, 4 Jun 2022 08:28:12 +0000"  >&lt;p&gt;Can you try with 3.17.0 as a lot of hardening et all has gone into camel-kafka&lt;/p&gt;</comment>
                            <comment id="17550325" author="rgala" created="Mon, 6 Jun 2022 06:28:28 +0000"  >&lt;p&gt;It behaves differently on 3.17.0:&lt;/p&gt;

&lt;p&gt;Af first call to&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ConsumerRecords&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;&amp;gt; allRecords = consumer.poll(pollDuration); &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;in KafkaFetchRecords class it fails with TopicAuthorizationException, but the default poll exception strategy tells it to just go on so it calls the above again but this time it does not fail anymore with TopicAuthorizationException, but it also does not fetch any records (the consumer is in some weird state after first poll attempt). It keeps trying to poll records like if there was no authorization issue at all. Luckily the Camel shutdown process is not affected by this.&lt;/p&gt;

&lt;p&gt;I would like to implement my own poll exception strategy and just stop polling when TopicAuthorizationException occurs, but continue with all other exceptions, but as I pointed out in &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-18142&quot; title=&quot;New PollExceptionStrategy interface&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-18142&quot;&gt;&lt;del&gt;CAMEL-18142&lt;/del&gt;&lt;/a&gt;, it seems impossible now. I could store the exception during the call to&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
pollExceptionStrategy.handle(partitionLastOffset, e) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and then use it in &lt;b&gt;canContinue()&lt;/b&gt; method later on, but it is not a thread safe solution unless I use a ThreadLocal wrapper etc.&lt;/p&gt;</comment>
                            <comment id="17550342" author="davsclaus" created="Mon, 6 Jun 2022 08:20:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=orpiske&quot; class=&quot;user-hover&quot; rel=&quot;orpiske&quot;&gt;orpiske&lt;/a&gt; sounds a bit like we should maybe react differently on TopicAuthorizationException out of the box?&lt;/p&gt;</comment>
                            <comment id="17550348" author="orpiske" created="Mon, 6 Jun 2022 08:40:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rgala&quot; class=&quot;user-hover&quot; rel=&quot;rgala&quot;&gt;rgala&lt;/a&gt;&#160; I think we should handle this differently, indeed. I need to research and think a bit about this. I am considering whether it would be easier to issue a call between the subscription and the poll that would ensure the authentication happens, so we can try to avoid over-complicating the poll handling strategy. This is, of course, a very early thought. So please, do let me know your suggestions if you have any ...&lt;/p&gt;</comment>
                            <comment id="17550351" author="orpiske" created="Mon, 6 Jun 2022 08:42:27 +0000"  >&lt;p&gt;BTW, I am assigning this one to me, but anyone interested in looking at it, please let me know as I have no ETA for looking at it just yet.&lt;/p&gt;</comment>
                            <comment id="17550467" author="rgala" created="Mon, 6 Jun 2022 13:30:23 +0000"  >&lt;p&gt;I would return false from canContinue() of&#160; BridgeErrorStrategy in case of this exception (or even all exceptions that extend KafkaException).&lt;/p&gt;</comment>
                            <comment id="17550471" author="orpiske" created="Mon, 6 Jun 2022 13:34:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rgala&quot; class=&quot;user-hover&quot; rel=&quot;rgala&quot;&gt;rgala&lt;/a&gt; thanks. If I come up with a quick patch for that, are you able to test?&lt;/p&gt;</comment>
                            <comment id="17550473" author="rgala" created="Mon, 6 Jun 2022 13:36:03 +0000"  >&lt;p&gt;If I manage to build Camel locally, then yes &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17550876" author="orpiske" created="Tue, 7 Jun 2022 08:37:38 +0000"  >&lt;p&gt;Hi, for now I worked on a quick fix based on your suggestion: &lt;a href=&quot;https://github.com/apache/camel/pull/7733&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/7733&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I&apos;d like to create a test case for it, but I don&apos;t have time right now. I&apos;ll keep the PR open for some time.&lt;/p&gt;</comment>
                            <comment id="17552603" author="orpiske" created="Fri, 10 Jun 2022 07:33:14 +0000"  >&lt;p&gt;I added a quick fix based on &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rgala&quot; class=&quot;user-hover&quot; rel=&quot;rgala&quot;&gt;rgala&lt;/a&gt; &apos;s suggestion. Please let me know or reopen the ticket in case it&apos;s still broken.&lt;/p&gt;

&lt;p&gt;Thanks everyone for the review and suggestions.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 22 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0y78w:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>