<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 11:02:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-19487] camel-core / camel-bean - Dynamic router instances pass messages to wrong endpoints with @DynamicRouter annotation</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-19487</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;This is actually reopening &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-9311&quot; title=&quot;Concurrency issue with the dynamic router&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-9311&quot;&gt;&lt;del&gt;CAMEL-9311&lt;/del&gt;&lt;/a&gt;, because DynamicRouterConcurrentPOJOTest that was added to reproduce it is still failing.&lt;/p&gt;

&lt;p&gt;First I thought the test is just flaky due to its bad design: it was calling &lt;tt&gt;assertMockEndpointsSatisfied()&lt;/tt&gt; without any synchronizations of the participating threads.&lt;/p&gt;

&lt;p&gt;But fixing that by adding &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
sendToSedaA.join(10000);
sendToSedaB.join(10000);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and replacing &lt;tt&gt;assertMockEndpointsSatisfied()&lt;/tt&gt; with some timeouted variant did not make the issue disappear.&lt;br/&gt;
The improved reproducer test can be seen in this branch: &lt;a href=&quot;https://github.com/ppalaga/camel/commits/CAMEL-19487&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ppalaga/camel/commits/CAMEL-19487&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Note that it is not always failing. On my machine, I see it failing like 1:10. Invoking it in a loop eventually leads to a failure:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
git fetch git@github.com:ppalaga/camel.git CAMEL-19487 
git checkout -b CAMEL-19487 FETCH_HEAD
# rebuild the tree
mvnd clean install -Pfastinstall

cd core/camel-core
set -e; &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;; &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; mvnd test -Dtest=DynamicRouterConcurrentPOJOTest#testConcurrentDynamicRouter; done
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The second commit &lt;a href=&quot;https://github.com/ppalaga/camel/commits/CAMEL-19487&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ppalaga/camel/commits/CAMEL-19487&lt;/a&gt; adds some debug output. &lt;br/&gt;
In case of failure it shows that one of the dynamic router instances sometimes sends one or more messages to the wrong endpoint.&lt;br/&gt;
Here is an example:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[INFO] Running org.apache.camel.processor.dynamicrouter.DynamicRouterConcurrentPOJOTest
...
[INFO] [stdout] ==== pipe a before Message from seda:a 74
...
[INFO] [stdout] ======= adding to mock:b: Message from seda:a 74
...
[INFO] [stdout] ==== pipe a after Message from seda:a 74 cnt 74
...
[ERROR] Tests run: 1, Failures: 1, Errors: 0, Skipped: 0, Time elapsed: 0.328 s &amp;lt;&amp;lt;&amp;lt; FAILURE! -- in org.apache.camel.processor.dynamicrouter.DynamicRouterConcurrentPOJOTest
[ERROR] org.apache.camel.processor.dynamicrouter.DynamicRouterConcurrentPOJOTest.testConcurrentDynamicRouter -- Time elapsed: 0.317 s &amp;lt;&amp;lt;&amp;lt; FAILURE!
java.lang.AssertionError: 
[Expected mock:b to contain only messages from seda:b, but there were also messages from seda:a] 
Expecting empty but was: [&lt;span class=&quot;code-quote&quot;&gt;&quot;Message from seda:a 74&quot;&lt;/span&gt;]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In this case the dynamic router instance attached to route a sends the message to mock:b. &lt;br/&gt;
I&apos;d say that&apos;s a serious bug.&lt;/p&gt;

&lt;p&gt;This is exactly what the original issue &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-9311&quot; title=&quot;Concurrency issue with the dynamic router&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-9311&quot;&gt;&lt;del&gt;CAMEL-9311&lt;/del&gt;&lt;/a&gt; was about.&lt;/p&gt;

&lt;p&gt;Observation:&lt;br/&gt;
The issue does not occur when each route uses a different dynamic router type: when I copy MyDynamicRouterPojo as MyDynamicRouterPojoB and use it in the route b, then all works as expected.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13541003">CAMEL-19487</key>
            <summary>camel-core / camel-bean - Dynamic router instances pass messages to wrong endpoints with @DynamicRouter annotation</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="ppalaga">Peter Palaga</reporter>
                        <labels>
                            <label>help-wanted</label>
                    </labels>
                <created>Thu, 22 Jun 2023 09:34:45 +0000</created>
                <updated>Tue, 24 Oct 2023 07:27:01 +0000</updated>
                            <resolved>Wed, 2 Aug 2023 15:59:04 +0000</resolved>
                                    <version>4.0-M3</version>
                                    <fixVersion>3.20.7</fixVersion>
                    <fixVersion>3.21.1</fixVersion>
                    <fixVersion>3.22.0</fixVersion>
                    <fixVersion>4.0.0</fixVersion>
                                    <component>camel-core</component>
                    <component>tests</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17736058" author="ppalaga" created="Thu, 22 Jun 2023 10:13:45 +0000"  >&lt;p&gt;I am not proficient enough in the underlying Camel code. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gnodet&quot; class=&quot;user-hover&quot; rel=&quot;gnodet&quot;&gt;gnodet&lt;/a&gt; or &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ggrzybek&quot; class=&quot;user-hover&quot; rel=&quot;ggrzybek&quot;&gt;ggrzybek&lt;/a&gt; could you please have a look?&lt;/p&gt;</comment>
                            <comment id="17736066" author="ppalaga" created="Thu, 22 Jun 2023 10:42:21 +0000"  >&lt;p&gt;Why is this minor, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="17737748" author="orpiske" created="Tue, 27 Jun 2023 16:07:15 +0000"  >&lt;p&gt;Just for the record: I logged &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-19425&quot; title=&quot;camel-core: DynamicRouterConcurrentPOJOTest is flaky&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-19425&quot;&gt;&lt;del&gt;CAMEL-19425&lt;/del&gt;&lt;/a&gt; as related to this (it&apos;s what it&apos;s used on the test description to disable it). I haven&apos;t had a chance to investigate this one yet.&lt;/p&gt;</comment>
                            <comment id="17749601" author="davsclaus" created="Tue, 1 Aug 2023 10:01:12 +0000"  >&lt;p&gt;Its when using  @DynamicRouter variant on a POJO that this can happen - works fine when using dynamicRouter EIP&lt;/p&gt;

&lt;p&gt;                from(&quot;seda:a&quot;)&lt;br/&gt;
                        .dynamicRouter(method(a, &quot;route&quot;));&lt;/p&gt;</comment>
                            <comment id="17749954" author="davsclaus" created="Tue, 1 Aug 2023 17:26:46 +0000"  >&lt;p&gt;For the POJO then this can only happen if you use the same class and instantiate different objects that have different destinations.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13547758">CAMEL-19759</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13539105">CAMEL-19425</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13555232">CAMEL-20035</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10062"><![CDATA[Moderate]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 15 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1ippk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>