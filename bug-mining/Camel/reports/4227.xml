<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:25:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-11697] S3 Consumer: If maxMessagesPerPoll is greater than 50 consumer fails to poll objects from bucket</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-11697</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;It is possible to configure S3 consumer to process several s3 objects in a single poll using the maxMessagesPerPoll property. &lt;/p&gt;

&lt;p&gt;If this property contains a small number, less than 50, everything works fine but if user tries to consume more files then s3 consumer simply fails all the time. It cannot poll files because there are not enough HTTP connections to open streams for all the requested files at once. The exception looks like this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;com.amazonaws.AmazonClientException: Unable to execute HTTP request: Timeout waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; connection from pool
	at com.amazonaws.http.AmazonHttpClient.executeHelper(AmazonHttpClient.java:544)
	at com.amazonaws.http.AmazonHttpClient.execute(AmazonHttpClient.java:273)
	at com.amazonaws.services.s3.AmazonS3Client.invoke(AmazonS3Client.java:3660)
	at com.amazonaws.services.s3.AmazonS3Client.getObject(AmazonS3Client.java:1133)
	at com.amazonaws.services.s3.AmazonS3EncryptionClient.access$201(AmazonS3EncryptionClient.java:65)
	at com.amazonaws.services.s3.AmazonS3EncryptionClient$S3DirectImpl.getObject(AmazonS3EncryptionClient.java:524)
	at com.amazonaws.services.s3.internal.crypto.S3CryptoModuleAE.getObjectSecurely(S3CryptoModuleAE.java:106)
	at com.amazonaws.services.s3.internal.crypto.CryptoModuleDispatcher.getObjectSecurely(CryptoModuleDispatcher.java:114)
	at com.amazonaws.services.s3.AmazonS3EncryptionClient.getObject(AmazonS3EncryptionClient.java:427)
	at com.amazonaws.services.s3.AmazonS3Client.getObject(AmazonS3Client.java:1005)
	at org.apache.camel.component.aws.s3.S3Consumer.createExchanges(S3Consumer.java:112)
	at org.apache.camel.component.aws.s3.S3Consumer.poll(S3Consumer.java:93)
	at org.apache.camel.impl.ScheduledPollConsumer.doRun(ScheduledPollConsumer.java:187)
	at org.apache.camel.impl.ScheduledPollConsumer.run(ScheduledPollConsumer.java:114)
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
	at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:308)
	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$301(ScheduledThreadPoolExecutor.java:180)
	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:294)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The issue happens because by default AmazonS3Client uses HTTP client with limited number of connections in the pool - 50. &lt;/p&gt;

&lt;p&gt;Since S3 consumer provides a possibility to consume any number of s3 objects in a single pool and because it is quite common case that someone needs to process 50 or more files in a single pool I think s3 consumer should handle this case properly. It should automatically change HTTP connections pool size to be able to handle requested number of objects. This can be done like this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ClientConfiguration s3Config = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ClientConfiguration();
/*
+20 we need to allocate a bit more to be sure that we always can &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; additional API calls when we already hold maxMessagesPerPoll s3 object streams opened
*/
s3Config.setMaxConnections(maxMessagesPerPoll + 20); 

AmazonS3Client client = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; AeAmazonS3Client(awsCreds, s3Config );
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13096962">CAMEL-11697</key>
            <summary>S3 Consumer: If maxMessagesPerPoll is greater than 50 consumer fails to poll objects from bucket</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="acosentino">Andrea Cosentino</assignee>
                                    <reporter username="mvlakh">MykhailoVlakh</reporter>
                        <labels>
                    </labels>
                <created>Wed, 23 Aug 2017 08:54:33 +0000</created>
                <updated>Thu, 24 Aug 2017 06:39:12 +0000</updated>
                            <resolved>Wed, 23 Aug 2017 13:25:43 +0000</resolved>
                                    <version>2.14.3</version>
                    <version>2.19.2</version>
                                    <fixVersion>2.20.0</fixVersion>
                                    <component>camel-aws</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16138303" author="ancosen" created="Wed, 23 Aug 2017 12:53:31 +0000"  >&lt;p&gt;We&apos;ll need to add a new options to the S3 configuration.&lt;/p&gt;</comment>
                            <comment id="16138337" author="ancosen" created="Wed, 23 Aug 2017 13:28:08 +0000"  >&lt;p&gt;Now you have a maxConnections options in the S3Configuration and you can tune it as you want, by default is 50.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/camel/blob/master/components/camel-aws/src/main/docs/aws-s3-component.adoc&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/blob/master/components/camel-aws/src/main/docs/aws-s3-component.adoc&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Since this is a new option it will be available in Camel 2.20.0&lt;/p&gt;</comment>
                            <comment id="16138359" author="mvlakh" created="Wed, 23 Aug 2017 13:43:47 +0000"  >&lt;p&gt;Hello &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ancosen&quot; class=&quot;user-hover&quot; rel=&quot;ancosen&quot;&gt;ancosen&lt;/a&gt;, thank you for a quick response. &lt;br/&gt;
I am not sure if this is the best way to fix this issue since user of the s3 consumer in this case should know how many connections the consumer needs. And since it is not obvious that all s3 objects will be opened simultaneously user will most likely ignore that setting until he/she gets a fault in run time.&lt;br/&gt;
I think the consumer should calculate a default value for this setting based on the value of the maxMessagesPerPoll  property to make sure that it always has enough connections unless user decided to use custom value. Do you agree?&lt;/p&gt;

&lt;p&gt;Also I am looking at the s3 consumer code and I do not understand why the consumer opens all the objects right away. Why cannot it open one object at a time when it actually initiates an exchange for it? This seems more efficient and requires only 1 connection at a time. What do you think?&lt;/p&gt;</comment>
                            <comment id="16138366" author="ancosen" created="Wed, 23 Aug 2017 13:49:30 +0000"  >&lt;p&gt;We can add an information on the documentation about having at least maxConnections &amp;gt;= maxMessagePerPoll. In my opinion forcing the maxConnection to be related to maxMessagePerPoll value (something like maxMessagePerPoll + 20) is not a good choice. Another solution is setting the maxConnections value equals to maxMessagePerPoll to be sure the connection pool is big enough.&lt;/p&gt;

&lt;p&gt;For the second question I need to take a more deeper look to the code, by the way as I say on the other issue opened by you, we love contributions, so feel free to open a PR or submit a patch.&lt;/p&gt;</comment>
                            <comment id="16138386" author="mvlakh" created="Wed, 23 Aug 2017 13:59:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ancosen&quot; class=&quot;user-hover&quot; rel=&quot;ancosen&quot;&gt;ancosen&lt;/a&gt; I suggested to add a little bit more connections to the pool to make sure that S3 consumer is able to perform some other S3 API calls when it already holds all the maxMessagePerPoll s3 objects opened. Otherwise all additional API call will fail since the pool will be empty at that point. If no additional API calls are expected then it is perfectly fine to have exacrt maxMessagePerPoll connections in the pool.&lt;/p&gt;

&lt;p&gt;Yes, I saw your proposition to contribute. If I find some free time I will take a look at the code once again and try to prepare a fix suggestion as a patch. But it would be nice to understand if there is any real reason to open all the objects before sending exchanges for processing. Because if this was intentional then there is no point to try change this code without knowing about that. &lt;/p&gt;

&lt;p&gt;Thank you!&lt;/p&gt;</comment>
                            <comment id="16139635" author="ancosen" created="Thu, 24 Aug 2017 06:39:12 +0000"  >&lt;p&gt;Ok, now the pool is equals to 50 (the default) + maxMessagesPerPoll.&lt;/p&gt;

&lt;p&gt;I&apos;ll take a look at the code to answer the other questions.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10061"><![CDATA[Novice]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 12 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3j6if:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>