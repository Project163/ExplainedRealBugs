<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:52:16 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-17536] ServicePool.doStop hangs during shutdown</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-17536</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;Camel sometimes hangs (100% usage of 1 CPU) during shutdown. This occurs intermittently during integration testing. We use &lt;tt&gt;recipientList&lt;/tt&gt; to perform some dynamic routing and many messages can be processed in parallel threads by &lt;tt&gt;recipientList&lt;/tt&gt; and there are a few of them in different routes (this will be important in a moment).&lt;/p&gt;

&lt;p&gt;Stack trace of stuck thread:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&quot;SpringApplicationShutdownHook&quot; #18 prio=5 os_prio=0 cpu=1784989.37ms elapsed=1790.21s tid=0x00007f7a13520000 nid=0xa80 runnable &#160;[0x00007f79a3af5000]
&#160; &#160;java.lang.Thread.State: RUNNABLE
&#160; &#160; at org.apache.camel.support.cache.ServicePool.stop(ServicePool.java:193)
&#160; &#160; at org.apache.camel.support.cache.ServicePool$$Lambda$2274/0x000000084108fc40.accept(Unknown Source)
&#160; &#160; at java.util.LinkedHashMap$LinkedValues.forEach(java.base@11.0.13/LinkedHashMap.java:608)
&#160; &#160; at org.apache.camel.support.cache.ServicePool.doStop(ServicePool.java:181)
&#160; &#160; at org.apache.camel.support.service.BaseService.stop(BaseService.java:160)
&#160; &#160; - locked &amp;lt;0x00000000e3ece780&amp;gt; (a java.lang.Object)
&#160; &#160; at org.apache.camel.support.service.ServiceHelper.stopService(ServiceHelper.java:162)
&#160; &#160; at org.apache.camel.support.cache.DefaultProducerCache.doStop(DefaultProducerCache.java:399)
&#160; &#160; at org.apache.camel.support.service.BaseService.stop(BaseService.java:160)
&#160; &#160; - locked &amp;lt;0x00000000e3ece740&amp;gt; (a java.lang.Object)
&#160; &#160; at org.apache.camel.support.service.ServiceHelper.stopService(ServiceHelper.java:162)
&#160; &#160; at org.apache.camel.support.service.ServiceHelper.stopService(ServiceHelper.java:147)
&#160; &#160; at org.apache.camel.processor.RecipientList.doStop(RecipientList.java:222)
&#160; &#160; at org.apache.camel.support.service.BaseService.stop(BaseService.java:160)
&#160; &#160; - locked &amp;lt;0x00000000e3ecdb00&amp;gt; (a java.lang.Object)
&#160; &#160; at org.apache.camel.support.service.ServiceHelper.stopService(ServiceHelper.java:162)
&#160; &#160; at org.apache.camel.support.service.ServiceHelper.stopService(ServiceHelper.java:165)
&#160; &#160; at org.apache.camel.support.service.ServiceHelper.stopService(ServiceHelper.java:147)
&#160; &#160; at org.apache.camel.processor.Pipeline.doStop(Pipeline.java:226)
&#160; &#160; at org.apache.camel.support.service.BaseService.stop(BaseService.java:160)
&#160; &#160; - locked &amp;lt;0x00000000e3ecda48&amp;gt; (a java.lang.Object)
&#160; &#160; at org.apache.camel.support.service.ServiceHelper.stopService(ServiceHelper.java:162)
&#160; &#160; at org.apache.camel.support.service.ServiceHelper.stopService(ServiceHelper.java:147)
&#160; &#160; at org.apache.camel.impl.engine.DefaultChannel.doStop(DefaultChannel.java:134)
&#160; &#160; at org.apache.camel.support.service.BaseService.stop(BaseService.java:160)
&#160; &#160; - locked &amp;lt;0x00000000e3eccde0&amp;gt; (a java.lang.Object)
&#160; &#160; at org.apache.camel.support.service.ServiceHelper.stopService(ServiceHelper.java:162)
&#160; &#160; at org.apache.camel.support.service.ServiceHelper.stopAndShutdownServices(ServiceHelper.java:257)
&#160; &#160; at org.apache.camel.support.service.ServiceHelper.stopAndShutdownServices(ServiceHelper.java:215)
&#160; &#160; at org.apache.camel.processor.errorhandler.RedeliveryErrorHandler.doShutdown(RedeliveryErrorHandler.java:1665)
&#160; &#160; at org.apache.camel.support.ChildServiceSupport.shutdown(ChildServiceSupport.java:113)
&#160; &#160; - locked &amp;lt;0x00000000e3ecc1e8&amp;gt; (a java.lang.Object)
&#160; &#160; at org.apache.camel.support.service.ServiceHelper.stopAndShutdownService(ServiceHelper.java:233)
&#160; &#160; at org.apache.camel.impl.engine.RouteService.stopChildServices(RouteService.java:409)
&#160; &#160; at org.apache.camel.impl.engine.RouteService.doStop(RouteService.java:260)
&#160; &#160; at org.apache.camel.support.ChildServiceSupport.stop(ChildServiceSupport.java:86)
&#160; &#160; - locked &amp;lt;0x00000000e40873a0&amp;gt; (a java.lang.Object)
&#160; &#160; at org.apache.camel.support.service.ServiceHelper.stopService(ServiceHelper.java:162)
&#160; &#160; at org.apache.camel.support.service.ServiceHelper.stopAndShutdownService(ServiceHelper.java:227)
&#160; &#160; at org.apache.camel.impl.engine.AbstractCamelContext.shutdownServices(AbstractCamelContext.java:3559)
&#160; &#160; at org.apache.camel.impl.engine.AbstractCamelContext.shutdownServices(AbstractCamelContext.java:3584)
&#160; &#160; at org.apache.camel.impl.engine.AbstractCamelContext.doStop(AbstractCamelContext.java:3366)
&#160; &#160; at org.apache.camel.spring.boot.SpringBootCamelContext.doStop(SpringBootCamelContext.java:61)
&#160; &#160; - locked &amp;lt;0x00000000e221e658&amp;gt; (a org.apache.camel.spring.boot.SpringBootCamelContext)
&#160; &#160; at org.apache.camel.support.service.BaseService.stop(BaseService.java:160)
&#160; &#160; - locked &amp;lt;0x00000000e221e8a8&amp;gt; (a java.lang.Object)
&#160; &#160; at org.apache.camel.impl.engine.AbstractCamelContext.stop(AbstractCamelContext.java:2640)
&#160; &#160; at org.apache.camel.spring.SpringCamelContext.stop(SpringCamelContext.java:128)
&#160; &#160; at org.springframework.context.support.DefaultLifecycleProcessor.doStop(DefaultLifecycleProcessor.java:247)
&#160; &#160; at org.springframework.context.support.DefaultLifecycleProcessor.access$300(DefaultLifecycleProcessor.java:54)
&#160; &#160; at org.springframework.context.support.DefaultLifecycleProcessor$LifecycleGroup.stop(DefaultLifecycleProcessor.java:373)
&#160; &#160; at org.springframework.context.support.DefaultLifecycleProcessor.stopBeans(DefaultLifecycleProcessor.java:206)
&#160; &#160; at org.springframework.context.support.DefaultLifecycleProcessor.onClose(DefaultLifecycleProcessor.java:129)
&#160; &#160; at org.springframework.context.support.AbstractApplicationContext.doClose(AbstractApplicationContext.java:1067)
&#160; &#160; at org.springframework.context.support.AbstractApplicationContext.close(AbstractApplicationContext.java:1021)
&#160; &#160; - locked &amp;lt;0x00000000e11e3868&amp;gt; (a java.lang.Object)
&#160; &#160; at org.springframework.boot.SpringApplicationShutdownHook.closeAndWait(SpringApplicationShutdownHook.java:137)
&#160; &#160; at org.springframework.boot.SpringApplicationShutdownHook$$Lambda$2265/0x0000000841088440.accept(Unknown Source)
&#160; &#160; at java.lang.Iterable.forEach(java.base@11.0.13/Iterable.java:75)
&#160; &#160; at org.springframework.boot.SpringApplicationShutdownHook.run(SpringApplicationShutdownHook.java:106)
&#160; &#160; at java.lang.Thread.run(java.base@11.0.13/Thread.java:829)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Deeper inspection of heap dump reveals that linked list in&#160;&lt;tt&gt;ServicePool.cache&lt;/tt&gt; is corrupted and has a loop, which causes &lt;tt&gt;foreach&lt;/tt&gt; to loop infinitely (see attached screenshot from heapdump analysis).&lt;/p&gt;

&lt;p&gt;Access to &lt;tt&gt;ServicePool.cache&lt;/tt&gt; is not synchronized even though &lt;tt&gt;LinkedHashMap&lt;/tt&gt; is not thread-safe. There is at least one code path that can add to the cache it concurrently (and indeed in this seems to happen in our tests):&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;org.apache.camel.processor.MulticastProcessor.process(Exchange, AsyncCallback)&lt;/li&gt;
	&lt;li&gt;org.apache.camel.processor.RecipientListProcessor.createProcessorExchangePairs(Exchange)&lt;/li&gt;
	&lt;li&gt;org.apache.camel.processor.RecipientListProcessor.doCreateProcessorExchangePairs(Exchange, Object, List&amp;lt;ProcessorExchangePair&amp;gt;, int)&lt;/li&gt;
	&lt;li&gt;org.apache.camel.support.cache.DefaultProducerCache.acquireProducer(Endpoint)&lt;/li&gt;
	&lt;li&gt;org.apache.camel.support.cache.ServicePool.acquire(Endpoint)&lt;/li&gt;
	&lt;li&gt;org.apache.camel.support.cache.ServicePool.cache&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;There are also a few unsynchronized invocations of &lt;tt&gt;DefaultProducerCache.acquireProducer&lt;/tt&gt; from other processors.&lt;/p&gt;

&lt;p&gt;I am not sure if other usages of &lt;tt&gt;cache&lt;/tt&gt; need to be synchronized, maybe Camel lifecycle provides enough serialization.&lt;br/&gt;
&#160;&lt;br/&gt;
The simpliest solution is to wrap &lt;tt&gt;cache&lt;/tt&gt; in &lt;tt&gt;Collections.synchronizedMap&lt;/tt&gt; but this might have negative impact on performance.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13424058">CAMEL-17536</key>
            <summary>ServicePool.doStop hangs during shutdown</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="krzysztofjamroz">Krzysztof Jamr&#243;z</reporter>
                        <labels>
                    </labels>
                <created>Fri, 21 Jan 2022 16:38:34 +0000</created>
                <updated>Mon, 24 Jan 2022 16:00:45 +0000</updated>
                            <resolved>Sun, 23 Jan 2022 08:45:45 +0000</resolved>
                                    <version>3.14.0</version>
                                    <fixVersion>3.14.1</fixVersion>
                    <fixVersion>3.15.0</fixVersion>
                                    <component>camel-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17480224" author="krzysztofjamroz" created="Fri, 21 Jan 2022 18:31:04 +0000"  >&lt;p&gt;I created a fix &lt;a href=&quot;https://github.com/apache/camel/pull/6806&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/6806&lt;/a&gt;. &lt;br/&gt;
&lt;tt&gt;Collections.synchronizedMap&lt;/tt&gt; cannot be used because we would loose information if &lt;tt&gt;cache&lt;/tt&gt; is &lt;tt&gt;LRUCache&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17480244" author="krzysztofjamroz" created="Fri, 21 Jan 2022 19:19:41 +0000"  >&lt;p&gt;Switch in Camel from Caffeine to DefaultLRUCache as default&#160; (only?) cache in &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-16093&quot; title=&quot;camel-caffeine-lrucache - Deprecate and move out of core&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-16093&quot;&gt;&lt;del&gt;CAMEL-16093&lt;/del&gt;&lt;/a&gt; makes the problem more likely&#160;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13424455">CAMEL-17544</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13354950">CAMEL-16093</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13039233" name="linkedhashmap corrupted.png" size="78854" author="krzysztofjamroz" created="Fri, 21 Jan 2022 16:16:20 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 42 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0yto8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>