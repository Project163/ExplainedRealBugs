<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:57:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-18350] camel-kafka: enabling &quot;breakOnFirstError&quot; causes camel to reconsume all records on error</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-18350</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;&lt;b&gt;Reproducing&lt;/b&gt;:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Configure camel kafka consumer with with &quot;breakOnFirstError&quot; = &quot;true&quot;&lt;/li&gt;
	&lt;li&gt;Produce a series of records to kafka record consumed by application&lt;/li&gt;
	&lt;li&gt;Ensure offset is commited&lt;/li&gt;
	&lt;li&gt;Produce more records&lt;/li&gt;
	&lt;li&gt;Trigger an error when processing one of the records&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;b&gt;Expected behavior:&lt;/b&gt;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Application should only reconsume records after the last committed offset&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;b&gt;Actual behavior:&lt;/b&gt;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Application reconsumes all records on topic&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Whether the erroneous behavior is triggered seem to be dependent on the offset the failing exchange has internally in the series of records in the poll.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I&apos;ve created a project on github with a failing test that reproduces the issue: &lt;a href=&quot;https://github.com/espeandr/camel-kafka-incorrectly-reconsumes-entire-topic-demo&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/espeandr/camel-kafka-incorrectly-reconsumes-entire-topic-demo&lt;/a&gt;. I haven&apos;t been able to find a pattern to which &quot;message offset&quot; in the poll causes the error. In the test I&apos;ve reproduced the error by forcing a max poll size as this simplifies the test setup. The issue is also reproducible without overriding maxPollSize.&lt;/p&gt;

&lt;p&gt;I suspect that offset = 0 is committed when breaking out in the erroneous cases.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13475171">CAMEL-18350</key>
            <summary>camel-kafka: enabling &quot;breakOnFirstError&quot; causes camel to reconsume all records on error</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="klease78">Karen Lease</assignee>
                                    <reporter username="eandre">Espen Andreassen</reporter>
                        <labels>
                    </labels>
                <created>Thu, 4 Aug 2022 13:04:41 +0000</created>
                <updated>Tue, 7 Nov 2023 10:08:05 +0000</updated>
                            <resolved>Thu, 29 Sep 2022 15:41:02 +0000</resolved>
                                    <version>3.18.0</version>
                                    <fixVersion>3.14.6</fixVersion>
                    <fixVersion>3.18.3</fixVersion>
                    <fixVersion>3.20.0</fixVersion>
                                    <component>camel-kafka</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17609931" author="eandre" created="Tue, 27 Sep 2022 09:27:28 +0000"  >&lt;p&gt;I think this bug is somewhat critical. It renders the only technique I know of for approximating &quot;exactly once&quot; useless. As stated in the description, it will cause redelivery of all records on topics in case of an error, which probably is pretty critical for users who have applied an exactly once technique.&lt;/p&gt;

&lt;p&gt;Here is a post on stackoverflow demonstrating that this technique probably is used by more than me:&lt;br/&gt;
&lt;a href=&quot;https://stackoverflow.com/questions/61621755/how-to-implement-exactly-once-kafka-consumer-using-apache-kafka&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://stackoverflow.com/questions/61621755/how-to-implement-exactly-once-kafka-consumer-using-apache-kafka&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17610377" author="davsclaus" created="Wed, 28 Sep 2022 06:54:39 +0000"  >&lt;p&gt;thanks for the test case, you are welcome to try to find a fix and send a PR. What happens if you set maxPollRecords to &amp;gt; 1 ?&lt;/p&gt;</comment>
                            <comment id="17610443" author="eandre" created="Wed, 28 Sep 2022 08:53:17 +0000"  >&lt;p&gt;Just had an incident where this error occurred in a running application. We first tried increasing the &quot;maxPollRecords&quot; and then enabling autocomit, but the application still went back to the earliest offset each time an error occurred. I suspect that &quot;breakOnFirstError&quot; = &quot;true&quot; is all that is needed to trigger this behavior.&lt;/p&gt;

&lt;p&gt;I&apos;ll see if I&apos;m able to update the test case to reproduce this behavior and confirm my suspicion.&lt;/p&gt;</comment>
                            <comment id="17610523" author="eandre" created="Wed, 28 Sep 2022 11:59:30 +0000"  >&lt;p&gt;I&apos;ve confirmed my suspicion. breakOnFirstError = true may cause this on its own. However, it also seems to be dependent on which offset in the series of polled records the error occurs. I&apos;ve updated the issue title, description, and test to clarify.&lt;/p&gt;</comment>
                            <comment id="17610568" author="klease78" created="Wed, 28 Sep 2022 13:06:46 +0000"  >&lt;p&gt;I started to look into it and it appears that setting the autoCommit to false is forcing Camel to use a no-op commit manager (which is &lt;b&gt;not&lt;/b&gt; what is written in the documentation) so in fact the offset is not correctly preserved:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2022-09-27 23:33:48.308 DEBUG &#160; --- [mer[test_topic]] o.a.c.c.kafka.consumer.CommitManagers &#160; &#160;: Allowing manual commit management
2022-09-27 23:33:48.308 DEBUG &#160; --- [mer[test_topic]] o.a.c.c.kafka.consumer.CommitManagers &#160; &#160;: Using an NO-OP commit manager &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; manual commit management&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;So I tried explicitly setting a commit manager, like so:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
.advanced()
 .kafkaManualCommitFactory(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.camel.component.kafka.consumer.DefaultKafkaManualCommitFactory())
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;After this it doesn&apos;t reconsume the messages before the failing one, but it seems only to consume the one after the failure. That&apos;s when using maxPollRecords(1). Without that, the test works, becaue the logs show that it is then seeking to offset 3 after the error and not -1.&lt;/p&gt;

&lt;p&gt;So there is something strange with the offset handling, as you found&#160; too.&lt;/p&gt;</comment>
                            <comment id="17610574" author="eandre" created="Wed, 28 Sep 2022 13:15:50 +0000"  >&lt;p&gt;Seems like you&apos;re onto somthing. To clarify, this happens regardless of autoCommit true or false. In my test case autoCommit is true/default (I updated this earlier today).&lt;/p&gt;</comment>
                            <comment id="17610604" author="klease78" created="Wed, 28 Sep 2022 14:51:47 +0000"  >&lt;p&gt;The problem is related to the number of messages polled at one time. In fact, the offset of the &quot;lastResult&quot; is always set to -1 on the first message in a batch of polled messages. If the error occurs on this message, then the offset for restarting is set to -1 which causes all messages to be reread.&lt;/p&gt;

&lt;p&gt;As you observed in your test, using 1, 2 or 4 as the polling size will cause the fifth message to be the first in a set of polled message which causes the incorrect behavior.&lt;/p&gt;

&lt;p&gt;As I&apos;m not familiar with camel-kafka, I don&apos;t yet have a suggestion for setting the correct offset for &quot;lastResult&quot; in the method KafkaRecordProcessorFacade.processPolledRecords().&lt;/p&gt;</comment>
                            <comment id="17610625" author="klease78" created="Wed, 28 Sep 2022 15:40:52 +0000"  >&lt;p&gt;I proposed a solution which makes your test work and doesn&apos;t break any others; let&apos;s see what the team thinks.&lt;/p&gt;</comment>
                            <comment id="17610818" author="eandre" created="Thu, 29 Sep 2022 06:17:02 +0000"  >&lt;p&gt;Great, thank you! Hoping the fix is included in next release&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13557008">CAMEL-20089</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13555368">CAMEL-20044</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 6 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z17h6o:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310080" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Regression</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10091"><![CDATA[Regression]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>