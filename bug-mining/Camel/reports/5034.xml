<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:37:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-13122] Potential bug in BeanExpression/HttpMessage</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-13122</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;I think I found a potential bug when using a bean to set a property if a message is coming through http. I wanted to check here before opening a bug in case I am missing something. It is very similar to the following bug which has already been fixed: &lt;a href=&quot;https://stackoverflow.com/questions/40293128/camel-rest-service-throws-exception-when-returning-null/40317432#40317432&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://stackoverflow.com/questions/40293128/camel-rest-service-throws-exception-when-returning-null/40317432#40317432&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The difference is that instead of returning null, an exception is thrown from the bean method. When that happen, I see the same behavior as described in the stackoverflow post above. &#160;I included an example on how to reproduce at the end of this email. Here is what I think happens:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Problem starts in BeanExpression:&lt;br/&gt;
 1. The exchange is copied, BeanExpression: line 194: Exchange resultExchange = ExchangeHelper.createCopy(exchange, true)&lt;br/&gt;
 2. The out body is then retrieved from the exchange, BeanExpression: line 201: result = resultExchange.getOut().getBody();&lt;br/&gt;
 3. Since out() is null, the in() message is copied to the out(), this makes a copy of the HttpMessage, which is copied along with the original ServletRequest (which contains a closed stream) DefaultExchange.class line 317.&lt;br/&gt;
 4. To copy the message from in to out, the method newInstance() from HttpMessage class is called. HttpMessage line 85&lt;br/&gt;
 5. At this point, the new instance of HttpMessage tries to read the stream from the original message which is already closed, IOException.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Example just below, I would be expecting the EXCEPTION_CAUGHT to be the RuntimeException I throw but instead it&apos;s a RuntimeBeanExpressionException effectively wrapping a IOException.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void configureTestException() {

&#160; restDefinitionV1 = restDefinitionV1

&#160;&#160;&#160; .get(&lt;span class=&quot;code-quote&quot;&gt;&quot;/throwException&quot;&lt;/span&gt;)

&#160;&#160;&#160; .route()

&#160;&#160;&#160;&#160; .onException(Exception.class)

&#160;&#160;&#160;&#160;&#160;&#160; .process(exchange -&amp;gt; {&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;Caught exception of type: &quot;&lt;/span&gt; + exchange.getProperty(Exchange.EXCEPTION_CAUGHT).getClass());} )

&#160;&#160;&#160;&#160;&#160;&#160; .handled(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)

&#160;&#160;&#160;&#160; .end()

&#160;&#160;&#160;&#160;&#160;&#160; .setProperty(&lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;).method(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TestBean(), &lt;span class=&quot;code-quote&quot;&gt;&quot;throwException&quot;&lt;/span&gt;)

&#160;&#160;&#160;&#160; .endRest();

}

&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;TestBean {

&#160; &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void throwException() {

&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RuntimeException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Excepting &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; exception to be handled by onException&quot;&lt;/span&gt;);

&#160; }

}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I will try to provide an actual unit test shortly.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13211575">CAMEL-13122</key>
            <summary>Potential bug in BeanExpression/HttpMessage</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="mkirouac">Micael Kirouac</reporter>
                        <labels>
                    </labels>
                <created>Thu, 24 Jan 2019 14:21:19 +0000</created>
                <updated>Fri, 11 Oct 2019 07:20:31 +0000</updated>
                            <resolved>Mon, 7 Oct 2019 08:42:03 +0000</resolved>
                                    <version>2.23.1</version>
                                    <fixVersion>3.0.0.RC3</fixVersion>
                    <fixVersion>3.0.0</fixVersion>
                                    <component>camel-servlet</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16763035" author="bedla" created="Thu, 7 Feb 2019 19:58:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mkirouac&quot; class=&quot;user-hover&quot; rel=&quot;mkirouac&quot;&gt;mkirouac&lt;/a&gt; &lt;del&gt;Could you confirm affected version? I was not able reproduce this in 2.23.1. Attaching passing unit test &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12957957/12957957_Camel13122Test.java&quot; title=&quot;Camel13122Test.java attached to CAMEL-13122&quot;&gt;Camel13122Test.java&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; based on your inputs.&lt;/del&gt;&lt;/p&gt;

&lt;p&gt;Now I see, the issue is related to camel-servlet and my unit test used camel-restlet. I was able to reproduce this with Arquillian test.&lt;/p&gt;</comment>
                            <comment id="16945684" author="davsclaus" created="Mon, 7 Oct 2019 08:42:03 +0000"  >&lt;p&gt;Fixed by &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-10425&quot; title=&quot;java.io.IOException: Stream closed - When setting result from bean in route&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-10425&quot;&gt;&lt;del&gt;CAMEL-10425&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12957957" name="Camel13122Test.java" size="1844" author="bedla" created="Thu, 7 Feb 2019 19:57:18 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 6 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|yi09s0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>