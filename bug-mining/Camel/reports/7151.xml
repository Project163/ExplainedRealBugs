<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 11:11:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-22127] ConcurrentModificationException is coming inside Camel&#8217;s Vert.x WebSocket</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-22127</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;h3&gt;&lt;a name=&quot;Whathappened&quot;&gt;&lt;/a&gt;What happened&lt;/h3&gt;

&lt;p&gt;&lt;tt&gt;ConcurrentModificationException&lt;/tt&gt; is coming &lt;b&gt;inside Camel&#8217;s Vert.x WebSocket&lt;/b&gt;&lt;br/&gt;
&lt;b&gt;producer&lt;/b&gt; while it traverses the collection that holds every live peer:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;org.apache.camel.component.vertx.websocket.VertxWebsocketEndpoint.findPeersForHostPort&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;findPeersForHostPort()&lt;/tt&gt; does&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;{{return connectedPeers.values() // Map&amp;lt;String,List&amp;lt;...&amp;gt;&amp;gt;&lt;br/&gt;
.stream() // &#8592; another thread can mutate&lt;br/&gt;
.flatMap(List::stream) // its internal ArrayList&lt;br/&gt;
.collect(Collectors.toList());}}&lt;/p&gt;

&lt;p&gt;While the stream is walking one of the internal &lt;tt&gt;ArrayList&lt;/tt&gt;s &lt;b&gt;another thread&lt;/b&gt;&lt;br/&gt;
&lt;b&gt;removes or adds a WebSocket&lt;/b&gt; (OPEN / CLOSE), so the underlying iterator throws&lt;br/&gt;
&lt;tt&gt;ConcurrentModificationException&lt;/tt&gt;.&lt;/p&gt;
&lt;hr /&gt;
&lt;h3&gt;&lt;a name=&quot;Howithappens%3F&quot;&gt;&lt;/a&gt;How it happens?&lt;/h3&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;getVertxHostRegistry().values() &#160; &#160; &#160; // Map.values() &#8594; mutable collection&lt;br/&gt;
&#160; &#160; &#160; .stream()&lt;/p&gt;

&lt;p&gt;~~~~&lt;br/&gt;
&#160; &#160; &#160; .flatMap(host -&amp;gt; host.getConnectedPeers().stream()) &#160; // &#8592; each host keeps&lt;br/&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; // &#160; a mutable List&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;If we check this &#160;host.getConnectedPeers()&#160; --&amp;gt; it is an arraylist :&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13076753/13076753_image-2025-05-29-17-27-30-528.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;Collections.synchronizedList(new ArrayList&amp;lt;&amp;gt;())&lt;/tt&gt; only &lt;b&gt;serialises each&lt;/b&gt;&lt;br/&gt;
&lt;b&gt;method call&lt;/b&gt; (&lt;tt&gt;add&lt;/tt&gt;, &lt;tt&gt;remove&lt;/tt&gt;, &lt;tt&gt;get&lt;/tt&gt;) &#8212; &lt;b&gt;its iterator is &lt;em&gt;not&lt;/em&gt; thread-safe&lt;/b&gt;.&lt;br/&gt;
If one thread is iterating while another thread mutates the list you still get&lt;br/&gt;
&lt;tt&gt;ConcurrentModificationException&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;How to fix:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;private final List&amp;lt;VertxWebsocketPeer&amp;gt; connectedPeers = new CopyOnWriteArrayList&amp;lt;&amp;gt;();&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;cheap reads and expensive writes ---&amp;gt; but better than Arraylist synchronized.&lt;/p&gt;
&lt;h3&gt;&lt;a name=&quot;Roughnumbers%28JVM17%2C1000peers%29&quot;&gt;&lt;/a&gt;Rough numbers (JVM 17, 1 000 peers)&lt;/h3&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Operation&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&lt;tt&gt;synchronizedList&lt;/tt&gt;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&lt;tt&gt;CopyOnWriteArrayList&lt;/tt&gt;&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Iterate (1 000 elements)&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;~3 &#181;s (lock + volatile read)&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;b&gt;~1 &#181;s&lt;/b&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Add / remove&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;~0.4 &#181;s&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;~0.7&#8211;1 &#181;s &lt;em&gt;(array copy)&lt;/em&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Net impact&lt;/b&gt;: latency &lt;b&gt;improves for every broadcast&lt;/b&gt; (no lock), while&lt;br/&gt;
the extra cost on connection OPEN/CLOSE is trivial because it happens only&lt;br/&gt;
once per client.&lt;br/&gt;
For a read-heavy fan-out list, &lt;tt&gt;CopyOnWriteArrayList&lt;/tt&gt; is the ideal trade-off. Hence - &lt;b&gt;switch to &lt;tt&gt;CopyOnWriteArrayList&lt;/tt&gt;&lt;/b&gt; &#8211; the read-path win outweighs the negligible write (only on open and close connections which do not happen very frequently)&lt;br/&gt;
cost and eliminates the &lt;tt&gt;ConcurrentModificationException&lt;/tt&gt; entirely.&lt;/p&gt;
&lt;h3&gt;&lt;a name=&quot;%C2%A0Anotheroption%C2%A0wecanreplaceitwithConcurrentHashmap.Keyset%28%29tostorehostedpeers.&quot;&gt;&lt;/a&gt;&#160;Another option&#160; - we can replace it with ConcurrentHashmap.Keyset() to store hosted peers.&lt;/h3&gt;
&lt;h3&gt;&lt;a name=&quot;Whyitshowsuponlyunderload&quot;&gt;&lt;/a&gt;Why it shows up only under load&lt;/h3&gt;
&lt;ul&gt;
	&lt;li&gt;With &lt;b&gt;1 000 connections&lt;/b&gt; and &lt;b&gt;32 writer threads&lt;/b&gt; you call the producer&lt;br/&gt;
thousands of times per second (worker threads iterate peers), while Vert.x&lt;br/&gt;
I/O threads register/un-register peers concurrently.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Under light traffic the race window is tiny, so you never notice it.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;b&gt;Root cause&lt;/b&gt;: Vert.x WebSocket producer iterates an &lt;tt&gt;ArrayList&lt;/tt&gt; while another&lt;br/&gt;
thread mutates it.&lt;/li&gt;
	&lt;li&gt;&lt;b&gt;Quick work-around&lt;/b&gt;: funnel writes through a single consumer queue.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Raw stacktrace:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;10:46:02.423 &lt;span class=&quot;error&quot;&gt;&amp;#91;Camel (camel-1) thread #31 - seda://outbound-delivery&amp;#93;&lt;/span&gt; WARN &#160;com.bp.ihub.template - Failed delivery for (MessageId: 0B49011231DA68D-0000000000560726 on ExchangeId: 0B49011231DA68D-000000000056154B). On delivery attempt: 0 caught: java.util.ConcurrentModificationException&lt;br/&gt;
java.util.ConcurrentModificationException: null&lt;br/&gt;
&#160; &#160; at java.base/java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:1631)&lt;br/&gt;
&#160; &#160; at java.base/java.util.stream.ReferencePipeline$Head.forEach(ReferencePipeline.java:762)&lt;br/&gt;
&#160; &#160; at java.base/java.util.stream.ReferencePipeline$7$1.accept(ReferencePipeline.java:276)&lt;br/&gt;
&#160; &#160; at java.base/java.util.stream.ReferencePipeline$2$1.accept(ReferencePipeline.java:179)&lt;br/&gt;
&#160; &#160; at java.base/java.util.stream.ReferencePipeline$2$1.accept(ReferencePipeline.java:179)&lt;br/&gt;
&#160; &#160; at java.base/java.util.concurrent.ConcurrentHashMap$ValueSpliterator.forEachRemaining(ConcurrentHashMap.java:3612)&lt;br/&gt;
&#160; &#160; at java.base/java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:509)&lt;br/&gt;
&#160; &#160; at java.base/java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:499)&lt;br/&gt;
&#160; &#160; at java.base/java.util.stream.ReduceOps$ReduceOp.evaluateSequential(ReduceOps.java:921)&lt;br/&gt;
&#160; &#160; at java.base/java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)&lt;br/&gt;
&#160; &#160; at java.base/java.util.stream.ReferencePipeline.collect(ReferencePipeline.java:682)&lt;br/&gt;
&#160; &#160; at org.apache.camel.component.vertx.websocket.VertxWebsocketEndpoint.findPeersForHostPort(VertxWebsocketEndpoint.java:234)&lt;br/&gt;
&#160; &#160; at org.apache.camel.component.vertx.websocket.VertxWebsocketProducer.getConnectedPeers(VertxWebsocketProducer.java:109)&lt;br/&gt;
&#160; &#160; at org.apache.camel.component.vertx.websocket.VertxWebsocketProducer.process(VertxWebsocketProducer.java:62)&lt;br/&gt;
&#160; &#160; at org.apache.camel.processor.SendProcessor.process(SendProcessor.java:210)&lt;br/&gt;
&#160; &#160; at org.apache.camel.management.DefaultInstrumentationProcessor.process(DefaultInstrumentationProcessor.java:90)&lt;br/&gt;
&#160; &#160; at org.apache.camel.processor.errorhandler.RedeliveryErrorHandler$RedeliveryTask.doRun(RedeliveryErrorHandler.java:840)&lt;br/&gt;
&#160; &#160; at org.apache.camel.processor.errorhandler.RedeliveryErrorHandler$RedeliveryTask.run(RedeliveryErrorHandler.java:746)&lt;br/&gt;
&#160; &#160; at org.apache.camel.impl.engine.DefaultReactiveExecutor$Worker.doRun(DefaultReactiveExecutor.java:199)&lt;br/&gt;
&#160; &#160; at org.apache.camel.impl.engine.DefaultReactiveExecutor$Worker.executeReactiveWork(DefaultReactiveExecutor.java:189)&lt;br/&gt;
&#160; &#160; at org.apache.camel.impl.engine.DefaultReactiveExecutor$Worker.tryExecuteReactiveWork(DefaultReactiveExecutor.java:166)&lt;br/&gt;
&#160; &#160; at org.apache.camel.impl.engine.DefaultReactiveExecutor$Worker.schedule(DefaultReactiveExecutor.java:148)&lt;br/&gt;
&#160; &#160; at org.apache.camel.impl.engine.DefaultReactiveExecutor.scheduleMain(DefaultReactiveExecutor.java:59)&lt;br/&gt;
&#160; &#160; at org.apache.camel.processor.Pipeline.process(Pipeline.java:163)&lt;br/&gt;
&#160; &#160; at org.apache.camel.impl.engine.CamelInternalProcessor.processNonTransacted(CamelInternalProcessor.java:354)&lt;br/&gt;
&#160; &#160; at org.apache.camel.impl.engine.CamelInternalProcessor.process(CamelInternalProcessor.java:330)&lt;br/&gt;
&#160; &#160; at org.apache.camel.component.seda.SedaConsumer.sendToConsumers(SedaConsumer.java:270)&lt;br/&gt;
&#160; &#160; at org.apache.camel.component.seda.SedaConsumer.doRun(SedaConsumer.java:188)&lt;br/&gt;
&#160; &#160; at org.apache.camel.component.seda.SedaConsumer.run(SedaConsumer.java:129)&lt;br/&gt;
&#160; &#160; at io.opentelemetry.context.Context.lambda$wrap$1(Context.java:241)&lt;br/&gt;
&#160; &#160; at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1136)&lt;br/&gt;
&#160; &#160; at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:635)&lt;br/&gt;
&#160; &#160; at io.opentelemetry.context.Context.lambda$wrap$1(Context.java:241)&lt;br/&gt;
&#160; &#160; at java.base/java.lang.Thread.run(Thread.java:840)&lt;/p&gt;</description>
                <environment></environment>
        <key id="13619534">CAMEL-22127</key>
            <summary>ConcurrentModificationException is coming inside Camel&#8217;s Vert.x WebSocket</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="kumargaura486807">Kumar Gaurav</reporter>
                        <labels>
                    </labels>
                <created>Thu, 29 May 2025 11:20:40 +0000</created>
                <updated>Thu, 5 Jun 2025 20:39:00 +0000</updated>
                            <resolved>Thu, 5 Jun 2025 20:39:00 +0000</resolved>
                                    <version>4.4.5</version>
                                    <fixVersion>4.8.8</fixVersion>
                    <fixVersion>4.10.6</fixVersion>
                    <fixVersion>4.13.0</fixVersion>
                                    <component>camel-platform-http-vertx</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17954928" author="davsclaus" created="Thu, 29 May 2025 12:18:44 +0000"  >&lt;p&gt;Can you try with latest release, 4.12.0 is being released now and JARs are uploaded&lt;/p&gt;</comment>
                            <comment id="17954931" author="davsclaus" created="Thu, 29 May 2025 12:29:22 +0000"  >&lt;p&gt;Oh yeah you are welcome to send a PR with the CopyOnWrite fix agains the main branch, then we can backport to older branches.&lt;/p&gt;

&lt;p&gt;But Camel 4.4 is EOL and wont be updated.&lt;/p&gt;</comment>
                            <comment id="17954963" author="JIRAUSER309520" created="Thu, 29 May 2025 14:44:36 +0000"  >&lt;p&gt;I will create PR with my fixes which resolved this as well as the issue with ValueSplitIterator of concurrent hashmap which has been coming when I fixed the&#160; CopyWONAL&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17954964" author="JIRAUSER309520" created="Thu, 29 May 2025 14:45:44 +0000"  >&lt;p&gt;Can you try with latest release, 4.12.0 is being released now and JARs are uploaded.&#160; &amp;gt;&amp;gt;&amp;gt;&#160; I cant upgrade to 4.12 as of now. It&#160; will be huge platform level upgrade to bump camel to this version.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13076753" name="image-2025-05-29-17-27-30-528.png" size="72812" author="kumargaura486807" created="Thu, 29 May 2025 11:57:30 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10062"><![CDATA[Moderate]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12314421" key="com.atlassian.jira.plugin.system.customfieldtypes:labels">
                        <customfieldname>Language</customfieldname>
                        <customfieldvalues>
                                        <label>java</label>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            23 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1w3g0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>