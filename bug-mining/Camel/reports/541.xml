<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:31:38 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-1467] OutOfMemory Exception in XMPP Component</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-1467</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;on publishing messages lots of messages using XMPP component (layered on top of Smack 3.0.4/3.1.0 client), Out of Memory Exception occurs. &lt;/p&gt;

&lt;p&gt;With standard JVM settings, client runs out of memory at around 6600 messages sent. With -Xmx1024M set, client runs out at ~110K messages sent.&lt;/p&gt;

&lt;p&gt;Appears that on a&lt;/p&gt;

&lt;p&gt;chat.sendMessage(message);&lt;/p&gt;

&lt;p&gt;The server sends the message back and the messages needs to be processed on the client side or the client will continue filling its local queue until it runs out of memory&lt;/p&gt;

&lt;p&gt;FIX:&lt;/p&gt;

&lt;p&gt;For XmppPrivateChatProducer and XmppGroupChatProducer, need to insert chat.nextMessage() after chat.sendMessage()&lt;/p&gt;

&lt;p&gt; public void process(Exchange exchange) {&lt;br/&gt;
   ...&lt;br/&gt;
        try &lt;/p&gt;
{
            chat.sendMessage(message);
            chat.nextMessage();
        }
&lt;p&gt; catch (XMPPException e) &lt;/p&gt;
{
            throw new RuntimeXmppException(e);
        }
&lt;p&gt;    }&lt;/p&gt;</description>
                <environment>&lt;p&gt;Mac OS 10.4.11, Java 1.5, Smack 3.0.4/3.1.0&lt;/p&gt;</environment>
        <key id="12486155">CAMEL-1467</key>
            <summary>OutOfMemory Exception in XMPP Component</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                            <parent id="12485960">CAMEL-2922</parent>
                                    <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="othuang">Orton Huang</reporter>
                        <labels>
                    </labels>
                <created>Thu, 19 Mar 2009 17:35:22 +0000</created>
                <updated>Thu, 8 Jul 2010 05:15:50 +0000</updated>
                            <resolved>Thu, 8 Jul 2010 05:15:50 +0000</resolved>
                                                    <fixVersion>1.6.1</fixVersion>
                    <fixVersion>2.0-M2</fixVersion>
                                    <component>camel-xmpp</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="300">5m</timeoriginalestimate>
                            <timeestimate seconds="300">5m</timeestimate>
                                        <comments>
                            <comment id="12951375" author="davsclaus" created="Fri, 20 Mar 2009 07:36:18 +0000"  >&lt;p&gt;Trunk: Committed revision 756348.&lt;br/&gt;
1.x: Committed revision 756358.&lt;/p&gt;</comment>
                            <comment id="12951377" author="davsclaus" created="Fri, 20 Mar 2009 07:37:33 +0000"  >&lt;p&gt;@Orton&lt;/p&gt;

&lt;p&gt;{{     chat.nextMessage();}} was only available in XmppGroupChatProducer. So I have only fixed it 1 place.&lt;br/&gt;
On XmppPrivateChatProducer the method does not exists.&lt;/p&gt;

</comment>
                            <comment id="12951382" author="othuang" created="Fri, 20 Mar 2009 15:40:43 +0000"  >&lt;p&gt;Hi Claus,&lt;/p&gt;

&lt;p&gt;Good to hear from you again. Hope you&apos;re doing well&lt;/p&gt;

&lt;p&gt;Sorry bout the confusion.&lt;/p&gt;

&lt;p&gt;In XmppPrivateChatProducer, the method that needs to be updated is:&lt;/p&gt;

&lt;p&gt;I added the chat.nextMessage() after the chat.sendMessage(message) (line 73) below:&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;

&lt;p&gt;------&lt;/p&gt;

&lt;p&gt;  public void process(Exchange exchange) {&lt;br/&gt;
        String threadId = exchange.getExchangeId();&lt;/p&gt;

&lt;p&gt;        try {&lt;br/&gt;
            ChatManager chatManager = endpoint.getConnection().getChatManager();&lt;br/&gt;
            Chat chat = chatManager.getThreadChat(threadId);&lt;/p&gt;

&lt;p&gt;            if (chat == null) {&lt;br/&gt;
                chat = chatManager.createChat(getParticipant(), threadId, new MessageListener() {&lt;br/&gt;
                    public void processMessage(Chat chat, Message message) &lt;/p&gt;
{
                        // not here to do conversation
                    }
&lt;p&gt;                });&lt;br/&gt;
            }&lt;/p&gt;

&lt;p&gt;            // TODO it would be nice if we could reuse the message from the exchange&lt;br/&gt;
            Message message = new Message();&lt;br/&gt;
            message.setTo(participant);&lt;br/&gt;
            message.setThread(threadId);&lt;br/&gt;
            message.setType(Message.Type.normal);&lt;/p&gt;

&lt;p&gt;            endpoint.getBinding().populateXmppMessage(message, exchange);&lt;br/&gt;
            if (LOG.isDebugEnabled()) &lt;/p&gt;
{
                LOG.debug(&quot;&amp;gt;&amp;gt;&amp;gt;&amp;gt; message: &quot; + message.getBody());
            }

&lt;p&gt;            chat.sendMessage(message);&lt;br/&gt;
            // receive the return message here - orton&lt;br/&gt;
            chat.nextMessage();&lt;br/&gt;
        } catch (XMPPException e) &lt;/p&gt;
{
            throw new RuntimeXmppException(e);
        }
&lt;p&gt;    }&lt;/p&gt;



</comment>
                            <comment id="12951358" author="davsclaus" created="Fri, 20 Mar 2009 17:51:07 +0000"  >&lt;p&gt;Orton&lt;/p&gt;

&lt;p&gt;There are &lt;b&gt;no&lt;/b&gt; nextMessage() on the chat object in XmppPrivateChatProducer.&lt;br/&gt;
Only the other one got the method.&lt;/p&gt;</comment>
                            <comment id="12951360" author="othuang" created="Fri, 20 Mar 2009 18:34:44 +0000"  >&lt;p&gt;Hi Claus,&lt;/p&gt;

&lt;p&gt;Ah, sorry little confusion. The nextMessage() needs to be in there to avoid the OOM exception...&lt;/p&gt;



&lt;p&gt;Orton&lt;/p&gt;


&lt;p&gt;On 3/20/09 12:52 PM, &quot;Claus Ibsen (JIRA)&quot; &amp;lt;jira@apache.org&amp;gt; wrote:&lt;/p&gt;



&lt;p&gt;    [ &lt;a href=&quot;https://issues.apache.org/activemq/browse/CAMEL-1467?page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel=50715#action_50715&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://issues.apache.org/activemq/browse/CAMEL-1467?page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel=50715#action_50715&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Claus Ibsen commented on &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-1467&quot; title=&quot;OutOfMemory Exception in XMPP Component&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-1467&quot;&gt;&lt;del&gt;CAMEL-1467&lt;/del&gt;&lt;/a&gt;:&lt;br/&gt;
------------------------------------&lt;/p&gt;

&lt;p&gt;Orton&lt;/p&gt;

&lt;p&gt;There are &lt;b&gt;no&lt;/b&gt; nextMessage() on the chat object in XmppPrivateChatProducer.&lt;br/&gt;
Only the other one got the method.&lt;/p&gt;


&lt;p&gt;&amp;#8211;&lt;br/&gt;
This message is automatically generated by JIRA.&lt;br/&gt;
-&lt;br/&gt;
You can reply to this email to add a comment to the issue online.&lt;/p&gt;

</comment>
                            <comment id="12951412" author="othuang" created="Thu, 26 Mar 2009 01:19:55 +0000"  >&lt;p&gt;Hi Claus,&lt;/p&gt;

&lt;p&gt;Just downloaded the Camel 1.6.1 version... Do you think you can make the same XMPP fixes in 1.6.1 that you made in 2.0?&lt;/p&gt;


&lt;p&gt;FIX:&lt;br/&gt;
For XmppPrivateChatProducer and XmppGroupChatProducer, need to insert chat.nextMessage() after chat.sendMessage()&lt;br/&gt;
 public void process(Exchange exchange) {&lt;br/&gt;
    ...&lt;br/&gt;
         try &lt;/p&gt;
{
             chat.sendMessage(message);
             chat.nextMessage(); // &amp;lt;----- this line needed!
         }
&lt;p&gt; catch (XMPPException e) &lt;/p&gt;
{
             throw new RuntimeXmppException(e);
         }
&lt;p&gt;           }&lt;/p&gt;


&lt;p&gt;Thanks!!&lt;br/&gt;
Orton&lt;/p&gt;


&lt;p&gt;On 3/20/09 12:52 PM, &quot;Claus Ibsen (JIRA)&quot; &amp;lt;jira@apache.org&amp;gt; wrote:&lt;/p&gt;



&lt;p&gt;    [ &lt;a href=&quot;https://issues.apache.org/activemq/browse/CAMEL-1467?page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel=50715#action_50715&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://issues.apache.org/activemq/browse/CAMEL-1467?page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel=50715#action_50715&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Claus Ibsen commented on &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-1467&quot; title=&quot;OutOfMemory Exception in XMPP Component&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-1467&quot;&gt;&lt;del&gt;CAMEL-1467&lt;/del&gt;&lt;/a&gt;:&lt;br/&gt;
------------------------------------&lt;/p&gt;

&lt;p&gt;Orton&lt;/p&gt;

&lt;p&gt;There are &lt;b&gt;no&lt;/b&gt; nextMessage() on the chat object in XmppPrivateChatProducer.&lt;br/&gt;
Only the other one got the method.&lt;/p&gt;


&lt;p&gt;&amp;#8211;&lt;br/&gt;
This message is automatically generated by JIRA.&lt;br/&gt;
-&lt;br/&gt;
You can reply to this email to add a comment to the issue online.&lt;/p&gt;

</comment>
                            <comment id="12951411" author="othuang" created="Thu, 26 Mar 2009 01:19:56 +0000"  >&lt;p&gt;Hi Claus,&lt;/p&gt;

&lt;p&gt;Just downloaded the Camel 1.6.1 version... Do you think you can make the same XMPP fixes in 1.6.1 that you made in 2.0?&lt;/p&gt;


&lt;p&gt;FIX:&lt;br/&gt;
For XmppPrivateChatProducer and XmppGroupChatProducer, need to insert chat.nextMessage() after chat.sendMessage()&lt;br/&gt;
 public void process(Exchange exchange) {&lt;br/&gt;
    ...&lt;br/&gt;
         try &lt;/p&gt;
{
             chat.sendMessage(message);
             chat.nextMessage(); // &amp;lt;----- this line needed!
         }
&lt;p&gt; catch (XMPPException e) &lt;/p&gt;
{
             throw new RuntimeXmppException(e);
         }
&lt;p&gt;           }&lt;/p&gt;


&lt;p&gt;Thanks!!&lt;br/&gt;
Orton&lt;/p&gt;


&lt;p&gt;On 3/20/09 12:52 PM, &quot;Claus Ibsen (JIRA)&quot; &amp;lt;jira@apache.org&amp;gt; wrote:&lt;/p&gt;



&lt;p&gt;    [ &lt;a href=&quot;https://issues.apache.org/activemq/browse/CAMEL-1467?page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel=50715#action_50715&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://issues.apache.org/activemq/browse/CAMEL-1467?page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel=50715#action_50715&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Claus Ibsen commented on &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-1467&quot; title=&quot;OutOfMemory Exception in XMPP Component&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-1467&quot;&gt;&lt;del&gt;CAMEL-1467&lt;/del&gt;&lt;/a&gt;:&lt;br/&gt;
------------------------------------&lt;/p&gt;

&lt;p&gt;Orton&lt;/p&gt;

&lt;p&gt;There are &lt;b&gt;no&lt;/b&gt; nextMessage() on the chat object in XmppPrivateChatProducer.&lt;br/&gt;
Only the other one got the method.&lt;/p&gt;


&lt;p&gt;&amp;#8211;&lt;br/&gt;
This message is automatically generated by JIRA.&lt;br/&gt;
-&lt;br/&gt;
You can reply to this email to add a comment to the issue online.&lt;/p&gt;

</comment>
                            <comment id="12951439" author="davsclaus" created="Fri, 27 Mar 2009 07:00:59 +0000"  >&lt;p&gt;Fixed it on XmppConsumer as well. Thanks orton&lt;/p&gt;

&lt;p&gt;trunk:  759033, 759036&lt;br/&gt;
1.x: 759035&lt;/p&gt;</comment>
                            <comment id="12953588" author="davsclaus" created="Sat, 21 Nov 2009 11:57:56 +0000"  >&lt;p&gt;Closing all 2.0M2 tickets&lt;/p&gt;</comment>
                            <comment id="12955708" author="mark.ford" created="Tue, 6 Jul 2010 12:14:56 +0000"  >&lt;p&gt;The patch for this bug was removed in revision 779121. The result is that the XMPPConsumer does not remove the message from the MultiUserChat and the possibility for an OutOfMemoryException still exists.&lt;/p&gt;

&lt;p&gt;The OOM occurs because the org.jivesoftware.smackx.muc.RoomListenerMultiplexor is a packet listener that contains a collector that stores all of the messages received up to a hard coded limit of 65k messages. These messages are not removed unless muc.pollMessage() or muc.nextMessage() is called. I&apos;m not sure the reason behind storing these messages in a collector. &lt;/p&gt;

&lt;p&gt;I have tested this in 2.1.0 and 2.3.0 and reviewed the code in 2.4-SNAPSHOT. I can supply a test case if needed.&lt;/p&gt;</comment>
                            <comment id="12955704" author="mark.ford" created="Tue, 6 Jul 2010 14:27:10 +0000"  >&lt;p&gt;Here&apos;s a relevant defect from the smack library:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://www.igniterealtime.org/issues/browse/SMACK-129&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.igniterealtime.org/issues/browse/SMACK-129&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12955702" author="davsclaus" created="Tue, 6 Jul 2010 15:29:10 +0000"  >&lt;p&gt;Yeah Mark a test case and a patch is much welcome.&lt;/p&gt;</comment>
                            <comment id="12952653" author="davsclaus" created="Thu, 8 Jul 2010 05:15:50 +0000"  >&lt;p&gt;This issue is continued at &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-2922&quot; title=&quot;XMPPConsumer does not remove the message which causes OOME with XMPP&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-2922&quot;&gt;&lt;del&gt;CAMEL-2922&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>76845</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 20 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i01ilb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6781</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>