<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:53:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-17588] Missing Clean-Up for DefaultReactiveExecutor.Worker-ThreadLocals</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-17588</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;We are running a Camel-Application on a Tomcat. While the Tomcat-Shutdown we observed a bunch of Thread-Local-WARNINGS in the catalina.out like:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
02-Feb-2022 01:31:23.810 SCHWERWIEGEND [main] org.apache.catalina.loader.WebappClassLoaderBase.checkThreadLocalMapForLeaks The web application [provinzial-integration-intern] created a ThreadLocal with key of type [java.lang.ThreadLocal.SuppliedThreadLocal] (value [java.lang.ThreadLocal$SuppliedThreadLocal@4a4357f5]) and a value of type [org.apache.camel.impl.engine.DefaultReactiveExecutor.Worker] (value [org.apache.camel.impl.engine.DefaultReactiveExecutor$Worker@76e66f23]) but failed to remove it when the web application was stopped. Threads are going to be renewed over time to &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; and avoid a probable memory leak.&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Obviously this belongs to the ThreadLocals used in &lt;em&gt;org.apache.camel.impl.engine.DefaultReactiveExecutor&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;In the worst case, this can lead to memory problems.&#160;&lt;br/&gt;
The ThreadLocals should be cleaned up.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13426229">CAMEL-17588</key>
            <summary>Missing Clean-Up for DefaultReactiveExecutor.Worker-ThreadLocals</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="10011">Won&apos;t Do</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="Ohm">Bj&#246;rn Ohm</reporter>
                        <labels>
                    </labels>
                <created>Wed, 2 Feb 2022 15:24:59 +0000</created>
                <updated>Mon, 4 Apr 2022 07:20:07 +0000</updated>
                            <resolved>Thu, 31 Mar 2022 04:50:08 +0000</resolved>
                                    <version>3.14.1</version>
                                    <fixVersion>3.17.0</fixVersion>
                                    <component>camel-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="17485995" author="davsclaus" created="Wed, 2 Feb 2022 17:58:57 +0000"  >&lt;p&gt;Thanks for reporting&lt;/p&gt;</comment>
                            <comment id="17503388" author="JIRAUSER284590" created="Wed, 9 Mar 2022 08:39:30 +0000"  >&lt;p&gt;After update to 3.14.2 there are unfortunately still a large number (correlate to load) of the same Thread-Local-SEVERE-Messages while Tomcat-Shutdown. (&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13040872/13040872_catalina.out&quot; title=&quot;catalina.out attached to CAMEL-17588&quot;&gt;catalina.out&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;)&lt;/p&gt;</comment>
                            <comment id="17504134" author="davsclaus" created="Thu, 10 Mar 2022 09:38:01 +0000"  >&lt;p&gt;Can you put together a small sample project we can use to reproduce this. You can attach the project to this jira as .zip or put code on github etc.&lt;/p&gt;</comment>
                            <comment id="17504140" author="davsclaus" created="Thu, 10 Mar 2022 09:45:32 +0000"  >&lt;p&gt;Had some more look and its not possible to cleanup all thread locals as different threads may have used the reactive engine.&lt;/p&gt;

&lt;p&gt;The worker is affinited per thread that uses the reactive engine.&lt;/p&gt;

&lt;p&gt;That is why you also see IBM and other frameworks in the tomcat log.&lt;/p&gt;</comment>
                            <comment id="17504193" author="JIRAUSER284590" created="Thu, 10 Mar 2022 11:16:46 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt; ,&lt;/p&gt;

&lt;p&gt;in my opinion this is not clean on the IBM-side either, but that&apos;s annother discussion&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;&#160;If you say the ThreadLocals can&apos;t or shouldn&apos;t be cleaned up after use on the thread, then I&apos;ll of course accept that, hoping it won&apos;t have any negative effects.&lt;/p&gt;

&lt;p&gt;Do you still need a sample project? Then I can try to make it available...&lt;/p&gt;

&lt;p&gt;Regards&lt;/p&gt;</comment>
                            <comment id="17504196" author="davsclaus" created="Thu, 10 Mar 2022 11:19:39 +0000"  >&lt;p&gt;The sample would help to investigate if there is some &quot;clever hacks&quot; - there are some using reflection to go inside JDK ThreadLocal but then you clear everytyhing and not only Camel. But you could maybe find out if the values inside ThreaadLocal impl are from Camel and not, and then only clear Camel.&lt;/p&gt;

&lt;p&gt;However I think its a dirty hack and the JDK documentation mentions that the JVM will automatic clear when classes are unloaded.&lt;/p&gt;

&lt;p&gt;And Tomcat is the only JEE server, that I have seen, that logs these WARNS on undeploying apps.&lt;/p&gt;</comment>
                            <comment id="17504222" author="davsclaus" created="Thu, 10 Mar 2022 12:24:11 +0000"  >&lt;p&gt;Okay I have some cleanup code as a clever hack. It would be good if you could put a sample project together (so I can try with SNAPSHOT jars of camel-core with the fix).&lt;br/&gt;
As the fix is &quot;ugly&quot; then we would likely have this as a special feature you need to turn on to use, then you can use this on apache tomcat.&lt;/p&gt;</comment>
                            <comment id="17504280" author="davsclaus" created="Thu, 10 Mar 2022 13:56:05 +0000"  >&lt;p&gt;There is a PR here&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/camel/pull/7182&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/7182&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17504969" author="JIRAUSER284590" created="Fri, 11 Mar 2022 15:22:09 +0000"  >&lt;p&gt;I knew from other situtions, where ThreadLocals are used, that they are cleaned up right after use (each time) in the current thread, typacilly in a finally-block (or similiar) and recreated new each time (I think this is the recommended way to handle ThreadLocals). I don&apos;t know, if this could be another approach (desired and possible).&#160;&lt;/p&gt;

&lt;p&gt;Your fix seems to be a one-time-cleanup while shutdown.&lt;br/&gt;
I tested it locally with my application and basically it worked (no more SEVERE-logs). But a problem could be, that the used &lt;em&gt;threads&lt;/em&gt;-Map could grow unbounded over the time??&#160;&lt;/p&gt;

&lt;p&gt;I have attached a small Camel-Spring-Boot-App &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13041002/13041002_plain-camel.zip&quot; title=&quot;plain-camel.zip attached to CAMEL-17588&quot;&gt;plain-camel.zip&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;, which started a CXF-Endpoint. After you post some SOAP-Requests, you can see in org.apache.camel.impl.engine.DefaultReactiveExecutor#workers the ThreadLocals... (see &lt;em&gt;/plain-camel/.readme&lt;/em&gt;).&lt;br/&gt;
Theres is also a UnitTest, which do this for you (&lt;em&gt;plain.camel.PlainCamelApplicationTest.callService()&lt;/em&gt;).&lt;br/&gt;
Of course this is just the case for incoming http-threads. I don&apos;t know in which cases the reactive-engine is used. For example we use JMS-Consumer with a thread-pool (growing and shrinking)...&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13041001/13041001_workers-threadLocals.PNG&quot; height=&quot;226&quot; width=&quot;268&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="17505207" author="davsclaus" created="Sat, 12 Mar 2022 07:38:14 +0000"  >&lt;p&gt;Hi&lt;/p&gt;

&lt;p&gt;Yeah Bjorn you are on to something, when you have many threads that are not long lived - then the thread locals internal array can grow (however they are weak referenced so they should be nulled over time) - and the JVM will automatic expunge stale entries (see the JDK source).&lt;/p&gt;

&lt;p&gt;But to be a good citizen then I think we can look at using a different pooling, see linked ticket created.&lt;/p&gt;</comment>
                            <comment id="17515232" author="davsclaus" created="Thu, 31 Mar 2022 10:46:27 +0000"  >&lt;p&gt;Thanks Bjorn for the test-case, there is a new camel-reactive-executor-tomcat module in Camel 3.17 that you can use.&lt;/p&gt;</comment>
                            <comment id="17516651" author="JIRAUSER284590" created="Mon, 4 Apr 2022 07:20:07 +0000"  >&lt;p&gt;Ok, I will try to remember that&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13430620">CAMEL-17712</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13433449">CAMEL-17785</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13040872" name="catalina.out" size="80891" author="Ohm" created="Wed, 9 Mar 2022 08:39:50 +0000"/>
                            <attachment id="13041002" name="plain-camel.zip" size="9807" author="Ohm" created="Fri, 11 Mar 2022 15:22:31 +0000"/>
                            <attachment id="13041001" name="workers-threadLocals.PNG" size="286786" author="Ohm" created="Fri, 11 Mar 2022 15:20:19 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 32 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0z6yw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>