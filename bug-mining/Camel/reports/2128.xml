<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:55:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-5907] Camel leaks memory on undeploy / redeploy in app server when JMX enabled and createConnector = true</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-5907</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;We have embedded Camel in an EAR that we deploy to Weblogic. The Camel context is configured via Spring:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &amp;lt;camelContext id=&lt;span class=&quot;code-quote&quot;&gt;&quot;camel&quot;&lt;/span&gt; handleFault=&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt; autoStartup=&lt;span class=&quot;code-quote&quot;&gt;&quot;{{autoStartup}}&quot;&lt;/span&gt; xmlns=&lt;span class=&quot;code-quote&quot;&gt;&quot;http:&lt;span class=&quot;code-comment&quot;&gt;//camel.apache.org/schema/spring&quot;&lt;/span&gt;&amp;gt;
&lt;/span&gt;        &amp;lt;contextScan /&amp;gt;
        &amp;lt;jmxAgent id=&lt;span class=&quot;code-quote&quot;&gt;&quot;camelAgent&quot;&lt;/span&gt; createConnector=&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt; registryPort=&lt;span class=&quot;code-quote&quot;&gt;&quot;{{jmxPort}}&quot;&lt;/span&gt; /&amp;gt;
    &amp;lt;/camelContext&amp;gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;You can see that we create a JMX connector to allow for remote management.&lt;/p&gt;

&lt;p&gt;However, we have run into PermGen space issues, because our application is leaking class loaders when the application is undeployed or redeployed.&lt;/p&gt;

&lt;p&gt;After digging around (and addressing some Jasper Reports ThreadLocal sloppiness), it appears that the only issue left is that the sun.rmi.transport.ObjectTable class maintains a static reference to all available RMI targets. Unfortunately, one of these targets is the JMX connector created by Camel, which was obviously loaded via our application&apos;s classloader.&lt;/p&gt;

&lt;p&gt;Thus, ObjectTable has a static reference to the Camel JMX RMI target, which has a reference to the app&apos;s class loader, which in turn has references to all classes loaded (and generated) for that single deployment of the application &amp;#8211; and none of these classes can be GC&apos;ed.&lt;/p&gt;

&lt;p&gt;After digging through the code for Camel&apos;s DefaultManagementAgent, I&apos;m inclined to believe that the fix is fairly simple:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Update &lt;tt&gt;createJmxConnector(String)&lt;/tt&gt; to cache the reference to the created &lt;tt&gt;Registry&lt;/tt&gt; in an instance variable.&lt;/li&gt;
&lt;/ol&gt;


&lt;ol&gt;
	&lt;li&gt;Update &lt;tt&gt;doStop()&lt;/tt&gt; to check if we have a cached &lt;tt&gt;Registry&lt;/tt&gt; instance, and if we do, call &lt;tt&gt;UnicastRemoteObject.unexportObject(registry, true);&lt;/tt&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Some app servers have workarounds for this sort of leak (see &quot;RMI targets&quot; in Table 1 at &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;), but Weblogic doesn&apos;t seem to.&lt;/p&gt;

&lt;p&gt;I&apos;ll also attach a screenshot of the memory analysis (more info at &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;).&lt;/p&gt;



&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;http://pic.dhe.ibm.com/infocenter/wasinfo/v8r5/index.jsp?topic=%2Fcom.ibm.websphere.express.doc%2Fae%2Fctrb_memleakdetection.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://pic.dhe.ibm.com/infocenter/wasinfo/v8r5/index.jsp?topic=%2Fcom.ibm.websphere.express.doc%2Fae%2Fctrb_memleakdetection.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; &lt;a href=&quot;http://www.yourkit.com/docs/kb/class_loaders.jsp&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.yourkit.com/docs/kb/class_loaders.jsp&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12625093">CAMEL-5907</key>
            <summary>Camel leaks memory on undeploy / redeploy in app server when JMX enabled and createConnector = true</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="njiang">Willem Jiang</assignee>
                                    <reporter username="sdanig">Daniel Gredler</reporter>
                        <labels>
                    </labels>
                <created>Sat, 22 Dec 2012 02:55:50 +0000</created>
                <updated>Wed, 2 Jan 2013 07:11:40 +0000</updated>
                            <resolved>Wed, 2 Jan 2013 07:11:40 +0000</resolved>
                                    <version>2.10.0</version>
                                    <fixVersion>2.9.6</fixVersion>
                    <fixVersion>2.10.4</fixVersion>
                    <fixVersion>2.11.0</fixVersion>
                                    <component>camel-jmx</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13538755" author="davsclaus" created="Sat, 22 Dec 2012 11:33:31 +0000"  >&lt;p&gt;Thanks for reporting.&lt;/p&gt;

&lt;p&gt;Would you be able to work on a patch with your suggested fix?&lt;/p&gt;

&lt;p&gt;There is a bit information about how to create and contribute patches at:&lt;br/&gt;
&lt;a href=&quot;http://camel.apache.org/contributing.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://camel.apache.org/contributing.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13539183" author="sdanig" created="Mon, 24 Dec 2012 04:41:30 +0000"  >&lt;p&gt;Yep, no problem. I&apos;ve contributed a couple of patches before &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I&apos;m including a unit test that verifies that the registry is cleaned up when the Camel context is stopped. The class that I added the test to doesn&apos;t really run the tests if you&apos;re on Windows, so watch out for that!&lt;/p&gt;</comment>
                            <comment id="13542037" author="davsclaus" created="Wed, 2 Jan 2013 07:11:40 +0000"  >&lt;p&gt;Thanks for the patch.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12562307" name="camel-5907.patch" size="5166" author="sdanig" created="Mon, 24 Dec 2012 04:42:02 +0000"/>
                            <attachment id="12562206" name="leak.png" size="243591" author="sdanig" created="Sat, 22 Dec 2012 02:58:50 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>301629</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 47 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i16v3z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>248172</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>