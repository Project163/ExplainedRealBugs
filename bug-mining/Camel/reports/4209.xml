<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:25:01 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-11623] LevelDB Java implementation wont be tried on Errors</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-11623</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;For a bit of background, we have been running into a problem with the LevelDB JNI drivers for AggregationRepositories, which prevents startup when using routes for which we require persistent aggregation. This, however, is not the main topic of this issue.&lt;/p&gt;

&lt;p&gt;In the latest version (2.19.2) the following issue has implemented a Java specific leveldb factory:&lt;/p&gt;

&lt;p&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-11427&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CAMEL-11427&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The relevant part of the Error on startup is as follows: &lt;/p&gt;

&lt;p&gt;java.lang.UnsatisfiedLinkError: Could not load library. Reasons: &lt;span class=&quot;error&quot;&gt;&amp;#91;no leveldbjni64-1.8 in java.library.path, no leveldbjni-1.8 in java.library.path, no leveldbjni in java.library.path, C:\Users\atos\AppData\Local\Temp\leveldbjni-64-1-794362262645531032.8: Can&amp;#39;t find dependent libraries&amp;#93;&lt;/span&gt; &lt;br/&gt;
at org.fusesource.hawtjni.runtime.Library.doLoad(Library.java:182) &lt;br/&gt;
at org.fusesource.hawtjni.runtime.Library.load(Library.java:140) &lt;br/&gt;
at org.fusesource.leveldbjni.JniDBFactory.(JniDBFactory.java:48) &lt;br/&gt;
at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method) &lt;br/&gt;
at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62) &lt;br/&gt;
at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45) &lt;br/&gt;
at java.lang.reflect.Constructor.newInstance(Constructor.java:423) &lt;br/&gt;
at java.lang.Class.newInstance(Class.java:442) &lt;br/&gt;
at org.apache.camel.component.leveldb.LevelDBFile.getFactory(LevelDBFile.java:189) &lt;br/&gt;
at org.apache.camel.component.leveldb.LevelDBFile.start(LevelDBFile.java:174) &lt;/p&gt;


&lt;p&gt;The way that I understand the code added in issue 11427, is that the LevelDBFile class getFactory() method (line 181) will first try to initiate with the JNI drivers and if that fails, will turn to the pure Java implementation. This is done by catching an Exception which is then ignored incase the JNI driver fails.&lt;/p&gt;

&lt;p&gt;However, when we look at the code we see that UnstatisfiedLinkError does not extend Exception, it extends Error.&lt;/p&gt;

&lt;p&gt;This Error is therefore not caught by the application and thus the Java implementation for LevelDB is never even attempted to be initialized as the method execution ends exceptionally at that point.&lt;/p&gt;

&lt;p&gt;So the main two questions are: &lt;br/&gt;
1) Was the code intended to catch this UnsatisfiedLinkageError (I know Errors are often considered a bad thing to catch) as a means to substitute the JNI driver, incase it fails?&lt;br/&gt;
2) If it is not supposed to catch this error, how can I use the pure Java implementation in this case? I expect that trying to exclude relevant packages also wont work as it will directly try to initiate the the JNI implementation by its name, which would fail also with an Error.&lt;/p&gt;


&lt;p&gt;So, in summary:&lt;br/&gt;
Is line 194 in class LevelDBFile in the camel-leveldb component supposed to catch an Error or more generally a Throwable instead of Exception?&lt;/p&gt;
</description>
                <environment></environment>
        <key id="13091852">CAMEL-11623</key>
            <summary>LevelDB Java implementation wont be tried on Errors</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="acosentino">Andrea Cosentino</assignee>
                                    <reporter username="kartasevm">Mart Karta&#353;ev</reporter>
                        <labels>
                    </labels>
                <created>Wed, 2 Aug 2017 10:38:13 +0000</created>
                <updated>Thu, 3 Aug 2017 10:13:48 +0000</updated>
                            <resolved>Thu, 3 Aug 2017 10:13:48 +0000</resolved>
                                    <version>2.19.2</version>
                                    <fixVersion>2.18.5</fixVersion>
                    <fixVersion>2.19.3</fixVersion>
                    <fixVersion>2.20.0</fixVersion>
                                    <component>camel-leveldb</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="16110698" author="kartasevm" created="Wed, 2 Aug 2017 10:43:21 +0000"  >&lt;p&gt;I assume this problem would be present in the 2.17.x, 2.18.x and 2.20.x branches as well, but they have not actually been released yet, so I am not sure how to mark the affects versions (see 11427 in regards to wrong version in Jira)&lt;/p&gt;</comment>
                            <comment id="16110699" author="davsclaus" created="Wed, 2 Aug 2017 10:43:47 +0000"  >&lt;p&gt;Yes catch Throwable. You are welcome to work on a patch or better yet a github PR&lt;br/&gt;
&lt;a href=&quot;http://camel.apache.org/contributing&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://camel.apache.org/contributing&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16110731" author="kartasevm" created="Wed, 2 Aug 2017 11:22:15 +0000"  >&lt;p&gt;I will start working on a PR.&lt;/p&gt;

&lt;p&gt;It looks as If I can&apos;t assign the task to myself on my own. Should it be assigned to me?&lt;/p&gt;</comment>
                            <comment id="16110742" author="davsclaus" created="Wed, 2 Aug 2017 11:33:04 +0000"  >&lt;p&gt;Mart, yeah its fine with a comment.&lt;/p&gt;

&lt;p&gt;We can grant rights to self assign tickets, but we tend to do this with users whom have worked on Camel a little bit more and shown interrest on helping out with many different things. &lt;/p&gt;</comment>
                            <comment id="16110744" author="davsclaus" created="Wed, 2 Aug 2017 11:33:25 +0000"  >&lt;p&gt;You can just do the github PR against master branch, then we backport to the older branches.&lt;/p&gt;</comment>
                            <comment id="16112400" author="davidkarlsen" created="Thu, 3 Aug 2017 08:18:33 +0000"  >&lt;p&gt;Handling Throwable is usually not a good practice (would catch OutOfMemoryError for instance) - maybe better and clearer to narrow to multicatch of UnsatisfiedLinkageError | Exception ?&lt;/p&gt;</comment>
                            <comment id="16112424" author="kartasevm" created="Thu, 3 Aug 2017 08:49:15 +0000"  >&lt;p&gt;I agree that in most cases it would be a bad practice and you might be correct that it is here as well. I would like to discuss a little first, though.&lt;/p&gt;

&lt;p&gt;I think that there are multiple types of Errors that might be relevant to catch here. For example NoClassDefFoundError, might be relevant as the fusesource JNI implementation is an optional include according to the POM, as is the iq80 java implementation. So technically we could exclude either of them and expecting to end up with an IllegalStateException instead.&lt;/p&gt;

&lt;p&gt;Say for example that we manually exclude fusesource packages entirely. Would we want it to fail with NoClassDefFoundError or have it catched and try the iq80 implementation?&lt;/p&gt;

&lt;p&gt;So my point is, are we trying to make sure that we try the Java implementation always, or only during the UnsatisfiedLinkageError?&lt;/p&gt;

&lt;p&gt;The point about the OutOfMemoryError is inarguably a sound one however... and catching throwable might hide some other odd problems, especially without logging.&lt;/p&gt;</comment>
                            <comment id="16112431" author="kartasevm" created="Thu, 3 Aug 2017 08:53:59 +0000"  >&lt;p&gt;LinkageError is a superclass of both NoClassDefFoundError and UnsatisfiedLinkageError..&lt;/p&gt;

&lt;p&gt;I am thinking that maybe specifying LinkageError as a more specific subset of Error might be relevant to this case?&lt;/p&gt;</comment>
                            <comment id="16112434" author="kartasevm" created="Thu, 3 Aug 2017 08:55:30 +0000"  >&lt;p&gt;I am not sure if ClassCircularity is something we want to catch here but many other subclasses of Linkage Error seem relevant though.&lt;/p&gt;</comment>
                            <comment id="16112439" author="davidkarlsen" created="Thu, 3 Aug 2017 08:57:04 +0000"  >&lt;p&gt;It&apos;s probably close enough. I am nitpicking a bit anyways - catching LinkageError will narrow it quite a bit to what was originally thought.&lt;/p&gt;</comment>
                            <comment id="16112446" author="davsclaus" created="Thu, 3 Aug 2017 08:58:35 +0000"  >&lt;p&gt;We catch throwable in many other places - this is fine as this is about loading the implementation on startup, and not while runtime routing. So I am +1 for the throwable.&lt;/p&gt;</comment>
                            <comment id="16112479" author="kartasevm" created="Thu, 3 Aug 2017 09:27:14 +0000"  >&lt;p&gt;Well I had already submitted the PR as catching a Throwable before David&apos;s comment. I could change it though.&lt;/p&gt;

&lt;p&gt;What would be preferable?&lt;/p&gt;</comment>
                            <comment id="16112481" author="ancosen" created="Thu, 3 Aug 2017 09:29:18 +0000"  >&lt;p&gt;Since we do the same in other places I guess it&apos;s ok to catch Throwable. Can you add the issue number to commit message?&lt;/p&gt;</comment>
                            <comment id="16112483" author="kartasevm" created="Thu, 3 Aug 2017 09:31:19 +0000"  >&lt;p&gt;I just saw your comment in GitHub. I am already doing so, no problem.&lt;/p&gt;</comment>
                            <comment id="16112531" author="githubbot" created="Thu, 3 Aug 2017 10:06:51 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/1866&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/1866&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                            <outwardlinks description="breaks">
                                        <issuelink>
            <issuekey id="13081028">CAMEL-11427</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 15 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ibfr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>