<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 11:12:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-22385] OpenTelemetry: Unclosed Span Scope with Parallel Multicast</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-22385</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;I&apos;m encountering a tracing issue with the&#160;&lt;tt&gt;camel-opentelemetry2&lt;/tt&gt;&#160;component, specifically when using a&#160;&lt;tt&gt;multicast&lt;/tt&gt;&#160;EIP with&#160;&lt;tt&gt;parallelProcessing&lt;/tt&gt;.&lt;br/&gt;
&lt;b&gt;Problem:&lt;/b&gt;&#160;The root&#160;&lt;tt&gt;Span&lt;/tt&gt;&#160;for my SQS-triggered route is failing to close. I believe this is because the&#160;&lt;tt&gt;Scope&lt;/tt&gt;&#160;associated with this span is not being properly closed and detached from the thread after the&#160;&lt;tt&gt;multicast&lt;/tt&gt;&#160;with&#160;&lt;tt&gt;parallelProcessing&lt;/tt&gt;&#160;completes.&lt;br/&gt;
&lt;b&gt;Observed Behavior:&lt;/b&gt;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;&lt;b&gt;Leaked Trace Context:&lt;/b&gt; Due to the unclosed scope, subsequent, unrelated spans (in this case SQS reads ) are incorrectly attached to the trace of the completed route.&lt;/li&gt;
	&lt;li&gt;&lt;b&gt;Cycle Repetition:&lt;/b&gt;&#160;This behavior persists until a new message is consumed from the SQS queue, which starts a new trace. However, this new trace then suffers from the same issue.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&lt;b&gt;Key Finding:&lt;/b&gt;&#160;The tracing behaves as expected (the root span&apos;s scope is closed correctly) if&#160;&lt;tt&gt;parallelProcessing&lt;/tt&gt;&#160;is removed from the&#160;&lt;tt&gt;multicast&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;This suggests an issue with how the OpenTelemetry tracer handles the thread context lifecycle during asynchronous, parallel processing. I&apos;ve attached screenshots illustrating the difference.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;See attached screenshots.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment>&lt;p&gt;Here&apos;s my configuration:&lt;/p&gt;

&lt;p&gt;```&lt;/p&gt;

&lt;p&gt;@Override&lt;br/&gt;
public void configure() {&lt;br/&gt;
&#160; // 1. Consume messages from a starting endpoint&lt;br/&gt;
&#160; from(RouteEndpoints.INBOUND_ENDPOINT.getValue())&lt;br/&gt;
&#160; &#160; .routeId(&quot;MyBusinessLogicRoute&quot;)&lt;/p&gt;

&lt;p&gt;&#160; &#160; // 2. Validate the incoming message&lt;br/&gt;
&#160; &#160; .choice()&lt;br/&gt;
&#160; &#160; &#160; // A generic predicate checks for validity&lt;br/&gt;
&#160; &#160; &#160; .when(header(&quot;isValid&quot;).isEqualTo(false))&lt;br/&gt;
&#160; &#160; &#160; &#160; .log(&quot;Invalid message received. Routing to dead-letter queue.&quot;)&lt;br/&gt;
&#160; &#160; &#160; &#160; .to(RouteEndpoints.DLQ_ENDPOINT.getValue()) // Send to Dead Letter Queue&lt;br/&gt;
&#160; &#160; &#160; .otherwise()&lt;br/&gt;
&#160; &#160; &#160; &#160; // 3. Route the message based on its type&lt;br/&gt;
&#160; &#160; &#160; &#160; .choice()&lt;br/&gt;
&#160; &#160; &#160; &#160; &#160; // Check for a specific &quot;type&quot; field in the JSON body&lt;br/&gt;
&#160; &#160; &#160; &#160; &#160; .when().jsonpath(&quot;$&lt;span class=&quot;error&quot;&gt;&amp;#91;?(@.messageType == &amp;#39;Confirmation&amp;#39;)&amp;#93;&lt;/span&gt;&quot;)&lt;br/&gt;
&#160; &#160; &#160; &#160; &#160; &#160; .to(RouteEndpoints.STORE_ENDPOINT.getValue()) // Store confirmation events&lt;br/&gt;
&#160; &#160; &#160; &#160; &#160; .otherwise()&lt;br/&gt;
&#160; &#160; &#160; &#160; &#160; &#160; // 4. Process other events in parallel&lt;br/&gt;
&#160; &#160; &#160; &#160; &#160; &#160; .multicast()&lt;br/&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; .parallelProcessing()&lt;br/&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; // Send to two different endpoints simultaneously&lt;br/&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; .to(RouteEndpoints.SEND_ENDPOINT.getValue(),&lt;br/&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; RouteEndpoints.STORE_ENDPOINT.getValue())&lt;br/&gt;
&#160; &#160; &#160; &#160; &#160; &#160; .end() // Closes the multicast&lt;br/&gt;
&#160; &#160; &#160; &#160; .end() // Closes the inner choice&lt;br/&gt;
&#160; &#160; .end(); // Closes the outer choice&lt;/p&gt;

&lt;p&gt;```&lt;/p&gt;</environment>
        <key id="13627542">CAMEL-22385</key>
            <summary>OpenTelemetry: Unclosed Span Scope with Parallel Multicast</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="squakez">Pasquale Congiusti</assignee>
                                    <reporter username="sergimola">Sergi Mola</reporter>
                        <labels>
                            <label>opentelemetry</label>
                            <label>telemetry</label>
                            <label>trace</label>
                            <label>tracing</label>
                    </labels>
                <created>Thu, 28 Aug 2025 10:20:39 +0000</created>
                <updated>Tue, 2 Sep 2025 11:26:10 +0000</updated>
                            <resolved>Tue, 2 Sep 2025 11:26:06 +0000</resolved>
                                    <version>4.14.0</version>
                                    <fixVersion>4.14.1</fixVersion>
                    <fixVersion>4.15.0</fixVersion>
                                    <component>camel-opentelemetry</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="18016796" author="JIRAUSER310836" created="Thu, 28 Aug 2025 13:57:00 +0000"  >&lt;p&gt;Here are some logs from setting opentelemetry to debug:&lt;/p&gt;

&lt;p&gt;```&lt;/p&gt;

&lt;p&gt;2025-08-28T13:50:58.200Z Camel (camel-1) thread #6 - Multicast DEBUG i.o.s.t.SdkSpan | Ignoring setStatus() description since status is not ERROR.&#160;&lt;br/&gt;
2025-08-28T13:50:58.202Z Camel (camel-1) thread #6 - Multicast DEBUG i.o.c.ThreadLocalContextStorage | &#160;Trying to close scope which does not represent current context. Ignoring the call.&#160;&lt;br/&gt;
2025-08-28T13:50:58.203Z Camel (camel-1) thread #6 - Multicast DEBUG i.o.c.ThreadLocalContextStorage | &#160;Trying to close scope which does not represent current context. Ignoring the call.&#160;&lt;br/&gt;
2025-08-28T13:50:58.203Z Camel (camel-1) thread #6 - Multicast DEBUG i.o.c.ThreadLocalContextStorage | &#160;Trying to close scope which does not represent current context. Ignoring the call.&#160;&lt;/p&gt;

&lt;p&gt;```&lt;/p&gt;</comment>
                            <comment id="18016961" author="squakez" created="Fri, 29 Aug 2025 07:13:30 +0000"  >&lt;p&gt;I&apos;m trying to reproduce the issue with a simpler route that don&apos;t involve external systems. In the while you may have a look at the multicast documentation &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; where it seems it is kind of expected that a new thread will span from the parallel thread pools. I am not entirely sure how this is affecting the telemetry and if that is the root cause. I&apos;d also need you to please tryout the same route against `camel-opentelemetry` component and to verify if the same behavior exists there or not.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://camel.apache.org/components/next/eips/multicast-eip.html#_multicasting_with_parallel_processing&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://camel.apache.org/components/next/eips/multicast-eip.html#_multicasting_with_parallel_processing&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="18016962" author="squakez" created="Fri, 29 Aug 2025 07:46:00 +0000"  >&lt;p&gt;FYI, I&apos;m testing a simpler multicast, both with direct and seda component:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        from(&lt;span class=&quot;code-quote&quot;&gt;&quot;timer:java?period=5000&quot;&lt;/span&gt;)
            .setBody()
                .simple(&lt;span class=&quot;code-quote&quot;&gt;&quot;Hello Camel from ${routeId}&quot;&lt;/span&gt;)
            .multicast()
                .parallelProcessing()
                .to(&lt;span class=&quot;code-quote&quot;&gt;&quot;seda:x&quot;&lt;/span&gt;)
                .to(&lt;span class=&quot;code-quote&quot;&gt;&quot;seda:y&quot;&lt;/span&gt;)
             .end();

         from(&lt;span class=&quot;code-quote&quot;&gt;&quot;seda:x&quot;&lt;/span&gt;).to(&lt;span class=&quot;code-quote&quot;&gt;&quot;log:multiX&quot;&lt;/span&gt;);
         from(&lt;span class=&quot;code-quote&quot;&gt;&quot;seda:y&quot;&lt;/span&gt;).to(&lt;span class=&quot;code-quote&quot;&gt;&quot;log:multiY&quot;&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;m not yet able to reproduce the issue. Would you mind also testing the above and verify if you have the same behavior with this route? I&apos;d like to check it out if it&apos;s really a problem on the multicast or possibly on the SQS component instead. Thanks.&lt;/p&gt;</comment>
                            <comment id="18016963" author="squakez" created="Fri, 29 Aug 2025 07:49:22 +0000"  >&lt;p&gt; &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13078153/13078153_simpler-multicast-otel2.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;/p&gt;</comment>
                            <comment id="18016969" author="squakez" created="Fri, 29 Aug 2025 08:04:28 +0000"  >&lt;p&gt;I&apos;m not getting the Span closure debug trace either.&lt;/p&gt;</comment>
                            <comment id="18017386" author="squakez" created="Mon, 1 Sep 2025 09:06:11 +0000"  >&lt;p&gt;I had another look at this issue. I think the problem could be with those components which are doing a poll against some service. What it happens is that, when running asynchronously, we keep track of any polling process, done repetitively until a given queue is empty. We start a new trace when there is some exchange, but in the while we need to understand to what trace those polling reads really belong, and, if we need to keep track of them at all.&lt;/p&gt;</comment>
                            <comment id="18017623" author="squakez" created="Tue, 2 Sep 2025 09:04:49 +0000"  >&lt;p&gt;I further update on this, I managed to replicate the problem.&lt;/p&gt;

&lt;p&gt;As I commented last time, the issue is related to the third party client used by aws2-sqs (and likely any other client instrumented with Otel). These are http based calls and are using as parent context the latest one available in Camel.  When we&apos;re in async mode, the call toward SQS to poll a message (but also to list or delete) can go to any other available thread on Camel context.&lt;/p&gt;

&lt;p&gt;This is happening also using the older opentelemetry implementation (though, in that case I got other operations, ie, delete). Although I understand it&apos;s bothering situation, this is really not affecting directly the other traces, so, beside the noise, the camel traces are consistent.&lt;/p&gt;

&lt;p&gt;I&apos;m continuing to work on this to try to find a solution. The ideal situation is to move those poll CLI calls outside the regular Camel processing tree, but it may be complicated to do that due to the way Camel share threads for optimization reasons.&lt;/p&gt;</comment>
                            <comment id="18017631" author="squakez" created="Tue, 2 Sep 2025 09:54:10 +0000"  >&lt;p&gt;Quick workaround is to use the `camel.opentelemetry2.traceProcessors=true`. With this option you won&apos;t have any further noise (although you have more spans due to the tracing of inner processors).&lt;/p&gt;</comment>
                            <comment id="18017637" author="JIRAUSER310836" created="Tue, 2 Sep 2025 10:31:38 +0000"  >&lt;p&gt;I can confirm the workaround solves the problem.&lt;/p&gt;

&lt;p&gt;It does add many more spans, but those could be removed if required later with the otel collector, for instance.&lt;/p&gt;

&lt;p&gt;Many thanks for the prompt support!&lt;/p&gt;</comment>
                            <comment id="18017639" author="squakez" created="Tue, 2 Sep 2025 10:42:08 +0000"  >&lt;p&gt;Happy that it worked. I am fixing this in 4.15 in &lt;a href=&quot;https://github.com/apache/camel/pull/19061&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/19061&lt;/a&gt; - it uses the same concept of the trace processors workaround, but without including any extra span. Once merged in 4.15 I will also backport to 4.14 for upcoming patch release on that version too.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13078153" name="simpler-multicast-otel2.png" size="58194" author="squakez" created="Fri, 29 Aug 2025 07:49:18 +0000"/>
                            <attachment id="13078143" name="with_parallel_processing.png" size="105377" author="sergimola" created="Thu, 28 Aug 2025 10:19:52 +0000"/>
                            <attachment id="13078142" name="without_parallel_processing.png" size="57830" author="sergimola" created="Thu, 28 Aug 2025 10:19:52 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1xgi0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>