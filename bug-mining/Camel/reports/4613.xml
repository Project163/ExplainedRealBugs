<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:30:53 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-12610] Camel bean component invokes cached instance of bean (that impl processor) in Registry</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-12610</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;Related SO question: &lt;a href=&quot;https://stackoverflow.com/questions/51108913/camel-bean-component-invokes-cached-instance-of-named-dependent-bean&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://stackoverflow.com/questions/51108913/camel-bean-component-invokes-cached-instance-of-named-dependent-bean&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Every invocation of bean component should query Registry for actual instance. Now it is cached in &lt;tt&gt;BeanProcessor#delegate&lt;/tt&gt; variable, even if endpoint parameter &lt;tt&gt;cache=false&lt;/tt&gt; specified.&lt;/p&gt;

&lt;p&gt;This behavior breaks&#160;java-ee&#160;compliance: &lt;a href=&quot;https://docs.oracle.com/javaee/7/api/javax/enterprise/context/Dependent.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://docs.oracle.com/javaee/7/api/javax/enterprise/context/Dependent.html&lt;/a&gt;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Every invocation of the&#160;&lt;a href=&quot;https://docs.oracle.com/javaee/7/api/javax/enterprise/context/spi/Context.html#get-javax.enterprise.context.spi.Contextual-javax.enterprise.context.spi.CreationalContext-&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;Context.get(Contextual, CreationalContext)&lt;/tt&gt;&lt;/a&gt;&#160;operation of the context object for the&#160;&lt;tt&gt;@Dependent&lt;/tt&gt;&#160;scope returns a new instance of the given bean.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Marking this as Major, because upgrading of Camel from 2.19.x to 2.2x.x leads to unpredictable results in CDI environment. Since this is tied to CDI environment, this issue is hard to notice even in well&#160;junit covered application and can result in major issues in pre-production or production environment.&lt;/p&gt;

&lt;p&gt;Full reproducible project with unit test and deployable WAR package, which passes&#160;with 2.19.x and lower. Fails with 2.20.x and higher &lt;a href=&quot;https://github.com/bedlaj/camel-dependent-bean&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;on Github&lt;/a&gt;.&#160;&lt;/p&gt;

&lt;p&gt;Attachments are based on version 2.21.1&lt;/p&gt;</description>
                <environment>&lt;p&gt;N/A&lt;/p&gt;</environment>
        <key id="13169403">CAMEL-12610</key>
            <summary>Camel bean component invokes cached instance of bean (that impl processor) in Registry</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="bedla">Jan Bednar</reporter>
                        <labels>
                    </labels>
                <created>Sun, 1 Jul 2018 14:17:13 +0000</created>
                <updated>Fri, 24 Aug 2018 09:46:25 +0000</updated>
                            <resolved>Fri, 24 Aug 2018 09:46:25 +0000</resolved>
                                    <version>2.20.3</version>
                    <version>2.21.1</version>
                    <version>2.22.0</version>
                                    <fixVersion>2.23.0</fixVersion>
                                    <component>camel-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16535957" author="njiang" created="Sun, 8 Jul 2018 01:56:34 +0000"  >&lt;p&gt;This issue is caused by the recent change of&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-11375&quot; title=&quot;Optimise - BeanProcessor - Make light-weight not as service&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-11375&quot;&gt;&lt;del&gt;CAMEL-11375&lt;/del&gt;&lt;/a&gt;, camel always try to get the processor from bean instance and the processor is is cached no matter the &quot;cache&quot; option is&#160;set or not. The quick fix could be avoiding using processor usage when the cached option is set.&lt;/p&gt;</comment>
                            <comment id="16535974" author="njiang" created="Sun, 8 Jul 2018 03:16:09 +0000"  >&lt;p&gt;Applied patch into master, camel-2.22.x and camel-2.21.x branches.&lt;/p&gt;</comment>
                            <comment id="16535975" author="njiang" created="Sun, 8 Jul 2018 03:20:33 +0000"  >&lt;p&gt;The workaround could be let the bean don&apos;t implement the Processor interface.&lt;/p&gt;</comment>
                            <comment id="16536649" author="davsclaus" created="Mon, 9 Jul 2018 08:06:42 +0000"  >&lt;p&gt;This cause test failures. Please run a full test of camel-core next time before committing.&lt;/p&gt;</comment>
                            <comment id="16536650" author="davsclaus" created="Mon, 9 Jul 2018 08:07:09 +0000"  >&lt;p&gt;The CI server also reports this error&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://builds.apache.org/job/Camel/job/master/455/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Camel/job/master/455/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16538182" author="davsclaus" created="Tue, 10 Jul 2018 07:34:21 +0000"  >&lt;p&gt;Okay so the problem is that this is only because of the bean implements Camel&apos;s Proccessor instance as Willem writes - you should not really do that - eithers its a POJO bean or its a processor with the .process EIP.&lt;/p&gt;

&lt;p&gt;Going to revert this as this breaks stuff, and the reporter can fix his pojo bean&lt;/p&gt;</comment>
                            <comment id="16538237" author="davsclaus" created="Tue, 10 Jul 2018 08:19:35 +0000"  >&lt;p&gt;Okay had to revert to keep existing behaviour.&#160;&lt;/p&gt;</comment>
                            <comment id="16538267" author="bedla" created="Tue, 10 Jul 2018 08:45:37 +0000"  >&lt;p&gt;Understand &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt;. Thanks. Our application relies on that. We have implemented hundreds of plugins, which are called dynamically with dynamicRouter based on rules defined in database. Every plugin is CDI bean and implements&#160;Processor interface. Because of the dynamicRouter it is not so easy replace bean component with .process EIP. I was thinking about replacing&#160;.to(&quot;bean:something&quot;) with .to(&quot;something&quot;), as described in Processor documentation, but it invokes the same instance too.&lt;/p&gt;</comment>
                            <comment id="16538296" author="njiang" created="Tue, 10 Jul 2018 09:07:44 +0000"  >&lt;p&gt;I&apos;m sorry the fix break the build(my bad), the issue is caused by the processor which is converted from bean should not be cached. If we set the cached option to false , it should get the new instance from the registry.  If we want to the POJO bean has nothing to do with the Processor converter, we may need to provide other way for use to inject their customer processor.&lt;/p&gt;

</comment>
                            <comment id="16538340" author="njiang" created="Tue, 10 Jul 2018 09:52:28 +0000"  >&lt;p&gt;Just found the current camel bean cached option is false by default ,  but it doesn&apos;t make sense that we keep the converted processor by default in AbstractBeanProcessor.  Can we set the default camel bean cached option to be true? &lt;/p&gt;</comment>
                            <comment id="16538507" author="njiang" created="Tue, 10 Jul 2018 12:41:07 +0000"  >&lt;p&gt;When I changed the default cached option to true,  a very old bug of test org.apache.camel.spring.config.ErrorHandlerTest just came out. As there is no exceptionProcessor bean in the registry, the test should failed. But as the deadLetterErrorHandler uses the RegistryBean by default, it doesn&apos;t find out the bean lookup issue when the service is started.&lt;/p&gt;</comment>
                            <comment id="16552091" author="bedla" created="Sun, 22 Jul 2018 17:16:05 +0000"  >&lt;p&gt;I dont think, this is resolved. Specially when title and severity of this issue changed. Just telling, that Processor cannot be bean is IMHO only shortcut, not real solution. But if this is expected behavior, that Processor is suposed to be singleton scope, it should be at least mentioned in documentation/javadoc. Maybe in Release Notes too, because it has been changed suddenly without notice.&lt;/p&gt;</comment>
                            <comment id="16552107" author="bedla" created="Sun, 22 Jul 2018 17:53:13 +0000"  >&lt;p&gt;The next thing. Right now, it looks, there is no way of&#160;using process EIP (as suggested by Claus),&#160;with registry lookup and&#160;without cache. &lt;tt&gt;.processRef(&quot;something&quot;)&lt;/tt&gt;, &lt;tt&gt;.process(&quot;something&quot;)&lt;/tt&gt;, &lt;tt&gt;.to(&quot;something&quot;)&lt;/tt&gt;, &lt;tt&gt;.toD(&quot;${header.destination}&quot;)&lt;/tt&gt;, &lt;tt&gt;.recipientList(simple(${header.destination}))&lt;/tt&gt; and &lt;tt&gt;dynamicRouter&lt;/tt&gt;. All of these methods invokes cached bean instance with header &lt;tt&gt;destination=&quot;something&quot;&lt;/tt&gt;. &lt;/p&gt;

&lt;p&gt;The &lt;tt&gt;.processRef(&quot;something&quot;)&lt;/tt&gt; is recomended way in &lt;a href=&quot;http://camel.apache.org/processor.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Processor docs&lt;/a&gt; &lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;If you need to lookup the processor in the Registry then you should use the processRef DSL:&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;and it is deprecated in master, but the cache is there too.&lt;/p&gt;</comment>
                            <comment id="16591333" author="davsclaus" created="Fri, 24 Aug 2018 08:39:02 +0000"  >&lt;p&gt;Trying to see if we can get a fix for this, so if you set cache=true. We can make it a global option on bean component so you can configure it once.&lt;/p&gt;</comment>
                            <comment id="16591410" author="davsclaus" created="Fri, 24 Aug 2018 09:44:30 +0000"  >&lt;p&gt;Okay got a fix, and also adding a global option on bean component to explicit turn on|off cache&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12929877" name="Referring objects for originalInstance.png" size="135571" author="bedla" created="Sun, 1 Jul 2018 17:07:41 +0000"/>
                            <attachment id="12929875" name="Stack during second invocation of SomeDependentBean.txt" size="2816" author="bedla" created="Sun, 1 Jul 2018 17:06:49 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 12 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3vfev:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>