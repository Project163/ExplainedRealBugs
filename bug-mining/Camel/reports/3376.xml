<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:10:49 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-9092] MQTT consumer receives duplicate messages after broker restart</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-9092</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;if clientId is specified, after ActiveMQ broker restart, camel-mqtt consumer starts to receive duplicate messages. Please see the testcase attached.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12857456">CAMEL-9092</key>
            <summary>MQTT consumer receives duplicate messages after broker restart</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="raulvk">Ra&#250;l Kripalani</assignee>
                                    <reporter username="igarashitm">Tomohisa Igarashi</reporter>
                        <labels>
                    </labels>
                <created>Thu, 20 Aug 2015 07:00:58 +0000</created>
                <updated>Fri, 28 Aug 2015 15:01:52 +0000</updated>
                            <resolved>Fri, 28 Aug 2015 15:01:52 +0000</resolved>
                                    <version>2.15.2</version>
                    <version>2.16.0</version>
                                    <fixVersion>2.16.0</fixVersion>
                    <fixVersion>2.15.4</fixVersion>
                                    <component>camel-mqtt</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14706291" author="davsclaus" created="Fri, 21 Aug 2015 06:31:38 +0000"  >&lt;p&gt;Maybe its a ActiveMQ problem?&lt;/p&gt;</comment>
                            <comment id="14706545" author="igarashitm" created="Fri, 21 Aug 2015 10:56:24 +0000"  >&lt;p&gt;Possibly, but so far it can&apos;t be reproduced without camel. I tried a plain ActiveMQ testcase with almost same broker settings on ActiveMQ 5.12.0 :&lt;br/&gt;
&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12751717/12751717_MQTTDuplicatesTest.java_activemq&quot; title=&quot;MQTTDuplicatesTest.java_activemq attached to CAMEL-9092&quot;&gt;MQTTDuplicatesTest.java_activemq&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;br/&gt;
 but it didn&apos;t hit any duplicates. I&apos;m still looking for the root cause, but I&apos;m kind of stuck &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14706707" author="igarashitm" created="Fri, 21 Aug 2015 12:56:39 +0000"  >&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12751717/12751717_MQTTDuplicatesTest.java_activemq&quot; title=&quot;MQTTDuplicatesTest.java_activemq attached to CAMEL-9092&quot;&gt;MQTTDuplicatesTest.java_activemq&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Tweaked to use CallbackConnection for sender as well - still it succeeds, so no duplicate. Note that this testcase depends on mqtt-client connection recovery feature unlike camel-mqtt is doing it by itself.&lt;/p&gt;</comment>
                            <comment id="14712621" author="githubbot" created="Wed, 26 Aug 2015 07:10:11 +0000"  >&lt;p&gt;GitHub user igarashitm opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/601&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/601&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-9092&quot; title=&quot;MQTT consumer receives duplicate messages after broker restart&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-9092&quot;&gt;&lt;del&gt;CAMEL-9092&lt;/del&gt;&lt;/a&gt; MQTT consumer receives duplicate messages after broker res&#8230;&lt;/p&gt;

&lt;p&gt;    &#8230;tart&lt;/p&gt;

&lt;p&gt;    Listener.onDisconnect() is also invoked when connection recovery occurs in mqtt-client internally, so it shouldn&apos;t attempt to reconnect from outside.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/igarashitm/camel&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/igarashitm/camel&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-9092&quot; title=&quot;MQTT consumer receives duplicate messages after broker restart&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-9092&quot;&gt;&lt;del&gt;CAMEL-9092&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/601.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/601.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #601&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit c4b2db9ded98f403f9705c4a56cc9c36f7cdad85&lt;br/&gt;
Author: Tomohisa Igarashi &amp;lt;tm.igarashi@gmail.com&amp;gt;&lt;br/&gt;
Date:   2015-08-26T07:03:23Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-9092&quot; title=&quot;MQTT consumer receives duplicate messages after broker restart&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-9092&quot;&gt;&lt;del&gt;CAMEL-9092&lt;/del&gt;&lt;/a&gt; MQTT consumer receives duplicate messages after broker restart&lt;/p&gt;

&lt;p&gt;    Listener.onDisconnect() is also invoked when connection recovery occurs in mqtt-client internally, so it shouldn&apos;t attempt to reconnect from outside.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="14712630" author="igarashitm" created="Wed, 26 Aug 2015 07:16:37 +0000"  >&lt;p&gt;I haven&apos;t yet made completely clear why that duplicates happen though, the pull request I submitted did fix the issue. As Listener.onDisconnected() is also invoked when connection recovery happens in mqtt-client internally, &lt;del&gt;invoking disconnect() due to this event triggers unnecessary connection re-initialization&lt;/del&gt; not really, just doing connected = false without disconnect(), so it&apos;s even worse as the old connection is remained open.&lt;br/&gt;
I also added setting tracer to MQTT when trace is enabled.&lt;/p&gt;</comment>
                            <comment id="14719305" author="githubbot" created="Fri, 28 Aug 2015 14:58:19 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/601&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/601&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14719312" author="raulvk" created="Fri, 28 Aug 2015 15:01:52 +0000"  >&lt;p&gt;The &lt;tt&gt;connected = true&lt;/tt&gt; is OK in &lt;tt&gt;onConnected()&lt;/tt&gt;.&lt;br/&gt;
Where it needed to be removed was from &lt;tt&gt;onDisconnected()&lt;/tt&gt; because the MQTT client handles its own reconnection. Setting &lt;tt&gt;connected = false&lt;/tt&gt; was tricking the endpoint into creating yet another connection while the original one was trying to reconnect. I think this led to more than 1 consumer showing up on the topic and hence the appearance of duplicates.&lt;/p&gt;

&lt;p&gt;Thanks for the report and the patch, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=igarashitm&quot; class=&quot;user-hover&quot; rel=&quot;igarashitm&quot;&gt;igarashitm&lt;/a&gt;. I merged it with the aforementioned change as well as making the &lt;tt&gt;uri&lt;/tt&gt; param final in the constructor of MQTTEndpoint.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12751429" name="MQTTDuplicatesTest.java" size="5740" author="igarashitm" created="Thu, 20 Aug 2015 07:02:04 +0000"/>
                            <attachment id="12751717" name="MQTTDuplicatesTest.java_activemq" size="8004" author="igarashitm" created="Fri, 21 Aug 2015 12:56:39 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 12 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2j57z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>