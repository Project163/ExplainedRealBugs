<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 11:03:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-19734] SEDA endpoint with multiple consumers produces strange message history from error handler</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-19734</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;I have a SEDA endpoint with multiple consumers enabled and three consumers configured and default error handler is in place.&lt;/p&gt;

&lt;p&gt;If one of the consumer queues becomes full then with the default error handler the message history is output but the first item is always one of the other consumers with a really large elapsed time (the system hasn&apos;t even been running this long) and then this is followed by the consumer route that actually threw the exception:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Message History (source location is disabled)
---------------------------------------------------------------------------------------------------------------------------------------
Source &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; ID &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; Processor &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;Elapsed (ms)
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;ClientInbound-ReadSimulatorSta from[seda:&lt;span class=&quot;code-comment&quot;&gt;//ClientInboundQueue?concurrentConsumers &#160; 1201857883
&lt;/span&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;ClientInbound-EventProcessor/p Processor@0x713c4d95 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;0
  &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;ClientInbound-EventProcessor/c choice[when[{body &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; xxx &#160; &#160; &#160; &#160;                   &#160; &#160;0
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;ClientInbound-EventProcessor/t seda:&lt;span class=&quot;code-comment&quot;&gt;//AttributeEventQueue?waitForTaskToComplete=I &#160; &#160; &#160; &#160; &#160; &#160;0
&lt;/span&gt;Stacktrace
---------------------------------------------------------------------------------------------------------------------------------------
java.lang.IllegalStateException: Queue full
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;So from the above `ClientInbound-ReadSimulatorState` is one of the multiple consumers that doesn&apos;t throw an exception.&lt;br/&gt;
`ClientInbound-EventProcessor` is the route that has a full queue which results in the queue full exception.&lt;/p&gt;

&lt;p&gt;I would expect to only see the `ClientInbound-EventProcessor` in the message history here; the first route in the history log seems to alternate between the two consumers that didn&apos;t generate the exception on successive error logs but they always have this strange elapsed time, here&apos;s a log showing the third consumer listed first:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Message History (source location is disabled)
---------------------------------------------------------------------------------------------------------------------------------------
Source &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; ID &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; Processor &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;Elapsed (ms)
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;ClientInbound-Query/ClientInbo from[seda:&lt;span class=&quot;code-comment&quot;&gt;//ClientInboundQueue?concurrentConsumers &#160; 1201857882
&lt;/span&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;ClientInbound-EventProcessor/p Processor@0x713c4d95 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;0
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;ClientInbound-EventProcessor/c choice[when[{body &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; xxx                   &#160; &#160; &#160; &#160; &#160; &#160;0
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;ClientInbound-EventProcessor/t seda:&lt;span class=&quot;code-comment&quot;&gt;//AttributeEventQueue?waitForTaskToComplete=I &#160; &#160; &#160; &#160; &#160; &#160;0
&lt;/span&gt;Stacktrace
---------------------------------------------------------------------------------------------------------------------------------------
java.lang.IllegalStateException: Queue full
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13546830">CAMEL-19734</key>
            <summary>SEDA endpoint with multiple consumers produces strange message history from error handler</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rhuanrocha">Rhuan Rocha</assignee>
                                    <reporter username="richturner">Rich T</reporter>
                        <labels>
                    </labels>
                <created>Thu, 10 Aug 2023 13:02:49 +0000</created>
                <updated>Tue, 12 Dec 2023 13:25:04 +0000</updated>
                            <resolved>Mon, 11 Dec 2023 09:03:48 +0000</resolved>
                                    <version>3.20.6</version>
                                    <fixVersion>3.21.4</fixVersion>
                    <fixVersion>3.22.0</fixVersion>
                    <fixVersion>4.0.4</fixVersion>
                    <fixVersion>4.3.0</fixVersion>
                                    <component>camel-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17752813" author="davsclaus" created="Thu, 10 Aug 2023 14:18:15 +0000"  >&lt;p&gt;What camel version do you use&lt;/p&gt;</comment>
                            <comment id="17752814" author="richturner" created="Thu, 10 Aug 2023 14:20:42 +0000"  >&lt;p&gt;3.20.6 which I put in the issue details &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17752817" author="davsclaus" created="Thu, 10 Aug 2023 14:27:20 +0000"  >&lt;p&gt;Can you put together a sample project / route / unit test or something we can use to reproduce this. &lt;/p&gt;</comment>
                            <comment id="17752822" author="richturner" created="Thu, 10 Aug 2023 14:31:55 +0000"  >&lt;p&gt;I don&apos;t have time at the moment but I will put it on my list.&lt;/p&gt;

&lt;p&gt;I don&apos;t know camel internaIs, is there any existing unit tests that cover exhaustion/error logging that could be leveraged?&lt;/p&gt;</comment>
                            <comment id="17753258" author="davsclaus" created="Fri, 11 Aug 2023 15:28:32 +0000"  >&lt;p&gt;So you route between seda queues&lt;/p&gt;


&lt;p&gt;from seda A&lt;br/&gt;
   ... some eip stuff here&lt;br/&gt;
    to seda B&lt;/p&gt;

&lt;p&gt;And its when seda B queue is full you see the history that may appear as mixed data&lt;/p&gt;</comment>
                            <comment id="17753980" author="richturner" created="Mon, 14 Aug 2023 10:31:59 +0000"  >&lt;p&gt;Correct,&lt;/p&gt;

&lt;p&gt;ClientInboundQueue is a multicast SEDA configured as:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
seda:&lt;span class=&quot;code-comment&quot;&gt;//ClientInboundQueue?multipleConsumers=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;amp;concurrentConsumers=2&amp;amp;waitForTaskToComplete=IfReplyExpected&amp;amp;purgeWhenStopping=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;amp;discardIfNoConsumers=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;amp;limitConcurrentConsumers=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&amp;amp;size=1000&lt;/span&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I have 3 routes consuming from this endpoint and the route where the exception occurs (routeId: ClientInbound-EventProcessor) routes to the following SEDA single consumer endpoint:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
seda:&lt;span class=&quot;code-comment&quot;&gt;//AttributeEventQueue?waitForTaskToComplete=IfReplyExpected&amp;amp;timeout=10000&amp;amp;purgeWhenStopping=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;amp;discardIfNoConsumers=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&amp;amp;size=25000&lt;/span&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The `AttributeEventQueue` reaches its&apos; size limit and then as expected exceptions are thrown but the message history log for some reason shows one of the un-related `ClientInboundQueue` consumers (that never route to `AttributeEventQueue`) with a huge ElapsedTime and then immediately after it is the route that actually caused the exception:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ClientInbound-EventProcessor -&amp;gt; AttributeEventQueue&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Hopefully this explains everything and thanks for your assistance.&lt;/p&gt;</comment>
                            <comment id="17772701" author="JIRAUSER297305" created="Fri, 6 Oct 2023 21:53:06 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=richturner&quot; class=&quot;user-hover&quot; rel=&quot;richturner&quot;&gt;richturner&lt;/a&gt;, I&apos;m trying to reproduce the issue you described, but I haven&apos;t been successful. &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13063391/13063391_camel-seda-reproducer.zip&quot; title=&quot;camel-seda-reproducer.zip attached to CAMEL-19734&quot;&gt;camel-seda-reproducer.zip&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Look at this&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;SedaTest &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; CamelTestSupport {

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; Logger logger = LoggerFactory.getLogger(SedaTest.class);
    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testMock() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        getMockEndpoint(&lt;span class=&quot;code-quote&quot;&gt;&quot;mock:result&quot;&lt;/span&gt;).expectedBodiesReceived(&lt;span class=&quot;code-quote&quot;&gt;&quot;Hello World&quot;&lt;/span&gt;);

        ExecutorService WORKER_THREAD_POOL = Executors.newFixedThreadPool(3);
        template.sendBody(&lt;span class=&quot;code-quote&quot;&gt;&quot;seda:&lt;span class=&quot;code-comment&quot;&gt;//ClientInboundQueue-one&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;Hello World&quot;&lt;/span&gt;);
&lt;/span&gt;        template.sendBody(&lt;span class=&quot;code-quote&quot;&gt;&quot;seda:&lt;span class=&quot;code-comment&quot;&gt;//ClientInboundQueue-two&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;Hello World&quot;&lt;/span&gt;);
&lt;/span&gt;        template.sendBody(&lt;span class=&quot;code-quote&quot;&gt;&quot;seda:&lt;span class=&quot;code-comment&quot;&gt;//ClientInboundQueue-tree&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;Hello World&quot;&lt;/span&gt;);
&lt;/span&gt;        MockEndpoint.assertIsSatisfied(context);
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; RoutesBuilder createRouteBuilder() {
        context.setMessageHistory(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RouteBuilder() {
            @Override
            &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void configure() {
                from(&lt;span class=&quot;code-quote&quot;&gt;&quot;seda:&lt;span class=&quot;code-comment&quot;&gt;//ClientInboundQueue-one?&quot;&lt;/span&gt; +
&lt;/span&gt;                        &lt;span class=&quot;code-quote&quot;&gt;&quot;multipleConsumers=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;amp;&quot;&lt;/span&gt; +
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;concurrentConsumers=2&amp;amp;&quot;&lt;/span&gt; +
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;waitForTaskToComplete=IfReplyExpected&amp;amp;&quot;&lt;/span&gt; +
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;purgeWhenStopping=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;amp;&quot;&lt;/span&gt; +
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;discardIfNoConsumers=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;amp;&quot;&lt;/span&gt; +
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;limitConcurrentConsumers=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&amp;amp;&quot;&lt;/span&gt; +
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;size=1000&quot;&lt;/span&gt;)
                        .process(exchange -&amp;gt; logger.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Executing ClientInboundQueue-one&quot;&lt;/span&gt;))
                        .to(&lt;span class=&quot;code-quote&quot;&gt;&quot;seda:&lt;span class=&quot;code-comment&quot;&gt;//AttributeEventQueue&quot;&lt;/span&gt;);
&lt;/span&gt;
                from(&lt;span class=&quot;code-quote&quot;&gt;&quot;seda:&lt;span class=&quot;code-comment&quot;&gt;//ClientInboundQueue-two?&quot;&lt;/span&gt; +
&lt;/span&gt;                        &lt;span class=&quot;code-quote&quot;&gt;&quot;multipleConsumers=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;amp;&quot;&lt;/span&gt; +
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;concurrentConsumers=2&amp;amp;&quot;&lt;/span&gt; +
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;waitForTaskToComplete=IfReplyExpected&amp;amp;&quot;&lt;/span&gt; +
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;purgeWhenStopping=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;amp;&quot;&lt;/span&gt; +
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;discardIfNoConsumers=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;amp;&quot;&lt;/span&gt; +
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;limitConcurrentConsumers=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&amp;amp;&quot;&lt;/span&gt; +
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;size=1000&quot;&lt;/span&gt;)
                        .process(exchange -&amp;gt; logger.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Executing ClientInboundQueue-two&quot;&lt;/span&gt;))
                        .to(&lt;span class=&quot;code-quote&quot;&gt;&quot;seda:&lt;span class=&quot;code-comment&quot;&gt;//AttributeEventQueue&quot;&lt;/span&gt;);
&lt;/span&gt;
                from(&lt;span class=&quot;code-quote&quot;&gt;&quot;seda:&lt;span class=&quot;code-comment&quot;&gt;//ClientInboundQueue-tree?&quot;&lt;/span&gt; +
&lt;/span&gt;                        &lt;span class=&quot;code-quote&quot;&gt;&quot;multipleConsumers=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;amp;&quot;&lt;/span&gt; +
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;concurrentConsumers=2&amp;amp;&quot;&lt;/span&gt; +
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;waitForTaskToComplete=IfReplyExpected&amp;amp;&quot;&lt;/span&gt; +
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;purgeWhenStopping=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;amp;&quot;&lt;/span&gt; +
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;discardIfNoConsumers=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;amp;&quot;&lt;/span&gt; +
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;limitConcurrentConsumers=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&amp;amp;&quot;&lt;/span&gt; +
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;size=1000&quot;&lt;/span&gt;)
                        .process(exchange -&amp;gt; logger.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Executing ClientInboundQueue-tree&quot;&lt;/span&gt;))
                        .to(&lt;span class=&quot;code-quote&quot;&gt;&quot;seda:&lt;span class=&quot;code-comment&quot;&gt;//AttributeEventQueue&quot;&lt;/span&gt;);
&lt;/span&gt;
                from(&lt;span class=&quot;code-quote&quot;&gt;&quot;seda:&lt;span class=&quot;code-comment&quot;&gt;//AttributeEventQueue?&quot;&lt;/span&gt; +
&lt;/span&gt;                        &lt;span class=&quot;code-quote&quot;&gt;&quot;waitForTaskToComplete=IfReplyExpected&amp;amp;&quot;&lt;/span&gt; +
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;timeout=10000&amp;amp;&quot;&lt;/span&gt; +
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;purgeWhenStopping=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;amp;&quot;&lt;/span&gt; +
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;discardIfNoConsumers=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&amp;amp;size=2&quot;&lt;/span&gt;)
                        .process(exchange -&amp;gt; logger.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Executing AttributeEventQueue&quot;&lt;/span&gt;))
                        .to(&lt;span class=&quot;code-quote&quot;&gt;&quot;mock:result&quot;&lt;/span&gt;);

            }
        };
    }

} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I&apos;m attaching the sample to you. Could you tell me if it is your scenario or if I&apos;m missing something?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This is my results, as expected:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[seda:&lt;span class=&quot;code-comment&quot;&gt;//ClientInboundQueue-tree] DefaultErrorHandler &#160; &#160; &#160; &#160; &#160; &#160;ERROR Failed delivery &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (MessageId: AE8B1D99CFA3461-0000000000000008 on ExchangeId: AE8B1D99CFA3461-0000000000000008). Exhausted after delivery attempt: 1 caught: java.lang.IllegalStateException: Queue fullMessage History (source location is disabled)
&lt;/span&gt;---------------------------------------------------------------------------------------------------------------------------------------
Source &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; ID &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; Processor &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;Elapsed (ms)
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;route3/route3 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;from[seda:&lt;span class=&quot;code-comment&quot;&gt;//ClientInboundQueue-tree?concurrentCons &#160; 1051803531
&lt;/span&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;route3/process3 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;Processor@0x2755d705 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;0
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;route3/to3 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; seda:&lt;span class=&quot;code-comment&quot;&gt;//AttributeEventQueue &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;0Stacktrace
&lt;/span&gt;---------------------------------------------------------------------------------------------------------------------------------------
java.lang.IllegalStateException: Queue full &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17777306" author="richturner" created="Thu, 19 Oct 2023 14:56:47 +0000"  >&lt;p&gt;Apologies for the delay: here&apos;s an update to your test that highlights the problem (notice the Start SEDA route that passes to the multiple consumers of ClientInboundQueue), I have added a thread sleep to the AttributeEventQueue to ensure it backs up but might not be necessary. In this configuration the AttributeEventQueue gets filled and this pushes back on route ID three, route one and two should never be impeded but you should see in the message history route one and/or two can appear at the top which seems wrong, also as mentioned the elapsed time makes no sense.&#160;&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;SedaTest &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; CamelTestSupport {

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; Logger logger = LoggerFactory.getLogger(SedaTest.class);
    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testMock() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        getMockEndpoint(&lt;span class=&quot;code-quote&quot;&gt;&quot;mock:result&quot;&lt;/span&gt;).expectedBodiesReceived(&lt;span class=&quot;code-quote&quot;&gt;&quot;Hello World&quot;&lt;/span&gt;);

        ExecutorService WORKER_THREAD_POOL = Executors.newFixedThreadPool(3);
        template.sendBody(&lt;span class=&quot;code-quote&quot;&gt;&quot;seda:&lt;span class=&quot;code-comment&quot;&gt;//Start&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;Hello World&quot;&lt;/span&gt;);
&lt;/span&gt;        template.sendBody(&lt;span class=&quot;code-quote&quot;&gt;&quot;seda:&lt;span class=&quot;code-comment&quot;&gt;//Start&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;Hello World&quot;&lt;/span&gt;);
&lt;/span&gt;        template.sendBody(&lt;span class=&quot;code-quote&quot;&gt;&quot;seda:&lt;span class=&quot;code-comment&quot;&gt;//Start&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;Hello World&quot;&lt;/span&gt;);
&lt;/span&gt;        template.sendBody(&lt;span class=&quot;code-quote&quot;&gt;&quot;seda:&lt;span class=&quot;code-comment&quot;&gt;//Start&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;Hello World&quot;&lt;/span&gt;);
&lt;/span&gt;        template.sendBody(&lt;span class=&quot;code-quote&quot;&gt;&quot;seda:&lt;span class=&quot;code-comment&quot;&gt;//Start&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;Hello World&quot;&lt;/span&gt;);
&lt;/span&gt;        MockEndpoint.assertIsSatisfied(context);
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; RoutesBuilder createRouteBuilder() {
        context.setMessageHistory(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RouteBuilder() {
            @Override
            &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void configure() {

                from(&lt;span class=&quot;code-quote&quot;&gt;&quot;seda:&lt;span class=&quot;code-comment&quot;&gt;//Start&quot;&lt;/span&gt;)
&lt;/span&gt;                    .id(&lt;span class=&quot;code-quote&quot;&gt;&quot;start&quot;&lt;/span&gt;)
                    .process(exchange -&amp;gt; logger.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Executing start&quot;&lt;/span&gt;))
                    .to(&lt;span class=&quot;code-quote&quot;&gt;&quot;seda:&lt;span class=&quot;code-comment&quot;&gt;//ClientInboundQueue&quot;&lt;/span&gt;);
&lt;/span&gt;
                from(&lt;span class=&quot;code-quote&quot;&gt;&quot;seda:&lt;span class=&quot;code-comment&quot;&gt;//ClientInboundQueue?&quot;&lt;/span&gt; +
&lt;/span&gt;                        &lt;span class=&quot;code-quote&quot;&gt;&quot;multipleConsumers=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;amp;&quot;&lt;/span&gt; +
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;waitForTaskToComplete=IfReplyExpected&amp;amp;&quot;&lt;/span&gt; +
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;purgeWhenStopping=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;amp;&quot;&lt;/span&gt; +
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;discardIfNoConsumers=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;amp;&quot;&lt;/span&gt; +
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;limitConcurrentConsumers=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&amp;amp;&quot;&lt;/span&gt; +
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;size=1000&quot;&lt;/span&gt;)
                        .id(&lt;span class=&quot;code-quote&quot;&gt;&quot;one&quot;&lt;/span&gt;)
                        .process(exchange -&amp;gt; logger.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Executing ClientInboundQueue-one&quot;&lt;/span&gt;));

                from(&lt;span class=&quot;code-quote&quot;&gt;&quot;seda:&lt;span class=&quot;code-comment&quot;&gt;//ClientInboundQueue?&quot;&lt;/span&gt; +
&lt;/span&gt;                        &lt;span class=&quot;code-quote&quot;&gt;&quot;multipleConsumers=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;amp;&quot;&lt;/span&gt; +
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;waitForTaskToComplete=IfReplyExpected&amp;amp;&quot;&lt;/span&gt; +
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;purgeWhenStopping=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;amp;&quot;&lt;/span&gt; +
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;discardIfNoConsumers=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;amp;&quot;&lt;/span&gt; +
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;limitConcurrentConsumers=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&amp;amp;&quot;&lt;/span&gt; +
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;size=1000&quot;&lt;/span&gt;)
                        .id(&lt;span class=&quot;code-quote&quot;&gt;&quot;two&quot;&lt;/span&gt;)
                        .process(exchange -&amp;gt; logger.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Executing ClientInboundQueue-two&quot;&lt;/span&gt;));

                from(&lt;span class=&quot;code-quote&quot;&gt;&quot;seda:&lt;span class=&quot;code-comment&quot;&gt;//ClientInboundQueue?&quot;&lt;/span&gt; +
&lt;/span&gt;                        &lt;span class=&quot;code-quote&quot;&gt;&quot;multipleConsumers=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;amp;&quot;&lt;/span&gt; +
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;waitForTaskToComplete=IfReplyExpected&amp;amp;&quot;&lt;/span&gt; +
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;purgeWhenStopping=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;amp;&quot;&lt;/span&gt; +
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;discardIfNoConsumers=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;amp;&quot;&lt;/span&gt; +
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;limitConcurrentConsumers=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&amp;amp;&quot;&lt;/span&gt; +
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;size=1000&quot;&lt;/span&gt;)
                        .id(&lt;span class=&quot;code-quote&quot;&gt;&quot;three&quot;&lt;/span&gt;)
                        .process(exchange -&amp;gt; logger.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Executing ClientInboundQueue-three&quot;&lt;/span&gt;))
                        .to(&lt;span class=&quot;code-quote&quot;&gt;&quot;seda:&lt;span class=&quot;code-comment&quot;&gt;//AttributeEventQueue&quot;&lt;/span&gt;);
&lt;/span&gt;
                from(&lt;span class=&quot;code-quote&quot;&gt;&quot;seda:&lt;span class=&quot;code-comment&quot;&gt;//AttributeEventQueue?&quot;&lt;/span&gt; +
&lt;/span&gt;                        &lt;span class=&quot;code-quote&quot;&gt;&quot;waitForTaskToComplete=IfReplyExpected&amp;amp;&quot;&lt;/span&gt; +
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;timeout=10000&amp;amp;&quot;&lt;/span&gt; +
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;purgeWhenStopping=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;amp;&quot;&lt;/span&gt; +
                        &lt;span class=&quot;code-quote&quot;&gt;&quot;discardIfNoConsumers=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&amp;amp;size=2&quot;&lt;/span&gt;)
                        .process(exchange -&amp;gt; {
                            logger.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Executing AttributeEventQueue&quot;&lt;/span&gt;);
                            &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(1000);
                        })
                        .to(&lt;span class=&quot;code-quote&quot;&gt;&quot;mock:result&quot;&lt;/span&gt;);

            }
        };
    } &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Here&apos;s an example incorrect history output with route one shown at the top:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[14 - seda:&lt;span class=&quot;code-comment&quot;&gt;//ClientInboundQueue] DefaultErrorHandler &#160; &#160; &#160; &#160; &#160; &#160;ERROR Failed delivery &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (MessageId: C231FF4DD699985-0000000000000012 on ExchangeId: C231FF4DD699985-0000000000000012). Exhausted after delivery attempt: 1 caught: java.lang.IllegalStateException: Queue fullMessage History (source location is disabled)
&lt;/span&gt;---------------------------------------------------------------------------------------------------------------------------------------
Source &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; ID &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; Processor &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;Elapsed (ms)
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;one/one &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;from[seda:&lt;span class=&quot;code-comment&quot;&gt;//ClientInboundQueue?discardIfNoConsumer &#160; &#160;540646067
&lt;/span&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;start/process1 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; Processor@0x7db534f2 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;0
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;start/to1 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;seda:&lt;span class=&quot;code-comment&quot;&gt;//ClientInboundQueue &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; 0
&lt;/span&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;three/process4 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; Processor@0x5910de75 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;0
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;three/to2 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;seda:&lt;span class=&quot;code-comment&quot;&gt;//AttributeEventQueue &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;0 &lt;/span&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;If we send the messages directly to ClientInboundQueue (rather than Start) then the message history is also incorrect:&lt;/p&gt;



&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[11 - seda:&lt;span class=&quot;code-comment&quot;&gt;//ClientInboundQueue] DefaultErrorHandler &#160; &#160; &#160; &#160; &#160; &#160;ERROR Failed delivery &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (MessageId: 74874E358312720-000000000000000E on ExchangeId: 74874E358312720-000000000000000E). Exhausted after delivery attempt: 1 caught: java.lang.IllegalStateException: Queue fullMessage History (source location is disabled)
&lt;/span&gt;---------------------------------------------------------------------------------------------------------------------------------------
Source &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; ID &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; Processor &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;Elapsed (ms)
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;two/two &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;from[seda:&lt;span class=&quot;code-comment&quot;&gt;//ClientInboundQueue?discardIfNoConsumer &#160; &#160;541298686
&lt;/span&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;three/process4 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; Processor@0x5910de75 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;1
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;three/to2 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;seda:&lt;span class=&quot;code-comment&quot;&gt;//AttributeEventQueue &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;0
&lt;/span&gt; &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Hope this helps.&lt;/p&gt;</comment>
                            <comment id="17795012" author="JIRAUSER297305" created="Sun, 10 Dec 2023 01:53:24 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=richturner&quot; class=&quot;user-hover&quot; rel=&quot;richturner&quot;&gt;richturner&lt;/a&gt; ,&lt;/p&gt;

&lt;p&gt;We have two issues here. The first one is the elapsed time which is wrong. I already found the cause and I&apos;m fixing it. The second issue is about the message history items and their order. About the second, I&apos;m investigating the situation and trying to figure out what is going on. One hypothesis is when the camel creates a copy of the exchange some issue about the message history replication is generating the side effect.&lt;/p&gt;</comment>
                            <comment id="17795018" author="JIRAUSER297305" created="Sun, 10 Dec 2023 04:11:50 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;I&apos;ve examined the StopWatch, and during my review, I came across this specific line:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/camel/blob/main/core/camel-util/src/main/java/org/apache/camel/util/StopWatch.java#L40&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/blob/main/core/camel-util/src/main/java/org/apache/camel/util/StopWatch.java#L40&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; StopWatch(&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; timeMillis) {       
    start = timeMillis;    
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;The taken method is considering the time as nanoTime &lt;a href=&quot;https://github.com/apache/camel/blob/main/core/camel-util/src/main/java/org/apache/camel/util/StopWatch.java#L74&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/blob/main/core/camel-util/src/main/java/org/apache/camel/util/StopWatch.java#L74&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; taken() {        
   &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (start &amp;gt; 0) {        
      &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; delta = &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.nanoTime() - start;            
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; Duration.ofNanos(delta).toMillis();        
   }        
   &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; 0;    
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I think we have two issues here. The first issue is the start property can have a value in milliseconds. The second issue is the System.nanoTime method has this text within the doc: &lt;em&gt;&lt;b&gt;This method can only be used to measure elapsed time and is not related to any other notion of system or wall-clock time. The value returned represents nanoseconds since some fixed but arbitrary&#160;origin&#160;time (perhaps in the future, so values may be negative).&lt;/b&gt;&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;The constructor StopWatch(long timeMillis) can induce the &lt;em&gt;developer to use it with the&lt;/em&gt; System.currentTimeMillis &lt;span class=&quot;error&quot;&gt;&amp;#91;Ex.: StopWatch(System.currentTimeMillis())&amp;#93;&lt;/span&gt; and generate a side effect. I think the better approach is to redefine the StopWatch to work just with nanoTime, and remove the timeMillis. What do you think about it? Does it make sense for you?&lt;/p&gt;</comment>
                            <comment id="17795242" author="davsclaus" created="Mon, 11 Dec 2023 08:49:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=orpiske&quot; class=&quot;user-hover&quot; rel=&quot;orpiske&quot;&gt;orpiske&lt;/a&gt; can you take a look - it seems the stop watch that takes a starting time millis should not be supported and we should deprecate that.&lt;/p&gt;</comment>
                            <comment id="17795715" author="orpiske" created="Tue, 12 Dec 2023 12:31:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rhuanrocha&quot; class=&quot;user-hover&quot; rel=&quot;rhuanrocha&quot;&gt;rhuanrocha&lt;/a&gt; yeah +1, let&apos;s remove this old interface from the StopWatch. I&apos;ll take a look at it today. &lt;/p&gt;</comment>
                            <comment id="17795718" author="orpiske" created="Tue, 12 Dec 2023 12:36:27 +0000"  >&lt;p&gt;Created &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-20224&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CAMEL-20224&lt;/a&gt; to track the removal of that interface.&lt;/p&gt;</comment>
                            <comment id="17795744" author="orpiske" created="Tue, 12 Dec 2023 13:25:04 +0000"  >&lt;p&gt;And I also created this, which is a bit more complex / will require more careful changes: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-20225&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CAMEL-20225&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13477967">CAMEL-18417</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13063391" name="camel-seda-reproducer.zip" size="20101" author="rhuanrocha" created="Fri, 6 Oct 2023 21:51:38 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 48 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1jpk8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>