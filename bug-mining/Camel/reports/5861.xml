<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:49:49 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-16916] camel split with parallel processing true consumes lots of heap space when using camel-ftp</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-16916</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;Camel split with parallel processing true consumes lots of heap space and eventually (after several huge runs) makes java run out of heap space. Reading 50 000 lines from source and creating 50 000 responses as xml files. Out of heap space happends after 3-4 runs (once a day). Workaround is to make parallelProcessing to false .&lt;/p&gt;

&lt;p&gt;My route:&lt;/p&gt;

&lt;p&gt;&amp;lt;from uri=&quot;sftp://server?fileName=list.txt&quot;/&amp;gt;&lt;/p&gt;

&lt;p&gt;&amp;lt;split parallelProcessing=&quot;true&quot;&amp;gt;&lt;br/&gt;
 &#160;&amp;lt;tokenize token=&quot;\r\n|\n&quot; xml=&quot;false&quot; trim=&quot;true&quot;/&amp;gt;&lt;br/&gt;
 &#160;&amp;lt;convertBodyTo type=&quot;java.lang.String&quot; charset=&quot;UTF-8&quot;/&amp;gt;&lt;br/&gt;
 &#160;&amp;lt;to uri=&quot;bean:collectDataByBody?method=collect&quot;/&amp;gt;&lt;br/&gt;
 &#160;&amp;lt;to uri=&quot;direct:sendToSftp&quot;/&amp;gt;&lt;br/&gt;
 &amp;lt;/split&amp;gt;&lt;/p&gt;

&lt;p&gt;&amp;lt;from uri=&quot;direct:sendToSftp&quot;/&amp;gt;&lt;br/&gt;
 &amp;lt;choice&amp;gt;&lt;br/&gt;
 &amp;lt;when&amp;gt;&lt;br/&gt;
 &amp;lt;simple&amp;gt;${body} != null&amp;lt;/simple&amp;gt;&lt;br/&gt;
 &amp;lt;marshal&amp;gt;&lt;br/&gt;
 &amp;lt;jaxb contextPath=&quot;fi.package.entity&quot;/&amp;gt;&lt;br/&gt;
 &amp;lt;/marshal&amp;gt;&lt;br/&gt;
 &amp;lt;to uri=&quot;sftp://server/answers?disconnect=true&quot;/&amp;gt;&lt;br/&gt;
 &amp;lt;/when&amp;gt;&lt;br/&gt;
 &amp;lt;otherwise&amp;gt;&amp;lt;/otherwise&amp;gt;&lt;br/&gt;
 &amp;lt;/choice&amp;gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment>&lt;p&gt;RHEL Linux 7&lt;/p&gt;

&lt;p&gt;Karaf 3.2.1&lt;/p&gt;

&lt;p&gt;OpenJDK 11&lt;/p&gt;</environment>
        <key id="13398930">CAMEL-16916</key>
            <summary>camel split with parallel processing true consumes lots of heap space when using camel-ftp</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="tapiiron">Tapio Piironen</reporter>
                        <labels>
                    </labels>
                <created>Thu, 2 Sep 2021 12:01:39 +0000</created>
                <updated>Tue, 28 Sep 2021 10:20:50 +0000</updated>
                            <resolved>Tue, 28 Sep 2021 10:20:50 +0000</resolved>
                                    <version>3.11.1</version>
                                    <fixVersion>3.7.6</fixVersion>
                    <fixVersion>3.11.3</fixVersion>
                    <fixVersion>3.13.0</fixVersion>
                                    <component>camel-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17408805" author="davsclaus" created="Thu, 2 Sep 2021 12:59:34 +0000"  >&lt;p&gt;You may want to run splitter in streaming mode, otherwise you still end up reading all data into memory, and if parallel you end up doing this concurrently for files all taking up memory space.&lt;/p&gt;</comment>
                            <comment id="17408806" author="davsclaus" created="Thu, 2 Sep 2021 13:00:05 +0000"  >&lt;p&gt;And can you take a heap dump or investigate your JVM what is sitting there to take up memory, the GC cannot reclaim that memory?&lt;/p&gt;</comment>
                            <comment id="17409279" author="tapiiron" created="Fri, 3 Sep 2021 05:44:00 +0000"  >&lt;p&gt;Thank you for the hint about streaming mode. Thought only the original split was in memory but if all the files are too, then it will fill memory for certain.&#160;&lt;/p&gt;

&lt;p&gt;In camel version 3.4.3 everything worked. This started happening after 3.11.0 .&lt;/p&gt;

&lt;p&gt;Will try to investigate JVM and reporting my findings here.&lt;/p&gt;</comment>
                            <comment id="17410500" author="tapiiron" created="Mon, 6 Sep 2021 09:36:39 +0000"  >&lt;p&gt;Streaming mode did not fix the problem. Made the route run last weekend and the service was out of heap space this morning. Trying to get better analysis this week (heap dump)&lt;/p&gt;</comment>
                            <comment id="17411736" author="tapiiron" created="Wed, 8 Sep 2021 07:11:34 +0000"  >&lt;p&gt;Cant put the dump file here as it contains sensitive information but these objects grow and dont get garbage collected:&lt;/p&gt;

&lt;p&gt;org.apache.camel.support.cache.DefaultProducerCache&lt;/p&gt;

&lt;p&gt;and DefaultLRUCacheFactory$SimpleLRUCache&lt;/p&gt;

&lt;p&gt;with AsyncProcessorConverterHelper HashMap with value of remote.RemoteFileProducer (10 Mb with smaller run this time).&lt;/p&gt;</comment>
                            <comment id="17412369" author="davsclaus" created="Thu, 9 Sep 2021 06:30:43 +0000"  >&lt;p&gt;Ah I suspect its the ftp component as its non singleton for its producers. Can you try with using file or some other component to see if the memory problem is gone, that would help us to know more preciesly that its due to this fact.&lt;/p&gt;</comment>
                            <comment id="17412395" author="tapiiron" created="Thu, 9 Sep 2021 07:07:39 +0000"  >&lt;p&gt;Tested with file component and garbage dump is a lot smaller + seems like cache is not filling remarkably.&#160;&lt;/p&gt;</comment>
                            <comment id="17421282" author="davsclaus" created="Tue, 28 Sep 2021 09:39:53 +0000"  >&lt;p&gt;Okay so I can confirm its due to camel-ftp is not singleton producers due they are not thread-safe. There are very few components with this behavior.&lt;br/&gt;
Also a problem is that the send processor is creating a producer cache with a capacity of 1, so when you have parallel mode, then there is only 1 producer that can be re-used, so a lot of new producers is created. And there is a potential race condition in the MultiPool that camel-ftp uses (not the others). So its a bit of 3 things going on.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 7 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0uje8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>