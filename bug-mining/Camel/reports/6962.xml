<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 11:08:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-21472] Opentelemetry is using the same traceId when exchange is fired from file or timer component</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-21472</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;&lt;b&gt;Problem&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;When using a consumer like&#160;&lt;tt&gt;timer&lt;/tt&gt;&#160;or&#160;&lt;tt&gt;file&lt;/tt&gt;, the traceId remains the same for all messages. When using a consumer like netty (or, I assume, any other http/tcp-based consumer), every call gets its own traceId as expected.&lt;/p&gt;

&lt;p&gt;See also &lt;a href=&quot;https://camel.zulipchat.com/#narrow/channel/257298-camel/topic/Same.20OTEL.20trace.20for.20all.20messages.20into.20IBM.20MQ&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://camel.zulipchat.com/#narrow/channel/257298-camel/topic/Same.20OTEL.20trace.20for.20all.20messages.20into.20IBM.20MQ&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Reproducer&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/thomas-gantenbein-tga/camel-opentelemetry/tree/main&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/thomas-gantenbein-tga/camel-opentelemetry/tree/main&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pcongiusti&quot; class=&quot;user-hover&quot; rel=&quot;pcongiusti&quot;&gt;pcongiusti&lt;/a&gt;, thanks for your answer on Zulip Chat. Let me know if I should further explain or minimize that reproducer.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13599905">CAMEL-21472</key>
            <summary>Opentelemetry is using the same traceId when exchange is fired from file or timer component</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="7">Later</resolution>
                                        <assignee username="squakez">Pasquale Congiusti</assignee>
                                    <reporter username="ganteth">Thomas Gantenbein</reporter>
                        <labels>
                    </labels>
                <created>Mon, 25 Nov 2024 12:34:29 +0000</created>
                <updated>Thu, 9 Jan 2025 12:36:08 +0000</updated>
                            <resolved>Thu, 9 Jan 2025 12:36:08 +0000</resolved>
                                    <version>4.8.1</version>
                                                    <component>camel-opentelemetry</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17900972" author="JIRAUSER304550" created="Mon, 25 Nov 2024 17:20:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pcongiusti&quot; class=&quot;user-hover&quot; rel=&quot;pcongiusti&quot;&gt;pcongiusti&lt;/a&gt;, I think it doesn&apos;t have to do anything with the component used, after all, but with the `ThreadLocalContextStorage`. Netty is using a several worker threads, while the file or timer component use the same thread. If I repeat the request to the netty route in &lt;a href=&quot;https://github.com/thomas-gantenbein-tga/camel-opentelemetry/blob/main/src/main/java/org/example/MySpringBootRouter.java#L18&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/thomas-gantenbein-tga/camel-opentelemetry/blob/main/src/main/java/org/example/MySpringBootRouter.java#L18&lt;/a&gt; frequently enough (I fired it 100 times with &quot;for run in {1..100}; do curl localhost:12345 &amp;amp; done&quot;) I manage to get the same traceIds for subsequent requests, too.&lt;/p&gt;

&lt;p&gt;Here are the logs from the reproducer after having it run through grep &quot;in netty&quot; | grep -Po &apos;thread.*&apos; | sort:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
thread #10 - NettyConsumerExecutorGroup [d05defb0897c489aaaa28809ed6e0225,1cce18f3597f5cf1] netty - in netty route
thread #10 - NettyConsumerExecutorGroup [d05defb0897c489aaaa28809ed6e0225,6acdf9db4a88fc47] netty - in netty route
thread #10 - NettyConsumerExecutorGroup [d05defb0897c489aaaa28809ed6e0225,8430524b2125075c] netty - in netty route
thread #10 - NettyConsumerExecutorGroup [d05defb0897c489aaaa28809ed6e0225,add494bb4de6c0a0] netty - in netty route
thread #10 - NettyConsumerExecutorGroup [d05defb0897c489aaaa28809ed6e0225,d2b4040f1fcc364b] netty - in netty route
thread #10 - NettyConsumerExecutorGroup [d05defb0897c489aaaa28809ed6e0225,f2f5db974223b4cd] netty - in netty route
thread #14 - NettyConsumerExecutorGroup [95129fc26654d41c20190a5043f99c4b,2287c028952851b8] netty - in netty route
thread #14 - NettyConsumerExecutorGroup [95129fc26654d41c20190a5043f99c4b,408782d7423d9991] netty - in netty route
thread #14 - NettyConsumerExecutorGroup [95129fc26654d41c20190a5043f99c4b,82c9d51db597d810] netty - in netty route
thread #14 - NettyConsumerExecutorGroup [95129fc26654d41c20190a5043f99c4b,877bb45250ae6a69] netty - in netty route
thread #14 - NettyConsumerExecutorGroup [95129fc26654d41c20190a5043f99c4b,9942fdd7f07c4be1] netty - in netty route
thread #14 - NettyConsumerExecutorGroup [95129fc26654d41c20190a5043f99c4b,de36e208f75a1d05] netty - in netty route
 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17901118" author="squakez" created="Tue, 26 Nov 2024 08:19:55 +0000"  >&lt;p&gt;Thanks for the insights. I am going to have a look and I&apos;ll ask your support for further troubleshooting if required.&lt;/p&gt;</comment>
                            <comment id="17901133" author="JIRAUSER304550" created="Tue, 26 Nov 2024 09:03:29 +0000"  >&lt;p&gt;Couldn&apos;t leave this alone, so in case it helps, here&apos;s what I&apos;ve tried:&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13073066/13073066_image-2024-11-26-09-59-35-555.png&quot; height=&quot;357&quot; width=&quot;813&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;This solves the issue for my tiny little example &#8211; not sure though that this is the right way. The lines about mdc logging are just a quick fix for me to test.&lt;/p&gt;</comment>
                            <comment id="17901148" author="squakez" created="Tue, 26 Nov 2024 09:57:45 +0000"  >&lt;p&gt;Hello. I think that part was kind of introduced on purpose: &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; and &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;. We need to understand a bit more on the root cause and which is the expected behavior of the component, how we can tune based on the requirement we have and if there is any bug we need to fix. I will try to work on all those points. I had a quick look to understand if the MDC behavior is something we can skip by configuration, but it seems it does not.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://camel.apache.org/components/next/others/opentelemetry.html#_mdc_logging&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://camel.apache.org/components/next/others/opentelemetry.html#_mdc_logging&lt;/a&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/camel/commit/04916f4e601d1c1cdb9c22cff9ff40e0a1070ffe&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/commit/04916f4e601d1c1cdb9c22cff9ff40e0a1070ffe&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17901151" author="davsclaus" created="Tue, 26 Nov 2024 09:58:46 +0000"  >&lt;p&gt;It smells like the span needs to be ended when the UoW of the Exchange is done (this happens when the timer or file, or even netty) is done with the exchange.&lt;/p&gt;

&lt;p&gt;The &quot;fix&quot; above seems to fix this on the start. But its a great help to find the best solution. And if possible if we can add some unit test / mock test for this.&lt;/p&gt;</comment>
                            <comment id="17901203" author="JIRAUSER304550" created="Tue, 26 Nov 2024 13:39:58 +0000"  >&lt;p&gt;Actually, forget about those lines regarding the MDC context: They are not necessary. I think I included them when I had not yet set `builder.setNoParent()` and was surprised to still find the same traceId in the logs. But it wasn&apos;t about the MDC context, it was about that `builder.setNoParent()`. Removing traceId from MDC seems to be done as expected (at least: expected by&#160;&lt;em&gt;me&lt;/em&gt;) in ActiveSpanManager.&lt;/p&gt;

&lt;p&gt;And I agree that this &quot;fix&quot; is counterintuitive. Also, it will work, I guess, for cases were messages originate from Camel, but it will not work if another service calls Camel, for example, with an existing traceId in a HTTP header: we&apos;d start a new traceId, which is certainly not what&apos;s expected.&lt;/p&gt;

&lt;p&gt;The span seems to be ended in &lt;a href=&quot;https://github.com/apache/camel/blob/main/components/camel-tracing/src/main/java/org/apache/camel/tracing/Tracer.java#L328,&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/blob/main/components/camel-tracing/src/main/java/org/apache/camel/tracing/Tracer.java#L328,&lt;/a&gt; but maybe we&apos;d have to check there if there is no parent span and, if so, clear the context &#8211; no idea how that is done exactly. It seems to me that the &quot;context&quot; of a trace is stored in ThreadLocalStorage and by calling Span.fromContext(ctx), that information is restored when a new exchange is started &#8211; including the traceId from a previous trace processed on the same thread.&lt;/p&gt;

&lt;p&gt;Anyway, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=squakez&quot; class=&quot;user-hover&quot; rel=&quot;squakez&quot;&gt;squakez&lt;/a&gt;, if you prefer to work on this by yourself I&apos;ll let you do your work and not disturb. If you appreciate comments like these and suggestions, I&apos;ll continue to try out things if I find time.&lt;/p&gt;</comment>
                            <comment id="17901206" author="jpoth" created="Tue, 26 Nov 2024 13:48:01 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ganteth&quot; class=&quot;user-hover&quot; rel=&quot;ganteth&quot;&gt;ganteth&lt;/a&gt;! By any chance, does adding the option `synchronous=true` to the timer and file uri fix the issue ? so &quot;file:.....&amp;amp;synchronous=true&quot; and &quot;timer:...&amp;amp;synchronous=true&quot; resolve the issue ? This reminds me of &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-21302&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CAMEL-21302&lt;/a&gt; ... thanks !&lt;/p&gt;</comment>
                            <comment id="17901212" author="squakez" created="Tue, 26 Nov 2024 14:04:40 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ganteth&quot; class=&quot;user-hover&quot; rel=&quot;ganteth&quot;&gt;ganteth&lt;/a&gt;, no, feel free to add any further findings and possible fixes. As you&apos;ve said, we must find the root cause and solve it at the root to avoid introducing any regression in other paths we&apos;re not testing out of the box. It may take a bit more time to have a final fix, but the idea is to have something stable for all the different scenarios.&lt;/p&gt;</comment>
                            <comment id="17901213" author="squakez" created="Tue, 26 Nov 2024 14:06:58 +0000"  >&lt;p&gt;If the actual work you&apos;ve done is patching this problem, you can submit a draft PR in the while, so, we can test any possible regression and have a first feedback.&lt;/p&gt;</comment>
                            <comment id="17901260" author="JIRAUSER304550" created="Tue, 26 Nov 2024 17:04:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jpoth&quot; class=&quot;user-hover&quot; rel=&quot;jpoth&quot;&gt;jpoth&lt;/a&gt;, thanks for the suggestion. No, the option synchronous=true doesn&apos;t resolve this.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=squakez&quot; class=&quot;user-hover&quot; rel=&quot;squakez&quot;&gt;squakez&lt;/a&gt;, I&apos;ve made a draft PR: &lt;a href=&quot;https://github.com/apache/camel/pull/16386.&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/16386.&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Actually, with my reproducer it works better than expected: I tried `curl -H &quot;traceparent: 00-4bf92f3577b34da6a3ce929d0e0e4736-00f067aa0ba902b7-01&quot; localhost:12345` and observed that traceId 4bf92f3577b34da6a3ce929d0e0e4736 was actually assigned to the trace and a new span was created. When not sending such a header, a new traceId would be generated. Same for the timer-route.&lt;/p&gt;

&lt;p&gt;I don&apos;t like the fact that my &quot;fix&quot; is checking whether a new traceId should be assigned when a new exchange comes in &#8211; instead of just doing whatever is necessary when the exchange is done and no parent span exists. But this is what seems to work for me for the moment, without me having to touch more stuff that I don&apos;t &lt;em&gt;really&lt;/em&gt; understand.&lt;/p&gt;</comment>
                            <comment id="17901415" author="jpoth" created="Wed, 27 Nov 2024 08:35:20 +0000"  >&lt;p&gt;Naively adding a test for the timer component, we can see that four different Spans are created :&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;TimerTest &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; CamelOpenTelemetryTestSupport {

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; SpanTestData[] testdata = {};

    TimerTest() {
        &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;(testdata);
    }

    @Test
    void testRoute() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; InterruptedException {
        MockEndpoint mock = getMockEndpoint(&lt;span class=&quot;code-quote&quot;&gt;&quot;mock:end&quot;&lt;/span&gt;);
        mock.expectedMessageCount(4);
        mock.assertIsSatisfied(3000);
        verifyTraceSpanNumbers(4, 2);
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; RoutesBuilder createRouteBuilder() {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RouteBuilder() {
            @Override
            &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void configure() {
                from(&lt;span class=&quot;code-quote&quot;&gt;&quot;timer:&lt;span class=&quot;code-comment&quot;&gt;//foo?repeatCount=4&amp;amp;delay=100&amp;amp;period=100&quot;&lt;/span&gt;).routeId(&lt;span class=&quot;code-quote&quot;&gt;&quot;myRoute&quot;&lt;/span&gt;)
&lt;/span&gt;                        .log(&lt;span class=&quot;code-quote&quot;&gt;&quot;message&quot;&lt;/span&gt;)
                        .to(&lt;span class=&quot;code-quote&quot;&gt;&quot;mock:end&quot;&lt;/span&gt;);
            }
        };
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17901949" author="squakez" created="Fri, 29 Nov 2024 14:51:13 +0000"  >&lt;p&gt;Okey, I think I have a fair understanding of what&apos;s going on. The problem is not with the tracing propagation at all. The telemetry is correctly creating the expected traces that can be later recovered in the OTEL collection.&lt;/p&gt;

&lt;p&gt;According to some troubleshooting I&apos;ve done raising log levels of the application, every exchange creates a trace_id correctly and each event create a span_id bound to the exchange trace_id. The problem indeed is with MDC which is not able to perform the same propagation mechanism used by the telemetry. This is something expected as the MDC stores values at each thread level. As soon as the core starts a new thread to manage some event (like it happens with the direct routes), then, the MDC is started from scratch, loosing those values or reusing any previous value set there. This is the reason why we either see empty traces or traces coming from previous threads executions.&lt;/p&gt;

&lt;p&gt;In general it seems the OTEL has &lt;a href=&quot;https://github.com/open-telemetry/opentelemetry-java-instrumentation/blob/main/docs/logger-mdc-instrumentation.md&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;some mechanism to manage MDC context directly&lt;/a&gt;. However, I&apos;ve quickly tested on Camel Main and it suffer the same problems we have when using our own solution.&lt;/p&gt;

&lt;p&gt;IMO, we should remove the feature at all as this is leading to inconsistencies which I am not sure we can really solve. We should remainder the user to use the specific telemetry instrumentation that is available for such a purpose instead.&lt;/p&gt;</comment>
                            <comment id="17901955" author="JIRAUSER304550" created="Fri, 29 Nov 2024 16:14:37 +0000"  >&lt;p&gt;I agree, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=squakez&quot; class=&quot;user-hover&quot; rel=&quot;squakez&quot;&gt;squakez&lt;/a&gt;. Sorry for the fuss I caused here. Should have checked with current snapshot version and then should have checked not only logs but also trace results in Jaeger. Is it &lt;a href=&quot;https://github.com/apache/camel/commit/8788f722922d066cc314c44ed4e60735109e9f07&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/commit/8788f722922d066cc314c44ed4e60735109e9f07&lt;/a&gt; that solved the problem that I initially reported here about release 4.8.1?&lt;/p&gt;

&lt;p&gt;If you remove the MDC logging support, may I suggest that you add a header instead with the current traceId/spanId on the exchange? That way one could still log traceId/spanId, though manually.&lt;/p&gt;

&lt;p&gt;And just to support your point, here are the MDC enabled logs that are missing traceIds:&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13073115/13073115_image-2024-11-29-17-04-16-581.png&quot; height=&quot;116&quot; width=&quot;822&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;And here is what Jaeger knows about those traces and even about those logs (which I wasn&apos;t sure that it would work):&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13073118/13073118_image-2024-11-29-17-12-49-768.png&quot; height=&quot;384&quot; width=&quot;905&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13073119/13073119_image-2024-11-29-17-12-58-036.png&quot; height=&quot;381&quot; width=&quot;907&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17901983" author="JIRAUSER304550" created="Fri, 29 Nov 2024 20:05:04 +0000"  >&lt;p&gt;To answer my own question: Yes, &lt;a href=&quot;https://github.com/apache/camel/commit/8788f722922d066cc314c44ed4e60735109e9f07&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/commit/8788f722922d066cc314c44ed4e60735109e9f07&lt;/a&gt; solved the problem I reported here. I tried by commenting out &lt;a href=&quot;https://github.com/apache/camel/commit/8788f722922d066cc314c44ed4e60735109e9f07#diff-9467b3f62367a0f54f07f7f567df10c7044c3c2a207aa6312e4c6d88bc3e68cdR63&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/commit/8788f722922d066cc314c44ed4e60735109e9f07#diff-9467b3f62367a0f54f07f7f567df10c7044c3c2a207aa6312e4c6d88bc3e68cdR63&lt;/a&gt;. In a route like&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
from(&lt;span class=&quot;code-quote&quot;&gt;&quot;timer:mytimer?period=5000&quot;&lt;/span&gt;)
&#160; &#160; &#160; &#160; &#160; &#160; .log(&lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;)
  &#160; &#160; &#160; &#160; &#160; .to(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:foo&quot;&lt;/span&gt;);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;that would already cause the same traceId being used every time the timer would fire. Removing `direct` would cause unique traceIds being generated again.&lt;/p&gt;</comment>
                            <comment id="17902775" author="JIRAUSER304550" created="Tue, 3 Dec 2024 22:09:55 +0000"  >&lt;p&gt;If you remove MDC support, doesn&apos;t that defeat one of the main purposes of tracing, i.e. the ability to trace a particular request over several services? If I don&apos;t have the traceId somewhere in the logs, it&apos;s hard to find a particular trace. Moreover, unless the option `traceProcessors` is true, the context is not passed to other threads, so even if logs were sent via a &lt;a href=&quot;https://opentelemetry.io/docs/specs/otel/logs/#new-first-party-application-logs&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Opentelemetry logs bridge&lt;/a&gt; instead of using MDC, I doubt that this would work, since that bridge would have no knowledge about the current context either if a route was using a new thread in the middle of its execution (for example after a delay EIP).&lt;/p&gt;

&lt;p&gt;Maybe if tracing is enabled, every processor should &lt;em&gt;always&lt;/em&gt; be intercepted so that context can be passed? &lt;a href=&quot;https://github.com/apache/camel/blob/main/components/camel-opentelemetry/src/main/java/org/apache/camel/opentelemetry/OpenTelemetryTracingStrategy.java#L45&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/blob/main/components/camel-opentelemetry/src/main/java/org/apache/camel/opentelemetry/OpenTelemetryTracingStrategy.java#L45&lt;/a&gt; almost has what may be needed, but maybe this should be invoked per default so that every processor would be wrapped at least in a &lt;a href=&quot;https://github.com/apache/camel/blob/main/components/camel-opentelemetry/src/main/java/org/apache/camel/opentelemetry/OpenTelemetryTracingStrategy.java#L52&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PropagateContext&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="17902915" author="squakez" created="Wed, 4 Dec 2024 08:21:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ganteth&quot; class=&quot;user-hover&quot; rel=&quot;ganteth&quot;&gt;ganteth&lt;/a&gt; no worries. More than removing the feature it would be substituting it with some alternative and more appropriate mechanisms, eg, the MDC support provided by Opentelemetry. I am actively working on these issues and I am about to open a thread on the mailing list to discuss about the possible options we have in front of us. Keep tuned.&lt;/p&gt;</comment>
                            <comment id="17902932" author="squakez" created="Wed, 4 Dec 2024 09:19:47 +0000"  >&lt;p&gt;I have identified the main reason of the failure which is the fact we&apos;re closing the scope too fast. I still need to verify the mechanism to restart the trace once the exchange is complete. This is the traces I am getting:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
10:13:21.909 [9e8c45a66385b66a603a75b4cf089c8d, f4e0aee994b9d56c] in timer route
10:13:21.916 [9e8c45a66385b66a603a75b4cf089c8d, 411bbecf3add1bcc] in aSlowerRoute
10:13:21.920 [9e8c45a66385b66a603a75b4cf089c8d, 411bbecf3add1bcc] still in aSlowerRoute
10:13:21.921 [9e8c45a66385b66a603a75b4cf089c8d, a6e5da0571573e03] in aFasterRoute
10:13:21.926 [9e8c45a66385b66a603a75b4cf089c8d, a6e5da0571573e03] still in aFasterRoute

10:13:31.885 [9e8c45a66385b66a603a75b4cf089c8d, 950d66e2a86c8dd5] in timer route
10:13:31.886 [9e8c45a66385b66a603a75b4cf089c8d, 625c85843b506435] in aSlowerRoute
10:13:31.888 [9e8c45a66385b66a603a75b4cf089c8d, 625c85843b506435] still in aSlowerRoute
10:13:31.889 [9e8c45a66385b66a603a75b4cf089c8d, 263bfaf1847fac78] in aFasterRoute
10:13:31.893 [9e8c45a66385b66a603a75b4cf089c8d, 263bfaf1847fac78] still in aFasterRoute

10:13:41.886 [9e8c45a66385b66a603a75b4cf089c8d, 6f1cea732bd351c3] in timer route
10:13:41.886 [9e8c45a66385b66a603a75b4cf089c8d, a103fc4b3a433864] in aSlowerRoute
10:13:41.888 [9e8c45a66385b66a603a75b4cf089c8d, a103fc4b3a433864] still in aSlowerRoute
10:13:41.889 [9e8c45a66385b66a603a75b4cf089c8d, 7b525d393fa4af89] in aFasterRoute
10:13:41.893 [9e8c45a66385b66a603a75b4cf089c8d, 7b525d393fa4af89] still in aFasterRoute
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;However we really have a problem with the MDC context propagation that is not working out of the box. The above traces are taken when using the MDC instrumentation provided by Opentelemetry, which, IMO, should be the proper way to handle. I&apos;ll continue working to see how to reset the trace properly and we can have a further discussion once that is over.&lt;/p&gt;</comment>
                            <comment id="17903339" author="squakez" created="Thu, 5 Dec 2024 12:11:26 +0000"  >&lt;p&gt;Quick heads up on this issue. I am making progresses, though, I don&apos;t have yet the complete solution as certain tests are failing. This is what I got so far (I&apos;ve included the wiretap to simulate a real async call interleaved in the process):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
12:26:36.036 [5f7c87408ab2e29dd5e736ec742f62b4, 52a7e016f8afbae7] in timer route
12:26:36.044 [5f7c87408ab2e29dd5e736ec742f62b4, b64517a3ecde8117] in aSlowerRoute
12:26:37.046 [5f7c87408ab2e29dd5e736ec742f62b4, b64517a3ecde8117] still in aSlowerRoute
12:26:37.048 [5f7c87408ab2e29dd5e736ec742f62b4, cb4d3e47274def0b] in aFasterRoute
12:26:37.549 [5f7c87408ab2e29dd5e736ec742f62b4, cb4d3e47274def0b] still in aFasterRoute

12:26:46.005 [bbe4122e503a3f9dfdc3806f0e3ea2af, a645119e2f5db80c] in timer route
12:26:46.007 [bbe4122e503a3f9dfdc3806f0e3ea2af, cb87f425ad3ca37a] in aSlowerRoute
12:26:47.009 [bbe4122e503a3f9dfdc3806f0e3ea2af, cb87f425ad3ca37a] still in aSlowerRoute
12:26:47.012 [bbe4122e503a3f9dfdc3806f0e3ea2af, 29ba3f5768fc64ab] in aFasterRoute
12:26:47.049 [5f7c87408ab2e29dd5e736ec742f62b4, 3646aa00eebee873] Exchange[ExchangePattern: InOnly, BodyType: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, Body: Tapped]
12:26:47.513 [bbe4122e503a3f9dfdc3806f0e3ea2af, 29ba3f5768fc64ab] still in aFasterRoute

12:26:55.986 [ca13252e5519903caacca8783b12b6b2, ad1e2070205874ec] in timer route
12:26:55.988 [ca13252e5519903caacca8783b12b6b2, 698855d05a1ae402] in aSlowerRoute
12:26:56.990 [ca13252e5519903caacca8783b12b6b2, 698855d05a1ae402] still in aSlowerRoute
12:26:56.991 [ca13252e5519903caacca8783b12b6b2, 1ffab7e5f139eb24] in aFasterRoute
12:26:57.009 [bbe4122e503a3f9dfdc3806f0e3ea2af, dcb95bf8393b9e38] Exchange[ExchangePattern: InOnly, BodyType: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, Body: Tapped]
12:26:57.492 [ca13252e5519903caacca8783b12b6b2, 1ffab7e5f139eb24] still in aFasterRoute


^C12:27:01.241 [, ] Apache Camel 4.9.0-SNAPSHOT (camel-1) is shutting down (timeout:45s)
12:27:01.246 [, ] Waiting as there are still 5 inflight and pending exchanges to complete, timeout in 45 seconds. Inflights per route: [route3 = 1, timer = 4]
12:27:02.248 [, ] Waiting as there are still 5 inflight and pending exchanges to complete, timeout in 44 seconds. Inflights per route: [route3 = 1, timer = 4]
12:27:03.249 [, ] Waiting as there are still 5 inflight and pending exchanges to complete, timeout in 43 seconds. Inflights per route: [route3 = 1, timer = 4]
12:27:04.251 [, ] Waiting as there are still 5 inflight and pending exchanges to complete, timeout in 42 seconds. Inflights per route: [route3 = 1, timer = 4]
12:27:05.252 [, ] Waiting as there are still 5 inflight and pending exchanges to complete, timeout in 41 seconds. Inflights per route: [route3 = 1, timer = 4]
12:27:06.255 [, ] Waiting as there are still 5 inflight and pending exchanges to complete, timeout in 40 seconds. Inflights per route: [route3 = 1, timer = 4]
12:27:06.990 [ca13252e5519903caacca8783b12b6b2, 941ea6fceb1d3016] Exchange[ExchangePattern: InOnly, BodyType: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, Body: Tapped]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;You may notice the wiretap trace belong to the previous exchange, which is expected as I made it on purpose to the wiretap to be started with some delay and fall into the execution of the following exchange.&lt;/p&gt;</comment>
                            <comment id="17911467" author="squakez" created="Thu, 9 Jan 2025 12:36:08 +0000"  >&lt;p&gt;This issue is part of a wider scope redesign as proposed in &lt;a href=&quot;https://github.com/apache/camel/pull/16753&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/16753&lt;/a&gt; - closing it in favor of a later epic that will be the result of the PR discussion.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13073066" name="image-2024-11-26-09-59-35-555.png" size="150131" author="ganteth" created="Tue, 26 Nov 2024 08:59:35 +0000"/>
                            <attachment id="13073115" name="image-2024-11-29-17-04-16-581.png" size="38995" author="ganteth" created="Fri, 29 Nov 2024 16:04:16 +0000"/>
                            <attachment id="13073116" name="image-2024-11-29-17-06-26-116.png" size="92960" author="ganteth" created="Fri, 29 Nov 2024 16:06:26 +0000"/>
                            <attachment id="13073117" name="image-2024-11-29-17-06-42-860.png" size="94067" author="ganteth" created="Fri, 29 Nov 2024 16:06:42 +0000"/>
                            <attachment id="13073118" name="image-2024-11-29-17-12-49-768.png" size="86731" author="ganteth" created="Fri, 29 Nov 2024 16:12:49 +0000"/>
                            <attachment id="13073119" name="image-2024-11-29-17-12-58-036.png" size="87815" author="ganteth" created="Fri, 29 Nov 2024 16:12:58 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            43 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1sr1s:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>