<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:26:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-10241] MockEndpointAndSkip and DirtiesContext not working</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-10241</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;MockEndpointAndSkip does not seem to get re-applied after each test when used in conjunction with DirtiesContext. Here is a unit test exhibiting the problem&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;@RunWith(CamelSpringBootJUnit4ClassRunner.class)
@SpringApplicationConfiguration
@MockEndpointsAndSkip(&quot;direct:b&quot;)
@DirtiesContext(classMode = ClassMode.AFTER_EACH_TEST_METHOD)
public class MockTest {

	@Produce(uri = &quot;direct:a&quot;)
	private ProducerTemplate producer;

	@EndpointInject(uri = &quot;mock:end&quot;)
	private MockEndpoint end;

	@EndpointInject(uri = &quot;mock:direct:b&quot;)
	private MockEndpoint directB;

	@Autowired
	private CamelContext context;

	@Configuration
	@EnableAutoConfiguration
	public static class Config extends SpringRouteBuilder {

		@Override
		public void configure() throws Exception {
			from(&quot;direct:a&quot;).to(&quot;direct:b&quot;);
			from(&quot;direct:b&quot;).to(&quot;mock:end&quot;);
		}
	}

	@Test
	public void testMock() throws InterruptedException {
		end.expectedMessageCount(0);
		directB.expectedBodiesReceived(&quot;hello&quot;);

		producer.sendBody(&quot;hello&quot;);

		MockEndpoint.assertIsSatisfied(context);
	}

	@Test
	public void testMock2() throws InterruptedException {
		end.expectedMessageCount(0);
		directB.expectedBodiesReceived(&quot;hello&quot;);

		producer.sendBody(&quot;hello&quot;);

		MockEndpoint.assertIsSatisfied(context);
	}
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;testMock and testMock2 are exactly the same and if run individually, they pass. However if you run both, the second one will always fail. Running them both inside eclipse and from maven command line exhibit the same behaviour. &lt;/p&gt;

&lt;p&gt;The error I get is&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.AssertionError: mock://end Received message count. Expected: &amp;lt;0&amp;gt; but was: &amp;lt;1&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Which must mean that the skipping isn&#8217;t working. Here&#8217;s the tracer output to confirm&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.camel.processor.interceptor.Tracer - ID-minhmac-local-51406-1470352938165-1-2 &amp;gt;&amp;gt;&amp;gt; (route3) from(direct://a) --&amp;gt; direct://b &amp;lt;&amp;lt;&amp;lt; Pattern:InOnly, Headers:{breadcrumbId=ID-minhmac-local-51406-1470352938165-1-1}, BodyType:String, Body:hello
org.apache.camel.processor.interceptor.Tracer - ID-minhmac-local-51406-1470352938165-1-2 &amp;gt;&amp;gt;&amp;gt; (route4) direct://b --&amp;gt; mock://end &amp;lt;&amp;lt;&amp;lt; Pattern:InOnly, Headers:{breadcrumbId=ID-minhmac-local-51406-1470352938165-1-1}, BodyType:String, Body:hello
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If you remove the DirtiesContext, then both tests passes. My suspicion is that there is a bug when re-applying the MockEndpointAndSkip when the spring context is being rebuilt between tests.&lt;/p&gt;</description>
                <environment>&lt;p&gt;java8&lt;br/&gt;
spring boot 1.3.6&lt;/p&gt;</environment>
        <key id="12996789">CAMEL-10241</key>
            <summary>MockEndpointAndSkip and DirtiesContext not working</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="5">Cannot Reproduce</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="mtran">Minh Tran</reporter>
                        <labels>
                    </labels>
                <created>Thu, 11 Aug 2016 23:07:16 +0000</created>
                <updated>Wed, 1 Nov 2017 10:49:04 +0000</updated>
                            <resolved>Wed, 1 Nov 2017 10:38:05 +0000</resolved>
                                    <version>2.17.3</version>
                                    <fixVersion>2.21.0</fixVersion>
                                    <component>camel-test</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15422437" author="jybesson" created="Tue, 16 Aug 2016 08:47:00 +0000"  >&lt;p&gt;Hello Minh Tran,&lt;/p&gt;

&lt;p&gt;I already experienced that kind of problem, I think you need to add the annotation on your test to make Camel check the annotation :&lt;br/&gt;
@ContextConfiguration(&lt;br/&gt;
        // Since Camel 2.11.0 &lt;br/&gt;
        loader = CamelSpringDelegatingTestContextLoader.class&lt;br/&gt;
    )&lt;/p&gt;

&lt;p&gt;Jean-Yves&lt;/p&gt;</comment>
                            <comment id="15423484" author="mtran" created="Tue, 16 Aug 2016 22:12:52 +0000"  >&lt;p&gt;Hi Jean-Yves, I just tried that annotation but it still showing the same problem. Works individually but fails when both are run.&lt;/p&gt;</comment>
                            <comment id="15423497" author="mtran" created="Tue, 16 Aug 2016 22:20:46 +0000"  >&lt;p&gt;I have done some more experimenting and if you split up the 2 tests into 2 different classes, remove the @DirtiesContext (there&apos;s no need for it since the context isn&apos;t being reused anyway). &lt;br/&gt;
ie&lt;br/&gt;
class MockTest containing only testMock()&lt;br/&gt;
class MockTest2 containing only testMock()&lt;/p&gt;

&lt;p&gt;The tests passes individually but fail if you run both test classes. So it appears as though the issue is not specifically about DirtiesContext but maybe around creating new spring contexts?&lt;/p&gt;</comment>
                            <comment id="15424530" author="jybesson" created="Wed, 17 Aug 2016 13:40:11 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;I run your tests on my side and got the same results. I found a possible answer : the loader CamelSpringDelegatingTestContextLoader.class which is responsible of annotation post-processing when spring context is loaded is in conflict with another loader defined in @SpringApplicationConfiguration.&lt;/p&gt;

&lt;p&gt;If you remove @SpringApplicationConfiguration and @EnableAutoConfiguration every works nicely with @DirtiesContext and @MockEndpoints. Here is my code, based on camel-spring-javaconfig :&lt;/p&gt;

&lt;p&gt;@RunWith(CamelSpringBootJUnit4ClassRunner.class)&lt;br/&gt;
@MockEndpointsAndSkip(&quot;direct:b&quot;)&lt;br/&gt;
@ContextConfiguration(classes = &lt;/p&gt;
{MockTest.Config.class}
&lt;p&gt;, loader = CamelSpringDelegatingTestContextLoader.class)&lt;br/&gt;
@DirtiesContext(classMode = ClassMode.AFTER_EACH_TEST_METHOD)&lt;br/&gt;
public class MockTest {&lt;/p&gt;

&lt;p&gt;    @Produce(uri = &quot;direct:a&quot;)&lt;br/&gt;
    private ProducerTemplate producer;&lt;/p&gt;

&lt;p&gt;    @EndpointInject(uri = &quot;mock:end&quot;)&lt;br/&gt;
    private MockEndpoint end;&lt;/p&gt;

&lt;p&gt;    @EndpointInject(uri = &quot;mock:direct:b&quot;)&lt;br/&gt;
    private MockEndpoint directB;&lt;/p&gt;

&lt;p&gt;    @Autowired&lt;br/&gt;
    private CamelContext context;&lt;/p&gt;

&lt;p&gt;    @Configuration&lt;br/&gt;
    public static class Config extends SingleRouteCamelConfiguration {&lt;/p&gt;

&lt;p&gt;        @Override&lt;br/&gt;
        public RouteBuilder route() {&lt;/p&gt;

&lt;p&gt;            return new RouteBuilder() {&lt;/p&gt;

&lt;p&gt;                @Override&lt;br/&gt;
                public void configure() throws Exception &lt;/p&gt;
{
                    this.from(&quot;direct:a&quot;).to(&quot;direct:b&quot;).routeId(&quot;route1&quot;);
                    this.from(&quot;direct:b&quot;).to(&quot;mock:end&quot;).routeId(&quot;route2&quot;);
                }

&lt;p&gt;            };&lt;/p&gt;

&lt;p&gt;        };&lt;/p&gt;

&lt;p&gt;    }&lt;/p&gt;

&lt;p&gt;    @Test&lt;br/&gt;
    public void testMock() throws InterruptedException &lt;/p&gt;
{

        this.end.expectedMessageCount(0);
        this.directB.expectedBodiesReceived(&quot;hello&quot;);

        this.producer.sendBody(&quot;hello&quot;);

        MockEndpoint.assertIsSatisfied(this.context);
    }&lt;br/&gt;
&lt;br/&gt;
    @Test&lt;br/&gt;
    public void testMock2() throws InterruptedException {
        this.end.expectedMessageCount(0);        this.directB.expectedBodiesReceived(&quot;hello&quot;);
        this.producer.sendBody(&quot;hello&quot;);
        MockEndpoint.assertIsSatisfied(this.context);    }
&lt;p&gt;}&lt;/p&gt;</comment>
                            <comment id="15424544" author="jybesson" created="Wed, 17 Aug 2016 13:49:55 +0000"  >&lt;p&gt;I will try to find a solution to have both Spring Boot and Camel annotation support in tests but it might take time as I&apos;m not a spring boot expert&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Anyone can help here ?&lt;/p&gt;</comment>
                            <comment id="15424661" author="mtran" created="Wed, 17 Aug 2016 14:57:58 +0000"  >&lt;p&gt;If you remove the @SpringApplicationConfiguration and @EnableAutoConfiguration then you lose all the spring boot benefits, eg properties configuration and auto configuration for camel as well&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I think in the @SpringApplicationConfiguration, there is an initializer property which you can probably add a custom one for Camel to do its thing when the context gets created?&lt;/p&gt;</comment>
                            <comment id="15424695" author="jybesson" created="Wed, 17 Aug 2016 15:16:35 +0000"  >&lt;p&gt;I think it is not possible inside a Spring Initializer because camel context is not created at that step of execution.&lt;br/&gt;
A good way to fix the problem would be to call CamelAnnotationsHandler.handleMockEndpoints(...) in CamelSpringBootExecutionListener.beforeTestMethod(...). For the moment it is only done for prepareInstance() method &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15447363" author="mtran" created="Mon, 29 Aug 2016 23:11:57 +0000"  >&lt;p&gt;I&apos;ve found a workaround for the mean time&lt;/p&gt;

&lt;p&gt;I removed the @MockendpointAndSkip and added @UseAdviceWith&lt;/p&gt;

&lt;p&gt;then modified/added the following beforeTest function&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;        @Configuration
	@EnableAutoConfiguration
	public static class Config extends SpringRouteBuilder {

		@Override
		public void configure() throws Exception {
			from(&quot;direct:a&quot;).routeId(&quot;a&quot;).to(&quot;direct:b&quot;);
			from(&quot;direct:b&quot;).routeId(&quot;b&quot;).to(&quot;mock:end&quot;);
		}
	}

       @Before
	public void beforeTest() throws Exception {
		context.getRouteDefinition(&quot;a&quot;).adviceWith(context, new AdviceWithRouteBuilder() {

			@Override
			public void configure() throws Exception {
				mockEndpointsAndSkip(&quot;direct:b&quot;);
			}
		});
		context.start();
	}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Not as convenient but at least now I can test properly in Spring Boot and have the ability to mock and skip end points&lt;/p&gt;</comment>
                            <comment id="16233908" author="davsclaus" created="Wed, 1 Nov 2017 10:38:05 +0000"  >&lt;p&gt;Works on latest release with camel-spring-boot unit tests&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13014983">CAMEL-10413</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 2 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i328dr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>