<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:30:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-12656] camel-zipkin - Root Span Id is not reported if the route calls multiple route</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-12656</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;Camel-Zipkin does not report traces with root span id when there are multiple routes.&#160;&lt;/p&gt;

&lt;p&gt;For example:&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
from(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:foo&quot;&lt;/span&gt;)
        .delay(1000)
        .to(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:bar&quot;&lt;/span&gt;)
        .to(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:moo&quot;&lt;/span&gt;)
        .to(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:tar&quot;&lt;/span&gt;);

from(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:bar&quot;&lt;/span&gt;)
        .delay(2000);

from(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:moo&quot;&lt;/span&gt;)
        .delay(1000);

from(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:tar&quot;&lt;/span&gt;)
        .delay(3000);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Root SpanId(TraceId) should be for service-name = direct:foo and the trace in UI should show all the 4 routes in one sequence. But it breaks. Check the attached screenshot: Traces Breaking.png&lt;/p&gt;

&lt;p&gt;I looked into the code and figured out why its happening. Here is the code which is breaking the functionality.&lt;/p&gt;

&lt;p&gt;Class Name: ZipkinTracer.ZipkinRoutePolicy&lt;br/&gt;
Inside&#160;onExchangeBegin() method&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// add on completion after the route is done, but before the consumer writes the response
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; allows us to track the zipkin event before returning the response which is the right time
&lt;/span&gt;exchange.addOnCompletion(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SynchronizationAdapter() {
    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void onAfterRoute(Route route, Exchange exchange) {
        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; serviceName = getServiceName(exchange, route.getEndpoint(), &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
        Brave brave = getBrave(serviceName);
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (brave != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            serverResponse(brave, serviceName, exchange);
        }
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; toString() {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;ZipkinTracerOnCompletion[&quot;&lt;/span&gt; + routeId + &lt;span class=&quot;code-quote&quot;&gt;&quot;]&quot;&lt;/span&gt;;
    }
});
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Using onAfterRoute() : &#160;if the exchange is being routed through multiple routes, there will be callbacks for each route.&lt;/p&gt;

&lt;p&gt;I have fix for it:&#160;&lt;br/&gt;
If I use&#160;onExchangeDone() instead of above code. The traces are reported properly.&#160; Check screenshots.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://zipkin.io/pages/instrumenting.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://zipkin.io/pages/instrumenting.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Note&lt;/b&gt;&#160;This process must be repeated if the service makes multiple downstream calls. That is each subsequent span will have the same trace id and parent id, but a new and different span id.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13172420">CAMEL-12656</key>
            <summary>camel-zipkin - Root Span Id is not reported if the route calls multiple route</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="st2654">Sourabh Taletiya</reporter>
                        <labels>
                    </labels>
                <created>Mon, 16 Jul 2018 14:59:47 +0000</created>
                <updated>Wed, 1 Aug 2018 08:48:26 +0000</updated>
                            <resolved>Wed, 1 Aug 2018 08:48:26 +0000</resolved>
                                    <version>2.21.1</version>
                                    <fixVersion>2.21.3</fixVersion>
                    <fixVersion>2.22.1</fixVersion>
                    <fixVersion>2.23.0</fixVersion>
                                    <component>camel-zipkin</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16545291" author="st2654" created="Mon, 16 Jul 2018 15:01:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cibsen%40e-ma.net&quot; class=&quot;user-hover&quot; rel=&quot;cibsen@e-ma.net&quot;&gt;cibsen@e-ma.net&lt;/a&gt; How can I assign this issue to me?&lt;/p&gt;</comment>
                            <comment id="16545315" author="ancosen" created="Mon, 16 Jul 2018 15:15:29 +0000"  >&lt;p&gt;You can&apos;t. It&apos;s sufficient to leave a comment.&lt;/p&gt;

&lt;p&gt;Also, test your app with the camel master code where we updated camel-zipkin.&#160;&lt;/p&gt;

&lt;p&gt;If you&apos;re breaking the normal behavior then your fix can be only be merged on master.&lt;/p&gt;</comment>
                            <comment id="16547481" author="davsclaus" created="Wed, 18 Jul 2018 07:24:01 +0000"  >&lt;p&gt;Yeah this seems more correct, thanks for the suggested fix. The root id should be used to group all of that activity on the exchange together, and your screenshots with the fix shows that.&lt;/p&gt;

&lt;p&gt;You are welcome to provide a github PR with the fix&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/camel/blob/master/CONTRIBUTING.md&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/blob/master/CONTRIBUTING.md&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16564695" author="githubbot" created="Wed, 1 Aug 2018 03:54:04 +0000"  >&lt;p&gt;st2654 opened a new pull request #2448: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12656&quot; title=&quot;camel-zipkin - Root Span Id is not reported if the route calls multiple route&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12656&quot;&gt;&lt;del&gt;CAMEL-12656&lt;/del&gt;&lt;/a&gt;: Fixed root span id for multiple routes.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2448&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2448&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12656&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CAMEL-12656&lt;/a&gt;&lt;br/&gt;
   I have added screenshots in Jira already.&lt;br/&gt;
   Camel-Zipkin does not report traces with root span id when there are multiple routes. &lt;/p&gt;

&lt;p&gt;   For example: &lt;br/&gt;
   `from(&quot;direct:foo&quot;)&lt;br/&gt;
           .delay(1000)&lt;br/&gt;
           .to(&quot;direct:bar&quot;)&lt;br/&gt;
           .to(&quot;direct:moo&quot;)&lt;br/&gt;
           .to(&quot;direct:tar&quot;);&lt;/p&gt;

&lt;p&gt;   from(&quot;direct:bar&quot;)&lt;br/&gt;
           .delay(2000);&lt;/p&gt;

&lt;p&gt;   from(&quot;direct:moo&quot;)&lt;br/&gt;
           .delay(1000);&lt;/p&gt;

&lt;p&gt;   from(&quot;direct:tar&quot;)&lt;br/&gt;
           .delay(3000);`&lt;/p&gt;

&lt;p&gt;   Root SpanId(TraceId) should be for service-name = direct:foo and the trace in UI should show all the 4 routes in one sequence. But it breaks. Check the attached screenshot: Traces Breaking.png&lt;/p&gt;

&lt;p&gt;   I looked into the code and figured out why its happening. Here is the code which is breaking the functionality.&lt;/p&gt;

&lt;p&gt;   Class Name: ZipkinTracer.ZipkinRoutePolicy&lt;br/&gt;
   Inside onExchangeBegin() method &lt;/p&gt;



&lt;p&gt;   // add on completion after the route is done, but before the consumer writes the response&lt;br/&gt;
   // this allows us to track the zipkin event before returning the response which is the right time&lt;br/&gt;
   exchange.addOnCompletion(new SynchronizationAdapter() {&lt;br/&gt;
       @Override&lt;br/&gt;
       public void onAfterRoute(Route route, Exchange exchange) {&lt;br/&gt;
           String serviceName = getServiceName(exchange, route.getEndpoint(), true, false);&lt;br/&gt;
           Brave brave = getBrave(serviceName);&lt;br/&gt;
           if (brave != null) &lt;/p&gt;
{
               serverResponse(brave, serviceName, exchange);
           }
&lt;p&gt;       }&lt;/p&gt;

&lt;p&gt;       @Override&lt;br/&gt;
       public String toString() &lt;/p&gt;
{
           return &quot;ZipkinTracerOnCompletion[&quot; + routeId + &quot;]&quot;;
       }
&lt;p&gt;   });&lt;/p&gt;




&lt;p&gt;   Using onAfterRoute() :  if the exchange is being routed through multiple routes, there will be callbacks for each route.&lt;/p&gt;

&lt;p&gt;   I have fix for it: &lt;br/&gt;
   If I use onExchangeDone() instead of above code. The traces are reported properly.  Check screenshots.&lt;/p&gt;

&lt;p&gt;   &lt;a href=&quot;https://zipkin.io/pages/instrumenting.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://zipkin.io/pages/instrumenting.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;   Note This process must be repeated if the service makes multiple downstream calls. That is each subsequent span will have the same trace id and parent id, but a new and different span id.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16564696" author="githubbot" created="Wed, 1 Aug 2018 03:54:05 +0000"  >&lt;p&gt;GitHub user st2654 opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/2448&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2448&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12656&quot; title=&quot;camel-zipkin - Root Span Id is not reported if the route calls multiple route&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12656&quot;&gt;&lt;del&gt;CAMEL-12656&lt;/del&gt;&lt;/a&gt;: Fixed root span id for multiple routes.&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12656&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CAMEL-12656&lt;/a&gt;&lt;br/&gt;
    I have added screenshots in Jira already.&lt;br/&gt;
    Camel-Zipkin does not report traces with root span id when there are multiple routes. &lt;/p&gt;

&lt;p&gt;    For example: &lt;br/&gt;
    `from(&quot;direct:foo&quot;)&lt;br/&gt;
            .delay(1000)&lt;br/&gt;
            .to(&quot;direct:bar&quot;)&lt;br/&gt;
            .to(&quot;direct:moo&quot;)&lt;br/&gt;
            .to(&quot;direct:tar&quot;);&lt;/p&gt;

&lt;p&gt;    from(&quot;direct:bar&quot;)&lt;br/&gt;
            .delay(2000);&lt;/p&gt;

&lt;p&gt;    from(&quot;direct:moo&quot;)&lt;br/&gt;
            .delay(1000);&lt;/p&gt;

&lt;p&gt;    from(&quot;direct:tar&quot;)&lt;br/&gt;
            .delay(3000);`&lt;/p&gt;

&lt;p&gt;    Root SpanId(TraceId) should be for service-name = direct:foo and the trace in UI should show all the 4 routes in one sequence. But it breaks. Check the attached screenshot: Traces Breaking.png&lt;/p&gt;

&lt;p&gt;    I looked into the code and figured out why its happening. Here is the code which is breaking the functionality.&lt;/p&gt;

&lt;p&gt;    Class Name: ZipkinTracer.ZipkinRoutePolicy&lt;br/&gt;
    Inside onExchangeBegin() method &lt;/p&gt;



&lt;p&gt;    // add on completion after the route is done, but before the consumer writes the response&lt;br/&gt;
    // this allows us to track the zipkin event before returning the response which is the right time&lt;br/&gt;
    exchange.addOnCompletion(new SynchronizationAdapter() {&lt;br/&gt;
        @Override&lt;br/&gt;
        public void onAfterRoute(Route route, Exchange exchange) {&lt;br/&gt;
            String serviceName = getServiceName(exchange, route.getEndpoint(), true, false);&lt;br/&gt;
            Brave brave = getBrave(serviceName);&lt;br/&gt;
            if (brave != null) &lt;/p&gt;
{
                serverResponse(brave, serviceName, exchange);
            }
&lt;p&gt;        }&lt;/p&gt;

&lt;p&gt;        @Override&lt;br/&gt;
        public String toString() &lt;/p&gt;
{
            return &quot;ZipkinTracerOnCompletion[&quot; + routeId + &quot;]&quot;;
        }
&lt;p&gt;    });&lt;/p&gt;




&lt;p&gt;    Using onAfterRoute() :  if the exchange is being routed through multiple routes, there will be callbacks for each route.&lt;/p&gt;

&lt;p&gt;    I have fix for it: &lt;br/&gt;
    If I use onExchangeDone() instead of above code. The traces are reported properly.  Check screenshots.&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://zipkin.io/pages/instrumenting.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://zipkin.io/pages/instrumenting.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Note This process must be repeated if the service makes multiple downstream calls. That is each subsequent span will have the same trace id and parent id, but a new and different span id.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/st2654/camel&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/st2654/camel&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12656&quot; title=&quot;camel-zipkin - Root Span Id is not reported if the route calls multiple route&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12656&quot;&gt;&lt;del&gt;CAMEL-12656&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/2448.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2448.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #2448&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit ca7fdaecc6645506a81c24409602ba3819b169b5&lt;br/&gt;
Author: Sourabh Taletiya &amp;lt;st2654@...&amp;gt;&lt;br/&gt;
Date:   2018-08-01T03:49:24Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12656&quot; title=&quot;camel-zipkin - Root Span Id is not reported if the route calls multiple route&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12656&quot;&gt;&lt;del&gt;CAMEL-12656&lt;/del&gt;&lt;/a&gt;: Fixed root span id for multiple routes.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16564702" author="githubbot" created="Wed, 1 Aug 2018 04:02:12 +0000"  >&lt;p&gt;st2654 commented on issue #2448: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12656&quot; title=&quot;camel-zipkin - Root Span Id is not reported if the route calls multiple route&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12656&quot;&gt;&lt;del&gt;CAMEL-12656&lt;/del&gt;&lt;/a&gt;: Fixed root span id for multiple routes.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2448#issuecomment-409442095&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2448#issuecomment-409442095&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   @oscerd @davsclaus How can I add you as reviewers??&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16564708" author="githubbot" created="Wed, 1 Aug 2018 04:13:50 +0000"  >&lt;p&gt;st2654 commented on issue #2448: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12656&quot; title=&quot;camel-zipkin - Root Span Id is not reported if the route calls multiple route&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12656&quot;&gt;&lt;del&gt;CAMEL-12656&lt;/del&gt;&lt;/a&gt;: Fixed root span id for multiple routes.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2448#issuecomment-409443582&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2448#issuecomment-409443582&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   I want it to be part of SpringBoot 1.X and camel release 2.21.3 if possible.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16564967" author="githubbot" created="Wed, 1 Aug 2018 08:38:12 +0000"  >&lt;p&gt;davsclaus commented on issue #2448: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12656&quot; title=&quot;camel-zipkin - Root Span Id is not reported if the route calls multiple route&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12656&quot;&gt;&lt;del&gt;CAMEL-12656&lt;/del&gt;&lt;/a&gt;: Fixed root span id for multiple routes.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2448#issuecomment-409497470&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2448#issuecomment-409497470&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Thanks as the master branch has changed a bit with zipkin upgrades, then I can manually port it upwards.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16564968" author="githubbot" created="Wed, 1 Aug 2018 08:38:20 +0000"  >&lt;p&gt;davsclaus closed pull request #2448: &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12656&quot; title=&quot;camel-zipkin - Root Span Id is not reported if the route calls multiple route&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12656&quot;&gt;&lt;del&gt;CAMEL-12656&lt;/del&gt;&lt;/a&gt;: Fixed root span id for multiple routes.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/camel/pull/2448&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2448&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/components/camel-zipkin/src/main/java/org/apache/camel/zipkin/ZipkinTracer.java b/components/camel-zipkin/src/main/java/org/apache/camel/zipkin/ZipkinTracer.java&lt;br/&gt;
index fa6d8d2101f..401b14d9e09 100644&lt;br/&gt;
&amp;#8212; a/components/camel-zipkin/src/main/java/org/apache/camel/zipkin/ZipkinTracer.java&lt;br/&gt;
+++ b/components/camel-zipkin/src/main/java/org/apache/camel/zipkin/ZipkinTracer.java&lt;br/&gt;
@@ -757,24 +757,16 @@ public void onExchangeBegin(Route route, Exchange exchange) &lt;/p&gt;
{
                     serverRequest(brave, serviceName, exchange);
                 }
&lt;p&gt;             }&lt;br/&gt;
+        }&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// add on completion after the route is done, but before the consumer writes the response&lt;/li&gt;
	&lt;li&gt;// this allows us to track the zipkin event before returning the response which is the right time&lt;/li&gt;
	&lt;li&gt;exchange.addOnCompletion(new SynchronizationAdapter() {&lt;/li&gt;
	&lt;li&gt;@Override&lt;/li&gt;
	&lt;li&gt;public void onAfterRoute(Route route, Exchange exchange) {&lt;/li&gt;
	&lt;li&gt;String serviceName = getServiceName(exchange, route.getEndpoint(), true, false);&lt;/li&gt;
	&lt;li&gt;Brave brave = getBrave(serviceName);&lt;/li&gt;
	&lt;li&gt;if (brave != null) 
{
-                        serverResponse(brave, serviceName, exchange);
-                    }&lt;/li&gt;
	&lt;li&gt;}&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;@Override&lt;/li&gt;
	&lt;li&gt;public String toString() 
{
-                    return &quot;ZipkinTracerOnCompletion[&quot; + routeId + &quot;]&quot;;
-                }&lt;/li&gt;
	&lt;li&gt;});&lt;br/&gt;
+        // Report Server send after route has completed processing of the exchange.&lt;br/&gt;
+        @Override&lt;br/&gt;
+        public void onExchangeDone(Route route, Exchange exchange) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+            String serviceName = getServiceName(exchange, route.getEndpoint(), true, false);+            Brave brave = getBrave(serviceName);+            if (brave != null) {
+                serverResponse(brave, serviceName, exchange);
+            }         }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;     }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;






&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16564969" author="githubbot" created="Wed, 1 Aug 2018 08:38:20 +0000"  >&lt;p&gt;Github user davsclaus closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/2448&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/2448&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16564991" author="davsclaus" created="Wed, 1 Aug 2018 08:48:26 +0000"  >&lt;p&gt;Thanks for the PR.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12931805" name="Traces breaking.png" size="99309" author="st2654" created="Mon, 16 Jul 2018 14:32:12 +0000"/>
                            <attachment id="12931806" name="Traces fixed 1.png" size="44390" author="st2654" created="Mon, 16 Jul 2018 14:32:11 +0000"/>
                            <attachment id="12931807" name="Traces fixed 2.png" size="132140" author="st2654" created="Mon, 16 Jul 2018 14:32:11 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 16 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3vxqn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>