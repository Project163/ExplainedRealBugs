<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:09:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-8798] weaveAddLast throwing UnsupportedOperation when route have a ChoiceDefinition</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-8798</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;I&apos;m currently upgrading from Camel 2.14.1 to 2.15.2, after the upgrade some of my test are failing. &lt;/p&gt;

&lt;p&gt;My route is: &lt;/p&gt;
        &lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;from(&lt;span class=&quot;code-quote&quot;&gt;&quot;file:input?idempotent=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;amp;moveFailed=.error&quot;&lt;/span&gt;).routeId(&lt;span class=&quot;code-quote&quot;&gt;&quot;MyRoute&quot;&lt;/span&gt;)
        .choice()
             .when(body().isEqualTo(&lt;span class=&quot;code-quote&quot;&gt;&quot;body1&quot;&lt;/span&gt;))
                 .log(&lt;span class=&quot;code-quote&quot;&gt;&quot;body1&quot;&lt;/span&gt;)
             .otherwise()
                .log(&lt;span class=&quot;code-quote&quot;&gt;&quot;notBody1&quot;&lt;/span&gt;)
       .end()
 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;My test contains : &lt;/p&gt;

        &lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;camelContext.getRouteDefinition(&lt;span class=&quot;code-quote&quot;&gt;&quot;MyRoute&quot;&lt;/span&gt;).adviceWith(camelContext, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; AdviceWithRouteBuilder() {
            @Override
            &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void configure() {
                weaveAddLast().to(mockOutput);
            }
        });
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The weaveAddLast is failing with the following stackTrace: &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.UnsupportedOperationException 
        at java.util.AbstractList.add(AbstractList.java:148) 
        at org.apache.camel.builder.AdviceWithTasks$4.task(AdviceWithTasks.java:298) 
        at org.apache.camel.model.RouteDefinition.adviceWith(RouteDefinition.java:270) 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;After some debug I found that when my route and with a Choice I cannot weaveAddLast the route. &lt;br/&gt;
When the AdviceWithTasks task method try to add the outputs (&lt;a href=&quot;https://github.com/apache/camel/blob/camel-2.15.2/camel-core/src/main/java/org/apache/camel/builder/AdviceWithTasks.java#L298&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;) the implementation of the list return by the ChoiceDefinition class does not implements the method add(int,Object) then we have the UnsupportedOperation &lt;/p&gt;

&lt;p&gt;The difference between 2.14.1 and 2.15.2 is that in the AdviceWithTasks the outputs list where the weaveAddLast try to find the last Processor to add the outputs is not a list returned by ChoiceDefinition but it&apos;s a list with the Logs processor. &lt;/p&gt;

&lt;p&gt;This difference is there because now in 2.15.2 the method that is going through the route to retrieve the outputs nodes have a maximum depth which is computed &lt;a href=&quot;https://github.com/apache/camel/blob/camel-2.15.2/camel-core/src/main/java/org/apache/camel/model/ProcessorDefinitionHelper.java#L221&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;When my route have finish with a ChoiceDefinition the maximum depth computed is only 1 then I cannot have my logs in outputs an the weaveAddLast have in his list only the ChoiceDefinition. &lt;/p&gt;</description>
                <environment>&lt;p&gt;JDK 7.0 64bits&lt;/p&gt;</environment>
        <key id="12832710">CAMEL-8798</key>
            <summary>weaveAddLast throwing UnsupportedOperation when route have a ChoiceDefinition</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="gterral">Terral Guillaume</reporter>
                        <labels>
                    </labels>
                <created>Tue, 26 May 2015 13:14:56 +0000</created>
                <updated>Fri, 29 May 2015 07:43:58 +0000</updated>
                            <resolved>Fri, 29 May 2015 07:43:57 +0000</resolved>
                                    <version>2.14.2</version>
                    <version>2.15.0</version>
                    <version>2.15.1</version>
                    <version>2.15.2</version>
                                    <fixVersion>2.15.3</fixVersion>
                    <fixVersion>2.16.0</fixVersion>
                    <fixVersion>2.14.4</fixVersion>
                                    <component>camel-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14564357" author="davsclaus" created="Fri, 29 May 2015 07:43:57 +0000"  >&lt;p&gt;Thanks for reporting.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 25 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2f767:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310080" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Regression</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10091"><![CDATA[Regression]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>