<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:50:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-17048] Exchange header null after upgrading to 3.12 from 3.11.2 when using transacted</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-17048</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;After upgrading camel from &lt;tt&gt;3.11.2&lt;/tt&gt; to &lt;tt&gt;3.12.0&lt;/tt&gt; I notice that a header I set in a processor is not being available &quot;later on&quot; anymore.&lt;/p&gt;
&lt;h5&gt;&lt;a name=&quot;Itlooksasfollows%3A&quot;&gt;&lt;/a&gt;It looks as follows:&lt;/h5&gt;

&lt;p&gt;Route&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;from(source)
  .process(myprocessor::setHeader)
  ...
  .process(anotherprocessor)
  ..
  .to(target)
;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;where myprocessor.setHeader does sth like&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;void setHeader(Exchange exchange) {
  exchange.getIn().setHeader(&quot;my-header&quot;, 1234);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and &lt;tt&gt;anotherprocessor&lt;/tt&gt; wants to access this header, e.g.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;@Override
void process(Exchange exchange) {
  ...
  Long value = exchange.getIn().getHeader(&quot;my-header&quot;, Long.class);
  if (value == null) { 
    throw ..
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;While with 3.11.x this works fine it stopped with 3.12.0.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13405332">CAMEL-17048</key>
            <summary>Exchange header null after upgrading to 3.12 from 3.11.2 when using transacted</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="adoser">dosera</reporter>
                        <labels>
                    </labels>
                <created>Thu, 7 Oct 2021 07:20:53 +0000</created>
                <updated>Fri, 8 Oct 2021 07:55:13 +0000</updated>
                            <resolved>Fri, 8 Oct 2021 07:53:52 +0000</resolved>
                                    <version>3.12.0</version>
                                    <fixVersion>3.13.0</fixVersion>
                                    <component>camel-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17425398" author="davsclaus" created="Thu, 7 Oct 2021 08:12:05 +0000"  >&lt;p&gt;Can you debug / trace to see if that header is set at all. Also can you build an unit test that reproduce this.&lt;/p&gt;

&lt;p&gt;And how do you run Camel.&lt;/p&gt;</comment>
                            <comment id="17425506" author="adoser" created="Thu, 7 Oct 2021 11:51:24 +0000"  >&lt;h3&gt;&lt;a name=&quot;Example&quot;&gt;&lt;/a&gt;Example&lt;/h3&gt;

&lt;p&gt;Camel is run in a springboot service:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;spring boot: 2.5.5
...
org.apache.camel.springboot:camel-ftp-starter:3.12.0
org.apache.camel.springboot:camel-zipfile-starter:3.12.0
org.apache.camel.springboot:camel-log-starter:3.12.0
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I narrowed it down to the &quot;transacted&quot; statement I have in my route, see the following example:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;@Component
public class MyRoute extends EndpointRouteBuilder {

    @Component
    private static class ProcessorSet implements Processor {

        @Override
        public void process(Exchange exchange) throws Exception {
            exchange.getIn().setHeader(&quot;my-header&quot;, 1234L);
            exchange.getIn().setBody(List.of(&quot;a&quot;, &quot;b&quot;));
            System.out.println(&quot;Set body and header&quot;);
        }

    }

    @Component
    private static class ProcessorGet implements Processor {

        @Override
        public void process(Exchange exchange) throws Exception {
            Object body = exchange.getIn().getBody();
            Long header = exchange.getIn().getHeader(&quot;my-header&quot;, Long.class);
            System.out.println(&quot;Got body=&quot; + body + &quot; and header=&quot; + header);
        }

    }

    @Autowired
    ProcessorSet processorSet;
    @Autowired
    ProcessorGet processorGet;

    @Override
    public void configure() throws Exception {
        from(&quot;file:./data&quot;).routeId(&quot;test&quot;)
                           .process(processorSet)
                           .transacted()
                           .split(bodyAs(Iterator.class))
                           .streaming()
                           .process(processorGet)
                           .to(&quot;log:foo&quot;);
    }

}

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and my very basic unit test&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;@SpringBootTest
public class MainTest {

    @Test
    public void test() throws InterruptedException {
        while(true) {

        }
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;by just putting a random file into the &lt;tt&gt;./data&lt;/tt&gt; folder.&lt;/p&gt;
&lt;h3&gt;&lt;a name=&quot;Outcome&quot;&gt;&lt;/a&gt;Outcome&lt;/h3&gt;
&lt;h3&gt;&lt;a name=&quot;With3.12and%22transacted%22&quot;&gt;&lt;/a&gt;With 3.12 and &quot;transacted&quot;&lt;/h3&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Got body=GenericFile[test] and header=null
Set body and header
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;h3&gt;&lt;a name=&quot;With3.12andnottransacted&quot;&gt;&lt;/a&gt;With 3.12 and not transacted&lt;/h3&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Set body and header
Got body=a and header=1234
Got body=b and header=1234
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;h3&gt;&lt;a name=&quot;With3.11.2and%22transacted%22&quot;&gt;&lt;/a&gt;With 3.11.2 and &quot;transacted&quot;&lt;/h3&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Set body and header
Got body=a and header=1234
Got body=b and header=1234
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;h3&gt;&lt;a name=&quot;With3.11.2andnottransacted&quot;&gt;&lt;/a&gt;With 3.11.2 and not transacted&lt;/h3&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Set body and header
Got body=a and header=1234
Got body=b and header=1234
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;h3&gt;&lt;a name=&quot;Observations&quot;&gt;&lt;/a&gt;Observations&lt;/h3&gt;

&lt;p&gt;If I change the code to put the &lt;tt&gt;transacted&lt;/tt&gt; &lt;b&gt;before&lt;/b&gt; the processor it seems to work - so therefore this bug here is most likely invalid.&lt;br/&gt;
 Yet I would still be very interested in &lt;b&gt;why&lt;/b&gt; this is happening or more if this was a bug in 3.11.x ?&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="17425518" author="davsclaus" created="Thu, 7 Oct 2021 12:21:40 +0000"  >&lt;p&gt;Ah okay, transacted should always be first. Unfortunately the model dont have a nice enforcement of this. Thought we do have some code that validates the order and it seems not to detect this.&lt;/p&gt;</comment>
                            <comment id="17426025" author="davsclaus" created="Fri, 8 Oct 2021 07:53:52 +0000"  >&lt;p&gt;Thanks for the test cases&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 5 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0vmvk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>