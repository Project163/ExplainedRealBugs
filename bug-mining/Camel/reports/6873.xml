<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 11:07:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-21114] camel-zipfile - ZipSplitter with AggregationStrategy does not aggregate all splits</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-21114</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;A transacted route with ZipSplitter and Aggregation Strategy does not aggregate the last zip file entry. The issue only occurs for transacted routes.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Example:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Zip Archive&lt;/em&gt;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;em&gt;A.xml&lt;/em&gt;&lt;/li&gt;
	&lt;li&gt;&lt;em&gt;B.xml&lt;/em&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Both splits are processed but only for the first exchange (A.xml) the aggregate method is called.&lt;/p&gt;

&lt;p&gt;For a zip archive with two entries the doRun() method of MulticastTransactedTask is called three times. The third time iterator.next() returns null although hasNext() was true. As a result the doDone() method is called but there is still a task in the queue (with the second exchange). This task is processed after doDone() was executed but it&#8217;s not aggregated because of a done check in aggregate() of MulticastTransactedTask.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;We found the problem in Camel 3.14, but it is still present in Camel 3.22.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;It can be reproduced with the following test (it works if you remove the transacted tag from the route)&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.camel.AggregationStrategy;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.camel.Exchange;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.camel.builder.RouteBuilder;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.camel.component.mock.MockEndpoint;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.camel.dataformat.zipfile.ZipSplitter;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.camel.spring.spi.SpringTransactionPolicy;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.camel.test.junit4.CamelTestSupport;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.h2.jdbcx.JdbcDataSource;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.junit.Test;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.springframework.jdbc.datasource.DataSourceTransactionManager;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.springframework.transaction.support.TransactionTemplate;

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;ZipSplitterTest &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; CamelTestSupport &#160;{&#160; &#160; 

&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; zipArchiveWithTwoFiles = &lt;span class=&quot;code-quote&quot;&gt;&quot;UEsDBBQAAAAIAFlrtFDFAfecUAAAAB4BAAALAAAAT3JkZXJzMS54bWyzyS9KSS0qtuPl4oQwQSxOm8wUOxMb/cwUCK+gKD+lNLkEzOG0yUvMTbWDCik42uiD+WB1+kgKbfThxqEZbEqUwU6kG2xGlMHOhA2GsortAFBLAwQUAAAACABBW9hQgBf0tVgAAAAqAQAACwAAAE9yZGVyczIueG1ss8kvSkktKrbj5eKEMEEsTpvMFDtDQ0Mb/cwUCL+gKD+lNLkEzOG0yUvMTbWDCimA1YFFwCr1kZTa6MONRDPcyMiIKMPB6kg13NjYmCjDweoIGQ5lFdsBAFBLAQIfABQAAAAIAFlrtFDFAfecUAAAAB4BAAALACQAAAAAAAAAIAAAAAAAAABPcmRlcnMxLnhtbAoAIAAAAAAAAQAYAAD57I2ZLtYBg97kuHn02gEA+eyNmS7WAVBLAQIfABQAAAAIAEFb2FCAF/S1WAAAACoBAAALACQAAAAAAAAAIAAAAHkAAABPcmRlcnMyLnhtbAoAIAAAAAAAAQAYAAAxPXoJStYBjn3iuHn02gEAMT16CUrWAVBLBQYAAAAAAgACALoAAAD6AAAAAAA=&quot;&lt;/span&gt;;
&#160; &#160;&#160;
&#160; &#160; @Test
&#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testIfAllSplitsAggregated() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
&#160; &#160; &#160; &#160; MockEndpoint mock = getMockEndpoint(&lt;span class=&quot;code-quote&quot;&gt;&quot;mock:result&quot;&lt;/span&gt;);
&#160; &#160; &#160; &#160; template.sendBody(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:start&quot;&lt;/span&gt;, &quot;&quot;);
&#160; &#160; &#160; 
        &lt;span class=&quot;code-comment&quot;&gt;// Check &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; second file was processed in aggregate() method of AggregationStrategy
&lt;/span&gt;&#160; &#160; &#160; &#160; assertEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;Orders2.xml&quot;&lt;/span&gt;, mock.getExchanges().get(0).getMessage().getHeader(&lt;span class=&quot;code-quote&quot;&gt;&quot;CamelFileName&quot;&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.class));
&#160; &#160; }&#160; &#160; 

    @Override
&#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; RouteBuilder createRouteBuilder() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
&#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RouteBuilder() {
&#160; &#160; &#160; &#160; &#160; &#160; @Override
&#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void configure() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
&#160;&#160;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; JdbcDataSource dataSource = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; JdbcDataSource();
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; dataSource.setURL(&lt;span class=&quot;code-quote&quot;&gt;&quot;jdbc:h2:mem:testdb;DB_CLOSE_DELAY=-1&quot;&lt;/span&gt;);
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; dataSource.setUser(&lt;span class=&quot;code-quote&quot;&gt;&quot;sa&quot;&lt;/span&gt;);
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; dataSource.setPassword(&quot;&quot;);&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; 

                DataSourceTransactionManager txManager = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DataSourceTransactionManager(dataSource);
                
                TransactionTemplate transactionTemplate = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TransactionTemplate(txManager);
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; transactionTemplate.setPropagationBehaviorName(&lt;span class=&quot;code-quote&quot;&gt;&quot;PROPAGATION_REQUIRED&quot;&lt;/span&gt;);
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; transactionTemplate.setIsolationLevelName(&lt;span class=&quot;code-quote&quot;&gt;&quot;ISOLATION_READ_COMMITTED&quot;&lt;/span&gt;);
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; transactionTemplate.setTimeout(1800);

&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; SpringTransactionPolicy springTransactionPolicy = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SpringTransactionPolicy();
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; springTransactionPolicy.setTransactionManager(txManager);
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; springTransactionPolicy.setTransactionTemplate(transactionTemplate);
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; getContext().getRegistry().bind(&lt;span class=&quot;code-quote&quot;&gt;&quot;transacted&quot;&lt;/span&gt;, springTransactionPolicy);
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; getContext().getRegistry().bind(&lt;span class=&quot;code-quote&quot;&gt;&quot;zipSplitter&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ZipSplitter());

&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; from(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:start&quot;&lt;/span&gt;)
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; .transacted(&lt;span class=&quot;code-quote&quot;&gt;&quot;transacted&quot;&lt;/span&gt;)
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; .setBody().simple(zipArchiveWithTwoFiles)
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; .unmarshal().base64()
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; .split().ref(&lt;span class=&quot;code-quote&quot;&gt;&quot;zipSplitter&quot;&lt;/span&gt;).streaming().aggregationStrategy(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StringAggregationStrategy())
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; .log(&lt;span class=&quot;code-quote&quot;&gt;&quot;Splitted&quot;&lt;/span&gt;)
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; .end()
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; .to(&lt;span class=&quot;code-quote&quot;&gt;&quot;mock:result&quot;&lt;/span&gt;);
&#160; &#160; &#160; &#160; &#160; &#160; }
&#160; &#160; &#160; &#160; };
&#160; &#160; }
&#160; &#160;&#160;
&#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;StringAggregationStrategy &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; AggregationStrategy {
&#160; &#160; &#160; &#160; @Override
&#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Exchange aggregate(Exchange oldExchange, Exchange newExchange) {
&#160; &#160; &#160; &#160; &#160; &#160;&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(newExchange.getMessage().getHeader(&lt;span class=&quot;code-quote&quot;&gt;&quot;CamelFileName&quot;&lt;/span&gt;));
&#160; &#160; &#160; &#160; &#160; &#160;&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; newExchange;
&#160; &#160; &#160; &#160; }
&#160; &#160; }
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13589876">CAMEL-21114</key>
            <summary>camel-zipfile - ZipSplitter with AggregationStrategy does not aggregate all splits</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="AWeickel">Andre Weickel</reporter>
                        <labels>
                    </labels>
                <created>Fri, 23 Aug 2024 12:36:15 +0000</created>
                <updated>Mon, 2 Sep 2024 11:14:09 +0000</updated>
                            <resolved>Mon, 2 Sep 2024 11:14:09 +0000</resolved>
                                    <version>3.14.10</version>
                    <version>3.22.2</version>
                                    <fixVersion>4.8.0</fixVersion>
                                    <component>camel-zipfile</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17876577" author="davsclaus" created="Mon, 26 Aug 2024 04:36:10 +0000"  >&lt;p&gt;Camel 3.14 is EOL. Try with 3.22 or latest 4.x release.&lt;/p&gt;</comment>
                            <comment id="17876605" author="JIRAUSER280366" created="Mon, 26 Aug 2024 07:03:45 +0000"  >&lt;p&gt;As mentioned the issue also occurs with 3.22&lt;/p&gt;</comment>
                            <comment id="17876607" author="davsclaus" created="Mon, 26 Aug 2024 07:05:00 +0000"  >&lt;p&gt;Try with 4.7.0 if you can and report back&lt;/p&gt;</comment>
                            <comment id="17876999" author="JIRAUSER280366" created="Tue, 27 Aug 2024 12:29:58 +0000"  >&lt;p&gt;Same issue with 4.7.0&lt;/p&gt;</comment>
                            <comment id="17878410" author="davsclaus" created="Sun, 1 Sep 2024 08:02:27 +0000"  >&lt;p&gt;Okay its the zip iterator that does not work well with next / hasNext in transacted mode&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 10 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1r1co:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>