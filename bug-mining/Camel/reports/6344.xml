<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:59:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-18844] Possible memory leak in org.apache.camel.impl.console.EventConsole</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-18844</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;Today I have upgraded from 3.18.4 to 3.20.0 and did tests under heavy load as usual. After processing of approximately 3 millions of exchanges JVM&apos;s heap usage reached 4GB and it ran out of memory. I analyzed a dump in Eclipse MAT and it showed the following:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;One instance of org.apache.camel.spring.boot.SpringBootCamelContext loaded by org.apache.catalina.loader.ParallelWebappClassLoader @ 0x700b5adb0 occupies 3&#160;276&#160;629&#160;016 (97,38%) bytes. The memory is accumulated in one instance of java.lang.Object[], loaded by &amp;lt;system class loader&amp;gt;, which occupies 3&#160;276&#160;529&#160;992 (97,38%) bytes.Keywordsorg.apache.camel.spring.boot.SpringBootCamelContextorg.apache.catalina.loader.ParallelWebappClassLoader @ 0x700b5adb0java.lang.Object[]&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I discovered that the &lt;b&gt;java.util.ArrayDeque&lt;/b&gt; instance in &lt;b&gt;org.apache.camel.impl.console.EventConsole&lt;/b&gt; instance (most probably the exchangeEvents one) contains references to over 12 millions of various org.apache.camel.impl.event.* objects, like &lt;b&gt;ExchangeCreatedEvent&lt;/b&gt;, &lt;b&gt;ExchangeSentEvent&lt;/b&gt; etc.&lt;/p&gt;

&lt;p&gt;I will investigate this further, but it looks like the poll method on ArrayDeque does not do something as expected or is used in a wrong way&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13515746">CAMEL-18844</key>
            <summary>Possible memory leak in org.apache.camel.impl.console.EventConsole</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="rgala">Rafa&#322; Ga&#322;a</reporter>
                        <labels>
                    </labels>
                <created>Tue, 27 Dec 2022 14:29:52 +0000</created>
                <updated>Mon, 30 Jan 2023 08:59:47 +0000</updated>
                            <resolved>Thu, 29 Dec 2022 08:23:39 +0000</resolved>
                                    <version>3.20.0</version>
                                    <fixVersion>3.20.1</fixVersion>
                    <fixVersion>3.21.0</fixVersion>
                    <fixVersion>4.0-M1</fixVersion>
                    <fixVersion>4.0.0</fixVersion>
                                    <component>camel-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17652257" author="davsclaus" created="Tue, 27 Dec 2022 14:39:14 +0000"  >&lt;p&gt;Thanks for reporting&lt;/p&gt;</comment>
                            <comment id="17652258" author="davsclaus" created="Tue, 27 Dec 2022 14:41:45 +0000"  >&lt;p&gt;What JDK version are you using&lt;/p&gt;</comment>
                            <comment id="17652259" author="rgala" created="Tue, 27 Dec 2022 14:46:14 +0000"  >&lt;p&gt;I tried on below versions and it behaves exactly the same way on each of them:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java version &quot;11.0.17&quot; 2022-10-18 LTS
Java(TM) SE Runtime Environment 18.9 (build 11.0.17+10-LTS-269)
Java HotSpot(TM) 64-Bit Server VM 18.9 (build 11.0.17+10-LTS-269, mixed mode)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java version &quot;11.0.16&quot; 2022-07-19 LTS
Java(TM) SE Runtime Environment 18.9 (build 11.0.16+11-LTS-199)
Java HotSpot(TM) 64-Bit Server VM 18.9 (build 11.0.16+11-LTS-199, mixed mode)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17652260" author="rgala" created="Tue, 27 Dec 2022 14:53:09 +0000"  >&lt;p&gt;Shouldn&apos;t this be synchronized?&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (exchangeEvents.size() &amp;gt;= capacity) {
    exchangeEvents.poll();
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I maye be wrong but it looks like this poll call was made to prevent the queue size from exceeding value of initial capacity (default 25). Because it&apos;s not synchronized, the add method is called more often then the poll one.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17652261" author="davsclaus" created="Tue, 27 Dec 2022 14:53:12 +0000"  >&lt;p&gt;Its a bit strange as the event console only keep last 25 always for me, and old exchange instances becomes unreachable and GC can claim them.&lt;br/&gt;
You can try also to not include camel-console in your app, then its not present.&lt;/p&gt;</comment>
                            <comment id="17652263" author="rgala" created="Tue, 27 Dec 2022 14:59:25 +0000"  >&lt;p&gt;I don&apos;t think the ArrayDeque keeps only the last 25 added elements, it grows constantly when needed&lt;/p&gt;</comment>
                            <comment id="17652265" author="davsclaus" created="Tue, 27 Dec 2022 15:07:21 +0000"  >&lt;p&gt;Yes you are right that in case of high concurrent load, then more can be added than polled. I am working on fixing this.&lt;/p&gt;</comment>
                            <comment id="17652271" author="davsclaus" created="Tue, 27 Dec 2022 15:23:45 +0000"  >&lt;p&gt;Okay I have pushed a fix&lt;/p&gt;</comment>
                            <comment id="17652272" author="davsclaus" created="Tue, 27 Dec 2022 15:27:15 +0000"  >&lt;p&gt;I attached a build JAR for camel-console to this JIRA you can use to test with 3.20.0 release.&lt;/p&gt;</comment>
                            <comment id="17652397" author="rgala" created="Wed, 28 Dec 2022 07:10:10 +0000"  >&lt;p&gt;I think there is a bug in the code. You do poll from exchangeEvents queue in case of RouteEvent and others &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; This is what I see after decompiling attached JAR, in Github it looks OK.&lt;/p&gt;</comment>
                            <comment id="17652433" author="davsclaus" created="Wed, 28 Dec 2022 09:04:13 +0000"  >&lt;p&gt;Ah yeah my bad, I did a fix and re-uploaded a new JAR&lt;/p&gt;</comment>
                            <comment id="17652442" author="rgala" created="Wed, 28 Dec 2022 09:31:41 +0000"  >&lt;p&gt;Thank you. I tested with the provided JAR. The good news is that it does not leak anymore, the bad news is that performance has degraded &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Threads are mostly waiting for obtaining locks:&lt;/p&gt;


&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&quot;Camel (camel-1) thread #356 - jt400://***MASKED**** - Thread t@547
&#160; &#160;java.lang.Thread.State: WAITING
&#160; &#160; &#160; &#160; at jdk.internal.misc.Unsafe.park(Native Method)
&#160; &#160; &#160; &#160; - parking to wait for &amp;lt;364e961d&amp;gt; (a java.util.concurrent.locks.ReentrantLock$FairSync)
&#160; &#160; &#160; &#160; at java.util.concurrent.locks.LockSupport.park(LockSupport.java:194)
&#160; &#160; &#160; &#160; at java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:885)
&#160; &#160; &#160; &#160; at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireQueued(AbstractQueuedSynchronizer.java:917)
&#160; &#160; &#160; &#160; at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquire(AbstractQueuedSynchronizer.java:1240)
&#160; &#160; &#160; &#160; at java.util.concurrent.locks.ReentrantLock.lock(ReentrantLock.java:267)
&#160; &#160; &#160; &#160; at java.util.concurrent.ArrayBlockingQueue.offer(ArrayBlockingQueue.java:341)
&#160; &#160; &#160; &#160; at org.apache.camel.impl.console.EventConsole$ConsoleEventNotifier.notify(EventConsole.java:174)
&#160; &#160; &#160; &#160; at org.apache.camel.support.EventHelper.doNotifyEvent(EventHelper.java:1514)
&#160; &#160; &#160; &#160; at org.apache.camel.support.EventHelper.notifyExchangeAsyncProcessingStartedEvent(EventHelper.java:1502)
&#160; &#160; &#160; &#160; at org.apache.camel.processor.SendProcessor.process(SendProcessor.java:174)
&#160; &#160; &#160; &#160; at org.apache.camel.processor.errorhandler.RedeliveryErrorHandler$RedeliveryTask.doRun(RedeliveryErrorHandler.java:818)
&#160; &#160; &#160; &#160; at org.apache.camel.processor.errorhandler.RedeliveryErrorHandler$RedeliveryTask.run(RedeliveryErrorHandler.java:726)
&#160; &#160; &#160; &#160; at org.apache.camel.impl.engine.DefaultReactiveExecutor$Worker.schedule(DefaultReactiveExecutor.java:181)
&#160; &#160; &#160; &#160; at org.apache.camel.impl.engine.DefaultReactiveExecutor.scheduleMain(DefaultReactiveExecutor.java:59)
&#160; &#160; &#160; &#160; at org.apache.camel.processor.Pipeline.process(Pipeline.java:165)
&#160; &#160; &#160; &#160; at org.apache.camel.impl.engine.CamelInternalProcessor.process(CamelInternalProcessor.java:392)
&#160; &#160; &#160; &#160; at org.apache.camel.impl.engine.DefaultAsyncProcessorAwaitManager.process(DefaultAsyncProcessorAwaitManager.java:83)
&#160; &#160; &#160; &#160; at org.apache.camel.support.AsyncProcessorSupport.process(AsyncProcessorSupport.java:41)
&#160; &#160; &#160; &#160; at org.apache.camel.component.jt400.Jt400DataQueueConsumer.poll(Jt400DataQueueConsumer.java:60)
&#160; &#160; &#160; &#160; at org.apache.camel.support.ScheduledPollConsumer.doRun(ScheduledPollConsumer.java:202)
&#160; &#160; &#160; &#160; at org.apache.camel.support.ScheduledPollConsumer.run(ScheduledPollConsumer.java:116)
&#160; &#160; &#160; &#160; at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:515)
&#160; &#160; &#160; &#160; at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:305)
&#160; &#160; &#160; &#160; at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:305)
&#160; &#160; &#160; &#160; at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)
&#160; &#160; &#160; &#160; at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)
&#160; &#160; &#160; &#160; at java.lang.Thread.run(Thread.java:834)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17652492" author="davsclaus" created="Wed, 28 Dec 2022 12:58:55 +0000"  >&lt;p&gt;Thanks for testing.&lt;/p&gt;

&lt;p&gt;I have attached a new JAR that is faster (do not use locks). Can you test this JAR and report back, thanks.&lt;/p&gt;</comment>
                            <comment id="17652496" author="rgala" created="Wed, 28 Dec 2022 13:14:46 +0000"  >&lt;p&gt;Tried it and it looks like there is no performance impact at all, which is awesome. However, I got hundreds of errors like below:&lt;/p&gt;


&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2022-12-28 14:07:19.560 [Camel (camel-1) thread #152 - jt400://***MASKED***] WARN &#160;org.apache.camel.support.EventHelper.doNotifyEvent:1516 - Error notifying event 2939D080E649AA6-00000000000010D4 exchange sending to: direct://***MASKED***. This exception will be ignored.
java.lang.ArrayIndexOutOfBoundsException: Index 25 out of bounds for length 25
&#160; &#160; at org.apache.camel.impl.console.EventConsole$ConsoleEventNotifier.notify(EventConsole.java:188)
&#160; &#160; at org.apache.camel.support.EventHelper.doNotifyEvent(EventHelper.java:1514)
&#160; &#160; at org.apache.camel.support.EventHelper.notifyExchangeSending(EventHelper.java:942)
&#160; &#160; at org.apache.camel.processor.SendProcessor.process(SendProcessor.java:143)
&#160; &#160; at org.apache.camel.processor.errorhandler.RedeliveryErrorHandler$RedeliveryTask.doRun(RedeliveryErrorHandler.java:818)
&#160; &#160; at org.apache.camel.processor.errorhandler.RedeliveryErrorHandler$RedeliveryTask.run(RedeliveryErrorHandler.java:726)
&#160; &#160; at org.apache.camel.impl.engine.DefaultReactiveExecutor$Worker.schedule(DefaultReactiveExecutor.java:181)
&#160; &#160; at org.apache.camel.impl.engine.DefaultReactiveExecutor.scheduleMain(DefaultReactiveExecutor.java:59)
&#160; &#160; at org.apache.camel.processor.Pipeline.process(Pipeline.java:165)
&#160; &#160; at org.apache.camel.impl.engine.CamelInternalProcessor.process(CamelInternalProcessor.java:392)
&#160; &#160; at org.apache.camel.impl.engine.DefaultAsyncProcessorAwaitManager.process(DefaultAsyncProcessorAwaitManager.java:83)
&#160; &#160; at org.apache.camel.support.AsyncProcessorSupport.process(AsyncProcessorSupport.java:41)
&#160; &#160; at org.apache.camel.component.jt400.Jt400DataQueueConsumer.poll(Jt400DataQueueConsumer.java:60)
&#160; &#160; at org.apache.camel.support.ScheduledPollConsumer.doRun(ScheduledPollConsumer.java:202)
&#160; &#160; at org.apache.camel.support.ScheduledPollConsumer.run(ScheduledPollConsumer.java:116)
&#160; &#160; at java.base/java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:515)
&#160; &#160; at java.base/java.util.concurrent.FutureTask.runAndReset(FutureTask.java:305)
&#160; &#160; at java.base/java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:305)
&#160; &#160; at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)
&#160; &#160; at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)
&#160; &#160; at java.base/java.lang.Thread.run(Thread.java:834) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;or&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2022-12-28 14:07:23.122 [Camel (camel-1) thread #193 - jt400://***MASKED***] WARN &#160;org.apache.camel.support.EventHelper.doNotifyEvent:1516 - Error notifying event 2939D080E649AA6-0000000000004B48. This exception will be ignored.
java.lang.ArrayIndexOutOfBoundsException: null&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17652541" author="davsclaus" created="Wed, 28 Dec 2022 17:06:46 +0000"  >&lt;p&gt;Thanks.&lt;/p&gt;

&lt;p&gt;I should have tested it too under high load, but since you are on top of it then lets try again.&lt;br/&gt;
I have attached a new JAR that uses atomic counters from JDK (keep an eye on thread contention).&lt;/p&gt;</comment>
                            <comment id="17652748" author="rgala" created="Thu, 29 Dec 2022 07:29:49 +0000"  >&lt;p&gt;Thanks.&lt;/p&gt;

&lt;p&gt;This one seems perfect. No warnings in log and performance seems unaffected.&lt;/p&gt;</comment>
                            <comment id="17652764" author="davsclaus" created="Thu, 29 Dec 2022 08:23:39 +0000"  >&lt;p&gt;Thanks for testing&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13515827">CAMEL-18847</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13054198" name="camel-console-3.20.1-SNAPSHOT.jar" size="98356" author="davsclaus" created="Wed, 28 Dec 2022 17:05:53 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 45 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1eeko:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>