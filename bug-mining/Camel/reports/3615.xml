<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:15:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-9768] HTTP[4] component disableStreamCache issue: java.io.IOException: Attempted read from closed stream.</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-9768</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;This issue is related to &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-7638&quot; title=&quot;Use response input stream directly in http producer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-7638&quot;&gt;&lt;del&gt;CAMEL-7638&lt;/del&gt;&lt;/a&gt; which was recently fixed/released in 2.17.0&lt;/p&gt;

&lt;p&gt;I was doing some testing with disableStreamCache=true on a http4 producer and am getting &quot;java.io.IOException: Attempted read from closed stream&quot;&lt;/p&gt;

&lt;p&gt;The stack trace shows the error occurring when trying to copy the input stream to an output stream inside the DefaultHttpBinding copyStream methods (i am using camel as a proxy from a sevlet component (consumer) to an http4 component (producer)).&lt;/p&gt;

&lt;p&gt;I think though, I see the root cause of this issue.  Inside the HttpProducer process method.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;// lets store the result in the output message.
&lt;/span&gt;        HttpResponse httpResponse = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (LOG.isDebugEnabled()) {
                LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Executing http {} method: {}&quot;&lt;/span&gt;, httpRequest.getMethod(), httpRequest.getURI().toString());
            }
            httpResponse = executeMethod(httpRequest);
            &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; responseCode = httpResponse.getStatusLine().getStatusCode();
            LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Http responseCode: {}&quot;&lt;/span&gt;, responseCode);

            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!throwException) {
                &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; we &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; not use failed exception then populate response &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; all response codes
&lt;/span&gt;                populateResponse(exchange, httpRequest, httpResponse, in, strategy, responseCode);
            } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
                &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; ok = HttpHelper.isStatusCodeOk(responseCode, getEndpoint().getOkStatusCodeRange());
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (ok) {
                    &lt;span class=&quot;code-comment&quot;&gt;// only populate response &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; OK response
&lt;/span&gt;                    populateResponse(exchange, httpRequest, httpResponse, in, strategy, responseCode);
                } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
                    &lt;span class=&quot;code-comment&quot;&gt;// operation failed so populate exception to &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt;
&lt;/span&gt;                    &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; populateHttpOperationFailedException(exchange, httpRequest, httpResponse, responseCode);
                }
            }
        } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (httpResponse != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                    EntityUtils.consume(httpResponse.getEntity());
                } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
                    &lt;span class=&quot;code-comment&quot;&gt;// nothing we could &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt;
&lt;/span&gt;                }
            }
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Specifically, that finally block at the end.&lt;/p&gt;

&lt;p&gt;When disableStreamCache=true is set on the Producer, the raw input stream is put in the exchange body, which was the change fixed by &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-7638&quot; title=&quot;Use response input stream directly in http producer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-7638&quot;&gt;&lt;del&gt;CAMEL-7638&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;However, the finally block is consuming and closing that input stream making it unusable later when we try to copy it to the servlet output stream to send back to the caller.&lt;/p&gt;

&lt;p&gt;I think the fix for this would be to check the endpoint to see if disableStreamCaching is set prior to consuming the entity in the finally block, perhaps something like this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    ...
    } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (httpResponse != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; !getEndpoint().isDisableStreamCache()) {
                &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                    EntityUtils.consume(httpResponse.getEntity());
                } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
                    &lt;span class=&quot;code-comment&quot;&gt;// nothing we could &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt;
&lt;/span&gt;                }
            }
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12953848">CAMEL-9768</key>
            <summary>HTTP[4] component disableStreamCache issue: java.io.IOException: Attempted read from closed stream.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="erwelch">Edward Welch</reporter>
                        <labels>
                    </labels>
                <created>Sun, 27 Mar 2016 14:33:06 +0000</created>
                <updated>Thu, 7 Apr 2016 08:43:28 +0000</updated>
                            <resolved>Thu, 7 Apr 2016 08:43:28 +0000</resolved>
                                    <version>2.17.0</version>
                                    <fixVersion>2.17.1</fixVersion>
                    <fixVersion>2.18.0</fixVersion>
                                    <component>camel-http4</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15217779" author="davsclaus" created="Wed, 30 Mar 2016 10:35:43 +0000"  >&lt;p&gt;Thanks yeah that sounds like a real fix. &lt;/p&gt;

&lt;p&gt;Can you provide a patch or PR for this?&lt;/p&gt;</comment>
                            <comment id="15218352" author="erwelch" created="Wed, 30 Mar 2016 17:18:52 +0000"  >&lt;p&gt;I&apos;ve not done a PR before but willing to give it a try!&lt;/p&gt;</comment>
                            <comment id="15227751" author="davsclaus" created="Wed, 6 Apr 2016 05:26:46 +0000"  >&lt;p&gt;How is it going?&lt;/p&gt;</comment>
                            <comment id="15228137" author="githubbot" created="Wed, 6 Apr 2016 11:37:42 +0000"  >&lt;p&gt;GitHub user erwelch opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/932&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/932&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-9768&quot; title=&quot;HTTP[4] component disableStreamCache issue: java.io.IOException: Attempted read from closed stream.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-9768&quot;&gt;&lt;del&gt;CAMEL-9768&lt;/del&gt;&lt;/a&gt; HTTP&lt;span class=&quot;error&quot;&gt;&amp;#91;4&amp;#93;&lt;/span&gt; component disableStreamCache issue&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/erwelch/camel&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/erwelch/camel&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-9768&quot; title=&quot;HTTP[4] component disableStreamCache issue: java.io.IOException: Attempted read from closed stream.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-9768&quot;&gt;&lt;del&gt;CAMEL-9768&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/932.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/932.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #932&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 37fcca3e88940e5d07122b4d63f5837ba8ca0f17&lt;br/&gt;
Author: Edward Welch &amp;lt;ed@edjusted.com&amp;gt;&lt;br/&gt;
Date:   2016-04-06T11:35:10Z&lt;/p&gt;

&lt;p&gt;    Check to see if disableStreamCache is enabled before consuming the httpResponse entity&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15229924" author="githubbot" created="Thu, 7 Apr 2016 08:43:08 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/932&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/932&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15229926" author="davsclaus" created="Thu, 7 Apr 2016 08:43:28 +0000"  >&lt;p&gt;Thanks. I added a so the stream is closed later so we cleanup nicely.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10061"><![CDATA[Novice]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 32 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2v9nj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>