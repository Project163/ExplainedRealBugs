<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:50:29 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-4959] Incorrect caching type converter misses for NaN</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-4959</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;When converting Double or Float with value NaN, org.apache.camel.converter.ObjectConverter returns &quot;null&quot;. But org.apache.camel.impl.converter.BaseTypeConverterRegistry.doConvertTo(Class, Exchange, Object) interpret this &quot;null&quot; as &quot;suitable conversion not found&quot; and cache misses. This lead to completely forgetting of conversion for given types.&lt;br/&gt;
For example, when conversing Double to Long, all works until Double is NaN. After that, conversion for &quot;Double-to-Long&quot; marked as misses. And  camel stop do any conversion for Double-to-Long until restart.&lt;/p&gt;

&lt;p&gt;Possible solution is to modify ObjectConverter`s methods to return &quot;Void.TYPE&quot; instead of &quot;null&quot; for NaN.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12540504">CAMEL-4959</key>
            <summary>Incorrect caching type converter misses for NaN</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="ciand7">Andrey Utkin</reporter>
                        <labels>
                    </labels>
                <created>Tue, 31 Jan 2012 07:06:19 +0000</created>
                <updated>Tue, 28 Feb 2012 11:43:59 +0000</updated>
                            <resolved>Thu, 23 Feb 2012 12:47:32 +0000</resolved>
                                    <version>2.8.3</version>
                                    <fixVersion>2.8.5</fixVersion>
                    <fixVersion>2.9.1</fixVersion>
                    <fixVersion>2.10.0</fixVersion>
                                    <component>camel-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="13196780" author="davsclaus" created="Tue, 31 Jan 2012 08:23:14 +0000"  >&lt;p&gt;That is correct. Andrey can you provide a patch with unit test that test this fix?&lt;/p&gt;</comment>
                            <comment id="13196819" author="ciand7" created="Tue, 31 Jan 2012 09:43:34 +0000"  >&lt;p&gt;Hi, Claus. &lt;br/&gt;
Yes, I can try to make patch with unit test for ObjectConverter.&lt;/p&gt;

&lt;p&gt;But suggested solution - return Void.TYPE from toXXXX() methods of ObjectConverter - is not correct &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; ObjectConverter is converter, so that methods must declare return type correctly - Short, Long, Integer. It is not possible to return Void from toXXXX()...&lt;/p&gt;

&lt;p&gt;May be it is correct to return 0 for NaN? &lt;br/&gt;
At least JDK do it:&lt;br/&gt;
==&lt;br/&gt;
Double d = Double.NaN;&lt;br/&gt;
Float f = Float.NaN;&lt;br/&gt;
System.out.println(d.longValue() + &quot;, &quot; + f.shortValue());&lt;br/&gt;
==&lt;br/&gt;
will print &lt;br/&gt;
&quot;0, 0&quot;&lt;/p&gt;
</comment>
                            <comment id="13198647" author="davsclaus" created="Thu, 2 Feb 2012 10:00:02 +0000"  >&lt;p&gt;Yeah lets return 0 for the primitive types.&lt;/p&gt;

&lt;p&gt;Patches is welcome, with unit tests.&lt;/p&gt;</comment>
                            <comment id="13216731" author="bvahdat" created="Sun, 26 Feb 2012 13:01:52 +0000"  >&lt;p&gt;I did &quot;Refactor to Method&quot; for the case if the to be converted value is NaN:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1293828&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1293828&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13217530" author="bvahdat" created="Mon, 27 Feb 2012 20:31:39 +0000"  >&lt;p&gt;IMHO the changes introduced by of this ticket causes regression failure. To avoid null values being misinterpreted as cache misses we do now convert e.g.&lt;/p&gt;

&lt;p&gt;Float.NaN =&amp;gt; (Byte) 0&lt;/p&gt;

&lt;p&gt;which was not the case before.&lt;/p&gt;

&lt;p&gt;Why not just simply &lt;b&gt;not&lt;/b&gt; mark the conversion as miss &lt;b&gt;if&lt;/b&gt; the conversion result is (Float.NaN / Double.NaN  ==&amp;gt; null). That&apos;s do &lt;b&gt;not&lt;/b&gt; add any entry for such conversion results into the misses cache and revert back ObjectConverter to what it was before. Does this make sense to you?&lt;/p&gt;

&lt;p&gt;And I simply don&apos;t get why the misses cache is a ConcurrentMap:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; 
&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ConcurrentMap&amp;lt;TypeMapping, TypeMapping&amp;gt; misses = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ConcurrentHashMap&amp;lt;TypeMapping, TypeMapping&amp;gt;();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 

&lt;p&gt;To my understanding&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; 
&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; List&amp;lt;TypeMapping&amp;gt; misses = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CopyOnWriteArrayList&amp;lt;TypeMapping&amp;gt;();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 

&lt;p&gt;would be just fine! Why do we need a Map to memorize the cache misses? Where we then do things like&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; 
misses.put(key, key);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;On it which is not really intuitive while reading the code, is this maybe because ideally we want to do lookup by the misses cache (misses.containsKey()) in O(1) instead of O(N)? &lt;/p&gt;

&lt;p&gt;See also:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://camel.465427.n5.nabble.com/ObjectConverter-problem-td5517376.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://camel.465427.n5.nabble.com/ObjectConverter-problem-td5517376.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13218078" author="davsclaus" created="Tue, 28 Feb 2012 11:36:37 +0000"  >&lt;p&gt;Yeah I have corrected the coverters to deal with NaN.&lt;/p&gt;

&lt;p&gt;And yes we need to lookup fast in type converter registry as its used a lot in Camel, and it should be as fast as possible, as it can become a bottleneck.&lt;/p&gt;</comment>
                            <comment id="13218079" author="bvahdat" created="Tue, 28 Feb 2012 11:43:59 +0000"  >&lt;p&gt;Yeah dealing with NaN&apos;s directly in BaseTypeConverterRegistry itself was what I was looking for, Thanks!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10061"><![CDATA[Novice]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>225917</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 39 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0244n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>10270</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>