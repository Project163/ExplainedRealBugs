<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 11:06:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-20938] camel-http - Using disableStreamCache=true cannot read body later due to stream closed</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-20938</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;Reported in mailing list.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2024-07-03 08:47:26.061  WARN 30864 --- [ - timer:&lt;span class=&quot;code-comment&quot;&gt;//test] ache.camel.component.timer.TimerConsumer : Error processing exchange. Exchange[8164CC526FF834E-0000000000000000]. Caused by: [org.apache.camel.TypeConversionException - Error during type conversion from type: org.apache.hc.client5.http.entity.LazyDecompressingInputStream to the required type: java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; with value org.apache.hc.client5.http.entity.LazyDecompressingInputStream@6f9df776 due to java.io.IOException: Attempted read on closed stream.]
&lt;/span&gt;org.apache.camel.TypeConversionException: Error during type conversion from type: org.apache.hc.client5.http.entity.LazyDecompressingInputStream to the required type: java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; with value org.apache.hc.client5.http.entity.LazyDecompressingInputStream@6f9df776 due to java.io.IOException: Attempted read on closed stream.
	at org.apache.camel.converter.CamelBaseBulkConverterLoader.convertTo(CamelBaseBulkConverterLoader.java:65) ~[camel-base-4.7.0-SNAPSHOT.jar:4.7.0-SNAPSHOT]
	at org.apache.camel.spi.BulkTypeConverters.convertTo(BulkTypeConverters.java:122) ~[camel-api-4.7.0-SNAPSHOT.jar:4.7.0-SNAPSHOT]
	at org.apache.camel.impl.converter.CoreTypeConverterRegistry.tryCachedConverters(CoreTypeConverterRegistry.java:416) ~[camel-base-4.7.0-SNAPSHOT.jar:4.7.0-SNAPSHOT]
	at org.apache.camel.impl.converter.CoreTypeConverterRegistry.doConvertTo(CoreTypeConverterRegistry.java:375) ~[camel-base-4.7.0-SNAPSHOT.jar:4.7.0-SNAPSHOT]
	at org.apache.camel.impl.converter.CoreTypeConverterRegistry.doConvertToAndStat(CoreTypeConverterRegistry.java:269) ~[camel-base-4.7.0-SNAPSHOT.jar:4.7.0-SNAPSHOT]
	at org.apache.camel.impl.converter.CoreTypeConverterRegistry.convertTo(CoreTypeConverterRegistry.java:164) ~[camel-base-4.7.0-SNAPSHOT.jar:4.7.0-SNAPSHOT]
	at org.apache.camel.support.ExpressionAdapter.evaluate(ExpressionAdapter.java:52) ~[camel-support-4.7.0-SNAPSHOT.jar:4.7.0-SNAPSHOT]
	at org.apache.camel.support.builder.ExpressionBuilder$62.evaluate(ExpressionBuilder.java:2105) ~[camel-support-4.7.0-SNAPSHOT.jar:4.7.0-SNAPSHOT]
	at org.apache.camel.support.ExpressionAdapter.evaluate(ExpressionAdapter.java:45) ~[camel-support-4.7.0-SNAPSHOT.jar:4.7.0-SNAPSHOT]
	at org.apache.camel.processor.LogProcessor.process(LogProcessor.java:71) ~[camel-core-processor-4.7.0-SNAPSHOT.jar:4.7.0-SNAPSHOT]
	at org.apache.camel.processor.errorhandler.RedeliveryErrorHandler$SimpleTask.handleFirst(RedeliveryErrorHandler.java:440) ~[camel-core-processor-4.7.0-SNAPSHOT.jar:4.7.0-SNAPSHOT]
	at org.apache.camel.processor.errorhandler.RedeliveryErrorHandler$SimpleTask.run(RedeliveryErrorHandler.java:416) ~[camel-core-processor-4.7.0-SNAPSHOT.jar:4.7.0-SNAPSHOT]
	at org.apache.camel.impl.engine.DefaultReactiveExecutor$Worker.doRun(DefaultReactiveExecutor.java:199) [camel-base-engine-4.7.0-SNAPSHOT.jar:4.7.0-SNAPSHOT]
	at org.apache.camel.impl.engine.DefaultReactiveExecutor$Worker.executeReactiveWork(DefaultReactiveExecutor.java:189) [camel-base-engine-4.7.0-SNAPSHOT.jar:4.7.0-SNAPSHOT]
	at org.apache.camel.impl.engine.DefaultReactiveExecutor$Worker.tryExecuteReactiveWork(DefaultReactiveExecutor.java:166) [camel-base-engine-4.7.0-SNAPSHOT.jar:4.7.0-SNAPSHOT]
	at org.apache.camel.impl.engine.DefaultReactiveExecutor$Worker.schedule(DefaultReactiveExecutor.java:148) [camel-base-engine-4.7.0-SNAPSHOT.jar:4.7.0-SNAPSHOT]
	at org.apache.camel.impl.engine.DefaultReactiveExecutor.scheduleMain(DefaultReactiveExecutor.java:59) [camel-base-engine-4.7.0-SNAPSHOT.jar:4.7.0-SNAPSHOT]
	at org.apache.camel.processor.Pipeline.process(Pipeline.java:163) [camel-core-processor-4.7.0-SNAPSHOT.jar:4.7.0-SNAPSHOT]
	at org.apache.camel.impl.engine.CamelInternalProcessor.processNonTransacted(CamelInternalProcessor.java:346) [camel-base-engine-4.7.0-SNAPSHOT.jar:4.7.0-SNAPSHOT]
	at org.apache.camel.impl.engine.CamelInternalProcessor.process(CamelInternalProcessor.java:322) [camel-base-engine-4.7.0-SNAPSHOT.jar:4.7.0-SNAPSHOT]
	at org.apache.camel.component.timer.TimerConsumer.sendTimerExchange(TimerConsumer.java:293) [camel-timer-4.7.0-SNAPSHOT.jar:4.7.0-SNAPSHOT]
	at org.apache.camel.component.timer.TimerConsumer$1.doRun(TimerConsumer.java:164) [camel-timer-4.7.0-SNAPSHOT.jar:4.7.0-SNAPSHOT]
	at org.apache.camel.component.timer.TimerConsumer$1.run(TimerConsumer.java:136) [camel-timer-4.7.0-SNAPSHOT.jar:4.7.0-SNAPSHOT]
	at java.base/java.util.TimerThread.mainLoop(Timer.java:566) [?:?]
	at java.base/java.util.TimerThread.run(Timer.java:516) [?:?]
Caused by: java.io.IOException: Attempted read on closed stream.
	at org.apache.hc.core5.http.io.EofSensorInputStream.isReadAllowed(EofSensorInputStream.java:107) ~[httpcore5-5.2.4.jar:5.2.4]
	at org.apache.hc.core5.http.io.EofSensorInputStream.read(EofSensorInputStream.java:116) ~[httpcore5-5.2.4.jar:5.2.4]
	at java.base/java.util.zip.CheckedInputStream.read(CheckedInputStream.java:59) ~[?:?]
	at java.base/java.util.zip.GZIPInputStream.readUByte(GZIPInputStream.java:266) ~[?:?]
	at java.base/java.util.zip.GZIPInputStream.readUShort(GZIPInputStream.java:258) ~[?:?]
	at java.base/java.util.zip.GZIPInputStream.readHeader(GZIPInputStream.java:164) ~[?:?]
	at java.base/java.util.zip.GZIPInputStream.&amp;lt;init&amp;gt;(GZIPInputStream.java:79) ~[?:?]
	at java.base/java.util.zip.GZIPInputStream.&amp;lt;init&amp;gt;(GZIPInputStream.java:91) ~[?:?]
	at org.apache.hc.client5.http.entity.GZIPInputStreamFactory.create(GZIPInputStreamFactory.java:61) ~[httpclient5-5.2.1.jar:5.2.1]
	at org.apache.hc.client5.http.entity.LazyDecompressingInputStream.initWrapper(LazyDecompressingInputStream.java:51) ~[httpclient5-5.2.1.jar:5.2.1]
	at org.apache.hc.client5.http.entity.LazyDecompressingInputStream.read(LazyDecompressingInputStream.java:69) ~[httpclient5-5.2.1.jar:5.2.1]
	at java.base/sun.nio.cs.StreamDecoder.readBytes(StreamDecoder.java:270) ~[?:?]
	at java.base/sun.nio.cs.StreamDecoder.implRead(StreamDecoder.java:313) ~[?:?]
	at java.base/sun.nio.cs.StreamDecoder.read(StreamDecoder.java:188) ~[?:?]
	at java.base/java.io.InputStreamReader.read(InputStreamReader.java:177) ~[?:?]
	at java.base/java.io.BufferedReader.fill(BufferedReader.java:162) ~[?:?]
	at java.base/java.io.BufferedReader.read1(BufferedReader.java:213) ~[?:?]
	at java.base/java.io.BufferedReader.read(BufferedReader.java:287) ~[?:?]
	at java.base/java.io.Reader.read(Reader.java:250) ~[?:?]
	at org.apache.camel.util.IOHelper.toString(IOHelper.java:144) ~[camel-util-4.7.0-SNAPSHOT.jar:4.7.0-SNAPSHOT]
	at org.apache.camel.util.IOHelper.toString(IOHelper.java:128) ~[camel-util-4.7.0-SNAPSHOT.jar:4.7.0-SNAPSHOT]
	at org.apache.camel.util.IOHelper.toString(IOHelper.java:124) ~[camel-util-4.7.0-SNAPSHOT.jar:4.7.0-SNAPSHOT]
	at org.apache.camel.converter.IOConverter.toString(IOConverter.java:186) ~[camel-base-4.7.0-SNAPSHOT.jar:4.7.0-SNAPSHOT]
	at org.apache.camel.converter.IOConverter.toString(IOConverter.java:201) ~[camel-base-4.7.0-SNAPSHOT.jar:4.7.0-SNAPSHOT]
	at org.apache.camel.converter.CamelBaseBulkConverterLoader.doConvertTo(CamelBaseBulkConverterLoader.java:345) ~[camel-base-4.7.0-SNAPSHOT.jar:4.7.0-SNAPSHOT]
	at org.apache.camel.converter.CamelBaseBulkConverterLoader.convertTo(CamelBaseBulkConverterLoader.java:56) ~[camel-base-4.7.0-SNAPSHOT.jar:4.7.0-SNAPSHOT]
	... 24 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When running&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.camel.Exchange;

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;HttpBug &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; org.apache.camel.builder.RouteBuilder {

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void configure() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        getContext().getTypeConverterRegistry();

        &lt;span class=&quot;code-comment&quot;&gt;//@formatter:off
&lt;/span&gt;        from(&lt;span class=&quot;code-quote&quot;&gt;&quot;timer:test?repeatCount=1&quot;&lt;/span&gt;)
            .setHeader(Exchange.HTTP_METHOD, constant(&lt;span class=&quot;code-quote&quot;&gt;&quot;GET&quot;&lt;/span&gt;))
            .setHeader(Exchange.HTTP_URI, constant(&lt;span class=&quot;code-quote&quot;&gt;&quot;https:&lt;span class=&quot;code-comment&quot;&gt;//camel.apache.org/components/4.4.x/http-component.html&quot;&lt;/span&gt;))
&lt;/span&gt;            .to(&lt;span class=&quot;code-quote&quot;&gt;&quot;http:myHttpRequest?disableStreamCache=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;)
            .log(&lt;span class=&quot;code-quote&quot;&gt;&quot;body : ${body}&quot;&lt;/span&gt;)
        .end();
        &lt;span class=&quot;code-comment&quot;&gt;//@formatter:on
&lt;/span&gt;    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13584582">CAMEL-20938</key>
            <summary>camel-http - Using disableStreamCache=true cannot read body later due to stream closed</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="davsclaus">Claus Ibsen</reporter>
                        <labels>
                    </labels>
                <created>Wed, 3 Jul 2024 06:53:59 +0000</created>
                <updated>Wed, 21 Aug 2024 11:32:38 +0000</updated>
                            <resolved>Wed, 21 Aug 2024 11:32:38 +0000</resolved>
                                                    <fixVersion>4.4.4</fixVersion>
                    <fixVersion>4.8.0</fixVersion>
                                    <component>camel-http</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17868939" author="JIRAUSER306348" created="Fri, 26 Jul 2024 12:51:53 +0000"  >&lt;p&gt;Hello,&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I tested the fix in Camel version 4.7.0, and I believe it doesn&#8217;t fully address the issue. While the error is no longer thrown, we still don&#8217;t receive a proper stream object when using the &#8220;disableStreamCache&#8221; option. Instead, the entire response is loaded into the Java heap, which is problematic for us when dealing with large API responses (exceeding 1 GB in size).&lt;/p&gt;

&lt;p&gt;Upon reviewing the code you committed for the fix, it appears that when Camel is in streaming mode, it consumes the stream and copies it into a byte array.&lt;/p&gt;

&lt;p&gt;I&#8217;ve included some screenshots from Visual VM for the same routes you provided to reproduce the issue. The only difference is that I&#8217;m not requesting a website like Camel docs; instead, I&#8217;m using an API with substantial response data (which I can&#8217;t share, but I can generate a similar-sized JSON if needed).&lt;/p&gt;

&lt;p&gt;In the first screenshot, you can see the byte array built by Camel. As you&#8217;ll notice, the current size matches my data size:&lt;/p&gt;

&lt;p&gt;&#160;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13070501/13070501_image-2024-07-26-14-34-59-635.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;In this second screenshot, I share the data inside the body&#8217;s exchange just before the .log(&quot;${body}&quot;). We found our byte array: &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13070502/13070502_image-2024-07-26-14-36-27-046.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Finally, I want to show you the heap of my small app:&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13070503/13070503_image-2024-07-26-14-36-58-094.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Maybe I&#8217;m doing something wrong, but as it&#8217;s written in the Camel HTTP component documentation: &quot;If setting this option to true, then the producers will not cache the response body stream but use the response stream as-is as the message body.&quot; I expected to get the stream in my body to consume it myself.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Best regards,&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17875415" author="davsclaus" created="Wed, 21 Aug 2024 09:14:10 +0000"  >&lt;p&gt;You cannot work with the input stream from http-client directly as it auto closes the stream asap, so any attempt from camel to read the content will causes a failure&lt;/p&gt;

&lt;p&gt;org.apache.hc.core5.http.io.entity.EntityUtils#consume&lt;/p&gt;</comment>
                            <comment id="17875435" author="davsclaus" created="Wed, 21 Aug 2024 10:08:37 +0000"  >&lt;p&gt;Okay I found a special executeOpen method in the http client we may be able to use&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13070501" name="image-2024-07-26-14-34-59-635.png" size="80866" author="ryanikhlef" created="Fri, 26 Jul 2024 12:34:59 +0000"/>
                            <attachment id="13070502" name="image-2024-07-26-14-36-27-046.png" size="64630" author="ryanikhlef" created="Fri, 26 Jul 2024 12:36:27 +0000"/>
                            <attachment id="13070503" name="image-2024-07-26-14-36-58-094.png" size="21060" author="ryanikhlef" created="Fri, 26 Jul 2024 12:36:58 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 12 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1q4pk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>