<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 11:06:18 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-20841] DataSonnet expressions are removed under memory load</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-20841</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;&lt;b&gt;Scenario:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;When there is a Camel/Spring Boot API project where there are a large amount of DataSonnet (DS) scripts&lt;br/&gt;
And when the application is under memory load or runs for a long time, some or ALL DS scripts are removed from the mapperCache&lt;br/&gt;
And once they are removed from the mapperCache, then a call to an API endpoint that contains that DS script will be unable to be evaluated and the API call will continue to fail because the expression isn&apos;t re-added to the mapperCache&lt;/p&gt;

&lt;p&gt;&lt;b&gt;What I expect to happen instead:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;The API is able to recover and re-add missing DS scripts.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;The error returned is:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Caused by: java.lang.IllegalStateException: Datasonnet expression not initialized at org.apache.camel.language.datasonnet.DatasonnetExpression.lambda$doEvaluate$0(DatasonnetExpression.java:138) at java.base/java.util.Optional.orElseThrow(Optional.java:403) at org.apache.camel.language.datasonnet.DatasonnetExpression.doEvaluate(DatasonnetExpression.java:138) at org.apache.camel.language.datasonnet.DatasonnetExpression.evaluate(DatasonnetExpression.java:92)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;br/&gt;
From what I can tell, Camel 3.7 didn&apos;t have this issue. It looks like the DS scripts have been stored in an LRUSoftCache for a long time and is designed this way so that expressions are removed to prevent OutOfMemoryError. However, in Camel 4 the mapper became pre-initialized and .lookup() was used instead of .computeIfMiss().&lt;br/&gt;
Camel 3.7: &lt;a href=&quot;https://github.com/apache/camel/blob/camel-3.7.x/components/camel-datasonnet/src/main/java/org/apache/camel/language/datasonnet/DatasonnetExpression.java#L143&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/blob/camel-3.7.x/components/camel-datasonnet/src/main/java/org/apache/camel/language/datasonnet/DatasonnetExpression.java#L143&lt;/a&gt;&lt;br/&gt;
Camel 4: &lt;a href=&quot;https://github.com/apache/camel/blob/main/components/camel-datasonnet/src/main/java/org/apache/camel/language/datasonnet/DatasonnetExpression.java#L137&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/blob/main/components/camel-datasonnet/src/main/java/org/apache/camel/language/datasonnet/DatasonnetExpression.java#L137&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Project that replicates this error:&lt;/b&gt; &lt;a href=&quot;https://github.com/rlratcliffe/replicate-ds-error&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/rlratcliffe/replicate-ds-error&lt;/a&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13581698">CAMEL-20841</key>
            <summary>DataSonnet expressions are removed under memory load</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="rlratcliffe">Rob Ratcliffe</reporter>
                        <labels>
                    </labels>
                <created>Wed, 5 Jun 2024 18:12:20 +0000</created>
                <updated>Fri, 28 Jun 2024 22:04:36 +0000</updated>
                            <resolved>Fri, 7 Jun 2024 04:39:05 +0000</resolved>
                                    <version>4.0-M1</version>
                    <version>4.6.0</version>
                                    <fixVersion>4.4.3</fixVersion>
                    <fixVersion>4.7.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17856617" author="JIRAUSER281980" created="Thu, 20 Jun 2024 21:52:12 +0000"  >&lt;p&gt;Is there any workaround for this? We are running into this very often, not only with Springboot, but Quarkus too,&lt;/p&gt;</comment>
                            <comment id="17860893" author="JIRAUSER305716" created="Fri, 28 Jun 2024 22:04:36 +0000"  >&lt;p&gt;I&apos;m not sure about a workaround, but camel-datasonnet 4.4.3 includes this fix and was released yesterday, if that helps.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 19 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1pmy0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>