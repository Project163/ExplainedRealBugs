<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 11:13:10 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-22648] [camel-opentelemetry2] don&apos;t propagate headers when creating a new trace</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-22648</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;Originally reported in &lt;a href=&quot;https://github.com/apache/camel-quarkus/issues/7801&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel-quarkus/issues/7801&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;We&apos;re missing to propagate traceparent header when we start a new trace.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13633175">CAMEL-22648</key>
            <summary>[camel-opentelemetry2] don&apos;t propagate headers when creating a new trace</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="8">Not A Problem</resolution>
                                        <assignee username="squakez">Pasquale Congiusti</assignee>
                                    <reporter username="squakez">Pasquale Congiusti</reporter>
                        <labels>
                    </labels>
                <created>Mon, 3 Nov 2025 12:01:11 +0000</created>
                <updated>Fri, 7 Nov 2025 10:49:06 +0000</updated>
                            <resolved>Fri, 7 Nov 2025 10:49:06 +0000</resolved>
                                                    <fixVersion>4.17.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="18035891" author="squakez" created="Thu, 6 Nov 2025 16:21:06 +0000"  >&lt;p&gt;The problem is not Camel. The design is consistent. The problem is that the upstream libraries are missing to propagate the traceparent, assuming that the downstream usage is going to use the thread local context propagation. This was the reason why we have changed model, as such model could not work when async calls. Now, I&apos;ve located the place where this is happening (at least in log):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[1b3bd06b5cf442fcbe2ff83a1252b740 9d07dfe868abe5c0] 2025-11-06 17:08:26.799 TRACE 1058802 --- [ntloop-thread-0] io.vertx.ext.web.impl.RouterImpl         : Router: 1094278250 accepting request GET http:&lt;span class=&quot;code-comment&quot;&gt;//localhost:8080/bar
&lt;/span&gt;[1b3bd06b5cf442fcbe2ff83a1252b740 9d07dfe868abe5c0] 2025-11-06 17:08:26.810 TRACE 1058802 --- [ntloop-thread-0] io.vertx.ext.web.RoutingContext          : Route matches: RouteState{metadata=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, path=&lt;span class=&quot;code-quote&quot;&gt;&apos;/&apos;&lt;/span&gt;, name=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, order=1, enabled=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, methods=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, consumes=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, emptyBodyPermittedWithConsumes=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, produces=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, contextHandlers=[io.opentelemetry.javaagent.instrumentation.vertx.RoutingContextHandlerWrapper@317a6446], failureHandlers=[io.vertx.ext.web.impl.RouteImpl$$Lambda$843/0x00000008016f3530@5d839d88], added=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, pattern=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, groups=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, useNormalizedPath=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, namedGroupsInRegex=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, virtualHostPattern=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, pathEndsWithSlash=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, exclusive=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, exactPath=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;}
[1b3bd06b5cf442fcbe2ff83a1252b740 9d07dfe868abe5c0] 2025-11-06 17:08:26.810 TRACE 1058802 --- [ntloop-thread-0] io.vertx.ext.web.RoutingContext          : Calling the  handler
[1b3bd06b5cf442fcbe2ff83a1252b740 9d07dfe868abe5c0] 2025-11-06 17:08:26.815 TRACE 1058802 --- [ntloop-thread-0] io.vertx.ext.web.RoutingContext          : Route matches: RouteState{metadata=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, path=&lt;span class=&quot;code-quote&quot;&gt;&apos;/bar&apos;&lt;/span&gt;, name=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, order=6, enabled=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, methods=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, consumes=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, emptyBodyPermittedWithConsumes=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, produces=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, contextHandlers=[io.opentelemetry.javaagent.instrumentation.vertx.RoutingContextHandlerWrapper@3b87cce7, io.opentelemetry.javaagent.instrumentation.vertx.RoutingContextHandlerWrapper@7d2cca67], failureHandlers=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, added=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, pattern=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, groups=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, useNormalizedPath=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, namedGroupsInRegex=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, virtualHostPattern=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, pathEndsWithSlash=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, exclusive=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, exactPath=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;}
[1b3bd06b5cf442fcbe2ff83a1252b740 9d07dfe868abe5c0] 2025-11-06 17:08:26.815 TRACE 1058802 --- [ntloop-thread-0] io.vertx.ext.web.RoutingContext          : Calling the  handler

Trace parent ... GET &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;

[4ba6d07f14a720f64b01ef789ef00436 3eb3d7ee8a8a0264] 2025-11-06 17:08:26.853 DEBUG 1058802 --- [worker-thread-0] org.apache.camel.telemetry.Tracer        : Started event span: OpenTelemetrySpanAdapter [span=ApplicationSpan{agentSpan=SdkSpan{traceId=4ba6d07f14a720f64b01ef789ef00436, spanId=3eb3d7ee8a8a0264, parentSpanContext=ImmutableSpanContext{traceId=00000000000000000000000000000000, spanId=0000000000000000, traceFlags=00, traceState=ArrayBasedTraceState{entries=[]}, remote=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, valid=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;}, name=GET, kind=INTERNAL, attributes=AttributesMap{data={camel.uri=platform-http:&lt;span class=&quot;code-comment&quot;&gt;///bar, op=EVENT_RECEIVED, thread.id=30, exchangeId=EBA8D1A0FAD1769-0000000000000001, server.address=http://0.0.0.0:8080, url.path=bar, component=camel-platform-http, server.protocol=http, http.method=GET, thread.name=vert.x-worker-thread-0, url.scheme=platform-http, http.url=http://localhost:8080/bar}, capacity=128, totalAddedValues=12}, status=ImmutableStatusData{statusCode=UNSET, description=}, totalRecordedEvents=0, totalRecordedLinks=0, startEpochNanos=1762445306849893418, endEpochNanos=0}}, baggage={}]
&lt;/span&gt;...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;As we can see in the MDC traces, the vertx libs are not propagating the generated traceparent in the downstream header, which is where we expect, as defined in the otel specification. I am checking the source code of vertx to understand if this is something configurable or fixable somehow.&lt;/p&gt;</comment>
                            <comment id="18035900" author="squakez" created="Thu, 6 Nov 2025 16:59:45 +0000"  >&lt;p&gt;Probably the problem is neither in the Vertx, but in the agent, which is the one in charge to instrument with opentelemetry the vertx code. We can possibly make some change in the code &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; in order to include the context propagation out of the box. However, as stated in previous comment, this has noting to do directly with Camel, but with the upstream dependencies.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/open-telemetry/opentelemetry-java-instrumentation/blob/03a11226fcc89e57057fd8077be9cf0826f21c50/instrumentation/vertx/vertx-web-3.0/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/vertx/RoutingContextHandlerWrapper.java#L31&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/open-telemetry/opentelemetry-java-instrumentation/blob/03a11226fcc89e57057fd8077be9cf0826f21c50/instrumentation/vertx/vertx-web-3.0/javaagent/src/main/java/io/opentelemetry/javaagent/instrumentation/vertx/RoutingContextHandlerWrapper.java#L31&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="18036201" author="squakez" created="Fri, 7 Nov 2025 10:48:52 +0000"  >&lt;p&gt;With PR &lt;a href=&quot;https://github.com/apache/camel/pull/19845&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/19845&lt;/a&gt; we&apos;re clarify the design of the component and adding a few more test to validate the consistency of the design. In parallel I&apos;m trying to add to the otel agent the capability to vertx to propagate context correctly. However, this is not a bug or feature on Camel side.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1yf9k:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>