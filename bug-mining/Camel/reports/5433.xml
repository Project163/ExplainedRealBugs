<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:43:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-15486] camel-test-spring - Mocking of Camel Endpoints breaks because adding 3rd party dependency with spring boot</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-15486</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;As soon you add the dependency&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&amp;lt;dependency&amp;gt;            
    &amp;lt;groupId&amp;gt;org.springframework.cloud&amp;lt;/groupId&amp;gt;            
    &amp;lt;artifactId&amp;gt;spring-cloud-contract-wiremock&amp;lt;/artifactId&amp;gt;               
    &amp;lt;version&amp;gt;2.2.3.RELEASE&amp;lt;/version&amp;gt;            
    &amp;lt;scope&amp;gt;test&amp;lt;/scope&amp;gt;        
&amp;lt;/dependency&amp;gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;to your project, the mocking of the endpoints breaks.&lt;/p&gt;

&lt;p&gt;I&apos;ve created a simple example to reproduce the issue:&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/erard22/spring-boot-camel-bug-demo&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/erard22/spring-boot-camel-bug-demo&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Component
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;SimpleCamelRoute &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; RouteBuilder {

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void configure() {

        from(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:processMessage&quot;&lt;/span&gt;)
                .to(&lt;span class=&quot;code-quote&quot;&gt;&quot;file:output&quot;&lt;/span&gt;);
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@CamelSpringBootTest
@SpringBootTest(classes = DemoApplication.class)
@ContextConfiguration
@DirtiesContext(classMode = DirtiesContext.ClassMode.AFTER_EACH_TEST_METHOD)
@MockEndpoints(&lt;span class=&quot;code-quote&quot;&gt;&quot;file:*&quot;&lt;/span&gt;)
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;SimpleCamelRouteTest {

    @Autowired
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; CamelContext camelContext;

    @Produce(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:processMessage&quot;&lt;/span&gt;)
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; ProducerTemplate producer;

    @EndpointInject(&lt;span class=&quot;code-quote&quot;&gt;&quot;mock:&lt;span class=&quot;code-comment&quot;&gt;//file:output&quot;&lt;/span&gt;)
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; MockEndpoint mockCamel;

    @Test
    void processMessage_successful() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        mockCamel.expectedBodiesReceived(&lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt;);
        producer.sendBodyAndHeaders(&lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt;, Collections.emptyMap());
        mockCamel.assertIsSatisfied();
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.AssertionError: mock:&lt;span class=&quot;code-comment&quot;&gt;//file:output Received message count. Expected: &amp;lt;1&amp;gt; but was: &amp;lt;0&amp;gt;
&lt;/span&gt;Expected :&amp;lt;1&amp;gt;
Actual   :&amp;lt;0&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13325312">CAMEL-15486</key>
            <summary>camel-test-spring - Mocking of Camel Endpoints breaks because adding 3rd party dependency with spring boot</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="erard22">Michel Erard</reporter>
                        <labels>
                    </labels>
                <created>Mon, 31 Aug 2020 09:41:48 +0000</created>
                <updated>Wed, 3 Sep 2025 11:30:17 +0000</updated>
                            <resolved>Thu, 10 Sep 2020 08:45:54 +0000</resolved>
                                    <version>3.4.3</version>
                                    <fixVersion>3.6.0</fixVersion>
                                    <component>camel-test</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17187624" author="davsclaus" created="Mon, 31 Aug 2020 10:17:19 +0000"  >&lt;p&gt;Try without that dirties context and otherwise thinker with the test. And what does that spring dependency do, maybe it does something that causes the restart to fail and in line of this camel too&lt;/p&gt;</comment>
                            <comment id="17187641" author="erard22" created="Mon, 31 Aug 2020 10:59:50 +0000"  >&lt;p&gt;Indeed, the line &lt;tt&gt;Starting CamelContext with name &lt;span class=&quot;error&quot;&gt;&amp;#91;camelContext&amp;#93;&lt;/span&gt;&lt;/tt&gt;&#160;is missing in the output. I&apos;ll have a closer look.&lt;/p&gt;</comment>
                            <comment id="17191657" author="erard22" created="Mon, 7 Sep 2020 11:48:07 +0000"  >&lt;p&gt;So, found out what the problem is.&lt;/p&gt;

&lt;p&gt;The Wiremock dependency has the class &lt;tt&gt;WireMockTestExecutionListener&lt;/tt&gt; that does load the application context in the&#160;&lt;tt&gt;TestExecutionListener#beforeTestClass&lt;/tt&gt; method that is executed earlier than the method&#160;&lt;tt&gt;CamelSpringBootExecutionListener#prepareTestInstance()&lt;/tt&gt;. Means when this code is executed the camel context is already started:&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// we are customizing the Camel context with
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// CamelAnnotationsHandler so we &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; not want to start it
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// automatically, which would happen when SpringCamelContext
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// is added to Spring ApplicationContext, so we set the flag
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// not to start it just yet
&lt;/span&gt;SpringCamelContext.setNoStart(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.setProperty(&lt;span class=&quot;code-quote&quot;&gt;&quot;skipStartingCamelContext&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I see two solutions:&#160;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Implement&#160;{{beforeTestClass }}as well and move this code there&lt;/li&gt;
	&lt;li&gt;Check if the context is already started and stop it in that case.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17191838" author="davsclaus" created="Mon, 7 Sep 2020 18:45:22 +0000"  >&lt;p&gt;You are welcome to work on #1 and provide a PR against master branch, thanks.&lt;/p&gt;</comment>
                            <comment id="17192716" author="erard22" created="Wed, 9 Sep 2020 08:03:41 +0000"  >&lt;p&gt;will do&lt;/p&gt;</comment>
                            <comment id="17193471" author="davsclaus" created="Thu, 10 Sep 2020 08:46:10 +0000"  >&lt;p&gt;Thanks Michael for the reporting and the PR&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 9 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0i7tk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>