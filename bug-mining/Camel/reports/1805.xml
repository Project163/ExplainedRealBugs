<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:50:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-5058] Bug: Unique Endpoints Leaking in DefaultInflightRepository</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-5058</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;If you have an endpoint protocol which uses unique URIs you will leak Strings in the HashMap stored in the DefaultInflightRepository (org.apache.camel.impl.DefaultInflightRepository)&lt;/p&gt;

&lt;p&gt;It seems there is a reference counting scheme in place, but it doesn&apos;t do a remove until the &quot;stop&quot; method is called to shut the system down.  We are running XMPP endpoints, which use a protocol like xmpp://someaccount@domain/password?to=someOtherAccount&lt;br/&gt;
When there are 10 million accounts, not all of which are active, but all of which may message at some time or another, no references are removed to the endpointCount.&lt;/p&gt;

&lt;p&gt;When the count becomes 0, the reference should be removed and the size method will still return the appropriate result.&lt;/p&gt;

&lt;p&gt;Please be careful in the implementation to synchronize on some object (perhaps the AtomicInteger) reflecting a read/write lock on the endpoint count modification.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12544960">CAMEL-5058</key>
            <summary>Bug: Unique Endpoints Leaking in DefaultInflightRepository</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="zilatica">Zach Calvert</reporter>
                        <labels>
                    </labels>
                <created>Fri, 2 Mar 2012 16:35:58 +0000</created>
                <updated>Thu, 8 Mar 2012 16:08:59 +0000</updated>
                            <resolved>Wed, 7 Mar 2012 22:19:45 +0000</resolved>
                                    <version>2.9.0</version>
                                    <fixVersion>2.9.2</fixVersion>
                    <fixVersion>2.10.0</fixVersion>
                                    <component>camel-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="86400">24h</timeoriginalestimate>
                            <timeestimate seconds="86400">24h</timeestimate>
                                        <comments>
                            <comment id="13221555" author="davsclaus" created="Sat, 3 Mar 2012 11:22:17 +0000"  >&lt;p&gt;The inflight registry should be route based instead of endpoint, as that is what the graceful shutdown really needs. &lt;br/&gt;
So instead of being endpoint based, we can switch to be route id, based instead.&lt;/p&gt;

&lt;p&gt;Can you post some more details about your use-case, I wonder why you get so many unique endpoints in the registry, as its consumer based. Are you adding a lot of new routes or the likes?&lt;/p&gt;</comment>
                            <comment id="13221623" author="davsclaus" created="Sat, 3 Mar 2012 16:10:42 +0000"  >&lt;p&gt;I have committed a fix that removes entries from the registry when removing a route.&lt;/p&gt;

&lt;p&gt;We need to keep it endpoint key based due producer template setup a UoW which essentially is a exchange created outside a route, and therefore we do not have a routeId at this given moment.&lt;/p&gt;</comment>
                            <comment id="13221644" author="bvahdat" created="Sat, 3 Mar 2012 17:04:39 +0000"  >&lt;p&gt;Just for the sake of not losing the revision history:&lt;/p&gt;

&lt;p&gt;trunk: &lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1296653&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1296653&lt;/a&gt;&lt;br/&gt;
2.9.x: &lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1296655&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=1296655&lt;/a&gt; &lt;/p&gt;</comment>
                            <comment id="13221814" author="davsclaus" created="Sun, 4 Mar 2012 07:12:37 +0000"  >&lt;p&gt;Ah I was 1000 numbers behind in the commit message &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13222358" author="zilatica" created="Mon, 5 Mar 2012 14:04:39 +0000"  >&lt;p&gt;We construct endpoints at runtime to send a message to the XMPP subsystem.  It isn&apos;t ideal, but it works for us.  With the memory leak, however, it has to be restarted once a week or so.&lt;/p&gt;

&lt;p&gt;Thanks for the fast fix!&lt;/p&gt;</comment>
                            <comment id="13222566" author="zilatica" created="Mon, 5 Mar 2012 20:00:33 +0000"  >&lt;p&gt;I&apos;m not quite sure this fixes our problem.  We aren&apos;t creating a true route.  We are using a ProducerTemplate to send a Message to an Endpoint, and the Endpoint is unique, created at runtime, and would essentially create a new entry in the ConcurrentHashMap stored in the DefaultInflightRepository.&lt;/p&gt;

&lt;p&gt;Ideally, when remove is called with an Exchange, if the reference count becomes 0, then the entry is removed from the Map.&lt;/p&gt;</comment>
                            <comment id="13223074" author="davsclaus" created="Tue, 6 Mar 2012 08:02:39 +0000"  >&lt;p&gt;Zach,&lt;/p&gt;

&lt;p&gt;Yes I suspected there was still a problem for you. But I didn&apos;t have a chance to ask how you send the messages. So just to be sure, you use a producer template to send to dynamic endpoint uris.&lt;/p&gt;</comment>
                            <comment id="13223140" author="davsclaus" created="Tue, 6 Mar 2012 10:24:55 +0000"  >&lt;p&gt;Notice ideally the inflight registry would just track for routes only. But the producer template uses an UoW as well for some reason we had to do a while ago. So it will also enlist itself in the inflight registry (well its in fact also an inflight message you may say).&lt;/p&gt;

&lt;p&gt;So we can either ensure to remove from the inflight map if it become zero as you suggest. This may require a bit of locking, as you need to remove and compare.&lt;/p&gt;

&lt;p&gt;Alternative, as the map, does not need to be removed in real time, we can have a background thread, doing the cleanup in a scheduled fashion.&lt;/p&gt;</comment>
                            <comment id="13223224" author="zilatica" created="Tue, 6 Mar 2012 13:03:44 +0000"  >&lt;p&gt;Claus, that is correct that I&apos;m using the producer template to send the messages.  I actually have a solution that I&apos;m currently testing, but I&apos;ve got to wait for our legal department to review the change to submit back to the community (we&apos;ve got a big process I have to follow).&lt;/p&gt;

&lt;p&gt;Hopefully I will be able to submit the patch, including a unit test, to validate the change.&lt;/p&gt;</comment>
                            <comment id="13223738" author="zilatica" created="Tue, 6 Mar 2012 22:25:14 +0000"  >&lt;p&gt;The diff to fix the leak.  Note the unit test runs 2,000,000 operations to validate the fix.  It runs in 1 second on my computer, so the bottleneck due to the synchronized is limited.&lt;/p&gt;</comment>
                            <comment id="13224071" author="davsclaus" created="Wed, 7 Mar 2012 07:26:17 +0000"  >&lt;p&gt;Zach thanks for the patch. Can you re-attach the patch and make sure the mark &lt;span class=&quot;error&quot;&gt;&amp;#91;x&amp;#93;&lt;/span&gt; in grant license to ASF in the file attachment wizard. We need this to be able to accept your patch.&lt;/p&gt;</comment>
                            <comment id="13224373" author="zilatica" created="Wed, 7 Mar 2012 14:39:22 +0000"  >&lt;p&gt;Re-attaching code with agreement to allow the Apache License&lt;/p&gt;</comment>
                            <comment id="13224374" author="zilatica" created="Wed, 7 Mar 2012 14:39:53 +0000"  >&lt;p&gt;Done&lt;/p&gt;</comment>
                            <comment id="13224784" author="davsclaus" created="Wed, 7 Mar 2012 22:19:45 +0000"  >&lt;p&gt;Thanks for the patch.&lt;/p&gt;</comment>
                            <comment id="13225120" author="bvahdat" created="Thu, 8 Mar 2012 10:14:00 +0000"  >&lt;p&gt;I did polish the provided unit-test a bit mostly because of the required visibility of the failed flag (volatile keyword).&lt;br/&gt;
Especially required while running tests on the multi-core boxes.&lt;/p&gt;</comment>
                            <comment id="13225201" author="zilatica" created="Thu, 8 Mar 2012 13:39:51 +0000"  >&lt;p&gt;Yea, my bad.  I remembered I had some cleanup to do on that hack-n-slash unit test last night.  Ugly, ugly unit test...&lt;/p&gt;


&lt;p&gt;Thanks for the cleanup Babak!&lt;/p&gt;</comment>
                            <comment id="13225277" author="davsclaus" created="Thu, 8 Mar 2012 16:08:59 +0000"  >&lt;p&gt;I improved this to avoid the synchronization in &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-5057&quot; title=&quot;A new stub component for easily unit testing with sending messages to/from an in-memory message queued endpoint&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-5057&quot;&gt;&lt;del&gt;CAMEL-5057&lt;/del&gt;&lt;/a&gt;. As well only to track in flight per routes, as per endpoint is not needed.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12517403" name="fixLeak.diff" size="6505" author="zilatica" created="Wed, 7 Mar 2012 14:39:21 +0000"/>
                            <attachment id="12517321" name="fixLeak.diff" size="6505" author="zilatica" created="Tue, 6 Mar 2012 22:25:14 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>230146</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 37 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i024qv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>10370</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>