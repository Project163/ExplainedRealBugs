<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:11:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-9143] Producers that implement the ServicePoolAware interface cause memory leak due to JMX references</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-9143</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;h4&gt;&lt;a name=&quot;Description&quot;&gt;&lt;/a&gt;Description&lt;/h4&gt;

&lt;p&gt;Producer instances that implement the ServicePoolAware interface will leak memory if their route is stopped, with new producers being leaked every time the route is started/stopped.&lt;/p&gt;

&lt;p&gt;Known implementations that are affected are RemoteFileProducer (ftp, sftp) and Mina2Producer.&lt;/p&gt;

&lt;p&gt;This is due to the behaviour that the SendProcessor which when the route is stopped it shuts down it&apos;s `producerCache` instance.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void doStop() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        ServiceHelper.stopServices(producerCache, producer);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;this in turn calls `stopAndShutdownService(pool)` which will call stop on the SharedProducerServicePool instance which is a NOOP however it also calls shutdown which effects a stop of the global pool (this stops all the registered services and then clears the pool.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void doStop() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        &lt;span class=&quot;code-comment&quot;&gt;// when stopping we intend to shutdown
&lt;/span&gt;        ServiceHelper.stopAndShutdownService(pool);
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            ServiceHelper.stopAndShutdownServices(producers.values());
        } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
            &lt;span class=&quot;code-comment&quot;&gt;// ensure producers are removed, and also from JMX
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Producer producer : producers.values()) {
                getCamelContext().removeService(producer);
            }
        }
        producers.clear();
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;However no call to `context.removeService(Producer) is called for the entries from the pool only those singleton instances that were in the `producers` map hence the JMX `ManagedProducer` that is created when `doGetProducer` invokes &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;                getCamelContext().addService(answer, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; is never removed. &lt;/p&gt;

&lt;p&gt;Since the global pool is empty when the next request to get a producer is called a new producer is created, jmx wrapper and all, whilst the old instance remains orphaned retaining any objects that pertain to that instance.&lt;/p&gt;

&lt;p&gt;One workaround is for the producer to call &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;getEndpoint().getCamelContext().removeService(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; in it&apos;s stop method, however this is fairly obscure and it would probably be better to invoke removal of the producer when it is removed from the shared pool.&lt;/p&gt;

&lt;p&gt;Another issue of note is that when a route is shutdown that contains a SendProcessor due to the shutdown invocation on the SharedProcessorServicePool the global pool is cleared of `everything` and remains in `Stopped` state until another route starts it (although it is still accessed and used whilst in the `Stopped` state).&lt;/p&gt;

&lt;h4&gt;&lt;a name=&quot;Impact&quot;&gt;&lt;/a&gt;Impact&lt;/h4&gt;

&lt;p&gt;For general use where there is no dynamic creation or passivation of routes this issue should be minimal, however in our use case where the routes are not static, there is a certain amount of recreation of routes as customer endpoints change and there is a need to passivate idle routes this causes a considerable memory leak (via SFTP in particular).&lt;/p&gt;

&lt;h4&gt;&lt;a name=&quot;TestCase&quot;&gt;&lt;/a&gt;Test Case&lt;/h4&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt; org.apache.camel.component;

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; com.google.common.util.concurrent.AtomicLongMap;

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.camel.CamelContext;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.camel.Consumer;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.camel.Endpoint;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.camel.Exchange;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.camel.Processor;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.camel.Producer;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.camel.Route;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.camel.Service;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.camel.ServicePoolAware;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.camel.ServiceStatus;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.camel.builder.RouteBuilder;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.camel.impl.DefaultComponent;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.camel.impl.DefaultEndpoint;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.camel.impl.DefaultProducer;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.camel.support.LifecycleStrategySupport;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.camel.support.ServiceSupport;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.camel.test.junit4.CamelTestSupport;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.junit.Test;

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.util.Map;

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; com.google.common.base.Preconditions.checkNotNull;

/**
 * Test memory behaviour of producers using {@link ServicePoolAware} when using JMX.
 */
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;ServicePoolAwareLeakyTest &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; CamelTestSupport {

  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; LEAKY_SIEVE_STABLE = &lt;span class=&quot;code-quote&quot;&gt;&quot;leaky:&lt;span class=&quot;code-comment&quot;&gt;//sieve-stable?plugged=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;;
&lt;/span&gt;  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; LEAKY_SIEVE_TRANSIENT = &lt;span class=&quot;code-quote&quot;&gt;&quot;leaky:&lt;span class=&quot;code-comment&quot;&gt;//sieve-&lt;span class=&quot;code-keyword&quot;&gt;transient&lt;/span&gt;?plugged=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;;
&lt;/span&gt;

  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isPatchApplied() {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;.parseBoolean(&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.getProperty(&lt;span class=&quot;code-quote&quot;&gt;&quot;patchApplied&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&quot;&lt;/span&gt;));
  }

  /**
   * Component that provides leaks producers.
   */
  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;LeakySieveComponent &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; DefaultComponent {
    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; Endpoint createEndpoint(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; uri, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; remaining, Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;&amp;gt; parameters) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
      &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; plugged = &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;.equalsIgnoreCase((&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;) parameters.remove(&lt;span class=&quot;code-quote&quot;&gt;&quot;plugged&quot;&lt;/span&gt;));
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; LeakySieveEndpoint(uri, isPatchApplied() &amp;amp;&amp;amp; plugged);
    }
  }

  /**
   * Endpoint that provides leaky producers.
   */
  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;LeakySieveEndpoint &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; DefaultEndpoint {

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; uri;
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; plugged;

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; LeakySieveEndpoint(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; uri, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; plugged) {
      &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.uri = checkNotNull(uri, &lt;span class=&quot;code-quote&quot;&gt;&quot;uri must not be &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;&quot;&lt;/span&gt;);
      &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.plugged = plugged;
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Producer createProducer() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; LeakySieveProducer(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;, plugged);
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Consumer createConsumer(Processor processor) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
      &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; UnsupportedOperationException();
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isSingleton() {
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; createEndpointUri() {
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; uri;
    }
  }

  /**
   * Leaky producer - &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; {@link ServicePoolAware}.
   */
  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;LeakySieveProducer &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; DefaultProducer &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; ServicePoolAware {

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; plugged;

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; LeakySieveProducer(Endpoint endpoint, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; plugged) {
      &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;(endpoint);
      &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.plugged = plugged;
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void process(Exchange exchange) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
      &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; nothing
&lt;/span&gt;    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void doStop() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
      &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.doStop();

      &lt;span class=&quot;code-comment&quot;&gt;//noinspection ConstantConditions
&lt;/span&gt;      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (plugged) {
        &lt;span class=&quot;code-comment&quot;&gt;// need to remove self from services since we are ServicePoolAware &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; will not be handled &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; us otherwise we
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// leak memory
&lt;/span&gt;        getEndpoint().getCamelContext().removeService(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;);
      }
    }
  }

  @Override
  &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; useJmx() {
    &lt;span class=&quot;code-comment&quot;&gt;// only occurs when using JMX as the GC root &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the producer is through a ManagedProducer created by the
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// context.addService() invocation
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
  }

  /**
   * Returns &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; verification of state should be performed during the test as opposed to at the end.
   */
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isFailFast() {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
  }

  /**
   * Returns &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; during fast failure we should verify that the service pool remains in the started state.
   */
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isVerifyProducerServicePoolRemainsStarted() {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
  }

  @Override
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isUseAdviceWith() {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
  }

  @Test
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testForMemoryLeak() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    registerLeakyComponent();

    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; AtomicLongMap&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; references = AtomicLongMap.create();

    &lt;span class=&quot;code-comment&quot;&gt;// track LeakySieveProducer lifecycle
&lt;/span&gt;    context.addLifecycleStrategy(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; LifecycleStrategySupport() {
      @Override
      &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void onServiceAdd(CamelContext context, Service service, Route route) {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (service &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; LeakySieveProducer) {
          references.incrementAndGet(((LeakySieveProducer) service).getEndpoint().getEndpointKey());
        }
      }

      @Override
      &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void onServiceRemove(CamelContext context, Service service, Route route) {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (service &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; LeakySieveProducer) {
          references.decrementAndGet(((LeakySieveProducer) service).getEndpoint().getEndpointKey());
        }
      }
    });

    context.addRoutes(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RouteBuilder() {
      @Override
      &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void configure() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        from(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:sieve-&lt;span class=&quot;code-keyword&quot;&gt;transient&lt;/span&gt;&quot;&lt;/span&gt;)
            .id(&lt;span class=&quot;code-quote&quot;&gt;&quot;sieve-&lt;span class=&quot;code-keyword&quot;&gt;transient&lt;/span&gt;&quot;&lt;/span&gt;)
            .to(LEAKY_SIEVE_TRANSIENT);

        from(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:sieve-stable&quot;&lt;/span&gt;)
            .id(&lt;span class=&quot;code-quote&quot;&gt;&quot;sieve-stable&quot;&lt;/span&gt;)
            .to(LEAKY_SIEVE_STABLE);
      }
    });

    context.start();

    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; 1000; i++) {
      ServiceSupport service = (ServiceSupport) context.getProducerServicePool();
      assertEquals(ServiceStatus.Started, service.getStatus());
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isFailFast()) {
        assertEquals(2, context.getProducerServicePool().size());
        assertEquals(1, references.get(LEAKY_SIEVE_TRANSIENT));
        assertEquals(1, references.get(LEAKY_SIEVE_STABLE));
      }

      context.stopRoute(&lt;span class=&quot;code-quote&quot;&gt;&quot;sieve-&lt;span class=&quot;code-keyword&quot;&gt;transient&lt;/span&gt;&quot;&lt;/span&gt;);

      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isFailFast()) {
        assertEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;Expected no service references to remain&quot;&lt;/span&gt;, 0, references.get(LEAKY_SIEVE_TRANSIENT));
      }

      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isFailFast()) {
        &lt;span class=&quot;code-comment&quot;&gt;// looks like we cleared more than just our route, we&apos;ve stopped and cleared the global ProducerServicePool
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// since SendProcessor.stop() invokes ServiceHelper.stopServices(producerCache, producer); which in turn invokes
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// ServiceHelper.stopAndShutdownService(pool);.
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;//
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// Whilst stop on the SharedProducerServicePool is a NOOP shutdown is not and effects a stop of the pool.
&lt;/span&gt;
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isVerifyProducerServicePoolRemainsStarted()) {
         assertEquals(ServiceStatus.Started, service.getStatus());
        }
        assertEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;Expected one stable producer to remain pooled&quot;&lt;/span&gt;, 1, context.getProducerServicePool().size());
        assertEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;Expected one stable producer to remain as service&quot;&lt;/span&gt;, 1, references.get(LEAKY_SIEVE_STABLE));
      }

      &lt;span class=&quot;code-comment&quot;&gt;// Send a body to verify behaviour of send producer after another route has been stopped
&lt;/span&gt;      sendBody(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:sieve-stable&quot;&lt;/span&gt;, &quot;&quot;);

      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isFailFast()) {
        &lt;span class=&quot;code-comment&quot;&gt;// shared pool is used despite being &lt;span class=&quot;code-quote&quot;&gt;&apos;Stopped&apos;&lt;/span&gt;
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isVerifyProducerServicePoolRemainsStarted()) {
          assertEquals(ServiceStatus.Started, service.getStatus());
        }

        assertEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;Expected only stable producer in pool&quot;&lt;/span&gt;, 1, context.getProducerServicePool().size());
        assertEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;Expected no references to &lt;span class=&quot;code-keyword&quot;&gt;transient&lt;/span&gt; producer&quot;&lt;/span&gt;, 0, references.get(LEAKY_SIEVE_TRANSIENT));
        assertEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;Expected reference to stable producer&quot;&lt;/span&gt;, 1, references.get(LEAKY_SIEVE_STABLE));
      }

      context.startRoute(&lt;span class=&quot;code-quote&quot;&gt;&quot;sieve-&lt;span class=&quot;code-keyword&quot;&gt;transient&lt;/span&gt;&quot;&lt;/span&gt;);

      &lt;span class=&quot;code-comment&quot;&gt;// ok, back to normal
&lt;/span&gt;      assertEquals(ServiceStatus.Started, service.getStatus());
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isFailFast()) {
        assertEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;Expected both producers in pool&quot;&lt;/span&gt;, 2, context.getProducerServicePool().size());
        assertEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;Expected one &lt;span class=&quot;code-keyword&quot;&gt;transient&lt;/span&gt; producer as service&quot;&lt;/span&gt;, 1, references.get(LEAKY_SIEVE_TRANSIENT));
        assertEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;Expected one stable producer as service&quot;&lt;/span&gt;, 1, references.get(LEAKY_SIEVE_STABLE));
      }
    }

    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!isFailFast()) {
      assertEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;Expected both producers in pool&quot;&lt;/span&gt;, 2, context.getProducerServicePool().size());

      &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; not fixed these will equal the number of iterations in the loop + 1
&lt;/span&gt;      assertEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;Expected one &lt;span class=&quot;code-keyword&quot;&gt;transient&lt;/span&gt; producer as service&quot;&lt;/span&gt;, 1, references.get(LEAKY_SIEVE_TRANSIENT));
      assertEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;Expected one stable producer as service&quot;&lt;/span&gt;, 1, references.get(LEAKY_SIEVE_STABLE));
    }
  }

  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void registerLeakyComponent() {
    &lt;span class=&quot;code-comment&quot;&gt;// register leaky component
&lt;/span&gt;    context.addComponent(&lt;span class=&quot;code-quote&quot;&gt;&quot;leaky&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; LeakySieveComponent());
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12873010">CAMEL-9143</key>
            <summary>Producers that implement the ServicePoolAware interface cause memory leak due to JMX references</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="ukcrpb6">Bob Browning</reporter>
                        <labels>
                    </labels>
                <created>Wed, 16 Sep 2015 15:23:31 +0000</created>
                <updated>Thu, 17 Sep 2015 09:41:32 +0000</updated>
                            <resolved>Thu, 17 Sep 2015 09:41:32 +0000</resolved>
                                    <version>2.14.1</version>
                    <version>2.14.2</version>
                    <version>2.15.0</version>
                    <version>2.15.1</version>
                                    <fixVersion>2.16.0</fixVersion>
                    <fixVersion>2.14.4</fixVersion>
                    <fixVersion>2.15.4</fixVersion>
                                    <component>camel-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14791696" author="davsclaus" created="Thu, 17 Sep 2015 07:11:12 +0000"  >&lt;p&gt;Thanks for the very detailed report. &lt;/p&gt;</comment>
                            <comment id="14791767" author="davsclaus" created="Thu, 17 Sep 2015 08:17:43 +0000"  >&lt;p&gt;Your endpoint should not be singleton, or the producer should override isSingleton and return false.&lt;/p&gt;</comment>
                            <comment id="14791797" author="davsclaus" created="Thu, 17 Sep 2015 08:46:05 +0000"  >&lt;p&gt;Though singleton endpoints/producer is possible with servicepoolaware also though its not so common.&lt;/p&gt;

&lt;p&gt;I got a fix and with the test case there is no mbean leaks anymore.&lt;/p&gt;</comment>
                            <comment id="14791806" author="ukcrpb6" created="Thu, 17 Sep 2015 08:56:39 +0000"  >&lt;p&gt;Yes in the TC as the intent was to simulate RemoteFileXxx it should override singleton as RemoteFileProducer does, but it still causes the leak.&lt;/p&gt;

&lt;p&gt;Prospect of the fix sounds good, cheers &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 9 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2k97b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>