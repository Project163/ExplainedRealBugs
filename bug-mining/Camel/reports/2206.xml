<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:56:10 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-6130] EndpointHelper.setReferenceProperties() does not work with OSGiServiceRegistry</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-6130</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;EndpointHelper.setReferenceProperties() does not work with OSGiServiceRegistry&lt;/p&gt;

&lt;p&gt;setReferenceProperties() is hard-coded to lookup services of type Object.class.&lt;/p&gt;

&lt;p&gt;It should use reflection to determine the type that the setter method accepts and then use that type to lookup the reference in the service registry.&lt;/p&gt;

&lt;p&gt;At the moment this issue is stopping #bean references in Endpoints from being resolved when using an OSGiServiceRegistry, in OSGi you need to know the class of the service you want before hand.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12635432">CAMEL-6130</key>
            <summary>EndpointHelper.setReferenceProperties() does not work with OSGiServiceRegistry</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="aaronjwhiteside">Aaron Whiteside</reporter>
                        <labels>
                    </labels>
                <created>Tue, 5 Mar 2013 21:05:27 +0000</created>
                <updated>Tue, 12 Mar 2013 11:47:43 +0000</updated>
                            <resolved>Tue, 12 Mar 2013 11:47:43 +0000</resolved>
                                    <version>2.9.5</version>
                    <version>2.10.4</version>
                                    <fixVersion>2.10.5</fixVersion>
                    <fixVersion>2.11.0</fixVersion>
                                    <component>osgi</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13594098" author="aaronjwhiteside" created="Tue, 5 Mar 2013 23:36:56 +0000"  >&lt;p&gt;Patch that fixes the issue, it&apos;s a little ugly but I didn&apos;t want to rewrite EndpointHelper or IntrospectionSupport.&lt;/p&gt;

&lt;p&gt;Passes all camel-core unit tests.&lt;/p&gt;</comment>
                            <comment id="13594577" author="davsclaus" created="Wed, 6 Mar 2013 10:31:03 +0000"  >&lt;p&gt;I think the fix should be on the OSGi side instead. So if Object.class is provided as type then it should ignore that. Or rely on the fact that any type is an Object.&lt;/p&gt;</comment>
                            <comment id="13594801" author="aaronjwhiteside" created="Wed, 6 Mar 2013 15:53:08 +0000"  >&lt;p&gt;I don&apos;t think that is possible, you need to know the exact type of a service to retrieve it from a BundleContext.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://www.osgi.org/javadoc/r4v43/core/org/osgi/framework/BundleContext.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.osgi.org/javadoc/r4v43/core/org/osgi/framework/BundleContext.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Passing in Object.class returns nothing because nothing is explicitly registered against that class.&lt;/p&gt;</comment>
                            <comment id="13594821" author="davsclaus" created="Wed, 6 Mar 2013 16:08:28 +0000"  >&lt;p&gt;You can use this method and provide null as the class&lt;br/&gt;
&lt;a href=&quot;http://www.osgi.org/javadoc/r4v43/core/org/osgi/framework/BundleContext.html#getServiceReferences(java.lang.Class&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.osgi.org/javadoc/r4v43/core/org/osgi/framework/BundleContext.html#getServiceReferences(java.lang.Class&lt;/a&gt;, java.lang.String)&lt;/p&gt;

&lt;p&gt;Frankly the end user has not provided any class but only the name of the bean to use. So if the service is register with class FooImpl.class, and we want to lookup this service using the name &quot;foo&quot;, then we should be able to do&lt;/p&gt;

&lt;p&gt;getServiceReferences(null, &quot;foo&quot;);&lt;/p&gt;

&lt;p&gt;If the setter type is a Foo (eg the interface) then Camel (with your patch) would call&lt;br/&gt;
getServiceReferences(Foo.class, &quot;foo&quot;);&lt;/p&gt;

&lt;p&gt;But what happens if the service was registered with &lt;br/&gt;
FooImpl.class as the class type.&lt;/p&gt;

&lt;p&gt;Would the OSGi service registry be smart enough to know that FooImpl and Foo is the &quot;same&quot;&lt;/p&gt;</comment>
                            <comment id="13594828" author="aaronjwhiteside" created="Wed, 6 Mar 2013 16:19:36 +0000"  >&lt;p&gt;The javadoc for that method says:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;clazz - The class under whose name the service was registered. Must not be null.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think in this case the &lt;em&gt;user&lt;/em&gt; is the Endpoint who is trying to lookup a property/bean and inject it into a method. So the method it finds to inject into determines the type? I think EndpointHelper.setReferenceProperties() is only used in that specific scenario and not by the wider public.&lt;/p&gt;

&lt;p&gt;Services in OSGi CAN be registered with any type, interface or not. But the general rule of thumb is you NEVER register a classes concert type, abstract types are OK, only the service interface. This is the essence of loosely coupled services, so I don&apos;t see this happening in practice.&lt;/p&gt;

&lt;p&gt;If the service was registered with it&apos;s concert class and you try and look it up by an interface it implements, you will not be able to find it. Mind you in OSGi you can expose/register a service via many interfaces/abstract classes.&lt;/p&gt;

&lt;p&gt;So no the OSGi service registry wouldn&apos;t be smart enough to figure it out by itself.&lt;/p&gt;</comment>
                            <comment id="13594840" author="davsclaus" created="Wed, 6 Mar 2013 16:31:59 +0000"  >&lt;p&gt;Ah it was getAllServiceReferences&lt;/p&gt;

&lt;p&gt;clazz - The class name with which the service was registered or null for all services.&lt;/p&gt;</comment>
                            <comment id="13594845" author="aaronjwhiteside" created="Wed, 6 Mar 2013 16:36:09 +0000"  >&lt;p&gt;Ah OK, So I still see a potential problem with that..&lt;/p&gt;

&lt;p&gt;Service property&apos;s have no unique constraint in OSGi, so there could be a a hundred services registered with the property name=hello, of all different types. So we would have to iterate through the list trying to inject each one until one fits? If you&apos;re OK with that approach I could implement it. Though I would be worried at the number of services it would find... potential performance issue.&lt;/p&gt;
</comment>
                            <comment id="13594891" author="aaronjwhiteside" created="Wed, 6 Mar 2013 17:43:04 +0000"  >&lt;p&gt;I&apos;ve had more time to think about this, and I don&apos;t think we should go with this approach.&lt;/p&gt;

&lt;p&gt;In endpoint helper we would have to call Registry.findByTypeWithName() passing Object.class then index into the result keyed by the bean name to get the object. &lt;/p&gt;

&lt;p&gt;I&apos;m not sure that all Registry implementations would work correctly this way? For me at least it still makes more sense to figure out the specific type and try and lookup a bean with that specific type and name.&lt;/p&gt;

&lt;p&gt;What do you think?&lt;/p&gt;</comment>
                            <comment id="13594925" author="davsclaus" created="Wed, 6 Mar 2013 18:19:25 +0000"  >&lt;p&gt;Yeah in light of the best practice in OSGi to register a service by its interface, and assuming the endpoint options will be using the interface as its type as well. So there is a 1:1 match. Then it makes sense to use the setter type in the lookup.&lt;/p&gt;

&lt;p&gt;If there is a type hierachy from the setter type, we could walk up the tree (and select the interfacaes), and do re-lookup, if we could not find a match. Though this may be overkill? &lt;/p&gt;</comment>
                            <comment id="13594934" author="aaronjwhiteside" created="Wed, 6 Mar 2013 18:25:16 +0000"  >&lt;p&gt;I think that&apos;s not a bad idea, I&apos;ve cleaned up the first patch a bit - so let me attach the cleaned up version. Then I&apos;ll work on a version that returns a set of possible types to try and lookup/inject.&lt;/p&gt;</comment>
                            <comment id="13594950" author="aaronjwhiteside" created="Wed, 6 Mar 2013 18:38:35 +0000"  >&lt;p&gt;Latest patch, cleaned up.&lt;/p&gt;</comment>
                            <comment id="13594959" author="davsclaus" created="Wed, 6 Mar 2013 18:45:24 +0000"  >&lt;p&gt;Great, it would be good if we could add an unit test to tests/camel-itest-osgi to have an actual unit test running in osgi environment.&lt;/p&gt;</comment>
                            <comment id="13594966" author="aaronjwhiteside" created="Wed, 6 Mar 2013 18:50:28 +0000"  >&lt;p&gt;second patch had a bug in it.. this one fixes that&lt;/p&gt;</comment>
                            <comment id="13594971" author="aaronjwhiteside" created="Wed, 6 Mar 2013 18:54:11 +0000"  >&lt;p&gt;You wouldn&apos;t happen to know which profiles to enable to run the tests under tests/camel-itest-osgi?&lt;/p&gt;</comment>
                            <comment id="13594990" author="davsclaus" created="Wed, 6 Mar 2013 19:08:40 +0000"  >&lt;p&gt;You can run the tests just by&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;mvn clean install
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Or a specific test class with&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;mvn clean test -Dtest=FooTest
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The profiles is there to not run the tests on the CI servers as they may hang the CI servers. Though the situation recently with pax-exam 2.6 and karaf 2.3 may improve this.&lt;/p&gt;</comment>
                            <comment id="13595099" author="aaronjwhiteside" created="Wed, 6 Mar 2013 20:50:54 +0000"  >&lt;p&gt;Forth patch, this one gets all the possible setter methods and then tries to inject each one until it succeeds or fails (due to conversion error or one of the setter methods throws an error).&lt;/p&gt;

&lt;p&gt;I added a todo comment, because I think we should really be suppressing these errors instead of just failing outright? But currently the existing behavior is preserved and all camel-core unit tests pass.&lt;/p&gt;

&lt;p&gt;I&apos;ve taken a look at OSGiIntegrationTestSupport used in tests/camel-itest-osgi and I can see that we never actually use the real OsgiServiceRegistry the JndiRegistry is always used by default. &lt;/p&gt;

&lt;p&gt;I&apos;ll continue to look at adding a real OSGi test, but in the meantime is the latest patch good enough to be applied? &lt;/p&gt;</comment>
                            <comment id="13595678" author="davsclaus" created="Thu, 7 Mar 2013 08:33:37 +0000"  >&lt;p&gt;camel-ahc uses builder pattern for its configuration so it failed due the code changes. We should allow builder pattern by default when using the set property IMHO. So I am testing with this enabled.&lt;/p&gt;</comment>
                            <comment id="13595769" author="davsclaus" created="Thu, 7 Mar 2013 10:52:06 +0000"  >&lt;p&gt;When using spring (spring-dm) or blueprint in the OSGi tests, then they use an OSGi CamelContext that setup all the registry and whatnot to use the OSGi versions. So eg OSGiRegistry would be used over JndiRegistry etc.&lt;/p&gt;

&lt;p&gt;This happens automatic for you.&lt;/p&gt;

&lt;p&gt;On the other hand if you create CamelContext manually you would need to use the osgi version of it, and setup all that other stuff manually.&lt;/p&gt;</comment>
                            <comment id="13596064" author="aaronjwhiteside" created="Thu, 7 Mar 2013 17:10:57 +0000"  >&lt;p&gt;Cleaned up EndpointHelper moved all the messy logic back into IntrospectionSupport.setProperty()&lt;/p&gt;

&lt;p&gt;All camel-core unit tests pass.&lt;/p&gt;</comment>
                            <comment id="13596191" author="davsclaus" created="Thu, 7 Mar 2013 19:00:19 +0000"  >&lt;p&gt;Thanks applied patch #5 to trunk and 2.10 branch&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12572362" name="CAMEL-6130-2.patch" size="7506" author="aaronjwhiteside" created="Wed, 6 Mar 2013 18:38:11 +0000"/>
                            <attachment id="12572366" name="CAMEL-6130-3.patch" size="7573" author="aaronjwhiteside" created="Wed, 6 Mar 2013 18:50:28 +0000"/>
                            <attachment id="12572388" name="CAMEL-6130-4_.patch" size="15179" author="aaronjwhiteside" created="Wed, 6 Mar 2013 20:45:58 +0000"/>
                            <attachment id="12572557" name="CAMEL-6130-5.patch" size="13318" author="aaronjwhiteside" created="Thu, 7 Mar 2013 17:10:57 +0000"/>
                            <attachment id="12572197" name="CAMEL-6130.patch" size="4308" author="aaronjwhiteside" created="Tue, 5 Mar 2013 23:36:56 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>315925</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 37 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1iikf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>316268</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>