<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:47:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-16197] CXF Attachment stay in file system after processing if file attachments has not been used</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-16197</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;Hi everyone,&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;we are using the camel CXF component and found that the cleanup of cached attachments is not working as expected. CXF will persist attachments to disk whenever they exceed a certain limit in size: &lt;a href=&quot;https://github.com/apache/cxf/blob/3.2.x-fixes/core/src/main/java/org/apache/cxf/io/CachedOutputStream.java#L433&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;cxf source&lt;/a&gt; If the attachments are consumed within the route, i.e. when they are used to send a message, the files will be removed from the filesystem. In case they are not used at all, the files will stay in the filesystem. So the CXF component somehow assumes that the attachments are consumed within the route.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Example&lt;/p&gt;

&lt;p&gt;We send a message that contains a attachment to a CXF endpoint. The attachment-size exceeds the size threshold and therefore will be persisted to disk. During message processing the attachment will not be used (the endpoint is oneway and attachments are not used within the route). After message processing, the file stays in the filesystem.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Reproduce with attached example project:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Start the Server.java test (starts the server taking the requests)&lt;/li&gt;
	&lt;li&gt;Start the Client.java (sends a request to the server)&lt;/li&gt;
	&lt;li&gt;Check the temp folder (printed in console by Client.java, in my case &#8220;C:\Users\me\AppData\Local\Temp\cxf-tmp-3330821712753099698)&lt;/li&gt;
	&lt;li&gt;Repeat executing Client.java and find for each run a new tmp-file&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Due to this file leaks, the filesystem will be filled up over time.&#160;&#160;&lt;/p&gt;

&lt;p&gt;Best regards,&lt;/p&gt;

&lt;p&gt;Manuel&lt;/p&gt;</description>
                <environment></environment>
        <key id="13358382">CAMEL-16197</key>
            <summary>CXF Attachment stay in file system after processing if file attachments has not been used</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="mash-sap">Manuel Shenavai</reporter>
                        <labels>
                    </labels>
                <created>Fri, 12 Feb 2021 17:29:06 +0000</created>
                <updated>Mon, 18 Jul 2022 12:59:50 +0000</updated>
                            <resolved>Wed, 31 Mar 2021 05:06:59 +0000</resolved>
                                    <version>2.25.3</version>
                                    <fixVersion>3.10.0</fixVersion>
                                    <component>camel-cxf</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17283867" author="davsclaus" created="Fri, 12 Feb 2021 17:34:19 +0000"  >&lt;p&gt;What version of Camel and CXF are you using?&lt;/p&gt;</comment>
                            <comment id="17283882" author="mash-sap" created="Fri, 12 Feb 2021 17:45:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt;, we are using following versions:&lt;/p&gt;

&lt;p&gt;CXF: 3.2.11&lt;br/&gt;
 Camel: 2.25.3&lt;/p&gt;</comment>
                            <comment id="17283890" author="davsclaus" created="Fri, 12 Feb 2021 18:02:04 +0000"  >&lt;p&gt;Can you test with Camel 3.7.2 which is the latest release and see if you can reproduce anything there.&lt;/p&gt;

&lt;p&gt;Camel 2.x is not active developed anymore, and we only fix criticial bugs or CVEs&lt;/p&gt;</comment>
                            <comment id="17284782" author="mash-sap" created="Mon, 15 Feb 2021 15:34:17 +0000"  >&lt;p&gt;Ok, I will give you an update soon.&lt;/p&gt;</comment>
                            <comment id="17285333" author="mash-sap" created="Tue, 16 Feb 2021 16:45:52 +0000"  >&lt;p&gt;I uploaded a new project using camel 3.7.2 to reproduce the problem. Please check this from your end.&lt;/p&gt;</comment>
                            <comment id="17285696" author="mash-sap" created="Wed, 17 Feb 2021 07:57:57 +0000"  >&lt;p&gt;The provided scenario is CXF Inbound (one-way). I like to add, that this problem can also occur when attachments are received via CXF and the attachments are not used, i.e. doing a request with CXF and the response contains attachments.&lt;/p&gt;</comment>
                            <comment id="17306349" author="davsclaus" created="Mon, 22 Mar 2021 16:31:00 +0000"  >&lt;p&gt;Can you report this to Apache CXF as its likely a bug in their system&lt;/p&gt;</comment>
                            <comment id="17308082" author="davsclaus" created="Wed, 24 Mar 2021 18:06:17 +0000"  >&lt;p&gt;Maybe we can do something in camel-cxf when Exchange is UoW done to check if there are any of those left over attachments, or trigger the stream to close which is when CXF itself deletes the files.&lt;/p&gt;</comment>
                            <comment id="17308124" author="davsclaus" created="Wed, 24 Mar 2021 18:56:34 +0000"  >&lt;p&gt;Thanks for the reproducer example - that was good to help reproduce and see the issue, that helped to verify the fix.&lt;/p&gt;</comment>
                            <comment id="17308139" author="mash-sap" created="Wed, 24 Mar 2021 19:16:03 +0000"  >&lt;p&gt;Great, thanks for fixing this issue!&#160;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/thumbs_up.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17311559" author="mash-sap" created="Tue, 30 Mar 2021 14:39:24 +0000"  >&lt;p&gt;Hi Claus,&lt;/p&gt;

&lt;p&gt;sorry for reopening this issue. I think we need the same fix for the cxfProducer: &lt;a href=&quot;https://github.com/Talend/apache-camel/blob/master/components/camel-cxf/src/main/java/org/apache/camel/component/cxf/CxfProducer.java#L187&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/Talend/apache-camel/blob/master/components/camel-cxf/src/main/java/org/apache/camel/component/cxf/CxfProducer.java#L187&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I attached a project to reproduce the problem. To reproduce:&lt;br/&gt;
 1) Start Server.java&lt;br/&gt;
 2) Start Client.java&lt;br/&gt;
 3) Check the cxf tmp folder (printed in the console output)&lt;br/&gt;
 4) Find 3 orphaned tmp-files in the tmp folder&lt;/p&gt;

&lt;p&gt;In this use-case cxf is the client that receives attachment from the server. The previous fix was cxf as a server getting a request containing attachments.&lt;/p&gt;

&lt;p&gt;Best regards,&lt;br/&gt;
 Manuel&lt;/p&gt;</comment>
                            <comment id="17312060" author="davsclaus" created="Wed, 31 Mar 2021 05:06:59 +0000"  >&lt;p&gt;Thanks for the 2nd reproducer. I have fixed this in the producer now.&lt;/p&gt;</comment>
                            <comment id="17317977" author="mash-sap" created="Fri, 9 Apr 2021 13:21:43 +0000"  >&lt;p&gt;I just tested the fixes. For my provided use-case they fix the problem. In addition to that, I checked the behavior if the attachments are removed from the camelExchange (without reading the data, just cleaning the attachment list). For use-case 1 (inbound, one-way) the attachments are still removed, thats good! For the second use-case, the file leak persist, because the cleanup works on the camelExchange. Therefore I did another change and moved the cleanup to the cxfBinding. I created a pull request for that:&lt;br/&gt;
 &lt;a href=&quot;https://github.com/apache/camel/pull/5326&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/5326&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;With this change, the file leak is fixes, even if the attachments are removed from the camel exchange.&lt;/p&gt;</comment>
                            <comment id="17318425" author="davsclaus" created="Sat, 10 Apr 2021 06:01:04 +0000"  >&lt;p&gt;Thanks for testing more and providing the PR&lt;/p&gt;</comment>
                            <comment id="17567978" author="rastislav.papp" created="Mon, 18 Jul 2022 12:59:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mash-sap&quot; class=&quot;user-hover&quot; rel=&quot;mash-sap&quot;&gt;mash-sap&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt;, I have a route like this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
from(&lt;span class=&quot;code-quote&quot;&gt;&quot;cxf:bean:publishedEndpoint&quot;&lt;/span&gt;)
   &lt;span class=&quot;code-comment&quot;&gt;//...
&lt;/span&gt;   .enrich(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:integratedEndpoint&quot;&lt;/span&gt;, AggregationStrategies.flexible().storeInBody())
   &lt;span class=&quot;code-comment&quot;&gt;//...
&lt;/span&gt;;

from(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:integratedEndpoint&quot;&lt;/span&gt;)
   .to(&lt;span class=&quot;code-quote&quot;&gt;&quot;cxf:bean:integratedEndpoint&quot;&lt;/span&gt;);

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Until this ticket got implemented (using camel 3.7.x) attachments returned from &lt;tt&gt;cxf:bean:integratedEndpoint&lt;/tt&gt; got populated into the published endpoint response. Now after upgrading to camel 3.14.x, the attachment is still there in the response, but empty. I suspect this is the culprit. When I set enrich&apos;s shareUnitOfWork=true, the problem is gone.&lt;/p&gt;

&lt;p&gt;Should I create a separate bug for this, or is my use case (integrated soap ws called via enrich EIP) not the proper usage? I&apos;m doing it mainly because when having combinations of published / integrated cxf endpoints in a route, each of them having different dataFormat, using &lt;tt&gt;.to&lt;/tt&gt; leaks data from one to the other.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13023188" name="attachment2.zip" size="53123" author="mash-sap" created="Tue, 30 Mar 2021 14:39:12 +0000"/>
                            <attachment id="13020525" name="attachments.3.7.zip" size="13804" author="mash-sap" created="Tue, 16 Feb 2021 16:44:17 +0000"/>
                            <attachment id="13020410" name="attachments.zip" size="8739" author="mash-sap" created="Fri, 12 Feb 2021 17:28:57 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 17 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0nmxc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>