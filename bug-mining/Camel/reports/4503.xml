<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:29:21 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-12395] HttpProducer cookie handling broken</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-12395</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;Assumptions from &lt;a href=&quot;https://tools.ietf.org/html/rfc6265&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://tools.ietf.org/html/rfc6265&lt;/a&gt;&lt;br/&gt;
When a host response contains multiple headers with the same key, each with different values, the HttpProducer overwrites the value, effectively last-in-wins,&#160;extracted problem code below&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void populateResponse(Exchange exchange, HttpRequestBase httpRequest, HttpResponse httpResponse,
Message in, HeaderFilterStrategy strategy, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; responseCode) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException, ClassNotFoundException {
  ...
  &lt;span class=&quot;code-comment&quot;&gt;// propagate HTTP response headers
&lt;/span&gt;  Header[] headers = httpResponse.getAllHeaders();
  Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, List&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;&amp;gt; m = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashMap&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, List&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;&amp;gt;();
  &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Header header : headers) {
    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name = header.getName();
    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; value = header.getValue();
    m.put(name, Collections.singletonList(value)); &lt;span class=&quot;code-comment&quot;&gt;//&amp;lt;--- This is the problem
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (name.toLowerCase().equals(&lt;span class=&quot;code-quote&quot;&gt;&quot;content-type&quot;&lt;/span&gt;)) {
      name = Exchange.CONTENT_TYPE;
      exchange.setProperty(Exchange.CHARSET_NAME, IOHelper.getCharsetNameFromContentType(value));
    }
    &lt;span class=&quot;code-comment&quot;&gt;// use http helper to extract parameter value as it may contain multiple values
&lt;/span&gt;    &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; extracted = HttpHelper.extractHttpParameterValue(value);
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (strategy != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; !strategy.applyFilterToExternalHeaders(name, extracted, exchange)) {
     HttpHelper.appendHeader(answer.getHeaders(), name, extracted);
    }
  }
  &lt;span class=&quot;code-comment&quot;&gt;// handle cookies
&lt;/span&gt;  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (getEndpoint().getCookieHandler() != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
  &lt;span class=&quot;code-comment&quot;&gt;//&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; host responded with multiple Set-Cookie headers, only last cookie is presented
&lt;/span&gt;  getEndpoint().getCookieHandler().storeCookies(exchange, httpRequest.getURI(), m);
  }
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;A simple fix -&amp;gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
...
&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Header header : headers) {
  &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name = header.getName();
  &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; value = header.getValue();
  List&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; values = m.computeIfAbsent(name, k -&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;&amp;gt;()).add(value);
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;On the flip side, when the client responds, the cookies pulled from the handler are not formatted correctly, broken code snippet from HttpProducer.process()&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (getEndpoint().getCookieHandler() != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, List&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;&amp;gt; cookieHeaders = getEndpoint().getCookieHandler().loadCookies(exchange, httpRequest.getURI());
            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Map.Entry&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, List&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;&amp;gt; entry : cookieHeaders.entrySet()) {
                &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; key = entry.getKey();
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (entry.getValue().size() &amp;gt; 0) {
                    &lt;span class=&quot;code-comment&quot;&gt;// use the &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt; toString of a ArrayList to create in the form [xxx, yyy]
&lt;/span&gt;                    &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; multi valued, &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a single value, then just output the value as is
&lt;/span&gt;                    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; s = entry.getValue().size() &amp;gt; 1 ? entry.getValue().toString() : entry.getValue().get(0);&lt;span class=&quot;code-comment&quot;&gt;//&amp;lt;--- This is a problem
&lt;/span&gt;                    httpRequest.addHeader(key, s);
                }
            }
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This can be fixed simply&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (getEndpoint().getCookieHandler() != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, List&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;&amp;gt; cookieHeaders = getEndpoint().getCookieHandler().loadCookies(exchange, httpRequest.getURI());
            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Map.Entry&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, List&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;&amp;gt; entry : cookieHeaders.entrySet()) {
                &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; key = entry.getKey();
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (entry.getValue().size() &amp;gt; 0) {
                    httpRequest.addHeader(key, entry.getValue().stream().collect(Collectors.joining(&lt;span class=&quot;code-quote&quot;&gt;&quot;;&quot;&lt;/span&gt;))); &lt;span class=&quot;code-comment&quot;&gt;//semi-colon, not comma...
&lt;/span&gt;                }
            }
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Additionally, the CookieHandler.loadCookies method is not properly constructing the Cookie values, as it calls HttpCookie.toString - which represents the host&apos;s &lt;em&gt;Set-Cookie&lt;/em&gt; value, not the client&apos;s &lt;em&gt;Cookie&lt;/em&gt; value&lt;/p&gt;</description>
                <environment></environment>
        <key id="13147296">CAMEL-12395</key>
            <summary>HttpProducer cookie handling broken</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="kbrooks">Kevin Brooks</reporter>
                        <labels>
                    </labels>
                <created>Thu, 22 Mar 2018 22:00:21 +0000</created>
                <updated>Fri, 13 Apr 2018 07:22:09 +0000</updated>
                            <resolved>Fri, 13 Apr 2018 07:22:09 +0000</resolved>
                                    <version>2.20.2</version>
                                    <fixVersion>2.20.4</fixVersion>
                    <fixVersion>2.21.1</fixVersion>
                    <fixVersion>2.22.0</fixVersion>
                                    <component>camel-http</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="86400">24h</timeoriginalestimate>
                            <timeestimate seconds="86400">24h</timeestimate>
                                        <comments>
                            <comment id="16417030" author="davsclaus" created="Wed, 28 Mar 2018 08:26:40 +0000"  >&lt;p&gt;You are welcome to provide a PR or patch file&lt;/p&gt;</comment>
                            <comment id="16436941" author="davsclaus" created="Fri, 13 Apr 2018 07:22:09 +0000"  >&lt;p&gt;Thanks for reporting and the suggested patch&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10061"><![CDATA[Novice]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 31 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ro9b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>