<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:43:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-15748] Paho consumer never connects if the broker is not reachable at startup</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-15748</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;Having a route with a paho consumer in a route, if the broker is not reachable at startup, camel context fail fast and shuts down.&lt;/p&gt;


&lt;p&gt; This can be avoided by setting the &lt;b&gt;SupervisingRouteController&lt;/b&gt;, but this way, even if camel context does not fail, the consumer is never able to establish a connection.&lt;/p&gt;

&lt;p&gt;The reason is that when &lt;b&gt;PahoConsumer&lt;/b&gt; starts for the first time, it creates a &lt;b&gt;MqttClient&lt;/b&gt; and stores it into &lt;b&gt;client&lt;/b&gt; field; the call to &lt;b&gt;client.connect&lt;/b&gt; throws an exception due to broker down;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#160;
    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void doStart() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.doStart();        connectOptions = PahoEndpoint.createMqttConnectOptions(getEndpoint().getConfiguration());        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (client == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            clientId = getEndpoint().getConfiguration().getClientId();
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (clientId == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                clientId = &lt;span class=&quot;code-quote&quot;&gt;&quot;camel-&quot;&lt;/span&gt; + MqttClient.generateClientId();
            }
            stopClient = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
            client = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MqttClient(
                    getEndpoint().getConfiguration().getBrokerUrl(),
                    clientId,
                    PahoEndpoint.createMqttClientPersistence(getEndpoint().getConfiguration()));
            LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Connecting client: {} to broker: {}&quot;&lt;/span&gt;, clientId, getEndpoint().getConfiguration().getBrokerUrl());
            client.connect(connectOptions);
        }
        
        &lt;span class=&quot;code-comment&quot;&gt;// other code omitted &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; brevity
&lt;/span&gt;        
        client.subscribe(getEndpoint().getTopic(), getEndpoint().getConfiguration().getQos());&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;after that &lt;b&gt;doStop&lt;/b&gt; is invoked but the &lt;b&gt;client&lt;/b&gt; instance is not nullified, because it is not connected&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void doStop() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.doStop();        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (stopClient &amp;amp;&amp;amp; client != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; client.isConnected()) {
            &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; topic = getEndpoint().getTopic();
            &lt;span class=&quot;code-comment&quot;&gt;// only unsubscribe &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; we are not durable
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (getEndpoint().getConfiguration().isCleanSession()) {
                LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Unsubscribing client: {} from topic: {}&quot;&lt;/span&gt;, clientId, topic);
                client.unsubscribe(topic);
            } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
                LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Client: {} is durable so will not unsubscribe from topic: {}&quot;&lt;/span&gt;, clientId, topic);
            }
            LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Disconnecting client: {} from broker: {}&quot;&lt;/span&gt;, clientId, getEndpoint().getConfiguration().getBrokerUrl());
            client.disconnect();
            client = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;when the supervisor tries to restart the route, &lt;b&gt;client&lt;/b&gt; instance already exists, but the call to &lt;b&gt;client.subscribe&lt;/b&gt; fails because the client is not connected.&lt;/p&gt;

&lt;p&gt;Perhaps always nullify &lt;b&gt;client&lt;/b&gt; in &lt;b&gt;doStop&lt;/b&gt;&#160;should resolve the issue; however I have no idea it this solution will impact in other ways.&lt;/p&gt;


&lt;p&gt; A better solution may be to handle automatic reconnect in the consumer, like &lt;b&gt;RabbitConsumer&lt;/b&gt;&#160;does, for example.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13337022">CAMEL-15748</key>
            <summary>Paho consumer never connects if the broker is not reachable at startup</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="mcollovati">Marco Collovati</reporter>
                        <labels>
                    </labels>
                <created>Sat, 24 Oct 2020 08:46:05 +0000</created>
                <updated>Tue, 3 Nov 2020 13:47:33 +0000</updated>
                            <resolved>Mon, 2 Nov 2020 05:20:32 +0000</resolved>
                                    <version>3.5.0</version>
                    <version>3.4.4</version>
                    <version>3.6.0</version>
                                    <fixVersion>3.4.5</fixVersion>
                    <fixVersion>3.7.0</fixVersion>
                                    <component>camel-paho</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17220034" author="davsclaus" created="Sat, 24 Oct 2020 08:53:12 +0000"  >&lt;p&gt;Can you try testing with setting the value to null.&lt;/p&gt;

&lt;p&gt;Supervising route controller is the better way as otherwise having to build in auto reconnection logic in 100+ components each with all kind of their own way is not ideal, vs having camel route controller managing it which can also be consistently managed and monitored.&lt;/p&gt;

&lt;p&gt;And btw on cloud systems you have readiness checks where the cloud system will restart / reschedule the app. &lt;/p&gt;</comment>
                            <comment id="17220039" author="mcollovati" created="Sat, 24 Oct 2020 09:36:18 +0000"  >&lt;p&gt;Also noticed two different behaviours in 3.5 (paho&#160;1.2.4)&#160; and 3.6 (paho&#160;1.2.5): in 3.5 &lt;b&gt;MqttClient.connect&lt;/b&gt; immediately fails if broker is down, whereas in 3.6 it hangs forever.&lt;/p&gt;</comment>
                            <comment id="17220040" author="mcollovati" created="Sat, 24 Oct 2020 09:41:28 +0000"  >&lt;p&gt;Thank you for the explanation &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Nullifying client works for me ; i tested it extending `PahoConsumer` and overriding `doStop` as in the attached test&#160;&#160;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13014058/13014058_PahoConsumerRestartTest.java&quot; title=&quot;PahoConsumerRestartTest.java attached to CAMEL-15748&quot;&gt;PahoConsumerRestartTest.java&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="17220172" author="davsclaus" created="Sat, 24 Oct 2020 18:27:56 +0000"  >&lt;p&gt;Thanks Marco. I wonder if you want to contribute this as a github PR and include the unit test. You can do this on 3.4.x branch and we can forward patch it on master - although most of the time we prefer master first.&lt;/p&gt;</comment>
                            <comment id="17220173" author="mcollovati" created="Sat, 24 Oct 2020 18:38:27 +0000"  >&lt;p&gt;I&apos;ll be glad to contribute; I&apos;ll open a PR as soon as possible.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17220321" author="davsclaus" created="Sun, 25 Oct 2020 15:45:42 +0000"  >&lt;p&gt;Merged to 3.4.x branch &lt;b&gt;DONE&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;TODO: master branch&lt;/p&gt;</comment>
                            <comment id="17220325" author="mcollovati" created="Sun, 25 Oct 2020 16:30:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt; I&apos;m working on a PR for master, but I have a problem with the test.&lt;/p&gt;

&lt;p&gt;As mentioned above, with&#160;paho&#160;1.2.5 the call to MqttClient.connect hangs indefinitely, regardless the connection timeout settings.&lt;/p&gt;

&lt;p&gt;Can this be handled somehow in test code?&lt;/p&gt;

&lt;p&gt;The only workaround I found is to set &lt;b&gt;timeToWait&lt;/b&gt;&#160;on MqttClient and reset it to &lt;b&gt;-1&lt;/b&gt; after connection is established, but I think this is not a good idea&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
client.setTimeToWait(1000 + getEndpoint().getConfiguration().getConnectionTimeout() * 1000);
client.connect(connectOptions);
client.setTimeToWait(-1);

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Does it make sense to add a `connectTimeToWait` configuration on PahoConfiguration?&lt;/p&gt;</comment>
                            <comment id="17220670" author="davsclaus" created="Mon, 26 Oct 2020 13:07:14 +0000"  >&lt;p&gt;Maybe its a bug in paho 1.2.5 - not sure if you can research this / or get in touch with them so they are aware of this&lt;/p&gt;</comment>
                            <comment id="17220993" author="mcollovati" created="Mon, 26 Oct 2020 21:00:16 +0000"  >&lt;p&gt;I think the reason of the hang is this change in paho &lt;b&gt;CommsReceiver&lt;/b&gt;, inside `run` main loop&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// paho 1.2.4
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (message != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
	&lt;span class=&quot;code-comment&quot;&gt;// A &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; message has arrived
&lt;/span&gt;	clientState.notifyReceivedMsg(message);
}  
&lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
    &lt;span class=&quot;code-comment&quot;&gt;// fix &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; bug 719
&lt;/span&gt;	&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!clientComms.isConnected()) {
		&lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IOException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Connection is lost.&quot;&lt;/span&gt;);
	}
}


&lt;span class=&quot;code-comment&quot;&gt;// paho 1.2.5
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (message != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
	&lt;span class=&quot;code-comment&quot;&gt;// A &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; message has arrived
&lt;/span&gt;	clientState.notifyReceivedMsg(message);
}  
&lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
	&lt;span class=&quot;code-comment&quot;&gt;// fix &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; bug 719
&lt;/span&gt;	&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!clientComms.isConnected() &amp;amp;&amp;amp; !clientComms.isConnecting()) {
        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IOException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Connection is lost.&quot;&lt;/span&gt;);
	}
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;During connection attempt &lt;b&gt;clientComms&lt;/b&gt; is in status connecting; when broker is down a null message is received and, in paho 1.2.4,an exception is immediately thrown because &lt;b&gt;clientComms&lt;/b&gt; is not connected. In 1.2.5 however the exception is never throw because &lt;b&gt;clientComms&lt;/b&gt; is in connecting state and this leads to an infinite loop.&lt;/p&gt;

&lt;p&gt;The issue 719, mentioned in the comment, is also referred by other issues but none of this are about infinite loops.&lt;br/&gt;
I can try to do some additional research on paho issue tracker and to get in touch to understand if this is a bug or an expected behavior, but this may take some time because I can do it only on my spare time.&lt;/p&gt;</comment>
                            <comment id="17224036" author="mcollovati" created="Sat, 31 Oct 2020 09:30:03 +0000"  >&lt;p&gt;Opened an issue on paho java issue tracker: &lt;a href=&quot;https://github.com/eclipse/paho.mqtt.java/issues/843&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/eclipse/paho.mqtt.java/issues/843&lt;/a&gt;&lt;br/&gt;
Waiting for feedback&lt;/p&gt;</comment>
                            <comment id="17224326" author="mcollovati" created="Sun, 1 Nov 2020 20:03:53 +0000"  >&lt;p&gt;Created the PR for master.&lt;/p&gt;

&lt;p&gt;The problem was in the test, not in paho client.&lt;/p&gt;

&lt;p&gt;When adding a connector to ActiveMQ *&lt;b&gt;BrokerService&lt;/b&gt;* the server socket is immediately available,even if &lt;b&gt;BrokerService.start&lt;/b&gt; is not invoked.&lt;br/&gt;
So paho client can establish a connection, but it receives &lt;b&gt;null&lt;/b&gt; messages do to socket read time out, and this leads to an infinite loop.&lt;/p&gt;

&lt;p&gt;Moving &lt;b&gt;addConnector&lt;/b&gt; immediately before broker start in test does the trick.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13014058" name="PahoConsumerRestartTest.java" size="4909" author="mcollovati" created="Sat, 24 Oct 2020 09:41:04 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 2 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0jz1s:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>