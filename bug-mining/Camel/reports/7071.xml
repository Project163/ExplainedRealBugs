<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 11:10:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-21858] camel-tracing: Incorrect http method on trace record</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-21858</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;Consider the following integration created with the yaml dsl:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
- from: 
    uri: &lt;span class=&quot;code-keyword&quot;&gt;rest&lt;/span&gt;:get:/demo 
    steps: 
    - setBody: 
        expression: 
           constant: &lt;span class=&quot;code-quote&quot;&gt;&apos;{&lt;span class=&quot;code-quote&quot;&gt;&quot;hello&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;world&quot;&lt;/span&gt;}&apos;&lt;/span&gt;
    - toD: 
        uri: &lt;span class=&quot;code-quote&quot;&gt;&quot;https:&lt;span class=&quot;code-comment&quot;&gt;//webhook.site/0148d971-4a63-4c61-8845-efd62b7242de&quot;&lt;/span&gt;
&lt;/span&gt;        parameters: 
          bridgeEndpoint: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; 
          httpMethod: POST 
          throwExceptionOnFailure: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and that open telemetry tracing is enabled.&lt;/p&gt;

&lt;p&gt;When a request to /demo is performed, we can see that the code performs a POST request to &lt;a href=&quot;https://webhook.site/0148d971-4a63-4c61-8845-efd62b7242de,&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://webhook.site/0148d971-4a63-4c61-8845-efd62b7242de,&lt;/a&gt; as it should, but the corresponding trace span reports the http.method as GET instead.&lt;/p&gt;

&lt;p&gt;This happens because the rest consumer sets the CamelHttpMethod header to GET and this header is used by the tracing component to build the span. I expected it to use give priority to the httpMethod endpoint parameter, as the http component does.&lt;/p&gt;

&lt;p&gt;similar scenario happens in this case:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
- from:    
    uri: &lt;span class=&quot;code-keyword&quot;&gt;rest&lt;/span&gt;:post:/demo    
    steps:      
    - removeHeaders:          
        pattern: &lt;span class=&quot;code-quote&quot;&gt;&quot;*&quot;&lt;/span&gt; 
   - setBody: 
        expression: 
          constant: &lt;span class=&quot;code-quote&quot;&gt;&apos;{&lt;span class=&quot;code-quote&quot;&gt;&quot;hello&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;world&quot;&lt;/span&gt;}&apos;&lt;/span&gt; &#160; &#160; 
    - toD:          
        uri: &lt;span class=&quot;code-quote&quot;&gt;&quot;https:&lt;span class=&quot;code-comment&quot;&gt;//webhook.site/0148d971-4a63-4c61-8845-efd62b7242de&quot;&lt;/span&gt;
&lt;/span&gt;        parameters:            
          bridgeEndpoint: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;            
          httpMethod: POST            
          throwExceptionOnFailure: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt; &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Here we have the rest consumer defined with POST, but we remove the headers.&lt;/p&gt;

&lt;p&gt;And the &lt;a href=&quot;https://github.com/apache/camel/blob/main/components/camel-tracing/src/main/java/org/apache/camel/tracing/decorators/AbstractHttpSpanDecorator.java#L47&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;span decorator&lt;/a&gt; decides it is a GET because the endpoint has query parameters. The endpoint in this case is &lt;a href=&quot;https://webhook.site/0148d971-4a63-4c61-8845-efd62b7242de?httMethod=true&amp;amp;httpMethod=POST&amp;amp;throwExceptionOnFailure=false&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://webhook.site/0148d971-4a63-4c61-8845-efd62b7242de?bridgeEndpoint=true&amp;amp;httpMethod=POST&amp;amp;throwExceptionOnFailure=false&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13611465">CAMEL-21858</key>
            <summary>camel-tracing: Incorrect http method on trace record</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="luiscarneiro">Luis Sergio Faria Carneiro</reporter>
                        <labels>
                    </labels>
                <created>Tue, 11 Mar 2025 16:56:36 +0000</created>
                <updated>Fri, 14 Mar 2025 14:25:09 +0000</updated>
                            <resolved>Fri, 14 Mar 2025 14:25:09 +0000</resolved>
                                                    <fixVersion>4.11.0</fixVersion>
                                    <component>camel-tracing</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17934287" author="luiscarneiro" created="Tue, 11 Mar 2025 17:22:39 +0000"  >&lt;p&gt;My proposal to solve this: Inspect the query String and look for the httpMethod param. it it&apos;s set, consider its value for deciding the http method and make it take priority over the http method header&lt;/p&gt;</comment>
                            <comment id="17934289" author="luiscarneiro" created="Tue, 11 Mar 2025 17:23:54 +0000"  >&lt;p&gt;A couple of tests on the&#160;AbstractHttpSpanDecoratorTest that reproduces the cases reported above:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testPostMethodQueryStringInEndpoint() {
        Endpoint endpoint = Mockito.mock(Endpoint.class);
        Exchange exchange = Mockito.mock(Exchange.class);
        Message message = Mockito.mock(Message.class);

        Mockito.when(endpoint.getEndpointUri()).thenReturn(&lt;span class=&quot;code-quote&quot;&gt;&quot;http:&lt;span class=&quot;code-comment&quot;&gt;//localhost:8080/endpoint?httpMethod=POST&quot;&lt;/span&gt;);
&lt;/span&gt;        Mockito.when(exchange.getIn()).thenReturn(message);
        Mockito.when(message.getHeader(Exchange.HTTP_URI, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.class))
                .thenReturn(&lt;span class=&quot;code-quote&quot;&gt;&quot;http:&lt;span class=&quot;code-comment&quot;&gt;//localhost:8080/endpoint?httpMethod=POST&quot;&lt;/span&gt;);
&lt;/span&gt;
        assertEquals(AbstractHttpSpanDecorator.POST_METHOD,
                AbstractHttpSpanDecorator.getHttpMethod(exchange, endpoint));
    }

    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testPostMethodQueryStringInEndpointWithHeaderAsGET() {
        Endpoint endpoint = Mockito.mock(Endpoint.class);
        Exchange exchange = Mockito.mock(Exchange.class);
        Message message = Mockito.mock(Message.class);

        Mockito.when(endpoint.getEndpointUri()).thenReturn(&lt;span class=&quot;code-quote&quot;&gt;&quot;http:&lt;span class=&quot;code-comment&quot;&gt;//localhost:8080/endpoint?httpMethod=POST&quot;&lt;/span&gt;);
&lt;/span&gt;        Mockito.when(exchange.getIn()).thenReturn(message);
        Mockito.when(message.getHeader(Exchange.HTTP_METHOD)).thenReturn(HttpMethods.GET);
        Mockito.when(message.getHeader(Exchange.HTTP_URI, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.class))
                .thenReturn(&lt;span class=&quot;code-quote&quot;&gt;&quot;http:&lt;span class=&quot;code-comment&quot;&gt;//localhost:8080/endpoint?httpMethod=POST&quot;&lt;/span&gt;);
&lt;/span&gt;
        assertEquals(AbstractHttpSpanDecorator.POST_METHOD,
                AbstractHttpSpanDecorator.getHttpMethod(exchange, endpoint));
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17934293" author="davsclaus" created="Tue, 11 Mar 2025 17:42:48 +0000"  >&lt;p&gt;what camel version do you use&lt;/p&gt;</comment>
                            <comment id="17934296" author="luiscarneiro" created="Tue, 11 Mar 2025 17:54:44 +0000"  >&lt;p&gt;I tested it with Camel 4.0.3.&lt;br/&gt;
The provided tests were created in the main branch.&lt;/p&gt;</comment>
                            <comment id="17934300" author="davsclaus" created="Tue, 11 Mar 2025 18:02:12 +0000"  >&lt;p&gt;4.0.3 is an old release that is EOL and not supported. Use latest 4.10.2 release first.&lt;/p&gt;</comment>
                            <comment id="17934309" author="luiscarneiro" created="Tue, 11 Mar 2025 18:18:55 +0000"  >&lt;p&gt;Ok, it will take some time to test it with 4.10.x. Currenly I&apos;m running on camel k, which does not have a 4.10 compatible runtime yet. I&apos;ll try it with jbang.&lt;/p&gt;

&lt;p&gt;But do the junit tests make sense? If they do, they were created in the main branch and may be a reproducer.&lt;/p&gt;</comment>
                            <comment id="17934318" author="luiscarneiro" created="Tue, 11 Mar 2025 19:12:39 +0000"  >&lt;p&gt;That&apos;s an issue with Camel 4.8.3 as well (the version that is compatible with camel-k-runtime 3.15.2). (Still trying to reproduce it outside camel-k with 4.10.x.)&lt;/p&gt;</comment>
                            <comment id="17935088" author="squakez" created="Thu, 13 Mar 2025 08:20:04 +0000"  >&lt;p&gt;I guess the same would apply on 4.10 as there was no major changes lately in the component. You should be able to reproduce with Camel JBang for sure. If you&apos;re going to fix it, please, take it in consideration also the new camel-telemetry component, which should eventually replace the camel-tracing. The decoration logic is exactly the same, so, you can reuse the same piece of code if it makes sense.&lt;/p&gt;</comment>
                            <comment id="17935145" author="luiscarneiro" created="Thu, 13 Mar 2025 11:07:26 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=squakez&quot; class=&quot;user-hover&quot; rel=&quot;squakez&quot;&gt;squakez&lt;/a&gt;. I submmited &lt;a href=&quot;https://github.com/apache/camel/pull/17448&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/17448&lt;/a&gt; to fix it, let&apos;s see if it is approved.  I overcame this issue with the current code by extending the existing span decorator and implementing the proposed fix, and it worked.&lt;/p&gt;

&lt;p&gt;As for the camel-opentelemetry2 component, I took a look at it, but didn&apos;t understand how it works. Just saw a couple of classes there and couldn&apos;t find how it relaates to some kind of span decorator. If you can provide me some hint on where to look, I can change that code as well.&lt;/p&gt;</comment>
                            <comment id="17935230" author="squakez" created="Thu, 13 Mar 2025 14:38:01 +0000"  >&lt;p&gt;Hello, I&apos;ve added a comment to the PR. About the otel2 component, then you need to check the camel-telemetry component (the abstraction which will eventually replace camel-tracing), the SpanDecoration logic is the same, have a look at &lt;a href=&quot;https://github.com/apache/camel/tree/main/components/camel-telemetry/src/main/java/org/apache/camel/telemetry/decorators&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/tree/main/components/camel-telemetry/src/main/java/org/apache/camel/telemetry/decorators&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            34 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1upo0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>