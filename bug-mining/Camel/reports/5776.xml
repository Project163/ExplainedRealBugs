<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:48:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-16704] camel-ahc - Requests getting timed out because the threads assigned to channels are busy</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-16704</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;Requests are getting timed out while waiting for the threads assigned to a channel because the thread is busy executing some other work.&lt;/p&gt;

&lt;p&gt;Below is a simple camel route with a processor to imitate a long running activity by sleeping thread, camel-ahc component, and a processor to log the output. The above steps are running in a loop for two times.&#160;&lt;/p&gt;

&lt;p&gt;Direct(source) -&amp;gt; Loop (2) -&amp;gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;Processor to imitate a long running&#160; activity -&amp;gt; AHC component -&amp;gt; Processor to log body -&amp;gt; Mock Output&lt;/p&gt;

&lt;p&gt;I fired two async calls with a small delay between them. For the first call, after completing the long running activity, the message reached AHC component. The response was received and it was processed successfully by the Netty thread. After this all the activities are done by Netty thread and it starts processing the long running activity (since it is running in a loop).&lt;/p&gt;

&lt;p&gt;Meanwhile, the call with the second message completed the long running activity and message will reach the AHC component. Netty will assign the same channel which was assigned to the first message. Now it will wait for the thread to be available to process the response and this thread is busy performing the long running activity and eventually the requests times out.&#160;&lt;/p&gt;

&lt;p&gt;Below are some important logs I extracted from the version 2.24.3. From the logs, it is clear that the channel with id &apos;0xbc4290ed&apos; is assigned for both HTTP calls and request times out waiting for the thread named &apos;AHC-NETTY-COMMON-1-1&apos;.&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&lt;/p&gt;

&lt;p&gt;I have attached JUnits for all 3 versions with folder name &apos;217&apos;, &apos;224&apos; and &apos;301&apos;. Each folder will have JUnit for that particular version, Detailed TRACE log named &apos;Detailed_Logs_XXX.log&apos; and important logs I extracted in a file named &apos;Important_Logs.txt&apos;&lt;/p&gt;

&lt;p&gt;17:44:38| Camel (camel-1) thread #1 - ProducerTemplate | ThreadDelay.java 39 ## Camel (camel-1) thread #1 - ProducerTemplate going into sleep... Exchange Id :: ID-W-PF26MQZL-1622808877625-0-1.&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&lt;/p&gt;

&lt;p&gt;17:44:38| Camel (camel-1) thread #1 - ProducerTemplate | ThreadDelay.java 39 ## Camel (camel-1) thread #1 - ProducerTemplate going into sleep... Exchange Id :: ID-W-PF26MQZL-1622808877625-0-1.&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&lt;/p&gt;

&lt;p&gt;17:44:41| Camel (camel-1) thread #2 - ProducerTemplate | ThreadDelay.java 39 ## Camel (camel-1) thread #2 - ProducerTemplate going into sleep... Exchange Id :: ID-W-PF26MQZL-1622808877625-0-2.&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&lt;/p&gt;

&lt;p&gt;17:44:42| Camel (camel-1) thread #1 - ProducerTemplate | ThreadDelay.java 41 ## Camel (camel-1) thread #1 - ProducerTemplate woke up from sleep... Exchange Id :: ID-W-PF26MQZL-1622808877625-0-1.&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&lt;/p&gt;

&lt;p&gt;17:44:42| Camel (camel-1) thread #1 - ProducerTemplate | AhcProducer.java 53 ## Executing request &lt;a href=&quot;https://www.boredapi.com/api/activity&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://www.boredapi.com/api/activity&lt;/a&gt; GET headers: breadcrumbId:ID-W-PF26MQZL-1622808877625-0-1&#160;&lt;/p&gt;

&lt;p&gt;17:44:44| AHC-NETTY-COMMON-1-1 | NettyConnectListener.java 73 ## Using new Channel &apos;&lt;span class=&quot;error&quot;&gt;&amp;#91;id: 0xbc4290ed, L:/10.16.84.166:62334 - R:www.boredapi.com/34.201.80.84:443&amp;#93;&lt;/span&gt;&apos; for &apos;GET&apos; to &apos;/api/activity&apos;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&lt;/p&gt;

&lt;p&gt;17:44:44| AHC-NETTY-COMMON-1-1 | ThreadDelay.java 48 ## AHC-NETTY-COMMON-1-1 Exchange Id :: ID-W-PF26MQZL-1622808877625-0-1 :: Body received :: {&quot;activity&quot;:&quot;Have a picnic with some friends&quot;,&quot;type&quot;:&quot;social&quot;,&quot;participants&quot;:3,&quot;price&quot;:0.1,&quot;link&quot;:&quot;&quot;,&quot;key&quot;:&quot;6813070&quot;,&quot;accessibility&quot;:0.1}.&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&lt;/p&gt;

&lt;p&gt;17:44:44| AHC-NETTY-COMMON-1-1 | ThreadDelay.java 39 ## AHC-NETTY-COMMON-1-1 going into sleep... Exchange Id :: ID-W-PF26MQZL-1622808877625-0-1.&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&lt;/p&gt;

&lt;p&gt;17:44:44| Camel (camel-1) thread #2 - ProducerTemplate | ThreadDelay.java 41 ## Camel (camel-1) thread #2 - ProducerTemplate woke up from sleep... Exchange Id :: ID-W-PF26MQZL-1622808877625-0-2.&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&lt;/p&gt;

&lt;p&gt;17:44:44| Camel (camel-1) thread #2 - ProducerTemplate | AhcProducer.java 53 ## Executing request &lt;a href=&quot;https://www.boredapi.com/api/activity&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://www.boredapi.com/api/activity&lt;/a&gt; GET headers: breadcrumbId:ID-W-PF26MQZL-1622808877625-0-2&#160; &#160;&lt;/p&gt;

&lt;p&gt;17:44:44| Camel (camel-1) thread #2 - ProducerTemplate | NettyRequestSender.java 579 ## Using pooled Channel &apos;&lt;span class=&quot;error&quot;&gt;&amp;#91;id: 0xbc4290ed, L:/10.16.84.166:62334 - R:www.boredapi.com/34.201.80.84:443&amp;#93;&lt;/span&gt;&apos; for &apos;GET&apos; to &apos;&lt;a href=&quot;https://www.boredapi.com/api/activity&amp;#39;&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://www.boredapi.com/api/activity&apos;&lt;/a&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&lt;/p&gt;

&lt;p&gt;17:44:48| pool-1-thread-1 | TimeoutTimerTask.java 42 ## Request timeout to www.boredapi.com/34.201.80.84:443 after 3000 ms for NettyResponseFuture{currentRetry=0,&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&lt;/p&gt;

&lt;p&gt;17:44:48| AHC-NETTY-COMMON-1-1 | ThreadDelay.java 41 ## AHC-NETTY-COMMON-1-1 woke up from sleep... Exchange Id :: ID-W-PF26MQZL-1622808877625-0-1.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13383149">CAMEL-16704</key>
            <summary>camel-ahc - Requests getting timed out because the threads assigned to channels are busy</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="sveluvil">Sreejith Veluvil</reporter>
                        <labels>
                    </labels>
                <created>Thu, 10 Jun 2021 09:56:39 +0000</created>
                <updated>Tue, 29 Jun 2021 05:28:22 +0000</updated>
                            <resolved>Fri, 25 Jun 2021 09:25:18 +0000</resolved>
                                    <version>2.17.0</version>
                    <version>2.24.3</version>
                    <version>3.0.1</version>
                    <version>3.1.0</version>
                    <version>3.10.0</version>
                                    <fixVersion>3.11.1</fixVersion>
                    <fixVersion>3.12.0</fixVersion>
                                    <component>camel-ahc</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17360714" author="davsclaus" created="Thu, 10 Jun 2021 10:14:49 +0000"  >&lt;p&gt;You are using EOL Camel versions. Can you try with latest release. Also instead of using camel-ahc you can try other http components. &lt;/p&gt;</comment>
                            <comment id="17360748" author="sveluvil" created="Thu, 10 Jun 2021 11:00:19 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Thanks for your reply.&#160;&lt;/p&gt;

&lt;p&gt;Unfortunately it is not possible for us to replace camel-ahc with any other http components since our product has been running for a long time now and it will be a huge change for us. The same issue is there in the version 3.0.1 as well.&lt;/p&gt;

&lt;p&gt;It will be helpful if the issue can be fixed in camel-ahc itself.&#160;&lt;/p&gt;

&lt;p&gt;Thank you&lt;/p&gt;</comment>
                            <comment id="17360750" author="davsclaus" created="Thu, 10 Jun 2021 11:09:09 +0000"  >&lt;p&gt;3.0.1 is a very old release, try with 3.1.0.&lt;br/&gt;
And put together a sample application or unit test that reproduces this problem. And use latest release 3.10.0. We do not support old Camel versions.&lt;/p&gt;</comment>
                            <comment id="17360885" author="sveluvil" created="Thu, 10 Jun 2021 13:12:33 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;I could reproduce the issue with versions 3.1.0 and 3.10.0. Please see attachment &apos;Camel_AHC_Thread_Busy_31X_310X.zip&apos; for unit test case which will reproduce the problem.&lt;/p&gt;

&lt;p&gt;The attachment has 2 folders. Folders are named &apos;3.1.0&apos; and &apos;3.10.0&apos; which has unit test corresponding to that version. Each folder also has a file named &apos;Detailed_Logs_X_X_X.log&apos; which has the detailed TRACE log when the issue got reproduced and a file named &apos;Important_Logs_X_X_X.txt&apos; which has important log statements I copied from the detailed trace log.&#160;&lt;/p&gt;

&lt;p&gt;Please note the problem is not always reproducible, but I was able to reproduce it when I run the test case 10-15 times.&#160;&lt;/p&gt;</comment>
                            <comment id="17361522" author="sveluvil" created="Fri, 11 Jun 2021 07:58:54 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Can you suggest a way to release the Netty thread after processing the response ?&lt;/p&gt;</comment>
                            <comment id="17369354" author="davsclaus" created="Fri, 25 Jun 2021 09:26:17 +0000"  >&lt;p&gt;Thanks for the test cases. I could see that Camel would use the netty thread for continue routing, so this is changed to let camel-ahc have its own worker pool so the netty threads are free and potentially not being blocked by Camel.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13026671" name="Camel-AHC_Thread_Busy_Issue.zip" size="254981" author="sveluvil" created="Thu, 10 Jun 2021 10:01:22 +0000"/>
                            <attachment id="13026686" name="Camel_AHC_Thread_Busy_31X_310X.zip" size="272508" author="sveluvil" created="Thu, 10 Jun 2021 13:13:02 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 20 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0ru40:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>