<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:43:10 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-3769] Mail component issue with starttls option</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-3769</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;The problem occurs when I read from a pop3 endpoint and send to an smtp endpoint in the same camel context with the mail.pop3.starttls.enable=true and mail.smtp.starttls.enable=true options.&lt;/p&gt;

&lt;p&gt;Required Java options for starttls are set:&lt;br/&gt;
-Djavax.net.ssl.trustStore=D:\test\xxx.jks&lt;br/&gt;
-Djavax.net.ssl.trustStorePassword=yyy&lt;/p&gt;


&lt;p&gt;When I only configure one of either route, everything works fine. When I configure both, I get the following exception:&lt;/p&gt;

&lt;p&gt;AUTH LOGIN&lt;br/&gt;
C: STAT&lt;br/&gt;
530 Must issue STARTTLS command first&lt;br/&gt;
STARTTLS&lt;br/&gt;
S: +OK 0 0&lt;br/&gt;
C: NOOP&lt;br/&gt;
220 begin TLS negotiation&lt;br/&gt;
S: +OK&lt;br/&gt;
C: RSET&lt;br/&gt;
S: +OK&lt;br/&gt;
C: QUIT&lt;br/&gt;
AUTH LOGIN&lt;br/&gt;
S: +OK POP3 server closing connection&lt;br/&gt;
503 wrong state for AUTH command&lt;br/&gt;
2011-03-03 10:08:36,797 &lt;span class=&quot;error&quot;&gt;&amp;#91;foo&amp;#93;&lt;/span&gt; ERROR DefaultErrorHandler - Failed delivery for exchangeId: ID-E6500-ahi-61446-1299143304838-0-2. Exhausted after delivery attempt: 1 caught: org.springframework.mail.MailAuthenticationException: Authentication failed; nested exception is javax.mail.AuthenticationFailedException: 503 wrong state for AUTH command&lt;/p&gt;

&lt;p&gt;org.springframework.mail.MailAuthenticationException: Authentication failed; nested exception is javax.mail.AuthenticationFailedException: 503 wrong state for AUTH command&lt;/p&gt;

&lt;p&gt;        at org.springframework.mail.javamail.JavaMailSenderImpl.doSend(JavaMailSenderImpl.java:392)&lt;span class=&quot;error&quot;&gt;&amp;#91;org.springframework.context.support-3.0.5.RELEASE.jar:3.0.5.RELEASE&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.springframework.mail.javamail.JavaMailSenderImpl.send(JavaMailSenderImpl.java:340)&lt;span class=&quot;error&quot;&gt;&amp;#91;org.springframework.context.support-3.0.5.RELEASE.jar:3.0.5.RELEASE&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.springframework.mail.javamail.JavaMailSenderImpl.send(JavaMailSenderImpl.java:355)&lt;span class=&quot;error&quot;&gt;&amp;#91;org.springframework.context.support-3.0.5.RELEASE.jar:3.0.5.RELEASE&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.springframework.mail.javamail.JavaMailSenderImpl.send(JavaMailSenderImpl.java:344)&lt;span class=&quot;error&quot;&gt;&amp;#91;org.springframework.context.support-3.0.5.RELEASE.jar:3.0.5.RELEASE&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.component.mail.MailProducer.process(MailProducer.java:44)&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-mail-2.6.0.jar:2.6.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.impl.converter.AsyncProcessorTypeConverter$ProcessorToAsyncProcessorBridge.process(AsyncProcessorTypeConverter.java:50)&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.6.0.jar:2.6.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.util.AsyncProcessorHelper.process(AsyncProcessorHelper.java:70)&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.6.0.jar:2.6.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.processor.SendProcessor$2.doInAsyncProducer(SendProcessor.java:104)&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.6.0.jar:2.6.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.impl.ProducerCache.doInAsyncProducer(ProducerCache.java:272)&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.6.0.jar:2.6.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.processor.SendProcessor.process(SendProcessor.java:98)&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.6.0.jar:2.6.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.util.AsyncProcessorHelper.process(AsyncProcessorHelper.java:70)&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.6.0.jar:2.6.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.processor.DelegateAsyncProcessor.processNext(DelegateAsyncProcessor.java:98)&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.6.0.jar:2.6.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.processor.DelegateAsyncProcessor.process(DelegateAsyncProcessor.java:89)&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.6.0.jar:2.6.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.management.InstrumentationProcessor.process(InstrumentationProcessor.java:68)&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.6.0.jar:2.6.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.util.AsyncProcessorHelper.process(AsyncProcessorHelper.java:70)&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.6.0.jar:2.6.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.processor.DelegateAsyncProcessor.processNext(DelegateAsyncProcessor.java:98)&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.6.0.jar:2.6.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.processor.DelegateAsyncProcessor.process(DelegateAsyncProcessor.java:89)&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.6.0.jar:2.6.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.processor.interceptor.TraceInterceptor.process(TraceInterceptor.java:99)&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.6.0.jar:2.6.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.util.AsyncProcessorHelper.process(AsyncProcessorHelper.java:70)&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.6.0.jar:2.6.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.processor.RedeliveryErrorHandler.processErrorHandler(RedeliveryErrorHandler.java:299)&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.6.0.jar:2.6.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.processor.RedeliveryErrorHandler.process(RedeliveryErrorHandler.java:208)&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.6.0.jar:2.6.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.processor.DefaultChannel.process(DefaultChannel.java:269)&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.6.0.jar:2.6.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.util.AsyncProcessorHelper.process(AsyncProcessorHelper.java:70)&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.6.0.jar:2.6.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.processor.Pipeline.process(Pipeline.java:125)&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.6.0.jar:2.6.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.processor.Pipeline.process(Pipeline.java:80)&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.6.0.jar:2.6.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.processor.UnitOfWorkProcessor.process(UnitOfWorkProcessor.java:102)&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.6.0.jar:2.6.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.util.AsyncProcessorHelper.process(AsyncProcessorHelper.java:70)&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.6.0.jar:2.6.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.processor.DelegateAsyncProcessor.processNext(DelegateAsyncProcessor.java:98)&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.6.0.jar:2.6.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.processor.DelegateAsyncProcessor.process(DelegateAsyncProcessor.java:89)&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.6.0.jar:2.6.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.processor.RoutePolicyProcessor.process(RoutePolicyProcessor.java:75)&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.6.0.jar:2.6.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.util.AsyncProcessorHelper.process(AsyncProcessorHelper.java:70)&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.6.0.jar:2.6.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.processor.DelegateAsyncProcessor.processNext(DelegateAsyncProcessor.java:98)&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.6.0.jar:2.6.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.processor.DelegateAsyncProcessor.process(DelegateAsyncProcessor.java:89)&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.6.0.jar:2.6.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.management.InstrumentationProcessor.process(InstrumentationProcessor.java:68)&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.6.0.jar:2.6.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.util.AsyncProcessorHelper.process(AsyncProcessorHelper.java:91)&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.6.0.jar:2.6.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.processor.DelegateAsyncProcessor.process(DelegateAsyncProcessor.java:85)&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.6.0.jar:2.6.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.component.timer.TimerConsumer.sendTimerExchange(TimerConsumer.java:104)&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.6.0.jar:2.6.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.component.timer.TimerConsumer$1.run(TimerConsumer.java:49)&lt;span class=&quot;error&quot;&gt;&amp;#91;camel-core-2.6.0.jar:2.6.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at java.util.TimerThread.mainLoop(Unknown Source)&lt;span class=&quot;error&quot;&gt;&amp;#91;:1.5.0_22&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at java.util.TimerThread.run(Unknown Source)&lt;span class=&quot;error&quot;&gt;&amp;#91;:1.5.0_22&amp;#93;&lt;/span&gt;&lt;/p&gt;



&lt;p&gt;The problem seems to be in org.apache.camel.component.mail.MailConfiguration.createJavaMailSender() where it uses the same mail session for both connection; see Session.getDefaultInstance below&lt;/p&gt;

&lt;p&gt;        if (session != null) &lt;/p&gt;
{
            answer.setSession(session);
        }
&lt;p&gt; else {&lt;br/&gt;
            // use our authenticator that does no live user interaction but returns the already configured username and password&lt;br/&gt;
            Session session;&lt;br/&gt;
            try &lt;/p&gt;
{
                session = Session.getDefaultInstance(answer.getJavaMailProperties(), getAuthenticator());
            }
&lt;p&gt; catch (Throwable t) &lt;/p&gt;
{
                // fallback as default instance may not be allowed on some systems
                session = Session.getInstance(answer.getJavaMailProperties(), getAuthenticator());
            }
&lt;p&gt;            answer.setSession(session);&lt;br/&gt;
        }&lt;/p&gt;


&lt;p&gt;This is because getDefaultInstance creates a Session object the first time it is called. Then it caches that Session and returns it for all subsequent calls. It also ignores the new and different properties for the second route.&lt;/p&gt;


&lt;p&gt;See also &lt;a href=&quot;http://camel.465427.n5.nabble.com/Mail-component-with-starttls-td3409505.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://camel.465427.n5.nabble.com/Mail-component-with-starttls-td3409505.html&lt;/a&gt; &lt;/p&gt;</description>
                <environment></environment>
        <key id="12500780">CAMEL-3769</key>
            <summary>Mail component issue with starttls option</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="ahiebl">Alfred Hiebl</reporter>
                        <labels>
                    </labels>
                <created>Tue, 8 Mar 2011 16:08:49 +0000</created>
                <updated>Tue, 25 Oct 2011 11:35:59 +0000</updated>
                            <resolved>Wed, 9 Mar 2011 09:22:07 +0000</resolved>
                                    <version>2.6.0</version>
                                    <fixVersion>2.7.0</fixVersion>
                                    <component>camel-mail</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13004019" author="ahiebl" created="Tue, 8 Mar 2011 16:11:51 +0000"  >&lt;p&gt;I suggest to change this section of the code to always use getInstance instead of getDefaultInstance.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (session != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            answer.setSession(session);
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
            &lt;span class=&quot;code-comment&quot;&gt;// use our authenticator that does no live user interaction but returns the already configured username and password
&lt;/span&gt;            Session session = Session.getInstance(answer.getJavaMailProperties(), getAuthenticator());
            &lt;span class=&quot;code-comment&quot;&gt;// sets the debug mode of the underlying mail framework
&lt;/span&gt;            session.setDebug(debugMode);
            answer.setSession(session);
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13004027" author="ahiebl" created="Tue, 8 Mar 2011 16:16:45 +0000"  >&lt;p&gt;At least in my tests, the debugMode=true did not work either. I think this is beacuse &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;// sets the debug mode of the underlying mail framework
&lt;/span&gt;answer.getSession().setDebug(debugMode);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;creates a Session and sets the debug option for this session object. In the next few line the JavaMailProperties are set&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;answer.setJavaMailProperties()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;which actually resets the Session object in JavaMailSenderImpl answer to null.&lt;/p&gt;</comment>
                            <comment id="13004062" author="ahiebl" created="Tue, 8 Mar 2011 17:02:33 +0000"  >&lt;p&gt;Changes are highlighted with kex word &quot;BUG FIX&quot;&lt;/p&gt;</comment>
                            <comment id="13004433" author="davsclaus" created="Wed, 9 Mar 2011 09:22:07 +0000"  >&lt;p&gt;trunk: 1079708.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12473006" name="MailConfiguration.java" size="15848" author="ahiebl" created="Tue, 8 Mar 2011 17:02:33 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>14165</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 38 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i01ws7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9080</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>