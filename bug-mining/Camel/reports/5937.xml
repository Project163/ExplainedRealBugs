<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:50:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-15333] SJMS transacted producer can lose messages</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-15333</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;Pre-reqs:&#160; SJMS producer with transacted=true, and not linked to a shared session (ReturnProducerCallback chosen in SjmsProducer#process)&lt;/p&gt;

&lt;p&gt;Sequence of events in method InOnlyProducer.sendMessage:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;message is sent successfully by&#160;&#160;producer.getMessageProducer().send(message);&lt;/li&gt;
	&lt;li&gt;producer is returned to pool by releaseProducerCallback.release(producer);&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Override
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void sendMessage(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Exchange exchange, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; AsyncCallback callback, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; MessageProducerResources producer, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ReleaseProducerCallback releaseProducerCallback) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        Message message = getEndpoint().getBinding().makeJmsMessage(exchange, producer.getSession());
        producer.getMessageProducer().send(message);
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
        exchange.setException(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CamelExchangeException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Unable to complete sending the JMS message&quot;&lt;/span&gt;, exchange, e));
    } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
        releaseProducerCallback.release(producer);
        callback.done(isSynchronous());
    }
}
 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;When the producer is returned to the pool, the pool may decide that it should be disposed.&#160; See GenericObjectPool#addToObjectPool.&#160; The variable shouldDestroy can be set to true for a few reasons, but in my case it was because&#160;there were too many idle producers in the pool (_pool.size() &amp;gt;= _maxIdle).&#160;&lt;/p&gt;

&lt;p&gt;When it is destroyed, SjmsProducer$MessageProducerResourcesFactory#destroyObject is called.&#160; If the session is transacted, then this method will&#160;roll it back.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Override
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void destroyObject(MessageProducerResources model) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (model.getMessageProducer() != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
        model.getMessageProducer().close();
    }

    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (model.getSession() != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (model.getSession().getTransacted()) {
                &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                    model.getSession().rollback();
                } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
                    &lt;span class=&quot;code-comment&quot;&gt;// Do nothing. Just make sure we are cleaned up
&lt;/span&gt;                }
            }
            model.getSession().close();
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
            &lt;span class=&quot;code-comment&quot;&gt;// TODO why is the session closed already?
&lt;/span&gt;        }
    }
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;There was only a subtle indication that this happened in the log, with some logging from the JMS client library (qpid in this case) at debug level.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;

2020-07-22 11:34:48.259 DEBUG|mdc.routename|ID-EXCHANGE-1595392487340-0-3| 27108 --- [Camel (camel-1) thread #15 - SjmsBatchConsumer] o.a.camel.component.sjms.SjmsProducer    : Processing Exchange.id:ID-EXCHANGE-1595392487340-0-3
2020-07-22 11:34:48.260 DEBUG|mdc.routename|ID-EXCHANGE-1595392487340-0-3| 27108 --- [Camel (camel-1) thread #15 - SjmsBatchConsumer] o.a.camel.component.sjms2.Sjms2Endpoint  : Creating ConnectionResource with connectionCount: 1 using ConnectionFactory: org.springframework.jms.connection.CachingConnectionFactory@2db98e22
2020-07-22 11:34:49.158 DEBUG||| 27108 --- [AmqpProvider :(1):[amqps:&lt;span class=&quot;code-comment&quot;&gt;//localhost:5672]] o.a.q.j.p.a.AmqpTransactionCoordinator   : New TX started: TX:ID:3ab193ce-faeb-42a2-ab39-1e7a92d1cc58:1:2
&lt;/span&gt;2020-07-22 11:34:49.158 DEBUG|mdc.routename|ID-EXCHANGE-1595392487340-0-3| 27108 --- [Camel (camel-1) thread #15 - SjmsBatchConsumer] o.a.qpid.jms.JmsLocalTransactionContext  : Begin: TX:ID:3ab193ce-faeb-42a2-ab39-1e7a92d1cc58:1:2
2020-07-22 11:34:49.158 DEBUG|mdc.routename|ID-EXCHANGE-1595392487340-0-3| 27108 --- [Camel (camel-1) thread #15 - SjmsBatchConsumer] o.s.j.c.CachingConnectionFactory         : Registering cached JMS Session &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; mode 0: org.apache.qpid.jms.JmsSession@322f173f
2020-07-22 11:34:49.173 DEBUG|mdc.routename|ID-EXCHANGE-1595392487340-0-3| 27108 --- [Camel (camel-1) thread #15 - SjmsBatchConsumer] o.s.j.c.CachingConnectionFactory         : Registering cached JMS MessageProducer &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; destination [queuename]: org.apache.qpid.jms.JmsMessageProducer@24ff95c9
2020-07-22 11:34:49.175 DEBUG|mdc.routename|ID-EXCHANGE-1595392487340-0-3| 27108 --- [Camel (camel-1) thread #15 - SjmsBatchConsumer] o.a.camel.component.sjms.SjmsProducer    :   Sending message synchronously: &amp;lt;?xml version=&lt;span class=&quot;code-quote&quot;&gt;&quot;1.0&quot;&lt;/span&gt; encoding=&lt;span class=&quot;code-quote&quot;&gt;&quot;UTF-8&quot;&lt;/span&gt;?&amp;gt;  (snip)
2020-07-22 11:34:49.201 DEBUG|mdc.routename|ID-EXCHANGE-1595392487340-0-3| 27108 --- [Camel (camel-1) thread #15 - SjmsBatchConsumer] o.a.qpid.jms.JmsLocalTransactionContext  : Rollback: TX:ID:3ab193ce-faeb-42a2-ab39-1e7a92d1cc58:1:2
2020-07-22 11:34:49.207 DEBUG||| 27108 --- [AmqpProvider :(1):[amqps:&lt;span class=&quot;code-comment&quot;&gt;//localhost:5672]] o.a.q.j.p.a.AmqpTransactionCoordinator   : New TX started: TX:ID:3ab193ce-faeb-42a2-ab39-1e7a92d1cc58:1:4
&lt;/span&gt;2020-07-22 11:34:49.367 DEBUG||| 27108 --- [AmqpProvider :(1):[amqps:&lt;span class=&quot;code-comment&quot;&gt;//localhost:5672]] o.a.q.j.p.a.AmqpTransactionCoordinator   : Last TX request succeeded: TX:ID:3ab193ce-faeb-42a2-ab39-1e7a92d1cc58:1:2
&lt;/span&gt;2020-07-22 11:34:49.367 DEBUG|mdc.routename|ID-EXCHANGE-1595392487340-0-3| 27108 --- [Camel (camel-1) thread #15 - SjmsBatchConsumer] o.a.camel.component.sjms.SjmsProducer    : Processing Exchange.id:ID-EXCHANGE-1595392487340-0-3 - SUCCESS
2020-07-22 11:34:49.371 DEBUG|mdc.routename|ID-EXCHANGE-1595392487340-0-3| 27108 --- [Camel (camel-1) thread #15 - SjmsBatchConsumer] .c.s.t.SessionTransactionSynchronization : Processing completion of ExchangeId: ID-EXCHANGE-1595392487340-0-3
2020-07-22 11:34:49.371 DEBUG|mdc.routename|ID-EXCHANGE-1595392487340-0-3| 27108 --- [Camel (camel-1) thread #15 - SjmsBatchConsumer] o.a.qpid.jms.JmsLocalTransactionContext  : Commit: TX:ID:3ab193ce-faeb-42a2-ab39-1e7a92d1cc58:1:4


&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Even the subsequent session.commit() in SessionTransactionSynchronization#onComplete did not fail - I think a new transaction (TX:ID:3ab193ce-faeb-42a2-ab39-1e7a92d1cc58:1:4) was started on the session when the first transaction was rolled back (TX:ID:3ab193ce-faeb-42a2-ab39-1e7a92d1cc58:1:2).&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The end result of this is that InOnlyProducer.sendMessage completes successfully without setting any exception on the exchange, but the message has been rolled back and not sent.&#160; It is lost.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13318925">CAMEL-15333</key>
            <summary>SJMS transacted producer can lose messages</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="2">Won&apos;t Fix</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="bradhgbst">Brad Harvey</reporter>
                        <labels>
                    </labels>
                <created>Thu, 23 Jul 2020 12:20:11 +0000</created>
                <updated>Tue, 5 Jan 2021 13:50:51 +0000</updated>
                            <resolved>Tue, 5 Jan 2021 13:50:51 +0000</resolved>
                                    <version>3.4.1</version>
                                    <fixVersion>3.x</fixVersion>
                                    <component>camel-sjms</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17163511" author="bradhgbst" created="Thu, 23 Jul 2020 12:29:05 +0000"  >&lt;p&gt;The condition that caused too many idle producers in the pool and triggers this bug may be unusual, but we can get it fairly reliably:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;asyncStartListener=true on the sjms-batch consumer and also the sjms producer, though not sure if it does anything on the producer.&lt;/li&gt;
	&lt;li&gt;SSL is enabled - less reliable to reproduce when it is not (maybe makes it take longer to create connections)&lt;/li&gt;
	&lt;li&gt;There are messages ready for the route as soon as the application is started&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;ve only seen it occur upon application startup.&#160; I think this combination might be causing 2 threads to create producers, which then gets dropped back to a single producer in the pool due to the default producer cache size of 1.&lt;/p&gt;</comment>
                            <comment id="17169770" author="davsclaus" created="Mon, 3 Aug 2020 07:12:03 +0000"  >&lt;p&gt;Ah thanks for the detailed report. So I guess we should somehow know if the resource is releases back in the pool due to operation was success, and that if the pool decides to destroy the resource, then we should not rollback any TX sessions. However if for some other &quot;odd&quot; situations then the TX may need to rollback (however if a inflight TX is not comitted, then the TX manager may regard it as failed and rollback it anyway; so we can potentially remove that rollback code in the destroy).&lt;/p&gt;</comment>
                            <comment id="17170216" author="davsclaus" created="Mon, 3 Aug 2020 17:21:09 +0000"  >&lt;p&gt;I wonder if you can build a reproducer using mockito like you did for that other ticket?&lt;/p&gt;</comment>
                            <comment id="17170489" author="bradhgbst" created="Tue, 4 Aug 2020 01:20:30 +0000"  >&lt;p&gt;Hi Claus,&lt;/p&gt;

&lt;p&gt;I&apos;m not really sure what the solution would look like.&#160; The caching model seems to have the producer owning/controlling the session lifecycle which is a bit backwards to how it would normally work and I&apos;m finding a bit hard to reconcile with transacted sessions, which obviously work at the session level.&#160; I&apos;m not even sure if the model.session.close() in destroyObject makes sense for a transacted session.&lt;/p&gt;

&lt;p&gt;The standard JMS component fits our use case so we have switched to that.&#160; Spring boot app (so can use caching connection factory), consumer side is sjms-batch.&#160; In camel 2 we had used the ability of SJMS to loop over collections but with that gone in 3 we have switched to split in the route + transacted JMS.&lt;/p&gt;

&lt;p&gt;I won&apos;t be able to work on a reproducer for this one since we&apos;re no longer using the component.&#160; I haven&apos;t provided any mockito reproducers for anything, maybe that was someone else &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&#160; Perhaps setting maxIdle to 0 would trigger it.&#160;&lt;/p&gt;

&lt;p&gt;Regards&lt;/p&gt;

&lt;p&gt;Brad&lt;/p&gt;</comment>
                            <comment id="17170751" author="davsclaus" created="Tue, 4 Aug 2020 11:54:07 +0000"  >&lt;p&gt;Yeah it seems a bit backwards with session and producer pooling tied together. &lt;/p&gt;</comment>
                            <comment id="17258929" author="davsclaus" created="Tue, 5 Jan 2021 13:50:51 +0000"  >&lt;p&gt;We are reworking camel-sjms for 3.8 onwards, so its more like spring jms and does not use its own pooling&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10062"><![CDATA[Moderate]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 45 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0h4js:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>