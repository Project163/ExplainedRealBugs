<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:36:01 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-13466] DefaultCamelContext not stopping all routes on doStop()</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-13466</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;Hello,&lt;/p&gt;

&lt;p&gt;after applying &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12980&quot; title=&quot;Bundle in &amp;#39;Active&amp;#39; State but Camel Context not initialized&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12980&quot;&gt;&lt;del&gt;CAMEL-12980&lt;/del&gt;&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;we&apos;re still facing an issue with a failing starting feature and the CXFServlet&#160;&lt;tt&gt;/services&lt;/tt&gt; URL.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;To reproduce&#160;:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;drop the attached JAR in deploy&lt;/li&gt;
	&lt;li&gt;wait for bundle start and failure&lt;/li&gt;
	&lt;li&gt;access &lt;tt&gt;/services&lt;/tt&gt; URL : endpoint + WSDL are listed &amp;gt; is this an expected behaviour?&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;br/&gt;
 For further analysis, it seems to be something missing in camel-core :&lt;/p&gt;

&lt;p&gt;When blueprint fails, the &lt;tt&gt;doStop()&lt;/tt&gt; method is called :&lt;br/&gt;
 &lt;a href=&quot;https://github.com/apache/camel/blob/camel-2.20.1/camel-core/src/main/java/org/apache/camel/impl/DefaultCamelContext.java#L3506&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/blob/camel-2.20.1/camel-core/src/main/java/org/apache/camel/impl/DefaultCamelContext.java#L3506&lt;/a&gt;&lt;br/&gt;
 At that line, it tries to stop only the routes already started, but not the ones failing &lt;b&gt;before&lt;/b&gt; filling &lt;tt&gt;routeStartupOrder&lt;/tt&gt; List.&lt;br/&gt;
 &lt;a href=&quot;https://github.com/apache/camel/blob/camel-2.20.1/camel-core/src/main/java/org/apache/camel/impl/DefaultCamelContext.java#L4041&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/blob/camel-2.20.1/camel-core/src/main/java/org/apache/camel/impl/DefaultCamelContext.java#L4041&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;One of this routes is a CxfConsumer which has already been instanciated, with a server creation :&lt;br/&gt;
 &lt;a href=&quot;https://github.com/apache/camel/blob/camel-2.20.1/components/camel-cxf/src/main/java/org/apache/camel/component/cxf/CxfConsumer.java#L69&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/blob/camel-2.20.1/components/camel-cxf/src/main/java/org/apache/camel/component/cxf/CxfConsumer.java#L69&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Even with &lt;tt&gt;DefaultCamelContext.doStop()&lt;/tt&gt;, the server is still started and available in &lt;tt&gt;/services&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Tried a fix by adding this line in DefaultCamelContext:3502 :&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// fill all the routes to be stopped
&lt;/span&gt;getRouteStartupOrder().addAll(routeServices.values().stream().map(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;::doPrepareRouteToBeStarted).collect(Collectors.toList()));

&lt;span class=&quot;code-comment&quot;&gt;// stop route inputs in the same order as they was started so we stop the very first inputs first
&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
 &lt;span class=&quot;code-comment&quot;&gt;// force shutting down routes as they may otherwise cause shutdown to hang
&lt;/span&gt;...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;And now the endpoint isn&apos;t available anymore.&lt;br/&gt;
 But this fix isn&apos;t effective enough as &lt;tt&gt;getRouteStartupOrder()&lt;/tt&gt; may have duplicates?&lt;/p&gt;

&lt;p&gt;Thanks,&lt;/p&gt;</description>
                <environment></environment>
        <key id="13230699">CAMEL-13466</key>
            <summary>DefaultCamelContext not stopping all routes on doStop()</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbonofre">Jean-Baptiste Onofr&#233;</assignee>
                                    <reporter username="jgreffe">Julien Greffe</reporter>
                        <labels>
                    </labels>
                <created>Mon, 29 Apr 2019 13:43:33 +0000</created>
                <updated>Tue, 2 Jul 2019 09:04:55 +0000</updated>
                            <resolved>Tue, 2 Jul 2019 09:04:55 +0000</resolved>
                                    <version>2.20.1</version>
                                    <fixVersion>2.23.4</fixVersion>
                    <fixVersion>2.24.2</fixVersion>
                    <fixVersion>3.0.0.M4</fixVersion>
                    <fixVersion>3.0.0</fixVersion>
                    <fixVersion>2.25.0</fixVersion>
                                    <component>camel-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="16833617" author="gzres" created="Mon, 6 May 2019 09:04:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ancosen&quot; class=&quot;user-hover&quot; rel=&quot;ancosen&quot;&gt;ancosen&lt;/a&gt; I&apos;m not sure it&apos;s OSGi related... &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-12980&quot; title=&quot;Bundle in &amp;#39;Active&amp;#39; State but Camel Context not initialized&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-12980&quot;&gt;&lt;del&gt;CAMEL-12980&lt;/del&gt;&lt;/a&gt; was about detecting Camel context problems and reflecting them in OSGi status, but not vice versa.&lt;br/&gt;
Do you think this can be &lt;em&gt;fixed&lt;/em&gt; generally for Camel Context (without relation to OSGi/SB/default)?&lt;/p&gt;</comment>
                            <comment id="16833619" author="jbonofre" created="Mon, 6 May 2019 09:06:00 +0000"  >&lt;p&gt;I&apos;m starting to work on this issue, first checking outside of OSGi/Karaf to see if it&apos;s OSGi related or Camel general. I will verify in log messages.&lt;/p&gt;</comment>
                            <comment id="16833695" author="ancosen" created="Mon, 6 May 2019 10:54:07 +0000"  >&lt;p&gt;Can you please use a newer version and check? We don&apos;t release 2.20.x from a while&lt;/p&gt;</comment>
                            <comment id="16838351" author="jbonofre" created="Mon, 13 May 2019 08:10:01 +0000"  >&lt;p&gt;I&apos;m now testing with 2.21.5, on a simple example in a &lt;tt&gt;Main&lt;/tt&gt; (not in Karaf).&lt;/p&gt;</comment>
                            <comment id="16839100" author="jbonofre" created="Tue, 14 May 2019 05:54:19 +0000"  >&lt;p&gt;I have a fix, I&apos;m opening the corresponding PR.&lt;/p&gt;</comment>
                            <comment id="16854298" author="davsclaus" created="Mon, 3 Jun 2019 07:18:52 +0000"  >&lt;p&gt;Jean any update on this with you working on unit test&lt;/p&gt;</comment>
                            <comment id="16859994" author="jbonofre" created="Mon, 10 Jun 2019 13:21:33 +0000"  >&lt;p&gt;The test is not so easy to do. I tried something like this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            camelContext.addRoutes(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RouteBuilder() {
                @Override
                &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void configure() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
                    &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IllegalStateException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Starting failure&quot;&lt;/span&gt;);
                }
            });
            camelContext.start();
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
            &lt;span class=&quot;code-comment&quot;&gt;// nothing to &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt;
&lt;/span&gt;        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;but it&apos;s not exactly the same case as here the CamelContext doesn&apos;t start at all. I would need some help for the test.&lt;/p&gt;

&lt;p&gt;Anyway,  the fix has been tested successfully &quot;at runtime&quot;.&lt;/p&gt;</comment>
                            <comment id="16862761" author="davsclaus" created="Thu, 13 Jun 2019 06:37:45 +0000"  >&lt;p&gt;Okay the CxfConsumer is wrong, it should never do such logic in its constructor, such init logic should be in doInit / doStart etc. So that should be fixed too.&lt;/p&gt;</comment>
                            <comment id="16862763" author="davsclaus" created="Thu, 13 Jun 2019 06:41:14 +0000"  >&lt;p&gt;That test with throwing an exception in the route builder is wrong, you need to do this from a route consumer in its doStart etc. I can help with this later. &lt;/p&gt;

&lt;p&gt;I think the current PR needs to be polished and the commented out code removed, also a better code comment why we do this, and we need 2x PRs one for camel-2.x branch and another for master.&lt;/p&gt;</comment>
                            <comment id="16862838" author="jbonofre" created="Thu, 13 Jun 2019 08:48:43 +0000"  >&lt;p&gt;It sounds good. Let me update the PR. Thanks a lot &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt; !&lt;/p&gt;</comment>
                            <comment id="16876771" author="davsclaus" created="Tue, 2 Jul 2019 08:25:29 +0000"  >&lt;p&gt;Okay I found some time to work on this and have a working fix with unit test.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13239276">CAMEL-13644</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12967379" name="sample-dozer-route-2.0.0-SNAPSHOT.jar" size="356310" author="jgreffe" created="Mon, 29 Apr 2019 13:43:50 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 20 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z028mo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>