<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:20:51 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-10272] Unexpected behaviour in aggregator if recipient list is processed in parallel</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-10272</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;h3&gt;&lt;a name=&quot;Problem&quot;&gt;&lt;/a&gt;Problem&lt;/h3&gt;

&lt;p&gt;The &lt;tt&gt;oldExchange&lt;/tt&gt; is &lt;tt&gt;null&lt;/tt&gt; more than once in the aggregator if a recipient list is processed in parallel.&lt;/p&gt;

&lt;h3&gt;&lt;a name=&quot;Camelroute&quot;&gt;&lt;/a&gt;Camel route&lt;/h3&gt;

&lt;p&gt;In my Camel route, a recipient list is worked of in parallel:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; from(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:start&quot;&lt;/span&gt;)
    .to(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:pre&quot;&lt;/span&gt;)
    .recipientList().method(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MyRecipientListBuilder())
        .stopOnException()
        .aggregationStrategy(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MyAggregationStrategy())
        .parallelProcessing()
    .end()
    .bean(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MyPostProcessor());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Snippet of &lt;tt&gt;MyAggregationStrategy&lt;/tt&gt;:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;@Override
@SuppressWarnings(&lt;span class=&quot;code-quote&quot;&gt;&quot;unchecked&quot;&lt;/span&gt;)
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Exchange aggregate(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Exchange oldExchange, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Exchange newExchange) {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (oldExchange == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
        &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; is the &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; more than once which is not expected!
&lt;/span&gt;    }
    &lt;span class=&quot;code-comment&quot;&gt;// ...&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;tt&gt;oldExchange&lt;/tt&gt; is null more than once which is not expected and which contradicts the contract with Camel.&lt;/p&gt;

&lt;h3&gt;&lt;a name=&quot;Analysis&quot;&gt;&lt;/a&gt;Analysis&lt;/h3&gt;

&lt;p&gt;Unfortunately, I am not able to provide a (simple) unit test for comprehending the problem. Furthermore our (complex) unit tests are not deterministic due to the root cause of the problem.&lt;/p&gt;

&lt;p&gt;During the processing, Camel invokes &lt;tt&gt;ParallelAggregateTask.doAggregateInternal()&lt;/tt&gt;. If aggregation is not done in parallel (as it is the case in our route), this is supposed to be done synchronously:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void doAggregateInternal(AggregationStrategy strategy, AtomicExchange result, Exchange exchange) {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (strategy != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
        &lt;span class=&quot;code-comment&quot;&gt;// prepare the exchanges &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; aggregation
&lt;/span&gt;        Exchange oldExchange = result.get();
        ExchangeHelper.prepareAggregation(oldExchange, exchange);
        result.set(strategy.aggregate(oldExchange, exchange));
    }
} 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;However, is it possible that we face a race condition in &lt;tt&gt;doAggregateInternal&lt;/tt&gt; even if this method is supposed to be invoked synchronously?&lt;/p&gt;</description>
                <environment>&lt;p&gt;MacOS 10.11.6, JRE 1.7.0_79&lt;/p&gt;</environment>
        <key id="13000301">CAMEL-10272</key>
            <summary>Unexpected behaviour in aggregator if recipient list is processed in parallel</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="Peter Keller">Peter Keller</reporter>
                        <labels>
                    </labels>
                <created>Fri, 26 Aug 2016 07:46:36 +0000</created>
                <updated>Mon, 2 Jan 2017 14:18:43 +0000</updated>
                            <resolved>Sun, 1 Jan 2017 15:01:25 +0000</resolved>
                                    <version>2.16.3</version>
                    <version>2.17.3</version>
                                    <fixVersion>2.19.0</fixVersion>
                                    <component>camel-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="15446658" author="ushnash@gmail.com" created="Mon, 29 Aug 2016 18:25:04 +0000"  >&lt;p&gt;I&apos;ll take a look at this.&lt;/p&gt;</comment>
                            <comment id="15693955" author="githubbot" created="Thu, 24 Nov 2016 18:18:36 +0000"  >&lt;p&gt;GitHub user aldettinger opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/1310&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/1310&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    CAMEL 10272: Fixed few comments&lt;/p&gt;

&lt;p&gt;    Note that this PR does not fix &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-10272&quot; title=&quot;Unexpected behaviour in aggregator if recipient list is processed in parallel&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-10272&quot;&gt;&lt;del&gt;CAMEL-10272&lt;/del&gt;&lt;/a&gt;(&lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-10272&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CAMEL-10272&lt;/a&gt;). I&apos;ll post on the issue tracker directly to details my findings.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/aldettinger/camel&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/aldettinger/camel&lt;/a&gt; master&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/1310.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/1310.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1310&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 42efb4ef220beb26e8a49c7e729c81d3e0054a63&lt;br/&gt;
Author: aldettinger &amp;lt;aldettinger@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-11-24T18:00:02Z&lt;/p&gt;

&lt;p&gt;    CAMEL 10272: Fixed few comments&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15693983" author="aldettinger" created="Thu, 24 Nov 2016 18:33:11 +0000"  >&lt;p&gt;I don&apos;t think that we are facing such a simple race condition here. In the method &lt;em&gt;doAggregateInternal(...)&lt;/em&gt;, &lt;em&gt;result.get(...)&lt;/em&gt; and &lt;em&gt;result.set(...)&lt;/em&gt; are not run concurrently.&lt;br/&gt;
A single thread is used at aggregation time, in the provided example at least.&lt;/p&gt;

&lt;p&gt;However, &lt;em&gt;oldExchange&lt;/em&gt; could be null more than once when the user custom aggregation strategy throws a runtime exception:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Router {
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] routeTo() {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] {&lt;span class=&quot;code-quote&quot;&gt;&quot;log:MSGROUTER_0?level=TRACE&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;log:MSGROUTER_1?level=TRACE&quot;&lt;/span&gt;};
        }
    }    

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; RouteBuilder createRouteBuilder() {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RouteBuilder() {
            @Override
            &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void configure() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
                from(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:start&quot;&lt;/span&gt;).
                recipientList().
                method(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Router()).
                aggregationStrategy(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; AggregationStrategy(){
                    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Exchange aggregate(Exchange oldExchange, Exchange newExchange) {
                        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (oldExchange == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                            &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;oldExchange is &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &quot;&lt;/span&gt;+newExchange.getExchangeId()+&lt;span class=&quot;code-quote&quot;&gt;&quot; thread: &quot;&lt;/span&gt;+&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread());
                        }
                        &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(3/0); &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; java.lang.ArithmeticException
&lt;/span&gt;                        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
                    }
                }).
                parallelProcessing().
                end();
            }
        };
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;outputs:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;oldExchange is null ID-alex-42036-1479994398470-0-3 thread: Thread[Camel (camel-1) thread #2 - RecipientList-AggregateTask,5,main]
oldExchange is null ID-alex-42036-1479994398470-0-4 thread: Thread[Camel (camel-1) thread #2 - RecipientList-AggregateTask,5,main]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;That said, I see the following drawbacks with the current implementation:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;The AggregationStrategy class javadoc lists a single case where oldExchange could be null whereas two exists&lt;/li&gt;
	&lt;li&gt;This case could be difficult to debug from a camel user perspective. Camel kind of hides the runtime exception in the custom aggregation strategy.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;From there, I see 2 paths to handle a runtime exception unwind from a custom aggregation strategy:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Produce an ERROR log. We then need to correct the javadoc accordingly.&lt;/li&gt;
	&lt;li&gt;Unwind the exception to the default error handler. Note that this is what happen when parallelProcessing is false.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Any thoughts on the right path then ?&lt;/p&gt;</comment>
                            <comment id="15694189" author="githubbot" created="Thu, 24 Nov 2016 20:50:52 +0000"  >&lt;p&gt;Github user aldettinger closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/1310&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/1310&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15709764" author="peter keller" created="Wed, 30 Nov 2016 21:00:57 +0000"  >&lt;p&gt;Alex, thank you very much for the analysis. &lt;/p&gt;

&lt;p&gt;You are right: if an exception is thrown then &lt;tt&gt;oldExchange&lt;/tt&gt; may be &lt;tt&gt;null&lt;/tt&gt;. As this may be the case in our route, it is mysterious why the exception is thrown in a non-deterministic way (of course the root cause may be another multi-threading issue not directly correlated to Camel).&lt;/p&gt;

&lt;p&gt;Note, if &lt;tt&gt;parallelAggregate()&lt;/tt&gt; is used (as mentioned above we don&apos;t use this setup), then &lt;tt&gt;oldExchange&lt;/tt&gt; may also be null. This can be shown using a debugger with setting a breakpoint in &lt;tt&gt;doAggregateInternal&lt;/tt&gt; on the line with &lt;tt&gt;ExchangeHelper.prepareAggregation&lt;/tt&gt;. Shouldn&apos;t Camel prevent &lt;tt&gt;oldExchange&lt;/tt&gt; to be &lt;tt&gt;null&lt;/tt&gt; in this case?&lt;/p&gt;

&lt;p&gt;The logging of the (possible) exception caused by the aggregation strategy could help to trace down the cause. Of course this could be done in the implementation of the aggregation strategy itself with a try/catch clause without changing the Camel framework. &lt;/p&gt;

&lt;p&gt;Unwinding the exception to the default error handler may break existing routes which is not desirable. That said, I personally would prefer this possibility.&lt;/p&gt;</comment>
                            <comment id="15712463" author="aldettinger" created="Thu, 1 Dec 2016 16:55:29 +0000"  >&lt;p&gt;Peter, thanks for your inputs.&lt;/p&gt;

&lt;p&gt;  As you don&apos;t use &lt;em&gt;parallelAggregate()&lt;/em&gt;, it may not be the cause of this issue.&lt;br/&gt;
However, it&apos;s interesting to note that I could also produce &lt;em&gt;oldExchange&lt;/em&gt; to be null more than once with &lt;em&gt;parallelAggregate()&lt;/em&gt;, even with a thread safe aggregation strategy.&lt;br/&gt;
It may be an itch to scratch in another ticket.&lt;/p&gt;

&lt;p&gt;  Back to this issue, I will propose a PR to log such exceptions in DEBUG level so one could have more details when facing such a situation.&lt;br/&gt;
We could make a great step forward if you could reproduce the behavior once while logging/unwinding throwables from your aggregation strategy.&lt;br/&gt;
Or you could also test against master with debug log level if the PR is accepted.&lt;/p&gt;</comment>
                            <comment id="15712469" author="githubbot" created="Thu, 1 Dec 2016 16:57:15 +0000"  >&lt;p&gt;GitHub user aldettinger opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/1326&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/1326&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-10272&quot; title=&quot;Unexpected behaviour in aggregator if recipient list is processed in parallel&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-10272&quot;&gt;&lt;del&gt;CAMEL-10272&lt;/del&gt;&lt;/a&gt;: Added a debug log and completed the javadoc&lt;/p&gt;

&lt;p&gt;    Please check &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-10272&quot; title=&quot;Unexpected behaviour in aggregator if recipient list is processed in parallel&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-10272&quot;&gt;&lt;del&gt;CAMEL-10272&lt;/del&gt;&lt;/a&gt;(&lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-10272&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CAMEL-10272&lt;/a&gt;) out for more details.&lt;br/&gt;
    sourcecheck and tests are ok.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/aldettinger/camel&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/aldettinger/camel&lt;/a&gt; master&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/1326.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/1326.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1326&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 2e3de5e889241e707054f01f9cf385aea72508fe&lt;br/&gt;
Author: aldettinger &amp;lt;aldettinger@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-12-01T15:48:48Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-10272&quot; title=&quot;Unexpected behaviour in aggregator if recipient list is processed in parallel&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-10272&quot;&gt;&lt;del&gt;CAMEL-10272&lt;/del&gt;&lt;/a&gt;: Added a debug log covering for instance a runtime exception thrown from a custom aggregation strategy&lt;/p&gt;

&lt;p&gt;commit b522d465467946a2640630e87d0854298c978953&lt;br/&gt;
Author: aldettinger &amp;lt;aldettinger@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-12-01T15:57:06Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-10272&quot; title=&quot;Unexpected behaviour in aggregator if recipient list is processed in parallel&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-10272&quot;&gt;&lt;del&gt;CAMEL-10272&lt;/del&gt;&lt;/a&gt;: Completed the aggregation strategy javadoc&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15715672" author="githubbot" created="Fri, 2 Dec 2016 17:08:56 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/1326&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/1326&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15717708" author="peter keller" created="Sat, 3 Dec 2016 08:28:01 +0000"  >&lt;p&gt;Alex thank you for the patch.&lt;/p&gt;

&lt;p&gt;I updated the summary and the description of the issue so that it better suits to the actual problem. I hope that everybody is fine with this.&lt;/p&gt;

&lt;p&gt;The analysis of our problem showed that a &lt;tt&gt;java.util.ConcurrentModificationException&lt;/tt&gt; was thrown in the aggregator. A non thread safe collection was accessed concurrently in every route of the recipient list as well as in the aggregator. This explains properly the unpredictable behaviour.&lt;/p&gt;

&lt;p&gt;Thinking about the solution I think the correct way is to pass the exception to the error handler of the main route, even if this brakes the old behaviour. Perhaps this could be controlled by a new option?&lt;/p&gt;</comment>
                            <comment id="15729803" author="aldettinger" created="Wed, 7 Dec 2016 20:16:42 +0000"  >&lt;p&gt;Peter, happy that you finally sorted this out.&lt;br/&gt;
Implementing a new option is an interesting proposal. This way, some camel users may test the new behavior while the branch remains backward compatible.&lt;br/&gt;
I&apos;ll take a look at this, time permitting.&lt;/p&gt;</comment>
                            <comment id="15780194" author="githubbot" created="Tue, 27 Dec 2016 11:18:03 +0000"  >&lt;p&gt;GitHub user aldettinger opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/1367&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/1367&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-10272&quot; title=&quot;Unexpected behaviour in aggregator if recipient list is processed in parallel&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-10272&quot;&gt;&lt;del&gt;CAMEL-10272&lt;/del&gt;&lt;/a&gt;: Provide an option to stop further processing when an exc&#8230;&lt;/p&gt;

&lt;p&gt;    &#8230;eption is thrown from an aggregation strategy while parallelProcessing is used.&lt;/p&gt;

&lt;p&gt;    The proposed option is backward compatible, could be experimented by camel users on this branch, and may be elected to become the default behavior on a next major release.&lt;/p&gt;

&lt;p&gt;    Check &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-10272&quot; title=&quot;Unexpected behaviour in aggregator if recipient list is processed in parallel&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-10272&quot;&gt;&lt;del&gt;CAMEL-10272&lt;/del&gt;&lt;/a&gt;(&lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-10272&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CAMEL-10272&lt;/a&gt;) out for more details.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/aldettinger/camel&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/aldettinger/camel&lt;/a&gt; master&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/1367.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/1367.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1367&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit f6ec5a03062271886d30b2ccfd6cad4c11a8afbf&lt;br/&gt;
Author: aldettinger &amp;lt;aldettinger@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-12-27T09:55:18Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-10272&quot; title=&quot;Unexpected behaviour in aggregator if recipient list is processed in parallel&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-10272&quot;&gt;&lt;del&gt;CAMEL-10272&lt;/del&gt;&lt;/a&gt;: Provide an option to stop further processing when an exception is thrown from an aggregation strategy while parallelProcessing is used.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15791225" author="davsclaus" created="Sun, 1 Jan 2017 15:01:26 +0000"  >&lt;p&gt;Thanks for the PR&lt;/p&gt;</comment>
                            <comment id="15792936" author="githubbot" created="Mon, 2 Jan 2017 14:18:43 +0000"  >&lt;p&gt;Github user aldettinger closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/1367&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/1367&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10063"><![CDATA[Advanced]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 46 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i32u1z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>