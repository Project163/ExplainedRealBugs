<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 11:11:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-22173] camel-salesforce - Checking initial replay id takes a lot of time or hangs</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-22173</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;we&apos;ve just updated Camel from 4.4 to 4.10 and we&apos;ve noticed an issue which is likely caused by the changes introduced by &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-21740&quot; title=&quot;camel-salesforce - pub/sub API corrupt replay id causes infinite resubscribe loop&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-21740&quot;&gt;&lt;del&gt;CAMEL-21740&lt;/del&gt;&lt;/a&gt;. We&apos;re seeing two issues:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;When a consumer restarts from the latest event (i.e. all the events have already been consumed) then checking the replay id takes exactly 60s. I think this happens because &lt;tt&gt;PubSubApiClient&lt;/tt&gt; sets &lt;tt&gt;FetchRequest.numRequested&lt;/tt&gt; to 1, but there aren&apos;t any events to consume; in this scenario the client waits up to 60s before invoking the callback. I&apos;m not sure where this value is configured (client  side? Server side?). I had a look at the Camel code and couldn&apos;t find this setting anywhere. I&apos;ve also tried to pass &lt;tt&gt;numRequested=0&lt;/tt&gt; and it doesn&apos;t work (it returns immediately but it doesn&apos;t check the replay id at all)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Sometimes the &quot;check initial replay id&quot; call just hangs. Bumping the timeout doesn&apos;t seem to help: we&apos;re using 5 minutes right now and we&apos;re still seeing issues. I&apos;m not sure what&apos;s triggering this behavior; AFAICT after we restart the application the call is always successful.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Based on the comments in &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-21740&quot; title=&quot;camel-salesforce - pub/sub API corrupt replay id causes infinite resubscribe loop&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-21740&quot;&gt;&lt;del&gt;CAMEL-21740&lt;/del&gt;&lt;/a&gt; I understand that the purpose of this check is to avoid using LATEST if the replay id doesn&apos;t exist; I&apos;m wondering if this could be done directly when subscribing to the topic, instead of trying to fetch a single event beforehand.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;lorenzo&lt;/p&gt;</description>
                <environment></environment>
        <key id="13621114">CAMEL-22173</key>
            <summary>camel-salesforce - Checking initial replay id takes a lot of time or hangs</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="lbenvenu">Lorenzo Benvenuti</reporter>
                        <labels>
                    </labels>
                <created>Tue, 17 Jun 2025 13:58:37 +0000</created>
                <updated>Fri, 4 Jul 2025 10:00:57 +0000</updated>
                            <resolved>Fri, 4 Jul 2025 10:00:57 +0000</resolved>
                                    <version>4.10.4</version>
                                    <fixVersion>4.13.0</fixVersion>
                                    <component>camel-salesforce</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17981675" author="davsclaus" created="Wed, 18 Jun 2025 05:46:13 +0000"  >&lt;p&gt;As you have the problem now you are welcome to see if you can improve this and send suggested code patches.&lt;/p&gt;</comment>
                            <comment id="17982697" author="lbenvenu" created="Wed, 18 Jun 2025 12:43:30 +0000"  >&lt;p&gt;I&apos;ve created a quick and dirty PR here: &lt;a href=&quot;https://github.com/apache/camel/pull/18396&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/18396&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I haven&apos;t implemented any tests and the code is pretty rough, but I just wanted to confirm this is a viable approach.&lt;br/&gt;
Basically &lt;tt&gt;PubSubApiClient&lt;/tt&gt; tries to subscribe to a pub/sub channel without checking the replay id and, in case the replay id is not valid, it stops the consumer route (should it stop the consumer only?).&lt;br/&gt;
With the previous implementation an invalid replay id was actually preventing the application from starting, here it just stops the route... but since consuming the stream is an asynchronous operation I don&apos;t think there&apos;s a workaround to that (also, the replay id could become invalid &lt;em&gt;after&lt;/em&gt; the application has been started: it happens if Salesforce rebuilds a topic, and even in this case I think that starting from the latest index is not always the safest choice) &lt;/p&gt;</comment>
                            <comment id="17982714" author="davsclaus" created="Wed, 18 Jun 2025 13:51:18 +0000"  >&lt;p&gt;Thanks for the draft PR. I dont think it should stop the route, as that is for the end user to decide what should happens. The mantra of Camel is to fail fast if something is not correct. You can use route controller to tell Camel to keep restarting routes if they fail on startup. So you should use that if you want Camel to keep starting the rest of the app.&lt;/p&gt;</comment>
                            <comment id="17982742" author="lbenvenu" created="Wed, 18 Jun 2025 15:45:14 +0000"  >&lt;p&gt;In this case the route won&apos;t fail on startup though, because the process is asynchronous. I believe the only option would be waiting until the GRPC call returns in &lt;tt&gt;doStart&lt;/tt&gt; but we may end up having the same issues that this PR is trying to solve. I stopped the route because the behavior seemed the closest to the previous one (app not starting); other options:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;keep retrying with the current index (and in most cases it will just keep retrying forever, I guess)&lt;/li&gt;
	&lt;li&gt;use &lt;tt&gt;BridgeExceptionHandlerToErrorHandler&lt;/tt&gt; to surface the exception in the route (should we stop the subscription and let route restarting the consumer if needed, or should we keep trying to reconnect?)&lt;/li&gt;
	&lt;li&gt;use a pluggable strategy (overkill?)&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17987146" author="lbenvenu" created="Tue, 1 Jul 2025 08:39:15 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt; do you have any thoughts on the solutions listed above? Thanks&lt;/p&gt;</comment>
                            <comment id="17988063" author="davsclaus" created="Thu, 3 Jul 2025 05:45:55 +0000"  >&lt;p&gt;Thanks I added some comments on the PR&lt;/p&gt;</comment>
                            <comment id="17993132" author="davsclaus" created="Thu, 3 Jul 2025 17:27:11 +0000"  >&lt;p&gt;Lorenzo, it would be good to add the option to the component level also, so you can configure it globally, and then if needed per endpoint (override).&lt;/p&gt;

&lt;p&gt;And add a note in the 4.13 upgrade guide that the old option is (removed) and that you should use the new option instead. its currently marked as deprecated and not in use, so we can just remove it on main branch.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17993526" author="lbenvenu" created="Fri, 4 Jul 2025 06:07:20 +0000"  >&lt;p&gt;Hi, sure! I&apos;ll create a couple of PRs ASAP. Thanks!&lt;/p&gt;</comment>
                            <comment id="17995708" author="davsclaus" created="Fri, 4 Jul 2025 08:49:49 +0000"  >&lt;p&gt;Are you doing a new PR on the component level option&lt;/p&gt;</comment>
                            <comment id="17995715" author="lbenvenu" created="Fri, 4 Jul 2025 09:14:58 +0000"  >&lt;p&gt;I&apos;ve just submitted it, &lt;a href=&quot;https://github.com/apache/camel/pull/18538&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/18538&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17995727" author="davsclaus" created="Fri, 4 Jul 2025 10:00:57 +0000"  >&lt;p&gt;Thanks for the help&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            18 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1wd6o:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>