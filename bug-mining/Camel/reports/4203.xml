<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:24:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-11609] camel-univocity-parsers: marshaller not thread safe</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-11609</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;org.apache.camel.dataformat.univocity.Marshaller.java is not thread safe.&lt;/p&gt;

&lt;p&gt;When this.adaptheaders is true, this.headers is modified in the wirteRow() method. This can lead to ConcurrentModificationExceptions (see below) and jumbled headers, occasionally.&lt;/p&gt;

&lt;p&gt;I use a &lt;tt&gt;UnivocityCsvDataFormat&lt;/tt&gt; for marshalling CSV in a route which is called in parallel. The DataFormat creates a Marshaller with adaptheaders == true when headers are not specified in the format.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.util.ConcurrentModificationException: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
            at java.util.LinkedHashMap$LinkedHashIterator.nextNode(LinkedHashMap.java:719)
            at java.util.LinkedHashMap$LinkedKeyIterator.next(LinkedHashMap.java:742)
            at org.apache.camel.dataformat.univocity.Marshaller.writeRow(Marshaller.java:95)
            at org.apache.camel.dataformat.univocity.Marshaller.marshal(Marshaller.java:67)
            at org.apache.camel.dataformat.univocity.AbstractUniVocityDataFormat.marshal(AbstractUniVocityDataFormat.java:94)
            at org.apache.camel.processor.MarshalProcessor.process(MarshalProcessor.java:69)
            at org.apache.camel.management.InstrumentationProcessor.process(InstrumentationProcessor.java:77)
            at org.apache.camel.processor.RedeliveryErrorHandler.process(RedeliveryErrorHandler.java:541)
            at org.apache.camel.processor.CamelInternalProcessor.process(CamelInternalProcessor.java:198)
            at org.apache.camel.processor.Pipeline.process(Pipeline.java:120)
            at org.apache.camel.processor.Pipeline.process(Pipeline.java:83)
            at org.apache.camel.processor.CamelInternalProcessor.process(CamelInternalProcessor.java:198)
            at org.apache.camel.component.direct.DirectProducer.process(DirectProducer.java:62)
            at org.apache.camel.processor.SendDynamicProcessor$1.doInAsyncProducer(SendDynamicProcessor.java:124)
            at org.apache.camel.impl.ProducerCache.doInAsyncProducer(ProducerCache.java:436)
            at org.apache.camel.processor.SendDynamicProcessor.process(SendDynamicProcessor.java:119)
            at org.apache.camel.processor.RedeliveryErrorHandler.process(RedeliveryErrorHandler.java:541)
            at org.apache.camel.processor.CamelInternalProcessor.process(CamelInternalProcessor.java:198)
            at org.apache.camel.processor.DelegateAsyncProcessor.process(DelegateAsyncProcessor.java:97)
            at org.apache.camel.processor.WireTapProcessor$1.call(WireTapProcessor.java:137)
            at org.apache.camel.processor.WireTapProcessor$1.call(WireTapProcessor.java:133)
            at java.util.concurrent.FutureTask.run(FutureTask.java:266)
            at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
            at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
            at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13090448">CAMEL-11609</key>
            <summary>camel-univocity-parsers: marshaller not thread safe</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="acosentino">Andrea Cosentino</assignee>
                                    <reporter username="derdb">Daniel Baldes</reporter>
                        <labels>
                    </labels>
                <created>Thu, 27 Jul 2017 08:15:14 +0000</created>
                <updated>Tue, 1 Aug 2017 13:02:51 +0000</updated>
                            <resolved>Tue, 1 Aug 2017 11:33:37 +0000</resolved>
                                    <version>2.19.1</version>
                                    <fixVersion>2.20.0</fixVersion>
                                    <component>camel-csv</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16102924" author="onders" created="Thu, 27 Jul 2017 08:27:04 +0000"  >&lt;p&gt;Failing unit test would be helpful&lt;/p&gt;

&lt;p&gt;by the stacktrace i see you have such a route where you wireTapped to a direct endpoint. Hard to imagine beyond.&lt;/p&gt;
</comment>
                            <comment id="16102928" author="derdb" created="Thu, 27 Jul 2017 08:32:56 +0000"  >&lt;p&gt;Providing a unit test is difficult; we have one integration test which fails in about 1 in 100 cases due to this issue.&lt;/p&gt;

&lt;p&gt;Given that the Marshaller holds and modifies a state in this.headers, it is obvious that it is not thread safe, though.&lt;/p&gt;</comment>
                            <comment id="16102941" author="onders" created="Thu, 27 Jul 2017 08:42:55 +0000"  >&lt;p&gt;I did not mean to argue it is obvious or not.&lt;/p&gt;

&lt;p&gt;As you can see;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/camel/blob/master/components/camel-univocity-parsers/src/main/java/org/apache/camel/dataformat/univocity/Marshaller.java#L38&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/blob/master/components/camel-univocity-parsers/src/main/java/org/apache/camel/dataformat/univocity/Marshaller.java#L38&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;LinkedHashMap is not thread-safe.&lt;/p&gt;

&lt;p&gt;What i wanted to understand your routing structure, maybe to help you suggest a workaround.&lt;/p&gt;

&lt;p&gt;PR is much welcome with maybe with just &lt;tt&gt;Collections.synchronizedMap(this.headers);&lt;/tt&gt;.&lt;br/&gt;
Camel loves contribution.&lt;/p&gt;

</comment>
                            <comment id="16102963" author="derdb" created="Thu, 27 Jul 2017 08:54:55 +0000"  >&lt;p&gt;We have a workaround because in this case, we can specify fixed headers (which leads to this.adaptheaders == false, i.e. headers are not modified, so no issue).&lt;/p&gt;

&lt;p&gt;Our routing structure is roughly as follows.  There is a &quot;direct:persistCSV&quot; route which uses marshal(univocityCsvDataFormat). This route may be called in parallel by multiple other routes (via to(&quot;direct:persistCSV&quot;)), these use split() and streaming(). Unfortunately I don&apos;t know much about camel and its threading model as I&apos;m new to this project, so it is entirely possible that we are doing something wrong. So the question remains if this Marshaller is supposed to work in a multi-threaded environment at all - if it is, then this is an issue.&lt;/p&gt;

&lt;p&gt;Simply using a synchronizedMap would rule out ConcurrentModificationException as far as I can tell, but in order to not get jumbled headers, they should not be kept and updated in the Marshaller instance at all I think - either always read the headers from this.headers and never change it, or read headers from the map into a local variable in the adaptheaders == true case. I don&apos;t know why changing headers would need to be kept as Marshaller state.&lt;/p&gt;</comment>
                            <comment id="16103900" author="onders" created="Thu, 27 Jul 2017 20:56:54 +0000"  >&lt;p&gt;As far as i can understand field matching is through the reconstruction of &lt;tt&gt;this.headers&lt;/tt&gt;. so it is important part.&lt;br/&gt;
so my view currently, if you don&apos;t have frequently changing headers, it should not be problem. If it is to match the fields it seems lock on the resource getting updated seems to be a price to pay. in such sence providing a simple PR.&lt;/p&gt;</comment>
                            <comment id="16103904" author="githubbot" created="Thu, 27 Jul 2017 21:01:36 +0000"  >&lt;p&gt;GitHub user onders86 opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/1855&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/1855&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-11609&quot; title=&quot;camel-univocity-parsers: marshaller not thread safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-11609&quot;&gt;&lt;del&gt;CAMEL-11609&lt;/del&gt;&lt;/a&gt;:thread-safety if headers get modified on the fly&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/onders86/camel&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/onders86/camel&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-11609&quot; title=&quot;camel-univocity-parsers: marshaller not thread safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-11609&quot;&gt;&lt;del&gt;CAMEL-11609&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/1855.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/1855.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1855&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit d6ae2bfd0ba2bb7826e7b342094406a3daf4a85b&lt;br/&gt;
Author: onders86 &amp;lt;ondersezgin@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-07-27T20:54:18Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-11609&quot; title=&quot;camel-univocity-parsers: marshaller not thread safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-11609&quot;&gt;&lt;del&gt;CAMEL-11609&lt;/del&gt;&lt;/a&gt;:thread-safety if headers get modified on the fly&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16104658" author="githubbot" created="Fri, 28 Jul 2017 08:34:46 +0000"  >&lt;p&gt;Github user onders86 closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/1855&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/1855&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16104670" author="ancosen" created="Fri, 28 Jul 2017 08:46:15 +0000"  >&lt;p&gt;I guess the fix must be reverted, the headers should stay immutable. We were discussing with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zregvart&quot; class=&quot;user-hover&quot; rel=&quot;zregvart&quot;&gt;zregvart&lt;/a&gt; too.&lt;/p&gt;</comment>
                            <comment id="16104672" author="derdb" created="Fri, 28 Jul 2017 08:46:51 +0000"  >&lt;p&gt;This is not going to fix the problem. You&apos;re only syncing on the write access. You need to synchronize both read and write. But this is not even necessary - why keep the headers as marshaller state if they are adapted on every writeRow in the first place. There is no sync needed here. I&apos;m at work now, maybe i can provide a PR when I&apos;m free this weekend&lt;/p&gt;</comment>
                            <comment id="16104673" author="derdb" created="Fri, 28 Jul 2017 08:47:07 +0000"  >&lt;p&gt;See my comment above&lt;/p&gt;</comment>
                            <comment id="16104680" author="onders" created="Fri, 28 Jul 2017 08:56:21 +0000"  >&lt;p&gt;if headers are immutable, is not this already existing UT is wrong?&lt;/p&gt;

&lt;p&gt;Reverted already..&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    /**
     * Tests that the marshalling adds &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; columns on the fly and keep its order
     */
    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void shouldMarshalAndAddNewColumns() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        template.sendBody(&lt;span class=&quot;code-quote&quot;&gt;&quot;direct:&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;&quot;&lt;/span&gt;, Arrays.asList(
                asMap(&lt;span class=&quot;code-quote&quot;&gt;&quot;A&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;B&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;2&quot;&lt;/span&gt;),
                asMap(&lt;span class=&quot;code-quote&quot;&gt;&quot;C&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;three&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;A&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;one&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;B&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;two&quot;&lt;/span&gt;)
        ));

        result.expectedMessageCount(1);
        result.assertIsSatisfied();

        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; body = assertIsInstanceOf(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.class, result.getExchanges().get(0).getIn().getBody());
        assertEquals(join(&lt;span class=&quot;code-quote&quot;&gt;&quot;1,2&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;one,two,three&quot;&lt;/span&gt;), body);
    }

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16104683" author="onders" created="Fri, 28 Jul 2017 08:59:30 +0000"  >&lt;p&gt;if you sync read access, i guess there is potential performance issue and your threading will possibly degrade.&lt;br/&gt;
maybe there is CopyOnWriteXXX collection or such specific implementation may be needed..&lt;/p&gt;</comment>
                            <comment id="16108629" author="githubbot" created="Tue, 1 Aug 2017 09:30:38 +0000"  >&lt;p&gt;GitHub user dbaldes opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/1859&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/1859&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-11609&quot; title=&quot;camel-univocity-parsers: marshaller not thread safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-11609&quot;&gt;&lt;del&gt;CAMEL-11609&lt;/del&gt;&lt;/a&gt;:thread-safety if headers get modified on the fly&lt;/p&gt;

&lt;p&gt;    This synchronized write and read on the headers when an adaption is needed. Unit tests are successful.&lt;/p&gt;

&lt;p&gt;    Potential performance drawback due to synchronization.&lt;/p&gt;


&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/dbaldes/camel&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/dbaldes/camel&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-11609&quot; title=&quot;camel-univocity-parsers: marshaller not thread safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-11609&quot;&gt;&lt;del&gt;CAMEL-11609&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/1859.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/1859.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1859&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit c213d80977cb49c7467d80a378ee50a7fe8a5db8&lt;br/&gt;
Author: Daniel Baldes &amp;lt;daniel@baldes.name&amp;gt;&lt;br/&gt;
Date:   2017-08-01T09:24:46Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-11609&quot; title=&quot;camel-univocity-parsers: marshaller not thread safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-11609&quot;&gt;&lt;del&gt;CAMEL-11609&lt;/del&gt;&lt;/a&gt;:thread-safety if headers get modified on the fly&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16108857" author="githubbot" created="Tue, 1 Aug 2017 13:02:51 +0000"  >&lt;p&gt;Github user dbaldes closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/camel/pull/1859&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/pull/1859&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 16 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3i2tj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>