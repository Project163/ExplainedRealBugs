<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:51:00 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-4556] NettyProducer creating new connection on every message</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-4556</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;Using a NettyProducer without the disconnect=true configuration is causing the route to block after 10 messages on the to(&quot;netty://tcp....&quot;) call.&lt;/p&gt;

&lt;p&gt;It appears that a new socket connection is created for every message, and then after 10 connections no new connection is allowed (must be a default thread pool limit?).&lt;/p&gt;

&lt;p&gt;Using the disconnect=true option fixes the problem as a socket is connected, message sent, then disconnected. But this does not seem viable for implementations where that overhead is undesirable or where more than one response is expected on a channel.&lt;/p&gt;

&lt;p&gt;&amp;#8211;&lt;/p&gt;

&lt;p&gt;This is a small Unit Test that shows the problem (&lt;a href=&quot;http://camel.465427.n5.nabble.com/Camel-Netty-Producer-creating-new-connection-on-every-message-td4844805.html#none&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://camel.465427.n5.nabble.com/Camel-Netty-Producer-creating-new-connection-on-every-message-td4844805.html#none&lt;/a&gt;) &lt;/p&gt;



&lt;p&gt;package netty; &lt;/p&gt;

&lt;p&gt;import java.util.Arrays; &lt;br/&gt;
import java.util.Collection; &lt;br/&gt;
import java.util.concurrent.TimeUnit; &lt;br/&gt;
import java.util.concurrent.atomic.AtomicBoolean; &lt;br/&gt;
import java.util.concurrent.atomic.AtomicInteger; &lt;/p&gt;

&lt;p&gt;import junit.framework.TestCase; &lt;/p&gt;

&lt;p&gt;import org.apache.camel.CamelContext; &lt;br/&gt;
import org.apache.camel.Exchange; &lt;br/&gt;
import org.apache.camel.ExchangePattern; &lt;br/&gt;
import org.apache.camel.Processor; &lt;br/&gt;
import org.apache.camel.builder.RouteBuilder; &lt;br/&gt;
import org.apache.camel.impl.DefaultCamelContext; &lt;br/&gt;
import org.junit.Before; &lt;br/&gt;
import org.junit.BeforeClass; &lt;br/&gt;
import org.junit.Test; &lt;br/&gt;
import org.junit.runner.RunWith; &lt;br/&gt;
import org.junit.runners.Parameterized; &lt;br/&gt;
import org.junit.runners.Parameterized.Parameters; &lt;br/&gt;
import org.slf4j.Logger; &lt;br/&gt;
import org.slf4j.LoggerFactory; &lt;/p&gt;

&lt;p&gt;@RunWith(Parameterized.class) &lt;br/&gt;
public class NettyTest extends TestCase &lt;br/&gt;
{ &lt;br/&gt;
    private final static Logger logger = LoggerFactory.getLogger(NettyTest.class); &lt;br/&gt;
    private final static CamelContext serverContext = new DefaultCamelContext(); &lt;/p&gt;

&lt;p&gt;    private final CamelContext clientContext = new DefaultCamelContext(); &lt;br/&gt;
    private final AtomicInteger responseCounter = new AtomicInteger(0); &lt;br/&gt;
    private final AtomicBoolean passedTen = new AtomicBoolean(false); &lt;/p&gt;

&lt;p&gt;    private Boolean disconnectClient; &lt;/p&gt;

&lt;p&gt;    public NettyTest(Boolean disconnectClient) &lt;/p&gt;
    { 
        this.disconnectClient = disconnectClient; 
    } 

&lt;p&gt;    @Parameters &lt;br/&gt;
    public static Collection&amp;lt;Object[]&amp;gt; configs() &lt;br/&gt;
    { &lt;br/&gt;
        return Arrays.asList(new Object[][] { &lt;/p&gt;
{ true }
&lt;p&gt;, &lt;/p&gt;
{ false }
&lt;p&gt; }); &lt;br/&gt;
    } &lt;/p&gt;

&lt;p&gt;    @BeforeClass &lt;br/&gt;
    public static void createServer() throws Exception &lt;br/&gt;
    { &lt;br/&gt;
        serverContext.addRoutes(new RouteBuilder() &lt;br/&gt;
        { &lt;br/&gt;
            @Override &lt;br/&gt;
            public void configure() throws Exception &lt;br/&gt;
            { &lt;br/&gt;
                from(&quot;netty:tcp://localhost:9000?sync=true&amp;amp;disconnectOnNoReply=false&amp;amp;allowDefaultCodec=true&amp;amp;tcpNoDelay=true&amp;amp;reuseAddress=true&amp;amp;keepAlive=false&quot;) &lt;br/&gt;
                        .setExchangePattern(ExchangePattern.InOut) &lt;br/&gt;
                        .process(new Processor() { &lt;/p&gt;

&lt;p&gt;                            @Override &lt;br/&gt;
                            public void process(Exchange exchange) throws Exception &lt;br/&gt;
                            { &lt;br/&gt;
                                Object body = exchange.getIn().getBody(); &lt;br/&gt;
                                logger.info(&quot;Request received : Value = {}&quot;, body); &lt;br/&gt;
                            } &lt;/p&gt;

&lt;p&gt;                        }) &lt;br/&gt;
                        .transform(constant(3)).stop(); &lt;br/&gt;
            } &lt;br/&gt;
        }); &lt;/p&gt;

&lt;p&gt;        serverContext.start(); &lt;br/&gt;
    } &lt;/p&gt;

&lt;p&gt;    @Before &lt;br/&gt;
    public void createClient() throws Exception &lt;br/&gt;
    { &lt;br/&gt;
        clientContext.addRoutes(new RouteBuilder() &lt;br/&gt;
        { &lt;br/&gt;
            @Override &lt;br/&gt;
            public void configure() throws Exception &lt;br/&gt;
            { &lt;br/&gt;
                // Generate an Echo message and ensure a Response is sent &lt;br/&gt;
                from(&quot;timer://echoTimer?delay=1s&amp;amp;fixedRate=true&amp;amp;period=1s&quot;) &lt;br/&gt;
                        .setExchangePattern(ExchangePattern.InOut) &lt;br/&gt;
                        .transform() &lt;br/&gt;
                        .constant(2) &lt;br/&gt;
                        .to(ExchangePattern.InOut, &quot;netty:tcp://localhost:9000?allowDefaultCodec=true&amp;amp;tcpNoDelay=true&amp;amp;reuseAddress=true&amp;amp;keepAlive=false&amp;amp;sync=true&amp;amp;disconnect=&quot; + disconnectClient.toString()) &lt;br/&gt;
                        .process(new Processor() &lt;br/&gt;
                        { &lt;br/&gt;
                            @Override &lt;br/&gt;
                            public void process(Exchange exchange) throws Exception &lt;br/&gt;
                            { &lt;br/&gt;
                                Object body = exchange.getIn().getBody(); &lt;br/&gt;
                                logger.info(&quot;Response number {} : Value = {}&quot;, &lt;br/&gt;
                                        responseCounter.incrementAndGet(), body); &lt;/p&gt;

&lt;p&gt;                                if (responseCounter.get() &amp;gt; 10) &lt;/p&gt;
{ 
                                    passedTen.set(true); 
                                }
&lt;p&gt; &lt;br/&gt;
                            } &lt;/p&gt;

&lt;p&gt;                        }).stop(); &lt;br/&gt;
            } &lt;br/&gt;
        }); &lt;br/&gt;
    } &lt;/p&gt;

&lt;p&gt;    @Test &lt;br/&gt;
    public void test() throws Exception &lt;br/&gt;
    { &lt;br/&gt;
        clientContext.getShutdownStrategy().setTimeout(1); &lt;/p&gt;

&lt;p&gt;        clientContext.start(); &lt;/p&gt;

&lt;p&gt;        logger.info(&quot;Disconnect = {}&quot;, this.disconnectClient); &lt;/p&gt;

&lt;p&gt;        Thread.sleep(TimeUnit.SECONDS.toMillis(15)); &lt;/p&gt;

&lt;p&gt;        clientContext.stop(); &lt;/p&gt;

&lt;p&gt;        assertTrue(&quot;More than 10 responses have been received&quot;, passedTen.get()); &lt;br/&gt;
    } &lt;br/&gt;
} &lt;/p&gt;</description>
                <environment></environment>
        <key id="12527524">CAMEL-4556</key>
            <summary>NettyProducer creating new connection on every message</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="maccamlc">Matthew McMahon</reporter>
                        <labels>
                    </labels>
                <created>Tue, 18 Oct 2011 00:49:19 +0000</created>
                <updated>Sun, 8 Apr 2012 12:55:44 +0000</updated>
                            <resolved>Sun, 8 Apr 2012 12:55:43 +0000</resolved>
                                    <version>2.8.1</version>
                                    <fixVersion>2.9.2</fixVersion>
                    <fixVersion>2.10.0</fixVersion>
                                    <component>camel-netty</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="13249537" author="davsclaus" created="Sun, 8 Apr 2012 12:48:40 +0000"  >&lt;p&gt;This is now working on trunk where the connection will be re-used.&lt;/p&gt;

&lt;p&gt;There is a slight API change, but I think it may be worthwhile to backport that to 2.9 branch. It only affects people who develop custom pipeline factories which should only be a few use-cases.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>88722</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 33 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i021o7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9872</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>