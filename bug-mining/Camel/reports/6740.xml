<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 11:05:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-20614] KameletConsumerNotAvailableException is thrown when two or more threads call toD</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-20614</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;When two or more threads try to instantiate a route template / kamelet parallelly with toD, the following exception is thrown:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[#77,Camel (camel-1) thread #15 - Split,5,main]
org.apache.camel.component.kamelet.KameletConsumerNotAvailableException: No consumers available on endpoint: kamelet:&lt;span class=&quot;code-comment&quot;&gt;//my-kamelet?someParameter=someValue. Exchange[17F2F4997569083-000000000000000C]
&lt;/span&gt;	at org.apache.camel.component.kamelet.KameletProducer.process(KameletProducer.java:78)
	at org.apache.camel.processor.SendProcessor.process(SendProcessor.java:172)
	at org.apache.camel.processor.errorhandler.NoErrorHandler.process(NoErrorHandler.java:46)
	at org.apache.camel.impl.engine.CamelInternalProcessor.process(CamelInternalProcessor.java:383)
	at org.apache.camel.processor.Pipeline$PipelineTask.run(Pipeline.java:102)
	at org.apache.camel.impl.engine.DefaultReactiveExecutor$Worker.executeReactiveWork(DefaultReactiveExecutor.java:196)
	at org.apache.camel.impl.engine.DefaultReactiveExecutor$Worker.schedule(DefaultReactiveExecutor.java:164)
	at org.apache.camel.impl.engine.DefaultReactiveExecutor.schedule(DefaultReactiveExecutor.java:54)
	at org.apache.camel.processor.MulticastProcessor.lambda$schedule$1(MulticastProcessor.java:369)
	at java.base/java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:577)
	at java.base/java.util.concurrent.FutureTask.run$$$capture(FutureTask.java:317)
	at java.base/java.util.concurrent.FutureTask.run(FutureTask.java)
	at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1144)
	at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:642)
	at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:1589)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The sequence of events leading to this exception is as follows:&lt;/p&gt;

&lt;p&gt;1. Thread A creates an endpoint with &lt;em&gt;org.apache.camel.impl.engine.AbstractCamelContext#doGetEndpoint&lt;/em&gt;&lt;br/&gt;
2. Thread A initiates the endpoint with &lt;em&gt;org.apache.camel.component.kamelet.KameletEndpoint#doInit&lt;/em&gt; and sets a key, e.g. my-kamelet-1&lt;br/&gt;
3. Thread A creates a new instance of a route template / kamelet with &lt;em&gt;org.apache.camel.impl.DefaultModel#addRouteFromTemplate&lt;/em&gt;. This method delegates to &lt;em&gt;org.apache.camel.model.RouteTemplateDefinition#asRouteDefinition&lt;/em&gt; which copies RouteDefinition from the template, but &lt;b&gt;it is only a shallow copy (not a deep copy)&lt;/b&gt;, so any referenced fields (e.g. RouteDefinition#input, RouteDefinition#outputs) are shared between threads.&lt;br/&gt;
4. Thread A updates the id of RouteDefinition (routeId=1) and URI-s of RouteDefinition#input (kamelet://source?routeId=1) and RouteDefinition#outputs (kamelet://sink?routeId=1) (see &lt;em&gt;org.apache.camel.component.kamelet.Kamelet#templateToRoute&lt;/em&gt;) which is also reflected in the template&apos;s RouteDefinition.&lt;br/&gt;
5. Thread B executes steps 1-4 and overwrites the URI-s of in the template&apos;s RouteDefinition (my-kamelet-2), hence in the shallow-copied RouteDefinition referenced by Thread A.&lt;br/&gt;
6. Thread A instantiates a Consumer for the URI from RouteDefinition#input, but because it has been modified by Thread B, it will create a Consumer for my-kamelet-2 instead of my-kamelet-1.&lt;br/&gt;
7. Thread A tries to send an Exchange to the route my-kamelet-1 and creates a Producer with the same key (my-kamelet-1). This Producer searches for a Consumer with the same key (my-kamelet-1), but it can&apos;t find it because in the previous step a Consumer with a different key (my-kamelet-2) was created and it throws &lt;em&gt;org.apache.camel.component.kamelet.KameletConsumerNotAvailableException&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;As a solution &lt;em&gt;org.apache.camel.component.kamelet.Kamelet#templateToRoute&lt;/em&gt; can be synchronised and referenced fields that are modified in this method should also be copied.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13573259">CAMEL-20614</key>
            <summary>KameletConsumerNotAvailableException is thrown when two or more threads call toD</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="bartoszpop">Bartosz Popiela</reporter>
                        <labels>
                    </labels>
                <created>Mon, 25 Mar 2024 22:11:34 +0000</created>
                <updated>Wed, 24 Apr 2024 19:19:47 +0000</updated>
                            <resolved>Thu, 18 Apr 2024 11:42:10 +0000</resolved>
                                    <version>3.22.1</version>
                    <version>4.4.1</version>
                                    <fixVersion>4.0.5</fixVersion>
                    <fixVersion>4.4.2</fixVersion>
                    <fixVersion>4.6.0</fixVersion>
                                    <component>camel-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="17837478" author="bartoszpop" created="Tue, 16 Apr 2024 01:56:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt; please find the test case attached - &lt;a href=&quot;https://github.com/bartoszpop/CAMEL-20614/blob/main/src/test/java/io/github/bartoszpop/camel/Camel20614Test.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Camel20614Test&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I see that you have already solved this issue in Camel 4.5 with the fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-20545&quot; title=&quot;AdviceWith -&amp;gt; replaceFromWith fails when using several templated routes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-20545&quot;&gt;&lt;del&gt;CAMEL-20545&lt;/del&gt;&lt;/a&gt; by introducing deep-copy to RouteTemplateDefinition#input. In the scope of the attached prs I did the same for other properties, as otherwise it may lead to undesired behaviour. I also backported your change to Camel 4.4 and Camel 3.22 as it causes kamelets to break in a multi-threaded environment.&lt;/p&gt;</comment>
                            <comment id="17838619" author="davsclaus" created="Thu, 18 Apr 2024 11:42:10 +0000"  >&lt;p&gt;Thanks for the work&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13571379">CAMEL-20545</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 29 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1o7f4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>