<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:57:45 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-6367] The logic in stream producer should sync (lock) and not per method which is wrong</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-6367</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;A new option is available for the stream:file to close it when done (closeOnDone). This option is appeared in 2.11 after my jira (&lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-6147&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CAMEL-6147&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;File unlock (or released or closed) looks to doesn&apos;t works fine if last line is not passed to the endpoint&lt;/p&gt;

&lt;p&gt;Example :&lt;/p&gt;

&lt;p&gt;We have a CSV with X line. We want to write a part of it in a file out_1.csv and a second part in a file out_2.csv according to a business rule, in my example the rule is after two lines readed.&lt;/p&gt;

&lt;p&gt;An example is : &lt;/p&gt;

&lt;p&gt;from(&quot;file://C:/Temp/camel/rep1/?noop=true&quot;)&lt;br/&gt;
    .log(&quot;start process file =&amp;gt; ${&lt;a href=&quot;file:name&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;file:name&lt;/a&gt;}&quot;)&lt;br/&gt;
    .split()&lt;br/&gt;
    .tokenize(&quot;\n&quot;)&lt;br/&gt;
        .streaming()&lt;br/&gt;
        .process(new Processor() {&lt;/p&gt;

&lt;p&gt;            public void process(Exchange exchange) throws Exception {&lt;br/&gt;
               // After 2 lines, next lines are rejected via an exchange property&lt;br/&gt;
               i++ ; &lt;br/&gt;
               if( i  &amp;gt; 2)  &lt;/p&gt;
{
                   exchange.setProperty(&quot;FILE_1&quot;, true );
               }
&lt;p&gt; else &lt;/p&gt;
{
                   exchange.setProperty(&quot;FILE_1&quot;, false);
               }
&lt;p&gt;            }&lt;br/&gt;
       })&lt;br/&gt;
       .choice()&lt;br/&gt;
       .when(property(&quot;FILE_1&quot;).isEqualTo(Boolean.TRUE))&lt;br/&gt;
           .to(&quot;stream:file?fileName=C:/Temp/camel/rep1/out/out_1.csv&amp;amp;closeOnDone=true&quot;)&lt;br/&gt;
       .when(property(&quot;FILE_2&quot;).isEqualTo(Boolean.TRUE))&lt;br/&gt;
            .to(&quot;stream:file?fileName=C:/Temp/camel/rep1/out/out_2.csv&amp;amp;closeOnDone=true&quot;)&lt;br/&gt;
       .end()&lt;br/&gt;
    .end()&lt;br/&gt;
.log(&quot;end process file =&amp;gt; ${&lt;a href=&quot;file:name&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;file:name&lt;/a&gt;}&quot;)&lt;br/&gt;
.end()&lt;br/&gt;
;&lt;/p&gt;

&lt;p&gt;It create two files, and out_1.csv is still locked.&lt;/p&gt;


&lt;p&gt;Solution : Seems like the logic in stream producer should sync (lock) and not per method which is wrong.&lt;br/&gt;
Or maybe better yet do not have a shared output stream.&lt;/p&gt;


&lt;p&gt;By the way, the problem appears not on if there are two files. It appears if the last exchange is not passed to the endpoint.&lt;/p&gt;

&lt;p&gt;Example with only one file : &lt;/p&gt;

&lt;p&gt;from(&quot;file://C:/Temp/camel/rep1/?noop=true&quot;)&lt;br/&gt;
     .split()&lt;br/&gt;
     .tokenize(&quot;\n&quot;)&lt;br/&gt;
     .streaming()&lt;br/&gt;
          .process(new Processor() {&lt;/p&gt;

&lt;p&gt;               public void process(Exchange exchange) throws Exception {&lt;br/&gt;
                    // After 2 lines, next lines are rejected via an&lt;br/&gt;
                    // exchange property&lt;br/&gt;
                    i++;&lt;br/&gt;
                    if (i &amp;gt; 2) &lt;/p&gt;
{
                         exchange.setProperty(&quot;FILE_1&quot;, false);
                    }
&lt;p&gt; else &lt;/p&gt;
{
                         exchange.setProperty(&quot;FILE_1&quot;, true);
                    }
&lt;p&gt;               }&lt;br/&gt;
          })&lt;br/&gt;
          .choice()&lt;br/&gt;
          .when(property(&quot;FILE_1&quot;).isEqualTo(Boolean.TRUE))&lt;br/&gt;
          .to(&quot;stream:file?fileName=C:/Temp/camel/rep1/out/out_1.csv&amp;amp;closeOnDone=true&quot;)&lt;br/&gt;
          .end()&lt;br/&gt;
     .end()&lt;br/&gt;
.end();&lt;/p&gt;</description>
                <environment></environment>
        <key id="12647894">CAMEL-6367</key>
            <summary>The logic in stream producer should sync (lock) and not per method which is wrong</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="8">Not A Problem</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="0jeff0">jeff</reporter>
                        <labels>
                    </labels>
                <created>Thu, 16 May 2013 07:30:29 +0000</created>
                <updated>Mon, 27 May 2013 07:32:06 +0000</updated>
                            <resolved>Sat, 25 May 2013 08:06:40 +0000</resolved>
                                    <version>2.11.0</version>
                                    <fixVersion>2.11.1</fixVersion>
                    <fixVersion>2.12.0</fixVersion>
                                    <component>camel-stream</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13661742" author="njiang" created="Mon, 20 May 2013 03:13:39 +0000"  >&lt;p&gt;I think you need to update your customer processor, to send the exchange to both file endpoint if you got the last exchange from the spliter. &lt;/p&gt;</comment>
                            <comment id="13661877" author="0jeff0" created="Mon, 20 May 2013 10:04:12 +0000"  >&lt;p&gt;Thanks Willem,&lt;/p&gt;

&lt;p&gt;As you can imagine, this example is just for explication.  We have a cascade ( lines are process by more than 20 routes to enrich, reject, validate etc ) of direct route to process line of CSV file.  &lt;/p&gt;

&lt;p&gt;The fact that process reject or not a line is based on business rules which dones&apos;t care of if it is the first or the last line. If I send the exchange to both endpoint if it is the last line then  I duplicate the information in two &quot; direction &quot; which while cause dublication in the rest of the file processing . &lt;/p&gt;


&lt;p&gt;Is there an elegant way to inform the file stream to close if it is the last line ( even if for me it is not  to the camel user to manage the file used by the framework ) ?   &lt;/p&gt;</comment>
                            <comment id="13662780" author="0jeff0" created="Tue, 21 May 2013 07:45:47 +0000"  >&lt;p&gt;Hi Willem, &lt;/p&gt;

&lt;p&gt;I hav found a solution, based on the idea of send the exchange to both endpoint : &lt;/p&gt;

&lt;p&gt;public void configure() throws Exception {&lt;/p&gt;

&lt;p&gt;		// Properties&lt;br/&gt;
		final String PROP_WRITE_IN_FILE_1 = &quot;PROP_WRITE_IN_FILE_1&quot;;&lt;br/&gt;
		final String PROP_WRITE_IN_FILE_2 = &quot;PROP_WRITE_IN_FILE_2&quot;;&lt;/p&gt;

&lt;p&gt;		// Routes &lt;br/&gt;
		final String ROUTE_FILE_1 = &quot;direct:ROUTE_FILE_1&quot; ;&lt;br/&gt;
		final String ROUTE_FILE_2 = &quot;direct:ROUTE_FILE_2&quot; ;&lt;/p&gt;

&lt;p&gt;		// MAIN ROUTE&lt;br/&gt;
		from(&quot;file://C:/Temp/camel/rep1/?noop=true&quot;)&lt;br/&gt;
			.log(&quot;start process file =&amp;gt; ${&lt;a href=&quot;file:name&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;file:name&lt;/a&gt;}&quot;)&lt;br/&gt;
			.split()&lt;br/&gt;
			.tokenize(&quot;\n&quot;).streaming().process(new Processor() {&lt;/p&gt;

&lt;p&gt;				public void process(Exchange exchange) throws Exception {&lt;br/&gt;
					// After 2 lines, next lines are rejected via an&lt;br/&gt;
					// exchange property&lt;br/&gt;
					i++;&lt;br/&gt;
					if (i &amp;lt;= 2) &lt;/p&gt;
{
						exchange.setProperty(PROP_WRITE_IN_FILE_1, true);
						exchange.setProperty(PROP_WRITE_IN_FILE_2, false);
					}
&lt;p&gt; else &lt;/p&gt;
{
						exchange.setProperty(PROP_WRITE_IN_FILE_1, false);
						exchange.setProperty(PROP_WRITE_IN_FILE_2, true);
					}
&lt;p&gt;				}&lt;br/&gt;
			})&lt;br/&gt;
			.multicast().parallelProcessing()&lt;br/&gt;
				.to(ROUTE_FILE_1  , ROUTE_FILE_2 )&lt;br/&gt;
			.end()&lt;br/&gt;
			.log(&quot;end process file =&amp;gt; ${&lt;a href=&quot;file:name&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;file:name&lt;/a&gt;}&quot;)&lt;br/&gt;
		.end();&lt;/p&gt;

&lt;p&gt;		// OUT FILE 1&lt;br/&gt;
		from(ROUTE_FILE_1)&lt;br/&gt;
			.process(new Processor() {&lt;br/&gt;
				public void process(Exchange exchange) throws Exception &lt;/p&gt;
{
					if( ! exchange.getProperty(PROP_WRITE_IN_FILE_1, Boolean.class).booleanValue())
					exchange.getIn().setBody(null);
				}
&lt;p&gt;			})&lt;br/&gt;
			.to(&quot;stream:file?fileName=C:/Temp/camel/rep1/out/out_1.csv&amp;amp;closeOnDone=true&quot;)&lt;br/&gt;
		.end();&lt;/p&gt;

&lt;p&gt;		// OUT FILE 2 &lt;br/&gt;
		from( ROUTE_FILE_2)&lt;br/&gt;
		.process(new Processor() {&lt;br/&gt;
				public void process(Exchange exchange) throws Exception &lt;/p&gt;
{
					if( ! exchange.getProperty(PROP_WRITE_IN_FILE_2, Boolean.class).booleanValue())
					exchange.getIn().setBody(null);
				}
&lt;p&gt;			})&lt;br/&gt;
			.to(&quot;stream:file?fileName=C:/Temp/camel/rep1/out/out_2.csv&amp;amp;closeOnDone=true&quot;)&lt;br/&gt;
		.end();&lt;/p&gt;

&lt;p&gt;	}&lt;/p&gt;


&lt;p&gt;It complicate the process but it works... &lt;/p&gt;

&lt;p&gt;For me camel doesn&apos;t manage correctly the Content Based Router from the EIP patterns in the &lt;a href=&quot;file:stream&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;file:stream&lt;/a&gt; component &lt;/p&gt;


</comment>
                            <comment id="13667020" author="davsclaus" created="Sat, 25 May 2013 08:06:40 +0000"  >&lt;p&gt;Polished the code a bit. Though we sync on the process method so only one thread can use the producer.&lt;/p&gt;

&lt;p&gt;And closeOnDone option is only for &lt;b&gt;one file&lt;/b&gt;.&lt;/p&gt;</comment>
                            <comment id="13667520" author="0jeff0" created="Mon, 27 May 2013 07:32:06 +0000"  >
&lt;p&gt;As I said, in my comment, the filestream in the 2.11 version doesn&apos;t manage correctly stream even with one file if the last exchange is not passed to the endpoint. &lt;/p&gt;

&lt;p&gt;Good news if your commit solves it.&lt;/p&gt;

&lt;p&gt;Jeff&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>328250</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 26 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1kmvj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>328594</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>