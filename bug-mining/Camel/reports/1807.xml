<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 09:50:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-5070] Message Loss when using Weighted Round Robin LoadBalancer</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-5070</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;chooseProcessor method accesses resources in a non synchronized fashion. This leads in errors during loadbalancing and as a result messages are lost. I have created a project that provides an integration test (using karaf 2.2.5 and a custom command to check messages of the activemq broker) with a custom weighted round robin loadbalancer that &quot;seems&quot; to solve the issue of lost messages.&lt;/p&gt;

&lt;p&gt;The problem with the provided solution is that when messages are dequeued from the second stage of queues (queues1, 2 and 3) in custom-loadbalancer-route subproject the jmsconsumer threads also block (checked this using profiler). I would expect only the jmsconsumer threads of the first queue (initial.queue) to block waiting for the synchronized chooseProcessor method. Any clues on why this happens?&lt;/p&gt;</description>
                <environment></environment>
        <key id="12545675">CAMEL-5070</key>
            <summary>Message Loss when using Weighted Round Robin LoadBalancer</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="akarpe">Ashwin J. Karpe</assignee>
                                    <reporter username="nikosd23">Nikolaos Dimos</reporter>
                        <labels>
                    </labels>
                <created>Thu, 8 Mar 2012 16:48:00 +0000</created>
                <updated>Sat, 10 Mar 2012 09:25:11 +0000</updated>
                            <resolved>Fri, 9 Mar 2012 19:25:20 +0000</resolved>
                                    <version>2.9.1</version>
                                    <fixVersion>2.8.5</fixVersion>
                    <fixVersion>2.9.2</fixVersion>
                    <fixVersion>2.10.0</fixVersion>
                                    <component>camel-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="13225298" author="nikosd23" created="Thu, 8 Mar 2012 16:49:55 +0000"  >&lt;p&gt;Attaching the maven project that contains the camel route, the custom activemq commands and the itest subproject&lt;/p&gt;</comment>
                            <comment id="13225315" author="nikosd23" created="Thu, 8 Mar 2012 17:14:07 +0000"  >&lt;p&gt;You can reproduce the problem by uncommenting the weightedRoundRobin line in the custom-loadbalancer-route subproject (and commenting of course the custom). The custom karaf command that was implemented (queue:broker-info) provides the following information QName|QConsumerCount|QSize|QEnqueueCount|QDequeueCount.&lt;/p&gt;</comment>
                            <comment id="13226090" author="davsclaus" created="Fri, 9 Mar 2012 14:21:27 +0000"  >&lt;p&gt;Which jms consumer is blocked?&lt;br/&gt;
And what is your problem exactly?&lt;/p&gt;

&lt;p&gt;Can you post some more details. &lt;/p&gt;</comment>
                            <comment id="13226109" author="nikosd23" created="Fri, 9 Mar 2012 14:44:19 +0000"  >&lt;p&gt;Weighted Round Robin Loadbalancer should be synchronized. The custom loadbalancer provided in the integration test does exactly this. It solves the problem of the index out of bound exception:&lt;/p&gt;

&lt;p&gt;Caused by: java.lang.ArrayIndexOutOfBoundsException: 3&lt;br/&gt;
        at java.util.concurrent.CopyOnWriteArrayList.get(CopyOnWriteArrayList.java:343)&lt;span class=&quot;error&quot;&gt;&amp;#91;:1.6.0_20&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.processor.loadbalancer.WeightedRoundRobinLoadBalancer.chooseProcessor(WeightedRoundRobinLoadBalancer.java:52)&lt;span class=&quot;error&quot;&gt;&amp;#91;71:org.apache.camel.camel-core:2.9.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.processor.loadbalancer.QueueLoadBalancer.process(QueueLoadBalancer.java:39)&lt;span class=&quot;error&quot;&gt;&amp;#91;71:org.apache.camel.camel-core:2.9.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.util.AsyncProcessorHelper.process(AsyncProcessorHelper.java:73)&lt;span class=&quot;error&quot;&gt;&amp;#91;71:org.apache.camel.camel-core:2.9.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.camel.processor.DelegateAsyncProcessor.processNext(DelegateAsyncProcessor.java:99)&lt;span class=&quot;error&quot;&gt;&amp;#91;71:org.apache.camel.camel-core:2.9.0&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Nevertheless, if you follow this approach jms consumers of queue1, queue2 and queue3 block. If you try to loadbalance a large amount of messages from the first queue to the other 3, using the synchronized weighted round robin loadbalancer, then you will see that the queues (queue1,2 and 3) are growing without obvious to me reason. The second route is only from jms to log.&lt;/p&gt;</comment>
                            <comment id="13226148" author="akarpe" created="Fri, 9 Mar 2012 15:40:57 +0000"  >&lt;p&gt;Hi Nikos,&lt;/p&gt;

&lt;p&gt;I can see the scenario you are mentioning happening under load where the counter and/or runtimeWeight may get out of synch under load...&lt;/p&gt;

&lt;p&gt;I am however unclear on the queues growing without reason issue. Do you mean there are additional messages being created and dispatched to the queues.&lt;/p&gt;

&lt;p&gt;Can you remove the synchronized on the chooseProcessor() method and synchronize just the counter and runtimeWeight and see if there is a change in behavior. &lt;/p&gt;

&lt;p&gt;Cheers,&lt;/p&gt;

&lt;p&gt;Ashwin...&lt;/p&gt;</comment>
                            <comment id="13226289" author="nikosd23" created="Fri, 9 Mar 2012 18:27:13 +0000"  >&lt;p&gt;Hi Ashwin,&lt;/p&gt;

&lt;p&gt;The provided sync load balancer solves the issue of lost messages. If you check the itest subproject you will see that the number of messages enqueued to initial route is the same as the sum of the messages dequeued from the three queues. I am not implying that additional messages are being created and dispatched to queues.&lt;/p&gt;

&lt;p&gt;I believe that the whole process of chooseprocessor should be atomic not just the access to counter shared resource or weights, that is why I synched the whole method.&lt;/p&gt;

&lt;p&gt;I have profiled the plain weighted round robin loadbalancer and experienced the same behaviour in terms of blocking jmsconsumer threads of all queues, so maybe this is the normal behavior. Sorry for not having done this before.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Nikos&lt;/p&gt;</comment>
                            <comment id="13226305" author="akarpe" created="Fri, 9 Mar 2012 18:41:56 +0000"  >&lt;p&gt;Hi Nikos,&lt;/p&gt;

&lt;p&gt;Excellent... I will make the fix right away, test, and check it in.&lt;/p&gt;

&lt;p&gt;Thanks for your help in identifying the issue and providing the patch...&lt;/p&gt;

&lt;p&gt;Cheers,&lt;/p&gt;

&lt;p&gt;Ashwin...&lt;/p&gt;</comment>
                            <comment id="13226306" author="akarpe" created="Fri, 9 Mar 2012 18:41:58 +0000"  >&lt;p&gt;Hi Nikos,&lt;/p&gt;

&lt;p&gt;Excellent... I will make the fix right away, test, and check it in.&lt;/p&gt;

&lt;p&gt;Thanks for your help in identifying the issue and providing the patch...&lt;/p&gt;

&lt;p&gt;Cheers,&lt;/p&gt;

&lt;p&gt;Ashwin...&lt;/p&gt;</comment>
                            <comment id="13226348" author="akarpe" created="Fri, 9 Mar 2012 19:24:17 +0000"  >&lt;p&gt;Hi Nikos,&lt;/p&gt;

&lt;p&gt;I have applied the fix to the trunk... &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://svn.apache.org/viewvc?view=revision&amp;amp;revision=1298993&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/viewvc?view=revision&amp;amp;revision=1298993&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Thanks for identifying the issue and offering a patch for it.&lt;/p&gt;

&lt;p&gt;Cheers,&lt;/p&gt;

&lt;p&gt;Ashwin...&lt;/p&gt;</comment>
                            <comment id="13226354" author="akarpe" created="Fri, 9 Mar 2012 19:25:20 +0000"  >&lt;p&gt;Applied fix to trunk as revision r1298993.&lt;/p&gt;

&lt;p&gt;Thanks to Nikolaos Dimos for providing the patch.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Ashwin...&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13226799" author="davsclaus" created="Sat, 10 Mar 2012 08:57:19 +0000"  >&lt;p&gt;See the asyncConsumer option on the JMS component&lt;br/&gt;
&lt;a href=&quot;http://camel.apache.org/jms&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://camel.apache.org/jms&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13226801" author="nikosd23" created="Sat, 10 Mar 2012 09:25:11 +0000"  >&lt;p&gt;Thanks Ashwin and Claus.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12517574" name="loadbalancer-itest.zip" size="23533" author="nikosd23" created="Thu, 8 Mar 2012 16:49:55 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>230858</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 37 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i024tj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>10382</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>