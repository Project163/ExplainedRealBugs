<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 11:09:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-21505] camel-as2: Binary files get corrupt when using &apos;base64&apos; content transfer encoding</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-21505</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;Binary files get corrupt when using &lt;b&gt;base64&lt;/b&gt; content transfer encoding due to String assignment of the decoded byte[]&lt;/p&gt;

&lt;p&gt;This can easily be tested sending a .zip file to Camel AS2 listener.&lt;/p&gt;

&lt;p&gt;After some investigation the issue seems to be in the EntityUtil.decode method.&lt;/p&gt;


&lt;p&gt;As shown in the screenshot the decoded (binary) byte[] is assigned to a new String which result into corrupt date in case of binary content.&lt;br/&gt;
&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13073173/13073173_image-2024-12-03-12-29-47-487.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;In addition there are new line characters in the encoded base64 encoded String data object.&lt;/p&gt;

&lt;p&gt;In case of using transfer encoding type &lt;b&gt;binary&lt;/b&gt; java.nio.charset.MalformedInputException: Input length = 1 it thrown which might be OK.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Windows and Docker &lt;br/&gt;
Java 21 Temurin&lt;/p&gt;</environment>
        <key id="13600716">CAMEL-21505</key>
            <summary>camel-as2: Binary files get corrupt when using &apos;base64&apos; content transfer encoding</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jono">Jono Morris</assignee>
                                    <reporter username="meinolf01">Meinolf S-D</reporter>
                        <labels>
                    </labels>
                <created>Tue, 3 Dec 2024 11:38:10 +0000</created>
                <updated>Thu, 30 Jan 2025 12:15:32 +0000</updated>
                            <resolved>Thu, 30 Jan 2025 12:15:32 +0000</resolved>
                                    <version>4.8.1</version>
                                    <fixVersion>4.8.4</fixVersion>
                    <fixVersion>4.10.0</fixVersion>
                                    <component>camel-as2</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17902598" author="davsclaus" created="Tue, 3 Dec 2024 11:41:02 +0000"  >&lt;p&gt;You are welcome to send a PR with a potential fix for review&lt;/p&gt;</comment>
                            <comment id="17906024" author="JIRAUSER307851" created="Mon, 16 Dec 2024 13:06:41 +0000"  >&lt;p&gt;I&apos;m sorry but I have no fix for this.&lt;/p&gt;</comment>
                            <comment id="17908291" author="davsclaus" created="Thu, 26 Dec 2024 12:12:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jono&quot; class=&quot;user-hover&quot; rel=&quot;jono&quot;&gt;jono&lt;/a&gt; I wonder if you would have time to look into this. As it looks like that a US-ASCII Charset is selected by default. I wonder if there is a way to understand from the received AS2 message whether its binary or not. I assume there is a header indicating binary vs plain text&lt;/p&gt;</comment>
                            <comment id="17908293" author="jono" created="Thu, 26 Dec 2024 12:18:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davsclaus&quot; class=&quot;user-hover&quot; rel=&quot;davsclaus&quot;&gt;davsclaus&lt;/a&gt;, yes I can have a look.&lt;/p&gt;</comment>
                            <comment id="17911945" author="jono" created="Fri, 10 Jan 2025 12:12:07 +0000"  >&lt;p&gt;Looking at sections 3.4 and 3.5 of AS2 spec &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;, AS2 appears to be primarily designed for sending EDI messages using 7-bit US-ASCII. &#160;&lt;/p&gt;

&lt;p&gt;Camel-AS2 provides EDIFACT, EDI-X12, EDI-CONSENT, and XML entity types, all of which only support text.&#160; However, I&apos;ve found that Zip content can be sent if it is first Base64 encoded, and I&apos;ve created a few examples &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;.&lt;br/&gt;
&#160; &#160;&lt;br/&gt;
&#160; &#160;1. &lt;a href=&quot;https://www.ietf.org/rfc/rfc4130.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://www.ietf.org/rfc/rfc4130.txt&lt;/a&gt;&lt;br/&gt;
&#160; &#160;2. &lt;a href=&quot;https://github.com/apache/camel/compare/main...jonomorris:camel:CAMEL-21505_zipfile_example?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/camel/compare/main...jonomorris:camel:CAMEL-21505_zipfile_example?expand=1&lt;/a&gt;&lt;br/&gt;
&#160; &#160;&lt;/p&gt;</comment>
                            <comment id="17912000" author="JIRAUSER307851" created="Fri, 10 Jan 2025 14:23:52 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jono&quot; class=&quot;user-hover&quot; rel=&quot;jono&quot;&gt;jono&lt;/a&gt;,&lt;br/&gt;
I would give some more information on how I have tested this when I found the issue.&lt;/p&gt;

&lt;p&gt;I have used Mendelson AS2 Server as Client to send the AS2 Message to Camel AS2.&lt;/p&gt;

&lt;p&gt;In Mendelson I have configured &apos;Content Transfer Encoding:&apos; &apos;base64&apos; and &apos;Payload content type:&apos; &apos;application/EDI-Consent&apos;.&lt;/p&gt;

&lt;p&gt;I sent a zip file containing some content items during my tests.&lt;/p&gt;

&lt;p&gt;When receiving the file in the processor it was already corrupted and after saving it to the filesystem the zip file can&apos;t be opened.&lt;/p&gt;

&lt;p&gt;After debugging the the Camel AS2 module I saw it gets corrupt in EntityUtil.decode method because the base64 encoded zip file is decoded to a native zip byte[].&lt;br/&gt;
The decoded native zip byte[] then is given as a parameter to a String Constructor which obviously lets a binary get corrupt.&lt;/p&gt;

&lt;p&gt;Here is a screenshot of the Mendelson AS2 Partner Configuation&lt;br/&gt;
&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13073912/13073912_image-2025-01-10-15-09-59-096.png&quot; height=&quot;460&quot; width=&quot;629&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;In your provided Unit Tests you have choosen &apos;7bit&apos; content transfer encoding instead of &apos;base64&apos; content transfer encoding: EDI_MESSAGE_CONTENT_TRANSFER_ENCODING = &quot;7bit&quot;&lt;/p&gt;

&lt;p&gt;This is a different approach. If you are choosing &apos;base64&apos; content transfer encoding the decode method in EntityUtils will run into &apos;case &quot;base64&quot;&apos; and do a decode of the base64 encoded zip and give the decoded byte[] to the String constructor.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;switch&lt;/span&gt; (encoding.toLowerCase()) {
&#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;base64&quot;&lt;/span&gt;:
&#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; Base64.decode(data);
&#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;quoted-printable&quot;&lt;/span&gt;:
&#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; QuotedPrintableCodec.decodeQuotedPrintable(data);
&#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;binary&quot;&lt;/span&gt;:
&#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;7bit&quot;&lt;/span&gt;:
&#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;8bit&quot;&lt;/span&gt;:
&#160; &#160; &#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// Identity encoding
&lt;/span&gt;&#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; data;
&#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;:
&#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CamelException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Unknown encoding: &quot;&lt;/span&gt; + encoding);
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Possibly this helps for the reproduction.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17912190" author="jono" created="Sat, 11 Jan 2025 10:56:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=meinolf01&quot; class=&quot;user-hover&quot; rel=&quot;meinolf01&quot;&gt;meinolf01&lt;/a&gt; thanks for the information.&#160; I&apos;ll investigate further.&lt;/p&gt;</comment>
                            <comment id="17921638" author="davsclaus" created="Tue, 28 Jan 2025 08:31:58 +0000"  >&lt;p&gt;Jono, let us know how it goes&lt;/p&gt;</comment>
                            <comment id="17921702" author="jono" created="Tue, 28 Jan 2025 11:55:23 +0000"  >&lt;p&gt;Claus, I just raised a PR for you to look at.&#160; Sorry for the delay.&#160;&lt;/p&gt;</comment>
                            <comment id="17921711" author="davsclaus" created="Tue, 28 Jan 2025 12:19:26 +0000"  >&lt;p&gt;Thanks Jono, a PR for the 4.8.x branch is welcome. However if you think its super easy then tell me and I can try to do it.&lt;/p&gt;</comment>
                            <comment id="17921715" author="jono" created="Tue, 28 Jan 2025 12:29:41 +0000"  >&lt;p&gt;I&apos;ve run out of time tonight Claus.&#160; You&apos;re welcome to do it, otherwise I can do it tomorrow.&lt;/p&gt;</comment>
                            <comment id="17921764" author="davsclaus" created="Tue, 28 Jan 2025 15:00:45 +0000"  >&lt;p&gt;Thanks I tried to backport, but testing locally I get a timeout error&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt; &amp;#8212; failsafe:3.5.0:verify (integration-test) @ camel-as2 &amp;#8212;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt; ------------------------------------------------------------------------&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt; Reactor Summary for Camel :: AS2 :: Parent 4.8.4-SNAPSHOT:&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt; Camel :: AS2 :: Parent ............................. SUCCESS [ &#160;0.897 s]&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt; Camel :: AS2 :: API ................................ SUCCESS &lt;span class=&quot;error&quot;&gt;&amp;#91;01:56 min&amp;#93;&lt;/span&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt; Camel :: AS2 :: Component .......................... FAILURE &lt;span class=&quot;error&quot;&gt;&amp;#91;10:04 min&amp;#93;&lt;/span&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt; ------------------------------------------------------------------------&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt; BUILD FAILURE&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt; ------------------------------------------------------------------------&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Without the PR then the 4.8.x branch can test success locally.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13073173" name="image-2024-12-03-12-29-47-487.png" size="148978" author="meinolf01" created="Tue, 3 Dec 2024 11:29:47 +0000"/>
                            <attachment id="13073912" name="image-2025-01-10-15-09-59-096.png" size="100090" author="meinolf01" created="Fri, 10 Jan 2025 14:09:59 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12314421" key="com.atlassian.jira.plugin.system.customfieldtypes:labels">
                        <customfieldname>Language</customfieldname>
                        <customfieldvalues>
                                        <label>Java</label>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            41 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1svzs:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>