<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:00:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-6936] FTP route with idempotent repo does not detect modified files</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-6936</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;Per my forum post:&lt;br/&gt;
&lt;a href=&quot;http://camel.465427.n5.nabble.com/inProgressRepository-Not-clearing-for-items-in-idempotentRepository-td5742613.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://camel.465427.n5.nabble.com/inProgressRepository-Not-clearing-for-items-in-idempotentRepository-td5742613.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I&apos;m attempting to consume messages from an FTP server using an idempotent repository to ensure that I do not re-download a file unless it has been modified. &lt;/p&gt;

&lt;p&gt;Here is my (quite simple) camel configuration: &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &amp;lt;beans:bean id=&lt;span class=&quot;code-quote&quot;&gt;&quot;downloadRepo&quot;&lt;/span&gt; class=&lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.camel.processor.idempotent.FileIdempotentRepository&quot;&lt;/span&gt; &amp;gt;
                &amp;lt;beans:property name=&lt;span class=&quot;code-quote&quot;&gt;&quot;fileStore&quot;&lt;/span&gt; value=&lt;span class=&quot;code-quote&quot;&gt;&quot;/tmp/.repo.txt&quot;&lt;/span&gt;/&amp;gt;
                &amp;lt;beans:property name=&lt;span class=&quot;code-quote&quot;&gt;&quot;cacheSize&quot;&lt;/span&gt; value=&lt;span class=&quot;code-quote&quot;&gt;&quot;25000&quot;&lt;/span&gt;/&amp;gt;
                &amp;lt;beans:property name=&lt;span class=&quot;code-quote&quot;&gt;&quot;maxFileStoreSize&quot;&lt;/span&gt; value=&lt;span class=&quot;code-quote&quot;&gt;&quot;1000000&quot;&lt;/span&gt;/&amp;gt;
        &amp;lt;/beans:bean&amp;gt;

        &amp;lt;camelContext trace=&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt; xmlns=&lt;span class=&quot;code-quote&quot;&gt;&quot;http:&lt;span class=&quot;code-comment&quot;&gt;//camel.apache.org/schema/spring&quot;&lt;/span&gt;&amp;gt;
&lt;/span&gt;                &amp;lt;endpoint id=&lt;span class=&quot;code-quote&quot;&gt;&quot;myFtpEndpoint&quot;&lt;/span&gt; uri=&lt;span class=&quot;code-quote&quot;&gt;&quot;ftp:&lt;span class=&quot;code-comment&quot;&gt;//me@localhost?password=****&amp;amp;binary=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;amp;recursive=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;amp;consumer.delay=15000&amp;amp;readLock=changed&amp;amp;passiveMode=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;amp;noop=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;amp;idempotentRepository=#downloadRepo&amp;amp;idempotentKey=$simple{file:name}-$simple{file:modified}&quot;&lt;/span&gt; /&amp;gt;
&lt;/span&gt;                &amp;lt;endpoint id=&lt;span class=&quot;code-quote&quot;&gt;&quot;myFileEndpoint&quot;&lt;/span&gt; uri=&lt;span class=&quot;code-quote&quot;&gt;&quot;file:&lt;span class=&quot;code-comment&quot;&gt;///tmp/files&quot;&lt;/span&gt;/&amp;gt;
&lt;/span&gt;
        &amp;lt;route&amp;gt;
            &amp;lt;from uri=&lt;span class=&quot;code-quote&quot;&gt;&quot;ref:myFtpEndpoint&quot;&lt;/span&gt; /&amp;gt;
            &amp;lt;to uri=&lt;span class=&quot;code-quote&quot;&gt;&quot;ref:myFileEndpoint&quot;&lt;/span&gt; /&amp;gt;
        &amp;lt;/route&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When I start my application for the first time, all files are correctly downloaded from the FTP server and stored in the target directory, as well as recorded in the idempotent repo. &lt;/p&gt;

&lt;p&gt;When I restart my application, all files are correctly detected as being in the idempotent repo already on the first poll of the FTP server, and are not re-downloaded: &lt;/p&gt;

&lt;p&gt;13-11-04 16:52:10,811 TRACE &lt;span class=&quot;error&quot;&gt;&amp;#91;Camel (camel-1) thread #0 - ftp://me@localhost&amp;#93;&lt;/span&gt; org.apache.camel.component.file.remote.FtpConsumer: FtpFile&lt;span class=&quot;error&quot;&gt;&amp;#91;name=test1.txt, dir=false, file=true&amp;#93;&lt;/span&gt; &lt;br/&gt;
2013-11-04 16:52:10,811 TRACE &lt;span class=&quot;error&quot;&gt;&amp;#91;Camel (camel-1) thread #0 - ftp://me@localhost&amp;#93;&lt;/span&gt; org.apache.camel.component.file.remote.FtpConsumer: This consumer is idempotent and the file has been consumed before. Will skip this file: RemoteFile&lt;span class=&quot;error&quot;&gt;&amp;#91;test1.txt&amp;#93;&lt;/span&gt; &lt;/p&gt;

&lt;p&gt;However, on all subsequent polls to the FTP server the idempotent check is short-circuited because the file is &quot;in progress&quot;: &lt;/p&gt;

&lt;p&gt;2013-11-04 16:53:10,886 TRACE &lt;span class=&quot;error&quot;&gt;&amp;#91;Camel (camel-1) thread #0 - ftp://me@localhost&amp;#93;&lt;/span&gt; org.apache.camel.component.file.remote.FtpConsumer: FtpFile&lt;span class=&quot;error&quot;&gt;&amp;#91;name=test1.txt, dir=false, file=true&amp;#93;&lt;/span&gt;&lt;br/&gt;
2013-11-04 16:53:10,886 TRACE &lt;span class=&quot;error&quot;&gt;&amp;#91;Camel (camel-1) thread #0 - ftp://me@localhost&amp;#93;&lt;/span&gt; org.apache.camel.component.file.remote.FtpConsumer: Skipping as file is already in progress: test1.txt &lt;/p&gt;

&lt;p&gt;I am using camel-ftp:2.11.1 (also observing same behavior with 2.12.1)  When I inspect the source code I notice two interesting things. &lt;br/&gt;
First, the GenericFileConsumer check that determines whether a file is already inProgress which is called from isValidFile() always adds the file to the inProgressRepository: &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isInProgress(GenericFile&amp;lt;T&amp;gt; file) { 
        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; key = file.getAbsoluteFilePath(); 
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; !endpoint.getInProgressRepository().add(key); 
    } 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Second, if a file is determined to match an entry already present in the idempotent repository it is discarded (GenericFileConsumer.isValidFile() returns false).  This means it is never published to an exchange, and thus never reaches the code which would remove it from the inProgressRepository. &lt;/p&gt;

&lt;p&gt;Since the inProgress check happens before the Idempotent Check, we will always short circuit after we get into the inprogress state, and the file will never actually be checked again. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12677585">CAMEL-6936</key>
            <summary>FTP route with idempotent repo does not detect modified files</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davsclaus">Claus Ibsen</assignee>
                                    <reporter username="skelly">Seth Kelly</reporter>
                        <labels>
                    </labels>
                <created>Tue, 5 Nov 2013 14:47:46 +0000</created>
                <updated>Mon, 11 Nov 2013 11:30:59 +0000</updated>
                            <resolved>Mon, 11 Nov 2013 11:19:34 +0000</resolved>
                                    <version>2.12.1</version>
                                    <fixVersion>2.11.3</fixVersion>
                    <fixVersion>2.12.2</fixVersion>
                    <fixVersion>2.13.0</fixVersion>
                                    <component>camel-core</component>
                    <component>camel-ftp</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13814268" author="skelly" created="Tue, 5 Nov 2013 21:23:53 +0000"  >&lt;p&gt;In order to solve this, might I suggest removing the idempotent options entirely, and instead implementing an Idempotent GenericFileFilter which can then be injected into the ftp component. This is the approach I used to get around the bug in my implementation and it is working well for me.&lt;/p&gt;</comment>
                            <comment id="13818820" author="davsclaus" created="Mon, 11 Nov 2013 10:09:56 +0000"  >&lt;p&gt;Thanks for the detailed report. This bug is also in the regular file component.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12659664">CAMEL-6574</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>356960</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 2 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1pjcn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>357250</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>