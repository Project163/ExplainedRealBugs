<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 10:10:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CAMEL-8663] Namespaces defined on the SOAP envelope get lost in PAYLOAD mode</title>
                <link>https://issues.apache.org/jira/browse/CAMEL-8663</link>
                <project id="12311211" key="CAMEL">Camel</project>
                    <description>&lt;p&gt;If a request message is send to a CXF consumer or a response is returned to the CXF provider that contains namespace definions at the SOAP envelope and the Camel-CXF endpoint is configured in PAYLOAD mode the namespace definition gets lost unless streaming is disabled.&lt;/p&gt;

&lt;p&gt;If the resulting CxfPayload is then converted e.g. to String that String will contain invalid XML (because some namespace definition is missing).&lt;/p&gt;

&lt;p&gt;For non-streaming mode (system property org.apache.camel.component.cxf.streaming is set to false) there are special precautions met to set these envelope namespaces on the first DOM element of the payload but this coding is missing for StAX.&lt;/p&gt;

&lt;p&gt;The messages in question look like that:&lt;br/&gt;
&amp;lt;soap:Envelope xmlns:soap=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:xs=&quot;http://www.w3.org/2001/XMLSchema&quot;&amp;gt;&lt;br/&gt;
  &amp;lt;soap:Body&amp;gt;&lt;br/&gt;
    &amp;lt;ns2:getTokenResponse xmlns:ns2=&quot;http://camel.apache.org/cxf/namespace&quot;&amp;gt;&lt;br/&gt;
      &amp;lt;return xsi:type=&quot;xs:string&quot;&amp;gt;Return Value&amp;lt;/return&amp;gt;&lt;br/&gt;
    &amp;lt;/ns2:getTokenResponse&amp;gt;&lt;br/&gt;
  &amp;lt;/soap:Body&amp;gt;&lt;br/&gt;
&amp;lt;/soap:Envelope&amp;gt;&lt;/p&gt;

&lt;p&gt;If the CxfPayload is converted to String it will lack the definition for the xsi namespace prefix (and further XML parsing will fail).&lt;/p&gt;</description>
                <environment></environment>
        <key id="12821943">CAMEL-8663</key>
            <summary>Namespaces defined on the SOAP envelope get lost in PAYLOAD mode</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ay">Akitoshi Yoshida</assignee>
                                    <reporter username="siano">Stephan Siano</reporter>
                        <labels>
                    </labels>
                <created>Fri, 17 Apr 2015 17:50:05 +0000</created>
                <updated>Thu, 21 Mar 2019 16:30:32 +0000</updated>
                            <resolved>Wed, 5 Aug 2015 16:01:27 +0000</resolved>
                                                    <fixVersion>2.16.0</fixVersion>
                                    <component>camel-cxf</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14500427" author="siano" created="Fri, 17 Apr 2015 18:50:39 +0000"  >&lt;p&gt;The attached patch tracks the namespaces in another interceptor and adds a nsMap in DefaultCxfBinding (similar to the one provided for DOM).&lt;/p&gt;

&lt;p&gt;A delegation XMLStreamReader then re-injects the namespaces.&lt;/p&gt;

&lt;p&gt;See the attached tests for details of the fix.&lt;/p&gt;</comment>
                            <comment id="14526560" author="siano" created="Mon, 4 May 2015 11:54:43 +0000"  >&lt;p&gt;The new version of the patch directly writes to a CachedOutputStream when doing the identity transformation. The previous version was intermediately storing the message in a String internally&lt;/p&gt;</comment>
                            <comment id="14530640" author="ay" created="Wed, 6 May 2015 14:37:28 +0000"  >&lt;p&gt;I think the xsi prefix in your example should not actually cause any problem when the StAXSource is correctly serialized (because it should find the namespace bound to prefix xsi and can serialize this attribute along with its namespace declrattion). If xsi&apos;s declaration disappears when converting to String, I think there is something wrong with the converter.&lt;/p&gt;

&lt;p&gt;But your example points out another issue, namely of handling the implicitly referenced prefixes (the prefix &quot;xs&quot; used in attribute value &quot;xs:string&quot;). To include this prefix declaration in the detached payload text, we need to collect the bindings from the envelope.&lt;/p&gt;

&lt;p&gt;I think the easiest way to do this is to make CXF provide this context map so that camel-cxf can directly inject it when instantiating CxfPayload.&lt;/p&gt;

&lt;p&gt;But in any case, the downside of including all implicitly referenced declarations is that they will be then included even when they are not even used. We might need to provide an option to not include additional declarations.&lt;/p&gt;

&lt;p&gt;I&apos;ll look into this.&lt;/p&gt;</comment>
                            <comment id="14532505" author="ay" created="Thu, 7 May 2015 11:55:29 +0000"  >&lt;p&gt;Hi Stephan,&lt;br/&gt;
I added an option CXF to directly gather the namespace map of the soap:body so this can be directly retrieved at camel-cxf.&lt;br/&gt;
Using this feature, I made a simpler patch and the code passes your test cases. &lt;br/&gt;
I am submitting this patch including your tests but the tests are disabled for now (wait for cxf-3.0.6).&lt;/p&gt;

&lt;p&gt;If you could look at the change and your feedback, that would be appreciated.&lt;br/&gt;
regards, aki&lt;/p&gt;</comment>
                            <comment id="14534410" author="siano" created="Fri, 8 May 2015 12:15:17 +0000"  >&lt;p&gt;Hi Aki,&lt;/p&gt;

&lt;p&gt;I have added some extensions to your patch. It contains the following changes:&lt;br/&gt;
1. I removed unused import statements left behind by your refactoring&lt;br/&gt;
2. I made the DelegatingXMLStream reader less aggressive. The namespaces are only injected on the top element that is read, not on every element of the payload.&lt;br/&gt;
3. The CachedCxfPayload will wrap the XMLStreamReader only into a DelegatingXMLStreamReader if it is not already one (the type converter normally already does this wrapping). The following identity transformation is done directly into a StreamResult backed by a CachedOutputStream. This avoids the type conversion into a StreamSource which is backed by a String that is then copied into a CachedOutputStream in the constructor of the StreamSourceCache.&lt;br/&gt;
4. I added two addiontional tests that also test this kind of messages with stream caching.&lt;br/&gt;
5. I think the org.apache.cxf.binding.soap.addNamespaceContext should always be set to true for Camel-CXF endpoints in payload mode. It is very intransparent to the user whether this setting is reqired or not, so I think it should always be enabled to be on the safe side.&lt;/p&gt;

&lt;p&gt;What do you think?&lt;/p&gt;

&lt;p&gt;Best regards&lt;br/&gt;
Stephan&lt;/p&gt;</comment>
                            <comment id="14535058" author="ay" created="Fri, 8 May 2015 17:42:34 +0000"  >&lt;p&gt;Hi Stephan,&lt;br/&gt;
thanks.&lt;br/&gt;
1. aah. I often forget to run the sourcecheck because it&apos;s not active by default clean install ;-( thanks&lt;br/&gt;
2. okay. But we need to change this logic so that the additional ns-decls get included only at the root level and not at any time when the namespaces are read at the first time. Otherwise you&apos;ll get an inconsistent behavior when some app repeatedly invokes next() and then does getNamespaceXX. At that point, the added prefixes might have be overwritten at some higher level. And also the additional ns-decls need to be included back at the root level at its end-element event. I&apos;ll adjust this accordingly.&lt;br/&gt;
3. okay&lt;br/&gt;
4. okay&lt;br/&gt;
5. thought about this for a while, That will make it more practical for most camel users. So okay. fine.&lt;/p&gt;

&lt;p&gt;Willem already fixed some of the original checkstyle issue. So I need to run the merge against the earlier version and then rebasing to the current version. And there are still several checkstyle errors that I need to fix before pushing the change this time.  So just a moment.&lt;/p&gt;</comment>
                            <comment id="14647352" author="ay" created="Thu, 30 Jul 2015 08:44:04 +0000"  >&lt;p&gt;Somehow I forgot about this ticket. I don&apos;t remember if I completed the work and forgot to mark it complete or if something is still left.&lt;br/&gt;
I will take care of it today.&lt;/p&gt;</comment>
                            <comment id="14655083" author="davsclaus" created="Wed, 5 Aug 2015 09:41:38 +0000"  >&lt;p&gt;Did you get a chance to look into this?&lt;/p&gt;</comment>
                            <comment id="14658253" author="ay" created="Wed, 5 Aug 2015 14:01:11 +0000"  >&lt;p&gt;I was interrupted and waited realized that this needed to wait for a new cxf version which has just been released.&lt;br/&gt;
I will activate the disabled tests and push the change after verifying it.&lt;/p&gt;

</comment>
                            <comment id="14658435" author="ay" created="Wed, 5 Aug 2015 16:01:27 +0000"  >&lt;p&gt;For now, the patch is only pushed to master/2.16.0.&lt;/p&gt;

&lt;p&gt;This patch does not integrate automatically into 2.15.x, as its change depends on the change made with &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-8410&quot; title=&quot;Add stream caching for CxfPayload&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-8410&quot;&gt;&lt;del&gt;CAMEL-8410&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/CAMEL-8688&quot; title=&quot;Removed StreamCache when doing a Wiretap&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CAMEL-8688&quot;&gt;&lt;del&gt;CAMEL-8688&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;That means, if this patch needs to be integrated into 2.15.x, either bring these previous changes into 2.15.x or adjust this patch to work without these change.&lt;/p&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10020">
                    <name>Cloners</name>
                                                                <inwardlinks description="is cloned by">
                                        <issuelink>
            <issuekey id="13223130">CAMEL-13357</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12827745">CXF-6394</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                            <outwardlinks description="breaks">
                                        <issuelink>
            <issuekey id="13096245">CAMEL-11681</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12730172" name="0001-CAMEL-8663-Namespaces-defined-on-SOAP-envelope-lost-.patch" size="55648" author="siano" created="Mon, 4 May 2015 12:47:29 +0000"/>
                            <attachment id="12731461" name="0001-Extension-to-Aki-s-patch.patch" size="22590" author="siano" created="Fri, 8 May 2015 12:15:17 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 15 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2dexz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>