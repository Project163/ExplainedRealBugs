[{"url":"https://api.github.com/repos/mockito/mockito/issues/comments/441296241","html_url":"https://github.com/mockito/mockito/issues/1541#issuecomment-441296241","issue_url":"https://api.github.com/repos/mockito/mockito/issues/1541","id":441296241,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTI5NjI0MQ==","user":{"login":"mockitoguy","id":24743,"node_id":"MDQ6VXNlcjI0NzQz","avatar_url":"https://avatars.githubusercontent.com/u/24743?v=4","gravatar_id":"","url":"https://api.github.com/users/mockitoguy","html_url":"https://github.com/mockitoguy","followers_url":"https://api.github.com/users/mockitoguy/followers","following_url":"https://api.github.com/users/mockitoguy/following{/other_user}","gists_url":"https://api.github.com/users/mockitoguy/gists{/gist_id}","starred_url":"https://api.github.com/users/mockitoguy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mockitoguy/subscriptions","organizations_url":"https://api.github.com/users/mockitoguy/orgs","repos_url":"https://api.github.com/users/mockitoguy/repos","events_url":"https://api.github.com/users/mockitoguy/events{/privacy}","received_events_url":"https://api.github.com/users/mockitoguy/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-11-23T18:00:08Z","updated_at":"2018-11-23T18:00:08Z","body":"Great investigation! Do you have a suggestion on how to resolve this?","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/mockito/mockito/issues/comments/441296241/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mockitoguy","id":24743,"node_id":"MDQ6VXNlcjI0NzQz","avatar_url":"https://avatars.githubusercontent.com/u/24743?v=4","gravatar_id":"","url":"https://api.github.com/users/mockitoguy","html_url":"https://github.com/mockitoguy","followers_url":"https://api.github.com/users/mockitoguy/followers","following_url":"https://api.github.com/users/mockitoguy/following{/other_user}","gists_url":"https://api.github.com/users/mockitoguy/gists{/gist_id}","starred_url":"https://api.github.com/users/mockitoguy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mockitoguy/subscriptions","organizations_url":"https://api.github.com/users/mockitoguy/orgs","repos_url":"https://api.github.com/users/mockitoguy/repos","events_url":"https://api.github.com/users/mockitoguy/events{/privacy}","received_events_url":"https://api.github.com/users/mockitoguy/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":1985070849,"node_id":"MDE1OlJlZmVyZW5jZWRFdmVudDE5ODUwNzA4NDk=","url":"https://api.github.com/repos/mockito/mockito/issues/events/1985070849","actor":{"login":"maxgrabenhorst","id":3321003,"node_id":"MDQ6VXNlcjMzMjEwMDM=","avatar_url":"https://avatars.githubusercontent.com/u/3321003?v=4","gravatar_id":"","url":"https://api.github.com/users/maxgrabenhorst","html_url":"https://github.com/maxgrabenhorst","followers_url":"https://api.github.com/users/maxgrabenhorst/followers","following_url":"https://api.github.com/users/maxgrabenhorst/following{/other_user}","gists_url":"https://api.github.com/users/maxgrabenhorst/gists{/gist_id}","starred_url":"https://api.github.com/users/maxgrabenhorst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maxgrabenhorst/subscriptions","organizations_url":"https://api.github.com/users/maxgrabenhorst/orgs","repos_url":"https://api.github.com/users/maxgrabenhorst/repos","events_url":"https://api.github.com/users/maxgrabenhorst/events{/privacy}","received_events_url":"https://api.github.com/users/maxgrabenhorst/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"f6e95923231e68c0f43ca27a5bfae12e0761b33f","commit_url":"https://api.github.com/repos/maxgrabenhorst/mockito/commits/f6e95923231e68c0f43ca27a5bfae12e0761b33f","created_at":"2018-11-24T17:15:26Z","performed_via_github_app":null},{"actor":{"login":"maxgrabenhorst","id":3321003,"node_id":"MDQ6VXNlcjMzMjEwMDM=","avatar_url":"https://avatars.githubusercontent.com/u/3321003?v=4","gravatar_id":"","url":"https://api.github.com/users/maxgrabenhorst","html_url":"https://github.com/maxgrabenhorst","followers_url":"https://api.github.com/users/maxgrabenhorst/followers","following_url":"https://api.github.com/users/maxgrabenhorst/following{/other_user}","gists_url":"https://api.github.com/users/maxgrabenhorst/gists{/gist_id}","starred_url":"https://api.github.com/users/maxgrabenhorst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maxgrabenhorst/subscriptions","organizations_url":"https://api.github.com/users/maxgrabenhorst/orgs","repos_url":"https://api.github.com/users/maxgrabenhorst/repos","events_url":"https://api.github.com/users/maxgrabenhorst/events{/privacy}","received_events_url":"https://api.github.com/users/maxgrabenhorst/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-11-24T17:50:01Z","updated_at":"2018-11-24T17:50:01Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/mockito/mockito/issues/1544","repository_url":"https://api.github.com/repos/mockito/mockito","labels_url":"https://api.github.com/repos/mockito/mockito/issues/1544/labels{/name}","comments_url":"https://api.github.com/repos/mockito/mockito/issues/1544/comments","events_url":"https://api.github.com/repos/mockito/mockito/issues/1544/events","html_url":"https://github.com/mockito/mockito/pull/1544","id":384008333,"node_id":"MDExOlB1bGxSZXF1ZXN0MjMzMzMxNTc3","number":1544,"title":"Fixes #1541: Prevent premature garbage collection of mock objects","user":{"login":"maxgrabenhorst","id":3321003,"node_id":"MDQ6VXNlcjMzMjEwMDM=","avatar_url":"https://avatars.githubusercontent.com/u/3321003?v=4","gravatar_id":"","url":"https://api.github.com/users/maxgrabenhorst","html_url":"https://github.com/maxgrabenhorst","followers_url":"https://api.github.com/users/maxgrabenhorst/followers","following_url":"https://api.github.com/users/maxgrabenhorst/following{/other_user}","gists_url":"https://api.github.com/users/maxgrabenhorst/gists{/gist_id}","starred_url":"https://api.github.com/users/maxgrabenhorst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maxgrabenhorst/subscriptions","organizations_url":"https://api.github.com/users/maxgrabenhorst/orgs","repos_url":"https://api.github.com/users/maxgrabenhorst/repos","events_url":"https://api.github.com/users/maxgrabenhorst/events{/privacy}","received_events_url":"https://api.github.com/users/maxgrabenhorst/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2018-11-24T17:50:01Z","updated_at":"2018-11-26T16:01:50Z","closed_at":"2018-11-26T15:59:15Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"draft":false,"repository":{"id":6207167,"node_id":"MDEwOlJlcG9zaXRvcnk2MjA3MTY3","name":"mockito","full_name":"mockito/mockito","private":false,"owner":{"login":"mockito","id":2054056,"node_id":"MDEyOk9yZ2FuaXphdGlvbjIwNTQwNTY=","avatar_url":"https://avatars.githubusercontent.com/u/2054056?v=4","gravatar_id":"","url":"https://api.github.com/users/mockito","html_url":"https://github.com/mockito","followers_url":"https://api.github.com/users/mockito/followers","following_url":"https://api.github.com/users/mockito/following{/other_user}","gists_url":"https://api.github.com/users/mockito/gists{/gist_id}","starred_url":"https://api.github.com/users/mockito/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mockito/subscriptions","organizations_url":"https://api.github.com/users/mockito/orgs","repos_url":"https://api.github.com/users/mockito/repos","events_url":"https://api.github.com/users/mockito/events{/privacy}","received_events_url":"https://api.github.com/users/mockito/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/mockito/mockito","description":"Most popular Mocking framework for unit tests written in Java","fork":false,"url":"https://api.github.com/repos/mockito/mockito","forks_url":"https://api.github.com/repos/mockito/mockito/forks","keys_url":"https://api.github.com/repos/mockito/mockito/keys{/key_id}","collaborators_url":"https://api.github.com/repos/mockito/mockito/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/mockito/mockito/teams","hooks_url":"https://api.github.com/repos/mockito/mockito/hooks","issue_events_url":"https://api.github.com/repos/mockito/mockito/issues/events{/number}","events_url":"https://api.github.com/repos/mockito/mockito/events","assignees_url":"https://api.github.com/repos/mockito/mockito/assignees{/user}","branches_url":"https://api.github.com/repos/mockito/mockito/branches{/branch}","tags_url":"https://api.github.com/repos/mockito/mockito/tags","blobs_url":"https://api.github.com/repos/mockito/mockito/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/mockito/mockito/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/mockito/mockito/git/refs{/sha}","trees_url":"https://api.github.com/repos/mockito/mockito/git/trees{/sha}","statuses_url":"https://api.github.com/repos/mockito/mockito/statuses/{sha}","languages_url":"https://api.github.com/repos/mockito/mockito/languages","stargazers_url":"https://api.github.com/repos/mockito/mockito/stargazers","contributors_url":"https://api.github.com/repos/mockito/mockito/contributors","subscribers_url":"https://api.github.com/repos/mockito/mockito/subscribers","subscription_url":"https://api.github.com/repos/mockito/mockito/subscription","commits_url":"https://api.github.com/repos/mockito/mockito/commits{/sha}","git_commits_url":"https://api.github.com/repos/mockito/mockito/git/commits{/sha}","comments_url":"https://api.github.com/repos/mockito/mockito/comments{/number}","issue_comment_url":"https://api.github.com/repos/mockito/mockito/issues/comments{/number}","contents_url":"https://api.github.com/repos/mockito/mockito/contents/{+path}","compare_url":"https://api.github.com/repos/mockito/mockito/compare/{base}...{head}","merges_url":"https://api.github.com/repos/mockito/mockito/merges","archive_url":"https://api.github.com/repos/mockito/mockito/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/mockito/mockito/downloads","issues_url":"https://api.github.com/repos/mockito/mockito/issues{/number}","pulls_url":"https://api.github.com/repos/mockito/mockito/pulls{/number}","milestones_url":"https://api.github.com/repos/mockito/mockito/milestones{/number}","notifications_url":"https://api.github.com/repos/mockito/mockito/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/mockito/mockito/labels{/name}","releases_url":"https://api.github.com/repos/mockito/mockito/releases{/id}","deployments_url":"https://api.github.com/repos/mockito/mockito/deployments","created_at":"2012-10-13T20:27:12Z","updated_at":"2025-11-09T13:17:53Z","pushed_at":"2025-10-31T15:40:36Z","git_url":"git://github.com/mockito/mockito.git","ssh_url":"git@github.com:mockito/mockito.git","clone_url":"https://github.com/mockito/mockito.git","svn_url":"https://github.com/mockito/mockito","homepage":"http://mockito.org","size":49566,"stargazers_count":15310,"watchers_count":15310,"language":"Java","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":true,"has_pages":true,"has_discussions":true,"forks_count":2642,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":476,"license":{"key":"mit","name":"MIT License","spdx_id":"MIT","url":"https://api.github.com/licenses/mit","node_id":"MDc6TGljZW5zZTEz"},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["java","java-library","mock","mock-library","mocking","mocking-framework","mockito","mocks","test-automation","test-driven-development","testing","testing-tools"],"visibility":"public","forks":2642,"open_issues":476,"watchers":15310,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"pull_request":{"url":"https://api.github.com/repos/mockito/mockito/pulls/1544","html_url":"https://github.com/mockito/mockito/pull/1544","diff_url":"https://github.com/mockito/mockito/pull/1544.diff","patch_url":"https://github.com/mockito/mockito/pull/1544.patch","merged_at":"2018-11-26T15:59:14Z"},"body":"Fixes #1541.\r\n\r\nIf using 'One-liner stubs' (https://static.javadoc.io/org.mockito/mockito-core/2.23.4/org/mockito/Mockito.html#one_liner_stub) the mock object may be premature cleaned up and returning the mock fails with an exception. This occurs because there is no strong reference to the mock itself.\r\n\r\nTherefore we need to maintain a strong reference to the mock until we've returned it, while making sure that the GC can still cleanup the mock correctly when needed.\r\n\r\nCause implementations of `BaseStubbing` are intended to be cleaned up after usage, we can store a strong ref to the mock there. `getMock` then uses the strong ref (instead of the weak ref provided by the invocation). After cleaning up the implementations of  `BaseStubbing` there is no strong ref to the mock itself anymore (except the one in the test class).\r\n\r\nI tried some alternative solutions but I believe this is the only way it works.\r\n\r\n----\r\n\r\nBind last mock creation to mockingProgress does not work because of this:\r\n```\r\nwhen(mock(TestClass2.class).getTestClass()).thenReturn(mock(TestClass.class)).getMock();\r\n```\r\n\r\nBind mock of last invocation for stubbing to mockingProgress does not work because of this:\r\n```\r\nwhen(mock(TestClass.class).getStuff()).thenReturn(\"X\").thenReturn(\r\n    when(mock(TestClass.class).getStuff()).thenReturn(\"XXX\").<TestClass>getMock().getStuff()\r\n).getMock();\r\n```","reactions":{"url":"https://api.github.com/repos/mockito/mockito/issues/1544/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mockito/mockito/issues/1544/timeline","performed_via_github_app":null,"state_reason":null}},"event":"cross-referenced"},{"url":"https://api.github.com/repos/mockito/mockito/issues/comments/441384903","html_url":"https://github.com/mockito/mockito/issues/1541#issuecomment-441384903","issue_url":"https://api.github.com/repos/mockito/mockito/issues/1541","id":441384903,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTM4NDkwMw==","user":{"login":"maxgrabenhorst","id":3321003,"node_id":"MDQ6VXNlcjMzMjEwMDM=","avatar_url":"https://avatars.githubusercontent.com/u/3321003?v=4","gravatar_id":"","url":"https://api.github.com/users/maxgrabenhorst","html_url":"https://github.com/maxgrabenhorst","followers_url":"https://api.github.com/users/maxgrabenhorst/followers","following_url":"https://api.github.com/users/maxgrabenhorst/following{/other_user}","gists_url":"https://api.github.com/users/maxgrabenhorst/gists{/gist_id}","starred_url":"https://api.github.com/users/maxgrabenhorst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maxgrabenhorst/subscriptions","organizations_url":"https://api.github.com/users/maxgrabenhorst/orgs","repos_url":"https://api.github.com/users/maxgrabenhorst/repos","events_url":"https://api.github.com/users/maxgrabenhorst/events{/privacy}","received_events_url":"https://api.github.com/users/maxgrabenhorst/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-11-24T18:00:07Z","updated_at":"2018-11-24T18:00:07Z","body":"Tried different approaches. I believe I found one solution that works well. Created a PR.","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/mockito/mockito/issues/comments/441384903/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"maxgrabenhorst","id":3321003,"node_id":"MDQ6VXNlcjMzMjEwMDM=","avatar_url":"https://avatars.githubusercontent.com/u/3321003?v=4","gravatar_id":"","url":"https://api.github.com/users/maxgrabenhorst","html_url":"https://github.com/maxgrabenhorst","followers_url":"https://api.github.com/users/maxgrabenhorst/followers","following_url":"https://api.github.com/users/maxgrabenhorst/following{/other_user}","gists_url":"https://api.github.com/users/maxgrabenhorst/gists{/gist_id}","starred_url":"https://api.github.com/users/maxgrabenhorst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maxgrabenhorst/subscriptions","organizations_url":"https://api.github.com/users/maxgrabenhorst/orgs","repos_url":"https://api.github.com/users/maxgrabenhorst/repos","events_url":"https://api.github.com/users/maxgrabenhorst/events{/privacy}","received_events_url":"https://api.github.com/users/maxgrabenhorst/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":1987173267,"node_id":"MDExOkNsb3NlZEV2ZW50MTk4NzE3MzI2Nw==","url":"https://api.github.com/repos/mockito/mockito/issues/events/1987173267","actor":{"login":"mockitoguy","id":24743,"node_id":"MDQ6VXNlcjI0NzQz","avatar_url":"https://avatars.githubusercontent.com/u/24743?v=4","gravatar_id":"","url":"https://api.github.com/users/mockitoguy","html_url":"https://github.com/mockitoguy","followers_url":"https://api.github.com/users/mockitoguy/followers","following_url":"https://api.github.com/users/mockitoguy/following{/other_user}","gists_url":"https://api.github.com/users/mockitoguy/gists{/gist_id}","starred_url":"https://api.github.com/users/mockitoguy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mockitoguy/subscriptions","organizations_url":"https://api.github.com/users/mockitoguy/orgs","repos_url":"https://api.github.com/users/mockitoguy/repos","events_url":"https://api.github.com/users/mockitoguy/events{/privacy}","received_events_url":"https://api.github.com/users/mockitoguy/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"closed","commit_id":null,"commit_url":null,"created_at":"2018-11-26T15:59:15Z","state_reason":null,"performed_via_github_app":null},{"id":1987173679,"node_id":"MDE1OlJlZmVyZW5jZWRFdmVudDE5ODcxNzM2Nzk=","url":"https://api.github.com/repos/mockito/mockito/issues/events/1987173679","actor":{"login":"mockitoguy","id":24743,"node_id":"MDQ6VXNlcjI0NzQz","avatar_url":"https://avatars.githubusercontent.com/u/24743?v=4","gravatar_id":"","url":"https://api.github.com/users/mockitoguy","html_url":"https://github.com/mockitoguy","followers_url":"https://api.github.com/users/mockitoguy/followers","following_url":"https://api.github.com/users/mockitoguy/following{/other_user}","gists_url":"https://api.github.com/users/mockitoguy/gists{/gist_id}","starred_url":"https://api.github.com/users/mockitoguy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mockitoguy/subscriptions","organizations_url":"https://api.github.com/users/mockitoguy/orgs","repos_url":"https://api.github.com/users/mockitoguy/repos","events_url":"https://api.github.com/users/mockitoguy/events{/privacy}","received_events_url":"https://api.github.com/users/mockitoguy/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"8dd8d1ad916c37fdebfccbfe72d46534fd82f5fa","commit_url":"https://api.github.com/repos/mockito/mockito/commits/8dd8d1ad916c37fdebfccbfe72d46534fd82f5fa","created_at":"2018-11-26T15:59:22Z","performed_via_github_app":null},{"actor":{"login":"maxgrabenhorst","id":3321003,"node_id":"MDQ6VXNlcjMzMjEwMDM=","avatar_url":"https://avatars.githubusercontent.com/u/3321003?v=4","gravatar_id":"","url":"https://api.github.com/users/maxgrabenhorst","html_url":"https://github.com/maxgrabenhorst","followers_url":"https://api.github.com/users/maxgrabenhorst/followers","following_url":"https://api.github.com/users/maxgrabenhorst/following{/other_user}","gists_url":"https://api.github.com/users/maxgrabenhorst/gists{/gist_id}","starred_url":"https://api.github.com/users/maxgrabenhorst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maxgrabenhorst/subscriptions","organizations_url":"https://api.github.com/users/maxgrabenhorst/orgs","repos_url":"https://api.github.com/users/maxgrabenhorst/repos","events_url":"https://api.github.com/users/maxgrabenhorst/events{/privacy}","received_events_url":"https://api.github.com/users/maxgrabenhorst/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-11-27T20:34:04Z","updated_at":"2018-11-27T20:34:04Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/mockito/mockito/issues/1547","repository_url":"https://api.github.com/repos/mockito/mockito","labels_url":"https://api.github.com/repos/mockito/mockito/issues/1547/labels{/name}","comments_url":"https://api.github.com/repos/mockito/mockito/issues/1547/comments","events_url":"https://api.github.com/repos/mockito/mockito/issues/1547/events","html_url":"https://github.com/mockito/mockito/issues/1547","id":384529390,"node_id":"MDU6SXNzdWUzODQ1MjkzOTA=","number":1547,"title":"Unexpected behaviour of the stubbing API (when using the API in a wrong or unintended way)","user":{"login":"maxgrabenhorst","id":3321003,"node_id":"MDQ6VXNlcjMzMjEwMDM=","avatar_url":"https://avatars.githubusercontent.com/u/3321003?v=4","gravatar_id":"","url":"https://api.github.com/users/maxgrabenhorst","html_url":"https://github.com/maxgrabenhorst","followers_url":"https://api.github.com/users/maxgrabenhorst/followers","following_url":"https://api.github.com/users/maxgrabenhorst/following{/other_user}","gists_url":"https://api.github.com/users/maxgrabenhorst/gists{/gist_id}","starred_url":"https://api.github.com/users/maxgrabenhorst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maxgrabenhorst/subscriptions","organizations_url":"https://api.github.com/users/maxgrabenhorst/orgs","repos_url":"https://api.github.com/users/maxgrabenhorst/repos","events_url":"https://api.github.com/users/maxgrabenhorst/events{/privacy}","received_events_url":"https://api.github.com/users/maxgrabenhorst/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"mockitoguy","id":24743,"node_id":"MDQ6VXNlcjI0NzQz","avatar_url":"https://avatars.githubusercontent.com/u/24743?v=4","gravatar_id":"","url":"https://api.github.com/users/mockitoguy","html_url":"https://github.com/mockitoguy","followers_url":"https://api.github.com/users/mockitoguy/followers","following_url":"https://api.github.com/users/mockitoguy/following{/other_user}","gists_url":"https://api.github.com/users/mockitoguy/gists{/gist_id}","starred_url":"https://api.github.com/users/mockitoguy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mockitoguy/subscriptions","organizations_url":"https://api.github.com/users/mockitoguy/orgs","repos_url":"https://api.github.com/users/mockitoguy/repos","events_url":"https://api.github.com/users/mockitoguy/events{/privacy}","received_events_url":"https://api.github.com/users/mockitoguy/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"mockitoguy","id":24743,"node_id":"MDQ6VXNlcjI0NzQz","avatar_url":"https://avatars.githubusercontent.com/u/24743?v=4","gravatar_id":"","url":"https://api.github.com/users/mockitoguy","html_url":"https://github.com/mockitoguy","followers_url":"https://api.github.com/users/mockitoguy/followers","following_url":"https://api.github.com/users/mockitoguy/following{/other_user}","gists_url":"https://api.github.com/users/mockitoguy/gists{/gist_id}","starred_url":"https://api.github.com/users/mockitoguy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mockitoguy/subscriptions","organizations_url":"https://api.github.com/users/mockitoguy/orgs","repos_url":"https://api.github.com/users/mockitoguy/repos","events_url":"https://api.github.com/users/mockitoguy/events{/privacy}","received_events_url":"https://api.github.com/users/mockitoguy/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":3,"created_at":"2018-11-26T22:02:04Z","updated_at":"2018-11-28T16:18:57Z","closed_at":"2018-11-28T16:18:57Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":6207167,"node_id":"MDEwOlJlcG9zaXRvcnk2MjA3MTY3","name":"mockito","full_name":"mockito/mockito","private":false,"owner":{"login":"mockito","id":2054056,"node_id":"MDEyOk9yZ2FuaXphdGlvbjIwNTQwNTY=","avatar_url":"https://avatars.githubusercontent.com/u/2054056?v=4","gravatar_id":"","url":"https://api.github.com/users/mockito","html_url":"https://github.com/mockito","followers_url":"https://api.github.com/users/mockito/followers","following_url":"https://api.github.com/users/mockito/following{/other_user}","gists_url":"https://api.github.com/users/mockito/gists{/gist_id}","starred_url":"https://api.github.com/users/mockito/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mockito/subscriptions","organizations_url":"https://api.github.com/users/mockito/orgs","repos_url":"https://api.github.com/users/mockito/repos","events_url":"https://api.github.com/users/mockito/events{/privacy}","received_events_url":"https://api.github.com/users/mockito/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/mockito/mockito","description":"Most popular Mocking framework for unit tests written in Java","fork":false,"url":"https://api.github.com/repos/mockito/mockito","forks_url":"https://api.github.com/repos/mockito/mockito/forks","keys_url":"https://api.github.com/repos/mockito/mockito/keys{/key_id}","collaborators_url":"https://api.github.com/repos/mockito/mockito/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/mockito/mockito/teams","hooks_url":"https://api.github.com/repos/mockito/mockito/hooks","issue_events_url":"https://api.github.com/repos/mockito/mockito/issues/events{/number}","events_url":"https://api.github.com/repos/mockito/mockito/events","assignees_url":"https://api.github.com/repos/mockito/mockito/assignees{/user}","branches_url":"https://api.github.com/repos/mockito/mockito/branches{/branch}","tags_url":"https://api.github.com/repos/mockito/mockito/tags","blobs_url":"https://api.github.com/repos/mockito/mockito/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/mockito/mockito/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/mockito/mockito/git/refs{/sha}","trees_url":"https://api.github.com/repos/mockito/mockito/git/trees{/sha}","statuses_url":"https://api.github.com/repos/mockito/mockito/statuses/{sha}","languages_url":"https://api.github.com/repos/mockito/mockito/languages","stargazers_url":"https://api.github.com/repos/mockito/mockito/stargazers","contributors_url":"https://api.github.com/repos/mockito/mockito/contributors","subscribers_url":"https://api.github.com/repos/mockito/mockito/subscribers","subscription_url":"https://api.github.com/repos/mockito/mockito/subscription","commits_url":"https://api.github.com/repos/mockito/mockito/commits{/sha}","git_commits_url":"https://api.github.com/repos/mockito/mockito/git/commits{/sha}","comments_url":"https://api.github.com/repos/mockito/mockito/comments{/number}","issue_comment_url":"https://api.github.com/repos/mockito/mockito/issues/comments{/number}","contents_url":"https://api.github.com/repos/mockito/mockito/contents/{+path}","compare_url":"https://api.github.com/repos/mockito/mockito/compare/{base}...{head}","merges_url":"https://api.github.com/repos/mockito/mockito/merges","archive_url":"https://api.github.com/repos/mockito/mockito/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/mockito/mockito/downloads","issues_url":"https://api.github.com/repos/mockito/mockito/issues{/number}","pulls_url":"https://api.github.com/repos/mockito/mockito/pulls{/number}","milestones_url":"https://api.github.com/repos/mockito/mockito/milestones{/number}","notifications_url":"https://api.github.com/repos/mockito/mockito/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/mockito/mockito/labels{/name}","releases_url":"https://api.github.com/repos/mockito/mockito/releases{/id}","deployments_url":"https://api.github.com/repos/mockito/mockito/deployments","created_at":"2012-10-13T20:27:12Z","updated_at":"2025-11-09T13:17:53Z","pushed_at":"2025-10-31T15:40:36Z","git_url":"git://github.com/mockito/mockito.git","ssh_url":"git@github.com:mockito/mockito.git","clone_url":"https://github.com/mockito/mockito.git","svn_url":"https://github.com/mockito/mockito","homepage":"http://mockito.org","size":49566,"stargazers_count":15310,"watchers_count":15310,"language":"Java","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":true,"has_pages":true,"has_discussions":true,"forks_count":2642,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":476,"license":{"key":"mit","name":"MIT License","spdx_id":"MIT","url":"https://api.github.com/licenses/mit","node_id":"MDc6TGljZW5zZTEz"},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["java","java-library","mock","mock-library","mocking","mocking-framework","mockito","mocks","test-automation","test-driven-development","testing","testing-tools"],"visibility":"public","forks":2642,"open_issues":476,"watchers":15310,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"### Problem\r\nWhen using the stubbing API in an unintended way, this could lead to the following issues:\r\n\r\n```\r\npublic class InvalidUsageTest extends TestBase {\r\n\r\n    @Mock private IMethods mock;\r\n\r\n    @Test\r\n    public void failure_scenario_1() {\r\n        mock.simpleMethod();\r\n        final OngoingStubbing<String> ongoingStubbing = when(mock.simpleMethod());\r\n        ongoingStubbing.thenReturn(\"A\");\r\n        ongoingStubbing.thenReturn(\"B\");\r\n        assertEquals(\"B\", mock.simpleMethod());\r\n    }\r\n\r\n    @Test\r\n    public void failure_scenario_2_1() {\r\n        final OngoingStubbing<String> ongoingStubbing = when(mock.simpleMethod());\r\n        ongoingStubbing.thenReturn(\"A\");\r\n        mock.differentMethod();\r\n        ongoingStubbing.thenReturn(\"B\");\r\n        assertEquals(\"A\", mock.simpleMethod());\r\n        assertEquals(\"B\", mock.differentMethod());\r\n    }\r\n\r\n    @Test\r\n    public void failure_scenario_2_2() {\r\n        final OngoingStubbing<String> ongoingStubbing =\r\n                                when(mock.simpleMethod()).thenReturn(\"A\");\r\n        when(mock.differentMethod()).thenReturn(\"B\");\r\n        ongoingStubbing.thenReturn(\"C\");\r\n        assertEquals(\"A\", mock.simpleMethod());\r\n        assertNotEquals(\"C\", mock.simpleMethod());\r\n        assertEquals(\"B\", mock.differentMethod());\r\n        assertEquals(\"C\", mock.differentMethod());\r\n    }\r\n}\r\n```\r\n\r\n#### Scenario 1\r\nWhen calling a mock method before actual stubbing, it is possible to call the `thenReturn()` multiple times (as often as the mock method was called before). An exception would be expected but instead the first call of `thenReturn(\"A\")` will be overridden with `thenReturn(\"B\")`\r\n\r\n#### Scenario 2.1\r\nWhen calling a mock method (e.g. `mock.differentMethod()`)  between two calls of `.thenReturn()` on the same `OngoingStubbing` object (created by passing `mock.simpleMethod()` to `when` method), instead of getting an exception (or overriding the previous call, like scenario 1.1) the `differentMethod()` method will be stubbed.\r\n\r\n#### Scenario 2.2\r\nQuite the same as scenario 2.1, but occurs when stubbing consecutively.\r\n\r\n### Analysis\r\n#### Scenario 2.1 / 2.2\r\nThis happens because the behaviour of `OngoingStubbing` depends on the state of the `InvocationContainerImpl`. This state changes in the background while executing methods of the mock, without notifying the `OngoingStubbing` implementations about changes, e.g. change of the `invocationForStubbing`. When adding a new answer using an already created `OngoingStubbing`, it may happen that the `invocationForStubbing` has changed and hence the wrong method will be stubbed.\r\n#### Scenario 1\r\nIn this case the check whether `thenReturn()` can be called relies on the `registeredInvocations` of the `InvocationContainerImpl` (when register not empty, `thenReturn()` can be called; `thenReturn()` removes last invocation from register). Here again this state can be modified by calling any method of the mock and hence it is possible to increase the `registeredInvocations` count before stubbing the actual method, which results in the possibility to call the `thenReturn()` method multiple times.\r\n\r\n-------\r\n\r\nWhat do you think Szczepan, should this unintended / wrong API usage result in proper exception messages or is this unexpected behaviour okay, when using the API in an unintended way?","reactions":{"url":"https://api.github.com/repos/mockito/mockito/issues/1547/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mockito/mockito/issues/1547/timeline","performed_via_github_app":null,"state_reason":"completed"}},"event":"cross-referenced"},{"actor":{"login":"bartcharbon","id":3714029,"node_id":"MDQ6VXNlcjM3MTQwMjk=","avatar_url":"https://avatars.githubusercontent.com/u/3714029?v=4","gravatar_id":"","url":"https://api.github.com/users/bartcharbon","html_url":"https://github.com/bartcharbon","followers_url":"https://api.github.com/users/bartcharbon/followers","following_url":"https://api.github.com/users/bartcharbon/following{/other_user}","gists_url":"https://api.github.com/users/bartcharbon/gists{/gist_id}","starred_url":"https://api.github.com/users/bartcharbon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bartcharbon/subscriptions","organizations_url":"https://api.github.com/users/bartcharbon/orgs","repos_url":"https://api.github.com/users/bartcharbon/repos","events_url":"https://api.github.com/users/bartcharbon/events{/privacy}","received_events_url":"https://api.github.com/users/bartcharbon/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-05-23T13:23:40Z","updated_at":"2019-05-23T13:23:40Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/molgenis/molgenis/issues/8516","repository_url":"https://api.github.com/repos/molgenis/molgenis","labels_url":"https://api.github.com/repos/molgenis/molgenis/issues/8516/labels{/name}","comments_url":"https://api.github.com/repos/molgenis/molgenis/issues/8516/comments","events_url":"https://api.github.com/repos/molgenis/molgenis/issues/8516/events","html_url":"https://github.com/molgenis/molgenis/issues/8516","id":447660677,"node_id":"MDU6SXNzdWU0NDc2NjA2Nzc=","number":8516,"title":"Unit test randomly fails with \"mock object was garbage collected\"","user":{"login":"bartcharbon","id":3714029,"node_id":"MDQ6VXNlcjM3MTQwMjk=","avatar_url":"https://avatars.githubusercontent.com/u/3714029?v=4","gravatar_id":"","url":"https://api.github.com/users/bartcharbon","html_url":"https://github.com/bartcharbon","followers_url":"https://api.github.com/users/bartcharbon/followers","following_url":"https://api.github.com/users/bartcharbon/following{/other_user}","gists_url":"https://api.github.com/users/bartcharbon/gists{/gist_id}","starred_url":"https://api.github.com/users/bartcharbon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bartcharbon/subscriptions","organizations_url":"https://api.github.com/users/bartcharbon/orgs","repos_url":"https://api.github.com/users/bartcharbon/repos","events_url":"https://api.github.com/users/bartcharbon/events{/privacy}","received_events_url":"https://api.github.com/users/bartcharbon/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":27272396,"node_id":"MDU6TGFiZWwyNzI3MjM5Ng==","url":"https://api.github.com/repos/molgenis/molgenis/labels/bug","name":"bug","color":"ff584c","default":true,"description":""},{"id":1300592612,"node_id":"MDU6TGFiZWwxMzAwNTkyNjEy","url":"https://api.github.com/repos/molgenis/molgenis/labels/8.0","name":"8.0","color":"0052cc","default":false,"description":""},{"id":1373692458,"node_id":"MDU6TGFiZWwxMzczNjkyNDU4","url":"https://api.github.com/repos/molgenis/molgenis/labels/8.1","name":"8.1","color":"496fd8","default":false,"description":""},{"id":1644545582,"node_id":"MDU6TGFiZWwxNjQ0NTQ1NTgy","url":"https://api.github.com/repos/molgenis/molgenis/labels/8.3","name":"8.3","color":"0052cc","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/molgenis/molgenis/milestones/90","html_url":"https://github.com/molgenis/molgenis/milestone/90","labels_url":"https://api.github.com/repos/molgenis/molgenis/milestones/90/labels","id":3443824,"node_id":"MDk6TWlsZXN0b25lMzQ0MzgyNA==","number":90,"title":"Backlog Next","description":"","creator":{"login":"mswertz","id":120060,"node_id":"MDQ6VXNlcjEyMDA2MA==","avatar_url":"https://avatars.githubusercontent.com/u/120060?v=4","gravatar_id":"","url":"https://api.github.com/users/mswertz","html_url":"https://github.com/mswertz","followers_url":"https://api.github.com/users/mswertz/followers","following_url":"https://api.github.com/users/mswertz/following{/other_user}","gists_url":"https://api.github.com/users/mswertz/gists{/gist_id}","starred_url":"https://api.github.com/users/mswertz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mswertz/subscriptions","organizations_url":"https://api.github.com/users/mswertz/orgs","repos_url":"https://api.github.com/users/mswertz/repos","events_url":"https://api.github.com/users/mswertz/events{/privacy}","received_events_url":"https://api.github.com/users/mswertz/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":24,"closed_issues":9,"state":"open","created_at":"2018-06-22T04:37:01Z","updated_at":"2020-08-27T07:53:35Z","due_on":"2020-01-01T08:00:00Z","closed_at":null},"comments":2,"created_at":"2019-05-23T13:23:40Z","updated_at":"2019-11-04T15:58:41Z","closed_at":"2019-11-04T15:58:41Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":8010626,"node_id":"MDEwOlJlcG9zaXRvcnk4MDEwNjI2","name":"molgenis","full_name":"molgenis/molgenis","private":false,"owner":{"login":"molgenis","id":1688158,"node_id":"MDEyOk9yZ2FuaXphdGlvbjE2ODgxNTg=","avatar_url":"https://avatars.githubusercontent.com/u/1688158?v=4","gravatar_id":"","url":"https://api.github.com/users/molgenis","html_url":"https://github.com/molgenis","followers_url":"https://api.github.com/users/molgenis/followers","following_url":"https://api.github.com/users/molgenis/following{/other_user}","gists_url":"https://api.github.com/users/molgenis/gists{/gist_id}","starred_url":"https://api.github.com/users/molgenis/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/molgenis/subscriptions","organizations_url":"https://api.github.com/users/molgenis/orgs","repos_url":"https://api.github.com/users/molgenis/repos","events_url":"https://api.github.com/users/molgenis/events{/privacy}","received_events_url":"https://api.github.com/users/molgenis/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/molgenis/molgenis","description":"MOLGENIS - for scientific data: management, exploration, integration and analysis. ","fork":false,"url":"https://api.github.com/repos/molgenis/molgenis","forks_url":"https://api.github.com/repos/molgenis/molgenis/forks","keys_url":"https://api.github.com/repos/molgenis/molgenis/keys{/key_id}","collaborators_url":"https://api.github.com/repos/molgenis/molgenis/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/molgenis/molgenis/teams","hooks_url":"https://api.github.com/repos/molgenis/molgenis/hooks","issue_events_url":"https://api.github.com/repos/molgenis/molgenis/issues/events{/number}","events_url":"https://api.github.com/repos/molgenis/molgenis/events","assignees_url":"https://api.github.com/repos/molgenis/molgenis/assignees{/user}","branches_url":"https://api.github.com/repos/molgenis/molgenis/branches{/branch}","tags_url":"https://api.github.com/repos/molgenis/molgenis/tags","blobs_url":"https://api.github.com/repos/molgenis/molgenis/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/molgenis/molgenis/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/molgenis/molgenis/git/refs{/sha}","trees_url":"https://api.github.com/repos/molgenis/molgenis/git/trees{/sha}","statuses_url":"https://api.github.com/repos/molgenis/molgenis/statuses/{sha}","languages_url":"https://api.github.com/repos/molgenis/molgenis/languages","stargazers_url":"https://api.github.com/repos/molgenis/molgenis/stargazers","contributors_url":"https://api.github.com/repos/molgenis/molgenis/contributors","subscribers_url":"https://api.github.com/repos/molgenis/molgenis/subscribers","subscription_url":"https://api.github.com/repos/molgenis/molgenis/subscription","commits_url":"https://api.github.com/repos/molgenis/molgenis/commits{/sha}","git_commits_url":"https://api.github.com/repos/molgenis/molgenis/git/commits{/sha}","comments_url":"https://api.github.com/repos/molgenis/molgenis/comments{/number}","issue_comment_url":"https://api.github.com/repos/molgenis/molgenis/issues/comments{/number}","contents_url":"https://api.github.com/repos/molgenis/molgenis/contents/{+path}","compare_url":"https://api.github.com/repos/molgenis/molgenis/compare/{base}...{head}","merges_url":"https://api.github.com/repos/molgenis/molgenis/merges","archive_url":"https://api.github.com/repos/molgenis/molgenis/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/molgenis/molgenis/downloads","issues_url":"https://api.github.com/repos/molgenis/molgenis/issues{/number}","pulls_url":"https://api.github.com/repos/molgenis/molgenis/pulls{/number}","milestones_url":"https://api.github.com/repos/molgenis/molgenis/milestones{/number}","notifications_url":"https://api.github.com/repos/molgenis/molgenis/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/molgenis/molgenis/labels{/name}","releases_url":"https://api.github.com/repos/molgenis/molgenis/releases{/id}","deployments_url":"https://api.github.com/repos/molgenis/molgenis/deployments","created_at":"2013-02-04T16:02:36Z","updated_at":"2025-08-13T11:10:23Z","pushed_at":"2025-07-29T10:02:40Z","git_url":"git://github.com/molgenis/molgenis.git","ssh_url":"git@github.com:molgenis/molgenis.git","clone_url":"https://github.com/molgenis/molgenis.git","svn_url":"https://github.com/molgenis/molgenis","homepage":"https://molgenis.org","size":172930,"stargazers_count":118,"watchers_count":118,"language":"Java","has_issues":true,"has_projects":false,"has_downloads":true,"has_wiki":false,"has_pages":false,"has_discussions":false,"forks_count":96,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":317,"license":{"key":"lgpl-3.0","name":"GNU Lesser General Public License v3.0","spdx_id":"LGPL-3.0","url":"https://api.github.com/licenses/lgpl-3.0","node_id":"MDc6TGljZW5zZTEy"},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["biobank","bioinformatics","catalogue","freemarker","genetics","java","javascript","lifescience","molgenis"],"visibility":"public","forks":96,"open_issues":317,"watchers":118,"default_branch":"master","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"We see this error now and again in our builds:\r\n...\"java.lang.IllegalStateException: The mock object was garbage collected. This should not happen in normal circumstances when using public API.\"...\r\n\r\nThis is probably caused by:\r\nhttps://github.com/mockito/mockito/issues/1541\r\nWhich was fixed in late in 2018:\r\nhttps://github.com/mockito/mockito/pull/1544\r\nHowever testNg support was dropped earlier that year:\r\nhttps://github.com/mockito/mockito-testng\r\n\r\npossible workaround, if it only happening in this test in our case, is to rewrite the test to a separate mock declaration and behaviour line. (so, no \"one-liner stub\")","reactions":{"url":"https://api.github.com/repos/molgenis/molgenis/issues/8516/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/molgenis/molgenis/issues/8516/timeline","performed_via_github_app":null,"state_reason":"completed"}},"event":"cross-referenced"}]