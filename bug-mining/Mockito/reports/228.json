{"url":"https://api.github.com/repos/mockito/mockito/issues/2238","repository_url":"https://api.github.com/repos/mockito/mockito","labels_url":"https://api.github.com/repos/mockito/mockito/issues/2238/labels{/name}","comments_url":"https://api.github.com/repos/mockito/mockito/issues/2238/comments","events_url":"https://api.github.com/repos/mockito/mockito/issues/2238/events","html_url":"https://github.com/mockito/mockito/issues/2238","id":838499438,"node_id":"MDU6SXNzdWU4Mzg0OTk0Mzg=","number":2238,"title":"Stacktraces of exceptions are trimmed too much","user":{"login":"hypfvieh","id":4946099,"node_id":"MDQ6VXNlcjQ5NDYwOTk=","avatar_url":"https://avatars.githubusercontent.com/u/4946099?v=4","gravatar_id":"","url":"https://api.github.com/users/hypfvieh","html_url":"https://github.com/hypfvieh","followers_url":"https://api.github.com/users/hypfvieh/followers","following_url":"https://api.github.com/users/hypfvieh/following{/other_user}","gists_url":"https://api.github.com/users/hypfvieh/gists{/gist_id}","starred_url":"https://api.github.com/users/hypfvieh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hypfvieh/subscriptions","organizations_url":"https://api.github.com/users/hypfvieh/orgs","repos_url":"https://api.github.com/users/hypfvieh/repos","events_url":"https://api.github.com/users/hypfvieh/events{/privacy}","received_events_url":"https://api.github.com/users/hypfvieh/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":532126464,"node_id":"MDU6TGFiZWw1MzIxMjY0NjQ=","url":"https://api.github.com/repos/mockito/mockito/labels/please%20contribute","name":"please contribute","color":"0e8a16","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2021-03-23T08:57:26Z","updated_at":"2021-11-26T13:12:01Z","closed_at":"2021-03-25T15:00:39Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Hi,\r\n\r\nI'm not sure if this is a bug or an intended behaviour.\r\n\r\nWhen testing a method which throws an exception (checked or unchecked), the causing line is suppressed in the stack coming from Mockito.\r\n\r\nSimple example:\r\n\r\n```java\r\npackage test;\r\n\r\nimport java.io.IOException;\r\n\r\nimport org.mockito.Mockito;\r\n\r\npublic class TestSpy {\r\n    public static void main(String[] args) throws IOException {\r\n        Foo spy = Mockito.spy(new Foo());\r\n        spy.message();\r\n    }\r\n\r\n    public static class Foo {\r\n        public void message() throws IOException {\r\n            System.out.println(\"Hello 1!\"); // line 15\r\n            System.out.println(\"Hello 2!\");\r\n            throw new IOException(\"fatal\"); // line 17\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nWhen calling 'message()' on the spy (same happens on a full mock as well), I would expect to see line 17 in the exception cause.\r\nInstead I see this:\r\n```\r\nException in thread \"main\" java.io.IOException: fatal\r\n\tat test.TestSpy$Foo.message(TestSpy.java:15)\r\n\tat test.TestSpy.main(TestSpy.java:10)\r\n```\r\n\r\nLine 15 contains 'System.out.println', which is not causing the exception, but is the first expression inside of the method 'message()'.\r\n\r\nI debugged this behaviour and came to `org.mockito.internal.creation.bytebuddy.MockMethodAdvice.hideRecursiveCall(Throwable, int, Class<?>)` \r\nwhich seems to be the root cause for this. \r\nThe stack trace given to that method includes the correct line (line 17 in this case). \r\n\r\nMy stack trace in this case has 18 entries in total:\r\n```\r\njava.io.IOException: fatal\r\n\tat test.TestSpy$Foo.message(TestSpy.java:17)\r\n\tat java.base/java.lang.invoke.MethodHandle.invokeWithArguments(MethodHandle.java:710)\r\n\tat org.mockito.internal.util.reflection.InstrumentationMemberAccessor$Dispatcher$ByteBuddy$2kmhnFkd.invokeWithArguments(Unknown Source)\r\n\tat org.mockito.internal.util.reflection.InstrumentationMemberAccessor.invoke(InstrumentationMemberAccessor.java:230)\r\n\tat org.mockito.internal.util.reflection.ModuleMemberAccessor.invoke(ModuleMemberAccessor.java:43)\r\n\tat org.mockito.internal.creation.bytebuddy.MockMethodAdvice.tryInvoke(MockMethodAdvice.java:329)\r\n\tat org.mockito.internal.creation.bytebuddy.MockMethodAdvice.access$500(MockMethodAdvice.java:56)\r\n\tat org.mockito.internal.creation.bytebuddy.MockMethodAdvice$RealMethodCall.invoke(MockMethodAdvice.java:249)\r\n\tat org.mockito.internal.invocation.InterceptedInvocation.callRealMethod(InterceptedInvocation.java:141)\r\n\tat org.mockito.internal.stubbing.answers.CallsRealMethods.answer(CallsRealMethods.java:44)\r\n\tat org.mockito.Answers.answer(Answers.java:98)\r\n\tat org.mockito.internal.handler.MockHandlerImpl.handle(MockHandlerImpl.java:106)\r\n\tat org.mockito.internal.handler.NullResultGuardian.handle(NullResultGuardian.java:29)\r\n\tat org.mockito.internal.handler.InvocationNotifierHandler.handle(InvocationNotifierHandler.java:33)\r\n\tat org.mockito.internal.creation.bytebuddy.MockMethodInterceptor.doIntercept(MockMethodInterceptor.java:82)\r\n\tat org.mockito.internal.creation.bytebuddy.MockMethodAdvice.handle(MockMethodAdvice.java:147)\r\n\tat test.TestSpy$Foo.message(TestSpy.java:15)\r\n\tat test.TestSpy.main(TestSpy.java:10)\r\n```\r\n\r\nWhen the method is finished, 13 entries are left and the most important entry is missing:\r\n```\r\njava.io.IOException: fatal\r\n\tat org.mockito.internal.creation.bytebuddy.MockMethodAdvice.tryInvoke(MockMethodAdvice.java:329)\r\n\tat org.mockito.internal.creation.bytebuddy.MockMethodAdvice.access$500(MockMethodAdvice.java:56)\r\n\tat org.mockito.internal.creation.bytebuddy.MockMethodAdvice$RealMethodCall.invoke(MockMethodAdvice.java:249)\r\n\tat org.mockito.internal.invocation.InterceptedInvocation.callRealMethod(InterceptedInvocation.java:141)\r\n\tat org.mockito.internal.stubbing.answers.CallsRealMethods.answer(CallsRealMethods.java:44)\r\n\tat org.mockito.Answers.answer(Answers.java:98)\r\n\tat org.mockito.internal.handler.MockHandlerImpl.handle(MockHandlerImpl.java:106)\r\n\tat org.mockito.internal.handler.NullResultGuardian.handle(NullResultGuardian.java:29)\r\n\tat org.mockito.internal.handler.InvocationNotifierHandler.handle(InvocationNotifierHandler.java:33)\r\n\tat org.mockito.internal.creation.bytebuddy.MockMethodInterceptor.doIntercept(MockMethodInterceptor.java:82)\r\n\tat org.mockito.internal.creation.bytebuddy.MockMethodAdvice.handle(MockMethodAdvice.java:147)\r\n\tat test.TestSpy$Foo.message(TestSpy.java:15)\r\n\tat test.TestSpy.main(TestSpy.java:10)\r\n```\r\n\r\nDisabling \"cleansStackTrace\" using MockitoConfiguration does not help - hideRecursiveCall is always called.\r\n\r\nThis bug/feature is very annoying when testing methods which may throw the same type of exception at different locations.\r\nEg. in my case I know that the exception was thrown in that very method, but I don't know if it happens in e.g. line 20 or 85.\r\n\r\nSame thing happens to `RuntimeException`s, which is also annoying... Seeing a NullPointerException without knowing where it happens is not helpful.\r\n\r\nIs there any (configuration) option to disable the 'cleaning' of the stack trace completely?\r\nAny chance of getting this fixed?\r\n\r\n**Tested Mockito versions:** 3.6.0 and 3.8.0\r\n**OS:** Linux/Ubuntu 20.04 64-Bit\r\n**JDK:** OpenJDK Runtime Environment AdoptOpenJDK (build 11.0.9+11)\r\n","closed_by":{"login":"TimvdLippe","id":5948271,"node_id":"MDQ6VXNlcjU5NDgyNzE=","avatar_url":"https://avatars.githubusercontent.com/u/5948271?v=4","gravatar_id":"","url":"https://api.github.com/users/TimvdLippe","html_url":"https://github.com/TimvdLippe","followers_url":"https://api.github.com/users/TimvdLippe/followers","following_url":"https://api.github.com/users/TimvdLippe/following{/other_user}","gists_url":"https://api.github.com/users/TimvdLippe/gists{/gist_id}","starred_url":"https://api.github.com/users/TimvdLippe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TimvdLippe/subscriptions","organizations_url":"https://api.github.com/users/TimvdLippe/orgs","repos_url":"https://api.github.com/users/TimvdLippe/repos","events_url":"https://api.github.com/users/TimvdLippe/events{/privacy}","received_events_url":"https://api.github.com/users/TimvdLippe/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mockito/mockito/issues/2238/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mockito/mockito/issues/2238/timeline","performed_via_github_app":null,"state_reason":"completed"}