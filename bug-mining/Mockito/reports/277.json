{"url":"https://api.github.com/repos/mockito/mockito/issues/2979","repository_url":"https://api.github.com/repos/mockito/mockito","labels_url":"https://api.github.com/repos/mockito/mockito/issues/2979/labels{/name}","comments_url":"https://api.github.com/repos/mockito/mockito/issues/2979/comments","events_url":"https://api.github.com/repos/mockito/mockito/issues/2979/events","html_url":"https://github.com/mockito/mockito/issues/2979","id":1671985348,"node_id":"I_kwDOAF62v85jqHjE","number":2979,"title":"`@Mock(serializable = true)` no longer works with parameterized types","user":{"login":"cpovirk","id":1703908,"node_id":"MDQ6VXNlcjE3MDM5MDg=","avatar_url":"https://avatars.githubusercontent.com/u/1703908?v=4","gravatar_id":"","url":"https://api.github.com/users/cpovirk","html_url":"https://github.com/cpovirk","followers_url":"https://api.github.com/users/cpovirk/followers","following_url":"https://api.github.com/users/cpovirk/following{/other_user}","gists_url":"https://api.github.com/users/cpovirk/gists{/gist_id}","starred_url":"https://api.github.com/users/cpovirk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cpovirk/subscriptions","organizations_url":"https://api.github.com/users/cpovirk/orgs","repos_url":"https://api.github.com/users/cpovirk/repos","events_url":"https://api.github.com/users/cpovirk/events{/privacy}","received_events_url":"https://api.github.com/users/cpovirk/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2023-04-17T21:20:21Z","updated_at":"2023-05-08T21:36:32Z","closed_at":"2023-05-08T21:36:32Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"This appears to be a result of #2923, though I've gotten myself a little confused trying to run the Mockito tests, so I haven't 100% confirmed that.\r\n\r\nAs a demonstration, I edited `MocksSerializationForAnnotationTest.java` to contain:\r\n\r\n```java\r\n@Mock(serializable = true)\r\nSupplier<Object> parameterizedSupplier;\r\n\r\n@Test\r\npublic void should_allow_mock_of_parameterized_type_to_be_serializable() throws Exception {\r\n  serializeAndBack(parameterizedSupplier);\r\n}\r\n```\r\n\r\nThat fails with:\r\n\r\n```\r\norg.mockitousage.basicapi.MocksSerializationForAnnotationTest > should_allow_mock_of_parameterized_type_to_be_serializable FAILED\r\n    java.io.NotSerializableException: sun.reflect.generics.reflectiveObjects.ParameterizedTypeImpl\r\n        at java.base/java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1185)\r\n        at java.base/java.io.ObjectOutputStream.defaultWriteFields(ObjectOutputStream.java:1553)\r\n        at java.base/java.io.ObjectOutputStream.writeSerialData(ObjectOutputStream.java:1510)\r\n        at java.base/java.io.ObjectOutputStream.writeOrdinaryObject(ObjectOutputStream.java:1433)\r\n        at java.base/java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1179)\r\n        at java.base/java.io.ObjectOutputStream.defaultWriteFields(ObjectOutputStream.java:1553)\r\n        at java.base/java.io.ObjectOutputStream.writeSerialData(ObjectOutputStream.java:1510)\r\n        at java.base/java.io.ObjectOutputStream.writeOrdinaryObject(ObjectOutputStream.java:1433)\r\n        at java.base/java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1179)\r\n        at java.base/java.io.ObjectOutputStream.defaultWriteFields(ObjectOutputStream.java:1553)\r\n        at java.base/java.io.ObjectOutputStream.writeSerialData(ObjectOutputStream.java:1510)\r\n        at java.base/java.io.ObjectOutputStream.writeOrdinaryObject(ObjectOutputStream.java:1433)\r\n        at java.base/java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1179)\r\n        at java.base/java.io.ObjectOutputStream.defaultWriteFields(ObjectOutputStream.java:1553)\r\n        at java.base/java.io.ObjectOutputStream.writeSerialData(ObjectOutputStream.java:1510)\r\n        at java.base/java.io.ObjectOutputStream.writeOrdinaryObject(ObjectOutputStream.java:1433)\r\n        at java.base/java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1179)\r\n        at java.base/java.io.ObjectOutputStream.defaultWriteFields(ObjectOutputStream.java:1553)\r\n        at java.base/java.io.ObjectOutputStream.writeSerialData(ObjectOutputStream.java:1510)\r\n        at java.base/java.io.ObjectOutputStream.writeOrdinaryObject(ObjectOutputStream.java:1433)\r\n        at java.base/java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1179)\r\n        at java.base/java.io.ObjectOutputStream.defaultWriteFields(ObjectOutputStream.java:1553)\r\n        at java.base/java.io.ObjectOutputStream.writeSerialData(ObjectOutputStream.java:1510)\r\n        at java.base/java.io.ObjectOutputStream.writeOrdinaryObject(ObjectOutputStream.java:1433)\r\n        at java.base/java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1179)\r\n        at java.base/java.io.ObjectOutputStream.writeObject(ObjectOutputStream.java:349)\r\n        at org.mockitoutil.SimpleSerializationUtil.serializeMock(SimpleSerializationUtil.java:40)\r\n        at org.mockitoutil.SimpleSerializationUtil.serializeAndBack(SimpleSerializationUtil.java:21)\r\n        at org.mockitousage.basicapi.MocksSerializationForAnnotationTest.should_allow_mock_of_parameterized_type_to_be_serializable(MocksSerializationForAnnotationTest.java:77)\r\n```\r\n\r\nI think I'm seeing it fixed if I change `CreationSettings.genericTypeToMock` to be `transient`. That _might_ be OK: The motivation for starting to use `genericTypeToMock` seems to have been for disambiguating between fields for `@InjectMocks`, so I wouldn't expect it to be needed after deserialization. But maybe `genericTypeToMock` is used in more advanced ways that _would_ matter after deserialization (say, to figure out what type a `Supplier<String>` should return from its `get` method in some cases), or maybe the hope is to use it in such ways in the future?\r\n\r\n(Alternatively, Mockito could skip setting the generic type for serializable mocks, but that could be surprising. Or Mockito could perform its own custom serialization and deserialization of parameterized types, but that sounds like a lot of work for little payoff.)\r\n\r\nIn the meantime, we can work around the problem by using `Mockito.mock(..., withSettings().serializable())` instead of `@Mock(serializable = true)` (since the former doesn't call `genericTypeToMock(...)`). But we do have one team that is reporting seeing this in a bunch of tests, so they'd have to shift their habits.\r\n\r\n@jfrantzius again :)","closed_by":{"login":"TimvdLippe","id":5948271,"node_id":"MDQ6VXNlcjU5NDgyNzE=","avatar_url":"https://avatars.githubusercontent.com/u/5948271?v=4","gravatar_id":"","url":"https://api.github.com/users/TimvdLippe","html_url":"https://github.com/TimvdLippe","followers_url":"https://api.github.com/users/TimvdLippe/followers","following_url":"https://api.github.com/users/TimvdLippe/following{/other_user}","gists_url":"https://api.github.com/users/TimvdLippe/gists{/gist_id}","starred_url":"https://api.github.com/users/TimvdLippe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TimvdLippe/subscriptions","organizations_url":"https://api.github.com/users/TimvdLippe/orgs","repos_url":"https://api.github.com/users/TimvdLippe/repos","events_url":"https://api.github.com/users/TimvdLippe/events{/privacy}","received_events_url":"https://api.github.com/users/TimvdLippe/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mockito/mockito/issues/2979/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mockito/mockito/issues/2979/timeline","performed_via_github_app":null,"state_reason":"completed"}