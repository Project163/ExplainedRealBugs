{"url":"https://api.github.com/repos/mockito/mockito/issues/3498","repository_url":"https://api.github.com/repos/mockito/mockito","labels_url":"https://api.github.com/repos/mockito/mockito/issues/3498/labels{/name}","comments_url":"https://api.github.com/repos/mockito/mockito/issues/3498/comments","events_url":"https://api.github.com/repos/mockito/mockito/issues/3498/events","html_url":"https://github.com/mockito/mockito/issues/3498","id":2638950555,"node_id":"I_kwDOAF62v86dSzCb","number":3498,"title":"Mockito fails with JVM internal error when mocking class clinit does not find a transitive dependency","user":{"login":"AndreasTu","id":14334055,"node_id":"MDQ6VXNlcjE0MzM0MDU1","avatar_url":"https://avatars.githubusercontent.com/u/14334055?v=4","gravatar_id":"","url":"https://api.github.com/users/AndreasTu","html_url":"https://github.com/AndreasTu","followers_url":"https://api.github.com/users/AndreasTu/followers","following_url":"https://api.github.com/users/AndreasTu/following{/other_user}","gists_url":"https://api.github.com/users/AndreasTu/gists{/gist_id}","starred_url":"https://api.github.com/users/AndreasTu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndreasTu/subscriptions","organizations_url":"https://api.github.com/users/AndreasTu/orgs","repos_url":"https://api.github.com/users/AndreasTu/repos","events_url":"https://api.github.com/users/AndreasTu/events{/privacy}","received_events_url":"https://api.github.com/users/AndreasTu/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2024-11-06T18:53:10Z","updated_at":"2024-12-03T05:42:06Z","closed_at":"2024-12-03T05:42:06Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"When tying to mock a class, where some transitive dependencies from the `<clinit>` are missing, Mockito swallows the root cause `NoClassDefFoundError`, but instead is reporting a JVM internal error\r\n `java.lang.InternalError: class redefinition failed: invalid class`, because the failing class is still tried to `retransform`.\r\n\r\nMockito reports the following exception:\r\n```\r\norg.mockito.exceptions.base.MockitoException: \r\nMockito cannot mock this class: class org.mockitousage.bugs.creation.MockClassWithMissingStaticDepTest$ClassWithErrorInCinit.\r\nMost likely it is a private class that is not visible by Mockito\r\n\r\nYou are seeing this disclaimer because Mockito is configured to create inlined mocks.\r\nYou can learn about inline mocks and their limitations under item #39 of the Mockito class javadoc.\r\n\r\n\tat org.mockito.internal.creation.bytebuddy.InlineDelegateByteBuddyMockMaker.prettifyFailure(InlineDelegateByteBuddyMockMaker.java:451)\r\n\tat org.mockito.internal.creation.bytebuddy.InlineDelegateByteBuddyMockMaker.createMockType(InlineDelegateByteBuddyMockMaker.java:416)\r\n\tat org.mockito.internal.creation.bytebuddy.InlineDelegateByteBuddyMockMaker.doCreateMock(InlineDelegateByteBuddyMockMaker.java:367)\r\n\tat org.mockito.internal.creation.bytebuddy.InlineDelegateByteBuddyMockMaker.createMock(InlineDelegateByteBuddyMockMaker.java:346)\r\n\tat org.mockito.internal.creation.bytebuddy.InlineByteBuddyMockMaker.createMock(InlineByteBuddyMockMaker.java:56)\r\n\tat org.mockito.internal.util.MockUtil.createMock(MockUtil.java:99)\r\n\tat org.mockito.internal.MockitoCore.mock(MockitoCore.java:84)\r\n\tat org.mockito.Mockito.mock(Mockito.java:2162)\r\n\tat org.mockito.Mockito.mock(Mockito.java:2077)\r\n\tat org.mockitousage.bugs.creation.MockClassWithMissingStaticDepTest.shouldNotSwallowCinitErrorsOfClassToMock(MockClassWithMissingStaticDepTest.java:21)\r\nCaused by: java.lang.IllegalArgumentException: Could not create type\r\n\tat net.bytebuddy.TypeCache.findOrInsert(TypeCache.java:170)\r\n\tat net.bytebuddy.TypeCache$WithInlineExpunction.findOrInsert(TypeCache.java:399)\r\n\tat net.bytebuddy.TypeCache.findOrInsert(TypeCache.java:190)\r\n\tat net.bytebuddy.TypeCache$WithInlineExpunction.findOrInsert(TypeCache.java:410)\r\n\tat org.mockito.internal.creation.bytebuddy.TypeCachingBytecodeGenerator.mockClass(TypeCachingBytecodeGenerator.java:75)\r\n\tat org.mockito.internal.creation.bytebuddy.InlineDelegateByteBuddyMockMaker.createMockType(InlineDelegateByteBuddyMockMaker.java:408)\r\n\t... 47 more\r\nCaused by: java.lang.InternalError: class redefinition failed: invalid class\r\n\tat java.instrument/sun.instrument.InstrumentationImpl.retransformClasses0(Native Method)\r\n\tat java.instrument/sun.instrument.InstrumentationImpl.retransformClasses(InstrumentationImpl.java:225)\r\n\tat org.mockito.internal.creation.bytebuddy.InlineBytecodeGenerator.triggerRetransformation(InlineBytecodeGenerator.java:285)\r\n\tat org.mockito.internal.creation.bytebuddy.InlineBytecodeGenerator.mockClass(InlineBytecodeGenerator.java:218)\r\n\tat org.mockito.internal.creation.bytebuddy.TypeCachingBytecodeGenerator.lambda$mockClass$0(TypeCachingBytecodeGenerator.java:78)\r\n\tat net.bytebuddy.TypeCache.findOrInsert(TypeCache.java:168)\r\n\t... 52 more\r\n```\r\n\r\n\r\nTest to reporduce the issue:\r\n\r\n```java\r\npublic class MockClassWithMissingStaticDepTest {\r\n\r\n    @Test\r\n    public void shouldNotSwallowCinitErrorsOfClassToMock() {\r\n        try {\r\n            @SuppressWarnings(\"unused\")\r\n            var unused = Mockito.mock(ClassWithErrorInClinit.class);\r\n\r\n            fail();\r\n        } catch (MockitoException e) {\r\n            e.printStackTrace();\r\n            var cause = e.getCause();\r\n            assertThat(cause).isInstanceOf(MockitoException.class);\r\n            assertThat(cause.getMessage()).isEqualTo(\"Cannot instrument class org.mockitousage.bugs.creation.MockClassWithMissingStaticDepTest$ClassWithErrorInCinit because it or one of its supertypes could not be initialized\");\r\n\r\n            var cause2 = cause.getCause();\r\n            assertThat(cause2).isInstanceOf(NoClassDefFoundError.class);\r\n            assertThat(cause2.getMessage()).isEqualTo(\"Simulate missing transitive dependency used in <clinit>.\");\r\n        }\r\n    }\r\n\r\n\r\n    private static class ClassWithErrorInClinit {\r\n        static {\r\n            //noinspection ConstantValue\r\n            if (true) {\r\n                throw new NoClassDefFoundError(\"Simulate missing transitive dependency used in <clinit>.\");\r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n## Root-Cause\r\nThe method `org.mockito.internal.creation.bytebuddy.InlineBytecodeGenerator.assureInitialization()` only handles `ExceptionInInitializerError` and swallows everything else.\r\n\r\n## Expected behavior\r\n\r\nMockito shall report the first `NoClassDefFoundError` instead of swallowing it.\r\n\r\nAffected version: `5.14.2`\r\nAffected JVM: `21`\r\n\r\nI will open a PR to fix the issue.","closed_by":{"login":"TimvdLippe","id":5948271,"node_id":"MDQ6VXNlcjU5NDgyNzE=","avatar_url":"https://avatars.githubusercontent.com/u/5948271?v=4","gravatar_id":"","url":"https://api.github.com/users/TimvdLippe","html_url":"https://github.com/TimvdLippe","followers_url":"https://api.github.com/users/TimvdLippe/followers","following_url":"https://api.github.com/users/TimvdLippe/following{/other_user}","gists_url":"https://api.github.com/users/TimvdLippe/gists{/gist_id}","starred_url":"https://api.github.com/users/TimvdLippe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TimvdLippe/subscriptions","organizations_url":"https://api.github.com/users/TimvdLippe/orgs","repos_url":"https://api.github.com/users/TimvdLippe/repos","events_url":"https://api.github.com/users/TimvdLippe/events{/privacy}","received_events_url":"https://api.github.com/users/TimvdLippe/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mockito/mockito/issues/3498/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mockito/mockito/issues/3498/timeline","performed_via_github_app":null,"state_reason":"completed"}