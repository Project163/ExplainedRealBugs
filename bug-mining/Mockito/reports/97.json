{"url":"https://api.github.com/repos/mockito/mockito/issues/845","repository_url":"https://api.github.com/repos/mockito/mockito","labels_url":"https://api.github.com/repos/mockito/mockito/issues/845/labels{/name}","comments_url":"https://api.github.com/repos/mockito/mockito/issues/845/comments","events_url":"https://api.github.com/repos/mockito/mockito/issues/845/events","html_url":"https://github.com/mockito/mockito/issues/845","id":197582722,"node_id":"MDU6SXNzdWUxOTc1ODI3MjI=","number":845,"title":"Rename MockMethodDispatcher.class to MockMethodDispatcher.raw on build","user":{"login":"raphw","id":4489328,"node_id":"MDQ6VXNlcjQ0ODkzMjg=","avatar_url":"https://avatars.githubusercontent.com/u/4489328?v=4","gravatar_id":"","url":"https://api.github.com/users/raphw","html_url":"https://github.com/raphw","followers_url":"https://api.github.com/users/raphw/followers","following_url":"https://api.github.com/users/raphw/following{/other_user}","gists_url":"https://api.github.com/users/raphw/gists{/gist_id}","starred_url":"https://api.github.com/users/raphw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/raphw/subscriptions","organizations_url":"https://api.github.com/users/raphw/orgs","repos_url":"https://api.github.com/users/raphw/repos","events_url":"https://api.github.com/users/raphw/events{/privacy}","received_events_url":"https://api.github.com/users/raphw/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":305646380,"node_id":"MDU6TGFiZWwzMDU2NDYzODA=","url":"https://api.github.com/repos/mockito/mockito/labels/android","name":"android","color":"009800","default":false,"description":null},{"id":450180641,"node_id":"MDU6TGFiZWw0NTAxODA2NDE=","url":"https://api.github.com/repos/mockito/mockito/labels/final-class-or-methods","name":"final-class-or-methods","color":"fbca04","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2016-12-26T12:25:45Z","updated_at":"2019-05-29T13:37:25Z","closed_at":"2016-12-27T17:49:02Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"The `org.mockito.internal.creation.bytebuddy.MockMethodDispatcher.class` file should be renamed to `org.mockito.internal.creation.bytebuddy.MockMethodDispatcher.raw` on building Mockito. This way, class loaders are no longer capable of loading the class directly what should never happen. Doing so, the bootstrap injection mechanism cannot be superseeded by child-first class loaders which break mockability due to the dispatcher class being loaded twice by two different class loaders.\r\n\r\nThis problem was observed with the Robolectrics class loader.\r\n\r\nAdditionally, the following change is required in the `InlineByteBuddyMockMaker` when creating the boot jar\r\n\r\n```java\r\nString source = \"org/mockito/internal/creation/bytebuddy/MockMethodDispatcher\";\r\noutputStream.putNextEntry(new JarEntry(source + \".class\"));\r\nInputStream inputStream = InlineByteBuddyMockMaker.class.getClassLoader().getResourceAsStream(source + \".raw\");\r\nif (inputStream == null) {\r\n  throw new MockitoInitializationException(join(\r\n    \"The MockMethodDispatcher class file could not be located \" + source,\r\n    \"\",\r\n    \"The class loader responsible: \" + InlineByteBuddyMockMaker.class.getClassLoader()\r\n  ));\r\n}\r\ntry {\r\n  int length;\r\n  byte[] buffer = new byte[1024];\r\n  while ((length = inputStream.read(buffer)) != -1) {\r\n    outputStream.write(buffer, 0, length);\r\n  }\r\n} finally {\r\n  inputStream.close();\r\n}\r\noutputStream.closeEntry();\r\n```","closed_by":{"login":"raphw","id":4489328,"node_id":"MDQ6VXNlcjQ0ODkzMjg=","avatar_url":"https://avatars.githubusercontent.com/u/4489328?v=4","gravatar_id":"","url":"https://api.github.com/users/raphw","html_url":"https://github.com/raphw","followers_url":"https://api.github.com/users/raphw/followers","following_url":"https://api.github.com/users/raphw/following{/other_user}","gists_url":"https://api.github.com/users/raphw/gists{/gist_id}","starred_url":"https://api.github.com/users/raphw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/raphw/subscriptions","organizations_url":"https://api.github.com/users/raphw/orgs","repos_url":"https://api.github.com/users/raphw/repos","events_url":"https://api.github.com/users/raphw/events{/privacy}","received_events_url":"https://api.github.com/users/raphw/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mockito/mockito/issues/845/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mockito/mockito/issues/845/timeline","performed_via_github_app":null,"state_reason":"completed"}