{"url":"https://api.github.com/repos/mockito/mockito/issues/1577","repository_url":"https://api.github.com/repos/mockito/mockito","labels_url":"https://api.github.com/repos/mockito/mockito/issues/1577/labels{/name}","comments_url":"https://api.github.com/repos/mockito/mockito/issues/1577/comments","events_url":"https://api.github.com/repos/mockito/mockito/issues/1577/events","html_url":"https://github.com/mockito/mockito/issues/1577","id":394364394,"node_id":"MDU6SXNzdWUzOTQzNjQzOTQ=","number":1577,"title":"IllegalAccessError on Java 11 when using module path","user":{"login":"marx-freedom","id":642092,"node_id":"MDQ6VXNlcjY0MjA5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/642092?v=4","gravatar_id":"","url":"https://api.github.com/users/marx-freedom","html_url":"https://github.com/marx-freedom","followers_url":"https://api.github.com/users/marx-freedom/followers","following_url":"https://api.github.com/users/marx-freedom/following{/other_user}","gists_url":"https://api.github.com/users/marx-freedom/gists{/gist_id}","starred_url":"https://api.github.com/users/marx-freedom/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/marx-freedom/subscriptions","organizations_url":"https://api.github.com/users/marx-freedom/orgs","repos_url":"https://api.github.com/users/marx-freedom/repos","events_url":"https://api.github.com/users/marx-freedom/events{/privacy}","received_events_url":"https://api.github.com/users/marx-freedom/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":399992302,"node_id":"MDU6TGFiZWwzOTk5OTIzMDI=","url":"https://api.github.com/repos/mockito/mockito/labels/in%20progress","name":"in progress","color":"ededed","default":false,"description":null},{"id":1087501916,"node_id":"MDU6TGFiZWwxMDg3NTAxOTE2","url":"https://api.github.com/repos/mockito/mockito/labels/java-11","name":"java-11","color":"b0ef88","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"raphw","id":4489328,"node_id":"MDQ6VXNlcjQ0ODkzMjg=","avatar_url":"https://avatars.githubusercontent.com/u/4489328?v=4","gravatar_id":"","url":"https://api.github.com/users/raphw","html_url":"https://github.com/raphw","followers_url":"https://api.github.com/users/raphw/followers","following_url":"https://api.github.com/users/raphw/following{/other_user}","gists_url":"https://api.github.com/users/raphw/gists{/gist_id}","starred_url":"https://api.github.com/users/raphw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/raphw/subscriptions","organizations_url":"https://api.github.com/users/raphw/orgs","repos_url":"https://api.github.com/users/raphw/repos","events_url":"https://api.github.com/users/raphw/events{/privacy}","received_events_url":"https://api.github.com/users/raphw/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"raphw","id":4489328,"node_id":"MDQ6VXNlcjQ0ODkzMjg=","avatar_url":"https://avatars.githubusercontent.com/u/4489328?v=4","gravatar_id":"","url":"https://api.github.com/users/raphw","html_url":"https://github.com/raphw","followers_url":"https://api.github.com/users/raphw/followers","following_url":"https://api.github.com/users/raphw/following{/other_user}","gists_url":"https://api.github.com/users/raphw/gists{/gist_id}","starred_url":"https://api.github.com/users/raphw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/raphw/subscriptions","organizations_url":"https://api.github.com/users/raphw/orgs","repos_url":"https://api.github.com/users/raphw/repos","events_url":"https://api.github.com/users/raphw/events{/privacy}","received_events_url":"https://api.github.com/users/raphw/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":7,"created_at":"2018-12-27T10:59:38Z","updated_at":"2019-03-04T10:46:52Z","closed_at":"2019-01-14T21:48:30Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Mockito cannot mock package private class when tests running with module path. It trying to use reflection and defineClass method by default and this does not work on Java 11. I've found PR #1355 and tried to use org.mockito.internal.simulateJava11 system property but it doesn't works either.\r\n\r\nI'm using:\r\nJava 11 (release), Maven 3.6.0, surefire-maven-plugin 3.0.0-M3, JUnit 5.3.2, Mockito 2.23.4 (2.23.11 have same issue).\r\n\r\nWith this configuration mockito and byte buddy are included in classpath, my modular jar is included in module path, and module system is configured correctly (I suppose :)).\r\n\r\nYou can check this on minimal sample project: [mockito-java11-jpms-example.zip](https://github.com/mockito/mockito/files/2712255/mockito-java11-jpms-example.zip) - just run `mvn clean test`.\r\n\r\n\r\nStacktrace\r\n```\r\nUnderlying exception : java.lang.IllegalStateException: Error invoking java.lang.invoke.MethodHandles$Lookup#defineClass                                                                              \r\n        at test.marx.mockito/test.marx.mockito.ServiceTest.testMockito(ServiceTest.java:17)                                                                                                           \r\n        at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)                                                                                                             \r\n        at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)                                                                                           \r\n        at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)                                                                                   \r\n        at java.base/java.lang.reflect.Method.invoke(Method.java:566)                                                                                                                                 \r\n        at org.junit.platform.commons.util.ReflectionUtils.invokeMethod(ReflectionUtils.java:532)                                                                                                     \r\n        at org.junit.jupiter.engine.execution.ExecutableInvoker.invoke(ExecutableInvoker.java:115)                                                                                                    \r\n        at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.lambda$invokeTestMethod$6(TestMethodTestDescriptor.java:171)                                                                  \r\n        at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:72)                                                                                      \r\n        at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.invokeTestMethod(TestMethodTestDescriptor.java:167)                                                                           \r\n        at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:114)                                                                                    \r\n        at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:59)                                                                                     \r\n        at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$4(NodeTestTask.java:108)                                                                             \r\n        at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:72)                                                                                      \r\n        at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:98)                                                                                       \r\n        at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:74)                                                                                                  \r\n        at java.base/java.util.ArrayList.forEach(ArrayList.java:1540)                                                                                                                                 \r\n        at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:38)                                      \r\n        at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$4(NodeTestTask.java:112)                                                                             \r\n        at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:72)                                                                                      \r\n        at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:98)                                                                                       \r\n        at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:74)                                                                                                  \r\n        at java.base/java.util.ArrayList.forEach(ArrayList.java:1540)                                                                                                                                 \r\n        at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:38)                                      \r\n        at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$4(NodeTestTask.java:112)                                                                             \r\n        at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:72)                                                                                      \r\n        at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:98)                                                                                       \r\n        at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:74)                                                                                                  \r\n        at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.submit(SameThreadHierarchicalTestExecutorService.java:32)                                         \r\n        at org.junit.platform.engine.support.hierarchical.HierarchicalTestExecutor.execute(HierarchicalTestExecutor.java:57)                                                                          \r\n        at org.junit.platform.engine.support.hierarchical.HierarchicalTestEngine.execute(HierarchicalTestEngine.java:51)                                                                              \r\n        at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:220)                                                                                                         \r\n        at org.junit.platform.launcher.core.DefaultLauncher.lambda$execute$6(DefaultLauncher.java:188)                                                                                                \r\n        at org.junit.platform.launcher.core.DefaultLauncher.withInterceptedStreams(DefaultLauncher.java:202)                                                                                          \r\n        at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:181)                                                                                                         \r\n        at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:128)                                                                                                         \r\n        at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.invokeAllTests(JUnitPlatformProvider.java:150)                                                                               \r\n        at org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.invoke(JUnitPlatformProvider.java:124)                                                                                       \r\n        at org.apache.maven.surefire.booter.ForkedBooter.invokeProviderInSameClassLoader(ForkedBooter.java:384)                                                                                       \r\n        at org.apache.maven.surefire.booter.ForkedBooter.runSuitesInProcess(ForkedBooter.java:345)                                                                                                    \r\n        at org.apache.maven.surefire.booter.ForkedBooter.execute(ForkedBooter.java:126)                                                                                                               \r\n        at org.apache.maven.surefire.booter.ForkedBooter.main(ForkedBooter.java:418)                                                                                                                  \r\nCaused by: java.lang.IllegalStateException: Error invoking java.lang.invoke.MethodHandles$Lookup#defineClass                                                                                          \r\n        at net.bytebuddy.dynamic.loading.ClassInjector$UsingLookup$Dispatcher$ForJava9CapableVm.defineClass(ClassInjector.java:1686)                                                                  \r\n        at net.bytebuddy.dynamic.loading.ClassInjector$UsingLookup.injectRaw(ClassInjector.java:1415)                                                                                                 \r\n        at net.bytebuddy.dynamic.loading.ClassInjector$AbstractBase.inject(ClassInjector.java:111)                                                                                                    \r\n        at net.bytebuddy.dynamic.loading.ClassLoadingStrategy$UsingLookup.load(ClassLoadingStrategy.java:466)                                                                                         \r\n        at net.bytebuddy.dynamic.TypeResolutionStrategy$Passive.initialize(TypeResolutionStrategy.java:100)                                                                                           \r\n        at net.bytebuddy.dynamic.DynamicType$Default$Unloaded.load(DynamicType.java:5623)                                                                                                             \r\n        at org.mockito.internal.creation.bytebuddy.SubclassBytecodeGenerator.mockClass(SubclassBytecodeGenerator.java:129)                                                                            \r\n        at org.mockito.internal.creation.bytebuddy.TypeCachingBytecodeGenerator$1.call(TypeCachingBytecodeGenerator.java:37)                                                                          \r\n        at org.mockito.internal.creation.bytebuddy.TypeCachingBytecodeGenerator$1.call(TypeCachingBytecodeGenerator.java:34)                                                                          \r\n        at net.bytebuddy.TypeCache.findOrInsert(TypeCache.java:152)                                                                                                                                   \r\n        at net.bytebuddy.TypeCache$WithInlineExpunction.findOrInsert(TypeCache.java:365)                                                                                                              \r\n        at net.bytebuddy.TypeCache.findOrInsert(TypeCache.java:174)                                                                                                                                   \r\n        at net.bytebuddy.TypeCache$WithInlineExpunction.findOrInsert(TypeCache.java:376)                                                                                                              \r\n        at org.mockito.internal.creation.bytebuddy.TypeCachingBytecodeGenerator.mockClass(TypeCachingBytecodeGenerator.java:32)                                                                       \r\n        at org.mockito.internal.creation.bytebuddy.SubclassByteBuddyMockMaker.createMockType(SubclassByteBuddyMockMaker.java:71)                                                                      \r\n        at org.mockito.internal.creation.bytebuddy.SubclassByteBuddyMockMaker.createMock(SubclassByteBuddyMockMaker.java:42)                                                                          \r\n        at org.mockito.internal.creation.bytebuddy.ByteBuddyMockMaker.createMock(ByteBuddyMockMaker.java:25)                                                                                          \r\n        at org.mockito.internal.util.MockUtil.createMock(MockUtil.java:35)                                                                                                                            \r\n        at org.mockito.internal.MockitoCore.mock(MockitoCore.java:69)                                                                                                                                 \r\n        at org.mockito.Mockito.mock(Mockito.java:1896)                                                                                                                                                \r\n        at org.mockito.Mockito.mock(Mockito.java:1805)                                                                                                                                                \r\n        ... 42 more                                                                                                                                                                                   \r\nCaused by: java.lang.IllegalAccessError: class org.mockito.codegen.IDependency$MockitoMock$1828864830 cannot access its superinterface test.marx.mockito.Service$IDependency (org.mockito.codegen.IDependency$MockitoMock$1828864830 is in unnamed module of loader 'app'; test.marx.mockito.Service$IDependency is in module test.marx.mockito of loader 'app')                                            \r\n        at java.base/java.lang.ClassLoader.defineClass1(Native Method)                                                                                                                                \r\n        at java.base/java.lang.System$2.defineClass(System.java:2123)                                                                                                                                 \r\n        at java.base/java.lang.invoke.MethodHandles$Lookup.defineClass(MethodHandles.java:962)                                                                                                        \r\n        at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)                                                                                                             \r\n        at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)                                                                                           \r\n        at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)                                                                                   \r\n        at java.base/java.lang.reflect.Method.invoke(Method.java:566)                                                                                                                                 \r\n        at net.bytebuddy.dynamic.loading.ClassInjector$UsingLookup$Dispatcher$ForJava9CapableVm.defineClass(ClassInjector.java:1682)                                                                  \r\n        ... 62 more                                                                                                                                                                                   ```\r\n\r\n","closed_by":{"login":"raphw","id":4489328,"node_id":"MDQ6VXNlcjQ0ODkzMjg=","avatar_url":"https://avatars.githubusercontent.com/u/4489328?v=4","gravatar_id":"","url":"https://api.github.com/users/raphw","html_url":"https://github.com/raphw","followers_url":"https://api.github.com/users/raphw/followers","following_url":"https://api.github.com/users/raphw/following{/other_user}","gists_url":"https://api.github.com/users/raphw/gists{/gist_id}","starred_url":"https://api.github.com/users/raphw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/raphw/subscriptions","organizations_url":"https://api.github.com/users/raphw/orgs","repos_url":"https://api.github.com/users/raphw/repos","events_url":"https://api.github.com/users/raphw/events{/privacy}","received_events_url":"https://api.github.com/users/raphw/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mockito/mockito/issues/1577/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mockito/mockito/issues/1577/timeline","performed_via_github_app":null,"state_reason":"completed"}