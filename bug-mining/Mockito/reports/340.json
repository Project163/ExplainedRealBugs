{"url":"https://api.github.com/repos/mockito/mockito/issues/3171","repository_url":"https://api.github.com/repos/mockito/mockito","labels_url":"https://api.github.com/repos/mockito/mockito/issues/3171/labels{/name}","comments_url":"https://api.github.com/repos/mockito/mockito/issues/3171/comments","events_url":"https://api.github.com/repos/mockito/mockito/issues/3171/events","html_url":"https://github.com/mockito/mockito/issues/3171","id":1987639069,"node_id":"I_kwDOAF62v852ePcd","number":3171,"title":"Mocks are not working on particular devices after update Android SDK from 33 to 34","user":{"login":"jukov","id":8081721,"node_id":"MDQ6VXNlcjgwODE3MjE=","avatar_url":"https://avatars.githubusercontent.com/u/8081721?v=4","gravatar_id":"","url":"https://api.github.com/users/jukov","html_url":"https://github.com/jukov","followers_url":"https://api.github.com/users/jukov/followers","following_url":"https://api.github.com/users/jukov/following{/other_user}","gists_url":"https://api.github.com/users/jukov/gists{/gist_id}","starred_url":"https://api.github.com/users/jukov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jukov/subscriptions","organizations_url":"https://api.github.com/users/jukov/orgs","repos_url":"https://api.github.com/users/jukov/repos","events_url":"https://api.github.com/users/jukov/events{/privacy}","received_events_url":"https://api.github.com/users/jukov/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2023-11-10T13:33:17Z","updated_at":"2025-03-28T10:04:05Z","closed_at":"2025-03-28T10:04:05Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"After seeing #3075, I've updated our project to Mockito 5.7.0 (btw I also tried 5.5.0), but even after that mocks are not working anymore on few on my devices. Then I was able to reproduce this issue in sample app which can be found [here](https://github.com/jukov/MockitoBugTest).\r\n\r\nI am trying to run this test:\r\n\r\n```\r\ninterface TestInterface {\r\n    fun foo(): Int\r\n}\r\n\r\n@RunWith(AndroidJUnit4::class)\r\nclass MockitoBugTest {\r\n\r\n    @Mock private val testInterface: TestInterface = mock(TestInterface::class.java)\r\n\r\n    @Before\r\n    fun setup() {\r\n        Mockito.`when`(testInterface.foo()).thenReturn(42)\r\n    }\r\n\r\n    @Test\r\n    fun foo() {\r\n        println(\"Success\")\r\n    }\r\n}\r\n```\r\n\r\nAfter what I receive the following error:\r\n\r\n<details>\r\n  <summary>Stacktrace</summary>\r\n\r\n```\r\njava.lang.ExceptionInInitializerError\r\nat org.mockito.internal.debugging.LocationFactory$DefaultLocationFactory.create(LocationFactory.java:48)\r\nat org.mockito.internal.debugging.LocationFactory.create(LocationFactory.java:19)\r\nat org.mockito.internal.debugging.LocationFactory.create(LocationFactory.java:15)\r\nat org.mockito.internal.creation.bytebuddy.MockMethodInterceptor.doIntercept(MockMethodInterceptor.java:56)\r\nat org.mockito.internal.creation.bytebuddy.MockMethodInterceptor$DispatcherDefaultingToRealMethod.interceptAbstract(MockMethodInterceptor.java:161)\r\nat info.jukov.mockitobugtest.TestInterface$MockitoMock$KqIWwkGD.foo(Unknown Source:15)\r\nat info.jukov.mockitobugtest.MockitoBugTest.setup(MockitoBugTest.kt:33)\r\n... 32 trimmed\r\nCaused by: java.lang.ClassCastException: java.util.stream.ReferencePipeline$Head cannot be cast to j$.util.stream.Stream\r\nat org.mockito.internal.debugging.LocationImpl$$ExternalSyntheticLambda0.apply(Unknown Source:0)\r\nat java.lang.StackStreamFactory$StackFrameTraverser.consumeFrames(StackStreamFactory.java:601)\r\nat java.lang.StackStreamFactory$AbstractStackWalker.doStackWalk(StackStreamFactory.java:316)\r\nat java.lang.StackStreamFactory$AbstractStackWalker.callStackWalk(StackStreamFactory.java:436)\r\nat java.lang.StackStreamFactory$AbstractStackWalker.beginStackWalk(StackStreamFactory.java:380)\r\nat java.lang.StackStreamFactory$AbstractStackWalker.walk(StackStreamFactory.java:251)\r\nat java.lang.StackWalker.walk(StackWalker.java:503)\r\nat org.mockito.internal.debugging.LocationImpl.stackWalk(LocationImpl.java:134)\r\nat org.mockito.internal.debugging.LocationImpl.framesToSkip(LocationImpl.java:123)\r\nat org.mockito.internal.debugging.LocationImpl.<clinit>(LocationImpl.java:59)\r\n... 40 more\r\n```\r\n  \r\n</details>\r\n\r\nAlso I've debugged mock process and found that some problem occurred in `SubclassByteBuddyMockMaker.createMock` method:\r\n\r\n```\r\npublic <T> T createMock(MockCreationSettings<T> settings, MockHandler handler) {\r\n        ...\r\n        try {\r\n            mockInstance = instantiator.newInstance(mockedProxyType);\r\n            MockAccess mockAccess = (MockAccess) mockInstance;\r\n            mockAccess.setMockitoInterceptor(new MockMethodInterceptor(handler, settings)); // Here\r\n\r\n            return ensureMockIsAssignableToMockedType(settings, mockInstance);\r\n        } catch (ClassCastException cce) {\r\n           ...\r\n        }\r\n```\r\n\r\nAfter executing `setMockitoInterceptor` debugger shows me following error:\r\n```Method threw 'java.lang.NoClassDefFoundError' exception. Cannot evaluate info.jukov.mockitobugtest.TestInterface$MockitoMock$tH4GO8Yq.toString()```\r\n\r\n\r\n**Additional details:**\r\n\r\n**Tests are not working on:**\r\nðŸš«Google Pixel 6 Pro (Android 14)\r\nðŸš«[Solana Mobile Saga](https://solanamobile.com/hardware) (Android 12)\r\nðŸš«Emulator Android 14\r\n\r\n**Tests are working on:**\r\nâœ…OnePlus 9 with Lineage OS (Android 13)\r\nâœ…Xiaomi Redmi 10 2022 (MIUI 12.5.26, Android 11)\r\nâœ…Emulator Android 13\r\nâœ…Emulator Android 12\r\nâœ…Emulator Android 11\r\n\r\n**Versions:**\r\nAndroid target SDK: 34\r\nMockito version: 5.7.0 (also tried 5.5.0)\r\nKotlin version: 1.9.20 (also tried 1.8.22)\r\nJava version: 11 (also tried 17)","closed_by":{"login":"TimvdLippe","id":5948271,"node_id":"MDQ6VXNlcjU5NDgyNzE=","avatar_url":"https://avatars.githubusercontent.com/u/5948271?v=4","gravatar_id":"","url":"https://api.github.com/users/TimvdLippe","html_url":"https://github.com/TimvdLippe","followers_url":"https://api.github.com/users/TimvdLippe/followers","following_url":"https://api.github.com/users/TimvdLippe/following{/other_user}","gists_url":"https://api.github.com/users/TimvdLippe/gists{/gist_id}","starred_url":"https://api.github.com/users/TimvdLippe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TimvdLippe/subscriptions","organizations_url":"https://api.github.com/users/TimvdLippe/orgs","repos_url":"https://api.github.com/users/TimvdLippe/repos","events_url":"https://api.github.com/users/TimvdLippe/events{/privacy}","received_events_url":"https://api.github.com/users/TimvdLippe/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mockito/mockito/issues/3171/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mockito/mockito/issues/3171/timeline","performed_via_github_app":null,"state_reason":"completed"}