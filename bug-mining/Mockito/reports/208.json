{"url":"https://api.github.com/repos/mockito/mockito/issues/1802","repository_url":"https://api.github.com/repos/mockito/mockito","labels_url":"https://api.github.com/repos/mockito/mockito/issues/1802/labels{/name}","comments_url":"https://api.github.com/repos/mockito/mockito/issues/1802/comments","events_url":"https://api.github.com/repos/mockito/mockito/issues/1802/events","html_url":"https://github.com/mockito/mockito/issues/1802","id":505101821,"node_id":"MDU6SXNzdWU1MDUxMDE4MjE=","number":1802,"title":"Exception \"The mock object was garbage collected.\"","user":{"login":"basdebakker","id":18264317,"node_id":"MDQ6VXNlcjE4MjY0MzE3","avatar_url":"https://avatars.githubusercontent.com/u/18264317?v=4","gravatar_id":"","url":"https://api.github.com/users/basdebakker","html_url":"https://github.com/basdebakker","followers_url":"https://api.github.com/users/basdebakker/followers","following_url":"https://api.github.com/users/basdebakker/following{/other_user}","gists_url":"https://api.github.com/users/basdebakker/gists{/gist_id}","starred_url":"https://api.github.com/users/basdebakker/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/basdebakker/subscriptions","organizations_url":"https://api.github.com/users/basdebakker/orgs","repos_url":"https://api.github.com/users/basdebakker/repos","events_url":"https://api.github.com/users/basdebakker/events{/privacy}","received_events_url":"https://api.github.com/users/basdebakker/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"raphw","id":4489328,"node_id":"MDQ6VXNlcjQ0ODkzMjg=","avatar_url":"https://avatars.githubusercontent.com/u/4489328?v=4","gravatar_id":"","url":"https://api.github.com/users/raphw","html_url":"https://github.com/raphw","followers_url":"https://api.github.com/users/raphw/followers","following_url":"https://api.github.com/users/raphw/following{/other_user}","gists_url":"https://api.github.com/users/raphw/gists{/gist_id}","starred_url":"https://api.github.com/users/raphw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/raphw/subscriptions","organizations_url":"https://api.github.com/users/raphw/orgs","repos_url":"https://api.github.com/users/raphw/repos","events_url":"https://api.github.com/users/raphw/events{/privacy}","received_events_url":"https://api.github.com/users/raphw/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"raphw","id":4489328,"node_id":"MDQ6VXNlcjQ0ODkzMjg=","avatar_url":"https://avatars.githubusercontent.com/u/4489328?v=4","gravatar_id":"","url":"https://api.github.com/users/raphw","html_url":"https://github.com/raphw","followers_url":"https://api.github.com/users/raphw/followers","following_url":"https://api.github.com/users/raphw/following{/other_user}","gists_url":"https://api.github.com/users/raphw/gists{/gist_id}","starred_url":"https://api.github.com/users/raphw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/raphw/subscriptions","organizations_url":"https://api.github.com/users/raphw/orgs","repos_url":"https://api.github.com/users/raphw/repos","events_url":"https://api.github.com/users/raphw/events{/privacy}","received_events_url":"https://api.github.com/users/raphw/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":5,"created_at":"2019-10-10T07:57:19Z","updated_at":"2020-09-09T11:38:09Z","closed_at":"2020-09-03T22:20:48Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"We received the following exception while running tests using Mockito, either version 3.0.0 or 3.1.0, and I'm filing this bug as requested:\r\n```\r\nException in thread \"main\" java.lang.IllegalStateException: The mock object was garbage collected. This should not happen in normal circumstances when using public API. Typically, the test class keeps strong reference to the mock object and it prevents getting the mock collected. Mockito internally needs to keep weak references to mock objects to avoid memory leaks for certain types of MockMaker implementations. If you see this exception using Mockito public API, please file a bug. For more information see issue #1313.\r\n\tat org.mockito.internal.invocation.mockref.MockWeakReference.get(MockWeakReference.java:32)\r\n\tat org.mockito.internal.invocation.InterceptedInvocation.getMock(InterceptedInvocation.java:106)\r\n\tat org.mockito.internal.stubbing.InvocationContainerImpl.invokedMock(InvocationContainerImpl.java:157)\r\n\tat org.mockito.internal.stubbing.OngoingStubbingImpl.<init>(OngoingStubbingImpl.java:22)\r\n\tat org.mockito.internal.handler.MockHandlerImpl.handle(MockHandlerImpl.java:83)\r\n\tat org.mockito.internal.handler.NullResultGuardian.handle(NullResultGuardian.java:29)\r\n\tat org.mockito.internal.handler.InvocationNotifierHandler.handle(InvocationNotifierHandler.java:35)\r\n\tat org.mockito.internal.creation.bytebuddy.MockMethodInterceptor.doIntercept(MockMethodInterceptor.java:61)\r\n\tat org.mockito.internal.creation.bytebuddy.MockMethodInterceptor.doIntercept(MockMethodInterceptor.java:49)\r\n\tat org.mockito.internal.creation.bytebuddy.MockMethodInterceptor$DispatcherDefaultingToRealMethod.interceptAbstract(MockMethodInterceptor.java:126)\r\n\tat org.mockito.codegen.Runnable$MockitoMock$1840149894.run(Unknown Source)\r\n\tat MockitoTest.runTest(MockitoTest.java:13)\r\n\tat MockitoTest.main(MockitoTest.java:6)\r\n```\r\n\r\nI've reduced the problem to the following test program:\r\n```java\r\nimport org.mockito.*;\r\n\r\npublic class MockitoTest {\r\n\r\n  public static void main(String[] args) {\r\n    while (true) runTest();\r\n  }\r\n\r\n  private static void runTest() {\r\n    Node list = createList();\r\n    while (list != null) {\r\n      Node next = list.next;\r\n      list.object.run();\r\n      list = next;\r\n    }\r\n  }\r\n\r\n  private static Node createList() {\r\n    Node node = null;\r\n    for (int i = 0; i < 1000; ++i) {\r\n      Node next = new Node();\r\n      next.next = node;\r\n      node = next;\r\n    }\r\n    return node;\r\n  }\r\n\r\n  private static class Node {\r\n    final Runnable object = Mockito.mock(Runnable.class);\r\n    Node next;\r\n  }\r\n}\r\n```\r\n\r\nWhether the problem occurs depends on what exactly the JVM does with the code. It looks like the mock object can be garbage collected between the call to the mocked method and Mockito trying to use the weak reference to it. I'm using AdoptOpenJDK 11.0.3.7-hotspot on Windows. My test program more often than not reproduces the exception within a few seconds, but occasionally it can run forever without failing.","closed_by":{"login":"raphw","id":4489328,"node_id":"MDQ6VXNlcjQ0ODkzMjg=","avatar_url":"https://avatars.githubusercontent.com/u/4489328?v=4","gravatar_id":"","url":"https://api.github.com/users/raphw","html_url":"https://github.com/raphw","followers_url":"https://api.github.com/users/raphw/followers","following_url":"https://api.github.com/users/raphw/following{/other_user}","gists_url":"https://api.github.com/users/raphw/gists{/gist_id}","starred_url":"https://api.github.com/users/raphw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/raphw/subscriptions","organizations_url":"https://api.github.com/users/raphw/orgs","repos_url":"https://api.github.com/users/raphw/repos","events_url":"https://api.github.com/users/raphw/events{/privacy}","received_events_url":"https://api.github.com/users/raphw/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mockito/mockito/issues/1802/reactions","total_count":5,"+1":5,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mockito/mockito/issues/1802/timeline","performed_via_github_app":null,"state_reason":"completed"}