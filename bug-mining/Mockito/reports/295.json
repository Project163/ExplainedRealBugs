{"url":"https://api.github.com/repos/mockito/mockito/issues/3229","repository_url":"https://api.github.com/repos/mockito/mockito","labels_url":"https://api.github.com/repos/mockito/mockito/issues/3229/labels{/name}","comments_url":"https://api.github.com/repos/mockito/mockito/issues/3229/comments","events_url":"https://api.github.com/repos/mockito/mockito/issues/3229/events","html_url":"https://github.com/mockito/mockito/issues/3229","id":2071043464,"node_id":"I_kwDOAF62v857cZ2I","number":3229,"title":"`@Captor` test parameters don't work with primitive type arguments","user":{"login":"KierannCode","id":56626948,"node_id":"MDQ6VXNlcjU2NjI2OTQ4","avatar_url":"https://avatars.githubusercontent.com/u/56626948?v=4","gravatar_id":"","url":"https://api.github.com/users/KierannCode","html_url":"https://github.com/KierannCode","followers_url":"https://api.github.com/users/KierannCode/followers","following_url":"https://api.github.com/users/KierannCode/following{/other_user}","gists_url":"https://api.github.com/users/KierannCode/gists{/gist_id}","starred_url":"https://api.github.com/users/KierannCode/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/KierannCode/subscriptions","organizations_url":"https://api.github.com/users/KierannCode/orgs","repos_url":"https://api.github.com/users/KierannCode/repos","events_url":"https://api.github.com/users/KierannCode/events{/privacy}","received_events_url":"https://api.github.com/users/KierannCode/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2024-01-08T18:56:58Z","updated_at":"2024-02-03T07:04:11Z","closed_at":"2024-02-03T07:04:11Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"That's the first time I'm actually contributing to any public project.\r\nI apologize if I'm missing important informations about this issue.\r\n\r\n### Description of the error :\r\n\r\nI'm using java 21 and the dependency org.mockito:mockito-junit-jupiter version 5.8.0\r\nThe issue occurs when using an `ArgumentCaptor` as a test method parameter annotated with `@Captor`, if it is used to capture the argument of a method that takes a primitive type, it throws a `NullPointerException` trying to unbox a `null` value to the primitive type.\r\nThis only occurs when using `@Captor` on a parameter. It works fine on a field or as a local `ArgumentCaptor`.\r\nThe `@Captor` parameters also work as expected with non-primitive types (Well kinda, I'll go back to this later)\r\n\r\n### Reproduction :\r\n\r\nHere's the sample code to reproduce the error, followed by the corresponding stacktrace (I had to order the test because the occurence of the error causes all other tests to fail somehow) :\r\n\r\n``` java annotate\r\n@ExtendWith(MockitoExtension.class)\r\n@TestMethodOrder(MethodOrderer.OrderAnnotation.class)\r\npublic class ReproductionTest {\r\n    @Mock\r\n    private Foo foo;\r\n\r\n    @Captor\r\n    private ArgumentCaptor<Integer> annotatedFieldCaptor;\r\n\r\n    @Test\r\n    @Order(1)\r\n    void this_works_fine() {\r\n        ArgumentCaptor<Integer> localCaptor = ArgumentCaptor.forClass(Integer.class);\r\n        testCaptor(localCaptor);\r\n    }\r\n\r\n    @Test\r\n    @Order(2)\r\n    void this_works_too() {\r\n        testCaptor(annotatedFieldCaptor);\r\n    }\r\n\r\n    @Test\r\n    @Order(3)\r\n    void this_throws_NullPointerException(@Captor ArgumentCaptor<Integer> annotatedParameterCaptor) {\r\n        testCaptor(annotatedParameterCaptor);\r\n    }\r\n\r\n    private void testCaptor(ArgumentCaptor<Integer> captor) {\r\n        doNothing().when(foo).doSomething(captor.capture());\r\n        foo.doSomething(1);\r\n        assertEquals(1, captor.getValue());\r\n    }\r\n\r\n    static class Foo {\r\n        void doSomething(int value) {\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nUnsurprisingly, the first two tests pass, but the third fails with the following stacktrace :\r\n\r\n> java.lang.NullPointerException: Cannot invoke \"java.lang.Integer.intValue()\" because the return value of \"org.mockito.ArgumentCaptor.capture()\" is null\r\n> \r\n> \tat org.test.ReproductionTest.testCaptor(ReproductionTest.java:44)\r\n> \tat org.test.ReproductionTest.this_throws_NullPointerException(ReproductionTest.java:40)\r\n> \tat java.base/java.lang.reflect.Method.invoke(Method.java:580)\r\n> \tat java.base/java.util.ArrayList.forEach(ArrayList.java:1596)\r\n> \tat java.base/java.util.ArrayList.forEach(ArrayList.java:1596)\r\n\r\n### Wait, there's more, and my proposition of solution\r\n\r\nI investigated the issue using the debugger and noticed pretty quickly what the problem was. The \"capture type\" was always set to `Object`, no matter what the generic type inside the `ArgumentCaptor` was (even non primitive). It's not the case for local and field captors, which have the expected \"capture type\". Knowing that, since the `capture()` method return `defaultValue(clazz)`, it always return `null`. It still works somehow for non primitive method parameters, but `null` cannot be passed as a primitive method parameter, hence the `NullPointerException` about the unboxing. So I investigated a bit more in the `CaptorParameterResolver` class, and I think I know what's wrong. It uses the `CaptorAnnotationProcessor.process` method, which uses\r\n`new GenericMaster().getGenericType(parameter)` to determine the generic type to capture.\r\nHowever, this leads to the invocation of the method `GenericMaster.getGenericType(Parameter parameter)`.\r\nThis method uses `Parameter.getType()` to look for the type parameter, but that actually returns the raw class of the parameter, so the informations about type parameters are lost. In the method `GenericMaster.getGenericType(Field field)` used for fields, it uses `Field.getGenericType()` that actually return the type with type parameters. The equivalent of this method for Parameter is `Parameter.getParameterizedType()`.\r\nI think this is clearly a bug, and the fix seems pretty obvious to me :\r\n\r\nIn GenericMaster.java, line 30, replace\r\n```return getaClass(parameter.getType());```\r\nby\r\n```return getaClass(parameter.getParameterizedType());```\r\n\r\nI tested it with a workaround and it works as intended (as a proof of concept only)\r\nFurthermore, it seems like this method (and all the captor parameter resolving circuit) isn't used anywhere else, so there's very little impact to expect from this fix.\r\n\r\n\r\n","closed_by":{"login":"TimvdLippe","id":5948271,"node_id":"MDQ6VXNlcjU5NDgyNzE=","avatar_url":"https://avatars.githubusercontent.com/u/5948271?v=4","gravatar_id":"","url":"https://api.github.com/users/TimvdLippe","html_url":"https://github.com/TimvdLippe","followers_url":"https://api.github.com/users/TimvdLippe/followers","following_url":"https://api.github.com/users/TimvdLippe/following{/other_user}","gists_url":"https://api.github.com/users/TimvdLippe/gists{/gist_id}","starred_url":"https://api.github.com/users/TimvdLippe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TimvdLippe/subscriptions","organizations_url":"https://api.github.com/users/TimvdLippe/orgs","repos_url":"https://api.github.com/users/TimvdLippe/repos","events_url":"https://api.github.com/users/TimvdLippe/events{/privacy}","received_events_url":"https://api.github.com/users/TimvdLippe/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mockito/mockito/issues/3229/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mockito/mockito/issues/3229/timeline","performed_via_github_app":null,"state_reason":"completed"}