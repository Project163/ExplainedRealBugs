{"url":"https://api.github.com/repos/mockito/mockito/issues/1717","repository_url":"https://api.github.com/repos/mockito/mockito","labels_url":"https://api.github.com/repos/mockito/mockito/issues/1717/labels{/name}","comments_url":"https://api.github.com/repos/mockito/mockito/issues/1717/comments","events_url":"https://api.github.com/repos/mockito/mockito/issues/1717/events","html_url":"https://github.com/mockito/mockito/issues/1717","id":448147668,"node_id":"MDU6SXNzdWU0NDgxNDc2Njg=","number":1717,"title":"Incompatibility between the inline mocks and JaCoCo 0.8.4","user":{"login":"fpavageau","id":800088,"node_id":"MDQ6VXNlcjgwMDA4OA==","avatar_url":"https://avatars.githubusercontent.com/u/800088?v=4","gravatar_id":"","url":"https://api.github.com/users/fpavageau","html_url":"https://github.com/fpavageau","followers_url":"https://api.github.com/users/fpavageau/followers","following_url":"https://api.github.com/users/fpavageau/following{/other_user}","gists_url":"https://api.github.com/users/fpavageau/gists{/gist_id}","starred_url":"https://api.github.com/users/fpavageau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fpavageau/subscriptions","organizations_url":"https://api.github.com/users/fpavageau/orgs","repos_url":"https://api.github.com/users/fpavageau/repos","events_url":"https://api.github.com/users/fpavageau/events{/privacy}","received_events_url":"https://api.github.com/users/fpavageau/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"raphw","id":4489328,"node_id":"MDQ6VXNlcjQ0ODkzMjg=","avatar_url":"https://avatars.githubusercontent.com/u/4489328?v=4","gravatar_id":"","url":"https://api.github.com/users/raphw","html_url":"https://github.com/raphw","followers_url":"https://api.github.com/users/raphw/followers","following_url":"https://api.github.com/users/raphw/following{/other_user}","gists_url":"https://api.github.com/users/raphw/gists{/gist_id}","starred_url":"https://api.github.com/users/raphw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/raphw/subscriptions","organizations_url":"https://api.github.com/users/raphw/orgs","repos_url":"https://api.github.com/users/raphw/repos","events_url":"https://api.github.com/users/raphw/events{/privacy}","received_events_url":"https://api.github.com/users/raphw/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"raphw","id":4489328,"node_id":"MDQ6VXNlcjQ0ODkzMjg=","avatar_url":"https://avatars.githubusercontent.com/u/4489328?v=4","gravatar_id":"","url":"https://api.github.com/users/raphw","html_url":"https://github.com/raphw","followers_url":"https://api.github.com/users/raphw/followers","following_url":"https://api.github.com/users/raphw/following{/other_user}","gists_url":"https://api.github.com/users/raphw/gists{/gist_id}","starred_url":"https://api.github.com/users/raphw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/raphw/subscriptions","organizations_url":"https://api.github.com/users/raphw/orgs","repos_url":"https://api.github.com/users/raphw/repos","events_url":"https://api.github.com/users/raphw/events{/privacy}","received_events_url":"https://api.github.com/users/raphw/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":1,"created_at":"2019-05-24T12:36:19Z","updated_at":"2019-05-24T20:24:19Z","closed_at":"2019-05-24T20:24:19Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"# Versions\r\n\r\nMockito 2.27.0\r\nJaCoCo 0.8.4\r\n\r\n# Problem\r\n\r\nJaCoCo 0.8.4 introduced the use of the Conditional Dynamic instruction when running with Java 11+, which triggers an exception in the [`MethodVisitor`](https://github.com/mockito/mockito/blob/v2.27.0/src/main/java/org/mockito/internal/creation/bytebuddy/InlineBytecodeGenerator.java#L314) used to strip the parameters, because it's not configured for the correct ASM API version:\r\n\r\n    Mockito cannot mock this class: class com.ekino.mockito.B.\r\n    \r\n    If you're not sure why you're getting this error, please report to the mailing list.\r\n    \r\n    \r\n    Java               : 11\r\n    JVM vendor name    : AdoptOpenJDK\r\n    JVM vendor version : 11.0.3+7\r\n    JVM name           : OpenJDK 64-Bit Server VM\r\n    JVM version        : 11.0.3+7\r\n    JVM info           : mixed mode\r\n    OS name            : Mac OS X\r\n    OS version         : 10.14.5\r\n    \r\n    \r\n    You are seeing this disclaimer because Mockito is configured to create inlined mocks.\r\n    You can learn about inline mocks and their limitations under item #39 of the Mockito class javadoc.\r\n    \r\n    Underlying exception : org.mockito.exceptions.base.MockitoException: Could not modify all classes [class java.lang.Object, class com.ekino.mockito.B]\r\n    org.mockito.exceptions.base.MockitoException: \r\n    Mockito cannot mock this class: class com.ekino.mockito.B.\r\n    \r\n    If you're not sure why you're getting this error, please report to the mailing list.\r\n    \r\n    \r\n    Java               : 11\r\n    JVM vendor name    : AdoptOpenJDK\r\n    JVM vendor version : 11.0.3+7\r\n    JVM name           : OpenJDK 64-Bit Server VM\r\n    JVM version        : 11.0.3+7\r\n    JVM info           : mixed mode\r\n    OS name            : Mac OS X\r\n    OS version         : 10.14.5\r\n    \r\n    \r\n    You are seeing this disclaimer because Mockito is configured to create inlined mocks.\r\n    You can learn about inline mocks and their limitations under item #39 of the Mockito class javadoc.\r\n    \r\n    Underlying exception : org.mockito.exceptions.base.MockitoException: Could not modify all classes [class java.lang.Object, class com.ekino.mockito.B]\r\n    \tat com.ekino.mockito.ATest.should_call_b(ATest.java:10)\r\n    \tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n    \tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\r\n    \tat java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n    \tat java.base/java.lang.reflect.Method.invoke(Method.java:566)\r\n    \tat org.junit.platform.commons.util.ReflectionUtils.invokeMethod(ReflectionUtils.java:628)\r\n    \tat org.junit.jupiter.engine.execution.ExecutableInvoker.invoke(ExecutableInvoker.java:117)\r\n    \tat org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.lambda$invokeTestMethod$7(TestMethodTestDescriptor.java:184)\r\n    \tat org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)\r\n    \tat org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.invokeTestMethod(TestMethodTestDescriptor.java:180)\r\n    \tat org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:127)\r\n    \tat org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:68)\r\n    \tat org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$5(NodeTestTask.java:135)\r\n    \tat org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)\r\n    \tat org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$7(NodeTestTask.java:125)\r\n    \tat org.junit.platform.engine.support.hierarchical.Node.around(Node.java:135)\r\n    \tat org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:123)\r\n    \tat org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)\r\n    \tat org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:122)\r\n    \tat org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:80)\r\n    \tat java.base/java.util.ArrayList.forEach(ArrayList.java:1540)\r\n    \tat org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:38)\r\n    \tat org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$5(NodeTestTask.java:139)\r\n    \tat org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)\r\n    \tat org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$7(NodeTestTask.java:125)\r\n    \tat org.junit.platform.engine.support.hierarchical.Node.around(Node.java:135)\r\n    \tat org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:123)\r\n    \tat org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)\r\n    \tat org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:122)\r\n    \tat org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:80)\r\n    \tat java.base/java.util.ArrayList.forEach(ArrayList.java:1540)\r\n    \tat org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:38)\r\n    \tat org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$5(NodeTestTask.java:139)\r\n    \tat org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)\r\n    \tat org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$7(NodeTestTask.java:125)\r\n    \tat org.junit.platform.engine.support.hierarchical.Node.around(Node.java:135)\r\n    \tat org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:123)\r\n    \tat org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)\r\n    \tat org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:122)\r\n    \tat org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:80)\r\n    \tat org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.submit(SameThreadHierarchicalTestExecutorService.java:32)\r\n    \tat org.junit.platform.engine.support.hierarchical.HierarchicalTestExecutor.execute(HierarchicalTestExecutor.java:57)\r\n    \tat org.junit.platform.engine.support.hierarchical.HierarchicalTestEngine.execute(HierarchicalTestEngine.java:51)\r\n    \tat org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:220)\r\n    \tat org.junit.platform.launcher.core.DefaultLauncher.lambda$execute$6(DefaultLauncher.java:188)\r\n    \tat org.junit.platform.launcher.core.DefaultLauncher.withInterceptedStreams(DefaultLauncher.java:202)\r\n    \tat org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:181)\r\n    \tat org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:128)\r\n    \tat org.gradle.api.internal.tasks.testing.junitplatform.JUnitPlatformTestClassProcessor$CollectAllTestClassesExecutor.processAllTestClasses(JUnitPlatformTestClassProcessor.java:102)\r\n    \tat org.gradle.api.internal.tasks.testing.junitplatform.JUnitPlatformTestClassProcessor$CollectAllTestClassesExecutor.access$000(JUnitPlatformTestClassProcessor.java:82)\r\n    \tat org.gradle.api.internal.tasks.testing.junitplatform.JUnitPlatformTestClassProcessor.stop(JUnitPlatformTestClassProcessor.java:78)\r\n    \tat org.gradle.api.internal.tasks.testing.SuiteTestClassProcessor.stop(SuiteTestClassProcessor.java:61)\r\n    \tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n    \tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\r\n    \tat java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n    \tat java.base/java.lang.reflect.Method.invoke(Method.java:566)\r\n    \tat org.gradle.internal.dispatch.ReflectionDispatch.dispatch(ReflectionDispatch.java:35)\r\n    \tat org.gradle.internal.dispatch.ReflectionDispatch.dispatch(ReflectionDispatch.java:24)\r\n    \tat org.gradle.internal.dispatch.ContextClassLoaderDispatch.dispatch(ContextClassLoaderDispatch.java:32)\r\n    \tat org.gradle.internal.dispatch.ProxyDispatchAdapter$DispatchingInvocationHandler.invoke(ProxyDispatchAdapter.java:93)\r\n    \tat com.sun.proxy.$Proxy5.stop(Unknown Source)\r\n    \tat org.gradle.api.internal.tasks.testing.worker.TestWorker.stop(TestWorker.java:132)\r\n    \tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n    \tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\r\n    \tat java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n    \tat java.base/java.lang.reflect.Method.invoke(Method.java:566)\r\n    \tat org.gradle.internal.dispatch.ReflectionDispatch.dispatch(ReflectionDispatch.java:35)\r\n    \tat org.gradle.internal.dispatch.ReflectionDispatch.dispatch(ReflectionDispatch.java:24)\r\n    \tat org.gradle.internal.remote.internal.hub.MessageHubBackedObjectConnection$DispatchWrapper.dispatch(MessageHubBackedObjectConnection.java:175)\r\n    \tat org.gradle.internal.remote.internal.hub.MessageHubBackedObjectConnection$DispatchWrapper.dispatch(MessageHubBackedObjectConnection.java:157)\r\n    \tat org.gradle.internal.remote.internal.hub.MessageHub$Handler.run(MessageHub.java:404)\r\n    \tat org.gradle.internal.concurrent.ExecutorPolicy$CatchAndRecordFailures.onExecute(ExecutorPolicy.java:63)\r\n    \tat org.gradle.internal.concurrent.ManagedExecutorImpl$1.run(ManagedExecutorImpl.java:46)\r\n    \tat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)\r\n    \tat java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)\r\n    \tat org.gradle.internal.concurrent.ThreadFactoryImpl$ManagedThreadRunnable.run(ThreadFactoryImpl.java:55)\r\n    \tat java.base/java.lang.Thread.run(Thread.java:834)\r\n    Caused by: org.mockito.exceptions.base.MockitoException: Could not modify all classes [class java.lang.Object, class com.ekino.mockito.B]\r\n    \tat net.bytebuddy.TypeCache.findOrInsert(TypeCache.java:152)\r\n    \tat net.bytebuddy.TypeCache$WithInlineExpunction.findOrInsert(TypeCache.java:365)\r\n    \tat net.bytebuddy.TypeCache.findOrInsert(TypeCache.java:174)\r\n    \tat net.bytebuddy.TypeCache$WithInlineExpunction.findOrInsert(TypeCache.java:376)\r\n    \t... 77 more\r\n    Caused by: java.lang.IllegalStateException: \r\n    Byte Buddy could not instrument all classes within the mock's type hierarchy\r\n    \r\n    This problem should never occur for javac-compiled classes. This problem has been observed for classes that are:\r\n     - Compiled by older versions of scalac\r\n     - Classes that are part of the Android distribution\r\n    \tat org.mockito.internal.creation.bytebuddy.InlineBytecodeGenerator.triggerRetransformation(InlineBytecodeGenerator.java:177)\r\n    \tat org.mockito.internal.creation.bytebuddy.InlineBytecodeGenerator.mockClass(InlineBytecodeGenerator.java:153)\r\n    \tat org.mockito.internal.creation.bytebuddy.TypeCachingBytecodeGenerator$1.call(TypeCachingBytecodeGenerator.java:37)\r\n    \tat org.mockito.internal.creation.bytebuddy.TypeCachingBytecodeGenerator$1.call(TypeCachingBytecodeGenerator.java:34)\r\n    \tat net.bytebuddy.TypeCache.findOrInsert(TypeCache.java:152)\r\n    \tat net.bytebuddy.TypeCache$WithInlineExpunction.findOrInsert(TypeCache.java:365)\r\n    \tat net.bytebuddy.TypeCache.findOrInsert(TypeCache.java:174)\r\n    \tat net.bytebuddy.TypeCache$WithInlineExpunction.findOrInsert(TypeCache.java:376)\r\n    \tat org.mockito.internal.creation.bytebuddy.TypeCachingBytecodeGenerator.mockClass(TypeCachingBytecodeGenerator.java:32)\r\n    \tat org.mockito.internal.creation.bytebuddy.InlineByteBuddyMockMaker.createMockType(InlineByteBuddyMockMaker.java:197)\r\n    \tat org.mockito.internal.creation.bytebuddy.InlineByteBuddyMockMaker.createMock(InlineByteBuddyMockMaker.java:178)\r\n    \tat org.mockito.internal.util.MockUtil.createMock(MockUtil.java:35)\r\n    \tat org.mockito.internal.MockitoCore.mock(MockitoCore.java:62)\r\n    \tat org.mockito.Mockito.mock(Mockito.java:1907)\r\n    \tat org.mockito.Mockito.mock(Mockito.java:1816)\r\n    \t... 77 more\r\n    Caused by: java.lang.UnsupportedOperationException: This feature requires ASM7\r\n    \tat net.bytebuddy.jar.asm.MethodVisitor.visitLdcInsn(MethodVisitor.java:542)\r\n    \tat net.bytebuddy.jar.asm.ClassReader.readCode(ClassReader.java:2181)\r\n    \tat net.bytebuddy.jar.asm.ClassReader.readMethod(ClassReader.java:1275)\r\n    \tat net.bytebuddy.jar.asm.ClassReader.accept(ClassReader.java:679)\r\n    \tat net.bytebuddy.jar.asm.ClassReader.accept(ClassReader.java:391)\r\n    \tat net.bytebuddy.dynamic.scaffold.TypeWriter$Default$ForInlining.create(TypeWriter.java:3393)\r\n    \tat net.bytebuddy.dynamic.scaffold.TypeWriter$Default.make(TypeWriter.java:1930)\r\n    \tat net.bytebuddy.dynamic.scaffold.inline.RedefinitionDynamicTypeBuilder.make(RedefinitionDynamicTypeBuilder.java:217)\r\n    \tat net.bytebuddy.dynamic.scaffold.inline.AbstractInliningDynamicTypeBuilder.make(AbstractInliningDynamicTypeBuilder.java:120)\r\n    \tat net.bytebuddy.dynamic.DynamicType$Builder$AbstractBase.make(DynamicType.java:3396)\r\n    \tat org.mockito.internal.creation.bytebuddy.InlineBytecodeGenerator.transform(InlineBytecodeGenerator.java:254)\r\n    \tat java.instrument/java.lang.instrument.ClassFileTransformer.transform(ClassFileTransformer.java:246)\r\n    \tat java.instrument/sun.instrument.TransformerManager.transform(TransformerManager.java:188)\r\n    \tat java.instrument/sun.instrument.InstrumentationImpl.transform(InstrumentationImpl.java:563)\r\n    \tat java.instrument/sun.instrument.InstrumentationImpl.retransformClasses0(Native Method)\r\n    \tat java.instrument/sun.instrument.InstrumentationImpl.retransformClasses(InstrumentationImpl.java:167)\r\n    \tat org.mockito.internal.creation.bytebuddy.InlineBytecodeGenerator.triggerRetransformation(InlineBytecodeGenerator.java:174)\r\n    \t... 91 more\r\n\r\n# Example\r\n\r\nI've pushed an [example](https://github.com/fpavageau/mockito-jacoco-condy) demonstrating the problem.\r\n\r\n# Fix\r\n\r\nI believe the fix is simply to configure the visitor with the ASM 7 API version, since that _is_ the version used by Mockito.","closed_by":{"login":"TimvdLippe","id":5948271,"node_id":"MDQ6VXNlcjU5NDgyNzE=","avatar_url":"https://avatars.githubusercontent.com/u/5948271?v=4","gravatar_id":"","url":"https://api.github.com/users/TimvdLippe","html_url":"https://github.com/TimvdLippe","followers_url":"https://api.github.com/users/TimvdLippe/followers","following_url":"https://api.github.com/users/TimvdLippe/following{/other_user}","gists_url":"https://api.github.com/users/TimvdLippe/gists{/gist_id}","starred_url":"https://api.github.com/users/TimvdLippe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TimvdLippe/subscriptions","organizations_url":"https://api.github.com/users/TimvdLippe/orgs","repos_url":"https://api.github.com/users/TimvdLippe/repos","events_url":"https://api.github.com/users/TimvdLippe/events{/privacy}","received_events_url":"https://api.github.com/users/TimvdLippe/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mockito/mockito/issues/1717/reactions","total_count":12,"+1":12,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mockito/mockito/issues/1717/timeline","performed_via_github_app":null,"state_reason":"completed"}