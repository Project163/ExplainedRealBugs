{"url":"https://api.github.com/repos/mockito/mockito/issues/2399","repository_url":"https://api.github.com/repos/mockito/mockito","labels_url":"https://api.github.com/repos/mockito/mockito/issues/2399/labels{/name}","comments_url":"https://api.github.com/repos/mockito/mockito/issues/2399/comments","events_url":"https://api.github.com/repos/mockito/mockito/issues/2399/events","html_url":"https://github.com/mockito/mockito/issues/2399","id":977054820,"node_id":"MDU6SXNzdWU5NzcwNTQ4MjA=","number":2399,"title":"Sporadic mock verification failures related to hashCode/equals on 3.12.1","user":{"login":"chadlwilson","id":29788154,"node_id":"MDQ6VXNlcjI5Nzg4MTU0","avatar_url":"https://avatars.githubusercontent.com/u/29788154?v=4","gravatar_id":"","url":"https://api.github.com/users/chadlwilson","html_url":"https://github.com/chadlwilson","followers_url":"https://api.github.com/users/chadlwilson/followers","following_url":"https://api.github.com/users/chadlwilson/following{/other_user}","gists_url":"https://api.github.com/users/chadlwilson/gists{/gist_id}","starred_url":"https://api.github.com/users/chadlwilson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chadlwilson/subscriptions","organizations_url":"https://api.github.com/users/chadlwilson/orgs","repos_url":"https://api.github.com/users/chadlwilson/repos","events_url":"https://api.github.com/users/chadlwilson/events{/privacy}","received_events_url":"https://api.github.com/users/chadlwilson/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":13,"created_at":"2021-08-23T13:45:47Z","updated_at":"2021-08-25T09:17:48Z","closed_at":"2021-08-24T12:09:57Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Since updating from `3.11.2` to `3.12.0` (and getting similar errors on `3.12.1`), I have seen some strange sometimes-reproducible verification failures on Mockito for tests which previously passed consistently.\r\n\r\nI can't yet establish a pattern or simple reproduction; it feels like it is somehow dependent on the order of test evaluation/usage with respect to other tests within the same JVM instance, and I have been unable to replicate locally.\r\n\r\nThere are two main classes I am seeing\r\n\r\n1. mocks with interactions being tracked (and thus failing `verifyNoInteractions(mock)` after being put into `HashSet`s (these did not seem to previously count as an interaction, and usually do not)\r\n    ```\r\n    com.thoughtworks.go.server.materials.postcommit.git.GitPostCommitHookImplementerTest > shouldReturnEmptyListIfParamHasNoValueForRepoURL() FAILED\r\n        org.mockito.exceptions.verification.NoInteractionsWanted: \r\n        No interactions wanted here:\r\n        -> at com.thoughtworks.go.server.materials.postcommit.git.GitPostCommitHookImplementerTest.shouldReturnEmptyListIfParamHasNoValueForRepoURL(GitPostCommitHookImplementerTest.java:93)\r\n        But found this interaction on mock 'gitMaterial':\r\n        -> at java.base/java.util.HashMap.hash(HashMap.java:340)\r\n        Actually, above is the only interaction with this mock.\r\n            at com.thoughtworks.go.server.materials.postcommit.git.GitPostCommitHookImplementerTest.shouldReturnEmptyListIfParamHasNoValueForRepoURL(GitPostCommitHookImplementerTest.java:93)\r\n    ```\r\n    https://github.com/gocd/gocd/blob/b7bba59201c857efc010c3493664802f218d2bae/server/src/test-fast/java/com/thoughtworks/go/server/materials/postcommit/git/GitPostCommitHookImplementerTest.java#L81-L94\r\n\r\n2. mocks that are not considered equal to themselves when put inside a `Collection` and then searched for \r\n    ```\r\n    com.thoughtworks.go.server.materials.postcommit.git.GitPostCommitHookImplementerTest > shouldReturnListOfMaterialMatchingThePayloadURL() FAILED\r\n        java.lang.AssertionError: \r\n        Expected: a collection containing <Mock for GitMaterial, hashCode: 0>\r\n             but: was <Mock for GitMaterial, hashCode: 0>, was <Mock for GitMaterial, hashCode: 0>\r\n            at org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:20)\r\n            at org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:8)\r\n            at com.thoughtworks.go.server.materials.postcommit.git.GitPostCommitHookImplementerTest.shouldReturnListOfMaterialMatchingThePayloadURL(GitPostCommitHookImplementerTest.java:58)\r\n    ```\r\n    https://github.com/gocd/gocd/blob/b7bba59201c857efc010c3493664802f218d2bae/server/src/test-fast/java/com/thoughtworks/go/server/materials/postcommit/git/GitPostCommitHookImplementerTest.java#L41-L65\r\n\r\nI have a handful of other examples too in different classes.\r\n\r\nThis could be confirmation bias, however since I saw some stuff was done with respect to hashCodes in #2331 I wondered if it could be related. Logging it here to see if anyone else has seen any similar weirdness or might know what is going on.\r\n\r\n**Environment**\r\n- Currently I _cannot_ replicate locally (MacOS Big Sur w/AdoptOpenJDK `15.0.2`) even where it is replicable on build/CI automation environment.\r\n- The failures seem to be (somewhat) reproducible on AL2 Linux w/ Oracle JDK `15.0.1`) but I cannot distinguish a pattern, and sometimes a different combination/ordering of tests does not seem to yield the same failure on exactly the same test code.","closed_by":{"login":"TimvdLippe","id":5948271,"node_id":"MDQ6VXNlcjU5NDgyNzE=","avatar_url":"https://avatars.githubusercontent.com/u/5948271?v=4","gravatar_id":"","url":"https://api.github.com/users/TimvdLippe","html_url":"https://github.com/TimvdLippe","followers_url":"https://api.github.com/users/TimvdLippe/followers","following_url":"https://api.github.com/users/TimvdLippe/following{/other_user}","gists_url":"https://api.github.com/users/TimvdLippe/gists{/gist_id}","starred_url":"https://api.github.com/users/TimvdLippe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TimvdLippe/subscriptions","organizations_url":"https://api.github.com/users/TimvdLippe/orgs","repos_url":"https://api.github.com/users/TimvdLippe/repos","events_url":"https://api.github.com/users/TimvdLippe/events{/privacy}","received_events_url":"https://api.github.com/users/TimvdLippe/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mockito/mockito/issues/2399/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":1,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mockito/mockito/issues/2399/timeline","performed_via_github_app":null,"state_reason":"completed"}