{"url":"https://api.github.com/repos/mockito/mockito/issues/2616","repository_url":"https://api.github.com/repos/mockito/mockito","labels_url":"https://api.github.com/repos/mockito/mockito/issues/2616/labels{/name}","comments_url":"https://api.github.com/repos/mockito/mockito/issues/2616/comments","events_url":"https://api.github.com/repos/mockito/mockito/issues/2616/events","html_url":"https://github.com/mockito/mockito/issues/2616","id":1199081599,"node_id":"I_kwDOAF62v85HeIh_","number":2616,"title":"Mock static class seems records wrong invocations if called nested method throws exception","user":{"login":"mariohofmann","id":26171236,"node_id":"MDQ6VXNlcjI2MTcxMjM2","avatar_url":"https://avatars.githubusercontent.com/u/26171236?v=4","gravatar_id":"","url":"https://api.github.com/users/mariohofmann","html_url":"https://github.com/mariohofmann","followers_url":"https://api.github.com/users/mariohofmann/followers","following_url":"https://api.github.com/users/mariohofmann/following{/other_user}","gists_url":"https://api.github.com/users/mariohofmann/gists{/gist_id}","starred_url":"https://api.github.com/users/mariohofmann/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mariohofmann/subscriptions","organizations_url":"https://api.github.com/users/mariohofmann/orgs","repos_url":"https://api.github.com/users/mariohofmann/repos","events_url":"https://api.github.com/users/mariohofmann/events{/privacy}","received_events_url":"https://api.github.com/users/mariohofmann/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-04-10T15:53:08Z","updated_at":"2022-06-18T09:41:06Z","closed_at":"2022-06-18T09:41:06Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"If mocking a static class where method calls another static method within same class and inner class is throwing an expception the\r\nthe stubbing does not work as expected (instead of returning stubbed answer the execption is thrown)\r\n\r\nClass `StaticTest.java`:\r\n```\r\nimport java.util.concurrent.atomic.AtomicInteger;\r\n\r\npublic class StaticClass {\r\n    public static final AtomicInteger countOuter = new AtomicInteger(0);\r\n    public static final AtomicInteger countInner = new AtomicInteger(0);\r\n    public static final AtomicInteger resultInner = new AtomicInteger();\r\n\r\n    public static int outerMethod(String aParam1, Integer aParam2, Object aParam3) {\r\n        countOuter.incrementAndGet();\r\n        resultInner.set(innerMethod(aParam1, aParam2));\r\n        return countOuter.incrementAndGet();\r\n    }\r\n\r\n    public static int innerMethod(String aParam1, Integer aParam2) {\r\n        throw new NullPointerException();\r\n//        return countInner.incrementAndGet();\r\n    }\r\n}\r\n```\r\n\r\nClass `TestStaticMock.java`:\r\n```\r\nimport static org.junit.jupiter.api.Assertions.*;\r\nimport static org.mockito.Answers.CALLS_REAL_METHODS;\r\nimport static org.mockito.ArgumentMatchers.any;\r\nimport static org.mockito.Mockito.*;\r\n\r\nimport org.junit.jupiter.api.Test;\r\nimport org.mockito.MockedStatic;\r\n\r\npublic class TestStaticMock {\r\n    @Test\r\n    void testMock() {\r\n        try (MockedStatic<StaticClass> mocked = mockStatic(StaticClass.class, CALLS_REAL_METHODS)) {\r\n            mocked.when(() -> StaticClass.outerMethod(any(), any(), any())).thenReturn(Integer.valueOf(-1));\r\n\r\n            assertEquals(-1, StaticClass.outerMethod(\"DUMMY\", Integer.valueOf(10), Double.valueOf(2.0))); // (1)\r\n//            assertThrows(NullPointerException.class, () -> StaticClass.outerMethod(\"DUMMY\", Integer.valueOf(10), Double.valueOf(2.0)));  // (2)\r\n\r\n            mocked.verify(() -> StaticClass.outerMethod(\"DUMMY\", Integer.valueOf(10), Double.valueOf(2.0)));\r\n            mocked.verifyNoMoreInteractions();\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nExpcected behaviour is `assertEquals` succeeds because the stubbing returns the expected value but exception raised\r\nby `innerMethod` is returned. If line marked with (1) is comment out and comment for line with (2) is removed the validation\r\nof check for `noMoreInteraction` prints\r\n\r\n```\r\norg.mockito.exceptions.verification.NoInteractionsWanted: \r\nNo interactions wanted here:\r\n-> at TestStaticMock.testMock(TestStaticMock.java:20)\r\nBut found this interaction on mock 'StaticClass.class':\r\n-> at TestStaticMock.lambda$0(TestStaticMock.java:14)\r\n***\r\nFor your reference, here is the list of all invocations ([?] - means unverified).\r\n1. [?]-> at TestStaticMock.lambda$0(TestStaticMock.java:14)\r\n2. -> at TestStaticMock.lambda$1(TestStaticMock.java:17)\r\n3. [?]-> at StaticClass.outerMethod(StaticClass.java:10)\r\n\r\n\tat TestStaticMock.testMock(TestStaticMock.java:20)\r\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\r\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n\tat java.lang.reflect.Method.invoke(Method.java:498)\r\n\tat org.junit.platform.commons.util.ReflectionUtils.invokeMethod(ReflectionUtils.java:725)\r\n\tat org.junit.jupiter.engine.execution.MethodInvocation.proceed(MethodInvocation.java:60)\r\n...\r\n```\r\nshowing inner invocation not expected and recording of stubbing.","closed_by":{"login":"TimvdLippe","id":5948271,"node_id":"MDQ6VXNlcjU5NDgyNzE=","avatar_url":"https://avatars.githubusercontent.com/u/5948271?v=4","gravatar_id":"","url":"https://api.github.com/users/TimvdLippe","html_url":"https://github.com/TimvdLippe","followers_url":"https://api.github.com/users/TimvdLippe/followers","following_url":"https://api.github.com/users/TimvdLippe/following{/other_user}","gists_url":"https://api.github.com/users/TimvdLippe/gists{/gist_id}","starred_url":"https://api.github.com/users/TimvdLippe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TimvdLippe/subscriptions","organizations_url":"https://api.github.com/users/TimvdLippe/orgs","repos_url":"https://api.github.com/users/TimvdLippe/repos","events_url":"https://api.github.com/users/TimvdLippe/events{/privacy}","received_events_url":"https://api.github.com/users/TimvdLippe/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mockito/mockito/issues/2616/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mockito/mockito/issues/2616/timeline","performed_via_github_app":null,"state_reason":"completed"}