{"url":"https://api.github.com/repos/mockito/mockito/issues/2865","repository_url":"https://api.github.com/repos/mockito/mockito","labels_url":"https://api.github.com/repos/mockito/mockito/issues/2865/labels{/name}","comments_url":"https://api.github.com/repos/mockito/mockito/issues/2865/comments","events_url":"https://api.github.com/repos/mockito/mockito/issues/2865/events","html_url":"https://github.com/mockito/mockito/issues/2865","id":1533223488,"node_id":"I_kwDOAF62v85bYyJA","number":2865,"title":"Default mock of `Optional` is not `empty` when using `RETURN_DEEP_STUBS`","user":{"login":"big-andy-coates","id":8012398,"node_id":"MDQ6VXNlcjgwMTIzOTg=","avatar_url":"https://avatars.githubusercontent.com/u/8012398?v=4","gravatar_id":"","url":"https://api.github.com/users/big-andy-coates","html_url":"https://github.com/big-andy-coates","followers_url":"https://api.github.com/users/big-andy-coates/followers","following_url":"https://api.github.com/users/big-andy-coates/following{/other_user}","gists_url":"https://api.github.com/users/big-andy-coates/gists{/gist_id}","starred_url":"https://api.github.com/users/big-andy-coates/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/big-andy-coates/subscriptions","organizations_url":"https://api.github.com/users/big-andy-coates/orgs","repos_url":"https://api.github.com/users/big-andy-coates/repos","events_url":"https://api.github.com/users/big-andy-coates/events{/privacy}","received_events_url":"https://api.github.com/users/big-andy-coates/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":532126464,"node_id":"MDU6TGFiZWw1MzIxMjY0NjQ=","url":"https://api.github.com/repos/mockito/mockito/labels/please%20contribute","name":"please contribute","color":"0e8a16","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2023-01-14T11:36:42Z","updated_at":"2023-08-25T16:51:50Z","closed_at":"2023-08-25T16:51:50Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Version affected: Mockito: 4.x & 5.x\r\n\r\nIf you create a mock with `RETURN_DEEP_STUBS`, then any method that returns a collection will, by default, return an empty collection, i.e. `isEmpty` returns `true`, etc.  This is great, as it means no additional configuration of the mock is required before passing to logic that would attempt to access elements of the collection.\r\n\r\nHowever, the same is not true for `Optional`, (and I'm assuming `OptionalLong` etc): if `RETURN_DEEP_STUBS` is used, methods that return `Optional` aren't treated in any special way and just return a default mock with not stubbing configured. This means `isEmpty` returns `false`, but `get()` returns `null`.   This breaks the contract of `Optional`, causing test failures that aren't actually valid, or requiring manual configuration of the `Optional` mock to do-the-right-thing, cluttering test code.\r\n\r\nHere's an example test that demonstrates this:\r\n\r\n```java\r\ninterface Address {\r\n   Optional<String> getState();\r\n}\r\n\r\n@Test\r\npublic void shouldDefaultDeepMockOptionalsToEmpty() {\r\n    final Address address = mock(Address.class, RETURNS_DEEP_STUBS);\r\n\r\n    assertThat(address.getState()).isEqualTo(Optional.empty());  // <--- fails\r\n}\r\n\r\n@Test\r\npublic void shouldDefaultMockOptionalsToEmpty() {\r\n    final Address address = mock(Address.class); // <-- no RETURNS_DEEP_STUBS\r\n\r\n    assertThat(address.getState()).isEqualTo(Optional.empty());  // <--- passes\r\n}\r\n```\r\n\r\nNote the second test, which doesn't use deep mocking, passes.\r\n\r\n - [x] The mockito message in the stacktrace have useful information, but it didn't help\r\n - [x] The problematic code (if that's possible) is copied here;\r\n       Note that some configuration are impossible to mock via Mockito\r\n - [x] Provide versions (mockito / jdk / os / any other relevant information)\r\n - [x] Provide a [Short, Self Contained, Correct (Compilable), Example](http://sscce.org) of the issue\r\n       (same as any question on stackoverflow.com)\r\n - [x] Read the [contributing guide](https://github.com/mockito/mockito/blob/main/.github/CONTRIBUTING.md)\r\n\r\n\r\n","closed_by":{"login":"TimvdLippe","id":5948271,"node_id":"MDQ6VXNlcjU5NDgyNzE=","avatar_url":"https://avatars.githubusercontent.com/u/5948271?v=4","gravatar_id":"","url":"https://api.github.com/users/TimvdLippe","html_url":"https://github.com/TimvdLippe","followers_url":"https://api.github.com/users/TimvdLippe/followers","following_url":"https://api.github.com/users/TimvdLippe/following{/other_user}","gists_url":"https://api.github.com/users/TimvdLippe/gists{/gist_id}","starred_url":"https://api.github.com/users/TimvdLippe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TimvdLippe/subscriptions","organizations_url":"https://api.github.com/users/TimvdLippe/orgs","repos_url":"https://api.github.com/users/TimvdLippe/repos","events_url":"https://api.github.com/users/TimvdLippe/events{/privacy}","received_events_url":"https://api.github.com/users/TimvdLippe/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mockito/mockito/issues/2865/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mockito/mockito/issues/2865/timeline","performed_via_github_app":null,"state_reason":"completed"}