{"url":"https://api.github.com/repos/mockito/mockito/issues/2281","repository_url":"https://api.github.com/repos/mockito/mockito","labels_url":"https://api.github.com/repos/mockito/mockito/issues/2281/labels{/name}","comments_url":"https://api.github.com/repos/mockito/mockito/issues/2281/comments","events_url":"https://api.github.com/repos/mockito/mockito/issues/2281/events","html_url":"https://github.com/mockito/mockito/issues/2281","id":872098147,"node_id":"MDU6SXNzdWU4NzIwOTgxNDc=","number":2281,"title":"MockedConstruction not autoclosed","user":{"login":"snv","id":992077,"node_id":"MDQ6VXNlcjk5MjA3Nw==","avatar_url":"https://avatars.githubusercontent.com/u/992077?v=4","gravatar_id":"","url":"https://api.github.com/users/snv","html_url":"https://github.com/snv","followers_url":"https://api.github.com/users/snv/followers","following_url":"https://api.github.com/users/snv/following{/other_user}","gists_url":"https://api.github.com/users/snv/gists{/gist_id}","starred_url":"https://api.github.com/users/snv/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/snv/subscriptions","organizations_url":"https://api.github.com/users/snv/orgs","repos_url":"https://api.github.com/users/snv/repos","events_url":"https://api.github.com/users/snv/events{/privacy}","received_events_url":"https://api.github.com/users/snv/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":532126464,"node_id":"MDU6TGFiZWw1MzIxMjY0NjQ=","url":"https://api.github.com/repos/mockito/mockito/labels/please%20contribute","name":"please contribute","color":"0e8a16","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2021-04-30T07:08:12Z","updated_at":"2021-10-06T19:42:05Z","closed_at":"2021-10-06T18:54:56Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Hi,\r\ni am using jUnit5 5.7.1 and Mockito 3.9.0, still on Java 8, starting the tests from IntelliJ IDEA 2020.3.4\r\n\r\nI have two testclasses (marked with  `@ExtendWith({MockitoExtension.class})`), which each have a test-method, which mocks the construction of MOCKED_CLASS via `@Mock` as parameter.\r\n\r\nThe second test fails though, with \r\n\r\n> org.junit.jupiter.api.extension.ParameterResolutionException: Failed to resolve parameter [org.mockito.MockedConstruction<MOCKED_CLASS> arg1] in method [public void SECONDLY_INVOCED_TEST_METHOD(org.mockito.MockedConstruction<MOCKED_CLASS>) throws java.lang.Exception]: \r\nFor MOCKED_CLASS, static mocking is already registered in the current thread\r\n>\r\n>To create a new mock, the existing static mock registration must be deregistered\r\n> \tat org.junit.jupiter.engine.execution.ExecutableInvoker.resolveParameter(ExecutableInvoker.java:239)\r\n> \tat org.junit.jupiter.engine.execution.ExecutableInvoker.resolveParameters(ExecutableInvoker.java:183)\r\n> \tat org.junit.jupiter.engine.execution.ExecutableInvoker.resolveParameters(ExecutableInvoker.java:144)\r\n> \tat org.junit.jupiter.engine.execution.ExecutableInvoker.invoke(ExecutableInvoker.java:96)\r\n> \tat org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.lambda$invokeTestMethod$6(TestMethodTestDescriptor.java:210)\r\n> \tat org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)\r\n> \tat org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.invokeTestMethod(TestMethodTestDescriptor.java:206)\r\n> \tat org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:131)\r\n> \tat org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:65)\r\n> \tat org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$5(NodeTestTask.java:139)\r\n> \tat org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)\r\n> \tat org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$7(NodeTestTask.java:129)\r\n> \tat org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)\r\n> \tat org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:127)\r\n> \tat org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)\r\n> \tat org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:126)\r\n> \tat org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:84)\r\n> \tat java.util.ArrayList.forEach(ArrayList.java:1257)\r\n> \tat org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:38)\r\n> \tat org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$5(NodeTestTask.java:143)\r\n> \tat org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)\r\n> \tat org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$7(NodeTestTask.java:129)\r\n> \tat org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)\r\n> \tat org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:127)\r\n> \tat org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)\r\n> \tat org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:126)\r\n> \tat org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:84)\r\n> \tat java.util.ArrayList.forEach(ArrayList.java:1257)\r\n> \tat org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:38)\r\n> \tat org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$5(NodeTestTask.java:143)\r\n> \tat org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)\r\n> \tat org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$7(NodeTestTask.java:129)\r\n> \tat org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)\r\n> \tat org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:127)\r\n> \tat org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)\r\n> \tat org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:126)\r\n> \tat org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:84)\r\n> \tat org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.submit(SameThreadHierarchicalTestExecutorService.java:32)\r\n> \tat org.junit.platform.engine.support.hierarchical.HierarchicalTestExecutor.execute(HierarchicalTestExecutor.java:57)\r\n> \tat org.junit.platform.engine.support.hierarchical.HierarchicalTestEngine.execute(HierarchicalTestEngine.java:51)\r\n> \tat org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:108)\r\n> \tat org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:88)\r\n> \tat org.junit.platform.launcher.core.EngineExecutionOrchestrator.lambda$execute$0(EngineExecutionOrchestrator.java:54)\r\n> \tat org.junit.platform.launcher.core.EngineExecutionOrchestrator.withInterceptedStreams(EngineExecutionOrchestrator.java:67)\r\n> \tat org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:52)\r\n> \tat org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:96)\r\n> \tat org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:75)\r\n> \tat com.intellij.junit5.JUnit5IdeaTestRunner.startRunnerWithArgs(JUnit5IdeaTestRunner.java:71)\r\n> \tat com.intellij.rt.junit.IdeaTestRunner$Repeater.startRunnerWithArgs(IdeaTestRunner.java:33)\r\n> \tat com.intellij.rt.junit.JUnitStarter.prepareStreamsAndStart(JUnitStarter.java:220)\r\n> \tat com.intellij.rt.junit.JUnitStarter.main(JUnitStarter.java:53)\r\n> Caused by: org.mockito.exceptions.base.MockitoException: \r\n> For com.oda.core.domain.production.customerImport.returns.ImportReturnsTransmissionFile, static mocking is already registered in the current thread\r\n> \r\n> To create a new mock, the existing static mock registration must be deregistered\r\n> \tat org.mockito.junit.jupiter.MockitoExtension.resolveParameter(MockitoExtension.java:198)\r\n> \tat org.junit.jupiter.engine.execution.ExecutableInvoker.resolveParameter(ExecutableInvoker.java:216)\r\n> \t... 50 more\r\n> \r\n> \r\n\r\nI can prevent that from happening, if i add a call to [`ScopedMock#closeOnDemand`](https://www.javadoc.io/static/org.mockito/mockito-core/3.9.0/org/mockito/ScopedMock.html#closeOnDemand--) on the injected `MockedConstruction<MOCKED_CLASS>` at the end of the first invoced test method.\r\nSo my conclusion is that the mocked construction was not auto-closed at the end of the method's scope, which is what i expected `@Mock` in combination with `@ExtendWith({MockitoExtension.class})` to do.\r\n\r\nOtherwise `@Mock` would be unusable for this, and i would have to use the try-with-ressouces syntax, to make sure the `MockedConstruction` actually gets released, even if the test fails (which is the workaround i will use for now).","closed_by":{"login":"TimvdLippe","id":5948271,"node_id":"MDQ6VXNlcjU5NDgyNzE=","avatar_url":"https://avatars.githubusercontent.com/u/5948271?v=4","gravatar_id":"","url":"https://api.github.com/users/TimvdLippe","html_url":"https://github.com/TimvdLippe","followers_url":"https://api.github.com/users/TimvdLippe/followers","following_url":"https://api.github.com/users/TimvdLippe/following{/other_user}","gists_url":"https://api.github.com/users/TimvdLippe/gists{/gist_id}","starred_url":"https://api.github.com/users/TimvdLippe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TimvdLippe/subscriptions","organizations_url":"https://api.github.com/users/TimvdLippe/orgs","repos_url":"https://api.github.com/users/TimvdLippe/repos","events_url":"https://api.github.com/users/TimvdLippe/events{/privacy}","received_events_url":"https://api.github.com/users/TimvdLippe/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mockito/mockito/issues/2281/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mockito/mockito/issues/2281/timeline","performed_via_github_app":null,"state_reason":"completed"}