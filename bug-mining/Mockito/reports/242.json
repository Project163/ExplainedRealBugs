{"url":"https://api.github.com/repos/mockito/mockito/issues/2656","repository_url":"https://api.github.com/repos/mockito/mockito","labels_url":"https://api.github.com/repos/mockito/mockito/issues/2656/labels{/name}","comments_url":"https://api.github.com/repos/mockito/mockito/issues/2656/comments","events_url":"https://api.github.com/repos/mockito/mockito/issues/2656/events","html_url":"https://github.com/mockito/mockito/issues/2656","id":1253591611,"node_id":"I_kwDOAF62v85KuEo7","number":2656,"title":"Regression? Strictness set in `@MockitoSettings` ignored after upgrade from 4.5.1 to 4.6.0","user":{"login":"big-andy-coates","id":8012398,"node_id":"MDQ6VXNlcjgwMTIzOTg=","avatar_url":"https://avatars.githubusercontent.com/u/8012398?v=4","gravatar_id":"","url":"https://api.github.com/users/big-andy-coates","html_url":"https://github.com/big-andy-coates","followers_url":"https://api.github.com/users/big-andy-coates/followers","following_url":"https://api.github.com/users/big-andy-coates/following{/other_user}","gists_url":"https://api.github.com/users/big-andy-coates/gists{/gist_id}","starred_url":"https://api.github.com/users/big-andy-coates/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/big-andy-coates/subscriptions","organizations_url":"https://api.github.com/users/big-andy-coates/orgs","repos_url":"https://api.github.com/users/big-andy-coates/repos","events_url":"https://api.github.com/users/big-andy-coates/events{/privacy}","received_events_url":"https://api.github.com/users/big-andy-coates/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":18,"created_at":"2022-05-31T09:28:19Z","updated_at":"2023-04-04T13:21:30Z","closed_at":"2022-06-02T16:07:34Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Upgrading from Mockito 4.5.1 to 4.6.0 and it looks to me as though https://github.com/mockito/mockito/pull/2650 or something around there has introduced a regression.\r\n\r\nI'm seeing `PotentialStubbingProblem` exceptions where previously there were none, because the test class is annotated with `@MockitoSettings(strictness = Strictness.LENIENT)`.\r\n\r\nThe issue seems to be that `StrictnessSelector` prefers the strictness set in the mock to the test level strictness, and the mock _defaults_ to `STRICT_STUBS`, so always overrides the strictness set in `@MockitoSettings`.\r\n\r\nI've added a failing example test that demonstrates the issue here:  https://github.com/big-andy-coates/mockito/pull/1\r\n\r\nThe above test fails with:\r\n\r\n```\r\nexpected: \r\n  Optional.empty\r\n but was: \r\n  Optional[org.mockito.exceptions.misusing.PotentialStubbingProblem: \r\n  Strict stubbing argument mismatch. Please check:\r\n   - this invocation of 'test' method:\r\n      rootMock.test(\"Bar\");\r\n      -> at org.mockitousage.ProductionCode.simpleMethod(ProductionCode.java:9)\r\n   - has following stubbing(s) with different arguments:\r\n      1. rootMock.test(\"Foo\");\r\n        -> at org.mockitousage.StrictnessTest$LenientMockitoSettings.should_not_throw_on_potential_stubbing_issue(StrictnessTest.java:176)\r\n  Typically, stubbing argument mismatch indicates user mistake when writing tests.\r\n  Mockito fails early so that you can debug potential problem easily.\r\n  However, there are legit scenarios when this exception generates false negative signal:\r\n    - stubbing the same method multiple times using 'given().will()' or 'when().then()' API\r\n      Please use 'will().given()' or 'doReturn().when()' API for stubbing.\r\n    - stubbed method is intentionally invoked with different arguments by code under test\r\n      Please use default or 'silent' JUnit Rule (equivalent of Strictness.LENIENT).\r\n  For more information see javadoc for PotentialStubbingProblem class.]\r\n```\r\n\r\n\r\n - [x] The mockito message in the stacktrace have useful information, but it didn't help\r\n - [x] The problematic code (if that's possible) is copied here;\r\n       Note that some configuration are impossible to mock via Mockito\r\n - [x] Provide versions (mockito / jdk / os / any other relevant information)\r\n - [x] Provide a [Short, Self Contained, Correct (Compilable), Example](http://sscce.org) of the issue\r\n       (same as any question on stackoverflow.com)\r\n - [x] Read the [contributing guide](https://github.com/mockito/mockito/blob/main/.github/CONTRIBUTING.md)\r\n\r\n\r\n","closed_by":{"login":"TimvdLippe","id":5948271,"node_id":"MDQ6VXNlcjU5NDgyNzE=","avatar_url":"https://avatars.githubusercontent.com/u/5948271?v=4","gravatar_id":"","url":"https://api.github.com/users/TimvdLippe","html_url":"https://github.com/TimvdLippe","followers_url":"https://api.github.com/users/TimvdLippe/followers","following_url":"https://api.github.com/users/TimvdLippe/following{/other_user}","gists_url":"https://api.github.com/users/TimvdLippe/gists{/gist_id}","starred_url":"https://api.github.com/users/TimvdLippe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TimvdLippe/subscriptions","organizations_url":"https://api.github.com/users/TimvdLippe/orgs","repos_url":"https://api.github.com/users/TimvdLippe/repos","events_url":"https://api.github.com/users/TimvdLippe/events{/privacy}","received_events_url":"https://api.github.com/users/TimvdLippe/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mockito/mockito/issues/2656/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":1},"timeline_url":"https://api.github.com/repos/mockito/mockito/issues/2656/timeline","performed_via_github_app":null,"state_reason":"completed"}