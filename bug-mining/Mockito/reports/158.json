{"url":"https://api.github.com/repos/mockito/mockito/issues/1578","repository_url":"https://api.github.com/repos/mockito/mockito","labels_url":"https://api.github.com/repos/mockito/mockito/issues/1578/labels{/name}","comments_url":"https://api.github.com/repos/mockito/mockito/issues/1578/comments","events_url":"https://api.github.com/repos/mockito/mockito/issues/1578/events","html_url":"https://github.com/mockito/mockito/issues/1578","id":395538465,"node_id":"MDU6SXNzdWUzOTU1Mzg0NjU=","number":1578,"title":"UnfinishedMockingSessionException with inner test classes","user":{"login":"mouyang","id":652585,"node_id":"MDQ6VXNlcjY1MjU4NQ==","avatar_url":"https://avatars.githubusercontent.com/u/652585?v=4","gravatar_id":"","url":"https://api.github.com/users/mouyang","html_url":"https://github.com/mouyang","followers_url":"https://api.github.com/users/mouyang/followers","following_url":"https://api.github.com/users/mouyang/following{/other_user}","gists_url":"https://api.github.com/users/mouyang/gists{/gist_id}","starred_url":"https://api.github.com/users/mouyang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mouyang/subscriptions","organizations_url":"https://api.github.com/users/mouyang/orgs","repos_url":"https://api.github.com/users/mouyang/repos","events_url":"https://api.github.com/users/mouyang/events{/privacy}","received_events_url":"https://api.github.com/users/mouyang/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2019-01-03T11:23:44Z","updated_at":"2019-01-31T23:39:06Z","closed_at":"2019-01-31T23:39:06Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"This appears to be a regression from 1.10.19 and 2.x-beta since it was reported as fixed in #353, but I was unable to get the sample test class to work in the release/2.x branch (also reported to fail in 2.13.0, 2.1.0-beta.125, and master too). The root cause is JUnitRule attempting to add a UniversalTestListener a second time to a ThreadSafeMockingProcess.\r\n\r\nSample Test class\r\n```\r\n@RunWith(HierarchicalContextRunner.class)\r\npublic class HierarchicalMockitoTest {\r\n    @Rule\r\n    public MockitoRule mockitoRule = MockitoJUnit.rule();\r\n\r\n    @Mock\r\n    private Runnable runnable;\r\n\r\n    public class Context {\r\n        @Test\r\n        public void test() throws Exception {\r\n            runnable.run();\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nException Thrown\r\n```\r\norg.mockito.exceptions.misusing.UnfinishedMockingSessionException: \r\nUnfinished mocking session detected.\r\nPrevious MockitoSession was not concluded with 'finishMocking()'.\r\nFor examples of correct usage see javadoc for MockitoSession class.\r\n\tat org.mockito.internal.junit.JUnitRule$1.evaluate(JUnitRule.java:42)\r\n\tat org.mockito.internal.junit.JUnitRule$1.evaluateSafely(JUnitRule.java:52)\r\n\tat org.mockito.internal.junit.JUnitRule$1.evaluate(JUnitRule.java:43)\r\n\tat de.bechte.junit.runners.context.statements.StatementExecutor.execute(StatementExecutor.java:28)\r\n\tat de.bechte.junit.runners.context.processing.MethodExecutor.run(MethodExecutor.java:83)\r\n\tat de.bechte.junit.runners.context.processing.MethodExecutor.run(MethodExecutor.java:57)\r\n\tat de.bechte.junit.runners.context.statements.RunChildren.evaluate(RunChildren.java:38)\r\n\tat de.bechte.junit.runners.context.statements.RunAll.evaluate(RunAll.java:27)\r\n\tat de.bechte.junit.runners.context.statements.StatementExecutor.execute(StatementExecutor.java:28)\r\n\tat de.bechte.junit.runners.context.HierarchicalContextRunner.run(HierarchicalContextRunner.java:134)\r\n\tat de.bechte.junit.runners.context.processing.ContextExecutor.run(ContextExecutor.java:26)\r\n\tat de.bechte.junit.runners.context.processing.ContextExecutor.run(ContextExecutor.java:15)\r\n\tat de.bechte.junit.runners.context.statements.RunChildren.evaluate(RunChildren.java:38)\r\n\tat de.bechte.junit.runners.context.statements.RunAll.evaluate(RunAll.java:27)\r\n\tat de.bechte.junit.runners.context.statements.StatementExecutor.execute(StatementExecutor.java:28)\r\n\tat de.bechte.junit.runners.context.HierarchicalContextRunner.run(HierarchicalContextRunner.java:134)\r\n\tat org.eclipse.jdt.internal.junit4.runner.JUnit4TestReference.run(JUnit4TestReference.java:86)\r\n\tat org.eclipse.jdt.internal.junit.runner.TestExecution.run(TestExecution.java:38)\r\n\tat org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:459)\r\n\tat org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:678)\r\n\tat org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.run(RemoteTestRunner.java:382)\r\n\tat org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.main(RemoteTestRunner.java:192)\r\n```\r\n\r\nI have a fix in progress which involves lazy initialization (\r\nhttps://github.com/mouyang/mockito/commit/540ad11d5a0d4066a73b3e46a932733d7ed816df).  I haven’t submitted a PR yet because I’m waiting for the library I used to reproduce the issue to make a new release with a required fix bechte/junit-hierarchicalcontextrunner#32. Also I need to clean up the commit to use reference this issue instead of 353. I suppose I can move forward with a PR if there was a way to reproduce the issue without using that library but I haven’t thought of a way to do that.\r\n\r\nThanks to @UrsMetz for verifying the regression and providing a sample test class.","closed_by":{"login":"TimvdLippe","id":5948271,"node_id":"MDQ6VXNlcjU5NDgyNzE=","avatar_url":"https://avatars.githubusercontent.com/u/5948271?v=4","gravatar_id":"","url":"https://api.github.com/users/TimvdLippe","html_url":"https://github.com/TimvdLippe","followers_url":"https://api.github.com/users/TimvdLippe/followers","following_url":"https://api.github.com/users/TimvdLippe/following{/other_user}","gists_url":"https://api.github.com/users/TimvdLippe/gists{/gist_id}","starred_url":"https://api.github.com/users/TimvdLippe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TimvdLippe/subscriptions","organizations_url":"https://api.github.com/users/TimvdLippe/orgs","repos_url":"https://api.github.com/users/TimvdLippe/repos","events_url":"https://api.github.com/users/TimvdLippe/events{/privacy}","received_events_url":"https://api.github.com/users/TimvdLippe/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mockito/mockito/issues/1578/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mockito/mockito/issues/1578/timeline","performed_via_github_app":null,"state_reason":"completed"}