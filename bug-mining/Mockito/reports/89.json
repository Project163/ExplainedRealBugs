{"url":"https://api.github.com/repos/mockito/mockito/issues/699","repository_url":"https://api.github.com/repos/mockito/mockito","labels_url":"https://api.github.com/repos/mockito/mockito/issues/699/labels{/name}","comments_url":"https://api.github.com/repos/mockito/mockito/issues/699/comments","events_url":"https://api.github.com/repos/mockito/mockito/issues/699/events","html_url":"https://github.com/mockito/mockito/issues/699","id":183362217,"node_id":"MDU6SXNzdWUxODMzNjIyMTc=","number":699,"title":"Fails to create mock of inner class hierarchy with type variable from outer class","user":{"login":"bric3","id":803621,"node_id":"MDQ6VXNlcjgwMzYyMQ==","avatar_url":"https://avatars.githubusercontent.com/u/803621?v=4","gravatar_id":"","url":"https://api.github.com/users/bric3","html_url":"https://github.com/bric3","followers_url":"https://api.github.com/users/bric3/followers","following_url":"https://api.github.com/users/bric3/following{/other_user}","gists_url":"https://api.github.com/users/bric3/gists{/gist_id}","starred_url":"https://api.github.com/users/bric3/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bric3/subscriptions","organizations_url":"https://api.github.com/users/bric3/orgs","repos_url":"https://api.github.com/users/bric3/repos","events_url":"https://api.github.com/users/bric3/events{/privacy}","received_events_url":"https://api.github.com/users/bric3/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":16375483,"node_id":"MDU6TGFiZWwxNjM3NTQ4Mw==","url":"https://api.github.com/repos/mockito/mockito/labels/bug","name":"bug","color":"fc2929","default":true,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2016-10-17T09:06:29Z","updated_at":"2016-10-17T15:30:45Z","closed_at":"2016-10-17T15:30:45Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Reported on the mailing-list [here](https://groups.google.com/d/msg/mockito/KkErqUKB8PQ/LanMehSpAQAJ) by Thang\n\nThis bug exists in Mockito 2.1.0 and does not exists in 1.10.19. The issue seems related to how ByteBuddy gather type variables.\n\nHere's how to I reproduced the issue : \n\n``` java\npublic abstract class AbstractOuter<InputT, OutputT> {\n    public abstract class AbstractInnerParent {\n        public abstract InputT input();\n        public abstract void output(OutputT output);\n    }\n\n    public abstract class AbstractInnerParentChild extends AbstractInnerParent { }\n}\n```\n\n``` java\n@Test\npublic void should_not_fail_creating_mock_of_inner_class_with_type_variable_of_outer() {\n    mock(AbstractOuter.AbstractInnerParentChild.class,\n         withSettings().outerInstance(AbstractOuter.class));\n}\n```\n\nThis code produces the following stacktraces, VM is irrelevant here.\n\n```\norg.mockito.exceptions.base.MockitoException: \nMockito cannot mock this class: class AbstractOuter$AbstractInnerParentChild.\n\nMockito can only non-private & non-final classes.\nIf you're not sure why you're getting this error, please report to the mailing list.\n\n\nJava               : 1.8\nJVM vendor name    : Azul Systems, Inc.\nJVM vendor version : 25.102-b14\nJVM name           : OpenJDK 64-Bit Server VM\nJVM version        : 1.8.0_102-b14\nJVM info           : mixed mode\nOS name            : Mac OS X\nOS version         : 10.11.6\n\n\nUnderlying exception : java.lang.IllegalStateException: Unknown type variable: OutputT\n\n    at BugTest.should_not_fail_creating_mock_of_inner_class_with_type_variable_of_outer(BugTest.java:16)\n    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n    at java.lang.reflect.Method.invoke(Method.java:498)\n    at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:50)\n    at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)\n    at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:47)\n    at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)\n    at org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:325)\n    at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:78)\n    at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:57)\n    at org.junit.runners.ParentRunner$3.run(ParentRunner.java:290)\n    at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:71)\n    at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:288)\n    at org.junit.runners.ParentRunner.access$000(ParentRunner.java:58)\n    at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:268)\n    at org.junit.runners.ParentRunner.run(ParentRunner.java:363)\n    at org.junit.runner.JUnitCore.run(JUnitCore.java:137)\n    at com.intellij.junit4.JUnit4IdeaTestRunner.startRunnerWithArgs(JUnit4IdeaTestRunner.java:68)\n    at com.intellij.rt.execution.junit.IdeaTestRunner$Repeater.startRunnerWithArgs(IdeaTestRunner.java:51)\n    at com.intellij.rt.execution.junit.JUnitStarter.prepareStreamsAndStart(JUnitStarter.java:237)\n    at com.intellij.rt.execution.junit.JUnitStarter.main(JUnitStarter.java:70)\n    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n    at java.lang.reflect.Method.invoke(Method.java:498)\n    at com.intellij.rt.execution.application.AppMain.main(AppMain.java:147)\nCaused by: java.lang.IllegalStateException: Unknown type variable: OutputT\n    at net.bytebuddy.description.type.TypeDescription$Generic$Visitor$Substitutor$ForTypeVariableBinding$TypeVariableSubstitutor.onType(TypeDescription.java:2183)\n    at net.bytebuddy.description.type.TypeDescription$Generic$Visitor$Substitutor$ForTypeVariableBinding$TypeVariableSubstitutor.onType(TypeDescription.java:2163)\n    at net.bytebuddy.description.type.TypeDescription$AbstractBase.accept(TypeDescription.java:7221)\n    at net.bytebuddy.description.type.TypeDescription$Generic$Visitor$Substitutor$ForTypeVariableBinding.onTypeVariable(TypeDescription.java:2136)\n    at net.bytebuddy.description.type.TypeDescription$Generic$Visitor$Substitutor$ForTypeVariableBinding.onTypeVariable(TypeDescription.java:2095)\n    at net.bytebuddy.description.type.TypeDescription$Generic$OfTypeVariable.accept(TypeDescription.java:5416)\n    at net.bytebuddy.description.type.TypeDescription$Generic$LazyProjection.accept(TypeDescription.java:5857)\n    at net.bytebuddy.description.method.ParameterDescription$TypeSubstituting.getType(ParameterDescription.java:858)\n    at net.bytebuddy.description.method.ParameterList$AbstractBase.asTypeList(ParameterList.java:86)\n    at net.bytebuddy.description.method.MethodDescription$AbstractBase.asTypeToken(MethodDescription.java:675)\n    at net.bytebuddy.dynamic.scaffold.MethodGraph$Compiler$Default$Key$Harmonized.of(MethodGraph.java:862)\n    at net.bytebuddy.dynamic.scaffold.MethodGraph$Compiler$Default$Key$Store.registerTopLevel(MethodGraph.java:1059)\n    at net.bytebuddy.dynamic.scaffold.MethodGraph$Compiler$Default.doAnalyze(MethodGraph.java:569)\n    at net.bytebuddy.dynamic.scaffold.MethodGraph$Compiler$Default.analyze(MethodGraph.java:529)\n    at net.bytebuddy.dynamic.scaffold.MethodGraph$Compiler$Default.analyzeNullable(MethodGraph.java:548)\n    at net.bytebuddy.dynamic.scaffold.MethodGraph$Compiler$Default.doAnalyze(MethodGraph.java:562)\n    at net.bytebuddy.dynamic.scaffold.MethodGraph$Compiler$Default.analyze(MethodGraph.java:529)\n    at net.bytebuddy.dynamic.scaffold.MethodGraph$Compiler$Default.analyzeNullable(MethodGraph.java:548)\n    at net.bytebuddy.dynamic.scaffold.MethodGraph$Compiler$Default.doAnalyze(MethodGraph.java:562)\n    at net.bytebuddy.dynamic.scaffold.MethodGraph$Compiler$Default.compile(MethodGraph.java:502)\n    at net.bytebuddy.dynamic.scaffold.MethodGraph$Compiler$AbstractBase.compile(MethodGraph.java:423)\n    at net.bytebuddy.dynamic.scaffold.MethodRegistry$Default.prepare(MethodRegistry.java:478)\n    at net.bytebuddy.dynamic.scaffold.subclass.SubclassDynamicTypeBuilder.make(SubclassDynamicTypeBuilder.java:160)\n    at net.bytebuddy.dynamic.scaffold.subclass.SubclassDynamicTypeBuilder.make(SubclassDynamicTypeBuilder.java:153)\n    at net.bytebuddy.dynamic.DynamicType$Builder$AbstractBase.make(DynamicType.java:2568)\n    at net.bytebuddy.dynamic.DynamicType$Builder$AbstractBase$Delegator.make(DynamicType.java:2670)\n    at org.mockito.internal.creation.bytebuddy.SubclassBytecodeGenerator.mockClass(SubclassBytecodeGenerator.java:80)\n    at org.mockito.internal.creation.bytebuddy.TypeCachingBytecodeGenerator$CachedBytecodeGenerator.getOrGenerateMockClass(TypeCachingBytecodeGenerator.java:87)\n    at org.mockito.internal.creation.bytebuddy.TypeCachingBytecodeGenerator.mockClass(TypeCachingBytecodeGenerator.java:34)\n    at org.mockito.internal.creation.bytebuddy.SubclassByteBuddyMockMaker.createMockType(SubclassByteBuddyMockMaker.java:64)\n    at org.mockito.internal.creation.bytebuddy.SubclassByteBuddyMockMaker.createMock(SubclassByteBuddyMockMaker.java:35)\n    at org.mockito.internal.creation.bytebuddy.ByteBuddyMockMaker.createMock(ByteBuddyMockMaker.java:22)\n    at org.mockito.internal.util.MockUtil.createMock(MockUtil.java:35)\n    at org.mockito.internal.MockitoCore.mock(MockitoCore.java:63)\n    at org.mockito.Mockito.mock(Mockito.java:1620)\n    ... 28 more\n```\n\n---\n\nOriginal issue with Google Dataflow SDK\n\n``` xml\n<dependency>\n  <groupId>com.google.cloud.dataflow</groupId>\n  <artifactId>google-cloud-dataflow-java-sdk-all</artifactId> \n  <version>1.8.0</version> \n</dependency> \n```\n\nMocked classe : [`DoFn.ProcessContext`](https://github.com/GoogleCloudPlatform/DataflowJavaSDK/blob/v1.8.0/sdk/src/main/java/com/google/cloud/dataflow/sdk/transforms/DoFn.java)\n\n``` java\nDoFn<String, ETEvent>.ProcessContext mockContext = \n    mock(DoFn.ProcessContext.class, withSettings().stubOnly().outerInstance(DoFn.class));\n```\n\n```\norg.mockito.exceptions.base.MockitoException: \nMockito cannot mock this class: class com.google.cloud.dataflow.sdk.transforms.DoFn$ProcessContext.\n\nMockito can only non-private & non-final classes.\nIf you're not sure why you're getting this error, please report to the mailing list.\n\n\nJava               : 1.8\nJVM vendor name    : Oracle Corporation\nJVM vendor version : 25.91-b14\nJVM name           : Java HotSpot(TM) 64-Bit Server VM\nJVM version        : 1.8.0_91-b14\nJVM info           : mixed mode\nOS name            : Mac OS X\nOS version         : 10.11.6\n\n\nUnderlying exception : java.lang.IllegalStateException: Unknown type variable: OutputT\n```\n","closed_by":{"login":"raphw","id":4489328,"node_id":"MDQ6VXNlcjQ0ODkzMjg=","avatar_url":"https://avatars.githubusercontent.com/u/4489328?v=4","gravatar_id":"","url":"https://api.github.com/users/raphw","html_url":"https://github.com/raphw","followers_url":"https://api.github.com/users/raphw/followers","following_url":"https://api.github.com/users/raphw/following{/other_user}","gists_url":"https://api.github.com/users/raphw/gists{/gist_id}","starred_url":"https://api.github.com/users/raphw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/raphw/subscriptions","organizations_url":"https://api.github.com/users/raphw/orgs","repos_url":"https://api.github.com/users/raphw/repos","events_url":"https://api.github.com/users/raphw/events{/privacy}","received_events_url":"https://api.github.com/users/raphw/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mockito/mockito/issues/699/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mockito/mockito/issues/699/timeline","performed_via_github_app":null,"state_reason":"completed"}