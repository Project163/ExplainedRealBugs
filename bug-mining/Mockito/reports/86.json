{"url":"https://api.github.com/repos/mockito/mockito/issues/701","repository_url":"https://api.github.com/repos/mockito/mockito","labels_url":"https://api.github.com/repos/mockito/mockito/issues/701/labels{/name}","comments_url":"https://api.github.com/repos/mockito/mockito/issues/701/comments","events_url":"https://api.github.com/repos/mockito/mockito/issues/701/events","html_url":"https://github.com/mockito/mockito/issues/701","id":183750277,"node_id":"MDU6SXNzdWUxODM3NTAyNzc=","number":701,"title":"Mockito 2 cannot mock kohsuke/github-api classes","user":{"login":"bric3","id":803621,"node_id":"MDQ6VXNlcjgwMzYyMQ==","avatar_url":"https://avatars.githubusercontent.com/u/803621?v=4","gravatar_id":"","url":"https://api.github.com/users/bric3","html_url":"https://github.com/bric3","followers_url":"https://api.github.com/users/bric3/followers","following_url":"https://api.github.com/users/bric3/following{/other_user}","gists_url":"https://api.github.com/users/bric3/gists{/gist_id}","starred_url":"https://api.github.com/users/bric3/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bric3/subscriptions","organizations_url":"https://api.github.com/users/bric3/orgs","repos_url":"https://api.github.com/users/bric3/repos","events_url":"https://api.github.com/users/bric3/events{/privacy}","received_events_url":"https://api.github.com/users/bric3/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":16375483,"node_id":"MDU6TGFiZWwxNjM3NTQ4Mw==","url":"https://api.github.com/repos/mockito/mockito/labels/bug","name":"bug","color":"fc2929","default":true,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2016-10-18T17:19:50Z","updated_at":"2016-10-25T20:08:52Z","closed_at":"2016-10-25T20:08:52Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"A user (Adam) on the [mailing list](https://groups.google.com/d/msgid/mockito/4cbdcec2-19d6-4757-b135-2cf515ed785f%40googlegroups.com) wasn't sure if he misused mockito. So he reached us via the mailing-list.\n\n> Hi guys, a super simple test that creates a new mock of a public non-final class `org.kohsuke.github.GHIssue` from https://github.com/kohsuke/github-api version 1.77, source https://github.com/kohsuke/github-api/blob/github-api-1.77/src/main/java/org/kohsuke/github/GHIssue.java fails with:\n\n```\nmock(GHIssue.class);\n```\n\n> ```\n> org.mockito.exceptions.base.MockitoException: \n> Mockito cannot mock this class: class org.kohsuke.github.GHIssue.\n> \n> Mockito can only non-private & non-final classes.\n> If you're not sure why you're getting this error, please report to the mailing list.\n> \n> Java               : 1.8\n> JVM vendor name    : Oracle Corporation\n> JVM vendor version : 25.101-b13\n> JVM name           : Java HotSpot(TM) 64-Bit Server VM\n> JVM version        : 1.8.0_101-b13\n> JVM info           : mixed mode\n> OS name            : Mac OS X\n> OS version         : 10.11.6\n> \n> \n> Underlying exception : java.lang.IllegalArgumentException: Cannot cast to primitive type: void\n> \n>     at com.siemion.mockito.AppTest.test(AppTest.java:12)\n>     at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n>     at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n>     at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n>     at java.lang.reflect.Method.invoke(Method.java:498)\n>     at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:47)\n>     at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)\n>     at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:44)\n>     at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)\n>     at org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:271)\n>     at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:70)\n>     at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:50)\n>     at org.junit.runners.ParentRunner$3.run(ParentRunner.java:238)\n>     at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:63)\n>     at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:236)\n>     at org.junit.runners.ParentRunner.access$000(ParentRunner.java:53)\n>     at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:229)\n>     at org.junit.runners.ParentRunner.run(ParentRunner.java:309)\n>     at org.junit.runner.JUnitCore.run(JUnitCore.java:160)\n>     at com.intellij.junit4.JUnit4IdeaTestRunner.startRunnerWithArgs(JUnit4IdeaTestRunner.java:69)\n>     at com.intellij.rt.execution.junit.JUnitStarter.prepareStreamsAndStart(JUnitStarter.java:234)\n>     at com.intellij.rt.execution.junit.JUnitStarter.main(JUnitStarter.java:74)\n>     at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n>     at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n>     at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n>     at java.lang.reflect.Method.invoke(Method.java:498)\n>     at com.intellij.rt.execution.application.AppMain.main(AppMain.java:144)\n> Caused by: java.lang.IllegalArgumentException: Cannot cast to primitive type: void\n>     at net.bytebuddy.implementation.bytecode.assign.TypeCasting.to(TypeCasting.java:39)\n>     at net.bytebuddy.dynamic.scaffold.TypeWriter$MethodPool$Record$AccessBridgeWrapper.apply(TypeWriter.java:1100)\n>     at net.bytebuddy.dynamic.scaffold.TypeWriter$Default$ForCreation.create(TypeWriter.java:3802)\n>     at net.bytebuddy.dynamic.scaffold.TypeWriter$Default.make(TypeWriter.java:1618)\n>     at net.bytebuddy.dynamic.scaffold.subclass.SubclassDynamicTypeBuilder.make(SubclassDynamicTypeBuilder.java:172)\n>     at net.bytebuddy.dynamic.scaffold.subclass.SubclassDynamicTypeBuilder.make(SubclassDynamicTypeBuilder.java:153)\n>     at net.bytebuddy.dynamic.DynamicType$Builder$AbstractBase.make(DynamicType.java:2568)\n>     at net.bytebuddy.dynamic.DynamicType$Builder$AbstractBase$Delegator.make(DynamicType.java:2670)\n>     at org.mockito.internal.creation.bytebuddy.SubclassBytecodeGenerator.mockClass(SubclassBytecodeGenerator.java:80)\n>     at org.mockito.internal.creation.bytebuddy.TypeCachingBytecodeGenerator$CachedBytecodeGenerator.getOrGenerateMockClass(TypeCachingBytecodeGenerator.java:87)\n>     at org.mockito.internal.creation.bytebuddy.TypeCachingBytecodeGenerator.mockClass(TypeCachingBytecodeGenerator.java:34)\n>     at org.mockito.internal.creation.bytebuddy.SubclassByteBuddyMockMaker.createMockType(SubclassByteBuddyMockMaker.java:64)\n>     at org.mockito.internal.creation.bytebuddy.SubclassByteBuddyMockMaker.createMock(SubclassByteBuddyMockMaker.java:35)\n>     at org.mockito.internal.creation.bytebuddy.ByteBuddyMockMaker.createMock(ByteBuddyMockMaker.java:22)\n>     at org.mockito.internal.util.MockUtil.createMock(MockUtil.java:35)\n>     at org.mockito.internal.MockitoCore.mock(MockitoCore.java:63)\n>     at org.mockito.Mockito.mock(Mockito.java:1629)\n>     at org.mockito.Mockito.mock(Mockito.java:1542)\n>     ... 27 more\n> ```\n\nOr\n\n```\nmock(GHRepository.class);\n```\n\n> ```\n> java.lang.VerifyError: Bad type on operand stack\n> Exception Details:\n>   Location:\n>     org/kohsuke/github/GHRepository$MockitoMock$667330966.getId()Ljava/lang/String; @4: checkcast\n>   Reason:\n>     Type integer (current frame, stack[0]) is not assignable to 'java/lang/Object'\n>   Current Frame:\n>     bci: @4\n>     flags: { }\n>     locals: { 'org/kohsuke/github/GHRepository$MockitoMock$667330966' }\n>     stack: { integer }\n>   Bytecode:\n>     0x0000000: 2ab6 003d c000 2eb0                    \n> \n> \n>     at sun.reflect.GeneratedSerializationConstructorAccessor1.newInstance(Unknown Source)\n>     at java.lang.reflect.Constructor.newInstance(Constructor.java:423)\n>     at org.objenesis.instantiator.sun.SunReflectionFactoryInstantiator.newInstance(SunReflectionFactoryInstantiator.java:45)\n>     at org.objenesis.ObjenesisBase.newInstance(ObjenesisBase.java:73)\n>     at org.mockito.internal.creation.instance.ObjenesisInstantiator.newInstance(ObjenesisInstantiator.java:14)\n> ```\n\nRelated classes declaration\n\n```\n    <dependency>\n      <groupId>org.kohsuke</groupId>\n      <artifactId>github-api</artifactId>\n      <version>1.77</version>\n    </dependency>\n```\n\n---\n\nAfter investigation on the project created by Adam Siemon [here](https://github.com/adamsiemion/mockito-bug). Iâ€™ve reproduced the issue you are seeing with mockito 2.2.3 (bb 1.4.26) and 2.2.5 (bb 1.4.33), regardless of the JDK version. It seems related to how [kohsuke/github-api](https://github.com/kohsuke/github-api) generates bridge method in the byte code for backward compatibility ; this seems highly unusual, it may produce valid bytecode but with _unmet_ bytecode patterns for mockito / bytebuddy.\nFor reference the tool is called [bridge-method-injector](https://github.com/infradna/bridge-method-injector), more on the [website](http://bridge-method-injector.infradna.com/)\n\nThe classes you are mentioning are modified by this tool :\n- [`GHIssues`](https://github.com/kohsuke/github-api/blob/github-api-1.77/src/main/java/org/kohsuke/github/GHIssue.java#L151-L154) annotated by `@WithBridgeMethods(void.class)`\n- `GHRepository` that inherits [`GHObject`](https://github.com/kohsuke/github-api/blob/github-api-1.77/src/main/java/org/kohsuke/github/GHObject.java#L66-L69) which also annotated by `@WithBridgeMethods(value=String.class, adapterMethod=\"intToString\")`\n\nIt works with 1.10.19 because CGLIB is far less intelligent regarding bridge methods.\n","closed_by":{"login":"raphw","id":4489328,"node_id":"MDQ6VXNlcjQ0ODkzMjg=","avatar_url":"https://avatars.githubusercontent.com/u/4489328?v=4","gravatar_id":"","url":"https://api.github.com/users/raphw","html_url":"https://github.com/raphw","followers_url":"https://api.github.com/users/raphw/followers","following_url":"https://api.github.com/users/raphw/following{/other_user}","gists_url":"https://api.github.com/users/raphw/gists{/gist_id}","starred_url":"https://api.github.com/users/raphw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/raphw/subscriptions","organizations_url":"https://api.github.com/users/raphw/orgs","repos_url":"https://api.github.com/users/raphw/repos","events_url":"https://api.github.com/users/raphw/events{/privacy}","received_events_url":"https://api.github.com/users/raphw/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mockito/mockito/issues/701/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mockito/mockito/issues/701/timeline","performed_via_github_app":null,"state_reason":"completed"}