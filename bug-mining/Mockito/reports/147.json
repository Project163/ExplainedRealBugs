{"url":"https://api.github.com/repos/mockito/mockito/issues/1584","repository_url":"https://api.github.com/repos/mockito/mockito","labels_url":"https://api.github.com/repos/mockito/mockito/issues/1584/labels{/name}","comments_url":"https://api.github.com/repos/mockito/mockito/issues/1584/comments","events_url":"https://api.github.com/repos/mockito/mockito/issues/1584/events","html_url":"https://github.com/mockito/mockito/issues/1584","id":397331846,"node_id":"MDU6SXNzdWUzOTczMzE4NDY=","number":1584,"title":"ClassLoader built by mockito is not able to load declared types in the hierarchy in OSGi","user":{"login":"nfalco79","id":4160180,"node_id":"MDQ6VXNlcjQxNjAxODA=","avatar_url":"https://avatars.githubusercontent.com/u/4160180?v=4","gravatar_id":"","url":"https://api.github.com/users/nfalco79","html_url":"https://github.com/nfalco79","followers_url":"https://api.github.com/users/nfalco79/followers","following_url":"https://api.github.com/users/nfalco79/following{/other_user}","gists_url":"https://api.github.com/users/nfalco79/gists{/gist_id}","starred_url":"https://api.github.com/users/nfalco79/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nfalco79/subscriptions","organizations_url":"https://api.github.com/users/nfalco79/orgs","repos_url":"https://api.github.com/users/nfalco79/repos","events_url":"https://api.github.com/users/nfalco79/events{/privacy}","received_events_url":"https://api.github.com/users/nfalco79/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2019-01-09T11:37:11Z","updated_at":"2019-01-29T10:02:28Z","closed_at":"2019-01-29T10:02:28Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"We develop in OSGi environment and we are using latest version of mockito available on maven central 2.23.4\r\n\r\nWe got an issue when we mock classes given to guice (sisu) for injection. Sisu/Guice analyse all declared fields and methods for the input type and its super classes to built a sort of index of known types. In OSGi it fails with ClassNotFoundException on mocked classes. The reason is that the mocked class built with `SubclassBytecodeGenerator` has a classloader not able to load types reachable only by supertypes. In OSGi this does not happen because each class has associated the classloader from which is loaded. This guarantee that the class is able to reach/load each type it declares (by its methods, fields or annotations).\r\n\r\nExample:\r\n\r\n- Bundle A\r\n`foo.Class1` has a protected method that returns foo.impl.OtherClass\r\n`foo.impl.OtherClass`\r\n\r\n- Bundle B (imports only `foo` package from bundle A)\r\n`acme.Class2 extends Class1`\r\n\r\n`Mockito.mock(foo.Class1).getDeclaredMethods()` will fails. To fix this issue `SubclassBytecodeGenerator` should compose a classloader (`MultipleParentClassLoader`) with also the classloader of superclass the mocked type (`features.mockedType`).","closed_by":{"login":"TimvdLippe","id":5948271,"node_id":"MDQ6VXNlcjU5NDgyNzE=","avatar_url":"https://avatars.githubusercontent.com/u/5948271?v=4","gravatar_id":"","url":"https://api.github.com/users/TimvdLippe","html_url":"https://github.com/TimvdLippe","followers_url":"https://api.github.com/users/TimvdLippe/followers","following_url":"https://api.github.com/users/TimvdLippe/following{/other_user}","gists_url":"https://api.github.com/users/TimvdLippe/gists{/gist_id}","starred_url":"https://api.github.com/users/TimvdLippe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TimvdLippe/subscriptions","organizations_url":"https://api.github.com/users/TimvdLippe/orgs","repos_url":"https://api.github.com/users/TimvdLippe/repos","events_url":"https://api.github.com/users/TimvdLippe/events{/privacy}","received_events_url":"https://api.github.com/users/TimvdLippe/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mockito/mockito/issues/1584/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mockito/mockito/issues/1584/timeline","performed_via_github_app":null,"state_reason":"completed"}