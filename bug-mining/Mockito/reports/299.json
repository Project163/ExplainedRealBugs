{"url":"https://api.github.com/repos/mockito/mockito/issues/3035","repository_url":"https://api.github.com/repos/mockito/mockito","labels_url":"https://api.github.com/repos/mockito/mockito/issues/3035/labels{/name}","comments_url":"https://api.github.com/repos/mockito/mockito/issues/3035/comments","events_url":"https://api.github.com/repos/mockito/mockito/issues/3035/events","html_url":"https://github.com/mockito/mockito/issues/3035","id":1750718439,"node_id":"I_kwDOAF62v85oWdfn","number":3035,"title":"Excessive locking in TypeCachingBytecodeGenerator#BOOTSTRAP_LOCK","user":{"login":"aswath80","id":1150058,"node_id":"MDQ6VXNlcjExNTAwNTg=","avatar_url":"https://avatars.githubusercontent.com/u/1150058?v=4","gravatar_id":"","url":"https://api.github.com/users/aswath80","html_url":"https://github.com/aswath80","followers_url":"https://api.github.com/users/aswath80/followers","following_url":"https://api.github.com/users/aswath80/following{/other_user}","gists_url":"https://api.github.com/users/aswath80/gists{/gist_id}","starred_url":"https://api.github.com/users/aswath80/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/aswath80/subscriptions","organizations_url":"https://api.github.com/users/aswath80/orgs","repos_url":"https://api.github.com/users/aswath80/repos","events_url":"https://api.github.com/users/aswath80/events{/privacy}","received_events_url":"https://api.github.com/users/aswath80/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"raphw","id":4489328,"node_id":"MDQ6VXNlcjQ0ODkzMjg=","avatar_url":"https://avatars.githubusercontent.com/u/4489328?v=4","gravatar_id":"","url":"https://api.github.com/users/raphw","html_url":"https://github.com/raphw","followers_url":"https://api.github.com/users/raphw/followers","following_url":"https://api.github.com/users/raphw/following{/other_user}","gists_url":"https://api.github.com/users/raphw/gists{/gist_id}","starred_url":"https://api.github.com/users/raphw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/raphw/subscriptions","organizations_url":"https://api.github.com/users/raphw/orgs","repos_url":"https://api.github.com/users/raphw/repos","events_url":"https://api.github.com/users/raphw/events{/privacy}","received_events_url":"https://api.github.com/users/raphw/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"raphw","id":4489328,"node_id":"MDQ6VXNlcjQ0ODkzMjg=","avatar_url":"https://avatars.githubusercontent.com/u/4489328?v=4","gravatar_id":"","url":"https://api.github.com/users/raphw","html_url":"https://github.com/raphw","followers_url":"https://api.github.com/users/raphw/followers","following_url":"https://api.github.com/users/raphw/following{/other_user}","gists_url":"https://api.github.com/users/raphw/gists{/gist_id}","starred_url":"https://api.github.com/users/raphw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/raphw/subscriptions","organizations_url":"https://api.github.com/users/raphw/orgs","repos_url":"https://api.github.com/users/raphw/repos","events_url":"https://api.github.com/users/raphw/events{/privacy}","received_events_url":"https://api.github.com/users/raphw/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":1,"created_at":"2023-06-10T01:19:59Z","updated_at":"2023-08-22T06:50:30Z","closed_at":"2023-08-22T06:50:30Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"The TypeCachingBytecodeGenerator#BOOTSTRAP_LOCK is resulting in excessive BLOCKED threads when running several thousand tests concurrently.  Byte-buddy TypeCache's findOrInsert without monitor seems to handle concurrency. Is this global lock needed ?\r\n\r\nMockito-Inline 4.10, Byte-Buddy 1.12.19\r\n\r\n`\r\n\"ForkJoinPool-1-worker-84\" Id=115 RUNNABLE (daemon=TRUE)\r\n\tat java.base@17.0.4/java.lang.StringLatin1.replace(StringLatin1.java:322)\r\n\tat java.base@17.0.4/java.lang.String.replace(String.java:2806)\r\n\tat app//net.bytebuddy.jar.asm.Type.getInternalName(Type.java:510)\r\n\tat app//net.bytebuddy.jar.asm.Type.appendDescriptor(Type.java:644)\r\n\tat app//net.bytebuddy.jar.asm.Type.getMethodDescriptor(Type.java:585)\r\n\tat app//net.bytebuddy.description.method.MethodDescription$ForLoadedMethod.getDescriptor(MethodDescription.java:1288)\r\n\tat app//net.bytebuddy.asm.Advice$Dispatcher$Inlining$Resolved$AdviceMethodInliner.visitMethod(Advice.java:8400)\r\n\tat app//net.bytebuddy.jar.asm.ClassReader.readMethod(ClassReader.java:1353)\r\n\tat app//net.bytebuddy.jar.asm.ClassReader.accept(ClassReader.java:744)\r\n\tat app//net.bytebuddy.jar.asm.ClassReader.accept(ClassReader.java:424)\r\n\tat app//net.bytebuddy.asm.Advice$Dispatcher$Inlining$Resolved$AdviceMethodInliner.apply(Advice.java:8394)\r\n\tat app//net.bytebuddy.asm.Advice$AdviceVisitor$WithExitAdvice.onUserEnd(Advice.java:10904)\r\n\tat app//net.bytebuddy.asm.Advice$AdviceVisitor.visitMaxs(Advice.java:10683)\r\n\tat app//net.bytebuddy.jar.asm.ClassReader.readCode(ClassReader.java:2665)\r\n\tat app//net.bytebuddy.jar.asm.ClassReader.readMethod(ClassReader.java:1514)\r\n\tat app//net.bytebuddy.jar.asm.ClassReader.accept(ClassReader.java:744)\r\n\tat app//net.bytebuddy.jar.asm.ClassReader.accept(ClassReader.java:424)\r\n\tat app//net.bytebuddy.dynamic.scaffold.TypeWriter$Default$ForInlining.create(TypeWriter.java:4014)\r\n\tat app//net.bytebuddy.dynamic.scaffold.TypeWriter$Default.make(TypeWriter.java:2224)\r\n\tat app//net.bytebuddy.dynamic.DynamicType$Builder$AbstractBase$UsingTypeWriter.make(DynamicType.java:4050)\r\n\tat app//net.bytebuddy.dynamic.DynamicType$Builder$AbstractBase.make(DynamicType.java:3734)\r\n\tat app//org.mockito.internal.creation.bytebuddy.InlineBytecodeGenerator.transform(InlineBytecodeGenerator.java:401)\r\n\tat java.instrument@17.0.4/java.lang.instrument.ClassFileTransformer.transform(ClassFileTransformer.java:244)\r\n\tat java.instrument@17.0.4/sun.instrument.TransformerManager.transform(TransformerManager.java:188)\r\n\tat java.instrument@17.0.4/sun.instrument.InstrumentationImpl.transform(InstrumentationImpl.java:541)\r\n\tat java.instrument@17.0.4/sun.instrument.InstrumentationImpl.retransformClasses0(Native Method)\r\n\tat java.instrument@17.0.4/sun.instrument.InstrumentationImpl.retransformClasses(InstrumentationImpl.java:169)\r\n\tat app//org.mockito.internal.creation.bytebuddy.InlineBytecodeGenerator.triggerRetransformation(InlineBytecodeGenerator.java:280)\r\n\tat app//org.mockito.internal.creation.bytebuddy.InlineBytecodeGenerator.mockClass(InlineBytecodeGenerator.java:217)\r\n\t- locked <0x730e33e8> (a org.mockito.internal.creation.bytebuddy.InlineBytecodeGenerator)\r\n\tat app//org.mockito.internal.creation.bytebuddy.TypeCachingBytecodeGenerator.lambda$mockClass$0(TypeCachingBytecodeGenerator.java:47)\r\n\tat app//org.mockito.internal.creation.bytebuddy.TypeCachingBytecodeGenerator$$Lambda$895/0x0000000801aeaf98.call(Unknown Source)\r\n\tat app//net.bytebuddy.TypeCache.findOrInsert(TypeCache.java:168)\r\n\tat app//net.bytebuddy.TypeCache$WithInlineExpunction.findOrInsert(TypeCache.java:399)\r\n\tat app//net.bytebuddy.TypeCache.findOrInsert(TypeCache.java:190)\r\n\t- locked <0x62f72614> (a java.lang.Object)\r\n\tat app//net.bytebuddy.TypeCache$WithInlineExpunction.findOrInsert(TypeCache.java:410)\r\n`\r\n\r\n`\r\n\"ForkJoinPool-1-worker-51\" Id=82 BLOCKED on java.lang.Object@62f72614 owned by \"ForkJoinPool-1-worker-84\" Id=115115 (daemon=TRUE)\r\n\tat app//net.bytebuddy.TypeCache.findOrInsert(TypeCache.java:189)\r\n\tat app//net.bytebuddy.TypeCache$WithInlineExpunction.findOrInsert(TypeCache.java:410)\r\n\tat app//org.mockito.internal.creation.bytebuddy.TypeCachingBytecodeGenerator.mockClass(TypeCachingBytecodeGenerator.java:40)\r\n\tat app//org.mockito.internal.creation.bytebuddy.InlineDelegateByteBuddyMockMaker.createMockType(InlineDelegateByteBuddyMockMaker.java:396)\r\n\tat app//org.mockito.internal.creation.bytebuddy.InlineDelegateByteBuddyMockMaker.doCreateMock(InlineDelegateByteBuddyMockMaker.java:355)\r\n\tat app//org.mockito.internal.creation.bytebuddy.InlineDelegateByteBuddyMockMaker.createMock(InlineDelegateByteBuddyMockMaker.java:334)\r\n\tat app//org.mockito.internal.creation.bytebuddy.InlineByteBuddyMockMaker.createMock(InlineByteBuddyMockMaker.java:56)\r\n\tat app//org.mockito.internal.util.MockUtil.createMock(MockUtil.java:99)\r\n`\r\n\r\ncheck that\r\n\r\n - [X] The mockito message in the stacktrace have useful information, but it didn't help\r\n - [X] The problematic code (if that's possible) is copied here;\r\n       Note that some configuration are impossible to mock via Mockito\r\n - [X] Provide versions (mockito / jdk / os / any other relevant information)\r\n - [X] Provide a [Short, Self Contained, Correct (Compilable), Example](http://sscce.org) of the issue\r\n       (same as any question on stackoverflow.com)\r\n - [X] Read the [contributing guide](https://github.com/mockito/mockito/blob/main/.github/CONTRIBUTING.md)\r\n\r\n\r\n","closed_by":{"login":"TimvdLippe","id":5948271,"node_id":"MDQ6VXNlcjU5NDgyNzE=","avatar_url":"https://avatars.githubusercontent.com/u/5948271?v=4","gravatar_id":"","url":"https://api.github.com/users/TimvdLippe","html_url":"https://github.com/TimvdLippe","followers_url":"https://api.github.com/users/TimvdLippe/followers","following_url":"https://api.github.com/users/TimvdLippe/following{/other_user}","gists_url":"https://api.github.com/users/TimvdLippe/gists{/gist_id}","starred_url":"https://api.github.com/users/TimvdLippe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TimvdLippe/subscriptions","organizations_url":"https://api.github.com/users/TimvdLippe/orgs","repos_url":"https://api.github.com/users/TimvdLippe/repos","events_url":"https://api.github.com/users/TimvdLippe/events{/privacy}","received_events_url":"https://api.github.com/users/TimvdLippe/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mockito/mockito/issues/3035/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mockito/mockito/issues/3035/timeline","performed_via_github_app":null,"state_reason":"completed"}