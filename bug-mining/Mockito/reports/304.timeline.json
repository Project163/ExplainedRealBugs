[{"id":11005776608,"node_id":"REFE_lADOAF62v851Kk9MzwAAAAKP_tLg","url":"https://api.github.com/repos/mockito/mockito/issues/events/11005776608","actor":{"login":"LeMikaelF","id":22927506,"node_id":"MDQ6VXNlcjIyOTI3NTA2","avatar_url":"https://avatars.githubusercontent.com/u/22927506?v=4","gravatar_id":"","url":"https://api.github.com/users/LeMikaelF","html_url":"https://github.com/LeMikaelF","followers_url":"https://api.github.com/users/LeMikaelF/followers","following_url":"https://api.github.com/users/LeMikaelF/following{/other_user}","gists_url":"https://api.github.com/users/LeMikaelF/gists{/gist_id}","starred_url":"https://api.github.com/users/LeMikaelF/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/LeMikaelF/subscriptions","organizations_url":"https://api.github.com/users/LeMikaelF/orgs","repos_url":"https://api.github.com/users/LeMikaelF/repos","events_url":"https://api.github.com/users/LeMikaelF/events{/privacy}","received_events_url":"https://api.github.com/users/LeMikaelF/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"e32024f3de9a6d398b860d89ca4b4100a6562b4a","commit_url":"https://api.github.com/repos/LeMikaelF/mockito/commits/e32024f3de9a6d398b860d89ca4b4100a6562b4a","created_at":"2023-11-20T03:14:45Z","performed_via_github_app":null},{"actor":{"login":"LeMikaelF","id":22927506,"node_id":"MDQ6VXNlcjIyOTI3NTA2","avatar_url":"https://avatars.githubusercontent.com/u/22927506?v=4","gravatar_id":"","url":"https://api.github.com/users/LeMikaelF","html_url":"https://github.com/LeMikaelF","followers_url":"https://api.github.com/users/LeMikaelF/followers","following_url":"https://api.github.com/users/LeMikaelF/following{/other_user}","gists_url":"https://api.github.com/users/LeMikaelF/gists{/gist_id}","starred_url":"https://api.github.com/users/LeMikaelF/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/LeMikaelF/subscriptions","organizations_url":"https://api.github.com/users/LeMikaelF/orgs","repos_url":"https://api.github.com/users/LeMikaelF/repos","events_url":"https://api.github.com/users/LeMikaelF/events{/privacy}","received_events_url":"https://api.github.com/users/LeMikaelF/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-11-20T04:31:24Z","updated_at":"2023-11-20T04:31:24Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/mockito/mockito/issues/3173","repository_url":"https://api.github.com/repos/mockito/mockito","labels_url":"https://api.github.com/repos/mockito/mockito/issues/3173/labels{/name}","comments_url":"https://api.github.com/repos/mockito/mockito/issues/3173/comments","events_url":"https://api.github.com/repos/mockito/mockito/issues/3173/events","html_url":"https://github.com/mockito/mockito/pull/3173","id":2001344750,"node_id":"PR_kwDOAF62v85f3W5e","number":3173,"title":"Fixes #3160 : Fix interference between spies when spying on records.","user":{"login":"LeMikaelF","id":22927506,"node_id":"MDQ6VXNlcjIyOTI3NTA2","avatar_url":"https://avatars.githubusercontent.com/u/22927506?v=4","gravatar_id":"","url":"https://api.github.com/users/LeMikaelF","html_url":"https://github.com/LeMikaelF","followers_url":"https://api.github.com/users/LeMikaelF/followers","following_url":"https://api.github.com/users/LeMikaelF/following{/other_user}","gists_url":"https://api.github.com/users/LeMikaelF/gists{/gist_id}","starred_url":"https://api.github.com/users/LeMikaelF/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/LeMikaelF/subscriptions","organizations_url":"https://api.github.com/users/LeMikaelF/orgs","repos_url":"https://api.github.com/users/LeMikaelF/repos","events_url":"https://api.github.com/users/LeMikaelF/events{/privacy}","received_events_url":"https://api.github.com/users/LeMikaelF/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2023-11-20T04:31:24Z","updated_at":"2023-11-28T06:57:26Z","closed_at":"2023-11-28T06:57:26Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"draft":false,"repository":{"id":6207167,"node_id":"MDEwOlJlcG9zaXRvcnk2MjA3MTY3","name":"mockito","full_name":"mockito/mockito","private":false,"owner":{"login":"mockito","id":2054056,"node_id":"MDEyOk9yZ2FuaXphdGlvbjIwNTQwNTY=","avatar_url":"https://avatars.githubusercontent.com/u/2054056?v=4","gravatar_id":"","url":"https://api.github.com/users/mockito","html_url":"https://github.com/mockito","followers_url":"https://api.github.com/users/mockito/followers","following_url":"https://api.github.com/users/mockito/following{/other_user}","gists_url":"https://api.github.com/users/mockito/gists{/gist_id}","starred_url":"https://api.github.com/users/mockito/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mockito/subscriptions","organizations_url":"https://api.github.com/users/mockito/orgs","repos_url":"https://api.github.com/users/mockito/repos","events_url":"https://api.github.com/users/mockito/events{/privacy}","received_events_url":"https://api.github.com/users/mockito/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/mockito/mockito","description":"Most popular Mocking framework for unit tests written in Java","fork":false,"url":"https://api.github.com/repos/mockito/mockito","forks_url":"https://api.github.com/repos/mockito/mockito/forks","keys_url":"https://api.github.com/repos/mockito/mockito/keys{/key_id}","collaborators_url":"https://api.github.com/repos/mockito/mockito/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/mockito/mockito/teams","hooks_url":"https://api.github.com/repos/mockito/mockito/hooks","issue_events_url":"https://api.github.com/repos/mockito/mockito/issues/events{/number}","events_url":"https://api.github.com/repos/mockito/mockito/events","assignees_url":"https://api.github.com/repos/mockito/mockito/assignees{/user}","branches_url":"https://api.github.com/repos/mockito/mockito/branches{/branch}","tags_url":"https://api.github.com/repos/mockito/mockito/tags","blobs_url":"https://api.github.com/repos/mockito/mockito/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/mockito/mockito/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/mockito/mockito/git/refs{/sha}","trees_url":"https://api.github.com/repos/mockito/mockito/git/trees{/sha}","statuses_url":"https://api.github.com/repos/mockito/mockito/statuses/{sha}","languages_url":"https://api.github.com/repos/mockito/mockito/languages","stargazers_url":"https://api.github.com/repos/mockito/mockito/stargazers","contributors_url":"https://api.github.com/repos/mockito/mockito/contributors","subscribers_url":"https://api.github.com/repos/mockito/mockito/subscribers","subscription_url":"https://api.github.com/repos/mockito/mockito/subscription","commits_url":"https://api.github.com/repos/mockito/mockito/commits{/sha}","git_commits_url":"https://api.github.com/repos/mockito/mockito/git/commits{/sha}","comments_url":"https://api.github.com/repos/mockito/mockito/comments{/number}","issue_comment_url":"https://api.github.com/repos/mockito/mockito/issues/comments{/number}","contents_url":"https://api.github.com/repos/mockito/mockito/contents/{+path}","compare_url":"https://api.github.com/repos/mockito/mockito/compare/{base}...{head}","merges_url":"https://api.github.com/repos/mockito/mockito/merges","archive_url":"https://api.github.com/repos/mockito/mockito/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/mockito/mockito/downloads","issues_url":"https://api.github.com/repos/mockito/mockito/issues{/number}","pulls_url":"https://api.github.com/repos/mockito/mockito/pulls{/number}","milestones_url":"https://api.github.com/repos/mockito/mockito/milestones{/number}","notifications_url":"https://api.github.com/repos/mockito/mockito/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/mockito/mockito/labels{/name}","releases_url":"https://api.github.com/repos/mockito/mockito/releases{/id}","deployments_url":"https://api.github.com/repos/mockito/mockito/deployments","created_at":"2012-10-13T20:27:12Z","updated_at":"2025-11-09T13:17:53Z","pushed_at":"2025-10-31T15:40:36Z","git_url":"git://github.com/mockito/mockito.git","ssh_url":"git@github.com:mockito/mockito.git","clone_url":"https://github.com/mockito/mockito.git","svn_url":"https://github.com/mockito/mockito","homepage":"http://mockito.org","size":49566,"stargazers_count":15310,"watchers_count":15310,"language":"Java","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":true,"has_pages":true,"has_discussions":true,"forks_count":2642,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":476,"license":{"key":"mit","name":"MIT License","spdx_id":"MIT","url":"https://api.github.com/licenses/mit","node_id":"MDc6TGljZW5zZTEz"},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["java","java-library","mock","mock-library","mocking","mocking-framework","mockito","mocks","test-automation","test-driven-development","testing","testing-tools"],"visibility":"public","forks":2642,"open_issues":476,"watchers":15310,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"pull_request":{"url":"https://api.github.com/repos/mockito/mockito/pulls/3173","html_url":"https://github.com/mockito/mockito/pull/3173","diff_url":"https://github.com/mockito/mockito/pull/3173.diff","patch_url":"https://github.com/mockito/mockito/pull/3173.patch","merged_at":"2023-11-28T06:57:26Z"},"body":"This fixes #3160. This is a bug where spied records end up having all their fields null. Here's a reproducer of the bug:\r\n\r\n```java\r\n@Test\r\nvoid myTest() {\r\n    spy(List.of(\"something\"));\r\n\r\n    record MyRecord(String name) {}\r\n    MyRecord spiedRecord = spy(new MyRecord(\"something\"));\r\n    assertEquals(\"something\", spiedRecord.name()); // fails because spiedRecord.name() is null\r\n}\r\n```\r\n\r\nThe issue only occurs when spying records if `AbstractCollection` (or one of its children) is also spied. This is why this reproducer passes if the first line is commented out.\r\n\r\nThe problem happens because all superclasses and interfaces of `java.util.ImmutableCollections.List12` (the implementation returned by `List.of()` are transformed by `ByteBuddyAgent` and `InlineDelegateByteBuddyMockMaker` (see `InlineBytecodeGenerator::triggerRetransformation`. However, one of the superclasses, `AbstractCollection`, happens to also be used by `MethodHandle`, and when it does, Mockito trips over itself and its fallback strategy also fails for records.\r\n\r\nIn other words, in the process of constructing a record for spying, `InstrumentationMemberAccessor::newInstance` calls `MethodHandle::invokeWithArguments`, which uses a collection. Since the `AbstractCollection` class was instrumented during the earlier spy creation, the construction is intercepted and calls `isMockConstruction` (in `InlineDelegateByteBuddyMockMaker`). Since the `mockitoConstruction` boolean is `true`, because there is indeed an ongoing mock construction, Mockito thinks that the current constructor `AbstractCollection()` is the correct constructor to implement, and `isMockConstruction` returns `true`. `onConstruction` then does one last check that the type of the constructor matches the object to spy, and when it doesn't, it throws an exception (`InlineDelegateByteBuddyMockMaker` line 287).\r\n\r\nMockito then considers that the spy creation has failed and falls back on creating a mock and then copying fields from the object to spy to the newly created mock (`MockUtil::createMock`). This strategy fails for records, because their fields cannot be set by `MethodHandles::unreflectSetter` (see the javadoc on the method), as opposed to classes, where even final fields can be set. This failure is then ignored, and fields are left uninitialized (see `LenientCopyTool::copyValues`). The interference betwen spies at the root of this issue also occurs for classes, but because the fallback can successfully copy the fields, the issue probably went unnoticed.\r\n\r\n**Testing**: I was unable to add a test for this, because the language level is set to 11, before records existed. All existing tests are still passing, though, and the reproducer above fails on the master branch but passes on mine.\r\n","reactions":{"url":"https://api.github.com/repos/mockito/mockito/issues/3173/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":1,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mockito/mockito/issues/3173/timeline","performed_via_github_app":null,"state_reason":null}},"event":"cross-referenced"},{"id":11077822260,"node_id":"REFE_lADOAF62v851Kk9MzwAAAAKUSic0","url":"https://api.github.com/repos/mockito/mockito/issues/events/11077822260","actor":{"login":"LeMikaelF","id":22927506,"node_id":"MDQ6VXNlcjIyOTI3NTA2","avatar_url":"https://avatars.githubusercontent.com/u/22927506?v=4","gravatar_id":"","url":"https://api.github.com/users/LeMikaelF","html_url":"https://github.com/LeMikaelF","followers_url":"https://api.github.com/users/LeMikaelF/followers","following_url":"https://api.github.com/users/LeMikaelF/following{/other_user}","gists_url":"https://api.github.com/users/LeMikaelF/gists{/gist_id}","starred_url":"https://api.github.com/users/LeMikaelF/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/LeMikaelF/subscriptions","organizations_url":"https://api.github.com/users/LeMikaelF/orgs","repos_url":"https://api.github.com/users/LeMikaelF/repos","events_url":"https://api.github.com/users/LeMikaelF/events{/privacy}","received_events_url":"https://api.github.com/users/LeMikaelF/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"bf63f4d72ea0bec79934a8bcbe11677430e82650","commit_url":"https://api.github.com/repos/LeMikaelF/mockito/commits/bf63f4d72ea0bec79934a8bcbe11677430e82650","created_at":"2023-11-28T01:46:48Z","performed_via_github_app":null},{"id":11079517132,"node_id":"CE_lADOAF62v851Kk9MzwAAAAKUZAPM","url":"https://api.github.com/repos/mockito/mockito/issues/events/11079517132","actor":{"login":"TimvdLippe","id":5948271,"node_id":"MDQ6VXNlcjU5NDgyNzE=","avatar_url":"https://avatars.githubusercontent.com/u/5948271?v=4","gravatar_id":"","url":"https://api.github.com/users/TimvdLippe","html_url":"https://github.com/TimvdLippe","followers_url":"https://api.github.com/users/TimvdLippe/followers","following_url":"https://api.github.com/users/TimvdLippe/following{/other_user}","gists_url":"https://api.github.com/users/TimvdLippe/gists{/gist_id}","starred_url":"https://api.github.com/users/TimvdLippe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TimvdLippe/subscriptions","organizations_url":"https://api.github.com/users/TimvdLippe/orgs","repos_url":"https://api.github.com/users/TimvdLippe/repos","events_url":"https://api.github.com/users/TimvdLippe/events{/privacy}","received_events_url":"https://api.github.com/users/TimvdLippe/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"closed","commit_id":null,"commit_url":null,"created_at":"2023-11-28T06:57:27Z","state_reason":null,"performed_via_github_app":null},{"id":11079517546,"node_id":"REFE_lADOAF62v851Kk9MzwAAAAKUZAVq","url":"https://api.github.com/repos/mockito/mockito/issues/events/11079517546","actor":{"login":"TimvdLippe","id":5948271,"node_id":"MDQ6VXNlcjU5NDgyNzE=","avatar_url":"https://avatars.githubusercontent.com/u/5948271?v=4","gravatar_id":"","url":"https://api.github.com/users/TimvdLippe","html_url":"https://github.com/TimvdLippe","followers_url":"https://api.github.com/users/TimvdLippe/followers","following_url":"https://api.github.com/users/TimvdLippe/following{/other_user}","gists_url":"https://api.github.com/users/TimvdLippe/gists{/gist_id}","starred_url":"https://api.github.com/users/TimvdLippe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TimvdLippe/subscriptions","organizations_url":"https://api.github.com/users/TimvdLippe/orgs","repos_url":"https://api.github.com/users/TimvdLippe/repos","events_url":"https://api.github.com/users/TimvdLippe/events{/privacy}","received_events_url":"https://api.github.com/users/TimvdLippe/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"b6554b29ed6c204a0dd4b8a670877fe0ba2e808b","commit_url":"https://api.github.com/repos/mockito/mockito/commits/b6554b29ed6c204a0dd4b8a670877fe0ba2e808b","created_at":"2023-11-28T06:57:31Z","performed_via_github_app":null}]