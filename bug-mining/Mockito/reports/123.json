{"url":"https://api.github.com/repos/mockito/mockito/issues/1117","repository_url":"https://api.github.com/repos/mockito/mockito","labels_url":"https://api.github.com/repos/mockito/mockito/issues/1117/labels{/name}","comments_url":"https://api.github.com/repos/mockito/mockito/issues/1117/comments","events_url":"https://api.github.com/repos/mockito/mockito/issues/1117/events","html_url":"https://github.com/mockito/mockito/issues/1117","id":234564613,"node_id":"MDU6SXNzdWUyMzQ1NjQ2MTM=","number":1117,"title":"Answer with delay in mock or spy to improve testing of asynchronous code","user":{"login":"myrle-krantz","id":16136960,"node_id":"MDQ6VXNlcjE2MTM2OTYw","avatar_url":"https://avatars.githubusercontent.com/u/16136960?v=4","gravatar_id":"","url":"https://api.github.com/users/myrle-krantz","html_url":"https://github.com/myrle-krantz","followers_url":"https://api.github.com/users/myrle-krantz/followers","following_url":"https://api.github.com/users/myrle-krantz/following{/other_user}","gists_url":"https://api.github.com/users/myrle-krantz/gists{/gist_id}","starred_url":"https://api.github.com/users/myrle-krantz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/myrle-krantz/subscriptions","organizations_url":"https://api.github.com/users/myrle-krantz/orgs","repos_url":"https://api.github.com/users/myrle-krantz/repos","events_url":"https://api.github.com/users/myrle-krantz/events{/privacy}","received_events_url":"https://api.github.com/users/myrle-krantz/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":140917181,"node_id":"MDU6TGFiZWwxNDA5MTcxODE=","url":"https://api.github.com/repos/mockito/mockito/labels/new%20feature","name":"new feature","color":"009800","default":false,"description":null},{"id":495288502,"node_id":"MDU6TGFiZWw0OTUyODg1MDI=","url":"https://api.github.com/repos/mockito/mockito/labels/noteworthy","name":"noteworthy","color":"5319e7","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2017-06-08T15:22:57Z","updated_at":"2017-08-15T06:58:47Z","closed_at":"2017-06-12T22:43:04Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I'm currently using Mockito for component testing of microservices.  All code should be run, up to the boundary at which another microservice is called.  In the component test, the mocks return very quickly, but obviously in integration testing, the real calls return much more slowly.  Some threading problems are revealed by the slow returns that would have been revealed in the component test if the returns could be forced to come back more slowly.  Since integration tests are *painfully* slow to start, this would save me, the developer, considerable time in debugging this kind of issue once I discover it in the integration tests.\r\n\r\nBecause it's so easy to write, I've already solved it with a class called AnswerWithDelay.  It takes another answer as a parameter, and inserts a little sleep before it returns.\r\n\r\nIf desired, I can turn this little helper into a PR for mockito. Or perhaps there's already something there that does this, that I've overlooked.\r\n\r\nBest Regards,\r\nMyrle\r\n\r\n```\r\n@RunWith(SpringRunner.class)\r\n@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.DEFINED_PORT,\r\n        classes = {AbstractRhythmTest.TestConfiguration.class},\r\n        properties = {\"rhythm.user=homer\", \"rhythm.beatCheckRate=500\"}\r\n)\r\npublic class AbstractRhythmTest {\r\n  //...\r\n  static class AnswerWithDelay<T> implements Answer<T> {\r\n    private final int sleepyTime;\r\n    private final Answer<T> answer;\r\n\r\n    AnswerWithDelay(final int sleepyTime, final Answer<T> answer) {\r\n      this.sleepyTime = sleepyTime;\r\n      this.answer = answer;\r\n    }\r\n\r\n    @Override\r\n    public T answer(final InvocationOnMock invocation) throws Throwable {\r\n      TimeUnit.MILLISECONDS.sleep(sleepyTime);\r\n      return answer.answer(invocation);\r\n    }\r\n  }\r\n\r\n  Beat createBeat(\r\n          final String applicationIdentifier,\r\n          final String beatIdentifier,\r\n          final int alignmentHour,\r\n          final LocalDateTime expectedBeatTimestamp) throws InterruptedException {\r\n    final String tenantIdentifier = tenantDataStoreContext.getTenantName();\r\n\r\n    final Beat beat = new Beat();\r\n    beat.setIdentifier(beatIdentifier);\r\n    beat.setAlignmentHour(alignmentHour);\r\n\r\n    Mockito.doAnswer(new AnswerWithDelay<>(2_000, new Returns(Optional.of(PermittableGroupIds.forApplication(applicationIdentifier))))).when(beatPublisherServiceSpy).requestPermissionForBeats(Matchers.eq(tenantIdentifier), Matchers.eq(applicationIdentifier));\r\n    Mockito.doAnswer(new AnswerWithDelay<>(2_000, new Returns(true))).when(beatPublisherServiceSpy).publishBeat(Matchers.eq(beatIdentifier), Matchers.eq(tenantIdentifier), Matchers.eq(applicationIdentifier),\r\n            AdditionalMatchers.or(Matchers.eq(expectedBeatTimestamp), Matchers.eq(getNextTimeStamp(expectedBeatTimestamp))));\r\n\r\n    this.testSubject.createBeat(applicationIdentifier, beat);\r\n\r\n    Assert.assertTrue(this.eventRecorder.wait(EventConstants.POST_BEAT, new BeatEvent(applicationIdentifier, beat.getIdentifier())));\r\n\r\n    Mockito.verify(beatPublisherServiceSpy, Mockito.timeout(2_500).times(1)).requestPermissionForBeats(tenantIdentifier, applicationIdentifier);\r\n\r\n    return beat;\r\n  }\r\n  //...\r\n}\r\n```","closed_by":{"login":"szpak","id":148013,"node_id":"MDQ6VXNlcjE0ODAxMw==","avatar_url":"https://avatars.githubusercontent.com/u/148013?v=4","gravatar_id":"","url":"https://api.github.com/users/szpak","html_url":"https://github.com/szpak","followers_url":"https://api.github.com/users/szpak/followers","following_url":"https://api.github.com/users/szpak/following{/other_user}","gists_url":"https://api.github.com/users/szpak/gists{/gist_id}","starred_url":"https://api.github.com/users/szpak/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szpak/subscriptions","organizations_url":"https://api.github.com/users/szpak/orgs","repos_url":"https://api.github.com/users/szpak/repos","events_url":"https://api.github.com/users/szpak/events{/privacy}","received_events_url":"https://api.github.com/users/szpak/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mockito/mockito/issues/1117/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mockito/mockito/issues/1117/timeline","performed_via_github_app":null,"state_reason":"completed"}