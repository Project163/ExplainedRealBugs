{"url":"https://api.github.com/repos/mockito/mockito/issues/2303","repository_url":"https://api.github.com/repos/mockito/mockito","labels_url":"https://api.github.com/repos/mockito/mockito/issues/2303/labels{/name}","comments_url":"https://api.github.com/repos/mockito/mockito/issues/2303/comments","events_url":"https://api.github.com/repos/mockito/mockito/issues/2303/events","html_url":"https://github.com/mockito/mockito/issues/2303","id":894567621,"node_id":"MDU6SXNzdWU4OTQ1Njc2MjE=","number":2303,"title":"\"The type is not public and its mock class is loaded by a different class loader\" with a context classloader that delegates","user":{"login":"charlesmunger","id":1119316,"node_id":"MDQ6VXNlcjExMTkzMTY=","avatar_url":"https://avatars.githubusercontent.com/u/1119316?v=4","gravatar_id":"","url":"https://api.github.com/users/charlesmunger","html_url":"https://github.com/charlesmunger","followers_url":"https://api.github.com/users/charlesmunger/followers","following_url":"https://api.github.com/users/charlesmunger/following{/other_user}","gists_url":"https://api.github.com/users/charlesmunger/gists{/gist_id}","starred_url":"https://api.github.com/users/charlesmunger/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/charlesmunger/subscriptions","organizations_url":"https://api.github.com/users/charlesmunger/orgs","repos_url":"https://api.github.com/users/charlesmunger/repos","events_url":"https://api.github.com/users/charlesmunger/events{/privacy}","received_events_url":"https://api.github.com/users/charlesmunger/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"raphw","id":4489328,"node_id":"MDQ6VXNlcjQ0ODkzMjg=","avatar_url":"https://avatars.githubusercontent.com/u/4489328?v=4","gravatar_id":"","url":"https://api.github.com/users/raphw","html_url":"https://github.com/raphw","followers_url":"https://api.github.com/users/raphw/followers","following_url":"https://api.github.com/users/raphw/following{/other_user}","gists_url":"https://api.github.com/users/raphw/gists{/gist_id}","starred_url":"https://api.github.com/users/raphw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/raphw/subscriptions","organizations_url":"https://api.github.com/users/raphw/orgs","repos_url":"https://api.github.com/users/raphw/repos","events_url":"https://api.github.com/users/raphw/events{/privacy}","received_events_url":"https://api.github.com/users/raphw/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"raphw","id":4489328,"node_id":"MDQ6VXNlcjQ0ODkzMjg=","avatar_url":"https://avatars.githubusercontent.com/u/4489328?v=4","gravatar_id":"","url":"https://api.github.com/users/raphw","html_url":"https://github.com/raphw","followers_url":"https://api.github.com/users/raphw/followers","following_url":"https://api.github.com/users/raphw/following{/other_user}","gists_url":"https://api.github.com/users/raphw/gists{/gist_id}","starred_url":"https://api.github.com/users/raphw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/raphw/subscriptions","organizations_url":"https://api.github.com/users/raphw/orgs","repos_url":"https://api.github.com/users/raphw/repos","events_url":"https://api.github.com/users/raphw/events{/privacy}","received_events_url":"https://api.github.com/users/raphw/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":8,"created_at":"2021-05-18T16:29:47Z","updated_at":"2021-05-27T21:35:24Z","closed_at":"2021-05-27T21:35:24Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Repro case:\r\n```java\r\npackage com.google.clm.mockitobug;\r\n\r\nimport static org.mockito.Mockito.mock;\r\n\r\nimport org.junit.Test;\r\nimport org.junit.runner.RunWith;\r\nimport org.junit.runners.JUnit4;\r\n\r\n/**\r\n * My goal is to create a context classloader that is identical in every way to the existing one,\r\n * except that it has a different object identity and possibly some extra fields. However, even a\r\n * basic classloader that always delegates causes problems for mockito.\r\n */\r\n@RunWith(JUnit4.class)\r\npublic final class ClassLoaderTest {\r\n\r\n  @Test\r\n  public void mockPackagePrivateInterface() {\r\n    ClassLoader old = Thread.currentThread().getContextClassLoader();\r\n    Thread.currentThread().setContextClassLoader(new ClassLoader(old) {});\r\n    // fails\r\n    Object unused = mock(PackagePrivate.class);\r\n  }\r\n\r\n  @Test\r\n  public void mockPublicInterface() {\r\n    ClassLoader old = Thread.currentThread().getContextClassLoader();\r\n    Thread.currentThread().setContextClassLoader(new ClassLoader(old) {});\r\n    // succeeds\r\n    Object unused = mock(Public.class);\r\n  }\r\n\r\n  interface PackagePrivate {}\r\n\r\n  public interface Public {}\r\n}\r\n```\r\nError:\r\n```\r\norg.mockito.exceptions.base.MockitoException: \r\nMockito cannot mock this class: interface com.google.clm.mockitobug.ClassLoaderTest$PackagePrivate.\r\n\r\nMockito can only mock non-private & non-final classes.\r\nIf you're not sure why you're getting this error, please report to the mailing list.\r\n\r\n\r\nJava               : 11\r\nJVM vendor name    : Google Inc.\r\nJVM vendor version : 11.0.10+9-google-release-371350251\r\nJVM name           : OpenJDK 64-Bit Server VM\r\nJVM version        : 11.0.10+9-google-release-371350251\r\nJVM info           : mixed mode, sharing\r\nOS name            : Linux\r\nOS version         : 4.15.0-smp-912.23.0.0\r\n\r\n\r\nUnderlying exception : org.mockito.exceptions.base.MockitoException: \r\nCannot create mock for interface com.google.clm.mockitobug.ClassLoaderTest$PackagePrivate\r\n\r\nThe type is not public and its mock class is loaded by a different class loader.\r\nThis can have multiple reasons:\r\n - You are mocking a class with additional interfaces of another class loader\r\n - Mockito is loaded by a different class loader than the mocked type (e.g. with OSGi)\r\n - The thread's context class loader is different than the mock's class loader\r\n\tat com.google.clm.mockitobug.ClassLoaderTest.mockPackagePrivateInterface(ClassLoaderTest.java:21)\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\r\n\tat java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n\tat java.base/java.lang.reflect.Method.invoke(Method.java:566)\r\n\tat org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:57)\r\n\tat org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)\r\n\tat org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:59)\r\n\tat org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)\r\n\tat org.junit.runners.BlockJUnit4ClassRunner$1.evaluate(BlockJUnit4ClassRunner.java:81)\r\n\tat org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:327)\r\n\tat org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:84)\r\n\tat org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:57)\r\n\tat org.junit.runners.ParentRunner$3.run(ParentRunner.java:292)\r\n\tat org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:73)\r\n\tat org.junit.runners.ParentRunner.runChildren(ParentRunner.java:290)\r\n\tat org.junit.runners.ParentRunner.access$000(ParentRunner.java:60)\r\n\tat org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:270)\r\n\tat org.junit.runners.ParentRunner.run(ParentRunner.java:370)\r\n\tat com.google.testing.junit.runner.internal.junit4.CancellableRequestFactory$CancellableRunner.run(CancellableRequestFactory.java:108)\r\n\tat org.junit.runner.JUnitCore.run(JUnitCore.java:137)\r\n\tat org.junit.runner.JUnitCore.run(JUnitCore.java:115)\r\n\tat com.google.testing.junit.runner.junit4.JUnit4Runner.run(JUnit4Runner.java:104)\r\n\tat com.google.testing.junit.runner.RunnerShell$2.run(RunnerShell.java:34)\r\n\tat com.google.testing.junit.runner.GoogleTestRunner.runTestsInSuite(GoogleTestRunner.java:200)\r\n\tat com.google.testing.junit.runner.GoogleTestRunner.runTestsInSuite(GoogleTestRunner.java:184)\r\n\tat com.google.testing.junit.runner.GoogleTestRunner.main(GoogleTestRunner.java:137)\r\nCaused by: org.mockito.exceptions.base.MockitoException: \r\nCannot create mock for interface com.google.clm.mockitobug.ClassLoaderTest$PackagePrivate\r\n\r\nThe type is not public and its mock class is loaded by a different class loader.\r\nThis can have multiple reasons:\r\n - You are mocking a class with additional interfaces of another class loader\r\n - Mockito is loaded by a different class loader than the mocked type (e.g. with OSGi)\r\n - The thread's context class loader is different than the mock's class loader\r\n\tat net.bytebuddy.TypeCache.findOrInsert(TypeCache.java:153)\r\n\tat net.bytebuddy.TypeCache$WithInlineExpunction.findOrInsert(TypeCache.java:366)\r\n\tat net.bytebuddy.TypeCache.findOrInsert(TypeCache.java:175)\r\n\tat net.bytebuddy.TypeCache$WithInlineExpunction.findOrInsert(TypeCache.java:377)\r\n\t... 27 more\r\n\r\n```\r\n\r\nIf mockito actually tried to use the classloader, I think it would work. Since we don't see an interesting exception deep in the stack, my guess is that mockito is doing some extra validation to avoid generating bytecode it thinks would fail.","closed_by":{"login":"TimvdLippe","id":5948271,"node_id":"MDQ6VXNlcjU5NDgyNzE=","avatar_url":"https://avatars.githubusercontent.com/u/5948271?v=4","gravatar_id":"","url":"https://api.github.com/users/TimvdLippe","html_url":"https://github.com/TimvdLippe","followers_url":"https://api.github.com/users/TimvdLippe/followers","following_url":"https://api.github.com/users/TimvdLippe/following{/other_user}","gists_url":"https://api.github.com/users/TimvdLippe/gists{/gist_id}","starred_url":"https://api.github.com/users/TimvdLippe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TimvdLippe/subscriptions","organizations_url":"https://api.github.com/users/TimvdLippe/orgs","repos_url":"https://api.github.com/users/TimvdLippe/repos","events_url":"https://api.github.com/users/TimvdLippe/events{/privacy}","received_events_url":"https://api.github.com/users/TimvdLippe/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mockito/mockito/issues/2303/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mockito/mockito/issues/2303/timeline","performed_via_github_app":null,"state_reason":"completed"}