{"url":"https://api.github.com/repos/mockito/mockito/issues/2933","repository_url":"https://api.github.com/repos/mockito/mockito","labels_url":"https://api.github.com/repos/mockito/mockito/issues/2933/labels{/name}","comments_url":"https://api.github.com/repos/mockito/mockito/issues/2933/comments","events_url":"https://api.github.com/repos/mockito/mockito/issues/2933/events","html_url":"https://github.com/mockito/mockito/issues/2933","id":1615302735,"node_id":"I_kwDOAF62v85gR5BP","number":2933,"title":"Execution with mockito-inline fails on platforms with EBCDIC as default encoding","user":{"login":"tobiasbaum","id":4025550,"node_id":"MDQ6VXNlcjQwMjU1NTA=","avatar_url":"https://avatars.githubusercontent.com/u/4025550?v=4","gravatar_id":"","url":"https://api.github.com/users/tobiasbaum","html_url":"https://github.com/tobiasbaum","followers_url":"https://api.github.com/users/tobiasbaum/followers","following_url":"https://api.github.com/users/tobiasbaum/following{/other_user}","gists_url":"https://api.github.com/users/tobiasbaum/gists{/gist_id}","starred_url":"https://api.github.com/users/tobiasbaum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tobiasbaum/subscriptions","organizations_url":"https://api.github.com/users/tobiasbaum/orgs","repos_url":"https://api.github.com/users/tobiasbaum/repos","events_url":"https://api.github.com/users/tobiasbaum/events{/privacy}","received_events_url":"https://api.github.com/users/tobiasbaum/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":532126464,"node_id":"MDU6TGFiZWw1MzIxMjY0NjQ=","url":"https://api.github.com/repos/mockito/mockito/labels/please%20contribute","name":"please contribute","color":"0e8a16","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2023-03-08T13:48:50Z","updated_at":"2023-03-09T16:53:35Z","closed_at":"2023-03-09T16:53:35Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"We recently switched from mockito-core to mockito-inline (specifically: org.mockito:mockito-inline:4.8.1). Since then, tests with mocks don't run on IBM z/OS (IBM JVM, Java 8) any more. Other platforms run fine. It seems like it has to do with the default encoding of the platform (Java property \"file.encoding\") being EBCDIC, which is not based on ASCII/UTF-8. Specifically, in the stacktrace below, the class name is \"_?[,_/,ÁÊÑ>%Ñ>Á\", which looks like an encoding issue.\r\n\r\nAfter briefly skimming the Mockito source code, I think part of the problem is in org.mockito.internal.configuration.plugins.PluginFileReader, which uses IOUtil.readLines to convert a byte stream to strings. IOUtil.readLines then uses the default constructor of InputStreamReader, which uses the platform's default encoding. If the stream is by convention always in, e.g., UTF-8, the encoding should be specified explicitly. See https://spotbugs.readthedocs.io/en/stable/bugDescriptions.html#dm-reliance-on-default-encoding-dm-default-encoding for more background information on this type of issue.\r\n\r\nI can probably try some fixing myself, but wanted to post an issue first to give a chance for discussions.\r\n\r\nHere's a stack trace:\r\n`\r\njava.lang.IllegalStateException: Could not initialize plugin: interface org.mockito.plugins.MockMaker (alternate: null)\r\n    at org.mockito.internal.configuration.plugins.PluginLoader$1.invoke(PluginLoader.java:84)\r\n    at com.sun.proxy.$Proxy34.getHandler(Unknown Source)\r\n    at org.mockito.internal.util.MockUtil.getMockHandlerOrNull(MockUtil.java:158)\r\n    at org.mockito.internal.util.MockUtil.isMock(MockUtil.java:147)\r\n    at org.mockito.internal.configuration.injection.scanner.MockScanner.isMockOrSpy(MockScanner.java:83)\r\n    at org.mockito.internal.configuration.injection.scanner.MockScanner.preparedMock(MockScanner.java:71)\r\n    at org.mockito.internal.configuration.injection.scanner.MockScanner.scan(MockScanner.java:59)\r\n    at org.mockito.internal.configuration.injection.scanner.MockScanner.addPreparedMocks(MockScanner.java:45)\r\n    at org.mockito.internal.configuration.InjectingAnnotationEngine.injectCloseableMocks(InjectingAnnotationEngine.java:112)\r\n    at org.mockito.internal.configuration.InjectingAnnotationEngine.processInjectMocks(InjectingAnnotationEngine.java:61)\r\n    at org.mockito.internal.configuration.InjectingAnnotationEngine.process(InjectingAnnotationEngine.java:48)\r\n    at org.mockito.MockitoAnnotations.openMocks(MockitoAnnotations.java:81)\r\n    at org.mockito.internal.framework.DefaultMockitoSession.<init>(DefaultMockitoSession.java:43)\r\n    at org.mockito.internal.session.DefaultMockitoSessionBuilder.startMocking(DefaultMockitoSessionBuilder.java:83)\r\n    at de.set.posy.workplace.plugins.poolOperator.gwt.server.poolContent.PoolContentTableServiceImplTest.setUp(PoolContentTableServiceImplTest.java:39)\r\n    at de.setsoftware.junit.SETTestcaseRunner$SetUpTearDownRule$1.invokeIfPresent(SETTestcaseRunner.java:155)\r\n    at de.setsoftware.junit.SETTestcaseRunner$SetUpTearDownRule$1.evaluate(SETTestcaseRunner.java:144)\r\n    at de.setsoftware.junit.SETTestcaseRunner.runChild(SETTestcaseRunner.java:58)\r\n    at de.setsoftware.junit.SETTestcaseRunner.runChild(SETTestcaseRunner.java:24)\r\n    at de.setsoftware.junit.SETSuiteRunner.run(SETSuiteRunner.java:193)\r\n    at de.setsoftware.UnitTestRunner.main(UnitTestRunner.java:127)\r\nCaused by: java.lang.IllegalStateException: Failed to load interface org.mockito.plugins.MockMaker implementation declared in java.lang.ClassLoader$CompoundEnumeration@c88de7f9\r\n    at org.mockito.internal.configuration.plugins.PluginInitializer.loadImpl(PluginInitializer.java:56)\r\n    at org.mockito.internal.configuration.plugins.PluginLoader.loadPlugin(PluginLoader.java:65)\r\n    at org.mockito.internal.configuration.plugins.PluginLoader.loadPlugin(PluginLoader.java:50)\r\n    at org.mockito.internal.configuration.plugins.PluginRegistry.<init>(PluginRegistry.java:27)\r\n    at org.mockito.internal.configuration.plugins.Plugins.<clinit>(Plugins.java:22)\r\n    at org.mockito.internal.MockitoCore.<clinit>(MockitoCore.java:73)\r\n    at org.mockito.Mockito.<clinit>(Mockito.java:1647)\r\n    at de.set.posy.workplace.plugins.poolOperator.gwt.server.poolContent.PoolContentTableServiceImplTest.setUp(PoolContentTableServiceImplTest.java:36)\r\nCaused by: java.lang.ClassNotFoundException: _?[,_/,ÁÊÑ>%Ñ>Á\r\n    at java.net.URLClassLoader.findClass(URLClassLoader.java:610)\r\n    at java.lang.ClassLoader.loadClassHelper(ClassLoader.java:945)\r\n    at java.lang.ClassLoader.loadClass(ClassLoader.java:890)\r\n    at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:349)\r\n    at java.lang.ClassLoader.loadClass(ClassLoader.java:873)\r\n    at org.mockito.internal.configuration.plugins.PluginInitializer.loadImpl(PluginInitializer.java:50)\r\n`\r\n\r\ncheck that\r\n\r\n - [x] The mockito message in the stacktrace have useful information, but it didn't help\r\n - [x] The problematic code (if that's possible) is copied here; N/A, problem is largely independent of the tested code\r\n - [x] Provide versions (mockito / jdk / os / any other relevant information)\r\n - [x] Provide a [Short, Self Contained, Correct (Compilable), Example](http://sscce.org) of the issue: N/A, is likely a platform issue independent of the code. I hope my description above helps anyway. And as soon as I'll have a running version, I can do testing on z/OS.\r\n - [x] Read the [contributing guide](https://github.com/mockito/mockito/blob/main/.github/CONTRIBUTING.md)\r\n\r\n\r\n","closed_by":{"login":"TimvdLippe","id":5948271,"node_id":"MDQ6VXNlcjU5NDgyNzE=","avatar_url":"https://avatars.githubusercontent.com/u/5948271?v=4","gravatar_id":"","url":"https://api.github.com/users/TimvdLippe","html_url":"https://github.com/TimvdLippe","followers_url":"https://api.github.com/users/TimvdLippe/followers","following_url":"https://api.github.com/users/TimvdLippe/following{/other_user}","gists_url":"https://api.github.com/users/TimvdLippe/gists{/gist_id}","starred_url":"https://api.github.com/users/TimvdLippe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TimvdLippe/subscriptions","organizations_url":"https://api.github.com/users/TimvdLippe/orgs","repos_url":"https://api.github.com/users/TimvdLippe/repos","events_url":"https://api.github.com/users/TimvdLippe/events{/privacy}","received_events_url":"https://api.github.com/users/TimvdLippe/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mockito/mockito/issues/2933/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mockito/mockito/issues/2933/timeline","performed_via_github_app":null,"state_reason":"completed"}