{"url":"https://api.github.com/repos/mockito/mockito/issues/3469","repository_url":"https://api.github.com/repos/mockito/mockito","labels_url":"https://api.github.com/repos/mockito/mockito/issues/3469/labels{/name}","comments_url":"https://api.github.com/repos/mockito/mockito/issues/3469/comments","events_url":"https://api.github.com/repos/mockito/mockito/issues/3469/events","html_url":"https://github.com/mockito/mockito/issues/3469","id":2587513382,"node_id":"I_kwDOAF62v86aOlIm","number":3469,"title":"Disabled Mock Triggers NPE when Checking isMock","user":{"login":"Kramermp","id":17225512,"node_id":"MDQ6VXNlcjE3MjI1NTEy","avatar_url":"https://avatars.githubusercontent.com/u/17225512?v=4","gravatar_id":"","url":"https://api.github.com/users/Kramermp","html_url":"https://github.com/Kramermp","followers_url":"https://api.github.com/users/Kramermp/followers","following_url":"https://api.github.com/users/Kramermp/following{/other_user}","gists_url":"https://api.github.com/users/Kramermp/gists{/gist_id}","starred_url":"https://api.github.com/users/Kramermp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Kramermp/subscriptions","organizations_url":"https://api.github.com/users/Kramermp/orgs","repos_url":"https://api.github.com/users/Kramermp/repos","events_url":"https://api.github.com/users/Kramermp/events{/privacy}","received_events_url":"https://api.github.com/users/Kramermp/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2024-10-15T03:16:44Z","updated_at":"2024-10-19T11:50:51Z","closed_at":"2024-10-19T11:50:50Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"check that\r\n - [X] The mockito message in the stacktrace have useful information, but it didn't help\r\n - [X] The problematic code (if that's possible) is copied here;\r\n       Note that some configuration are impossible to mock via Mockito\r\n - [X] Provide versions (mockito / jdk / os / any other relevant information)\r\n - [X] Provide a [Short, Self Contained, Correct (Compilable), Example](http://sscce.org) of the issue\r\n       (same as any question on stackoverflow.com)\r\n - [X] Read the [contributing guide](https://github.com/mockito/mockito/blob/main/.github/CONTRIBUTING.md)\r\n\r\nThere is the ability to trigger a NullPointerException by calling `isMock` on a disabled mock. This behavior should probably be changed to either return true, because a DisabledMock is still a mock or `isMock` should throw a `DisabledMockException` because you are interacting with a disabledMock.\r\n \r\nProblematic Code is: `DisabledMockHandler#getMockSettings` returning `null` here breaks the logic for determining if an object a mock.\r\n```\r\n@Override\r\n    public MockCreationSettings getMockSettings() {\r\n        return null;\r\n    }\r\n```\r\nNPE Source is in the following loop of `MockUtil#getMockHandlerOrNull`. \r\n```\r\nfor (MockMaker mockMaker : mockMakers.values()) {\r\n            MockHandler<?> handler = mockMaker.getHandler(mock);\r\n            if (handler != null) {\r\n                assert getMockMaker(handler.getMockSettings().getMockMaker()) == mockMaker;\r\n                return handler;\r\n            }\r\n        }\r\n```\r\n\r\nStack Trace Snippet:\r\n```\r\njava.lang.NullPointerException: Cannot invoke \"org.mockito.mock.MockCreationSettings.getMockMaker()\" because the return value of \"org.mockito.invocation.MockHandler.getMockSettings()\" is null\r\n\tat org.mockito.internal.util.MockUtil.getMockHandlerOrNull(MockUtil.java:160)\r\n\tat org.mockito.internal.util.MockUtil.isMock(MockUtil.java:147)\r\n\tat org.mockito.internal.util.DefaultMockingDetails.isMock(DefaultMockingDetails.java:32)\r\n\tat org.mockito.internal.framework.DefaultMockitoFrameworkTest.behavior_after_clear_inline_mocks_is_mock(DefaultMockitoFrameworkTest.java:226)\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)\r\n\tat java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n\tat java.base/java.lang.reflect.Method.invoke(Method.java:569)\r\n```\r\n\r\n\r\nThe following unit test reproduces the issue. This unit test can be added to `DefaultMockitoFrameworkTest` and will fail for an NPE. This test should probably be modeled to either trigger a `DisabledMockException` or `return true` because a DisabledMock is still a mock.\r\n```\r\n\r\n    @Test\r\n    public void behavior_after_clear_inline_mocks_is_mock() {\r\n        // clearing mocks only works with inline mocking\r\n        assumeTrue(Plugins.getMockMaker() instanceof InlineMockMaker);\r\n        PersonWithName obj = mock(PersonWithName.class);\r\n        when(obj.getMyName()).thenReturn(\"Bob\");\r\n        assertEquals(\"Bob\", obj.getMyName());\r\n        assertTrue(mockingDetails(obj).isMock());\r\n        framework.clearInlineMocks();\r\n\r\n        try {\r\n            mockingDetails(obj).isMock();\r\n        } catch (DisabledMockException e) {\r\n            return;\r\n        }\r\n        Assert.fail(\"Should have thrown DisabledMockException\");\r\n    }\r\n ```\r\n","closed_by":{"login":"TimvdLippe","id":5948271,"node_id":"MDQ6VXNlcjU5NDgyNzE=","avatar_url":"https://avatars.githubusercontent.com/u/5948271?v=4","gravatar_id":"","url":"https://api.github.com/users/TimvdLippe","html_url":"https://github.com/TimvdLippe","followers_url":"https://api.github.com/users/TimvdLippe/followers","following_url":"https://api.github.com/users/TimvdLippe/following{/other_user}","gists_url":"https://api.github.com/users/TimvdLippe/gists{/gist_id}","starred_url":"https://api.github.com/users/TimvdLippe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TimvdLippe/subscriptions","organizations_url":"https://api.github.com/users/TimvdLippe/orgs","repos_url":"https://api.github.com/users/TimvdLippe/repos","events_url":"https://api.github.com/users/TimvdLippe/events{/privacy}","received_events_url":"https://api.github.com/users/TimvdLippe/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mockito/mockito/issues/3469/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mockito/mockito/issues/3469/timeline","performed_via_github_app":null,"state_reason":"completed"}