{"url":"https://api.github.com/repos/mockito/mockito/issues/357","repository_url":"https://api.github.com/repos/mockito/mockito","labels_url":"https://api.github.com/repos/mockito/mockito/issues/357/labels{/name}","comments_url":"https://api.github.com/repos/mockito/mockito/issues/357/comments","events_url":"https://api.github.com/repos/mockito/mockito/issues/357/events","html_url":"https://github.com/mockito/mockito/issues/357","id":134054873,"node_id":"MDU6SXNzdWUxMzQwNTQ4NzM=","number":357,"title":"ClassCastExceptions with JDK9 javac","user":{"login":"cushon","id":478458,"node_id":"MDQ6VXNlcjQ3ODQ1OA==","avatar_url":"https://avatars.githubusercontent.com/u/478458?v=4","gravatar_id":"","url":"https://api.github.com/users/cushon","html_url":"https://github.com/cushon","followers_url":"https://api.github.com/users/cushon/followers","following_url":"https://api.github.com/users/cushon/following{/other_user}","gists_url":"https://api.github.com/users/cushon/gists{/gist_id}","starred_url":"https://api.github.com/users/cushon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cushon/subscriptions","organizations_url":"https://api.github.com/users/cushon/orgs","repos_url":"https://api.github.com/users/cushon/repos","events_url":"https://api.github.com/users/cushon/events{/privacy}","received_events_url":"https://api.github.com/users/cushon/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":338749221,"node_id":"MDU6TGFiZWwzMzg3NDkyMjE=","url":"https://api.github.com/repos/mockito/mockito/labels/java-9","name":"java-9","color":"996334","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"TimvdLippe","id":5948271,"node_id":"MDQ6VXNlcjU5NDgyNzE=","avatar_url":"https://avatars.githubusercontent.com/u/5948271?v=4","gravatar_id":"","url":"https://api.github.com/users/TimvdLippe","html_url":"https://github.com/TimvdLippe","followers_url":"https://api.github.com/users/TimvdLippe/followers","following_url":"https://api.github.com/users/TimvdLippe/following{/other_user}","gists_url":"https://api.github.com/users/TimvdLippe/gists{/gist_id}","starred_url":"https://api.github.com/users/TimvdLippe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TimvdLippe/subscriptions","organizations_url":"https://api.github.com/users/TimvdLippe/orgs","repos_url":"https://api.github.com/users/TimvdLippe/repos","events_url":"https://api.github.com/users/TimvdLippe/events{/privacy}","received_events_url":"https://api.github.com/users/TimvdLippe/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"TimvdLippe","id":5948271,"node_id":"MDQ6VXNlcjU5NDgyNzE=","avatar_url":"https://avatars.githubusercontent.com/u/5948271?v=4","gravatar_id":"","url":"https://api.github.com/users/TimvdLippe","html_url":"https://github.com/TimvdLippe","followers_url":"https://api.github.com/users/TimvdLippe/followers","following_url":"https://api.github.com/users/TimvdLippe/following{/other_user}","gists_url":"https://api.github.com/users/TimvdLippe/gists{/gist_id}","starred_url":"https://api.github.com/users/TimvdLippe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TimvdLippe/subscriptions","organizations_url":"https://api.github.com/users/TimvdLippe/orgs","repos_url":"https://api.github.com/users/TimvdLippe/repos","events_url":"https://api.github.com/users/TimvdLippe/events{/privacy}","received_events_url":"https://api.github.com/users/TimvdLippe/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":23,"created_at":"2016-02-16T18:10:54Z","updated_at":"2019-02-12T13:14:02Z","closed_at":"2019-02-12T13:14:02Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"JDK 9 fixes a javac bug ([JDK-8058199](https://bugs.openjdk.java.net/browse/JDK-8058199)) that was causing checkcast intructions to be skipped. Previously javac used the parameter types of a method symbol's erased type as targets when translating the arguments. In JDK 9, javac has been fixed to use the inferred types as targets. The fix causes additional checkcasts to be generated if the inferred types do not have the same erasure.\n\nThe fix breaks Mockito answer strategies that pick types based on the erased method signature's return type, and causes tests to fail with ClassCastExceptions when compiled with the JDK 9 javac.\n\n---\n\nExample 1\n\n``` java\nclass Super<T> {\n  T g() {\n    return null;\n  }\n}\n\nclass Sub extends Super<Boolean> {}\n```\n\n``` java\n@Mock Sub s;\nwhen(s.g()).thenReturn(false);\n```\n\ncompiled with javac 8\n\n```\nINVOKEVIRTUAL Sub.g ()Ljava/lang/Object;\nINVOKESTATIC org/mockito/Mockito.when (Ljava/lang/Object;)Lorg/mockito/stubbing/OngoingStubbing;\n```\n\ncompiled with javac 9\n\n```\nINVOKEVIRTUAL Sub.g ()Ljava/lang/Object;\nCHECKCAST java/lang/Boolean\nINVOKESTATIC org/mockito/Mockito.when (Ljava/lang/Object;)Lorg/mockito/stubbing/OngoingStubbing;\n```\n\nThe erased return type of `Super.g` is `Object`, but the expected return type of `Sub.g` is `Boolean`. If the answer strategy returns `Object` the checkcast fails.\n\n---\n\nExample 2\n\n``` java\nclass Foo {\n  <T> T getFirst(Iterable<T> xs) { return xs.iterator().next(); }\n}\n```\n\n``` java\n@Mock Foo f;\nIterable<Boolean> it = Arrays.asList(false);\nwhen(f.getFirst(it)).thenReturn(false)\n```\n\ncompiled with javac 8\n\n```\nINVOKEVIRTUAL Foo.getFirst (Ljava/lang/Iterable;)Ljava/lang/Object;\nINVOKESTATIC org/mockito/Mockito.when (Ljava/lang/Object;)Lorg/mockito/stubbing/OngoingStubbing;\n```\n\ncompiled with javac 9\n\n```\nINVOKEVIRTUAL Foo.getFirst (Ljava/lang/Iterable;)Ljava/lang/Object;\nCHECKCAST java/lang/Boolean\nINVOKESTATIC org/mockito/Mockito.when (Ljava/lang/Object;)Lorg/mockito/stubbing/OngoingStubbing;\n```\n\nThe erased return type of `Foo.getFirst` is `Object`, but the inferred return type of `getFirst(Iterable<Boolean>)` is `Boolean`. If the answer strategy returns `Object` the checkcast fails.\n\n---\n\nThe first example could be fixed by using [`GenericMetadataSupport`](https://github.com/mockito/mockito/blob/9b838461abf93670d123109f7e3d8871f182767a/src/main/java/org/mockito/internal/util/reflection/GenericMetadataSupport.java) in all of the answer implementations instead of `invocation.getMethod().getReturnType()`.\n\nIt gets more difficult if the mock's type is an instantiation of a generic type (e.g. `@Mock Foo<Bar> x;`), since the field's type arguments get dropped. I think fixing that would require adding support for mocking types, not just classes.\n\nFor the second example, returning the right answer requires considering the generic signature of the invoked method, and performing type inference using the argument types. Unfortunately the runtime type of the argument is going to be a raw `Iterable` and the inference depends on knowing it's `Iterable<Boolean>`, so I'm not sure what to do there.\n","closed_by":{"login":"TimvdLippe","id":5948271,"node_id":"MDQ6VXNlcjU5NDgyNzE=","avatar_url":"https://avatars.githubusercontent.com/u/5948271?v=4","gravatar_id":"","url":"https://api.github.com/users/TimvdLippe","html_url":"https://github.com/TimvdLippe","followers_url":"https://api.github.com/users/TimvdLippe/followers","following_url":"https://api.github.com/users/TimvdLippe/following{/other_user}","gists_url":"https://api.github.com/users/TimvdLippe/gists{/gist_id}","starred_url":"https://api.github.com/users/TimvdLippe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TimvdLippe/subscriptions","organizations_url":"https://api.github.com/users/TimvdLippe/orgs","repos_url":"https://api.github.com/users/TimvdLippe/repos","events_url":"https://api.github.com/users/TimvdLippe/events{/privacy}","received_events_url":"https://api.github.com/users/TimvdLippe/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mockito/mockito/issues/357/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mockito/mockito/issues/357/timeline","performed_via_github_app":null,"state_reason":"completed"}