{"url":"https://api.github.com/repos/rollup/rollup/issues/3662","repository_url":"https://api.github.com/repos/rollup/rollup","labels_url":"https://api.github.com/repos/rollup/rollup/issues/3662/labels{/name}","comments_url":"https://api.github.com/repos/rollup/rollup/issues/3662/comments","events_url":"https://api.github.com/repos/rollup/rollup/issues/3662/events","html_url":"https://github.com/rollup/rollup/issues/3662","id":651631904,"node_id":"MDU6SXNzdWU2NTE2MzE5MDQ=","number":3662,"title":"[Mac OS] \"Error: EMFILE: too many open files\" for large projects","user":{"login":"wessberg","id":20454213,"node_id":"MDQ6VXNlcjIwNDU0MjEz","avatar_url":"https://avatars.githubusercontent.com/u/20454213?v=4","gravatar_id":"","url":"https://api.github.com/users/wessberg","html_url":"https://github.com/wessberg","followers_url":"https://api.github.com/users/wessberg/followers","following_url":"https://api.github.com/users/wessberg/following{/other_user}","gists_url":"https://api.github.com/users/wessberg/gists{/gist_id}","starred_url":"https://api.github.com/users/wessberg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wessberg/subscriptions","organizations_url":"https://api.github.com/users/wessberg/orgs","repos_url":"https://api.github.com/users/wessberg/repos","events_url":"https://api.github.com/users/wessberg/events{/privacy}","received_events_url":"https://api.github.com/users/wessberg/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2020-07-06T15:32:27Z","updated_at":"2020-07-10T19:57:52Z","closed_at":"2020-07-10T19:57:52Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"<!--\r\n  âš¡ï¸ katchow! We ðŸ’› issues.\r\n\r\n  Please - do not - remove this template.\r\n  Please - do not - skip or remove parts of this template.\r\n  Or your issue may be closed.\r\n\r\n  ðŸ‘‰ðŸ½ Need help or tech support? Please don't open an issue!\r\n  Head to https://gitter.im/rollup/rollup or https://stackoverflow.com/questions/tagged/rollupjs\r\n  \r\n  ðŸ‘‰ðŸ½ Is this issue related to an official plugin? Please do not open an issue here, go to the plugins repository instead: https://github.com/rollup/plugins/issues\r\n\r\n  â¤ï¸ Rollup? Please consider supporting our collective:\r\n  ðŸ‘‰ https://opencollective.com/rollup/donate\r\n-->\r\n\r\n- Rollup Version: 2.19.0\r\n- Operating System (or Browser): Mac OS 10.15.5\r\n- Node Version (if applicable): 14.4.0\r\n\r\n<!--\r\n  Issues without minimal reproductions will be closed! Please provide a link to one by:\r\n  1. Using the REPL at https://rollupjs.org/repl/, or\r\n  2. Using the REPL.it reproduction template at https://repl.it/@rollup/rollup-repro\r\n     (allows full use of all rollup options and plugins), or\r\n  3. Provide a minimal repository link (Read https://git.io/fNzHA for instructions).\r\n     These may take more time to triage than the other options.\r\n     \r\n  For some bugs it this may seem like overkill but believe us, very often what seems like a\r\n  \"clear issue\" is actually specific to some details of your setup. Having a runnable\r\n  reproduction not only \"proves\" your bug to us but also allows us to spend all our effort\r\n  fixing the bug instead of struggling to understand your issue.\r\n-->\r\n\r\nHey there. My team is relying heavily on Rollup as the foundation of our build pipeline for a very large codebase with a very large amount of dependencies. We usually end up with around ~400 chunks for our primary web application.\r\n\r\nRecently we migrated from Rollup 1.32.1 to 2.19.0 and since then we constantly run into `EMFILE: too many open files` errors on Mac OS when we run Rollup in watch mode during the second or third rebuild after changing one or more files.\r\n\r\nI would hope that I could provide more details than this, but I'm not sure if there have been significant changes to the watch pipeline with Chokidar, but it would seem that a lot more files is attempted to be opened/read from simultaneously now, at least in this particular codebase.\r\n\r\n### Expected Behavior\r\n\r\nIdeally, watch mode should continue working, even for projects with thousands of open files. Using something like [`graceful-fs`](https://github.com/isaacs/node-graceful-fs) as a drop-in replacement for `fs` could fix this issue since it, according to the README, _\"queues up `open` and `readdir` calls, and retries them once something closes if there is an EMFILE error from too many file descriptors.\"_.\r\n\r\n\r\n### Actual Behavior\r\n\r\nWatch-builds fail on Mac OS with an `Error: EMFILE: too many open files` error after one or few rebuilds in projects with a very large amount of watched files. In this particular codebase, this only became a problem after migrating to Rollup 2.19.0 from 1.32.1.\r\n\r\n\r\n<!--\r\n  Most issues can be expressed or demonstrated through the REPL or a repository.\r\n  However, the situation may arise where some small code snippets also need to\r\n  be provided. In that situation, please add your code below using\r\n  Fenced Code Blocks (https://help.github.com/articles/creating-and-highlighting-code-blocks/)\r\n-->\r\n\r\n\r\n","closed_by":{"login":"lukastaegert","id":12949268,"node_id":"MDQ6VXNlcjEyOTQ5MjY4","avatar_url":"https://avatars.githubusercontent.com/u/12949268?v=4","gravatar_id":"","url":"https://api.github.com/users/lukastaegert","html_url":"https://github.com/lukastaegert","followers_url":"https://api.github.com/users/lukastaegert/followers","following_url":"https://api.github.com/users/lukastaegert/following{/other_user}","gists_url":"https://api.github.com/users/lukastaegert/gists{/gist_id}","starred_url":"https://api.github.com/users/lukastaegert/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lukastaegert/subscriptions","organizations_url":"https://api.github.com/users/lukastaegert/orgs","repos_url":"https://api.github.com/users/lukastaegert/repos","events_url":"https://api.github.com/users/lukastaegert/events{/privacy}","received_events_url":"https://api.github.com/users/lukastaegert/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rollup/rollup/issues/3662/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rollup/rollup/issues/3662/timeline","performed_via_github_app":null,"state_reason":"completed"}