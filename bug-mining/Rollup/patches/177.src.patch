diff --git a/src/ast/nodes/BinaryExpression.ts b/src/ast/nodes/BinaryExpression.ts
index 5fd97123e..c89297216 100644
--- a/src/ast/nodes/BinaryExpression.ts
+++ b/src/ast/nodes/BinaryExpression.ts
@@ -13,6 +13,7 @@ import {
 	UNKNOWN_PATH
 } from '../utils/PathTracker';
 import { getRenderedLiteralValue } from '../utils/renderLiteralValue';
+import ExternalVariable from '../variables/ExternalVariable';
 import NamespaceVariable from '../variables/NamespaceVariable';
 import ExpressionStatement from './ExpressionStatement';
 import type { LiteralValue } from './Literal';
@@ -106,7 +107,9 @@ export default class BinaryExpression extends NodeBase implements DeoptimizableE
 
 		// Optimize `'export' in namespace`
 		if (this.operator === 'in' && this.right.variable instanceof NamespaceVariable) {
-			return this.right.variable.context.traceExport(String(leftValue))[0] != null;
+			const [variable] = this.right.variable.context.traceExport(String(leftValue));
+			if (variable instanceof ExternalVariable) return UnknownValue;
+			return !!variable;
 		}
 
 		const rightValue = this.right.getLiteralValueAtPath(EMPTY_PATH, recursionTracker, origin);
@@ -120,7 +123,9 @@ export default class BinaryExpression extends NodeBase implements DeoptimizableE
 
 	getRenderedLiteralValue() {
 		// Only optimize `'export' in ns`
-		if (this.operator !== 'in' || !this.right.variable?.isNamespace) return UnknownValue;
+		if (this.operator !== 'in' || !(this.right.variable instanceof NamespaceVariable)) {
+			return UnknownValue;
+		}
 
 		if (this.renderedLiteralValue !== UNASSIGNED) return this.renderedLiteralValue;
 		return (this.renderedLiteralValue = getRenderedLiteralValue(
@@ -147,11 +152,12 @@ export default class BinaryExpression extends NodeBase implements DeoptimizableE
 	include(
 		context: InclusionContext,
 		includeChildrenRecursively: IncludeChildren,
-		_options?: InclusionOptions
+		options?: InclusionOptions
 	) {
-		this.included = true;
+		if (!this.included) this.includeNode(context);
 		if (typeof this.getRenderedLiteralValue() === 'symbol') {
-			super.include(context, includeChildrenRecursively, _options);
+			this.left.include(context, includeChildrenRecursively, options);
+			this.right.include(context, includeChildrenRecursively, options);
 		}
 	}
 
diff --git a/test/form/samples/external-namespace-optimzation-in-operator/_config.js b/test/form/samples/external-namespace-optimzation-in-operator/_config.js
index 27cac503e..e8b8e8d6a 100644
--- a/test/form/samples/external-namespace-optimzation-in-operator/_config.js
+++ b/test/form/samples/external-namespace-optimzation-in-operator/_config.js
@@ -1,6 +1,6 @@
 module.exports = {
 	description: 'disables optimization for external namespace when using the in operator',
 	options: {
-		external: ['node:crypto']
+		external: ['node:crypto', './ext.js']
 	}
 };
diff --git a/test/form/samples/external-namespace-optimzation-in-operator/_expected.js b/test/form/samples/external-namespace-optimzation-in-operator/_expected.js
index f0e7e0746..c4aee3950 100644
--- a/test/form/samples/external-namespace-optimzation-in-operator/_expected.js
+++ b/test/form/samples/external-namespace-optimzation-in-operator/_expected.js
@@ -1,5 +1,27 @@
 import * as nc from 'node:crypto';
+import * as ext from './ext.js';
+
+function _mergeNamespaces(n, m) {
+	m.forEach(function (e) {
+		e && typeof e !== 'string' && !Array.isArray(e) && Object.keys(e).forEach(function (k) {
+			if (k !== 'default' && !(k in n)) {
+				var d = Object.getOwnPropertyDescriptor(e, k);
+				Object.defineProperty(n, k, d.get ? d : {
+					enumerable: true,
+					get: function () { return e[k]; }
+				});
+			}
+		});
+	});
+	return Object.freeze(n);
+}
+
+var pt = /*#__PURE__*/_mergeNamespaces({
+	__proto__: null
+}, [ext]);
 
 const crypto = 'webcrypto' in nc;
+const direct = 'whatever' in ext;
+const indirect = 'whatever' in pt;
 
-export { crypto };
+export { crypto, direct, indirect };
diff --git a/test/form/samples/external-namespace-optimzation-in-operator/ext.js b/test/form/samples/external-namespace-optimzation-in-operator/ext.js
new file mode 100644
index 000000000..79716867d
--- /dev/null
+++ b/test/form/samples/external-namespace-optimzation-in-operator/ext.js
@@ -0,0 +1 @@
+export const whatever = 1
diff --git a/test/form/samples/external-namespace-optimzation-in-operator/main.js b/test/form/samples/external-namespace-optimzation-in-operator/main.js
index ff9e8ae49..02fd0a0de 100644
--- a/test/form/samples/external-namespace-optimzation-in-operator/main.js
+++ b/test/form/samples/external-namespace-optimzation-in-operator/main.js
@@ -1,2 +1,7 @@
 import * as nc from 'node:crypto';
+import * as ext from './ext.js';
+import * as pt from './passthrough.js';
+
 export const crypto = 'webcrypto' in nc;
+export const direct = 'whatever' in ext;
+export const indirect = 'whatever' in pt;
diff --git a/test/form/samples/external-namespace-optimzation-in-operator/passthrough.js b/test/form/samples/external-namespace-optimzation-in-operator/passthrough.js
new file mode 100644
index 000000000..8ea6df228
--- /dev/null
+++ b/test/form/samples/external-namespace-optimzation-in-operator/passthrough.js
@@ -0,0 +1 @@
+export * from './ext.js'
diff --git a/test/form/samples/namespace-optimization-in-operator/_expected.js b/test/form/samples/namespace-optimization-in-operator/_expected.js
index 2f585faf5..2259bb79a 100644
--- a/test/form/samples/namespace-optimization-in-operator/_expected.js
+++ b/test/form/samples/namespace-optimization-in-operator/_expected.js
@@ -1,3 +1,4 @@
 function c() {}
 
 console.log(c());
+console.log(true);
diff --git a/test/form/samples/namespace-optimization-in-operator/main.js b/test/form/samples/namespace-optimization-in-operator/main.js
index b7cabb723..7aa3bcffb 100644
--- a/test/form/samples/namespace-optimization-in-operator/main.js
+++ b/test/form/samples/namespace-optimization-in-operator/main.js
@@ -1,4 +1,5 @@
 import * as foo from './foo';
 
-if ('d' in foo) console.log(foo.d())
-if ('c' in foo) console.log(foo.c())
+if ('d' in foo) console.log(foo.d());
+if ('c' in foo) console.log(foo.c());
+console.log('c' in foo);
diff --git a/test/form/samples/optimization-in-operator/_config.js b/test/form/samples/optimization-in-operator/_config.js
new file mode 100644
index 000000000..8af6c86c0
--- /dev/null
+++ b/test/form/samples/optimization-in-operator/_config.js
@@ -0,0 +1,3 @@
+module.exports = defineTest({
+	description: 'keep foo structure'
+});
diff --git a/test/form/samples/optimization-in-operator/_expected.js b/test/form/samples/optimization-in-operator/_expected.js
new file mode 100644
index 000000000..3972a98fb
--- /dev/null
+++ b/test/form/samples/optimization-in-operator/_expected.js
@@ -0,0 +1,11 @@
+var foo = {
+	a: 1,
+	b: 1
+};
+
+function check(name) {
+	if (name in foo) return true;
+	return false;
+}
+
+export { check as default };
diff --git a/test/form/samples/optimization-in-operator/foo.js b/test/form/samples/optimization-in-operator/foo.js
new file mode 100644
index 000000000..49e5cbbe0
--- /dev/null
+++ b/test/form/samples/optimization-in-operator/foo.js
@@ -0,0 +1,4 @@
+export default {
+	a: 1,
+	b: 1
+};
diff --git a/test/form/samples/optimization-in-operator/main.js b/test/form/samples/optimization-in-operator/main.js
new file mode 100644
index 000000000..5e30a2f40
--- /dev/null
+++ b/test/form/samples/optimization-in-operator/main.js
@@ -0,0 +1,6 @@
+import foo from './foo';
+
+export default function check(name) {
+	if (name in foo) return true;
+	return false;
+}
