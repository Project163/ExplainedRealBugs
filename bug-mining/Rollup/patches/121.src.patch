diff --git a/bin/src/run/deprecateOptions.js b/bin/src/run/deprecateOptions.js
index eded62f60..cb840f0ed 100644
--- a/bin/src/run/deprecateOptions.js
+++ b/bin/src/run/deprecateOptions.js
@@ -1,76 +1,92 @@
-export default function deprecateOptions ( options ) {
+// second argument is required because rollup's Node API
+// passes inputOptions first and then output options
+// unlike the config file which passes whole options in one go
+export default function deprecateOptions ( options, deprecateConfig ) {
 	const deprecations = [];
 
-	if ( options.entry ) {
-		deprecations.push( { old: 'entry', new: 'input' } );
-		options.input = options.entry; // don't delete, as plugins sometimes depend on this...
-	}
-
-	if ( options.moduleName ) {
-		deprecations.push( { old: 'moduleName', new: 'output.name' } );
-		options.name = options.moduleName;
-		delete options.moduleName;
-	}
-
-	if ( options.sourceMap ) {
-		deprecations.push( { old: 'sourceMap', new: 'output.sourcemap' } );
-		options.sourcemap = options.sourceMap;
-		delete options.sourceMap;
-	}
-
-	if ( options.sourceMapFile ) {
-		deprecations.push( { old: 'sourceMapFile', new: 'output.sourcemapFile' } );
-		options.sourcemapFile = options.sourceMapFile;
-		delete options.sourceMapFile;
-	}
-
-	if ( options.useStrict ) {
-		deprecations.push( { old: 'useStrict', new: 'output.strict' } );
-		options.strict = options.useStrict;
-		delete options.useStrict;
-	}
+	if (deprecateConfig.input) deprecateInputOptions();
+	if (deprecateConfig.output) deprecateOutputOptions();
 
-	if ( options.targets ) {
-		deprecations.push( { old: 'targets', new: 'output' } );
-		options.output = options.targets;
-		delete options.targets;
+	return deprecations;
 
-		let deprecatedDest = false;
-		options.output.forEach( output => {
-			if ( output.dest ) {
-				if ( !deprecatedDest ) {
-					deprecations.push( { old: 'targets.dest', new: 'output.file' } );
-					deprecatedDest = true;
-				}
-				output.file = output.dest;
-				delete output.dest;
+	function deprecateInputOptions () {
+		if ( options.entry ) {
+			deprecations.push( { old: 'entry', new: 'input' } );
+			options.input = options.entry; // don't delete, as plugins sometimes depend on this...
+		}
+	
+		if ( options.pureExternalModules ) {
+			deprecations.push( { old: 'pureExternalModules', new: 'treeshake.pureExternalModules' } );
+			if ( options.treeshake === undefined ) {
+				options.treeshake = {};
 			}
-		} );
-	} else if ( options.dest ) {
-		deprecations.push( { old: 'dest', new: 'output.file' } );
-		options.output = {
-			file: options.dest,
-			format: options.format
-		};
-		delete options.dest;
-	}
-
-	if ( options.format ) {
-		if ( !options.output ) options.output = { format: options.format };
-		deprecations.push( { old: 'format', new: 'output.format' } );
-		delete options.format;
+			if ( options.treeshake ) {
+				options.treeshake.pureExternalModules = options.pureExternalModules;
+			}
+			delete options.pureExternalModules;
+		}
 	}
 
-	if ( options.pureExternalModules ) {
-		deprecations.push( { old: 'pureExternalModules', new: 'treeshake.pureExternalModules' } );
-		if ( options.treeshake === undefined ) {
-			options.treeshake = {};
+	function deprecateOutputOptions () {
+		if ( options.moduleName ) {
+			deprecations.push( { old: 'moduleName', new: 'output.name' } );
+			options.name = options.moduleName;
+			delete options.moduleName;
+		}
+	
+		if ( options.sourceMap ) {
+			deprecations.push( { old: 'sourceMap', new: 'output.sourcemap' } );
+			options.sourcemap = options.sourceMap;
+			delete options.sourceMap;
+		}
+	
+		if ( options.sourceMapFile ) {
+			deprecations.push( { old: 'sourceMapFile', new: 'output.sourcemapFile' } );
+			options.sourcemapFile = options.sourceMapFile;
+			delete options.sourceMapFile;
 		}
-		if ( options.treeshake ) {
-			options.treeshake.pureExternalModules = options.pureExternalModules;
+	
+		if ( options.useStrict ) {
+			deprecations.push( { old: 'useStrict', new: 'output.strict' } );
+			options.strict = options.useStrict;
+			delete options.useStrict;
+		}
+	
+		if ( options.targets ) {
+			deprecations.push( { old: 'targets', new: 'output' } );
+			options.output = options.targets;
+			delete options.targets;
+	
+			let deprecatedDest = false;
+			options.output.forEach( output => {
+				if ( output.dest ) {
+					if ( !deprecatedDest ) {
+						deprecations.push( { old: 'targets.dest', new: 'output.file' } );
+						deprecatedDest = true;
+					}
+					output.file = output.dest;
+					delete output.dest;
+				}
+			} );
+		} else if ( options.dest ) {
+			deprecations.push( { old: 'dest', new: 'output.file' } );
+			options.output = {
+				file: options.dest,
+				format: options.format
+			};
+			delete options.dest;
+		}
+	
+		if ( options.format ) {
+			if ( !options.output ) options.output = { format: options.format };
+			deprecations.push( { old: 'format', new: 'output.format' } );
+			delete options.format;
+		}
+	
+		if (options.output && options.output.moduleId) {
+			options.output.amd = { id: options.moduleId };
+			deprecations.push( { old: 'moduleId', new: 'amd' } );
+			delete options.output.moduleId;
 		}
-		delete options.pureExternalModules;
 	}
-
-	return deprecations;
 }
diff --git a/bin/src/run/mergeOptions.js b/bin/src/run/mergeOptions.js
index 881c8bf2f..6fdc55138 100644
--- a/bin/src/run/mergeOptions.js
+++ b/bin/src/run/mergeOptions.js
@@ -11,8 +11,8 @@ function normalizeObjectOptionValue ( optionValue ) {
 	return optionValue;
 }
 
-export default function mergeOptions ( config, command ) {
-	const deprecations = deprecate( config, command );
+export default function mergeOptions ( config, command, deprecateConfig) {
+	const deprecations = deprecate( config, command, deprecateConfig );
 
 	function getOption ( name ) {
 		return command[ name ] !== undefined ? command[ name ] : config[ name ];
@@ -115,7 +115,7 @@ export default function mergeOptions ( config, command ) {
 	return { inputOptions, outputOptions, deprecations };
 }
 
-function deprecate ( config, command ) {
+function deprecate ( config, command = {}, deprecateConfig = { input: true, output: true } ) {
 	const deprecations = [];
 
 	// CLI
@@ -144,6 +144,6 @@ function deprecate ( config, command ) {
 	}
 
 	// config file
-	deprecations.push( ...deprecateOptions( config ) );
+	deprecations.push( ...deprecateOptions( config, deprecateConfig ) );
 	return deprecations;
 }
diff --git a/src/rollup/index.js b/src/rollup/index.js
index 56f15519a..55b4ad68a 100644
--- a/src/rollup/index.js
+++ b/src/rollup/index.js
@@ -6,6 +6,8 @@ import { mapSequence } from '../utils/promise.js';
 import validateKeys from '../utils/validateKeys.js';
 import error from '../utils/error.js';
 import { SOURCEMAPPING_URL } from '../utils/sourceMappingURL.js';
+import deprecateOptions from '../../bin/src/run/deprecateOptions';
+import batchWarnings from '../../bin/src/run/batchWarnings';
 import Bundle from '../Bundle.js';
 
 export const VERSION = '<@VERSION@>';
@@ -48,20 +50,14 @@ const ALLOWED_KEYS = [
 	'watch'
 ];
 
-function checkAmd ( options ) {
-	if ( options.moduleId ) {
-		if ( options.amd ) throw new Error( 'Cannot have both options.amd and options.moduleId' );
-
-		options.amd = { id: options.moduleId };
-		delete options.moduleId;
-
-		const message = `options.moduleId is deprecated in favour of options.amd = { id: moduleId }`;
-		if ( options.onwarn ) {
-			options.onwarn( { message } );
-		} else {
-			console.warn( message ); // eslint-disable-line no-console
-		}
-	}
+function addDeprecations (deprecations, warn) {
+	const message = `The following options have been renamed — please update your config: ${deprecations.map(
+		option => `${option.old} -> ${option.new}` ).join( ', ' )}`;
+	warn( {
+		code: 'DEPRECATED_OPTIONS',
+		message,
+		deprecations
+	} );
 }
 
 function checkInputOptions ( options, warn ) {
@@ -70,37 +66,12 @@ function checkInputOptions ( options, warn ) {
 			'The `transform`, `load`, `resolveId` and `resolveExternal` options are deprecated in favour of a unified plugin API. See https://github.com/rollup/rollup/wiki/Plugins for details' );
 	}
 
-	if ( options.pureExternalModules ) {
-		if ( options.treeshake === undefined ) {
-			options.treeshake = {};
-		}
-		if ( options.treeshake ) {
-			options.treeshake.pureExternalModules = options.pureExternalModules;
-		}
-		delete options.pureExternalModules;
-		warn( {
-			message: `options.pureExternalModules is deprecated, use options.treeshake.pureExternalModules`
-		} );
-	}
-
-	if ( options.entry && !options.input ) {
-		options.input = options.entry;
-		warn( {
-			message: `options.entry is deprecated, use options.input`
-		} );
-	}
-
 	const err = validateKeys( keys( options ), ALLOWED_KEYS );
 	if ( err ) throw err;
-}
 
-const deprecatedOutputOptions = {
-	dest: 'file',
-	moduleName: 'name',
-	sourceMap: 'sourcemap',
-	sourceMapFile: 'sourcemapFile',
-	useStrict: 'strict'
-};
+	const deprecations = deprecateOptions(options, { input: true });
+	if ( deprecations.length ) addDeprecations(deprecations, warn);
+}
 
 function checkOutputOptions ( options, warn ) {
 	if ( options.format === 'es6' ) {
@@ -119,33 +90,10 @@ function checkOutputOptions ( options, warn ) {
 
 	if ( options.moduleId ) {
 		if ( options.amd ) throw new Error( 'Cannot have both options.amd and options.moduleId' );
-
-		options.amd = { id: options.moduleId };
-		delete options.moduleId;
-
-		warn( {
-			message: `options.moduleId is deprecated in favour of options.amd = { id: moduleId }`
-		} );
 	}
 
-	const deprecations = [];
-	Object.keys( deprecatedOutputOptions ).forEach( old => {
-		if ( old in options ) {
-			deprecations.push( { old, new: deprecatedOutputOptions[ old ] } );
-			options[ deprecatedOutputOptions[ old ] ] = options[ old ];
-			delete options[ old ];
-		}
-	} );
-
-	if ( deprecations.length ) {
-		const message = `The following options have been renamed — please update your config: ${deprecations.map(
-			option => `${option.old} -> ${option.new}` ).join( ', ' )}`;
-		warn( {
-			code: 'DEPRECATED_OPTIONS',
-			message,
-			deprecations
-		} );
-	}
+	const deprecations = deprecateOptions({ output: options }, { output: true });
+	if ( deprecations.length ) addDeprecations(deprecations, warn);
 }
 
 const throwAsyncGenerateError = {
@@ -160,7 +108,17 @@ export default function rollup ( inputOptions ) {
 			throw new Error( 'You must supply an options object to rollup' );
 		}
 
-		const warn = inputOptions.onwarn || (warning => console.warn( warning.message )); // eslint-disable-line no-console
+		const warnings = batchWarnings();
+		const onwarn = inputOptions.onwarn;
+		let warn;
+
+		if (onwarn) {
+			warn = warning => {
+				onwarn(warning, warnings.add);
+			};
+		} else {
+			warn = warning => console.warn(warning.message); // eslint-disable-line no-console
+		}
 
 		checkInputOptions( inputOptions, warn );
 		const bundle = new Bundle( inputOptions );
@@ -175,7 +133,6 @@ export default function rollup ( inputOptions ) {
 					throw new Error( 'You must supply an options object' );
 				}
 				checkOutputOptions( outputOptions, warn );
-				checkAmd( outputOptions );
 
 				timeStart( '--GENERATE--' );
 
diff --git a/test/misc/index.js b/test/misc/index.js
index f16df3f45..8ebd7ba3b 100644
--- a/test/misc/index.js
+++ b/test/misc/index.js
@@ -25,6 +25,29 @@ describe('sanity checks', () => {
 			});
 	});
 
+	it('node API passes warning and default handler to custom onwarn function', () => {
+		let args = [];
+		return rollup
+			.rollup({
+				entry: 'x',
+				plugins: [loader({ x: `console.log( 42 );` })],
+				onwarn (warning, onwarn) {
+					args = [warning, onwarn];
+				}
+			})
+			.then(() => {
+				assert.deepEqual(args[0], {
+					code: 'DEPRECATED_OPTIONS',
+					deprecations: [{
+						new: 'input',
+						old: 'entry',
+					}],
+					message: `The following options have been renamed — please update your config: entry -> input`
+				});
+				assert.equal(typeof args[1], 'function');
+			});
+	});
+
 	it('fails without options.input', () => {
 		return rollup
 			.rollup({})
@@ -119,7 +142,12 @@ describe('deprecations', () => {
 			assert.equal(result, 42);
 			assert.deepEqual(warnings, [
 				{
-					message: `options.entry is deprecated, use options.input`
+					code: 'DEPRECATED_OPTIONS',
+					deprecations: [{
+						new: 'input',
+						old: 'entry',
+					}],
+					message: `The following options have been renamed — please update your config: entry -> input`
 				}
 			]);
 		});
