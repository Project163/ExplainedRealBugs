{"url":"https://api.github.com/repos/square/leakcanary/issues/2167","repository_url":"https://api.github.com/repos/square/leakcanary","labels_url":"https://api.github.com/repos/square/leakcanary/issues/2167/labels{/name}","comments_url":"https://api.github.com/repos/square/leakcanary/issues/2167/comments","events_url":"https://api.github.com/repos/square/leakcanary/issues/2167/events","html_url":"https://github.com/square/leakcanary/issues/2167","id":994751250,"node_id":"MDU6SXNzdWU5OTQ3NTEyNTA=","number":2167,"title":"Android System Autofill Leak (Spannable)","user":{"login":"maxxx","id":123766,"node_id":"MDQ6VXNlcjEyMzc2Ng==","avatar_url":"https://avatars.githubusercontent.com/u/123766?v=4","gravatar_id":"","url":"https://api.github.com/users/maxxx","html_url":"https://github.com/maxxx","followers_url":"https://api.github.com/users/maxxx/followers","following_url":"https://api.github.com/users/maxxx/following{/other_user}","gists_url":"https://api.github.com/users/maxxx/gists{/gist_id}","starred_url":"https://api.github.com/users/maxxx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maxxx/subscriptions","organizations_url":"https://api.github.com/users/maxxx/orgs","repos_url":"https://api.github.com/users/maxxx/repos","events_url":"https://api.github.com/users/maxxx/events{/privacy}","received_events_url":"https://api.github.com/users/maxxx/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":236245157,"node_id":"MDU6TGFiZWwyMzYyNDUxNTc=","url":"https://api.github.com/repos/square/leakcanary/labels/type:%20leak","name":"type: leak","color":"f9ee02","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/square/leakcanary/milestones/22","html_url":"https://github.com/square/leakcanary/milestone/22","labels_url":"https://api.github.com/repos/square/leakcanary/milestones/22/labels","id":6597430,"node_id":"MDk6TWlsZXN0b25lNjU5NzQzMA==","number":22,"title":"2.8","description":"","creator":{"login":"pyricau","id":557033,"node_id":"MDQ6VXNlcjU1NzAzMw==","avatar_url":"https://avatars.githubusercontent.com/u/557033?v=4","gravatar_id":"","url":"https://api.github.com/users/pyricau","html_url":"https://github.com/pyricau","followers_url":"https://api.github.com/users/pyricau/followers","following_url":"https://api.github.com/users/pyricau/following{/other_user}","gists_url":"https://api.github.com/users/pyricau/gists{/gist_id}","starred_url":"https://api.github.com/users/pyricau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pyricau/subscriptions","organizations_url":"https://api.github.com/users/pyricau/orgs","repos_url":"https://api.github.com/users/pyricau/repos","events_url":"https://api.github.com/users/pyricau/events{/privacy}","received_events_url":"https://api.github.com/users/pyricau/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":22,"state":"closed","created_at":"2021-03-26T17:54:29Z","updated_at":"2022-01-04T09:47:35Z","due_on":null,"closed_at":"2022-01-04T09:47:35Z"},"comments":2,"created_at":"2021-09-13T11:03:01Z","updated_at":"2021-12-16T00:36:35Z","closed_at":"2021-12-16T00:36:29Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"This is the reopen for #1573 as suggested in https://github.com/square/leakcanary/issues/1573#issuecomment-839154311. \r\nSo on Android 11 (API 30) I caught this leak when trying to add custom URLSpan to SpannableStringBuilder (for setting into TextView, also with LinkMovementMethod).\r\nI have found only generic SO post about such situations - https://stackoverflow.com/questions/28539216/android-textview-leaks-with-setmovementmethod and comment https://issuetracker.google.com/issues/146100180#comment6\r\nThe workaround suggested in https://stackoverflow.com/a/53202503/2190250) seems working.\r\n\r\n```\r\nfun getClickableSpannedString(text: CharSequence, context: Context): CharSequence {\r\n  val resultBuilder = SpannableString(text)\r\n  \r\n  val span = object : URLSpan(\"some data\") {\r\n      override fun onClick(widget: View) {\r\n          // some use of Context passed in function, like opening web page or just context.startActivity\r\n      }\r\n  }\r\n  \r\n  // add to resultBuilder \r\n  resultBuilder.setSpan(span,\r\n                  ...,\r\n                  ...,\r\n                  Spanned.SPAN_EXCLUSIVE_EXCLUSIVE)\r\n  \r\n  return resultBuilder\r\n}\r\n```\r\n\r\n### LeakTrace information\r\n```\r\n​\r\n┬───\r\n│ GC Root: Global variable in native code\r\n│\r\n├─ android.app.assist.AssistStructure$SendChannel instance\r\n│    Leaking: UNKNOWN\r\n│    Retaining 1,4 MB in 19355 objects\r\n│    ↓ AssistStructure$SendChannel.mAssistStructure\r\n│                                  ~~~~~~~~~~~~~~~~\r\n├─ android.app.assist.AssistStructure instance\r\n│    Leaking: UNKNOWN\r\n│    Retaining 1,4 MB in 19354 objects\r\n│    ↓ AssistStructure.mWindowNodes\r\n│                      ~~~~~~~~~~~~\r\n├─ java.util.ArrayList instance\r\n│    Leaking: UNKNOWN\r\n│    Retaining 1,4 MB in 19351 objects\r\n│    ↓ ArrayList.elementData\r\n│                ~~~~~~~~~~~\r\n├─ java.lang.Object[] array\r\n│    Leaking: UNKNOWN\r\n│    Retaining 1,4 MB in 19350 objects\r\n│    ↓ Object[].[0]\r\n│               ~~~\r\n├─ android.app.assist.AssistStructure$WindowNode instance\r\n│    Leaking: UNKNOWN\r\n│    Retaining 1,4 MB in 19349 objects\r\n│    ↓ AssistStructure$WindowNode.mRoot\r\n│                                 ~~~~~\r\n├─ android.app.assist.AssistStructure$ViewNode instance\r\n│    Leaking: UNKNOWN\r\n│    Retaining 1,4 MB in 19347 objects\r\n│    ↓ AssistStructure$ViewNode.mChildren\r\n│                               ~~~~~~~~~\r\n├─ android.app.assist.AssistStructure$ViewNode[] array\r\n│    Leaking: UNKNOWN\r\n│    Retaining 1,4 MB in 19345 objects\r\n│    ↓ AssistStructure$ViewNode[].[0]\r\n│                                 ~~~\r\n├─ android.app.assist.AssistStructure$ViewNode instance\r\n│    Leaking: UNKNOWN\r\n│    Retaining 1,4 MB in 19344 objects\r\n│    ↓ AssistStructure$ViewNode.mChildren\r\n│                               ~~~~~~~~~\r\n├─ android.app.assist.AssistStructure$ViewNode[] array\r\n│    Leaking: UNKNOWN\r\n│    Retaining 1,4 MB in 19339 objects\r\n│    ↓ AssistStructure$ViewNode[].[1]\r\n│                                 ~~~\r\n├─ android.app.assist.AssistStructure$ViewNode instance\r\n│    Leaking: UNKNOWN\r\n│    Retaining 1,4 MB in 19333 objects\r\n│    ↓ AssistStructure$ViewNode.mChildren\r\n│                               ~~~~~~~~~\r\n├─ android.app.assist.AssistStructure$ViewNode[] array\r\n│    Leaking: UNKNOWN\r\n│    Retaining 1,4 MB in 19328 objects\r\n│    ↓ AssistStructure$ViewNode[].[1]\r\n│                                 ~~~\r\n├─ android.app.assist.AssistStructure$ViewNode instance\r\n│    Leaking: UNKNOWN\r\n│    Retaining 1,3 MB in 18131 objects\r\n│    ↓ AssistStructure$ViewNode.mText\r\n│                               ~~~~~\r\n├─ android.app.assist.AssistStructure$ViewNodeText instance\r\n│    Leaking: UNKNOWN\r\n│    Retaining 1,3 MB in 18125 objects\r\n│    ↓ AssistStructure$ViewNodeText.mText\r\n│                                   ~~~~~\r\n├─ android.text.SpannableStringBuilder instance\r\n│    Leaking: UNKNOWN\r\n│    Retaining 1,3 MB in 18124 objects\r\n│    ↓ SpannableStringBuilder.mSpans\r\n│                             ~~~~~~\r\n├─ java.lang.Object[] array\r\n│    Leaking: UNKNOWN\r\n│    Retaining 36 B in 1 objects\r\n│    ↓ Object[].[1]\r\n│               ~~~\r\n├─ com.***.AppTextUtils$getClickableSpannedString$1 instance\r\n│    Leaking: UNKNOWN\r\n│    Retaining 1,3 MB in 18114 objects\r\n│    Anonymous subclass of android.text.style.URLSpan\r\n│    $context instance of com.***Activity with mDestroyed\r\n│    = true\r\n│    ↓ AppTextUtils$getClickableSpannedString$1.$context\r\n│                                               ~~~~~~~~\r\n╰→ com.***Activity instance\r\n​     Leaking: YES (ObjectWatcher was watching this because com.***Activity received Activity#onDestroy() callback and Activity#mDestroyed is true)\r\n​     Retaining 1,3 MB in 18113 objects\r\n​     key = a4b2dad5-d4d5-4eb0-a3b1-b806ac7e5866\r\n​     watchDurationMillis = 136708\r\n​     retainedDurationMillis = 131708\r\n​     mApplication instance of com.***\r\n​     mBase instance of androidx.appcompat.view.ContextThemeWrapper\r\nMETADATA\r\nBuild.VERSION.SDK_INT: 30\r\nBuild.MANUFACTURER: samsung\r\nLeakCanary version: 2.7\r\nApp process name: com.***\r\nStats: LruCache[maxSize=3000,hits=7899,misses=125272,hitRate=5%]\r\nRandomAccess[bytes=7109912,reads=125272,travel=110060325860,range=41624594,size=52241891]\r\nHeap dump reason: 4 retained objects, app is not visible\r\nAnalysis duration: 21754 ms\r\n```\r\n","closed_by":{"login":"pyricau","id":557033,"node_id":"MDQ6VXNlcjU1NzAzMw==","avatar_url":"https://avatars.githubusercontent.com/u/557033?v=4","gravatar_id":"","url":"https://api.github.com/users/pyricau","html_url":"https://github.com/pyricau","followers_url":"https://api.github.com/users/pyricau/followers","following_url":"https://api.github.com/users/pyricau/following{/other_user}","gists_url":"https://api.github.com/users/pyricau/gists{/gist_id}","starred_url":"https://api.github.com/users/pyricau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pyricau/subscriptions","organizations_url":"https://api.github.com/users/pyricau/orgs","repos_url":"https://api.github.com/users/pyricau/repos","events_url":"https://api.github.com/users/pyricau/events{/privacy}","received_events_url":"https://api.github.com/users/pyricau/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/square/leakcanary/issues/2167/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/square/leakcanary/issues/2167/timeline","performed_via_github_app":null,"state_reason":"completed"}