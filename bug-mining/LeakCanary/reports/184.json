{"url":"https://api.github.com/repos/square/leakcanary/issues/1876","repository_url":"https://api.github.com/repos/square/leakcanary","labels_url":"https://api.github.com/repos/square/leakcanary/issues/1876/labels{/name}","comments_url":"https://api.github.com/repos/square/leakcanary/issues/1876/comments","events_url":"https://api.github.com/repos/square/leakcanary/issues/1876/events","html_url":"https://github.com/square/leakcanary/issues/1876","id":642642787,"node_id":"MDU6SXNzdWU2NDI2NDI3ODc=","number":1876,"title":"Hprof file reading performance discussion","user":{"login":"Armaxis","id":2152942,"node_id":"MDQ6VXNlcjIxNTI5NDI=","avatar_url":"https://avatars.githubusercontent.com/u/2152942?v=4","gravatar_id":"","url":"https://api.github.com/users/Armaxis","html_url":"https://github.com/Armaxis","followers_url":"https://api.github.com/users/Armaxis/followers","following_url":"https://api.github.com/users/Armaxis/following{/other_user}","gists_url":"https://api.github.com/users/Armaxis/gists{/gist_id}","starred_url":"https://api.github.com/users/Armaxis/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Armaxis/subscriptions","organizations_url":"https://api.github.com/users/Armaxis/orgs","repos_url":"https://api.github.com/users/Armaxis/repos","events_url":"https://api.github.com/users/Armaxis/events{/privacy}","received_events_url":"https://api.github.com/users/Armaxis/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/square/leakcanary/milestones/19","html_url":"https://github.com/square/leakcanary/milestone/19","labels_url":"https://api.github.com/repos/square/leakcanary/milestones/19/labels","id":5530347,"node_id":"MDk6TWlsZXN0b25lNTUzMDM0Nw==","number":19,"title":"2.5","description":"","creator":{"login":"pyricau","id":557033,"node_id":"MDQ6VXNlcjU1NzAzMw==","avatar_url":"https://avatars.githubusercontent.com/u/557033?v=4","gravatar_id":"","url":"https://api.github.com/users/pyricau","html_url":"https://github.com/pyricau","followers_url":"https://api.github.com/users/pyricau/followers","following_url":"https://api.github.com/users/pyricau/following{/other_user}","gists_url":"https://api.github.com/users/pyricau/gists{/gist_id}","starred_url":"https://api.github.com/users/pyricau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pyricau/subscriptions","organizations_url":"https://api.github.com/users/pyricau/orgs","repos_url":"https://api.github.com/users/pyricau/repos","events_url":"https://api.github.com/users/pyricau/events{/privacy}","received_events_url":"https://api.github.com/users/pyricau/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":19,"state":"closed","created_at":"2020-06-11T05:51:03Z","updated_at":"2020-10-01T17:50:17Z","due_on":null,"closed_at":"2020-10-01T17:50:17Z"},"comments":3,"created_at":"2020-06-21T21:16:54Z","updated_at":"2020-09-15T21:27:45Z","closed_at":"2020-09-15T21:25:01Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"While analyzing [method trace](https://github.com/square/leakcanary/files/4810257/trace.zip) from #1875 I noticed that we spend a lot of time checking if thread is interruped because of `FileChannelImpl`\r\n\r\n![image](https://user-images.githubusercontent.com/2152942/85235290-690dab00-b3d9-11ea-9c2d-a0eb1ebbb3c0.png)\r\n\r\n[Current implementation](https://github.com/square/leakcanary/blob/5983eae9a1dbd96f0de5cd5e2601cd3c563f978f/shark-hprof/src/main/java/shark/Hprof.kt#L71) of LeakCanary uses `Okio`'s source to read from file while manually using `FileChannel` to move the pointer back and forward around the file as we read different parts of hprof file. We do not write to file, only read, so we're looking for the most efficient random read file access on Android. We can't fully read the file into memory, though.\r\n\r\nI wonder if we are using the most efficient approach to read the file. Our use case might be not the best fit for Okio, and perhaps we need to try something different. We're single-threaded and don't care about async IO, locking file while reading it works for us. There's `RandomAccessFile` API available (I'm not familiar with it) that looks promising? And `MappedByteBuffer` for reading parts into memory.\r\n\r\n","closed_by":{"login":"pyricau","id":557033,"node_id":"MDQ6VXNlcjU1NzAzMw==","avatar_url":"https://avatars.githubusercontent.com/u/557033?v=4","gravatar_id":"","url":"https://api.github.com/users/pyricau","html_url":"https://github.com/pyricau","followers_url":"https://api.github.com/users/pyricau/followers","following_url":"https://api.github.com/users/pyricau/following{/other_user}","gists_url":"https://api.github.com/users/pyricau/gists{/gist_id}","starred_url":"https://api.github.com/users/pyricau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pyricau/subscriptions","organizations_url":"https://api.github.com/users/pyricau/orgs","repos_url":"https://api.github.com/users/pyricau/repos","events_url":"https://api.github.com/users/pyricau/events{/privacy}","received_events_url":"https://api.github.com/users/pyricau/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/square/leakcanary/issues/1876/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/square/leakcanary/issues/1876/timeline","performed_via_github_app":null,"state_reason":"completed"}