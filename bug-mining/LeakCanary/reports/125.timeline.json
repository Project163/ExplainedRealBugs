[{"id":2551531517,"node_id":"MDEyOkxhYmVsZWRFdmVudDI1NTE1MzE1MTc=","url":"https://api.github.com/repos/square/leakcanary/issues/events/2551531517","actor":{"login":"nowele-rechka-entercom","id":50639220,"node_id":"MDQ6VXNlcjUwNjM5MjIw","avatar_url":"https://avatars.githubusercontent.com/u/50639220?v=4","gravatar_id":"","url":"https://api.github.com/users/nowele-rechka-entercom","html_url":"https://github.com/nowele-rechka-entercom","followers_url":"https://api.github.com/users/nowele-rechka-entercom/followers","following_url":"https://api.github.com/users/nowele-rechka-entercom/following{/other_user}","gists_url":"https://api.github.com/users/nowele-rechka-entercom/gists{/gist_id}","starred_url":"https://api.github.com/users/nowele-rechka-entercom/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nowele-rechka-entercom/subscriptions","organizations_url":"https://api.github.com/users/nowele-rechka-entercom/orgs","repos_url":"https://api.github.com/users/nowele-rechka-entercom/repos","events_url":"https://api.github.com/users/nowele-rechka-entercom/events{/privacy}","received_events_url":"https://api.github.com/users/nowele-rechka-entercom/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2019-08-12T21:13:17Z","label":{"name":"type: bug","color":"fc2929"},"performed_via_github_app":null},{"url":"https://api.github.com/repos/square/leakcanary/issues/comments/520607201","html_url":"https://github.com/square/leakcanary/issues/1532#issuecomment-520607201","issue_url":"https://api.github.com/repos/square/leakcanary/issues/1532","id":520607201,"node_id":"MDEyOklzc3VlQ29tbWVudDUyMDYwNzIwMQ==","user":{"login":"pyricau","id":557033,"node_id":"MDQ6VXNlcjU1NzAzMw==","avatar_url":"https://avatars.githubusercontent.com/u/557033?v=4","gravatar_id":"","url":"https://api.github.com/users/pyricau","html_url":"https://github.com/pyricau","followers_url":"https://api.github.com/users/pyricau/followers","following_url":"https://api.github.com/users/pyricau/following{/other_user}","gists_url":"https://api.github.com/users/pyricau/gists{/gist_id}","starred_url":"https://api.github.com/users/pyricau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pyricau/subscriptions","organizations_url":"https://api.github.com/users/pyricau/orgs","repos_url":"https://api.github.com/users/pyricau/repos","events_url":"https://api.github.com/users/pyricau/events{/privacy}","received_events_url":"https://api.github.com/users/pyricau/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-08-12T21:44:12Z","updated_at":"2019-08-12T21:44:12Z","body":"Thanks!","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/square/leakcanary/issues/comments/520607201/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"pyricau","id":557033,"node_id":"MDQ6VXNlcjU1NzAzMw==","avatar_url":"https://avatars.githubusercontent.com/u/557033?v=4","gravatar_id":"","url":"https://api.github.com/users/pyricau","html_url":"https://github.com/pyricau","followers_url":"https://api.github.com/users/pyricau/followers","following_url":"https://api.github.com/users/pyricau/following{/other_user}","gists_url":"https://api.github.com/users/pyricau/gists{/gist_id}","starred_url":"https://api.github.com/users/pyricau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pyricau/subscriptions","organizations_url":"https://api.github.com/users/pyricau/orgs","repos_url":"https://api.github.com/users/pyricau/repos","events_url":"https://api.github.com/users/pyricau/events{/privacy}","received_events_url":"https://api.github.com/users/pyricau/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/square/leakcanary/issues/comments/520673512","html_url":"https://github.com/square/leakcanary/issues/1532#issuecomment-520673512","issue_url":"https://api.github.com/repos/square/leakcanary/issues/1532","id":520673512,"node_id":"MDEyOklzc3VlQ29tbWVudDUyMDY3MzUxMg==","user":{"login":"pyricau","id":557033,"node_id":"MDQ6VXNlcjU1NzAzMw==","avatar_url":"https://avatars.githubusercontent.com/u/557033?v=4","gravatar_id":"","url":"https://api.github.com/users/pyricau","html_url":"https://github.com/pyricau","followers_url":"https://api.github.com/users/pyricau/followers","following_url":"https://api.github.com/users/pyricau/following{/other_user}","gists_url":"https://api.github.com/users/pyricau/gists{/gist_id}","starred_url":"https://api.github.com/users/pyricau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pyricau/subscriptions","organizations_url":"https://api.github.com/users/pyricau/orgs","repos_url":"https://api.github.com/users/pyricau/repos","events_url":"https://api.github.com/users/pyricau/events{/privacy}","received_events_url":"https://api.github.com/users/pyricau/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-08-13T03:20:53Z","updated_at":"2019-08-13T03:20:53Z","body":"Running the analysis with the profiler:\r\n\r\n- Memory starts at 2Mb\r\n- Goes up to 176Mb when building the index\r\n- After building the index it drops back to 140Mb. => 1) what are the extra 36Mb for?\r\n- Then it goes up to 181Mb => 2) Is this for finding leaking instances?\r\n- Then down to 140Mb (so those were temporary 40Mb)\r\n- Then up to 214Mb => 3) Is this for the shortest path? Maybe initial list of GC roots?\r\n- Then down to 153Mb and slowing building back up to 190Mb => 4) What's that about?\r\n\r\nGenerally, we have two directions to investigate: a) the baseline memory required post hprof indexing, and how to lower that and b) the spikes while analyzing. The baseline is the most impactful right now.\r\n\r\nI dumped the heap post indexing:\r\n\r\n- The object cache uses 120Mb, the hprof string cache 13Mb\r\n- Object cache (LongObjectScatterMap):\r\n  - => Keys: 33Mb for the array\r\n  - => values: 87Mb including 16Mb for the array => 71Mb for the rest => matches the remaining.\r\n  - IndexedInstance (1.4M): 45Mb\r\n  - PrimitiveArray (514K): 16Mb\r\n  - ObjectArray (213K): 7Mb\r\n  - Class (27K classes): 1Mb","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/square/leakcanary/issues/comments/520673512/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"pyricau","id":557033,"node_id":"MDQ6VXNlcjU1NzAzMw==","avatar_url":"https://avatars.githubusercontent.com/u/557033?v=4","gravatar_id":"","url":"https://api.github.com/users/pyricau","html_url":"https://github.com/pyricau","followers_url":"https://api.github.com/users/pyricau/followers","following_url":"https://api.github.com/users/pyricau/following{/other_user}","gists_url":"https://api.github.com/users/pyricau/gists{/gist_id}","starred_url":"https://api.github.com/users/pyricau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pyricau/subscriptions","organizations_url":"https://api.github.com/users/pyricau/orgs","repos_url":"https://api.github.com/users/pyricau/repos","events_url":"https://api.github.com/users/pyricau/events{/privacy}","received_events_url":"https://api.github.com/users/pyricau/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/square/leakcanary/issues/comments/520674875","html_url":"https://github.com/square/leakcanary/issues/1532#issuecomment-520674875","issue_url":"https://api.github.com/repos/square/leakcanary/issues/1532","id":520674875,"node_id":"MDEyOklzc3VlQ29tbWVudDUyMDY3NDg3NQ==","user":{"login":"pyricau","id":557033,"node_id":"MDQ6VXNlcjU1NzAzMw==","avatar_url":"https://avatars.githubusercontent.com/u/557033?v=4","gravatar_id":"","url":"https://api.github.com/users/pyricau","html_url":"https://github.com/pyricau","followers_url":"https://api.github.com/users/pyricau/followers","following_url":"https://api.github.com/users/pyricau/following{/other_user}","gists_url":"https://api.github.com/users/pyricau/gists{/gist_id}","starred_url":"https://api.github.com/users/pyricau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pyricau/subscriptions","organizations_url":"https://api.github.com/users/pyricau/orgs","repos_url":"https://api.github.com/users/pyricau/repos","events_url":"https://api.github.com/users/pyricau/events{/privacy}","received_events_url":"https://api.github.com/users/pyricau/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-08-13T03:29:21Z","updated_at":"2019-08-13T03:29:21Z","body":"So our baseline is 133Mb (makes sense that memory goes down to 140Mb, 7Mb of baseline java memory for instrumentation tests is reasonable) and the big question is: how can we reduce that, and what do we have to sacrifice for it?","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/square/leakcanary/issues/comments/520674875/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"pyricau","id":557033,"node_id":"MDQ6VXNlcjU1NzAzMw==","avatar_url":"https://avatars.githubusercontent.com/u/557033?v=4","gravatar_id":"","url":"https://api.github.com/users/pyricau","html_url":"https://github.com/pyricau","followers_url":"https://api.github.com/users/pyricau/followers","following_url":"https://api.github.com/users/pyricau/following{/other_user}","gists_url":"https://api.github.com/users/pyricau/gists{/gist_id}","starred_url":"https://api.github.com/users/pyricau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pyricau/subscriptions","organizations_url":"https://api.github.com/users/pyricau/orgs","repos_url":"https://api.github.com/users/pyricau/repos","events_url":"https://api.github.com/users/pyricau/events{/privacy}","received_events_url":"https://api.github.com/users/pyricau/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/square/leakcanary/issues/comments/520688310","html_url":"https://github.com/square/leakcanary/issues/1532#issuecomment-520688310","issue_url":"https://api.github.com/repos/square/leakcanary/issues/1532","id":520688310,"node_id":"MDEyOklzc3VlQ29tbWVudDUyMDY4ODMxMA==","user":{"login":"pyricau","id":557033,"node_id":"MDQ6VXNlcjU1NzAzMw==","avatar_url":"https://avatars.githubusercontent.com/u/557033?v=4","gravatar_id":"","url":"https://api.github.com/users/pyricau","html_url":"https://github.com/pyricau","followers_url":"https://api.github.com/users/pyricau/followers","following_url":"https://api.github.com/users/pyricau/following{/other_user}","gists_url":"https://api.github.com/users/pyricau/gists{/gist_id}","starred_url":"https://api.github.com/users/pyricau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pyricau/subscriptions","organizations_url":"https://api.github.com/users/pyricau/orgs","repos_url":"https://api.github.com/users/pyricau/repos","events_url":"https://api.github.com/users/pyricau/events{/privacy}","received_events_url":"https://api.github.com/users/pyricau/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-08-13T04:54:56Z","updated_at":"2019-08-13T05:07:16Z","body":"There's ~2M instances and 8 bytes per ref so we should use 16Mb per array. Not sure why keys is double the size of values, long et object ref are the same size.\r\n\r\nEdit: it's a 32 bit emulator so references use only 4 bits.\r\n\r\nWhich makes me think, might be worth storing those ids as ints when parsing a heap dump from a 32bit platform. That'd require maintaining parallel data structures (for the maps but also the sealed class that are values in the map), so not great.","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/square/leakcanary/issues/comments/520688310/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"pyricau","id":557033,"node_id":"MDQ6VXNlcjU1NzAzMw==","avatar_url":"https://avatars.githubusercontent.com/u/557033?v=4","gravatar_id":"","url":"https://api.github.com/users/pyricau","html_url":"https://github.com/pyricau","followers_url":"https://api.github.com/users/pyricau/followers","following_url":"https://api.github.com/users/pyricau/following{/other_user}","gists_url":"https://api.github.com/users/pyricau/gists{/gist_id}","starred_url":"https://api.github.com/users/pyricau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pyricau/subscriptions","organizations_url":"https://api.github.com/users/pyricau/orgs","repos_url":"https://api.github.com/users/pyricau/repos","events_url":"https://api.github.com/users/pyricau/events{/privacy}","received_events_url":"https://api.github.com/users/pyricau/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/square/leakcanary/issues/comments/520696186","html_url":"https://github.com/square/leakcanary/issues/1532#issuecomment-520696186","issue_url":"https://api.github.com/repos/square/leakcanary/issues/1532","id":520696186,"node_id":"MDEyOklzc3VlQ29tbWVudDUyMDY5NjE4Ng==","user":{"login":"pyricau","id":557033,"node_id":"MDQ6VXNlcjU1NzAzMw==","avatar_url":"https://avatars.githubusercontent.com/u/557033?v=4","gravatar_id":"","url":"https://api.github.com/users/pyricau","html_url":"https://github.com/pyricau","followers_url":"https://api.github.com/users/pyricau/followers","following_url":"https://api.github.com/users/pyricau/following{/other_user}","gists_url":"https://api.github.com/users/pyricau/gists{/gist_id}","starred_url":"https://api.github.com/users/pyricau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pyricau/subscriptions","organizations_url":"https://api.github.com/users/pyricau/orgs","repos_url":"https://api.github.com/users/pyricau/repos","events_url":"https://api.github.com/users/pyricau/events{/privacy}","received_events_url":"https://api.github.com/users/pyricau/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-08-13T05:40:53Z","updated_at":"2019-08-13T05:40:53Z","body":"A few more observations:\r\n\r\n- we use `position` to figure out where to read in the heap dump. So `position` is only useful when performing IO, as opposed to the rest of the index which is useful to skip reads. So we could store the \"id=>position\" map on disk. Would need to be efficient for the initial write phase and subsequence reads.\r\n- IndexedClass uses 40bits, the other ones use 32bits. That's most likely due to 12bit header + content + 4bit shadow$_monitor + alignment.\r\n\r\nThe total cost of IndexedInstance (which we have 1.4M instances here) is 8 bit key + 4bit value ref + 32bit = 44bits per instance. \r\n\r\nWe could inline the index sealed classes and split our object index maps into one map per type of thing to store.\r\n\r\nIndexedClass: long => (position, superclassId, instanceSize) => 32 bits per instance instead of 56\r\nIndexedInstance: long => (position, classId) => 24 bits per instance instead of 44bits\r\nSame for IndexedObjectArray\r\nIndexedPrimitiveArray: long => (position, type) => 5 bits per instance instead of 44 bits\r\n\r\nThis would approximately divide by two the total memory used by the index in this case. The perf hit is that it's slower to find an object by id, but that should still be pretty good. Probably less than 4x (we'll always look up the bigger map first)\r\n\r\nIf we dump the position to a file index we can reduce this further by another 30%.","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/square/leakcanary/issues/comments/520696186/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"pyricau","id":557033,"node_id":"MDQ6VXNlcjU1NzAzMw==","avatar_url":"https://avatars.githubusercontent.com/u/557033?v=4","gravatar_id":"","url":"https://api.github.com/users/pyricau","html_url":"https://github.com/pyricau","followers_url":"https://api.github.com/users/pyricau/followers","following_url":"https://api.github.com/users/pyricau/following{/other_user}","gists_url":"https://api.github.com/users/pyricau/gists{/gist_id}","starred_url":"https://api.github.com/users/pyricau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pyricau/subscriptions","organizations_url":"https://api.github.com/users/pyricau/orgs","repos_url":"https://api.github.com/users/pyricau/repos","events_url":"https://api.github.com/users/pyricau/events{/privacy}","received_events_url":"https://api.github.com/users/pyricau/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/square/leakcanary/issues/comments/520696574","html_url":"https://github.com/square/leakcanary/issues/1532#issuecomment-520696574","issue_url":"https://api.github.com/repos/square/leakcanary/issues/1532","id":520696574,"node_id":"MDEyOklzc3VlQ29tbWVudDUyMDY5NjU3NA==","user":{"login":"pyricau","id":557033,"node_id":"MDQ6VXNlcjU1NzAzMw==","avatar_url":"https://avatars.githubusercontent.com/u/557033?v=4","gravatar_id":"","url":"https://api.github.com/users/pyricau","html_url":"https://github.com/pyricau","followers_url":"https://api.github.com/users/pyricau/followers","following_url":"https://api.github.com/users/pyricau/following{/other_user}","gists_url":"https://api.github.com/users/pyricau/gists{/gist_id}","starred_url":"https://api.github.com/users/pyricau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pyricau/subscriptions","organizations_url":"https://api.github.com/users/pyricau/orgs","repos_url":"https://api.github.com/users/pyricau/repos","events_url":"https://api.github.com/users/pyricau/events{/privacy}","received_events_url":"https://api.github.com/users/pyricau/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-08-13T05:43:03Z","updated_at":"2019-08-13T05:43:03Z","body":"The hprof string cache can be reduced by storing a reversed trie as value instead of strings directly. Class names have a lot of repetitive prefix so this should compress well.","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/square/leakcanary/issues/comments/520696574/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"pyricau","id":557033,"node_id":"MDQ6VXNlcjU1NzAzMw==","avatar_url":"https://avatars.githubusercontent.com/u/557033?v=4","gravatar_id":"","url":"https://api.github.com/users/pyricau","html_url":"https://github.com/pyricau","followers_url":"https://api.github.com/users/pyricau/followers","following_url":"https://api.github.com/users/pyricau/following{/other_user}","gists_url":"https://api.github.com/users/pyricau/gists{/gist_id}","starred_url":"https://api.github.com/users/pyricau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pyricau/subscriptions","organizations_url":"https://api.github.com/users/pyricau/orgs","repos_url":"https://api.github.com/users/pyricau/repos","events_url":"https://api.github.com/users/pyricau/events{/privacy}","received_events_url":"https://api.github.com/users/pyricau/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/square/leakcanary/issues/comments/520698114","html_url":"https://github.com/square/leakcanary/issues/1532#issuecomment-520698114","issue_url":"https://api.github.com/repos/square/leakcanary/issues/1532","id":520698114,"node_id":"MDEyOklzc3VlQ29tbWVudDUyMDY5ODExNA==","user":{"login":"pyricau","id":557033,"node_id":"MDQ6VXNlcjU1NzAzMw==","avatar_url":"https://avatars.githubusercontent.com/u/557033?v=4","gravatar_id":"","url":"https://api.github.com/users/pyricau","html_url":"https://github.com/pyricau","followers_url":"https://api.github.com/users/pyricau/followers","following_url":"https://api.github.com/users/pyricau/following{/other_user}","gists_url":"https://api.github.com/users/pyricau/gists{/gist_id}","starred_url":"https://api.github.com/users/pyricau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pyricau/subscriptions","organizations_url":"https://api.github.com/users/pyricau/orgs","repos_url":"https://api.github.com/users/pyricau/repos","events_url":"https://api.github.com/users/pyricau/events{/privacy}","received_events_url":"https://api.github.com/users/pyricau/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-08-13T05:51:09Z","updated_at":"2019-08-13T05:51:09Z","body":"Thinking about this some more: we probably just need one new map type, long to n-bytes, where n is provided when building the map and each entry has n bytes allocated. The tricky part is writing and reading with minimal allocations, which probably requires exposing access to the underlying array.","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/square/leakcanary/issues/comments/520698114/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"pyricau","id":557033,"node_id":"MDQ6VXNlcjU1NzAzMw==","avatar_url":"https://avatars.githubusercontent.com/u/557033?v=4","gravatar_id":"","url":"https://api.github.com/users/pyricau","html_url":"https://github.com/pyricau","followers_url":"https://api.github.com/users/pyricau/followers","following_url":"https://api.github.com/users/pyricau/following{/other_user}","gists_url":"https://api.github.com/users/pyricau/gists{/gist_id}","starred_url":"https://api.github.com/users/pyricau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pyricau/subscriptions","organizations_url":"https://api.github.com/users/pyricau/orgs","repos_url":"https://api.github.com/users/pyricau/repos","events_url":"https://api.github.com/users/pyricau/events{/privacy}","received_events_url":"https://api.github.com/users/pyricau/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/square/leakcanary/issues/comments/520866747","html_url":"https://github.com/square/leakcanary/issues/1532#issuecomment-520866747","issue_url":"https://api.github.com/repos/square/leakcanary/issues/1532","id":520866747,"node_id":"MDEyOklzc3VlQ29tbWVudDUyMDg2Njc0Nw==","user":{"login":"pyricau","id":557033,"node_id":"MDQ6VXNlcjU1NzAzMw==","avatar_url":"https://avatars.githubusercontent.com/u/557033?v=4","gravatar_id":"","url":"https://api.github.com/users/pyricau","html_url":"https://github.com/pyricau","followers_url":"https://api.github.com/users/pyricau/followers","following_url":"https://api.github.com/users/pyricau/following{/other_user}","gists_url":"https://api.github.com/users/pyricau/gists{/gist_id}","starred_url":"https://api.github.com/users/pyricau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pyricau/subscriptions","organizations_url":"https://api.github.com/users/pyricau/orgs","repos_url":"https://api.github.com/users/pyricau/repos","events_url":"https://api.github.com/users/pyricau/events{/privacy}","received_events_url":"https://api.github.com/users/pyricau/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-08-13T14:47:39Z","updated_at":"2019-08-13T14:47:39Z","body":"Also, the size of position can be dynamic, based on the size of the hprof. In this example we'd need 4 bytes. We can store it as unsigned.","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/square/leakcanary/issues/comments/520866747/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"pyricau","id":557033,"node_id":"MDQ6VXNlcjU1NzAzMw==","avatar_url":"https://avatars.githubusercontent.com/u/557033?v=4","gravatar_id":"","url":"https://api.github.com/users/pyricau","html_url":"https://github.com/pyricau","followers_url":"https://api.github.com/users/pyricau/followers","following_url":"https://api.github.com/users/pyricau/following{/other_user}","gists_url":"https://api.github.com/users/pyricau/gists{/gist_id}","starred_url":"https://api.github.com/users/pyricau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pyricau/subscriptions","organizations_url":"https://api.github.com/users/pyricau/orgs","repos_url":"https://api.github.com/users/pyricau/repos","events_url":"https://api.github.com/users/pyricau/events{/privacy}","received_events_url":"https://api.github.com/users/pyricau/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":2553874688,"node_id":"MDE3OlJlbmFtZWRUaXRsZUV2ZW50MjU1Mzg3NDY4OA==","url":"https://api.github.com/repos/square/leakcanary/issues/events/2553874688","actor":{"login":"pyricau","id":557033,"node_id":"MDQ6VXNlcjU1NzAzMw==","avatar_url":"https://avatars.githubusercontent.com/u/557033?v=4","gravatar_id":"","url":"https://api.github.com/users/pyricau","html_url":"https://github.com/pyricau","followers_url":"https://api.github.com/users/pyricau/followers","following_url":"https://api.github.com/users/pyricau/following{/other_user}","gists_url":"https://api.github.com/users/pyricau/gists{/gist_id}","starred_url":"https://api.github.com/users/pyricau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pyricau/subscriptions","organizations_url":"https://api.github.com/users/pyricau/orgs","repos_url":"https://api.github.com/users/pyricau/repos","events_url":"https://api.github.com/users/pyricau/events{/privacy}","received_events_url":"https://api.github.com/users/pyricau/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"renamed","commit_id":null,"commit_url":null,"created_at":"2019-08-13T15:53:27Z","rename":{"from":"Leak analysis failed","to":"Leak analysis failed: OOM"},"performed_via_github_app":null},{"url":"https://api.github.com/repos/square/leakcanary/issues/comments/520912132","html_url":"https://github.com/square/leakcanary/issues/1532#issuecomment-520912132","issue_url":"https://api.github.com/repos/square/leakcanary/issues/1532","id":520912132,"node_id":"MDEyOklzc3VlQ29tbWVudDUyMDkxMjEzMg==","user":{"login":"pyricau","id":557033,"node_id":"MDQ6VXNlcjU1NzAzMw==","avatar_url":"https://avatars.githubusercontent.com/u/557033?v=4","gravatar_id":"","url":"https://api.github.com/users/pyricau","html_url":"https://github.com/pyricau","followers_url":"https://api.github.com/users/pyricau/followers","following_url":"https://api.github.com/users/pyricau/following{/other_user}","gists_url":"https://api.github.com/users/pyricau/gists{/gist_id}","starred_url":"https://api.github.com/users/pyricau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pyricau/subscriptions","organizations_url":"https://api.github.com/users/pyricau/orgs","repos_url":"https://api.github.com/users/pyricau/repos","events_url":"https://api.github.com/users/pyricau/events{/privacy}","received_events_url":"https://api.github.com/users/pyricau/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-08-13T16:40:22Z","updated_at":"2019-08-13T16:40:22Z","body":"Answering some of my prior questions:\r\n\r\n- The hprof is a 32bit hprof\r\n- Opening it in Android Studio bumps the memory by 2Gb, so we're still doing 10x better (side note: that memory in AS never gets reclaimed on closing the heap dump...)\r\n- The first spike and drop happens as we're parsing the heap dump and getting to the end of parsing. Looks like these spikes are due to reading large arrays. We don't use the content of these arrays so that's definitely an optimization target.\r\n- We go from 140 pre enqueing of GC roots to 160Mb~190Mb post enqueuing GC roots and then drops down to 130Mb. Sorting GC roots has no impact, so it looks like it's the enqueuing of 12K GC roots that's using all that memory. Which is weird because when we start polling we immediately reclaim that memory. There are a ton of Java frames and for each java frame we read the thread name. I wonder if we might be constantly reading up thread names (no caching for those currently), when maybe the number of threads is actually small. Worth trying to add a temporary cache there.\r\n","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/square/leakcanary/issues/comments/520912132/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"pyricau","id":557033,"node_id":"MDQ6VXNlcjU1NzAzMw==","avatar_url":"https://avatars.githubusercontent.com/u/557033?v=4","gravatar_id":"","url":"https://api.github.com/users/pyricau","html_url":"https://github.com/pyricau","followers_url":"https://api.github.com/users/pyricau/followers","following_url":"https://api.github.com/users/pyricau/following{/other_user}","gists_url":"https://api.github.com/users/pyricau/gists{/gist_id}","starred_url":"https://api.github.com/users/pyricau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pyricau/subscriptions","organizations_url":"https://api.github.com/users/pyricau/orgs","repos_url":"https://api.github.com/users/pyricau/repos","events_url":"https://api.github.com/users/pyricau/events{/privacy}","received_events_url":"https://api.github.com/users/pyricau/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/square/leakcanary/issues/comments/520915521","html_url":"https://github.com/square/leakcanary/issues/1532#issuecomment-520915521","issue_url":"https://api.github.com/repos/square/leakcanary/issues/1532","id":520915521,"node_id":"MDEyOklzc3VlQ29tbWVudDUyMDkxNTUyMQ==","user":{"login":"pyricau","id":557033,"node_id":"MDQ6VXNlcjU1NzAzMw==","avatar_url":"https://avatars.githubusercontent.com/u/557033?v=4","gravatar_id":"","url":"https://api.github.com/users/pyricau","html_url":"https://github.com/pyricau","followers_url":"https://api.github.com/users/pyricau/followers","following_url":"https://api.github.com/users/pyricau/following{/other_user}","gists_url":"https://api.github.com/users/pyricau/gists{/gist_id}","starred_url":"https://api.github.com/users/pyricau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pyricau/subscriptions","organizations_url":"https://api.github.com/users/pyricau/orgs","repos_url":"https://api.github.com/users/pyricau/repos","events_url":"https://api.github.com/users/pyricau/events{/privacy}","received_events_url":"https://api.github.com/users/pyricau/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-08-13T16:49:35Z","updated_at":"2019-08-13T16:49:35Z","body":"Confirmed that adding a map of thread names removes the spike and memory stays flat when enqueuing GC roots. Nice!","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/square/leakcanary/issues/comments/520915521/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"pyricau","id":557033,"node_id":"MDQ6VXNlcjU1NzAzMw==","avatar_url":"https://avatars.githubusercontent.com/u/557033?v=4","gravatar_id":"","url":"https://api.github.com/users/pyricau","html_url":"https://github.com/pyricau","followers_url":"https://api.github.com/users/pyricau/followers","following_url":"https://api.github.com/users/pyricau/following{/other_user}","gists_url":"https://api.github.com/users/pyricau/gists{/gist_id}","starred_url":"https://api.github.com/users/pyricau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pyricau/subscriptions","organizations_url":"https://api.github.com/users/pyricau/orgs","repos_url":"https://api.github.com/users/pyricau/repos","events_url":"https://api.github.com/users/pyricau/events{/privacy}","received_events_url":"https://api.github.com/users/pyricau/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/square/leakcanary/issues/comments/521071225","html_url":"https://github.com/square/leakcanary/issues/1532#issuecomment-521071225","issue_url":"https://api.github.com/repos/square/leakcanary/issues/1532","id":521071225,"node_id":"MDEyOklzc3VlQ29tbWVudDUyMTA3MTIyNQ==","user":{"login":"pyricau","id":557033,"node_id":"MDQ6VXNlcjU1NzAzMw==","avatar_url":"https://avatars.githubusercontent.com/u/557033?v=4","gravatar_id":"","url":"https://api.github.com/users/pyricau","html_url":"https://github.com/pyricau","followers_url":"https://api.github.com/users/pyricau/followers","following_url":"https://api.github.com/users/pyricau/following{/other_user}","gists_url":"https://api.github.com/users/pyricau/gists{/gist_id}","starred_url":"https://api.github.com/users/pyricau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pyricau/subscriptions","organizations_url":"https://api.github.com/users/pyricau/orgs","repos_url":"https://api.github.com/users/pyricau/repos","events_url":"https://api.github.com/users/pyricau/events{/privacy}","received_events_url":"https://api.github.com/users/pyricau/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-08-14T01:47:52Z","updated_at":"2019-08-14T01:47:52Z","body":"Skipping reading the dynamic content of arrays and classes and instance saves significant allocations and memory while reading (no impact on the baseline though)\r\n\r\nSplitting the index in 4 (one per object type) and replacing the 3 largest indexes with nbyte maps goes from 120,816,776 to 82,604,520, a 32% reduction.\r\n\r\nAnother idea: the load factor is 0.75% which makes sense as the array is growing. However, once done, we might want to rehash to 100% and save the unused space.","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/square/leakcanary/issues/comments/521071225/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"pyricau","id":557033,"node_id":"MDQ6VXNlcjU1NzAzMw==","avatar_url":"https://avatars.githubusercontent.com/u/557033?v=4","gravatar_id":"","url":"https://api.github.com/users/pyricau","html_url":"https://github.com/pyricau","followers_url":"https://api.github.com/users/pyricau/followers","following_url":"https://api.github.com/users/pyricau/following{/other_user}","gists_url":"https://api.github.com/users/pyricau/gists{/gist_id}","starred_url":"https://api.github.com/users/pyricau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pyricau/subscriptions","organizations_url":"https://api.github.com/users/pyricau/orgs","repos_url":"https://api.github.com/users/pyricau/repos","events_url":"https://api.github.com/users/pyricau/events{/privacy}","received_events_url":"https://api.github.com/users/pyricau/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/square/leakcanary/issues/comments/523626354","html_url":"https://github.com/square/leakcanary/issues/1532#issuecomment-523626354","issue_url":"https://api.github.com/repos/square/leakcanary/issues/1532","id":523626354,"node_id":"MDEyOklzc3VlQ29tbWVudDUyMzYyNjM1NA==","user":{"login":"pyricau","id":557033,"node_id":"MDQ6VXNlcjU1NzAzMw==","avatar_url":"https://avatars.githubusercontent.com/u/557033?v=4","gravatar_id":"","url":"https://api.github.com/users/pyricau","html_url":"https://github.com/pyricau","followers_url":"https://api.github.com/users/pyricau/followers","following_url":"https://api.github.com/users/pyricau/following{/other_user}","gists_url":"https://api.github.com/users/pyricau/gists{/gist_id}","starred_url":"https://api.github.com/users/pyricau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pyricau/subscriptions","organizations_url":"https://api.github.com/users/pyricau/orgs","repos_url":"https://api.github.com/users/pyricau/repos","events_url":"https://api.github.com/users/pyricau/events{/privacy}","received_events_url":"https://api.github.com/users/pyricau/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-08-21T20:02:36Z","updated_at":"2019-08-21T20:02:36Z","body":"@nowele-rechka-entercom btw, it looks like there are 161 leaks in this heap dump.. ","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/square/leakcanary/issues/comments/523626354/reactions","total_count":1,"+1":0,"-1":1,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"pyricau","id":557033,"node_id":"MDQ6VXNlcjU1NzAzMw==","avatar_url":"https://avatars.githubusercontent.com/u/557033?v=4","gravatar_id":"","url":"https://api.github.com/users/pyricau","html_url":"https://github.com/pyricau","followers_url":"https://api.github.com/users/pyricau/followers","following_url":"https://api.github.com/users/pyricau/following{/other_user}","gists_url":"https://api.github.com/users/pyricau/gists{/gist_id}","starred_url":"https://api.github.com/users/pyricau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pyricau/subscriptions","organizations_url":"https://api.github.com/users/pyricau/orgs","repos_url":"https://api.github.com/users/pyricau/repos","events_url":"https://api.github.com/users/pyricau/events{/privacy}","received_events_url":"https://api.github.com/users/pyricau/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":2574336507,"node_id":"MDE0Ok1lbnRpb25lZEV2ZW50MjU3NDMzNjUwNw==","url":"https://api.github.com/repos/square/leakcanary/issues/events/2574336507","actor":{"login":"nowele-rechka-entercom","id":50639220,"node_id":"MDQ6VXNlcjUwNjM5MjIw","avatar_url":"https://avatars.githubusercontent.com/u/50639220?v=4","gravatar_id":"","url":"https://api.github.com/users/nowele-rechka-entercom","html_url":"https://github.com/nowele-rechka-entercom","followers_url":"https://api.github.com/users/nowele-rechka-entercom/followers","following_url":"https://api.github.com/users/nowele-rechka-entercom/following{/other_user}","gists_url":"https://api.github.com/users/nowele-rechka-entercom/gists{/gist_id}","starred_url":"https://api.github.com/users/nowele-rechka-entercom/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nowele-rechka-entercom/subscriptions","organizations_url":"https://api.github.com/users/nowele-rechka-entercom/orgs","repos_url":"https://api.github.com/users/nowele-rechka-entercom/repos","events_url":"https://api.github.com/users/nowele-rechka-entercom/events{/privacy}","received_events_url":"https://api.github.com/users/nowele-rechka-entercom/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2019-08-21T20:02:36Z","performed_via_github_app":null},{"id":2574336509,"node_id":"MDE1OlN1YnNjcmliZWRFdmVudDI1NzQzMzY1MDk=","url":"https://api.github.com/repos/square/leakcanary/issues/events/2574336509","actor":{"login":"nowele-rechka-entercom","id":50639220,"node_id":"MDQ6VXNlcjUwNjM5MjIw","avatar_url":"https://avatars.githubusercontent.com/u/50639220?v=4","gravatar_id":"","url":"https://api.github.com/users/nowele-rechka-entercom","html_url":"https://github.com/nowele-rechka-entercom","followers_url":"https://api.github.com/users/nowele-rechka-entercom/followers","following_url":"https://api.github.com/users/nowele-rechka-entercom/following{/other_user}","gists_url":"https://api.github.com/users/nowele-rechka-entercom/gists{/gist_id}","starred_url":"https://api.github.com/users/nowele-rechka-entercom/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nowele-rechka-entercom/subscriptions","organizations_url":"https://api.github.com/users/nowele-rechka-entercom/orgs","repos_url":"https://api.github.com/users/nowele-rechka-entercom/repos","events_url":"https://api.github.com/users/nowele-rechka-entercom/events{/privacy}","received_events_url":"https://api.github.com/users/nowele-rechka-entercom/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2019-08-21T20:02:36Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/square/leakcanary/issues/comments/523644159","html_url":"https://github.com/square/leakcanary/issues/1532#issuecomment-523644159","issue_url":"https://api.github.com/repos/square/leakcanary/issues/1532","id":523644159,"node_id":"MDEyOklzc3VlQ29tbWVudDUyMzY0NDE1OQ==","user":{"login":"nowele-rechka-entercom","id":50639220,"node_id":"MDQ6VXNlcjUwNjM5MjIw","avatar_url":"https://avatars.githubusercontent.com/u/50639220?v=4","gravatar_id":"","url":"https://api.github.com/users/nowele-rechka-entercom","html_url":"https://github.com/nowele-rechka-entercom","followers_url":"https://api.github.com/users/nowele-rechka-entercom/followers","following_url":"https://api.github.com/users/nowele-rechka-entercom/following{/other_user}","gists_url":"https://api.github.com/users/nowele-rechka-entercom/gists{/gist_id}","starred_url":"https://api.github.com/users/nowele-rechka-entercom/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nowele-rechka-entercom/subscriptions","organizations_url":"https://api.github.com/users/nowele-rechka-entercom/orgs","repos_url":"https://api.github.com/users/nowele-rechka-entercom/repos","events_url":"https://api.github.com/users/nowele-rechka-entercom/events{/privacy}","received_events_url":"https://api.github.com/users/nowele-rechka-entercom/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-08-21T20:51:54Z","updated_at":"2019-08-21T20:51:54Z","body":"> @nowele-rechka-entercom btw, it looks like there are 161 leaks in this heap dump..\r\n\r\nWill we be able to get access to that report or should we wait to rerun with the LeakCanary update?","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/square/leakcanary/issues/comments/523644159/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"nowele-rechka-entercom","id":50639220,"node_id":"MDQ6VXNlcjUwNjM5MjIw","avatar_url":"https://avatars.githubusercontent.com/u/50639220?v=4","gravatar_id":"","url":"https://api.github.com/users/nowele-rechka-entercom","html_url":"https://github.com/nowele-rechka-entercom","followers_url":"https://api.github.com/users/nowele-rechka-entercom/followers","following_url":"https://api.github.com/users/nowele-rechka-entercom/following{/other_user}","gists_url":"https://api.github.com/users/nowele-rechka-entercom/gists{/gist_id}","starred_url":"https://api.github.com/users/nowele-rechka-entercom/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nowele-rechka-entercom/subscriptions","organizations_url":"https://api.github.com/users/nowele-rechka-entercom/orgs","repos_url":"https://api.github.com/users/nowele-rechka-entercom/repos","events_url":"https://api.github.com/users/nowele-rechka-entercom/events{/privacy}","received_events_url":"https://api.github.com/users/nowele-rechka-entercom/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":2574468123,"node_id":"MDE0Ok1lbnRpb25lZEV2ZW50MjU3NDQ2ODEyMw==","url":"https://api.github.com/repos/square/leakcanary/issues/events/2574468123","actor":{"login":"nowele-rechka-entercom","id":50639220,"node_id":"MDQ6VXNlcjUwNjM5MjIw","avatar_url":"https://avatars.githubusercontent.com/u/50639220?v=4","gravatar_id":"","url":"https://api.github.com/users/nowele-rechka-entercom","html_url":"https://github.com/nowele-rechka-entercom","followers_url":"https://api.github.com/users/nowele-rechka-entercom/followers","following_url":"https://api.github.com/users/nowele-rechka-entercom/following{/other_user}","gists_url":"https://api.github.com/users/nowele-rechka-entercom/gists{/gist_id}","starred_url":"https://api.github.com/users/nowele-rechka-entercom/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nowele-rechka-entercom/subscriptions","organizations_url":"https://api.github.com/users/nowele-rechka-entercom/orgs","repos_url":"https://api.github.com/users/nowele-rechka-entercom/repos","events_url":"https://api.github.com/users/nowele-rechka-entercom/events{/privacy}","received_events_url":"https://api.github.com/users/nowele-rechka-entercom/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2019-08-21T20:51:54Z","performed_via_github_app":null},{"id":2574468125,"node_id":"MDE1OlN1YnNjcmliZWRFdmVudDI1NzQ0NjgxMjU=","url":"https://api.github.com/repos/square/leakcanary/issues/events/2574468125","actor":{"login":"nowele-rechka-entercom","id":50639220,"node_id":"MDQ6VXNlcjUwNjM5MjIw","avatar_url":"https://avatars.githubusercontent.com/u/50639220?v=4","gravatar_id":"","url":"https://api.github.com/users/nowele-rechka-entercom","html_url":"https://github.com/nowele-rechka-entercom","followers_url":"https://api.github.com/users/nowele-rechka-entercom/followers","following_url":"https://api.github.com/users/nowele-rechka-entercom/following{/other_user}","gists_url":"https://api.github.com/users/nowele-rechka-entercom/gists{/gist_id}","starred_url":"https://api.github.com/users/nowele-rechka-entercom/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nowele-rechka-entercom/subscriptions","organizations_url":"https://api.github.com/users/nowele-rechka-entercom/orgs","repos_url":"https://api.github.com/users/nowele-rechka-entercom/repos","events_url":"https://api.github.com/users/nowele-rechka-entercom/events{/privacy}","received_events_url":"https://api.github.com/users/nowele-rechka-entercom/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2019-08-21T20:51:54Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/square/leakcanary/issues/comments/523704564","html_url":"https://github.com/square/leakcanary/issues/1532#issuecomment-523704564","issue_url":"https://api.github.com/repos/square/leakcanary/issues/1532","id":523704564,"node_id":"MDEyOklzc3VlQ29tbWVudDUyMzcwNDU2NA==","user":{"login":"pyricau","id":557033,"node_id":"MDQ6VXNlcjU1NzAzMw==","avatar_url":"https://avatars.githubusercontent.com/u/557033?v=4","gravatar_id":"","url":"https://api.github.com/users/pyricau","html_url":"https://github.com/pyricau","followers_url":"https://api.github.com/users/pyricau/followers","following_url":"https://api.github.com/users/pyricau/following{/other_user}","gists_url":"https://api.github.com/users/pyricau/gists{/gist_id}","starred_url":"https://api.github.com/users/pyricau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pyricau/subscriptions","organizations_url":"https://api.github.com/users/pyricau/orgs","repos_url":"https://api.github.com/users/pyricau/repos","events_url":"https://api.github.com/users/pyricau/events{/privacy}","received_events_url":"https://api.github.com/users/pyricau/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-08-22T01:01:24Z","updated_at":"2019-08-22T01:01:24Z","body":"You can use Shark CLI directly against the hprof file: https://square.github.io/leakcanary/shark/#shark-cli","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/square/leakcanary/issues/comments/523704564/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"pyricau","id":557033,"node_id":"MDQ6VXNlcjU1NzAzMw==","avatar_url":"https://avatars.githubusercontent.com/u/557033?v=4","gravatar_id":"","url":"https://api.github.com/users/pyricau","html_url":"https://github.com/pyricau","followers_url":"https://api.github.com/users/pyricau/followers","following_url":"https://api.github.com/users/pyricau/following{/other_user}","gists_url":"https://api.github.com/users/pyricau/gists{/gist_id}","starred_url":"https://api.github.com/users/pyricau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pyricau/subscriptions","organizations_url":"https://api.github.com/users/pyricau/orgs","repos_url":"https://api.github.com/users/pyricau/repos","events_url":"https://api.github.com/users/pyricau/events{/privacy}","received_events_url":"https://api.github.com/users/pyricau/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":2576759440,"node_id":"MDE1OlJlZmVyZW5jZWRFdmVudDI1NzY3NTk0NDA=","url":"https://api.github.com/repos/square/leakcanary/issues/events/2576759440","actor":{"login":"pyricau","id":557033,"node_id":"MDQ6VXNlcjU1NzAzMw==","avatar_url":"https://avatars.githubusercontent.com/u/557033?v=4","gravatar_id":"","url":"https://api.github.com/users/pyricau","html_url":"https://github.com/pyricau","followers_url":"https://api.github.com/users/pyricau/followers","following_url":"https://api.github.com/users/pyricau/following{/other_user}","gists_url":"https://api.github.com/users/pyricau/gists{/gist_id}","starred_url":"https://api.github.com/users/pyricau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pyricau/subscriptions","organizations_url":"https://api.github.com/users/pyricau/orgs","repos_url":"https://api.github.com/users/pyricau/repos","events_url":"https://api.github.com/users/pyricau/events{/privacy}","received_events_url":"https://api.github.com/users/pyricau/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"5bb3bf377732ef5c689f69068ce507a801a2310d","commit_url":"https://api.github.com/repos/square/leakcanary/commits/5bb3bf377732ef5c689f69068ce507a801a2310d","created_at":"2019-08-22T14:46:41Z","performed_via_github_app":null},{"actor":{"login":"pyricau","id":557033,"node_id":"MDQ6VXNlcjU1NzAzMw==","avatar_url":"https://avatars.githubusercontent.com/u/557033?v=4","gravatar_id":"","url":"https://api.github.com/users/pyricau","html_url":"https://github.com/pyricau","followers_url":"https://api.github.com/users/pyricau/followers","following_url":"https://api.github.com/users/pyricau/following{/other_user}","gists_url":"https://api.github.com/users/pyricau/gists{/gist_id}","starred_url":"https://api.github.com/users/pyricau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pyricau/subscriptions","organizations_url":"https://api.github.com/users/pyricau/orgs","repos_url":"https://api.github.com/users/pyricau/repos","events_url":"https://api.github.com/users/pyricau/events{/privacy}","received_events_url":"https://api.github.com/users/pyricau/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-08-22T14:46:43Z","updated_at":"2019-08-22T14:46:43Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/square/leakcanary/issues/1543","repository_url":"https://api.github.com/repos/square/leakcanary","labels_url":"https://api.github.com/repos/square/leakcanary/issues/1543/labels{/name}","comments_url":"https://api.github.com/repos/square/leakcanary/issues/1543/comments","events_url":"https://api.github.com/repos/square/leakcanary/issues/1543/events","html_url":"https://github.com/square/leakcanary/pull/1543","id":484039418,"node_id":"MDExOlB1bGxSZXF1ZXN0MzA5OTk4MjI5","number":1543,"title":"Optimize memory usage","user":{"login":"pyricau","id":557033,"node_id":"MDQ6VXNlcjU1NzAzMw==","avatar_url":"https://avatars.githubusercontent.com/u/557033?v=4","gravatar_id":"","url":"https://api.github.com/users/pyricau","html_url":"https://github.com/pyricau","followers_url":"https://api.github.com/users/pyricau/followers","following_url":"https://api.github.com/users/pyricau/following{/other_user}","gists_url":"https://api.github.com/users/pyricau/gists{/gist_id}","starred_url":"https://api.github.com/users/pyricau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pyricau/subscriptions","organizations_url":"https://api.github.com/users/pyricau/orgs","repos_url":"https://api.github.com/users/pyricau/repos","events_url":"https://api.github.com/users/pyricau/events{/privacy}","received_events_url":"https://api.github.com/users/pyricau/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/square/leakcanary/milestones/11","html_url":"https://github.com/square/leakcanary/milestone/11","labels_url":"https://api.github.com/repos/square/leakcanary/milestones/11/labels","id":4542768,"node_id":"MDk6TWlsZXN0b25lNDU0Mjc2OA==","number":11,"title":"2.0-beta-3","description":"","creator":{"login":"pyricau","id":557033,"node_id":"MDQ6VXNlcjU1NzAzMw==","avatar_url":"https://avatars.githubusercontent.com/u/557033?v=4","gravatar_id":"","url":"https://api.github.com/users/pyricau","html_url":"https://github.com/pyricau","followers_url":"https://api.github.com/users/pyricau/followers","following_url":"https://api.github.com/users/pyricau/following{/other_user}","gists_url":"https://api.github.com/users/pyricau/gists{/gist_id}","starred_url":"https://api.github.com/users/pyricau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pyricau/subscriptions","organizations_url":"https://api.github.com/users/pyricau/orgs","repos_url":"https://api.github.com/users/pyricau/repos","events_url":"https://api.github.com/users/pyricau/events{/privacy}","received_events_url":"https://api.github.com/users/pyricau/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":12,"state":"closed","created_at":"2019-08-02T12:26:18Z","updated_at":"2022-04-15T23:59:08Z","due_on":"2019-08-22T07:00:00Z","closed_at":"2019-08-22T23:35:21Z"},"comments":0,"created_at":"2019-08-22T14:46:42Z","updated_at":"2019-08-22T20:13:50Z","closed_at":"2019-08-22T20:13:46Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"draft":false,"repository":{"id":34824499,"node_id":"MDEwOlJlcG9zaXRvcnkzNDgyNDQ5OQ==","name":"leakcanary","full_name":"square/leakcanary","private":false,"owner":{"login":"square","id":82592,"node_id":"MDEyOk9yZ2FuaXphdGlvbjgyNTky","avatar_url":"https://avatars.githubusercontent.com/u/82592?v=4","gravatar_id":"","url":"https://api.github.com/users/square","html_url":"https://github.com/square","followers_url":"https://api.github.com/users/square/followers","following_url":"https://api.github.com/users/square/following{/other_user}","gists_url":"https://api.github.com/users/square/gists{/gist_id}","starred_url":"https://api.github.com/users/square/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/square/subscriptions","organizations_url":"https://api.github.com/users/square/orgs","repos_url":"https://api.github.com/users/square/repos","events_url":"https://api.github.com/users/square/events{/privacy}","received_events_url":"https://api.github.com/users/square/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/square/leakcanary","description":"A memory leak detection library for Android.","fork":false,"url":"https://api.github.com/repos/square/leakcanary","forks_url":"https://api.github.com/repos/square/leakcanary/forks","keys_url":"https://api.github.com/repos/square/leakcanary/keys{/key_id}","collaborators_url":"https://api.github.com/repos/square/leakcanary/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/square/leakcanary/teams","hooks_url":"https://api.github.com/repos/square/leakcanary/hooks","issue_events_url":"https://api.github.com/repos/square/leakcanary/issues/events{/number}","events_url":"https://api.github.com/repos/square/leakcanary/events","assignees_url":"https://api.github.com/repos/square/leakcanary/assignees{/user}","branches_url":"https://api.github.com/repos/square/leakcanary/branches{/branch}","tags_url":"https://api.github.com/repos/square/leakcanary/tags","blobs_url":"https://api.github.com/repos/square/leakcanary/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/square/leakcanary/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/square/leakcanary/git/refs{/sha}","trees_url":"https://api.github.com/repos/square/leakcanary/git/trees{/sha}","statuses_url":"https://api.github.com/repos/square/leakcanary/statuses/{sha}","languages_url":"https://api.github.com/repos/square/leakcanary/languages","stargazers_url":"https://api.github.com/repos/square/leakcanary/stargazers","contributors_url":"https://api.github.com/repos/square/leakcanary/contributors","subscribers_url":"https://api.github.com/repos/square/leakcanary/subscribers","subscription_url":"https://api.github.com/repos/square/leakcanary/subscription","commits_url":"https://api.github.com/repos/square/leakcanary/commits{/sha}","git_commits_url":"https://api.github.com/repos/square/leakcanary/git/commits{/sha}","comments_url":"https://api.github.com/repos/square/leakcanary/comments{/number}","issue_comment_url":"https://api.github.com/repos/square/leakcanary/issues/comments{/number}","contents_url":"https://api.github.com/repos/square/leakcanary/contents/{+path}","compare_url":"https://api.github.com/repos/square/leakcanary/compare/{base}...{head}","merges_url":"https://api.github.com/repos/square/leakcanary/merges","archive_url":"https://api.github.com/repos/square/leakcanary/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/square/leakcanary/downloads","issues_url":"https://api.github.com/repos/square/leakcanary/issues{/number}","pulls_url":"https://api.github.com/repos/square/leakcanary/pulls{/number}","milestones_url":"https://api.github.com/repos/square/leakcanary/milestones{/number}","notifications_url":"https://api.github.com/repos/square/leakcanary/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/square/leakcanary/labels{/name}","releases_url":"https://api.github.com/repos/square/leakcanary/releases{/id}","deployments_url":"https://api.github.com/repos/square/leakcanary/deployments","created_at":"2015-04-29T23:54:16Z","updated_at":"2025-11-10T12:46:59Z","pushed_at":"2025-08-05T05:43:50Z","git_url":"git://github.com/square/leakcanary.git","ssh_url":"git@github.com:square/leakcanary.git","clone_url":"https://github.com/square/leakcanary.git","svn_url":"https://github.com/square/leakcanary","homepage":"https://square.github.io/leakcanary","size":147448,"stargazers_count":29826,"watchers_count":29826,"language":"Kotlin","has_issues":true,"has_projects":false,"has_downloads":true,"has_wiki":false,"has_pages":true,"has_discussions":false,"forks_count":3974,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":144,"license":{"key":"apache-2.0","name":"Apache License 2.0","spdx_id":"Apache-2.0","url":"https://api.github.com/licenses/apache-2.0","node_id":"MDc6TGljZW5zZTI="},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["android","java","kotlin","kotlin-android","leak-canary","leak-trace","leakcanary","memory-leak","outofmemory","outofmemoryerror"],"visibility":"public","forks":3974,"open_issues":144,"watchers":29826,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"pull_request":{"url":"https://api.github.com/repos/square/leakcanary/pulls/1543","html_url":"https://github.com/square/leakcanary/pull/1543","diff_url":"https://github.com/square/leakcanary/pull/1543.diff","patch_url":"https://github.com/square/leakcanary/pull/1543.patch","merged_at":"2019-08-22T20:13:46Z"},"body":"Optimizing for a new provided 160Mb [hprof](https://drive.google.com/open?id=1INEgGwHugZ98VyOpaNexGGvzPznmxi5U) with 2M objects\r\n\r\nHprofHeapGraph went from 136Mb to 40Mb. IndexingTest#indexHprof is now about twice as fast. Parsing of smaller heap dumps slowed down a bit, but it's not noticeable (impacts LeakCanary jvm unit tests by a few seconds).\r\n\r\nChanges:\r\n\r\n* HprofInMemoryIndex.objectIndex split into one index per object type\r\n* Replaced LongObjectScatterMap with SortedByMap for storing the index\r\n  * This is just one giant byte array, split into entries of N bytes where N is split between bytes for keys and bytes for values.\r\n  * Relying on raw bytes means we get rid of object overhead, plus it makes it easy to use the minimal number of bytes necessary (e.g. 32 bits heap dumps only need 4 bytes per object id. Heap dumps size influences the number of bytes needed to store the position of an object in the heap dump file)\r\n  * Using a distinct SortedByMap for each of the 4 object types means N is exactly the number of bytes needed to index that type of object.\r\n  * Using a single byte array for keys and values means we can append keys and values in place as we parse them (in UnsortedBytesMap), and then sort in place, minimizing allocations.\r\n  * To avoid having to reallocate arrays as we parse the heap dump, we run in two passes. The first pass runs fast and computes the exact object counts so that the second pass can allocate arrays at the right size.\r\n  * We don't store the objects contents in the index, so we were unecessarily allocating stack memory for those as we were parsing them. Added new *SkipContentRecord types that skip over the content.\r\n  * Unfortunately the JVM does not provide any API for sorting a byte array in chunks of N bytes. Implementing quicksort is not a good option as heapdumps are often mostly sorted by object id. Copied over [TimSort](https://android.googlesource.com/platform/libcore/+/jb-mr2-release/luni/src/main/java/java/util/TimSort.java) from AOSP (Apache 2), converted it to Kotlin and adapted it (ByteArrayTimSort.kt)\r\n* Added caching of thread names when going through GC roots\r\n\r\nFixes #1532","reactions":{"url":"https://api.github.com/repos/square/leakcanary/issues/1543/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/square/leakcanary/issues/1543/timeline","performed_via_github_app":null,"state_reason":null}},"event":"cross-referenced"},{"id":2577261749,"node_id":"MDE1OlJlZmVyZW5jZWRFdmVudDI1NzcyNjE3NDk=","url":"https://api.github.com/repos/square/leakcanary/issues/events/2577261749","actor":{"login":"pyricau","id":557033,"node_id":"MDQ6VXNlcjU1NzAzMw==","avatar_url":"https://avatars.githubusercontent.com/u/557033?v=4","gravatar_id":"","url":"https://api.github.com/users/pyricau","html_url":"https://github.com/pyricau","followers_url":"https://api.github.com/users/pyricau/followers","following_url":"https://api.github.com/users/pyricau/following{/other_user}","gists_url":"https://api.github.com/users/pyricau/gists{/gist_id}","starred_url":"https://api.github.com/users/pyricau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pyricau/subscriptions","organizations_url":"https://api.github.com/users/pyricau/orgs","repos_url":"https://api.github.com/users/pyricau/repos","events_url":"https://api.github.com/users/pyricau/events{/privacy}","received_events_url":"https://api.github.com/users/pyricau/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"abc2d512183718db16fd2d8374117c9214bb42c8","commit_url":"https://api.github.com/repos/square/leakcanary/commits/abc2d512183718db16fd2d8374117c9214bb42c8","created_at":"2019-08-22T17:28:28Z","performed_via_github_app":null},{"id":2577635162,"node_id":"MDE1OlJlZmVyZW5jZWRFdmVudDI1Nzc2MzUxNjI=","url":"https://api.github.com/repos/square/leakcanary/issues/events/2577635162","actor":{"login":"pyricau","id":557033,"node_id":"MDQ6VXNlcjU1NzAzMw==","avatar_url":"https://avatars.githubusercontent.com/u/557033?v=4","gravatar_id":"","url":"https://api.github.com/users/pyricau","html_url":"https://github.com/pyricau","followers_url":"https://api.github.com/users/pyricau/followers","following_url":"https://api.github.com/users/pyricau/following{/other_user}","gists_url":"https://api.github.com/users/pyricau/gists{/gist_id}","starred_url":"https://api.github.com/users/pyricau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pyricau/subscriptions","organizations_url":"https://api.github.com/users/pyricau/orgs","repos_url":"https://api.github.com/users/pyricau/repos","events_url":"https://api.github.com/users/pyricau/events{/privacy}","received_events_url":"https://api.github.com/users/pyricau/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"93748c8c5ed41fecf3d7ecc99bc004041042ad15","commit_url":"https://api.github.com/repos/square/leakcanary/commits/93748c8c5ed41fecf3d7ecc99bc004041042ad15","created_at":"2019-08-22T19:46:46Z","performed_via_github_app":null},{"id":2577707930,"node_id":"MDExOkNsb3NlZEV2ZW50MjU3NzcwNzkzMA==","url":"https://api.github.com/repos/square/leakcanary/issues/events/2577707930","actor":{"login":"pyricau","id":557033,"node_id":"MDQ6VXNlcjU1NzAzMw==","avatar_url":"https://avatars.githubusercontent.com/u/557033?v=4","gravatar_id":"","url":"https://api.github.com/users/pyricau","html_url":"https://github.com/pyricau","followers_url":"https://api.github.com/users/pyricau/followers","following_url":"https://api.github.com/users/pyricau/following{/other_user}","gists_url":"https://api.github.com/users/pyricau/gists{/gist_id}","starred_url":"https://api.github.com/users/pyricau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pyricau/subscriptions","organizations_url":"https://api.github.com/users/pyricau/orgs","repos_url":"https://api.github.com/users/pyricau/repos","events_url":"https://api.github.com/users/pyricau/events{/privacy}","received_events_url":"https://api.github.com/users/pyricau/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"closed","commit_id":null,"commit_url":null,"created_at":"2019-08-22T20:13:46Z","state_reason":null,"performed_via_github_app":null},{"id":2577708012,"node_id":"MDE1OlJlZmVyZW5jZWRFdmVudDI1Nzc3MDgwMTI=","url":"https://api.github.com/repos/square/leakcanary/issues/events/2577708012","actor":{"login":"pyricau","id":557033,"node_id":"MDQ6VXNlcjU1NzAzMw==","avatar_url":"https://avatars.githubusercontent.com/u/557033?v=4","gravatar_id":"","url":"https://api.github.com/users/pyricau","html_url":"https://github.com/pyricau","followers_url":"https://api.github.com/users/pyricau/followers","following_url":"https://api.github.com/users/pyricau/following{/other_user}","gists_url":"https://api.github.com/users/pyricau/gists{/gist_id}","starred_url":"https://api.github.com/users/pyricau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pyricau/subscriptions","organizations_url":"https://api.github.com/users/pyricau/orgs","repos_url":"https://api.github.com/users/pyricau/repos","events_url":"https://api.github.com/users/pyricau/events{/privacy}","received_events_url":"https://api.github.com/users/pyricau/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"2f5e1fa80ef40f111551c868c32a6a4c717b04a4","commit_url":"https://api.github.com/repos/square/leakcanary/commits/2f5e1fa80ef40f111551c868c32a6a4c717b04a4","created_at":"2019-08-22T20:13:48Z","performed_via_github_app":null}]