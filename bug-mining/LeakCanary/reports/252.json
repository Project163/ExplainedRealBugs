{"url":"https://api.github.com/repos/square/leakcanary/issues/2297","repository_url":"https://api.github.com/repos/square/leakcanary","labels_url":"https://api.github.com/repos/square/leakcanary/issues/2297/labels{/name}","comments_url":"https://api.github.com/repos/square/leakcanary/issues/2297/comments","events_url":"https://api.github.com/repos/square/leakcanary/issues/2297/events","html_url":"https://github.com/square/leakcanary/issues/2297","id":1116873221,"node_id":"I_kwDOAhNhM85CkiIF","number":2297,"title":"Reset weak refs in between tests","user":{"login":"pyricau","id":557033,"node_id":"MDQ6VXNlcjU1NzAzMw==","avatar_url":"https://avatars.githubusercontent.com/u/557033?v=4","gravatar_id":"","url":"https://api.github.com/users/pyricau","html_url":"https://github.com/pyricau","followers_url":"https://api.github.com/users/pyricau/followers","following_url":"https://api.github.com/users/pyricau/following{/other_user}","gists_url":"https://api.github.com/users/pyricau/gists{/gist_id}","starred_url":"https://api.github.com/users/pyricau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pyricau/subscriptions","organizations_url":"https://api.github.com/users/pyricau/orgs","repos_url":"https://api.github.com/users/pyricau/repos","events_url":"https://api.github.com/users/pyricau/events{/privacy}","received_events_url":"https://api.github.com/users/pyricau/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":205873874,"node_id":"MDU6TGFiZWwyMDU4NzM4NzQ=","url":"https://api.github.com/repos/square/leakcanary/labels/type:%20bug","name":"type: bug","color":"fc2929","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/square/leakcanary/milestones/23","html_url":"https://github.com/square/leakcanary/milestone/23","labels_url":"https://api.github.com/repos/square/leakcanary/milestones/23/labels","id":7539052,"node_id":"MI_kwDOAhNhM84Acwls","number":23,"title":"2.9","description":"","creator":{"login":"pyricau","id":557033,"node_id":"MDQ6VXNlcjU1NzAzMw==","avatar_url":"https://avatars.githubusercontent.com/u/557033?v=4","gravatar_id":"","url":"https://api.github.com/users/pyricau","html_url":"https://github.com/pyricau","followers_url":"https://api.github.com/users/pyricau/followers","following_url":"https://api.github.com/users/pyricau/following{/other_user}","gists_url":"https://api.github.com/users/pyricau/gists{/gist_id}","starred_url":"https://api.github.com/users/pyricau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pyricau/subscriptions","organizations_url":"https://api.github.com/users/pyricau/orgs","repos_url":"https://api.github.com/users/pyricau/repos","events_url":"https://api.github.com/users/pyricau/events{/privacy}","received_events_url":"https://api.github.com/users/pyricau/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":20,"state":"closed","created_at":"2022-01-04T09:47:49Z","updated_at":"2022-04-20T13:29:07Z","due_on":null,"closed_at":"2022-04-20T00:49:55Z"},"comments":3,"created_at":"2022-01-28T00:28:08Z","updated_at":"2023-01-24T11:00:22Z","closed_at":"2022-04-19T13:00:14Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"https://github.com/square/workflow-kotlin/pull/632\r\n\r\nLeak:\r\n\r\n```\r\n┬───\r\n│ GC Root: Thread object\r\n│\r\n├─ android.app.Instrumentation$InstrumentationThread instance\r\n│    Leaking: UNKNOWN\r\n│    Retaining 227.7 kB in 4195 objects\r\n│    Thread name: 'Instr: androidx.test.runner.AndroidJUnitRunner'\r\n│    ↓ Instrumentation$InstrumentationThread<Java Local>\r\n│                                           ~~~~~~~~~~~~\r\n├─ org.junit.runner.Result instance\r\n│    Leaking: UNKNOWN\r\n│    Retaining 219.2 kB in 3829 objects\r\n│    ↓ Result.failures\r\n│             ~~~~~~~~\r\n├─ java.util.concurrent.CopyOnWriteArrayList instance\r\n│    Leaking: UNKNOWN\r\n│    Retaining 219.1 kB in 3823 objects\r\n│    ↓ CopyOnWriteArrayList[0]\r\n│                          ~~~\r\n├─ org.junit.runner.notification.Failure instance\r\n│    Leaking: UNKNOWN\r\n│    Retaining 219.1 kB in 3820 objects\r\n│    ↓ Failure.fThrownException\r\n│              ~~~~~~~~~~~~~~~~\r\n├─ androidx.test.espresso.NoMatchingViewException instance\r\n│    Leaking: UNKNOWN\r\n│    Retaining 219.1 kB in 3819 objects\r\n│    ↓ NoMatchingViewException.rootView\r\n│                              ~~~~~~~~\r\n├─ com.android.internal.policy.DecorView instance\r\n│    Leaking: YES (View.mContext references a destroyed activity)\r\n│    Retaining 196.6 kB in 3529 objects\r\n│    View not part of a window view hierarchy\r\n│    View.mAttachInfo is null (view detached)\r\n│    View.mWindowAttachCount = 1\r\n│    mContext instance of android.view.ContextThemeWrapper, wrapping activity com.squareup.sample.mainactivity.TicTacToeActivity with mDestroyed = true\r\n│    ↓ View.mContext\r\n├─ android.view.ContextThemeWrapper instance\r\n│    Leaking: YES (DecorView↑ is leaking and ContextThemeWrapper wraps an Activity with Activity.mDestroyed true)\r\n│    Retaining 32 B in 1 objects\r\n│    mBase instance of com.squareup.sample.mainactivity.TicTacToeActivity with mDestroyed = true\r\n│    ↓ ContextWrapper.mBase\r\n╰→ com.squareup.sample.mainactivity.TicTacToeActivity instance\r\n​     Leaking: YES (ObjectWatcher was watching this because com.squareup.sample.mainactivity.TicTacToeActivity received Activity#onDestroy() callback and Activity#mDestroyed is true)\r\n​     Retaining 7.5 kB in 258 objects\r\n​     key = 11c18440-95d4-4600-bae9-6cab076a1bcd\r\n​     watchDurationMillis = 9186\r\n​     retainedDurationMillis = 4185\r\n​     mApplication instance of android.app.Application\r\n​     mBase instance of androidx.appcompat.view.ContextThemeWrapper\r\n```\r\n\r\nThe InstrumentationThread thread  has a local reference (ie local variable) to a test result which includes failures, and one of these failures is an exception that keeps a reference to the root view. The failing test is the one that runs before the one that we ding as leaking. The previous test fails, so not running the rule. But during the previous test we collect weak refs. Which we probably should clear before we start the next test. We do clear them normallly. when calling assertNoLeak (after running the analysis).\r\n\r\nWe likely want a try finally around evaluate that clears the refs.\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n","closed_by":{"login":"pyricau","id":557033,"node_id":"MDQ6VXNlcjU1NzAzMw==","avatar_url":"https://avatars.githubusercontent.com/u/557033?v=4","gravatar_id":"","url":"https://api.github.com/users/pyricau","html_url":"https://github.com/pyricau","followers_url":"https://api.github.com/users/pyricau/followers","following_url":"https://api.github.com/users/pyricau/following{/other_user}","gists_url":"https://api.github.com/users/pyricau/gists{/gist_id}","starred_url":"https://api.github.com/users/pyricau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pyricau/subscriptions","organizations_url":"https://api.github.com/users/pyricau/orgs","repos_url":"https://api.github.com/users/pyricau/repos","events_url":"https://api.github.com/users/pyricau/events{/privacy}","received_events_url":"https://api.github.com/users/pyricau/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/square/leakcanary/issues/2297/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/square/leakcanary/issues/2297/timeline","performed_via_github_app":null,"state_reason":"completed"}