{"url":"https://api.github.com/repos/square/leakcanary/issues/2268","repository_url":"https://api.github.com/repos/square/leakcanary","labels_url":"https://api.github.com/repos/square/leakcanary/issues/2268/labels{/name}","comments_url":"https://api.github.com/repos/square/leakcanary/issues/2268/comments","events_url":"https://api.github.com/repos/square/leakcanary/issues/2268/events","html_url":"https://github.com/square/leakcanary/issues/2268","id":1094533711,"node_id":"I_kwDOAhNhM85BPUJP","number":2268,"title":"Heap Dump Expedited Work not starting in Android < API31 with LeakCanary 2.8","user":{"login":"dicosta","id":1282215,"node_id":"MDQ6VXNlcjEyODIyMTU=","avatar_url":"https://avatars.githubusercontent.com/u/1282215?v=4","gravatar_id":"","url":"https://api.github.com/users/dicosta","html_url":"https://github.com/dicosta","followers_url":"https://api.github.com/users/dicosta/followers","following_url":"https://api.github.com/users/dicosta/following{/other_user}","gists_url":"https://api.github.com/users/dicosta/gists{/gist_id}","starred_url":"https://api.github.com/users/dicosta/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dicosta/subscriptions","organizations_url":"https://api.github.com/users/dicosta/orgs","repos_url":"https://api.github.com/users/dicosta/repos","events_url":"https://api.github.com/users/dicosta/events{/privacy}","received_events_url":"https://api.github.com/users/dicosta/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":205873874,"node_id":"MDU6TGFiZWwyMDU4NzM4NzQ=","url":"https://api.github.com/repos/square/leakcanary/labels/type:%20bug","name":"type: bug","color":"fc2929","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/square/leakcanary/milestones/24","html_url":"https://github.com/square/leakcanary/milestone/24","labels_url":"https://api.github.com/repos/square/leakcanary/milestones/24/labels","id":7547316,"node_id":"MI_kwDOAhNhM84Acym0","number":24,"title":"2.8.1","description":"","creator":{"login":"pyricau","id":557033,"node_id":"MDQ6VXNlcjU1NzAzMw==","avatar_url":"https://avatars.githubusercontent.com/u/557033?v=4","gravatar_id":"","url":"https://api.github.com/users/pyricau","html_url":"https://github.com/pyricau","followers_url":"https://api.github.com/users/pyricau/followers","following_url":"https://api.github.com/users/pyricau/following{/other_user}","gists_url":"https://api.github.com/users/pyricau/gists{/gist_id}","starred_url":"https://api.github.com/users/pyricau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pyricau/subscriptions","organizations_url":"https://api.github.com/users/pyricau/orgs","repos_url":"https://api.github.com/users/pyricau/repos","events_url":"https://api.github.com/users/pyricau/events{/privacy}","received_events_url":"https://api.github.com/users/pyricau/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":3,"state":"closed","created_at":"2022-01-06T10:23:32Z","updated_at":"2022-04-13T19:31:54Z","due_on":null,"closed_at":"2022-04-13T19:31:54Z"},"comments":6,"created_at":"2022-01-05T16:31:30Z","updated_at":"2022-04-05T15:21:49Z","closed_at":"2022-01-06T12:03:37Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description\r\n\r\nWhen trying to do a 'Dump Heap Now' on an emulator with API30/29, the Work does not start, and and an exception is logged (see the trace in additional information section)\r\n\r\nIf the emulator runs API31, it works fine.\r\nIf I don't include the work-runtime, running an emulator with API30/29, it runs ok (I understand that in this case, the job is being done in a simple Thread) \r\n\r\n### Steps to Reproduce\r\n\r\n1. Open Leaks Screen on an Emulator running Android API29 or API30\r\n2. Go to 'Heap Dumps'\r\n3. Tap on 'Dump Heap Now'\r\n\r\n**Expected behavior:** \r\nThe 'Dump Heap' work to run \r\n\r\n### Version Information\r\n\r\n* LeakCanary version: 2.8\r\n* Android OS version: 11, 10, \r\n* Gradle version: 7.0.2\r\n\r\n### Additional Information\r\n\r\nI think this is related to that Expedited work, when run in an Android version prior to API31, runs in a foreground service, and because of that, the Work should provide foreground info (like the icon and the title) for the notification the system displays when a foreground service is run\r\n\r\nTrace:\r\n\r\n```\r\n2022-01-05 12:38:07.901 4829-4896/com.XXX.XXX.XXX D/LeakCanary: Enqueuing heap analysis for /storage/emulated/0/Download/leakcanary-com.XXX.XXX.XXX/2022-01-05_12-38-04_891.hprof on WorkManager remote worker\r\n2022-01-05 12:38:07.984 4829-4895/com.XXX.XXX.XXX E/WM-WorkerWrapper: Work [ id=xxx, tags={ leakcanary.internal.HeapAnalyzerWorker } ] failed because it threw an exception/error\r\n    java.util.concurrent.ExecutionException: java.util.concurrent.ExecutionException: java.util.concurrent.ExecutionException: java.lang.IllegalStateException: Expedited WorkRequests require a ListenableWorker to provide an implementation for `getForegroundInfoAsync()`\r\n        at androidx.work.impl.utils.futures.AbstractFuture.getDoneValue(AbstractFuture.java:516)\r\n        at androidx.work.impl.utils.futures.AbstractFuture.get(AbstractFuture.java:475)\r\n        at androidx.work.impl.WorkerWrapper$2.run(WorkerWrapper.java:311)\r\n        at androidx.work.impl.utils.SerialExecutor$Task.run(SerialExecutor.java:91)\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1167)\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:641)\r\n        at java.lang.Thread.run(Thread.java:923)\r\n     Caused by: java.util.concurrent.ExecutionException: java.util.concurrent.ExecutionException: java.lang.IllegalStateException: Expedited WorkRequests require a ListenableWorker to provide an implementation for `getForegroundInfoAsync()`\r\n        at androidx.work.impl.utils.futures.AbstractFuture.getDoneValue(AbstractFuture.java:516)\r\n        at androidx.work.impl.utils.futures.AbstractFuture.get(AbstractFuture.java:475)\r\n        at androidx.work.impl.WorkerWrapper$1.run(WorkerWrapper.java:291)\r\n        at android.os.Handler.handleCallback(Handler.java:938)\r\n        at android.os.Handler.dispatchMessage(Handler.java:99)\r\n        at android.os.Looper.loop(Looper.java:223)\r\n        at android.app.ActivityThread.main(ActivityThread.java:7656)\r\n        at java.lang.reflect.Method.invoke(Native Method)\r\n        at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:592)\r\n        at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:947)\r\n     Caused by: java.util.concurrent.ExecutionException: java.lang.IllegalStateException: Expedited WorkRequests require a ListenableWorker to provide an implementation for `getForegroundInfoAsync()`\r\n        at androidx.work.impl.utils.futures.AbstractFuture.getDoneValue(AbstractFuture.java:516)\r\n        at androidx.work.impl.utils.futures.AbstractFuture.get(AbstractFuture.java:475)\r\n        at androidx.work.impl.utils.WorkForegroundRunnable$2.run(WorkForegroundRunnable.java:93)\r\n        at android.os.Handler.handleCallback(Handler.java:938) \r\n        at android.os.Handler.dispatchMessage(Handler.java:99) \r\n        at android.os.Looper.loop(Looper.java:223) \r\n        at android.app.ActivityThread.main(ActivityThread.java:7656) \r\n        at java.lang.reflect.Method.invoke(Native Method) \r\n        at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:592) \r\n        at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:947) \r\n     Caused by: java.lang.IllegalStateException: Expedited WorkRequests require a ListenableWorker to provide an implementation for `getForegroundInfoAsync()`\r\n        at androidx.work.ListenableWorker.getForegroundInfoAsync(ListenableWorker.java:260)\r\n        at androidx.work.impl.utils.WorkForegroundRunnable$1.run(WorkForegroundRunnable.java:85)\r\n        at android.os.Handler.handleCallback(Handler.java:938) \r\n        at android.os.Handler.dispatchMessage(Handler.java:99) \r\n        at android.os.Looper.loop(Looper.java:223) \r\n        at android.app.ActivityThread.main(ActivityThread.java:7656) \r\n        at java.lang.reflect.Method.invoke(Native Method) \r\n        at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:592) \r\n        at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:947) \r\n2022-01-05 12:38:07.985 4829-4895/com.xxxx.xxx.xxx I/WM-WorkerWrapper: Worker result FAILURE for Work [ id=xxx, tags={ leakcanary.internal.HeapAnalyzerWorker } ]\r\n2022-01-05 12:38:07.991 4829-4829/com.xxx.xxx.xxx D/LeakCanary: Watching instance of androidx.work.impl.background.systemjob.SystemJobService (androidx.work.impl.background.systemjob.SystemJobService received Service#onDestroy() callback) with key xxx\r\n```\r\n\r\n\r\n","closed_by":{"login":"pyricau","id":557033,"node_id":"MDQ6VXNlcjU1NzAzMw==","avatar_url":"https://avatars.githubusercontent.com/u/557033?v=4","gravatar_id":"","url":"https://api.github.com/users/pyricau","html_url":"https://github.com/pyricau","followers_url":"https://api.github.com/users/pyricau/followers","following_url":"https://api.github.com/users/pyricau/following{/other_user}","gists_url":"https://api.github.com/users/pyricau/gists{/gist_id}","starred_url":"https://api.github.com/users/pyricau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pyricau/subscriptions","organizations_url":"https://api.github.com/users/pyricau/orgs","repos_url":"https://api.github.com/users/pyricau/repos","events_url":"https://api.github.com/users/pyricau/events{/privacy}","received_events_url":"https://api.github.com/users/pyricau/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/square/leakcanary/issues/2268/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/square/leakcanary/issues/2268/timeline","performed_via_github_app":null,"state_reason":"completed"}