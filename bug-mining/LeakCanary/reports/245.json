{"url":"https://api.github.com/repos/square/leakcanary/issues/2300","repository_url":"https://api.github.com/repos/square/leakcanary","labels_url":"https://api.github.com/repos/square/leakcanary/issues/2300/labels{/name}","comments_url":"https://api.github.com/repos/square/leakcanary/issues/2300/comments","events_url":"https://api.github.com/repos/square/leakcanary/issues/2300/events","html_url":"https://github.com/square/leakcanary/issues/2300","id":1118248486,"node_id":"I_kwDOAhNhM85Cpx4m","number":2300,"title":"Leak in `InputMethodManager`","user":{"login":"fourlastor","id":1263058,"node_id":"MDQ6VXNlcjEyNjMwNTg=","avatar_url":"https://avatars.githubusercontent.com/u/1263058?v=4","gravatar_id":"","url":"https://api.github.com/users/fourlastor","html_url":"https://github.com/fourlastor","followers_url":"https://api.github.com/users/fourlastor/followers","following_url":"https://api.github.com/users/fourlastor/following{/other_user}","gists_url":"https://api.github.com/users/fourlastor/gists{/gist_id}","starred_url":"https://api.github.com/users/fourlastor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fourlastor/subscriptions","organizations_url":"https://api.github.com/users/fourlastor/orgs","repos_url":"https://api.github.com/users/fourlastor/repos","events_url":"https://api.github.com/users/fourlastor/events{/privacy}","received_events_url":"https://api.github.com/users/fourlastor/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":236245157,"node_id":"MDU6TGFiZWwyMzYyNDUxNTc=","url":"https://api.github.com/repos/square/leakcanary/labels/type:%20leak","name":"type: leak","color":"f9ee02","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/square/leakcanary/milestones/23","html_url":"https://github.com/square/leakcanary/milestone/23","labels_url":"https://api.github.com/repos/square/leakcanary/milestones/23/labels","id":7539052,"node_id":"MI_kwDOAhNhM84Acwls","number":23,"title":"2.9","description":"","creator":{"login":"pyricau","id":557033,"node_id":"MDQ6VXNlcjU1NzAzMw==","avatar_url":"https://avatars.githubusercontent.com/u/557033?v=4","gravatar_id":"","url":"https://api.github.com/users/pyricau","html_url":"https://github.com/pyricau","followers_url":"https://api.github.com/users/pyricau/followers","following_url":"https://api.github.com/users/pyricau/following{/other_user}","gists_url":"https://api.github.com/users/pyricau/gists{/gist_id}","starred_url":"https://api.github.com/users/pyricau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pyricau/subscriptions","organizations_url":"https://api.github.com/users/pyricau/orgs","repos_url":"https://api.github.com/users/pyricau/repos","events_url":"https://api.github.com/users/pyricau/events{/privacy}","received_events_url":"https://api.github.com/users/pyricau/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":20,"state":"closed","created_at":"2022-01-04T09:47:49Z","updated_at":"2022-04-20T13:29:07Z","due_on":null,"closed_at":"2022-04-20T00:49:55Z"},"comments":1,"created_at":"2022-01-29T15:28:56Z","updated_at":"2022-04-16T05:08:04Z","closed_at":"2022-04-16T05:08:04Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### LeakTrace information\r\n\r\n```\r\n ┬───\r\n    │ GC Root: System class\r\n    │\r\n    ├─ android.view.inputmethod.InputMethodManager class\r\n    │    Leaking: NO (InputMethodManager↓ is not leaking and a class is never leaking)\r\n    │    ↓ static InputMethodManager.sInstance\r\n    ├─ android.view.inputmethod.InputMethodManager instance\r\n    │    Leaking: NO (InputMethodManager is a singleton)\r\n    │    ↓ InputMethodManager.mCurrentInputConnection\r\n    │                         ~~~~~~~~~~~~~~~~~~~~~~~\r\n    ├─ com.android.internal.widget.EditableInputConnection instance\r\n    │    Leaking: UNKNOWN\r\n    │    Retaining 267.4 kB in 4530 objects\r\n    │    ↓ BaseInputConnection.mTargetView\r\n    │                          ~~~~~~~~~~~\r\n    ├─ com.example.MyEditText instance\r\n    │    Leaking: UNKNOWN\r\n    │    Retaining 267.3 kB in 4528 objects\r\n    │    View not part of a window view hierarchy\r\n    │    View.mAttachInfo is null (view detached)\r\n    │    View.mID = R.id.textInput\r\n    │    View.mWindowAttachCount = 1\r\n    │    mContext instance of dagger.hilt.android.internal.managers.ViewComponentManager$FragmentContextWrapper, wrapping\r\n    │    activity com.example.MyActivity with mDestroyed = false\r\n    │    ↓ View.mListenerInfo\r\n    │           ~~~~~~~~~~~~~\r\n    ├─ android.view.View$ListenerInfo instance\r\n    │    Leaking: UNKNOWN\r\n    │    Retaining 116 B in 3 objects\r\n    │    ↓ View$ListenerInfo.mOnClickListener\r\n    │                        ~~~~~~~~~~~~~~~~\r\n    ├─ com.example.MyFragment$$ExternalSyntheticLambda0 instance\r\n    │    Leaking: UNKNOWN\r\n    │    Retaining 12 B in 1 objects\r\n    │    ↓ MyFragment$$ExternalSyntheticLambda0.f$0\r\n    │                                                  ~~~\r\n    ╰→ com.example.MyFragment instance\r\n    ​     Leaking: YES (ObjectWatcher was watching this because com.example.MyFragment received\r\n    ​     Fragment#onDestroy() callback and Fragment#mFragmentManager is null)\r\n    ​     Retaining 7.0 kB in 223 objects\r\n    ​     key = da743d39-1384-4f37-abd2-cb75c56d7ce2\r\n    ​     watchDurationMillis = 6291\r\n    ​     retainedDurationMillis = 1242\r\n    ​     componentContext instance of dagger.hilt.android.internal.managers.ViewComponentManager$FragmentContextWrapper,\r\n    ​     wrapping activity com.example.MyActivity with mDestroyed = false\r\n    \r\n    METADATA\r\n```\r\n\r\nThis leak seems to happen only on Samsung devices (at least, from my experiments, I tried on a Pixel 3a and didn't happen, while on a few Samsung devices it did). Basically when an edit text field is focused and the activity/fragment gets collected, IMM seems to leak the field (and thus the activity).\r\n\r\nThe device I used most often to reproduce this leak is a **Samsung Galaxy A12, Android version 11 and One UI Core version 3.1**.\r\n\r\nIt seems to have been [already reported](https://issuetracker.google.com/issues/156230908) to AOSP.\r\n\r\nThis seems to be very similar to the leak which is fixed via [`AndroidLeakFixes.IMM_FOCUSED_VIEW`](https://github.com/square/leakcanary/blob/main/plumber-android-core/src/main/java/leakcanary/AndroidLeakFixes.kt#L409) (which fixed [another leak](https://code.google.com/p/android/issues/detail?id=171190) around `InputMethodManager`), but trying to copy-paste the same fix (inverting the android version check) didn't seem to fix the issue (and android linter complained that some of the methods accessed by reflection might throw on API 29+).\r\n\r\nIt can be reproduced reliably via this reproduction repository https://github.com/dmytroKarataiev/TextInputLayout-MemoryLeak\r\n","closed_by":{"login":"pyricau","id":557033,"node_id":"MDQ6VXNlcjU1NzAzMw==","avatar_url":"https://avatars.githubusercontent.com/u/557033?v=4","gravatar_id":"","url":"https://api.github.com/users/pyricau","html_url":"https://github.com/pyricau","followers_url":"https://api.github.com/users/pyricau/followers","following_url":"https://api.github.com/users/pyricau/following{/other_user}","gists_url":"https://api.github.com/users/pyricau/gists{/gist_id}","starred_url":"https://api.github.com/users/pyricau/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pyricau/subscriptions","organizations_url":"https://api.github.com/users/pyricau/orgs","repos_url":"https://api.github.com/users/pyricau/repos","events_url":"https://api.github.com/users/pyricau/events{/privacy}","received_events_url":"https://api.github.com/users/pyricau/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/square/leakcanary/issues/2300/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/square/leakcanary/issues/2300/timeline","performed_via_github_app":null,"state_reason":"completed"}