diff --git a/build.gradle b/build.gradle
index 651eafbd5..6a55c2572 100644
--- a/build.gradle
+++ b/build.gradle
@@ -41,7 +41,7 @@ buildscript {
   }
   dependencies {
     classpath deps.kotlin.gradlePlugin
-    classpath 'com.android.tools.build:gradle:3.4.0'
+    classpath 'com.android.tools.build:gradle:3.4.2'
     classpath 'net.ltgt.gradle:gradle-errorprone-plugin:0.0.16'
     classpath 'com.github.ben-manes:gradle-versions-plugin:0.20.0'
     classpath "org.jetbrains.dokka:dokka-gradle-plugin:0.9.18"
diff --git a/leakcanary-android-core/consumer-proguard-rules.pro b/leakcanary-android-core/consumer-proguard-rules.pro
index 48ffcc287..72f9d6c59 100644
--- a/leakcanary-android-core/consumer-proguard-rules.pro
+++ b/leakcanary-android-core/consumer-proguard-rules.pro
@@ -1,9 +1,6 @@
--dontwarn com.squareup.haha.guava.**
--dontwarn com.squareup.haha.perflib.**
--dontwarn com.squareup.haha.trove.**
--dontwarn com.squareup.leakcanary.**
--keep class com.squareup.haha.** { *; }
--keep class com.squareup.leakcanary.** { *; }
-
+# Loaded via reflection & referenced by shark.AndroidReferenceMatchers.LEAK_CANARY_INTERNAL
+-keep class leakcanary.internal.InternalLeakCanary { *; }
+# Referenced by shark.AndroidReferenceMatchers.LEAK_CANARY_HEAP_DUMPER
+-keep class leakcanary.internal.AndroidHeapDumper { *; }
 # Marshmallow removed Notification.setLatestEventInfo()
 -dontwarn android.app.Notification
diff --git a/leakcanary-android-sample/build.gradle b/leakcanary-android-sample/build.gradle
index ad05c1696..dd517107a 100644
--- a/leakcanary-android-sample/build.gradle
+++ b/leakcanary-android-sample/build.gradle
@@ -37,7 +37,16 @@ android {
   }
 
   buildTypes {
-    debug
+    // Build with ./gradlew leakcanary-android-sample:installDebug -Pminify
+    if (project.hasProperty('minify')) {
+      debug {
+        minifyEnabled true
+        proguardFiles getDefaultProguardFile('proguard-android-optimize.txt')
+      }
+    } else {
+      debug
+    }
+
     release
   }
 
diff --git a/leakcanary-object-watcher-android-androidx/build.gradle b/leakcanary-object-watcher-android-androidx/build.gradle
index ba51c3086..afa37c482 100644
--- a/leakcanary-object-watcher-android-androidx/build.gradle
+++ b/leakcanary-object-watcher-android-androidx/build.gradle
@@ -13,6 +13,7 @@ android {
   compileSdkVersion versions.compileSdk
   defaultConfig {
     minSdkVersion versions.minSdk
+    consumerProguardFiles 'consumer-proguard-rules.pro'
   }
   lintOptions {
     disable 'GoogleAppIndexingWarning'
diff --git a/leakcanary-object-watcher-android-androidx/consumer-proguard-rules.pro b/leakcanary-object-watcher-android-androidx/consumer-proguard-rules.pro
new file mode 100644
index 000000000..7f67c8b27
--- /dev/null
+++ b/leakcanary-object-watcher-android-androidx/consumer-proguard-rules.pro
@@ -0,0 +1,2 @@
+# AndroidXFragmentDestroyWatcher is loaded via reflection
+-keep class leakcanary.internal.AndroidXFragmentDestroyWatcher { *; }
diff --git a/leakcanary-object-watcher-android/build.gradle b/leakcanary-object-watcher-android/build.gradle
index 18fda0be6..2ba1e7b4e 100644
--- a/leakcanary-object-watcher-android/build.gradle
+++ b/leakcanary-object-watcher-android/build.gradle
@@ -12,6 +12,7 @@ android {
 
   defaultConfig {
     minSdkVersion versions.minSdk
+    consumerProguardFiles 'consumer-proguard-rules.pro'
   }
 
   lintOptions {
diff --git a/leakcanary-object-watcher-android/consumer-proguard-rules.pro b/leakcanary-object-watcher-android/consumer-proguard-rules.pro
new file mode 100644
index 000000000..04653f44e
--- /dev/null
+++ b/leakcanary-object-watcher-android/consumer-proguard-rules.pro
@@ -0,0 +1,4 @@
+# A ContentProvider that gets created by Android on startup
+-keep class leakcanary.internal.AppWatcherInstaller { <init>(); }
+# KeyedWeakReference is looked up in the hprof file
+-keep class leakcanary.KeyedWeakReference { *; }
