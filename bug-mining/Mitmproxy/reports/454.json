{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5524","repository_url":"https://api.github.com/repos/mitmproxy/mitmproxy","labels_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5524/labels{/name}","comments_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5524/comments","events_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5524/events","html_url":"https://github.com/mitmproxy/mitmproxy/issues/5524","id":1335540679,"node_id":"I_kwDOAAfumM5PmrvH","number":5524,"title":"Unable to record files properly when in upstream mode. ","user":{"login":"nicovama","id":29952167,"node_id":"MDQ6VXNlcjI5OTUyMTY3","avatar_url":"https://avatars.githubusercontent.com/u/29952167?v=4","gravatar_id":"","url":"https://api.github.com/users/nicovama","html_url":"https://github.com/nicovama","followers_url":"https://api.github.com/users/nicovama/followers","following_url":"https://api.github.com/users/nicovama/following{/other_user}","gists_url":"https://api.github.com/users/nicovama/gists{/gist_id}","starred_url":"https://api.github.com/users/nicovama/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nicovama/subscriptions","organizations_url":"https://api.github.com/users/nicovama/orgs","repos_url":"https://api.github.com/users/nicovama/repos","events_url":"https://api.github.com/users/nicovama/events{/privacy}","received_events_url":"https://api.github.com/users/nicovama/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":466930397,"node_id":"MDU6TGFiZWw0NjY5MzAzOTc=","url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels/kind/triage","name":"kind/triage","color":"006b75","default":false,"description":"Unclassified issues"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2022-08-11T06:47:21Z","updated_at":"2022-11-28T17:58:17Z","closed_at":"2022-11-28T17:58:17Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"#### Problem Description\r\nHi there Mitmproxy community.\r\nEver since I upgraded to mitmproxy 8.0.0 from 7.0.4, I'm unable to record network properly.  Not only do I see the file size is much smaller that it should, but trying to open the file results in an exception. \r\n\r\nUnaware if this issue has been resolved in the latest release of mitmproxy. I know the connections.py file has had issues since the major upgrade , but I'm unable to update to 8.1.0 because I have a dependency on python 3.8.\r\n\r\n#### Steps to reproduce the behavior:\r\n1.  Record a file in upstream mode \r\nEx: `mitmdump -k -v  --mode upstream:proxy.net:3000 --listen-host $IP -p $PORT -w recording.bin`\r\n2.  Open the recording\r\nEx: `mitmdump -k -n -r`\r\n\r\nThis results in the following traceback\r\n```\r\nTraceback (most recent call last):\r\n\r\n  File \"/usr/local/lib/python3.8/site-packages/mitmproxy/addons/readfile.py\", line 71, in doread\r\n    await self.load_flows_from_path(ctx.options.rfile)\r\n\r\n  File \"/usr/local/lib/python3.8/site-packages/mitmproxy/addons/readfile.py\", line 94, in load_flows_from_path\r\n    return await super().load_flows_from_path(path)\r\n\r\n  File \"/usr/local/lib/python3.8/site-packages/mitmproxy/addons/readfile.py\", line 63, in load_flows_from_path\r\n    return await self.load_flows(f)\r\n\r\n  File \"/usr/local/lib/python3.8/site-packages/mitmproxy/addons/readfile.py\", line 45, in load_flows\r\n    for flow in freader.stream():\r\n\r\n  File \"/usr/local/lib/python3.8/site-packages/mitmproxy/io/io.py\", line 48, in stream\r\n    yield FLOW_TYPES[mdata[\"type\"]].from_state(mdata)\r\n\r\n  File \"/usr/local/lib/python3.8/site-packages/mitmproxy/flow.py\", line 165, in from_state\r\n    f.set_state(state)\r\n\r\n  File \"/usr/local/lib/python3.8/site-packages/mitmproxy/flow.py\", line 160, in set_state\r\n    super().set_state(state)\r\n\r\n  File \"/usr/local/lib/python3.8/site-packages/mitmproxy/stateobject.py\", line 47, in set_state\r\n    setattr(self, attr, make_object(cls, val))\r\n\r\n  File \"/usr/local/lib/python3.8/site-packages/mitmproxy/stateobject.py\", line 94, in make_object\r\n    return _process(typeinfo, val, True)\r\n\r\n  File \"/usr/local/lib/python3.8/site-packages/mitmproxy/stateobject.py\", line 56, in _process\r\n    return typeinfo.from_state(val)\r\n\r\n  File \"/usr/local/lib/python3.8/site-packages/mitmproxy/connection.py\", line 331, in from_state\r\n    server.set_state(state)\r\n\r\n  File \"/usr/local/lib/python3.8/site-packages/mitmproxy/connection.py\", line 353, in set_state\r\n    self.via = state[\"via2\"]\r\n\r\n  File \"/usr/local/lib/python3.8/site-packages/mitmproxy/connection.py\", line 299, in __setattr__\r\n    raise RuntimeError(f\"Cannot change server.{name} on open connection.\")\r\n\r\nRuntimeError: Cannot change server.via on open connection.\r\n```\r\n\r\n#### System Information\r\nPaste the output of \"mitmproxy --version\" here.\r\nmitmproxy --version\r\n```\r\nMitmproxy: 8.0.0\r\nPython:    3.8.11\r\nOpenSSL:   OpenSSL 1.1.1n  15 Mar 2022\r\nPlatform:  Linux\r\n```","closed_by":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5524/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5524/timeline","performed_via_github_app":null,"state_reason":"completed"}