{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/7457","repository_url":"https://api.github.com/repos/mitmproxy/mitmproxy","labels_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/7457/labels{/name}","comments_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/7457/comments","events_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/7457/events","html_url":"https://github.com/mitmproxy/mitmproxy/issues/7457","id":2773791939,"node_id":"I_kwDOAAfumM6lVLTD","number":7457,"title":"Streamline filter expression case-sensitivity","user":{"login":"jwadolowski","id":6334715,"node_id":"MDQ6VXNlcjYzMzQ3MTU=","avatar_url":"https://avatars.githubusercontent.com/u/6334715?v=4","gravatar_id":"","url":"https://api.github.com/users/jwadolowski","html_url":"https://github.com/jwadolowski","followers_url":"https://api.github.com/users/jwadolowski/followers","following_url":"https://api.github.com/users/jwadolowski/following{/other_user}","gists_url":"https://api.github.com/users/jwadolowski/gists{/gist_id}","starred_url":"https://api.github.com/users/jwadolowski/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jwadolowski/subscriptions","organizations_url":"https://api.github.com/users/jwadolowski/orgs","repos_url":"https://api.github.com/users/jwadolowski/repos","events_url":"https://api.github.com/users/jwadolowski/events{/privacy}","received_events_url":"https://api.github.com/users/jwadolowski/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":79336545,"node_id":"MDU6TGFiZWw3OTMzNjU0NQ==","url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels/kind/feature","name":"kind/feature","color":"207de5","default":false,"description":"New features / enhancements"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2025-01-07T21:39:29Z","updated_at":"2025-01-29T19:06:37Z","closed_at":"2025-01-29T19:06:37Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Problem description\r\n\r\nThis is an idea proposed by @mhils in #7450 to fix filter expression inconsistencies when it comes to `re`'s case-sensitivity. At the time of writing `~u`, `~m` and `~d` use `re.IGNORECASE`  flag (see [flowfilter.py](https://github.com/mitmproxy/mitmproxy/blob/v11.0.2/mitmproxy/flowfilter.py)). Other filters like `~hq` or `~bq` don't use that which effectively translates to the following:\r\n\r\n- both `~u example.com` and `~u EXAMPLE.COM` work exactly the same (the regex is treated as case-**insensitive**)\r\n- `~hq Host:` and `~hq host:` are case-**sensitive** - a request with `Host: example.org` header matches to the first filter, but not to the second one\r\n\r\nIt's my gut feeling rather than data-backed fact, but in vast majority of cases case-insensitive matching is expected.\r\n\r\n## Proposal\r\n\r\nAll relevant filter operators should use case-insensitive matching by default to make things consistent.\r\n\r\n1. Identify for which filter operators default `re.IGNORECASE` flag makes sense and apply the change accordingly\r\n2. Implement a global option (e.g. an env variable or config parameter) that disables the `re.IGNORECASE` flag, so case-sensitive filter expressions can be used (e.g. _\"I'd like to block access to `example.com/FOO`, but leave `example.com/foo` unaffected\"_)\r\n3. Add relevant test cases to cover new behaviour\r\n\r\n## Alternatives\r\n\r\nInstead of global \"disable case-insensitive matching\" flag it'd be great to control case-sensitivity per each instance filter expression. Most likely, that'd imply a change of filter expression format which sounds like a breaking change to me.\r\n\r\n## Additional context\r\n\r\n- original discussion: #7450\r\n- according to [RFC 9110](https://www.rfc-editor.org/rfc/rfc9110.html) header names are case-insensitive and should be treated as such. Nevertheless, client can send them in upper- or mixed-case\r\n- as stated in [RFC 7540](https://www.rfc-editor.org/rfc/rfc7540#section-8.1.2) (which describes HTTP/2): _\"(...) header field names MUST be converted to lowercase prior to their encoding in HTTP/2. A request or response containing uppercase header field names MUST be treated as malformed\"_. Header lowercasing is not mandatory for HTTP/1.1 clients though.\r\n","closed_by":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/7457/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/7457/timeline","performed_via_github_app":null,"state_reason":"completed"}