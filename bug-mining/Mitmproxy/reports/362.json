{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/3987","repository_url":"https://api.github.com/repos/mitmproxy/mitmproxy","labels_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/3987/labels{/name}","comments_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/3987/comments","events_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/3987/events","html_url":"https://github.com/mitmproxy/mitmproxy/issues/3987","id":614904724,"node_id":"MDU6SXNzdWU2MTQ5MDQ3MjQ=","number":3987,"title":"Version detection mistakes an unrelated parent git repository as its own","user":{"login":"JustAnotherArchivist","id":29556373,"node_id":"MDQ6VXNlcjI5NTU2Mzcz","avatar_url":"https://avatars.githubusercontent.com/u/29556373?v=4","gravatar_id":"","url":"https://api.github.com/users/JustAnotherArchivist","html_url":"https://github.com/JustAnotherArchivist","followers_url":"https://api.github.com/users/JustAnotherArchivist/followers","following_url":"https://api.github.com/users/JustAnotherArchivist/following{/other_user}","gists_url":"https://api.github.com/users/JustAnotherArchivist/gists{/gist_id}","starred_url":"https://api.github.com/users/JustAnotherArchivist/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JustAnotherArchivist/subscriptions","organizations_url":"https://api.github.com/users/JustAnotherArchivist/orgs","repos_url":"https://api.github.com/users/JustAnotherArchivist/repos","events_url":"https://api.github.com/users/JustAnotherArchivist/events{/privacy}","received_events_url":"https://api.github.com/users/JustAnotherArchivist/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":174959532,"node_id":"MDU6TGFiZWwxNzQ5NTk1MzI=","url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels/help%20wanted","name":"help wanted","color":"fbca04","default":true,"description":null},{"id":429899749,"node_id":"MDU6TGFiZWw0Mjk4OTk3NDk=","url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels/area/core","name":"area/core","color":"fef2c0","default":false,"description":null},{"id":943316112,"node_id":"MDU6TGFiZWw5NDMzMTYxMTI=","url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels/kind/ux","name":"kind/ux","color":"0e8a16","default":false,"description":"User experience improvements"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2020-05-08T18:22:56Z","updated_at":"2020-06-19T15:34:23Z","closed_at":"2020-06-19T15:34:23Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"#### Problem Description\r\nI use <https://github.com/pyenv/pyenv> for Python version and venv management. It's generally installed as a `git clone` and keeps the actual installations and venvs in some deep directories beneath itself. So in a typical setup, you will have a clone of pyenv's repository in `~/.pyenv`, and then if you install mitmproxy in some venv managed by pyenv, its files end up in e.g. `~/.pyenv/versions/3.8.2/envs/mitmproxy/lib/python3.8/site-packages/mitmproxy/`. Because mitmproxy's version detection uses `git describe` and some parent of this directory (namely, `~/.pyenv`) is indeed a git repository, it thinks that this is a dev installation and includes that information in its version output if appropriate, i.e. if there were commits since the last tag in that repo.\r\n\r\n#### Steps to reproduce the behavior:\r\nAny git repository higher in the hierarchy than where mitmproxy's files are located would work, but a typical pyenv setup can be reproduced as follows:\r\n\r\n1. Install pyenv at some commit that is not tagged. The example below is based on https://github.com/pyenv/pyenv/commit/a8ca63fcc0d6b470e2d5fc18fb85fad90efd4a59, which is two commits ahead of the previous tag v1.2.17. Further, install at least one Python version (I'll assume 3.8.2 below). The installation can be somewhat complicated as various dependencies are required for compiling Python, so I shall not give details about that here. [Here](https://github.com/pyenv/pyenv#installation)'s the starting point for instructions.\r\n2. Install [pyenv-virtualenv](https://github.com/pyenv/pyenv-virtualenv) for virtual environment management; I believe this step is optional for this particular issue, but it greatly simplifies things when using pyenv normally and is a common setup.\r\n3. Install mitmproxy in pyenv: `pyenv virtualenv 3.8.2 mitmproxy && pyenv shell mitmproxy && pip install mitmproxy`\r\n4.\r\n```\r\n$ mitmproxy --version\r\nMitmproxy: 5.1.1 (+2, commit a8ca63f)\r\n```\r\n\r\nI have not tried it, but it should be possible to reproduce the same issue by installing mitmproxy in a venv in a directory that is somewhere beneath a git repository.\r\n\r\n#### Possible solution\r\nThe `GIT_CEILING_DIRECTORIES` environment variable can be used to limit how far up the directory tree `git` will recurse. For example,\r\n\r\n    GIT_CEILING_DIRECTORIES=\"$(cd .. && pwd)\" git describe\r\n\r\nwould not recurse past the parent directory when attempting to find a git repository. Note that this has to contain absolute paths, so `GIT_CEILING_DIRECTORIES=../..` or similar will not work.\r\n\r\nHowever, even with the strictest `GIT_CEILING_DIRECTORIES` value imaginable, this still doesn't cover the case where the mitmproxy directory is directly inside some unrelated repository (e.g. if someone were to version-control their `site-packages` directory), since that's the structure used in the actual mitmproxy repository.\r\n\r\n#### System Information\r\n```\r\n$ mitmproxy --version\r\nMitmproxy: 5.1.1 (+2, commit a8ca63f)\r\nPython:    3.8.2\r\nOpenSSL:   OpenSSL 1.1.1g  21 Apr 2020\r\nPlatform:  Linux-5.6.0-1-amd64-x86_64-with-glibc2.29\r\n```","closed_by":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/3987/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/3987/timeline","performed_via_github_app":null,"state_reason":"completed"}