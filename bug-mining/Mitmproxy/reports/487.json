{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5064","repository_url":"https://api.github.com/repos/mitmproxy/mitmproxy","labels_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5064/labels{/name}","comments_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5064/comments","events_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5064/events","html_url":"https://github.com/mitmproxy/mitmproxy/issues/5064","id":1104900332,"node_id":"I_kwDOAAfumM5B23Ds","number":5064,"title":"Allow Server SNI Interrogation in Transparent Mode","user":{"login":"ericdraken","id":22000765,"node_id":"MDQ6VXNlcjIyMDAwNzY1","avatar_url":"https://avatars.githubusercontent.com/u/22000765?v=4","gravatar_id":"","url":"https://api.github.com/users/ericdraken","html_url":"https://github.com/ericdraken","followers_url":"https://api.github.com/users/ericdraken/followers","following_url":"https://api.github.com/users/ericdraken/following{/other_user}","gists_url":"https://api.github.com/users/ericdraken/gists{/gist_id}","starred_url":"https://api.github.com/users/ericdraken/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ericdraken/subscriptions","organizations_url":"https://api.github.com/users/ericdraken/orgs","repos_url":"https://api.github.com/users/ericdraken/repos","events_url":"https://api.github.com/users/ericdraken/events{/privacy}","received_events_url":"https://api.github.com/users/ericdraken/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":79336545,"node_id":"MDU6TGFiZWw3OTMzNjU0NQ==","url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels/kind/feature","name":"kind/feature","color":"207de5","default":false,"description":"New features / enhancements"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2022-01-16T00:20:57Z","updated_at":"2024-07-05T22:23:37Z","closed_at":"2024-07-05T22:19:56Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"#### Problem Description\r\n\r\nThe sever SNI is not added to the array of hostnames checked against `ignored-hosts` and `allowed-hosts` in `next_layer.py` so some requests get past the respective filters.\r\n\r\n#### Proposal\r\n\r\nHere is a patch I currently use myself that I'd like to share (7.0.4):\r\n\r\n```diff\r\nIndex: venv/lib/python3.8/site-packages/mitmproxy/addons/next_layer.py\r\nIDEA additional info:\r\nSubsystem: com.intellij.openapi.diff.impl.patch.CharsetEP\r\n<+>UTF-8\r\n===================================================================\r\ndiff --git a/usr/local/lib/python3.8/site-packages/mitmproxy/addons/next_layer.py b/usr/local/lib/python3.8/site-packages/mitmproxy/addons/next_layer.py\r\n--- a/usr/local/lib/python3.8/site-packages/mitmproxy/addons/next_layer.py  (date 1641187083049)\r\n+++ b/usr/local/lib/python3.8/site-packages/mitmproxy/addons/next_layer.py  (date 1641187083049)\r\n@@ -59,7 +59,7 @@\r\n                 re.compile(x, re.IGNORECASE) for x in ctx.options.allow_hosts\r\n             ]\r\n \r\n-    def ignore_connection(self, server_address: Optional[connection.Address], data_client: bytes) -> Optional[bool]:\r\n+    def ignore_connection(self, server: Optional[connection.Server], data_client: bytes) -> Optional[bool]:\r\n         \"\"\"\r\n         Returns:\r\n             True, if the connection should be ignored.\r\n@@ -70,8 +70,11 @@\r\n             return False\r\n \r\n         hostnames: List[str] = []\r\n-        if server_address is not None:\r\n-            hostnames.append(server_address[0])\r\n+        if server is not None:\r\n+            if server.address is not None:\r\n+                hostnames.append(server.address[0])\r\n+            if server.sni is not None:\r\n+                hostnames.append(server.sni)\r\n         if is_tls_record_magic(data_client):\r\n             try:\r\n                 ch = parse_client_hello(data_client)\r\n@@ -122,7 +125,7 @@\r\n             return stack_match(context, layers)\r\n \r\n         # 1. check for --ignore/--allow\r\n-        ignore = self.ignore_connection(context.server.address, data_client)\r\n+        ignore = self.ignore_connection(context.server, data_client)\r\n         if ignore is True:\r\n             return layers.TCPLayer(context, ignore=True)\r\n         if ignore is None:\r\n```\r\n\r\n#### Alternatives\r\nN/A\r\n\r\n#### Additional context\r\n\r\nHere is a write-up I made about why this patch is needed: https://ericdraken.com/pfsense-decrypt-ad-traffic/#patch\r\n","closed_by":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5064/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5064/timeline","performed_via_github_app":null,"state_reason":"completed"}