{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/773","repository_url":"https://api.github.com/repos/mitmproxy/mitmproxy","labels_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/773/labels{/name}","comments_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/773/comments","events_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/773/events","html_url":"https://github.com/mitmproxy/mitmproxy/issues/773","id":107076621,"node_id":"MDU6SXNzdWUxMDcwNzY2MjE=","number":773,"title":"crash of mitmdump as result of bad cookie","user":{"login":"ghost","id":10137,"node_id":"MDQ6VXNlcjEwMTM3","avatar_url":"https://avatars.githubusercontent.com/u/10137?v=4","gravatar_id":"","url":"https://api.github.com/users/ghost","html_url":"https://github.com/ghost","followers_url":"https://api.github.com/users/ghost/followers","following_url":"https://api.github.com/users/ghost/following{/other_user}","gists_url":"https://api.github.com/users/ghost/gists{/gist_id}","starred_url":"https://api.github.com/users/ghost/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ghost/subscriptions","organizations_url":"https://api.github.com/users/ghost/orgs","repos_url":"https://api.github.com/users/ghost/repos","events_url":"https://api.github.com/users/ghost/events{/privacy}","received_events_url":"https://api.github.com/users/ghost/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":79336502,"node_id":"MDU6TGFiZWw3OTMzNjUwMg==","url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels/kind/bug","name":"kind/bug","color":"d93f0b","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/milestones/9","html_url":"https://github.com/mitmproxy/mitmproxy/milestone/9","labels_url":"https://api.github.com/repos/mitmproxy/mitmproxy/milestones/9/labels","id":1309453,"node_id":"MDk6TWlsZXN0b25lMTMwOTQ1Mw==","number":9,"title":"0.14","description":"","creator":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":11,"state":"closed","created_at":"2015-09-16T23:32:36Z","updated_at":"2015-12-12T15:26:52Z","due_on":null,"closed_at":"2015-11-18T13:09:09Z"},"comments":2,"created_at":"2015-09-17T21:21:57Z","updated_at":"2015-09-28T12:55:27Z","closed_at":"2015-09-28T12:55:27Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**What's the problem?**\nI recently see mitmdump crashing with errors like \n\n```\nTraceback (most recent call last):\n  File \"/usr/local/lib/python2.7/dist-packages/libmproxy/proxy/server.py\", line 120, in handle\n    root_layer()\n  File \"/usr/local/lib/python2.7/dist-packages/libmproxy/proxy/modes/transparent_proxy.py\", line 21, in __call__\n    layer()\n  File \"/usr/local/lib/python2.7/dist-packages/libmproxy/protocol/tls.py\", line 273, in __call__\n    layer()\nTypeError: 'NoneType' object is not callable\n\nmitmproxy has crashed!Traceback (most recent call last):\n  File \"/usr/local/lib/python2.7/dist-packages/libmproxy/proxy/server.py\", line 120, in handle\n    root_layer()\n  File \"/usr/local/lib/python2.7/dist-packages/libmproxy/proxy/modes/transparent_proxy.py\", line 21, in __call__\n    layer()\nTypeError: 'NoneType' object is not callable\n\nTraceback (most recent call last):\n  File \"/usr/local/lib/python2.7/dist-packages/libmproxy/proxy/server.py\", line 120, in handle\n    root_layer()\n  File \"/usr/local/lib/python2.7/dist-packages/libmproxy/proxy/modes/transparent_proxy.py\", line 21, in __call__\n    layer()\n  File \"/usr/local/lib/python2.7/dist-packages/libmproxy/protocol/tls.py\", line 273, in __call__\n    layer()\nTypeError: 'NoneType' object is not callable\nmitmproxy has crashed!\nmitmproxy has crashed!\n\nPlease lodge a bug report at: https://github.com/mitmproxy/mitmproxyPlease lodge a bug report at: https://github.com/mitmproxy/mitmproxy\n\n\nPlease lodge a bug report at: https://github.com/mitmproxy/mitmproxy\nTraceback (most recent call last):\n  File \"/usr/local/lib/python2.7/dist-packages/libmproxy/proxy/server.py\", line 120, in handle\n    root_layer()\n  File \"/usr/local/lib/python2.7/dist-packages/libmproxy/proxy/modes/transparent_proxy.py\", line 21, in __call__\n    layer()\n  File \"/usr/local/lib/python2.7/dist-packages/libmproxy/protocol/tls.py\", line 273, in __call__\n    layer()\n  File \"/usr/local/lib/python2.7/dist-packages/libmproxy/protocol/http.py\", line 162, in __call__\n    layer()\n  File \"/usr/local/lib/python2.7/dist-packages/libmproxy/protocol/http.py\", line 367, in __call__\n    self.get_response_from_server(flow)\n  File \"/usr/local/lib/python2.7/dist-packages/libmproxy/protocol/http.py\", line 485, in get_response_from_server\n    if flow.response.stream:\nAttributeError: 'NoneType' object has no attribute 'response'\n[...]\n\nmitmproxy has crashed!\nPlease lodge a bug report at: https://github.com/mitmproxy/mitmproxy\nTraceback (most recent call last):\n  File \"/usr/local/bin/mitmdump\", line 3, in <module>\n    mitmdump()\n  File \"/usr/local/lib/python2.7/dist-packages/libmproxy/main.py\", line 99, in mitmdump\n    master.run()\n  File \"/usr/local/lib/python2.7/dist-packages/libmproxy/dump.py\", line 342, in run\n    return flow.FlowMaster.run(self)\n  File \"/usr/local/lib/python2.7/dist-packages/libmproxy/controller.py\", line 122, in run\n    self.tick(self.masterq, 0.1)\n  File \"/usr/local/lib/python2.7/dist-packages/libmproxy/flow.py\", line 821, in tick\n\n  File \"/usr/local/lib/python2.7/dist-packages/libmproxy/controller.py\", line 108, in tick\n    self.handle(*msg)\n  File \"/usr/local/lib/python2.7/dist-packages/libmproxy/controller.py\", line 129, in handle\n    m(obj)\n  File \"/usr/local/lib/python2.7/dist-packages/libmproxy/dump.py\", line 314, in handle_request\n    flow.FlowMaster.handle_request(self, f)\n  File \"/usr/local/lib/python2.7/dist-packages/libmproxy/flow.py\", line 1003, in handle_request\n    return f\n  File \"/usr/local/lib/python2.7/dist-packages/libmproxy/flow.py\", line 914, in process_new_request\n    if not pb:\n  File \"/usr/local/lib/python2.7/dist-packages/libmproxy/flow.py\", line 801, in do_server_playback\n    flow.reply(response)\n  File \"/usr/local/lib/python2.7/dist-packages/libmproxy/models/http.py\", line 396, in refresh\n    c.append(self._refresh_cookie(i, delta))\n  File \"/usr/local/lib/python2.7/dist-packages/libmproxy/models/http.py\", line 355, in _refresh_cookie\n    c = Cookie.SimpleCookie(str(c))\n  File \"/usr/lib/python2.7/Cookie.py\", line 576, in __init__\n    if input: self.load(input)\n  File \"/usr/lib/python2.7/Cookie.py\", line 629, in load\n    self.__ParseString(rawdata)\n  File \"/usr/lib/python2.7/Cookie.py\", line 662, in __ParseString\n    self.__set(K, rval, cval)\n  File \"/usr/lib/python2.7/Cookie.py\", line 582, in __set\n    M.set(key, real_value, coded_value)\n  File \"/usr/lib/python2.7/Cookie.py\", line 457, in set\n    raise CookieError(\"Illegal key value: %s\" % key)\nCookie.CookieError: Illegal key value: f_?RK<\nTraceback (most recent call last):\n  File \"/usr/local/lib/python2.7/dist-packages/libmproxy/proxy/server.py\", line 120, in handle\n    root_layer()\n  File \"/usr/local/lib/python2.7/dist-packages/libmproxy/proxy/modes/transparent_proxy.py\", line 21, in __call__\n    layer()\n  File \"/usr/local/lib/python2.7/dist-packages/libmproxy/protocol/tls.py\", line 273, in __call__\n    layer()\n  File \"/usr/local/lib/python2.7/dist-packages/libmproxy/protocol/http.py\", line 162, in __call__\n    layer()\n  File \"/usr/local/lib/python2.7/dist-packages/libmproxy/protocol/http.py\", line 367, in __call__\n    self.get_response_from_server(flow)\n  File \"/usr/local/lib/python2.7/dist-packages/libmproxy/protocol/http.py\", line 485, in get_response_from_server\n    if flow.response.stream:\nAttributeError: 'NoneType' object has no attribute 'response'\n[...]\n```\n\n**What's expected?**\nmitmdump should not crash but handle the problem.\n\n**Which versions are affected?**\nThe master version of mitmdump from yesterday was used.\n\n**How to reproduce the problem?**\nI'm sorry but I do not know exactly how to produce this. I think it should be enough to set up a small server, e.g. with python, that sends a \"bad\" cookie. Now running mitmdump as a transparent proxy and capturing the data. Afterwards the crash should occur at the replay. But I had not the time to test this.\n\n**Why does this happen?**\nIn my captured files there seems to be a bad cookie from `match.rtbidder.net/match?[...]`. I do not know if this is against any convention but it crashed mitmdump as a result of a Cookie.CookieError.\nAfter modifying mitmdump to log every Cookie in libmproxy/models/http.py `_refresh_cookie`, it was clear that the following shortened line lead to the error:\n`uid=Kfyl<1f>]f_?RK<=x__<5/C#j>/KP8>=[...]mC72; path=/; domain=.rtbidder.net; expires=Thu, 15-Sep-2016 [...]`\n\n**How could the problem be solved?**\nI modified `_refresh_cookie` in a way that everything expect the return is covered by a try except block for Cookie.CookieError. If the error occurs the original parameter `str(c).strip()` is returned. I know that the expiration time is not modified but I thought this is better than a crash.\n","closed_by":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/773/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/773/timeline","performed_via_github_app":null,"state_reason":"completed"}