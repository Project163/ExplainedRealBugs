{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5108","repository_url":"https://api.github.com/repos/mitmproxy/mitmproxy","labels_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5108/labels{/name}","comments_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5108/comments","events_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5108/events","html_url":"https://github.com/mitmproxy/mitmproxy/issues/5108","id":1122872252,"node_id":"I_kwDOAAfumM5C7au8","number":5108,"title":"Wait for connection hooks to finish before calling HTTP hooks","user":{"login":"Prinzhorn","id":679144,"node_id":"MDQ6VXNlcjY3OTE0NA==","avatar_url":"https://avatars.githubusercontent.com/u/679144?v=4","gravatar_id":"","url":"https://api.github.com/users/Prinzhorn","html_url":"https://github.com/Prinzhorn","followers_url":"https://api.github.com/users/Prinzhorn/followers","following_url":"https://api.github.com/users/Prinzhorn/following{/other_user}","gists_url":"https://api.github.com/users/Prinzhorn/gists{/gist_id}","starred_url":"https://api.github.com/users/Prinzhorn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Prinzhorn/subscriptions","organizations_url":"https://api.github.com/users/Prinzhorn/orgs","repos_url":"https://api.github.com/users/Prinzhorn/repos","events_url":"https://api.github.com/users/Prinzhorn/events{/privacy}","received_events_url":"https://api.github.com/users/Prinzhorn/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":79336545,"node_id":"MDU6TGFiZWw3OTMzNjU0NQ==","url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels/kind/feature","name":"kind/feature","color":"207de5","default":false,"description":"New features / enhancements"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-02-03T09:54:47Z","updated_at":"2022-02-04T13:49:57Z","closed_at":"2022-02-04T13:49:57Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"#### Problem Description\r\n\r\nThis issue is in response to your comment https://github.com/mitmproxy/mitmproxy/issues/4207#issuecomment-907014592\r\n\r\n> Ah, you are hitting a special case here: We are not waiting for server_connected to complete before notifying the HTTP layer that the connection has been established (I didn't think this would be useful to anyone and it surely isn't faster). If you have a concrete use case here please open a separate issue, this should be straightforward to adjust. In fact at the moment it's a bit more complicated because we don't block.\r\n\r\nTo summarize: I'm doing rather heavy work in every hook and communicate with a different service (gRPC calls to Node.js that process the hooks). When using `@concurrent` (and probably same with async hooks) hooks such as `server_connected` and `request` are racing each other (I think that's actually the only case). With synchronous hooks this cannot happen because whatever I do in `server_connected` blocks the entire proxy.\r\n\r\n```py\r\nimport time\r\nfrom mitmproxy.script import concurrent\r\n\r\n\r\n@concurrent\r\ndef client_connected(data):\r\n    print('>>> client_connected')\r\n    time.sleep(2)\r\n    print('<<< client_connected')\r\n\r\n\r\n@concurrent\r\ndef server_connect(data):\r\n    print('>>> server_connect')\r\n    time.sleep(2)\r\n    print('<<< server_connect')\r\n\r\n\r\n@concurrent\r\ndef server_connected(data):\r\n    print('>>> server_connected')\r\n    time.sleep(2)\r\n    print('<<< server_connected')\r\n\r\n\r\n@concurrent\r\ndef request(flow):\r\n    print('>>> request')\r\n    time.sleep(2)\r\n    print('<<< request')\r\n\r\n\r\n@concurrent\r\ndef response(flow):\r\n    print('>>> response')\r\n    time.sleep(2)\r\n    print('<<< response')\r\n\r\n\r\n@concurrent\r\ndef client_disconnected(data):\r\n    print('>>> client_disconnected')\r\n    time.sleep(2)\r\n    print('<<< client_disconnected')\r\n\r\n\r\n@concurrent\r\ndef server_disconnected(data):\r\n    print('>>> server_disconnected')\r\n    time.sleep(2)\r\n    print('<<< server_disconnected')\r\n```\r\n\r\nAs you can see `server_connected` and `request` are interleaved.\r\n\r\n```\r\n>>> client_connected\r\n<<< client_connected\r\n>>> server_connect\r\n<<< server_connect\r\n>>> server_connected\r\n>>> request\r\n<<< server_connected\r\n<<< request\r\n>>> response\r\n<<< response\r\n>>> client_disconnected\r\n<<< client_disconnected\r\n>>> server_disconnected\r\n<<< server_disconnected\r\n```\r\n\r\n#### Proposal\r\n\r\nWait for the connection hooks to finish before continuing with the HTTP layer.\r\n\r\n#### Alternatives\r\n\r\nI could leave the connection event synchronous so that the always block and finish. But depending on the number of clients and servers this would mostly diminish the effect of making all other hooks async or concurrent.","closed_by":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5108/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5108/timeline","performed_via_github_app":null,"state_reason":"completed"}