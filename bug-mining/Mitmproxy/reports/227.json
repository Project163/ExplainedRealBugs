{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/1828","repository_url":"https://api.github.com/repos/mitmproxy/mitmproxy","labels_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/1828/labels{/name}","comments_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/1828/comments","events_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/1828/events","html_url":"https://github.com/mitmproxy/mitmproxy/issues/1828","id":194652413,"node_id":"MDU6SXNzdWUxOTQ2NTI0MTM=","number":1828,"title":"How to configure file system watchdog (away) for attached scripts","user":{"login":"RobbBienert","id":5629624,"node_id":"MDQ6VXNlcjU2Mjk2MjQ=","avatar_url":"https://avatars.githubusercontent.com/u/5629624?v=4","gravatar_id":"","url":"https://api.github.com/users/RobbBienert","html_url":"https://github.com/RobbBienert","followers_url":"https://api.github.com/users/RobbBienert/followers","following_url":"https://api.github.com/users/RobbBienert/following{/other_user}","gists_url":"https://api.github.com/users/RobbBienert/gists{/gist_id}","starred_url":"https://api.github.com/users/RobbBienert/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/RobbBienert/subscriptions","organizations_url":"https://api.github.com/users/RobbBienert/orgs","repos_url":"https://api.github.com/users/RobbBienert/repos","events_url":"https://api.github.com/users/RobbBienert/events{/privacy}","received_events_url":"https://api.github.com/users/RobbBienert/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":174959532,"node_id":"MDU6TGFiZWwxNzQ5NTk1MzI=","url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels/help%20wanted","name":"help wanted","color":"fbca04","default":true,"description":null},{"id":429899749,"node_id":"MDU6TGFiZWw0Mjk4OTk3NDk=","url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels/area/core","name":"area/core","color":"fef2c0","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2016-12-09T17:28:44Z","updated_at":"2017-02-11T00:45:17Z","closed_at":"2017-02-11T00:45:17Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Hi folks,\r\n\r\nI upgraded my local mitmproxy using pip from 0.17 to 0.18.2 and now my script does not work anymore. The mitmproxy is used to connect a local machine with a corporate proxy and measure the traffic in between. The mitmproxy (to be exact, the mitmdump program) is called like this:\r\n\r\n    /usr/local/bin/mitmdump -p 9090 -U 'http://proxy:8080' -s 'tracer.py argument'\r\n\r\nThe `tracer.py` has three functions implemented as described in the [Events Documentation](http://docs.mitmproxy.org/en/latest/scripting/events.html):\r\n\r\n    def start():\r\n        # should be called once on startup\r\n        # so do some initialization here\r\n    \r\n    def response(flow):\r\n        # track the response information\r\n    \r\n    def done():\r\n        # called at script shutdown\r\n\r\nIn the stdout I see a lot of lines telling me `Reloading script: tracer.py` and if I add a print('hello from start()') to the `start()` function I also see this message in stdout, which means that `start()` gets executed more than once. My search for `Reloading script` pointed me to [the function `tick` in addons/script.py](https://github.com/mitmproxy/mitmproxy/blob/6792cc1de90b02b89da9ae80704ea237c5486e66/mitmproxy/addons/script.py#L185), which seems to be running in a certain interval. The problem I can address so far here is that what happens when `self.should_reload.is_set()` returns `True` while the proxy is running.\r\n\r\n`should_reload`s internal state is set to `False` by `clear()` in line 187, but it could be set to `True` again by `reload()` in line 175. `reload` is passed as callback to a `ReloadHandler` in line 204, which is connected to a file system watchdog. This sounds similar to the [Scripting Overview](http://docs.mitmproxy.org/en/latest/scripting/overview.html#developing-scripts),\r\n\r\n> Mitmprxoy monitors scripts for modifications, and reloads them on change. When this happens, the script is shut down (the done event is called), and the new instance is started up as if the script had just been loaded (the start and configure events are called).\r\n\r\nwith the exception, that the `ReloadHandler` reloads the script if _anything_ in the observed directory is changed. So I propose not only to filter directories and files starting with a `.`, but to watch _only_ for files ending with `.py`.\r\n\r\n##### System information\r\n\r\nThe output of \"mitmdump --sysinfo\":\r\n\r\nMitmproxy version: 0.18.2\r\nPython version: 2.7.12\r\nPlatform: Linux-4.4.0-42-generic-x86_64-with-LinuxMint-18-sarah\r\nSSL version: OpenSSL 1.0.2g  1 Mar 2016\r\nLinux distro: LinuxMint 18 sarah","closed_by":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/1828/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/1828/timeline","performed_via_github_app":null,"state_reason":"completed"}