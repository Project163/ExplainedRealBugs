{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/774","repository_url":"https://api.github.com/repos/mitmproxy/mitmproxy","labels_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/774/labels{/name}","comments_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/774/comments","events_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/774/events","html_url":"https://github.com/mitmproxy/mitmproxy/issues/774","id":107082335,"node_id":"MDU6SXNzdWUxMDcwODIzMzU=","number":774,"title":"HTTPS not replayed by mitmdump","user":{"login":"ghost","id":10137,"node_id":"MDQ6VXNlcjEwMTM3","avatar_url":"https://avatars.githubusercontent.com/u/10137?v=4","gravatar_id":"","url":"https://api.github.com/users/ghost","html_url":"https://github.com/ghost","followers_url":"https://api.github.com/users/ghost/followers","following_url":"https://api.github.com/users/ghost/following{/other_user}","gists_url":"https://api.github.com/users/ghost/gists{/gist_id}","starred_url":"https://api.github.com/users/ghost/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ghost/subscriptions","organizations_url":"https://api.github.com/users/ghost/orgs","repos_url":"https://api.github.com/users/ghost/repos","events_url":"https://api.github.com/users/ghost/events{/privacy}","received_events_url":"https://api.github.com/users/ghost/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":79336502,"node_id":"MDU6TGFiZWw3OTMzNjUwMg==","url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels/kind/bug","name":"kind/bug","color":"d93f0b","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/milestones/9","html_url":"https://github.com/mitmproxy/mitmproxy/milestone/9","labels_url":"https://api.github.com/repos/mitmproxy/mitmproxy/milestones/9/labels","id":1309453,"node_id":"MDk6TWlsZXN0b25lMTMwOTQ1Mw==","number":9,"title":"0.14","description":"","creator":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":11,"state":"closed","created_at":"2015-09-16T23:32:36Z","updated_at":"2015-12-12T15:26:52Z","due_on":null,"closed_at":"2015-11-18T13:09:09Z"},"comments":1,"created_at":"2015-09-17T21:54:58Z","updated_at":"2015-09-18T11:27:18Z","closed_at":"2015-09-18T11:27:18Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**What's the problem?**\nMitmdump is configured as a transparent proxy with ssl support, the certificate is installed. The sites with ssl could be captured but with some thousand URIs for https and http none for https is replayed, only http.\n\nI'm not sure if this is related to #755.\n\n**What's expected?**\nThe https sites should be replayed, too.\n\n**Which versions are affected?**\nThe master version of mitmdump/libmproxy from yesterday was used.\n\nIn 0.13 this problem was not there.\n\n**How to reproduce the problem?**\nThe best way I can think of is to search for a file with HTTPS, like a picture from wikipedia, to capture it with a transparent mitmdump and than to replay this. I used `--no-pop` but I think this doesn't matter.\n\n**Why does this happen?**\nFor a better understanding I modified the output of mitmdump. Thus it told me when a replay was done and additionally the value of `_hash` from flow.py. Therefore I added a `print(repr(key))` in front of the return of the `_hash` function.\n\nNow I used the logo from wikipedia for the test. With the modified hash function there is a line printed for every response in the captured file on startup. In this case it is something like\n\n```\n['443', 'http', 'GET', [...]\n```\n\nWhen a request occur some new line are printed, in this case something like\n\n```\n['443', 'https', 'GET', [...]\n192.168.X.X:59990: clientconnect\n192.168.X.X GET https://[...]\n192.168.X.X GET https://[...]\n << 200 OK 10kB\n192.168.X.X:59990: clientdisconnect\n```\n\nDo not forget, the output is modified thus more is printed than normal. But the problem is also revealed. When the captured file is loaded the saved data is loaded with scheme http. But the request is done with https thus there is no match but a miss and mitmdump did not find the captured data even though it is there.\n\nBy looking into the captured file it is clear, that the data is saved with scheme https and thus correctly.\n\n**How could the problem be solved?**\nWell to be true I undo some code. I removed line 249 `scheme = \"https\" if flow.client_conn and flow.client_conn.ssl_established else \"http\"` and set `scheme=r.scheme`. This is a workaround and I could not tell the side effects of this.\nBut to say the truth I do not understand why there is such a line. Depending on the comment I think that libmproxy may downgrade https connection to http ones. And to be able to find the data the scheme is modified. But if scheme could only be https and http and that you try to find the response in both cases, I do not know why scheme is not simply removed.\n","closed_by":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/774/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/774/timeline","performed_via_github_app":null,"state_reason":"completed"}