{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/4630","repository_url":"https://api.github.com/repos/mitmproxy/mitmproxy","labels_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/4630/labels{/name}","comments_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/4630/comments","events_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/4630/events","html_url":"https://github.com/mitmproxy/mitmproxy/issues/4630","id":916404596,"node_id":"MDU6SXNzdWU5MTY0MDQ1OTY=","number":4630,"title":"Instagram TCP connections broken with HTTP2 enabled","user":{"login":"Nerixyz","id":19953266,"node_id":"MDQ6VXNlcjE5OTUzMjY2","avatar_url":"https://avatars.githubusercontent.com/u/19953266?v=4","gravatar_id":"","url":"https://api.github.com/users/Nerixyz","html_url":"https://github.com/Nerixyz","followers_url":"https://api.github.com/users/Nerixyz/followers","following_url":"https://api.github.com/users/Nerixyz/following{/other_user}","gists_url":"https://api.github.com/users/Nerixyz/gists{/gist_id}","starred_url":"https://api.github.com/users/Nerixyz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Nerixyz/subscriptions","organizations_url":"https://api.github.com/users/Nerixyz/orgs","repos_url":"https://api.github.com/users/Nerixyz/repos","events_url":"https://api.github.com/users/Nerixyz/events{/privacy}","received_events_url":"https://api.github.com/users/Nerixyz/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":466930397,"node_id":"MDU6TGFiZWw0NjY5MzAzOTc=","url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels/kind/triage","name":"kind/triage","color":"006b75","default":false,"description":"Unclassified issues"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2021-06-09T16:40:07Z","updated_at":"2021-06-09T22:32:02Z","closed_at":"2021-06-09T22:23:52Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"#### Problem Description\r\nUsing the latest binary (v7) with HTTP2 enabled and in SOCKS mode, Instagram on Android can't use MQTT through TCP anymore.\r\nOther Facebook apps might also be affected as they use a similar connection.\r\n\r\nIn an affected version, you can see a lot of TCP connections to two different hosts with the same port (443). If you look at the tcp messages, the last message is always `missing connection preface` (then the connection is closed).\r\n\r\nThis doesn't happen if mitmproxy has HTTP2 disabled (instagram uses http2, so you only see tcp connections but the MQTT connections mentioned at the start work fine; there are two persistent connections).\r\n\r\nI beleive this was introduced in #4529 (commit `f94a9a3`) as the build for #4532 (commit `0e8dd73`) doesn't have this issue.\r\n\r\n#### Steps to reproduce the behavior:\r\n0. Have an Instagram account with [WhiteHat mode](https://www.facebook.com/whitehat) enabled (and enable no TLS 1.3 and allow user certificates in the app).\r\n1. Fully close Instagram\r\n2. Start mitmproxy in SOCKS mode\r\n3. Open Instagram\r\n\r\n#### System Information\r\n```\r\nMitmproxy: 7.0.0.dev binary\r\nPython:    3.9.2\r\nOpenSSL:   OpenSSL 1.1.1k  25 Mar 2021\r\nPlatform:  Windows-10-10.0.19041-SP0\r\n```","closed_by":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/4630/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/4630/timeline","performed_via_github_app":null,"state_reason":"completed"}