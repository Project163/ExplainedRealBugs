[{"id":4933953028,"node_id":"MDEyOkxhYmVsZWRFdmVudDQ5MzM5NTMwMjg=","url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/events/4933953028","actor":{"login":"Prinzhorn","id":679144,"node_id":"MDQ6VXNlcjY3OTE0NA==","avatar_url":"https://avatars.githubusercontent.com/u/679144?v=4","gravatar_id":"","url":"https://api.github.com/users/Prinzhorn","html_url":"https://github.com/Prinzhorn","followers_url":"https://api.github.com/users/Prinzhorn/followers","following_url":"https://api.github.com/users/Prinzhorn/following{/other_user}","gists_url":"https://api.github.com/users/Prinzhorn/gists{/gist_id}","starred_url":"https://api.github.com/users/Prinzhorn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Prinzhorn/subscriptions","organizations_url":"https://api.github.com/users/Prinzhorn/orgs","repos_url":"https://api.github.com/users/Prinzhorn/repos","events_url":"https://api.github.com/users/Prinzhorn/events{/privacy}","received_events_url":"https://api.github.com/users/Prinzhorn/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2021-06-24T11:15:07Z","label":{"name":"kind/triage","color":"006b75"},"performed_via_github_app":null},{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/comments/867654988","html_url":"https://github.com/mitmproxy/mitmproxy/issues/4655#issuecomment-867654988","issue_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/4655","id":867654988,"node_id":"MDEyOklzc3VlQ29tbWVudDg2NzY1NDk4OA==","user":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-06-24T13:53:34Z","updated_at":"2021-06-24T13:53:34Z","body":"Event log with `-vvv --set proxy_debug`:\r\n\r\n```\r\nProxy server listening at http://*:10021\r\n[::1]:57280: client connect\r\n[::1]:57280:   >> Start({})\r\n[::1]:57280:   << NextLayerHook(data=NextLayer:None)\r\n[::1]:57280:   >> Reply(NextLayerHook(data=NextLayer:ReverseProxy()),None)\r\n[::1]:57280:   [nextlayer] ReverseProxy()\r\n[::1]:57280:   >> Start({})\r\n[::1]:57280:   << OpenConnection({'connection': Server({'id': '…ae9b46', 'address': ('localhost', 10022), 'state': <ConnectionState.CLOSED: 0>})})\r\n[::1]:57280:   << OpenConnection({'connection': Server({'id': '…ae9b46', 'address': ('localhost', 10022), 'state': <ConnectionState.CLOSED: 0>})})\r\n[::1]:57280: server connect localhost ([::1]:10022)\r\n[::1]:57280:   >> Reply(OpenConnection({'connection': Server({'id': '…ae9b46', 'address': ('localhost', 10022), 'state': <ConnectionState.OPEN: 3>, 'timestamp_start': 1624542764.7953513, 'timestamp_tcp_setup': 1624542764.8006616, 'peername': ('::1', 10022, 0, 0), 'sockname': ('::1', 57281, 0, 0)})}),None)\r\n[::1]:57280:     >> Start({})\r\n[::1]:57280:   >> DataReceived(server, b'220---------- Welcome to Pure-FTPd [privsep] [TLS] ----------\\r\\n220-You are user number 1 of 1 allowed.\\r\\n220-Local time is now 13:52. Server port: 21.\\r\\n220-This is a private system - No anonymous login\\r\\n220-IPv6 connections are also welcome on this server.\\r\\n220 You will be disconnected after 15 minutes of inactivity.\\r\\n')\r\n[::1]:57280:     >> DataReceived(server, b'220---------- Welcome to Pure-FTPd [privsep] [TLS] ----------\\r\\n220-You are user number 1 of 1 allowed.\\r\\n220-Local time is now 13:52. Server port: 21.\\r\\n220-This is a private system - No anonymous login\\r\\n220-IPv6 connections…\r\n[::1]:57280:     << NextLayerHook(data=NextLayer:None)\r\n[::1]:57280:   << NextLayerHook(data=NextLayer:None)\r\n[::1]:57280:   >> Reply(NextLayerHook(data=NextLayer:TCPLayer(state: start)),None)\r\n[::1]:57280:     >> Reply(NextLayerHook(data=NextLayer:TCPLayer(state: start)),None)\r\n[::1]:57280:     [nextlayer] TCPLayer(state: start)\r\n[::1]:57280:     >> Start({})\r\n[::1]:57280:     << TcpStartHook(flow=<TCPFlow (0 messages)>)\r\n[::1]:57280:     << TcpStartHook(flow=<TCPFlow (0 messages)>)\r\n[::1]:57280:   << TcpStartHook(flow=<TCPFlow (0 messages)>)\r\n[::1]:57280:     >! DataReceived(server, b'220---------- Welcome to Pure-FTPd [privsep] [TLS] ----------\\r\\n220-You are user number 1 of 1 allowed.\\r\\n220-Local time is now 13:52. Server port: 21.\\r\\n220-This is a private system - No anonymous login\\r\\n220-IPv6 connections are also welcome on this server.\\r\\n220 You will be disconnected after 15 minutes of inactivity.\\r\\n')\r\n[::1]:57280:   >> Reply(TcpStartHook(flow=<TCPFlow (0 messages)>),None)\r\n[::1]:57280:     >> Reply(TcpStartHook(flow=<TCPFlow (0 messages)>),None)\r\n[::1]:57280:     !> DataReceived(server, b'220---------- Welcome to Pure-FTPd [privsep] [TLS] ----------\\r\\n220-You are user number 1 of 1 allowed.\\r\\n220-Local time is now 13:52. Server port: 21.\\r\\n220-This is a private system - No anonymous login\\r\\n220-IPv6 connections are also welcome on this server.\\r\\n220 You will be disconnected after 15 minutes of inactivity.\\r\\n')\r\n[::1]:57280:     << TcpMessageHook(flow=<TCPFlow (1 messages)>)\r\n[::1]:57280:   << TcpMessageHook(flow=<TCPFlow (1 messages)>)\r\n[::1]:57280 <- tcp <- localhost:10022\r\n[::1]:57280:   >> Reply(TcpMessageHook(flow=<TCPFlow (1 messages)>),None)\r\n[::1]:57280:     >> Reply(TcpMessageHook(flow=<TCPFlow (1 messages)>),None)\r\n[::1]:57280:     << SendData(client, b'220---------- Welcome to Pure-FTPd [privsep] [TLS] ----------\\r\\n220-You are user number 1 of 1 allowed.\\r\\n220-Local time is now 13:52. Server port: 21.\\r\\n220-This is a private system - No anonymous login\\r\\n220-IPv6 connections are also welcome on this server.\\r\\n220 You will be disconnected after 15 minutes of inactivity.\\r\\n')\r\n[::1]:57280:   << SendData(client, b'220---------- Welcome to Pure-FTPd [privsep] [TLS] ----------\\r\\n220-You are user number 1 of 1 allowed.\\r\\n220-Local time is now 13:52. Server port: 21.\\r\\n220-This is a private system - No anonymous login\\r\\n220-IPv6 connections are…\r\n[::1]:57280:   >> DataReceived(client, b'AUTH TLS\\r\\n')\r\n[::1]:57280:     >> DataReceived(client, b'AUTH TLS\\r\\n')\r\n[::1]:57280:     << TcpMessageHook(flow=<TCPFlow (2 messages)>)\r\n[::1]:57280:   << TcpMessageHook(flow=<TCPFlow (2 messages)>)\r\n[::1]:57280 -> tcp -> localhost:10022\r\n[::1]:57280:   >> Reply(TcpMessageHook(flow=<TCPFlow (2 messages)>),None)\r\n[::1]:57280:     >> Reply(TcpMessageHook(flow=<TCPFlow (2 messages)>),None)\r\n[::1]:57280:     << SendData(server, b'AUTH TLS\\r\\n')\r\n[::1]:57280:   << SendData(server, b'AUTH TLS\\r\\n')\r\n[::1]:57280:   >> DataReceived(server, b'500 This security scheme is not implemented\\r\\n')\r\n[::1]:57280:     >> DataReceived(server, b'500 This security scheme is not implemented\\r\\n')\r\n[::1]:57280:     << TcpMessageHook(flow=<TCPFlow (3 messages)>)\r\n[::1]:57280:   << TcpMessageHook(flow=<TCPFlow (3 messages)>)\r\n[::1]:57280 <- tcp <- localhost:10022\r\n[::1]:57280:   >> Reply(TcpMessageHook(flow=<TCPFlow (3 messages)>),None)\r\n[::1]:57280:     >> Reply(TcpMessageHook(flow=<TCPFlow (3 messages)>),None)\r\n[::1]:57280:     << SendData(client, b'500 This security scheme is not implemented\\r\\n')\r\n[::1]:57280:   << SendData(client, b'500 This security scheme is not implemented\\r\\n')\r\n[::1]:57280:   >> DataReceived(client, b'AUTH SSL\\r\\n')\r\n[::1]:57280:     >> DataReceived(client, b'AUTH SSL\\r\\n')\r\n[::1]:57280:     << TcpMessageHook(flow=<TCPFlow (4 messages)>)\r\n[::1]:57280:   << TcpMessageHook(flow=<TCPFlow (4 messages)>)\r\n[::1]:57280 -> tcp -> localhost:10022\r\n[::1]:57280:   >> Reply(TcpMessageHook(flow=<TCPFlow (4 messages)>),None)\r\n[::1]:57280:     >> Reply(TcpMessageHook(flow=<TCPFlow (4 messages)>),None)\r\n[::1]:57280:     << SendData(server, b'AUTH SSL\\r\\n')\r\n[::1]:57280:   << SendData(server, b'AUTH SSL\\r\\n')\r\n[::1]:57280:   >> DataReceived(server, b'500 This security scheme is not implemented\\r\\n')\r\n[::1]:57280:     >> DataReceived(server, b'500 This security scheme is not implemented\\r\\n')\r\n[::1]:57280:     << TcpMessageHook(flow=<TCPFlow (5 messages)>)\r\n[::1]:57280:   << TcpMessageHook(flow=<TCPFlow (5 messages)>)\r\n[::1]:57280 <- tcp <- localhost:10022\r\n[::1]:57280:   >> Reply(TcpMessageHook(flow=<TCPFlow (5 messages)>),None)\r\n[::1]:57280:     >> Reply(TcpMessageHook(flow=<TCPFlow (5 messages)>),None)\r\n[::1]:57280:     << SendData(client, b'500 This security scheme is not implemented\\r\\n')\r\n[::1]:57280:   << SendData(client, b'500 This security scheme is not implemented\\r\\n')\r\n[::1]:57280:   >> DataReceived(client, b'USER prinzhorn\\r\\n')\r\n[::1]:57280:     >> DataReceived(client, b'USER prinzhorn\\r\\n')\r\n[::1]:57280:     << TcpMessageHook(flow=<TCPFlow (6 messages)>)\r\n[::1]:57280:   << TcpMessageHook(flow=<TCPFlow (6 messages)>)\r\n[::1]:57280 -> tcp -> localhost:10022\r\n[::1]:57280:   >> Reply(TcpMessageHook(flow=<TCPFlow (6 messages)>),None)\r\n[::1]:57280:     >> Reply(TcpMessageHook(flow=<TCPFlow (6 messages)>),None)\r\n[::1]:57280:     << SendData(server, b'USER prinzhorn\\r\\n')\r\n[::1]:57280:   << SendData(server, b'USER prinzhorn\\r\\n')\r\n[::1]:57280:   >> DataReceived(server, b'331 User prinzhorn OK. Password required\\r\\n')\r\n[::1]:57280:     >> DataReceived(server, b'331 User prinzhorn OK. Password required\\r\\n')\r\n[::1]:57280:     << TcpMessageHook(flow=<TCPFlow (7 messages)>)\r\n[::1]:57280:   << TcpMessageHook(flow=<TCPFlow (7 messages)>)\r\n[::1]:57280 <- tcp <- localhost:10022\r\n[::1]:57280:   >> Reply(TcpMessageHook(flow=<TCPFlow (7 messages)>),None)\r\n[::1]:57280:     >> Reply(TcpMessageHook(flow=<TCPFlow (7 messages)>),None)\r\n[::1]:57280:     << SendData(client, b'331 User prinzhorn OK. Password required\\r\\n')\r\n[::1]:57280:   << SendData(client, b'331 User prinzhorn OK. Password required\\r\\n')\r\n[::1]:57280:   >> DataReceived(client, b'PASS prinzhorn\\r\\n')\r\n[::1]:57280:     >> DataReceived(client, b'PASS prinzhorn\\r\\n')\r\n[::1]:57280:     << TcpMessageHook(flow=<TCPFlow (8 messages)>)\r\n[::1]:57280:   << TcpMessageHook(flow=<TCPFlow (8 messages)>)\r\n[::1]:57280 -> tcp -> localhost:10022\r\n[::1]:57280:   >> Reply(TcpMessageHook(flow=<TCPFlow (8 messages)>),None)\r\n[::1]:57280:     >> Reply(TcpMessageHook(flow=<TCPFlow (8 messages)>),None)\r\n[::1]:57280:     << SendData(server, b'PASS prinzhorn\\r\\n')\r\n[::1]:57280:   << SendData(server, b'PASS prinzhorn\\r\\n')\r\n[::1]:57280:   >> DataReceived(server, b'230 OK. Current directory is /\\r\\n')\r\n[::1]:57280:     >> DataReceived(server, b'230 OK. Current directory is /\\r\\n')\r\n[::1]:57280:     << TcpMessageHook(flow=<TCPFlow (9 messages)>)\r\n[::1]:57280:   << TcpMessageHook(flow=<TCPFlow (9 messages)>)\r\n[::1]:57280 <- tcp <- localhost:10022\r\n[::1]:57280:   >> Reply(TcpMessageHook(flow=<TCPFlow (9 messages)>),None)\r\n[::1]:57280:     >> Reply(TcpMessageHook(flow=<TCPFlow (9 messages)>),None)\r\n[::1]:57280:     << SendData(client, b'230 OK. Current directory is /\\r\\n')\r\n[::1]:57280:   << SendData(client, b'230 OK. Current directory is /\\r\\n')\r\n[::1]:57280:   >> DataReceived(client, b'SYST\\r\\n')\r\n[::1]:57280:     >> DataReceived(client, b'SYST\\r\\n')\r\n[::1]:57280:     << TcpMessageHook(flow=<TCPFlow (10 messages)>)\r\n[::1]:57280:   << TcpMessageHook(flow=<TCPFlow (10 messages)>)\r\n[::1]:57280 -> tcp -> localhost:10022\r\n[::1]:57280:   >> Reply(TcpMessageHook(flow=<TCPFlow (10 messages)>),None)\r\n[::1]:57280:     >> Reply(TcpMessageHook(flow=<TCPFlow (10 messages)>),None)\r\n[::1]:57280:     << SendData(server, b'SYST\\r\\n')\r\n[::1]:57280:   << SendData(server, b'SYST\\r\\n')\r\n[::1]:57280:   >> DataReceived(server, b'215 UNIX Type: L8\\r\\n')\r\n[::1]:57280:     >> DataReceived(server, b'215 UNIX Type: L8\\r\\n')\r\n[::1]:57280:     << TcpMessageHook(flow=<TCPFlow (11 messages)>)\r\n[::1]:57280:   << TcpMessageHook(flow=<TCPFlow (11 messages)>)\r\n[::1]:57280 <- tcp <- localhost:10022\r\n[::1]:57280:   >> Reply(TcpMessageHook(flow=<TCPFlow (11 messages)>),None)\r\n[::1]:57280:     >> Reply(TcpMessageHook(flow=<TCPFlow (11 messages)>),None)\r\n[::1]:57280:     << SendData(client, b'215 UNIX Type: L8\\r\\n')\r\n[::1]:57280:   << SendData(client, b'215 UNIX Type: L8\\r\\n')\r\n[::1]:57280:   >> DataReceived(client, b'FEAT\\r\\n')\r\n[::1]:57280:     >> DataReceived(client, b'FEAT\\r\\n')\r\n[::1]:57280:     << TcpMessageHook(flow=<TCPFlow (12 messages)>)\r\n[::1]:57280:   << TcpMessageHook(flow=<TCPFlow (12 messages)>)\r\n[::1]:57280 -> tcp -> localhost:10022\r\n[::1]:57280:   >> Reply(TcpMessageHook(flow=<TCPFlow (12 messages)>),None)\r\n[::1]:57280:     >> Reply(TcpMessageHook(flow=<TCPFlow (12 messages)>),None)\r\n[::1]:57280:     << SendData(server, b'FEAT\\r\\n')\r\n[::1]:57280:   << SendData(server, b'FEAT\\r\\n')\r\n[::1]:57280:   >> DataReceived(server, b'211-Extensions supported:\\r\\n EPRT\\r\\n IDLE\\r\\n MDTM\\r\\n SIZE\\r\\n MFMT\\r\\n REST STREAM\\r\\n MLST type*;size*;sizd*;modify*;UNIX.mode*;UNIX.uid*;UNIX.gid*;unique*;\\r\\n MLSD\\r\\n AUTH TLS\\r\\n PBSZ\\r\\n PROT\\r\\n UTF8\\r\\n TVFS\\r\\n ESTA\\r\\n PASV\\r\\n EPSV\\r\\n SPSV\\r\\r\\n211 End.\\r\\n')\r\n[::1]:57280:     >> DataReceived(server, b'211-Extensions supported:\\r\\n EPRT\\r\\n IDLE\\r\\n MDTM\\r\\n SIZE\\r\\n MFMT\\r\\n REST STREAM\\r\\n MLST type*;size*;sizd*;modify*;UNIX.mode*;UNIX.uid*;UNIX.gid*;unique*;\\r\\n MLSD\\r\\n AUTH TLS\\r\\n PBSZ\\r\\n PROT\\r\\n UTF8\\r\\n TVFS\\r\\n ESTA\\r…\r\n[::1]:57280:     << TcpMessageHook(flow=<TCPFlow (13 messages)>)\r\n[::1]:57280:   << TcpMessageHook(flow=<TCPFlow (13 messages)>)\r\n[::1]:57280 <- tcp <- localhost:10022\r\n[::1]:57280:   >> Reply(TcpMessageHook(flow=<TCPFlow (13 messages)>),None)\r\n[::1]:57280:     >> Reply(TcpMessageHook(flow=<TCPFlow (13 messages)>),None)\r\n[::1]:57280:     << SendData(client, b'211-Extensions supported:\\r\\n EPRT\\r\\n IDLE\\r\\n MDTM\\r\\n SIZE\\r\\n MFMT\\r\\n REST STREAM\\r\\n MLST type*;size*;sizd*;modify*;UNIX.mode*;UNIX.uid*;UNIX.gid*;unique*;\\r\\n MLSD\\r\\n AUTH TLS\\r\\n PBSZ\\r\\n PROT\\r\\n UTF8\\r\\n TVFS\\r\\n ESTA\\r\\n PASV\\r\\n EPSV\\r\\n SPSV\\r\\r\\n211 End.\\r\\n')\r\n[::1]:57280:   << SendData(client, b'211-Extensions supported:\\r\\n EPRT\\r\\n IDLE\\r\\n MDTM\\r\\n SIZE\\r\\n MFMT\\r\\n REST STREAM\\r\\n MLST type*;size*;sizd*;modify*;UNIX.mode*;UNIX.uid*;UNIX.gid*;unique*;\\r\\n MLSD\\r\\n AUTH TLS\\r\\n PBSZ\\r\\n PROT\\r\\n UTF8\\r\\n TVFS\\r\\n ESTA\\r\\n P…\r\n[::1]:57280:   >> DataReceived(client, b'OPTS UTF8 ON\\r\\n')\r\n[::1]:57280:     >> DataReceived(client, b'OPTS UTF8 ON\\r\\n')\r\n[::1]:57280:     << TcpMessageHook(flow=<TCPFlow (14 messages)>)\r\n[::1]:57280:   << TcpMessageHook(flow=<TCPFlow (14 messages)>)\r\n[::1]:57280 -> tcp -> localhost:10022\r\n[::1]:57280:   >> Reply(TcpMessageHook(flow=<TCPFlow (14 messages)>),None)\r\n[::1]:57280:     >> Reply(TcpMessageHook(flow=<TCPFlow (14 messages)>),None)\r\n[::1]:57280:     << SendData(server, b'OPTS UTF8 ON\\r\\n')\r\n[::1]:57280:   << SendData(server, b'OPTS UTF8 ON\\r\\n')\r\n[::1]:57280:   >> DataReceived(server, b'200 OK, UTF-8 enabled\\r\\n')\r\n[::1]:57280:     >> DataReceived(server, b'200 OK, UTF-8 enabled\\r\\n')\r\n[::1]:57280:     << TcpMessageHook(flow=<TCPFlow (15 messages)>)\r\n[::1]:57280:   << TcpMessageHook(flow=<TCPFlow (15 messages)>)\r\n[::1]:57280 <- tcp <- localhost:10022\r\n[::1]:57280:   >> Reply(TcpMessageHook(flow=<TCPFlow (15 messages)>),None)\r\n[::1]:57280:     >> Reply(TcpMessageHook(flow=<TCPFlow (15 messages)>),None)\r\n[::1]:57280:     << SendData(client, b'200 OK, UTF-8 enabled\\r\\n')\r\n[::1]:57280:   << SendData(client, b'200 OK, UTF-8 enabled\\r\\n')\r\n[::1]:57280:   >> DataReceived(client, b'PWD\\r\\n')\r\n[::1]:57280:     >> DataReceived(client, b'PWD\\r\\n')\r\n[::1]:57280:     << TcpMessageHook(flow=<TCPFlow (16 messages)>)\r\n[::1]:57280:   << TcpMessageHook(flow=<TCPFlow (16 messages)>)\r\n[::1]:57280 -> tcp -> localhost:10022\r\n[::1]:57280:   >> Reply(TcpMessageHook(flow=<TCPFlow (16 messages)>),None)\r\n[::1]:57280:     >> Reply(TcpMessageHook(flow=<TCPFlow (16 messages)>),None)\r\n[::1]:57280:     << SendData(server, b'PWD\\r\\n')\r\n[::1]:57280:   << SendData(server, b'PWD\\r\\n')\r\n[::1]:57280:   >> DataReceived(server, b'257 \"/\" is your current location\\r\\n')\r\n[::1]:57280:     >> DataReceived(server, b'257 \"/\" is your current location\\r\\n')\r\n[::1]:57280:     << TcpMessageHook(flow=<TCPFlow (17 messages)>)\r\n[::1]:57280:   << TcpMessageHook(flow=<TCPFlow (17 messages)>)\r\n[::1]:57280 <- tcp <- localhost:10022\r\n[::1]:57280:   >> Reply(TcpMessageHook(flow=<TCPFlow (17 messages)>),None)\r\n[::1]:57280:     >> Reply(TcpMessageHook(flow=<TCPFlow (17 messages)>),None)\r\n[::1]:57280:     << SendData(client, b'257 \"/\" is your current location\\r\\n')\r\n[::1]:57280:   << SendData(client, b'257 \"/\" is your current location\\r\\n')\r\n[::1]:57280:   >> DataReceived(client, b'TYPE I\\r\\n')\r\n[::1]:57280:     >> DataReceived(client, b'TYPE I\\r\\n')\r\n[::1]:57280:     << TcpMessageHook(flow=<TCPFlow (18 messages)>)\r\n[::1]:57280:   << TcpMessageHook(flow=<TCPFlow (18 messages)>)\r\n[::1]:57280 -> tcp -> localhost:10022\r\n[::1]:57280:   >> Reply(TcpMessageHook(flow=<TCPFlow (18 messages)>),None)\r\n[::1]:57280:     >> Reply(TcpMessageHook(flow=<TCPFlow (18 messages)>),None)\r\n[::1]:57280:     << SendData(server, b'TYPE I\\r\\n')\r\n[::1]:57280:   << SendData(server, b'TYPE I\\r\\n')\r\n[::1]:57280:   >> DataReceived(server, b'200 TYPE is now 8-bit binary\\r\\n')\r\n[::1]:57280:     >> DataReceived(server, b'200 TYPE is now 8-bit binary\\r\\n')\r\n[::1]:57280:     << TcpMessageHook(flow=<TCPFlow (19 messages)>)\r\n[::1]:57280:   << TcpMessageHook(flow=<TCPFlow (19 messages)>)\r\n[::1]:57280 <- tcp <- localhost:10022\r\n[::1]:57280:   >> Reply(TcpMessageHook(flow=<TCPFlow (19 messages)>),None)\r\n[::1]:57280:     >> Reply(TcpMessageHook(flow=<TCPFlow (19 messages)>),None)\r\n[::1]:57280:     << SendData(client, b'200 TYPE is now 8-bit binary\\r\\n')\r\n[::1]:57280:   << SendData(client, b'200 TYPE is now 8-bit binary\\r\\n')\r\n[::1]:57280:   >> DataReceived(client, b'EPSV\\r\\n')\r\n[::1]:57280:     >> DataReceived(client, b'EPSV\\r\\n')\r\n[::1]:57280:     << TcpMessageHook(flow=<TCPFlow (20 messages)>)\r\n[::1]:57280:   << TcpMessageHook(flow=<TCPFlow (20 messages)>)\r\n[::1]:57280 -> tcp -> localhost:10022\r\n[::1]:57280:   >> Reply(TcpMessageHook(flow=<TCPFlow (20 messages)>),None)\r\n[::1]:57280:     >> Reply(TcpMessageHook(flow=<TCPFlow (20 messages)>),None)\r\n[::1]:57280:     << SendData(server, b'EPSV\\r\\n')\r\n[::1]:57280:   << SendData(server, b'EPSV\\r\\n')\r\n[::1]:57280:   >> DataReceived(server, b'229 Extended Passive mode OK (|||30007|)\\r\\n')\r\n[::1]:57280:     >> DataReceived(server, b'229 Extended Passive mode OK (|||30007|)\\r\\n')\r\n[::1]:57280:     << TcpMessageHook(flow=<TCPFlow (21 messages)>)\r\n[::1]:57280:   << TcpMessageHook(flow=<TCPFlow (21 messages)>)\r\n[::1]:57280 <- tcp <- localhost:10022\r\n[::1]:57280:   >> Reply(TcpMessageHook(flow=<TCPFlow (21 messages)>),None)\r\n[::1]:57280:     >> Reply(TcpMessageHook(flow=<TCPFlow (21 messages)>),None)\r\n[::1]:57280:     << SendData(client, b'229 Extended Passive mode OK (|||30007|)\\r\\n')\r\n[::1]:57280:   << SendData(client, b'229 Extended Passive mode OK (|||30007|)\\r\\n')\r\n[::1]:57280:   >> DataReceived(client, b'MLSD\\r\\n')\r\n[::1]:57280:     >> DataReceived(client, b'MLSD\\r\\n')\r\n[::1]:57280:     << TcpMessageHook(flow=<TCPFlow (22 messages)>)\r\n[::1]:57280:   << TcpMessageHook(flow=<TCPFlow (22 messages)>)\r\n[::1]:57280 -> tcp -> localhost:10022\r\n[::1]:57280:   >> Reply(TcpMessageHook(flow=<TCPFlow (22 messages)>),None)\r\n[::1]:57280:     >> Reply(TcpMessageHook(flow=<TCPFlow (22 messages)>),None)\r\n[::1]:57280:     << SendData(server, b'MLSD\\r\\n')\r\n[::1]:57280:   << SendData(server, b'MLSD\\r\\n')\r\n[::1]:57280:   >> DataReceived(server, b'150 Accepted data connection\\r\\n226-Options: -a -l \\r\\n226 2 matches total\\r\\n')\r\n[::1]:57280:     >> DataReceived(server, b'150 Accepted data connection\\r\\n226-Options: -a -l \\r\\n226 2 matches total\\r\\n')\r\n[::1]:57280:     << TcpMessageHook(flow=<TCPFlow (23 messages)>)\r\n[::1]:57280:   << TcpMessageHook(flow=<TCPFlow (23 messages)>)\r\n[::1]:57280 <- tcp <- localhost:10022\r\n[::1]:57280:   >> Reply(TcpMessageHook(flow=<TCPFlow (23 messages)>),None)\r\n[::1]:57280:     >> Reply(TcpMessageHook(flow=<TCPFlow (23 messages)>),None)\r\n[::1]:57280:     << SendData(client, b'150 Accepted data connection\\r\\n226-Options: -a -l \\r\\n226 2 matches total\\r\\n')\r\n[::1]:57280:   << SendData(client, b'150 Accepted data connection\\r\\n226-Options: -a -l \\r\\n226 2 matches total\\r\\n')\r\n[::1]:57283: client connect\r\n[::1]:57283:   >> Start({})\r\n[::1]:57283:   << NextLayerHook(data=NextLayer:None)\r\n[::1]:57283:   >> Reply(NextLayerHook(data=NextLayer:ReverseProxy()),None)\r\n[::1]:57283:   [nextlayer] ReverseProxy()\r\n[::1]:57283:   >> Start({})\r\n[::1]:57283:   << OpenConnection({'connection': Server({'id': '…3e6328', 'address': ('localhost', 10022), 'state': <ConnectionState.CLOSED: 0>})})\r\n[::1]:57283:   << OpenConnection({'connection': Server({'id': '…3e6328', 'address': ('localhost', 10022), 'state': <ConnectionState.CLOSED: 0>})})\r\n[::1]:57283: server connect localhost ([::1]:10022)\r\n[::1]:57283:   >> Reply(OpenConnection({'connection': Server({'id': '…3e6328', 'address': ('localhost', 10022), 'state': <ConnectionState.OPEN: 3>, 'timestamp_start': 1624542780.254956, 'timestamp_tcp_setup': 1624542780.2567515, 'peername': ('::1', 10022, 0, 0), 'sockname': ('::1', 57284, 0, 0)})}),None)\r\n[::1]:57283:     >> Start({})\r\n[::1]:57283:   >> DataReceived(server, b'421 1 users (the maximum) are already logged in, sorry\\r\\n')\r\n[::1]:57283:     >> DataReceived(server, b'421 1 users (the maximum) are already logged in, sorry\\r\\n')\r\n[::1]:57283:     << NextLayerHook(data=NextLayer:None)\r\n[::1]:57283:   << NextLayerHook(data=NextLayer:None)\r\n[::1]:57283:   >> ConnectionClosed(connection=Server({'id': '…3e6328', 'address': ('localhost', 10022), 'state': <ConnectionState.CAN_WRITE: 2>, 'timestamp_start': 1624542780.254956, 'timestamp_tcp_setup': 1624542780.2567515, 'peername': ('::1', 10022, 0, 0), 'sockname': ('::1', 57284, 0, 0)}))\r\n[::1]:57283:     >! ConnectionClosed(connection=Server({'id': '…3e6328', 'address': ('localhost', 10022), 'state': <ConnectionState.CAN_WRITE: 2>, 'timestamp_start': 1624542780.254956, 'timestamp_tcp_setup': 1624542780.2567515, 'peername': ('::1', 10022, 0, 0), 'sockname': ('::1', 57284, 0, 0)}))\r\n[::1]:57283:   >> Reply(NextLayerHook(data=NextLayer:TCPLayer(state: start)),None)\r\n[::1]:57283:     >> Reply(NextLayerHook(data=NextLayer:TCPLayer(state: start)),None)\r\n[::1]:57283:     [nextlayer] TCPLayer(state: start)\r\n[::1]:57283:     >> Start({})\r\n[::1]:57283:     << TcpStartHook(flow=<TCPFlow (0 messages)>)\r\n[::1]:57283:     << TcpStartHook(flow=<TCPFlow (0 messages)>)\r\n[::1]:57283:   << TcpStartHook(flow=<TCPFlow (0 messages)>)\r\n[::1]:57283:     >! DataReceived(server, b'421 1 users (the maximum) are already logged in, sorry\\r\\n')\r\n[::1]:57283:     !> ConnectionClosed(connection=Server({'id': '…3e6328', 'address': ('localhost', 10022), 'state': <ConnectionState.CAN_WRITE: 2>, 'timestamp_start': 1624542780.254956, 'timestamp_tcp_setup': 1624542780.2567515, 'peername': ('::1', 10022, 0, 0), 'sockname': ('::1', 57284, 0, 0)}))\r\n[::1]:57283:     >! ConnectionClosed(connection=Server({'id': '…3e6328', 'address': ('localhost', 10022), 'state': <ConnectionState.CAN_WRITE: 2>, 'timestamp_start': 1624542780.254956, 'timestamp_tcp_setup': 1624542780.2567515, 'peername': ('::1', 10022, 0, 0), 'sockname': ('::1', 57284, 0, 0)}))\r\n[::1]:57283:   >> Reply(TcpStartHook(flow=<TCPFlow (0 messages)>),None)\r\n[::1]:57283:     >> Reply(TcpStartHook(flow=<TCPFlow (0 messages)>),None)\r\n[::1]:57283:     << OpenConnection({'connection': Server({'id': '…3e6328', 'address': ('localhost', 10022), 'state': <ConnectionState.CAN_WRITE: 2>, 'timestamp_start': 1624542780.254956, 'timestamp_tcp_setup': 1624542780.2567515, 'peername': ('::1', 10022, 0, 0), 'sockname': ('::1', 57284, 0, 0)})})\r\n[::1]:57283:   << OpenConnection({'connection': Server({'id': '…3e6328', 'address': ('localhost', 10022), 'state': <ConnectionState.CAN_WRITE: 2>, 'timestamp_start': 1624542780.254956, 'timestamp_tcp_setup': 1624542780.2567515, 'peername': ('::1', 10022, 0, 0), 'sockname…\r\n[::1]:57283: mitmproxy has crashed!\r\nTraceback (most recent call last):\r\n  File \"c:\\users\\user\\git\\mitmproxy\\mitmproxy\\proxy\\server.py\", line 282, in server_event\r\n    assert command.connection not in self.transports\r\nAssertionError\r\n```","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/comments/867654988/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":4934764709,"node_id":"MDEyOkxhYmVsZWRFdmVudDQ5MzQ3NjQ3MDk=","url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/events/4934764709","actor":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2021-06-24T13:54:17Z","label":{"name":"release-blocker","color":"fc4bc4"},"performed_via_github_app":null},{"id":4935027210,"node_id":"MDE1OlJlZmVyZW5jZWRFdmVudDQ5MzUwMjcyMTA=","url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/events/4935027210","actor":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"5542cb9ad3452a246eb9be0da552ca16d20e83f1","commit_url":"https://api.github.com/repos/mhils/mitmproxy/commits/5542cb9ad3452a246eb9be0da552ca16d20e83f1","created_at":"2021-06-24T14:38:03Z","performed_via_github_app":null},{"id":4935052726,"node_id":"MDExOkNsb3NlZEV2ZW50NDkzNTA1MjcyNg==","url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/events/4935052726","actor":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"closed","commit_id":"ad7f1d11e457b297d31ea1cbe953876fd9efb8ae","commit_url":"https://api.github.com/repos/mitmproxy/mitmproxy/commits/ad7f1d11e457b297d31ea1cbe953876fd9efb8ae","created_at":"2021-06-24T14:42:23Z","state_reason":null,"performed_via_github_app":null},{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/comments/868326074","html_url":"https://github.com/mitmproxy/mitmproxy/issues/4655#issuecomment-868326074","issue_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/4655","id":868326074,"node_id":"MDEyOklzc3VlQ29tbWVudDg2ODMyNjA3NA==","user":{"login":"Prinzhorn","id":679144,"node_id":"MDQ6VXNlcjY3OTE0NA==","avatar_url":"https://avatars.githubusercontent.com/u/679144?v=4","gravatar_id":"","url":"https://api.github.com/users/Prinzhorn","html_url":"https://github.com/Prinzhorn","followers_url":"https://api.github.com/users/Prinzhorn/followers","following_url":"https://api.github.com/users/Prinzhorn/following{/other_user}","gists_url":"https://api.github.com/users/Prinzhorn/gists{/gist_id}","starred_url":"https://api.github.com/users/Prinzhorn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Prinzhorn/subscriptions","organizations_url":"https://api.github.com/users/Prinzhorn/orgs","repos_url":"https://api.github.com/users/Prinzhorn/repos","events_url":"https://api.github.com/users/Prinzhorn/events{/privacy}","received_events_url":"https://api.github.com/users/Prinzhorn/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-06-25T08:38:01Z","updated_at":"2021-06-25T08:38:29Z","body":"@mhils nice! In the future could you add a sentence or two in the commit or PR? That'd help me learn some of the internals if you point out what the issue here was and the context. And I'll try to remember including verbose logs in the future. I keep forgetting they exist.","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/comments/868326074/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"Prinzhorn","id":679144,"node_id":"MDQ6VXNlcjY3OTE0NA==","avatar_url":"https://avatars.githubusercontent.com/u/679144?v=4","gravatar_id":"","url":"https://api.github.com/users/Prinzhorn","html_url":"https://github.com/Prinzhorn","followers_url":"https://api.github.com/users/Prinzhorn/followers","following_url":"https://api.github.com/users/Prinzhorn/following{/other_user}","gists_url":"https://api.github.com/users/Prinzhorn/gists{/gist_id}","starred_url":"https://api.github.com/users/Prinzhorn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Prinzhorn/subscriptions","organizations_url":"https://api.github.com/users/Prinzhorn/orgs","repos_url":"https://api.github.com/users/Prinzhorn/repos","events_url":"https://api.github.com/users/Prinzhorn/events{/privacy}","received_events_url":"https://api.github.com/users/Prinzhorn/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":4938776589,"node_id":"MDE0Ok1lbnRpb25lZEV2ZW50NDkzODc3NjU4OQ==","url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/events/4938776589","actor":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2021-06-25T08:38:01Z","performed_via_github_app":null},{"id":4938776592,"node_id":"MDE1OlN1YnNjcmliZWRFdmVudDQ5Mzg3NzY1OTI=","url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/events/4938776592","actor":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2021-06-25T08:38:01Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/comments/868357451","html_url":"https://github.com/mitmproxy/mitmproxy/issues/4655#issuecomment-868357451","issue_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/4655","id":868357451,"node_id":"MDEyOklzc3VlQ29tbWVudDg2ODM1NzQ1MQ==","user":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-06-25T09:13:28Z","updated_at":"2021-06-25T09:13:28Z","body":"Yeah, you make a good point here. I guess I didn't add a comment because it's a race condition that's quite difficult to explain, but that's a bad excuse. Let me make up with the extra extended version:\r\n\r\nWe start off at the beginning of the second connection. The first part is normal: Proxy core calls `next_layer` event hook to determine which protocol layer should be used, next_layer addon says we're fundamentally a reverse proxy:\r\n\r\n```\r\n[::1]:57283: client connect\r\n[::1]:57283:   >> Start({})\r\n[::1]:57283:   << NextLayerHook(data=NextLayer:None)\r\n[::1]:57283:   >> Reply(NextLayerHook(data=NextLayer:ReverseProxy()),None)\r\n[::1]:57283:   [nextlayer] ReverseProxy()\r\n[::1]:57283:   >> Start({})\r\n```\r\nNext, we already see an `OpenConnection` command here because of eager mode. All good so far.\r\nhttps://github.com/mitmproxy/mitmproxy/blob/53ca9dda901c59489c3ca2b375a1a5ee8352907e/mitmproxy/proxy/layers/modes.py#L26-L27\r\n```\r\n[::1]:57283:   << OpenConnection({'connection': Server({'id': '…3e6328', 'address': ('localhost', 10022), 'state': <ConnectionState.CLOSED: 0>})})\r\n[::1]:57283:   << OpenConnection({'connection': Server({'id': '…3e6328', 'address': ('localhost', 10022), 'state': <ConnectionState.CLOSED: 0>})})\r\n[::1]:57283: server connect localhost ([::1]:10022)\r\n[::1]:57283:   >> Reply(OpenConnection({'connection': Server({'id': '…3e6328', 'address': ('localhost', 10022), 'state': <ConnectionState.OPEN: 3>, 'timestamp_start': 1624542780.254956, 'timestamp_tcp_setup': 1624542780.2567515, 'peername': ('::1', 10022, 0, 0), 'sockname': ('::1', 57284, 0, 0)})}),None)\r\n[::1]:57283:     >> Start({})\r\n```\r\n\r\nConnection successful. (second last line above). Now the next thing that happens is that we receive some data from the server (the client hasn't sent anything yet). Having received some data, we trigger `next_layer` again to find out what the next layer is going to be.\r\n\r\n```\r\n[::1]:57283:   >> DataReceived(server, b'421 1 users (the maximum) are already logged in, sorry\\r\\n')\r\n[::1]:57283:     >> DataReceived(server, b'421 1 users (the maximum) are already logged in, sorry\\r\\n')\r\n[::1]:57283:     << NextLayerHook(data=NextLayer:None)\r\n[::1]:57283:   << NextLayerHook(data=NextLayer:None)\r\n```\r\n\r\nWhile mitmproxy's addons are processing, we _simultaneously_ receive a TCP close from the server. Crucically, this happens _before_ the next_layer hook finished and `Reply(NextLayerHook(...))` occurs. The NextLayer addon is waiting for the hook reply first, so the even is in this layer's event queue (`>!` instead of `>>` below).\r\n\r\n```\r\n[::1]:57283:   >> ConnectionClosed(connection=Server({'id': '…3e6328', 'address': ('localhost', 10022), 'state': <ConnectionState.CAN_WRITE: 2>, 'timestamp_start': 1624542780.254956, 'timestamp_tcp_setup': 1624542780.2567515, 'peername': ('::1', 10022, 0, 0), 'sockname': ('::1', 57284, 0, 0)}))\r\n[::1]:57283:     >! ConnectionClosed(connection=Server({'id': '…3e6328', 'address': ('localhost', 10022), 'state': <ConnectionState.CAN_WRITE: 2>, 'timestamp_start': 1624542780.254956, 'timestamp_tcp_setup': 1624542780.2567515, 'peername': ('::1', 10022, 0, 0), 'sockname': ('::1', 57284, 0, 0)}))\r\n```\r\nNow our `next_layer` hook finally returns with TCPLayer as the next layer. The NextLayer addon then sends three events to this new child layer: `Start`, `DataReceived`, and `ConnectionClosed`. You can see that the first event already causes us to emit a `tcp_start` event that bubbles out. The other events are then put into TCPLayers event queue, which waits for the return of `tcp_start` before it processes them. The `>!` again denotes that they are not processed but put into the event queue.\r\n\r\n\r\nhttps://github.com/mitmproxy/mitmproxy/blob/10ee19c13879bddafeb9217dd5e4e29af954baac/mitmproxy/proxy/layers/tcp.py#L69-L74\r\n\r\n```\r\n[::1]:57283:   >> Reply(NextLayerHook(data=NextLayer:TCPLayer(state: start)),None)\r\n[::1]:57283:     >> Reply(NextLayerHook(data=NextLayer:TCPLayer(state: start)),None)\r\n[::1]:57283:     [nextlayer] TCPLayer(state: start)\r\n[::1]:57283:     >> Start({})\r\n[::1]:57283:     << TcpStartHook(flow=<TCPFlow (0 messages)>)  # reaction to Start\r\n[::1]:57283:     << TcpStartHook(flow=<TCPFlow (0 messages)>)  # reaction to Start\r\n[::1]:57283:   << TcpStartHook(flow=<TCPFlow (0 messages)>)  # reaction to Start\r\n[::1]:57283:     >! DataReceived(server, b'421 1 users (the maximum) are already logged in, sorry\\r\\n')  \r\n[::1]:57283:     !> ConnectionClosed(connection=Server({'id': '…3e6328', 'address': ('localhost', 10022), 'state': <ConnectionState.CAN_WRITE: 2>, 'timestamp_start': 1624542780.254956, 'timestamp_tcp_setup': 1624542780.2567515, 'peername': ('::1', 10022, 0, 0), 'sockname': ('::1', 57284, 0, 0)}))\r\n[::1]:57283:     >! ConnectionClosed(connection=Server({'id': '…3e6328', 'address': ('localhost', 10022), 'state': <ConnectionState.CAN_WRITE: 2>, 'timestamp_start': 1624542780.254956, 'timestamp_tcp_setup': 1624542780.2567515, 'peername': ('::1', 10022, 0, 0), 'sockname': ('::1', 57284, 0, 0)}))\r\n```\r\n\r\nFinally, the `tcp_start` event returns, but here we trigger the bug: As `server.connected` is not `True` anymore (see last code snippet), the TCP layer assumes it is responsible for connection establishment and yields a second `OpenConnection` for the same connection. `server.py` rightfully complains.\r\n\r\n```\r\n[::1]:57283:   >> Reply(TcpStartHook(flow=<TCPFlow (0 messages)>),None)\r\n[::1]:57283:     >> Reply(TcpStartHook(flow=<TCPFlow (0 messages)>),None)\r\n[::1]:57283:     << OpenConnection({'connection': Server({'id': '…3e6328', 'address': ('localhost', 10022), 'state': <ConnectionState.CAN_WRITE: 2>, 'timestamp_start': 1624542780.254956, 'timestamp_tcp_setup': 1624542780.2567515, 'peername': ('::1', 10022, 0, 0), 'sockname': ('::1', 57284, 0, 0)})})\r\n[::1]:57283:   << OpenConnection({'connection': Server({'id': '…3e6328', 'address': ('localhost', 10022), 'state': <ConnectionState.CAN_WRITE: 2>, 'timestamp_start': 1624542780.254956, 'timestamp_tcp_setup': 1624542780.2567515, 'peername': ('::1', 10022, 0, 0), 'sockname…\r\n[::1]:57283: mitmproxy has crashed!\r\nTraceback (most recent call last):\r\n  File \"c:\\users\\user\\git\\mitmproxy\\mitmproxy\\proxy\\server.py\", line 282, in server_event\r\n    assert command.connection not in self.transports\r\nAssertionError\r\n```\r\nThe fix has been to not check if we are currently connected, but to check if a connection was ever attempted on this server connection object:\r\nhttps://github.com/mhils/mitmproxy/commit/5542cb9ad3452a246eb9be0da552ca16d20e83f1#diff-76953bcc94b8a0670202747a2d38d3bd06ef6ef9df7f066ec9d682e5210d0049L73-R73\r\n\r\nIf we now look at the fixed version, we see that no second `OpenConnection` is issued. Instead, we process the event queue: First `!> DataReceived` is handled, then `!> ConnectionClosed`.\r\n\r\n```\r\n[::1]:61584:   >> Reply(TcpStartHook(flow=<TCPFlow (0 messages)>),None)\r\n[::1]:61584:     >> Reply(TcpStartHook(flow=<TCPFlow (0 messages)>),None)\r\n[::1]:61584:     !> DataReceived(server, b'421 1 users (the maximum) are already logged in, sorry\\r\\n')\r\n[::1]:61584:     << TcpMessageHook(flow=<TCPFlow (1 messages)>)\r\n[::1]:61584:   << TcpMessageHook(flow=<TCPFlow (1 messages)>)\r\n[::1]:61584 <- tcp <- localhost:10022\r\n[::1]:61584:   >> Reply(TcpMessageHook(flow=<TCPFlow (1 messages)>),None)\r\n[::1]:61584:     >> Reply(TcpMessageHook(flow=<TCPFlow (1 messages)>),None)\r\n[::1]:61584:     << SendData(client, b'421 1 users (the maximum) are already logged in, sorry\\r\\n')\r\n[::1]:61584:   << SendData(client, b'421 1 users (the maximum) are already logged in, sorry\\r\\n')\r\n[::1]:61584:     !> ConnectionClosed(connection=Server({'id': '…5c8bf8', 'address': ('localhost', 10022), 'state': <ConnectionState.CAN_WRITE: 2>, 'timestamp_start': 1624612004.7545989, 'timestamp_tcp_setup': 1624612004.7556005, 'peername': ('::1', 10022, 0, 0), 'sockname': ('::1', 61585, 0, 0)}))\r\n[::1]:61584:     << CloseConnection({'connection': Client({'id': '…f34b73', 'peername': ('::1', 61584, 0, 0), 'sockname': ('::1', 10021, 0, 0), 'timestamp_start': 1624612004.7495992, 'state': <ConnectionState.OPEN: 3>, 'reply': None}), 'half_close': True})\r\n[::1]:61584:   << CloseConnection({'connection': Client({'id': '…f34b73', 'peername': ('::1', 61584, 0, 0), 'sockname': ('::1', 10021, 0, 0), 'timestamp_start': 1624612004.7495992, 'state': <ConnectionState.OPEN: 3>, 'reply': None}), 'half_close': True})\r\n[::1]:61584: half-closing Client([::1]:61584, state=open)\r\n[::1]:61584:   >> ConnectionClosed(connection=Client({'id': '…f34b73', 'peername': ('::1', 61584, 0, 0), 'sockname': ('::1', 10021, 0, 0), 'timestamp_start': 1624612004.7495992, 'state': <ConnectionState.CLOSED: 0>, 'reply': None}))\r\n[::1]:61584:     >> ConnectionClosed(connection=Client({'id': '…f34b73', 'peername': ('::1', 61584, 0, 0), 'sockname': ('::1', 10021, 0, 0), 'timestamp_start': 1624612004.7495992, 'state': <ConnectionState.CLOSED: 0>, 'reply': None}))\r\n[::1]:61584:     << CloseConnection({'connection': Server({'id': '…5c8bf8', 'address': ('localhost', 10022), 'state': <ConnectionState.CAN_WRITE: 2>, 'timestamp_start': 1624612004.7545989, 'timestamp_tcp_setup': 1624612004.7556005, 'peername': ('::1', 10022, 0, 0), 'sockname': ('::1', 61585, 0, 0)}), 'half_close': False})\r\n[::1]:61584:   << CloseConnection({'connection': Server({'id': '…5c8bf8', 'address': ('localhost', 10022), 'state': <ConnectionState.CAN_WRITE: 2>, 'timestamp_start': 1624612004.7545989, 'timestamp_tcp_setup': 1624612004.7556005, 'peername': ('::1', 10022, 0, 0), 'sockna…\r\n[::1]:61584:     << TcpEndHook(flow=<TCPFlow (1 messages)>)\r\n[::1]:61584:   << TcpEndHook(flow=<TCPFlow (1 messages)>)\r\n[::1]:61584: client disconnect\r\n[::1]:61584: server disconnect localhost ([::1]:10022)\r\n[::1]:61584:   >> Reply(TcpEndHook(flow=<TCPFlow (1 messages)>),None)\r\n[::1]:61584:     >> Reply(TcpEndHook(flow=<TCPFlow (1 messages)>),None)\r\n[::1]:61584: closing transports...\r\n[::1]:61584: transports closed!\r\n```\r\n\r\n","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/comments/868357451/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false}}]