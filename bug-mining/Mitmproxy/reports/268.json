{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/2594","repository_url":"https://api.github.com/repos/mitmproxy/mitmproxy","labels_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/2594/labels{/name}","comments_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/2594/comments","events_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/2594/events","html_url":"https://github.com/mitmproxy/mitmproxy/issues/2594","id":267067487,"node_id":"MDU6SXNzdWUyNjcwNjc0ODc=","number":2594,"title":"Transparent mode fail with looking up failure.","user":{"login":"Ga-ryo","id":5594144,"node_id":"MDQ6VXNlcjU1OTQxNDQ=","avatar_url":"https://avatars.githubusercontent.com/u/5594144?v=4","gravatar_id":"","url":"https://api.github.com/users/Ga-ryo","html_url":"https://github.com/Ga-ryo","followers_url":"https://api.github.com/users/Ga-ryo/followers","following_url":"https://api.github.com/users/Ga-ryo/following{/other_user}","gists_url":"https://api.github.com/users/Ga-ryo/gists{/gist_id}","starred_url":"https://api.github.com/users/Ga-ryo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Ga-ryo/subscriptions","organizations_url":"https://api.github.com/users/Ga-ryo/orgs","repos_url":"https://api.github.com/users/Ga-ryo/repos","events_url":"https://api.github.com/users/Ga-ryo/events{/privacy}","received_events_url":"https://api.github.com/users/Ga-ryo/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":79336502,"node_id":"MDU6TGFiZWw3OTMzNjUwMg==","url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels/kind/bug","name":"kind/bug","color":"d93f0b","default":false,"description":null},{"id":174959532,"node_id":"MDU6TGFiZWwxNzQ5NTk1MzI=","url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels/help%20wanted","name":"help wanted","color":"fbca04","default":true,"description":null},{"id":329157517,"node_id":"MDU6TGFiZWwzMjkxNTc1MTc=","url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels/os/macos","name":"os/macos","color":"eeeeee","default":false,"description":""},{"id":429899749,"node_id":"MDU6TGFiZWw0Mjk4OTk3NDk=","url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels/area/core","name":"area/core","color":"fef2c0","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2017-10-20T05:30:13Z","updated_at":"2017-12-12T21:40:49Z","closed_at":"2017-12-12T21:40:49Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"##### Steps to reproduce the problem:\r\n\r\n1. Launch Wifi Access Point(OS X)\r\n2. Setup pfctl configuration so that http packet will be forwarded.\r\n3. Launch mitmproxy ( `sudo mitmproxy -p 8080 -m transparent --showhost` )\r\n4. Access web page after connecting to AP which launched before.\r\n5. See event log.\r\n\r\n\r\n##### Any other comments? What have you tried so far?\r\n\r\nWhen I tried to use transparent mode with OS X(10.11.6).\r\nRuntimeError(\"Could not resolve original destination.\") raised.\r\n\r\nI investigated this bug.\r\nAnd I found that this is caused by difference between AF_INET's and AF_INET6's peername.\r\nhttps://github.com/mitmproxy/mitmproxy/blob/de006ea8adc08b9a8a6aa94eda2b30468727c307/mitmproxy/net/tcp.py#L567\r\n\r\nIf we use AF_INET, getpeername() return string like `\"192.168.2.5:45670\"`.\r\nBut if we use AF_INET6, getpeername() return string like `\"::ffff:192.168.2.5:45670\"`.\r\n\r\n`pfctl -s state` 's result is like below.\r\n`ALL tcp 192.168.2.5:45670 -> xx.xx.xx.xx:33291 -> xx.xx.xx.xx:443       ESTABLISHED:ESTABLISHED`\r\n\r\nAs you see, `::ffff:` doesn't exist.\r\n\r\nSo [lookup](https://github.com/mitmproxy/mitmproxy/blob/f17c0fdac636f7269f4885294e2a8d2c52c23590/mitmproxy/platform/pf.py#L4) function raises RuntimeError() because `spec in i` condition won't become true.\r\n\r\n##### System information\r\n\r\nMitmproxy version: 3.0.0 (release version)\r\nPython version: 3.6.2\r\nPlatform: Darwin-15.6.0-x86_64-i386-64bit\r\nSSL version: OpenSSL 1.0.2l  25 May 2017\r\nMac version: 10.11.6 ('', '', '') x86_64","closed_by":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/2594/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/2594/timeline","performed_via_github_app":null,"state_reason":"completed"}