{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/2622","repository_url":"https://api.github.com/repos/mitmproxy/mitmproxy","labels_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/2622/labels{/name}","comments_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/2622/comments","events_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/2622/events","html_url":"https://github.com/mitmproxy/mitmproxy/issues/2622","id":271798254,"node_id":"MDU6SXNzdWUyNzE3OTgyNTQ=","number":2622,"title":"Console Options: Wrong help text shown when entering value.","user":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":79336502,"node_id":"MDU6TGFiZWw3OTMzNjUwMg==","url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels/kind/bug","name":"kind/bug","color":"d93f0b","default":false,"description":null},{"id":426474723,"node_id":"MDU6TGFiZWw0MjY0NzQ3MjM=","url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels/area/console","name":"area/console","color":"fef2c0","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/milestones/19","html_url":"https://github.com/mitmproxy/mitmproxy/milestone/19","labels_url":"https://api.github.com/repos/mitmproxy/mitmproxy/milestones/19/labels","id":2215185,"node_id":"MDk6TWlsZXN0b25lMjIxNTE4NQ==","number":19,"title":"3.0","description":"","creator":{"login":"cortesi","id":22544,"node_id":"MDQ6VXNlcjIyNTQ0","avatar_url":"https://avatars.githubusercontent.com/u/22544?v=4","gravatar_id":"","url":"https://api.github.com/users/cortesi","html_url":"https://github.com/cortesi","followers_url":"https://api.github.com/users/cortesi/followers","following_url":"https://api.github.com/users/cortesi/following{/other_user}","gists_url":"https://api.github.com/users/cortesi/gists{/gist_id}","starred_url":"https://api.github.com/users/cortesi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cortesi/subscriptions","organizations_url":"https://api.github.com/users/cortesi/orgs","repos_url":"https://api.github.com/users/cortesi/repos","events_url":"https://api.github.com/users/cortesi/events{/privacy}","received_events_url":"https://api.github.com/users/cortesi/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":60,"state":"closed","created_at":"2016-12-26T03:49:12Z","updated_at":"2018-03-05T20:25:15Z","due_on":null,"closed_at":"2018-03-05T20:25:15Z"},"comments":0,"created_at":"2017-11-07T11:28:18Z","updated_at":"2017-12-20T06:49:06Z","closed_at":"2017-12-20T06:49:05Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"##### Steps to reproduce the problem:\r\n\r\n1. Use arrow keys to navigate to random option, e.g. ciphers_client. The help string now is \"Set supported ciphers for client connections using OpenSSL syntax.\"\r\n2. Press enter twice to start and finish edit.\r\n3. The help box now shows the help text of the first option (\"Add all certificates of the upstream server to the certificate chain that will be served to the proxy client, as extras.\")\r\n\r\n##### Any other comments? What have you tried so far?\r\n\r\nThe problem is that we have two OptionList instances, which in combination with blinker send conflicting signals to OptionHelp.\r\n\r\nThe following patch helps with debugging:\r\n```diff\r\ndiff --git a/mitmproxy/tools/console/options.py b/mitmproxy/tools/console/options.py\r\nindex 4d55aee..9787343 100644\r\n--- a/mitmproxy/tools/console/options.py\r\n+++ b/mitmproxy/tools/console/options.py\r\n@@ -93,10 +93,17 @@ class OptionItem(urwid.WidgetWrap):\r\n\r\n\r\n class OptionListWalker(urwid.ListWalker):\r\n+    instances = []\r\n+\r\n     def __init__(self, master):\r\n         self.master = master\r\n\r\n-        self.index = 0\r\n+        import traceback; traceback.print_stack()\r\n+        input(\"Initialization of \" + repr(self))\r\n+\r\n+        self.changes = []\r\n+        self.instances.append(self)\r\n+        self._index = 0\r\n         self.focusobj = None\r\n\r\n         self.opts = sorted(master.options.keys())\r\n@@ -105,6 +112,16 @@ class OptionListWalker(urwid.ListWalker):\r\n         self.set_focus(0)\r\n         self.master.options.changed.connect(self.sig_mod)\r\n\r\n+    @property\r\n+    def index(self):\r\n+        return self._index\r\n+\r\n+    @index.setter\r\n+    def index(self, val):\r\n+        self.changes.append(val)\r\n+        self._index = val\r\n+        print(self, {i: i.changes for i in self.instances})\r\n+\r\n     def sig_mod(self, *args, **kwargs):\r\n         self._modified()\r\n         self.set_focus(self.index)\r\n(\r\n```\r\n\r\nThe initial output of running mitmproxy with this looks as follows:\r\n```\r\nÎ» mitmproxy\r\n  File \"/home/user/venv/bin/mitmproxy\", line 11, in <module>\r\n    load_entry_point('mitmproxy', 'console_scripts', 'mitmproxy')()\r\n  File \"/mnt/c/Users/user/git/mitmproxy/mitmproxy/tools/main.py\", line 137, in mitmproxy\r\n    run(console.master.ConsoleMaster, cmdline.mitmproxy, args)\r\n  File \"/mnt/c/Users/user/git/mitmproxy/mitmproxy/tools/main.py\", line 119, in run\r\n    master.run()\r\n  File \"/mnt/c/Users/user/git/mitmproxy/mitmproxy/tools/console/master.py\", line 192, in run\r\n    self.window = window.Window(self)\r\n  File \"/mnt/c/Users/user/git/mitmproxy/mitmproxy/tools/console/window.py\", line 126, in __init__\r\n    WindowStack(master, \"flowlist\"),\r\n  File \"/mnt/c/Users/user/git/mitmproxy/mitmproxy/tools/console/window.py\", line 37, in __init__\r\n    options = options.Options(master),\r\n  File \"/mnt/c/Users/user/git/mitmproxy/mitmproxy/tools/console/options.py\", line 269, in __init__\r\n    self.optionslist = OptionsList(master)\r\n  File \"/mnt/c/Users/user/git/mitmproxy/mitmproxy/tools/console/options.py\", line 176, in __init__\r\n    self.walker = OptionListWalker(master)\r\n  File \"/mnt/c/Users/user/git/mitmproxy/mitmproxy/tools/console/options.py\", line 101, in __init__\r\n    import traceback; traceback.print_stack()\r\nInitialization of <mitmproxy.tools.console.options.OptionListWalker object at 0x7f0f9f19e048>\r\n<mitmproxy.tools.console.options.OptionListWalker object at 0x7f0f9f19e048> {<mitmproxy.tools.console.options.OptionListWalker object at 0x7f0f9f19e048>: [0]}\r\n  File \"/home/user/venv/bin/mitmproxy\", line 11, in <module>\r\n    load_entry_point('mitmproxy', 'console_scripts', 'mitmproxy')()\r\n  File \"/mnt/c/Users/user/git/mitmproxy/mitmproxy/tools/main.py\", line 137, in mitmproxy\r\n    run(console.master.ConsoleMaster, cmdline.mitmproxy, args)\r\n  File \"/mnt/c/Users/user/git/mitmproxy/mitmproxy/tools/main.py\", line 119, in run\r\n    master.run()\r\n  File \"/mnt/c/Users/user/git/mitmproxy/mitmproxy/tools/console/master.py\", line 192, in run\r\n    self.window = window.Window(self)\r\n  File \"/mnt/c/Users/user/git/mitmproxy/mitmproxy/tools/console/window.py\", line 127, in __init__\r\n    WindowStack(master, \"eventlog\")\r\n  File \"/mnt/c/Users/user/git/mitmproxy/mitmproxy/tools/console/window.py\", line 37, in __init__\r\n    options = options.Options(master),\r\n  File \"/mnt/c/Users/user/git/mitmproxy/mitmproxy/tools/console/options.py\", line 269, in __init__\r\n    self.optionslist = OptionsList(master)\r\n  File \"/mnt/c/Users/user/git/mitmproxy/mitmproxy/tools/console/options.py\", line 176, in __init__\r\n    self.walker = OptionListWalker(master)\r\n  File \"/mnt/c/Users/user/git/mitmproxy/mitmproxy/tools/console/options.py\", line 101, in __init__\r\n    import traceback; traceback.print_stack()\r\nInitialization of <mitmproxy.tools.console.options.OptionListWalker object at 0x7f0f9f1d5710>\r\n```\r\n\r\n@cortesi: I'm not really into WindowStack, what is happening here?\r\n\r\n##### System information\r\n\r\n```\r\nMitmproxy: 3.0.0dev0958 (4cb96de)\r\nPython:    3.5.2\r\nOpenSSL:   OpenSSL 1.0.2g  1 Mar 2016\r\nPlatform:  Linux-4.4.0-43-Microsoft-x86_64-with-Ubuntu-16.04-xenial\r\n```\r\n\r\n<!-- Please use the mitmproxy forums (https://discourse.mitmproxy.org/) for support/how-to questions. Thanks! :) -->\r\n","closed_by":{"login":"cortesi","id":22544,"node_id":"MDQ6VXNlcjIyNTQ0","avatar_url":"https://avatars.githubusercontent.com/u/22544?v=4","gravatar_id":"","url":"https://api.github.com/users/cortesi","html_url":"https://github.com/cortesi","followers_url":"https://api.github.com/users/cortesi/followers","following_url":"https://api.github.com/users/cortesi/following{/other_user}","gists_url":"https://api.github.com/users/cortesi/gists{/gist_id}","starred_url":"https://api.github.com/users/cortesi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cortesi/subscriptions","organizations_url":"https://api.github.com/users/cortesi/orgs","repos_url":"https://api.github.com/users/cortesi/repos","events_url":"https://api.github.com/users/cortesi/events{/privacy}","received_events_url":"https://api.github.com/users/cortesi/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/2622/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/2622/timeline","performed_via_github_app":null,"state_reason":"completed"}