{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/1858","repository_url":"https://api.github.com/repos/mitmproxy/mitmproxy","labels_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/1858/labels{/name}","comments_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/1858/comments","events_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/1858/events","html_url":"https://github.com/mitmproxy/mitmproxy/issues/1858","id":195657176,"node_id":"MDU6SXNzdWUxOTU2NTcxNzY=","number":1858,"title":"flow.request.urlencoded_form does not work with Unicode parameters in Python 3","user":{"login":"rofreg","id":81912,"node_id":"MDQ6VXNlcjgxOTEy","avatar_url":"https://avatars.githubusercontent.com/u/81912?v=4","gravatar_id":"","url":"https://api.github.com/users/rofreg","html_url":"https://github.com/rofreg","followers_url":"https://api.github.com/users/rofreg/followers","following_url":"https://api.github.com/users/rofreg/following{/other_user}","gists_url":"https://api.github.com/users/rofreg/gists{/gist_id}","starred_url":"https://api.github.com/users/rofreg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rofreg/subscriptions","organizations_url":"https://api.github.com/users/rofreg/orgs","repos_url":"https://api.github.com/users/rofreg/repos","events_url":"https://api.github.com/users/rofreg/events{/privacy}","received_events_url":"https://api.github.com/users/rofreg/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":79336502,"node_id":"MDU6TGFiZWw3OTMzNjUwMg==","url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels/kind/bug","name":"kind/bug","color":"d93f0b","default":false,"description":null},{"id":429896009,"node_id":"MDU6TGFiZWw0Mjk4OTYwMDk=","url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels/area/protocols","name":"area/protocols","color":"fef2c0","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/milestones/16","html_url":"https://github.com/mitmproxy/mitmproxy/milestone/16","labels_url":"https://api.github.com/repos/mitmproxy/mitmproxy/milestones/16/labels","id":1982753,"node_id":"MDk6TWlsZXN0b25lMTk4Mjc1Mw==","number":16,"title":"1.0","description":"This will be the first Python3-only release. ","creator":{"login":"cortesi","id":22544,"node_id":"MDQ6VXNlcjIyNTQ0","avatar_url":"https://avatars.githubusercontent.com/u/22544?v=4","gravatar_id":"","url":"https://api.github.com/users/cortesi","html_url":"https://github.com/cortesi","followers_url":"https://api.github.com/users/cortesi/followers","following_url":"https://api.github.com/users/cortesi/following{/other_user}","gists_url":"https://api.github.com/users/cortesi/gists{/gist_id}","starred_url":"https://api.github.com/users/cortesi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cortesi/subscriptions","organizations_url":"https://api.github.com/users/cortesi/orgs","repos_url":"https://api.github.com/users/cortesi/repos","events_url":"https://api.github.com/users/cortesi/events{/privacy}","received_events_url":"https://api.github.com/users/cortesi/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":19,"state":"closed","created_at":"2016-09-04T23:29:01Z","updated_at":"2016-12-26T03:42:42Z","due_on":"2016-12-15T08:00:00Z","closed_at":"2016-12-26T03:42:42Z"},"comments":3,"created_at":"2016-12-14T21:57:07Z","updated_at":"2016-12-19T14:23:20Z","closed_at":"2016-12-19T14:19:05Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"##### Steps to reproduce the problem:\r\n\r\n1. Save the following as `test_script.py`:\r\n```\r\nimport mitmproxy\r\nimport json\r\n\r\ndef request(flow):\r\n  if flow.request.urlencoded_form:\r\n    mitmproxy.ctx.log(str(flow.request.urlencoded_form))\r\n  else:\r\n    mitmproxy.ctx.log(\"No form parameters found\")\r\n```\r\n2. Launch `mitmdump` with `mitmdump -s test_script.py`\r\n3. Point your browser to `https://secure.splitwise.com/login`, and try to log in with any username or password (don't worry, you don't need an actual account)\r\n\r\nThe expected behavior is for `flow.request.urlencoded_form` to return a list of form parameters that includes `('utf8', '✓')` (or `(b'utf8', b'%E2%9C%93')`). Instead, `flow.request.urlencoded_form` returns no parameters at all, because it throws an exception trying to process the Unicode `✓` symbol that is included in the form.\r\n\r\n##### Any other comments? What have you tried so far?\r\n\r\nA semi-working fix is to update [this line](https://github.com/mitmproxy/mitmproxy/blob/master/mitmproxy/net/http/request.py#L363) to the following:\r\n```\r\nreturn tuple(mitmproxy.net.http.url.decode(str(self.content)))\r\n```\r\nIt appears that `mitmproxy.net.http.url.decode` chokes when trying to process a parameter of the `bytes` type, but it succeeds when processing a parameter of the `str` type. Unfortunately, this also changes the type of the returned tuples from `bytes` to `str`, which probably isn't backwards-compatible with existing usage of mitmproxy. Not sure if there's an easy way to fix that – I plan to keep investigating, but if anyone has suggestions or expertise, I'd appreciate the help!\r\n\r\n##### System information\r\n\r\n```\r\nMitmproxy version: 0.19\r\nPython version: 3.5.2\r\nPlatform: Darwin-16.1.0-x86_64-i386-64bit\r\nSSL version: OpenSSL 1.0.2j  26 Sep 2016\r\nMac version: 10.12.1 ('', '', '') x86_64\r\n```\r\n\r\n/cc @jhottenstein","closed_by":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/1858/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/1858/timeline","performed_via_github_app":null,"state_reason":"completed"}