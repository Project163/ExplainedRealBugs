{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/6143","repository_url":"https://api.github.com/repos/mitmproxy/mitmproxy","labels_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/6143/labels{/name}","comments_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/6143/comments","events_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/6143/events","html_url":"https://github.com/mitmproxy/mitmproxy/issues/6143","id":1723644242,"node_id":"I_kwDOAAfumM5mvLlS","number":6143,"title":"Wrong SNI hostname used for reverse HTTPS proxy","user":{"login":"jciaffi","id":62593000,"node_id":"MDQ6VXNlcjYyNTkzMDAw","avatar_url":"https://avatars.githubusercontent.com/u/62593000?v=4","gravatar_id":"","url":"https://api.github.com/users/jciaffi","html_url":"https://github.com/jciaffi","followers_url":"https://api.github.com/users/jciaffi/followers","following_url":"https://api.github.com/users/jciaffi/following{/other_user}","gists_url":"https://api.github.com/users/jciaffi/gists{/gist_id}","starred_url":"https://api.github.com/users/jciaffi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jciaffi/subscriptions","organizations_url":"https://api.github.com/users/jciaffi/orgs","repos_url":"https://api.github.com/users/jciaffi/repos","events_url":"https://api.github.com/users/jciaffi/events{/privacy}","received_events_url":"https://api.github.com/users/jciaffi/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":79336502,"node_id":"MDU6TGFiZWw3OTMzNjUwMg==","url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels/kind/bug","name":"kind/bug","color":"d93f0b","default":false,"description":null},{"id":429896009,"node_id":"MDU6TGFiZWw0Mjk4OTYwMDk=","url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels/area/protocols","name":"area/protocols","color":"fef2c0","default":false,"description":null},{"id":2831217282,"node_id":"MDU6TGFiZWwyODMxMjE3Mjgy","url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels/prio/high","name":"prio/high","color":"B3193B","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2023-05-24T10:13:14Z","updated_at":"2023-05-28T16:35:36Z","closed_at":"2023-05-28T16:35:36Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"#### Problem Description\r\nWhen using mitmproxy in reverse proxy mode, it attempts to use the mitmproxy's domain for SNI in the outer TLS connection, fails to validate that connection and returns \"502 Bad Gateway\" -- \"Certificate verify failed: Hostname mismatch\"\r\n\r\n#### Steps to reproduce the behavior:\r\n1. Start mitmproxy in reverse proxy mode, e.g.\r\n\r\n```mitmproxy --mode reverse:https://www.chimieparistech.psl.eu@8081 --certs locahost=localhost.pem```\r\n\r\n3. Get https://localhost:8081/ with Chrome or Edge\r\n\r\nmitmproxy logs...\r\n```warn: [10:40:24.473][[::1]:62455] Server TLS handshake failed. Certificate verify failed: hostname mismatch```\r\n... and returns to the browser ...\r\n502 Bad Gateway, Certificate verify failed: hostname mismatch.\r\n\r\nA packet capture of the traffic shows that mitmproxy sends at least 2 client Hello packets to the Chimieparistech server. In the first one the SNI is www.chimieparistech.psl.eu but right after, the second one has for SNI : localhost.\r\n\r\nProblem does not repeat when using Firefox or curl. \r\n\r\n#### System Information\r\nMitmproxy: 9.0.1\r\nPython:    3.11.2\r\nOpenSSL:   OpenSSL 3.0.7 1 Nov 2022\r\nPlatform:  Windows-10-10.0.22621-SP0\r\nChrome : Version 113.0.5672.127)\r\nEdge : Version 113.0.1774.50)","closed_by":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/6143/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/6143/timeline","performed_via_github_app":null,"state_reason":"completed"}