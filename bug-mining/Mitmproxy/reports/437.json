{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5343","repository_url":"https://api.github.com/repos/mitmproxy/mitmproxy","labels_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5343/labels{/name}","comments_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5343/comments","events_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5343/events","html_url":"https://github.com/mitmproxy/mitmproxy/issues/5343","id":1234366426,"node_id":"I_kwDOAAfumM5Jku_a","number":5343,"title":"`test_fuzz_cancel` crashes for some inputs","user":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":79336502,"node_id":"MDU6TGFiZWw3OTMzNjUwMg==","url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels/kind/bug","name":"kind/bug","color":"d93f0b","default":false,"description":null},{"id":429896009,"node_id":"MDU6TGFiZWw0Mjk4OTYwMDk=","url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels/area/protocols","name":"area/protocols","color":"fef2c0","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-05-12T18:55:25Z","updated_at":"2022-05-15T20:18:32Z","closed_at":"2022-05-15T20:18:32Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"From https://github.com/mitmproxy/mitmproxy/runs/6411486204:\r\n\r\n```python\r\n_______________________________ test_fuzz_cancel _______________________________\r\n\r\n    @given(stream_request=booleans(), stream_response=booleans(), data=data())\r\n>   def test_fuzz_cancel(stream_request, stream_response, data):\r\n\r\ntest/mitmproxy/proxy/layers/http/test_http_fuzz.py:420: \r\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \r\ntest/mitmproxy/proxy/layers/http/test_http_fuzz.py:421: in test_fuzz_cancel\r\n    _test_cancel(\r\ntest/mitmproxy/proxy/layers/http/test_http_fuzz.py:526: in _test_cancel\r\n    assert playbook >> evt\r\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \r\n\r\nself = <test.mitmproxy.proxy.tutils.Playbook object at 0x1094a4ac0>\r\n\r\n    def __bool__(self):\r\n        \"\"\"Determine if playbook is correct.\"\"\"\r\n        already_asserted = len(self.actual)\r\n        i = already_asserted\r\n        while i < len(self.expected):\r\n            x = self.expected[i]\r\n            if isinstance(x, commands.Command):\r\n                pass\r\n            else:\r\n                if hasattr(x, \"playbook_eval\"):\r\n                    try:\r\n                        x = self.expected[i] = x.playbook_eval(self)\r\n                    except Exception:\r\n                        self.actual.append(_TracebackInPlaybook(traceback.format_exc()))\r\n                        break\r\n                for name, value in vars(x).items():\r\n                    if isinstance(value, _Placeholder):\r\n                        setattr(x, name, value())\r\n                if isinstance(x, events.OpenConnectionCompleted) and not x.reply:\r\n                    x.command.connection.state = ConnectionState.OPEN\r\n                    x.command.connection.timestamp_start = 1624544785\r\n                elif isinstance(x, events.ConnectionClosed):\r\n                    x.connection.state &= ~ConnectionState.CAN_READ\r\n                    x.connection.timestamp_end = 1624544787\r\n    \r\n                self.actual.append(x)\r\n                cmds: list[commands.Command] = []\r\n                try:\r\n                    # consume them one by one so that we can extend the log with all commands until traceback.\r\n                    for cmd in self.layer.handle_event(x):\r\n                        cmds.append(cmd)\r\n                except Exception:\r\n                    self.actual.extend(cmds)\r\n                    self.actual.append(_TracebackInPlaybook(traceback.format_exc()))\r\n                    break\r\n    \r\n                cmds = list(\r\n                    _merge_sends(\r\n                        cmds, ignore_hooks=not self.hooks, ignore_logs=not self.logs\r\n                    )\r\n                )\r\n    \r\n                self.actual.extend(cmds)\r\n                pos = len(self.actual) - len(cmds) - 1\r\n                hook_replies = []\r\n                for cmd in cmds:\r\n                    pos += 1\r\n                    assert self.actual[pos] == cmd\r\n                    if isinstance(cmd, commands.CloseConnection):\r\n                        if cmd.half_close:\r\n                            cmd.connection.state &= ~ConnectionState.CAN_WRITE\r\n                        else:\r\n                            cmd.connection.state = ConnectionState.CLOSED\r\n                    elif isinstance(cmd, commands.Log):\r\n                        need_to_emulate_log = (\r\n                            not self.logs\r\n                            and cmd.level in (\"debug\", \"info\")\r\n                            and (\r\n                                pos >= len(self.expected)\r\n                                or not isinstance(self.expected[pos], commands.Log)\r\n                            )\r\n                        )\r\n                        if need_to_emulate_log:\r\n                            self.expected.insert(pos, cmd)\r\n                    elif isinstance(cmd, commands.StartHook) and not self.hooks:\r\n                        need_to_emulate_hook = not self.hooks and (\r\n                            pos >= len(self.expected)\r\n                            or (\r\n                                not (\r\n                                    isinstance(self.expected[pos], commands.StartHook)\r\n                                    and self.expected[pos].name == cmd.name\r\n                                )\r\n                            )\r\n                        )\r\n                        if need_to_emulate_hook:\r\n                            self.expected.insert(pos, cmd)\r\n                            if cmd.blocking:\r\n                                # the current event may still have yielded more events, so we need to insert\r\n                                # the reply *after* those additional events.\r\n                                hook_replies.append(events.HookCompleted(cmd))\r\n                self.expected = (\r\n                    self.expected[: pos + 1] + hook_replies + self.expected[pos + 1 :]\r\n                )\r\n    \r\n                eq(\r\n                    self.expected[i:], self.actual[i:]\r\n                )  # compare now already to set placeholders\r\n            i += 1\r\n    \r\n        if not eq(self.expected, self.actual):\r\n            self._errored = True\r\n            diffs = list(\r\n                difflib.ndiff(\r\n                    [_fmt_entry(x) for x in self.expected],\r\n                    [_fmt_entry(x) for x in self.actual],\r\n                )\r\n            )\r\n            if already_asserted:\r\n                diffs.insert(already_asserted, \"==== asserted until here ====\")\r\n            diff = \"\\n\".join(diffs)\r\n>           raise AssertionError(f\"Playbook mismatch!\\n{diff}\")\r\nE           AssertionError: Playbook mismatch!\r\nE             >> Start({})\r\nE             << SendData(client, b'\\x00\\x00*\\x04\\x00\\x00\\x00\\x00\\x00\\x00\\x01\\x00\\x00\\x10\\x00\\x00\\x02\\x00\\x00\\x00\\x00\\x00\\x04\\x00\\x00\\xff\\xff\\x00\\x05\\x00\\x00@\\x00\\x00\\x08\\x00\\x00\\x00\\x00\\x00\\x03\\x00\\x00\\x00d\\x00\\x06\\x00\\x01\\x00\\x00')\r\nE             >> DataReceived(client, b'PRI * HTTP/2.0\\r\\n\\r\\nSM\\r\\n\\r\\n')\r\nE             >> DataReceived(client, b'\\x00\\x00\\x00\\x04\\x01\\x00\\x00\\x00\\x00')\r\nE             >> DataReceived(client, b'\\x00\\x00\\r\\x01\\x04\\x00\\x00\\x00\\x01\\x82\\x86\\x84A\\x88/\\x91\\xd3]\\x05\\\\\\x87\\xa7')\r\nE             << HttpRequestHeadersHook(flow=<HTTPFlow\r\n\r\nE                  request = Request(GET example.com:80/)\r\n\r\nE                  response = Response(200, no content)\r\n\r\nE                  error = peer closed connection\r\n\r\nE                  client_conn = Client(client:1234, state=closed, alpn=h2)\r\n\r\nE                  server_conn = Server(example.com:80, state=open, alpn=h2)>)\r\nE             >> DataReceived(client, b'\\x00\\x00\\x03\\x00\\x01\\x00\\x00\\x00\\x01foo')\r\nE             >> Reply(HttpRequestHeadersHook(flow=<HTTPFlow\r\n\r\nE                  request = Request(GET example.com:80/)\r\n\r\nE                  response = Response(200, no content)\r\n\r\nE                  error = peer closed connection\r\n\r\nE                  client_conn = Client(client:1234, state=closed, alpn=h2)\r\n\r\nE                  server_conn = Server(example.com:80, state=open, alpn=h2)>), None)\r\nE             << OpenConnection({'connection': Server({'id': '…149a8d', 'address': ('example.com', 80), 'state': <ConnectionState.OPEN: 3>, 'transport_protocol': 'tcp', 'alpn': b'h2', 'timestamp_start': 1624544785})})\r\nE             >> Reply(OpenConnection({'connection': Server({'id': '…149a8d', 'address': ('example.com', 80), 'state': <ConnectionState.OPEN: 3>, 'transport_protocol': 'tcp', 'alpn': b'h2', 'timestamp_start': 1624544785})}), None)\r\nE           - << Log('Streaming request to example.com.', 'info')\r\nE           + << SendData(server, b'PRI * HTTP/2.0\\r\\n\\r\\nSM\\r\\n\\r\\n\\x00\\x00*\\x04\\x00\\x00\\x00\\x00\\x00\\x00\\x01\\x00\\x00\\x10\\x00\\x00\\x02\\x00\\x00\\x00\\x00\\x00\\x04\\x00\\x00\\xff\\xff\\x00\\x05\\x00\\x00@\\x00\\x00\\x08\\x00\\x00\\x00\\x00\\x00\\x03\\x00\\x00\\x00d\\x00\\x06\\x00\\x01\\x00\\x00\\x00\\x00\\r\\x01\\x04\\x00\\x00\\x00\\x01\\x82\\x86\\x84A\\x88/\\x91\\xd3]\\x05\\\\\\x87\\xa7\\x00\\x00\\x03\\x00\\x00\\x00\\x00\\x00\\x01foo')\r\nE             << Log('Streaming request to example.com.', 'info')\r\nE             << HttpRequestHook(flow=<HTTPFlow\r\n\r\nE                  request = Request(GET example.com:80/)\r\n\r\nE                  response = Response(200, no content)\r\n\r\nE                  error = peer closed connection\r\n\r\nE                  client_conn = Client(client:1234, state=closed, alpn=h2)\r\n\r\nE                  server_conn = Server(example.com:80, state=open, alpn=h2)>)\r\nE             >> DataReceived(server, b'\\x00\\x00\\x01\\x01\\x04\\x00\\x00\\x00\\x01\\x88')\r\nE             >> ConnectionClosed(connection=Client({'id': '…9d91e6', 'peername': ('client', 1234), 'sockname': ('127.0.0.1', 8080), 'timestamp_start': 1605699329, 'state': <ConnectionState.CLOSED: 0>, 'transport_protocol': 'tcp', 'alpn': b'h2', 'timestamp_end': 1624544787}))\r\nE             << CloseConnection({'connection': Client({'id': '…9d91e6', 'peername': ('client', 1234), 'sockname': ('127.0.0.1', 8080), 'timestamp_start': 1605699329, 'state': <ConnectionState.CLOSED: 0>, 'transport_protocol': 'tcp', 'alpn': b'h2', 'timestamp_end': 1624544787}), 'half_close': False})\r\nE             >> Reply(HttpRequestHook(flow=<HTTPFlow\r\n\r\nE                  request = Request(GET example.com:80/)\r\n\r\nE                  response = Response(200, no content)\r\n\r\nE                  error = peer closed connection\r\n\r\nE                  client_conn = Client(client:1234, state=closed, alpn=h2)\r\n\r\nE                  server_conn = Server(example.com:80, state=open, alpn=h2)>), None)\r\nE             << SendData(server, b'\\x00\\x00\\x00\\x00\\x01\\x00\\x00\\x00\\x01')\r\nE             << HttpResponseHeadersHook(flow=<HTTPFlow\r\n\r\nE                  request = Request(GET example.com:80/)\r\n\r\nE                  response = Response(200, no content)\r\n\r\nE                  error = peer closed connection\r\n\r\nE                  client_conn = Client(client:1234, state=closed, alpn=h2)\r\n\r\nE                  server_conn = Server(example.com:80, state=open, alpn=h2)>)\r\nE             >> Reply(HttpResponseHeadersHook(flow=<HTTPFlow\r\n\r\nE                  request = Request(GET example.com:80/)\r\n\r\nE                  response = Response(200, no content)\r\n\r\nE                  error = peer closed connection\r\n\r\nE                  client_conn = Client(client:1234, state=closed, alpn=h2)\r\n\r\nE                  server_conn = Server(example.com:80, state=open, alpn=h2)>), None)\r\nE             << HttpErrorHook(flow=<HTTPFlow\r\n\r\nE                  request = Request(GET example.com:80/)\r\n\r\nE                  response = Response(200, no content)\r\n\r\nE                  error = peer closed connection\r\n\r\nE                  client_conn = Client(client:1234, state=closed, alpn=h2)\r\n\r\nE                  server_conn = Server(example.com:80, state=open, alpn=h2)>)\r\nE           ==== asserted until here ====\r\nE             >> Reply(HttpErrorHook(flow=<HTTPFlow\r\n\r\nE                  request = Request(GET example.com:80/)\r\n\r\nE                  response = Response(200, no content)\r\n\r\nE                  error = peer closed connection\r\n\r\nE                  client_conn = Client(client:1234, state=closed, alpn=h2)\r\n\r\nE                  server_conn = Server(example.com:80, state=open, alpn=h2)>), None)\r\nE             >> DataReceived(server, b'\\x00\\x00\\x03\\x00\\x01\\x00\\x00\\x00\\x01bar')\r\nE           + << Traceback (most recent call last):\r\nE                  File \"/Users/runner/work/mitmproxy/mitmproxy/mitmproxy/proxy/layers/http/__init__.py\", line 911, in event_to_child\r\nE                    stream = self.streams[command.event.stream_id]\r\nE                KeyError: 1\r\nE           \r\nE                During handling of the above exception, another exception occurred:\r\nE           \r\nE                Traceback (most recent call last):\r\nE                  File \"/Users/runner/work/mitmproxy/mitmproxy/test/mitmproxy/proxy/tutils.py\", line 206, in __bool__\r\nE                    for cmd in self.layer.handle_event(x):\r\nE                  File \"/Users/runner/work/mitmproxy/mitmproxy/mitmproxy/proxy/layer.py\", line 143, in handle_event\r\nE                    command = command_generator.send(send)\r\nE                  File \"/Users/runner/work/mitmproxy/mitmproxy/mitmproxy/proxy/layers/http/__init__.py\", line 890, in _handle_event\r\nE                    yield from self.event_to_child(handler, event)\r\nE                  File \"/Users/runner/work/mitmproxy/mitmproxy/mitmproxy/proxy/layers/http/__init__.py\", line 914, in event_to_child\r\nE                    assert isinstance(\r\nE                AssertionError\r\n\r\ntest/mitmproxy/proxy/tutils.py:277: AssertionError\r\n---------------------------------- Hypothesis ----------------------------------\r\nFalsifying example: test_fuzz_cancel(\r\n    stream_request=True, stream_response=False, data=data(...),\r\n)\r\nDraw 1: ('data_req', DataReceived(client, b'\\x00\\x00\\r\\x01\\x04\\x00\\x00\\x00\\x01\\x82\\x86\\x84A\\x88/\\x91\\xd3]\\x05\\\\\\x87\\xa7'))\r\nDraw 2: ('data_reqbody', DataReceived(client, b'\\x00\\x00\\x03\\x00\\x01\\x00\\x00\\x00\\x01foo'))\r\nDraw 3: ('reply_hook_req_headers', reply({'args': (), 'to': HttpRequestHeadersHook(flow=Placeholder:<HTTPFlow\r\n  request = Request(GET example.com:80/)\r\n  client_conn = Client(client:1234, state=open, alpn=h2)\r\n  server_conn = Server(<no address>, state=closed)>), 'side_effect': <function _test_cancel.<locals>.maybe_stream at 0x1091a3ac0>}))\r\nDraw 4: ('reply_openconn', reply({'args': (None,), 'to': OpenConnection({'connection': Placeholder:Server({'id': '…149a8d', 'address': ('example.com', 80), 'state': <ConnectionState.CLOSED: 0>, 'transport_protocol': 'tcp'})}), 'side_effect': <function make_h2 at 0x10878ac20>}))\r\nDraw 5: ('data_resp', DataReceived(_placeholder, b'\\x00\\x00\\x01\\x01\\x04\\x00\\x00\\x00\\x01\\x88'))\r\nDraw 6: ('err_client_disc', ConnectionClosed(connection=Client({'id': '…9d91e6', 'peername': ('client', 1234), 'sockname': ('127.0.0.1', 8080), 'timestamp_start': [1605](https://github.com/mitmproxy/mitmproxy/runs/6411486204?check_suite_focus=true#step:6:1605)699329, 'state': <ConnectionState.OPEN: 3>, 'transport_protocol': 'tcp', 'alpn': b'h2'})))\r\nDraw 7: ('reply_hook_req', reply({'args': (), 'to': HttpRequestHook(flow=Placeholder:<HTTPFlow\r\n  request = Request(GET example.com:80/)\r\n  client_conn = Client(client:1234, state=closed, alpn=h2)\r\n  server_conn = Server(example.com:80, state=open, alpn=h2)>), 'side_effect': <function reply.<lambda> at 0x1086a7010>}))\r\nDraw 8: ('reply_hook_resp_headers', reply({'args': (), 'to': HttpResponseHeadersHook(flow=Placeholder:<HTTPFlow\r\n  request = Request(GET example.com:80/)\r\n  response = Response(200, no content)\r\n  client_conn = Client(client:1234, state=closed, alpn=h2)\r\n  server_conn = Server(example.com:80, state=open, alpn=h2)>), 'side_effect': <function _test_cancel.<locals>.maybe_stream at 0x1091a3ac0>}))\r\nDraw 9: ('reply_hook_error', reply({'args': (), 'to': HttpErrorHook(flow=Placeholder:<HTTPFlow\r\n  request = Request(GET example.com:80/)\r\n  response = Response(200, no content)\r\n  error = peer closed connection\r\n  client_conn = Client(client:1234, state=closed, alpn=h2)\r\n  server_conn = Server(example.com:80, state=open, alpn=h2)>), 'side_effect': <function reply.<lambda> at 0x1086a7010>}))\r\nDraw 10: ('data_respbody', DataReceived(_placeholder, b'\\x00\\x00\\x03\\x00\\x01\\x00\\x00\\x00\\x01bar'))\r\n```","closed_by":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5343/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5343/timeline","performed_via_github_app":null,"state_reason":"completed"}