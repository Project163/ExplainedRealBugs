{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/6646","repository_url":"https://api.github.com/repos/mitmproxy/mitmproxy","labels_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/6646/labels{/name}","comments_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/6646/comments","events_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/6646/events","html_url":"https://github.com/mitmproxy/mitmproxy/issues/6646","id":2117599317,"node_id":"I_kwDOAAfumM5-OABV","number":6646,"title":"Console Freezes on Incorrect Timestamps in Flows","user":{"login":"owlux","id":45324938,"node_id":"MDQ6VXNlcjQ1MzI0OTM4","avatar_url":"https://avatars.githubusercontent.com/u/45324938?v=4","gravatar_id":"","url":"https://api.github.com/users/owlux","html_url":"https://github.com/owlux","followers_url":"https://api.github.com/users/owlux/followers","following_url":"https://api.github.com/users/owlux/following{/other_user}","gists_url":"https://api.github.com/users/owlux/gists{/gist_id}","starred_url":"https://api.github.com/users/owlux/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/owlux/subscriptions","organizations_url":"https://api.github.com/users/owlux/orgs","repos_url":"https://api.github.com/users/owlux/repos","events_url":"https://api.github.com/users/owlux/events{/privacy}","received_events_url":"https://api.github.com/users/owlux/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":466930397,"node_id":"MDU6TGFiZWw0NjY5MzAzOTc=","url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels/kind/triage","name":"kind/triage","color":"006b75","default":false,"description":"Unclassified issues"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2024-02-05T03:26:19Z","updated_at":"2024-11-27T10:07:09Z","closed_at":"2024-11-27T10:07:09Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"#### Problem Description\r\nI'm using mitmproxy in WireGuard mode for iOS/Android devices. Sometimes, DNS flows are recorded with the request timestamp being later than the response, which causes the console to freeze when these flows are displayed.\r\n\r\nUpon encountering this issue, manually rendering the screen using a debugger revealed the following error:\r\n\r\n```\r\nTraceback (most recent call last):\r\n  File \"c:\\Users\\x\\Documents\\code\\y\\.venv\\lib\\site-packages\\mitmproxy\\tools\\console\\common.py\", line 352, in format_duration\r\n    99 - 100 * min(math.log2(1 + 1000 * duration) / 12, 0.99)\r\nValueError: math domain error\r\n```\r\n\r\nThe problem seems to be from a negative `duration` value calculated as `f.response.timestamp - f.request.timestamp`. I suspect this causes the faux_idle_callback() in urwid/main_loop.py not to be called anymore, stopping the screen rendering.\r\n\r\nAlthough format_duration is invoked from various layers, the issue only occurs with DNS flows in my environment. Adjusting a single line in the `format_dns_flow()` function within `mitmproxy\\tools\\console\\common.py` resolved the issue.\r\n\r\n```\r\n- if duration:\r\n+ if duration and duration > 0:\r\n```\r\n\r\nThe UI freezing during exceptions made it difficult to pinpoint the problem. It would be helpful if there was a way to output errors to a file.\r\n\r\n#### Steps to Reproduce:\r\n1. Load `invalid_timestamp_dns.flow` in mitmproxy.\r\n2. Notice the screen does not render.\r\n\r\n[invalid_timestamp_dns.zip](https://github.com/mitmproxy/mitmproxy/files/14160108/invalid_timestamp_dns.zip)\r\n\r\n#### System Info\r\nMitmproxy: 10.2.2\r\nPython: 3.11.7\r\nOpenSSL: OpenSSL 3.1.4 24 Oct 2023\r\nPlatform: Windows-10-10.0.22631-SP0\r\n\r\nWireGuard for iOS: 1.0.16 (27)","closed_by":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/6646/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/6646/timeline","performed_via_github_app":null,"state_reason":"completed"}