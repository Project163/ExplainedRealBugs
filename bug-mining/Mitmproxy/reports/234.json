{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/2071","repository_url":"https://api.github.com/repos/mitmproxy/mitmproxy","labels_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/2071/labels{/name}","comments_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/2071/comments","events_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/2071/events","html_url":"https://github.com/mitmproxy/mitmproxy/issues/2071","id":210442126,"node_id":"MDU6SXNzdWUyMTA0NDIxMjY=","number":2071,"title":"[web] Failed to dump flows into json when visiting https website.","user":{"login":"MatthewShao","id":9366279,"node_id":"MDQ6VXNlcjkzNjYyNzk=","avatar_url":"https://avatars.githubusercontent.com/u/9366279?v=4","gravatar_id":"","url":"https://api.github.com/users/MatthewShao","html_url":"https://github.com/MatthewShao","followers_url":"https://api.github.com/users/MatthewShao/followers","following_url":"https://api.github.com/users/MatthewShao/following{/other_user}","gists_url":"https://api.github.com/users/MatthewShao/gists{/gist_id}","starred_url":"https://api.github.com/users/MatthewShao/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MatthewShao/subscriptions","organizations_url":"https://api.github.com/users/MatthewShao/orgs","repos_url":"https://api.github.com/users/MatthewShao/repos","events_url":"https://api.github.com/users/MatthewShao/events{/privacy}","received_events_url":"https://api.github.com/users/MatthewShao/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":79336502,"node_id":"MDU6TGFiZWw3OTMzNjUwMg==","url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels/kind/bug","name":"kind/bug","color":"d93f0b","default":false,"description":null},{"id":429891082,"node_id":"MDU6TGFiZWw0Mjk4OTEwODI=","url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels/area/web","name":"area/web","color":"fef2c0","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2017-02-27T10:21:54Z","updated_at":"2017-02-27T16:10:18Z","closed_at":"2017-02-27T16:10:18Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"##### Steps to reproduce the problem:\r\n\r\n1. start mitmweb and set the correct proxy configuration in the browser.\r\n2. visit [github](https://github.com), or any other website with https\r\n3. mitmweb stuck and throw an exception:\r\n```python\r\nERROR:tornado.application:Exception in callback <function WebMaster.run.<locals>.<lambda> at 0x7f8871ebb378>\r\nTraceback (most recent call last):\r\n  File \"/home/matthew/Hack/mitmproxy/venv3.5/lib/python3.5/site-packages/tornado/ioloop.py\", line 1041, in _run\r\n    return self.callback()\r\n  File \"/home/matthew/Hack/mitmproxy/mitmproxy/tools/web/master.py\", line 109, in <lambda>\r\n    tornado.ioloop.PeriodicCallback(lambda: self.tick(timeout=0), 5).start()\r\n  File \"/home/matthew/Hack/mitmproxy/mitmproxy/master.py\", line 109, in tick\r\n    handle_func(obj)\r\n  File \"/home/matthew/Hack/mitmproxy/mitmproxy/controller.py\", line 70, in wrapper\r\n    master.addons(f.__name__, message)\r\n  File \"/home/matthew/Hack/mitmproxy/mitmproxy/addonmanager.py\", line 90, in __call__\r\n    self.invoke(i, name, *args, **kwargs)\r\n  File \"/home/matthew/Hack/mitmproxy/mitmproxy/addonmanager.py\", line 85, in invoke\r\n    func(*args, **kwargs)\r\n  File \"/home/matthew/Hack/mitmproxy/mitmproxy/addons/view.py\", line 327, in request\r\n    self.add(f)\r\n  File \"/home/matthew/Hack/mitmproxy/mitmproxy/addons/view.py\", line 255, in add\r\n    self.sig_view_add.send(self, flow=f)\r\n  File \"/home/matthew/Hack/mitmproxy/venv3.5/lib/python3.5/site-packages/blinker/base.py\", line 267, in send\r\n    for receiver in self.receivers_for(sender)]\r\n  File \"/home/matthew/Hack/mitmproxy/venv3.5/lib/python3.5/site-packages/blinker/base.py\", line 267, in <listcomp>\r\n    for receiver in self.receivers_for(sender)]\r\n  File \"/home/matthew/Hack/mitmproxy/mitmproxy/tools/web/master.py\", line 58, in _sig_view_add\r\n    data=app.flow_to_json(flow)\r\n  File \"/home/matthew/Hack/mitmproxy/mitmproxy/tools/web/app.py\", line 197, in broadcast\r\n    message = json.dumps(kwargs, ensure_ascii=False).encode(\"utf8\", \"surrogateescape\")\r\n  File \"/usr/lib/python3.5/json/__init__.py\", line 237, in dumps\r\n    **kw).encode(obj)\r\n  File \"/usr/lib/python3.5/json/encoder.py\", line 198, in encode\r\n    chunks = self.iterencode(o, _one_shot=True)\r\n  File \"/usr/lib/python3.5/json/encoder.py\", line 256, in iterencode\r\n    return _iterencode(o, 0)\r\n  File \"/usr/lib/python3.5/json/encoder.py\", line 179, in default\r\n    raise TypeError(repr(o) + \" is not JSON serializable\")\r\nTypeError: b'-----BEGIN CERTIFICATE-----\\nMIIC5jCCAc6gAwIBAgIGDYj0HL5MMA0GCSqGSIb3DQEBCwUAMCgxEjAQBgNVBAMM\\nCW1pdG1wcm94eTESMBAGA1UECgwJbWl0bXByb3h5MB4XDTE3MDIyNTA5MDM0M1oX\\nDTIwMDIyNzA5MDM0M1owFTETMBEGA1UEAwwKZ2l0aHViLmNvbTCCASIwDQYJKoZI\\nhvcNAQEBBQADggEPADCCAQoCggEBAMTLqdlVNA4h2xzkX5XhLO1wtqZX0X0JpsXC\\nHUO+KE3Pf2IBHWFAzeB3SVuaTSIa55UvRUDgZm+gYpl/qswf3MpPB8rkosLtwSJt\\ns7ziAYF0JlrwYW+ZBaH/baQZ4JmgpY3qFzrkNhXwrVW+Wg3uO47w/9GaIuUNVv5t\\nElfbCDBO0wvWt9tgEuaFNLVwOnibN4LEioQw/xnnUZu4JU6u+16rWasARxU7vlGs\\no+CB6wgoK62W4VnSK7aQv6PMAOR49tyzhLXO6LKHQtZA4DG34zXWTYfXhuTC7rnA\\nQ6haZ9qyVyeYclIXpJkmf10q2eJTjQbj8ff4Cj3LYlVmBtC2qbsCAwEAAaMpMCcw\\nJQYDVR0RBB4wHIIKZ2l0aHViLmNvbYIOd3d3LmdpdGh1Yi5jb20wDQYJKoZIhvcN\\nAQELBQADggEBABRJcH+lDB6ec343S+tNYDtr+wWgSiGw7WggKcUpMawBuqY61K4L\\nLoxous98ie5XFfLbZI2rW/sIbMEuhjjamEMNmt83ZmZxo/YzMTXO/HlmHZYm+Vjw\\nTdhGxe5cGTxjCwXhygRHX+IupDjanniwmh2jfg/0SlW7S4YE/MQJ1mcbGyzppwkg\\n4hZ6sEcGe+RC7Sn1tJWlVpA3V8a6udZE8ejlaZV0/PYbJUWyRxAl00PlvRG2sPu5\\nEJM7Xbd0TxtqVX7oagImBhqlhf0CyJfRMq0DU34j0oeUqtV/0FaapMumOODcnloI\\nJeldz1QeX2hHksE1hYeVjZNFNKQLtzvEpgg=\\n-----END CERTIFICATE-----\\n' is not JSON serializable\r\n\r\n```\r\n\r\n##### Any other comments? What have you tried so far?\r\n`Flow.client_conn.mitmcert`is in the type of `bytes`, so `json.dumps()` could not handle it and throw an exception saying that it is not JSON serializable.\r\nI noticed that in `flow_to_json()` function, there is a comment say: \r\n> Remove flow message content and cert to save transmission space.\r\n\r\nAnd we indeed remove the `server_conn.cert` from the returning dict, but left `client_conn.mitmcert`.\r\nI have tried to add one more line of code to remove `client_conn.mitmcert` from the returning dict and it solve this exception. \r\nHowever, I am not sure whether it is appropriate to remove this item. Or should we convert it into a string and keep it in the returning dict?\r\n\r\n##### System information\r\n\r\nMitmproxy version: 3.0.0 (2.0.0dev0028-0x0fdf2c0) \r\nPython version: 3.5.2\r\nPlatform: Linux-4.4.0-63-generic-x86_64-with-Ubuntu-16.04-xenial\r\nSSL version: OpenSSL 1.0.2g  1 Mar 2016\r\nLinux distro: Ubuntu 16.04 xenial\r\n","closed_by":{"login":"Kriechi","id":114300,"node_id":"MDQ6VXNlcjExNDMwMA==","avatar_url":"https://avatars.githubusercontent.com/u/114300?v=4","gravatar_id":"","url":"https://api.github.com/users/Kriechi","html_url":"https://github.com/Kriechi","followers_url":"https://api.github.com/users/Kriechi/followers","following_url":"https://api.github.com/users/Kriechi/following{/other_user}","gists_url":"https://api.github.com/users/Kriechi/gists{/gist_id}","starred_url":"https://api.github.com/users/Kriechi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Kriechi/subscriptions","organizations_url":"https://api.github.com/users/Kriechi/orgs","repos_url":"https://api.github.com/users/Kriechi/repos","events_url":"https://api.github.com/users/Kriechi/events{/privacy}","received_events_url":"https://api.github.com/users/Kriechi/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/2071/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/2071/timeline","performed_via_github_app":null,"state_reason":"completed"}