{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/786","repository_url":"https://api.github.com/repos/mitmproxy/mitmproxy","labels_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/786/labels{/name}","comments_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/786/comments","events_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/786/events","html_url":"https://github.com/mitmproxy/mitmproxy/issues/786","id":108946769,"node_id":"MDU6SXNzdWUxMDg5NDY3Njk=","number":786,"title":"mitmdump produces \"Bad Request\" by replacing host header","user":{"login":"ghost","id":10137,"node_id":"MDQ6VXNlcjEwMTM3","avatar_url":"https://avatars.githubusercontent.com/u/10137?v=4","gravatar_id":"","url":"https://api.github.com/users/ghost","html_url":"https://github.com/ghost","followers_url":"https://api.github.com/users/ghost/followers","following_url":"https://api.github.com/users/ghost/following{/other_user}","gists_url":"https://api.github.com/users/ghost/gists{/gist_id}","starred_url":"https://api.github.com/users/ghost/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ghost/subscriptions","organizations_url":"https://api.github.com/users/ghost/orgs","repos_url":"https://api.github.com/users/ghost/repos","events_url":"https://api.github.com/users/ghost/events{/privacy}","received_events_url":"https://api.github.com/users/ghost/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2015-09-29T19:56:13Z","updated_at":"2019-02-26T21:20:41Z","closed_at":"2015-10-03T21:59:32Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**What's the problem?**\nDifferent sites could not be called when mitmdump runs, e.g. Amazon(US) and CRLs from Microsoft. Amazon will open but do not load some CSS and pictures resulting in an very ugly page. Probably every site using Akamai is affected.\n\n**What's expected?**\nWindows should get its CRLs and Amazon site should be displayed normally.\n\n**Which versions are affected?**\nThe master version of mitmdump/libmproxy from yesterday was used.\nIn detail the last commit should be \nc6811bd0e8 for mitmproxy\n0f9a72580a for pathod and\n2e1f7ecd55 for netlib.\n\n**How to reproduce the problem?**\nIt should be enough to run mitmdump with SSL support and in transparent proxy mode to capture data. Then use a client with installed root certificate to call a site with Akamai like `https://www.amazon.com`. A Windows client may try to update its CRLs after some time.\n\n**Why does this happen?**\nOne CRL from Microsoft is used as an example.\nThe client asked for\n\n```\nGET /pkiops/crl/MicSecSerCA2011_2011-10-18.crl HTTP/1.1\nCache-Control: max-age = 750\nConnection: Keep-Alive\nAccept: */*\nIf-Modified-Since: Sun, 27 Sep 2015 05:01:39 GMT\nIf-None-Match: \"24caf397e1f8d01:0\"\nUser-Agent: Microsoft-CryptoAPI/6.1\nHost: www.microsoft.com\n```\n\nmitmdump will alter this request and asked the server for\n\n```\nGET /pkiops/crl/MicSecSerCA2011_2011-10-18.crl HTTP/1.1\nCache-Control: max-age = 750\nConnection: Keep-Alive\nAccept: */*\nIf-Modified-Since: Sun, 27 Sep 2015 05:01:39 GMT\nIf-None-Match: \"24caf397e1f8d01:0\"\nUser-Agent: Microsoft-CryptoAPI/6.1\nhost: 23.206.108.111\n```\n\nThis leads to the result\n\n```\nHTTP/1.0 400 Bad Request\nServer: AkamaiGHost\nMime-Version: 1.0\nContent-Type: text/html\nContent-Length: 259\nExpires: Tue, 29 Sep 2015 10:50:56 GMT\nDate: Tue, 29 Sep 2015 10:50:56 GMT\nConnection: close\n\n<HTML><HEAD>\n<TITLE>Invalid URL</TITLE>\n</HEAD><BODY>\n<H1>Invalid URL</H1>\nThe requested URL \"&#47;pkiops&#47;crl&#47;MicSecSerCA2011&#95;2011&#45;10&#45;18&#46;crl\", is invalid.<p>\nReference&#32;&#35;9&#46;76a9645f&#46;1443523856&#46;276b8d47\n</BODY></HTML>\n```\n\nMitmdump exchange the Host header with domain with a host header with IP. The RFC mentioned that the header are case-insensitive. Thus the IP seems to be the problem, server with virtual hosts and it seems Akamai server, too, do not know which one is requested.\n\n**Is there a workaround?**\nWell in netlib/http/request.py in the `@host.setter` function starting in line 106 the last part after comment `# Update host header` could be commented out to prevent the Host header to get modified.\n\n**Why is this post here?**\nI am not sure where to post it. The workaround is in netlib but the problem exists in mitmdump thus I put it here. I am sorry if this is wrong.\n\n**Is there something else?**\nMay I ask a question? This is not the first time to see that the destination/host from the TCP layer is used by mitmdump for the header field at HTTP layer. There are different technique like virtual hosts and load balancing which may not work that way. \nIs there a special reason for this strategy?\n","closed_by":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/786/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/786/timeline","performed_via_github_app":null,"state_reason":"completed"}