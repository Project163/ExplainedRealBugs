{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/4312","repository_url":"https://api.github.com/repos/mitmproxy/mitmproxy","labels_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/4312/labels{/name}","comments_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/4312/comments","events_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/4312/events","html_url":"https://github.com/mitmproxy/mitmproxy/issues/4312","id":751527432,"node_id":"MDU6SXNzdWU3NTE1Mjc0MzI=","number":4312,"title":"Mitmdump option \"--modify-headers\" not working if any script added using \"--scripts\".","user":{"login":"Ignisor","id":22328453,"node_id":"MDQ6VXNlcjIyMzI4NDUz","avatar_url":"https://avatars.githubusercontent.com/u/22328453?v=4","gravatar_id":"","url":"https://api.github.com/users/Ignisor","html_url":"https://github.com/Ignisor","followers_url":"https://api.github.com/users/Ignisor/followers","following_url":"https://api.github.com/users/Ignisor/following{/other_user}","gists_url":"https://api.github.com/users/Ignisor/gists{/gist_id}","starred_url":"https://api.github.com/users/Ignisor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Ignisor/subscriptions","organizations_url":"https://api.github.com/users/Ignisor/orgs","repos_url":"https://api.github.com/users/Ignisor/repos","events_url":"https://api.github.com/users/Ignisor/events{/privacy}","received_events_url":"https://api.github.com/users/Ignisor/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":79336502,"node_id":"MDU6TGFiZWw3OTMzNjUwMg==","url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels/kind/bug","name":"kind/bug","color":"d93f0b","default":false,"description":null},{"id":429899749,"node_id":"MDU6TGFiZWw0Mjk4OTk3NDk=","url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels/area/core","name":"area/core","color":"fef2c0","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2020-11-26T11:47:31Z","updated_at":"2020-12-10T09:42:44Z","closed_at":"2020-12-10T09:42:33Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"#### Problem Description\r\nWhen using mitmdump with script specified using `--scripts` option - `--modify-headers` option is ignored.\r\n\r\n#### Steps to reproduce the behavior:\r\n\r\n**1.** Launch `mitmdump` with `--modify-headers`. \r\nMy example: \r\n`mitmdump --set confdir=./.mitmproxy --flow-detail=2 --listen-port=8081 --modify-headers \"/~q/Host/example.org\"`\r\nOutput with `curl -x 127.0.0.1:8081 \"http://www.trackip.net/ip?json\"`:\r\n```\r\n127.0.0.1:50216: clientconnect\r\n127.0.0.1:50216: GET http://www.trackip.net/ip?json\r\n    User-Agent: curl/7.64.1\r\n    Accept: */*\r\n    Proxy-Connection: Keep-Alive\r\n    Host: example.org\r\n << 404 Not Found 1.67k\r\n    Date: Thu, 26 Nov 2020 10:06:22 GMT\r\n    Content-Type: text/html; charset=UTF-8\r\n    Transfer-Encoding: chunked\r\n    Connection: keep-alive\r\n    Set-Cookie: __cfduid=de786483d16a417b8768b01f604ef7f991606385181; expires=Sat, 26-Dec-20 10:06:21 GMT; path=/; domain=.example.org; HttpOnly; SameSite=Lax\r\n    Lookup-Cache-Hit: 1\r\n    Cache-Control: public, max-age=60\r\n    Vary: Accept-Language, Accept-Encoding\r\n    X-Cache: MISS\r\n    X-Cache-Hits: 0\r\n    CF-Cache-Status: MISS\r\n    cf-request-id: 06a59dbd0500002d377c038000000001\r\n    Report-To: {\"endpoints\":[{\"url\":\"https:\\\\/\\\\/a.nel.cloudflare.com\\\\/report?s=NYIz48uJ3L6ZWGjd%2FEO4iNMvcCH0gsGhQhs4dpQ92t5e7W2I3wP1hp%2FoVqfbe94xjJbxqsuNcuvGp4dShFlFYVyn3W0hQX6RveNgJw%3D%3D\"}],\"group\":\"cf-nel\",\"max_age\":604800}\r\n    NEL: {\"report_to\":\"cf-nel\",\"max_age\":604800}\r\n    X-Content-Type-Options: nosniff\r\n    Server: cloudflare\r\n    CF-RAY: 5f82cbdb3f422d37-KBP\r\n127.0.0.1:50216: clientdisconnect\r\n```\r\nHeader `Host` has been replaced with `example.org`, as expected.\r\n\r\n**2.** Now launch `mitmdump` with `--modify-headers` and `--script`.\r\nMy example (using [jsondump.py](https://github.com/mitmproxy/mitmproxy/blob/master/examples/contrib/jsondump.py) script from `examples/contrib`): \r\n`mitmdump --set confdir=./.mitmproxy --flow-detail=2 --listen-port=8081 --modify-headers \"/~q/Host/example.org\" --scripts=\"/Users/ignisor/dev/proxy_lib/proxy/utils/jsondump.py\"`\r\nOutput with `curl -x 127.0.0.1:8081 \"http://www.trackip.net/ip?json\"`:\r\n```\r\nProxy server listening at http://*:8081\r\n127.0.0.1:50412: clientconnect\r\n127.0.0.1:50412: GET http://www.trackip.net/ip?json\r\n    Host: www.trackip.net\r\n    User-Agent: curl/7.64.1\r\n    Accept: */*\r\n    Proxy-Connection: Keep-Alive\r\n << 200 OK 76b\r\n    Date: Thu, 26 Nov 2020 10:11:30 GMT\r\n    Content-Type: text/plain\r\n    Content-Length: 76\r\n    Connection: keep-alive\r\n    Set-Cookie: __cfduid=dd9e78e478768657490d8e5f8df1e870d1606385490; expires=Sat, 26-Dec-20 10:11:30 GMT; path=/; domain=.trackip.net; HttpOnly; SameSite=Lax\r\n    CF-Cache-Status: DYNAMIC\r\n    cf-request-id: 06a5a272a300003f0495bde000000001\r\n    Report-To: {\"endpoints\":[{\"url\":\"https:\\\\/\\\\/a.nel.cloudflare.com\\\\/report?s=E3IAN%2BfUeGUIqX75SqBx%2FwUVisP1%2Fa7iRdHS7P6wUzZI1A6zSkhSqR6sKJ82sZo9tWkzTrtPYVQq6xozPGJ82Y34hSyPXP%2Fo%2FW7kC%2FFulUc%3D\"}],\"group\":\"cf-nel\",\"max_age\":604800}\r\n    NEL: {\"report_to\":\"cf-nel\",\"max_age\":604800}\r\n    Server: cloudflare\r\n    CF-RAY: 5f82d3643d183f04-KBP\r\n127.0.0.1:50412: clientdisconnect\r\n```\r\nHeader `Host` **not changed** and still `www.trackip.net`.\r\n\r\n\r\n#### System Information\r\n\r\n> Mitmproxy: 5.3.0\r\n> Python:    3.9.0\r\n> OpenSSL:   OpenSSL 1.1.1h  22 Sep 2020\r\n> Platform:  macOS-10.16-x86_64-i386-64bit\r\n","closed_by":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/4312/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/4312/timeline","performed_via_github_app":null,"state_reason":"completed"}