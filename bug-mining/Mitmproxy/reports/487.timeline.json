[{"id":5899669710,"node_id":"LE_lADOAAfumM5B23DszwAAAAFfpdDO","url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/events/5899669710","actor":{"login":"ericdraken","id":22000765,"node_id":"MDQ6VXNlcjIyMDAwNzY1","avatar_url":"https://avatars.githubusercontent.com/u/22000765?v=4","gravatar_id":"","url":"https://api.github.com/users/ericdraken","html_url":"https://github.com/ericdraken","followers_url":"https://api.github.com/users/ericdraken/followers","following_url":"https://api.github.com/users/ericdraken/following{/other_user}","gists_url":"https://api.github.com/users/ericdraken/gists{/gist_id}","starred_url":"https://api.github.com/users/ericdraken/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ericdraken/subscriptions","organizations_url":"https://api.github.com/users/ericdraken/orgs","repos_url":"https://api.github.com/users/ericdraken/repos","events_url":"https://api.github.com/users/ericdraken/events{/privacy}","received_events_url":"https://api.github.com/users/ericdraken/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2022-01-16T00:20:57Z","label":{"name":"kind/feature","color":"207de5"},"performed_via_github_app":null},{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/comments/1013887846","html_url":"https://github.com/mitmproxy/mitmproxy/issues/5064#issuecomment-1013887846","issue_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5064","id":1013887846,"node_id":"IC_kwDOAAfumM48brNm","user":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-01-16T14:38:55Z","updated_at":"2022-01-16T14:38:55Z","body":"Thanks for sharing your patches! ðŸ˜ƒ \r\nCould you share how your setup looks like? We do peek at the incoming bytes and extract the SNI right after your additions:\r\nhttps://github.com/mitmproxy/mitmproxy/blob/1abb8f69217910c8623bd1339da2502aed98ff0d/mitmproxy/addons/next_layer.py#L75-L85\r\n\r\nIf that for some reason doesn't pick up a SNI that's a bug we should fix.","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/comments/1013887846/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/comments/1013940510","html_url":"https://github.com/mitmproxy/mitmproxy/issues/5064#issuecomment-1013940510","issue_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5064","id":1013940510,"node_id":"IC_kwDOAAfumM48b4Ee","user":{"login":"ericdraken","id":22000765,"node_id":"MDQ6VXNlcjIyMDAwNzY1","avatar_url":"https://avatars.githubusercontent.com/u/22000765?v=4","gravatar_id":"","url":"https://api.github.com/users/ericdraken","html_url":"https://github.com/ericdraken","followers_url":"https://api.github.com/users/ericdraken/followers","following_url":"https://api.github.com/users/ericdraken/following{/other_user}","gists_url":"https://api.github.com/users/ericdraken/gists{/gist_id}","starred_url":"https://api.github.com/users/ericdraken/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ericdraken/subscriptions","organizations_url":"https://api.github.com/users/ericdraken/orgs","repos_url":"https://api.github.com/users/ericdraken/repos","events_url":"https://api.github.com/users/ericdraken/events{/privacy}","received_events_url":"https://api.github.com/users/ericdraken/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-01-16T19:50:37Z","updated_at":"2022-01-16T19:51:38Z","body":"My pleasure. Well, I wrote an adblocker script and noticed that just before the `allowed_hosts` regex check sometimes in the `hostnames` list there would only be an IP address, and sometimes an IP address and an `*.apple.com` FQDN. I was wondering why only an IP sometimes. I looked at the snipped you shared early on and when I breakpoint I often see just an IP.\r\n\r\n**Here is the thing:** everything works perfectly in proxy mode or regular mode (I get FQDN each time). The problem I described above happens in transparent mode. \r\n\r\nI noticed that the `server.sni` field is available but not appended, and to my delight when I applied my patch, I faithfully see the FQDN of each request. I may need an explanation why it works now as I followed a hunch and got lucky(?).","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/comments/1013940510/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"ericdraken","id":22000765,"node_id":"MDQ6VXNlcjIyMDAwNzY1","avatar_url":"https://avatars.githubusercontent.com/u/22000765?v=4","gravatar_id":"","url":"https://api.github.com/users/ericdraken","html_url":"https://github.com/ericdraken","followers_url":"https://api.github.com/users/ericdraken/followers","following_url":"https://api.github.com/users/ericdraken/following{/other_user}","gists_url":"https://api.github.com/users/ericdraken/gists{/gist_id}","starred_url":"https://api.github.com/users/ericdraken/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ericdraken/subscriptions","organizations_url":"https://api.github.com/users/ericdraken/orgs","repos_url":"https://api.github.com/users/ericdraken/repos","events_url":"https://api.github.com/users/ericdraken/events{/privacy}","received_events_url":"https://api.github.com/users/ericdraken/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/comments/1014250595","html_url":"https://github.com/mitmproxy/mitmproxy/issues/5064#issuecomment-1014250595","issue_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5064","id":1014250595,"node_id":"IC_kwDOAAfumM48dDxj","user":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-01-17T08:18:39Z","updated_at":"2022-01-17T08:18:39Z","body":"> The problem I described above happens in transparent mode.\r\n\r\nThis is somewhat confusing to me - `client.sni` should only be set when the connection is already being intercepted, so your allow/ignore would come too late to stop that. The correct way is really to check if the client sends a client hello (`is_tls_record_magic`) and then parsing said ClientHello. If you have a case where that logic fails I'd be eager to see more, because that then would be a bug we should track down.","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/comments/1014250595/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/comments/1014276878","html_url":"https://github.com/mitmproxy/mitmproxy/issues/5064#issuecomment-1014276878","issue_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5064","id":1014276878,"node_id":"IC_kwDOAAfumM48dKMO","user":{"login":"ericdraken","id":22000765,"node_id":"MDQ6VXNlcjIyMDAwNzY1","avatar_url":"https://avatars.githubusercontent.com/u/22000765?v=4","gravatar_id":"","url":"https://api.github.com/users/ericdraken","html_url":"https://github.com/ericdraken","followers_url":"https://api.github.com/users/ericdraken/followers","following_url":"https://api.github.com/users/ericdraken/following{/other_user}","gists_url":"https://api.github.com/users/ericdraken/gists{/gist_id}","starred_url":"https://api.github.com/users/ericdraken/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ericdraken/subscriptions","organizations_url":"https://api.github.com/users/ericdraken/orgs","repos_url":"https://api.github.com/users/ericdraken/repos","events_url":"https://api.github.com/users/ericdraken/events{/privacy}","received_events_url":"https://api.github.com/users/ericdraken/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-01-17T08:52:37Z","updated_at":"2022-01-17T08:52:37Z","body":"I hope this helps. I put a simple `print(hostnames)` at \r\n\r\nhttps://github.com/mitmproxy/mitmproxy/blob/1abb8f69217910c8623bd1339da2502aed98ff0d/mitmproxy/addons/next_layer.py#L89\r\n\r\nWithout my patch:\r\n\r\n![image](https://user-images.githubusercontent.com/22000765/149736930-117e5523-7dd8-43c1-8736-cf10f3e61b5c.png)\r\n\r\nWith my patch:\r\n\r\n![image](https://user-images.githubusercontent.com/22000765/149737428-09231609-4de8-4189-8f1e-6f66aa3badc7.png)\r\n\r\nRight after each of the arrays is printed, the `ignore_connection` method evaluates an `any` check on the hostname. Unless I'm not understanding correctly, I'd prefer that each connection is rejected or accepted, not just the very first one (screenshot 1).\r\n\r\nIf it helps, I used `--no-http2` religiously. ;)","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/comments/1014276878/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"ericdraken","id":22000765,"node_id":"MDQ6VXNlcjIyMDAwNzY1","avatar_url":"https://avatars.githubusercontent.com/u/22000765?v=4","gravatar_id":"","url":"https://api.github.com/users/ericdraken","html_url":"https://github.com/ericdraken","followers_url":"https://api.github.com/users/ericdraken/followers","following_url":"https://api.github.com/users/ericdraken/following{/other_user}","gists_url":"https://api.github.com/users/ericdraken/gists{/gist_id}","starred_url":"https://api.github.com/users/ericdraken/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ericdraken/subscriptions","organizations_url":"https://api.github.com/users/ericdraken/orgs","repos_url":"https://api.github.com/users/ericdraken/repos","events_url":"https://api.github.com/users/ericdraken/events{/privacy}","received_events_url":"https://api.github.com/users/ericdraken/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/comments/1014406089","html_url":"https://github.com/mitmproxy/mitmproxy/issues/5064#issuecomment-1014406089","issue_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5064","id":1014406089,"node_id":"IC_kwDOAAfumM48dpvJ","user":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-01-17T11:14:44Z","updated_at":"2022-01-17T11:14:51Z","body":"Could you please try the following print statment instead?\r\n```python\r\nprint(f\"{hostnames=} {is_tls_record_magic(data_client)=} {data_client=} {server=}\") \r\n```\r\n\r\n> Unless I'm not understanding correctly, I'd prefer that each connection is rejected or accepted, not just the very first one (screenshot 1).\r\n\r\nI'm not sure if I follow your comment here. If `ignore_hosts` is set, all connections are ignored if they match one or multiple patterns.","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/comments/1014406089/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/comments/1014872214","html_url":"https://github.com/mitmproxy/mitmproxy/issues/5064#issuecomment-1014872214","issue_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5064","id":1014872214,"node_id":"IC_kwDOAAfumM48fbiW","user":{"login":"ericdraken","id":22000765,"node_id":"MDQ6VXNlcjIyMDAwNzY1","avatar_url":"https://avatars.githubusercontent.com/u/22000765?v=4","gravatar_id":"","url":"https://api.github.com/users/ericdraken","html_url":"https://github.com/ericdraken","followers_url":"https://api.github.com/users/ericdraken/followers","following_url":"https://api.github.com/users/ericdraken/following{/other_user}","gists_url":"https://api.github.com/users/ericdraken/gists{/gist_id}","starred_url":"https://api.github.com/users/ericdraken/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ericdraken/subscriptions","organizations_url":"https://api.github.com/users/ericdraken/orgs","repos_url":"https://api.github.com/users/ericdraken/repos","events_url":"https://api.github.com/users/ericdraken/events{/privacy}","received_events_url":"https://api.github.com/users/ericdraken/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-01-17T20:39:07Z","updated_at":"2022-01-17T20:39:07Z","body":"Thank you for indulging me in this conversation.\r\n\r\n**Update:** I believe the problem relates to how I update the `NextLayer` regex.\r\n\r\nHere is a minimal addon demonstrating the problem. I'd like to update the `allow-hosts` or `ignore-hosts` regex through code without triggering the update chain for all addons (this could be the mistake).\r\n\r\n```\r\n# -*- coding: utf-8 -*-\r\n#  Copyright (c) 2021. Eric Draken (ericdraken.com)\r\n#  PoC for Issue #5064\r\nimport re\r\n\r\nfrom mitmproxy import ctx, http\r\nfrom mitmproxy.addons.next_layer import NextLayer\r\nfrom mitmproxy.proxy import layer\r\n\r\nlogger = ctx.log\r\n\r\n\r\nclass MITMLogger:\r\n    \"\"\"PoC for Issue #5064\"\"\"\r\n\r\n    # Intercept only these wildcard domains and no others\r\n    intercept_hosts = r\"example\\.(com|net|org)\"\r\n    intercept_hosts_re = re.compile(intercept_hosts, re.IGNORECASE)\r\n\r\n    \"\"\"The following methods are hooks that are called during the normal flow of MITMProxy\"\"\"\r\n\r\n    # noinspection PyMethodMayBeStatic\r\n    def load(self, _):\r\n        # Do not allow piped requests we could miss\r\n        ctx.options.http2 = False\r\n        try:\r\n            ctx.options.update(http2=False, anticomp=True, mode=\"transparent\", termlog_verbosity=\"debug\")\r\n        except KeyError:\r\n            ctx.options.update(http2=False, anticomp=True, mode=\"transparent\")\r\n        logger.warn(f\"{self.__class__.__name__} loaded\")\r\n\r\n    def running(self):\r\n        \"\"\"Override CLI arguments and update the regex manually\"\"\"\r\n        if ctx.options.allow_hosts != [self.intercept_hosts]:\r\n            ctx.options.allow_hosts = [self.intercept_hosts]\r\n\r\n            ctx.options.ignore_hosts = []\r\n            next_layer_addon: NextLayer = ctx.master.addons.get(\"NextLayer\".lower())\r\n            next_layer_addon.configure(\"allow_hosts\")\r\n            logger.warn(f\"Updated interceptable hosts\")\r\n\r\n    def next_layer(self, nextlayer: layer.NextLayer):\r\n        \"\"\"Do I want to passthru or block the request? Here is my chance.\"\"\"\r\n        logger.warn(nextlayer) # Usually none, so repr() should be changed in NextLayer\r\n        logger.warn(nextlayer.context)\r\n\r\n    def request(self, flow: http.HTTPFlow) -> None:\r\n        logger.warn(f\">> {flow.request.pretty_url}\\n\\n\")\r\n\r\n    # noinspection PyMethodMayBeStatic\r\n    def error(self, flow: http.HTTPFlow):\r\n        logger.warn(f\">> {flow.request.pretty_url}\\n<< {flow.error}\\n\\n\")\r\n\r\n    def response(self, flow: http.HTTPFlow):\r\n        logger.warn(f\">> {flow.request.pretty_url}\\n<< {flow.response}\\n\\n\")\r\n\r\n\r\n# Register the addon\r\naddons = [MITMLogger()]\r\n```\r\n\r\nSimple curl:\r\n\r\n`curl --ssl-no-revoke https://example.com/`\r\n\r\n![image](https://user-images.githubusercontent.com/22000765/149833856-fb00c6b8-fe5e-447e-b751-ca6c89399826.png)\r\n\r\n![image](https://user-images.githubusercontent.com/22000765/149833869-fb402efc-7a0e-4630-a0c0-0921740d7101.png)\r\n\r\nHowever, if adding `--allow-hosts` the normal way:\r\n\r\n![image](https://user-images.githubusercontent.com/22000765/149833737-17c727ad-e9bf-4758-84fb-d28bb5659028.png)\r\n\r\n![image](https://user-images.githubusercontent.com/22000765/149833744-6001c05e-3fc0-4b3e-a7bc-62e25ef511bb.png)\r\n\r\nSomehow, I get both the server IP and hostname with my patch + setting the regex manually. The root of this issue may be in the way I update the regex. A better approach? I need to update the regex frequently.\r\n\r\n---\r\n\r\n> Could you please try the following print statment instead?\r\n> print(f\"{hostnames=} {is_tls_record_magic(data_client)=} {data_client=} {server=}\") \r\n\r\nCertainly. Using the regex update:\r\n\r\n![image](https://user-images.githubusercontent.com/22000765/149834446-08c5dff9-fcb1-49e7-8612-1ca4103b7c32.png)\r\n\r\n","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/comments/1014872214/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"ericdraken","id":22000765,"node_id":"MDQ6VXNlcjIyMDAwNzY1","avatar_url":"https://avatars.githubusercontent.com/u/22000765?v=4","gravatar_id":"","url":"https://api.github.com/users/ericdraken","html_url":"https://github.com/ericdraken","followers_url":"https://api.github.com/users/ericdraken/followers","following_url":"https://api.github.com/users/ericdraken/following{/other_user}","gists_url":"https://api.github.com/users/ericdraken/gists{/gist_id}","starred_url":"https://api.github.com/users/ericdraken/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ericdraken/subscriptions","organizations_url":"https://api.github.com/users/ericdraken/orgs","repos_url":"https://api.github.com/users/ericdraken/repos","events_url":"https://api.github.com/users/ericdraken/events{/privacy}","received_events_url":"https://api.github.com/users/ericdraken/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/comments/1333102612","html_url":"https://github.com/mitmproxy/mitmproxy/issues/5064#issuecomment-1333102612","issue_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5064","id":1333102612,"node_id":"IC_kwDOAAfumM5PdYgU","user":{"login":"gotoin","id":15847842,"node_id":"MDQ6VXNlcjE1ODQ3ODQy","avatar_url":"https://avatars.githubusercontent.com/u/15847842?v=4","gravatar_id":"","url":"https://api.github.com/users/gotoin","html_url":"https://github.com/gotoin","followers_url":"https://api.github.com/users/gotoin/followers","following_url":"https://api.github.com/users/gotoin/following{/other_user}","gists_url":"https://api.github.com/users/gotoin/gists{/gist_id}","starred_url":"https://api.github.com/users/gotoin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gotoin/subscriptions","organizations_url":"https://api.github.com/users/gotoin/orgs","repos_url":"https://api.github.com/users/gotoin/repos","events_url":"https://api.github.com/users/gotoin/events{/privacy}","received_events_url":"https://api.github.com/users/gotoin/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-12-01T03:10:47Z","updated_at":"2022-12-01T03:10:47Z","body":"+1","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/comments/1333102612/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"gotoin","id":15847842,"node_id":"MDQ6VXNlcjE1ODQ3ODQy","avatar_url":"https://avatars.githubusercontent.com/u/15847842?v=4","gravatar_id":"","url":"https://api.github.com/users/gotoin","html_url":"https://github.com/gotoin","followers_url":"https://api.github.com/users/gotoin/followers","following_url":"https://api.github.com/users/gotoin/following{/other_user}","gists_url":"https://api.github.com/users/gotoin/gists{/gist_id}","starred_url":"https://api.github.com/users/gotoin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gotoin/subscriptions","organizations_url":"https://api.github.com/users/gotoin/orgs","repos_url":"https://api.github.com/users/gotoin/repos","events_url":"https://api.github.com/users/gotoin/events{/privacy}","received_events_url":"https://api.github.com/users/gotoin/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/comments/2211403259","html_url":"https://github.com/mitmproxy/mitmproxy/issues/5064#issuecomment-2211403259","issue_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5064","id":2211403259,"node_id":"IC_kwDOAAfumM6Dz1X7","user":{"login":"JarLob","id":26652396,"node_id":"MDQ6VXNlcjI2NjUyMzk2","avatar_url":"https://avatars.githubusercontent.com/u/26652396?v=4","gravatar_id":"","url":"https://api.github.com/users/JarLob","html_url":"https://github.com/JarLob","followers_url":"https://api.github.com/users/JarLob/followers","following_url":"https://api.github.com/users/JarLob/following{/other_user}","gists_url":"https://api.github.com/users/JarLob/gists{/gist_id}","starred_url":"https://api.github.com/users/JarLob/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JarLob/subscriptions","organizations_url":"https://api.github.com/users/JarLob/orgs","repos_url":"https://api.github.com/users/JarLob/repos","events_url":"https://api.github.com/users/JarLob/events{/privacy}","received_events_url":"https://api.github.com/users/JarLob/received_events","type":"User","user_view_type":"public","site_admin":true},"created_at":"2024-07-05T20:55:31Z","updated_at":"2024-07-05T22:23:37Z","body":"Hi @mhils, hopefully I can contribute something back to this amazing tool!\nAs you know I'm using mitmproxy in [permissions monitor](https://github.com/GitHubSecurityLab/actions-permissions). Recently I was experimenting with `allow_hosts` and noticed the same inconsistency when mitmproxy doesn't recognize some requests. I have forked mitmproxy, added some logging and hacked with the fork of the actions-permissions to get [this log](https://github.com/JarLob/proxy/actions/runs/9813122161/job/27098521689#step:12:122). A copy - [job-logs.txt](https://github.com/user-attachments/files/16113537/job-logs.txt)\n\n![Image](https://github.com/user-attachments/assets/ec360331-3bb5-40e2-ba04-2fcd3edfd6a4)\n\nSame as the author of this thread I see a tcp request that is not recognized as tls, but the `context.server.sni` has the host already.\n\nEverything is in GitHub and should be reproducible. There is a fork of mitmproxy with some logging added (branch `sni`) - the [snapshot](https://github.com/JarLob/mitmproxy/tree/c6edb94023b8a27a4a76a9b8174f8cc1ec231b79). There is [fork](https://github.com/GitHubSecurityLab/actions-permissions/tree/maven) with hacks of permissions monitor action and there is [repository](https://github.com/JarLob/proxy/tree/sni) I use to start a workflow ([test.yml](https://github.com/JarLob/proxy/blob/fe4f9e496001952bcc7cf4b46b56b8d4b4fb3e20/.github/workflows/test.yml)) that calls curl with mitmproxy set up. But it basically boils down to this:\n* Mitmproxy runs in transparent mode:\n```\n/home/mitmproxyuser/mitmproxy/venv/bin/mitmdump --mode transparent \\\n          --showhost \\\n          --allow-hosts '\\bgithub\\.com(:\\d+)$' \\\n          --set block_global=false \\\n          `#-q` \\\n          --set termlog_verbosity=debug \\\n          --set proxy_debug=true \\\n          -s /home/mitmproxyuser/mitm_plugin.py \\\n          --set output='/home/mitmproxyuser/out.txt' \\\n          --set token='$INPUT_TOKEN' \\\n          --set hosts='api.github.com,github.com' \\\n          --set debug='$RUNNER_DEBUG' \\\n          --set ACTIONS_ID_TOKEN_REQUEST_URL='$ACTIONS_ID_TOKEN_REQUEST_URL' \\\n          --set ACTIONS_ID_TOKEN_REQUEST_TOKEN='$ACTIONS_ID_TOKEN_REQUEST_TOKEN' \\\n          --set GITHUB_REPOSITORY_ID='$GITHUB_REPOSITORY_ID' \\\n          --set GITHUB_REPOSITORY='$GITHUB_REPOSITORY' \\\n          >>/home/mitmproxyuser/out.txt 2>&1 &\"\n```\n* Actions runner does some source checkout (this is why there is one correct interception) and then this curl command is run:\n```\ncurl \\\n            -H \"Accept: application/vnd.github+json\" \\\n            -H \"Authorization: Bearer ${{ github.token }}\"\\\n            -H \"X-GitHub-Api-Version: 2022-11-28\" \\\n            https://Api.github.com/repos/${{ github.event.repository.owner.login }}/${{ github.event.repository.name }}/issues/1/labels\n```\nEverything else is in the logs, but I find it hard to understand :/ Don't hesitate to fork and run or guide me what else logging to add and I can run it for you.\n\nP.S. I have noticed [these lines](https://github.com/JarLob/mitmproxy/blob/c6edb94023b8a27a4a76a9b8174f8cc1ec231b79/mitmproxy/addons/next_layer.py#L241-L244) were not under `if context.server.address:` in previous versions of mitmproxy and shifted them left, but it didn't seem to help. What version do you think is correct? UPD: I think I understood, it is because of the `port`.","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/comments/2211403259/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"JarLob","id":26652396,"node_id":"MDQ6VXNlcjI2NjUyMzk2","avatar_url":"https://avatars.githubusercontent.com/u/26652396?v=4","gravatar_id":"","url":"https://api.github.com/users/JarLob","html_url":"https://github.com/JarLob","followers_url":"https://api.github.com/users/JarLob/followers","following_url":"https://api.github.com/users/JarLob/following{/other_user}","gists_url":"https://api.github.com/users/JarLob/gists{/gist_id}","starred_url":"https://api.github.com/users/JarLob/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JarLob/subscriptions","organizations_url":"https://api.github.com/users/JarLob/orgs","repos_url":"https://api.github.com/users/JarLob/repos","events_url":"https://api.github.com/users/JarLob/events{/privacy}","received_events_url":"https://api.github.com/users/JarLob/received_events","type":"User","user_view_type":"public","site_admin":true}},{"id":13409410435,"node_id":"MEE_lADOAAfumM5B23DszwAAAAMfQ12D","url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/events/13409410435","actor":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2024-07-05T20:55:32Z","performed_via_github_app":null},{"id":13409410442,"node_id":"SE_lADOAAfumM5B23DszwAAAAMfQ12K","url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/events/13409410442","actor":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2024-07-05T20:55:32Z","performed_via_github_app":null},{"id":13409736983,"node_id":"REFE_lADOAAfumM5B23DszwAAAAMfSFkX","url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/events/13409736983","actor":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"a0f8c85f36b8148ed430993f154595ea1ad0f10c","commit_url":"https://api.github.com/repos/mhils/mitmproxy/commits/a0f8c85f36b8148ed430993f154595ea1ad0f10c","created_at":"2024-07-05T22:09:35Z","performed_via_github_app":null},{"id":13409744682,"node_id":"REFE_lADOAAfumM5B23DszwAAAAMfSHcq","url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/events/13409744682","actor":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"76f8b10989530ca00126ecc918352ab2ed58348c","commit_url":"https://api.github.com/repos/mhils/mitmproxy/commits/76f8b10989530ca00126ecc918352ab2ed58348c","created_at":"2024-07-05T22:11:33Z","performed_via_github_app":null},{"id":13409749190,"node_id":"REFE_lADOAAfumM5B23DszwAAAAMfSIjG","url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/events/13409749190","actor":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"59d87b3eca40b92a4e3f2e49f105328e77a2e966","commit_url":"https://api.github.com/repos/mhils/mitmproxy/commits/59d87b3eca40b92a4e3f2e49f105328e77a2e966","created_at":"2024-07-05T22:12:55Z","performed_via_github_app":null},{"actor":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-07-05T22:13:45Z","updated_at":"2024-07-05T22:13:45Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/7002","repository_url":"https://api.github.com/repos/mitmproxy/mitmproxy","labels_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/7002/labels{/name}","comments_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/7002/comments","events_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/7002/events","html_url":"https://github.com/mitmproxy/mitmproxy/pull/7002","id":2393191685,"node_id":"PR_kwDOAAfumM50kcCc","number":7002,"title":"Incorporate existing SNI into allow/ignore decision, fix #5064","user":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2024-07-05T22:13:45Z","updated_at":"2024-07-05T22:28:48Z","closed_at":"2024-07-05T22:19:55Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"draft":false,"repository":{"id":519832,"node_id":"MDEwOlJlcG9zaXRvcnk1MTk4MzI=","name":"mitmproxy","full_name":"mitmproxy/mitmproxy","private":false,"owner":{"login":"mitmproxy","id":4652787,"node_id":"MDEyOk9yZ2FuaXphdGlvbjQ2NTI3ODc=","avatar_url":"https://avatars.githubusercontent.com/u/4652787?v=4","gravatar_id":"","url":"https://api.github.com/users/mitmproxy","html_url":"https://github.com/mitmproxy","followers_url":"https://api.github.com/users/mitmproxy/followers","following_url":"https://api.github.com/users/mitmproxy/following{/other_user}","gists_url":"https://api.github.com/users/mitmproxy/gists{/gist_id}","starred_url":"https://api.github.com/users/mitmproxy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mitmproxy/subscriptions","organizations_url":"https://api.github.com/users/mitmproxy/orgs","repos_url":"https://api.github.com/users/mitmproxy/repos","events_url":"https://api.github.com/users/mitmproxy/events{/privacy}","received_events_url":"https://api.github.com/users/mitmproxy/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/mitmproxy/mitmproxy","description":"An interactive TLS-capable intercepting HTTP proxy for penetration testers and software developers.","fork":false,"url":"https://api.github.com/repos/mitmproxy/mitmproxy","forks_url":"https://api.github.com/repos/mitmproxy/mitmproxy/forks","keys_url":"https://api.github.com/repos/mitmproxy/mitmproxy/keys{/key_id}","collaborators_url":"https://api.github.com/repos/mitmproxy/mitmproxy/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/mitmproxy/mitmproxy/teams","hooks_url":"https://api.github.com/repos/mitmproxy/mitmproxy/hooks","issue_events_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/events{/number}","events_url":"https://api.github.com/repos/mitmproxy/mitmproxy/events","assignees_url":"https://api.github.com/repos/mitmproxy/mitmproxy/assignees{/user}","branches_url":"https://api.github.com/repos/mitmproxy/mitmproxy/branches{/branch}","tags_url":"https://api.github.com/repos/mitmproxy/mitmproxy/tags","blobs_url":"https://api.github.com/repos/mitmproxy/mitmproxy/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/mitmproxy/mitmproxy/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/mitmproxy/mitmproxy/git/refs{/sha}","trees_url":"https://api.github.com/repos/mitmproxy/mitmproxy/git/trees{/sha}","statuses_url":"https://api.github.com/repos/mitmproxy/mitmproxy/statuses/{sha}","languages_url":"https://api.github.com/repos/mitmproxy/mitmproxy/languages","stargazers_url":"https://api.github.com/repos/mitmproxy/mitmproxy/stargazers","contributors_url":"https://api.github.com/repos/mitmproxy/mitmproxy/contributors","subscribers_url":"https://api.github.com/repos/mitmproxy/mitmproxy/subscribers","subscription_url":"https://api.github.com/repos/mitmproxy/mitmproxy/subscription","commits_url":"https://api.github.com/repos/mitmproxy/mitmproxy/commits{/sha}","git_commits_url":"https://api.github.com/repos/mitmproxy/mitmproxy/git/commits{/sha}","comments_url":"https://api.github.com/repos/mitmproxy/mitmproxy/comments{/number}","issue_comment_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/comments{/number}","contents_url":"https://api.github.com/repos/mitmproxy/mitmproxy/contents/{+path}","compare_url":"https://api.github.com/repos/mitmproxy/mitmproxy/compare/{base}...{head}","merges_url":"https://api.github.com/repos/mitmproxy/mitmproxy/merges","archive_url":"https://api.github.com/repos/mitmproxy/mitmproxy/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/mitmproxy/mitmproxy/downloads","issues_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues{/number}","pulls_url":"https://api.github.com/repos/mitmproxy/mitmproxy/pulls{/number}","milestones_url":"https://api.github.com/repos/mitmproxy/mitmproxy/milestones{/number}","notifications_url":"https://api.github.com/repos/mitmproxy/mitmproxy/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels{/name}","releases_url":"https://api.github.com/repos/mitmproxy/mitmproxy/releases{/id}","deployments_url":"https://api.github.com/repos/mitmproxy/mitmproxy/deployments","created_at":"2010-02-16T04:10:13Z","updated_at":"2025-11-09T17:55:49Z","pushed_at":"2025-11-09T14:36:54Z","git_url":"git://github.com/mitmproxy/mitmproxy.git","ssh_url":"git@github.com:mitmproxy/mitmproxy.git","clone_url":"https://github.com/mitmproxy/mitmproxy.git","svn_url":"https://github.com/mitmproxy/mitmproxy","homepage":"https://mitmproxy.org","size":67124,"stargazers_count":41160,"watchers_count":41160,"language":"Python","has_issues":true,"has_projects":false,"has_downloads":true,"has_wiki":false,"has_pages":false,"has_discussions":true,"forks_count":4359,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":387,"license":{"key":"mit","name":"MIT License","spdx_id":"MIT","url":"https://api.github.com/licenses/mit","node_id":"MDc6TGljZW5zZTEz"},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["debugging","http","http2","man-in-the-middle","mitmproxy","proxy","python","security","ssl","tls","websocket"],"visibility":"public","forks":4359,"open_issues":387,"watchers":41160,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"pull_request":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/pulls/7002","html_url":"https://github.com/mitmproxy/mitmproxy/pull/7002","diff_url":"https://github.com/mitmproxy/mitmproxy/pull/7002.diff","patch_url":"https://github.com/mitmproxy/mitmproxy/pull/7002.patch","merged_at":"2024-07-05T22:19:55Z"},"body":"#### Description\r\n\r\nThis PR fixes the issue reported by @JarLob in https://github.com/mitmproxy/mitmproxy/issues/5064#issuecomment-2211403259. The problem here was that we did not take an already-parsed SNI into account, but were only looking at TLS handshakes that were happening _just now_.\r\n\r\n#### Checklist\r\n\r\n - [x] I have updated tests where applicable.\r\n - [x] I have added an entry to the CHANGELOG.\r\n","reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/7002/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/7002/timeline","performed_via_github_app":null,"state_reason":null}},"event":"cross-referenced"},{"id":13409753522,"node_id":"REFE_lADOAAfumM5B23DszwAAAAMfSJmy","url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/events/13409753522","actor":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"2c58d996872a71b58e84bac874faf373d044c81a","commit_url":"https://api.github.com/repos/mhils/mitmproxy/commits/2c58d996872a71b58e84bac874faf373d044c81a","created_at":"2024-07-05T22:14:14Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/comments/2211464705","html_url":"https://github.com/mitmproxy/mitmproxy/issues/5064#issuecomment-2211464705","issue_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5064","id":2211464705,"node_id":"IC_kwDOAAfumM6D0EYB","user":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-07-05T22:14:44Z","updated_at":"2024-07-05T22:18:59Z","body":"Thank you @JarLob! Your logs were immensely helpful. ðŸ˜ƒ This should be fixed in #7002, see the PR for a detailed description. :)","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/comments/2211464705/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":1,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":13409755233,"node_id":"MEE_lADOAAfumM5B23DszwAAAAMfSKBh","url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/events/13409755233","actor":{"login":"JarLob","id":26652396,"node_id":"MDQ6VXNlcjI2NjUyMzk2","avatar_url":"https://avatars.githubusercontent.com/u/26652396?v=4","gravatar_id":"","url":"https://api.github.com/users/JarLob","html_url":"https://github.com/JarLob","followers_url":"https://api.github.com/users/JarLob/followers","following_url":"https://api.github.com/users/JarLob/following{/other_user}","gists_url":"https://api.github.com/users/JarLob/gists{/gist_id}","starred_url":"https://api.github.com/users/JarLob/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JarLob/subscriptions","organizations_url":"https://api.github.com/users/JarLob/orgs","repos_url":"https://api.github.com/users/JarLob/repos","events_url":"https://api.github.com/users/JarLob/events{/privacy}","received_events_url":"https://api.github.com/users/JarLob/received_events","type":"User","user_view_type":"public","site_admin":true},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2024-07-05T22:14:46Z","performed_via_github_app":null},{"id":13409755238,"node_id":"SE_lADOAAfumM5B23DszwAAAAMfSKBm","url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/events/13409755238","actor":{"login":"JarLob","id":26652396,"node_id":"MDQ6VXNlcjI2NjUyMzk2","avatar_url":"https://avatars.githubusercontent.com/u/26652396?v=4","gravatar_id":"","url":"https://api.github.com/users/JarLob","html_url":"https://github.com/JarLob","followers_url":"https://api.github.com/users/JarLob/followers","following_url":"https://api.github.com/users/JarLob/following{/other_user}","gists_url":"https://api.github.com/users/JarLob/gists{/gist_id}","starred_url":"https://api.github.com/users/JarLob/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JarLob/subscriptions","organizations_url":"https://api.github.com/users/JarLob/orgs","repos_url":"https://api.github.com/users/JarLob/repos","events_url":"https://api.github.com/users/JarLob/events{/privacy}","received_events_url":"https://api.github.com/users/JarLob/received_events","type":"User","user_view_type":"public","site_admin":true},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2024-07-05T22:14:46Z","performed_via_github_app":null},{"id":13409773021,"node_id":"CE_lADOAAfumM5B23DszwAAAAMfSOXd","url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/events/13409773021","actor":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"closed","commit_id":"5353df5f1eeaf5fc36d9b5f7024199c888aed116","commit_url":"https://api.github.com/repos/mitmproxy/mitmproxy/commits/5353df5f1eeaf5fc36d9b5f7024199c888aed116","created_at":"2024-07-05T22:19:56Z","state_reason":null,"performed_via_github_app":null},{"id":13410278723,"node_id":"REFE_lADOAAfumM5B23DszwAAAAMfUJ1D","url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/events/13410278723","actor":{"login":"cysk003","id":14152194,"node_id":"MDQ6VXNlcjE0MTUyMTk0","avatar_url":"https://avatars.githubusercontent.com/u/14152194?v=4","gravatar_id":"","url":"https://api.github.com/users/cysk003","html_url":"https://github.com/cysk003","followers_url":"https://api.github.com/users/cysk003/followers","following_url":"https://api.github.com/users/cysk003/following{/other_user}","gists_url":"https://api.github.com/users/cysk003/gists{/gist_id}","starred_url":"https://api.github.com/users/cysk003/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cysk003/subscriptions","organizations_url":"https://api.github.com/users/cysk003/orgs","repos_url":"https://api.github.com/users/cysk003/repos","events_url":"https://api.github.com/users/cysk003/events{/privacy}","received_events_url":"https://api.github.com/users/cysk003/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"5353df5f1eeaf5fc36d9b5f7024199c888aed116","commit_url":"https://api.github.com/repos/cysk003/mitmproxy/commits/5353df5f1eeaf5fc36d9b5f7024199c888aed116","created_at":"2024-07-06T01:22:39Z","performed_via_github_app":null}]