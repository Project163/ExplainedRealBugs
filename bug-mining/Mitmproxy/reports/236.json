{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/2113","repository_url":"https://api.github.com/repos/mitmproxy/mitmproxy","labels_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/2113/labels{/name}","comments_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/2113/comments","events_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/2113/events","html_url":"https://github.com/mitmproxy/mitmproxy/issues/2113","id":212483989,"node_id":"MDU6SXNzdWUyMTI0ODM5ODk=","number":2113,"title":"Unserializable Object when writing out flow with WebSockets","user":{"login":"mrballcb","id":194079,"node_id":"MDQ6VXNlcjE5NDA3OQ==","avatar_url":"https://avatars.githubusercontent.com/u/194079?v=4","gravatar_id":"","url":"https://api.github.com/users/mrballcb","html_url":"https://github.com/mrballcb","followers_url":"https://api.github.com/users/mrballcb/followers","following_url":"https://api.github.com/users/mrballcb/following{/other_user}","gists_url":"https://api.github.com/users/mrballcb/gists{/gist_id}","starred_url":"https://api.github.com/users/mrballcb/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mrballcb/subscriptions","organizations_url":"https://api.github.com/users/mrballcb/orgs","repos_url":"https://api.github.com/users/mrballcb/repos","events_url":"https://api.github.com/users/mrballcb/events{/privacy}","received_events_url":"https://api.github.com/users/mrballcb/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":79336502,"node_id":"MDU6TGFiZWw3OTMzNjUwMg==","url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels/kind/bug","name":"kind/bug","color":"d93f0b","default":false,"description":null},{"id":429899749,"node_id":"MDU6TGFiZWw0Mjk4OTk3NDk=","url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels/area/core","name":"area/core","color":"fef2c0","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2017-03-07T16:24:41Z","updated_at":"2017-12-16T18:04:04Z","closed_at":"2017-03-10T20:15:46Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"##### Steps to reproduce the problem:\r\n\r\n0. Preconfigured the `~/.mitmproxy/mitmproxy-ca-cert.pem` into Mac's \"Keychain Access\" app in System, configured to \"Always Trust\".\r\n1. Start up mitmproxy with \"--host\".\r\n2. Configure Mac to use 127.0.0.1 port 8080 for both http (80) and https (443).\r\n3. Start app that uses WebSockets.\r\n4. Find and select (move to) the flow with \"Connection: Upgrade\" header and same header in response.\r\n5. Type \"w\" to write out flows, type \"t\" for this flow, and give it a filename.  (Behaves the same if I write out all flows if one of them is websocket connection).\r\n6. mitmproxy does a stack dump and exits:\r\n\r\n```\r\nTraceback (most recent call last):\r\n  File \"/usr/local/Cellar/mitmproxy/2.0.0/libexec/lib/python3.6/site-packages/mitmproxy/tools/console/master.py\", line 281, in run\r\n    self.loop.run()\r\n  File \"/usr/local/Cellar/mitmproxy/2.0.0/libexec/lib/python3.6/site-packages/urwid/main_loop.py\", line 278, in run\r\n    self._run()\r\n  File \"/usr/local/Cellar/mitmproxy/2.0.0/libexec/lib/python3.6/site-packages/urwid/main_loop.py\", line 376, in _run\r\n    self.event_loop.run()\r\n  File \"/usr/local/Cellar/mitmproxy/2.0.0/libexec/lib/python3.6/site-packages/urwid/main_loop.py\", line 682, in run\r\n    self._loop()\r\n  File \"/usr/local/Cellar/mitmproxy/2.0.0/libexec/lib/python3.6/site-packages/urwid/main_loop.py\", line 719, in _loop\r\n    self._watch_files[fd]()\r\n  File \"/usr/local/Cellar/mitmproxy/2.0.0/libexec/lib/python3.6/site-packages/urwid/raw_display.py\", line 393, in <lambda>\r\n    event_loop, callback, self.get_available_raw_input())\r\n  File \"/usr/local/Cellar/mitmproxy/2.0.0/libexec/lib/python3.6/site-packages/urwid/raw_display.py\", line 493, in parse_input\r\n    callback(processed, processed_codes)\r\n  File \"/usr/local/Cellar/mitmproxy/2.0.0/libexec/lib/python3.6/site-packages/urwid/main_loop.py\", line 403, in _update\r\n    self.process_input(keys)\r\n  File \"/usr/local/Cellar/mitmproxy/2.0.0/libexec/lib/python3.6/site-packages/urwid/main_loop.py\", line 503, in process_input\r\n    k = self._topmost_widget.keypress(self.screen_size, k)\r\n  File \"/usr/local/Cellar/mitmproxy/2.0.0/libexec/lib/python3.6/site-packages/mitmproxy/tools/console/window.py\", line 84, in keypress\r\n    k = super().keypress(size, k)\r\n  File \"/usr/local/Cellar/mitmproxy/2.0.0/libexec/lib/python3.6/site-packages/urwid/container.py\", line 1116, in keypress\r\n    return self.footer.keypress((maxcol,),key)\r\n  File \"/usr/local/Cellar/mitmproxy/2.0.0/libexec/lib/python3.6/site-packages/mitmproxy/tools/console/statusbar.py\", line 155, in keypress\r\n    return self.master.ab.keypress(*args, **kwargs)\r\n  File \"/usr/local/Cellar/mitmproxy/2.0.0/libexec/lib/python3.6/site-packages/mitmproxy/tools/console/statusbar.py\", line 110, in keypress\r\n    self.prompt_execute(self._w.get_edit_text())\r\n  File \"/usr/local/Cellar/mitmproxy/2.0.0/libexec/lib/python3.6/site-packages/mitmproxy/tools/console/statusbar.py\", line 133, in prompt_execute\r\n    msg = p(txt)\r\n  File \"/usr/local/Cellar/mitmproxy/2.0.0/libexec/lib/python3.6/site-packages/mitmproxy/tools/console/statusbar.py\", line 21, in __call__\r\n    return self.callback(pth, *self.args)\r\n  File \"/usr/local/Cellar/mitmproxy/2.0.0/libexec/lib/python3.6/site-packages/mitmproxy/tools/console/master.py\", line 388, in save_flows\r\n    return self._write_flows(path, self.view)\r\n  File \"/usr/local/Cellar/mitmproxy/2.0.0/libexec/lib/python3.6/site-packages/mitmproxy/tools/console/master.py\", line 382, in _write_flows\r\n    fw.add(i)\r\n  File \"/usr/local/Cellar/mitmproxy/2.0.0/libexec/lib/python3.6/site-packages/mitmproxy/io.py\", line 27, in add\r\n    tnetstring.dump(d, self.fo)\r\n  File \"/usr/local/Cellar/mitmproxy/2.0.0/libexec/lib/python3.6/site-packages/mitmproxy/contrib/tnetstring.py\", line 66, in dump\r\n    file_handle.write(dumps(value))\r\n  File \"/usr/local/Cellar/mitmproxy/2.0.0/libexec/lib/python3.6/site-packages/mitmproxy/contrib/tnetstring.py\", line 57, in dumps\r\n    _rdumpq(q, 0, value)\r\n  File \"/usr/local/Cellar/mitmproxy/2.0.0/libexec/lib/python3.6/site-packages/mitmproxy/contrib/tnetstring.py\", line 142, in _rdumpq\r\n    size = _rdumpq(q, size, v)\r\n  File \"/usr/local/Cellar/mitmproxy/2.0.0/libexec/lib/python3.6/site-packages/mitmproxy/contrib/tnetstring.py\", line 142, in _rdumpq\r\n    size = _rdumpq(q, size, v)\r\n  File \"/usr/local/Cellar/mitmproxy/2.0.0/libexec/lib/python3.6/site-packages/mitmproxy/contrib/tnetstring.py\", line 149, in _rdumpq\r\n    raise ValueError(\"unserializable object: {} ({})\".format(value, type(value)))\r\nValueError: unserializable object: <WebSocketFlow (69 messages)> (<class 'mitmproxy.websocket.WebSocketFlow'>)\r\n\r\nmitmproxy has crashed!\r\nPlease lodge a bug report at:\r\n\thttps://github.com/mitmproxy/mitmproxy\r\nShutting down...\r\n```\r\n\r\n##### Any other comments? What have you tried so far?\r\n\r\nIf you run `mitmproxy --host --no-websocket`, this error writing out flows doesn't occur as the proxy doesn't honor the websocket upgrade.  Operationally, I can't tell if mitmproxy filters out the upgrade header, or if it blocks the entire flow at the proxy.  Either way, it doesn't have a problem when writing out the flows.\r\n\r\nOur ultimate goal is to harden our app by forcing it to fallback to older web technologies like long polling if the websocket upgrade is blocked, such as by a BlueCoat configured to block websockets (apparently common on enterprise networks).  I'm trying to get mitmproxy to mimic that behavior.  Using --no-websocket does seem to achieve that, but when I try to compare flows between websocket and non-websocket, mitmproxy stackdumps when dumping the websocket flow.\r\n\r\n##### System information\r\n\r\nMitmproxy version: 2.0.0 (release version)\r\nPython version: 3.6.0\r\nPlatform: Darwin-16.4.0-x86_64-i386-64bit\r\nSSL version: OpenSSL 1.1.0e  16 Feb 2017\r\nMac version: 10.12.3 ('', '', '') x86_64","closed_by":{"login":"Kriechi","id":114300,"node_id":"MDQ6VXNlcjExNDMwMA==","avatar_url":"https://avatars.githubusercontent.com/u/114300?v=4","gravatar_id":"","url":"https://api.github.com/users/Kriechi","html_url":"https://github.com/Kriechi","followers_url":"https://api.github.com/users/Kriechi/followers","following_url":"https://api.github.com/users/Kriechi/following{/other_user}","gists_url":"https://api.github.com/users/Kriechi/gists{/gist_id}","starred_url":"https://api.github.com/users/Kriechi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Kriechi/subscriptions","organizations_url":"https://api.github.com/users/Kriechi/orgs","repos_url":"https://api.github.com/users/Kriechi/repos","events_url":"https://api.github.com/users/Kriechi/events{/privacy}","received_events_url":"https://api.github.com/users/Kriechi/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/2113/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/2113/timeline","performed_via_github_app":null,"state_reason":"completed"}