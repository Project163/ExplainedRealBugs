{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/4870","repository_url":"https://api.github.com/repos/mitmproxy/mitmproxy","labels_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/4870/labels{/name}","comments_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/4870/comments","events_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/4870/events","html_url":"https://github.com/mitmproxy/mitmproxy/issues/4870","id":1029959465,"node_id":"I_kwDOAAfumM49Y-8p","number":4870,"title":"HttpStream.state_wait_for_request_headers error","user":{"login":"pocket-live","id":11918286,"node_id":"MDQ6VXNlcjExOTE4Mjg2","avatar_url":"https://avatars.githubusercontent.com/u/11918286?v=4","gravatar_id":"","url":"https://api.github.com/users/pocket-live","html_url":"https://github.com/pocket-live","followers_url":"https://api.github.com/users/pocket-live/followers","following_url":"https://api.github.com/users/pocket-live/following{/other_user}","gists_url":"https://api.github.com/users/pocket-live/gists{/gist_id}","starred_url":"https://api.github.com/users/pocket-live/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pocket-live/subscriptions","organizations_url":"https://api.github.com/users/pocket-live/orgs","repos_url":"https://api.github.com/users/pocket-live/repos","events_url":"https://api.github.com/users/pocket-live/events{/privacy}","received_events_url":"https://api.github.com/users/pocket-live/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":79336502,"node_id":"MDU6TGFiZWw3OTMzNjUwMg==","url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels/kind/bug","name":"kind/bug","color":"d93f0b","default":false,"description":null},{"id":429896009,"node_id":"MDU6TGFiZWw0Mjk4OTYwMDk=","url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels/area/protocols","name":"area/protocols","color":"fef2c0","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2021-10-19T07:32:57Z","updated_at":"2021-10-19T11:24:48Z","closed_at":"2021-10-19T11:24:48Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"#### Problem Description\r\n```\r\nmit_server          | 2021-10-19T07:17:01.079759751Z 37.103.81.174:57654: mitmproxy has crashed!\r\nmit_server          | 2021-10-19T07:17:01.079788763Z Traceback (most recent call last):\r\nmit_server          | 2021-10-19T07:17:01.079794934Z   File \"/usr/local/lib/python3.9/site-packages/mitmproxy/proxy/server.py\", line 279, in server_event\r\nmit_server          | 2021-10-19T07:17:01.079799991Z     for command in layer_commands:\r\nmit_server          | 2021-10-19T07:17:01.079804504Z   File \"/usr/local/lib/python3.9/site-packages/mitmproxy/proxy/layer.py\", line 144, in handle_event\r\nmit_server          | 2021-10-19T07:17:01.079809056Z     command = command_generator.send(send)\r\nmit_server          | 2021-10-19T07:17:01.079813637Z   File \"/usr/local/lib/python3.9/site-packages/mitmproxy/proxy/layer.py\", line 255, in handle_event\r\nmit_server          | 2021-10-19T07:17:01.079818387Z     yield from self._handle(event)\r\nmit_server          | 2021-10-19T07:17:01.079826095Z   File \"/usr/local/lib/python3.9/site-packages/mitmproxy/proxy/layer.py\", line 144, in handle_event\r\nmit_server          | 2021-10-19T07:17:01.079830842Z     command = command_generator.send(send)\r\nmit_server          | 2021-10-19T07:17:01.079835186Z   File \"/usr/local/lib/python3.9/site-packages/mitmproxy/proxy/layers/http/__init__.py\", line 740, in _handle_event\r\nmit_server          | 2021-10-19T07:17:01.079839927Z     yield from self.event_to_child(handler, event)\r\nmit_server          | 2021-10-19T07:17:01.079844281Z   File \"/usr/local/lib/python3.9/site-packages/mitmproxy/proxy/layers/http/__init__.py\", line 761, in event_to_child\r\nmit_server          | 2021-10-19T07:17:01.079849161Z     yield from self.event_to_child(stream, command.event)\r\nmit_server          | 2021-10-19T07:17:01.079853589Z   File \"/usr/local/lib/python3.9/site-packages/mitmproxy/proxy/layers/http/__init__.py\", line 749, in event_to_child\r\nmit_server          | 2021-10-19T07:17:01.079858633Z     for command in child.handle_event(event):\r\nmit_server          | 2021-10-19T07:17:01.079863297Z   File \"/usr/local/lib/python3.9/site-packages/mitmproxy/proxy/layer.py\", line 144, in handle_event\r\nmit_server          | 2021-10-19T07:17:01.079902048Z     command = command_generator.send(send)\r\nmit_server          | 2021-10-19T07:17:01.079906606Z   File \"/usr/local/lib/python3.9/site-packages/mitmproxy/proxy/layers/http/__init__.py\", line 136, in _handle_event\r\nmit_server          | 2021-10-19T07:17:01.079910826Z     yield from self.client_state(event)\r\nmit_server          | 2021-10-19T07:17:01.079914867Z   File \"/usr/local/lib/python3.9/site-packages/mitmproxy/proxy/utils.py\", line 23, in _check_event_type\r\nmit_server          | 2021-10-19T07:17:01.079919260Z     raise AssertionError(\r\nmit_server          | 2021-10-19T07:17:01.079925280Z AssertionError: Unexpected event type at HttpStream.state_wait_for_request_headers: Expected RequestHeaders, got RequestData(stream_id=1, data=b\"\\x16\\x03\\x03\\x00\\xbe\\x01\\x00\\x00\\xba\\x03\\x03anp\\xedr'\\xd2\\xa1\\xe5\\xf0 9\\xf7\\r\\xef\\x9dd/\\x8d\\xf8r*&K\\xf7(\\xe8\\xd6\\xf6\\x96\\x16\\xa3\\x00\\x00*\\xc0,\\xc0+\\xc00\\xc0/\\x00\\x9f\\x00\\x9e\\xc0$\\xc0#\\xc0(\\xc0'\\xc0\\n\\xc0\\t\\xc0\\x14\\xc0\\x13\\x00\\x9d\\x00\\x9c\\x00=\\x00<\\x005\\x00/\\x00\\n\\x01\\x00\\x00g\\x00\\x00\\x00&\\x00$\\x00\\x00!authentication-prod.ar.indazn.com\\x00\\n\\x00\\x08\\x00\\x06\\x00\\x1d\\x00\\x17\\x00\\x18\\x00\\x0b\\x00\\x02\\x01\\x00\\x00\\r\\x00\\x1a\\x00\\x18\\x08\\x04\\x08\\x05\\x08\\x06\\x04\\x01\\x05\\x01\\x02\\x01\\x04\\x03\\x05\\x03\\x02\\x03\\x02\\x02\\x06\\x01\\x06\\x03\\x00#\\x00\\x00\\x00\\x17\\x00\\x00\\xff\\x01\\x00\\x01\\x00\").\r\nmit_server          | 2021-10-19T07:17:01.079939109Z \r\nmit_server          | 2021-10-19T07:17:04.149705128Z 37.103.81.174:49416: mitmproxy has crashed!\r\nmit_server          | 2021-10-19T07:17:04.149733496Z Traceback (most recent call last):\r\nmit_server          | 2021-10-19T07:17:04.149738250Z   File \"/usr/local/lib/python3.9/site-packages/mitmproxy/proxy/server.py\", line 279, in server_event\r\nmit_server          | 2021-10-19T07:17:04.149742511Z     for command in layer_commands:\r\nmit_server          | 2021-10-19T07:17:04.149746107Z   File \"/usr/local/lib/python3.9/site-packages/mitmproxy/proxy/layer.py\", line 144, in handle_event\r\nmit_server          | 2021-10-19T07:17:04.149749966Z     command = command_generator.send(send)\r\nmit_server          | 2021-10-19T07:17:04.149753507Z   File \"/usr/local/lib/python3.9/site-packages/mitmproxy/proxy/layer.py\", line 255, in handle_event\r\nmit_server          | 2021-10-19T07:17:04.149757131Z     yield from self._handle(event)\r\nmit_server          | 2021-10-19T07:17:04.149760429Z   File \"/usr/local/lib/python3.9/site-packages/mitmproxy/proxy/layer.py\", line 144, in handle_event\r\nmit_server          | 2021-10-19T07:17:04.149763878Z     command = command_generator.send(send)\r\nmit_server          | 2021-10-19T07:17:04.149767309Z   File \"/usr/local/lib/python3.9/site-packages/mitmproxy/proxy/layers/http/__init__.py\", line 740, in _handle_event\r\nmit_server          | 2021-10-19T07:17:04.149770905Z     yield from self.event_to_child(handler, event)\r\nmit_server          | 2021-10-19T07:17:04.149774329Z   File \"/usr/local/lib/python3.9/site-packages/mitmproxy/proxy/layers/http/__init__.py\", line 749, in event_to_child\r\nmit_server          | 2021-10-19T07:17:04.149777989Z     for command in child.handle_event(event):\r\nmit_server          | 2021-10-19T07:17:04.149781325Z   File \"/usr/local/lib/python3.9/site-packages/mitmproxy/proxy/layer.py\", line 135, in handle_event\r\nmit_server          | 2021-10-19T07:17:04.149784903Z     command_generator = self._handle_event(event)\r\nmit_server          | 2021-10-19T07:17:04.149788233Z   File \"/usr/local/lib/python3.9/site-packages/mitmproxy/proxy/utils.py\", line 23, in _check_event_type\r\nmit_server          | 2021-10-19T07:17:04.149805983Z     raise AssertionError(\r\nmit_server          | 2021-10-19T07:17:04.149809318Z AssertionError: Unexpected event type at HttpStream._handle_event: Expected Start|HttpEvent, got ConnectionClosed(connection=Server({'id': 'â€¦a2bdcc', 'address': ('api-global.netflix.com', 443), 'state': <ConnectionState.CAN_WRITE: 2>, 'timestamp_start': 1634627762.836605, 'timestamp_tcp_setup': 1634627763.5006588, 'peername': ('34.214.223.171', 443), 'sockname': ('172.23.0.4', 57018)})).\r\n```\r\n\r\n#### Steps to reproduce the behavior:\r\n1. After a period of use, the client shuts down the proxy and the server keeps printing error messages\r\n2.The client is iphone\r\n\r\n#### System Information\r\nMitmproxy: 7.0.4\r\nPython:    3.9.7\r\nOpenSSL:   OpenSSL 1.1.1l  24 Aug 2021\r\nPlatform:  Linux-3.10.0-1127.18.2.el7.x86_64-x86_64-with-glibc2.28\r\n","closed_by":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/4870/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/4870/timeline","performed_via_github_app":null,"state_reason":"completed"}