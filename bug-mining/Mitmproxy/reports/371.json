{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/4368","repository_url":"https://api.github.com/repos/mitmproxy/mitmproxy","labels_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/4368/labels{/name}","comments_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/4368/comments","events_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/4368/events","html_url":"https://github.com/mitmproxy/mitmproxy/issues/4368","id":772980090,"node_id":"MDU6SXNzdWU3NzI5ODAwOTA=","number":4368,"title":"OpenSSL.crypto.X509Name cannot be garbage collected","user":{"login":"linw1995","id":13523027,"node_id":"MDQ6VXNlcjEzNTIzMDI3","avatar_url":"https://avatars.githubusercontent.com/u/13523027?v=4","gravatar_id":"","url":"https://api.github.com/users/linw1995","html_url":"https://github.com/linw1995","followers_url":"https://api.github.com/users/linw1995/followers","following_url":"https://api.github.com/users/linw1995/following{/other_user}","gists_url":"https://api.github.com/users/linw1995/gists{/gist_id}","starred_url":"https://api.github.com/users/linw1995/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/linw1995/subscriptions","organizations_url":"https://api.github.com/users/linw1995/orgs","repos_url":"https://api.github.com/users/linw1995/repos","events_url":"https://api.github.com/users/linw1995/events{/privacy}","received_events_url":"https://api.github.com/users/linw1995/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":79336502,"node_id":"MDU6TGFiZWw3OTMzNjUwMg==","url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels/kind/bug","name":"kind/bug","color":"d93f0b","default":false,"description":null},{"id":429899749,"node_id":"MDU6TGFiZWw0Mjk4OTk3NDk=","url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels/area/core","name":"area/core","color":"fef2c0","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2020-12-22T14:16:58Z","updated_at":"2020-12-30T21:57:24Z","closed_at":"2020-12-30T21:57:02Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"#### Problem Description\r\n\r\nIf run mitmdump for a long time, its memory will keep increasing. I manage to narrow down the suspected memory leak is, this line of code in the `dummy_cert` function from `mitmproxy/certs.py` file.\r\n\r\nhttps://github.com/mitmproxy/mitmproxy/blob/554674f37c731d92b0c497611bceefe17c9c514d/mitmproxy/certs.py#L108 \r\n\r\nThis line will keep creating many `OpenSSL.crypto.X509Name` objects. And they are cannot be garbage collected.\r\n\r\n#### Steps to reproduce the behavior:\r\n\r\nRun the below script to reveal this problem quickly.\r\n\r\n```python\r\nimport secrets\r\n\r\nimport objgraph\r\n\r\nfrom mitmproxy.certs import CertStore\r\n\r\nstore = CertStore.from_store(path=\"~/.mitmproxy/\", basename=\"mitmproxy\", key_size=2048)\r\n\r\nprint(\"before\")\r\nobjgraph.show_growth()\r\n\r\nfor _ in range(10000):\r\n    random_string = secrets.token_hex(16)\r\n    commonname = random_string.encode(\"utf-8\") + b\".com\"\r\n    store.get_cert(commonname=commonname, sans=[], organization=None)\r\n\r\nprint(\"after\")\r\nobjgraph.show_growth()\r\n```\r\n\r\n**Output**\r\n\r\n```\r\nbefore\r\nfunction                       5791     +5791\r\ndict                           2809     +2809\r\ntuple                          2571     +2571\r\nbuiltin_function_or_method     2052     +2052\r\nweakref                        1594     +1594\r\nwrapper_descriptor             1283     +1283\r\ngetset_descriptor              1117     +1117\r\nmethod_descriptor               953      +953\r\ntype                            850      +850\r\ncell                            542      +542\r\nafter\r\ndict                    13419    +10610\r\nX509Name                10100    +10100\r\nlist                      537      +200\r\n_X509NameInvalidator      202      +200\r\nX509                      101      +100\r\n__CDataGCP                103      +100\r\nCertStoreEntry            100      +100\r\nCert                      100      +100\r\nfunction                 5800        +9\r\nweakref                  1599        +5\r\n```\r\n\r\n#### System Information\r\n\r\nMitmproxy: 7.0.0.dev (+221, commit 6123675)\r\nPython:    3.9.1\r\nOpenSSL:   OpenSSL 1.1.1i  8 Dec 2020\r\nPlatform:  macOS-10.15.7-x86_64-i386-64bit\r\n\r\n#### Temporary Fix\r\n\r\n`OpenSSL.crypto.X509` uses `self._issuer_invalidator = _X509NameInvalidator()` to invalidate `X509Name` object \r\n(in this problem it is issuer name). It holds them forever even the dummy certs are no longer in usage.\r\n\r\nUse `X509.from_cryptography` and `X509.to_cryptography` to create a new `X509` object to resolve this problem.\r\n\r\nhttps://github.com/mitmproxy/mitmproxy/blob/554674f37c731d92b0c497611bceefe17c9c514d/mitmproxy/certs.py#L108 \r\n\r\nReplace this line of code with the below code.\r\n\r\n```python\r\nnew_cacert = OpenSSL.crypto.X509.from_cryptography(cacert.to_cryptography())\r\ncert.set_issuer(new_cacert.get_subject())\r\n```\r\n\r\nThe `X509` and `X509Name` objects make references between themselves.\r\nAnd they will be garbage collected if the dummy cert being garbage collected.\r\n","closed_by":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/4368/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/4368/timeline","performed_via_github_app":null,"state_reason":"completed"}