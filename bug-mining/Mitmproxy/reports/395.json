{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/4713","repository_url":"https://api.github.com/repos/mitmproxy/mitmproxy","labels_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/4713/labels{/name}","comments_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/4713/comments","events_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/4713/events","html_url":"https://github.com/mitmproxy/mitmproxy/issues/4713","id":956945726,"node_id":"MDU6SXNzdWU5NTY5NDU3MjY=","number":4713,"title":"MITMproxy crashes when using upstream proxy with -k","user":{"login":"Jab2870","id":1909202,"node_id":"MDQ6VXNlcjE5MDkyMDI=","avatar_url":"https://avatars.githubusercontent.com/u/1909202?v=4","gravatar_id":"","url":"https://api.github.com/users/Jab2870","html_url":"https://github.com/Jab2870","followers_url":"https://api.github.com/users/Jab2870/followers","following_url":"https://api.github.com/users/Jab2870/following{/other_user}","gists_url":"https://api.github.com/users/Jab2870/gists{/gist_id}","starred_url":"https://api.github.com/users/Jab2870/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Jab2870/subscriptions","organizations_url":"https://api.github.com/users/Jab2870/orgs","repos_url":"https://api.github.com/users/Jab2870/repos","events_url":"https://api.github.com/users/Jab2870/events{/privacy}","received_events_url":"https://api.github.com/users/Jab2870/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":79336502,"node_id":"MDU6TGFiZWw3OTMzNjUwMg==","url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels/kind/bug","name":"kind/bug","color":"d93f0b","default":false,"description":null},{"id":426483470,"node_id":"MDU6TGFiZWw0MjY0ODM0NzA=","url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels/upstream","name":"upstream","color":"fef2c0","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2021-07-30T17:38:35Z","updated_at":"2021-08-02T13:15:08Z","closed_at":"2021-08-02T13:15:08Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"#### Problem Description\r\n\r\nAs the title says, I'm using mitmproxy with an upstream proxy (burp) and the\r\n`-k` flag, and it crashes\r\n\r\n\r\n#### Steps to reproduce the behavior:\r\n1. Setup burp listening on 8081\r\n2. Open mitmproxy with `mitmproxy -k --mode \"upstream:http://127.0.0.1:8081\"`\r\n3. Try and send a request, e.g. `curl https://jonathanh.co.uk -k` through the proxies\r\n\r\n#### System Information\r\nPaste the output of \"mitmproxy --version\" here.\r\n\r\n\r\n```\r\nMitmproxy: 7.0.0\r\nPython:    3.9.6\r\nOpenSSL:   OpenSSL 1.1.1k  25 Mar 2021\r\nPlatform:  Linux-5.12.15-zen1-1-zen-x86_64-with-glibc2.33\r\n```\r\n### Event Log\r\n\r\nThe event log contains the following:\r\n\r\n```\r\ninfo: Proxy server listening at http://*:8080\r\ninfo: 127.0.0.1:55706: client connect\r\ninfo: 127.0.0.1:55706: server connect 127.0.0.1:8081\r\nerror: Addon error: Traceback (most recent call last):\r\n  File \"/usr/lib/python3.9/site-packages/mitmproxy/addons/tlsconfig.py\", line 122, in tls_start_client\r\n    self.create_client_proxy_ssl_conn(tls_start)\r\n  File \"/usr/lib/python3.9/site-packages/mitmproxy/addons/tlsconfig.py\", line 131, in create_client_proxy_ssl_conn\r\n    entry = self.get_cert(tls_start.context)\r\n  File \"/usr/lib/python3.9/site-packages/mitmproxy/addons/tlsconfig.py\", line 287, in get_cert\r\n    if upstream_cert.cn:\r\n  File \"/usr/lib/python3.9/site-packages/mitmproxy/certs.py\", line 117, in cn\r\n    attrs = self._cert.subject.get_attributes_for_oid(x509.NameOID.COMMON_NAME)\r\n  File \"/usr/lib/python3.9/site-packages/cryptography/hazmat/backends/openssl/x509.py\", line 110, in subject\r\n    return _decode_x509_name(self._backend, subject)\r\n  File \"/usr/lib/python3.9/site-packages/cryptography/hazmat/backends/openssl/decode_asn1.py\", line 63, in _decode_x509_name\r\n    attribute = _decode_x509_name_entry(backend, entry)\r\n  File \"/usr/lib/python3.9/site-packages/cryptography/hazmat/backends/openssl/decode_asn1.py\", line 54, in _decode_x509_name_entry\r\n    return x509.NameAttribute(x509.ObjectIdentifier(oid), value, type)\r\n  File \"/usr/lib/python3.9/site-packages/cryptography/x509/name.py\", line 91, in __init__\r\n    raise ValueError(\r\nValueError: Country name must be a 2 character country code\r\n\r\nerror: 127.0.0.1:55706: No TLS context was provided, failing connection.\r\nerror: 127.0.0.1:55706: mitmproxy has crashed!\r\nTraceback (most recent call last):\r\n  File \"/usr/lib/python3.9/site-packages/mitmproxy/proxy/server.py\", line 279, in server_event\r\n    for command in layer_commands:\r\n  File \"/usr/lib/python3.9/site-packages/mitmproxy/proxy/layer.py\", line 168, in handle_event\r\n    command = next(command_generator)\r\n  File \"/usr/lib/python3.9/site-packages/mitmproxy/proxy/layer.py\", line 255, in handle_event\r\n    yield from self._handle(event)\r\n  File \"/usr/lib/python3.9/site-packages/mitmproxy/proxy/layer.py\", line 168, in handle_event\r\n    command = next(command_generator)\r\n  File \"/usr/lib/python3.9/site-packages/mitmproxy/proxy/layers/http/__init__.py\", line 690, in _handle_event\r\n    yield from self.event_to_child(stream, event)\r\n  File \"/usr/lib/python3.9/site-packages/mitmproxy/proxy/layers/http/__init__.py\", line 740, in event_to_child\r\n    for command in child.handle_event(event):\r\n  File \"/usr/lib/python3.9/site-packages/mitmproxy/proxy/layer.py\", line 168, in handle_event\r\n    command = next(command_generator)\r\n  File \"/usr/lib/python3.9/site-packages/mitmproxy/proxy/layers/http/__init__.py\", line 608, in passthrough\r\n    for command in self.child_layer.handle_event(event):\r\n  File \"/usr/lib/python3.9/site-packages/mitmproxy/proxy/layer.py\", line 168, in handle_event\r\n    command = next(command_generator)\r\n  File \"/usr/lib/python3.9/site-packages/mitmproxy/proxy/tunnel.py\", line 85, in _handle_event\r\n    yield from self.event_to_child(event)\r\n  File \"/usr/lib/python3.9/site-packages/mitmproxy/proxy/tunnel.py\", line 104, in event_to_child\r\n    for command in self.child_layer.handle_event(event):\r\n  File \"/usr/lib/python3.9/site-packages/mitmproxy/proxy/layer.py\", line 168, in handle_event\r\n    command = next(command_generator)\r\n  File \"/usr/lib/python3.9/site-packages/mitmproxy/proxy/tunnel.py\", line 85, in _handle_event\r\n    yield from self.event_to_child(event)\r\n  File \"/usr/lib/python3.9/site-packages/mitmproxy/proxy/layers/tls.py\", line 320, in event_to_child\r\n    yield from super().event_to_child(event)\r\n  File \"/usr/lib/python3.9/site-packages/mitmproxy/proxy/tunnel.py\", line 104, in event_to_child\r\n    for command in self.child_layer.handle_event(event):\r\n  File \"/usr/lib/python3.9/site-packages/mitmproxy/proxy/layer.py\", line 129, in handle_event\r\n    yield from self.__continue(event)\r\n  File \"/usr/lib/python3.9/site-packages/mitmproxy/proxy/layer.py\", line 220, in __continue\r\n    yield from self.__process(command_generator, event.reply)\r\n  File \"/usr/lib/python3.9/site-packages/mitmproxy/proxy/layer.py\", line 207, in __process\r\n    command = next(command_generator)\r\n  File \"/usr/lib/python3.9/site-packages/mitmproxy/proxy/tunnel.py\", line 61, in _handle_event\r\n    done, err = yield from self.receive_handshake_data(event.data)\r\n  File \"/usr/lib/python3.9/site-packages/mitmproxy/proxy/layers/tls.py\", line 381, in receive_handshake_data\r\n    yield from self.start_tls()\r\n  File \"/usr/lib/python3.9/site-packages/mitmproxy/proxy/layers/tls.py\", line 173, in start_tls\r\n    assert tls_start.ssl_conn\r\nAssertionError\r\n\r\ninfo: 127.0.0.1:55706: Client TLS handshake failed. The client disconnected during the handshake. If this happens consistently for jonathanh.co.uk, this may\r\nindicate that the client does not trust the proxy's certificate.\r\ninfo: 127.0.0.1:55706: client disconnect\r\ninfo: 127.0.0.1:55706: server disconnect 127.0.0.1:8081\r\n```","closed_by":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/4713/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/4713/timeline","performed_via_github_app":null,"state_reason":"completed"}