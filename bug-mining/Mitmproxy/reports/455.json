{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5148","repository_url":"https://api.github.com/repos/mitmproxy/mitmproxy","labels_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5148/labels{/name}","comments_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5148/comments","events_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5148/events","html_url":"https://github.com/mitmproxy/mitmproxy/issues/5148","id":1145210517,"node_id":"I_kwDOAAfumM5EQoaV","number":5148,"title":"Crash when editing multipart/formdata","user":{"login":"psacawa","id":21274063,"node_id":"MDQ6VXNlcjIxMjc0MDYz","avatar_url":"https://avatars.githubusercontent.com/u/21274063?v=4","gravatar_id":"","url":"https://api.github.com/users/psacawa","html_url":"https://github.com/psacawa","followers_url":"https://api.github.com/users/psacawa/followers","following_url":"https://api.github.com/users/psacawa/following{/other_user}","gists_url":"https://api.github.com/users/psacawa/gists{/gist_id}","starred_url":"https://api.github.com/users/psacawa/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/psacawa/subscriptions","organizations_url":"https://api.github.com/users/psacawa/orgs","repos_url":"https://api.github.com/users/psacawa/repos","events_url":"https://api.github.com/users/psacawa/events{/privacy}","received_events_url":"https://api.github.com/users/psacawa/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":466930397,"node_id":"MDU6TGFiZWw0NjY5MzAzOTc=","url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels/kind/triage","name":"kind/triage","color":"006b75","default":false,"description":"Unclassified issues"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-02-21T01:23:10Z","updated_at":"2023-02-07T10:29:11Z","closed_at":"2023-02-07T10:29:11Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"#### Problem Description\r\n\r\nI received the following message when editng a field of a `multipart/form-data` request body, which is for for file uploads.\r\n\r\n```\r\nTraceback (most recent call last):\r\n  File \"mitmproxy/master.py\", line 54, in run_loop\r\n  File \"urwid/main_loop.py\", line 287, in run\r\n  File \"urwid/main_loop.py\", line 385, in _run\r\n  File \"urwid/main_loop.py\", line 1494, in run\r\n  File \"urwid/compat.py\", line 58, in reraise\r\n  File \"asyncio/events.py\", line 80, in _run\r\n  File \"urwid/raw_display.py\", line 416, in <lambda>\r\n  File \"urwid/raw_display.py\", line 515, in parse_input\r\n  File \"urwid/main_loop.py\", line 412, in _update\r\n  File \"urwid/main_loop.py\", line 513, in process_input' (No such file or directory)\r\n  File \"mitmproxy/tools/console/window.py\", line 318, in keypress\r\n  File \"mitmproxy/tools/console/keymap.py\", line 145, in handle\r\n  File \"mitmproxy/tools/console/commandexecutor.py\", line 18, in __call__\r\n  File \"mitmproxy/command.py\", line 273, in execute\r\n  File \"mitmproxy/command.py\", line 259, in call_strings\r\n  File \"mitmproxy/command.py\", line 129, in call\r\n  File \"mitmproxy/command.py\", line 303, in wrapper\r\n  File \"mitmproxy/tools/console/consoleaddons.py\", line 328, in view_pop\r\n  File \"blinker/base.py\", line 266, in send\r\n  File \"blinker/base.py\", line 266, in <listcomp>\r\n  File \"mitmproxy/tools/console/window.py\", line 247, in pop\r\n  File \"mitmproxy/tools/console/window.py\", line 114, in pop\r\n  File \"mitmproxy/tools/console/window.py\", line 126, in call\r\n  File \"mitmproxy/tools/console/grideditor/base.py\", line 462, in layout_popping\r\n  File \"mitmproxy/tools/console/grideditor/base.py\", line 440, in call\r\n  File \"mitmproxy/tools/console/grideditor/base.py\", line 313, in layout_popping\r\n  File \"mitmproxy/tools/console/grideditor/base.py\", line 455, in set_data_update\r\n  File \"mitmproxy/tools/console/grideditor/editors.py\", line 68, in set_data\r\n  File \"mitmproxy/http.py\", line 998, in multipart_form\r\n  File \"mitmproxy/http.py\", line 979, in _set_multipart_form\r\n  File \"mitmproxy/net/http/multipart.py\", line 34, in encode\r\n  File \"re.py\", line 201, in search\r\nTypeError: cannot use a bytes pattern on a string-like object\r\n\r\nmitmproxy has crashed!\r\nPlease lodge a bug report at:\r\n        https://github.com/mitmproxy/mitmproxy/issues\r\n```\r\nRecording: \r\n[![asciicast](https://asciinema.org/a/CZuTvDKY3PPObhJCGfUx7vagA.svg)](https://asciinema.org/a/CZuTvDKY3PPObhJCGfUx7vagA)\r\nYou can see in the recording that the Grideditor fields display the stringified bytes objects `str(b'asdf')`. I have been able to recreate the bug editing all fields of the `multipart/form-data`, not just the one for the file itself. **This bug has nothing to do with the external editor, as I initially wrote.**\r\n\r\nAnother issue is the the GridEditor  for `multipart/form-data` is very slow for even medium-sized files. When dealing with a 197Kb file, it becomes unresponsive.\r\n\r\n#### Steps to reproduce the behavior:\r\n1. Send a post request with a file upload encoded as `multipart/form-data` \r\n2. Edit a field of the request with the `multipart/form-data`  `GridEditor` view directly in `mitmproxy`\r\n3. Return from the external editor by pressing `Q`.\r\n\r\n#### System Information\r\nReplicated on:\r\n```\r\nMitmproxy: 7.0.0 binary\r\nPython:    3.9.5\r\nOpenSSL:   OpenSSL 1.1.1k  25 Mar 2021\r\nPlatform:  Linux-5.13.0-28-generic-x86_64-with-glibc2.31\r\n```\r\n\r\n```\r\nMitmproxy: 7.0.4 binary\r\nPython:    3.9.7\r\nOpenSSL:   OpenSSL 1.1.1l  24 Aug 2021\r\nPlatform:  Linux-5.13.0-28-generic-x86_64-with-glibc2.31\r\n```\r\n","closed_by":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5148/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5148/timeline","performed_via_github_app":null,"state_reason":"completed"}