{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/307","repository_url":"https://api.github.com/repos/mitmproxy/mitmproxy","labels_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/307/labels{/name}","comments_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/307/comments","events_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/307/events","html_url":"https://github.com/mitmproxy/mitmproxy/issues/307","id":37777368,"node_id":"MDU6SXNzdWUzNzc3NzM2OA==","number":307,"title":"Bug in '~bs' and 'b' operators (+ working but crappy 'fix')","user":{"login":"Jamie-Landeg-Jones","id":483894,"node_id":"MDQ6VXNlcjQ4Mzg5NA==","avatar_url":"https://avatars.githubusercontent.com/u/483894?v=4","gravatar_id":"","url":"https://api.github.com/users/Jamie-Landeg-Jones","html_url":"https://github.com/Jamie-Landeg-Jones","followers_url":"https://api.github.com/users/Jamie-Landeg-Jones/followers","following_url":"https://api.github.com/users/Jamie-Landeg-Jones/following{/other_user}","gists_url":"https://api.github.com/users/Jamie-Landeg-Jones/gists{/gist_id}","starred_url":"https://api.github.com/users/Jamie-Landeg-Jones/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Jamie-Landeg-Jones/subscriptions","organizations_url":"https://api.github.com/users/Jamie-Landeg-Jones/orgs","repos_url":"https://api.github.com/users/Jamie-Landeg-Jones/repos","events_url":"https://api.github.com/users/Jamie-Landeg-Jones/events{/privacy}","received_events_url":"https://api.github.com/users/Jamie-Landeg-Jones/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":79336502,"node_id":"MDU6TGFiZWw3OTMzNjUwMg==","url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels/kind/bug","name":"kind/bug","color":"d93f0b","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/milestones/4","html_url":"https://github.com/mitmproxy/mitmproxy/milestone/4","labels_url":"https://api.github.com/repos/mitmproxy/mitmproxy/milestones/4/labels","id":673178,"node_id":"MDk6TWlsZXN0b25lNjczMTc4","number":4,"title":"0.11","description":"","creator":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":43,"state":"closed","created_at":"2014-05-28T16:11:10Z","updated_at":"2014-11-11T10:21:37Z","due_on":null,"closed_at":"2014-11-11T10:21:10Z"},"comments":4,"created_at":"2014-07-14T11:08:26Z","updated_at":"2014-08-03T21:58:30Z","closed_at":"2014-08-03T00:35:04Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I've noticed a problem with filter operators, specifically '~bs':\n\nUsing '~bs' or '~b' in a replace expression, if the remote content is compressed, the operator will fail to match, as the test is applied to the non-decoded result.\n\nI've supplied a quick and dirty solution for '~b' which works, but I've never programmed Python before, and done very little OO, so I know this patch isn't good enough to merge, but hopefully it helps show thr problem.\n\nThree immediate issues with this fix I can see:\n\n1) This is probably not the place for this code, as in its current form it needs to be duplicated in the '~b' section.\n\n2) When there's a '~b' or '~bs' match, the body is decompressed twice.\n\n3) If there are multiple '~bs' operators, then the document will be seperately decompressed for each one (and again for each one with a positive match) [ though, doesn't it already work that way where one url may match more than one operator causing duplicate decomprssions? ]\n\nAnyway, with file libmproxy/filt.py at the beginning, after the line:\n\n```\nfrom .contrib import pyparsing as pp\n```\n\nI added:\n\n```\nfrom . import encoding\n```\n\nThen, I replaced the FBodResponse block from:\n\n```\nclass FBodResponse(_Rex):\n    code = \"bs\"\n    help = \"Response body\"\n    def __call__(self, f):\n        if f.response and f.response.content and re.search(self.expr, f.response.content):\n            return True\n```\n\nto:\n\n```\nclass FBodResponse(_Rex):\n    code = \"bs\"\n    help = \"Response body\"\n    def __call__(self, f):\n        if f.response and f.response.content:\n            self.f = f\n            ce = f.response.headers.get_first(\"content-encoding\")\n            if ce in encoding.ENCODINGS:\n                self.ce = ce\n                self.f.response.decode()\n            if re.search(self.expr, f.response.content):\n                return True\n```\n","closed_by":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/307/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/307/timeline","performed_via_github_app":null,"state_reason":"completed"}