{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5109","repository_url":"https://api.github.com/repos/mitmproxy/mitmproxy","labels_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5109/labels{/name}","comments_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5109/comments","events_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5109/events","html_url":"https://github.com/mitmproxy/mitmproxy/issues/5109","id":1122976230,"node_id":"I_kwDOAAfumM5C70Hm","number":5109,"title":"Wrong SNI hostname used for upstream HTTPS proxy","user":{"login":"flowztul","id":5297798,"node_id":"MDQ6VXNlcjUyOTc3OTg=","avatar_url":"https://avatars.githubusercontent.com/u/5297798?v=4","gravatar_id":"","url":"https://api.github.com/users/flowztul","html_url":"https://github.com/flowztul","followers_url":"https://api.github.com/users/flowztul/followers","following_url":"https://api.github.com/users/flowztul/following{/other_user}","gists_url":"https://api.github.com/users/flowztul/gists{/gist_id}","starred_url":"https://api.github.com/users/flowztul/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/flowztul/subscriptions","organizations_url":"https://api.github.com/users/flowztul/orgs","repos_url":"https://api.github.com/users/flowztul/repos","events_url":"https://api.github.com/users/flowztul/events{/privacy}","received_events_url":"https://api.github.com/users/flowztul/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":79336502,"node_id":"MDU6TGFiZWw3OTMzNjUwMg==","url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels/kind/bug","name":"kind/bug","color":"d93f0b","default":false,"description":null},{"id":429896009,"node_id":"MDU6TGFiZWw0Mjk4OTYwMDk=","url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels/area/protocols","name":"area/protocols","color":"fef2c0","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-02-03T11:34:02Z","updated_at":"2025-03-12T19:41:01Z","closed_at":"2022-03-29T08:27:56Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"#### Problem Description\r\nWhen using mitmproxy with an upstream HTTPS proxy, it will attempt to use the client connection's target host for SNI in the outer TLS connection, and will subsequently fail to validate that connection and return \"502 Bad Gateway\" -- \"Certificate verify failed: Hostname mismatch\"\r\n\r\n#### Steps to reproduce the behavior:\r\n1. Start mitmproxy with an HTTPS upstream proxy, e.g. `mitmproxy --mode upstream:https://example.com:1234 --upstream-auth user:pass`\r\n2. Issue an HTTP request, e.g. `curl -ski -x http://127.0.0.1:8080 https://api.ipify.org`\r\n3. mitmproxy will log `warn: 127.0.0.1:55584: Server TLS handshake failed. Certificate verify failed: Hostname mismatch` and return a `502 Bad Gateway` error with reason `Certificate verify failed: Hostname mismatch` to the client.\r\n4. A packet capture of the upstream traffic shows that mitmproxy tried to use `api.ipify.org` for SNI in the TLS connection to the upstream proxy.\r\n\r\n#### System Information\r\n```\r\nMitmproxy: 7.0.4\r\nPython:    3.8.10\r\nOpenSSL:   OpenSSL 1.1.1l  24 Aug 2021\r\nPlatform:  Linux-5.4.0-26-generic-x86_64-with-glibc2.29\r\n```","closed_by":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5109/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5109/timeline","performed_via_github_app":null,"state_reason":"completed"}