{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5316","repository_url":"https://api.github.com/repos/mitmproxy/mitmproxy","labels_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5316/labels{/name}","comments_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5316/comments","events_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5316/events","html_url":"https://github.com/mitmproxy/mitmproxy/issues/5316","id":1223890374,"node_id":"I_kwDOAAfumM5I8xXG","number":5316,"title":"Improper handling of Punycode","user":{"login":"ZzZombo","id":10889612,"node_id":"MDQ6VXNlcjEwODg5NjEy","avatar_url":"https://avatars.githubusercontent.com/u/10889612?v=4","gravatar_id":"","url":"https://api.github.com/users/ZzZombo","html_url":"https://github.com/ZzZombo","followers_url":"https://api.github.com/users/ZzZombo/followers","following_url":"https://api.github.com/users/ZzZombo/following{/other_user}","gists_url":"https://api.github.com/users/ZzZombo/gists{/gist_id}","starred_url":"https://api.github.com/users/ZzZombo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ZzZombo/subscriptions","organizations_url":"https://api.github.com/users/ZzZombo/orgs","repos_url":"https://api.github.com/users/ZzZombo/repos","events_url":"https://api.github.com/users/ZzZombo/events{/privacy}","received_events_url":"https://api.github.com/users/ZzZombo/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":79336502,"node_id":"MDU6TGFiZWw3OTMzNjUwMg==","url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels/kind/bug","name":"kind/bug","color":"d93f0b","default":false,"description":null},{"id":174959532,"node_id":"MDU6TGFiZWwxNzQ5NTk1MzI=","url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels/help%20wanted","name":"help wanted","color":"fbca04","default":true,"description":null},{"id":429896009,"node_id":"MDU6TGFiZWw0Mjk4OTYwMDk=","url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels/area/protocols","name":"area/protocols","color":"fef2c0","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-05-03T09:48:39Z","updated_at":"2022-05-06T11:02:50Z","closed_at":"2022-05-06T11:02:50Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"#### Problem Description\r\nCan't open an address like `https://стопкоронавирус.рф/` through `mitmproxy` or other applications. My upstream proxy receives a CONNECT request to https://СЃС‚РѕРїРєРѕСЂРѕРЅР°РІРёСЂСѓСЃ.СЂС„:443 instead. As the current run of `mitmproxy` was supposed to be just a test, it was configured only to forward all requests as-is to the upstream proxy, so this rules out any and all issues that could arise from my tinkering. Note: the actual URL that the browser opens is `https://xn--80aesfpebagmfblc0a.xn--p1ai` in this case.\r\n\r\nDid it fail to properly encode the resulting authority? My upstream proxy normally has no issues with opening Puny-encoded URLs. I can verify that by opening that URL bypassing `mitmproxy`. It looks like it uses the wrong encoding, as it reminds me of the time when Unicode was not widespread and so this is how text in Russian would display when the text encoding wasn't set correctly.\r\n\r\n#### Steps to reproduce the behavior:\r\n1. Configure `mitmproxy` to forward all requests as-is to the upstream proxy that optionally can report what requests it receives. This includes no HTTPS decryption.\r\n2. Navigate your browser to `https://стопкоронавирус.рф/`.\r\n3. Check what the authority part of the URL the upstream proxy gets, it should be mangled.\r\n\r\n#### System Information\r\nPaste the output of \"mitmproxy --version\" here.\r\n\r\n```Mitmproxy: 8.0.0 binary\r\nPython:    3.10.2\r\nOpenSSL:   OpenSSL 1.1.1n  15 Mar 2022\r\nPlatform:  Windows-10-10.0.19043-SP0\r\n```","closed_by":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5316/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5316/timeline","performed_via_github_app":null,"state_reason":"completed"}