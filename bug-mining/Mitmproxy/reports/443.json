{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5584","repository_url":"https://api.github.com/repos/mitmproxy/mitmproxy","labels_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5584/labels{/name}","comments_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5584/comments","events_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5584/events","html_url":"https://github.com/mitmproxy/mitmproxy/issues/5584","id":1371253490,"node_id":"I_kwDOAAfumM5Ru6ry","number":5584,"title":"Test_Format.test_roundtrip_big_integer test fails with Python 3.10.7+, 3.9.14+, 3.8.14+, 3.7.14+","user":{"login":"decathorpe","id":12836693,"node_id":"MDQ6VXNlcjEyODM2Njkz","avatar_url":"https://avatars.githubusercontent.com/u/12836693?v=4","gravatar_id":"","url":"https://api.github.com/users/decathorpe","html_url":"https://github.com/decathorpe","followers_url":"https://api.github.com/users/decathorpe/followers","following_url":"https://api.github.com/users/decathorpe/following{/other_user}","gists_url":"https://api.github.com/users/decathorpe/gists{/gist_id}","starred_url":"https://api.github.com/users/decathorpe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/decathorpe/subscriptions","organizations_url":"https://api.github.com/users/decathorpe/orgs","repos_url":"https://api.github.com/users/decathorpe/repos","events_url":"https://api.github.com/users/decathorpe/events{/privacy}","received_events_url":"https://api.github.com/users/decathorpe/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":466930397,"node_id":"MDU6TGFiZWw0NjY5MzAzOTc=","url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels/kind/triage","name":"kind/triage","color":"006b75","default":false,"description":"Unclassified issues"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-09-13T10:54:16Z","updated_at":"2022-09-15T12:06:34Z","closed_at":"2022-09-15T12:06:34Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"#### Problem Description\r\n\r\nAccording to the release notes for 3.10.7:\r\nhttps://docs.python.org/3/whatsnew/changelog.html#python-3-10-7-final\r\n\r\nThere's now a size limit on integers / strings when converting between them to address CVE CVE-2020-10735.\r\nThis seems to trip up the Test_Format.test_roundtrip_big_integer test in mitmproxy:\r\n\r\n```\r\n____________________ Test_Format.test_roundtrip_big_integer ____________________\r\n\r\nself = <test_tnetstring.Test_Format testMethod=test_roundtrip_big_integer>\r\n\r\n    def test_roundtrip_big_integer(self):\r\n        i1 = math.factorial(30000)\r\n>       s = tnetstring.dumps(i1)\r\n\r\ntest/mitmproxy/io/test_tnetstring.py:91: \r\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \r\nmitmproxy/io/tnetstring.py:57: in dumps\r\n    _rdumpq(q, 0, value)\r\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \r\n\r\nq = deque([]), size = 0\r\nvalue = <[ValueError('Exceeds the limit (4300) for integer string conversion') raised in repr()] int object at 0x55f6fc81d070>\r\n\r\n    def _rdumpq(q: collections.deque, size: int, value: TSerializable) -> int:\r\n        \"\"\"\r\n        Dump value as a tnetstring, to a deque instance, last chunks first.\r\n    \r\n        This function generates the tnetstring representation of the given value,\r\n        pushing chunks of the output onto the given deque instance.  It pushes\r\n        the last chunk first, then recursively generates more chunks.\r\n    \r\n        When passed in the current size of the string in the queue, it will return\r\n        the new size of the string in the queue.\r\n    \r\n        Operating last-chunk-first makes it easy to calculate the size written\r\n        for recursive structures without having to build their representation as\r\n        a string.  This is measurably faster than generating the intermediate\r\n        strings, especially on deeply nested structures.\r\n        \"\"\"\r\n        write = q.appendleft\r\n        if value is None:\r\n            write(b\"0:~\")\r\n            return size + 3\r\n        elif value is True:\r\n            write(b\"4:true!\")\r\n            return size + 7\r\n        elif value is False:\r\n            write(b\"5:false!\")\r\n            return size + 8\r\n        elif isinstance(value, int):\r\n>           data = str(value).encode()\r\nE           ValueError: Exceeds the limit (4300) for integer string conversion\r\n```\r\n\r\n#### Steps to reproduce the behavior:\r\n\r\nRunning `tox -e py` with any of the newly released Python versions triggers this test failure.\r\n\r\n#### System Information\r\n\r\n```\r\n$ mitmproxy --version\r\nMitmproxy: 9.0.0.dev (+102, commit a5f75a0)\r\nPython:    3.10.7\r\nOpenSSL:   OpenSSL 3.0.5 5 Jul 2022\r\nPlatform:  Linux-5.19.8-200.fc36.x86_64-x86_64-with-glibc2.35\r\n```","closed_by":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5584/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5584/timeline","performed_via_github_app":null,"state_reason":"completed"}