{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/6944","repository_url":"https://api.github.com/repos/mitmproxy/mitmproxy","labels_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/6944/labels{/name}","comments_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/6944/comments","events_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/6944/events","html_url":"https://github.com/mitmproxy/mitmproxy/issues/6944","id":2368191588,"node_id":"I_kwDOAAfumM6NJ7xk","number":6944,"title":"Non-linear growth in processing time with mitmproxy regarding packet size","user":{"login":"jackfromeast","id":51242003,"node_id":"MDQ6VXNlcjUxMjQyMDAz","avatar_url":"https://avatars.githubusercontent.com/u/51242003?v=4","gravatar_id":"","url":"https://api.github.com/users/jackfromeast","html_url":"https://github.com/jackfromeast","followers_url":"https://api.github.com/users/jackfromeast/followers","following_url":"https://api.github.com/users/jackfromeast/following{/other_user}","gists_url":"https://api.github.com/users/jackfromeast/gists{/gist_id}","starred_url":"https://api.github.com/users/jackfromeast/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jackfromeast/subscriptions","organizations_url":"https://api.github.com/users/jackfromeast/orgs","repos_url":"https://api.github.com/users/jackfromeast/repos","events_url":"https://api.github.com/users/jackfromeast/events{/privacy}","received_events_url":"https://api.github.com/users/jackfromeast/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":466930397,"node_id":"MDU6TGFiZWw0NjY5MzAzOTc=","url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels/kind/triage","name":"kind/triage","color":"006b75","default":false,"description":"Unclassified issues"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":12,"created_at":"2024-06-23T03:05:48Z","updated_at":"2024-06-24T10:36:41Z","closed_at":"2024-06-24T10:36:41Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"#### Problem Description\r\nRecently, I've observed an additional overhead that impacts performance which is primarily caused by the `mitmproxy` proxy server. Through my analysis, I identified two critical issues:\r\n\r\n1. Non-linear Growth in Processing Time: The processing time for network requests increases non-linearly with the size of the packets. This means that as the packet size grows, the time required to process these requests increases disproportionately.\r\n\r\n2. Significant Slowdown with Concurrent Requests: The processing time for network requests slows down dramatically when handling multiple requests simultaneously.\r\n\r\nThe worst-case scenario occurs when there is a high volume of concurrent requests, especially when some of these requests are significantly large. In such cases, the performance degradation is severe, leading to substantial delays and inefficiencies in processing.\r\n\r\nI demonstrated these findings through two experimental settings: 1/ **Sequential Requests**: The first HTML page loads the JavaScript files one by one. Each request is triggered by the `onload` event of the previously requested JavaScript file. 2/ **Concurrent Requests**: The second HTML request loads all the JavaScript files simultaneously. For these experiments, I created 20 JavaScript files ranging from 1MB to 100MB, increasing by 5MB each. I host the proxy and test server on the `localhost` with different ports.\r\n\r\n\r\n#### Sequential Requests: Without mitmproxy vs. With mitmproxy\r\n\r\n![mitmproxy_performance_impact-1](https://github.com/mitmproxy/mitmproxy/assets/51242003/41ae3a87-a3e7-47b8-906c-99a090a41d92)\r\n\r\n| Name                | Size     | Loading Time (Without mitmproxy) | Loading Time (With mitmproxy) |\r\n|---------------------|----------|----------------------------------|-------------------------------|\r\n| large_script_1.js   | 1.0 MB   | 4 ms                             | 71 ms                         |\r\n| large_script_2.js   | 6.3 MB   | 35 ms                            | 62 ms                         |\r\n| large_script_3.js   | 11.5 MB  | 83 ms                            | 195 ms                        |\r\n| large_script_4.js   | 16.8 MB  | 142 ms                           | 272 ms                        |\r\n| large_script_5.js   | 22.0 MB  | 201 ms                           | 416 ms                        |\r\n| large_script_6.js   | 27.3 MB  | 254 ms                           | 602 ms                        |\r\n| large_script_7.js   | 32.5 MB  | 294 ms                           | 818 ms                        |\r\n| large_script_8.js   | 37.7 MB  | 357 ms                           | 1.78 s                        |\r\n| large_script_9.js   | 43.0 MB  | 412 ms                           | 2.94 s                        |\r\n| large_script_10.js  | 48.2 MB  | 467 ms                           | 4.34 s                        |\r\n| large_script_11.js  | 53.5 MB  | 502 ms                           | 5.82 s                        |\r\n| large_script_12.js  | 58.7 MB  | 578 ms                           | 7.69 s                        |\r\n| large_script_13.js  | 64.0 MB  | 590 ms                           | 9.29 s                        |\r\n| large_script_14.js  | 69.2 MB  | 664 ms                           | 11.30 s                       |\r\n| large_script_15.js  | 74.4 MB  | 744 ms                           | 13.83 s                       |\r\n| large_script_16.js  | 79.7 MB  | 779 ms                           | 16.19 s                       |\r\n| large_script_17.js  | 84.9 MB  | 832 ms                           | 18.74 s                       |\r\n| large_script_18.js  | 90.2 MB  | 883 ms                           | 20.94 s                       |\r\n| large_script_19.js  | 95.4 MB  | 976 ms                           | 24.02 s                       |\r\n| large_script_20.js  | 101 MB   | 970 ms                           | 26.58 s                       |\r\n\r\n**Without mitmproxy:**\r\n\r\n![mitm-nproxy-one-by-one](https://github.com/mitmproxy/mitmproxy/assets/51242003/d41b6bc3-c43e-4a39-87d7-83b728f438c8)\r\n\r\n**With mitmproxy:**\r\n\r\n![mitm-proxy-one-by-one](https://github.com/mitmproxy/mitmproxy/assets/51242003/88f27944-ea83-44c4-9ca4-83c7837c0fb5)\r\n\r\n#### Concurrent Requests: Without mitmproxy vs. With mitmproxy\r\n\r\n![mitmproxy_performance_impact-2](https://github.com/mitmproxy/mitmproxy/assets/51242003/2060a008-d644-405c-afcc-e89eca323293)\r\n\r\n\r\n| Name                | Size     | Loading Time (Without mitmproxy) | Loading Time (With mitmproxy) |\r\n|---------------------|----------|----------------------------------|-------------------------------|\r\n| large_script_1.js   | 1.0 MB   | 4 ms                             | 21 ms                         |\r\n| large_script_2.js   | 6.3 MB   | 40 ms                            | 281 ms                        |\r\n| large_script_3.js   | 11.5 MB  | 97 ms                            | 700 ms                        |\r\n| large_script_4.js   | 16.8 MB  | 152 ms                           | 1.36 s                        |\r\n| large_script_5.js   | 22.0 MB  | 202 ms                           | 1.72 s                        |\r\n| large_script_6.js   | 27.3 MB  | 266 ms                           | 2.53 s                        |\r\n| large_script_7.js   | 32.5 MB  | 332 ms                           | 3.53 s                        |\r\n| large_script_8.js   | 37.7 MB  | 435 ms                           | 6.03 s                        |\r\n| large_script_9.js   | 43.0 MB  | 547 ms                           | 9.56 s                        |\r\n| large_script_10.js  | 48.2 MB  | 719 ms                           | 15.74 s                       |\r\n| large_script_11.js  | 53.5 MB  | 940 ms                           | 20.72 s                       |\r\n| large_script_12.js  | 58.7 MB  | 1.05 s                           | 28.10 s                       |\r\n| large_script_13.js  | 64.0 MB  | 1.17 s                           | 36.80 s                       |\r\n| large_script_14.js  | 69.2 MB  | 1.27 s                           | 50.31 s                       |\r\n| large_script_15.js  | 74.4 MB  | 1.64 s                           | 1.1 min                       |\r\n| large_script_16.js  | 79.7 MB  | 2.10 s                           | 1.4 min                       |\r\n| large_script_17.js  | 84.9 MB  | 2.41 s                           | 1.6 min                       |\r\n| large_script_18.js  | 90.2 MB  | 2.54 s                           | 1.9 min                       |\r\n| large_script_19.js  | 95.4 MB  | 2.77 s                           | 2.2 min                       |\r\n| large_script_20.js  | 101 MB   | 2.94 s                           | 2.4 min                       |\r\n\r\n**Without mitmproxy:**\r\n\r\n![mitm-nproxy-concurrent](https://github.com/mitmproxy/mitmproxy/assets/51242003/11a6b9c8-cc92-45be-9d7e-bac4464bcea2)\r\n\r\n**With mitmproxy:**\r\n\r\n![mitm-proxy-concurrent](https://github.com/mitmproxy/mitmproxy/assets/51242003/d134c140-c36b-4254-a4c6-94b77f434c36)\r\n\r\n#### System Information\r\n\r\n```\r\nMitmproxy: 10.3.0\r\nPython:    3.11.6\r\nOpenSSL:   OpenSSL 3.2.2 4 Jun 2024\r\nPlatform:  Linux-6.5.0-28-generic-x86_64-with-glibc2.38\r\n```\r\n\r\n**Therefore, I was wondering if there is a way to mitigate this situation that makes mitmproxy good at processing ~100MB JavaScript files if there is no resource limitation? Thanks!**","closed_by":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/6944/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/6944/timeline","performed_via_github_app":null,"state_reason":"completed"}