{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/2036","repository_url":"https://api.github.com/repos/mitmproxy/mitmproxy","labels_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/2036/labels{/name}","comments_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/2036/comments","events_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/2036/events","html_url":"https://github.com/mitmproxy/mitmproxy/issues/2036","id":208565826,"node_id":"MDU6SXNzdWUyMDg1NjU4MjY=","number":2036,"title":"Add `request.host_header`","user":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":429896009,"node_id":"MDU6TGFiZWw0Mjk4OTYwMDk=","url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels/area/protocols","name":"area/protocols","color":"fef2c0","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2017-02-17T21:45:06Z","updated_at":"2017-02-18T11:08:55Z","closed_at":"2017-02-18T11:08:55Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"There are a bunch of places in the codebase where we use a hard-coded `headers[\"Host\"]` that now also have to deal with h2, see for example https://github.com/mitmproxy/mitmproxy/pull/2034. The question is how we handle this best:\r\n\r\n1. Rewrite the special h2 headers starting with a colon to their h1 counterparts before we send them to the rest of mitmproxy (and undo that before sending them out). This would fix the symptoms we currently have, but we wouldn't display h2 flows accurately in the UI anymore (and the mapping would not be bijective). Sounds rather unconvincing to me.\r\n2. Add a special `request.host_header` (or `.authority_header`?) property that proxies to the right header and use that instead of `headers[\"Host\"]`.\r\n3. Distinguish between both headers everywhere. Nah.\r\n\r\nUnless somebody comes up with a better option, I'd propose we go an implement option 2 to tackle this. Implementation isn't entirely trivial, but I'd propose the following semantics:\r\n\r\n- Get with no header present: `None`\r\n- Get with (either `Host` or `:authority`) or matching `Host` and `:authority`: the correct header\r\n- Get with different `Host` and `:authority`: Probably raise an exception?\r\n- Set with existing: Update all the existing ones\r\n- Set without existing: Use http_version and only set one of them. \r\n\r\n@Lukasa @Kriechi @yoavweiss, would that work for everyone?","closed_by":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/2036/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/2036/timeline","performed_via_github_app":null,"state_reason":"completed"}