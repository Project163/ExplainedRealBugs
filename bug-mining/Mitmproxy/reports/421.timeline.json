[{"id":5848366439,"node_id":"LE_lADOAAfumM5BPzlpzwAAAAFclv1n","url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/events/5848366439","actor":{"login":"EndUser509","id":42170559,"node_id":"MDQ6VXNlcjQyMTcwNTU5","avatar_url":"https://avatars.githubusercontent.com/u/42170559?v=4","gravatar_id":"","url":"https://api.github.com/users/EndUser509","html_url":"https://github.com/EndUser509","followers_url":"https://api.github.com/users/EndUser509/followers","following_url":"https://api.github.com/users/EndUser509/following{/other_user}","gists_url":"https://api.github.com/users/EndUser509/gists{/gist_id}","starred_url":"https://api.github.com/users/EndUser509/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/EndUser509/subscriptions","organizations_url":"https://api.github.com/users/EndUser509/orgs","repos_url":"https://api.github.com/users/EndUser509/repos","events_url":"https://api.github.com/users/EndUser509/events{/privacy}","received_events_url":"https://api.github.com/users/EndUser509/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2022-01-05T19:09:11Z","label":{"name":"kind/triage","color":"006b75"},"performed_via_github_app":null},{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/comments/1006667814","html_url":"https://github.com/mitmproxy/mitmproxy/issues/5034#issuecomment-1006667814","issue_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5034","id":1006667814,"node_id":"IC_kwDOAAfumM48AIgm","user":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-01-06T15:12:48Z","updated_at":"2022-01-06T15:12:48Z","body":"Honestly I was dreading to even open this issue after reading \"Client sometimes ...\" in the title, but turns out there is a positive surprise in here. ðŸ˜ This is super super interesting, thank you very much! ðŸ°\r\n\r\n1. I can't trigger `.drain()` to raise on my system, but that might be OS-specific. Out of interest, would you mind posting the full OSError `repr()` here?\r\n2. How did you approach finding this? Any tips/tricks you can share?\r\n3. It may be useful to just cancel any handler (not just the current one) if we cannot write. Could you verify that the following patch also works for you?\r\n\r\n```diff\r\n--- a/mitmproxy/proxy/server.py\r\n+++ b/mitmproxy/proxy/server.py\r\n@@ -227,7 +227,11 @@ class ConnectionHandler(metaclass=abc.ABCMeta):\r\n                 self.server_event(events.DataReceived(connection, data))\r\n                 for transport in self.transports.values():\r\n                     if transport.writer is not None:\r\n-                        await transport.writer.drain()\r\n+                        try:\r\n+                            await transport.writer.drain()\r\n+                        except OSError as e:\r\n+                            if transport.handler is not None:\r\n+                                asyncio_utils.cancel_task(transport.handler, f\"cannot drain writer: {e}\")\r\n```\r\n","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/comments/1006667814/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":5852818849,"node_id":"UNLE_lADOAAfumM5BPzlpzwAAAAFc2u2h","url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/events/5852818849","actor":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"unlabeled","commit_id":null,"commit_url":null,"created_at":"2022-01-06T15:13:51Z","label":{"name":"kind/triage","color":"006b75"},"performed_via_github_app":null},{"id":5852818854,"node_id":"LE_lADOAAfumM5BPzlpzwAAAAFc2u2m","url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/events/5852818854","actor":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2022-01-06T15:13:51Z","label":{"name":"area/core","color":"fef2c0"},"performed_via_github_app":null},{"id":5852818860,"node_id":"LE_lADOAAfumM5BPzlpzwAAAAFc2u2s","url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/events/5852818860","actor":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2022-01-06T15:13:51Z","label":{"name":"kind/bug","color":"d93f0b"},"performed_via_github_app":null},{"id":5852818866,"node_id":"LE_lADOAAfumM5BPzlpzwAAAAFc2u2y","url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/events/5852818866","actor":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2022-01-06T15:13:51Z","label":{"name":"prio/high","color":"B3193B"},"performed_via_github_app":null},{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/comments/1006863160","html_url":"https://github.com/mitmproxy/mitmproxy/issues/5034#issuecomment-1006863160","issue_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5034","id":1006863160,"node_id":"IC_kwDOAAfumM48A4M4","user":{"login":"EndUser509","id":42170559,"node_id":"MDQ6VXNlcjQyMTcwNTU5","avatar_url":"https://avatars.githubusercontent.com/u/42170559?v=4","gravatar_id":"","url":"https://api.github.com/users/EndUser509","html_url":"https://github.com/EndUser509","followers_url":"https://api.github.com/users/EndUser509/followers","following_url":"https://api.github.com/users/EndUser509/following{/other_user}","gists_url":"https://api.github.com/users/EndUser509/gists{/gist_id}","starred_url":"https://api.github.com/users/EndUser509/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/EndUser509/subscriptions","organizations_url":"https://api.github.com/users/EndUser509/orgs","repos_url":"https://api.github.com/users/EndUser509/repos","events_url":"https://api.github.com/users/EndUser509/events{/privacy}","received_events_url":"https://api.github.com/users/EndUser509/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-01-06T19:22:26Z","updated_at":"2022-01-06T19:52:26Z","body":"Thanks for looking into this! Apart from this issue the new sansio design rocks! I can even scroll around in Google Maps and the CPU usage of the proxy machine remains in the one digit range. With V4 this was laggy with >100% load. Cool.\r\n\r\n>     1. I can't trigger `.drain()` to raise on my system, but that might be OS-specific. Out of interest, would you mind posting the full OSError `repr()` here?\r\n\r\nWhen I log a `repr(e)` when drain() raises an exception then the log entry reads:\r\n\r\n```ConnectionResetError('Connection lost')```\r\n\r\nOut of curiosity I also added an `except asyncio.CancelledError as e:` after `drain()` and that also sometimes catches an exception (meaning my fix wasn't complete...):\r\n\r\n```CancelledError('client disconnected')```\r\n\r\nI wonder what it takes to reproduce this on your side. I run mitmdump in transparent mode (easy for me to add and remove my machines), from the git repo directly on a CentOS 8 Stream on a laptop. Basically it provides a gateway from my WIFI network to the ADSL router.\r\n\r\n>     2. How did you approach finding this? Any tips/tricks you can share?\r\n\r\nThe hard way, with tcpdump/wireshark, `--set proxy_debug=true` and putting `self.log()` all over the place in _server.py_. With tcpdump I noticed that when a page load stalled that I could still tap on links and that the browser then still sent data to the proxy after that transport has been closed (HTTP/2 does that) so it had to be the stream management at a low level. I also noticed that for the connection that stalled, the log entry `client disconnect` in `ConnectionHandler()` after `watch.cancel()` was missing for that connection. After narrowing down this far I started inserting `self.log()` until I found that the one after `drain()` sometimes was not logging.\r\n\r\nWhat also helped me on the way was to add this to my script:\r\n\r\n```\r\ndef error(flow: http.HTTPFlow):\r\n    if flow.error is not None:\r\n        ctx.log(\"FLOWERROR \" + str(flow.error))\r\n```\r\n\r\n>     3. It may be useful to just cancel any handler (not just the current one) if we cannot write. Could you verify that the following patch also works for you?\r\n> \r\n> \r\n> ```diff\r\n> --- a/mitmproxy/proxy/server.py\r\n> +++ b/mitmproxy/proxy/server.py\r\n> @@ -227,7 +227,11 @@ class ConnectionHandler(metaclass=abc.ABCMeta):\r\n>                  self.server_event(events.DataReceived(connection, data))\r\n>                  for transport in self.transports.values():\r\n>                      if transport.writer is not None:\r\n> -                        await transport.writer.drain()\r\n> +                        try:\r\n> +                            await transport.writer.drain()\r\n> +                        except OSError as e:\r\n> +                            if transport.handler is not None:\r\n> +                                asyncio_utils.cancel_task(transport.handler, f\"cannot drain writer: {e}\")\r\n> ```\r\n\r\nI just tried this variant a bit. It made it worse for pass-through connections (apple.com on my iPad). After the first or second click already the connection stalls consistently. I guess the approach is too aggressive.\r\n\r\nFor normal HTTP/2 connections it worked OK but I did get a _502 Bad Gateway_ when reading heise.de after a few pages. The `error()` in my script logged:\r\n\r\n```\r\nFLOWERROR HTTP/2 protocol error: Invalid input ConnectionInputs.RECV_HEADERS in state ConnectionState.CLOSED\r\n```\r\nI do not fully understand the code in _server.py_, for instance, why there is a need to drain all writers, not just the one from this connection. I am not strongly advocating my solution, so far it is just the most solid for me, even if I apparently missed the `CancelError`s. If you have more suggestions then I will try them out, this is dead easy for me to reproduce. Which still worries me, apparenly nobody else had this issue so far... :)\r\n","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/comments/1006863160/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"EndUser509","id":42170559,"node_id":"MDQ6VXNlcjQyMTcwNTU5","avatar_url":"https://avatars.githubusercontent.com/u/42170559?v=4","gravatar_id":"","url":"https://api.github.com/users/EndUser509","html_url":"https://github.com/EndUser509","followers_url":"https://api.github.com/users/EndUser509/followers","following_url":"https://api.github.com/users/EndUser509/following{/other_user}","gists_url":"https://api.github.com/users/EndUser509/gists{/gist_id}","starred_url":"https://api.github.com/users/EndUser509/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/EndUser509/subscriptions","organizations_url":"https://api.github.com/users/EndUser509/orgs","repos_url":"https://api.github.com/users/EndUser509/repos","events_url":"https://api.github.com/users/EndUser509/events{/privacy}","received_events_url":"https://api.github.com/users/EndUser509/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/comments/1006986649","html_url":"https://github.com/mitmproxy/mitmproxy/issues/5034#issuecomment-1006986649","issue_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5034","id":1006986649,"node_id":"IC_kwDOAAfumM48BWWZ","user":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-01-06T22:37:54Z","updated_at":"2022-01-06T22:37:54Z","body":"> Thanks for looking into this! Apart from this issue the new sansio design rocks! I can even scroll around in Google Maps and the CPU usage of the proxy machine remains in the one digit range. With V4 this was laggy with >100% load. Cool.\r\n\r\nExcellent. Very happy to hear that. ðŸ˜ƒ \r\n\r\n> I wonder what it takes to reproduce this on your side. I run mitmdump in transparent mode (easy for me to add and remove my machines), from the git repo directly on a CentOS 8 Stream on a laptop.\r\n\r\nThat's helpful, thanks. My main driver is a Windows machine in regular mode, so that's quite a different stack.\r\n\r\n> The hard way, with tcpdump/wireshark, `--set proxy_debug=true` and putting `self.log()` all over the place in _server.py_. With tcpdump I noticed that when a page load stalled that I could still tap on links and that the browser then still sent data to the proxy after that transport has been closed (HTTP/2 does that) so it had to be the stream management at a low level. I also noticed that for the connection that stalled, the log entry `client disconnect` in `ConnectionHandler()` after `watch.cancel()` was missing for that connection. After narrowing down this far I started inserting `self.log()` until I found that the one after `drain()` sometimes was not logging.\r\n\r\nVery impressive! I'm actually somewhat puzzled which part silently swallows the OSError here, I definitely need to figure out why exceptions are ignored and correct that. But let's focus on the initial issue here.\r\n\r\n> I just tried this variant a bit. It made it worse for pass-through connections (apple.com on my iPad). After the first or second click already the connection stalls consistently. I guess the approach is too aggressive.\r\n\r\nThis confused me for a bit, but I think I have a working theory now: When a coroutine/task is cancelled, it continues to run normally until the next `await` statement, which throws a `CancelledError`. What's may be happening here is that we first cancel our very own connection handler task we're currently in, and after that then `drain()` another transport. As we have already cancelled our own coroutine this `await drain()` immediately throws a `CancelledError`, which as you correctly pointed out both of us did not catch before! The problem just happens to be much more visible in my patch.\r\n\r\n> I do not fully understand the code in server.py, for instance, why there is a need to drain all writers\r\n\r\nWe do that to create backpressure. Assume you have a very fast connection to your laptop, a slower connection upstream, and you want to upload a large file. mitmproxy would very quickly read everything from your local device and then have an immense send buffer for the upstream connection. So while mitmproxy is slowly shoveling bits upstream, your client is done uploading for minutes already, hits a timeout, and aborts the connection[^1]. \r\nDraining the upstream connection aftere each read means we wait for space in the upstream send buffer to be available before we continue reading from the downstream socket again. In other words, while we drain the upstream send buffer, our own downstream receive buffer fills up and the OS' TCP implementation signals to downstream that they need to slow down. Does that make sense?\r\n\r\n> If you have more suggestions then I will try them out, this is dead easy for me to reproduce. Which still worries me, apparenly nobody else had this issue so far... :)\r\n\r\nHere's a revised patch that does catch the CancelledError. Could you test that and see how it works?\r\n\r\n```diff\r\n--- a/mitmproxy/proxy/server.py\r\n+++ b/mitmproxy/proxy/server.py\r\n@@ -223,11 +223,21 @@ class ConnectionHandler(metaclass=abc.ABCMeta):\r\n             except asyncio.CancelledError as e:\r\n                 cancelled = e\r\n                 break\r\n-            else:\r\n-                self.server_event(events.DataReceived(connection, data))\r\n-                for transport in self.transports.values():\r\n-                    if transport.writer is not None:\r\n+\r\n+            self.server_event(events.DataReceived(connection, data))\r\n+\r\n+            # Drain all writers to create some backpressure. We won't continue reading until there's space available in\r\n+            # our write buffers, so our own read buffers run full and the TCP recv stream is throttled.\r\n+            for transport in self.transports.values():\r\n+                if transport.writer is not None:\r\n+                    try:\r\n                         await transport.writer.drain()\r\n+                    except OSError as e:\r\n+                        if transport.handler is not None:\r\n+                            asyncio_utils.cancel_task(transport.handler, f\"Error sending data: {e}\")\r\n+                    except asyncio.CancelledError as e:\r\n+                        cancelled = e\r\n+                        break\r\n```\r\n\r\n[^1]: I'm assuming a streamed request body (or plain TCP) here. If mitmproxy is told not to stream this issue still exists.","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/comments/1006986649/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/comments/1007189026","html_url":"https://github.com/mitmproxy/mitmproxy/issues/5034#issuecomment-1007189026","issue_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5034","id":1007189026,"node_id":"IC_kwDOAAfumM48CHwi","user":{"login":"EndUser509","id":42170559,"node_id":"MDQ6VXNlcjQyMTcwNTU5","avatar_url":"https://avatars.githubusercontent.com/u/42170559?v=4","gravatar_id":"","url":"https://api.github.com/users/EndUser509","html_url":"https://github.com/EndUser509","followers_url":"https://api.github.com/users/EndUser509/followers","following_url":"https://api.github.com/users/EndUser509/following{/other_user}","gists_url":"https://api.github.com/users/EndUser509/gists{/gist_id}","starred_url":"https://api.github.com/users/EndUser509/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/EndUser509/subscriptions","organizations_url":"https://api.github.com/users/EndUser509/orgs","repos_url":"https://api.github.com/users/EndUser509/repos","events_url":"https://api.github.com/users/EndUser509/events{/privacy}","received_events_url":"https://api.github.com/users/EndUser509/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-01-07T07:11:10Z","updated_at":"2022-01-07T07:11:10Z","body":"I'll reply in full and run extensive tests in the evening. One question though on the new patch that you may be able to answer before that:\r\n\r\n> Here's a revised patch that does catch the CancelledError. Could you test that and see how it works?\r\n> \r\n> ```diff\r\n> --- a/mitmproxy/proxy/server.py\r\n> +++ b/mitmproxy/proxy/server.py\r\n> @@ -223,11 +223,21 @@ class ConnectionHandler(metaclass=abc.ABCMeta):\r\n>              except asyncio.CancelledError as e:\r\n>                  cancelled = e\r\n>                  break\r\n> -            else:\r\n> -                self.server_event(events.DataReceived(connection, data))\r\n> -                for transport in self.transports.values():\r\n> -                    if transport.writer is not None:\r\n> +\r\n> +            self.server_event(events.DataReceived(connection, data))\r\n> +\r\n> +            # Drain all writers to create some backpressure. We won't continue reading until there's space available in\r\n> +            # our write buffers, so our own read buffers run full and the TCP recv stream is throttled.\r\n> +            for transport in self.transports.values():\r\n> +                if transport.writer is not None:\r\n> +                    try:\r\n>                          await transport.writer.drain()\r\n> +                    except OSError as e:\r\n> +                        if transport.handler is not None:\r\n> +                            asyncio_utils.cancel_task(transport.handler, f\"Error sending data: {e}\")\r\n> +                    except asyncio.CancelledError as e:\r\n> +                        cancelled = e\r\n> +                        break\r\n> ```\r\n\r\nThat last break, it will only exit the inner loop which does not make sense to me. I would either ignore the exception and continue draining the rest of the writers as well or exit the outer loop with an 'else - continue - break' construct similar to what I used in my patch. Since you set cancelled I guess you want the later.\r\n","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/comments/1007189026/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"EndUser509","id":42170559,"node_id":"MDQ6VXNlcjQyMTcwNTU5","avatar_url":"https://avatars.githubusercontent.com/u/42170559?v=4","gravatar_id":"","url":"https://api.github.com/users/EndUser509","html_url":"https://github.com/EndUser509","followers_url":"https://api.github.com/users/EndUser509/followers","following_url":"https://api.github.com/users/EndUser509/following{/other_user}","gists_url":"https://api.github.com/users/EndUser509/gists{/gist_id}","starred_url":"https://api.github.com/users/EndUser509/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/EndUser509/subscriptions","organizations_url":"https://api.github.com/users/EndUser509/orgs","repos_url":"https://api.github.com/users/EndUser509/repos","events_url":"https://api.github.com/users/EndUser509/events{/privacy}","received_events_url":"https://api.github.com/users/EndUser509/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/comments/1007333496","html_url":"https://github.com/mitmproxy/mitmproxy/issues/5034#issuecomment-1007333496","issue_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5034","id":1007333496,"node_id":"IC_kwDOAAfumM48CrB4","user":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-01-07T11:23:38Z","updated_at":"2022-01-07T11:23:38Z","body":"Yes, good catch. Let's break out entirely. :)","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/comments/1007333496/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/comments/1007393754","html_url":"https://github.com/mitmproxy/mitmproxy/issues/5034#issuecomment-1007393754","issue_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5034","id":1007393754,"node_id":"IC_kwDOAAfumM48C5va","user":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-01-07T13:08:48Z","updated_at":"2022-01-07T13:08:48Z","body":"Here's a revised revised patch that should break out:\r\n```diff\r\ndiff --git a/mitmproxy/proxy/server.py b/mitmproxy/proxy/server.py\r\nindex 4b26b23c6..7af7f09d6 100644\r\n--- a/mitmproxy/proxy/server.py\r\n+++ b/mitmproxy/proxy/server.py\r\n@@ -223,11 +223,14 @@ class ConnectionHandler(metaclass=abc.ABCMeta):\r\n             except asyncio.CancelledError as e:\r\n                 cancelled = e\r\n                 break\r\n-            else:\r\n-                self.server_event(events.DataReceived(connection, data))\r\n-                for transport in self.transports.values():\r\n-                    if transport.writer is not None:\r\n-                        await transport.writer.drain()\r\n+\r\n+            self.server_event(events.DataReceived(connection, data))\r\n+\r\n+            try:\r\n+                await self.drain_writers()\r\n+            except asyncio.CancelledError as e:\r\n+                cancelled = e\r\n+                break\r\n\r\n         if cancelled is None:\r\n             connection.state &= ~ConnectionState.CAN_READ\r\n@@ -253,6 +256,19 @@ class ConnectionHandler(metaclass=abc.ABCMeta):\r\n         if cancelled:\r\n             raise cancelled\r\n\r\n+    async def drain_writers(self):\r\n+        \"\"\"\r\n+        Drain all writers to create some backpressure. We won't continue reading until there's space available in our\r\n+        write buffers, so if we cannot write fast enough our own read buffers run full and the TCP recv stream is throttled.\r\n+        \"\"\"\r\n+        for transport in self.transports.values():\r\n+            if transport.writer is not None:\r\n+                try:\r\n+                    await transport.writer.drain()\r\n+                except OSError as e:\r\n+                    if transport.handler is not None:\r\n+                        asyncio_utils.cancel_task(transport.handler, f\"Error sending data: {e}\")\r\n+\r\n     async def on_timeout(self) -> None:\r\n         self.log(f\"Closing connection due to inactivity: {self.client}\")\r\n         handler = self.transports[self.client].handler\r\n```","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/comments/1007393754/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/comments/1007692253","html_url":"https://github.com/mitmproxy/mitmproxy/issues/5034#issuecomment-1007692253","issue_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5034","id":1007692253,"node_id":"IC_kwDOAAfumM48ECnd","user":{"login":"EndUser509","id":42170559,"node_id":"MDQ6VXNlcjQyMTcwNTU5","avatar_url":"https://avatars.githubusercontent.com/u/42170559?v=4","gravatar_id":"","url":"https://api.github.com/users/EndUser509","html_url":"https://github.com/EndUser509","followers_url":"https://api.github.com/users/EndUser509/followers","following_url":"https://api.github.com/users/EndUser509/following{/other_user}","gists_url":"https://api.github.com/users/EndUser509/gists{/gist_id}","starred_url":"https://api.github.com/users/EndUser509/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/EndUser509/subscriptions","organizations_url":"https://api.github.com/users/EndUser509/orgs","repos_url":"https://api.github.com/users/EndUser509/repos","events_url":"https://api.github.com/users/EndUser509/events{/privacy}","received_events_url":"https://api.github.com/users/EndUser509/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-01-07T19:51:29Z","updated_at":"2022-01-07T19:51:29Z","body":"> Here's a revised revised patch that should break out:\r\n> \r\n> ```diff\r\n> diff --git a/mitmproxy/proxy/server.py b/mitmproxy/proxy/server.py\r\n> index 4b26b23c6..7af7f09d6 100644\r\n> --- a/mitmproxy/proxy/server.py\r\n> +++ b/mitmproxy/proxy/server.py\r\n> @@ -223,11 +223,14 @@ class ConnectionHandler(metaclass=abc.ABCMeta):\r\n>              except asyncio.CancelledError as e:\r\n>                  cancelled = e\r\n>                  break\r\n> -            else:\r\n> -                self.server_event(events.DataReceived(connection, data))\r\n> -                for transport in self.transports.values():\r\n> -                    if transport.writer is not None:\r\n> -                        await transport.writer.drain()\r\n> +\r\n> +            self.server_event(events.DataReceived(connection, data))\r\n> +\r\n> +            try:\r\n> +                await self.drain_writers()\r\n> +            except asyncio.CancelledError as e:\r\n> +                cancelled = e\r\n> +                break\r\n> \r\n>          if cancelled is None:\r\n>              connection.state &= ~ConnectionState.CAN_READ\r\n> @@ -253,6 +256,19 @@ class ConnectionHandler(metaclass=abc.ABCMeta):\r\n>          if cancelled:\r\n>              raise cancelled\r\n> \r\n> +    async def drain_writers(self):\r\n> +        \"\"\"\r\n> +        Drain all writers to create some backpressure. We won't continue reading until there's space available in our\r\n> +        write buffers, so if we cannot write fast enough our own read buffers run full and the TCP recv stream is throttled.\r\n> +        \"\"\"\r\n> +        for transport in self.transports.values():\r\n> +            if transport.writer is not None:\r\n> +                try:\r\n> +                    await transport.writer.drain()\r\n> +                except OSError as e:\r\n> +                    if transport.handler is not None:\r\n> +                        asyncio_utils.cancel_task(transport.handler, f\"Error sending data: {e}\")\r\n> +\r\n>      async def on_timeout(self) -> None:\r\n>          self.log(f\"Closing connection due to inactivity: {self.client}\")\r\n>          handler = self.transports[self.client].handler\r\n> ```\r\n\r\nI have applied this patch and tried various websites, Youtube, Google Maps, etc. and there was not a single delayed load or missing image during my hours of surfing. In the logs I did not see any suspicious server-side errors. So I think the above fix works great.\r\n\r\nThanks for the solution! I keep the patch in my checkout until it is also committed to the main branch. But this issue can be closed I think.","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/comments/1007692253/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"EndUser509","id":42170559,"node_id":"MDQ6VXNlcjQyMTcwNTU5","avatar_url":"https://avatars.githubusercontent.com/u/42170559?v=4","gravatar_id":"","url":"https://api.github.com/users/EndUser509","html_url":"https://github.com/EndUser509","followers_url":"https://api.github.com/users/EndUser509/followers","following_url":"https://api.github.com/users/EndUser509/following{/other_user}","gists_url":"https://api.github.com/users/EndUser509/gists{/gist_id}","starred_url":"https://api.github.com/users/EndUser509/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/EndUser509/subscriptions","organizations_url":"https://api.github.com/users/EndUser509/orgs","repos_url":"https://api.github.com/users/EndUser509/repos","events_url":"https://api.github.com/users/EndUser509/events{/privacy}","received_events_url":"https://api.github.com/users/EndUser509/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":5860185719,"node_id":"REFE_lADOAAfumM5BPzlpzwAAAAFdS1Z3","url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/events/5860185719","actor":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"a9d10de6a99b7fb35971c340a2b16985b7dc5262","commit_url":"https://api.github.com/repos/mhils/mitmproxy/commits/a9d10de6a99b7fb35971c340a2b16985b7dc5262","created_at":"2022-01-07T22:05:01Z","performed_via_github_app":null},{"actor":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-01-07T22:05:52Z","updated_at":"2022-01-07T22:05:52Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5040","repository_url":"https://api.github.com/repos/mitmproxy/mitmproxy","labels_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5040/labels{/name}","comments_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5040/comments","events_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5040/events","html_url":"https://github.com/mitmproxy/mitmproxy/pull/5040","id":1096703371,"node_id":"PR_kwDOAAfumM4wrbyP","number":5040,"title":"Catch cancellation errors when draining writers, fix #5034","user":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-01-07T22:05:52Z","updated_at":"2022-01-08T07:07:02Z","closed_at":"2022-01-08T07:06:59Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"draft":false,"repository":{"id":519832,"node_id":"MDEwOlJlcG9zaXRvcnk1MTk4MzI=","name":"mitmproxy","full_name":"mitmproxy/mitmproxy","private":false,"owner":{"login":"mitmproxy","id":4652787,"node_id":"MDEyOk9yZ2FuaXphdGlvbjQ2NTI3ODc=","avatar_url":"https://avatars.githubusercontent.com/u/4652787?v=4","gravatar_id":"","url":"https://api.github.com/users/mitmproxy","html_url":"https://github.com/mitmproxy","followers_url":"https://api.github.com/users/mitmproxy/followers","following_url":"https://api.github.com/users/mitmproxy/following{/other_user}","gists_url":"https://api.github.com/users/mitmproxy/gists{/gist_id}","starred_url":"https://api.github.com/users/mitmproxy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mitmproxy/subscriptions","organizations_url":"https://api.github.com/users/mitmproxy/orgs","repos_url":"https://api.github.com/users/mitmproxy/repos","events_url":"https://api.github.com/users/mitmproxy/events{/privacy}","received_events_url":"https://api.github.com/users/mitmproxy/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/mitmproxy/mitmproxy","description":"An interactive TLS-capable intercepting HTTP proxy for penetration testers and software developers.","fork":false,"url":"https://api.github.com/repos/mitmproxy/mitmproxy","forks_url":"https://api.github.com/repos/mitmproxy/mitmproxy/forks","keys_url":"https://api.github.com/repos/mitmproxy/mitmproxy/keys{/key_id}","collaborators_url":"https://api.github.com/repos/mitmproxy/mitmproxy/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/mitmproxy/mitmproxy/teams","hooks_url":"https://api.github.com/repos/mitmproxy/mitmproxy/hooks","issue_events_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/events{/number}","events_url":"https://api.github.com/repos/mitmproxy/mitmproxy/events","assignees_url":"https://api.github.com/repos/mitmproxy/mitmproxy/assignees{/user}","branches_url":"https://api.github.com/repos/mitmproxy/mitmproxy/branches{/branch}","tags_url":"https://api.github.com/repos/mitmproxy/mitmproxy/tags","blobs_url":"https://api.github.com/repos/mitmproxy/mitmproxy/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/mitmproxy/mitmproxy/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/mitmproxy/mitmproxy/git/refs{/sha}","trees_url":"https://api.github.com/repos/mitmproxy/mitmproxy/git/trees{/sha}","statuses_url":"https://api.github.com/repos/mitmproxy/mitmproxy/statuses/{sha}","languages_url":"https://api.github.com/repos/mitmproxy/mitmproxy/languages","stargazers_url":"https://api.github.com/repos/mitmproxy/mitmproxy/stargazers","contributors_url":"https://api.github.com/repos/mitmproxy/mitmproxy/contributors","subscribers_url":"https://api.github.com/repos/mitmproxy/mitmproxy/subscribers","subscription_url":"https://api.github.com/repos/mitmproxy/mitmproxy/subscription","commits_url":"https://api.github.com/repos/mitmproxy/mitmproxy/commits{/sha}","git_commits_url":"https://api.github.com/repos/mitmproxy/mitmproxy/git/commits{/sha}","comments_url":"https://api.github.com/repos/mitmproxy/mitmproxy/comments{/number}","issue_comment_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/comments{/number}","contents_url":"https://api.github.com/repos/mitmproxy/mitmproxy/contents/{+path}","compare_url":"https://api.github.com/repos/mitmproxy/mitmproxy/compare/{base}...{head}","merges_url":"https://api.github.com/repos/mitmproxy/mitmproxy/merges","archive_url":"https://api.github.com/repos/mitmproxy/mitmproxy/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/mitmproxy/mitmproxy/downloads","issues_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues{/number}","pulls_url":"https://api.github.com/repos/mitmproxy/mitmproxy/pulls{/number}","milestones_url":"https://api.github.com/repos/mitmproxy/mitmproxy/milestones{/number}","notifications_url":"https://api.github.com/repos/mitmproxy/mitmproxy/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels{/name}","releases_url":"https://api.github.com/repos/mitmproxy/mitmproxy/releases{/id}","deployments_url":"https://api.github.com/repos/mitmproxy/mitmproxy/deployments","created_at":"2010-02-16T04:10:13Z","updated_at":"2025-11-09T17:55:49Z","pushed_at":"2025-11-09T14:36:54Z","git_url":"git://github.com/mitmproxy/mitmproxy.git","ssh_url":"git@github.com:mitmproxy/mitmproxy.git","clone_url":"https://github.com/mitmproxy/mitmproxy.git","svn_url":"https://github.com/mitmproxy/mitmproxy","homepage":"https://mitmproxy.org","size":67124,"stargazers_count":41160,"watchers_count":41160,"language":"Python","has_issues":true,"has_projects":false,"has_downloads":true,"has_wiki":false,"has_pages":false,"has_discussions":true,"forks_count":4359,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":387,"license":{"key":"mit","name":"MIT License","spdx_id":"MIT","url":"https://api.github.com/licenses/mit","node_id":"MDc6TGljZW5zZTEz"},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["debugging","http","http2","man-in-the-middle","mitmproxy","proxy","python","security","ssl","tls","websocket"],"visibility":"public","forks":4359,"open_issues":387,"watchers":41160,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"pull_request":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/pulls/5040","html_url":"https://github.com/mitmproxy/mitmproxy/pull/5040","diff_url":"https://github.com/mitmproxy/mitmproxy/pull/5040.diff","patch_url":"https://github.com/mitmproxy/mitmproxy/pull/5040.patch","merged_at":"2022-01-08T07:06:59Z"},"body":"This PR takes the patch from #5034 into main. Thanks again, @EndUser509! ðŸ˜ƒ:cake: ","reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5040/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5040/timeline","performed_via_github_app":null,"state_reason":null}},"event":"cross-referenced"},{"id":5860938338,"node_id":"CE_lADOAAfumM5BPzlpzwAAAAFdVtJi","url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/events/5860938338","actor":{"login":"mhils","id":1019198,"node_id":"MDQ6VXNlcjEwMTkxOTg=","avatar_url":"https://avatars.githubusercontent.com/u/1019198?v=4","gravatar_id":"","url":"https://api.github.com/users/mhils","html_url":"https://github.com/mhils","followers_url":"https://api.github.com/users/mhils/followers","following_url":"https://api.github.com/users/mhils/following{/other_user}","gists_url":"https://api.github.com/users/mhils/gists{/gist_id}","starred_url":"https://api.github.com/users/mhils/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhils/subscriptions","organizations_url":"https://api.github.com/users/mhils/orgs","repos_url":"https://api.github.com/users/mhils/repos","events_url":"https://api.github.com/users/mhils/events{/privacy}","received_events_url":"https://api.github.com/users/mhils/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"closed","commit_id":"000e26674e39a04c23fcc717d50c9fa475330796","commit_url":"https://api.github.com/repos/mitmproxy/mitmproxy/commits/000e26674e39a04c23fcc717d50c9fa475330796","created_at":"2022-01-08T07:07:05Z","state_reason":null,"performed_via_github_app":null},{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/comments/1007917783","html_url":"https://github.com/mitmproxy/mitmproxy/issues/5034#issuecomment-1007917783","issue_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5034","id":1007917783,"node_id":"IC_kwDOAAfumM48E5rX","user":{"login":"Prinzhorn","id":679144,"node_id":"MDQ6VXNlcjY3OTE0NA==","avatar_url":"https://avatars.githubusercontent.com/u/679144?v=4","gravatar_id":"","url":"https://api.github.com/users/Prinzhorn","html_url":"https://github.com/Prinzhorn","followers_url":"https://api.github.com/users/Prinzhorn/followers","following_url":"https://api.github.com/users/Prinzhorn/following{/other_user}","gists_url":"https://api.github.com/users/Prinzhorn/gists{/gist_id}","starred_url":"https://api.github.com/users/Prinzhorn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Prinzhorn/subscriptions","organizations_url":"https://api.github.com/users/Prinzhorn/orgs","repos_url":"https://api.github.com/users/Prinzhorn/repos","events_url":"https://api.github.com/users/Prinzhorn/events{/privacy}","received_events_url":"https://api.github.com/users/Prinzhorn/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-01-08T08:50:10Z","updated_at":"2022-01-08T08:50:10Z","body":"@EndUser509 thank you for this excellent detective work :monocle_face:  ! Is there a PayPal or something I can send a coffee to? I want to pavlov high quality contributions :smile: ","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/comments/1007917783/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":1,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"Prinzhorn","id":679144,"node_id":"MDQ6VXNlcjY3OTE0NA==","avatar_url":"https://avatars.githubusercontent.com/u/679144?v=4","gravatar_id":"","url":"https://api.github.com/users/Prinzhorn","html_url":"https://github.com/Prinzhorn","followers_url":"https://api.github.com/users/Prinzhorn/followers","following_url":"https://api.github.com/users/Prinzhorn/following{/other_user}","gists_url":"https://api.github.com/users/Prinzhorn/gists{/gist_id}","starred_url":"https://api.github.com/users/Prinzhorn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Prinzhorn/subscriptions","organizations_url":"https://api.github.com/users/Prinzhorn/orgs","repos_url":"https://api.github.com/users/Prinzhorn/repos","events_url":"https://api.github.com/users/Prinzhorn/events{/privacy}","received_events_url":"https://api.github.com/users/Prinzhorn/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":5861008799,"node_id":"MEE_lADOAAfumM5BPzlpzwAAAAFdV-Wf","url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/events/5861008799","actor":{"login":"EndUser509","id":42170559,"node_id":"MDQ6VXNlcjQyMTcwNTU5","avatar_url":"https://avatars.githubusercontent.com/u/42170559?v=4","gravatar_id":"","url":"https://api.github.com/users/EndUser509","html_url":"https://github.com/EndUser509","followers_url":"https://api.github.com/users/EndUser509/followers","following_url":"https://api.github.com/users/EndUser509/following{/other_user}","gists_url":"https://api.github.com/users/EndUser509/gists{/gist_id}","starred_url":"https://api.github.com/users/EndUser509/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/EndUser509/subscriptions","organizations_url":"https://api.github.com/users/EndUser509/orgs","repos_url":"https://api.github.com/users/EndUser509/repos","events_url":"https://api.github.com/users/EndUser509/events{/privacy}","received_events_url":"https://api.github.com/users/EndUser509/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2022-01-08T08:50:11Z","performed_via_github_app":null},{"id":5861008800,"node_id":"SE_lADOAAfumM5BPzlpzwAAAAFdV-Wg","url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/events/5861008800","actor":{"login":"EndUser509","id":42170559,"node_id":"MDQ6VXNlcjQyMTcwNTU5","avatar_url":"https://avatars.githubusercontent.com/u/42170559?v=4","gravatar_id":"","url":"https://api.github.com/users/EndUser509","html_url":"https://github.com/EndUser509","followers_url":"https://api.github.com/users/EndUser509/followers","following_url":"https://api.github.com/users/EndUser509/following{/other_user}","gists_url":"https://api.github.com/users/EndUser509/gists{/gist_id}","starred_url":"https://api.github.com/users/EndUser509/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/EndUser509/subscriptions","organizations_url":"https://api.github.com/users/EndUser509/orgs","repos_url":"https://api.github.com/users/EndUser509/repos","events_url":"https://api.github.com/users/EndUser509/events{/privacy}","received_events_url":"https://api.github.com/users/EndUser509/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2022-01-08T08:50:11Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/comments/1008307629","html_url":"https://github.com/mitmproxy/mitmproxy/issues/5034#issuecomment-1008307629","issue_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5034","id":1008307629,"node_id":"IC_kwDOAAfumM48GY2t","user":{"login":"EndUser509","id":42170559,"node_id":"MDQ6VXNlcjQyMTcwNTU5","avatar_url":"https://avatars.githubusercontent.com/u/42170559?v=4","gravatar_id":"","url":"https://api.github.com/users/EndUser509","html_url":"https://github.com/EndUser509","followers_url":"https://api.github.com/users/EndUser509/followers","following_url":"https://api.github.com/users/EndUser509/following{/other_user}","gists_url":"https://api.github.com/users/EndUser509/gists{/gist_id}","starred_url":"https://api.github.com/users/EndUser509/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/EndUser509/subscriptions","organizations_url":"https://api.github.com/users/EndUser509/orgs","repos_url":"https://api.github.com/users/EndUser509/repos","events_url":"https://api.github.com/users/EndUser509/events{/privacy}","received_events_url":"https://api.github.com/users/EndUser509/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-01-09T14:25:30Z","updated_at":"2022-01-09T14:25:30Z","body":"> @EndUser509 thank you for this excellent detective work monocle_face ! Is there a PayPal or something I can send a coffee to? I want to pavlov high quality contributions smile\r\n\r\nThanks, but it should be the other way round. I am really thankful that this project exists. Helping to fix an issue that I notice is the least I can do. :)","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/comments/1008307629/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":1,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"EndUser509","id":42170559,"node_id":"MDQ6VXNlcjQyMTcwNTU5","avatar_url":"https://avatars.githubusercontent.com/u/42170559?v=4","gravatar_id":"","url":"https://api.github.com/users/EndUser509","html_url":"https://github.com/EndUser509","followers_url":"https://api.github.com/users/EndUser509/followers","following_url":"https://api.github.com/users/EndUser509/following{/other_user}","gists_url":"https://api.github.com/users/EndUser509/gists{/gist_id}","starred_url":"https://api.github.com/users/EndUser509/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/EndUser509/subscriptions","organizations_url":"https://api.github.com/users/EndUser509/orgs","repos_url":"https://api.github.com/users/EndUser509/repos","events_url":"https://api.github.com/users/EndUser509/events{/privacy}","received_events_url":"https://api.github.com/users/EndUser509/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":5862370890,"node_id":"MEE_lADOAAfumM5BPzlpzwAAAAFdbK5K","url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/events/5862370890","actor":{"login":"EndUser509","id":42170559,"node_id":"MDQ6VXNlcjQyMTcwNTU5","avatar_url":"https://avatars.githubusercontent.com/u/42170559?v=4","gravatar_id":"","url":"https://api.github.com/users/EndUser509","html_url":"https://github.com/EndUser509","followers_url":"https://api.github.com/users/EndUser509/followers","following_url":"https://api.github.com/users/EndUser509/following{/other_user}","gists_url":"https://api.github.com/users/EndUser509/gists{/gist_id}","starred_url":"https://api.github.com/users/EndUser509/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/EndUser509/subscriptions","organizations_url":"https://api.github.com/users/EndUser509/orgs","repos_url":"https://api.github.com/users/EndUser509/repos","events_url":"https://api.github.com/users/EndUser509/events{/privacy}","received_events_url":"https://api.github.com/users/EndUser509/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2022-01-09T14:25:30Z","performed_via_github_app":null},{"id":5862370892,"node_id":"SE_lADOAAfumM5BPzlpzwAAAAFdbK5M","url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/events/5862370892","actor":{"login":"EndUser509","id":42170559,"node_id":"MDQ6VXNlcjQyMTcwNTU5","avatar_url":"https://avatars.githubusercontent.com/u/42170559?v=4","gravatar_id":"","url":"https://api.github.com/users/EndUser509","html_url":"https://github.com/EndUser509","followers_url":"https://api.github.com/users/EndUser509/followers","following_url":"https://api.github.com/users/EndUser509/following{/other_user}","gists_url":"https://api.github.com/users/EndUser509/gists{/gist_id}","starred_url":"https://api.github.com/users/EndUser509/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/EndUser509/subscriptions","organizations_url":"https://api.github.com/users/EndUser509/orgs","repos_url":"https://api.github.com/users/EndUser509/repos","events_url":"https://api.github.com/users/EndUser509/events{/privacy}","received_events_url":"https://api.github.com/users/EndUser509/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2022-01-09T14:25:30Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/comments/1047746229","html_url":"https://github.com/mitmproxy/mitmproxy/issues/5034#issuecomment-1047746229","issue_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5034","id":1047746229,"node_id":"IC_kwDOAAfumM4-c1a1","user":{"login":"Prinzhorn","id":679144,"node_id":"MDQ6VXNlcjY3OTE0NA==","avatar_url":"https://avatars.githubusercontent.com/u/679144?v=4","gravatar_id":"","url":"https://api.github.com/users/Prinzhorn","html_url":"https://github.com/Prinzhorn","followers_url":"https://api.github.com/users/Prinzhorn/followers","following_url":"https://api.github.com/users/Prinzhorn/following{/other_user}","gists_url":"https://api.github.com/users/Prinzhorn/gists{/gist_id}","starred_url":"https://api.github.com/users/Prinzhorn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Prinzhorn/subscriptions","organizations_url":"https://api.github.com/users/Prinzhorn/orgs","repos_url":"https://api.github.com/users/Prinzhorn/repos","events_url":"https://api.github.com/users/Prinzhorn/events{/privacy}","received_events_url":"https://api.github.com/users/Prinzhorn/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-02-22T12:27:23Z","updated_at":"2022-02-22T12:27:23Z","body":"@EndUser509 could you send me an e-mail to the address in my profile?","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/comments/1047746229/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"Prinzhorn","id":679144,"node_id":"MDQ6VXNlcjY3OTE0NA==","avatar_url":"https://avatars.githubusercontent.com/u/679144?v=4","gravatar_id":"","url":"https://api.github.com/users/Prinzhorn","html_url":"https://github.com/Prinzhorn","followers_url":"https://api.github.com/users/Prinzhorn/followers","following_url":"https://api.github.com/users/Prinzhorn/following{/other_user}","gists_url":"https://api.github.com/users/Prinzhorn/gists{/gist_id}","starred_url":"https://api.github.com/users/Prinzhorn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Prinzhorn/subscriptions","organizations_url":"https://api.github.com/users/Prinzhorn/orgs","repos_url":"https://api.github.com/users/Prinzhorn/repos","events_url":"https://api.github.com/users/Prinzhorn/events{/privacy}","received_events_url":"https://api.github.com/users/Prinzhorn/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":6117677459,"node_id":"MEE_lADOAAfumM5BPzlpzwAAAAFspFmT","url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/events/6117677459","actor":{"login":"EndUser509","id":42170559,"node_id":"MDQ6VXNlcjQyMTcwNTU5","avatar_url":"https://avatars.githubusercontent.com/u/42170559?v=4","gravatar_id":"","url":"https://api.github.com/users/EndUser509","html_url":"https://github.com/EndUser509","followers_url":"https://api.github.com/users/EndUser509/followers","following_url":"https://api.github.com/users/EndUser509/following{/other_user}","gists_url":"https://api.github.com/users/EndUser509/gists{/gist_id}","starred_url":"https://api.github.com/users/EndUser509/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/EndUser509/subscriptions","organizations_url":"https://api.github.com/users/EndUser509/orgs","repos_url":"https://api.github.com/users/EndUser509/repos","events_url":"https://api.github.com/users/EndUser509/events{/privacy}","received_events_url":"https://api.github.com/users/EndUser509/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2022-02-22T12:27:23Z","performed_via_github_app":null},{"id":6117677468,"node_id":"SE_lADOAAfumM5BPzlpzwAAAAFspFmc","url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/events/6117677468","actor":{"login":"EndUser509","id":42170559,"node_id":"MDQ6VXNlcjQyMTcwNTU5","avatar_url":"https://avatars.githubusercontent.com/u/42170559?v=4","gravatar_id":"","url":"https://api.github.com/users/EndUser509","html_url":"https://github.com/EndUser509","followers_url":"https://api.github.com/users/EndUser509/followers","following_url":"https://api.github.com/users/EndUser509/following{/other_user}","gists_url":"https://api.github.com/users/EndUser509/gists{/gist_id}","starred_url":"https://api.github.com/users/EndUser509/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/EndUser509/subscriptions","organizations_url":"https://api.github.com/users/EndUser509/orgs","repos_url":"https://api.github.com/users/EndUser509/repos","events_url":"https://api.github.com/users/EndUser509/events{/privacy}","received_events_url":"https://api.github.com/users/EndUser509/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2022-02-22T12:27:23Z","performed_via_github_app":null},{"actor":{"login":"EndUser509","id":42170559,"node_id":"MDQ6VXNlcjQyMTcwNTU5","avatar_url":"https://avatars.githubusercontent.com/u/42170559?v=4","gravatar_id":"","url":"https://api.github.com/users/EndUser509","html_url":"https://github.com/EndUser509","followers_url":"https://api.github.com/users/EndUser509/followers","following_url":"https://api.github.com/users/EndUser509/following{/other_user}","gists_url":"https://api.github.com/users/EndUser509/gists{/gist_id}","starred_url":"https://api.github.com/users/EndUser509/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/EndUser509/subscriptions","organizations_url":"https://api.github.com/users/EndUser509/orgs","repos_url":"https://api.github.com/users/EndUser509/repos","events_url":"https://api.github.com/users/EndUser509/events{/privacy}","received_events_url":"https://api.github.com/users/EndUser509/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-02-26T20:23:04Z","updated_at":"2022-02-26T20:23:04Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5158","repository_url":"https://api.github.com/repos/mitmproxy/mitmproxy","labels_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5158/labels{/name}","comments_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5158/comments","events_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5158/events","html_url":"https://github.com/mitmproxy/mitmproxy/issues/5158","id":1152249490,"node_id":"I_kwDOAAfumM5Ere6S","number":5158,"title":"HTTP/2 page elements not loading in rare cases","user":{"login":"EndUser509","id":42170559,"node_id":"MDQ6VXNlcjQyMTcwNTU5","avatar_url":"https://avatars.githubusercontent.com/u/42170559?v=4","gravatar_id":"","url":"https://api.github.com/users/EndUser509","html_url":"https://github.com/EndUser509","followers_url":"https://api.github.com/users/EndUser509/followers","following_url":"https://api.github.com/users/EndUser509/following{/other_user}","gists_url":"https://api.github.com/users/EndUser509/gists{/gist_id}","starred_url":"https://api.github.com/users/EndUser509/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/EndUser509/subscriptions","organizations_url":"https://api.github.com/users/EndUser509/orgs","repos_url":"https://api.github.com/users/EndUser509/repos","events_url":"https://api.github.com/users/EndUser509/events{/privacy}","received_events_url":"https://api.github.com/users/EndUser509/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":466930397,"node_id":"MDU6TGFiZWw0NjY5MzAzOTc=","url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels/kind/triage","name":"kind/triage","color":"006b75","default":false,"description":"Unclassified issues"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-02-26T20:23:04Z","updated_at":"2022-03-16T07:30:39Z","closed_at":"2022-03-16T07:30:39Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":519832,"node_id":"MDEwOlJlcG9zaXRvcnk1MTk4MzI=","name":"mitmproxy","full_name":"mitmproxy/mitmproxy","private":false,"owner":{"login":"mitmproxy","id":4652787,"node_id":"MDEyOk9yZ2FuaXphdGlvbjQ2NTI3ODc=","avatar_url":"https://avatars.githubusercontent.com/u/4652787?v=4","gravatar_id":"","url":"https://api.github.com/users/mitmproxy","html_url":"https://github.com/mitmproxy","followers_url":"https://api.github.com/users/mitmproxy/followers","following_url":"https://api.github.com/users/mitmproxy/following{/other_user}","gists_url":"https://api.github.com/users/mitmproxy/gists{/gist_id}","starred_url":"https://api.github.com/users/mitmproxy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mitmproxy/subscriptions","organizations_url":"https://api.github.com/users/mitmproxy/orgs","repos_url":"https://api.github.com/users/mitmproxy/repos","events_url":"https://api.github.com/users/mitmproxy/events{/privacy}","received_events_url":"https://api.github.com/users/mitmproxy/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/mitmproxy/mitmproxy","description":"An interactive TLS-capable intercepting HTTP proxy for penetration testers and software developers.","fork":false,"url":"https://api.github.com/repos/mitmproxy/mitmproxy","forks_url":"https://api.github.com/repos/mitmproxy/mitmproxy/forks","keys_url":"https://api.github.com/repos/mitmproxy/mitmproxy/keys{/key_id}","collaborators_url":"https://api.github.com/repos/mitmproxy/mitmproxy/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/mitmproxy/mitmproxy/teams","hooks_url":"https://api.github.com/repos/mitmproxy/mitmproxy/hooks","issue_events_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/events{/number}","events_url":"https://api.github.com/repos/mitmproxy/mitmproxy/events","assignees_url":"https://api.github.com/repos/mitmproxy/mitmproxy/assignees{/user}","branches_url":"https://api.github.com/repos/mitmproxy/mitmproxy/branches{/branch}","tags_url":"https://api.github.com/repos/mitmproxy/mitmproxy/tags","blobs_url":"https://api.github.com/repos/mitmproxy/mitmproxy/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/mitmproxy/mitmproxy/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/mitmproxy/mitmproxy/git/refs{/sha}","trees_url":"https://api.github.com/repos/mitmproxy/mitmproxy/git/trees{/sha}","statuses_url":"https://api.github.com/repos/mitmproxy/mitmproxy/statuses/{sha}","languages_url":"https://api.github.com/repos/mitmproxy/mitmproxy/languages","stargazers_url":"https://api.github.com/repos/mitmproxy/mitmproxy/stargazers","contributors_url":"https://api.github.com/repos/mitmproxy/mitmproxy/contributors","subscribers_url":"https://api.github.com/repos/mitmproxy/mitmproxy/subscribers","subscription_url":"https://api.github.com/repos/mitmproxy/mitmproxy/subscription","commits_url":"https://api.github.com/repos/mitmproxy/mitmproxy/commits{/sha}","git_commits_url":"https://api.github.com/repos/mitmproxy/mitmproxy/git/commits{/sha}","comments_url":"https://api.github.com/repos/mitmproxy/mitmproxy/comments{/number}","issue_comment_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/comments{/number}","contents_url":"https://api.github.com/repos/mitmproxy/mitmproxy/contents/{+path}","compare_url":"https://api.github.com/repos/mitmproxy/mitmproxy/compare/{base}...{head}","merges_url":"https://api.github.com/repos/mitmproxy/mitmproxy/merges","archive_url":"https://api.github.com/repos/mitmproxy/mitmproxy/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/mitmproxy/mitmproxy/downloads","issues_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues{/number}","pulls_url":"https://api.github.com/repos/mitmproxy/mitmproxy/pulls{/number}","milestones_url":"https://api.github.com/repos/mitmproxy/mitmproxy/milestones{/number}","notifications_url":"https://api.github.com/repos/mitmproxy/mitmproxy/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/mitmproxy/mitmproxy/labels{/name}","releases_url":"https://api.github.com/repos/mitmproxy/mitmproxy/releases{/id}","deployments_url":"https://api.github.com/repos/mitmproxy/mitmproxy/deployments","created_at":"2010-02-16T04:10:13Z","updated_at":"2025-11-09T17:55:49Z","pushed_at":"2025-11-09T14:36:54Z","git_url":"git://github.com/mitmproxy/mitmproxy.git","ssh_url":"git@github.com:mitmproxy/mitmproxy.git","clone_url":"https://github.com/mitmproxy/mitmproxy.git","svn_url":"https://github.com/mitmproxy/mitmproxy","homepage":"https://mitmproxy.org","size":67124,"stargazers_count":41160,"watchers_count":41160,"language":"Python","has_issues":true,"has_projects":false,"has_downloads":true,"has_wiki":false,"has_pages":false,"has_discussions":true,"forks_count":4359,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":387,"license":{"key":"mit","name":"MIT License","spdx_id":"MIT","url":"https://api.github.com/licenses/mit","node_id":"MDc6TGljZW5zZTEz"},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["debugging","http","http2","man-in-the-middle","mitmproxy","proxy","python","security","ssl","tls","websocket"],"visibility":"public","forks":4359,"open_issues":387,"watchers":41160,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"#### Problem Description\r\nI sometimes notice that web pages loaded with HTTP/2 in my browser sometimes stop loading images. I am trying to narrow this issue down. My first suspicion is the code in server.py as in #5034 we already noticed that exceptions are silently ignored in certain tasks.\r\n\r\nI wrapped all tasks in try-except to see if there are any exceptions that cause tasks to die that was not expected. I found this:\r\n\r\n```\r\n[2022-02-26 20:56:41] 192.168.2.63:60214: Traceback (most recent call last):\r\n[2022-02-26 20:56:41]   File \"/home/enduser/mitmproxy/mitmproxy/proxy/server.py\", line 266, in handle_connection\r\n[2022-02-26 20:56:41]     await self.drain_writers()\r\n[2022-02-26 20:56:41]   File \"/home/enduser/mitmproxy/mitmproxy/proxy/server.py\", line 308, in drain_writers\r\n[2022-02-26 20:56:41]     await transport.writer.drain()\r\n[2022-02-26 20:56:41]   File \"/usr/lib64/python3.9/asyncio/streams.py\", line 387, in drain\r\n[2022-02-26 20:56:41]     await self._protocol._drain_helper()\r\n[2022-02-26 20:56:41]   File \"/usr/lib64/python3.9/asyncio/streams.py\", line 194, in _drain_helper\r\n[2022-02-26 20:56:41]     assert waiter is None or waiter.cancelled()\r\n[2022-02-26 20:56:41] AssertionError\r\n```\r\n\r\nThis assertion comes from within the `asyncio` code. Any idea what test could be done in `drain_writers` for each writer in order to not trigger the assertion? I am now running a modified version of `drain_writers` that looks like this:\r\n\r\n```\r\n        for transport in self.transports.values():\r\n            if transport.writer is not None:\r\n                try:\r\n                    await transport.writer.drain()\r\n                except OSError as e:\r\n                    if transport.handler is not None:\r\n                        asyncio_utils.cancel_task(transport.handler, f\"Error sending data: {e}\")\r\n                except AssertionError:\r\n                    pass\r\n```\r\nUgly but I will run this for a while to see if that is the reason for my missing images.","reactions":{"url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5158/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/5158/timeline","performed_via_github_app":null,"state_reason":"completed"}},"event":"cross-referenced"},{"id":8419619967,"node_id":"REFE_lADOAAfumM5BPzlpzwAAAAH12TR_","url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/events/8419619967","actor":{"login":"forcemax","id":6047090,"node_id":"MDQ6VXNlcjYwNDcwOTA=","avatar_url":"https://avatars.githubusercontent.com/u/6047090?v=4","gravatar_id":"","url":"https://api.github.com/users/forcemax","html_url":"https://github.com/forcemax","followers_url":"https://api.github.com/users/forcemax/followers","following_url":"https://api.github.com/users/forcemax/following{/other_user}","gists_url":"https://api.github.com/users/forcemax/gists{/gist_id}","starred_url":"https://api.github.com/users/forcemax/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/forcemax/subscriptions","organizations_url":"https://api.github.com/users/forcemax/orgs","repos_url":"https://api.github.com/users/forcemax/repos","events_url":"https://api.github.com/users/forcemax/events{/privacy}","received_events_url":"https://api.github.com/users/forcemax/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"400cb4cb38e18106ca4b9c32109e498e562a6426","commit_url":"https://api.github.com/repos/forcemax/mitmproxy/commits/400cb4cb38e18106ca4b9c32109e498e562a6426","created_at":"2023-02-02T10:36:29Z","performed_via_github_app":null},{"id":12137562904,"node_id":"REFE_lADOAAfumM5BPzlpzwAAAALTdIMY","url":"https://api.github.com/repos/mitmproxy/mitmproxy/issues/events/12137562904","actor":{"login":"jrblixt","id":10424783,"node_id":"MDQ6VXNlcjEwNDI0Nzgz","avatar_url":"https://avatars.githubusercontent.com/u/10424783?v=4","gravatar_id":"","url":"https://api.github.com/users/jrblixt","html_url":"https://github.com/jrblixt","followers_url":"https://api.github.com/users/jrblixt/followers","following_url":"https://api.github.com/users/jrblixt/following{/other_user}","gists_url":"https://api.github.com/users/jrblixt/gists{/gist_id}","starred_url":"https://api.github.com/users/jrblixt/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jrblixt/subscriptions","organizations_url":"https://api.github.com/users/jrblixt/orgs","repos_url":"https://api.github.com/users/jrblixt/repos","events_url":"https://api.github.com/users/jrblixt/events{/privacy}","received_events_url":"https://api.github.com/users/jrblixt/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"000e26674e39a04c23fcc717d50c9fa475330796","commit_url":"https://api.github.com/repos/jrblixt/mitmproxy/commits/000e26674e39a04c23fcc717d50c9fa475330796","created_at":"2024-03-15T23:08:27Z","performed_via_github_app":null}]