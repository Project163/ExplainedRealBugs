diff --git a/mitmproxy/log.py b/mitmproxy/log.py
index 0713df964..ca2404852 100644
--- a/mitmproxy/log.py
+++ b/mitmproxy/log.py
@@ -1,4 +1,3 @@
-import asyncio
 from dataclasses import dataclass
 
 from mitmproxy import hooks
@@ -61,7 +60,7 @@ class Log:
         self(txt, "error")
 
     def __call__(self, text, level="info"):
-        asyncio.get_event_loop().call_soon(
+        self.master.event_loop.call_soon_threadsafe(
             self.master.addons.trigger, AddLogHook(LogEntry(text, level)),
         )
 
diff --git a/test/mitmproxy/addons/test_command_history.py b/test/mitmproxy/addons/test_command_history.py
index e71267500..3d9a6e8ee 100644
--- a/test/mitmproxy/addons/test_command_history.py
+++ b/test/mitmproxy/addons/test_command_history.py
@@ -40,13 +40,13 @@ class TestCommandHistory:
 
     def test_add_command(self):
         ch = command_history.CommandHistory()
+        with taddons.context(ch):
+            ch.add_command('cmd1')
+            ch.add_command('cmd2')
+            assert ch.history == ['cmd1', 'cmd2']
 
-        ch.add_command('cmd1')
-        ch.add_command('cmd2')
-        assert ch.history == ['cmd1', 'cmd2']
-
-        ch.add_command('')
-        assert ch.history == ['cmd1', 'cmd2']
+            ch.add_command('')
+            assert ch.history == ['cmd1', 'cmd2']
 
     @pytest.mark.asyncio
     async def test_add_command_failed(self):
