diff --git a/CHANGELOG.md b/CHANGELOG.md
index 3a8675372..f4254e9e3 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -46,6 +46,8 @@
   ([#7570](https://github.com/mitmproxy/mitmproxy/pull/7570), @DenizenB)
 - Correctly forward HTTP_1_1_REQUIRED errors in HTTP/2 streams.
   ([#7575](https://github.com/mitmproxy/mitmproxy/pull/7575), @mhils)
+- Fix a bug where HAR export would crash for malformed flows.
+  ([#7666](https://github.com/mitmproxy/mitmproxy/pull/7666), @mhils)
 - Fix a bug where mitmweb would crash when viewing flows with undefined headers.
   ([#7595](https://github.com/mitmproxy/mitmproxy/pull/7595), @emanuele-em)
 - Fix a bug where mitmproxy does not listen on IPv4 and IPv6 by default in wireguard mode.
diff --git a/mitmproxy/addons/savehar.py b/mitmproxy/addons/savehar.py
index 7d55e0c19..d99308aaf 100644
--- a/mitmproxy/addons/savehar.py
+++ b/mitmproxy/addons/savehar.py
@@ -246,7 +246,9 @@ class SaveHar:
                 "headers": self.format_multidict(flow.request.headers),
                 "queryString": self.format_multidict(flow.request.query),
                 "headersSize": len(str(flow.request.headers)),
-                "bodySize": len(flow.request.content) if flow.request.content else 0,
+                "bodySize": len(flow.request.raw_content)
+                if flow.request.raw_content
+                else 0,
             },
             "response": response,
             "cache": {},
diff --git a/test/mitmproxy/addons/test_savehar.py b/test/mitmproxy/addons/test_savehar.py
index 753938fde..77cf287ff 100644
--- a/test/mitmproxy/addons/test_savehar.py
+++ b/test/mitmproxy/addons/test_savehar.py
@@ -240,6 +240,19 @@ class TestHardumpOption:
             assert len(out["log"]["entries"]) == 1
 
 
+def test_content_raises():
+    flow = tflow.tflow(
+        req=tutils.treq(content=b"foo", headers=((b"content-encoding", b"utf8"),)),
+        resp=tutils.tresp(content=b"foo", headers=((b"content-encoding", b"utf8"),)),
+    )
+    with pytest.raises(ValueError):
+        _ = flow.request.content
+    with pytest.raises(ValueError):
+        _ = flow.response.content
+    # should not raise
+    assert SaveHar().make_har([flow])
+
+
 if __name__ == "__main__":
     version.VERSION = "1.2.3"
     s = SaveHar()
diff --git a/test/mitmproxy/data/flows/diff_data.har b/test/mitmproxy/data/flows/diff_data.har
index 8f6446018..e49533ecf 100644
--- a/test/mitmproxy/data/flows/diff_data.har
+++ b/test/mitmproxy/data/flows/diff_data.har
@@ -599,7 +599,7 @@
                         }
                     ],
                     "headersSize": 990,
-                    "bodySize": 5970,
+                    "bodySize": 2379,
                     "postData": {
                         "mimeType": "application/octet-stream",
                         "text": "\n\u0014stanleygvi@gmail.com\u0010c\u0018\u0001\"\u0088,\n\u00ae\u0012\nfZ:ADqtAZwoGEGO4Rxc1RHIZbNFXaOB6MkBUyZCQvU4oUZ5lSUjHseZ6QaZ9Zlbvq+gNumk3FGw1gapr32/inhTGYvBN+dv82tsAw== \u00f1\u00c9\u009c\u00de\u009c\u009f\u0081\u0003(\u00d9\u009d\u008d\u00eb\u00a710\u00d5\u00c3\u0087\u00eb\u00a71:\u000bMacBook-Pro\u0090\u0001\u0000\u00aa\u0001\u00fc\u0010\u00ba\u00bc\u0018\u00f7\u0010\n\u0018PyIKPe4Z1cTqdvB7d+FPCQ==\u001a\u00d8\u0010\b\u008f\u0097\u00c4\u00c0\u0007\u0010\u008e\u0097\u00c4\u00c0\u0007\u0018\u0000 \u0003(\u00002\u0000:d\u0012\u0010chrome://newtab/\u001a\u0000\"\u0007New Tab0\u0006@\u0011H\u00c4\u00b3\u0086\u00eb\u00a71P\u0000X\u0000`\u0000x\u00fd\u00d2\u009b\u00ee\u0080\u00f2\u00d8\u0017\u00a0\u0001\u00c8\u0001\u00b0\u0001\u0000\u00c8\u0001\u0006\u00d0\u0001\u0000\u00d8\u0001\u00fd\u00d2\u009b\u00ee\u0080\u00f2\u00d8\u0017\u00e0\u0001\u00fd\u00d2\u009b\u00ee\u0080\u00f2\u00d8\u0017\u00e0\u0001\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u0001:\u008f\u0004\u0012\u00ae\u0001https://www.google.com/search?q=how+to+start+txp+connection&oq=how+to+start+txp+connection+&aqs=chrome..69i57j0i13i30j0i22i30l3j0i390i650l3.10590j0j7&sourceid=chrome&ie=UTF-8\u001a\u0000\"+how to start txp connection - Google Search0\u0005@\u0016H\u00a6\u00c5\u0087\u00eb\u00a71P\u0000X\u0001`\u0000x\u0082\u00b3\u008e\u00f7\u0080\u00f2\u00d8\u0017\u008a\u0001\"https://www.google.com/favicon.ico\u00a0\u0001\u00c8\u0001\u00b0\u0001\u0000\u00c8\u0001\u0004\u00d0\u0001\u0000\u00d8\u0001\u00c5\u00e3\u0080\u00f7\u0080\u00f2\u00d8\u0017\u00e0\u0001\u00c5\u00e3\u0080\u00f7\u0080\u00f2\u00d8\u0017\u00e0\u0001\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u00ff\u0001\u00ea\u0001\u00ba\u0001\n\u00ae\u0001https://www.google.com/search?q=how+to+start+txp+connection&oq=how+to+start+txp+connection+&aqs=chrome..69i57j0i13i30j0i22i30l3j0i390i650l3.10590j0j7&sourceid=chrome&ie=UTF-8\u0010\u00c7\u00c3\u0087\u00eb\u00a71\u0018\u0005\u00f2\u0001\u0002en:\u0084\t\u0012\u00de\u0003https://www.google.com/search?q=how+to+start+tcp+connection&sca_esv=564088781&sxsrf=AB5stBg6T1uwGI6y4Fe4qhRAiNDRQM-rJw%3A1694320680892&ei=KEj9ZMuDNszv0PEPxrGkmAQ&ved=0ahUKEwjLt8eynJ-BAxXMNzQIHcYYCUMQ4dUDCBA&uact=5&oq=how+to+start+tcp+connection&gs_lp=Egxnd3Mtd2l6LXNlcnAiG2hvdyB0byBzdGFydCB0Y3AgY29ubmVjdGlvbjIEEAAYHjIIEAAYigUYhgMyCBAAGIoFGIYDMggQABiKBRiGAzIIEAAYigUYhgNIiQ1QnApYhAtwAXgBkAEAmAGAAaAB3gGqAQMxLjG4AQPIAQD4AQHCAgoQABhHGNYEGLAD4gMEGAAgQYgGAZAGCA&sclient=gws-wiz-serp\u001a\u0017https://www.google.com/\"+how to start tcp connection - Google Search0\u0007@\u0018H\u00f4\u00f6\u008c\u00eb\u00a71P\u0001X\u0000`\u0000x\u00d6\u00fb\u0099\u00a1\u0081\u00f2\u00d8\u0017\u008a\u0001\"https://www.google.com/favicon.ico\u00a0\u0001\u00c8\u0001\u00b0\u0001\u0000\u00c8\u0001\u0004\u00d0\u0001\u0000\u00d8\u0001\u00ec\u00f4\u00cb\u00fa\u0080\u00f2\u00d8\u0017\u00e0\u0001\u00c5\u00e3\u0080\u00f7\u0080\u00f2\u00d8\u0017\u00e0\u0001\u00c5\u00e3\u0080\u00f7\u0080\u00f2\u00d8\u0017\u00ea\u0001\u00ea\u0003\n\u00de\u0003https://www.google.com/search?q=how+to+start+tcp+connection&sca_esv=564088781&sxsrf=AB5stBg6T1uwGI6y4Fe4qhRAiNDRQM-rJw%3A1694320680892&ei=KEj9ZMuDNszv0PEPxrGkmAQ&ved=0ahUKEwjLt8eynJ-BAxXMNzQIHcYYCUMQ4dUDCBA&uact=5&oq=how+to+start+tcp+connection&gs_lp=Egxnd3Mtd2l6LXNlcnAiG2hvdyB0byBzdGFydCB0Y3AgY29ubmVjdGlvbjIEEAAYHjIIEAAYigUYhgMyCBAAGIoFGIYDMggQABiKBRiGAzIIEAAYigUYhgNIiQ1QnApYhAtwAXgBkAEAmAGAAaAB3gGqAQMxLjG4AQPIAQD4AQHCAgoQABhHGNYEGLAD4gMEGAAgQYgGAZAGCA&sclient=gws-wiz-serp\u0010\u00a9\u00fe\u0087\u00eb\u00a71\u0018\u0007\u00f2\u0001\u0002en:\u00c0\u0002\u0012Phttps://stackoverflow.com/questions/31447099/starting-a-tcp-server-from-terminal\u001a\u0017https://www.google.com/\"<macos - Starting a TCP server from terminal - Stack Overflow0\u0000@\u001cH\u00a5\u0098\u008d\u00eb\u00a71P\u0000X\u0000`\u0000x\u00d4\u00e5\u009e\u00a3\u0081\u00f2\u00d8\u0017\u008a\u0001Jhttps://cdn.sstatic.net/Sites/stackoverflow/Img/favicon.ico?v=ec617d715196\u00a0\u0001\u00c8\u0001\u00b0\u0001\u0000\u00c8\u0001\u0004\u00d0\u0001\u0000\u00d8\u0001\u00d4\u00e5\u009e\u00a3\u0081\u00f2\u00d8\u0017\u00e0\u0001\u00c5\u00e3\u0080\u00f7\u0080\u00f2\u00d8\u0017\u00e0\u0001\u00ec\u00f4\u00cb\u00fa\u0080\u00f2\u00d8\u0017\u00f2\u0001\u0002enh\u0001 \u0000\u00ba\u0001\u001cDCHzs6R1kn3NKekCTS4i+GSbZhM=\n\u008e\n\n$97781583-edbd-4992-bc6d-41244fca980b \u0000(\u00a7\u0098\u008d\u00eb\u00a710\u00a7\u0098\u008d\u00eb\u00a71:\u00f7\u0003PyIKPe4Z1cTqdvB7d+FPCQ==-https://www.google.com/search?q=how+to+start+tcp+connection&sca_esv=564088781&sxsrf=AB5stBg6T1uwGI6y4Fe4qhRAiNDRQM-rJw%3A1694320680892&ei=KEj9ZMuDNszv0PEPxrGkmAQ&ved=0ahUKEwjLt8eynJ-BAxXMNzQIHcYYCUMQ4dUDCBA&uact=5&oq=how+to+start+tcp+connection&gs_lp=Egxnd3Mtd2l6LXNlcnAiG2hvdyB0byBzdGFydCB0Y3AgY29ubmVjdGlvbjIEEAAYHjIIEAAYigUYhgMyCBAAGIoFGIYDMggQABiKBRiGAzIIEAAYigUYhgNIiQ1QnApYhAtwAXgBkAEAmAGAAaAB3gGqAQMxLjG4AQPIAQD4AQHCAgoQABhHGNYEGLAD4gMEGAAgQYgGAZAGCA&sclient=gws-wiz-serp\u0090\u0001\u0000\u00aa\u0001\u00b8\u0005\u008a\u00d9\u00d6\u0003\u00b2\u0005\b\u00d6\u00fb\u0099\u00a1\u0081\u00f2\u00d8\u0017\u0012\u0018PyIKPe4Z1cTqdvB7d+FPCQ==\u001a\u0094\u0004\b\u00b7\u00d7\u0002\u0012\u00de\u0003https://www.google.com/search?q=how+to+start+tcp+connection&sca_esv=564088781&sxsrf=AB5stBg6T1uwGI6y4Fe4qhRAiNDRQM-rJw%3A1694320680892&ei=KEj9ZMuDNszv0PEPxrGkmAQ&ved=0ahUKEwjLt8eynJ-BAxXMNzQIHcYYCUMQ4dUDCBA&uact=5&oq=how+to+start+tcp+connection&gs_lp=Egxnd3Mtd2l6LXNlcnAiG2hvdyB0byBzdGFydCB0Y3AgY29ubmVjdGlvbjIEEAAYHjIIEAAYigUYhgMyCBAAGIoFGIYDMggQABiKBRiGAzIIEAAYigUYhgNIiQ1QnApYhAtwAXgBkAEAmAGAAaAB3gGqAQMxLjG4AQPIAQD4AQHCAgoQABhHGNYEGLAD4gMEGAAgQYgGAZAGCA&sclient=gws-wiz-serp\u001a+how to start tcp connection - Google Search \u0000\"\n\b\u0007\u0010\u0000\u0018\u0001 \u0000(\u0000(\u00000\u00008\u00a5\u00f9\u0084\u0002@\u0001H\u008e\u0097\u00c4\u00c0\u0007P\u008f\u0097\u00c4\u00c0\u0007X\u00ec\u00f4\u00cb\u00fa\u0080\u00f2\u00d8\u0017`\u00c5\u00e3\u0080\u00f7\u0080\u00f2\u00d8\u0017h\u00f5\u00e3\u0081\u009d\u0081\u00f2\u00d8\u0017p\u00c8\u0001z\u0000\u0080\u0001\u0000\u008a\u0001\"https://www.google.com/favicon.ico\u0098\u0001\u0000\u00a0\u0001\u0000\u00a8\u0001\u0000\u00b0\u0001\u00bb\u0012\u00ba\u0001\u001cEUnahljrPTRWmmUBMZN2rt6QEGM=\n\u00bd\u0007\n$db37a49f-9fee-4129-9d97-2a68bac38af2 \u0000(\u00b0\u0098\u008d\u00eb\u00a710\u00a8\u0098\u008d\u00eb\u00a71:iPyIKPe4Z1cTqdvB7d+FPCQ==-https://stackoverflow.com/questions/31447099/starting-a-tcp-server-from-terminal\u0090\u0001\u0000\u00aa\u0001\u00f6\u0005\u008a\u00d9\u00d6\u0003\u00f0\u0005\b\u00d4\u00e5\u009e\u00a3\u0081\u00f2\u00d8\u0017\u0012\u0018PyIKPe4Z1cTqdvB7d+FPCQ==\u001a\u0096\u0001\b\u00b8\u00d7\u0002\u0012Phttps://stackoverflow.com/questions/31447099/starting-a-tcp-server-from-terminal\u001a<macos - Starting a TCP server from terminal - Stack Overflow \u0000\"\n\b\u0000\u0010\u0000\u0018\u0000 \u0000(\u0000(\u00b7\u00d7\u00020\u00008\u0000@\u0001H\u008e\u0097\u00c4\u00c0\u0007P\u008f\u0097\u00c4\u00c0\u0007X\u00d4\u00e5\u009e\u00a3\u0081\u00f2\u00d8\u0017`\u00c5\u00e3\u0080\u00f7\u0080\u00f2\u00d8\u0017h\u00ec\u00f4\u00cb\u00fa\u0080\u00f2\u00d8\u0017p\u00c8\u0001z\u0000\u0080\u0001\u0000\u0092\u0001\u00de\u0003https://www.google.com/search?q=how+to+start+tcp+connection&sca_esv=564088781&sxsrf=AB5stBg6T1uwGI6y4Fe4qhRAiNDRQM-rJw%3A1694320680892&ei=KEj9ZMuDNszv0PEPxrGkmAQ&ved=0ahUKEwjLt8eynJ-BAxXMNzQIHcYYCUMQ4dUDCBA&uact=5&oq=how+to+start+tcp+connection&gs_lp=Egxnd3Mtd2l6LXNlcnAiG2hvdyB0byBzdGFydCB0Y3AgY29ubmVjdGlvbjIEEAAYHjIIEAAYigUYhgMyCBAAGIoFGIYDMggQABiKBRiGAzIIEAAYigUYhgNIiQ1QnApYhAtwAXgBkAEAmAGAAaAB3gGqAQMxLjG4AQPIAQD4AQHCAgoQABhHGNYEGLAD4gMEGAAgQYgGAZAGCA&sclient=gws-wiz-serp\u0098\u0001\u0000\u00a0\u0001\u0000\u00a8\u0001\u0000\u00b0\u0001\u00bb\u0012\u00ba\u0001\u001cswqCCuC9fz8ZGkV3Uzm9JBA5tuY=\u0012\u0018PyIKPe4Z1cTqdvB7d+FPCQ==\"\u00e6\u0005\b\u0088\u0081\u0002\b\u00c6\u00a6\u0002\b\u00b1\u00e6\u0002\b\u00cf\u00f3\u0003\b\u00f1\u00f7\u0001\b\u00de\u00d8\u0012\b\u00c9\u0095\u0014\b\u00b9\u00a1/\b\u00fa\u00c1\u0002\b\u00f7\u00f7\u0002\b\u00a2\u00b4\u0005\b\u00c7\u0087\u0003\b\u00ec\u00f9\u0002\b\u00e8\u00a9\u0006\b\u009f\u00ef\u0005\b\u00eb\u0095\t\b\u009a\u00b7\t\b\u00e1\u00fc\t\b\u0094\u008b\u0019\b\u00a6\u00e4\u001b\b\u00ee\u00f7!\b\u00fc\u00de$\b\u00b4\u00d2$\b\u00c9\u008b)\b\u00a2\u00be,\b\u0091\u00eb:\b\u008a\u0091?\b\u0081\u00f5\u0002\u0010\u0001\u0018\u0000 \u0000*\u0098\u0001eRJdHM9vsSY:APA91bE6lYR7OwAkLHWMGRPYPG9p9X3mnCeziP8sA7rmLoQ4Tk9WOoBRoQZo0IgpyeOry-A6tVveCttII_43fTB4vlxdjN21Uyl7O8DCEOs9lVQoJSKYjahI9b25arWVQbv33h7COdHq*\u0098\u0001eE9N_R8m2mU:APA91bHbpGHVkIJHy5R-8LsWi_EURBiu7TDZOAB3_pKaAChXQizAiqyJ7LPF7dXLS3X6iRq1XjkvrASnNT4U-CcyTOG5LovCN0vqV9jjjmAzomMsjNpSVMjI9zePpFiHouRtE_K9HWHv0\u0000:\u0098\u0001eE9N_R8m2mU:APA91bHbpGHVkIJHy5R-8LsWi_EURBiu7TDZOAB3_pKaAChXQizAiqyJ7LPF7dXLS3X6iRq1XjkvrASnNT4U-CcyTOG5LovCN0vqV9jjjmAzomMsjNpSVMjI9zePpFiHouRtE_K9HWHv:\u0098\u0001eRJdHM9vsSY:APA91bE6lYR7OwAkLHWMGRPYPG9p9X3mnCeziP8sA7rmLoQ4Tk9WOoBRoQZo0IgpyeOry-A6tVveCttII_43fTB4vlxdjN21Uyl7O8DCEOs9lVQoJSKYjahI9b25arWVQbv33h7COdHq@\u00012\u0080\u0002gfd bX`vAN/]o#t@-(V8\"B2\\vJbj|:;~B)[Kr$54'1DG\"[f6PFw,P!Rr7]P-{L#I9YwD-%JUk!}<V[*0V(L61wb6}*~Oh('dSA@2b YZ$gDm{#oD+DEFDRIAFB[E=E{?bul3,B8+,f-+v%#h%_q3_-4DQaSGY#XgH?o`.\\d56\\hMVoP7eyeM2'i7uuh/>YScz)QA/R`!9W&m0FqQX9+axfs\"m2sGK42H]bKk3*3,)Mr$|C+BXm}]_Cn1E00`O4!%:%z00000146-9b6d-1d2e-0000-0000539c866dRF\n\u000e\u0012\f8\u0000@\u0000R\u0004\b\u0000\u0010\u0001`\f\n\u0004\u0018\u0091\u00eb:\n\u0004\u0018\u0091\u00eb:\n\u0004\u0018\u00c7\u0087\u0003\n\u0004\u0018\u0091\u00eb:\n\u0004\u0018\u00c7\u0087\u0003\n\u0004\u0018\u0091\u00eb:\n\u0004\u0018\u00c7\u0087\u0003\n\u0004\u0018\u00c7\u0087\u0003\u0010\u0001\u0018\u0000 \u0000Z\u0081\u0001\n\u007f\u0012}Chrome MAC 116.0.5845.179 (17ff023f3eb4f6883321db9399bfc65560ef84a9-refs/branch-heads/5845@{#1745}) channel(stable),gzip(gfe)b'AIzaSyBOti4mM-6x9WDnZIjIeyEU21OpBXqWBgwj\u0002\u0010\u0001r\u000be27aus4bokQ",
