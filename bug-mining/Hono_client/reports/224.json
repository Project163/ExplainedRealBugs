{"url":"https://api.github.com/repos/eclipse-hono/hono/issues/2070","repository_url":"https://api.github.com/repos/eclipse-hono/hono","labels_url":"https://api.github.com/repos/eclipse-hono/hono/issues/2070/labels{/name}","comments_url":"https://api.github.com/repos/eclipse-hono/hono/issues/2070/comments","events_url":"https://api.github.com/repos/eclipse-hono/hono/issues/2070/events","html_url":"https://github.com/eclipse-hono/hono/issues/2070","id":651639774,"node_id":"MDU6SXNzdWU2NTE2Mzk3NzQ=","number":2070,"title":"Support Hono deployment in multi-tenant messaging environments","user":{"login":"dejanb","id":141611,"node_id":"MDQ6VXNlcjE0MTYxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/141611?v=4","gravatar_id":"","url":"https://api.github.com/users/dejanb","html_url":"https://github.com/dejanb","followers_url":"https://api.github.com/users/dejanb/followers","following_url":"https://api.github.com/users/dejanb/following{/other_user}","gists_url":"https://api.github.com/users/dejanb/gists{/gist_id}","starred_url":"https://api.github.com/users/dejanb/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dejanb/subscriptions","organizations_url":"https://api.github.com/users/dejanb/orgs","repos_url":"https://api.github.com/users/dejanb/repos","events_url":"https://api.github.com/users/dejanb/events{/privacy}","received_events_url":"https://api.github.com/users/dejanb/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":323160608,"node_id":"MDU6TGFiZWwzMjMxNjA2MDg=","url":"https://api.github.com/repos/eclipse-hono/hono/labels/enhancement","name":"enhancement","color":"84b6eb","default":true,"description":null},{"id":643682479,"node_id":"MDU6TGFiZWw2NDM2ODI0Nzk=","url":"https://api.github.com/repos/eclipse-hono/hono/labels/Client","name":"Client","color":"0e8a16","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"dejanb","id":141611,"node_id":"MDQ6VXNlcjE0MTYxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/141611?v=4","gravatar_id":"","url":"https://api.github.com/users/dejanb","html_url":"https://github.com/dejanb","followers_url":"https://api.github.com/users/dejanb/followers","following_url":"https://api.github.com/users/dejanb/following{/other_user}","gists_url":"https://api.github.com/users/dejanb/gists{/gist_id}","starred_url":"https://api.github.com/users/dejanb/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dejanb/subscriptions","organizations_url":"https://api.github.com/users/dejanb/orgs","repos_url":"https://api.github.com/users/dejanb/repos","events_url":"https://api.github.com/users/dejanb/events{/privacy}","received_events_url":"https://api.github.com/users/dejanb/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"dejanb","id":141611,"node_id":"MDQ6VXNlcjE0MTYxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/141611?v=4","gravatar_id":"","url":"https://api.github.com/users/dejanb","html_url":"https://github.com/dejanb","followers_url":"https://api.github.com/users/dejanb/followers","following_url":"https://api.github.com/users/dejanb/following{/other_user}","gists_url":"https://api.github.com/users/dejanb/gists{/gist_id}","starred_url":"https://api.github.com/users/dejanb/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dejanb/subscriptions","organizations_url":"https://api.github.com/users/dejanb/orgs","repos_url":"https://api.github.com/users/dejanb/repos","events_url":"https://api.github.com/users/dejanb/events{/privacy}","received_events_url":"https://api.github.com/users/dejanb/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/eclipse-hono/hono/milestones/23","html_url":"https://github.com/eclipse-hono/hono/milestone/23","labels_url":"https://api.github.com/repos/eclipse-hono/hono/milestones/23/labels","id":5232802,"node_id":"MDk6TWlsZXN0b25lNTIzMjgwMg==","number":23,"title":"1.3.0","description":"https://projects.eclipse.org/projects/iot.hono/releases/1.3.0","creator":{"login":"sophokles73","id":5682135,"node_id":"MDQ6VXNlcjU2ODIxMzU=","avatar_url":"https://avatars.githubusercontent.com/u/5682135?v=4","gravatar_id":"","url":"https://api.github.com/users/sophokles73","html_url":"https://github.com/sophokles73","followers_url":"https://api.github.com/users/sophokles73/followers","following_url":"https://api.github.com/users/sophokles73/following{/other_user}","gists_url":"https://api.github.com/users/sophokles73/gists{/gist_id}","starred_url":"https://api.github.com/users/sophokles73/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sophokles73/subscriptions","organizations_url":"https://api.github.com/users/sophokles73/orgs","repos_url":"https://api.github.com/users/sophokles73/repos","events_url":"https://api.github.com/users/sophokles73/events{/privacy}","received_events_url":"https://api.github.com/users/sophokles73/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":176,"state":"closed","created_at":"2020-03-24T14:28:34Z","updated_at":"2020-08-03T13:27:48Z","due_on":"2020-07-15T07:00:00Z","closed_at":"2020-08-03T13:27:48Z"},"comments":0,"created_at":"2020-07-06T15:43:30Z","updated_at":"2020-07-13T09:24:21Z","closed_at":"2020-07-13T09:24:21Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"In multi-tenant messaging environments there could be different connection endpoints used by infrastructure and end users. For end users in this case, the addresses are usually translated internally in order to enable consistent namespaces.\r\n\r\nFor example, dispatch router enables this behaviour through the (poorly) documented `multiTenant` property\r\n\r\n```\r\n  [\"listener\", {\r\n    \"host\": \"0.0.0.0\",\r\n    \"port\": 5672,\r\n    \"linkCapacity\": 100,\r\n    \"authenticatePeer\": true,\r\n    \"saslMechanisms\": \"PLAIN\",\r\n    \"saslPlugin\": \"Hono Auth\",\r\n    \"multiTenant\": true\r\n  }]\r\n```\r\n\r\nWhen clients connect through a listener like this, all addresses in the attach frames will be prefixed with the virtual host prefix. e.g. `telemetry/DEFAULT_TENANT` would become `test-vhost/telemetry/DEFAULT_TENANT` internally. End clients are be unaware of this. There are more work being done in the router to make this more configurable in the future (mosly to support Kubernetes namespaces), but the basic principles will remain the same.\r\n\r\nIn order to be able to work in such environments, infrastructure components connecting through the non multi-tenant listeners and are responsible of doing address translation on thier own. The proposal is to add an option for protocol adapters to rewrite addresses when opening links to the AMQP network.\r\nThe idea is to provide a configuration option similar to popular web server URL rewrite rules.\r\n\r\nThe rule configuration would be in the `\"$PATTERN $SUBSTITUTION\"` format. The `$PATTERN` should match the original address. It uses the regular Java pattern syntax. There are two helper constants introduced:\r\n\t* `ENDPOINT` - that will match the current endpoint being used</li>\r\n    * `ID` - a pattern that will match any identity (using default format) in the system\r\n\r\nExample configuration could look like this:\r\n\r\n```\r\n  messaging:\r\n    name: Hono adapter-http-vertx\r\n    amqpHostname: hono-internal\r\n    host: eclipse-hono-dispatch-router\r\n    port: 5673\r\n    keyPath: /etc/hono/key.pem\r\n    certPath: /etc/hono/cert.pem\r\n    trustStorePath: /etc/hono/trusted-certs.pem\r\n    hostnameVerificationRequired: false\r\n    addressRewriteRule: (${ENDPOINT})/(${ID}) test-vhost/$1/$2\r\n  command:\r\n    name: Hono adapter-http-vertx\r\n    amqpHostname: hono-internal\r\n    host: eclipse-hono-dispatch-router\r\n    port: 5673\r\n    keyPath: /etc/hono/key.pem\r\n    certPath: /etc/hono/cert.pem\r\n    trustStorePath: /etc/hono/trusted-certs.pem\r\n    hostnameVerificationRequired: false\r\n    addressRewriteRule: (${ENDPOINT})/(${ID}) test-vhost/$1/$2\r\n```\r\n\r\nThis would result in aforementioned rewrites that prefix addresses with virtual host (`test-vhost`) in this example.\r\nThis feature is completely optional and doesn't affect the behaviour of the system if it's not used. If it's used it changes the contract between adapters and the AMQP network, but not for the devices and business applications.\r\n\r\nA deployment that could be used to test this kind of setup could be found here:\r\n\r\nRouter config: https://github.com/dejanb/packages/blob/address-rewrite/charts/hono/config/router/qdrouterd-multitenant.json\r\nChart config file: https://github.com/dejanb/packages/blob/address-rewrite/charts/hono/addressRewrite.yaml\r\n\r\nThis could be added to the chart after the Hono properly supports this feature.","closed_by":{"login":"dejanb","id":141611,"node_id":"MDQ6VXNlcjE0MTYxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/141611?v=4","gravatar_id":"","url":"https://api.github.com/users/dejanb","html_url":"https://github.com/dejanb","followers_url":"https://api.github.com/users/dejanb/followers","following_url":"https://api.github.com/users/dejanb/following{/other_user}","gists_url":"https://api.github.com/users/dejanb/gists{/gist_id}","starred_url":"https://api.github.com/users/dejanb/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dejanb/subscriptions","organizations_url":"https://api.github.com/users/dejanb/orgs","repos_url":"https://api.github.com/users/dejanb/repos","events_url":"https://api.github.com/users/dejanb/events{/privacy}","received_events_url":"https://api.github.com/users/dejanb/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/eclipse-hono/hono/issues/2070/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/eclipse-hono/hono/issues/2070/timeline","performed_via_github_app":null,"state_reason":"completed"}