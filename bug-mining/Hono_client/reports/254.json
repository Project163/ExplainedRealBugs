{"url":"https://api.github.com/repos/eclipse-hono/hono/issues/2777","repository_url":"https://api.github.com/repos/eclipse-hono/hono","labels_url":"https://api.github.com/repos/eclipse-hono/hono/issues/2777/labels{/name}","comments_url":"https://api.github.com/repos/eclipse-hono/hono/issues/2777/comments","events_url":"https://api.github.com/repos/eclipse-hono/hono/issues/2777/events","html_url":"https://github.com/eclipse-hono/hono/issues/2777","id":939915578,"node_id":"MDU6SXNzdWU5Mzk5MTU1Nzg=","number":2777,"title":"Integration tests module compilation takes very long","user":{"login":"calohmn","id":891931,"node_id":"MDQ6VXNlcjg5MTkzMQ==","avatar_url":"https://avatars.githubusercontent.com/u/891931?v=4","gravatar_id":"","url":"https://api.github.com/users/calohmn","html_url":"https://github.com/calohmn","followers_url":"https://api.github.com/users/calohmn/followers","following_url":"https://api.github.com/users/calohmn/following{/other_user}","gists_url":"https://api.github.com/users/calohmn/gists{/gist_id}","starred_url":"https://api.github.com/users/calohmn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calohmn/subscriptions","organizations_url":"https://api.github.com/users/calohmn/orgs","repos_url":"https://api.github.com/users/calohmn/repos","events_url":"https://api.github.com/users/calohmn/events{/privacy}","received_events_url":"https://api.github.com/users/calohmn/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":2161239242,"node_id":"MDU6TGFiZWwyMTYxMjM5MjQy","url":"https://api.github.com/repos/eclipse-hono/hono/labels/build%20system","name":"build system","color":"0e8a16","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"calohmn","id":891931,"node_id":"MDQ6VXNlcjg5MTkzMQ==","avatar_url":"https://avatars.githubusercontent.com/u/891931?v=4","gravatar_id":"","url":"https://api.github.com/users/calohmn","html_url":"https://github.com/calohmn","followers_url":"https://api.github.com/users/calohmn/followers","following_url":"https://api.github.com/users/calohmn/following{/other_user}","gists_url":"https://api.github.com/users/calohmn/gists{/gist_id}","starred_url":"https://api.github.com/users/calohmn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calohmn/subscriptions","organizations_url":"https://api.github.com/users/calohmn/orgs","repos_url":"https://api.github.com/users/calohmn/repos","events_url":"https://api.github.com/users/calohmn/events{/privacy}","received_events_url":"https://api.github.com/users/calohmn/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"calohmn","id":891931,"node_id":"MDQ6VXNlcjg5MTkzMQ==","avatar_url":"https://avatars.githubusercontent.com/u/891931?v=4","gravatar_id":"","url":"https://api.github.com/users/calohmn","html_url":"https://github.com/calohmn","followers_url":"https://api.github.com/users/calohmn/followers","following_url":"https://api.github.com/users/calohmn/following{/other_user}","gists_url":"https://api.github.com/users/calohmn/gists{/gist_id}","starred_url":"https://api.github.com/users/calohmn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calohmn/subscriptions","organizations_url":"https://api.github.com/users/calohmn/orgs","repos_url":"https://api.github.com/users/calohmn/repos","events_url":"https://api.github.com/users/calohmn/events{/privacy}","received_events_url":"https://api.github.com/users/calohmn/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/eclipse-hono/hono/milestones/30","html_url":"https://github.com/eclipse-hono/hono/milestone/30","labels_url":"https://api.github.com/repos/eclipse-hono/hono/milestones/30/labels","id":6776674,"node_id":"MDk6TWlsZXN0b25lNjc3NjY3NA==","number":30,"title":"1.9.0","description":"","creator":{"login":"sophokles73","id":5682135,"node_id":"MDQ6VXNlcjU2ODIxMzU=","avatar_url":"https://avatars.githubusercontent.com/u/5682135?v=4","gravatar_id":"","url":"https://api.github.com/users/sophokles73","html_url":"https://github.com/sophokles73","followers_url":"https://api.github.com/users/sophokles73/followers","following_url":"https://api.github.com/users/sophokles73/following{/other_user}","gists_url":"https://api.github.com/users/sophokles73/gists{/gist_id}","starred_url":"https://api.github.com/users/sophokles73/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sophokles73/subscriptions","organizations_url":"https://api.github.com/users/sophokles73/orgs","repos_url":"https://api.github.com/users/sophokles73/repos","events_url":"https://api.github.com/users/sophokles73/events{/privacy}","received_events_url":"https://api.github.com/users/sophokles73/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":88,"state":"closed","created_at":"2021-05-20T09:10:01Z","updated_at":"2021-07-16T10:47:00Z","due_on":"2021-07-15T07:00:00Z","closed_at":"2021-07-16T10:47:00Z"},"comments":3,"created_at":"2021-07-08T14:23:24Z","updated_at":"2021-07-13T12:14:24Z","closed_at":"2021-07-13T11:33:43Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Something that has baffled me for quite a while is how long it takes to compile the \"tests\" Hono module with the integration tests.\r\nOn my machine that takes about 60 seconds (for just 63 classes)!\r\nThis means there is quite some patience needed when developing integration tests.\r\n\r\nI've tried to narrow it down a bit, to see which classes take up the most time.\r\nRemoving everything except the `org.eclipse.hono.tests.http.HttpTestBase` class and classes it depends on leads to a compilation time of still about 40 seconds.\r\n\r\nTesting some more, the compilation time is increased by several seconds when duplicating the last `assertThat` line multiple times here:\r\nhttps://github.com/eclipse/hono/blob/969751067daf83a1e4f6dfde5b0b0c7f7cbe5c13/tests/src/test/java/org/eclipse/hono/tests/http/HttpTestBase.java#L1300-L1310\r\n\r\nNarrowing it down to just this piece of code\r\n```\r\n    public void test(final java.util.Optional<java.util.List<String>> listOptional) {\r\n        listOptional\r\n                .map(list -> {\r\n                    verify(() -> {\r\n                        org.assertj.core.api.Assertions.assertThat(list.get(1)).isNull();\r\n                        org.assertj.core.api.Assertions.assertThat(list.get(1)).isNull();\r\n                        org.assertj.core.api.Assertions.assertThat(list.get(1)).isNull();\r\n                        org.assertj.core.api.Assertions.assertThat(list.get(1)).isNull();\r\n                        org.assertj.core.api.Assertions.assertThat(list.get(1)).isNull();\r\n                        org.assertj.core.api.Assertions.assertThat(list.get(1)).isNull();\r\n                        org.assertj.core.api.Assertions.assertThat(list.get(1)).isNull();\r\n                        org.assertj.core.api.Assertions.assertThat(list.get(1)).isNull();\r\n                        org.assertj.core.api.Assertions.assertThat(list.get(1)).isNull();\r\n                        org.assertj.core.api.Assertions.assertThat(list.get(1)).isNull();\r\n                    });\r\n                    return list;\r\n                });\r\n    }\r\n    private void verify(final Runnable block) {\r\n        //\r\n    }\r\n```\r\nI arrive at 6 seconds:\r\n```\r\njavac -verbose -version -cp [path]/assertj-core-3.20.2.jar:. Test.java\r\njavac 14.0.2\r\n...\r\n[total 6073ms]\r\n```\r\nTrying out other JDK (versions), there is no significant difference.\r\n\r\nThis all leads me to believe that the combination of lambdas + generics + the heavily overloaded AssertJ `Assertions.assertThat` methods lead to these long compilation times. Using the latest AssertJ version (3.20.2) has brought no difference.\r\n\r\nI've done some tests using an AssertJ alternative, [Truth](https://truth.dev/) by the Guava team.\r\nBy just changing the static import\r\n`import static org.assertj.core.api.Assertions.assertThat;`\r\nto\r\n`import static com.google.common.truth.Truth.assertThat;`\r\nin the aforementioned `HttpTestBase` class (and removing two `.as(\"[something]\")` expressions from `assertThat` invocations), the compilation time of the tests module drops from 60s to 30s.\r\n\r\nUsing Truth `assertThat` in (almost) all test classes leads to a compilation time of 12s!\r\nThis requires changes to some assertions, since Truth `assertThat` doesn't have that many assertion methods to choose from.\r\n(For the test I kept these AssertJ assertions, e.g. `assertThat(resp.getAuthorizedGateways()).containsExactlyElementsOf(via);`)\r\n\r\nOther possible options here:\r\n- Use AssertJ `AssertionsForClassTypes.assertThat` instead of `Assertions.assertThat` where applicable. This has already brought down the compilation time of the tests module to 35s.\r\n- Use Hamcrest instead. This requires quite some changes though, since the invocation is a bit different: \r\n`assertThat(a, equalTo(b));` vs AssertJ `assertThat(a).isEqualTo(b);`. I've done no tests here yet.\r\n\r\n\r\nI would suggest going for Truth here, since the above mentioned combination of `assertThat` with lambdas and also with generics is something we use oftentimes in the Hono code. And the migration from AssertJ doesn't seem to need much of an effort.\r\n\r\nI can prepare a PR for the `tests` module to show the needed changes.\r\n\r\n@sophokles73, @dejanb, @kaniyan, @ctron WDYT? ","closed_by":{"login":"calohmn","id":891931,"node_id":"MDQ6VXNlcjg5MTkzMQ==","avatar_url":"https://avatars.githubusercontent.com/u/891931?v=4","gravatar_id":"","url":"https://api.github.com/users/calohmn","html_url":"https://github.com/calohmn","followers_url":"https://api.github.com/users/calohmn/followers","following_url":"https://api.github.com/users/calohmn/following{/other_user}","gists_url":"https://api.github.com/users/calohmn/gists{/gist_id}","starred_url":"https://api.github.com/users/calohmn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calohmn/subscriptions","organizations_url":"https://api.github.com/users/calohmn/orgs","repos_url":"https://api.github.com/users/calohmn/repos","events_url":"https://api.github.com/users/calohmn/events{/privacy}","received_events_url":"https://api.github.com/users/calohmn/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/eclipse-hono/hono/issues/2777/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/eclipse-hono/hono/issues/2777/timeline","performed_via_github_app":null,"state_reason":"completed"}