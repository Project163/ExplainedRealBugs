{"url":"https://api.github.com/repos/eclipse-hono/hono/issues/454","repository_url":"https://api.github.com/repos/eclipse-hono/hono","labels_url":"https://api.github.com/repos/eclipse-hono/hono/issues/454/labels{/name}","comments_url":"https://api.github.com/repos/eclipse-hono/hono/issues/454/comments","events_url":"https://api.github.com/repos/eclipse-hono/hono/issues/454/events","html_url":"https://github.com/eclipse-hono/hono/issues/454","id":290505789,"node_id":"MDU6SXNzdWUyOTA1MDU3ODk=","number":454,"title":"Possible memory leak with `TelemetrySenderImpl`","user":{"login":"ctron","id":202474,"node_id":"MDQ6VXNlcjIwMjQ3NA==","avatar_url":"https://avatars.githubusercontent.com/u/202474?v=4","gravatar_id":"","url":"https://api.github.com/users/ctron","html_url":"https://github.com/ctron","followers_url":"https://api.github.com/users/ctron/followers","following_url":"https://api.github.com/users/ctron/following{/other_user}","gists_url":"https://api.github.com/users/ctron/gists{/gist_id}","starred_url":"https://api.github.com/users/ctron/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ctron/subscriptions","organizations_url":"https://api.github.com/users/ctron/orgs","repos_url":"https://api.github.com/users/ctron/repos","events_url":"https://api.github.com/users/ctron/events{/privacy}","received_events_url":"https://api.github.com/users/ctron/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":323160606,"node_id":"MDU6TGFiZWwzMjMxNjA2MDY=","url":"https://api.github.com/repos/eclipse-hono/hono/labels/bug","name":"bug","color":"fc2929","default":true,"description":null},{"id":643682479,"node_id":"MDU6TGFiZWw2NDM2ODI0Nzk=","url":"https://api.github.com/repos/eclipse-hono/hono/labels/Client","name":"Client","color":"0e8a16","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/eclipse-hono/hono/milestones/9","html_url":"https://github.com/eclipse-hono/hono/milestone/9","labels_url":"https://api.github.com/repos/eclipse-hono/hono/milestones/9/labels","id":2676077,"node_id":"MDk6TWlsZXN0b25lMjY3NjA3Nw==","number":9,"title":"0.5","description":"Official 0.5 release, see https://projects.eclipse.org/projects/iot.hono/releases/0.5","creator":{"login":"sophokles73","id":5682135,"node_id":"MDQ6VXNlcjU2ODIxMzU=","avatar_url":"https://avatars.githubusercontent.com/u/5682135?v=4","gravatar_id":"","url":"https://api.github.com/users/sophokles73","html_url":"https://github.com/sophokles73","followers_url":"https://api.github.com/users/sophokles73/followers","following_url":"https://api.github.com/users/sophokles73/following{/other_user}","gists_url":"https://api.github.com/users/sophokles73/gists{/gist_id}","starred_url":"https://api.github.com/users/sophokles73/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sophokles73/subscriptions","organizations_url":"https://api.github.com/users/sophokles73/orgs","repos_url":"https://api.github.com/users/sophokles73/repos","events_url":"https://api.github.com/users/sophokles73/events{/privacy}","received_events_url":"https://api.github.com/users/sophokles73/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":46,"state":"closed","created_at":"2017-08-02T08:11:48Z","updated_at":"2018-02-19T10:53:07Z","due_on":"2018-02-12T08:00:00Z","closed_at":"2018-02-12T17:03:15Z"},"comments":12,"created_at":"2018-01-22T15:29:38Z","updated_at":"2018-01-24T09:17:43Z","closed_at":"2018-01-24T09:17:43Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"While testing Hono I stumbled over the situation that the Hono HTTP adapter runs into memory issues. Peeking at the heap I can see a high number of instances of the `TelemetrySenderImpl`:\r\n\r\n~~~\r\nsh-4.2$ jmap -histo 1  | head -n 30\r\n\r\n num     #instances         #bytes  class name\r\n----------------------------------------------\r\n   1:        306888       31552608  [B\r\n   2:        273952       26299392  org.apache.qpid.proton.engine.impl.DeliveryImpl\r\n   3:        343058       25441536  [C\r\n   4:        273952        8766464  org.apache.qpid.proton.engine.impl.TransportDelivery\r\n   5:        330609        7934616  java.lang.String\r\n   6:        273952        6574848  io.vertx.proton.impl.ProtonDeliveryImpl\r\n   7:        273309        6559416  org.eclipse.hono.client.impl.TelemetrySenderImpl$$Lambda$180/1997786804\r\n   8:        284584        4553344  org.apache.qpid.proton.amqp.UnsignedInteger\r\n   9:         16953        3474568  [I\r\n  10:         14247        1534456  [Ljava.lang.Object;\r\n  11:          7507         834672  java.lang.Class\r\n  12:         19613         627616  java.util.concurrent.ConcurrentHashMap$Node\r\n  13:          8313         532032  java.nio.DirectByteBuffer\r\n  14:         10630         510240  java.nio.HeapByteBuffer\r\n  15:          5433         378288  [Ljava.util.HashMap$Node;\r\n  16:         10935         349920  java.util.HashMap$Node\r\n  17:          7718         308720  java.util.LinkedHashMap$Entry\r\n  18:         17963         287408  java.lang.Object\r\n  19:           386         212272  [Ljava.nio.channels.SelectionKey;\r\n  20:          4170         200160  io.netty.buffer.UnpooledByteBufAllocator$InstrumentedUnpooledUnsafeHeapByteBuf\r\n  21:          2186         192368  java.lang.reflect.Method\r\n  22:          3421         191576  java.util.LinkedHashMap\r\n  23:           133         177968  [Ljava.util.concurrent.ConcurrentHashMap$Node;\r\n  24:          3654         175392  java.util.HashMap\r\n  25:          4221         168840  io.netty.handler.codec.DefaultHeaders$HeaderEntry\r\n  26:           234         153504  io.netty.util.internal.shaded.org.jctools.queues.MpscArrayQueue\r\n  27:          4769         152608  java.lang.ref.WeakReference\r\n~~~\r\n\r\nLooking at the code I spotted the following in `org.eclipse.hono.client.impl.HonoClientImpl.getOrCreateSender(String, Consumer<Handler<AsyncResult<MessageSender>>>, Handler<AsyncResult<MessageSender>>)`:\r\n\r\n~~~java\r\n…\r\n} else if (!creationLocks.computeIfAbsent(key, k -> Boolean.FALSE)) {\r\n\r\n  // register a handler to be notified if the underlying connection to the server fails\r\n  // so that we can fail the result handler passed in\r\n  final Handler<Void> connectionFailureHandler = connectionLost -> {\r\n  // remove lock so that next attempt to open a sender doesn't fail\r\n  creationLocks.remove(key);\r\n  resultHandler.handle(Future.failedFuture(\r\n    new ServerErrorException(HttpURLConnection.HTTP_UNAVAILABLE, \"connection to server lost\")));\r\n  };\r\n  creationRequests.add(connectionFailureHandler);\r\n  creationLocks.put(key, Boolean.TRUE);\r\n  LOG.debug(\"creating new message sender for {}\", key);\r\n…\r\n~~~\r\n\r\nTo me it looks like as if this method gets called un-synchronized from various threads. So between the \"computeIfAbsent\" (which will always return false) and the \"put\", it might be that multiple callers might have triggered a new connection.\r\n\r\nChanging it to `creationLocks.putIfAbsent(key, k -> Boolean.TRUE) == null` should fix this issue as only the first caller will pass. After that the result will be non-null until the key is removed by the call to `remove`. Of course that would change the meaning of the value carried by the map. So maybe switching this to `Map<String,Object>` would be more appropriate then.","closed_by":{"login":"ctron","id":202474,"node_id":"MDQ6VXNlcjIwMjQ3NA==","avatar_url":"https://avatars.githubusercontent.com/u/202474?v=4","gravatar_id":"","url":"https://api.github.com/users/ctron","html_url":"https://github.com/ctron","followers_url":"https://api.github.com/users/ctron/followers","following_url":"https://api.github.com/users/ctron/following{/other_user}","gists_url":"https://api.github.com/users/ctron/gists{/gist_id}","starred_url":"https://api.github.com/users/ctron/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ctron/subscriptions","organizations_url":"https://api.github.com/users/ctron/orgs","repos_url":"https://api.github.com/users/ctron/repos","events_url":"https://api.github.com/users/ctron/events{/privacy}","received_events_url":"https://api.github.com/users/ctron/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/eclipse-hono/hono/issues/454/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/eclipse-hono/hono/issues/454/timeline","performed_via_github_app":null,"state_reason":"completed"}