[{"id":3931800312,"node_id":"MDEyOkxhYmVsZWRFdmVudDM5MzE4MDAzMTI=","url":"https://api.github.com/repos/eclipse-hono/hono/issues/events/3931800312","actor":{"login":"calohmn","id":891931,"node_id":"MDQ6VXNlcjg5MTkzMQ==","avatar_url":"https://avatars.githubusercontent.com/u/891931?v=4","gravatar_id":"","url":"https://api.github.com/users/calohmn","html_url":"https://github.com/calohmn","followers_url":"https://api.github.com/users/calohmn/followers","following_url":"https://api.github.com/users/calohmn/following{/other_user}","gists_url":"https://api.github.com/users/calohmn/gists{/gist_id}","starred_url":"https://api.github.com/users/calohmn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calohmn/subscriptions","organizations_url":"https://api.github.com/users/calohmn/orgs","repos_url":"https://api.github.com/users/calohmn/repos","events_url":"https://api.github.com/users/calohmn/events{/privacy}","received_events_url":"https://api.github.com/users/calohmn/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2020-10-28T15:09:23Z","label":{"name":"enhancement","color":"84b6eb"},"performed_via_github_app":null},{"id":3931800314,"node_id":"MDEyOkxhYmVsZWRFdmVudDM5MzE4MDAzMTQ=","url":"https://api.github.com/repos/eclipse-hono/hono/issues/events/3931800314","actor":{"login":"calohmn","id":891931,"node_id":"MDQ6VXNlcjg5MTkzMQ==","avatar_url":"https://avatars.githubusercontent.com/u/891931?v=4","gravatar_id":"","url":"https://api.github.com/users/calohmn","html_url":"https://github.com/calohmn","followers_url":"https://api.github.com/users/calohmn/followers","following_url":"https://api.github.com/users/calohmn/following{/other_user}","gists_url":"https://api.github.com/users/calohmn/gists{/gist_id}","starred_url":"https://api.github.com/users/calohmn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calohmn/subscriptions","organizations_url":"https://api.github.com/users/calohmn/orgs","repos_url":"https://api.github.com/users/calohmn/repos","events_url":"https://api.github.com/users/calohmn/events{/privacy}","received_events_url":"https://api.github.com/users/calohmn/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2020-10-28T15:09:23Z","label":{"name":"C&C","color":"2dbc83"},"performed_via_github_app":null},{"url":"https://api.github.com/repos/eclipse-hono/hono/issues/comments/718418108","html_url":"https://github.com/eclipse-hono/hono/issues/2273#issuecomment-718418108","issue_url":"https://api.github.com/repos/eclipse-hono/hono/issues/2273","id":718418108,"node_id":"MDEyOklzc3VlQ29tbWVudDcxODQxODEwOA==","user":{"login":"calohmn","id":891931,"node_id":"MDQ6VXNlcjg5MTkzMQ==","avatar_url":"https://avatars.githubusercontent.com/u/891931?v=4","gravatar_id":"","url":"https://api.github.com/users/calohmn","html_url":"https://github.com/calohmn","followers_url":"https://api.github.com/users/calohmn/followers","following_url":"https://api.github.com/users/calohmn/following{/other_user}","gists_url":"https://api.github.com/users/calohmn/gists{/gist_id}","starred_url":"https://api.github.com/users/calohmn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calohmn/subscriptions","organizations_url":"https://api.github.com/users/calohmn/orgs","repos_url":"https://api.github.com/users/calohmn/repos","events_url":"https://api.github.com/users/calohmn/events{/privacy}","received_events_url":"https://api.github.com/users/calohmn/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2020-10-29T07:25:13Z","updated_at":"2020-11-19T09:48:47Z","body":"General notes and possible approaches:\r\n\r\n### Topics to be used by northbound applications\r\n\r\nThe general idea is for northbound applications to publish command messages on a Kafka topic and to receive command response messages by subscribing to a Kafka topic. In order for applications to only be able to publish/receive command (response) messages for their specific tenant, the topic names should contain the tenant identifier, so that corresponding ACLs can be put in place in Kafka. This could mean using **`command-$tenantId`** as topic for sending commands and **`command_response-$tenantId`** for receiving command responses. For these topics, the device identifier would be used as partition key to ensure correct ordering of messages related to one specific device.\r\n\r\n### Command acknowledgements\r\n\r\nFor the AMQP-based Command & Control API, the outcome of sending a command message was indicated back to the sending application by means of AMQP delivery states. As when using Kafka, there is no such protocol-provided acknowledgement mechanism, the question is whether or how to support acknowledgements then.\r\n\r\nEither:\r\n\r\n- Don't support (technical-level) command acknowledgements: applications will no longer know whether commands were actually forwarded to or even acknowledged by the target device (depending on device protocol). Applications will then have to use application-level mechanisms to find out, whether a command has reached the device. Usually that would mean requiring a command response message from the device.\r\n\r\n- Or mimic/implement technical-level command acknowledgements by letting the protocol adapters publish corresponding messages on a topic like `command_ack-$tenantId`, which the northbound application will have to subscribe to. For commands, for which a reply is expected, this would probably not offer much benefit. And for the case of one-way commands, where the application wants an acknowledgement, the alternative would be to just use a command that requests a command response from the device instead.\r\n\r\n## Alternatives for routing command messages\r\n\r\n### 1. Receiving commands on all protocol adapters (that have subscriptions for command tenant)\r\n\r\n![CommandsKafka_direct](https://user-images.githubusercontent.com/891931/97456965-9cd58000-1939-11eb-89f6-ac9161ec2d15.png)\r\n\r\nLet _each_ protocol adapter (with a command subscription for some device of tenant X) consume _each_ command (targeted at _any_ device of tenant X) directly. Let each adapter then decide whether it should handle or ignore the command, by checking its local command subscriptions, mapping the device of the command to a gateway if needed.\r\n\r\n<details>\r\n<summary>Implementation considerations (click to expand)</summary>\r\n\r\n- Each adapter instance keeps one Kafka consumer group with up to $partitionCount consumers (each in a vert.x verticle). Received commands will be forwarded on the vert.x event bus and received/handled by the verticles in which the command subscription from the device is handled. (Without the vert.x event bus indirection, each command subscription verticle would need its own Kafka consumer group.)\r\n\r\n- The consumers in the consumer group have subscriptions for all relevant `command-$tenant` topics, corresponding to the connected devices.\r\n\r\nIntuitively, one could think that a protocol adapter might choose to target only the partitions for the `command-$tenant` consumer that correspond to the devices that the adapter has subscriptions for. But that wouldn't work if a gateway is involved (the adapter would have to take all possible devices behind the gateway into account and choose the corresponding partitions).\r\n\r\n</details>\r\nEvaluation:\r\n\r\n- :+1: Simple design, no extra component, probably straightforward to implement\r\n- :+1: No extra Kafka topics just for message routing\r\n- :-1: More adapters → more traffic overhead, more consumer groups: Each command for a specific tenant needs to be sent to **all** protocol adapters that have received a command subscription for any device of that tenant. That means: the more protocol adapters, the more potential traffic overhead. BUT: for a limited number of protocol adapters this could be still acceptable, also with the heavy batching that Kafka does.\r\n- :warning: Behaviour change towards current API: If multiple gateways of a device are subscribed at the same time, a command will get sent to **all** of them, not just to one. Also the lastKnownGateway information can't be used here.\r\nA similar behaviour change exists, when a gateway has both a wildcard subscription (for all its devices) and a specific device subscription. With the above approach the command gets sent on both channels, whereas currently in Hono 1.4 only the device-specific subscription would be served.\r\n\r\n### 2. CommandRouter receives commands first and routes them to target protocol adapter\r\n\r\n![CommandsKafka_CommandRouter](https://user-images.githubusercontent.com/891931/97462716-4f5c1180-193f-11eb-940b-434b9c17c39e.png)\r\n\r\nCommands are received by a new CommandRouting component which manages the mappings of device id and the id of the adapter instance with a command subscription for that device.\r\nEach received command is mapped to the adapter instance and published on the `cmd_internal-$adapterInstanceId` topic. The target protocol adapter will then consume/handle the message.\r\n\r\n- :+1: Design in accordance to [CommandRouting component design](https://github.com/eclipse/hono/issues/2029) already made for usage with the AMQP messaging network.\r\n- :-1: Extra CommandRouting component needed.\r\n- :-1: Extra Kafka topics just for message routing needed.\r\n- :-1: Code overhead: Both adapters *and* CommandRouting component need both AMQP *and* Kafka C&C implementations.\r\n\r\n<details>\r\n<summary>Alternatives concerning the key-value store (click to expand)</summary>\r\n\r\n* Using external key-value store (as now already for the device connection API)\r\n* Integrating key-value store in CommandRouting component instances, building a cluster and an Infinispan distributed cache among them\r\n  * problem: without external persistence, lastKnownGateway entries would be gone when all CommandRoutingComponent instances are down\r\n* Using Kafka Streams in the component and storing the \"device → adapterInstance\" mapping in a KTable\r\n  * Less operational overhead, since no additional Cache (Infinispan or similar) must be operated and Kafka will be there anyway\r\n  * KTables are persistent, so a restart of CommandRouter (or even Kafka) is not a problem\r\n  * Potential risk for additional effort: Kafka Streams client possibly can't be integrated well into vert.x application (vert.x needed because of necessary device registry access). That means either a non-vert.x based AMQP client needs to be used or the device registry needs to be accessed via another protocol (e.g. HTTP)\r\n</details>\r\n\r\n### 3. Adapters perform command routing if needed\r\n\r\n![CommandsKafka_AdaptersAlsoRouters](https://user-images.githubusercontent.com/891931/97537896-d224b100-19bf-11eb-8625-8dfb47bf25da.png)\r\n\r\n**A one-to-one adaptation of the current (as of Hono 1.4) AMQP Command&Control handling:**\r\nOnly _one_ protocol adapter initially consumes a `command-$tenant` topic message (because of shared consumer group). Adapter maps command to gateway and target adapter instance and either handles it itself or publishes it on the `cmd_internal-$adapterInstanceId` topic (see approach 2).\r\n\r\n- :+1: No separate CommandRouting component needed, that means also not much code overhead for supporting both AMQP and Kafka since logic is only in the adapters.\r\n- :+1: Least amount of traffic overhead.\r\n- :-1: Extra Kafka topics just for message routing needed.\r\n- :-1: Extra Kafka/broker connections needed for protocol adapter `cmd_internal-$adapterInstance` consumers (need to be in their own consumer group, not in the shared one across protocol adapters). Probably only relevant for large number of protocol adapters.\r\n- :-1: The reasons that led to developing the AMQP CommandRouter design: Added complexity for protocol adapter implementations, somewhat unintuitive command flow, custom protocol adapter issues could reflect on command handling of other adapters. (With diminishing focus on custom protocol adapters, this could be reevaluated though.)\r\n\r\n### 4. Receiving commands on separate component which the adapters connect to (via AMQP)\r\n\r\n_**EDIT**: [updated version below](https://github.com/eclipse/hono/issues/2273#issuecomment-718826207)._\r\n\r\n![CommandsKafka_CommandForwarder](https://user-images.githubusercontent.com/891931/97534915-1792af80-19bb-11eb-843c-ac7e06c3a888.png)\r\n\r\nA new CommandForwarder (name chosen to separate it from the above CommandRouter concept) component receives all commands first and then forwards them via AMQP to the one corresponding protocol adapter instance registered via the Device Connection service.\r\n\r\n<details>\r\n<summary>Detailed description (click to expand)</summary>\r\n\r\nAll CommandForwarder instances receive all commands, each instance representing a Kafka consumer group.\r\n\r\nWhen a device subscribes for commands, the corresponding protocol adapter will make sure it has a command receiver AMQP link to one random CommandForwarder instance. The protocol adapter then registers the \"device id → adapter instance\" mapping with the device connection service. Basically, the protocol adapter behaves like with the current AMQP C&C implementation, treating the CommandForwarder as its AMQP messaging network peer (only the \"command/$tenantId\" links from the adapters aren't needed here).\r\n\r\nAn incoming command in the CommandForwarder will trigger a check with the device connection service to find the target adapter instance. Then: Either the CommandForwarder instance has a link to that adapter instance, so that it will forward the command on that link, or it doesn't have such a link, ignoring the command message and relying on the fact that another CommandForwarder instance (the one with the matching link) will have forwarded the command message.\r\n\r\n(This approach could even be adopted for the AMQP C&C implementation: The AMQP messaging network needs to use multicast for the \"command/$tenantId\" then. Since Qdrouter 1.9, this may be viable also regarding delivery outcome handling (see [DISPATCH-1266](https://issues.apache.org/jira/browse/DISPATCH-1266))).\r\n\r\n</details>\r\nEvaluation:\r\n\r\n- :+1: Direct command message flow (no hop back to Kafka).\r\n- :+1: No extra Kafka routing topics.\r\n- :+1: Protocol adapter logic can be almost completely left as is (Hono 1.4), being agnostic of whether Kafka or an AMQP messaging network is used (only \"command/$tenantId\" AMQP links aren't needed with Kafka). If adopting this concept also for AMQP, it would be 100% the same.\r\n- :-1: Some traffic overhead when increasing the number of CommandForwarder instances (all commands need to reach all Forwarder instances).\r\n- :-1: Some overhead in DeviceConnection service requests with increased number of CommandForwarder instances.","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/eclipse-hono/hono/issues/comments/718418108/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"calohmn","id":891931,"node_id":"MDQ6VXNlcjg5MTkzMQ==","avatar_url":"https://avatars.githubusercontent.com/u/891931?v=4","gravatar_id":"","url":"https://api.github.com/users/calohmn","html_url":"https://github.com/calohmn","followers_url":"https://api.github.com/users/calohmn/followers","following_url":"https://api.github.com/users/calohmn/following{/other_user}","gists_url":"https://api.github.com/users/calohmn/gists{/gist_id}","starred_url":"https://api.github.com/users/calohmn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calohmn/subscriptions","organizations_url":"https://api.github.com/users/calohmn/orgs","repos_url":"https://api.github.com/users/calohmn/repos","events_url":"https://api.github.com/users/calohmn/events{/privacy}","received_events_url":"https://api.github.com/users/calohmn/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/eclipse-hono/hono/issues/comments/718466224","html_url":"https://github.com/eclipse-hono/hono/issues/2273#issuecomment-718466224","issue_url":"https://api.github.com/repos/eclipse-hono/hono/issues/2273","id":718466224,"node_id":"MDEyOklzc3VlQ29tbWVudDcxODQ2NjIyNA==","user":{"login":"sophokles73","id":5682135,"node_id":"MDQ6VXNlcjU2ODIxMzU=","avatar_url":"https://avatars.githubusercontent.com/u/5682135?v=4","gravatar_id":"","url":"https://api.github.com/users/sophokles73","html_url":"https://github.com/sophokles73","followers_url":"https://api.github.com/users/sophokles73/followers","following_url":"https://api.github.com/users/sophokles73/following{/other_user}","gists_url":"https://api.github.com/users/sophokles73/gists{/gist_id}","starred_url":"https://api.github.com/users/sophokles73/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sophokles73/subscriptions","organizations_url":"https://api.github.com/users/sophokles73/orgs","repos_url":"https://api.github.com/users/sophokles73/repos","events_url":"https://api.github.com/users/sophokles73/events{/privacy}","received_events_url":"https://api.github.com/users/sophokles73/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2020-10-29T08:17:53Z","updated_at":"2020-10-29T08:17:53Z","body":"Thanks for the detailed overview of options :+1: IMHO option 4 looks most promising as it reduces complexity in the adapters and is mostly compliant with #2029. In fact, I do not see why we would still need a separate Device Connection Service in this case. Couldn't that be part of the Command Forwarder as proposed in #2029 (where the component is called *Command Routing Service*)?","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/eclipse-hono/hono/issues/comments/718466224/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"sophokles73","id":5682135,"node_id":"MDQ6VXNlcjU2ODIxMzU=","avatar_url":"https://avatars.githubusercontent.com/u/5682135?v=4","gravatar_id":"","url":"https://api.github.com/users/sophokles73","html_url":"https://github.com/sophokles73","followers_url":"https://api.github.com/users/sophokles73/followers","following_url":"https://api.github.com/users/sophokles73/following{/other_user}","gists_url":"https://api.github.com/users/sophokles73/gists{/gist_id}","starred_url":"https://api.github.com/users/sophokles73/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sophokles73/subscriptions","organizations_url":"https://api.github.com/users/sophokles73/orgs","repos_url":"https://api.github.com/users/sophokles73/repos","events_url":"https://api.github.com/users/sophokles73/events{/privacy}","received_events_url":"https://api.github.com/users/sophokles73/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/eclipse-hono/hono/issues/comments/718558117","html_url":"https://github.com/eclipse-hono/hono/issues/2273#issuecomment-718558117","issue_url":"https://api.github.com/repos/eclipse-hono/hono/issues/2273","id":718558117,"node_id":"MDEyOklzc3VlQ29tbWVudDcxODU1ODExNw==","user":{"login":"calohmn","id":891931,"node_id":"MDQ6VXNlcjg5MTkzMQ==","avatar_url":"https://avatars.githubusercontent.com/u/891931?v=4","gravatar_id":"","url":"https://api.github.com/users/calohmn","html_url":"https://github.com/calohmn","followers_url":"https://api.github.com/users/calohmn/followers","following_url":"https://api.github.com/users/calohmn/following{/other_user}","gists_url":"https://api.github.com/users/calohmn/gists{/gist_id}","starred_url":"https://api.github.com/users/calohmn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calohmn/subscriptions","organizations_url":"https://api.github.com/users/calohmn/orgs","repos_url":"https://api.github.com/users/calohmn/repos","events_url":"https://api.github.com/users/calohmn/events{/privacy}","received_events_url":"https://api.github.com/users/calohmn/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2020-10-29T09:45:33Z","updated_at":"2020-10-29T09:45:33Z","body":"@sophokles73 Yes, the design of option 4 above would just be the first, \"least implementation effort\" approach (also making use of the optimized HotRod-based DeviceConnection client). \r\n\r\nDeveloping this further, it can really be just one component and we can tweak the Command Routing service design of #2029 in that direction (with emphasis on the fact that routing doesn't involve forwarding back to Qdrouter/Kafka here).\r\nIn fact, the bottom image of https://github.com/eclipse/hono/issues/2029#issuecomment-643321500 (\"Variation\") is already close:\r\nFor the AMQP messaging network approach we would just require **multicast** message routing for the `command/$tenantId` address, so that commands don't need to be transferred from one CommandRouter instance to the other. Looking at the [Qdrouter docs](https://qpid.apache.org/releases/qpid-dispatch-1.14.0/user-guide/index.html#message-settlement-reliability-message-routing-qdr), I think using multicast shouldn't be a problem with regard to the disposition update to be sent back to the northbound application in case of AMQP C&C (behaviour was [fixed](https://issues.apache.org/jira/browse/DISPATCH-1266) with Qdrouter 1.9 one year ago).","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/eclipse-hono/hono/issues/comments/718558117/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"calohmn","id":891931,"node_id":"MDQ6VXNlcjg5MTkzMQ==","avatar_url":"https://avatars.githubusercontent.com/u/891931?v=4","gravatar_id":"","url":"https://api.github.com/users/calohmn","html_url":"https://github.com/calohmn","followers_url":"https://api.github.com/users/calohmn/followers","following_url":"https://api.github.com/users/calohmn/following{/other_user}","gists_url":"https://api.github.com/users/calohmn/gists{/gist_id}","starred_url":"https://api.github.com/users/calohmn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calohmn/subscriptions","organizations_url":"https://api.github.com/users/calohmn/orgs","repos_url":"https://api.github.com/users/calohmn/repos","events_url":"https://api.github.com/users/calohmn/events{/privacy}","received_events_url":"https://api.github.com/users/calohmn/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":3935368523,"node_id":"MDE0Ok1lbnRpb25lZEV2ZW50MzkzNTM2ODUyMw==","url":"https://api.github.com/repos/eclipse-hono/hono/issues/events/3935368523","actor":{"login":"sophokles73","id":5682135,"node_id":"MDQ6VXNlcjU2ODIxMzU=","avatar_url":"https://avatars.githubusercontent.com/u/5682135?v=4","gravatar_id":"","url":"https://api.github.com/users/sophokles73","html_url":"https://github.com/sophokles73","followers_url":"https://api.github.com/users/sophokles73/followers","following_url":"https://api.github.com/users/sophokles73/following{/other_user}","gists_url":"https://api.github.com/users/sophokles73/gists{/gist_id}","starred_url":"https://api.github.com/users/sophokles73/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sophokles73/subscriptions","organizations_url":"https://api.github.com/users/sophokles73/orgs","repos_url":"https://api.github.com/users/sophokles73/repos","events_url":"https://api.github.com/users/sophokles73/events{/privacy}","received_events_url":"https://api.github.com/users/sophokles73/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2020-10-29T09:45:34Z","performed_via_github_app":null},{"id":3935368527,"node_id":"MDE1OlN1YnNjcmliZWRFdmVudDM5MzUzNjg1Mjc=","url":"https://api.github.com/repos/eclipse-hono/hono/issues/events/3935368527","actor":{"login":"sophokles73","id":5682135,"node_id":"MDQ6VXNlcjU2ODIxMzU=","avatar_url":"https://avatars.githubusercontent.com/u/5682135?v=4","gravatar_id":"","url":"https://api.github.com/users/sophokles73","html_url":"https://github.com/sophokles73","followers_url":"https://api.github.com/users/sophokles73/followers","following_url":"https://api.github.com/users/sophokles73/following{/other_user}","gists_url":"https://api.github.com/users/sophokles73/gists{/gist_id}","starred_url":"https://api.github.com/users/sophokles73/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sophokles73/subscriptions","organizations_url":"https://api.github.com/users/sophokles73/orgs","repos_url":"https://api.github.com/users/sophokles73/repos","events_url":"https://api.github.com/users/sophokles73/events{/privacy}","received_events_url":"https://api.github.com/users/sophokles73/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2020-10-29T09:45:34Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/eclipse-hono/hono/issues/comments/718752609","html_url":"https://github.com/eclipse-hono/hono/issues/2273#issuecomment-718752609","issue_url":"https://api.github.com/repos/eclipse-hono/hono/issues/2273","id":718752609,"node_id":"MDEyOklzc3VlQ29tbWVudDcxODc1MjYwOQ==","user":{"login":"dejanb","id":141611,"node_id":"MDQ6VXNlcjE0MTYxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/141611?v=4","gravatar_id":"","url":"https://api.github.com/users/dejanb","html_url":"https://github.com/dejanb","followers_url":"https://api.github.com/users/dejanb/followers","following_url":"https://api.github.com/users/dejanb/following{/other_user}","gists_url":"https://api.github.com/users/dejanb/gists{/gist_id}","starred_url":"https://api.github.com/users/dejanb/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dejanb/subscriptions","organizations_url":"https://api.github.com/users/dejanb/orgs","repos_url":"https://api.github.com/users/dejanb/repos","events_url":"https://api.github.com/users/dejanb/events{/privacy}","received_events_url":"https://api.github.com/users/dejanb/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2020-10-29T13:29:05Z","updated_at":"2020-10-29T13:29:05Z","body":"@calohmn thanks for this detailed analysis. On the first read, I also agree that solution 4 is the best next evolution of the current implementation and will align with other improvements already planned (as @sophokles73 pointed out).\r\n\r\nI can see also that we can in the future keep evolving this more towards solution 2. By probably replacing infinispan (caches) with KTable and also if at some point we replace adapter-registry communication from AMQP to HTTP it would make sense to use Kafka for commands in the adapters (as everything else would be HTTP or Kafka in that scenario).\r\n\r\nBut again, if we go for the solution 4 now it doesn't stop us from further considering these changes in the future.","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/eclipse-hono/hono/issues/comments/718752609/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"dejanb","id":141611,"node_id":"MDQ6VXNlcjE0MTYxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/141611?v=4","gravatar_id":"","url":"https://api.github.com/users/dejanb","html_url":"https://github.com/dejanb","followers_url":"https://api.github.com/users/dejanb/followers","following_url":"https://api.github.com/users/dejanb/following{/other_user}","gists_url":"https://api.github.com/users/dejanb/gists{/gist_id}","starred_url":"https://api.github.com/users/dejanb/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dejanb/subscriptions","organizations_url":"https://api.github.com/users/dejanb/orgs","repos_url":"https://api.github.com/users/dejanb/repos","events_url":"https://api.github.com/users/dejanb/events{/privacy}","received_events_url":"https://api.github.com/users/dejanb/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":3936331477,"node_id":"MDE0Ok1lbnRpb25lZEV2ZW50MzkzNjMzMTQ3Nw==","url":"https://api.github.com/repos/eclipse-hono/hono/issues/events/3936331477","actor":{"login":"calohmn","id":891931,"node_id":"MDQ6VXNlcjg5MTkzMQ==","avatar_url":"https://avatars.githubusercontent.com/u/891931?v=4","gravatar_id":"","url":"https://api.github.com/users/calohmn","html_url":"https://github.com/calohmn","followers_url":"https://api.github.com/users/calohmn/followers","following_url":"https://api.github.com/users/calohmn/following{/other_user}","gists_url":"https://api.github.com/users/calohmn/gists{/gist_id}","starred_url":"https://api.github.com/users/calohmn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calohmn/subscriptions","organizations_url":"https://api.github.com/users/calohmn/orgs","repos_url":"https://api.github.com/users/calohmn/repos","events_url":"https://api.github.com/users/calohmn/events{/privacy}","received_events_url":"https://api.github.com/users/calohmn/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2020-10-29T13:29:06Z","performed_via_github_app":null},{"id":3936331482,"node_id":"MDE1OlN1YnNjcmliZWRFdmVudDM5MzYzMzE0ODI=","url":"https://api.github.com/repos/eclipse-hono/hono/issues/events/3936331482","actor":{"login":"calohmn","id":891931,"node_id":"MDQ6VXNlcjg5MTkzMQ==","avatar_url":"https://avatars.githubusercontent.com/u/891931?v=4","gravatar_id":"","url":"https://api.github.com/users/calohmn","html_url":"https://github.com/calohmn","followers_url":"https://api.github.com/users/calohmn/followers","following_url":"https://api.github.com/users/calohmn/following{/other_user}","gists_url":"https://api.github.com/users/calohmn/gists{/gist_id}","starred_url":"https://api.github.com/users/calohmn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calohmn/subscriptions","organizations_url":"https://api.github.com/users/calohmn/orgs","repos_url":"https://api.github.com/users/calohmn/repos","events_url":"https://api.github.com/users/calohmn/events{/privacy}","received_events_url":"https://api.github.com/users/calohmn/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2020-10-29T13:29:06Z","performed_via_github_app":null},{"id":3936331488,"node_id":"MDE0Ok1lbnRpb25lZEV2ZW50MzkzNjMzMTQ4OA==","url":"https://api.github.com/repos/eclipse-hono/hono/issues/events/3936331488","actor":{"login":"sophokles73","id":5682135,"node_id":"MDQ6VXNlcjU2ODIxMzU=","avatar_url":"https://avatars.githubusercontent.com/u/5682135?v=4","gravatar_id":"","url":"https://api.github.com/users/sophokles73","html_url":"https://github.com/sophokles73","followers_url":"https://api.github.com/users/sophokles73/followers","following_url":"https://api.github.com/users/sophokles73/following{/other_user}","gists_url":"https://api.github.com/users/sophokles73/gists{/gist_id}","starred_url":"https://api.github.com/users/sophokles73/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sophokles73/subscriptions","organizations_url":"https://api.github.com/users/sophokles73/orgs","repos_url":"https://api.github.com/users/sophokles73/repos","events_url":"https://api.github.com/users/sophokles73/events{/privacy}","received_events_url":"https://api.github.com/users/sophokles73/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2020-10-29T13:29:06Z","performed_via_github_app":null},{"id":3936331495,"node_id":"MDE1OlN1YnNjcmliZWRFdmVudDM5MzYzMzE0OTU=","url":"https://api.github.com/repos/eclipse-hono/hono/issues/events/3936331495","actor":{"login":"sophokles73","id":5682135,"node_id":"MDQ6VXNlcjU2ODIxMzU=","avatar_url":"https://avatars.githubusercontent.com/u/5682135?v=4","gravatar_id":"","url":"https://api.github.com/users/sophokles73","html_url":"https://github.com/sophokles73","followers_url":"https://api.github.com/users/sophokles73/followers","following_url":"https://api.github.com/users/sophokles73/following{/other_user}","gists_url":"https://api.github.com/users/sophokles73/gists{/gist_id}","starred_url":"https://api.github.com/users/sophokles73/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sophokles73/subscriptions","organizations_url":"https://api.github.com/users/sophokles73/orgs","repos_url":"https://api.github.com/users/sophokles73/repos","events_url":"https://api.github.com/users/sophokles73/events{/privacy}","received_events_url":"https://api.github.com/users/sophokles73/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2020-10-29T13:29:06Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/eclipse-hono/hono/issues/comments/718775859","html_url":"https://github.com/eclipse-hono/hono/issues/2273#issuecomment-718775859","issue_url":"https://api.github.com/repos/eclipse-hono/hono/issues/2273","id":718775859,"node_id":"MDEyOklzc3VlQ29tbWVudDcxODc3NTg1OQ==","user":{"login":"calohmn","id":891931,"node_id":"MDQ6VXNlcjg5MTkzMQ==","avatar_url":"https://avatars.githubusercontent.com/u/891931?v=4","gravatar_id":"","url":"https://api.github.com/users/calohmn","html_url":"https://github.com/calohmn","followers_url":"https://api.github.com/users/calohmn/followers","following_url":"https://api.github.com/users/calohmn/following{/other_user}","gists_url":"https://api.github.com/users/calohmn/gists{/gist_id}","starred_url":"https://api.github.com/users/calohmn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calohmn/subscriptions","organizations_url":"https://api.github.com/users/calohmn/orgs","repos_url":"https://api.github.com/users/calohmn/repos","events_url":"https://api.github.com/users/calohmn/events{/privacy}","received_events_url":"https://api.github.com/users/calohmn/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2020-10-29T14:06:16Z","updated_at":"2020-10-29T14:06:16Z","body":"> I can see also that we can in the future keep evolving this more towards solution 2. By probably replacing infinispan (caches) with KTable [...]\r\n\r\nThe \"Key-Value store\" box drawn in the diagram for solution 2 is something that I left out in the figure for solution 4 (there it's abstracted away by the Device Connection service box). So yes, the different options for such a key-value store apply to solution 4 as well.\r\n\r\n> it would make sense to use Kafka for commands in the adapters [...]\r\n\r\nYou mean in this new CommandRouter component, potentially using Kafka Streams there, right? Yes, that's something I would also see as a potential future optimization.","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/eclipse-hono/hono/issues/comments/718775859/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"calohmn","id":891931,"node_id":"MDQ6VXNlcjg5MTkzMQ==","avatar_url":"https://avatars.githubusercontent.com/u/891931?v=4","gravatar_id":"","url":"https://api.github.com/users/calohmn","html_url":"https://github.com/calohmn","followers_url":"https://api.github.com/users/calohmn/followers","following_url":"https://api.github.com/users/calohmn/following{/other_user}","gists_url":"https://api.github.com/users/calohmn/gists{/gist_id}","starred_url":"https://api.github.com/users/calohmn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calohmn/subscriptions","organizations_url":"https://api.github.com/users/calohmn/orgs","repos_url":"https://api.github.com/users/calohmn/repos","events_url":"https://api.github.com/users/calohmn/events{/privacy}","received_events_url":"https://api.github.com/users/calohmn/received_events","type":"User","user_view_type":"public","site_admin":false}},{"actor":{"login":"calohmn","id":891931,"node_id":"MDQ6VXNlcjg5MTkzMQ==","avatar_url":"https://avatars.githubusercontent.com/u/891931?v=4","gravatar_id":"","url":"https://api.github.com/users/calohmn","html_url":"https://github.com/calohmn","followers_url":"https://api.github.com/users/calohmn/followers","following_url":"https://api.github.com/users/calohmn/following{/other_user}","gists_url":"https://api.github.com/users/calohmn/gists{/gist_id}","starred_url":"https://api.github.com/users/calohmn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calohmn/subscriptions","organizations_url":"https://api.github.com/users/calohmn/orgs","repos_url":"https://api.github.com/users/calohmn/repos","events_url":"https://api.github.com/users/calohmn/events{/privacy}","received_events_url":"https://api.github.com/users/calohmn/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2020-10-29T15:08:04Z","updated_at":"2020-10-29T15:08:04Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/eclipse-hono/hono/issues/2029","repository_url":"https://api.github.com/repos/eclipse-hono/hono","labels_url":"https://api.github.com/repos/eclipse-hono/hono/issues/2029/labels{/name}","comments_url":"https://api.github.com/repos/eclipse-hono/hono/issues/2029/comments","events_url":"https://api.github.com/repos/eclipse-hono/hono/issues/2029/events","html_url":"https://github.com/eclipse-hono/hono/issues/2029","id":636874925,"node_id":"MDU6SXNzdWU2MzY4NzQ5MjU=","number":2029,"title":"Introduce CommandRouting service/component (replacing DeviceConnectionService)","user":{"login":"calohmn","id":891931,"node_id":"MDQ6VXNlcjg5MTkzMQ==","avatar_url":"https://avatars.githubusercontent.com/u/891931?v=4","gravatar_id":"","url":"https://api.github.com/users/calohmn","html_url":"https://github.com/calohmn","followers_url":"https://api.github.com/users/calohmn/followers","following_url":"https://api.github.com/users/calohmn/following{/other_user}","gists_url":"https://api.github.com/users/calohmn/gists{/gist_id}","starred_url":"https://api.github.com/users/calohmn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calohmn/subscriptions","organizations_url":"https://api.github.com/users/calohmn/orgs","repos_url":"https://api.github.com/users/calohmn/repos","events_url":"https://api.github.com/users/calohmn/events{/privacy}","received_events_url":"https://api.github.com/users/calohmn/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":323160608,"node_id":"MDU6TGFiZWwzMjMxNjA2MDg=","url":"https://api.github.com/repos/eclipse-hono/hono/labels/enhancement","name":"enhancement","color":"84b6eb","default":true,"description":null},{"id":947051526,"node_id":"MDU6TGFiZWw5NDcwNTE1MjY=","url":"https://api.github.com/repos/eclipse-hono/hono/labels/C&C","name":"C&C","color":"2dbc83","default":false,"description":"Command and Control"}],"state":"closed","locked":false,"assignee":{"login":"calohmn","id":891931,"node_id":"MDQ6VXNlcjg5MTkzMQ==","avatar_url":"https://avatars.githubusercontent.com/u/891931?v=4","gravatar_id":"","url":"https://api.github.com/users/calohmn","html_url":"https://github.com/calohmn","followers_url":"https://api.github.com/users/calohmn/followers","following_url":"https://api.github.com/users/calohmn/following{/other_user}","gists_url":"https://api.github.com/users/calohmn/gists{/gist_id}","starred_url":"https://api.github.com/users/calohmn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calohmn/subscriptions","organizations_url":"https://api.github.com/users/calohmn/orgs","repos_url":"https://api.github.com/users/calohmn/repos","events_url":"https://api.github.com/users/calohmn/events{/privacy}","received_events_url":"https://api.github.com/users/calohmn/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"calohmn","id":891931,"node_id":"MDQ6VXNlcjg5MTkzMQ==","avatar_url":"https://avatars.githubusercontent.com/u/891931?v=4","gravatar_id":"","url":"https://api.github.com/users/calohmn","html_url":"https://github.com/calohmn","followers_url":"https://api.github.com/users/calohmn/followers","following_url":"https://api.github.com/users/calohmn/following{/other_user}","gists_url":"https://api.github.com/users/calohmn/gists{/gist_id}","starred_url":"https://api.github.com/users/calohmn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calohmn/subscriptions","organizations_url":"https://api.github.com/users/calohmn/orgs","repos_url":"https://api.github.com/users/calohmn/repos","events_url":"https://api.github.com/users/calohmn/events{/privacy}","received_events_url":"https://api.github.com/users/calohmn/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/eclipse-hono/hono/milestones/26","html_url":"https://github.com/eclipse-hono/hono/milestone/26","labels_url":"https://api.github.com/repos/eclipse-hono/hono/milestones/26/labels","id":5863476,"node_id":"MDk6TWlsZXN0b25lNTg2MzQ3Ng==","number":26,"title":"1.5.0","description":"","creator":{"login":"sophokles73","id":5682135,"node_id":"MDQ6VXNlcjU2ODIxMzU=","avatar_url":"https://avatars.githubusercontent.com/u/5682135?v=4","gravatar_id":"","url":"https://api.github.com/users/sophokles73","html_url":"https://github.com/sophokles73","followers_url":"https://api.github.com/users/sophokles73/followers","following_url":"https://api.github.com/users/sophokles73/following{/other_user}","gists_url":"https://api.github.com/users/sophokles73/gists{/gist_id}","starred_url":"https://api.github.com/users/sophokles73/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sophokles73/subscriptions","organizations_url":"https://api.github.com/users/sophokles73/orgs","repos_url":"https://api.github.com/users/sophokles73/repos","events_url":"https://api.github.com/users/sophokles73/events{/privacy}","received_events_url":"https://api.github.com/users/sophokles73/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":153,"state":"closed","created_at":"2020-09-10T11:30:29Z","updated_at":"2020-12-17T10:01:50Z","due_on":"2020-12-16T08:00:00Z","closed_at":"2020-12-17T10:01:50Z"},"comments":9,"created_at":"2020-06-11T09:43:06Z","updated_at":"2020-12-04T10:01:53Z","closed_at":"2020-12-04T10:01:53Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":51307016,"node_id":"MDEwOlJlcG9zaXRvcnk1MTMwNzAxNg==","name":"hono","full_name":"eclipse-hono/hono","private":false,"owner":{"login":"eclipse-hono","id":112081701,"node_id":"O_kgDOBq47JQ","avatar_url":"https://avatars.githubusercontent.com/u/112081701?v=4","gravatar_id":"","url":"https://api.github.com/users/eclipse-hono","html_url":"https://github.com/eclipse-hono","followers_url":"https://api.github.com/users/eclipse-hono/followers","following_url":"https://api.github.com/users/eclipse-hono/following{/other_user}","gists_url":"https://api.github.com/users/eclipse-hono/gists{/gist_id}","starred_url":"https://api.github.com/users/eclipse-hono/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eclipse-hono/subscriptions","organizations_url":"https://api.github.com/users/eclipse-hono/orgs","repos_url":"https://api.github.com/users/eclipse-hono/repos","events_url":"https://api.github.com/users/eclipse-hono/events{/privacy}","received_events_url":"https://api.github.com/users/eclipse-hono/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/eclipse-hono/hono","description":"Eclipse Hono™ Project","fork":false,"url":"https://api.github.com/repos/eclipse-hono/hono","forks_url":"https://api.github.com/repos/eclipse-hono/hono/forks","keys_url":"https://api.github.com/repos/eclipse-hono/hono/keys{/key_id}","collaborators_url":"https://api.github.com/repos/eclipse-hono/hono/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/eclipse-hono/hono/teams","hooks_url":"https://api.github.com/repos/eclipse-hono/hono/hooks","issue_events_url":"https://api.github.com/repos/eclipse-hono/hono/issues/events{/number}","events_url":"https://api.github.com/repos/eclipse-hono/hono/events","assignees_url":"https://api.github.com/repos/eclipse-hono/hono/assignees{/user}","branches_url":"https://api.github.com/repos/eclipse-hono/hono/branches{/branch}","tags_url":"https://api.github.com/repos/eclipse-hono/hono/tags","blobs_url":"https://api.github.com/repos/eclipse-hono/hono/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/eclipse-hono/hono/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/eclipse-hono/hono/git/refs{/sha}","trees_url":"https://api.github.com/repos/eclipse-hono/hono/git/trees{/sha}","statuses_url":"https://api.github.com/repos/eclipse-hono/hono/statuses/{sha}","languages_url":"https://api.github.com/repos/eclipse-hono/hono/languages","stargazers_url":"https://api.github.com/repos/eclipse-hono/hono/stargazers","contributors_url":"https://api.github.com/repos/eclipse-hono/hono/contributors","subscribers_url":"https://api.github.com/repos/eclipse-hono/hono/subscribers","subscription_url":"https://api.github.com/repos/eclipse-hono/hono/subscription","commits_url":"https://api.github.com/repos/eclipse-hono/hono/commits{/sha}","git_commits_url":"https://api.github.com/repos/eclipse-hono/hono/git/commits{/sha}","comments_url":"https://api.github.com/repos/eclipse-hono/hono/comments{/number}","issue_comment_url":"https://api.github.com/repos/eclipse-hono/hono/issues/comments{/number}","contents_url":"https://api.github.com/repos/eclipse-hono/hono/contents/{+path}","compare_url":"https://api.github.com/repos/eclipse-hono/hono/compare/{base}...{head}","merges_url":"https://api.github.com/repos/eclipse-hono/hono/merges","archive_url":"https://api.github.com/repos/eclipse-hono/hono/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/eclipse-hono/hono/downloads","issues_url":"https://api.github.com/repos/eclipse-hono/hono/issues{/number}","pulls_url":"https://api.github.com/repos/eclipse-hono/hono/pulls{/number}","milestones_url":"https://api.github.com/repos/eclipse-hono/hono/milestones{/number}","notifications_url":"https://api.github.com/repos/eclipse-hono/hono/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/eclipse-hono/hono/labels{/name}","releases_url":"https://api.github.com/repos/eclipse-hono/hono/releases{/id}","deployments_url":"https://api.github.com/repos/eclipse-hono/hono/deployments","created_at":"2016-02-08T15:45:28Z","updated_at":"2025-11-04T15:48:55Z","pushed_at":"2025-11-07T14:00:09Z","git_url":"git://github.com/eclipse-hono/hono.git","ssh_url":"git@github.com:eclipse-hono/hono.git","clone_url":"https://github.com/eclipse-hono/hono.git","svn_url":"https://github.com/eclipse-hono/hono","homepage":"https://eclipse.dev/hono","size":51799,"stargazers_count":476,"watchers_count":476,"language":"Java","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":true,"has_pages":false,"has_discussions":false,"forks_count":139,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":115,"license":{"key":"epl-2.0","name":"Eclipse Public License 2.0","spdx_id":"EPL-2.0","url":"https://api.github.com/licenses/epl-2.0","node_id":"MDc6TGljZW5zZTMy"},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["eclipseiot","internet-of-things","messaging"],"visibility":"public","forks":139,"open_issues":115,"watchers":476,"default_branch":"master","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"The current Command & Control implementation uses tenant scoped `command/[tenantId]` links to initially receive commands from a downstream application. After having received a command message on that link, the protocol adapter instance that the command target device is connected to is being identified and the command is sent/routed to that adapter instance.\r\n\r\nCurrently, each adapter supports these tenant-scoped links and the corresponding routing logic.\r\n\r\nThis means added complexity for protocol adapter implementations and makes command processing also somewhat unintuitive (a command may be received first by an AMQP adapter and then routed to an MQTT adapter for example).\r\nIt also means that potential issues in a custom protocol adapter could have consequences for commands directed at one of the standard Hono protocol adapters (if these command messages are received by the custom protocol adapter first).\r\n\r\nThis all leads to the idea of introducing a separate component that will first receive **all** command messages and then route them to the appropriate protocol adapter instance.\r\nSuch a `CommandRouting` component could then include also the implementation of the current `DeviceConnectionService`. That means that the `CommandRouting` implementation has the service to identify the target protocol adapter instance of a command message right inside its own component. Thinking further along this line, we can just as well replace the `DeviceConnectionService` with the `CommandRouting` service.\r\n\r\nOperations of the new `CommandRouting` service (to be used by the protocol adapters):\r\n- `setLastKnownGatewayForDevice(tenant, device, gateway)`\r\n- `registerCommandConsumer(tenant, device, consumerId, lifespan)`\r\n- `unregisterCommandConsumer(tenant, device, consumerId)`\r\n\r\n(~~`consumerId` here means the same as what was called `adapterInstanceId` in the *DeviceConnectionAPI*; `adapterInstanceId` was a bit misleading, as there are usually multiple such consumers per adapter instance, corresponding to the number of vert.x verticle instances~~ EDIT: using `adapterInstanceId` is probably more appropriate since we want to keep the number of related resources (e.g. Kafka topics) low. That requires mapping incoming commands to the vert.x verticles (via vert.x event bus), though.)\r\n\r\nFor #1276, this method will probably be needed as well:\r\n- `registerCommandConsumer(tenant, device, correlationId, consumerId, lifespan)`\r\n\r\nThe `AdapterInstancesLivenessService` (#2028) will then also be incorporated into the `CommandRouting` service. For that, an additional, optional operation could be added:\r\n- `ping(consumerId)`\r\n\r\nThis would then be used by custom protocol adapters that are not in the same kubernetes cluster as the other adapters and the `CommandRouting` component.\r\n","reactions":{"url":"https://api.github.com/repos/eclipse-hono/hono/issues/2029/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/eclipse-hono/hono/issues/2029/timeline","performed_via_github_app":null,"state_reason":"completed"}},"event":"cross-referenced"},{"url":"https://api.github.com/repos/eclipse-hono/hono/issues/comments/718826207","html_url":"https://github.com/eclipse-hono/hono/issues/2273#issuecomment-718826207","issue_url":"https://api.github.com/repos/eclipse-hono/hono/issues/2273","id":718826207,"node_id":"MDEyOklzc3VlQ29tbWVudDcxODgyNjIwNw==","user":{"login":"calohmn","id":891931,"node_id":"MDQ6VXNlcjg5MTkzMQ==","avatar_url":"https://avatars.githubusercontent.com/u/891931?v=4","gravatar_id":"","url":"https://api.github.com/users/calohmn","html_url":"https://github.com/calohmn","followers_url":"https://api.github.com/users/calohmn/followers","following_url":"https://api.github.com/users/calohmn/following{/other_user}","gists_url":"https://api.github.com/users/calohmn/gists{/gist_id}","starred_url":"https://api.github.com/users/calohmn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calohmn/subscriptions","organizations_url":"https://api.github.com/users/calohmn/orgs","repos_url":"https://api.github.com/users/calohmn/repos","events_url":"https://api.github.com/users/calohmn/events{/privacy}","received_events_url":"https://api.github.com/users/calohmn/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2020-10-29T15:23:06Z","updated_at":"2021-01-05T10:38:44Z","body":"I also think that solution 4 looks like the best alternative. Here's an updated version of it. I've also updated the AMQP messaging network based design in #2029.\r\n\r\n### 4. CommandRouter receives commands first and routes them directly to target protocol adapter using AMQP\r\n\r\n![CommandsKafka_CommandRouter2](https://user-images.githubusercontent.com/891931/97594313-d920e300-1a02-11eb-8cc4-4dc0ffe992f9.png)\r\n\r\nA new CommandRouter component receives all commands first and then forwards them via AMQP to the one corresponding protocol adapter instance, that has registered itself for the device id of the command.\r\n\r\n<details>\r\n<summary>Detailed description (click to expand)</summary>\r\n\r\nAll CommandRouter instances receive all commands, each instance representing a Kafka consumer group.\r\n\r\nWhen a device subscribes for commands, the corresponding protocol adapter will make sure it has a command receiver AMQP link to one random CommandRouter instance. The protocol adapter then registers itself (i.e. its consumer) together with the device id of the subscription using the new CommandRouting API method `registerCommandConsumer(deviceId, consumerId)` (#2029).\r\n\r\nAn incoming command in the CommandRouter will trigger a check with the stored \"device id → consumer id\" mapping to find the target adapter instance consumer. Then: Either the CommandRouter instance has a link to that adapter instance consumer, so that it will forward the command on that link, or it doesn't have such a link, ignoring the command message and relying on the fact that another CommandRouter instance (the one with the matching link) will have forwarded the command message.\r\n\r\n</details>\r\nEvaluation:\r\n\r\n- :+1: Design in accordance to [updated CommandRouting component design](https://github.com/eclipse/hono/issues/2029#issuecomment-718816290) for usage with the AMQP messaging network.\r\n- :+1: Direct command message flow (no hop back to Kafka).\r\n- :+1: When AMQP messaging network based C&C has been refactored according to #2029, the protocol adapter logic will most probably be 100% the same for use with Kafka and the AMQP messaging network. Only difference is in the CommandRouting component implementation.\r\n- :+1: No extra Kafka routing topics.\r\n- :-1: Extra CommandRouting component needed.\r\n- :-1: Some traffic overhead when increasing the number of CommandRouter instances (all commands need to reach all Forwarder instances).\r\n- :-1: Some overhead in DeviceConnection service requests with increased number of CommandRouter instances.\r\n- :-1: Could lead to some messages getting delivered twice or not at all if a device reconnects and re-subscribes (see comments below)\r\n\r\n<details>\r\n<summary>Alternatives concerning the key-value store (click to expand)</summary>\r\n\r\n* Using external key-value store (as now already for the device connection API)\r\n* Integrating key-value store in CommandRouting component instances, building a cluster and an Infinispan distributed cache among them\r\n  * problem: without external persistence, lastKnownGateway entries would be gone when all CommandRoutingComponent instances are down (the \"device → adapterInstance\" mapping could maybe be restored on demand by the adapters)\r\n* Using Kafka Streams in the component and storing the \"device → adapterInstance\" mapping in a KTable\r\n  * Less operational overhead, since no additional Cache (Infinispan or similar) must be operated and Kafka will be there anyway\r\n  * KTables are persistent, so a restart of CommandRouter (or even Kafka) is not a problem\r\n  * Potential risk for additional effort: Kafka Streams client possibly can't be integrated well into vert.x application (vert.x needed because of necessary device registry access). That means either a non-vert.x based AMQP client needs to be used or the device registry needs to be accessed via another protocol (e.g. HTTP)\r\n</details>\r\n","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/eclipse-hono/hono/issues/comments/718826207/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"calohmn","id":891931,"node_id":"MDQ6VXNlcjg5MTkzMQ==","avatar_url":"https://avatars.githubusercontent.com/u/891931?v=4","gravatar_id":"","url":"https://api.github.com/users/calohmn","html_url":"https://github.com/calohmn","followers_url":"https://api.github.com/users/calohmn/followers","following_url":"https://api.github.com/users/calohmn/following{/other_user}","gists_url":"https://api.github.com/users/calohmn/gists{/gist_id}","starred_url":"https://api.github.com/users/calohmn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calohmn/subscriptions","organizations_url":"https://api.github.com/users/calohmn/orgs","repos_url":"https://api.github.com/users/calohmn/repos","events_url":"https://api.github.com/users/calohmn/events{/privacy}","received_events_url":"https://api.github.com/users/calohmn/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/eclipse-hono/hono/issues/comments/718847274","html_url":"https://github.com/eclipse-hono/hono/issues/2273#issuecomment-718847274","issue_url":"https://api.github.com/repos/eclipse-hono/hono/issues/2273","id":718847274,"node_id":"MDEyOklzc3VlQ29tbWVudDcxODg0NzI3NA==","user":{"login":"dejanb","id":141611,"node_id":"MDQ6VXNlcjE0MTYxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/141611?v=4","gravatar_id":"","url":"https://api.github.com/users/dejanb","html_url":"https://github.com/dejanb","followers_url":"https://api.github.com/users/dejanb/followers","following_url":"https://api.github.com/users/dejanb/following{/other_user}","gists_url":"https://api.github.com/users/dejanb/gists{/gist_id}","starred_url":"https://api.github.com/users/dejanb/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dejanb/subscriptions","organizations_url":"https://api.github.com/users/dejanb/orgs","repos_url":"https://api.github.com/users/dejanb/repos","events_url":"https://api.github.com/users/dejanb/events{/privacy}","received_events_url":"https://api.github.com/users/dejanb/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2020-10-29T15:54:40Z","updated_at":"2020-10-29T15:54:40Z","body":"Looks good to me.","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/eclipse-hono/hono/issues/comments/718847274/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"dejanb","id":141611,"node_id":"MDQ6VXNlcjE0MTYxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/141611?v=4","gravatar_id":"","url":"https://api.github.com/users/dejanb","html_url":"https://github.com/dejanb","followers_url":"https://api.github.com/users/dejanb/followers","following_url":"https://api.github.com/users/dejanb/following{/other_user}","gists_url":"https://api.github.com/users/dejanb/gists{/gist_id}","starred_url":"https://api.github.com/users/dejanb/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dejanb/subscriptions","organizations_url":"https://api.github.com/users/dejanb/orgs","repos_url":"https://api.github.com/users/dejanb/repos","events_url":"https://api.github.com/users/dejanb/events{/privacy}","received_events_url":"https://api.github.com/users/dejanb/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/eclipse-hono/hono/issues/comments/719383866","html_url":"https://github.com/eclipse-hono/hono/issues/2273#issuecomment-719383866","issue_url":"https://api.github.com/repos/eclipse-hono/hono/issues/2273","id":719383866,"node_id":"MDEyOklzc3VlQ29tbWVudDcxOTM4Mzg2Ng==","user":{"login":"calohmn","id":891931,"node_id":"MDQ6VXNlcjg5MTkzMQ==","avatar_url":"https://avatars.githubusercontent.com/u/891931?v=4","gravatar_id":"","url":"https://api.github.com/users/calohmn","html_url":"https://github.com/calohmn","followers_url":"https://api.github.com/users/calohmn/followers","following_url":"https://api.github.com/users/calohmn/following{/other_user}","gists_url":"https://api.github.com/users/calohmn/gists{/gist_id}","starred_url":"https://api.github.com/users/calohmn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calohmn/subscriptions","organizations_url":"https://api.github.com/users/calohmn/orgs","repos_url":"https://api.github.com/users/calohmn/repos","events_url":"https://api.github.com/users/calohmn/events{/privacy}","received_events_url":"https://api.github.com/users/calohmn/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2020-10-30T08:02:46Z","updated_at":"2020-11-02T07:52:09Z","body":"About the usage of multiple `command-$tenant` consumer groups (one group per CommandRouter instance) in solution 4:\r\n\r\nI'm wondering whether this could lead to a message getting delivered twice if a device reconnects and re-subscribes.\r\n\r\nLet's say a device is connected to adapter A which in turn is connected with CommandRouter X. A high rate of commands flows down that path to the device.\r\nNow the device disconnects and reconnects (and re-subscribes) this time to adapter B which is connected to CommandRouter Y.\r\nCommandRouter Y could have been put under pressure somehow and could be slower in processing the incoming commands (reading is done independently to Router X because of different consumer groups). This could mean that messages arrive at CommandRouter Y now which have already been received by CommandRouter X earlier. I could imagine, that this could lead to the same command messages getting delivered to the device twice.\r\n\r\nAs a solution I currently only see forcing all CommandRouter instances to use the same, single consumer group to read from the `command-$tenant` topic (EDIT: other idea for a fix given [below](https://github.com/eclipse/hono/issues/2273#issuecomment-720301419)).\r\nThe problem of transferring a command from one CommandRouter instance to another, in case the target protocol adapter is connected to that other instance, could be solved by letting all CommandRouter instances be part of a cluster (Infinispan/Hazelcast). Then messages could be forwarded using the clustered vert.x event bus for example.\r\nI originally thought to maybe rather avoid this, sticking to Kafka/AMQP messaging channels, but without lots of other inter-component connections, I don't see how we can get the command message across otherwise.\r\nOf course this all could also mean that we rather choose solution 2 - although I would really like to skip the extra hop back via Kafka (and the extra topics involved).\r\n@sophokles73 @dejanb WDYT?","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/eclipse-hono/hono/issues/comments/719383866/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"calohmn","id":891931,"node_id":"MDQ6VXNlcjg5MTkzMQ==","avatar_url":"https://avatars.githubusercontent.com/u/891931?v=4","gravatar_id":"","url":"https://api.github.com/users/calohmn","html_url":"https://github.com/calohmn","followers_url":"https://api.github.com/users/calohmn/followers","following_url":"https://api.github.com/users/calohmn/following{/other_user}","gists_url":"https://api.github.com/users/calohmn/gists{/gist_id}","starred_url":"https://api.github.com/users/calohmn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calohmn/subscriptions","organizations_url":"https://api.github.com/users/calohmn/orgs","repos_url":"https://api.github.com/users/calohmn/repos","events_url":"https://api.github.com/users/calohmn/events{/privacy}","received_events_url":"https://api.github.com/users/calohmn/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":3939956965,"node_id":"MDE0Ok1lbnRpb25lZEV2ZW50MzkzOTk1Njk2NQ==","url":"https://api.github.com/repos/eclipse-hono/hono/issues/events/3939956965","actor":{"login":"dejanb","id":141611,"node_id":"MDQ6VXNlcjE0MTYxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/141611?v=4","gravatar_id":"","url":"https://api.github.com/users/dejanb","html_url":"https://github.com/dejanb","followers_url":"https://api.github.com/users/dejanb/followers","following_url":"https://api.github.com/users/dejanb/following{/other_user}","gists_url":"https://api.github.com/users/dejanb/gists{/gist_id}","starred_url":"https://api.github.com/users/dejanb/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dejanb/subscriptions","organizations_url":"https://api.github.com/users/dejanb/orgs","repos_url":"https://api.github.com/users/dejanb/repos","events_url":"https://api.github.com/users/dejanb/events{/privacy}","received_events_url":"https://api.github.com/users/dejanb/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2020-10-30T08:02:46Z","performed_via_github_app":null},{"id":3939956969,"node_id":"MDE1OlN1YnNjcmliZWRFdmVudDM5Mzk5NTY5Njk=","url":"https://api.github.com/repos/eclipse-hono/hono/issues/events/3939956969","actor":{"login":"dejanb","id":141611,"node_id":"MDQ6VXNlcjE0MTYxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/141611?v=4","gravatar_id":"","url":"https://api.github.com/users/dejanb","html_url":"https://github.com/dejanb","followers_url":"https://api.github.com/users/dejanb/followers","following_url":"https://api.github.com/users/dejanb/following{/other_user}","gists_url":"https://api.github.com/users/dejanb/gists{/gist_id}","starred_url":"https://api.github.com/users/dejanb/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dejanb/subscriptions","organizations_url":"https://api.github.com/users/dejanb/orgs","repos_url":"https://api.github.com/users/dejanb/repos","events_url":"https://api.github.com/users/dejanb/events{/privacy}","received_events_url":"https://api.github.com/users/dejanb/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2020-10-30T08:02:46Z","performed_via_github_app":null},{"id":3939956976,"node_id":"MDE0Ok1lbnRpb25lZEV2ZW50MzkzOTk1Njk3Ng==","url":"https://api.github.com/repos/eclipse-hono/hono/issues/events/3939956976","actor":{"login":"sophokles73","id":5682135,"node_id":"MDQ6VXNlcjU2ODIxMzU=","avatar_url":"https://avatars.githubusercontent.com/u/5682135?v=4","gravatar_id":"","url":"https://api.github.com/users/sophokles73","html_url":"https://github.com/sophokles73","followers_url":"https://api.github.com/users/sophokles73/followers","following_url":"https://api.github.com/users/sophokles73/following{/other_user}","gists_url":"https://api.github.com/users/sophokles73/gists{/gist_id}","starred_url":"https://api.github.com/users/sophokles73/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sophokles73/subscriptions","organizations_url":"https://api.github.com/users/sophokles73/orgs","repos_url":"https://api.github.com/users/sophokles73/repos","events_url":"https://api.github.com/users/sophokles73/events{/privacy}","received_events_url":"https://api.github.com/users/sophokles73/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2020-10-30T08:02:46Z","performed_via_github_app":null},{"id":3939956978,"node_id":"MDE1OlN1YnNjcmliZWRFdmVudDM5Mzk5NTY5Nzg=","url":"https://api.github.com/repos/eclipse-hono/hono/issues/events/3939956978","actor":{"login":"sophokles73","id":5682135,"node_id":"MDQ6VXNlcjU2ODIxMzU=","avatar_url":"https://avatars.githubusercontent.com/u/5682135?v=4","gravatar_id":"","url":"https://api.github.com/users/sophokles73","html_url":"https://github.com/sophokles73","followers_url":"https://api.github.com/users/sophokles73/followers","following_url":"https://api.github.com/users/sophokles73/following{/other_user}","gists_url":"https://api.github.com/users/sophokles73/gists{/gist_id}","starred_url":"https://api.github.com/users/sophokles73/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sophokles73/subscriptions","organizations_url":"https://api.github.com/users/sophokles73/orgs","repos_url":"https://api.github.com/users/sophokles73/repos","events_url":"https://api.github.com/users/sophokles73/events{/privacy}","received_events_url":"https://api.github.com/users/sophokles73/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2020-10-30T08:02:46Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/eclipse-hono/hono/issues/comments/719646702","html_url":"https://github.com/eclipse-hono/hono/issues/2273#issuecomment-719646702","issue_url":"https://api.github.com/repos/eclipse-hono/hono/issues/2273","id":719646702,"node_id":"MDEyOklzc3VlQ29tbWVudDcxOTY0NjcwMg==","user":{"login":"dejanb","id":141611,"node_id":"MDQ6VXNlcjE0MTYxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/141611?v=4","gravatar_id":"","url":"https://api.github.com/users/dejanb","html_url":"https://github.com/dejanb","followers_url":"https://api.github.com/users/dejanb/followers","following_url":"https://api.github.com/users/dejanb/following{/other_user}","gists_url":"https://api.github.com/users/dejanb/gists{/gist_id}","starred_url":"https://api.github.com/users/dejanb/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dejanb/subscriptions","organizations_url":"https://api.github.com/users/dejanb/orgs","repos_url":"https://api.github.com/users/dejanb/repos","events_url":"https://api.github.com/users/dejanb/events{/privacy}","received_events_url":"https://api.github.com/users/dejanb/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2020-10-30T16:12:25Z","updated_at":"2020-10-30T16:13:12Z","body":"@calohmn You are trying to solve \"exactly once\" delivery/processing problem here which is something that's hardly ever successfully implemented in a distributed system. For example, even if you implement all of the above what could happen is that protocol adapter sends a command to a device and fail immediately after without sending an ack. So we don't\r\n know if a device received/processed a command or not. So the command execution will fail and it will be probably retried by the client. This is just one example, but the point is that we need make sure device is an \"idempotent consumer\" of commands (meaning it can tolerate duplicate messages) and not try to solve the \"exactly once\" problem.\r\n","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/eclipse-hono/hono/issues/comments/719646702/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"dejanb","id":141611,"node_id":"MDQ6VXNlcjE0MTYxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/141611?v=4","gravatar_id":"","url":"https://api.github.com/users/dejanb","html_url":"https://github.com/dejanb","followers_url":"https://api.github.com/users/dejanb/followers","following_url":"https://api.github.com/users/dejanb/following{/other_user}","gists_url":"https://api.github.com/users/dejanb/gists{/gist_id}","starred_url":"https://api.github.com/users/dejanb/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dejanb/subscriptions","organizations_url":"https://api.github.com/users/dejanb/orgs","repos_url":"https://api.github.com/users/dejanb/repos","events_url":"https://api.github.com/users/dejanb/events{/privacy}","received_events_url":"https://api.github.com/users/dejanb/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":3942005042,"node_id":"MDE0Ok1lbnRpb25lZEV2ZW50Mzk0MjAwNTA0Mg==","url":"https://api.github.com/repos/eclipse-hono/hono/issues/events/3942005042","actor":{"login":"calohmn","id":891931,"node_id":"MDQ6VXNlcjg5MTkzMQ==","avatar_url":"https://avatars.githubusercontent.com/u/891931?v=4","gravatar_id":"","url":"https://api.github.com/users/calohmn","html_url":"https://github.com/calohmn","followers_url":"https://api.github.com/users/calohmn/followers","following_url":"https://api.github.com/users/calohmn/following{/other_user}","gists_url":"https://api.github.com/users/calohmn/gists{/gist_id}","starred_url":"https://api.github.com/users/calohmn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calohmn/subscriptions","organizations_url":"https://api.github.com/users/calohmn/orgs","repos_url":"https://api.github.com/users/calohmn/repos","events_url":"https://api.github.com/users/calohmn/events{/privacy}","received_events_url":"https://api.github.com/users/calohmn/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2020-10-30T16:12:26Z","performed_via_github_app":null},{"id":3942005043,"node_id":"MDE1OlN1YnNjcmliZWRFdmVudDM5NDIwMDUwNDM=","url":"https://api.github.com/repos/eclipse-hono/hono/issues/events/3942005043","actor":{"login":"calohmn","id":891931,"node_id":"MDQ6VXNlcjg5MTkzMQ==","avatar_url":"https://avatars.githubusercontent.com/u/891931?v=4","gravatar_id":"","url":"https://api.github.com/users/calohmn","html_url":"https://github.com/calohmn","followers_url":"https://api.github.com/users/calohmn/followers","following_url":"https://api.github.com/users/calohmn/following{/other_user}","gists_url":"https://api.github.com/users/calohmn/gists{/gist_id}","starred_url":"https://api.github.com/users/calohmn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calohmn/subscriptions","organizations_url":"https://api.github.com/users/calohmn/orgs","repos_url":"https://api.github.com/users/calohmn/repos","events_url":"https://api.github.com/users/calohmn/events{/privacy}","received_events_url":"https://api.github.com/users/calohmn/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2020-10-30T16:12:26Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/eclipse-hono/hono/issues/comments/720301419","html_url":"https://github.com/eclipse-hono/hono/issues/2273#issuecomment-720301419","issue_url":"https://api.github.com/repos/eclipse-hono/hono/issues/2273","id":720301419,"node_id":"MDEyOklzc3VlQ29tbWVudDcyMDMwMTQxOQ==","user":{"login":"calohmn","id":891931,"node_id":"MDQ6VXNlcjg5MTkzMQ==","avatar_url":"https://avatars.githubusercontent.com/u/891931?v=4","gravatar_id":"","url":"https://api.github.com/users/calohmn","html_url":"https://github.com/calohmn","followers_url":"https://api.github.com/users/calohmn/followers","following_url":"https://api.github.com/users/calohmn/following{/other_user}","gists_url":"https://api.github.com/users/calohmn/gists{/gist_id}","starred_url":"https://api.github.com/users/calohmn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calohmn/subscriptions","organizations_url":"https://api.github.com/users/calohmn/orgs","repos_url":"https://api.github.com/users/calohmn/repos","events_url":"https://api.github.com/users/calohmn/events{/privacy}","received_events_url":"https://api.github.com/users/calohmn/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2020-11-02T07:50:01Z","updated_at":"2020-11-02T07:50:01Z","body":"@dejanb I agree that we aren't aiming for \"exactly once\" qos here, rather \"at least once\". But still I think we should try to prevent possible scenarios where message duplication can occur. And if an approach (like solution 2 or 3) has fewer scenarios where such duplication can occur, that is an advantage of that approach to be taken into account.\r\n\r\nFor the scenario described above I could also imagine the following fix regarding solution 4: \r\nWhen a device unsubscribes, associate the current consumer partition and offset information with that device id and store it in the Key/Value store. When the device subscribes again (possibly on another CommandRouter instance), read that entry and potentially skip entries according to current partition offset. These Key/Value store entries would only be given a short lifespan then.","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/eclipse-hono/hono/issues/comments/720301419/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"calohmn","id":891931,"node_id":"MDQ6VXNlcjg5MTkzMQ==","avatar_url":"https://avatars.githubusercontent.com/u/891931?v=4","gravatar_id":"","url":"https://api.github.com/users/calohmn","html_url":"https://github.com/calohmn","followers_url":"https://api.github.com/users/calohmn/followers","following_url":"https://api.github.com/users/calohmn/following{/other_user}","gists_url":"https://api.github.com/users/calohmn/gists{/gist_id}","starred_url":"https://api.github.com/users/calohmn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calohmn/subscriptions","organizations_url":"https://api.github.com/users/calohmn/orgs","repos_url":"https://api.github.com/users/calohmn/repos","events_url":"https://api.github.com/users/calohmn/events{/privacy}","received_events_url":"https://api.github.com/users/calohmn/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":3946687346,"node_id":"MDE0Ok1lbnRpb25lZEV2ZW50Mzk0NjY4NzM0Ng==","url":"https://api.github.com/repos/eclipse-hono/hono/issues/events/3946687346","actor":{"login":"dejanb","id":141611,"node_id":"MDQ6VXNlcjE0MTYxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/141611?v=4","gravatar_id":"","url":"https://api.github.com/users/dejanb","html_url":"https://github.com/dejanb","followers_url":"https://api.github.com/users/dejanb/followers","following_url":"https://api.github.com/users/dejanb/following{/other_user}","gists_url":"https://api.github.com/users/dejanb/gists{/gist_id}","starred_url":"https://api.github.com/users/dejanb/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dejanb/subscriptions","organizations_url":"https://api.github.com/users/dejanb/orgs","repos_url":"https://api.github.com/users/dejanb/repos","events_url":"https://api.github.com/users/dejanb/events{/privacy}","received_events_url":"https://api.github.com/users/dejanb/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2020-11-02T07:50:01Z","performed_via_github_app":null},{"id":3946687349,"node_id":"MDE1OlN1YnNjcmliZWRFdmVudDM5NDY2ODczNDk=","url":"https://api.github.com/repos/eclipse-hono/hono/issues/events/3946687349","actor":{"login":"dejanb","id":141611,"node_id":"MDQ6VXNlcjE0MTYxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/141611?v=4","gravatar_id":"","url":"https://api.github.com/users/dejanb","html_url":"https://github.com/dejanb","followers_url":"https://api.github.com/users/dejanb/followers","following_url":"https://api.github.com/users/dejanb/following{/other_user}","gists_url":"https://api.github.com/users/dejanb/gists{/gist_id}","starred_url":"https://api.github.com/users/dejanb/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dejanb/subscriptions","organizations_url":"https://api.github.com/users/dejanb/orgs","repos_url":"https://api.github.com/users/dejanb/repos","events_url":"https://api.github.com/users/dejanb/events{/privacy}","received_events_url":"https://api.github.com/users/dejanb/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2020-11-02T07:50:01Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/eclipse-hono/hono/issues/comments/720497161","html_url":"https://github.com/eclipse-hono/hono/issues/2273#issuecomment-720497161","issue_url":"https://api.github.com/repos/eclipse-hono/hono/issues/2273","id":720497161,"node_id":"MDEyOklzc3VlQ29tbWVudDcyMDQ5NzE2MQ==","user":{"login":"b-abel","id":7031135,"node_id":"MDQ6VXNlcjcwMzExMzU=","avatar_url":"https://avatars.githubusercontent.com/u/7031135?v=4","gravatar_id":"","url":"https://api.github.com/users/b-abel","html_url":"https://github.com/b-abel","followers_url":"https://api.github.com/users/b-abel/followers","following_url":"https://api.github.com/users/b-abel/following{/other_user}","gists_url":"https://api.github.com/users/b-abel/gists{/gist_id}","starred_url":"https://api.github.com/users/b-abel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/b-abel/subscriptions","organizations_url":"https://api.github.com/users/b-abel/orgs","repos_url":"https://api.github.com/users/b-abel/repos","events_url":"https://api.github.com/users/b-abel/events{/privacy}","received_events_url":"https://api.github.com/users/b-abel/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2020-11-02T14:14:34Z","updated_at":"2020-11-02T14:14:34Z","body":"> but the point is that we need make sure device is an \"idempotent consumer\" of commands (meaning it can tolerate duplicate messages)\r\n\r\n@dejanb @calohmn IMHO the Command and Control API already provides the means to do that: the message-id needs to be unique on the sender side. I think it is fair to assume, that if a solution does not already use idempotent commands, it could still use the message-id to perform de-duplication on the device. ","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/eclipse-hono/hono/issues/comments/720497161/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"b-abel","id":7031135,"node_id":"MDQ6VXNlcjcwMzExMzU=","avatar_url":"https://avatars.githubusercontent.com/u/7031135?v=4","gravatar_id":"","url":"https://api.github.com/users/b-abel","html_url":"https://github.com/b-abel","followers_url":"https://api.github.com/users/b-abel/followers","following_url":"https://api.github.com/users/b-abel/following{/other_user}","gists_url":"https://api.github.com/users/b-abel/gists{/gist_id}","starred_url":"https://api.github.com/users/b-abel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/b-abel/subscriptions","organizations_url":"https://api.github.com/users/b-abel/orgs","repos_url":"https://api.github.com/users/b-abel/repos","events_url":"https://api.github.com/users/b-abel/events{/privacy}","received_events_url":"https://api.github.com/users/b-abel/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":3948304626,"node_id":"MDE0Ok1lbnRpb25lZEV2ZW50Mzk0ODMwNDYyNg==","url":"https://api.github.com/repos/eclipse-hono/hono/issues/events/3948304626","actor":{"login":"dejanb","id":141611,"node_id":"MDQ6VXNlcjE0MTYxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/141611?v=4","gravatar_id":"","url":"https://api.github.com/users/dejanb","html_url":"https://github.com/dejanb","followers_url":"https://api.github.com/users/dejanb/followers","following_url":"https://api.github.com/users/dejanb/following{/other_user}","gists_url":"https://api.github.com/users/dejanb/gists{/gist_id}","starred_url":"https://api.github.com/users/dejanb/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dejanb/subscriptions","organizations_url":"https://api.github.com/users/dejanb/orgs","repos_url":"https://api.github.com/users/dejanb/repos","events_url":"https://api.github.com/users/dejanb/events{/privacy}","received_events_url":"https://api.github.com/users/dejanb/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2020-11-02T14:14:35Z","performed_via_github_app":null},{"id":3948304629,"node_id":"MDE1OlN1YnNjcmliZWRFdmVudDM5NDgzMDQ2Mjk=","url":"https://api.github.com/repos/eclipse-hono/hono/issues/events/3948304629","actor":{"login":"dejanb","id":141611,"node_id":"MDQ6VXNlcjE0MTYxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/141611?v=4","gravatar_id":"","url":"https://api.github.com/users/dejanb","html_url":"https://github.com/dejanb","followers_url":"https://api.github.com/users/dejanb/followers","following_url":"https://api.github.com/users/dejanb/following{/other_user}","gists_url":"https://api.github.com/users/dejanb/gists{/gist_id}","starred_url":"https://api.github.com/users/dejanb/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dejanb/subscriptions","organizations_url":"https://api.github.com/users/dejanb/orgs","repos_url":"https://api.github.com/users/dejanb/repos","events_url":"https://api.github.com/users/dejanb/events{/privacy}","received_events_url":"https://api.github.com/users/dejanb/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2020-11-02T14:14:35Z","performed_via_github_app":null}]