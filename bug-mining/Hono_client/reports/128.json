{"url":"https://api.github.com/repos/eclipse-hono/hono/issues/1015","repository_url":"https://api.github.com/repos/eclipse-hono/hono","labels_url":"https://api.github.com/repos/eclipse-hono/hono/issues/1015/labels{/name}","comments_url":"https://api.github.com/repos/eclipse-hono/hono/issues/1015/comments","events_url":"https://api.github.com/repos/eclipse-hono/hono/issues/1015/events","html_url":"https://github.com/eclipse-hono/hono/issues/1015","id":404773337,"node_id":"MDU6SXNzdWU0MDQ3NzMzMzc=","number":1015,"title":"AuthService: use error codes for failed authentication attempts","user":{"login":"calohmn","id":891931,"node_id":"MDQ6VXNlcjg5MTkzMQ==","avatar_url":"https://avatars.githubusercontent.com/u/891931?v=4","gravatar_id":"","url":"https://api.github.com/users/calohmn","html_url":"https://github.com/calohmn","followers_url":"https://api.github.com/users/calohmn/followers","following_url":"https://api.github.com/users/calohmn/following{/other_user}","gists_url":"https://api.github.com/users/calohmn/gists{/gist_id}","starred_url":"https://api.github.com/users/calohmn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calohmn/subscriptions","organizations_url":"https://api.github.com/users/calohmn/orgs","repos_url":"https://api.github.com/users/calohmn/repos","events_url":"https://api.github.com/users/calohmn/events{/privacy}","received_events_url":"https://api.github.com/users/calohmn/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":323160608,"node_id":"MDU6TGFiZWwzMjMxNjA2MDg=","url":"https://api.github.com/repos/eclipse-hono/hono/labels/enhancement","name":"enhancement","color":"84b6eb","default":true,"description":null},{"id":1214650296,"node_id":"MDU6TGFiZWwxMjE0NjUwMjk2","url":"https://api.github.com/repos/eclipse-hono/hono/labels/Auth%20Server","name":"Auth Server","color":"0052cc","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2019-01-30T13:35:01Z","updated_at":"2019-02-09T06:41:54Z","closed_at":"2019-02-09T06:41:54Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"This is relevant for a scenario where a non-standard `AuthenticationService` component is used (i.e. not the `FileBasedAuthenticationService`).\r\n\r\nImagine an `AuthenticationService` implementation based on a database. When that database is down temporarily, authentication requests should not be answered with the standard \"authentication failed\" response but instead with an exception that points out the temporary nature of the error.\r\nFor such a authentication exception, the `HonoClient` should retry the authentication attempt (i.e. retry the connection attempt with the SASL handshake).\r\n\r\nThis relates to the different SASL outcomes now taken into account by the `HonoClient` (see #1014) and the place in `HonoSaslAuthenticator` where the `AuthenticationService` is invoked and its response is used to set a SASL outcome - currently this is only PN_SASL_OK or PN_SASL_AUTH.\r\n\r\n---\r\nThe one part of a potential fix for this could be in all classes implementing `AuthenticationService`, see the FIXME comment here:\r\n````\r\n     * @param authRequest The authentication information provided by the client in the SASL exchange.\r\n     * @param authenticationResultHandler The handler to invoke with the authentication result. If authentication succeeds,\r\n     *                                    the result contains the authenticated user.\r\n     *                                    FIXME describe ServiceInvocationException (with its status field) as the preferred exception type here and use it in all implementing classes.\r\n     */\r\n    void authenticate(JsonObject authRequest, Handler<AsyncResult<HonoUser>> authenticationResultHandler);\r\n````\r\n\r\nThe other part would be in `HonoSaslAuthenticator#process`:\r\n````\r\nauthTracker.setHandler(s -> {\r\n    if (s.succeeded()) {\r\n\r\n        final HonoUser user = s.result();\r\n        LOG.debug(\"authentication of client [authorization ID: {}] succeeded\", user.getName());\r\n        Constants.setClientPrincipal(protonConnection, user);\r\n        succeeded = true;\r\n        sasl.done(SaslOutcome.PN_SASL_OK);\r\n\r\n    } else {\r\n        // FIXME add support for setting these kinds of outcomes based on the exception (should be a ServiceInvocationException):\r\n        //       PN_SASL_SYS failed due to a system error\r\n        //       PN_SASL_TEMP impermanent error\r\n        //       PN_SASL_PERM failed due to unrecoverable error\r\n        //       see ProtonSaslClientAuthenticatorImpl\r\n\r\n        LOG.debug(\"authentication failed: \" + s.cause().getMessage());\r\n        sasl.done(SaslOutcome.PN_SASL_AUTH);\r\n    }\r\n````","closed_by":{"login":"sophokles73","id":5682135,"node_id":"MDQ6VXNlcjU2ODIxMzU=","avatar_url":"https://avatars.githubusercontent.com/u/5682135?v=4","gravatar_id":"","url":"https://api.github.com/users/sophokles73","html_url":"https://github.com/sophokles73","followers_url":"https://api.github.com/users/sophokles73/followers","following_url":"https://api.github.com/users/sophokles73/following{/other_user}","gists_url":"https://api.github.com/users/sophokles73/gists{/gist_id}","starred_url":"https://api.github.com/users/sophokles73/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sophokles73/subscriptions","organizations_url":"https://api.github.com/users/sophokles73/orgs","repos_url":"https://api.github.com/users/sophokles73/repos","events_url":"https://api.github.com/users/sophokles73/events{/privacy}","received_events_url":"https://api.github.com/users/sophokles73/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/eclipse-hono/hono/issues/1015/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/eclipse-hono/hono/issues/1015/timeline","performed_via_github_app":null,"state_reason":"completed"}