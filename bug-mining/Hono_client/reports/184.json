{"url":"https://api.github.com/repos/eclipse-hono/hono/issues/1471","repository_url":"https://api.github.com/repos/eclipse-hono/hono","labels_url":"https://api.github.com/repos/eclipse-hono/hono/issues/1471/labels{/name}","comments_url":"https://api.github.com/repos/eclipse-hono/hono/issues/1471/comments","events_url":"https://api.github.com/repos/eclipse-hono/hono/issues/1471/events","html_url":"https://github.com/eclipse-hono/hono/issues/1471","id":488428508,"node_id":"MDU6SXNzdWU0ODg0Mjg1MDg=","number":1471,"title":"Conceptual problem in connection handling","user":{"login":"ctron","id":202474,"node_id":"MDQ6VXNlcjIwMjQ3NA==","avatar_url":"https://avatars.githubusercontent.com/u/202474?v=4","gravatar_id":"","url":"https://api.github.com/users/ctron","html_url":"https://github.com/ctron","followers_url":"https://api.github.com/users/ctron/followers","following_url":"https://api.github.com/users/ctron/following{/other_user}","gists_url":"https://api.github.com/users/ctron/gists{/gist_id}","starred_url":"https://api.github.com/users/ctron/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ctron/subscriptions","organizations_url":"https://api.github.com/users/ctron/orgs","repos_url":"https://api.github.com/users/ctron/repos","events_url":"https://api.github.com/users/ctron/events{/privacy}","received_events_url":"https://api.github.com/users/ctron/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":323160606,"node_id":"MDU6TGFiZWwzMjMxNjA2MDY=","url":"https://api.github.com/repos/eclipse-hono/hono/labels/bug","name":"bug","color":"fc2929","default":true,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/eclipse-hono/hono/milestones/19","html_url":"https://github.com/eclipse-hono/hono/milestone/19","labels_url":"https://api.github.com/repos/eclipse-hono/hono/milestones/19/labels","id":4065065,"node_id":"MDk6TWlsZXN0b25lNDA2NTA2NQ==","number":19,"title":"1.0.0","description":"https://projects.eclipse.org/projects/iot.hono/releases/1.0.0","creator":{"login":"sophokles73","id":5682135,"node_id":"MDQ6VXNlcjU2ODIxMzU=","avatar_url":"https://avatars.githubusercontent.com/u/5682135?v=4","gravatar_id":"","url":"https://api.github.com/users/sophokles73","html_url":"https://github.com/sophokles73","followers_url":"https://api.github.com/users/sophokles73/followers","following_url":"https://api.github.com/users/sophokles73/following{/other_user}","gists_url":"https://api.github.com/users/sophokles73/gists{/gist_id}","starred_url":"https://api.github.com/users/sophokles73/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sophokles73/subscriptions","organizations_url":"https://api.github.com/users/sophokles73/orgs","repos_url":"https://api.github.com/users/sophokles73/repos","events_url":"https://api.github.com/users/sophokles73/events{/privacy}","received_events_url":"https://api.github.com/users/sophokles73/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":2,"closed_issues":414,"state":"closed","created_at":"2019-02-18T08:14:59Z","updated_at":"2022-11-30T09:51:53Z","due_on":"2019-10-14T07:00:00Z","closed_at":"2019-10-18T13:28:58Z"},"comments":8,"created_at":"2019-09-03T07:04:45Z","updated_at":"2019-09-18T06:39:10Z","closed_at":"2019-09-18T06:39:10Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"To me it looks like we have a conceptual problem in the handling of connections to other services.\r\n\r\nEvery now and then, I recognized cases, where the adapters just don't become ready. And so I was digging into the issue. In the log you can then find something like:\r\n\r\n~~~\r\n2019-09-02T17:11:38.515Z INFO  [HonoConnectionImpl] stopping connection attempt to server [host: iot-device-registry.enmasse-infra.svc, port: 5671] due to terminal error\r\njavax.security.sasl.AuthenticationException: Failed to authenticate\r\n~~~\r\n\r\nThis \"terminal error\" will stop the client from trying to re-connect, and it seems like it never will re-try again. For as long as process is alive. So effectively, the process would be dead now.\r\n\r\nMy assumption was, that the pod would get cleaned up at some point, due to failing health checks. However that also doesn't seem to be the case. Taking a look at `org.eclipse.hono.service.AbstractProtocolAdapterBase`, you can see that the connections are checked in `registerReadinessChecks`, but not in the `registerLivenessChecks` method.\r\n\r\nIn that case, the \"liveness check\" would still always succeed.\r\n\r\nTaking a look at the Kubernetes documentation (https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/):\r\n\r\n> The kubelet uses liveness probes to know when to restart a Container. For example, liveness probes could catch a deadlock, where an application is running, but unable to make progress. Restarting a Container in such a state can help to make the application more available despite bugs.\r\n> The kubelet uses readiness probes to know when a Container is ready to start accepting traffic. A Pod is considered ready when all of its Containers are ready. One use of this signal is to control which Pods are used as backends for Services. When a Pod is not ready, it is removed from Service load balancers.\r\n\r\nIt looks to me, as if the correct way to signal the \"terminal error\", is not through the \"readiness\" check, but through the \"liveness\" check instead.\r\n\r\nAdditionally, I would question the idea of a terminal error altogether. From what I see in our case, it has to do with an invalid service credential. So that problem will go away in a minute.\r\n\r\nI think we should:\r\n\r\n1. Trigger a liveness failure in case of a terminal error.\r\n1. Event for a terminal error, allow to try again.\r\n\r\nFixing the first point is required to solve the issue. The second point would only allow the pod to recover itself, before it get killed by Kubernetes, and might be more of an improvement to the situation.\r\n\r\nI also think we should fix this before 1.0.0!","closed_by":{"login":"ctron","id":202474,"node_id":"MDQ6VXNlcjIwMjQ3NA==","avatar_url":"https://avatars.githubusercontent.com/u/202474?v=4","gravatar_id":"","url":"https://api.github.com/users/ctron","html_url":"https://github.com/ctron","followers_url":"https://api.github.com/users/ctron/followers","following_url":"https://api.github.com/users/ctron/following{/other_user}","gists_url":"https://api.github.com/users/ctron/gists{/gist_id}","starred_url":"https://api.github.com/users/ctron/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ctron/subscriptions","organizations_url":"https://api.github.com/users/ctron/orgs","repos_url":"https://api.github.com/users/ctron/repos","events_url":"https://api.github.com/users/ctron/events{/privacy}","received_events_url":"https://api.github.com/users/ctron/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/eclipse-hono/hono/issues/1471/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/eclipse-hono/hono/issues/1471/timeline","performed_via_github_app":null,"state_reason":"completed"}