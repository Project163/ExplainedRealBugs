{"url":"https://api.github.com/repos/eclipse-hono/hono/issues/2244","repository_url":"https://api.github.com/repos/eclipse-hono/hono","labels_url":"https://api.github.com/repos/eclipse-hono/hono/issues/2244/labels{/name}","comments_url":"https://api.github.com/repos/eclipse-hono/hono/issues/2244/comments","events_url":"https://api.github.com/repos/eclipse-hono/hono/issues/2244/events","html_url":"https://github.com/eclipse-hono/hono/issues/2244","id":718150997,"node_id":"MDU6SXNzdWU3MTgxNTA5OTc=","number":2244,"title":"[MQTT/AMQP] Issues with devices not properly disconnecting and then reconnecting","user":{"login":"calohmn","id":891931,"node_id":"MDQ6VXNlcjg5MTkzMQ==","avatar_url":"https://avatars.githubusercontent.com/u/891931?v=4","gravatar_id":"","url":"https://api.github.com/users/calohmn","html_url":"https://github.com/calohmn","followers_url":"https://api.github.com/users/calohmn/followers","following_url":"https://api.github.com/users/calohmn/following{/other_user}","gists_url":"https://api.github.com/users/calohmn/gists{/gist_id}","starred_url":"https://api.github.com/users/calohmn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calohmn/subscriptions","organizations_url":"https://api.github.com/users/calohmn/orgs","repos_url":"https://api.github.com/users/calohmn/repos","events_url":"https://api.github.com/users/calohmn/events{/privacy}","received_events_url":"https://api.github.com/users/calohmn/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":323160606,"node_id":"MDU6TGFiZWwzMjMxNjA2MDY=","url":"https://api.github.com/repos/eclipse-hono/hono/labels/bug","name":"bug","color":"fc2929","default":true,"description":null},{"id":525773890,"node_id":"MDU6TGFiZWw1MjU3NzM4OTA=","url":"https://api.github.com/repos/eclipse-hono/hono/labels/MQTT%20Adapter","name":"MQTT Adapter","color":"e99695","default":false,"description":null},{"id":947051526,"node_id":"MDU6TGFiZWw5NDcwNTE1MjY=","url":"https://api.github.com/repos/eclipse-hono/hono/labels/C&C","name":"C&C","color":"2dbc83","default":false,"description":"Command and Control"},{"id":974522947,"node_id":"MDU6TGFiZWw5NzQ1MjI5NDc=","url":"https://api.github.com/repos/eclipse-hono/hono/labels/AMQP%20Adapter","name":"AMQP Adapter","color":"aa3020","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"calohmn","id":891931,"node_id":"MDQ6VXNlcjg5MTkzMQ==","avatar_url":"https://avatars.githubusercontent.com/u/891931?v=4","gravatar_id":"","url":"https://api.github.com/users/calohmn","html_url":"https://github.com/calohmn","followers_url":"https://api.github.com/users/calohmn/followers","following_url":"https://api.github.com/users/calohmn/following{/other_user}","gists_url":"https://api.github.com/users/calohmn/gists{/gist_id}","starred_url":"https://api.github.com/users/calohmn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calohmn/subscriptions","organizations_url":"https://api.github.com/users/calohmn/orgs","repos_url":"https://api.github.com/users/calohmn/repos","events_url":"https://api.github.com/users/calohmn/events{/privacy}","received_events_url":"https://api.github.com/users/calohmn/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"calohmn","id":891931,"node_id":"MDQ6VXNlcjg5MTkzMQ==","avatar_url":"https://avatars.githubusercontent.com/u/891931?v=4","gravatar_id":"","url":"https://api.github.com/users/calohmn","html_url":"https://github.com/calohmn","followers_url":"https://api.github.com/users/calohmn/followers","following_url":"https://api.github.com/users/calohmn/following{/other_user}","gists_url":"https://api.github.com/users/calohmn/gists{/gist_id}","starred_url":"https://api.github.com/users/calohmn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calohmn/subscriptions","organizations_url":"https://api.github.com/users/calohmn/orgs","repos_url":"https://api.github.com/users/calohmn/repos","events_url":"https://api.github.com/users/calohmn/events{/privacy}","received_events_url":"https://api.github.com/users/calohmn/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/eclipse-hono/hono/milestones/26","html_url":"https://github.com/eclipse-hono/hono/milestone/26","labels_url":"https://api.github.com/repos/eclipse-hono/hono/milestones/26/labels","id":5863476,"node_id":"MDk6TWlsZXN0b25lNTg2MzQ3Ng==","number":26,"title":"1.5.0","description":"","creator":{"login":"sophokles73","id":5682135,"node_id":"MDQ6VXNlcjU2ODIxMzU=","avatar_url":"https://avatars.githubusercontent.com/u/5682135?v=4","gravatar_id":"","url":"https://api.github.com/users/sophokles73","html_url":"https://github.com/sophokles73","followers_url":"https://api.github.com/users/sophokles73/followers","following_url":"https://api.github.com/users/sophokles73/following{/other_user}","gists_url":"https://api.github.com/users/sophokles73/gists{/gist_id}","starred_url":"https://api.github.com/users/sophokles73/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sophokles73/subscriptions","organizations_url":"https://api.github.com/users/sophokles73/orgs","repos_url":"https://api.github.com/users/sophokles73/repos","events_url":"https://api.github.com/users/sophokles73/events{/privacy}","received_events_url":"https://api.github.com/users/sophokles73/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":153,"state":"closed","created_at":"2020-09-10T11:30:29Z","updated_at":"2020-12-17T10:01:50Z","due_on":"2020-12-16T08:00:00Z","closed_at":"2020-12-17T10:01:50Z"},"comments":6,"created_at":"2020-10-09T13:34:33Z","updated_at":"2020-10-22T04:32:00Z","closed_at":"2020-10-22T04:32:00Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"When an MQTT device connection gets broken without the MQTT adapter noticing, and when the device then reconnects (before the MQTT keepAlive period has elapsed) and re-subscribes for commands, one of these issues may arise:\r\n- **A:** If reconnect happened on different adapter/verticle instance:\r\nThe late disconnect (after the keepAlive period) will trigger a \"disconnectedTtdEvent\" message, superceding the \"connectedTtdEvent\" message from the reconnect, meaning the latest such event message doesn't reflect the \"connected\" state of the device.\r\n- **B:** If reconnect happened on *same* adapter/verticle instance:\r\nThe late disconnect will also cause the command consumer from the reconnect attempt to be removed. This means the reconnected device won't receive any commands.\r\n\r\nScenario A described in more detail:\r\n- An MQTT device has subscribed for receiving command messages. \r\n- The MQTT connection then gets broken somehow, without a proper disconnect getting sent, so that the MQTT adapter first doesn't notice that the device is disconnected.\r\n- Then the MQTT device reconnects with another MQTT adapter instance (or verticle instance) and subscribes again. This means an event message (with `ttd=-1`) is sent downstream, notifying the northbound application about the connected device.\r\n- Then the MQTT adapter, that the device was initially connected with, notices the broken connection via the MQTT keep alive mechanism. This means again an event message is sent downstream, this time meaning the device isn't connected anymore (`ttd=0`). This means the latest event message that the northbound application receives (ie. the \"disconnected\" event), doesn't reflect the actual connection status of the device. This possibly means that the application doesn't send commands anymore although the device is connected and has subscribed for commands.\r\n\r\nWhen testing with `mosquitto_sub`: The case of the broken (half-open) MQTT connection can be simulated by suspending the `mosquitto_sub` process (CTRL+Z).\r\n\r\nBoth issues probably also apply to a corresponding AMQP device scenario.","closed_by":{"login":"calohmn","id":891931,"node_id":"MDQ6VXNlcjg5MTkzMQ==","avatar_url":"https://avatars.githubusercontent.com/u/891931?v=4","gravatar_id":"","url":"https://api.github.com/users/calohmn","html_url":"https://github.com/calohmn","followers_url":"https://api.github.com/users/calohmn/followers","following_url":"https://api.github.com/users/calohmn/following{/other_user}","gists_url":"https://api.github.com/users/calohmn/gists{/gist_id}","starred_url":"https://api.github.com/users/calohmn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calohmn/subscriptions","organizations_url":"https://api.github.com/users/calohmn/orgs","repos_url":"https://api.github.com/users/calohmn/repos","events_url":"https://api.github.com/users/calohmn/events{/privacy}","received_events_url":"https://api.github.com/users/calohmn/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/eclipse-hono/hono/issues/2244/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/eclipse-hono/hono/issues/2244/timeline","performed_via_github_app":null,"state_reason":"completed"}