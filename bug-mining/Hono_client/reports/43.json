{"url":"https://api.github.com/repos/eclipse-hono/hono/issues/365","repository_url":"https://api.github.com/repos/eclipse-hono/hono","labels_url":"https://api.github.com/repos/eclipse-hono/hono/issues/365/labels{/name}","comments_url":"https://api.github.com/repos/eclipse-hono/hono/issues/365/comments","events_url":"https://api.github.com/repos/eclipse-hono/hono/issues/365/events","html_url":"https://github.com/eclipse-hono/hono/issues/365","id":264184989,"node_id":"MDU6SXNzdWUyNjQxODQ5ODk=","number":365,"title":"MQTT adapter stops working as soon as AMQP credits run out","user":{"login":"alexmabsi","id":29867923,"node_id":"MDQ6VXNlcjI5ODY3OTIz","avatar_url":"https://avatars.githubusercontent.com/u/29867923?v=4","gravatar_id":"","url":"https://api.github.com/users/alexmabsi","html_url":"https://github.com/alexmabsi","followers_url":"https://api.github.com/users/alexmabsi/followers","following_url":"https://api.github.com/users/alexmabsi/following{/other_user}","gists_url":"https://api.github.com/users/alexmabsi/gists{/gist_id}","starred_url":"https://api.github.com/users/alexmabsi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alexmabsi/subscriptions","organizations_url":"https://api.github.com/users/alexmabsi/orgs","repos_url":"https://api.github.com/users/alexmabsi/repos","events_url":"https://api.github.com/users/alexmabsi/events{/privacy}","received_events_url":"https://api.github.com/users/alexmabsi/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":323160606,"node_id":"MDU6TGFiZWwzMjMxNjA2MDY=","url":"https://api.github.com/repos/eclipse-hono/hono/labels/bug","name":"bug","color":"fc2929","default":true,"description":null},{"id":691341461,"node_id":"MDU6TGFiZWw2OTEzNDE0NjE=","url":"https://api.github.com/repos/eclipse-hono/hono/labels/Device%20Registry","name":"Device Registry","color":"1d76db","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"sophokles73","id":5682135,"node_id":"MDQ6VXNlcjU2ODIxMzU=","avatar_url":"https://avatars.githubusercontent.com/u/5682135?v=4","gravatar_id":"","url":"https://api.github.com/users/sophokles73","html_url":"https://github.com/sophokles73","followers_url":"https://api.github.com/users/sophokles73/followers","following_url":"https://api.github.com/users/sophokles73/following{/other_user}","gists_url":"https://api.github.com/users/sophokles73/gists{/gist_id}","starred_url":"https://api.github.com/users/sophokles73/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sophokles73/subscriptions","organizations_url":"https://api.github.com/users/sophokles73/orgs","repos_url":"https://api.github.com/users/sophokles73/repos","events_url":"https://api.github.com/users/sophokles73/events{/privacy}","received_events_url":"https://api.github.com/users/sophokles73/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"sophokles73","id":5682135,"node_id":"MDQ6VXNlcjU2ODIxMzU=","avatar_url":"https://avatars.githubusercontent.com/u/5682135?v=4","gravatar_id":"","url":"https://api.github.com/users/sophokles73","html_url":"https://github.com/sophokles73","followers_url":"https://api.github.com/users/sophokles73/followers","following_url":"https://api.github.com/users/sophokles73/following{/other_user}","gists_url":"https://api.github.com/users/sophokles73/gists{/gist_id}","starred_url":"https://api.github.com/users/sophokles73/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sophokles73/subscriptions","organizations_url":"https://api.github.com/users/sophokles73/orgs","repos_url":"https://api.github.com/users/sophokles73/repos","events_url":"https://api.github.com/users/sophokles73/events{/privacy}","received_events_url":"https://api.github.com/users/sophokles73/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/eclipse-hono/hono/milestones/11","html_url":"https://github.com/eclipse-hono/hono/milestone/11","labels_url":"https://api.github.com/repos/eclipse-hono/hono/milestones/11/labels","id":2827777,"node_id":"MDk6TWlsZXN0b25lMjgyNzc3Nw==","number":11,"title":"0.5-M10","description":"* Created Eclipse sandbox\r\n* Arbitrary bug fixes and improvements","creator":{"login":"sophokles73","id":5682135,"node_id":"MDQ6VXNlcjU2ODIxMzU=","avatar_url":"https://avatars.githubusercontent.com/u/5682135?v=4","gravatar_id":"","url":"https://api.github.com/users/sophokles73","html_url":"https://github.com/sophokles73","followers_url":"https://api.github.com/users/sophokles73/followers","following_url":"https://api.github.com/users/sophokles73/following{/other_user}","gists_url":"https://api.github.com/users/sophokles73/gists{/gist_id}","starred_url":"https://api.github.com/users/sophokles73/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sophokles73/subscriptions","organizations_url":"https://api.github.com/users/sophokles73/orgs","repos_url":"https://api.github.com/users/sophokles73/repos","events_url":"https://api.github.com/users/sophokles73/events{/privacy}","received_events_url":"https://api.github.com/users/sophokles73/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":9,"state":"closed","created_at":"2017-10-10T14:42:34Z","updated_at":"2017-10-24T15:32:08Z","due_on":"2017-10-24T07:00:00Z","closed_at":"2017-10-24T15:32:08Z"},"comments":10,"created_at":"2017-10-10T10:58:58Z","updated_at":"2017-10-17T16:13:09Z","closed_at":"2017-10-17T16:13:09Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Hey,\r\n\r\nI think there's an issue with the current protocol adapter imeplementations.\r\n\r\nI ran some load tests against the mqtt adapter and have some findings. I wonder if there are any configuration gotchas or something I might have missed.\r\n\r\nLet's start with the test scenario:\r\n\r\n6 AWS EC2 instances fire against the hono mqtt adapter using jmeter. Device authentication is enabled (pwd, sha-512). The hono cluster is rather small, 3 t2.medium nodes running kubernetes with 3 masters. \r\nOne message has a 512 byte payload.\r\n\r\nEverything works fine with a total throttled throughput of 200 messages/sec. (10 devices on 1 tenant)\r\nAs soon as I ramp up the load everything breaks (2000 messages/sec total from 10 devices and 2000 messages/sec from 200 devices). \r\n\r\nThe problem as far as I can tell is: \r\n\r\nThe mqtt adapter runs out of credits and closes the connection, see this log message:\r\n\r\nVertxBasedMqttProtocolAdapter - cannot process message for device [tenantId: DEFAULT_TENANT, deviceId: loadTestClient-4, topic: telemetry/DEFAULT_TENANT/loadTestClient-4, QoS: AT_MOST_ONCE, cause: no credit available for sending message\r\n\r\nClosing the conncetion also deletes the registration assertion which in turn makes it necessary to gather the registration data from the device registry service on the next message. The device registry gets overwhelmed by those requests (100k in a 10min test run in my case).\r\nThe messaging service does not receive any more messages the mqtt adapter failes to recover by itself. I would expect the system to behave differently: Drop new messages from the affected tenant, instead it tries to accept them and 'kills' backend services. \r\n\r\nAre there any problems with my setup as far as you can tell? Imo the behavior is not acceptable, as there is a hard limit on throughput that brings down a deployment and requires manual intervention.\r\n\r\nI'm happy to provide more information, just give me some pointers if necessary\r\n\r\nCheers\r\n","closed_by":{"login":"sophokles73","id":5682135,"node_id":"MDQ6VXNlcjU2ODIxMzU=","avatar_url":"https://avatars.githubusercontent.com/u/5682135?v=4","gravatar_id":"","url":"https://api.github.com/users/sophokles73","html_url":"https://github.com/sophokles73","followers_url":"https://api.github.com/users/sophokles73/followers","following_url":"https://api.github.com/users/sophokles73/following{/other_user}","gists_url":"https://api.github.com/users/sophokles73/gists{/gist_id}","starred_url":"https://api.github.com/users/sophokles73/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sophokles73/subscriptions","organizations_url":"https://api.github.com/users/sophokles73/orgs","repos_url":"https://api.github.com/users/sophokles73/repos","events_url":"https://api.github.com/users/sophokles73/events{/privacy}","received_events_url":"https://api.github.com/users/sophokles73/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/eclipse-hono/hono/issues/365/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/eclipse-hono/hono/issues/365/timeline","performed_via_github_app":null,"state_reason":"completed"}