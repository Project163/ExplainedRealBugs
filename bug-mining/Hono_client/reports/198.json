{"url":"https://api.github.com/repos/eclipse-hono/hono/issues/1718","repository_url":"https://api.github.com/repos/eclipse-hono/hono","labels_url":"https://api.github.com/repos/eclipse-hono/hono/issues/1718/labels{/name}","comments_url":"https://api.github.com/repos/eclipse-hono/hono/issues/1718/comments","events_url":"https://api.github.com/repos/eclipse-hono/hono/issues/1718/events","html_url":"https://github.com/eclipse-hono/hono/issues/1718","id":554692772,"node_id":"MDU6SXNzdWU1NTQ2OTI3NzI=","number":1718,"title":"Rare sender/receiver creation error","user":{"login":"calohmn","id":891931,"node_id":"MDQ6VXNlcjg5MTkzMQ==","avatar_url":"https://avatars.githubusercontent.com/u/891931?v=4","gravatar_id":"","url":"https://api.github.com/users/calohmn","html_url":"https://github.com/calohmn","followers_url":"https://api.github.com/users/calohmn/followers","following_url":"https://api.github.com/users/calohmn/following{/other_user}","gists_url":"https://api.github.com/users/calohmn/gists{/gist_id}","starred_url":"https://api.github.com/users/calohmn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calohmn/subscriptions","organizations_url":"https://api.github.com/users/calohmn/orgs","repos_url":"https://api.github.com/users/calohmn/repos","events_url":"https://api.github.com/users/calohmn/events{/privacy}","received_events_url":"https://api.github.com/users/calohmn/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":323160606,"node_id":"MDU6TGFiZWwzMjMxNjA2MDY=","url":"https://api.github.com/repos/eclipse-hono/hono/labels/bug","name":"bug","color":"fc2929","default":true,"description":null},{"id":643682479,"node_id":"MDU6TGFiZWw2NDM2ODI0Nzk=","url":"https://api.github.com/repos/eclipse-hono/hono/labels/Client","name":"Client","color":"0e8a16","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"calohmn","id":891931,"node_id":"MDQ6VXNlcjg5MTkzMQ==","avatar_url":"https://avatars.githubusercontent.com/u/891931?v=4","gravatar_id":"","url":"https://api.github.com/users/calohmn","html_url":"https://github.com/calohmn","followers_url":"https://api.github.com/users/calohmn/followers","following_url":"https://api.github.com/users/calohmn/following{/other_user}","gists_url":"https://api.github.com/users/calohmn/gists{/gist_id}","starred_url":"https://api.github.com/users/calohmn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calohmn/subscriptions","organizations_url":"https://api.github.com/users/calohmn/orgs","repos_url":"https://api.github.com/users/calohmn/repos","events_url":"https://api.github.com/users/calohmn/events{/privacy}","received_events_url":"https://api.github.com/users/calohmn/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"calohmn","id":891931,"node_id":"MDQ6VXNlcjg5MTkzMQ==","avatar_url":"https://avatars.githubusercontent.com/u/891931?v=4","gravatar_id":"","url":"https://api.github.com/users/calohmn","html_url":"https://github.com/calohmn","followers_url":"https://api.github.com/users/calohmn/followers","following_url":"https://api.github.com/users/calohmn/following{/other_user}","gists_url":"https://api.github.com/users/calohmn/gists{/gist_id}","starred_url":"https://api.github.com/users/calohmn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calohmn/subscriptions","organizations_url":"https://api.github.com/users/calohmn/orgs","repos_url":"https://api.github.com/users/calohmn/repos","events_url":"https://api.github.com/users/calohmn/events{/privacy}","received_events_url":"https://api.github.com/users/calohmn/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/eclipse-hono/hono/milestones/20","html_url":"https://github.com/eclipse-hono/hono/milestone/20","labels_url":"https://api.github.com/repos/eclipse-hono/hono/milestones/20/labels","id":4449316,"node_id":"MDk6TWlsZXN0b25lNDQ0OTMxNg==","number":20,"title":"1.1.0","description":"https://projects.eclipse.org/projects/iot.hono/releases/1.1.0","creator":{"login":"sophokles73","id":5682135,"node_id":"MDQ6VXNlcjU2ODIxMzU=","avatar_url":"https://avatars.githubusercontent.com/u/5682135?v=4","gravatar_id":"","url":"https://api.github.com/users/sophokles73","html_url":"https://github.com/sophokles73","followers_url":"https://api.github.com/users/sophokles73/followers","following_url":"https://api.github.com/users/sophokles73/following{/other_user}","gists_url":"https://api.github.com/users/sophokles73/gists{/gist_id}","starred_url":"https://api.github.com/users/sophokles73/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sophokles73/subscriptions","organizations_url":"https://api.github.com/users/sophokles73/orgs","repos_url":"https://api.github.com/users/sophokles73/repos","events_url":"https://api.github.com/users/sophokles73/events{/privacy}","received_events_url":"https://api.github.com/users/sophokles73/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":111,"state":"closed","created_at":"2019-06-28T15:13:35Z","updated_at":"2020-02-07T14:19:14Z","due_on":"2020-02-07T08:00:00Z","closed_at":"2020-02-07T08:32:52Z"},"comments":2,"created_at":"2020-01-24T11:50:25Z","updated_at":"2020-01-31T13:36:20Z","closed_at":"2020-01-31T13:36:20Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"We have seen the following error in a protocol adapter log while the AMQP messaging network component got restarted:\r\n````\r\n15:26:17.575 [vert.x-eventloop-thread-0] INFO  o.e.h.client.impl.HonoConnectionImpl - link establishment [peer: xx] timed out after 1000ms\r\n15:26:17.576 [vert.x-eventloop-thread-0] ERROR io.vertx.core.impl.ContextImpl - Unhandled exception\r\njava.lang.IllegalStateException: null\r\n\tat org.apache.qpid.proton.engine.impl.EndpointImpl.decref(EndpointImpl.java:54)\r\n\tat org.apache.qpid.proton.engine.impl.LinkImpl.postFinal(LinkImpl.java:128)\r\n\tat org.apache.qpid.proton.engine.impl.EndpointImpl.decref(EndpointImpl.java:52)\r\n\tat org.apache.qpid.proton.engine.impl.EndpointImpl.free(EndpointImpl.java:191)\r\n\tat io.vertx.proton.impl.ProtonLinkImpl.free(ProtonLinkImpl.java:303)\r\n\tat io.vertx.proton.impl.ProtonReceiverImpl.free(ProtonReceiverImpl.java:41)\r\n\tat org.eclipse.hono.client.impl.HonoConnectionImpl.onTimeOut(HonoConnectionImpl.java:810)\r\n\tat org.eclipse.hono.client.impl.HonoConnectionImpl.lambda$createReceiver$19(HonoConnectionImpl.java:795)\r\n\tat io.vertx.core.impl.VertxImpl$InternalTimerHandler.handle(VertxImpl.java:911)\r\n\tat io.vertx.core.impl.VertxImpl$InternalTimerHandler.handle(VertxImpl.java:875)\r\n\tat io.vertx.core.impl.ContextImpl.executeTask(ContextImpl.java:320)\r\n\tat io.vertx.core.impl.EventLoopContext.execute(EventLoopContext.java:43)\r\n\tat io.vertx.core.impl.ContextImpl.executeFromIO(ContextImpl.java:188)\r\n\tat io.vertx.core.impl.ContextImpl.executeFromIO(ContextImpl.java:180)\r\n\tat io.vertx.core.impl.VertxImpl$InternalTimerHandler.run(VertxImpl.java:901)\r\n\tat io.netty.util.concurrent.PromiseTask$RunnableAdapter.call(PromiseTask.java:38)\r\n\tat io.netty.util.concurrent.ScheduledFutureTask.run(ScheduledFutureTask.java:127)\r\n\tat io.netty.util.concurrent.AbstractEventExecutor.safeExecute(AbstractEventExecutor.java:163)\r\n\tat io.netty.util.concurrent.SingleThreadEventExecutor.runAllTasks(SingleThreadEventExecutor.java:416)\r\n\tat io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:515)\r\n\tat io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:918)\r\n\tat io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)\r\n\tat io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\r\n\tat java.base/java.lang.Thread.run(Thread.java:834)\r\n````\r\nThis caused the receiver creation future to not get finished.\r\n\r\n\r\n<details>\r\n<summary>Here is another variant of this stacktrace.</summary>\r\n\r\n~~~\r\njava.lang.IllegalStateException: null\r\n\tat org.apache.qpid.proton.engine.impl.EndpointImpl.decref(EndpointImpl.java:54)\r\n\tat org.apache.qpid.proton.engine.impl.SessionImpl.postFinal(SessionImpl.java:138)\r\n\tat org.apache.qpid.proton.engine.impl.EndpointImpl.decref(EndpointImpl.java:52)\r\n\tat org.apache.qpid.proton.engine.impl.LinkImpl.postFinal(LinkImpl.java:128)\r\n\tat org.apache.qpid.proton.engine.impl.EndpointImpl.decref(EndpointImpl.java:52)\r\n\tat org.apache.qpid.proton.engine.impl.EndpointImpl.free(EndpointImpl.java:191)\r\n\tat io.vertx.proton.impl.ProtonLinkImpl.free(ProtonLinkImpl.java:303)\r\n\tat io.vertx.proton.impl.ProtonReceiverImpl.free(ProtonReceiverImpl.java:41)\r\n\tat org.eclipse.hono.client.impl.HonoConnectionImpl.onTimeOut(HonoConnectionImpl.java:810)\r\n\tat org.eclipse.hono.client.impl.HonoConnectionImpl.lambda$createReceiver$19(HonoConnectionImpl.java:795)\r\n\tat io.vertx.core.impl.VertxImpl$InternalTimerHandler.handle(VertxImpl.java:911)\r\n\tat io.vertx.core.impl.VertxImpl$InternalTimerHandler.handle(VertxImpl.java:875)\r\n\tat io.vertx.core.impl.ContextImpl.executeTask(ContextImpl.java:320)\r\n\tat io.vertx.core.impl.EventLoopContext.execute(EventLoopContext.java:43)\r\n\tat io.vertx.core.impl.ContextImpl.executeFromIO(ContextImpl.java:188)\r\n\tat io.vertx.core.impl.ContextImpl.executeFromIO(ContextImpl.java:180)\r\n\tat io.vertx.core.impl.VertxImpl$InternalTimerHandler.run(VertxImpl.java:901)\r\n\tat io.netty.util.concurrent.PromiseTask$RunnableAdapter.call(PromiseTask.java:38)\r\n\tat io.netty.util.concurrent.ScheduledFutureTask.run(ScheduledFutureTask.java:127)\r\n\tat io.netty.util.concurrent.AbstractEventExecutor.safeExecute(AbstractEventExecutor.java:163)\r\n\tat io.netty.util.concurrent.SingleThreadEventExecutor.runAllTasks(SingleThreadEventExecutor.java:416)\r\n\tat io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:515)\r\n\tat io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:918)\r\n\tat io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)\r\n\tat io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\r\n\tat java.base/java.lang.Thread.run(Thread.java:834)\r\n~~~\r\n\r\n</details>\r\n\r\n<details>\r\n<summary>And here another during *sender* creation.</summary>\r\n\r\n~~~\r\njava.lang.IllegalStateException: null\r\n\tat org.apache.qpid.proton.engine.impl.EndpointImpl.decref(EndpointImpl.java:54)\r\n\tat org.apache.qpid.proton.engine.impl.LinkImpl.postFinal(LinkImpl.java:128)\r\n\tat org.apache.qpid.proton.engine.impl.EndpointImpl.decref(EndpointImpl.java:52)\r\n\tat org.apache.qpid.proton.engine.impl.EndpointImpl.free(EndpointImpl.java:191)\r\n\tat io.vertx.proton.impl.ProtonLinkImpl.free(ProtonLinkImpl.java:303)\r\n\tat io.vertx.proton.impl.ProtonSenderImpl.free(ProtonSenderImpl.java:33)\r\n\tat org.eclipse.hono.client.impl.HonoConnectionImpl.onTimeOut(HonoConnectionImpl.java:810)\r\n\tat org.eclipse.hono.client.impl.HonoConnectionImpl.lambda$createSender$12(HonoConnectionImpl.java:698)\r\n\tat io.vertx.core.impl.VertxImpl$InternalTimerHandler.handle(VertxImpl.java:911)\r\n\tat io.vertx.core.impl.VertxImpl$InternalTimerHandler.handle(VertxImpl.java:875)\r\n\tat io.vertx.core.impl.ContextImpl.executeTask(ContextImpl.java:320)\r\n\tat io.vertx.core.impl.EventLoopContext.execute(EventLoopContext.java:43)\r\n\tat io.vertx.core.impl.ContextImpl.executeFromIO(ContextImpl.java:188)\r\n\tat io.vertx.core.impl.ContextImpl.executeFromIO(ContextImpl.java:180)\r\n\tat io.vertx.core.impl.VertxImpl$InternalTimerHandler.run(VertxImpl.java:901)\r\n\tat io.netty.util.concurrent.PromiseTask$RunnableAdapter.call(PromiseTask.java:38)\r\n\tat io.netty.util.concurrent.ScheduledFutureTask.run(ScheduledFutureTask.java:127)\r\n\tat io.netty.util.concurrent.AbstractEventExecutor.safeExecute(AbstractEventExecutor.java:163)\r\n\tat io.netty.util.concurrent.SingleThreadEventExecutor.runAllTasks(SingleThreadEventExecutor.java:416)\r\n\tat io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:515)\r\n\tat io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:918)\r\n\tat io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)\r\n\tat io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\r\n\tat java.base/java.lang.Thread.run(Thread.java:834)\r\n\r\n~~~\r\n\r\n</details>\r\n\r\n\r\nThe errors above lead to the assumption that somehow one of the Proton Link/Session/Connection/Transport objects got corrupted.\r\nAn explanation could be that there was an exception in one of the handlers associated with these objects (e.g. closeHandler, detachHandler, etc.).\r\nSuch exceptions don't get logged and cause a corrupted state of the Proton object (see https://github.com/vert-x3/vertx-proton/issues/94).\r\nTherefore a solution could be to add exception handling for these handlers.\r\n\r\nAnother issue is that the `link establishment timed out` log message is misleading - the failure to establish the link is caused by the closed connection, not by the \"attach\" frame not getting received on an intact connection.\r\n\r\nEDIT: the origin actually wasn't an unhandled exception thrown in one of the handlers - see [comment below](https://github.com/eclipse/hono/issues/1718#issuecomment-580672008).","closed_by":{"login":"calohmn","id":891931,"node_id":"MDQ6VXNlcjg5MTkzMQ==","avatar_url":"https://avatars.githubusercontent.com/u/891931?v=4","gravatar_id":"","url":"https://api.github.com/users/calohmn","html_url":"https://github.com/calohmn","followers_url":"https://api.github.com/users/calohmn/followers","following_url":"https://api.github.com/users/calohmn/following{/other_user}","gists_url":"https://api.github.com/users/calohmn/gists{/gist_id}","starred_url":"https://api.github.com/users/calohmn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calohmn/subscriptions","organizations_url":"https://api.github.com/users/calohmn/orgs","repos_url":"https://api.github.com/users/calohmn/repos","events_url":"https://api.github.com/users/calohmn/events{/privacy}","received_events_url":"https://api.github.com/users/calohmn/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/eclipse-hono/hono/issues/1718/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/eclipse-hono/hono/issues/1718/timeline","performed_via_github_app":null,"state_reason":"completed"}