<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:57:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLUME-2517] Performance issue: SimpleDateFormat constructor takes 30% of HDFSEventSink.process()</title>
                <link>https://issues.apache.org/jira/browse/FLUME-2517</link>
                <project id="12311321" key="FLUME">Flume</project>
                    <description>&lt;p&gt;I started investigating why HDFS sink has so bad throughput in v 1.5.0.0. It seems to be better in 1.6.0.0 (current trunk).&lt;/p&gt;

&lt;p&gt;PseudoTx channel was filling up, because HDFS Sink could not write as fast as data coming from source.&lt;/p&gt;

&lt;p&gt;Profiling from jconsole revealed that 30% of the time spent in HDFSEventSink.process() method is taken by constructing SimpleDateFormat objects. SimpleDateFormat object is notoriously a heavy and time consuming object to create. It is also not thread-safe.&lt;/p&gt;

&lt;p&gt;It is used in HDFS Sink to calculate the path that contains date-time wildcards. I will provide a patch to cache SimpleDateFormat objects for thread. With this patch, the PseudoTx channel I used for testing was not constantly filling up, and throughput was much better.&lt;/p&gt;</description>
                <environment>&lt;p&gt;linux i686&lt;br/&gt;
java version &quot;1.7.0_45&quot;&lt;/p&gt;</environment>
        <key id="12749878">FLUME-2517</key>
            <summary>Performance issue: SimpleDateFormat constructor takes 30% of HDFSEventSink.process()</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pkonyves">Pal Konyves</assignee>
                                    <reporter username="pkonyves">Pal Konyves</reporter>
                        <labels>
                            <label>performance</label>
                    </labels>
                <created>Wed, 22 Oct 2014 20:50:42 +0000</created>
                <updated>Fri, 17 Apr 2015 01:21:43 +0000</updated>
                            <resolved>Mon, 27 Oct 2014 20:43:28 +0000</resolved>
                                    <version>1.5.0.1</version>
                                    <fixVersion>1.6.0</fixVersion>
                                    <component>Sinks+Sources</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="14180537" author="pkonyves" created="Wed, 22 Oct 2014 21:08:11 +0000"  >&lt;p&gt;Patch attached with cached SimpleDateFormat instances. &lt;br/&gt;
Cleanup of HashMap is intentionally left out, since there isn&apos;t a scenario of an always changing format string. format strings are static and permanent per configuration.&lt;/p&gt;</comment>
                            <comment id="14180561" author="pkonyves" created="Wed, 22 Oct 2014 21:25:56 +0000"  >&lt;p&gt;jconsole and profiling output added before and after patch&lt;/p&gt;</comment>
                            <comment id="14180610" author="hshreedharan" created="Wed, 22 Oct 2014 22:01:56 +0000"  >&lt;p&gt;Why does the map need to be thread-local?&lt;/p&gt;</comment>
                            <comment id="14180648" author="pkonyves" created="Wed, 22 Oct 2014 22:16:26 +0000"  >&lt;p&gt;because as far as i know, SimpleDateFormat is not thread-safe. it stores intermediate values during formatting. Storing them in a ThreadLocal, fixes the concurrent access issue, and it is faster than using synchronized during using the SimpleDateFormat object&lt;/p&gt;</comment>
                            <comment id="14180659" author="hshreedharan" created="Wed, 22 Oct 2014 22:21:05 +0000"  >&lt;p&gt;So you are caching data formats per thread? I don&apos;t think there is a solution - seems like the one you wrote this might be the only solution. Let me think about it&lt;/p&gt;</comment>
                            <comment id="14180674" author="pkonyves" created="Wed, 22 Oct 2014 22:28:13 +0000"  >&lt;p&gt;I think the other option is below, but then we also need to synchronize access to the Map for thread-safety and visibility, maybe use a ConcurrentMap. The problem with this is, that if many threads access the SimpleDateFormat object, the mutex can be slow, although, I didn&apos;t make measurements, how heavy the concurrent access is.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, SimpleDateFormat&amp;gt; cache;
SimpleDateFormat sdf = cache.get(formatString);

&lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt;(sdf) {
  sdf.format(formatString);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;... I don&apos;t want to stick to the thread-local solution, I just would like to avoid creating SimpleDateFormat object for every event.&lt;/p&gt;</comment>
                            <comment id="14182121" author="hshreedharan" created="Thu, 23 Oct 2014 22:55:48 +0000"  >&lt;p&gt;If we keep a map per sink, we don&apos;t need the synchronization, correct? Each sink only processes one event at a time, so that should be fine. Having one thread per map should also work around the synchronization issues.&lt;/p&gt;</comment>
                            <comment id="14182717" author="pkonyves" created="Fri, 24 Oct 2014 12:05:34 +0000"  >&lt;p&gt;I didn&apos;t look into the code in that much detail that uses the BucketPath class. Because one HDFSSink can have multiple writer threads, I assumed, the problematic method can be called from different threads. So it might not make sense to make it thread-safe in this situation.&lt;/p&gt;

&lt;p&gt;On the other hand, if someone in the future wants to call BucketPath#replaceShorthand from multiple threads, it might malfunction. So I think we better make it thread-safe already.&lt;/p&gt;

&lt;p&gt;Here they suggest the same solutions for using SimpleDateFormat: &lt;a href=&quot;http://stackoverflow.com/questions/10411944/java-text-simpledateformat-not-thread-safe&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://stackoverflow.com/questions/10411944/java-text-simpledateformat-not-thread-safe&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14185606" author="hshreedharan" created="Mon, 27 Oct 2014 18:55:13 +0000"  >&lt;p&gt;+1. This looks good to me. Let me run the tests&lt;/p&gt;</comment>
                            <comment id="14185766" author="jira-bot" created="Mon, 27 Oct 2014 20:42:26 +0000"  >&lt;p&gt;Commit 77d56e95ead7a04499aa83d1a78fcfbd957b20c7 in flume&apos;s branch refs/heads/trunk from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hshreedharan&quot; class=&quot;user-hover&quot; rel=&quot;hshreedharan&quot;&gt;hshreedharan&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=flume.git;h=77d56e9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=flume.git;h=77d56e9&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-2517&quot; title=&quot;Performance issue: SimpleDateFormat constructor takes 30% of HDFSEventSink.process()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-2517&quot;&gt;&lt;del&gt;FLUME-2517&lt;/del&gt;&lt;/a&gt;. Cache SimpleDataFormat objects in bucketwriter for better performance.&lt;/p&gt;

&lt;p&gt;(Pal Konyves via Hari)&lt;/p&gt;</comment>
                            <comment id="14185767" author="jira-bot" created="Mon, 27 Oct 2014 20:42:32 +0000"  >&lt;p&gt;Commit 0c1ff2fec6c3b815d54f056c629c8744736cccbb in flume&apos;s branch refs/heads/flume-1.6 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hshreedharan&quot; class=&quot;user-hover&quot; rel=&quot;hshreedharan&quot;&gt;hshreedharan&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=flume.git;h=0c1ff2f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=flume.git;h=0c1ff2f&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-2517&quot; title=&quot;Performance issue: SimpleDateFormat constructor takes 30% of HDFSEventSink.process()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-2517&quot;&gt;&lt;del&gt;FLUME-2517&lt;/del&gt;&lt;/a&gt;. Cache SimpleDataFormat objects in bucketwriter for better performance.&lt;/p&gt;

&lt;p&gt;(Pal Konyves via Hari)&lt;/p&gt;</comment>
                            <comment id="14185773" author="hshreedharan" created="Mon, 27 Oct 2014 20:43:28 +0000"  >&lt;p&gt;Committed! Thanks Pal!&lt;/p&gt;</comment>
                            <comment id="14185865" author="hudson" created="Mon, 27 Oct 2014 21:38:04 +0000"  >&lt;p&gt;SUCCESS: Integrated in flume-trunk #681 (See &lt;a href=&quot;https://builds.apache.org/job/flume-trunk/681/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/flume-trunk/681/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-2517&quot; title=&quot;Performance issue: SimpleDateFormat constructor takes 30% of HDFSEventSink.process()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-2517&quot;&gt;&lt;del&gt;FLUME-2517&lt;/del&gt;&lt;/a&gt;. Cache SimpleDataFormat objects in bucketwriter for better performance. (hshreedharan: &lt;a href=&quot;http://git-wip-us.apache.org/repos/asf/flume/repo?p=flume.git&amp;amp;a=commit&amp;amp;h=77d56e95ead7a04499aa83d1a78fcfbd957b20c7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://git-wip-us.apache.org/repos/asf/flume/repo?p=flume.git&amp;amp;a=commit&amp;amp;h=77d56e95ead7a04499aa83d1a78fcfbd957b20c7&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;flume-ng-core/src/main/java/org/apache/flume/formatter/output/BucketPath.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14185874" author="hudson" created="Mon, 27 Oct 2014 21:44:55 +0000"  >&lt;p&gt;UNSTABLE: Integrated in Flume-trunk-hbase-98 #40 (See &lt;a href=&quot;https://builds.apache.org/job/Flume-trunk-hbase-98/40/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Flume-trunk-hbase-98/40/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-2517&quot; title=&quot;Performance issue: SimpleDateFormat constructor takes 30% of HDFSEventSink.process()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-2517&quot;&gt;&lt;del&gt;FLUME-2517&lt;/del&gt;&lt;/a&gt;. Cache SimpleDataFormat objects in bucketwriter for better performance. (hshreedharan: &lt;a href=&quot;http://git-wip-us.apache.org/repos/asf/flume/repo?p=flume.git&amp;amp;a=commit&amp;amp;h=77d56e95ead7a04499aa83d1a78fcfbd957b20c7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://git-wip-us.apache.org/repos/asf/flume/repo?p=flume.git&amp;amp;a=commit&amp;amp;h=77d56e95ead7a04499aa83d1a78fcfbd957b20c7&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;flume-ng-core/src/main/java/org/apache/flume/formatter/output/BucketPath.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14186081" author="pkonyves" created="Tue, 28 Oct 2014 00:06:35 +0000"  >&lt;p&gt;thanks &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14186122" author="ralph.goers@dslextreme.com" created="Tue, 28 Oct 2014 00:33:38 +0000"  >&lt;p&gt;Wouldn&apos;t it be simpler to use Apache Commons Lang&apos;s FastDateFormat? &lt;a href=&quot;http://commons.apache.org/proper/commons-lang/javadocs/api-release/org/apache/commons/lang3/time/FastDateFormat.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://commons.apache.org/proper/commons-lang/javadocs/api-release/org/apache/commons/lang3/time/FastDateFormat.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14186158" author="hshreedharan" created="Tue, 28 Oct 2014 01:01:53 +0000"  >&lt;p&gt;I don;t have much experience with that? Is it a drop in replacement, and is the performance much better.&lt;/p&gt;</comment>
                            <comment id="14186400" author="ralph.goers@dslextreme.com" created="Tue, 28 Oct 2014 05:37:28 +0000"  >&lt;p&gt;It is mostly compatible and it is thread-safe. See the Javadoc for details. The problem this issue is addressing is the contention on locking the SimpleDateFormat, which using FastDateFormat would solve.&lt;/p&gt;

&lt;p&gt;Note that it also has a DateParser for parsing dates. &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://daniel.mitterdorfer.name/articles/2014/benchmarking-digging-deeper/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://daniel.mitterdorfer.name/articles/2014/benchmarking-digging-deeper/&lt;/a&gt; has a performance comparison of SimpleDateFormat, FastDateFormat and a Thread-scoped SimpleDateFormat.&lt;/p&gt;</comment>
                            <comment id="14186664" author="pkonyves" created="Tue, 28 Oct 2014 09:58:55 +0000"  >&lt;p&gt;I was not aware of this. I think FastDateFormat is also a good solution, if apache commons-lang is already on the dependency list.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12676424" name="flume_2517.patch" size="2437" author="pkonyves" created="Wed, 22 Oct 2014 21:08:11 +0000"/>
                            <attachment id="12676428" name="flume_2517.png" size="675417" author="pkonyves" created="Wed, 22 Oct 2014 21:25:56 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 3 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i21gr3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>