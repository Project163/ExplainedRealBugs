<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:56:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLUME-1175] RollingFileSink complains of Bad File Descriptor upon a reconfig event</title>
                <link>https://issues.apache.org/jira/browse/FLUME-1175</link>
                <project id="12311321" key="FLUME">Flume</project>
                    <description>&lt;p&gt;Steps:&lt;br/&gt;
1) Create a config file that looks something like this:&lt;br/&gt;
agent.channels = c1&lt;br/&gt;
agent.sources = r1&lt;br/&gt;
agent.sinks = k1&lt;br/&gt;
#&lt;br/&gt;
agent.channels.c1.type = MEMORY&lt;br/&gt;
#&lt;br/&gt;
agent.sources.r1.channels = c1&lt;br/&gt;
agent.sources.r1.type = SEQ&lt;br/&gt;
#&lt;br/&gt;
agent.sinks.k1.channel = c1&lt;br/&gt;
agent.sinks.k1.type = FILE_ROLL&lt;br/&gt;
agent.sinks.k1.sink.directory = /var/log/flume-ng&lt;br/&gt;
agent.sinks.k1.sink.rollInterval = 0&lt;/p&gt;

&lt;p&gt;2) Start the Flume NG agent&lt;/p&gt;

&lt;p&gt;3) touch the config file so that a reconfig event is triggered within 30 secs&lt;/p&gt;

&lt;p&gt;4) tail the output file to observer the sequence generator events:&lt;br/&gt;
tail -f /var/log/flume-ng/XXXXXXXXXXXX&lt;/p&gt;

&lt;p&gt;5) Notice that the flow suddenly stops at the reconfig event (within 30 secs after touching the config file). Flow doesn&apos;t continue. The flume log shows a Bad File Descriptor error for the RollingFileSink:&lt;/p&gt;

&lt;p&gt;2012-05-03 01:34:34,806 (SinkRunner-PollingRunner-DefaultSinkProcessor) &lt;span class=&quot;error&quot;&gt;&amp;#91;ERROR - org.apache.flume.SinkRunner$PollingRunner.run(SinkRunner.java:160)&amp;#93;&lt;/span&gt; Unable to deliver event. Exception follows.&lt;br/&gt;
org.apache.flume.EventDeliveryException: Failed to process event: [Event headers = &lt;/p&gt;
{timestamp=1336034074797, nanos=3762297996593382, pri=INFO, host=&amp;lt;mysupersecrethost&amp;gt;, FlumeOG=yes, execcmd=java.nio.HeapByteBuffer[pos=0 lim=24 cap=24], procsource=java.nio.HeapByteBuffer[pos=0 lim=6 cap=6], service=java.nio.HeapByteBuffer[pos=0 lim=4 cap=4]}
&lt;p&gt;, body.length = 26 ]&lt;br/&gt;
        at org.apache.flume.sink.RollingFileSink.process(RollingFileSink.java:201)&lt;br/&gt;
        at org.apache.flume.sink.DefaultSinkProcessor.process(DefaultSinkProcessor.java:68)&lt;br/&gt;
        at org.apache.flume.SinkRunner$PollingRunner.run(SinkRunner.java:147)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:662)&lt;br/&gt;
Caused by: java.io.IOException: Bad file descriptor&lt;br/&gt;
        at java.io.FileOutputStream.writeBytes(Native Method)&lt;br/&gt;
        at java.io.FileOutputStream.write(FileOutputStream.java:282)&lt;br/&gt;
        at java.io.BufferedOutputStream.flushBuffer(BufferedOutputStream.java:65)&lt;br/&gt;
        at java.io.BufferedOutputStream.flush(BufferedOutputStream.java:123)&lt;br/&gt;
        at org.apache.flume.sink.RollingFileSink.process(RollingFileSink.java:193)&lt;br/&gt;
        ... 3 more&lt;/p&gt;</description>
                <environment>&lt;p&gt;CentOS 6.2 64-bit&lt;/p&gt;</environment>
        <key id="12553726">FLUME-1175</key>
            <summary>RollingFileSink complains of Bad File Descriptor upon a reconfig event</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="roshan_naik">Roshan Naik</assignee>
                                    <reporter username="will@cloudera.com">Will McQueen</reporter>
                        <labels>
                    </labels>
                <created>Thu, 3 May 2012 09:40:26 +0000</created>
                <updated>Sat, 8 Dec 2012 01:32:44 +0000</updated>
                            <resolved>Fri, 7 Dec 2012 16:13:54 +0000</resolved>
                                    <version>1.2.0</version>
                                    <fixVersion>1.4.0</fixVersion>
                                    <component>Sinks+Sources</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="13267338" author="will@cloudera.com" created="Thu, 3 May 2012 09:52:22 +0000"  >&lt;p&gt;I&apos;m not sure, but what I think may be happening is:&lt;br/&gt;
1) Reconfig event occurs&lt;br/&gt;
2) RollingFileSink finishes executing its process() method, or maybe the sink runner thread that&apos;s calling RollingFileSink.process gets interrupted somewhere in the middle of the process() call. Either way, I believe in these cases that it&apos;s possible that the process() method will return while the outputStream field still has a non-null value pointing to some BufferedOutputStreamObject&lt;br/&gt;
3) As part of the reconfig steps, the sink&apos;s configure() is called next. And configure() sets the &apos;directory&apos; field, but outputStream field is still set to the old value.&lt;br/&gt;
4) Next, stop() is called (again as part of reconfig steps). outputStream field&apos;s object is flushed and closed, but not nulled-out afterwards.&lt;br/&gt;
5) Next, start() is called. Reconfig steps are done.&lt;br/&gt;
6) Next, sink runner calls process(), which checks if outputStream != null (which is true, since outputStream is pointing to the old, closed BufferedOutputStream).&lt;/p&gt;

&lt;p&gt;So maybe one possible fix could be to insert a line in stop() to null-out the outputStream field (and also null-out the serializer field while we&apos;re at it)... something like this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (serializer != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
  &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
    serializer.flush();
    serializer.beforeClose();
  } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
    logger.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Unable to cleanup serializer. Exception follows.&quot;&lt;/span&gt;, e);
  } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
    serializer = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
  }
}

&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (outputStream != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
  logger.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Closing file {}&quot;&lt;/span&gt;, pathController.getCurrentFile());
  &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
    outputStream.flush();
    outputStream.close();
  } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
    logger.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Unable to close outputStream. Exception follows.&quot;&lt;/span&gt;, e);
  } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
    outputStream = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13507581" author="roshan_naik" created="Fri, 30 Nov 2012 19:29:42 +0000"  >&lt;p&gt;Will McQueen, are you working on this ?&lt;/p&gt;</comment>
                            <comment id="13507597" author="will@cloudera.com" created="Fri, 30 Nov 2012 19:41:57 +0000"  >&lt;p&gt;Hi Roshan,&lt;/p&gt;

&lt;p&gt;Not at the moment, but if you have some time to take it up then that&apos;s fine&lt;br/&gt;
with me.&lt;/p&gt;

&lt;p&gt;Cheers,&lt;br/&gt;
Will&lt;/p&gt;


</comment>
                            <comment id="13507619" author="roshan_naik" created="Fri, 30 Nov 2012 20:04:30 +0000"  >&lt;p&gt;ok.. i have verified that null-ing it out is the right solution.&lt;/p&gt;

&lt;p&gt;One other change i wanted to get opinions on before submitting a patch&lt;/p&gt;

&lt;p&gt;The catch clauses in stop() are swallowing any exception from flush() or close(). But it seems to me that if flush()/close() fails, in the reconfig scenario, an exception should be thrown and let flume to die.  In a normal shutdown case this is not necessary though. However the stop() does not allow exceptions to be thrown.&lt;/p&gt;</comment>
                            <comment id="13507625" author="roshan_naik" created="Fri, 30 Nov 2012 20:23:56 +0000"  >&lt;p&gt;maybe that issue is a deeper topic than this jira ?&lt;/p&gt;</comment>
                            <comment id="13507652" author="roshan_naik" created="Fri, 30 Nov 2012 21:14:21 +0000"  >&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;nulling out outputStream in  RollingFileSink.stop()&lt;/li&gt;
	&lt;li&gt;removing superfluous calls to outputStream.flush()&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13509087" author="roshan_naik" created="Mon, 3 Dec 2012 21:52:16 +0000"  >&lt;p&gt;nulling out outputStream in RollingFileSink.stop()&lt;br/&gt;
removing superfluous calls to outputStream.flush()&lt;/p&gt;</comment>
                            <comment id="13526468" author="brocknoland" created="Fri, 7 Dec 2012 15:50:59 +0000"  >&lt;p&gt;Roshan,&lt;/p&gt;

&lt;p&gt;Regarding the logging the exception. Yes that is a deeper topic. I don&apos;t think our semantics around this are clear. Additionally, lets say you have 5 flows in agent, do you want one of them to kill the whole agent?  This are things which aren&apos;t perfectly clear. Without a clear statement of how things should work I think what we should do is catch and log anything inside of the stop/configure/start.&lt;/p&gt;</comment>
                            <comment id="13526492" author="brocknoland" created="Fri, 7 Dec 2012 16:13:54 +0000"  >&lt;p&gt;Thank you for the patch Roshan! I have committed this to trunk and 1.4!&lt;/p&gt;</comment>
                            <comment id="13526965" author="hudson" created="Sat, 8 Dec 2012 01:32:44 +0000"  >&lt;p&gt;Integrated in flume-trunk #337 (See &lt;a href=&quot;https://builds.apache.org/job/flume-trunk/337/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/flume-trunk/337/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-1175&quot; title=&quot;RollingFileSink complains of Bad File Descriptor upon a reconfig event&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-1175&quot;&gt;&lt;del&gt;FLUME-1175&lt;/del&gt;&lt;/a&gt;: RollingFileSink complains of Bad File Descriptor upon a reconfig event (Revision e858adee407bf76cf2a036433ed4173714505924)&lt;/p&gt;

&lt;p&gt;     Result = SUCCESS&lt;br/&gt;
brock : &lt;a href=&quot;http://git-wip-us.apache.org/repos/asf/flume/repo?p=flume.git&amp;amp;a=commit&amp;amp;h=e858adee407bf76cf2a036433ed4173714505924&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://git-wip-us.apache.org/repos/asf/flume/repo?p=flume.git&amp;amp;a=commit&amp;amp;h=e858adee407bf76cf2a036433ed4173714505924&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;flume-ng-core/src/main/java/org/apache/flume/sink/RollingFileSink.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12555560" name="FLUME-1175.patch" size="1765" author="roshan_naik" created="Fri, 30 Nov 2012 21:14:21 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>237930</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 50 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i09tfz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>55203</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>