<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:56:01 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLUME-936] MemoryChannel is not thread safe</title>
                <link>https://issues.apache.org/jira/browse/FLUME-936</link>
                <project id="12311321" key="FLUME">Flume</project>
                    <description>&lt;p&gt;The memory channel isn&apos;t thread safe as a couple of parallel transactions can commit/rollback each others entries if called in the wrong order.&lt;/p&gt;

&lt;p&gt;I&apos;m attaching a unit test I made that demonstrates it using a cyclicbarrier to force the event order that causes the precondition to fail.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12538936">FLUME-936</key>
            <summary>MemoryChannel is not thread safe</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="juhanic">Juhani Connolly</assignee>
                                    <reporter username="juhanic">Juhani Connolly</reporter>
                        <labels>
                    </labels>
                <created>Thu, 19 Jan 2012 09:48:35 +0000</created>
                <updated>Fri, 24 Feb 2012 06:34:48 +0000</updated>
                            <resolved>Fri, 24 Feb 2012 05:17:32 +0000</resolved>
                                    <version>NG alpha 2</version>
                                    <fixVersion>1.1.0</fixVersion>
                                    <component>Channel</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="13189710" author="juhanic" created="Fri, 20 Jan 2012 09:30:59 +0000"  >&lt;p&gt;The unit test recreates the following order;&lt;/p&gt;

&lt;p&gt;t1: begin transaction&lt;br/&gt;
t1: put&lt;br/&gt;
t2: begin transaction&lt;br/&gt;
t2: put&lt;br/&gt;
t1: rollback transaction   &amp;lt;- Problem happens here as undoPut gets called, and removes the queue entry placed and stamped by t2&lt;br/&gt;
t2: commit transaction   &amp;lt;- As things are right now, this is actually committing the Event that was supposed to have been rolled back&lt;br/&gt;
t1+t2: close transaction&lt;/p&gt;


&lt;p&gt;Overall it seems pretty hairy. One solution I can think of is to keep uncommitted entries in the thread-separate transaction items rather than keeping them in a shared queue&lt;/p&gt;</comment>
                            <comment id="13189963" author="esammer" created="Fri, 20 Jan 2012 18:11:23 +0000"  >&lt;p&gt;Completely agree, Juhani. Do you want to to take a crack at implementing outstanding transactions as threadlocals or something like that?&lt;/p&gt;</comment>
                            <comment id="13190018" author="petenewcomb" created="Fri, 20 Jan 2012 19:20:49 +0000"  >&lt;p&gt;In case it&apos;s useful, take a look at &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-935&quot; title=&quot;Create abstract implementations of basic channel/transaction semantics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-935&quot;&gt;&lt;del&gt;FLUME-935&lt;/del&gt;&lt;/a&gt;, which is my attempt to provide a abstract implementation of Channel with threadlocal Transaction objects.&lt;/p&gt;</comment>
                            <comment id="13190199" author="prasadm" created="Fri, 20 Jan 2012 23:52:17 +0000"  >&lt;p&gt;The original implementation was addressing a single pushing events into the channel. Adding events directly into the shared queue with multiple sources would make it unnecessarily complicated. Keeping the new events local to the  transaction make it much simpler.&lt;br/&gt;
The transactions are already thread local and has local event queues (used for undo), though I guess using the common threadlocal transaction would be better ..&lt;/p&gt;

&lt;p&gt;Juhani, if you are planning to fix it, please go ahead. Otherwise I can pick it up.&lt;/p&gt;</comment>
                            <comment id="13190836" author="juhanic" created="Mon, 23 Jan 2012 00:27:00 +0000"  >&lt;p&gt;Yeah I can take a crack at it, might take a couple days due to other current priorities.&lt;/p&gt;</comment>
                            <comment id="13196764" author="jiraposter@reviews.apache.org" created="Tue, 31 Jan 2012 07:48:08 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/3704/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/3704/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;Review request for Flume.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;This is an initial go at fixing the threading issues with memory channel. &lt;/p&gt;

&lt;p&gt;It uses the preliminary work on &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-935&quot; title=&quot;Create abstract implementations of basic channel/transaction semantics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-935&quot;&gt;&lt;del&gt;FLUME-935&lt;/del&gt;&lt;/a&gt; and I have included the code from that.&lt;/p&gt;

&lt;p&gt;The tagging of the events became unnecessary so I dropped that. One thing that concerns me slightly is how to deal with not having enough space in the queue to rollback failed takes. One method would be to keep a minimum buffer of transactionCapacity. Another would be to implement the queue of queues as suggested in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-889&quot; title=&quot;All events in memory channel are lost on reconfiguration&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-889&quot;&gt;&lt;del&gt;FLUME-889&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Anyway, just putting up this early version to see what people think&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-936&quot; title=&quot;MemoryChannel is not thread safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-936&quot;&gt;&lt;del&gt;FLUME-936&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-936&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLUME-936&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  flume-ng-core/src/main/java/org/apache/flume/channel/BasicChannelSemantics.java PRE-CREATION &lt;br/&gt;
  flume-ng-core/src/main/java/org/apache/flume/channel/BasicTransactionSemantics.java PRE-CREATION &lt;br/&gt;
  flume-ng-core/src/main/java/org/apache/flume/channel/ChannelUtils.java PRE-CREATION &lt;br/&gt;
  flume-ng-core/src/main/java/org/apache/flume/channel/MemoryChannel.java d379b64 &lt;br/&gt;
  flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannel.java b44030e &lt;br/&gt;
  flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannelConcurrency.java PRE-CREATION &lt;br/&gt;
  flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannelTransaction.java d18045b &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/3704/diff&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/3704/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;The original tests pass, though I had to take out the state checks because of the changes to semantics from the flume-935 code. I also had to add a transaction.close statement where semantics were not properly being followed&lt;br/&gt;
I have to retrofit my new concurrency test since without the tagged events it cannot fail without checking that the content is correct. I&apos;ll put that up asap, just wanted to get some eyes on this before I head out.&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Juhani&lt;/p&gt;
</comment>
                            <comment id="13197075" author="jiraposter@reviews.apache.org" created="Tue, 31 Jan 2012 18:22:10 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/3704/#review4706&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/3704/#review4706&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


&lt;p&gt;Thanks for the patch Juhani. Here is my high-level feedback:&lt;/p&gt;

&lt;p&gt;1. Since this depends upon &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-935&quot; title=&quot;Create abstract implementations of basic channel/transaction semantics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-935&quot;&gt;&lt;del&gt;FLUME-935&lt;/del&gt;&lt;/a&gt;, I have marked the issue blocked by that JIRA. I would rather check that in first than have the sources from there be part of the patch here. Accordingly, my feedback is limited to the sources that are not part of &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-935&quot; title=&quot;Create abstract implementations of basic channel/transaction semantics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-935&quot;&gt;&lt;del&gt;FLUME-935&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;2. The concurrent tests that you have added are a good first step. However, I suggest adding another test that has at least 10 simulated sources and sinks with over a hundred events exchanging hands. While the current test asserts correctness over a known scenario, this new test will be able to chance upon failures that may otherwise go unnoticed.&lt;/p&gt;

&lt;p&gt;3. For some reason, the indentation and whitespace is not looking right in the review. I suggest you update your IDE preferences to replace all tabs with spaces, and use a 2-space indent policy. Also, please remove any trailing whitespaces from the code anywhere. Personally, I use AnyEdit tool plugin on my Eclipse which allows the removal of trailing whitespaces on file save. Other tools would work great as well.&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Arvind&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;On 2012-01-31 07:46:56, Juhani Connolly wrote:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an automatically generated e-mail. To reply, visit:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/3704/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/3704/&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;(Updated 2012-01-31 07:46:56)&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Review request for Flume.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Summary&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an initial go at fixing the threading issues with memory channel. &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;It uses the preliminary work on &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-935&quot; title=&quot;Create abstract implementations of basic channel/transaction semantics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-935&quot;&gt;&lt;del&gt;FLUME-935&lt;/del&gt;&lt;/a&gt; and I have included the code from that.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;The tagging of the events became unnecessary so I dropped that. One thing that concerns me slightly is how to deal with not having enough space in the queue to rollback failed takes. One method would be to keep a minimum buffer of transactionCapacity. Another would be to implement the queue of queues as suggested in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-889&quot; title=&quot;All events in memory channel are lost on reconfiguration&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-889&quot;&gt;&lt;del&gt;FLUME-889&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Anyway, just putting up this early version to see what people think&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-936&quot; title=&quot;MemoryChannel is not thread safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-936&quot;&gt;&lt;del&gt;FLUME-936&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-936&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLUME-936&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diffs&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/main/java/org/apache/flume/channel/BasicChannelSemantics.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/main/java/org/apache/flume/channel/BasicTransactionSemantics.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/main/java/org/apache/flume/channel/ChannelUtils.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/main/java/org/apache/flume/channel/MemoryChannel.java d379b64 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannel.java b44030e &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannelConcurrency.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannelTransaction.java d18045b &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/3704/diff&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/3704/diff&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Testing&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;The original tests pass, though I had to take out the state checks because of the changes to semantics from the flume-935 code. I also had to add a transaction.close statement where semantics were not properly being followed&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;I have to retrofit my new concurrency test since without the tagged events it cannot fail without checking that the content is correct. I&apos;ll put that up asap, just wanted to get some eyes on this before I head out.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Thanks,&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Juhani&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
</comment>
                            <comment id="13197422" author="juhanic" created="Wed, 1 Feb 2012 00:23:30 +0000"  >&lt;p&gt;Blocking on 935 makes total sense to me, and as I mentioned there, there was still a couple of things I was concerned in in that. Once that is settled, I will fix up any details left. I&apos;ll put together another unit test today.&lt;/p&gt;

&lt;p&gt;I&apos;m also including in the fixes I made to flume-889 before(that issue can be cancelled as far as I&apos;m concerned), the ones that prevented data loss on reconfiguration&lt;/p&gt;</comment>
                            <comment id="13197717" author="jiraposter@reviews.apache.org" created="Wed, 1 Feb 2012 09:48:58 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/3704/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/3704/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;(Updated 2012-02-01 09:47:28.609110)&lt;/p&gt;


&lt;p&gt;Review request for Flume.&lt;/p&gt;


&lt;p&gt;Changes&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Too much contention for the locks in the original version... Some stuff could have the lock for a full duration of BlockingDeque.offer() and it was starving other threads.&lt;/p&gt;

&lt;p&gt;Should be good now. If someone has time, I&apos;d appreciate if they can have a long hard think over possible failure patterns. It is important to note that rollback can fail and will throw a ChannelException if there is no space to restore commits to. One possible way around this is to maintain an invariant across all threads that consists of queue.remainingCapacity() &amp;gt;= sumallthreads(takeList.size())      Feedback on that would be appreciated&lt;/p&gt;

&lt;p&gt;I added in some unit tests to confirm the correct behavior of the capacities. &lt;br/&gt;
Also added another highly parallel unit test to TestMemoryChannelConcurrency.&lt;br/&gt;
Modified existing unit tests where necessary to adjust configurations where transactioncapacity needed to be set.&lt;/p&gt;

&lt;p&gt;Fixed coding guidelines stuff and added apache license.&lt;br/&gt;
Fixed  a couple of small bugs.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;This is an initial go at fixing the threading issues with memory channel. &lt;/p&gt;

&lt;p&gt;It uses the preliminary work on &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-935&quot; title=&quot;Create abstract implementations of basic channel/transaction semantics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-935&quot;&gt;&lt;del&gt;FLUME-935&lt;/del&gt;&lt;/a&gt; and I have included the code from that.&lt;/p&gt;

&lt;p&gt;The tagging of the events became unnecessary so I dropped that. One thing that concerns me slightly is how to deal with not having enough space in the queue to rollback failed takes. One method would be to keep a minimum buffer of transactionCapacity. Another would be to implement the queue of queues as suggested in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-889&quot; title=&quot;All events in memory channel are lost on reconfiguration&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-889&quot;&gt;&lt;del&gt;FLUME-889&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Anyway, just putting up this early version to see what people think&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-936&quot; title=&quot;MemoryChannel is not thread safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-936&quot;&gt;&lt;del&gt;FLUME-936&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-936&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLUME-936&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs (updated)&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  flume-ng-core/src/main/java/org/apache/flume/channel/BasicChannelSemantics.java PRE-CREATION &lt;br/&gt;
  flume-ng-core/src/main/java/org/apache/flume/channel/BasicTransactionSemantics.java PRE-CREATION &lt;br/&gt;
  flume-ng-core/src/main/java/org/apache/flume/channel/ChannelUtils.java PRE-CREATION &lt;br/&gt;
  flume-ng-core/src/main/java/org/apache/flume/channel/MemoryChannel.java d379b64 &lt;br/&gt;
  flume-ng-core/src/test/java/org/apache/flume/channel/TestFanoutChannel.java ada9a72 &lt;br/&gt;
  flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannel.java b44030e &lt;br/&gt;
  flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannelConcurrency.java PRE-CREATION &lt;br/&gt;
  flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannelTransaction.java d18045b &lt;br/&gt;
  flume-ng-core/src/test/java/org/apache/flume/source/TestExecSource.java 6acbbd5 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/3704/diff&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/3704/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;The original tests pass, though I had to take out the state checks because of the changes to semantics from the flume-935 code. I also had to add a transaction.close statement where semantics were not properly being followed&lt;br/&gt;
I have to retrofit my new concurrency test since without the tagged events it cannot fail without checking that the content is correct. I&apos;ll put that up asap, just wanted to get some eyes on this before I head out.&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Juhani&lt;/p&gt;
</comment>
                            <comment id="13197719" author="jiraposter@reviews.apache.org" created="Wed, 1 Feb 2012 09:54:58 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/3704/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/3704/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;(Updated 2012-02-01 09:52:49.475183)&lt;/p&gt;


&lt;p&gt;Review request for Flume.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;This is an initial go at fixing the threading issues with memory channel. &lt;/p&gt;

&lt;p&gt;It uses the preliminary work on &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-935&quot; title=&quot;Create abstract implementations of basic channel/transaction semantics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-935&quot;&gt;&lt;del&gt;FLUME-935&lt;/del&gt;&lt;/a&gt; and I have included the code from that.&lt;/p&gt;

&lt;p&gt;The tagging of the events became unnecessary so I dropped that. One thing that concerns me slightly is how to deal with not having enough space in the queue to rollback failed takes. One method would be to keep a minimum buffer of transactionCapacity. Another would be to implement the queue of queues as suggested in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-889&quot; title=&quot;All events in memory channel are lost on reconfiguration&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-889&quot;&gt;&lt;del&gt;FLUME-889&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Anyway, just putting up this early version to see what people think&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-936&quot; title=&quot;MemoryChannel is not thread safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-936&quot;&gt;&lt;del&gt;FLUME-936&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-936&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLUME-936&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs (updated)&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  flume-ng-core/src/main/java/org/apache/flume/channel/BasicChannelSemantics.java PRE-CREATION &lt;br/&gt;
  flume-ng-core/src/main/java/org/apache/flume/channel/BasicTransactionSemantics.java PRE-CREATION &lt;br/&gt;
  flume-ng-core/src/main/java/org/apache/flume/channel/ChannelUtils.java PRE-CREATION &lt;br/&gt;
  flume-ng-core/src/main/java/org/apache/flume/channel/MemoryChannel.java d379b64 &lt;br/&gt;
  flume-ng-core/src/test/java/org/apache/flume/channel/TestFanoutChannel.java ada9a72 &lt;br/&gt;
  flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannel.java b44030e &lt;br/&gt;
  flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannelConcurrency.java PRE-CREATION &lt;br/&gt;
  flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannelTransaction.java d18045b &lt;br/&gt;
  flume-ng-core/src/test/java/org/apache/flume/source/TestExecSource.java 6acbbd5 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/3704/diff&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/3704/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;The original tests pass, though I had to take out the state checks because of the changes to semantics from the flume-935 code. I also had to add a transaction.close statement where semantics were not properly being followed&lt;br/&gt;
I have to retrofit my new concurrency test since without the tagged events it cannot fail without checking that the content is correct. I&apos;ll put that up asap, just wanted to get some eyes on this before I head out.&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Juhani&lt;/p&gt;
</comment>
                            <comment id="13197721" author="jiraposter@reviews.apache.org" created="Wed, 1 Feb 2012 09:56:58 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/3704/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/3704/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;(Updated 2012-02-01 09:55:19.470045)&lt;/p&gt;


&lt;p&gt;Review request for Flume.&lt;/p&gt;


&lt;p&gt;Changes&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;white-space... and forgetting to git add, hence the changeless diff&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;This is an initial go at fixing the threading issues with memory channel. &lt;/p&gt;

&lt;p&gt;It uses the preliminary work on &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-935&quot; title=&quot;Create abstract implementations of basic channel/transaction semantics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-935&quot;&gt;&lt;del&gt;FLUME-935&lt;/del&gt;&lt;/a&gt; and I have included the code from that.&lt;/p&gt;

&lt;p&gt;The tagging of the events became unnecessary so I dropped that. One thing that concerns me slightly is how to deal with not having enough space in the queue to rollback failed takes. One method would be to keep a minimum buffer of transactionCapacity. Another would be to implement the queue of queues as suggested in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-889&quot; title=&quot;All events in memory channel are lost on reconfiguration&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-889&quot;&gt;&lt;del&gt;FLUME-889&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Anyway, just putting up this early version to see what people think&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-936&quot; title=&quot;MemoryChannel is not thread safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-936&quot;&gt;&lt;del&gt;FLUME-936&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-936&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLUME-936&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs (updated)&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  flume-ng-core/src/main/java/org/apache/flume/channel/BasicChannelSemantics.java PRE-CREATION &lt;br/&gt;
  flume-ng-core/src/main/java/org/apache/flume/channel/BasicTransactionSemantics.java PRE-CREATION &lt;br/&gt;
  flume-ng-core/src/main/java/org/apache/flume/channel/ChannelUtils.java PRE-CREATION &lt;br/&gt;
  flume-ng-core/src/main/java/org/apache/flume/channel/MemoryChannel.java d379b64 &lt;br/&gt;
  flume-ng-core/src/test/java/org/apache/flume/channel/TestFanoutChannel.java ada9a72 &lt;br/&gt;
  flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannel.java b44030e &lt;br/&gt;
  flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannelConcurrency.java PRE-CREATION &lt;br/&gt;
  flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannelTransaction.java d18045b &lt;br/&gt;
  flume-ng-core/src/test/java/org/apache/flume/source/TestExecSource.java 6acbbd5 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/3704/diff&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/3704/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;The original tests pass, though I had to take out the state checks because of the changes to semantics from the flume-935 code. I also had to add a transaction.close statement where semantics were not properly being followed&lt;br/&gt;
I have to retrofit my new concurrency test since without the tagged events it cannot fail without checking that the content is correct. I&apos;ll put that up asap, just wanted to get some eyes on this before I head out.&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Juhani&lt;/p&gt;
</comment>
                            <comment id="13198016" author="jiraposter@reviews.apache.org" created="Wed, 1 Feb 2012 18:10:57 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/3704/#review4750&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/3704/#review4750&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


&lt;p&gt;The changes overall look fine. A couple of comments,&lt;/p&gt;

&lt;p&gt;1) It should be okay to bump up the queue capacity during before rollback start, to ensure sufficient  space to return the events.&lt;/p&gt;

&lt;p&gt;2) The commit() after put() and rollback() after take() are both &lt;br/&gt;
adding elements to the channel&apos;s queue. But they are under different locks. That means concurrent source and sink could cause queue to reach capacity in the middle of commit/rollback and one of them would be partially complete. I guess its better to use same lock for both operations. &lt;/p&gt;




&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Prasad&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;On 2012-02-01 09:55:19, Juhani Connolly wrote:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an automatically generated e-mail. To reply, visit:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/3704/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/3704/&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;(Updated 2012-02-01 09:55:19)&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Review request for Flume.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Summary&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an initial go at fixing the threading issues with memory channel. &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;It uses the preliminary work on &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-935&quot; title=&quot;Create abstract implementations of basic channel/transaction semantics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-935&quot;&gt;&lt;del&gt;FLUME-935&lt;/del&gt;&lt;/a&gt; and I have included the code from that.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;The tagging of the events became unnecessary so I dropped that. One thing that concerns me slightly is how to deal with not having enough space in the queue to rollback failed takes. One method would be to keep a minimum buffer of transactionCapacity. Another would be to implement the queue of queues as suggested in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-889&quot; title=&quot;All events in memory channel are lost on reconfiguration&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-889&quot;&gt;&lt;del&gt;FLUME-889&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Anyway, just putting up this early version to see what people think&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-936&quot; title=&quot;MemoryChannel is not thread safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-936&quot;&gt;&lt;del&gt;FLUME-936&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-936&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLUME-936&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diffs&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/main/java/org/apache/flume/channel/BasicChannelSemantics.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/main/java/org/apache/flume/channel/BasicTransactionSemantics.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/main/java/org/apache/flume/channel/ChannelUtils.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/main/java/org/apache/flume/channel/MemoryChannel.java d379b64 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/test/java/org/apache/flume/channel/TestFanoutChannel.java ada9a72 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannel.java b44030e &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannelConcurrency.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannelTransaction.java d18045b &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/test/java/org/apache/flume/source/TestExecSource.java 6acbbd5 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/3704/diff&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/3704/diff&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Testing&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;The original tests pass, though I had to take out the state checks because of the changes to semantics from the flume-935 code. I also had to add a transaction.close statement where semantics were not properly being followed&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;I have to retrofit my new concurrency test since without the tagged events it cannot fail without checking that the content is correct. I&apos;ll put that up asap, just wanted to get some eyes on this before I head out.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Thanks,&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Juhani&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
</comment>
                            <comment id="13198388" author="jiraposter@reviews.apache.org" created="Thu, 2 Feb 2012 00:39:52 +0000"  >

&lt;blockquote&gt;&lt;p&gt;On 2012-02-01 18:09:27, Prasad Mujumdar wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; The changes overall look fine. A couple of comments,&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; 1) It should be okay to bump up the queue capacity during before rollback start, to ensure sufficient  space to return the events.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; 2) The commit() after put() and rollback() after take() are both &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; adding elements to the channel&apos;s queue. But they are under different locks. That means concurrent source and sink could cause queue to reach capacity in the middle of commit/rollback and one of them would be partially complete. I guess its better to use same lock for both operations. &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Totally right about 2) I&apos;ve fixed that and will put the patch for that up now&lt;/p&gt;

&lt;p&gt;As far as 1) resizing the queue is pretty awkward. Anything we resize up for rollback would have to be resized back down at some time. If we want to guarantee that rollbacks succeed, I think it would be better just to reserve space in the main queue for the contents of every threads take queue, by maintaining  queue.remainingCapacity() &amp;gt;= sumallthreads(takeList.size()) perhaps this should be a separate issue?&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Juhani&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/3704/#review4750&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/3704/#review4750&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


&lt;p&gt;On 2012-02-01 09:55:19, Juhani Connolly wrote:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an automatically generated e-mail. To reply, visit:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/3704/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/3704/&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;(Updated 2012-02-01 09:55:19)&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Review request for Flume.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Summary&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an initial go at fixing the threading issues with memory channel. &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;It uses the preliminary work on &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-935&quot; title=&quot;Create abstract implementations of basic channel/transaction semantics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-935&quot;&gt;&lt;del&gt;FLUME-935&lt;/del&gt;&lt;/a&gt; and I have included the code from that.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;The tagging of the events became unnecessary so I dropped that. One thing that concerns me slightly is how to deal with not having enough space in the queue to rollback failed takes. One method would be to keep a minimum buffer of transactionCapacity. Another would be to implement the queue of queues as suggested in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-889&quot; title=&quot;All events in memory channel are lost on reconfiguration&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-889&quot;&gt;&lt;del&gt;FLUME-889&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Anyway, just putting up this early version to see what people think&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-936&quot; title=&quot;MemoryChannel is not thread safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-936&quot;&gt;&lt;del&gt;FLUME-936&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-936&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLUME-936&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diffs&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/main/java/org/apache/flume/channel/BasicChannelSemantics.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/main/java/org/apache/flume/channel/BasicTransactionSemantics.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/main/java/org/apache/flume/channel/ChannelUtils.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/main/java/org/apache/flume/channel/MemoryChannel.java d379b64 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/test/java/org/apache/flume/channel/TestFanoutChannel.java ada9a72 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannel.java b44030e &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannelConcurrency.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannelTransaction.java d18045b &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/test/java/org/apache/flume/source/TestExecSource.java 6acbbd5 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/3704/diff&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/3704/diff&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Testing&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;The original tests pass, though I had to take out the state checks because of the changes to semantics from the flume-935 code. I also had to add a transaction.close statement where semantics were not properly being followed&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;I have to retrofit my new concurrency test since without the tagged events it cannot fail without checking that the content is correct. I&apos;ll put that up asap, just wanted to get some eyes on this before I head out.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Thanks,&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Juhani&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
</comment>
                            <comment id="13198395" author="jiraposter@reviews.apache.org" created="Thu, 2 Feb 2012 00:43:52 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/3704/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/3704/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;(Updated 2012-02-02 00:42:37.375992)&lt;/p&gt;


&lt;p&gt;Review request for Flume.&lt;/p&gt;


&lt;p&gt;Changes&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;This addresses Prasad&apos;s concern regarding the queue getting full up by reducing to one lock&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;This is an initial go at fixing the threading issues with memory channel. &lt;/p&gt;

&lt;p&gt;It uses the preliminary work on &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-935&quot; title=&quot;Create abstract implementations of basic channel/transaction semantics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-935&quot;&gt;&lt;del&gt;FLUME-935&lt;/del&gt;&lt;/a&gt; and I have included the code from that.&lt;/p&gt;

&lt;p&gt;The tagging of the events became unnecessary so I dropped that. One thing that concerns me slightly is how to deal with not having enough space in the queue to rollback failed takes. One method would be to keep a minimum buffer of transactionCapacity. Another would be to implement the queue of queues as suggested in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-889&quot; title=&quot;All events in memory channel are lost on reconfiguration&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-889&quot;&gt;&lt;del&gt;FLUME-889&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Anyway, just putting up this early version to see what people think&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-936&quot; title=&quot;MemoryChannel is not thread safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-936&quot;&gt;&lt;del&gt;FLUME-936&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-936&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLUME-936&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs (updated)&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  flume-ng-core/src/main/java/org/apache/flume/channel/BasicChannelSemantics.java PRE-CREATION &lt;br/&gt;
  flume-ng-core/src/main/java/org/apache/flume/channel/BasicTransactionSemantics.java PRE-CREATION &lt;br/&gt;
  flume-ng-core/src/main/java/org/apache/flume/channel/ChannelUtils.java PRE-CREATION &lt;br/&gt;
  flume-ng-core/src/main/java/org/apache/flume/channel/MemoryChannel.java d379b64 &lt;br/&gt;
  flume-ng-core/src/test/java/org/apache/flume/channel/TestFanoutChannel.java ada9a72 &lt;br/&gt;
  flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannel.java b44030e &lt;br/&gt;
  flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannelConcurrency.java PRE-CREATION &lt;br/&gt;
  flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannelTransaction.java d18045b &lt;br/&gt;
  flume-ng-core/src/test/java/org/apache/flume/source/TestExecSource.java 6acbbd5 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/3704/diff&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/3704/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;The original tests pass, though I had to take out the state checks because of the changes to semantics from the flume-935 code. I also had to add a transaction.close statement where semantics were not properly being followed&lt;br/&gt;
I have to retrofit my new concurrency test since without the tagged events it cannot fail without checking that the content is correct. I&apos;ll put that up asap, just wanted to get some eyes on this before I head out.&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Juhani&lt;/p&gt;
</comment>
                            <comment id="13198483" author="jiraposter@reviews.apache.org" created="Thu, 2 Feb 2012 02:27:52 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/3704/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/3704/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;(Updated 2012-02-02 02:27:14.322838)&lt;/p&gt;


&lt;p&gt;Review request for Flume.&lt;/p&gt;


&lt;p&gt;Changes&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;I decided to address Prasad&apos;s issue with failing rollbacks by implementing my invariant idea.&lt;br/&gt;
I also added in a concurrent sink + source test, with a tight capacity(only 100), and 50 each of randomly committing/rollbacking sinks and sources. &lt;/p&gt;

&lt;p&gt;One can note that in it, a failed commit for sources is not exception handled, so the thread would die and with that the test.&lt;br/&gt;
On the other hand, the source thread commits are inside a try/catch and can fail. If they do, they are just rolled back. In practice this means that barring agent failure, anything that has been succesfully committed to the memory channel shouldn&apos;t ever be lost.&lt;/p&gt;

&lt;p&gt;I think that the code is pretty hard to understand... I have tried to annotate and document concurrency guards and invariants, if anyone can think of ways to make it easier to understand let me know.&lt;/p&gt;

&lt;p&gt;Other than that, I believe this patch should hopefully be my final one, solving the outstanding issues. I will be sure to remove the 935 changes from it once I put it up to the JIRA&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;This is an initial go at fixing the threading issues with memory channel. &lt;/p&gt;

&lt;p&gt;It uses the preliminary work on &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-935&quot; title=&quot;Create abstract implementations of basic channel/transaction semantics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-935&quot;&gt;&lt;del&gt;FLUME-935&lt;/del&gt;&lt;/a&gt; and I have included the code from that.&lt;/p&gt;

&lt;p&gt;The tagging of the events became unnecessary so I dropped that. One thing that concerns me slightly is how to deal with not having enough space in the queue to rollback failed takes. One method would be to keep a minimum buffer of transactionCapacity. Another would be to implement the queue of queues as suggested in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-889&quot; title=&quot;All events in memory channel are lost on reconfiguration&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-889&quot;&gt;&lt;del&gt;FLUME-889&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Anyway, just putting up this early version to see what people think&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-936&quot; title=&quot;MemoryChannel is not thread safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-936&quot;&gt;&lt;del&gt;FLUME-936&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-936&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLUME-936&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs (updated)&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  flume-ng-core/src/main/java/org/apache/flume/channel/BasicChannelSemantics.java PRE-CREATION &lt;br/&gt;
  flume-ng-core/src/main/java/org/apache/flume/channel/BasicTransactionSemantics.java PRE-CREATION &lt;br/&gt;
  flume-ng-core/src/main/java/org/apache/flume/channel/ChannelUtils.java PRE-CREATION &lt;br/&gt;
  flume-ng-core/src/main/java/org/apache/flume/channel/MemoryChannel.java d379b64 &lt;br/&gt;
  flume-ng-core/src/test/java/org/apache/flume/channel/TestFanoutChannel.java ada9a72 &lt;br/&gt;
  flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannel.java b44030e &lt;br/&gt;
  flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannelConcurrency.java PRE-CREATION &lt;br/&gt;
  flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannelTransaction.java d18045b &lt;br/&gt;
  flume-ng-core/src/test/java/org/apache/flume/source/TestExecSource.java 6acbbd5 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/3704/diff&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/3704/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;The original tests pass, though I had to take out the state checks because of the changes to semantics from the flume-935 code. I also had to add a transaction.close statement where semantics were not properly being followed&lt;br/&gt;
I have to retrofit my new concurrency test since without the tagged events it cannot fail without checking that the content is correct. I&apos;ll put that up asap, just wanted to get some eyes on this before I head out.&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Juhani&lt;/p&gt;
</comment>
                            <comment id="13198668" author="jiraposter@reviews.apache.org" created="Thu, 2 Feb 2012 10:23:52 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/3704/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/3704/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;(Updated 2012-02-02 10:23:16.661600)&lt;/p&gt;


&lt;p&gt;Review request for Flume.&lt;/p&gt;


&lt;p&gt;Changes&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;One more diff because I had only been running the ng-core tests. Some of the other tests also fail without adjusting the memory channel configuration(I just made the defaults larger rathar than adjusting many different tests)&lt;/p&gt;

&lt;p&gt;Additionally, when running the tests via mvn as opposed to running them one at a time through my IDE, testConcurrentSinksAndSources fails with mismatched put and take counts. I cannot recreate this regardless of how many times I run the test on its own so I&apos;m pretty sure that it is because of mvn concurrently running multiple tests at a time which are then interfering with one another, though if anyone has any other ideas I&apos;m all ears.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;This is an initial go at fixing the threading issues with memory channel. &lt;/p&gt;

&lt;p&gt;It uses the preliminary work on &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-935&quot; title=&quot;Create abstract implementations of basic channel/transaction semantics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-935&quot;&gt;&lt;del&gt;FLUME-935&lt;/del&gt;&lt;/a&gt; and I have included the code from that.&lt;/p&gt;

&lt;p&gt;The tagging of the events became unnecessary so I dropped that. One thing that concerns me slightly is how to deal with not having enough space in the queue to rollback failed takes. One method would be to keep a minimum buffer of transactionCapacity. Another would be to implement the queue of queues as suggested in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-889&quot; title=&quot;All events in memory channel are lost on reconfiguration&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-889&quot;&gt;&lt;del&gt;FLUME-889&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Anyway, just putting up this early version to see what people think&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-936&quot; title=&quot;MemoryChannel is not thread safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-936&quot;&gt;&lt;del&gt;FLUME-936&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-936&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLUME-936&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs (updated)&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  flume-ng-core/src/main/java/org/apache/flume/channel/BasicChannelSemantics.java PRE-CREATION &lt;br/&gt;
  flume-ng-core/src/main/java/org/apache/flume/channel/BasicTransactionSemantics.java PRE-CREATION &lt;br/&gt;
  flume-ng-core/src/main/java/org/apache/flume/channel/ChannelUtils.java PRE-CREATION &lt;br/&gt;
  flume-ng-core/src/main/java/org/apache/flume/channel/MemoryChannel.java d379b64 &lt;br/&gt;
  flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannel.java b44030e &lt;br/&gt;
  flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannelConcurrency.java PRE-CREATION &lt;br/&gt;
  flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannelTransaction.java d18045b &lt;br/&gt;
  flume-ng-core/src/test/java/org/apache/flume/source/TestExecSource.java 46e42e3 &lt;br/&gt;
  flume-ng-node/src/test/java/org/apache/flume/source/TestNetcatSource.java 9e465e1 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/3704/diff&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/3704/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;The original tests pass, though I had to take out the state checks because of the changes to semantics from the flume-935 code. I also had to add a transaction.close statement where semantics were not properly being followed&lt;br/&gt;
I have to retrofit my new concurrency test since without the tagged events it cannot fail without checking that the content is correct. I&apos;ll put that up asap, just wanted to get some eyes on this before I head out.&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Juhani&lt;/p&gt;
</comment>
                            <comment id="13200993" author="jiraposter@reviews.apache.org" created="Mon, 6 Feb 2012 01:37:58 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/3704/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/3704/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;(Updated 2012-02-06 01:37:09.579940)&lt;/p&gt;


&lt;p&gt;Review request for Flume.&lt;/p&gt;


&lt;p&gt;Changes&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;This is a final patch(unless someone runs into problems with it).&lt;br/&gt;
Updated for the latest 728 and I made the tests independent of each other to avoid problems with mvn&apos;s parallel testing.&lt;br/&gt;
Everything runs through the full test suite in mvn without errors, and the new tests include checking that no data is lost with multiple threads parallel put/taking.&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;This is an initial go at fixing the threading issues with memory channel. &lt;/p&gt;

&lt;p&gt;It uses the preliminary work on &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-935&quot; title=&quot;Create abstract implementations of basic channel/transaction semantics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-935&quot;&gt;&lt;del&gt;FLUME-935&lt;/del&gt;&lt;/a&gt; and I have included the code from that.&lt;/p&gt;

&lt;p&gt;The tagging of the events became unnecessary so I dropped that. One thing that concerns me slightly is how to deal with not having enough space in the queue to rollback failed takes. One method would be to keep a minimum buffer of transactionCapacity. Another would be to implement the queue of queues as suggested in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-889&quot; title=&quot;All events in memory channel are lost on reconfiguration&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-889&quot;&gt;&lt;del&gt;FLUME-889&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Anyway, just putting up this early version to see what people think&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-936&quot; title=&quot;MemoryChannel is not thread safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-936&quot;&gt;&lt;del&gt;FLUME-936&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-936&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLUME-936&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs (updated)&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  flume-ng-core/src/main/java/org/apache/flume/channel/BasicChannelSemantics.java PRE-CREATION &lt;br/&gt;
  flume-ng-core/src/main/java/org/apache/flume/channel/BasicTransactionSemantics.java PRE-CREATION &lt;br/&gt;
  flume-ng-core/src/main/java/org/apache/flume/channel/ChannelUtils.java PRE-CREATION &lt;br/&gt;
  flume-ng-core/src/main/java/org/apache/flume/channel/MemoryChannel.java d379b64 &lt;br/&gt;
  flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannel.java b44030e &lt;br/&gt;
  flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannelConcurrency.java PRE-CREATION &lt;br/&gt;
  flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannelTransaction.java d18045b &lt;br/&gt;
  flume-ng-core/src/test/java/org/apache/flume/source/TestExecSource.java 46e42e3 &lt;br/&gt;
  flume-ng-node/src/test/java/org/apache/flume/source/TestNetcatSource.java 9e465e1 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/3704/diff&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/3704/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;The original tests pass, though I had to take out the state checks because of the changes to semantics from the flume-935 code. I also had to add a transaction.close statement where semantics were not properly being followed&lt;br/&gt;
I have to retrofit my new concurrency test since without the tagged events it cannot fail without checking that the content is correct. I&apos;ll put that up asap, just wanted to get some eyes on this before I head out.&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Juhani&lt;/p&gt;
</comment>
                            <comment id="13200997" author="juhanic" created="Mon, 6 Feb 2012 01:41:29 +0000"  >&lt;p&gt;Totally forgot about 935 still not being committed. Hopefully the outstanding issues in that get fixed soon and I&apos;ll fix this against that once that happens.&lt;/p&gt;</comment>
                            <comment id="13200999" author="petenewcomb" created="Mon, 6 Feb 2012 01:58:45 +0000"  >&lt;p&gt;Sorry about the delay, but I&apos;m just finishing up the unit tests around &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-935&quot; title=&quot;Create abstract implementations of basic channel/transaction semantics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-935&quot;&gt;&lt;del&gt;FLUME-935&lt;/del&gt;&lt;/a&gt;.  Hope to post a new patch later this evening.&lt;/p&gt;</comment>
                            <comment id="13201034" author="juhanic" created="Mon, 6 Feb 2012 04:51:45 +0000"  >&lt;p&gt;Great! I&apos;ll keep an eye out for that&lt;/p&gt;</comment>
                            <comment id="13202637" author="jiraposter@reviews.apache.org" created="Tue, 7 Feb 2012 19:08:57 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/3704/#review4871&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/3704/#review4871&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;Ship it!&lt;/p&gt;


&lt;p&gt;Looks good to me. &lt;br/&gt;
Thanks for addressing all the issues and additional tests !&lt;/p&gt;

&lt;p&gt;A minor suggestion, the commits/rollback are updating the putList and takeList under the queueLock. These can be moved outside the synchronized block to reduce the lock contention. Not important, you can log a separate jira later.&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Prasad&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;On 2012-02-06 01:37:09, Juhani Connolly wrote:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an automatically generated e-mail. To reply, visit:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/3704/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/3704/&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;(Updated 2012-02-06 01:37:09)&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Review request for Flume.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Summary&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an initial go at fixing the threading issues with memory channel. &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;It uses the preliminary work on &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-935&quot; title=&quot;Create abstract implementations of basic channel/transaction semantics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-935&quot;&gt;&lt;del&gt;FLUME-935&lt;/del&gt;&lt;/a&gt; and I have included the code from that.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;The tagging of the events became unnecessary so I dropped that. One thing that concerns me slightly is how to deal with not having enough space in the queue to rollback failed takes. One method would be to keep a minimum buffer of transactionCapacity. Another would be to implement the queue of queues as suggested in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-889&quot; title=&quot;All events in memory channel are lost on reconfiguration&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-889&quot;&gt;&lt;del&gt;FLUME-889&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Anyway, just putting up this early version to see what people think&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-936&quot; title=&quot;MemoryChannel is not thread safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-936&quot;&gt;&lt;del&gt;FLUME-936&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-936&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLUME-936&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diffs&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/main/java/org/apache/flume/channel/BasicChannelSemantics.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/main/java/org/apache/flume/channel/BasicTransactionSemantics.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/main/java/org/apache/flume/channel/ChannelUtils.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/main/java/org/apache/flume/channel/MemoryChannel.java d379b64 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannel.java b44030e &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannelConcurrency.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannelTransaction.java d18045b &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/test/java/org/apache/flume/source/TestExecSource.java 46e42e3 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-node/src/test/java/org/apache/flume/source/TestNetcatSource.java 9e465e1 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/3704/diff&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/3704/diff&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Testing&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;The original tests pass, though I had to take out the state checks because of the changes to semantics from the flume-935 code. I also had to add a transaction.close statement where semantics were not properly being followed&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;I have to retrofit my new concurrency test since without the tagged events it cannot fail without checking that the content is correct. I&apos;ll put that up asap, just wanted to get some eyes on this before I head out.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Thanks,&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Juhani&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
</comment>
                            <comment id="13202643" author="prasadm" created="Tue, 7 Feb 2012 19:15:08 +0000"  >&lt;p&gt;@Juhani, please attach the latest patch to the Jira, make sure to grant license to Apache. I will go ahead and commit it.&lt;/p&gt;</comment>
                            <comment id="13203175" author="juhanic" created="Wed, 8 Feb 2012 02:30:52 +0000"  >&lt;p&gt;Prasad: still waiting on 935 to get committed... I looked at it yesterday and it looks good to me. &lt;br/&gt;
However, it does lose the reentrant transaction semantics(which in my opinion makes sense), so I will need to disable the reentrant tests in this patch, I hope that is not a problem.&lt;br/&gt;
I will submit the patch as soon as 935 has been committed&lt;/p&gt;</comment>
                            <comment id="13203316" author="jiraposter@reviews.apache.org" created="Wed, 8 Feb 2012 06:48:57 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/3704/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/3704/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;(Updated 2012-02-08 06:47:33.989223)&lt;/p&gt;


&lt;p&gt;Review request for Flume.&lt;/p&gt;


&lt;p&gt;Changes&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;This is the diff that does not include the work from &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-935&quot; title=&quot;Create abstract implementations of basic channel/transaction semantics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-935&quot;&gt;&lt;del&gt;FLUME-935&lt;/del&gt;&lt;/a&gt; that should be committed once that has gone through.&lt;/p&gt;

&lt;p&gt;There was a concurrency bug in the unit test which I have now fixed.&lt;br/&gt;
I also improved concurrency by introducing a couple of semaphores so that threads could wait on data without having to block inside the synchronization mechanisms(the patch originally simply didn&apos;t block... Which for some usages would be rather user-unfriendly&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;This is an initial go at fixing the threading issues with memory channel. &lt;/p&gt;

&lt;p&gt;It uses the preliminary work on &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-935&quot; title=&quot;Create abstract implementations of basic channel/transaction semantics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-935&quot;&gt;&lt;del&gt;FLUME-935&lt;/del&gt;&lt;/a&gt; and I have included the code from that.&lt;/p&gt;

&lt;p&gt;The tagging of the events became unnecessary so I dropped that. One thing that concerns me slightly is how to deal with not having enough space in the queue to rollback failed takes. One method would be to keep a minimum buffer of transactionCapacity. Another would be to implement the queue of queues as suggested in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-889&quot; title=&quot;All events in memory channel are lost on reconfiguration&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-889&quot;&gt;&lt;del&gt;FLUME-889&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Anyway, just putting up this early version to see what people think&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-936&quot; title=&quot;MemoryChannel is not thread safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-936&quot;&gt;&lt;del&gt;FLUME-936&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-936&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLUME-936&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs (updated)&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  flume-ng-core/src/main/java/org/apache/flume/channel/MemoryChannel.java d379b64 &lt;br/&gt;
  flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannel.java b44030e &lt;br/&gt;
  flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannelConcurrency.java PRE-CREATION &lt;br/&gt;
  flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannelTransaction.java d18045b &lt;br/&gt;
  flume-ng-core/src/test/java/org/apache/flume/source/TestExecSource.java 46e42e3 &lt;br/&gt;
  flume-ng-node/src/test/java/org/apache/flume/source/TestNetcatSource.java 9e465e1 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/3704/diff&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/3704/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;The original tests pass, though I had to take out the state checks because of the changes to semantics from the flume-935 code. I also had to add a transaction.close statement where semantics were not properly being followed&lt;br/&gt;
I have to retrofit my new concurrency test since without the tagged events it cannot fail without checking that the content is correct. I&apos;ll put that up asap, just wanted to get some eyes on this before I head out.&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Juhani&lt;/p&gt;
</comment>
                            <comment id="13203318" author="juhanic" created="Wed, 8 Feb 2012 06:49:36 +0000"  >&lt;p&gt;Patch not intended for inclusion until &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-935&quot; title=&quot;Create abstract implementations of basic channel/transaction semantics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-935&quot;&gt;&lt;del&gt;FLUME-935&lt;/del&gt;&lt;/a&gt; has been committed. Additional fixes are necessary if &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-935&quot; title=&quot;Create abstract implementations of basic channel/transaction semantics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-935&quot;&gt;&lt;del&gt;FLUME-935&lt;/del&gt;&lt;/a&gt; changes from its state in revision 5 of &lt;a href=&quot;https://reviews.apache.org/r/3516/diff/#index_header&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/3516/diff/#index_header&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13209954" author="juhanic" created="Fri, 17 Feb 2012 01:14:24 +0000"  >&lt;p&gt;936-2 wasn&apos;t patching correctly against the latest flume-728 so here&apos;s an updated patchfile now that 935 is available.&lt;br/&gt;
Tests pass, but there is some weirdness going on with rat failing on licenses because it tries to examine the surefire reports...&lt;/p&gt;</comment>
                            <comment id="13209956" author="juhanic" created="Fri, 17 Feb 2012 01:15:23 +0000"  >&lt;p&gt;Forgot to grant license&lt;/p&gt;</comment>
                            <comment id="13211648" author="jiraposter@reviews.apache.org" created="Mon, 20 Feb 2012 03:05:38 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/3704/#review5217&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/3704/#review5217&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


&lt;p&gt;Juhani - can you please confirm if this change is the latest? I see this diff is named &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-936&quot; title=&quot;MemoryChannel is not thread safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-936&quot;&gt;&lt;del&gt;FLUME-936&lt;/del&gt;&lt;/a&gt;-2.patch while the one attached to the jira is &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-936&quot; title=&quot;MemoryChannel is not thread safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-936&quot;&gt;&lt;del&gt;FLUME-936&lt;/del&gt;&lt;/a&gt;-3.patch. &lt;/p&gt;

&lt;p&gt;Should I go ahead and review this or are you planning to update this diff?&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Arvind&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;On 2012-02-08 06:47:33, Juhani Connolly wrote:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an automatically generated e-mail. To reply, visit:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/3704/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/3704/&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;(Updated 2012-02-08 06:47:33)&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Review request for Flume.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Summary&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an initial go at fixing the threading issues with memory channel. &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;It uses the preliminary work on &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-935&quot; title=&quot;Create abstract implementations of basic channel/transaction semantics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-935&quot;&gt;&lt;del&gt;FLUME-935&lt;/del&gt;&lt;/a&gt; and I have included the code from that.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;The tagging of the events became unnecessary so I dropped that. One thing that concerns me slightly is how to deal with not having enough space in the queue to rollback failed takes. One method would be to keep a minimum buffer of transactionCapacity. Another would be to implement the queue of queues as suggested in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-889&quot; title=&quot;All events in memory channel are lost on reconfiguration&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-889&quot;&gt;&lt;del&gt;FLUME-889&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Anyway, just putting up this early version to see what people think&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-936&quot; title=&quot;MemoryChannel is not thread safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-936&quot;&gt;&lt;del&gt;FLUME-936&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-936&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLUME-936&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diffs&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/main/java/org/apache/flume/channel/MemoryChannel.java d379b64 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannel.java b44030e &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannelConcurrency.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannelTransaction.java d18045b &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/test/java/org/apache/flume/source/TestExecSource.java 46e42e3 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-node/src/test/java/org/apache/flume/source/TestNetcatSource.java 9e465e1 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/3704/diff&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/3704/diff&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Testing&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;The original tests pass, though I had to take out the state checks because of the changes to semantics from the flume-935 code. I also had to add a transaction.close statement where semantics were not properly being followed&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;I have to retrofit my new concurrency test since without the tagged events it cannot fail without checking that the content is correct. I&apos;ll put that up asap, just wanted to get some eyes on this before I head out.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Thanks,&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Juhani&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
</comment>
                            <comment id="13211672" author="jiraposter@reviews.apache.org" created="Mon, 20 Feb 2012 05:09:33 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/3704/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/3704/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;(Updated 2012-02-20 05:09:19.954344)&lt;/p&gt;


&lt;p&gt;Review request for Flume.&lt;/p&gt;


&lt;p&gt;Changes&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Uploaded &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-936&quot; title=&quot;MemoryChannel is not thread safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-936&quot;&gt;&lt;del&gt;FLUME-936&lt;/del&gt;&lt;/a&gt;-3.patch&lt;br/&gt;
There is no difference in this patch from the last one, just based on the latest flume-728 as the previous patch wasn&apos;t applying cleanly&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;This is an initial go at fixing the threading issues with memory channel. &lt;/p&gt;

&lt;p&gt;It uses the preliminary work on &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-935&quot; title=&quot;Create abstract implementations of basic channel/transaction semantics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-935&quot;&gt;&lt;del&gt;FLUME-935&lt;/del&gt;&lt;/a&gt; and I have included the code from that.&lt;/p&gt;

&lt;p&gt;The tagging of the events became unnecessary so I dropped that. One thing that concerns me slightly is how to deal with not having enough space in the queue to rollback failed takes. One method would be to keep a minimum buffer of transactionCapacity. Another would be to implement the queue of queues as suggested in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-889&quot; title=&quot;All events in memory channel are lost on reconfiguration&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-889&quot;&gt;&lt;del&gt;FLUME-889&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Anyway, just putting up this early version to see what people think&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-936&quot; title=&quot;MemoryChannel is not thread safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-936&quot;&gt;&lt;del&gt;FLUME-936&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-936&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLUME-936&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs (updated)&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  flume-ng-core/src/main/java/org/apache/flume/channel/MemoryChannel.java 6a17f06 &lt;br/&gt;
  flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannel.java b44030e &lt;br/&gt;
  flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannelConcurrency.java PRE-CREATION &lt;br/&gt;
  flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannelTransaction.java d18045b &lt;br/&gt;
  flume-ng-core/src/test/java/org/apache/flume/source/TestExecSource.java 3014368 &lt;br/&gt;
  flume-ng-node/src/test/java/org/apache/flume/source/TestNetcatSource.java 9e465e1 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/3704/diff&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/3704/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;The original tests pass, though I had to take out the state checks because of the changes to semantics from the flume-935 code. I also had to add a transaction.close statement where semantics were not properly being followed&lt;br/&gt;
I have to retrofit my new concurrency test since without the tagged events it cannot fail without checking that the content is correct. I&apos;ll put that up asap, just wanted to get some eyes on this before I head out.&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Juhani&lt;/p&gt;
</comment>
                            <comment id="13212409" author="jiraposter@reviews.apache.org" created="Tue, 21 Feb 2012 06:41:32 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/3704/#review5234&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/3704/#review5234&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


&lt;p&gt;Thanks for the patch Juhani. Can you please rebase it and update the review? It is not applying cleanly for MemoryChannel.java. &lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Arvind&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;On 2012-02-20 05:09:19, Juhani Connolly wrote:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an automatically generated e-mail. To reply, visit:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/3704/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/3704/&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;(Updated 2012-02-20 05:09:19)&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Review request for Flume.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Summary&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an initial go at fixing the threading issues with memory channel. &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;It uses the preliminary work on &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-935&quot; title=&quot;Create abstract implementations of basic channel/transaction semantics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-935&quot;&gt;&lt;del&gt;FLUME-935&lt;/del&gt;&lt;/a&gt; and I have included the code from that.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;The tagging of the events became unnecessary so I dropped that. One thing that concerns me slightly is how to deal with not having enough space in the queue to rollback failed takes. One method would be to keep a minimum buffer of transactionCapacity. Another would be to implement the queue of queues as suggested in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-889&quot; title=&quot;All events in memory channel are lost on reconfiguration&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-889&quot;&gt;&lt;del&gt;FLUME-889&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Anyway, just putting up this early version to see what people think&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-936&quot; title=&quot;MemoryChannel is not thread safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-936&quot;&gt;&lt;del&gt;FLUME-936&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-936&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLUME-936&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diffs&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/main/java/org/apache/flume/channel/MemoryChannel.java 6a17f06 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannel.java b44030e &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannelConcurrency.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannelTransaction.java d18045b &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/test/java/org/apache/flume/source/TestExecSource.java 3014368 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-node/src/test/java/org/apache/flume/source/TestNetcatSource.java 9e465e1 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/3704/diff&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/3704/diff&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Testing&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;The original tests pass, though I had to take out the state checks because of the changes to semantics from the flume-935 code. I also had to add a transaction.close statement where semantics were not properly being followed&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;I have to retrofit my new concurrency test since without the tagged events it cannot fail without checking that the content is correct. I&apos;ll put that up asap, just wanted to get some eyes on this before I head out.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Thanks,&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Juhani&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
</comment>
                            <comment id="13212414" author="jiraposter@reviews.apache.org" created="Tue, 21 Feb 2012 06:51:33 +0000"  >
&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/3704/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/3704/&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;

&lt;p&gt;(Updated 2012-02-21 06:51:00.751898)&lt;/p&gt;


&lt;p&gt;Review request for Flume.&lt;/p&gt;


&lt;p&gt;Changes&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;Rebased patch and tested with following:&lt;/p&gt;

&lt;p&gt; 1005  git pull origin flume-728&lt;br/&gt;
 1009  git diff 44850b9989a4c13716cbc6 &amp;gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-936&quot; title=&quot;MemoryChannel is not thread safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-936&quot;&gt;&lt;del&gt;FLUME-936&lt;/del&gt;&lt;/a&gt;-4.patch&lt;br/&gt;
 1010  git checkout origin/flume-728 -b temp&lt;br/&gt;
 1012  git apply &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-936&quot; title=&quot;MemoryChannel is not thread safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-936&quot;&gt;&lt;del&gt;FLUME-936&lt;/del&gt;&lt;/a&gt;-4.patch&lt;br/&gt;
 1014  mvn clean&lt;br/&gt;
 1015  mvn test&lt;/p&gt;

&lt;p&gt;Results are fine&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt; ------------------------------------------------------------------------&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt; Reactor Summary:&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt; &lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt; Apache Flume ...................................... SUCCESS &lt;span class=&quot;error&quot;&gt;&amp;#91;4.458s&amp;#93;&lt;/span&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt; Flume NG Core ..................................... SUCCESS &lt;span class=&quot;error&quot;&gt;&amp;#91;1:47.853s&amp;#93;&lt;/span&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt; Flume NG Sinks .................................... SUCCESS &lt;span class=&quot;error&quot;&gt;&amp;#91;0.096s&amp;#93;&lt;/span&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt; Flume NG HDFS Sink ................................ SUCCESS &lt;span class=&quot;error&quot;&gt;&amp;#91;14.040s&amp;#93;&lt;/span&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt; Flume NG IRC Sink ................................. SUCCESS &lt;span class=&quot;error&quot;&gt;&amp;#91;0.890s&amp;#93;&lt;/span&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt; Flume NG Channels ................................. SUCCESS &lt;span class=&quot;error&quot;&gt;&amp;#91;0.065s&amp;#93;&lt;/span&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt; Flume NG JDBC channel ............................. SUCCESS &lt;span class=&quot;error&quot;&gt;&amp;#91;28.434s&amp;#93;&lt;/span&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt; Flume NG Node ..................................... SUCCESS &lt;span class=&quot;error&quot;&gt;&amp;#91;31.250s&amp;#93;&lt;/span&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt; Flume NG file-based channel ....................... SUCCESS &lt;span class=&quot;error&quot;&gt;&amp;#91;1.793s&amp;#93;&lt;/span&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt; Flume NG distribution ............................. SUCCESS &lt;span class=&quot;error&quot;&gt;&amp;#91;0.754s&amp;#93;&lt;/span&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt; Flume legacy Sources .............................. SUCCESS &lt;span class=&quot;error&quot;&gt;&amp;#91;0.134s&amp;#93;&lt;/span&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt; Flume legacy Thrift Source ........................ SUCCESS &lt;span class=&quot;error&quot;&gt;&amp;#91;3.043s&amp;#93;&lt;/span&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt; Flume legacy Avro source .......................... SUCCESS &lt;span class=&quot;error&quot;&gt;&amp;#91;2.876s&amp;#93;&lt;/span&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt; Flume NG Clients .................................. SUCCESS &lt;span class=&quot;error&quot;&gt;&amp;#91;0.062s&amp;#93;&lt;/span&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt; Flume NG Log4j Appender ........................... SUCCESS &lt;span class=&quot;error&quot;&gt;&amp;#91;3.732s&amp;#93;&lt;/span&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt; ------------------------------------------------------------------------&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt; BUILD SUCCESS&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt; ------------------------------------------------------------------------&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt; Total time: 3:19.980s&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt; Finished at: Tue Feb 21 15:49:08 JST 2012&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt; Final Memory: 83M/229M&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt; ------------------------------------------------------------------------&lt;/p&gt;


&lt;p&gt;Summary&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;This is an initial go at fixing the threading issues with memory channel. &lt;/p&gt;

&lt;p&gt;It uses the preliminary work on &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-935&quot; title=&quot;Create abstract implementations of basic channel/transaction semantics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-935&quot;&gt;&lt;del&gt;FLUME-935&lt;/del&gt;&lt;/a&gt; and I have included the code from that.&lt;/p&gt;

&lt;p&gt;The tagging of the events became unnecessary so I dropped that. One thing that concerns me slightly is how to deal with not having enough space in the queue to rollback failed takes. One method would be to keep a minimum buffer of transactionCapacity. Another would be to implement the queue of queues as suggested in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-889&quot; title=&quot;All events in memory channel are lost on reconfiguration&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-889&quot;&gt;&lt;del&gt;FLUME-889&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Anyway, just putting up this early version to see what people think&lt;/p&gt;


&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-936&quot; title=&quot;MemoryChannel is not thread safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-936&quot;&gt;&lt;del&gt;FLUME-936&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-936&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLUME-936&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Diffs (updated)&lt;/p&gt;
&lt;hr /&gt;

&lt;p&gt;  flume-ng-core/src/main/java/org/apache/flume/channel/MemoryChannel.java 6a17f06 &lt;br/&gt;
  flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannel.java b44030e &lt;br/&gt;
  flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannelConcurrency.java PRE-CREATION &lt;br/&gt;
  flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannelTransaction.java d18045b &lt;br/&gt;
  flume-ng-core/src/test/java/org/apache/flume/source/TestExecSource.java 3014368 &lt;br/&gt;
  flume-ng-node/src/test/java/org/apache/flume/source/TestNetcatSource.java 9e465e1 &lt;/p&gt;

&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/3704/diff&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/3704/diff&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Testing&lt;br/&gt;
-------&lt;/p&gt;

&lt;p&gt;The original tests pass, though I had to take out the state checks because of the changes to semantics from the flume-935 code. I also had to add a transaction.close statement where semantics were not properly being followed&lt;br/&gt;
I have to retrofit my new concurrency test since without the tagged events it cannot fail without checking that the content is correct. I&apos;ll put that up asap, just wanted to get some eyes on this before I head out.&lt;/p&gt;


&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Juhani&lt;/p&gt;
</comment>
                            <comment id="13212420" author="jiraposter@reviews.apache.org" created="Tue, 21 Feb 2012 07:15:33 +0000"  >

&lt;blockquote&gt;&lt;p&gt;On 2012-02-21 06:40:54, Arvind Prabhakar wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; Thanks for the patch Juhani. Can you please rebase it and update the review? It is not applying cleanly for MemoryChannel.java. &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I just diffed patch-3 and patch-4(from my updated diff below) and they appear to be identical.&lt;br/&gt;
Can you paste the output of the failed apply attempt?&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Juhani&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/3704/#review5234&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/3704/#review5234&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


&lt;p&gt;On 2012-02-21 06:51:00, Juhani Connolly wrote:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an automatically generated e-mail. To reply, visit:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/3704/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/3704/&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;(Updated 2012-02-21 06:51:00)&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Review request for Flume.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Summary&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an initial go at fixing the threading issues with memory channel. &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;It uses the preliminary work on &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-935&quot; title=&quot;Create abstract implementations of basic channel/transaction semantics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-935&quot;&gt;&lt;del&gt;FLUME-935&lt;/del&gt;&lt;/a&gt; and I have included the code from that.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;The tagging of the events became unnecessary so I dropped that. One thing that concerns me slightly is how to deal with not having enough space in the queue to rollback failed takes. One method would be to keep a minimum buffer of transactionCapacity. Another would be to implement the queue of queues as suggested in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-889&quot; title=&quot;All events in memory channel are lost on reconfiguration&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-889&quot;&gt;&lt;del&gt;FLUME-889&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Anyway, just putting up this early version to see what people think&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-936&quot; title=&quot;MemoryChannel is not thread safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-936&quot;&gt;&lt;del&gt;FLUME-936&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-936&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLUME-936&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diffs&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/main/java/org/apache/flume/channel/MemoryChannel.java 6a17f06 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannel.java b44030e &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannelConcurrency.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannelTransaction.java d18045b &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/test/java/org/apache/flume/source/TestExecSource.java 3014368 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-node/src/test/java/org/apache/flume/source/TestNetcatSource.java 9e465e1 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/3704/diff&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/3704/diff&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Testing&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;The original tests pass, though I had to take out the state checks because of the changes to semantics from the flume-935 code. I also had to add a transaction.close statement where semantics were not properly being followed&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;I have to retrofit my new concurrency test since without the tagged events it cannot fail without checking that the content is correct. I&apos;ll put that up asap, just wanted to get some eyes on this before I head out.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Thanks,&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Juhani&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
</comment>
                            <comment id="13212422" author="jiraposter@reviews.apache.org" created="Tue, 21 Feb 2012 07:29:34 +0000"  >

&lt;blockquote&gt;&lt;p&gt;On 2012-02-21 06:40:54, Arvind Prabhakar wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; Thanks for the patch Juhani. Can you please rebase it and update the review? It is not applying cleanly for MemoryChannel.java. &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Juhani Connolly wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;I just diffed patch-3 and patch-4(from my updated diff below) and they appear to be identical.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Can you paste the output of the failed apply attempt?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;just to be totally sure, I did a fresh svn checkout/patch and it was fine.&lt;/p&gt;

&lt;p&gt; 1032  mkdir flume&lt;br/&gt;
 1033  cd flume&lt;br/&gt;
 1034  svn checkout &lt;a href=&quot;https://svn.apache.org/repos/asf/incubator/flume/branches/flume-728/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/repos/asf/incubator/flume/branches/flume-728/&lt;/a&gt;&lt;br/&gt;
 1035  cd flume-728/&lt;br/&gt;
 1037  patch -p1 &amp;lt; ~/workspace/flume/&lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-936&quot; title=&quot;MemoryChannel is not thread safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-936&quot;&gt;&lt;del&gt;FLUME-936&lt;/del&gt;&lt;/a&gt;-4.patch &lt;br/&gt;
 1038  mvn test&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Juhani&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/3704/#review5234&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/3704/#review5234&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


&lt;p&gt;On 2012-02-21 06:51:00, Juhani Connolly wrote:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an automatically generated e-mail. To reply, visit:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/3704/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/3704/&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;(Updated 2012-02-21 06:51:00)&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Review request for Flume.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Summary&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an initial go at fixing the threading issues with memory channel. &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;It uses the preliminary work on &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-935&quot; title=&quot;Create abstract implementations of basic channel/transaction semantics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-935&quot;&gt;&lt;del&gt;FLUME-935&lt;/del&gt;&lt;/a&gt; and I have included the code from that.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;The tagging of the events became unnecessary so I dropped that. One thing that concerns me slightly is how to deal with not having enough space in the queue to rollback failed takes. One method would be to keep a minimum buffer of transactionCapacity. Another would be to implement the queue of queues as suggested in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-889&quot; title=&quot;All events in memory channel are lost on reconfiguration&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-889&quot;&gt;&lt;del&gt;FLUME-889&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Anyway, just putting up this early version to see what people think&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-936&quot; title=&quot;MemoryChannel is not thread safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-936&quot;&gt;&lt;del&gt;FLUME-936&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-936&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLUME-936&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diffs&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/main/java/org/apache/flume/channel/MemoryChannel.java 6a17f06 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannel.java b44030e &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannelConcurrency.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannelTransaction.java d18045b &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/test/java/org/apache/flume/source/TestExecSource.java 3014368 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-node/src/test/java/org/apache/flume/source/TestNetcatSource.java 9e465e1 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/3704/diff&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/3704/diff&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Testing&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;The original tests pass, though I had to take out the state checks because of the changes to semantics from the flume-935 code. I also had to add a transaction.close statement where semantics were not properly being followed&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;I have to retrofit my new concurrency test since without the tagged events it cannot fail without checking that the content is correct. I&apos;ll put that up asap, just wanted to get some eyes on this before I head out.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Thanks,&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Juhani&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
</comment>
                            <comment id="13215389" author="prasadm" created="Fri, 24 Feb 2012 05:17:32 +0000"  >&lt;p&gt;Patch committed to Flume 1.x codeline.&lt;br/&gt;
Thanks Juhani !&lt;/p&gt;</comment>
                            <comment id="13215421" author="hudson" created="Fri, 24 Feb 2012 06:15:37 +0000"  >&lt;p&gt;Integrated in flume-728 #115 (See &lt;a href=&quot;https://builds.apache.org/job/flume-728/115/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/flume-728/115/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-936&quot; title=&quot;MemoryChannel is not thread safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-936&quot;&gt;&lt;del&gt;FLUME-936&lt;/del&gt;&lt;/a&gt;: MemoryChannel is not thread safe&lt;br/&gt;
(Juhani Connolly via Prasad Mujumdar) (Revision 1293084)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
prasadm : &lt;a href=&quot;http://svn.apache.org/viewvc/?view=rev&amp;amp;rev=1293084&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc/?view=rev&amp;amp;rev=1293084&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/incubator/flume/branches/flume-728/flume-ng-core/src/main/java/org/apache/flume/channel/MemoryChannel.java&lt;/li&gt;
	&lt;li&gt;/incubator/flume/branches/flume-728/flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannel.java&lt;/li&gt;
	&lt;li&gt;/incubator/flume/branches/flume-728/flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannelConcurrency.java&lt;/li&gt;
	&lt;li&gt;/incubator/flume/branches/flume-728/flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannelTransaction.java&lt;/li&gt;
	&lt;li&gt;/incubator/flume/branches/flume-728/flume-ng-core/src/test/java/org/apache/flume/source/TestExecSource.java&lt;/li&gt;
	&lt;li&gt;/incubator/flume/branches/flume-728/flume-ng-node/src/test/java/org/apache/flume/source/TestNetcatSource.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13215429" author="jiraposter@reviews.apache.org" created="Fri, 24 Feb 2012 06:34:47 +0000"  >

&lt;blockquote&gt;&lt;p&gt;On 2012-02-21 06:40:54, Arvind Prabhakar wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; Thanks for the patch Juhani. Can you please rebase it and update the review? It is not applying cleanly for MemoryChannel.java. &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Juhani Connolly wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;I just diffed patch-3 and patch-4(from my updated diff below) and they appear to be identical.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Can you paste the output of the failed apply attempt?&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Juhani Connolly wrote:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;just to be totally sure, I did a fresh svn checkout/patch and it was fine.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;1032  mkdir flume&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;1033  cd flume&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;1034  svn checkout &lt;a href=&quot;https://svn.apache.org/repos/asf/incubator/flume/branches/flume-728/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/repos/asf/incubator/flume/branches/flume-728/&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;1035  cd flume-728/&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;1037  patch -p1 &amp;lt; ~/workspace/flume/&lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-936&quot; title=&quot;MemoryChannel is not thread safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-936&quot;&gt;&lt;del&gt;FLUME-936&lt;/del&gt;&lt;/a&gt;-4.patch &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;1038  mvn test&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Thanks Juhani. I probably did not apply the patch correctly or had some local changes at the time that may have caused conflict. Since I do not have the workspace now I cannot say for sure what the problem was. However, since the patch was committed, chances are there was no problem and it was a pilot error on my part. Thanks for making doubly sure of it though.&lt;/p&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Arvind&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;-----------------------------------------------------------&lt;br/&gt;
This is an automatically generated e-mail. To reply, visit:&lt;br/&gt;
&lt;a href=&quot;https://reviews.apache.org/r/3704/#review5234&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/3704/#review5234&lt;/a&gt;&lt;br/&gt;
-----------------------------------------------------------&lt;/p&gt;


&lt;p&gt;On 2012-02-21 06:51:00, Juhani Connolly wrote:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an automatically generated e-mail. To reply, visit:&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://reviews.apache.org/r/3704/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/3704/&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----------------------------------------------------------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;(Updated 2012-02-21 06:51:00)&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Review request for Flume.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Summary&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This is an initial go at fixing the threading issues with memory channel. &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;It uses the preliminary work on &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-935&quot; title=&quot;Create abstract implementations of basic channel/transaction semantics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-935&quot;&gt;&lt;del&gt;FLUME-935&lt;/del&gt;&lt;/a&gt; and I have included the code from that.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;The tagging of the events became unnecessary so I dropped that. One thing that concerns me slightly is how to deal with not having enough space in the queue to rollback failed takes. One method would be to keep a minimum buffer of transactionCapacity. Another would be to implement the queue of queues as suggested in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-889&quot; title=&quot;All events in memory channel are lost on reconfiguration&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-889&quot;&gt;&lt;del&gt;FLUME-889&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Anyway, just putting up this early version to see what people think&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This addresses bug &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-936&quot; title=&quot;MemoryChannel is not thread safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-936&quot;&gt;&lt;del&gt;FLUME-936&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-936&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLUME-936&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diffs&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-----&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/main/java/org/apache/flume/channel/MemoryChannel.java 6a17f06 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannel.java b44030e &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannelConcurrency.java PRE-CREATION &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannelTransaction.java d18045b &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-core/src/test/java/org/apache/flume/source/TestExecSource.java 3014368 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;flume-ng-node/src/test/java/org/apache/flume/source/TestNetcatSource.java 9e465e1 &lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Diff: &lt;a href=&quot;https://reviews.apache.org/r/3704/diff&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://reviews.apache.org/r/3704/diff&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Testing&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;-------&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;The original tests pass, though I had to take out the state checks because of the changes to semantics from the flume-935 code. I also had to add a transaction.close statement where semantics were not properly being followed&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;I have to retrofit my new concurrency test since without the tagged events it cannot fail without checking that the content is correct. I&apos;ll put that up asap, just wanted to get some eyes on this before I head out.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Thanks,&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Juhani&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                                                <inwardlinks description="is blocked by">
                                        <issuelink>
            <issuekey id="12538638">FLUME-935</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="12535534">FLUME-889</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12514921" name="FLUME-936-3.patch" size="40383" author="juhanic" created="Fri, 17 Feb 2012 01:15:23 +0000"/>
                            <attachment id="12515328" name="FLUME-936-4.patch" size="40383" author="juhanic" created="Tue, 21 Feb 2012 06:52:29 +0000"/>
                            <attachment id="12511112" name="FLUME-936-unittest.patch" size="2824" author="juhanic" created="Thu, 19 Jan 2012 09:50:57 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>224439</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 39 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i09ryv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>54964</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310192" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Release Note</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>This depends on Flume-935 and should not be committed before that</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>