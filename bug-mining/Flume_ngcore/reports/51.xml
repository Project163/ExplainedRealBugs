<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:56:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLUME-1232] Cannot start agent a 3rd time when using FileChannel</title>
                <link>https://issues.apache.org/jira/browse/FLUME-1232</link>
                <project id="12311321" key="FLUME">Flume</project>
                    <description>&lt;p&gt;Steps:&lt;br/&gt;
1) Start clean by wiping-out FileChannel&apos;s existing checkpoint dir and data dir&lt;br/&gt;
2) Configure the agent to use filechannel (type = FILE). THe config file I used is at the end of this text.&lt;br/&gt;
3) Start the agent, confirm lock files exist in data and checkpoint dirs, stop agent, confirm lock files are remove from data and checkpoint dirs.&lt;br/&gt;
4) Repeat step 3&lt;br/&gt;
5) Start the agent. The following exceptions are shown in the logs:&lt;/p&gt;

&lt;p&gt;2012-05-29 03:15:36,453 DEBUG file.ReplayHandler: record.getTimestamp() = 1338286275813, lastCheckpoint = 1338286279596, fileId = 1, offset = 1924, type = Commit, transaction 1338285619250&lt;br/&gt;
2012-05-29 03:15:36,453 DEBUG file.ReplayHandler: record.getTimestamp() = 1338286279783, lastCheckpoint = 1338286279596, fileId = 1, offset = 1949, type = Take, transaction 1338285619251&lt;br/&gt;
2012-05-29 03:15:36,453 DEBUG file.ReplayHandler: record.getTimestamp() = 1338286279784, lastCheckpoint = 1338286279596, fileId = 1, offset = 1980, type = Commit, transaction 1338285619251&lt;br/&gt;
2012-05-29 03:15:36,453 DEBUG file.ReplayHandler: Processing commit of Take&lt;br/&gt;
2012-05-29 03:15:36,453 INFO file.ReplayHandler: Replayed 1 from /var/run/flume-ng/.flume/file-channel/data/log-1&lt;br/&gt;
2012-05-29 03:15:36,453 INFO file.ReplayHandler: Replaying /var/run/flume-ng/.flume/file-channel/data/log-2&lt;br/&gt;
2012-05-29 03:15:36,454 DEBUG file.ReplayHandler: record.getTimestamp() = 1338286370280, lastCheckpoint = 1338286279596, fileId = 2, offset = 8, type = Take, transaction 1338286369982&lt;br/&gt;
2012-05-29 03:15:36,454 DEBUG file.ReplayHandler: record.getTimestamp() = 1338286370287, lastCheckpoint = 1338286279596, fileId = 2, offset = 39, type = Commit, transaction 1338286369982&lt;br/&gt;
2012-05-29 03:15:36,454 DEBUG file.ReplayHandler: Processing commit of Take&lt;br/&gt;
2012-05-29 03:15:36,454 INFO file.ReplayHandler: Unable to remove FlumeEventPointer &lt;span class=&quot;error&quot;&gt;&amp;#91;fileID=1, offset=1853&amp;#93;&lt;/span&gt; added to pending list&lt;br/&gt;
2012-05-29 03:15:36,454 INFO file.ReplayHandler: Replayed 1 from /var/run/flume-ng/.flume/file-channel/data/log-2&lt;br/&gt;
2012-05-29 03:15:36,454 DEBUG file.ReplayHandler: Pending take FlumeEventPointer &lt;span class=&quot;error&quot;&gt;&amp;#91;fileID=1, offset=1853&amp;#93;&lt;/span&gt;&lt;br/&gt;
2012-05-29 03:15:36,455 ERROR file.Log: Failed to initialize Log&lt;br/&gt;
java.lang.IllegalStateException: Pending takes 1 exist after the end of replay&lt;br/&gt;
        at com.google.common.base.Preconditions.checkState(Preconditions.java:145)&lt;br/&gt;
        at org.apache.flume.channel.file.ReplayHandler.replayLog(ReplayHandler.java:137)&lt;br/&gt;
        at org.apache.flume.channel.file.Log.replay(Log.java:205)&lt;br/&gt;
        at org.apache.flume.channel.file.FileChannel.start(FileChannel.java:180)&lt;br/&gt;
        at org.apache.flume.lifecycle.LifecycleSupervisor$MonitorRunnable.run(LifecycleSupervisor.java:228)&lt;br/&gt;
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:441)&lt;br/&gt;
        at java.util.concurrent.FutureTask$Sync.innerRunAndReset(FutureTask.java:317)&lt;br/&gt;
        at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:150)&lt;br/&gt;
        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$101(ScheduledThreadPoolExecutor.java:98)&lt;br/&gt;
        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.runPeriodic(ScheduledThreadPoolExecutor.java:180)&lt;br/&gt;
        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:204)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:662)&lt;br/&gt;
2012-05-29 03:15:36,457 ERROR lifecycle.LifecycleSupervisor: Unable to start org.apache.flume.channel.file.FileChannel@1ac88440 - Exception follows.&lt;br/&gt;
java.lang.IllegalStateException: Log is closed&lt;br/&gt;
        at com.google.common.base.Preconditions.checkState(Preconditions.java:145)&lt;br/&gt;
        at org.apache.flume.channel.file.Log.getFlumeEventQueue(Log.java:226)&lt;br/&gt;
        at org.apache.flume.channel.file.FileChannel.getDepth(FileChannel.java:253)&lt;br/&gt;
        at org.apache.flume.channel.file.FileChannel.start(FileChannel.java:187)&lt;br/&gt;
        at org.apache.flume.lifecycle.LifecycleSupervisor$MonitorRunnable.run(LifecycleSupervisor.java:228)&lt;br/&gt;
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:441)&lt;br/&gt;
        at java.util.concurrent.FutureTask$Sync.innerRunAndReset(FutureTask.java:317)&lt;br/&gt;
        at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:150)&lt;br/&gt;
        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$101(ScheduledThreadPoolExecutor.java:98)&lt;br/&gt;
        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.runPeriodic(ScheduledThreadPoolExecutor.java:180)&lt;br/&gt;
        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:204)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:662)&lt;br/&gt;
2012-05-29 03:15:36,458 ERROR flume.SinkRunner: Unhandled exception, logging and sleeping for 5000ms&lt;br/&gt;
java.lang.IllegalStateException: Channel closed&lt;br/&gt;
        at com.google.common.base.Preconditions.checkState(Preconditions.java:145)&lt;br/&gt;
        at org.apache.flume.channel.file.FileChannel.createTransaction(FileChannel.java:237)&lt;br/&gt;
        at org.apache.flume.channel.BasicChannelSemantics.getTransaction(BasicChannelSemantics.java:118)&lt;br/&gt;
        at org.apache.flume.sink.LoggerSink.process(LoggerSink.java:61)&lt;br/&gt;
        at org.apache.flume.sink.DefaultSinkProcessor.process(DefaultSinkProcessor.java:68)&lt;br/&gt;
        at org.apache.flume.SinkRunner$PollingRunner.run(SinkRunner.java:147)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:662)&lt;br/&gt;
2012-05-29 03:15:39,460 INFO file.FileChannel: Starting FileChannel with dataDir &lt;span class=&quot;error&quot;&gt;&amp;#91;/var/run/flume-ng/.flume/file-channel/data&amp;#93;&lt;/span&gt;&lt;br/&gt;
2012-05-29 03:15:39,460 INFO file.Log: Cannot lock /var/run/flume-ng/.flume/file-channel/checkpoint. The directory is already locked.&lt;br/&gt;
2012-05-29 03:15:39,461 ERROR lifecycle.LifecycleSupervisor: Unable to start org.apache.flume.channel.file.FileChannel@1ac88440 - Exception follows.&lt;br/&gt;
java.lang.RuntimeException: java.io.IOException: Cannot lock /var/run/flume-ng/.flume/file-channel/checkpoint. The directory is already locked.&lt;br/&gt;
        at com.google.common.base.Throwables.propagate(Throwables.java:156)&lt;br/&gt;
        at org.apache.flume.channel.file.FileChannel.start(FileChannel.java:182)&lt;br/&gt;
        at org.apache.flume.lifecycle.LifecycleSupervisor$MonitorRunnable.run(LifecycleSupervisor.java:228)&lt;br/&gt;
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:441)&lt;br/&gt;
        at java.util.concurrent.FutureTask$Sync.innerRunAndReset(FutureTask.java:317)&lt;br/&gt;
        at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:150)&lt;/p&gt;


&lt;p&gt;Config file I used (flume.conf):&lt;/p&gt;

&lt;p&gt;agent.channels = c1&lt;br/&gt;
agent.sources = r1&lt;br/&gt;
agent.sinks = k1&lt;br/&gt;
#&lt;br/&gt;
agent.channels.c1.type = FILE&lt;br/&gt;
#&lt;br/&gt;
agent.sources.r1.channels = c1&lt;br/&gt;
agent.sources.r1.type = NETCAT&lt;br/&gt;
agent.sources.r1.bind = 0.0.0.0&lt;br/&gt;
agent.sources.r1.port = 41414&lt;br/&gt;
#&lt;br/&gt;
agent.sinks.k1.channel = c1&lt;br/&gt;
agent.sinks.k1.type = LOGGER&lt;/p&gt;</description>
                <environment>&lt;p&gt;RHEL 5.6 64-bit&lt;/p&gt;</environment>
        <key id="12558408">FLUME-1232</key>
            <summary>Cannot start agent a 3rd time when using FileChannel</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="aprabhakar">Arvind Prabhakar</assignee>
                                    <reporter username="will@cloudera.com">Will McQueen</reporter>
                        <labels>
                    </labels>
                <created>Tue, 29 May 2012 10:26:28 +0000</created>
                <updated>Mon, 10 Sep 2012 08:58:31 +0000</updated>
                            <resolved>Thu, 21 Jun 2012 16:58:47 +0000</resolved>
                                    <version>1.2.0</version>
                                    <fixVersion>1.2.0</fixVersion>
                                    <component>Channel</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="13285133" author="aprabhakar" created="Tue, 29 May 2012 21:11:30 +0000"  >&lt;p&gt;@Will - I am not able to reproduce it with the current trunk. Can you repeat the test by making sure that you clean up the ~/.flume/file-channel directory and restarting?&lt;/p&gt;

&lt;p&gt;(Edit: Will instead of Hari. Sorry about the mixup)&lt;/p&gt;</comment>
                            <comment id="13285249" author="will@cloudera.com" created="Tue, 29 May 2012 23:16:13 +0000"  >&lt;p&gt;Actually I can no longer reproduce this issue either. It could be a race conditions that&apos;s challenging to reproduce. But I still do sometimes see the following exception when shutting down the agent:&lt;/p&gt;

&lt;p&gt;  2012-05-29 15:29:22,874 INFO file.LogFile: Closing RandomReader /var/run/flume-ng/.flume/file-channel/data/log-14&lt;br/&gt;
2012-05-29 15:29:22,976 INFO file.LogFile: Closing RandomReader /var/run/flume-ng/.flume/file-channel/data/log-15&lt;br/&gt;
2012-05-29 15:29:23,111 ERROR flume.SinkRunner: Unhandled exception, logging and sleeping for 5000ms&lt;br/&gt;
java.lang.IllegalStateException: Channel closed&lt;br/&gt;
	at com.google.common.base.Preconditions.checkState(Preconditions.java:145)&lt;br/&gt;
	at org.apache.flume.channel.file.FileChannel.createTransaction(FileChannel.java:237)&lt;br/&gt;
	at org.apache.flume.channel.BasicChannelSemantics.getTransaction(BasicChannelSemantics.java:118)&lt;br/&gt;
	at org.apache.flume.sink.LoggerSink.process(LoggerSink.java:61)&lt;br/&gt;
	at org.apache.flume.sink.DefaultSinkProcessor.process(DefaultSinkProcessor.java:68)&lt;br/&gt;
	at org.apache.flume.SinkRunner$PollingRunner.run(SinkRunner.java:147)&lt;br/&gt;
	at java.lang.Thread.run(Unknown Source)&lt;/p&gt;</comment>
                            <comment id="13286747" author="will@cloudera.com" created="Thu, 31 May 2012 17:04:26 +0000"  >&lt;p&gt;With a config similary to Juhani&apos;s from &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-1246&quot; title=&quot;FileChannel hangs silently when Hadoop libs not found&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-1246&quot;&gt;&lt;del&gt;FLUME-1246&lt;/del&gt;&lt;/a&gt;, I&apos;m now able to reproduce the originally-posted exceptions (I&apos;m using a custom timestamp interceptor, since I&apos;m not synced to the latest bits).&lt;/p&gt;

&lt;p&gt;agent.channels = c1&lt;br/&gt;
agent.sources = r1&lt;br/&gt;
agent.sinks = k1&lt;/p&gt;

&lt;p&gt;agent.channels.c1.type = FILE&lt;br/&gt;
agent.channels.c1.checkpointDir = /tmp/flume-check&lt;br/&gt;
agent.channels.c1.dataDirs = /tmp/flume-data&lt;/p&gt;

&lt;p&gt;agent.sources.r1.channels = c1&lt;br/&gt;
agent.sources.r1.type = EXEC&lt;br/&gt;
agent.sources.r1.command = /usr/bin/top -b -d 1&lt;br/&gt;
agent.sources.r1.restart = true&lt;br/&gt;
agent.sources.r1.restartThrottle = 1000&lt;br/&gt;
agent.sources.r1.interceptors = i1&lt;br/&gt;
agent.sources.r1.interceptors.i1.type = org.apache.flume.interceptor.custom.TimestampInterceptor$Builder&lt;/p&gt;

&lt;p&gt;agent.sinks.k1.channel = c1&lt;br/&gt;
agent.sinks.k1.type = LOGGER&lt;/p&gt;</comment>
                            <comment id="13287619" author="will@cloudera.com" created="Fri, 1 Jun 2012 19:43:05 +0000"  >&lt;p&gt;Based on additional testing, it seems that the locking issue seems to be related to having a &apos;timestamp&apos; header in the events. The issue is not reproducible when I remove the TimestampInterceptor. The issue is also not reproducible when I add a different interceptor that adds some header other than &apos;timestamp&apos; (eg, &apos;blah&apos; = &apos;BBB&apos;). I don&apos;t think the issue is related specifically to interceptors either, just to the &apos;timestamp&apos; header in events. The steps to reproduce are as follows. I recommending doing &apos;tail -f&apos; on the flume log file to watch the progress, and also set your log4j.properties file so that flume.root.logger=DEBUG,LOGFILE.&lt;/p&gt;

&lt;p&gt;1) Remove the checkpoint and data dirs&lt;br/&gt;
2) Start flume with the config file specified in the previous comment. Confirm that lock file exists in checkpoint dir and data dir.&lt;br/&gt;
3) Wait 30 seconds to allow data to flow for some time (this will also increase the amount of time that the replay take during a next run)&lt;br/&gt;
4) Stop flume. Confirm that lock file does not exist in checkpoint dir and data dir.&lt;br/&gt;
5) Start flume. Confirm that lock file exists in checkpoint dir and data dir. The replay mechanism will begin (as seen by tailing flume.log).&lt;br/&gt;
6) Stop flume while the replay is still going on (this is important). So basically, as soon as you started flume in step 5, stop it within a few seconds.&lt;br/&gt;
7) Now, start flume one last time. Tail the logfile. When the replay completes, you should now see the exceptions appear:&lt;/p&gt;

&lt;p&gt;2012-06-01 12:04:23,744 DEBUG file.ReplayHandler: Pending take FlumeEventPointer &lt;span class=&quot;error&quot;&gt;&amp;#91;fileID=1, offset=1937522&amp;#93;&lt;/span&gt;&lt;br/&gt;
2012-06-01 12:04:23,744 DEBUG file.ReplayHandler: Pending take FlumeEventPointer &lt;span class=&quot;error&quot;&gt;&amp;#91;fileID=1, offset=1937685&amp;#93;&lt;/span&gt;&lt;br/&gt;
2012-06-01 12:04:23,744 DEBUG file.ReplayHandler: Pending take FlumeEventPointer &lt;span class=&quot;error&quot;&gt;&amp;#91;fileID=1, offset=1937848&amp;#93;&lt;/span&gt;&lt;br/&gt;
2012-06-01 12:04:23,744 ERROR file.Log: Failed to initialize Log&lt;br/&gt;
java.lang.IllegalStateException: Pending takes 299 exist after the end of replay&lt;br/&gt;
	at com.google.common.base.Preconditions.checkState(Preconditions.java:145)&lt;br/&gt;
	at org.apache.flume.channel.file.ReplayHandler.replayLog(ReplayHandler.java:137)&lt;br/&gt;
	at org.apache.flume.channel.file.Log.replay(Log.java:205)&lt;br/&gt;
	at org.apache.flume.channel.file.FileChannel.start(FileChannel.java:180)&lt;br/&gt;
	at org.apache.flume.lifecycle.LifecycleSupervisor$MonitorRunnable.run(LifecycleSupervisor.java:228)&lt;br/&gt;
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:441)&lt;br/&gt;
	at java.util.concurrent.FutureTask$Sync.innerRunAndReset(FutureTask.java:317)&lt;br/&gt;
	at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:150)&lt;br/&gt;
	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$101(ScheduledThreadPoolExecutor.java:98)&lt;br/&gt;
	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.runPeriodic(ScheduledThreadPoolExecutor.java:180)&lt;br/&gt;
	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:204)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:662)&lt;br/&gt;
2012-06-01 12:04:23,745 ERROR lifecycle.LifecycleSupervisor: Unable to start org.apache.flume.channel.file.FileChannel@7cf1bb78 - Exception follows.&lt;br/&gt;
java.lang.IllegalStateException: Log is closed&lt;br/&gt;
	at com.google.common.base.Preconditions.checkState(Preconditions.java:145)&lt;br/&gt;
	at org.apache.flume.channel.file.Log.getFlumeEventQueue(Log.java:226)&lt;br/&gt;
	at org.apache.flume.channel.file.FileChannel.getDepth(FileChannel.java:253)&lt;br/&gt;
	at org.apache.flume.channel.file.FileChannel.start(FileChannel.java:187)&lt;br/&gt;
	at org.apache.flume.lifecycle.LifecycleSupervisor$MonitorRunnable.run(LifecycleSupervisor.java:228)&lt;br/&gt;
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:441)&lt;br/&gt;
	at java.util.concurrent.FutureTask$Sync.innerRunAndReset(FutureTask.java:317)&lt;br/&gt;
	at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:150)&lt;br/&gt;
	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$101(ScheduledThreadPoolExecutor.java:98)&lt;br/&gt;
	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.runPeriodic(ScheduledThreadPoolExecutor.java:180)&lt;br/&gt;
	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:204)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:662)&lt;br/&gt;
2012-06-01 12:04:23,746 ERROR flume.SinkRunner: Unhandled exception, logging and sleeping for 5000ms&lt;br/&gt;
java.lang.IllegalStateException: Channel closed&lt;br/&gt;
	at com.google.common.base.Preconditions.checkState(Preconditions.java:145)&lt;br/&gt;
	at org.apache.flume.channel.file.FileChannel.createTransaction(FileChannel.java:237)&lt;br/&gt;
	at org.apache.flume.channel.BasicChannelSemantics.getTransaction(BasicChannelSemantics.java:118)&lt;br/&gt;
	at org.apache.flume.sink.LoggerSink.process(LoggerSink.java:61)&lt;br/&gt;
	at org.apache.flume.sink.DefaultSinkProcessor.process(DefaultSinkProcessor.java:68)&lt;br/&gt;
	at org.apache.flume.SinkRunner$PollingRunner.run(SinkRunner.java:147)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:662)&lt;br/&gt;
2012-06-01 12:04:23,746 ERROR source.ExecSource: Failed while running command: /usr/bin/top -b -d 1&lt;br/&gt;
java.lang.IllegalStateException: Channel closed&lt;br/&gt;
	at com.google.common.base.Preconditions.checkState(Preconditions.java:145)&lt;br/&gt;
	at org.apache.flume.channel.file.FileChannel.createTransaction(FileChannel.java:237)&lt;br/&gt;
	at org.apache.flume.channel.BasicChannelSemantics.getTransaction(BasicChannelSemantics.java:118)&lt;br/&gt;
	at org.apache.flume.channel.ChannelProcessor.processEvent(ChannelProcessor.java:248)&lt;br/&gt;
	at org.apache.flume.source.ExecSource$ExecRunnable.run(ExecSource.java:258)&lt;br/&gt;
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:441)&lt;br/&gt;
	at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)&lt;br/&gt;
	at java.util.concurrent.FutureTask.run(FutureTask.java:138)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:662)&lt;br/&gt;
2012-06-01 12:04:23,747 INFO source.ExecSource: Restarting in 1000ms, exit code 143&lt;br/&gt;
2012-06-01 12:04:25,267 ERROR source.ExecSource: Failed while running command: /usr/bin/top -b -d 1&lt;br/&gt;
java.lang.IllegalStateException: Channel closed&lt;br/&gt;
	at com.google.common.base.Preconditions.checkState(Preconditions.java:145)&lt;br/&gt;
	at org.apache.flume.channel.file.FileChannel.createTransaction(FileChannel.java:237)&lt;br/&gt;
	at org.apache.flume.channel.BasicChannelSemantics.getTransaction(BasicChannelSemantics.java:118)&lt;br/&gt;
	at org.apache.flume.channel.ChannelProcessor.processEvent(ChannelProcessor.java:248)&lt;br/&gt;
	at org.apache.flume.source.ExecSource$ExecRunnable.run(ExecSource.java:258)&lt;br/&gt;
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:441)&lt;br/&gt;
	at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)&lt;br/&gt;
	at java.util.concurrent.FutureTask.run(FutureTask.java:138)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:662)&lt;br/&gt;
2012-06-01 12:04:25,268 INFO source.ExecSource: Restarting in 1000ms, exit code 141&lt;br/&gt;
2012-06-01 12:04:26,746 INFO file.FileChannel: Starting FileChannel with dataDir &lt;span class=&quot;error&quot;&gt;&amp;#91;/tmp/flume-data&amp;#93;&lt;/span&gt;&lt;br/&gt;
2012-06-01 12:04:26,746 INFO file.Log: Cannot lock /tmp/flume-check. The directory is already locked.&lt;br/&gt;
2012-06-01 12:04:26,747 ERROR lifecycle.LifecycleSupervisor: Unable to start org.apache.flume.channel.file.FileChannel@7cf1bb78 - Exception follows.&lt;br/&gt;
java.lang.RuntimeException: java.io.IOException: Cannot lock /tmp/flume-check. The directory is already locked.&lt;br/&gt;
	at com.google.common.base.Throwables.propagate(Throwables.java:156)&lt;br/&gt;
	at org.apache.flume.channel.file.FileChannel.start(FileChannel.java:182)&lt;br/&gt;
	at org.apache.flume.lifecycle.LifecycleSupervisor$MonitorRunnable.run(LifecycleSupervisor.java:228)&lt;br/&gt;
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:441)&lt;br/&gt;
	at java.util.concurrent.FutureTask$Sync.innerRunAndReset(FutureTask.java:317)&lt;br/&gt;
	at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:150)&lt;br/&gt;
	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$101(ScheduledThreadPoolExecutor.java:98)&lt;br/&gt;
	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.runPeriodic(ScheduledThreadPoolExecutor.java:180)&lt;br/&gt;
	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:204)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:662)&lt;br/&gt;
Caused by: java.io.IOException: Cannot lock /tmp/flume-check. The directory is already locked.&lt;br/&gt;
	at org.apache.flume.channel.file.Log.lock(Log.java:574)&lt;br/&gt;
	at org.apache.flume.channel.file.Log.&amp;lt;init&amp;gt;(Log.java:95)&lt;br/&gt;
	at org.apache.flume.channel.file.FileChannel.start(FileChannel.java:178)&lt;br/&gt;
	... 10 more&lt;/p&gt;


&lt;p&gt;The interceptor I&apos;m using is:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt; org.apache.flume.interceptor.custom;

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.util.List;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.flume.Context;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.flume.Event;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.flume.interceptor.Interceptor;

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;TimestampInterceptor &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; Interceptor {

  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; TimestampInterceptor() {

  }

  @Override
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void initialize() {

  }

  @Override
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Event intercept(Event event) {
    event.getHeaders().put(&lt;span class=&quot;code-quote&quot;&gt;&quot;timestamp&quot;&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.valueOf(&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.currentTimeMillis()));
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; event;
  }

  @Override
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; List&amp;lt;Event&amp;gt; intercept(List&amp;lt;Event&amp;gt; events) {
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Event e : events) {
      intercept(e);
    }
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; events;
  }

  @Override
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void close() {

  }

  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Builder &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; Interceptor.Builder {

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void configure(Context context) {

    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Interceptor build() {
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TimestampInterceptor();
    }

  }

}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13288073" author="will@cloudera.com" created="Sun, 3 Jun 2012 03:55:53 +0000"  >&lt;p&gt;I found a slightly simpler test case.&lt;/p&gt;

&lt;p&gt;Steps:&lt;br/&gt;
1) Put custom-timestamp-interceptor.jar in /usr/lib/flume-ng/lib (built from the source file shown in the previous comment)&lt;br/&gt;
2) Start clean by wiping-out any existing /tmp/flume-&lt;/p&gt;
{check,data} dirs&lt;br/&gt;
3) Start the agent. Tail the log in separate window. Monitor the presence of lock files in separate window using &apos;watch ls /tmp/flume-{check,data}
&lt;p&gt;&apos;. Confirm lock files exist.&lt;br/&gt;
4) Wait 30 seconds, stop agent. Confirm no lock files.&lt;br/&gt;
5) Start agent. Confirm lock files exist. Wait 30 seconds. Stop agent (no need to stop the agent during the replay... can stop it any time after the replay is done). Confirm no lock files.&lt;br/&gt;
6) Start agent. Confirm lock files exist. After the reply is done, you should see the same exception repeatedly, which prevents agent from doing work.&lt;/p&gt;

&lt;p&gt;Config file is:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;agent.channels = c1
agent.sources = r1
agent.sinks = k1

agent.channels.c1.type = FILE
agent.channels.c1.checkpointDir = /tmp/flume-check
agent.channels.c1.dataDirs = /tmp/flume-data

agent.sources.r1.channels = c1
agent.sources.r1.type = EXEC
agent.sources.r1.command = /bin/echo FLUME-1232
agent.sources.r1.restart = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
agent.sources.r1.restartThrottle = 100
agent.sources.r1.interceptors = i1
agent.sources.r1.interceptors.i1.type = org.apache.flume.interceptor.custom.TimestampInterceptor$Builder

agent.sinks.k1.channel = c1
agent.sinks.k1.type = LOGGER
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;2012-06-02 20:41:27,932 DEBUG file.ReplayHandler: Pending take FlumeEventPointer &lt;span class=&quot;error&quot;&gt;&amp;#91;fileID=1, offset=42175&amp;#93;&lt;/span&gt;&lt;br/&gt;
2012-06-02 20:41:27,932 DEBUG file.ReplayHandler: Pending take FlumeEventPointer &lt;span class=&quot;error&quot;&gt;&amp;#91;fileID=1, offset=42268&amp;#93;&lt;/span&gt;&lt;br/&gt;
2012-06-02 20:41:27,932 DEBUG file.ReplayHandler: Pending take FlumeEventPointer &lt;span class=&quot;error&quot;&gt;&amp;#91;fileID=1, offset=42361&amp;#93;&lt;/span&gt;&lt;br/&gt;
2012-06-02 20:41:27,933 ERROR file.Log: Failed to initialize Log&lt;br/&gt;
java.lang.IllegalStateException: Pending takes 3 exist after the end of replay&lt;br/&gt;
    at com.google.common.base.Preconditions.checkState(Preconditions.java:145)&lt;br/&gt;
    at org.apache.flume.channel.file.ReplayHandler.replayLog(ReplayHandler.java:137)&lt;br/&gt;
    at org.apache.flume.channel.file.Log.replay(Log.java:205)&lt;br/&gt;
    at org.apache.flume.channel.file.FileChannel.start(FileChannel.java:180)&lt;br/&gt;
    at org.apache.flume.lifecycle.LifecycleSupervisor$MonitorRunnable.run(LifecycleSupervisor.java:228)&lt;br/&gt;
    at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:441)&lt;br/&gt;
    at java.util.concurrent.FutureTask$Sync.innerRunAndReset(FutureTask.java:317)&lt;br/&gt;
    at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:150)&lt;br/&gt;
    at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$101(ScheduledThreadPoolExecutor.java:98)&lt;br/&gt;
    at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.runPeriodic(ScheduledThreadPoolExecutor.java:180)&lt;br/&gt;
    at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:204)&lt;br/&gt;
    at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
    at java.lang.Thread.run(Thread.java:662)&lt;br/&gt;
2012-06-02 20:41:27,934 ERROR lifecycle.LifecycleSupervisor: Unable to start org.apache.flume.channel.file.FileChannel@37bd2664 - Exception follows.&lt;br/&gt;
java.lang.IllegalStateException: Log is closed&lt;br/&gt;
    at com.google.common.base.Preconditions.checkState(Preconditions.java:145)&lt;br/&gt;
    at org.apache.flume.channel.file.Log.getFlumeEventQueue(Log.java:226)&lt;br/&gt;
    at org.apache.flume.channel.file.FileChannel.getDepth(FileChannel.java:253)&lt;br/&gt;
    at org.apache.flume.channel.file.FileChannel.start(FileChannel.java:187)&lt;br/&gt;
    at org.apache.flume.lifecycle.LifecycleSupervisor$MonitorRunnable.run(LifecycleSupervisor.java:228)&lt;br/&gt;
    at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:441)&lt;br/&gt;
    at java.util.concurrent.FutureTask$Sync.innerRunAndReset(FutureTask.java:317)&lt;br/&gt;
    at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:150)&lt;br/&gt;
    at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$101(ScheduledThreadPoolExecutor.java:98)&lt;br/&gt;
    at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.runPeriodic(ScheduledThreadPoolExecutor.java:180)&lt;br/&gt;
    at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:204)&lt;br/&gt;
    at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
    at java.lang.Thread.run(Thread.java:662)&lt;br/&gt;
2012-06-02 20:41:27,934 INFO nodemanager.DefaultLogicalNodeManager: Waiting for channel: c1 to start. Sleeping for 500 ms&lt;br/&gt;
2012-06-02 20:41:28,434 INFO nodemanager.DefaultLogicalNodeManager: Waiting for channel: c1 to start. Sleeping for 500 ms&lt;br/&gt;
2012-06-02 20:41:28,934 INFO nodemanager.DefaultLogicalNodeManager: Waiting for channel: c1 to start. Sleeping for 500 ms&lt;br/&gt;
2012-06-02 20:41:29,435 INFO nodemanager.DefaultLogicalNodeManager: Waiting for channel: c1 to start. Sleeping for 500 ms&lt;br/&gt;
2012-06-02 20:41:29,935 INFO nodemanager.DefaultLogicalNodeManager: Waiting for channel: c1 to start. Sleeping for 500 ms&lt;br/&gt;
2012-06-02 20:41:30,435 INFO nodemanager.DefaultLogicalNodeManager: Waiting for channel: c1 to start. Sleeping for 500 ms&lt;br/&gt;
2012-06-02 20:41:30,934 INFO file.FileChannel: Starting FileChannel with dataDir &lt;span class=&quot;error&quot;&gt;&amp;#91;/tmp/flume-data&amp;#93;&lt;/span&gt;&lt;br/&gt;
2012-06-02 20:41:30,935 INFO file.Log: Cannot lock /tmp/flume-check. The directory is already locked.&lt;br/&gt;
2012-06-02 20:41:30,935 ERROR lifecycle.LifecycleSupervisor: Unable to start org.apache.flume.channel.file.FileChannel@37bd2664 - Exception follows.&lt;br/&gt;
java.lang.RuntimeException: java.io.IOException: Cannot lock /tmp/flume-check. The directory is already locked.&lt;br/&gt;
    at com.google.common.base.Throwables.propagate(Throwables.java:156)&lt;br/&gt;
    at org.apache.flume.channel.file.FileChannel.start(FileChannel.java:182)&lt;br/&gt;
    at org.apache.flume.lifecycle.LifecycleSupervisor$MonitorRunnable.run(LifecycleSupervisor.java:228)&lt;br/&gt;
    at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:441)&lt;br/&gt;
    at java.util.concurrent.FutureTask$Sync.innerRunAndReset(FutureTask.java:317)&lt;br/&gt;
    at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:150)&lt;br/&gt;
    at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$101(ScheduledThreadPoolExecutor.java:98)&lt;br/&gt;
    at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.runPeriodic(ScheduledThreadPoolExecutor.java:180)&lt;br/&gt;
    at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:204)&lt;br/&gt;
    at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
    at java.lang.Thread.run(Thread.java:662)&lt;br/&gt;
Caused by: java.io.IOException: Cannot lock /tmp/flume-check. The directory is already locked.&lt;br/&gt;
    at org.apache.flume.channel.file.Log.lock(Log.java:574)&lt;br/&gt;
    at org.apache.flume.channel.file.Log.&amp;lt;init&amp;gt;(Log.java:95)&lt;br/&gt;
    at org.apache.flume.channel.file.FileChannel.start(FileChannel.java:178)&lt;br/&gt;
    ... 10 more&lt;br/&gt;
2012-06-02 20:41:30,936 INFO nodemanager.DefaultLogicalNodeManager: Waiting for channel: c1 to start. Sleeping for 500 ms&lt;br/&gt;
2012-06-02 20:41:31,436 INFO nodemanager.DefaultLogicalNodeManager: Waiting for channel: c1 to start. Sleeping for 500 ms&lt;br/&gt;
2012-06-02 20:41:31,936 INFO nodemanager.DefaultLogicalNodeManager: Waiting for channel: c1 to start. Sleeping for 500 ms&lt;br/&gt;
2012-06-02 20:41:32,436 INFO nodemanager.DefaultLogicalNodeManager: Waiting for channel: c1 to start. Sleeping for 500 ms&lt;br/&gt;
2012-06-02 20:41:32,937 INFO nodemanager.DefaultLogicalNodeManager: Waiting for channel: c1 to start. Sleeping for 500 ms&lt;br/&gt;
2012-06-02 20:41:33,437 INFO nodemanager.DefaultLogicalNodeManager: Waiting for channel: c1 to start. Sleeping for 500 ms&lt;br/&gt;
2012-06-02 20:41:33,936 INFO file.FileChannel: Starting FileChannel with dataDir &lt;span class=&quot;error&quot;&gt;&amp;#91;/tmp/flume-data&amp;#93;&lt;/span&gt;&lt;br/&gt;
2012-06-02 20:41:33,936 INFO file.Log: Cannot lock /tmp/flume-check. The directory is already locked.&lt;br/&gt;
2012-06-02 20:41:33,936 ERROR lifecycle.LifecycleSupervisor: Unable to start org.apache.flume.channel.file.FileChannel@37bd2664 - Exception follows.&lt;/p&gt;
</comment>
                            <comment id="13289123" author="juhanic" created="Tue, 5 Jun 2012 03:50:46 +0000"  >&lt;p&gt;I am getting more or less the exact same error, and it is making flume unresponsive to shutdown requests.&lt;/p&gt;

&lt;p&gt;The interceptor isn&apos;t necessary to recreate it.&lt;/p&gt;</comment>
                            <comment id="13289128" author="juhanic" created="Tue, 5 Jun 2012 04:03:21 +0000"  >&lt;p&gt;As an added note, deleting the lock files in the check and data directories does not resolve the problem.&lt;/p&gt;

&lt;p&gt;Here&apos;s our conf btw, no interceptor &lt;/p&gt;


&lt;p&gt;test.channels.ch1.type = file&lt;br/&gt;
test.channels.ch1.checkpointDir = /home/share/juhani_connolly/flume-1.2.0-incubating-SNAPSHOT/check&lt;br/&gt;
test.channels.ch1.dataDirs = /home/share/juhani_connolly/flume-1.2.0-incubating-SNAPSHOT/filechdata&lt;/p&gt;

&lt;p&gt;test.sources.top.type = exec&lt;br/&gt;
test.sources.top.command = /usr/bin/top -b -d 1&lt;br/&gt;
test.sources.top.restart = true&lt;br/&gt;
test.sources.top.restartThrottle = 1000&lt;br/&gt;
test.sources.top.channels = ch1&lt;/p&gt;

&lt;p&gt;test.sources.avro.type = avro&lt;br/&gt;
test.sources.avro.port = 9090&lt;br/&gt;
test.sources.avro.bind = 172.28.19.112&lt;br/&gt;
test.sources.avro.channels = ch1&lt;/p&gt;

&lt;p&gt;test.sinks.log.type = logger&lt;br/&gt;
test.sinks.log.channel = ch1&lt;/p&gt;

&lt;p&gt;test.channels = ch1&lt;br/&gt;
test.sources = avro&lt;br/&gt;
test.sinks = log&lt;/p&gt;</comment>
                            <comment id="13289159" author="hshreedharan" created="Tue, 5 Jun 2012 05:20:04 +0000"  >&lt;p&gt;Thanks Juhani. This is interesting. Could you please share your logs and exact steps to reproduce. I have been able to reproduce with Will&apos;s steps above.&lt;/p&gt;</comment>
                            <comment id="13289182" author="will@cloudera.com" created="Tue, 5 Jun 2012 06:02:47 +0000"  >&lt;p&gt;Hi Juhani,&lt;/p&gt;

&lt;p&gt;&amp;gt;&amp;gt;The interceptor isn&apos;t necessary to recreate i&lt;/p&gt;

&lt;p&gt;...but I notice your config specifies an avro source. Are events coming into that avro source with a timestamp header?&lt;/p&gt;

&lt;p&gt;Cheers,&lt;br/&gt;
Will&lt;/p&gt;</comment>
                            <comment id="13289185" author="will@cloudera.com" created="Tue, 5 Jun 2012 06:08:57 +0000"  >&lt;p&gt;The issue seems to surface when combining a file channel with timestamped events.&lt;/p&gt;

&lt;p&gt;I tried using the timestamp interceptor that&apos;s built-in to Flume instead of using a custom one. The result is the same... the issue is still reproducible. I&apos;m using the latest upstream with this config file:&lt;/p&gt;

&lt;p&gt;agent.channels = c1&lt;br/&gt;
agent.sources = r1&lt;br/&gt;
agent.sinks = k1&lt;br/&gt;
#&lt;br/&gt;
agent.channels.c1.type = FILE&lt;br/&gt;
agent.channels.c1.checkpointDir = /tmp/flume-check&lt;br/&gt;
agent.channels.c1.dataDirs = /tmp/flume-data&lt;br/&gt;
#&lt;br/&gt;
agent.sources.r1.channels = c1&lt;br/&gt;
agent.sources.r1.type = EXEC&lt;br/&gt;
agent.sources.r1.command = /bin/echo &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-1232&quot; title=&quot;Cannot start agent a 3rd time when using FileChannel&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-1232&quot;&gt;&lt;del&gt;FLUME-1232&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
agent.sources.r1.restart = true&lt;br/&gt;
agent.sources.r1.restartThrottle = 100&lt;br/&gt;
agent.sources.r1.interceptors = i1&lt;br/&gt;
agent.sources.r1.interceptors.i1.type = org.apache.flume.interceptor.TimestampInterceptor$Builder&lt;br/&gt;
#&lt;br/&gt;
agent.sinks.k1.channel = c1&lt;br/&gt;
agent.sinks.k1.type = LOGGER&lt;/p&gt;

&lt;p&gt;If an interceptor puts any other header besides a timestamp header, then the issue isn&apos;t reproducible. If instead of an interceptor I just use an avro-client to send the events with a timestamp header, then I&apos;m not able to Ctrl-C out of the terminal that&apos;s running flume agent on the 3rd time that I run it. The logs show the same lock-related issue. Below is a thread dump (Ctrl-\ at the hung terminal window). As far as I can tell, the issue boils down to a combination of having a timestamp header and using the file channel.&lt;/p&gt;

&lt;p&gt;2012-06-03 23:09:32&lt;br/&gt;
Full thread dump Java HotSpot(TM) 64-Bit Server VM (20.6-b01 mixed mode):&lt;/p&gt;

&lt;p&gt;&quot;SIGINT handler&quot; daemon prio=10 tid=0x00007f2968002800 nid=0x43bf waiting for monitor entry &lt;span class=&quot;error&quot;&gt;&amp;#91;0x00007f2992549000&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: BLOCKED (on object monitor)&lt;br/&gt;
    at java.lang.Shutdown.exit(Shutdown.java:168)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;waiting to lock &amp;lt;0x00000000f9d98070&amp;gt; (a java.lang.Class for java.lang.Shutdown)&lt;br/&gt;
    at java.lang.Terminator$1.handle(Terminator.java:35)&lt;br/&gt;
    at sun.misc.Signal$1.run(Signal.java:195)&lt;br/&gt;
    at java.lang.Thread.run(Thread.java:662)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&quot;node-shutdownHook&quot; prio=10 tid=0x00007f293c002800 nid=0x43bd waiting on condition &lt;span class=&quot;error&quot;&gt;&amp;#91;0x00007f2991177000&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: TIMED_WAITING (parking)&lt;br/&gt;
    at sun.misc.Unsafe.park(Native Method)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;parking to wait for  &amp;lt;0x00000000fecb55a0&amp;gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)&lt;br/&gt;
    at java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:196)&lt;br/&gt;
    at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.awaitNanos(AbstractQueuedSynchronizer.java:2025)&lt;br/&gt;
    at java.util.concurrent.ThreadPoolExecutor.awaitTermination(ThreadPoolExecutor.java:1253)&lt;br/&gt;
    at org.apache.flume.lifecycle.LifecycleSupervisor.stop(LifecycleSupervisor.java:86)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x00000000fecb4af8&amp;gt; (a org.apache.flume.lifecycle.LifecycleSupervisor)&lt;br/&gt;
    at org.apache.flume.node.FlumeNode.stop(FlumeNode.java:69)&lt;br/&gt;
    at org.apache.flume.node.Application$1.run(Application.java:160)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&quot;SIGINT handler&quot; daemon prio=10 tid=0x00007f2968001000 nid=0x43bb in Object.wait() &lt;span class=&quot;error&quot;&gt;&amp;#91;0x00007f2991379000&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: WAITING (on object monitor)&lt;br/&gt;
    at java.lang.Object.wait(Native Method)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;waiting on &amp;lt;0x00000000fecbaf58&amp;gt; (a org.apache.flume.node.Application$1)&lt;br/&gt;
    at java.lang.Thread.join(Thread.java:1186)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x00000000fecbaf58&amp;gt; (a org.apache.flume.node.Application$1)&lt;br/&gt;
    at java.lang.Thread.join(Thread.java:1239)&lt;br/&gt;
    at java.lang.ApplicationShutdownHooks.runHooks(ApplicationShutdownHooks.java:79)&lt;br/&gt;
    at java.lang.ApplicationShutdownHooks$1.run(ApplicationShutdownHooks.java:24)&lt;br/&gt;
    at java.lang.Shutdown.runHooks(Shutdown.java:79)&lt;br/&gt;
    at java.lang.Shutdown.sequence(Shutdown.java:123)&lt;br/&gt;
    at java.lang.Shutdown.exit(Shutdown.java:168)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x00000000f9d98070&amp;gt; (a java.lang.Class for java.lang.Shutdown)&lt;br/&gt;
    at java.lang.Terminator$1.handle(Terminator.java:35)&lt;br/&gt;
    at sun.misc.Signal$1.run(Signal.java:195)&lt;br/&gt;
    at java.lang.Thread.run(Thread.java:662)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&quot;Log-BackgroundWorker&quot; daemon prio=10 tid=0x00007f294c002000 nid=0x3afb waiting on condition &lt;span class=&quot;error&quot;&gt;&amp;#91;0x00007f2991d24000&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: TIMED_WAITING (sleeping)&lt;br/&gt;
    at java.lang.Thread.sleep(Native Method)&lt;br/&gt;
    at org.apache.flume.channel.file.Log$BackgroundWorker.run(Log.java:646)&lt;/p&gt;

&lt;p&gt;&quot;lifecycleSupervisor-1-1&quot; prio=10 tid=0x00007f2940007000 nid=0x3afa waiting on condition &lt;span class=&quot;error&quot;&gt;&amp;#91;0x00007f2992044000&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: TIMED_WAITING (parking)&lt;br/&gt;
    at sun.misc.Unsafe.park(Native Method)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;parking to wait for  &amp;lt;0x00000000feca5a48&amp;gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)&lt;br/&gt;
    at java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:196)&lt;br/&gt;
    at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.awaitNanos(AbstractQueuedSynchronizer.java:2025)&lt;br/&gt;
    at java.util.concurrent.DelayQueue.take(DelayQueue.java:164)&lt;br/&gt;
    at java.util.concurrent.ScheduledThreadPoolExecutor$DelayedWorkQueue.take(ScheduledThreadPoolExecutor.java:609)&lt;br/&gt;
    at java.util.concurrent.ScheduledThreadPoolExecutor$DelayedWorkQueue.take(ScheduledThreadPoolExecutor.java:602)&lt;br/&gt;
    at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:947)&lt;br/&gt;
    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:907)&lt;br/&gt;
    at java.lang.Thread.run(Thread.java:662)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&quot;conf-file-poller-0&quot; prio=10 tid=0x00007f2948001800 nid=0x3af9 waiting for monitor entry &lt;span class=&quot;error&quot;&gt;&amp;#91;0x00007f2992145000&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: BLOCKED (on object monitor)&lt;br/&gt;
    at org.apache.flume.channel.AbstractChannel.getLifecycleState(AbstractChannel.java:55)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;waiting to lock &amp;lt;0x00000000fecd9d30&amp;gt; (a org.apache.flume.channel.file.FileChannel)&lt;br/&gt;
    at org.apache.flume.node.nodemanager.DefaultLogicalNodeManager.startAllComponents(DefaultLogicalNodeManager.java:112)&lt;br/&gt;
    at org.apache.flume.conf.properties.PropertiesFileConfigurationProvider.load(PropertiesFileConfigurationProvider.java:225)&lt;br/&gt;
    at org.apache.flume.conf.file.AbstractFileConfigurationProvider.doLoad(AbstractFileConfigurationProvider.java:123)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x00000000fecb4f50&amp;gt; (a org.apache.flume.conf.properties.PropertiesFileConfigurationProvider)&lt;br/&gt;
    at org.apache.flume.conf.file.AbstractFileConfigurationProvider.access$300(AbstractFileConfigurationProvider.java:38)&lt;br/&gt;
    at org.apache.flume.conf.file.AbstractFileConfigurationProvider$FileWatcherRunnable.run(AbstractFileConfigurationProvider.java:202)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:441)&lt;br/&gt;
    at java.util.concurrent.FutureTask$Sync.innerRunAndReset(FutureTask.java:317)&lt;br/&gt;
    at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:150)&lt;br/&gt;
    at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$101(ScheduledThreadPoolExecutor.java:98)&lt;br/&gt;
    at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.runPeriodic(ScheduledThreadPoolExecutor.java:180)&lt;br/&gt;
    at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:204)&lt;br/&gt;
    at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
    at java.lang.Thread.run(Thread.java:662)&lt;/p&gt;

&lt;p&gt;&quot;lifecycleSupervisor-1-0&quot; prio=10 tid=0x00007f2950003800 nid=0x3af8 runnable &lt;span class=&quot;error&quot;&gt;&amp;#91;0x00007f2992246000&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: RUNNABLE&lt;br/&gt;
    at org.apache.flume.channel.file.FlumeEventQueue.remove(FlumeEventQueue.java:129)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;locked &amp;lt;0x00000000fecd9838&amp;gt; (a org.apache.flume.channel.file.FlumeEventQueue)&lt;br/&gt;
    at org.apache.flume.channel.file.ReplayHandler.processCommit(ReplayHandler.java:163)&lt;br/&gt;
    at org.apache.flume.channel.file.ReplayHandler.replayLog(ReplayHandler.java:108)&lt;br/&gt;
    at org.apache.flume.channel.file.Log.replay(Log.java:205)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x00000000fecd90b8&amp;gt; (a org.apache.flume.channel.file.Log)&lt;br/&gt;
    at org.apache.flume.channel.file.FileChannel.start(FileChannel.java:180)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x00000000fecd9d30&amp;gt; (a org.apache.flume.channel.file.FileChannel)&lt;br/&gt;
    at org.apache.flume.lifecycle.LifecycleSupervisor$MonitorRunnable.run(LifecycleSupervisor.java:228)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x00000000fecd9d30&amp;gt; (a org.apache.flume.channel.file.FileChannel)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:441)&lt;br/&gt;
    at java.util.concurrent.FutureTask$Sync.innerRunAndReset(FutureTask.java:317)&lt;br/&gt;
    at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:150)&lt;br/&gt;
    at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$101(ScheduledThreadPoolExecutor.java:98)&lt;br/&gt;
    at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.runPeriodic(ScheduledThreadPoolExecutor.java:180)&lt;br/&gt;
    at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:204)&lt;br/&gt;
    at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
    at java.lang.Thread.run(Thread.java:662)&lt;/p&gt;

&lt;p&gt;&quot;lifecycleSupervisor-1-2&quot; prio=10 tid=0x00007f2994d71000 nid=0x3af7 waiting for monitor entry &lt;span class=&quot;error&quot;&gt;&amp;#91;0x00007f2992347000&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: BLOCKED (on object monitor)&lt;br/&gt;
    at org.apache.flume.lifecycle.LifecycleSupervisor$MonitorRunnable.run(LifecycleSupervisor.java:207)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;waiting to lock &amp;lt;0x00000000fecb4f50&amp;gt; (a org.apache.flume.conf.properties.PropertiesFileConfigurationProvider)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:441)&lt;br/&gt;
    at java.util.concurrent.FutureTask$Sync.innerRunAndReset(FutureTask.java:317)&lt;br/&gt;
    at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:150)&lt;br/&gt;
    at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$101(ScheduledThreadPoolExecutor.java:98)&lt;br/&gt;
    at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.runPeriodic(ScheduledThreadPoolExecutor.java:180)&lt;br/&gt;
    at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:204)&lt;br/&gt;
    at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
    at java.lang.Thread.run(Thread.java:662)&lt;/p&gt;

&lt;p&gt;&quot;Low Memory Detector&quot; daemon prio=10 tid=0x00007f299409c800 nid=0x3af3 runnable &lt;span class=&quot;error&quot;&gt;&amp;#91;0x0000000000000000&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: RUNNABLE&lt;/p&gt;

&lt;p&gt;&quot;C2 CompilerThread1&quot; daemon prio=10 tid=0x00007f299409a000 nid=0x3af2 waiting on condition &lt;span class=&quot;error&quot;&gt;&amp;#91;0x0000000000000000&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: RUNNABLE&lt;/p&gt;

&lt;p&gt;&quot;C2 CompilerThread0&quot; daemon prio=10 tid=0x00007f2994097000 nid=0x3af1 waiting on condition &lt;span class=&quot;error&quot;&gt;&amp;#91;0x0000000000000000&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: RUNNABLE&lt;/p&gt;

&lt;p&gt;&quot;Signal Dispatcher&quot; daemon prio=10 tid=0x00007f2994095000 nid=0x3af0 waiting on condition &lt;span class=&quot;error&quot;&gt;&amp;#91;0x0000000000000000&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: RUNNABLE&lt;/p&gt;

&lt;p&gt;&quot;Finalizer&quot; daemon prio=10 tid=0x00007f2994078800 nid=0x3aef in Object.wait() &lt;span class=&quot;error&quot;&gt;&amp;#91;0x00007f2993357000&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: WAITING (on object monitor)&lt;br/&gt;
    at java.lang.Object.wait(Native Method)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;waiting on &amp;lt;0x00000000fec30070&amp;gt; (a java.lang.ref.ReferenceQueue$Lock)&lt;br/&gt;
    at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:118)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x00000000fec30070&amp;gt; (a java.lang.ref.ReferenceQueue$Lock)&lt;br/&gt;
    at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:134)&lt;br/&gt;
    at java.lang.ref.Finalizer$FinalizerThread.run(Finalizer.java:159)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&quot;Reference Handler&quot; daemon prio=10 tid=0x00007f2994076800 nid=0x3aee in Object.wait() &lt;span class=&quot;error&quot;&gt;&amp;#91;0x00007f2993458000&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: WAITING (on object monitor)&lt;br/&gt;
    at java.lang.Object.wait(Native Method)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;waiting on &amp;lt;0x00000000fec7ef58&amp;gt; (a java.lang.ref.Reference$Lock)&lt;br/&gt;
    at java.lang.Object.wait(Object.java:485)&lt;br/&gt;
    at java.lang.ref.Reference$ReferenceHandler.run(Reference.java:116)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x00000000fec7ef58&amp;gt; (a java.lang.ref.Reference$Lock)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&quot;main&quot; prio=10 tid=0x00007f2994012000 nid=0x3ae8 waiting on condition &lt;span class=&quot;error&quot;&gt;&amp;#91;0x00007f299b81d000&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: TIMED_WAITING (sleeping)&lt;br/&gt;
    at java.lang.Thread.sleep(Native Method)&lt;br/&gt;
    at org.apache.flume.lifecycle.LifecycleController.waitForOneOf(LifecycleController.java:73)&lt;br/&gt;
    at org.apache.flume.lifecycle.LifecycleController.waitForOneOf(LifecycleController.java:49)&lt;br/&gt;
    at org.apache.flume.node.Application.run(Application.java:167)&lt;br/&gt;
    at org.apache.flume.node.Application.main(Application.java:70)&lt;/p&gt;

&lt;p&gt;&quot;VM Thread&quot; prio=10 tid=0x00007f2994070000 nid=0x3aed runnable&lt;/p&gt;

&lt;p&gt;&quot;GC task thread#0 (ParallelGC)&quot; prio=10 tid=0x00007f2994025000 nid=0x3ae9 runnable&lt;/p&gt;

&lt;p&gt;&quot;GC task thread#1 (ParallelGC)&quot; prio=10 tid=0x00007f2994027000 nid=0x3aea runnable&lt;/p&gt;

&lt;p&gt;&quot;GC task thread#2 (ParallelGC)&quot; prio=10 tid=0x00007f2994028800 nid=0x3aeb runnable&lt;/p&gt;

&lt;p&gt;&quot;GC task thread#3 (ParallelGC)&quot; prio=10 tid=0x00007f299402a800 nid=0x3aec runnable&lt;/p&gt;

&lt;p&gt;&quot;VM Periodic Task Thread&quot; prio=10 tid=0x00007f29940af000 nid=0x3af4 waiting on condition&lt;/p&gt;

&lt;p&gt;JNI global references: 1622&lt;/p&gt;

&lt;p&gt;Heap&lt;br/&gt;
 PSYoungGen      total 3456K, used 912K [0x00000000ff960000, 0x00000000ffcf0000, 0x0000000100000000)&lt;br/&gt;
  eden space 3264K, 24% used [0x00000000ff960000,0x00000000ffa242e8,0x00000000ffc90000)&lt;br/&gt;
  from space 192K, 66% used [0x00000000ffc90000,0x00000000ffcb0000,0x00000000ffcc0000)&lt;br/&gt;
  to   space 192K, 0% used [0x00000000ffcc0000,0x00000000ffcc0000,0x00000000ffcf0000)&lt;br/&gt;
 PSOldGen        total 13696K, used 4873K [0x00000000fec00000, 0x00000000ff960000, 0x00000000ff960000)&lt;br/&gt;
  object space 13696K, 35% used [0x00000000fec00000,0x00000000ff0c2540,0x00000000ff960000)&lt;br/&gt;
 PSPermGen       total 21248K, used 7030K [0x00000000f9a00000, 0x00000000faec0000, 0x00000000fec00000)&lt;br/&gt;
  object space 21248K, 33% used [0x00000000f9a00000,0x00000000fa0ddb88,0x00000000faec0000)&lt;/p&gt;</comment>
                            <comment id="13289193" author="juhanic" created="Tue, 5 Jun 2012 06:24:54 +0000"  >&lt;p&gt;It doesn&apos;t. I&apos;m pretty sure also the source you use is irrelevant. I switched back to using top(though any exec will work) and could still recreate this.&lt;/p&gt;

&lt;p&gt;here&apos;s a portion of the logs:&lt;br/&gt;
2012-06-05 15:13:44,840 (lifecycleSupervisor-1-1) &lt;span class=&quot;error&quot;&gt;&amp;#91;INFO - org.apache.flume.channel.file.Log.lock(Log.java:573)&amp;#93;&lt;/span&gt; Cannot lock /home/share/juhani_connolly/flume-1.2.0-incubating-SNAPSHOT/check. The directory is already locked.&lt;br/&gt;
2012-06-05 15:13:44,840 (lifecycleSupervisor-1-1) &lt;span class=&quot;error&quot;&gt;&amp;#91;WARN - org.apache.flume.channel.file.FileChannel.start(FileChannel.java:182)&amp;#93;&lt;/span&gt; Starting FileChannel failed&lt;br/&gt;
java.io.IOException: Cannot lock /home/share/juhani_connolly/flume-1.2.0-incubating-SNAPSHOT/check. The directory is already locked.&lt;br/&gt;
	at org.apache.flume.channel.file.Log.lock(Log.java:574)&lt;br/&gt;
	at org.apache.flume.channel.file.Log.&amp;lt;init&amp;gt;(Log.java:95)&lt;br/&gt;
	at org.apache.flume.channel.file.FileChannel.start(FileChannel.java:178)&lt;br/&gt;
	at org.apache.flume.lifecycle.LifecycleSupervisor$MonitorRunnable.run(LifecycleSupervisor.java:228)&lt;br/&gt;
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:441)&lt;br/&gt;
	at java.util.concurrent.FutureTask$Sync.innerRunAndReset(FutureTask.java:317)&lt;br/&gt;
	at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:150)&lt;br/&gt;
	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$101(ScheduledThreadPoolExecutor.java:98)&lt;br/&gt;
	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.runPeriodic(ScheduledThreadPoolExecutor.java:181)&lt;br/&gt;
	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:205)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:619)&lt;br/&gt;
2012-06-05 15:13:44,841 (lifecycleSupervisor-1-1) &lt;span class=&quot;error&quot;&gt;&amp;#91;ERROR - org.apache.flume.lifecycle.LifecycleSupervisor$MonitorRunnable.run(LifecycleSupervisor.java:230)&amp;#93;&lt;/span&gt; Unable to start org.apache.flume.channel.file.FileChannel@3ed02b51 - Exception follows.&lt;br/&gt;
java.lang.RuntimeException: java.io.IOException: Cannot lock /home/share/juhani_connolly/flume-1.2.0-incubating-SNAPSHOT/check. The directory is already locked.&lt;br/&gt;
	at com.google.common.base.Throwables.propagate(Throwables.java:156)&lt;br/&gt;
	at org.apache.flume.channel.file.FileChannel.start(FileChannel.java:183)&lt;br/&gt;
	at org.apache.flume.lifecycle.LifecycleSupervisor$MonitorRunnable.run(LifecycleSupervisor.java:228)&lt;br/&gt;
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:441)&lt;br/&gt;
	at java.util.concurrent.FutureTask$Sync.innerRunAndReset(FutureTask.java:317)&lt;br/&gt;
	at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:150)&lt;br/&gt;
	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$101(ScheduledThreadPoolExecutor.java:98)&lt;br/&gt;
	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.runPeriodic(ScheduledThreadPoolExecutor.java:181)&lt;br/&gt;
	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:205)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:619)&lt;br/&gt;
Caused by: java.io.IOException: Cannot lock /home/share/juhani_connolly/flume-1.2.0-incubating-SNAPSHOT/check. The directory is already locked.&lt;br/&gt;
	at org.apache.flume.channel.file.Log.lock(Log.java:574)&lt;br/&gt;
	at org.apache.flume.channel.file.Log.&amp;lt;init&amp;gt;(Log.java:95)&lt;br/&gt;
	at org.apache.flume.channel.file.FileChannel.start(FileChannel.java:178)&lt;br/&gt;
	... 10 more&lt;/p&gt;


&lt;p&gt;It looks though like one way to recreate this is to kill flume while a replay of logs is happening(I have not managed to recreate Will&apos;s 3 start pattern):&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Start flume with a file channel, let it write some data&lt;/li&gt;
	&lt;li&gt;restart&lt;/li&gt;
	&lt;li&gt;stop while it is replaying the data. This will eventually put things into a dead state where a kill -9 is necessary&lt;/li&gt;
	&lt;li&gt;when you try to restart it, once the replay is done, it is unstartable with the above logs. More interestingly, even deleting the in_use lock files does not recover the state(deleting the checkpoint and data directories will of course work)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;m pretty sure that when I first hit this it was with a different method but I can&apos;t figure it out, but this one I can recreate every time.&lt;/p&gt;

&lt;p&gt;So any time flume is interrupted when trying to replay, something in the process breaks the file channel.&lt;/p&gt;</comment>
                            <comment id="13289207" author="will@cloudera.com" created="Tue, 5 Jun 2012 07:25:03 +0000"  >&lt;p&gt;Okay thanks Juhani, that&apos;s good to know. So it doesn&apos;t seem to be necessarily tied to timestamped events. Interesting.&lt;/p&gt;</comment>
                            <comment id="13397310" author="juhanic" created="Wed, 20 Jun 2012 07:07:10 +0000"  >&lt;p&gt;Arvind, are you looking into this? If not I&apos;m going to have a dig around see if I can figure out what is causing the lock contention&lt;/p&gt;</comment>
                            <comment id="13397367" author="juhanic" created="Wed, 20 Jun 2012 09:18:03 +0000"  >&lt;p&gt;Sorry for hopping onto this with Arvind assigned but we need to have it working soon...&lt;/p&gt;

&lt;p&gt;It looks to me like&lt;/p&gt;

&lt;p&gt;    int pendingTakesSize = pendingTakes.size();&lt;br/&gt;
    if (pendingTakesSize &amp;gt; 0) {&lt;br/&gt;
      String msg = &quot;Pending takes &quot; + pendingTakesSize&lt;br/&gt;
          + &quot; exist after the end of replay&quot;;&lt;br/&gt;
      if (LOG.isDebugEnabled()) {&lt;br/&gt;
        for (Long pointer : pendingTakes) &lt;/p&gt;
{
          LOG.debug(&quot;Pending take &quot; + FlumeEventPointer.fromLong(pointer));
        }
&lt;p&gt;        Preconditions.checkState(false, msg);    // &amp;lt;------------------- THIS&lt;br/&gt;
      } else &lt;/p&gt;
{
        LOG.error(msg + &quot;. Duplicate messages will exist in destination.&quot;);
      }
&lt;p&gt;    }&lt;br/&gt;
    LOG.info(&quot;Replayed &quot; + total);&lt;/p&gt;

&lt;p&gt;Is killing it. I&apos;m not sure why we&apos;re checking preconditions in a isDebugEnabled conditional clause(I guess the intention is to kill things during debug?). Regardless, that cancels the replay, leaving the Log state as open=false, and the files are still locked. From there, the the FileChannel.getDepth throws in exception inside log.getFlumeEventQueue because the log is closed, cancelling the start(), which exits without switching to LifeCycleState.STARTED. From there on, further cycles simply cannot start because the file remains locked.&lt;/p&gt;

&lt;p&gt;So, in summary the problem occurs under the following circumstances:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Debug level logging is enabled&lt;/li&gt;
	&lt;li&gt;There are uncompleted takes in the queue.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Everything else appears to be coincidence(or there may be a bug that causes takes to not be properly processed?)&lt;/p&gt;

&lt;p&gt;Some general problems:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Success of the replay isn&apos;t checked&lt;/li&gt;
	&lt;li&gt;Locks are depending on VM shutdown to be released, unless they actually succeeded the first time around(in the Log constructor).&lt;/li&gt;
	&lt;li&gt;Surely sometimes having pending takes still hanging, is unavoidable... I don&apos;t think we need to be busting out in that situation as I&apos;m sure some users will still be running with logs on debug? I guess the Preconditions.chackState(false) may be a remnant from debugging?&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I haven&apos;t been able to look over everything in detail but merely commenting out the Preconditions line was enough to make everything work and should be enough for a quick fix(of course one can also confirm this is the problem by running with a log level above debug).&lt;/p&gt;</comment>
                            <comment id="13397389" author="aprabhakar" created="Wed, 20 Jun 2012 09:50:29 +0000"  >&lt;p&gt;@Juhani - I just posted a patch. Please review it or try it out and let me know if it addresses the problem.&lt;/p&gt;</comment>
                            <comment id="13397392" author="juhanic" created="Wed, 20 Jun 2012 09:52:16 +0000"  >&lt;p&gt;great timing. I&apos;ll check it out&lt;/p&gt;</comment>
                            <comment id="13397410" author="juhanic" created="Wed, 20 Jun 2012 10:29:25 +0000"  >&lt;p&gt;Cursory testing would seem to indicate it works.&lt;/p&gt;

&lt;p&gt;I&apos;ll do some more serious tests tomorrow on our test systems&lt;/p&gt;</comment>
                            <comment id="13398033" author="aprabhakar" created="Thu, 21 Jun 2012 00:53:49 +0000"  >&lt;p&gt;Updated the patch with review feedback incorporated and removed a debug assertion that was causing some failures.&lt;/p&gt;</comment>
                            <comment id="13398063" author="aprabhakar" created="Thu, 21 Jun 2012 01:30:29 +0000"  >&lt;p&gt;Updated patch with review feedback.&lt;/p&gt;</comment>
                            <comment id="13398587" author="brocknoland" created="Thu, 21 Jun 2012 16:58:47 +0000"  >&lt;p&gt;Committed in 1352615. Thank you for your patch Arvind!&lt;/p&gt;</comment>
                            <comment id="13398611" author="hudson" created="Thu, 21 Jun 2012 17:27:47 +0000"  >&lt;p&gt;Integrated in flume-trunk #246 (See &lt;a href=&quot;https://builds.apache.org/job/flume-trunk/246/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/flume-trunk/246/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-1232&quot; title=&quot;Cannot start agent a 3rd time when using FileChannel&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-1232&quot;&gt;&lt;del&gt;FLUME-1232&lt;/del&gt;&lt;/a&gt;: Cannot start agent a 3rd time when using FileChannel &lt;/p&gt;

&lt;p&gt;(Arvind Prabhakar via Brock Noland) (Revision 1352615)&lt;/p&gt;

&lt;p&gt;     Result = SUCCESS&lt;br/&gt;
brock : &lt;a href=&quot;http://svn.apache.org/viewvc/?view=rev&amp;amp;rev=1352615&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc/?view=rev&amp;amp;rev=1352615&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/incubator/flume/trunk/flume-ng-channels/flume-file-channel/src/main/java/org/apache/flume/channel/file/Checkpoint.java&lt;/li&gt;
	&lt;li&gt;/incubator/flume/trunk/flume-ng-channels/flume-file-channel/src/main/java/org/apache/flume/channel/file/FileChannel.java&lt;/li&gt;
	&lt;li&gt;/incubator/flume/trunk/flume-ng-channels/flume-file-channel/src/main/java/org/apache/flume/channel/file/FileChannelConfiguration.java&lt;/li&gt;
	&lt;li&gt;/incubator/flume/trunk/flume-ng-channels/flume-file-channel/src/main/java/org/apache/flume/channel/file/FlumeEventQueue.java&lt;/li&gt;
	&lt;li&gt;/incubator/flume/trunk/flume-ng-channels/flume-file-channel/src/main/java/org/apache/flume/channel/file/Log.java&lt;/li&gt;
	&lt;li&gt;/incubator/flume/trunk/flume-ng-channels/flume-file-channel/src/main/java/org/apache/flume/channel/file/LogFile.java&lt;/li&gt;
	&lt;li&gt;/incubator/flume/trunk/flume-ng-channels/flume-file-channel/src/main/java/org/apache/flume/channel/file/ReplayHandler.java&lt;/li&gt;
	&lt;li&gt;/incubator/flume/trunk/flume-ng-channels/flume-file-channel/src/test/java/org/apache/flume/channel/file/TestCheckpoint.java&lt;/li&gt;
	&lt;li&gt;/incubator/flume/trunk/flume-ng-channels/flume-file-channel/src/test/java/org/apache/flume/channel/file/TestFileChannel.java&lt;/li&gt;
	&lt;li&gt;/incubator/flume/trunk/flume-ng-channels/flume-file-channel/src/test/java/org/apache/flume/channel/file/TestFlumeEventQueue.java&lt;/li&gt;
	&lt;li&gt;/incubator/flume/trunk/flume-ng-channels/flume-file-channel/src/test/java/org/apache/flume/channel/file/TestLog.java&lt;/li&gt;
	&lt;li&gt;/incubator/flume/trunk/flume-ng-core/src/main/java/org/apache/flume/sink/LoggerSink.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13399532" author="ralph.goers@dslextreme.com" created="Fri, 22 Jun 2012 19:23:39 +0000"  >&lt;p&gt;We ran into this problem when testing. We have verified that the fix corrects the reported problem. Thanks.&lt;/p&gt;</comment>
                            <comment id="13451825" author="will@cloudera.com" created="Mon, 10 Sep 2012 08:58:31 +0000"  >&lt;p&gt;Fix verified. Closing issue.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="12560055">FLUME-1268</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12532678" name="FLUME-1232-2.patch" size="72465" author="aprabhakar" created="Wed, 20 Jun 2012 09:48:30 +0000"/>
                            <attachment id="12532803" name="FLUME-1232-3.patch" size="73110" author="aprabhakar" created="Thu, 21 Jun 2012 00:52:34 +0000"/>
                            <attachment id="12532811" name="FLUME-1232-4.patch" size="73216" author="aprabhakar" created="Thu, 21 Jun 2012 01:30:29 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>248233</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 10 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i09ts7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>55258</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>