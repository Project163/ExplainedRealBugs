<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:56:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLUME-1248] flume-ng script gets broken when it tried to load hbase classpath</title>
                <link>https://issues.apache.org/jira/browse/FLUME-1248</link>
                <project id="12311321" key="FLUME">Flume</project>
                    <description>&lt;p&gt;bin/flume-ng tried to load hbase/hadoop class path by this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;103     local HBASE_CLASSPATH=&quot;&quot;
104     local HBASE_JAVA_LIBRARY_PATH=$(HBASE_CLASSPATH=&lt;span class=&quot;code-quote&quot;&gt;&quot;$FLUME_CLASSPATH&quot;&lt;/span&gt; \
105         ${HBASE_IN_PATH} org.apache.flume.tools.GetJavaProperty \
106         java.library.path 2&amp;gt;/dev/&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It actually turned out to be:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;$ hbase -cp ../lib/flume-ng-core-1.2.0-incubating-SNAPSHOT.jar \
  org.apache.flume.tools.GetJavaProperty  java.library.path
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;However what I saw is:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;-bash-3.2$ hbase -cp ../lib/flume-ng-core-1.2.0-incubating-SNAPSHOT.jar   org.apache.flume.tools.GetJavaProperty  java.library.path
/usr/lib/hadoop-0.20/lib/&lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt;/Linux-amd64-64:/usr/lib/hbase/bin/../lib/&lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt;/Linux-amd64-64
Heap
 par &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; generation   total 235968K, used 8391K [0x00000002fae00000, 0x000000030ae00000, 0x000000030ae00000)
  eden space 209792K,   4% used [0x00000002fae00000, 0x00000002fb631f30, 0x0000000307ae0000)
  from space 26176K,   0% used [0x0000000307ae0000, 0x0000000307ae0000, 0x0000000309470000)
  to   space 26176K,   0% used [0x0000000309470000, 0x0000000309470000, 0x000000030ae00000)
 concurrent mark-sweep generation total 20709376K, used 0K [0x000000030ae00000, 0x00000007fae00000, 0x00000007fae00000)
 concurrent-mark-sweep perm gen total 21248K, used 2724K [0x00000007fae00000, 0x00000007fc2c0000, 0x0000000800000000)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;The hbase gc info outputs to stdout and screwed up the flume-ng script. &lt;/p&gt;

&lt;p&gt;The root cause is the combination of several factors:&lt;br/&gt;
1. turn on hbase gc log by:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;export HBASE_OPTS=&quot;$HBASE_OPTS -verbose:gc -XX:+PrintGCDetails -XX:+PrintGCDateS
tamps -Xloggc:$HBASE_HOME/logs/gc-hbase.log&quot; 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;2. the gc log directory is protected by limiting the permission as 755, and owned by hbase user.&lt;/p&gt;

&lt;p&gt;3. use another user, such as flume, to execute the script.&lt;/p&gt;

&lt;p&gt;Since flume user doesn&apos;t have write permission to the hbase gc log directory, jvm will output the gc info to stdout, and the flume script will be screwed up. &lt;/p&gt;

&lt;p&gt;A simple but tricky fix could be adding ``grep hbase&apos;&apos; in the scrip to filter out the gc info:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;103     local HBASE_CLASSPATH=&quot;&quot;
104     local HBASE_JAVA_LIBRARY_PATH=$(HBASE_CLASSPATH=&lt;span class=&quot;code-quote&quot;&gt;&quot;$FLUME_CLASSPATH&quot;&lt;/span&gt; \
105         ${HBASE_IN_PATH} org.apache.flume.tools.GetJavaProperty \
106         java.library.path | grep hbase 2&amp;gt;/dev/&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</description>
                <environment></environment>
        <key id="12558865">FLUME-1248</key>
            <summary>flume-ng script gets broken when it tried to load hbase classpath</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="will@cloudera.com">Will McQueen</assignee>
                                    <reporter username="mingjielai">Mingjie Lai</reporter>
                        <labels>
                    </labels>
                <created>Thu, 31 May 2012 21:09:29 +0000</created>
                <updated>Mon, 18 Jun 2012 23:26:11 +0000</updated>
                            <resolved>Mon, 18 Jun 2012 23:00:10 +0000</resolved>
                                    <version>1.1.0</version>
                                    <fixVersion>1.2.0</fixVersion>
                                    <component>Shell</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="13286949" author="mingjielai" created="Thu, 31 May 2012 21:10:52 +0000"  >&lt;p&gt;It should be a common a use case that people turn on gc log and use another user to execute hbase. &lt;/p&gt;

&lt;p&gt;Thought?&lt;/p&gt;</comment>
                            <comment id="13286987" author="hshreedharan" created="Thu, 31 May 2012 22:02:05 +0000"  >&lt;p&gt;Thanks Mingjie. I will take a look at this. &lt;/p&gt;</comment>
                            <comment id="13287091" author="hshreedharan" created="Fri, 1 Jun 2012 01:48:54 +0000"  >&lt;p&gt;Mingjie,&lt;/p&gt;

&lt;p&gt;I posted a patch which implements the idea you posted above for add_hadoop_paths too(and add_HBASE_paths as you mentioned above).&lt;/p&gt;

</comment>
                            <comment id="13287144" author="mingjielai" created="Fri, 1 Jun 2012 04:25:48 +0000"  >&lt;p&gt;Hari. &lt;/p&gt;

&lt;p&gt;Thanks. Another option is to pass a parameter to flume-ng which indicates to include hadoop/hbase classpath or not. &lt;/p&gt;

&lt;p&gt;However I think using grep is okay currently. &lt;/p&gt;

&lt;p&gt;+1&lt;/p&gt;
</comment>
                            <comment id="13287156" author="will@cloudera.com" created="Fri, 1 Jun 2012 05:22:27 +0000"  >&lt;p&gt;Hi Mingjie and Hari,&lt;/p&gt;

&lt;p&gt;&amp;gt;&amp;gt;Another option is to pass a parameter to flume-ng which indicates to include hadoop/hbase classpath or not.&lt;/p&gt;

&lt;p&gt;AFAIK, hbase jars are only needed by hbase sink, and hadoop jars are needed only by FileChannel and HDFSEventSink. If we enable the passing of a param to flume-ng that indicates whether to include hadoop/hbase classpath, then what about the case where a user starts the agent without any of those 3 components in the config file, but later decides to modify the config while Flume is running? In that case, I believe a ClassNotFoundException would be thrown when adding one of those 3 components to the config (after a dynamic refresh is triggered w/in 30 secs of modification).&lt;/p&gt;

&lt;p&gt;For this reason, my vote is currently to pick-up hbase and hadoop jars.&lt;/p&gt;

&lt;p&gt;Also, I&apos;m wondering about the solution regarding the grep of the hbase (or hadoop) string... it seems that &apos;hbase&apos; string won&apos;t necessarily be in the classpath if a user installs hbase from a tar file. So I&apos;m concerned about having our parsing code be tightly coupled to the &apos;hbase&apos; string. Can we explore other alternatives? I think some things to consider in general would be:&lt;/p&gt;

&lt;p&gt;1) Keep in mind that the goal of these 2 particular invocations of hbase and hadoop scripts are only to get the java.library.path, which I believe should be unaffected by an JVM options. ie, I don&apos;t see a need to profile these 2 invocations of hadoop and hbase like I would if I were profiling the actual hbase and hadoop daemons. Do you?&lt;/p&gt;

&lt;p&gt;2) There are several ways that JVM options might sneak into the environment when hbase/hadoop is run. One way might be through a file in /etc/default that could get sourced by a hadoop/hbase init script. Another way could be through flume-env.sh. Another might be just by exporting a var from the parent shell that runs flume-ng. We should consider all these cases (and possibly more), and see if it makes sense to somehow override all JVM options passed to the hadoop/hbase during these 2 invocations so that the JVM options are reset to empty string to guarantee clean output.&lt;/p&gt;

&lt;p&gt;3) We could modify the GetJavaProperty tool (or create an alternative impl and leave the current impl as it is). The reason is this: I&apos;m concerned that it could be possible that thedesired output we need from this tool might be interleaved with output from some JVM option, possibly resulting in corrupted output. So, one proposal would be to insert some checks into the output string that the flume-ng script could use to confirm the java.library.path value&apos;s validity. For example, if GetJavaProperty returns a java.library.path value of &quot;.:/some/class/path&quot;, then the output to stdout could be something like &quot;&amp;lt;magicnum&amp;gt;.:/some/class/path&amp;lt;magicnum&amp;gt;&amp;lt;md5sum&amp;gt;&quot;, where magicnum is some known constant specified in GetJavaProperty, and surrounds the java.library.path value, with a trailing md5sum of the &quot;.:/some/class.path&quot; value to ensure that the string value was not interleaved with some other output from some JVM options. So the flume-ng script would just need to use the known magicnum to parse-out the value using something like a regex, and then parse-out the md5sum trailer (which I believe is a fixed string) to compare it against the md5sum calculated by the flume-ng script. If they match, we continue. If they don&apos;t, then we either print a warning and continue, or we print an error and stop (I vote for error and stop).&lt;/p&gt;

&lt;p&gt;Personally, I feel most comfortable with option #3 so far as the more robust of the 3. Thoughts?&lt;/p&gt;

&lt;p&gt;Cheers,&lt;br/&gt;
Will&lt;/p&gt;</comment>
                            <comment id="13287162" author="hshreedharan" created="Fri, 1 Jun 2012 05:39:01 +0000"  >&lt;p&gt;&amp;gt;&amp;gt; Also, I&apos;m wondering about the solution regarding the grep of the hbase (or hadoop) string... it seems that &apos;hbase&apos; string won&apos;t necessarily be in the classpath if a user installs hbase from a tar file. So I&apos;m concerned about having our parsing code be tightly coupled to the &apos;hbase&apos; string. &lt;/p&gt;

&lt;p&gt;Agreed. This is a problem.&lt;/p&gt;

&lt;p&gt;#3 does seem like a good, but complex solution.&lt;/p&gt;

&lt;p&gt;Another option is to have GetJavaProperty write to some file in /tmp and the flume-ng script delete it after it is done.&lt;/p&gt;</comment>
                            <comment id="13287163" author="mubarakseyed" created="Fri, 1 Jun 2012 05:42:03 +0000"  >&lt;p&gt;+1 for option #3&lt;/p&gt;</comment>
                            <comment id="13287200" author="will@cloudera.com" created="Fri, 1 Jun 2012 05:56:06 +0000"  >&lt;p&gt;Hi Hari,&lt;/p&gt;

&lt;p&gt;If you like you can re-assign this ticket to me and I can give #3 a shot.&lt;/p&gt;

&lt;p&gt;Cheers,&lt;br/&gt;
Will&lt;/p&gt;</comment>
                            <comment id="13287201" author="hshreedharan" created="Fri, 1 Jun 2012 05:58:44 +0000"  >&lt;p&gt;Hi Will - Sure. Please do.&lt;/p&gt;</comment>
                            <comment id="13287206" author="mingjielai" created="Fri, 1 Jun 2012 06:24:29 +0000"  >&lt;p&gt;Will. &lt;/p&gt;

&lt;p&gt;I agreed grep is problematic. &lt;/p&gt;

&lt;p&gt;But #3 is a little bit complicated. &lt;/p&gt;

&lt;p&gt;How about use ``head -n1&apos;&apos; instead of grep? It can guarantee there is only one line to stdout. So far I only see gc log corrupting the output. It might be good enough. We can also perform some check after getting the output. &lt;/p&gt;
</comment>
                            <comment id="13287282" author="mpercy" created="Fri, 1 Jun 2012 09:14:37 +0000"  >&lt;p&gt;Would this work?&lt;/p&gt;

&lt;p&gt;local OLD_HBASE_OPTS=&quot;$HBASE_OPTS&quot;&lt;br/&gt;
export HBASE_OPTS=&quot;&quot;&lt;br/&gt;
local HBASE_JAVA_LIBRARY_PATH=$(HBASE_CLASSPATH=&quot;$FLUME_CLASSPATH&quot; \&lt;br/&gt;
        ${HBASE_IN_PATH} org.apache.flume.tools.GetJavaProperty \&lt;br/&gt;
        java.library.path 2&amp;gt;/dev/null)&lt;br/&gt;
HBASE_OPTS=&quot;$OLD_HBASE_OPTS&quot;&lt;/p&gt;

&lt;p&gt;Sounds to me like the script environment is getting polluted from the shell... if that&apos;s the root cause then let&apos;s prevent that.&lt;/p&gt;</comment>
                            <comment id="13287298" author="will@cloudera.com" created="Fri, 1 Jun 2012 09:47:20 +0000"  >&lt;p&gt;Mingjie,&lt;/p&gt;

&lt;p&gt;For &apos;head -n1&apos;, would it be safe to assume that the first line of output would always contain the desired output of GetJavaProperty? Also, what kind of check did you have in mind? If the check fails, then would we parse the next line, or fail?&lt;/p&gt;

&lt;p&gt;Mike,&lt;/p&gt;

&lt;p&gt;Sounds like you have a good, simple solution for option #2 that doesn&apos;t involve any parsing of output. And I don&apos;t think that any files in /etc/default would get sourced, because I believe those are sourced only from init scripts... so I think now there should be no concern about getting unexpected output to stdout since the flume-ng script is calling the hadoop/hbase executable directly. +1 for your solution, unless someone feels a need for wanting to run with JVM options for GetJavaProperty.&lt;/p&gt;

&lt;p&gt;Btw, here&apos;s some code for solution #3. It would require a new lib (Apache commons codec) for DigestUtils, and some flume-ng script changes for doing the parsing. It would also mean that since the flume-ng script would need use md5sum, the user must have md5sum installed on their machine. Using your solution obviates the need for all this.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;GetJavaProperty2 {
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; DELIM = 0xFEEDDADEEL; &lt;span class=&quot;code-comment&quot;&gt;//68432014830
&lt;/span&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; args[]) {
        args = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] {&lt;span class=&quot;code-quote&quot;&gt;&quot;java.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;path&quot;&lt;/span&gt;};
        StringBuilder payloadBuilder = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StringBuilder();

        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (args.length == 0) {
            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; prop : &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.getProperties().keySet()) {
                payloadBuilder.append(prop + &lt;span class=&quot;code-quote&quot;&gt;&quot;=&quot;&lt;/span&gt;
                        + &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.getProperty(prop.toString(), &quot;&quot;));
            }
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; prop : args) {
                payloadBuilder.append(&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.getProperty(prop, &quot;&quot;));
            }
        }

        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; payload = payloadBuilder.toString();

        StringBuilder envelope = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StringBuilder();
        envelope.append(&lt;span class=&quot;code-quote&quot;&gt;&quot;||&quot;&lt;/span&gt;).append(DELIM);
        envelope.append(&lt;span class=&quot;code-quote&quot;&gt;&quot;||&quot;&lt;/span&gt;).append(payload.toString());
        envelope.append(&lt;span class=&quot;code-quote&quot;&gt;&quot;||&quot;&lt;/span&gt;).append(DELIM);

        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; md5Trailer = DigestUtils.md5Hex(payload.toString());

        StringBuilder output = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StringBuilder(envelope);
        output.append(&lt;span class=&quot;code-quote&quot;&gt;&quot;||&quot;&lt;/span&gt;).append(md5Trailer);
        output.append(&lt;span class=&quot;code-quote&quot;&gt;&quot;||&quot;&lt;/span&gt;);

        &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(output);
    }
}

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13287312" author="mpercy" created="Fri, 1 Jun 2012 10:09:21 +0000"  >&lt;p&gt;Hey, whatever works is great... let&apos;s just try to keep it easy to understand the intention of the code. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13287492" author="hshreedharan" created="Fri, 1 Jun 2012 15:58:11 +0000"  >&lt;p&gt;One of the reasons I did not suggest it was because I was not sure if all versions of HBase use the same env variable and also if it would change in future releases of Hbase. If it is changed, then we will have issues when running against different versions of HBase. I am not sure it is a good idea to have a dependency(or whatever it can be called), on an env variable we do not own or control, and which might as well be called something else in the future(what if HBase decides it should be called HBASE_JAVA_OPTS or something - remember HADOOP_HOME and HADOOP_PREFIX).&lt;/p&gt;</comment>
                            <comment id="13287573" author="mingjielai" created="Fri, 1 Jun 2012 18:16:42 +0000"  >&lt;p&gt;Will. &lt;/p&gt;

&lt;p&gt;&amp;gt; For &apos;head -n1&apos;, would it be safe to assume that the first line of output would always contain the desired output of GetJavaProperty? &lt;/p&gt;

&lt;p&gt;From the logic in flume-ng, we only need the first line from the output. No? &lt;/p&gt;

&lt;p&gt;&amp;gt; Also, what kind of check did you have in mind? &lt;/p&gt;

&lt;p&gt;the expect result should be several class paths that separated by ``:&apos;&apos;, in one line. We can ignore it if it doesn&apos;t match&lt;/p&gt;

&lt;p&gt;I think we need the make the code generic enough for all (possible) other cases. Adding special delimiters in java code then parsing in shell is a little bit too tricky.&lt;/p&gt;

&lt;p&gt;And as I described above, this problem only occurs with the combination of multiple conditions for hbase. We may not want to have some special treatment in the flume core feature. I&apos;d prefer to only do parsing in the script, such as head -n1.&lt;/p&gt;

&lt;p&gt;In most case, ppl may just want to call:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;$ java -cp flume-ng-core-1.2.0-incubating-SNAPSHOT.jar   org.apache.flume.tools.GetJavaProperty [one property]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and expect to see the expected property without seeing weird delimiters. &lt;/p&gt;

&lt;p&gt;As Mike said, we should make it simple, and easy to understand. &lt;/p&gt;</comment>
                            <comment id="13287602" author="mpercy" created="Fri, 1 Jun 2012 18:55:25 +0000"  >&lt;p&gt;One aspect of bin/flume-ng which may not be obvious is that it tries to disable all interference from environment variables from places other than flume-env.sh. This is related to desired behavior if an init script calls bin/flume-ng on system reboot. Maybe a better alternative than my last suggestion is to simply set HBASE_OPTS=&quot;&quot; at the top of the script, and then source flume-env.sh ... then people have the flexibility of overriding it if needed. If HBase changes the variable name in the future, we can null out that variable too.&lt;/p&gt;

&lt;p&gt;We can do head -n1 as well (which is also simple), however it feels like like that&apos;s just working around this issue.&lt;/p&gt;</comment>
                            <comment id="13287735" author="hshreedharan" created="Fri, 1 Jun 2012 22:21:46 +0000"  >&lt;p&gt;Mike: Yes, we can null out the variable(and any new ones HBase might introduce), but now we would have weird version dependencies - like older versions of flume not working with new version of HBase etc. I already don&apos;t like the way we have hacked around the Hadoop variable naming issue, I would rather not see something like that for HBase as well. The script is quite hacky as it is, I would prefer that we don&apos;t have situations where we have a bunch of code which is meant to just hack around issues like this. &lt;/p&gt;

&lt;p&gt;What I am trying to say is - we should not have to worry about environment variables/files etc which we do not control and are pretty much implementation detail of some other system(Hadoop/HBase/anything). We should not have code depending on those projects using these environment variables and that should not lead us to having extra bits and pieces of code to make things work. I&apos;d rather see a more complex, but reliable/robust piece of code that does not need to change based on other projects.&lt;/p&gt;

&lt;p&gt;Will: Do you really need to use MD5 itself? As far as I can see, any way in which we can compare that the original string is the same as the output should be fine right? Even an ASCII character sum? Agreed, it is not as good as having MD5, but I am quite sure it will be ok to use something like that.&lt;/p&gt;</comment>
                            <comment id="13287819" author="mpercy" created="Sat, 2 Jun 2012 01:01:41 +0000"  >&lt;p&gt;Guys, I feel that doing any kind of complicated parsing or md5 stuff is really overcomplicating the solution. These bugs are quite simple to work around / fix in this manner and changes to those environment variables should be rare enough that we can just fix any problems as we find them. It&apos;s not practical to try to future-proof this shell interface stuff which is already, unfortunately, not very robust (because HBase and Hadoop do not provide the facilities we want). Let&apos;s just do the simplest thing possible here.&lt;/p&gt;</comment>
                            <comment id="13288439" author="will@cloudera.com" created="Mon, 4 Jun 2012 09:17:14 +0000"  >&lt;p&gt;Hi Mingjie,&lt;/p&gt;

&lt;p&gt;&amp;gt;&amp;gt;How about use ``head -n1&apos;&apos; instead of grep? It can guarantee there is only one line to stdout.&lt;/p&gt;

&lt;p&gt;Good idea, but there&apos;s no guarantee that the desired line will located on the first line of the output (eg, when using other JVM args such as &apos;-verbose:class&apos;).&lt;/p&gt;

&lt;p&gt;Cheers,&lt;br/&gt;
Will&lt;/p&gt;</comment>
                            <comment id="13288443" author="will@cloudera.com" created="Mon, 4 Jun 2012 09:21:34 +0000"  >&lt;p&gt;Let&apos;s go with a simple solution and consider other options in the future as the need arises. I&apos;d like to go with the solution proposed by Mike. I&apos;ve attached a patch for review. Thank you.&lt;/p&gt;</comment>
                            <comment id="13290871" author="mingjielai" created="Thu, 7 Jun 2012 07:47:47 +0000"  >&lt;p&gt;Will. I don&apos;t understand how the patch can fix the issue:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;diff --git bin/flume-ng bin/flume-ng
index 6088e3d..3652185 100755
--- bin/flume-ng
+++ bin/flume-ng
@@ -185,6 +185,8 @@ run_flume() {
 # set &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt; params
 FLUME_CLASSPATH=&quot;&quot;
 FLUME_JAVA_LIBRARY_PATH=&quot;&quot;
+HADOOP_OPTS=&quot;&quot;
+HBASE_OPTS=&quot;&quot;
 JAVA_OPTS=&lt;span class=&quot;code-quote&quot;&gt;&quot;-Xmx20m&quot;&lt;/span&gt;
 
 opt_conf=&quot;&quot;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</comment>
                            <comment id="13290884" author="will@cloudera.com" created="Thu, 7 Jun 2012 08:32:27 +0000"  >&lt;p&gt;Removing patch from this ticket. This particular solution isn&apos;t solving the issue. I was able to reproduce the same issue with this patch when I put the GC options into the hbase-env.sh file. Will post a follow-up comment.&lt;/p&gt;</comment>
                            <comment id="13290905" author="will@cloudera.com" created="Thu, 7 Jun 2012 09:32:14 +0000"  >&lt;p&gt;Hi Mingjie,&lt;/p&gt;

&lt;p&gt;In the diff you posted from the previously att&apos;d patch, the HADOOP_OPTS and HBASE_OPTS are set to empty string so that GC options wouldn&apos;t be passed to hbase when invoked from Flume and then the output from the GetJavaProperty call wouldn&apos;t come back with extra lines. Those 2 lines probably should&apos;ve specified &apos;export&apos;:&lt;br/&gt;
     export HADOOP_OPTS=&quot;&quot;&lt;br/&gt;
     export HBASE_OPTS=&quot;&quot;&lt;/p&gt;

&lt;p&gt;...but regardless, I can still reproduce the issue when I uncomment the line in hbase-env.sh that adds the GC options:&lt;br/&gt;
     export HBASE_OPTS=&quot;$HBASE_OPTS -verbose:gc -XX:+PrintGCDetails -XX:+PrintGCDateStamps&quot;&lt;/p&gt;

&lt;p&gt;...so I cancelled the patch and it looks like this needs more discussion (and I need to test before submitting the next patch).&lt;/p&gt;

&lt;p&gt;If we look at hbase script, it&apos;s sourcing hbase-config.sh, which in turn sources hadoop-env.sh, in which a user can specify an HBASE_OPTS value to startup hbase with. If that HBASE_OPTS value has gc args like &quot;-verbose:gc&quot;, then we know that flume will get back unexpected output. So, I think we should reconsider your suggestion and possibly modify it. So your suggestion was:&lt;/p&gt;

&lt;p&gt;     head -n1&lt;/p&gt;

&lt;p&gt;..and I believe that it will solve exactly the problem you posted in the ticket, using the jvm args that you mention. So if we want to just solve the current problem, then this seems like a straightforward solution. But if we want a solution that covers additional cases, such as &quot;-verbose:class&quot; option (or any other option that writes to stdout before the program&apos;s main() output has been written), then I feel we have some choices, including:&lt;/p&gt;

&lt;p&gt;1) Call GetJavaProperties w/o any args, which will cause all env vars to be printed, one per line. So then grep for the line that starts with key &quot;java.library.path=&quot;, and grab the associated value and we&apos;re done.&lt;br/&gt;
..or..&lt;br/&gt;
2) Modify GetJavaProperties so that calling it with an arg would print the key to stdout, then proceed as in step 1. So change this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;     &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.getProperty(prop, &quot;&quot;));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;...to this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;     &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(prop + &lt;span class=&quot;code-quote&quot;&gt;&quot;=&quot;&lt;/span&gt; + &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.getProperty(prop, &quot;&quot;));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;#2 will produce a lot less output to parse on each startup of the agent, while #1 just requires a change to the script and not to the Java code.&lt;/p&gt;


&lt;p&gt;Thoughts?&lt;/p&gt;</comment>
                            <comment id="13292075" author="hshreedharan" created="Fri, 8 Jun 2012 23:06:43 +0000"  >&lt;p&gt;Hi Will,&lt;/p&gt;

&lt;p&gt;Could you let me know if you have a patch for this yet? I guess it is feasible for now to use &quot;head -n 1&quot; and note that some gc options can cause problems. &lt;/p&gt;

&lt;p&gt;As for the above, I&apos;d rather have the changes go into the Java code than the already fragile script. This is just a suggestion, please feel free to choose the one which you think is better. &lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="13294769" author="will@cloudera.com" created="Thu, 14 Jun 2012 02:23:54 +0000"  >&lt;p&gt;This patch searches for the prop value of java.library.path using bash regex. The script assumes that the target line can appear anywhere in the output (eg, when specifying -verbose:class in hbase-env.sh)&lt;/p&gt;</comment>
                            <comment id="13294771" author="will@cloudera.com" created="Thu, 14 Jun 2012 02:25:13 +0000"  >&lt;p&gt;Patch is not att&apos;d to this ticket. Could not submit to reviewboard because reviewboard main page says &quot;503 Service Temporarily Unavailable&quot;&lt;/p&gt;</comment>
                            <comment id="13294773" author="will@cloudera.com" created="Thu, 14 Jun 2012 02:31:10 +0000"  >&lt;p&gt;Tested with the following combinations:&lt;/p&gt;

&lt;p&gt;1: &lt;span class=&quot;error&quot;&gt;&amp;#91;PASS&amp;#93;&lt;/span&gt;&lt;br/&gt;
hbase and hadoop are both installed&lt;br/&gt;
hbase-env.sh specifies:&lt;br/&gt;
  export HBASE_OPTS=&quot;$HBASE_OPTS -verbose:class -XX:+PrintGCDetails -XX:+PrintGCDateStamps&quot;&lt;br/&gt;
hadoop-env.sh doesn&apos;t specify any GC options&lt;/p&gt;

&lt;p&gt;2: &lt;span class=&quot;error&quot;&gt;&amp;#91;PASS&amp;#93;&lt;/span&gt;&lt;br/&gt;
hadoop is installed but hbase is not installed&lt;br/&gt;
hadoop-env.sh specifies:&lt;br/&gt;
  export HADOOP_OPTS=&quot;$HADOOP_OPTS -verbose:class -XX:+PrintGCDetails -XX:+PrintGCDateStamps&quot;&lt;/p&gt;

&lt;p&gt;3: &lt;span class=&quot;error&quot;&gt;&amp;#91;FAIL, as expected. This is beyond Flume&amp;#39;s control&amp;#93;&lt;/span&gt;&lt;br/&gt;
hbase and hadoop are both installed&lt;br/&gt;
hbase-env.sh specifies:&lt;br/&gt;
  export HBASE_OPTS=&quot;$HBASE_OPTS -verbose:class -XX:+PrintGCDetails -XX:+PrintGCDateStamps&quot;&lt;br/&gt;
hadoop-env.sh specifies:&lt;br/&gt;
  export HADOOP_OPTS=&quot;$HADOOP_OPTS -verbose:class -XX:+PrintGCDetails -XX:+PrintGCDateStamps&quot;&lt;/p&gt;

&lt;p&gt;In order for case #3 to pass, the hbase script would need to apply the same change that we&apos;re proposing to make here with Flume.&lt;/p&gt;</comment>
                            <comment id="13294775" author="will@cloudera.com" created="Thu, 14 Jun 2012 02:33:02 +0000"  >&lt;p&gt;Missing GetJavaProperty diff&lt;/p&gt;</comment>
                            <comment id="13294777" author="will@cloudera.com" created="Thu, 14 Jun 2012 02:34:49 +0000"  >&lt;p&gt;This patch searches for the prop value of java.library.path using bash regex. The script assumes that the target line can appear anywhere in the output (eg, when specifying -verbose:class in hbase-env.sh)&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;This patch includes the GetJavaProperty.java diff&amp;#93;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="13294778" author="will@cloudera.com" created="Thu, 14 Jun 2012 02:35:44 +0000"  >&lt;p&gt;Re-attached patch with GetJavaProperty.java diff this time.&lt;/p&gt;</comment>
                            <comment id="13295273" author="will@cloudera.com" created="Thu, 14 Jun 2012 19:59:13 +0000"  >&lt;p&gt;This patch is ready to be reviewed.&lt;/p&gt;</comment>
                            <comment id="13295280" author="hshreedharan" created="Thu, 14 Jun 2012 20:09:53 +0000"  >&lt;p&gt;I tried out the patch, with HBASE_OPTS set. Works as expected.&lt;/p&gt;</comment>
                            <comment id="13396154" author="mpercy" created="Mon, 18 Jun 2012 19:04:47 +0000"  >&lt;p&gt;Will, the patch looks good, and it works.&lt;/p&gt;

&lt;p&gt;One nit: can you remove the below lines?&lt;/p&gt;

&lt;p&gt;IFS=$&apos;\n&apos;&lt;br/&gt;
unset IFS&lt;/p&gt;

&lt;p&gt;This IFS variable appears twice in the patch but is apparently not used.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Mike&lt;/p&gt;</comment>
                            <comment id="13396332" author="mpercy" created="Mon, 18 Jun 2012 22:57:23 +0000"  >&lt;p&gt;Hmm, looks like this is a built-in bash variable. Tricky bash!&lt;/p&gt;

&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13396336" author="mpercy" created="Mon, 18 Jun 2012 23:00:10 +0000"  >&lt;p&gt;Patch committed. Thanks Will!&lt;/p&gt;</comment>
                            <comment id="13396353" author="hudson" created="Mon, 18 Jun 2012 23:26:11 +0000"  >&lt;p&gt;Integrated in flume-trunk #238 (See &lt;a href=&quot;https://builds.apache.org/job/flume-trunk/238/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/flume-trunk/238/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-1248&quot; title=&quot;flume-ng script gets broken when it tried to load hbase classpath&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-1248&quot;&gt;&lt;del&gt;FLUME-1248&lt;/del&gt;&lt;/a&gt;. flume-ng script breaks if hbase-env.sh sets certain Java opts.&lt;/p&gt;

&lt;p&gt;(Will McQueen via Mike Percy) (Revision 1351528)&lt;/p&gt;

&lt;p&gt;     Result = SUCCESS&lt;br/&gt;
mpercy : &lt;a href=&quot;http://svn.apache.org/viewvc/?view=rev&amp;amp;rev=1351528&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc/?view=rev&amp;amp;rev=1351528&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/incubator/flume/trunk/bin/flume-ng&lt;/li&gt;
	&lt;li&gt;/incubator/flume/trunk/flume-ng-core/src/main/java/org/apache/flume/tools/GetJavaProperty.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12532036" name="FLUME-1248.patch" size="2168" author="will@cloudera.com" created="Thu, 14 Jun 2012 02:34:49 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>248249</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 22 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i09tvr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>55274</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>