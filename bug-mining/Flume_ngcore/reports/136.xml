<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:57:18 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLUME-2233] MemoryChannel lock contention on every put due to bytesRemaining Semaphore</title>
                <link>https://issues.apache.org/jira/browse/FLUME-2233</link>
                <project id="12311321" key="FLUME">Flume</project>
                    <description>&lt;p&gt;This semaphore is checked every time there is a put (unlike the queueRemaining semaphore which is checked only on transaction commits), causing the channel to slow down, even when the user does not care about memory usage. &lt;/p&gt;

&lt;p&gt;We must add a new parameter to make sure that we look at bytesRemaining only when required which the user can disable if memory is not something they worry about because they know the channel size will be sufficiently small. By default, we will need to still check bytesRemaining to avoid breaking existing configurations.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12677465">FLUME-2233</key>
            <summary>MemoryChannel lock contention on every put due to bytesRemaining Semaphore</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hshreedharan">Hari Shreedharan</assignee>
                                    <reporter username="hshreedharan">Hari Shreedharan</reporter>
                        <labels>
                    </labels>
                <created>Mon, 4 Nov 2013 22:49:12 +0000</created>
                <updated>Sat, 9 Nov 2013 07:18:43 +0000</updated>
                            <resolved>Thu, 7 Nov 2013 21:01:34 +0000</resolved>
                                                    <fixVersion>1.5.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="13813510" author="roshan_naik" created="Tue, 5 Nov 2013 01:10:53 +0000"  >&lt;p&gt;whatever it is, it would be good to make it default. &lt;br/&gt;
It would be nice to have most flume components require minimal (if not 0) explicit config tweaks to have them run in a performant manner.&lt;/p&gt;</comment>
                            <comment id="13813527" author="hshreedharan" created="Tue, 5 Nov 2013 01:34:01 +0000"  >&lt;p&gt;I agree, but the issue is that we have made releases which automatically check for the available memory size fields. Adding this param means that we need to ensure that older config behavior does not change. So we need to check bytesRemaining by default.&lt;/p&gt;</comment>
                            <comment id="13813665" author="hshreedharan" created="Tue, 5 Nov 2013 05:41:18 +0000"  >&lt;p&gt;Patch that implements the fix. Unfortunately, there is no easy way to test this fix.&lt;/p&gt;</comment>
                            <comment id="13814212" author="roshan_naik" created="Tue, 5 Nov 2013 20:05:57 +0000"  >&lt;p&gt;Rather than optionally disabling the semaphore, i think it is better to instead update the semaphore on commit. That will help the perf issue and also flume wont be running in a unsafe mode. It is difficult in practice for users to decide upfront whether or not this flag should be turned on in production.&lt;/p&gt;</comment>
                            <comment id="13814217" author="hshreedharan" created="Tue, 5 Nov 2013 20:11:22 +0000"  >&lt;p&gt;That was my initial thought - to do what we do with the queueRemaining semaphore, but a long running transaction could essentially hold up heap space - and the heap space used by the channel is not just the committed transactions. Even though there is a performance penalty, this actually is more of the intended meaning of the original patch. Also, I have rarely seen this enabled in prod. Most users with memory channels generally tend to keep smaller channels and don&apos;t really hit memory issues a lot.&lt;/p&gt;</comment>
                            <comment id="13814219" author="hshreedharan" created="Tue, 5 Nov 2013 20:12:33 +0000"  >&lt;p&gt;Also note that I am not married to this approach. If other committers feel strongly that we should check the semaphore on commit, I am ok with that too - though I think that might be a bit misguiding to users.&lt;/p&gt;</comment>
                            <comment id="13814251" author="roshan_naik" created="Tue, 5 Nov 2013 21:07:45 +0000"  >&lt;p&gt;ok. I think the byteCapacityBufferPercentage can mitigate/alleviate the heap consumption issue.&lt;/p&gt;</comment>
                            <comment id="13814258" author="hshreedharan" created="Tue, 5 Nov 2013 21:16:43 +0000"  >&lt;p&gt;Note sure what you mean? Are you suggesting we move this to just the commit and ask that the users specify a lower byteCapacityBufferPercentage to take care of the events currently in the pipeline?&lt;/p&gt;</comment>
                            <comment id="13814280" author="roshan_naik" created="Tue, 5 Nov 2013 21:41:35 +0000"  >&lt;p&gt;Yes, kind of..  i was thinking byteCapacityBufferPercentage can be used to account for the uncommitted events also. Today it seems to be used to account for header size only. &lt;/p&gt;

&lt;p&gt;Whether users need to tweak the setting or not would depend on the situation. For many use cases the current default value may already be generous enough since the transaction batch size is typically not very large. Use cases where lots of headers are applied to events, very large batch sizes on source, lots of sources are hooked up to a single mem channel, or event body size is relatively large are situations where user may need to tweak byteCapacityBufferPercentage.&lt;/p&gt;</comment>
                            <comment id="13814360" author="hshreedharan" created="Tue, 5 Nov 2013 22:54:28 +0000"  >&lt;p&gt;Moving the semaphore update to commit. This should improve the lock contention issue.&lt;/p&gt;</comment>
                            <comment id="13815604" author="roshan_naik" created="Thu, 7 Nov 2013 03:25:15 +0000"  >&lt;p&gt;could you please update the patch on  RB ?&lt;/p&gt;</comment>
                            <comment id="13815684" author="hshreedharan" created="Thu, 7 Nov 2013 05:54:41 +0000"  >&lt;p&gt;Done&lt;/p&gt;</comment>
                            <comment id="13816415" author="roshan_naik" created="Thu, 7 Nov 2013 21:01:12 +0000"  >&lt;p&gt;+1.&lt;br/&gt;
Thanks for the patch Hari.&lt;/p&gt;</comment>
                            <comment id="13818053" author="hudson" created="Sat, 9 Nov 2013 07:18:43 +0000"  >&lt;p&gt;FAILURE: Integrated in flume-trunk #522 (See &lt;a href=&quot;https://builds.apache.org/job/flume-trunk/522/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/flume-trunk/522/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-2233&quot; title=&quot;MemoryChannel lock contention on every put due to bytesRemaining Semaphore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-2233&quot;&gt;&lt;del&gt;FLUME-2233&lt;/del&gt;&lt;/a&gt;. MemoryChannel lock contention on every put due to bytesRemaining Semaphore (roshan: &lt;a href=&quot;http://git-wip-us.apache.org/repos/asf/flume/repo?p=flume.git&amp;amp;a=commit&amp;amp;h=d3f5123c4d6cdbe4e5cca6e7e141e507bb1103a7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://git-wip-us.apache.org/repos/asf/flume/repo?p=flume.git&amp;amp;a=commit&amp;amp;h=d3f5123c4d6cdbe4e5cca6e7e141e507bb1103a7&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;flume-ng-core/src/main/java/org/apache/flume/channel/MemoryChannel.java&lt;/li&gt;
	&lt;li&gt;flume-ng-core/src/test/java/org/apache/flume/channel/TestMemoryChannel.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12612270" name="FLUME-2233.patch" size="6012" author="hshreedharan" created="Tue, 5 Nov 2013 22:54:28 +0000"/>
                            <attachment id="12612236" name="FLUME-2233.patch" size="9851" author="hshreedharan" created="Tue, 5 Nov 2013 20:12:33 +0000"/>
                            <attachment id="12612232" name="FLUME-2233.patch" size="9847" author="hshreedharan" created="Tue, 5 Nov 2013 19:42:25 +0000"/>
                            <attachment id="12612117" name="FLUME-2233.patch" size="8508" author="hshreedharan" created="Tue, 5 Nov 2013 05:41:18 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>356840</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 2 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1pilz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>357130</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>