<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:57:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLUME-2182] Spooling Directory Source will not ingest data completely when a wide character appears at the edge of a buffer</title>
                <link>https://issues.apache.org/jira/browse/FLUME-2182</link>
                <project id="12311321" key="FLUME">Flume</project>
                    <description>&lt;p&gt;the bug is in ResettableFileInputStream.java: int readChar().&lt;br/&gt;
if the last byte of buf is only a partial of a wide character, readChar()  shouldn&apos;t return -1(ResettableFileInputStream.java:186). it &lt;br/&gt;
loses the remanent data  in a file.&lt;/p&gt;

&lt;p&gt;I fix it such as: &lt;br/&gt;
public synchronized int readChar() throws IOException {&lt;br/&gt;
   // if (!buf.hasRemaining()) {&lt;br/&gt;
   if(buf.limit()- buf.position &amp;lt; 10)&lt;/p&gt;
{
      refillBuf();
    }

&lt;p&gt;    int start = buf.position();&lt;br/&gt;
    charBuf.clear();&lt;/p&gt;

&lt;p&gt;    boolean isEndOfInput = false;&lt;br/&gt;
    if (position &amp;gt;= fileSize) &lt;/p&gt;
{
      isEndOfInput = true;
    }

&lt;p&gt;    CoderResult res = decoder.decode(buf, charBuf, isEndOfInput);&lt;br/&gt;
    if (res.isMalformed() || res.isUnmappable()) &lt;/p&gt;
{
      res.throwException();
    }

&lt;p&gt;    int delta = buf.position() - start;&lt;/p&gt;

&lt;p&gt;    charBuf.flip();&lt;br/&gt;
    if (charBuf.hasRemaining()) &lt;/p&gt;
{
      char c = charBuf.get();
      // don&apos;t increment the persisted location if we are in between a
      // surrogate pair, otherwise we may never recover if we seek() to this
      // location!
      incrPosition(delta, !Character.isHighSurrogate(c));
      return c;

    // there may be a partial character in the decoder buffer
    }
&lt;p&gt; else &lt;/p&gt;
{
      incrPosition(delta, false);
      return -1;
    }

&lt;p&gt;  }&lt;/p&gt;

&lt;p&gt;it avoid a partial character, but have new issue. sometime, some lines of a log file have a repeated character.&lt;br/&gt;
eg. &lt;br/&gt;
   original file: 123456&lt;br/&gt;
   sink file:     1233456&lt;/p&gt;</description>
                <environment></environment>
        <key id="12667107">FLUME-2182</key>
            <summary>Spooling Directory Source will not ingest data completely when a wide character appears at the edge of a buffer</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="svenmeys">Sven Meys</assignee>
                                    <reporter username="syntonyliu">syntony liu</reporter>
                        <labels>
                    </labels>
                <created>Thu, 5 Sep 2013 14:01:46 +0000</created>
                <updated>Mon, 29 Sep 2014 22:37:41 +0000</updated>
                            <resolved>Sat, 28 Sep 2013 00:19:28 +0000</resolved>
                                    <version>1.4.0</version>
                                    <fixVersion>1.5.0</fixVersion>
                                    <component>Sinks+Sources</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="13759094" author="syntonyliu" created="Thu, 5 Sep 2013 14:09:49 +0000"  >&lt;p&gt;Do I fix it correctly? &lt;br/&gt;
Why the hdfs sink file have a repeated character in some line?&lt;/p&gt;</comment>
                            <comment id="13759102" author="syntonyliu" created="Thu, 5 Sep 2013 14:19:12 +0000"  >&lt;p&gt;in addition, I modify  decoder . it can&apos;t throw Exception.&lt;br/&gt;
public ResettableFileInputStream(File file, PositionTracker tracker,&lt;br/&gt;
                                   int bufSize, Charset charset)&lt;br/&gt;
      throws IOException &lt;/p&gt;
{

     ......
    this.decoder = charset.newDecoder();
    this.decoder.implOnMalformedInput(CodingErrorAction.REPLACE); // add by me     
    this.decoder.implOnUnmappableCharacter(CodingErrorAction.REPLACE); // add by me     
    ......
  }</comment>
                            <comment id="13779266" author="svenmeys" created="Thu, 26 Sep 2013 21:23:48 +0000"  >&lt;p&gt;I found the same error.&lt;br/&gt;
Happens when the byte buffer reaches it&apos;s end, so only a part of a character is read.&lt;/p&gt;

&lt;p&gt;I also tried to solve it using the method described in the bug report, by ensuring there are at least 32 bytes in the buffer at all times. But I found that somehow, between the the millions of lines parsed, there is one extra line written to the output that contains exactly as many characters as the extra space you allow for the buffer refill.&lt;/p&gt;

&lt;p&gt;To solve this, I commented out the line chan.position(position); in the refilBuff() method.&lt;/p&gt;

&lt;p&gt;However, this may cause a whole series of other problems, which I have no time researching right now.&lt;/p&gt;</comment>
                            <comment id="13779799" author="svenmeys" created="Fri, 27 Sep 2013 09:48:31 +0000"  >&lt;p&gt;Included a workaround that we&apos;re using until a permanent fix is created.&lt;/p&gt;</comment>
                            <comment id="13779993" author="jlord" created="Fri, 27 Sep 2013 14:53:56 +0000"  >&lt;p&gt;I believe this issue is a duplicate of &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-2052&quot; title=&quot;Spooling directory source should be able to replace or ignore malformed characters&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-2052&quot;&gt;&lt;del&gt;FLUME-2052&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13780110" author="svenmeys" created="Fri, 27 Sep 2013 17:25:33 +0000"  >&lt;p&gt;It is related, but not the same.&lt;/p&gt;

&lt;p&gt;In the case of &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-2052&quot; title=&quot;Spooling directory source should be able to replace or ignore malformed characters&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-2052&quot;&gt;&lt;del&gt;FLUME-2052&lt;/del&gt;&lt;/a&gt;, they are dealing with corrupt characters that cause the readCahr method to throw a MalformedException.&lt;/p&gt;

&lt;p&gt;In this specific case no such exceptions are thrown at all. Even when explicitly turning on reporting in the decoder. Instead, the readChar method returns a -1, which denotes end-of-file, and continues to do so in further attempts to read new characters.&lt;/p&gt;

&lt;p&gt;I did some additional investigation. The workaround works as a temporary patch. The fix we proposed here by checking for minimum character width, is also kind-of a hack. But I found the real culprit and a fix that makes the code more robust.&lt;/p&gt;

&lt;p&gt;The culprit: delta. When calling decoder.decode on an incomplete character (eg: two bytes of a three-byte char), the decoder does not ingest the chars, nor advances the position of the byte buffer.&lt;/p&gt;

&lt;p&gt;This results in an empty char buffer, which returns -1 as expected, but also in a delta(number of bytes processed) that is zero. At the end of the method, the filepointer(position) is increased by delta (0 in this case).&lt;/p&gt;

&lt;p&gt;Any following call to readChar will return -1, as the byte buffer did not advance its position and won&apos;t refill.&lt;/p&gt;

&lt;p&gt;Forcing a call to refillBuffers at this point will result in strange behavior as your byte buffer still has the bytes of an incomplete character in it and the file pointer is positioned before that exact same set of bytes.&lt;/p&gt;

&lt;p&gt;The fix: Check if delta is 0. If so, clear the bytebuffer, refill it, continue.&lt;/p&gt;

&lt;p&gt;Here&apos;s the fixed function (note, this might not fix &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-2052&quot; title=&quot;Spooling directory source should be able to replace or ignore malformed characters&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-2052&quot;&gt;&lt;del&gt;FLUME-2052&lt;/del&gt;&lt;/a&gt;):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; readChar() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!buf.hasRemaining()) {
            refillBuf();
        }

        &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; start = buf.position();
        charBuf.clear();

        &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isEndOfInput = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (position &amp;gt;= fileSize) {
            isEndOfInput = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
        }

        CoderResult res = decoder.decode(buf, charBuf, isEndOfInput);
        &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; delta = buf.position() - start;

        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(delta == 0 &amp;amp;&amp;amp; buf.hasRemaining()) {
            logger.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Incomplete character detected! Reloading buffer&quot;&lt;/span&gt;);
            buf.clear();
            buf.flip();
            refillBuf();

            start = buf.position();
            res = decoder.decode(buf, charBuf, isEndOfInput);
            delta = buf.position() - start;
        }

        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (res.isMalformed() || res.isUnmappable()) {
            res.throwException();
        }

        charBuf.flip();
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (charBuf.hasRemaining()) {
            &lt;span class=&quot;code-object&quot;&gt;char&lt;/span&gt; c = charBuf.get();
            &lt;span class=&quot;code-comment&quot;&gt;// don&apos;t increment the persisted location &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; we are in between a
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// surrogate pair, otherwise we may never recover &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; we seek() to &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// location!
&lt;/span&gt;            incrPosition(delta, !&lt;span class=&quot;code-object&quot;&gt;Character&lt;/span&gt;.isHighSurrogate(c));
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; c;

            &lt;span class=&quot;code-comment&quot;&gt;// there may be a partial character in the decoder buffer
&lt;/span&gt;        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
            incrPosition(delta, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; -1;
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13780141" author="svenmeys" created="Fri, 27 Sep 2013 17:42:26 +0000"  >&lt;p&gt;An other, more defensive way to fix this would be to do the following:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;// Add &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;variable
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; maxCharWidth;

&lt;span class=&quot;code-comment&quot;&gt;// Add &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; to the constructor
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.maxCharWidth = (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;)charset.newEncoder().maxBytesPerChar();


&lt;span class=&quot;code-comment&quot;&gt;// Replace &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; in the readChar() method
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(!buf.hasRemaining) {
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//    refillBuf();
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//}
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (buf.remaining() &amp;lt; maxCharWidth) {
   buf.clear();
   buf.flip();
   refillBuf();
}

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13780344" author="mpercy" created="Fri, 27 Sep 2013 20:32:03 +0000"  >&lt;p&gt;Hey Sven, thanks for reporting this! Your patch looks good.&lt;/p&gt;

&lt;p&gt;Can you please add a unit test for this that fails before your patch and passes with your patch?&lt;/p&gt;</comment>
                            <comment id="13780354" author="mpercy" created="Fri, 27 Sep 2013 20:40:24 +0000"  >&lt;p&gt;Also: please add a comment above the &quot;if (buf.remaining() &amp;lt; maxCharWidth) {&quot; block with something to the effect of:&lt;/p&gt;

&lt;p&gt;// The decoder can have issues with partial multi-byte characters,&lt;br/&gt;
// so ensure that we maintain at least maxCharWidth characters in&lt;br/&gt;
// the buffer up until EOF.&lt;/p&gt;</comment>
                            <comment id="13780552" author="svenmeys" created="Fri, 27 Sep 2013 23:14:57 +0000"  >&lt;p&gt;There ya go. Fix submitted, now with unit test(for UTF-8) and comments.&lt;/p&gt;</comment>
                            <comment id="13780594" author="mpercy" created="Sat, 28 Sep 2013 00:05:48 +0000"  >&lt;p&gt;+1&lt;/p&gt;

&lt;p&gt;Thanks Sven, looks good! I&apos;m running all the unit tests now and then I will commit this.&lt;/p&gt;</comment>
                            <comment id="13780612" author="mpercy" created="Sat, 28 Sep 2013 00:19:28 +0000"  >&lt;p&gt;I just pushed this to trunk and flume-1.5 branches.&lt;/p&gt;

&lt;p&gt;Removing the relnote... I haven&apos;t tried the workaround deserializer but this patch appears to fix the core issue.&lt;/p&gt;</comment>
                            <comment id="13780638" author="hudson" created="Sat, 28 Sep 2013 01:29:21 +0000"  >&lt;p&gt;FAILURE: Integrated in flume-trunk #502 (See &lt;a href=&quot;https://builds.apache.org/job/flume-trunk/502/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/flume-trunk/502/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-2182&quot; title=&quot;Spooling Directory Source will not ingest data completely when a wide character appears at the edge of a buffer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-2182&quot;&gt;&lt;del&gt;FLUME-2182&lt;/del&gt;&lt;/a&gt;. Spooling Directory Source will not ingest data completely when a wide character appears at the edge of a buffer (mpercy: &lt;a href=&quot;http://git-wip-us.apache.org/repos/asf/flume/repo?p=flume.git&amp;amp;a=commit&amp;amp;h=ffa706429186df2cf8ad04fd9dcba37b6a35d7f1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://git-wip-us.apache.org/repos/asf/flume/repo?p=flume.git&amp;amp;a=commit&amp;amp;h=ffa706429186df2cf8ad04fd9dcba37b6a35d7f1&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;flume-ng-core/src/test/java/org/apache/flume/serialization/TestResettableFileInputStream.java&lt;/li&gt;
	&lt;li&gt;flume-ng-core/src/main/java/org/apache/flume/serialization/ResettableFileInputStream.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="12674083">FLUME-2215</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12680332">FLUME-2241</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12680332">FLUME-2241</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12605600" name="Fix_for_FLUME-2182.patch" size="4023" author="svenmeys" created="Fri, 27 Sep 2013 23:14:57 +0000"/>
                            <attachment id="12605422" name="ModifiedLineDeserializer.java" size="7978" author="svenmeys" created="Fri, 27 Sep 2013 09:46:58 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>347044</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 8 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1nudj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>347343</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>