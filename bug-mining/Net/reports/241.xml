<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 20:45:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[NET-584] Error when using org.apache.commons.net.ftp.FTPClient setControlKeepAliveTimeout</title>
                <link>https://issues.apache.org/jira/browse/NET-584</link>
                <project id="12310487" key="NET">Commons Net</project>
                    <description>&lt;p&gt;I have a question about using library commons-net-3.4.jar&lt;br/&gt;
Question is about org.apache.commons.net.ftp.FTPClient method setControlKeepAliveTimeout.&lt;/p&gt;

&lt;p&gt;Read about using it on:&lt;br/&gt;
&lt;a href=&quot;https://commons.apache.org/proper/commons-net/apidocs/org/apache/commons/net/ftp/FTPClient.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://commons.apache.org/proper/commons-net/apidocs/org/apache/commons/net/ftp/FTPClient.html&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;When I use it in my code I get this error:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.net.SocketTimeoutException: Read timed out
	at java.net.SocketInputStream.socketRead0(Native Method)
	at java.net.SocketInputStream.read(SocketInputStream.java:163)
	at java.net.SocketInputStream.read(SocketInputStream.java:133)
	at sun.nio.cs.StreamDecoder.readBytes(StreamDecoder.java:322)
	at sun.nio.cs.StreamDecoder.implRead(StreamDecoder.java:364)
	at sun.nio.cs.StreamDecoder.read(StreamDecoder.java:210)
	at java.io.InputStreamReader.read(InputStreamReader.java:205)
	at java.io.BufferedReader.fill(BufferedReader.java:165)
	at java.io.BufferedReader.read(BufferedReader.java:186)
	at org.apache.commons.net.io.CRLFLineReader.readLine(CRLFLineReader.java:58)
	at org.apache.commons.net.ftp.FTP.__getReply(FTP.java:313)
	at org.apache.commons.net.ftp.FTP.__getReplyNoReport(FTP.java:303)
	at org.apache.commons.net.ftp.FTPClient$CSL.cleanUp(FTPClient.java:3838)
	at org.apache.commons.net.ftp.FTPClient._storeFile(FTPClient.java:695)
	at org.apache.commons.net.ftp.FTPClient.__storeFile(FTPClient.java:643)
	at org.apache.commons.net.ftp.FTPClient.storeFile(FTPClient.java:2033)
	at ru.mdm.File.Transfer.FTP.PutRemoteFileBinary(FTP.java:192)
	at ru.mdm.File.Transfer.TimeLimit.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.Protocol.PutRemoteFileBinaryThread.actionsToExecute(PutRemoteFileBinaryThread.java:23)
	at ru.mdm.File.Transfer.TimeLimit.OperationThread.run(OperationThread.java:60)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Without enabling this option all works fine.&lt;/p&gt;



&lt;p&gt;Here is the code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt; ru.mdm.File.Transfer;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; bin.ru.osa.common.utils.*;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.util.List;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.io.*;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; com.ibm.broker.javacompute.MbJavaComputeNode;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; com.ibm.broker.plugin.*;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.commons.net.ftp.*;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.commons.net.*;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; ru.mdm.File.Transfer.Options.OptionsXMLProcessor;

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;FTP &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; Protocol 
{
	
	FTPClient client = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FTPClient();
	
	OptionsXMLProcessor optionsXMLProcessor;
	
	
	&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;   st;
	&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; LastMessage = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;();
	
	&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;   ignoreErrors = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
	
	
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; FTP() 
	{
		&lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;();		
	}

	
	&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void finalize() { disconnect(); }

	
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void connect(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; CntName, 
						&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; Host, 
						&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; Port, 
						&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; L, 
						&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; P)  &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception
	{
	  &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;
	  {		
		client.setControlKeepAliveTimeout(300);
	    client.connect(Host);
	    client.login(L, P);
	    CheckState();	    
	  }
	  &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt;(Exception e)
	  {
	     LastMessage=client.getReplyString();	     	     
	     &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(LastMessage == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) LastMessage = e.getMessage();
	     
	     e.printStackTrace();
	     
		 &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; e;
	  }
	}	
	
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void disconnect()
	{
		&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;
		{
			&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(client.isConnected())
			{
				client.logout();  
				client.disconnect();
			}
		}
		&lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt;(Exception e)
		{			
			e.printStackTrace();
		}
	}	
	
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void chmod(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; RemoteFile, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; Rights)  &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception
	{
		client.sendSiteCommand(&lt;span class=&quot;code-quote&quot;&gt;&quot;chmod &quot;&lt;/span&gt;+RemoteFile+&lt;span class=&quot;code-quote&quot;&gt;&quot; &quot;&lt;/span&gt;+Rights);
		CheckState();
	}
	
	
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void lsMB(MbElement InputDir,MbElement filelist)   &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception, MbException
	{
		MbElement xfile;		
		
		&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (FTPFile file : client.listFiles((&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;)InputDir.evaluateXPath(&lt;span class=&quot;code-quote&quot;&gt;&quot;string(SOURCE_PATH)&quot;&lt;/span&gt;)))
        {
          &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(!file.isFile()) &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;; &lt;span class=&quot;code-comment&quot;&gt;//-- No sub-dirs, No Symlinks !	                      
&lt;/span&gt;          
          xfile=filelist.createElementAsLastChild(MbElement.TYPE_NAME, &lt;span class=&quot;code-quote&quot;&gt;&quot;File&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
          xfile.createElementAsLastChild(MbElement.TYPE_NAME, &lt;span class=&quot;code-quote&quot;&gt;&quot;FileName&quot;&lt;/span&gt;, file.getName());
          xfile.createElementAsLastChild(MbElement.TYPE_NAME, &lt;span class=&quot;code-quote&quot;&gt;&quot;FileSize&quot;&lt;/span&gt;, file.getSize());
          xfile.createElementAsLastChild(MbElement.TYPE_NAME, &lt;span class=&quot;code-quote&quot;&gt;&quot;SourcePath&quot;&lt;/span&gt;, (&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;)InputDir.evaluateXPath(&lt;span class=&quot;code-quote&quot;&gt;&quot;string(SOURCE_PATH)&quot;&lt;/span&gt;));
          xfile.createElementAsLastChild(MbElement.TYPE_NAME, &lt;span class=&quot;code-quote&quot;&gt;&quot;SourceGateway&quot;&lt;/span&gt;, (&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;)InputDir.evaluateXPath(&lt;span class=&quot;code-quote&quot;&gt;&quot;string(GATEWAY_NAME)&quot;&lt;/span&gt;));
        }		
	}
	
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void mkdir(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; RemotePath)   &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception
	{
	   client.makeDirectory(RemotePath);
	   CheckState();
	}

	
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void chdir(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; RemotePath)   &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception
	{
		client.changeWorkingDirectory(RemotePath);	
		CheckState();
	}


	
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void delete(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; RemotePath)   &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception
	{
		client.deleteFile(RemotePath);	
		CheckState();
	}
	
	
		
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void rename(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; RemoteFileSrc, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; RemoteFileDst)    &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception
	{
	     client.rename(RemoteFileSrc, RemoteFileDst);
	     CheckState();
	}
	
		
   &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void GetRemoteFileBinary(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; RemoteFile, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; LocalFile)     &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception
   {
	   client.enterLocalPassiveMode();
       client.setFileType(FTPClient.BINARY_FILE_TYPE);
       client.retrieveFile(RemoteFile, 
     		               &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FileOutputStream(LocalFile));
       
       
       CheckState();
    }

  		
   &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void PutRemoteFileBinary(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; LocalFile, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; RemoteFile)      &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception
   {
       client.enterLocalPassiveMode();
       client.setFileType(FTPClient.BINARY_FILE_TYPE);
       client.storeFile(RemoteFile, 
    		            &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FileInputStream(LocalFile));	
       CheckState();
   }   
   
   
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void ignoreErrors(&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; x)  { ignoreErrors=x;	}
   
	
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isOK()  { &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; st;	}

	
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isConnected()	
	{
		&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; answer=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
		&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
			answer = client.sendNoOp();
		} &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
			&lt;span class=&quot;code-comment&quot;&gt;// TODO Auto-generated &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; block
&lt;/span&gt;			e.printStackTrace();
		}		
		st = answer;
		&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; answer;		
       
	}
	
	
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; LastMessage() {	&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; LastMessage;	};
	
	
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void CheckState(&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; state) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception
	{
	    &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; reply = client.getReplyCode();
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(FTPReply.isPositiveCompletion(reply))    st=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
        &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;                                        st=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
		
        LastMessage=client.getReplyString();	
		
		&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(!st &amp;amp;&amp;amp; !ignoreErrors)	
			&lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Exception(LastMessage);
	}
	
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void CheckState() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception
	{
	    &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; reply = client.getReplyCode();
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(FTPReply.isPositiveCompletion(reply))    st=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
        &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;                                        st=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
		
        LastMessage=client.getReplyString();	
		
		&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(!st &amp;amp;&amp;amp; !ignoreErrors)	
			&lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Exception(LastMessage);
	}
	
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void attachOptions(OptionsXMLProcessor optionsXMLProcessor) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception 
	{
		&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.optionsXMLProcessor = optionsXMLProcessor;
	}


	
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; getIP() {
		
		&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &quot;&quot;;
	}
	
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isIgnoreErrors() 
	{		
		&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; ignoreErrors;
	}
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12922641">NET-584</key>
            <summary>Error when using org.apache.commons.net.ftp.FTPClient setControlKeepAliveTimeout</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="kazantsevas">Kazantsev Andrey Sergeevich</reporter>
                        <labels>
                    </labels>
                <created>Thu, 17 Dec 2015 09:20:02 +0000</created>
                <updated>Thu, 6 Aug 2020 12:27:25 +0000</updated>
                            <resolved>Mon, 20 Mar 2017 21:21:25 +0000</resolved>
                                                    <fixVersion>3.7</fixVersion>
                                    <component>FTP</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15905038" author="nmanley" created="Fri, 10 Mar 2017 13:06:35 +0000"  >&lt;p&gt;I am having the same issue with version 3.5. It only happens on large file uploads (&amp;gt;1GB). I get the same error SocketTimeoutException: Read timed out. Removing the call to &lt;tt&gt;setControlKeepAliveTimeout&lt;/tt&gt; was able to resolve the issue. I don&apos;t know how that will affect the control connection though and whether it may timeout at another time without the keep-alive. I was not able to reproduce the error with version 3.3.&lt;/p&gt;</comment>
                            <comment id="15905749" author="sebb@apache.org" created="Fri, 10 Mar 2017 21:47:14 +0000"  >&lt;p&gt;The method only affects the behaviour with certain retrieve/store methods (as per the Javadoc).&lt;br/&gt;
If it does not help, then don&apos;t use it - not all FTP servers support control connection communication whilst a transfer is in progress.&lt;/p&gt;

&lt;p&gt;It looks as though the code fails when it is trying to retrieve the outstanding NOOP responses after the data transfer has completed.&lt;/p&gt;

&lt;p&gt;Maybe the code should ignore SocketTimeoutException at this point in case the responses were lost.&lt;br/&gt;
However I don&apos;t understand why this worked in 3.3 but does not in 3.5.&lt;/p&gt;

&lt;p&gt;I can post a SNAPSHOT build with this change; it would be very helpful to know if this fixes the problem&lt;/p&gt;</comment>
                            <comment id="15905899" author="sebb@apache.org" created="Fri, 10 Mar 2017 23:59:34 +0000"  >&lt;p&gt;SNAPSHOT commons-net-3.7-20170310.235330-8 posted to the Apache snapshot repo in case you want to try.&lt;br/&gt;
This should only be used for testing. Do not use on a production system. etc.&lt;/p&gt;</comment>
                            <comment id="15905925" author="nmanley" created="Sat, 11 Mar 2017 00:25:41 +0000"  >&lt;p&gt;Hey, Sebb. Thank you for the prompt response. I had some time to look at this today while I was at work. I dug into some of the code to better understand what it was doing and I think I misunderstood what the controlKeepAlive was doing.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The method only affects the behaviour with certain retrieve/store methods (as per the Javadoc).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I didn&apos;t realize that at first. I thought it was something that happens continuously. As in, a NoOp would get sent every X seconds from the time I connect to the time I disconnect.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;If it does not help, then don&apos;t use it - not all FTP servers support control connection communication whilst a transfer is in progress.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I didn&apos;t know this either. I was under the impression that if I had a long upload, I had to do something to keep the control connection alive or it would time out. Removing the setControlKeepAliveTimeout had the opposite effect I was expecting. I thought for sure that without it, the control connection would timeout during a long upload. That doesn&apos;t seem to be the case though.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;However I don&apos;t understand why this worked in 3.3 but does not in 3.5.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Could have just been an issue of me not uploading a large enough file to trigger it. Don&apos;t take that to mean the issue doesn&apos;t exist in 3.3, just that I didn&apos;t happen to see it trigger when I was testing out different versions.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Maybe the code should ignore SocketTimeoutException at this point in case the responses were lost.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Maybe. But it looks like the exception is being triggered when it&apos;s reading the reply. Prior to that, the &lt;tt&gt;CSL&lt;/tt&gt; class is trying to clean-up any outstanding NoOps. I think that&apos;s the part that might be exhausting the input stream and it maybe eating the transfer reply along the way. I don&apos;t know if ignoring the exception outright is the correct behavior.&lt;/p&gt;

&lt;p&gt;After a bit more research and understanding, I&apos;m willing to say that this probably isn&apos;t a bug in Commons Net; just a misuse on my part. I might suggest that some of the documentation on &lt;tt&gt;controlKeepAliveTimeout&lt;/tt&gt; that exists on the &lt;tt&gt;FTPClient&lt;/tt&gt; class also be put into the setter. That would make it more discoverable. Also, do you think it is worth adding to the javadoc what you said about not all FTP servers supporting simultaneous writing to the control/data socket? In some senses the javadoc sounds like it&apos;s saying &quot;it&apos;s a good idea to use this&quot; (a best practice to follow) rather than &quot;use this if you have problems&quot; (a workaround).&lt;/p&gt;

&lt;p&gt;The original reporter seems to have had a similar misunderstanding as did the users on &lt;a href=&quot;https://issues.apache.org/jira/browse/NET-486&quot; title=&quot;FtpClient 3.0.1 - SocketTimeoutException - Read Timed out&quot; class=&quot;issue-link&quot; data-issue-key=&quot;NET-486&quot;&gt;&lt;del&gt;NET-486&lt;/del&gt;&lt;/a&gt;. I don&apos;t know how much work it would be to have the code handle this a bit nicer (either not throw an exception, or throw something nicer than &quot;read timed out&quot;). But if that proves to be too much of a hassle, then re-wording the javadocs would go a long way. Just something that would signify it as a workaround for particular users and not a best practice that someone should be doing.&lt;/p&gt;</comment>
                            <comment id="15906152" author="sebb@apache.org" created="Sat, 11 Mar 2017 10:05:20 +0000"  >&lt;p&gt;The NOOPs are only (potentially) needed for long running data transfers which pass through a router.&lt;br/&gt;
They should not be needed for talking directly to an FTP server, because the server knows which control channels are associated with which data channels.&lt;br/&gt;
(If it does not, it is badly broken!)&lt;/p&gt;

&lt;p&gt;Some routers are clever enough to do the same; some just see an idle channel and assume it has been abandoned. These latter need NOOPs to try and prevent disconnection.&lt;/p&gt;

&lt;p&gt;FTPClient only sends the NOOPs if the wait time is &amp;gt; 0 and the command is one of the retrieve/store operations that don&apos;t involve application interaction.&lt;/p&gt;

&lt;p&gt;In other cases where the control channel may be idle for long periods, it is up to the app to send NOOPs.&lt;/p&gt;

&lt;p&gt;FTP servers that can support parallel control channel traffic will respond to the NOOPs during the data transfer.&lt;br/&gt;
If not, then the replies will likely be sent when the transfer completes and the server returns to processing the control channel.&lt;br/&gt;
FTPClient keeps a count of the number of unanswered NOOPs and tries to drain these at the end of the transfer.&lt;br/&gt;
If any requests or responses got lost, then of course we get a timeout, which is what I think we are seeing.&lt;br/&gt;
I guess the longer the data transfer, the more likely it is that they are lost. This may explain the behaviour you are seeing with bigger files.&lt;/p&gt;

&lt;p&gt;Note: the SNAPSHOT code now assumes that a timeout during cleanup means that there are no more replies left and does not throw an exception (it writes to stderr instead).&lt;/p&gt;

&lt;p&gt;I think it is correct to ignore the timeout here; however writing to stderr is no use for production code.&lt;br/&gt;
Need to either ignore the timeout or find a way to let the app know (or a way for the app to find out).&lt;/p&gt;

&lt;p&gt;Meanwhile it would be very helpful if you were able to try the updated code.&lt;/p&gt;</comment>
                            <comment id="15927833" author="nmanley" created="Thu, 16 Mar 2017 10:56:22 +0000"  >&lt;p&gt;I tried the snapshot &lt;tt&gt;commons-net-3.7-20170312.153354-15.jar&lt;/tt&gt;. It times out on completePendingCommand.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;NET-584: notAcked=18
NET-584: ignoring Read timed out
java.net.SocketTimeoutException: Read timed out
        at java.net.SocketInputStream.socketRead0(Native Method)
        at java.net.SocketInputStream.socketRead(SocketInputStream.java:116)
        at java.net.SocketInputStream.read(SocketInputStream.java:171)
        at java.net.SocketInputStream.read(SocketInputStream.java:141)
        at sun.nio.cs.StreamDecoder.readBytes(StreamDecoder.java:284)
        at sun.nio.cs.StreamDecoder.implRead(StreamDecoder.java:326)
        at sun.nio.cs.StreamDecoder.read(StreamDecoder.java:178)
        at java.io.InputStreamReader.read(InputStreamReader.java:184)
        at java.io.BufferedReader.fill(BufferedReader.java:161)
        at java.io.BufferedReader.read(BufferedReader.java:182)
        at org.apache.commons.net.io.CRLFLineReader.readLine(CRLFLineReader.java:58)
        at org.apache.commons.net.ftp.FTP.__getReply(FTP.java:321)
        at org.apache.commons.net.ftp.FTP.__getReply(FTP.java:300)
        at org.apache.commons.net.ftp.FTP.getReply(FTP.java:732)
        at org.apache.commons.net.ftp.FTPClient.completePendingCommand(FTPClient.java:1859)
        at org.apache.commons.net.ftp.FTPClient._storeFile(FTPClient.java:700)
        at org.apache.commons.net.ftp.FTPClient.__storeFile(FTPClient.java:644)
        at org.apache.commons.net.ftp.FTPClient.storeFile(FTPClient.java:2036)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15927904" author="sebb@apache.org" created="Thu, 16 Mar 2017 12:15:53 +0000"  >&lt;p&gt;Thanks for testing, that&apos;s very useful.&lt;/p&gt;

&lt;p&gt;I&apos;ve just realised that there&apos;s a problem with the code:&lt;/p&gt;

&lt;p&gt;If any of the NOOP responses are dropped, FTPClient can consume the final response from the server.&lt;br/&gt;
This will result in the behaviour you are seeing.&lt;/p&gt;

&lt;p&gt;The code needs to check if the reply is for a NOOP.&lt;br/&gt;
If not, it needs to ensure that the reply is retained for the call to completePendingCommand()&lt;/p&gt;

&lt;p&gt;I think that should be relatively straightforward, because NOOP responses should have a 200 code, and the get/put commands use something different, e.g. 226, 250.&lt;/p&gt;</comment>
                            <comment id="15927974" author="sebb@apache.org" created="Thu, 16 Mar 2017 13:04:55 +0000"  >&lt;p&gt;Servers that don&apos;t send NOOP replies whilst a transfer is in progress seem to send the get/put completion response before the NOOP responses.&lt;br/&gt;
That makes sense, since presumably the server does not even see the NOOP until the transfer completes.&lt;br/&gt;
So long as no responses are lost, it does not matter which order they replies are processed by FTPClient, because it only looks for a successful code, not a particular success code.&lt;/p&gt;

&lt;p&gt;That is probably why it works for shorter files.&lt;/p&gt;</comment>
                            <comment id="15928102" author="sebb@apache.org" created="Thu, 16 Mar 2017 14:04:04 +0000"  >&lt;p&gt;Added a fix to fetch the command reply before the delayed NOOP replies.&lt;/p&gt;

&lt;p&gt;URL: &lt;a href=&quot;http://svn.apache.org/viewvc?rev=1787188&amp;amp;view=rev&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?rev=1787188&amp;amp;view=rev&lt;/a&gt;&lt;br/&gt;
Log:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/NET-584&quot; title=&quot;Error when using org.apache.commons.net.ftp.FTPClient setControlKeepAliveTimeout&quot; class=&quot;issue-link&quot; data-issue-key=&quot;NET-584&quot;&gt;&lt;del&gt;NET-584&lt;/del&gt;&lt;/a&gt; Error with org.apache.commons.net.ftp.FTPClient setControlKeepAliveTimeout&lt;br/&gt;
Look for command completion first&lt;/p&gt;

&lt;p&gt;Modified:&lt;br/&gt;
    commons/proper/net/trunk/src/main/java/org/apache/commons/net/ftp/FTPClient.java&lt;/p&gt;</comment>
                            <comment id="15930872" author="nmanley" created="Fri, 17 Mar 2017 23:06:47 +0000"  >&lt;p&gt;Using &lt;tt&gt;commons-net-3.7-20170316.143309-17.jar&lt;/tt&gt;, I received the following output.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;NET-584: notAcked=16
NET-584: ignoring Read timed out
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The process then exited successfully. No exception thrown. I&apos;m very satisfied with this solution. Even if someone uses setControlKeepAlive unnecessarily, things will continue to just work. Awesome job, Sebb! Thank you very much for your help. I&apos;m not the original reporter on this ticket, but since it&apos;s over a year old, I don&apos;t think the original reporter will be around to verify the solution. I think you would be okay to call it resolved though.&lt;/p&gt;</comment>
                            <comment id="15933596" author="sebb@apache.org" created="Mon, 20 Mar 2017 21:21:25 +0000"  >&lt;p&gt;Thanks for confirming the fix has worked and the help in testing the issue.&lt;/p&gt;

&lt;p&gt;URL: &lt;a href=&quot;http://svn.apache.org/viewvc?rev=1787849&amp;amp;view=rev&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?rev=1787849&amp;amp;view=rev&lt;/a&gt;&lt;br/&gt;
Log:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/NET-584&quot; title=&quot;Error when using org.apache.commons.net.ftp.FTPClient setControlKeepAliveTimeout&quot; class=&quot;issue-link&quot; data-issue-key=&quot;NET-584&quot;&gt;&lt;del&gt;NET-584&lt;/del&gt;&lt;/a&gt; Error when using org.apache.commons.net.ftp.FTPClient setControlKeepAliveTimeout&lt;/p&gt;

&lt;p&gt;Modified:&lt;br/&gt;
    commons/proper/net/trunk/src/changes/changes.xml&lt;br/&gt;
    commons/proper/net/trunk/src/main/java/org/apache/commons/net/ftp/FTPClient.java&lt;/p&gt;
</comment>
                            <comment id="16018433" author="raikking" created="Sat, 20 May 2017 12:35:31 +0000"  >&lt;p&gt;I have found related problem like this.&lt;br/&gt;
When I use ftp client transfer big data file, I start a new thread to send pwd or noop command periodically to keep control connection alive.&lt;br/&gt;
But  I found the vsftpd server can not receive pwd or noop cmd until data transfer finished.&lt;br/&gt;
I wonder why ftp server can not support control connection communication whilst a transfer is in progress since there are control and data connection at the same time?&lt;br/&gt;
How to check whether this ftp server can support  control connection communication whilst a transfer is in progress?&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 26 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2q0wf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>