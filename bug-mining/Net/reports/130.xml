<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 20:44:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[NET-326] A KeyManager is required when the protection level is set to &apos;P&apos; with FTPSClient on active mode</title>
                <link>https://issues.apache.org/jira/browse/NET-326</link>
                <project id="12310487" key="NET">Commons Net</project>
                    <description>&lt;p&gt;Using a simple FTPS client that list a directory, when execPROT(&quot;P&quot;) is set and the active mode is on, the following exception is thrown :&lt;/p&gt;

&lt;p&gt;javax.net.ssl.SSLException: No available certificate or key corresponds to the SSL cipher suites which are enabled.&lt;br/&gt;
	at com.sun.net.ssl.internal.ssl.SSLServerSocketImpl.checkEnabledSuites(SSLServerSocketImpl.java:303)&lt;br/&gt;
	at com.sun.net.ssl.internal.ssl.SSLServerSocketImpl.accept(SSLServerSocketImpl.java:253)&lt;br/&gt;
	at org.apache.commons.net.ftp.FTPClient.&lt;em&gt;openDataConnection&lt;/em&gt;(FTPClient.java:489)&lt;br/&gt;
	at org.apache.commons.net.ftp.FTPSClient.&lt;em&gt;openDataConnection&lt;/em&gt;(FTPSClient.java:494)&lt;br/&gt;
	at org.apache.commons.net.ftp.FTPClient.listNames(FTPClient.java:1950)&lt;br/&gt;
	at org.apache.commons.net.ftp.FTPClient.listNames(FTPClient.java:1996)&lt;br/&gt;
	at fr.enovacom.eai.actions.dynamiques.protocole.ftp.FTPGet.testFTPS(FTPGet.java:379)&lt;br/&gt;
	at fr.enovacom.eai.actions.dynamiques.protocole.ftp.FTPGet.main(FTPGet.java:401)&lt;/p&gt;

&lt;p&gt;This doesn&apos;t occur on passive mode.&lt;br/&gt;
The only way to make it work is to set a keyManager although there is no need for a client authentication.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Windows XP profesional service pack 2, Java Java 1.6.0_12-b04 &lt;/p&gt;</environment>
        <key id="12466192">NET-326</key>
            <summary>A KeyManager is required when the protection level is set to &apos;P&apos; with FTPSClient on active mode</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="tdudouit">Terence Dudouit</reporter>
                        <labels>
                    </labels>
                <created>Fri, 4 Jun 2010 16:03:08 +0000</created>
                <updated>Sat, 4 Jun 2011 19:26:33 +0000</updated>
                            <resolved>Mon, 21 Mar 2011 02:58:06 +0000</resolved>
                                    <version>2.0</version>
                                    <fixVersion>3.0</fixVersion>
                                    <component>FTP</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="12896145" author="elbeau" created="Fri, 6 Aug 2010 20:14:27 +0000"  >&lt;p&gt;This is a pretty fatal flaw for me to be able to use this component in my product.&lt;/p&gt;

&lt;p&gt;Terence is absolutely right, it works in passive mode, but throws the exception in active mode.  Active or Passive should not matter.&lt;/p&gt;</comment>
                            <comment id="13005100" author="bogdro" created="Thu, 10 Mar 2011 15:16:46 +0000"  >&lt;p&gt;Terence, you didn&apos;t show us:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;your code&lt;/li&gt;
	&lt;li&gt;the way you&apos;re running your code&lt;/li&gt;
	&lt;li&gt;the server&apos;s configuration.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Since you&apos;re saying that a KeyManager is required, I&apos;m guessing that the FTP server connecting to you in active mode as a &quot;client&quot; requires you to provide your certificate/key. Since there&apos;s no default certificate, the connection fails. If this is true, then to reproduce this (if anyone&apos;s interested):&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;install vsftpd (the easiest, I guess) and set in the config file:
	&lt;ul&gt;
		&lt;li&gt;require_ssl_reuse=no&lt;/li&gt;
		&lt;li&gt;ssl_enable=yes&lt;/li&gt;
		&lt;li&gt;ssl_sslv3=yes&lt;/li&gt;
		&lt;li&gt;ssl_tlsv1=yes&lt;/li&gt;
		&lt;li&gt;rsa_cert_file=/path/to/your_certificate_and_key_file&lt;/li&gt;
		&lt;li&gt;ssl_request_cert=yes&lt;/li&gt;
		&lt;li&gt;require_cert=yes&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;run the following code:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;FTPSClient c = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FTPSClient ();
c.connect (&lt;span class=&quot;code-quote&quot;&gt;&quot;127.0.0.1&quot;&lt;/span&gt;, 21);
c.enterLocalActiveMode();
&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println (c.getReplyString());
c.login (&lt;span class=&quot;code-quote&quot;&gt;&quot;login&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;password&quot;&lt;/span&gt;);

&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println (c.getReplyString());
c.execPROT (&lt;span class=&quot;code-quote&quot;&gt;&quot;P&quot;&lt;/span&gt;);
&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println (c.getReplyString());
&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] names = c.listNames();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Now, to the point: for this to work automatically, the FTPSClient class would have to have all the possible key/certificates. Because of the number of these, this is impossible to have. The solution is the FTPSClient constructor with the SSLContext parameter. A quick search on the Web (with the errors as the search term) made me produce the following code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; X509TrustManager s_x509TrustManager;
&lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; {
	s_x509TrustManager = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; X509TrustManager() {
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; java.security.cert.X509Certificate[] getAcceptedIssuers() {
		&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; java.security.cert.X509Certificate[] {}; }
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isClientTrusted(java.security.cert.X509Certificate[] chain) { &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;; }
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isServerTrusted(java.security.cert.X509Certificate[] chain) { &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;; }
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void checkServerTrusted(java.security.cert.X509Certificate[] certificates, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; authType)
	{}
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void checkClientTrusted(java.security.cert.X509Certificate[] certificates, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; authType) {}
	};
}

&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void testFTPS () &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception
{
	SSLContext ctx;
	KeyManagerFactory kmf;
	KeyStore ks;
	&lt;span class=&quot;code-object&quot;&gt;char&lt;/span&gt;[] passphrase = &lt;span class=&quot;code-quote&quot;&gt;&quot;aaaaaa&quot;&lt;/span&gt;.toCharArray();

	ctx = SSLContext.getInstance(&lt;span class=&quot;code-quote&quot;&gt;&quot;TLS&quot;&lt;/span&gt;);
	kmf = KeyManagerFactory.getInstance(&lt;span class=&quot;code-quote&quot;&gt;&quot;SunX509&quot;&lt;/span&gt;);
	ks = KeyStore.getInstance(&lt;span class=&quot;code-quote&quot;&gt;&quot;JKS&quot;&lt;/span&gt;);

	ks.load(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FileInputStream(&lt;span class=&quot;code-quote&quot;&gt;&quot;keystore&quot;&lt;/span&gt;), passphrase);

	kmf.init(ks, passphrase);
	ctx.init(kmf.getKeyManagers(), &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; X509TrustManager[] {s_x509TrustManager}, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);

	FTPSClient c = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FTPSClient (ctx);
	c.connect (&lt;span class=&quot;code-quote&quot;&gt;&quot;127.0.0.1&quot;&lt;/span&gt;, 21);
	c.enterLocalActiveMode();
	&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println (c.getReplyString());
	c.login (&lt;span class=&quot;code-quote&quot;&gt;&quot;login&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;password&quot;&lt;/span&gt;);

	&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println (c.getReplyString());
	c.execPROT (&lt;span class=&quot;code-quote&quot;&gt;&quot;P&quot;&lt;/span&gt;);
	&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println (c.getReplyString());
	&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] names = c.listNames();
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This code &lt;b&gt;works&lt;/b&gt; when connecting to &lt;b&gt;the same&lt;/b&gt; vsftpd server as before (when the previous code caused an exception). To run this code, add the following command-line options to &quot;java&quot; (don&apos;t know if still required actually, but won&apos;t hurt):&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;-Djavax.net.ssl.trustStore=truststore&lt;/li&gt;
	&lt;li&gt;-Djavax.net.ssl.trustStorePassword=aaaaaa&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Please read the &lt;a href=&quot;http://download.oracle.com/javase/6/docs/technotes/guides/security/jsse/JSSERefGuide.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;JSSE Reference Guide&lt;/a&gt;, especially the &quot;Code Examples&quot; section. That&apos;s where I got most of the information I needed (especially about creating the keystores in files: &quot;keystore&quot; used by the code, and &quot;truststore&quot; used on the command-line). I think that only a certificate for &quot;localhost&quot; is required, but just in case, I&apos;ve also added a certificate for my hostname in the keystores.&lt;/p&gt;

&lt;p&gt;Furthermore, if there&apos;s a KeyManager missing, you can always install your own with the FTPSClient.setKeyManager method.&lt;/p&gt;</comment>
                            <comment id="13005151" author="sebb@apache.org" created="Thu, 10 Mar 2011 16:48:15 +0000"  >&lt;p&gt;Would there be any point in including the SSLContext setup code in NET? e.g. in a utility module.&lt;br/&gt;
Or is it too specific to the SSL protocol?&lt;/p&gt;</comment>
                            <comment id="13005711" author="bogdro" created="Fri, 11 Mar 2011 16:36:55 +0000"  >&lt;p&gt;I think this could be done, but remember that there are a few parameters in the code, as you can see:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;the protocol&lt;/li&gt;
	&lt;li&gt;the Provider or a provider String (for SSLContext.getInstance(), not used here)&lt;/li&gt;
	&lt;li&gt;the KeyManagerFactory type&lt;/li&gt;
	&lt;li&gt;the KeyStore type&lt;/li&gt;
	&lt;li&gt;the filename of the KeyStore&lt;/li&gt;
	&lt;li&gt;the password to the KeyStore&lt;/li&gt;
	&lt;li&gt;the TrustManager&lt;/li&gt;
	&lt;li&gt;a SecureRandom instance (the &quot;null&quot; parameter in ctx.init() above)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;It ceratinly would be possible to create a few overloaded methods that take different number of parameters from the above list. If a parameter is null or not present in some version of the utility method, use the one from the code above.&lt;/p&gt;

&lt;p&gt;It would be easier for users, because in the simplest version they would only need to create a keystore and provide the filename and password to the method and they would get a ready-to-use SSLContext for use in the constructor (so, of course, the overloaded methods would have be &quot;public static&quot;, if they would be in FTPSClient). I didn&apos;t think of that, but you&apos;re right - we should make it easier for the users. The simplest version (filename+password) would surely be easier to use than writing all the above by hand after, say, an hour of browsing the Web. The more parameters will there be in the &quot;biggest&quot; declaration, the better for the more advanced users (less assuming by us, most possibilities for the users).&lt;/p&gt;

&lt;p&gt;The problem is that supporting all combinations of parameters would probably produce many methods. These would probably have to be put in a separate module. The minimum is one method (with all the parameters passed from outside), but it would be hard to use, so the real minimum should be 2 methods (one with all the parameters and one just with the filename and the password).&lt;/p&gt;

&lt;p&gt;Conclusion: yes, there is a point in implementing this. Perhaps even not only in the &quot;ftp&quot; package, but somewhere above, because, in theory, even POP3, SMTP and other servers where SSL/TLS is used, could require user authentication by certificate (apart from the password later on).&lt;/p&gt;</comment>
                            <comment id="13006179" author="bogdro" created="Sun, 13 Mar 2011 11:53:21 +0000"  >&lt;p&gt;Here is a simple class that wraps all the SSLContext creation details in simple methods. There are 2 &quot;maximum&quot; methods (all parameters included), 1 &quot;minimum&quot; (just the keystore and a password to it) and some in between. Tested the simplest method - still works. Put it in the right package (org/apache/commons/net/util?), you can move tha anonymous class to a named inner class, if you like.&lt;/p&gt;</comment>
                            <comment id="13006197" author="sebb@apache.org" created="Sun, 13 Mar 2011 13:46:32 +0000"  >&lt;p&gt;Thanks, the patch looks very useful.&lt;/p&gt;

&lt;p&gt;Just a few minor points of clarification:&lt;/p&gt;

&lt;p&gt;Do we really need the isClientTrusted/isServerTrusted methods? They appear to be for pre-JDK 1.4 code.&lt;/p&gt;

&lt;p&gt;Why is the checkServerTrusted code commented out?&lt;/p&gt;

&lt;p&gt;Also, the accept-all TrustManager seems to be basically the same FTPSTrustManager and POP3TrustManager and SMTPSTrustManager - they could surely all be combined&lt;br/&gt;
into a single utility class?&lt;/p&gt;

&lt;p&gt;Note: no need to provide patches for such changes, but feedback very welcome!&lt;/p&gt;</comment>
                            <comment id="13006205" author="bogdro" created="Sun, 13 Mar 2011 15:08:48 +0000"  >&lt;p&gt;isClient/ServerTrusted(): I believe we don&apos;t need these anymore. I left them because the code I&apos;ve found on the &apos;net used them and I figured these may be required for backwards-comaptibility and this was my only reason. Now I&apos;m thining that the backward-compatible version perhaps required classes from javax.security.cert (instead of the new java.security.cert), so this compatibility may not be retained anyway.&lt;/p&gt;

&lt;p&gt;checkServertrusted(): wasn&apos;t commented-out in FTPSTrustManager, but since we&apos;re accepting everything, I&apos;m not even validating. Validating the certificates could cause Exceptions, so we could validate not all certificates. What to do is the right question. If the server certificate has expired or is self-signed or is not signed by a certificate a user has in his/her trust store, should we reject it even if it would provide encryption?&lt;/p&gt;

&lt;p&gt;Yes, the accept-all TrustManager looks like the other (except for the disabled code, perhaps). It came from the Web, while POP3TrustManager and SMTPSTrustManager came from the FTPSTrustManager. I didn&apos;t think back then that these could be combined, I kept my classes in the packages I modified. But you&apos;re right: at this point we&apos;re duplicating code, so these certainly can be combined. And there wouldn&apos;t be need for the anonymous class in the SSLContextsFactory any more.&lt;/p&gt;</comment>
                            <comment id="13006217" author="sebb@apache.org" created="Sun, 13 Mar 2011 16:31:19 +0000"  >&lt;p&gt;OK, thanks, that&apos;s cleared it up.&lt;/p&gt;

&lt;p&gt;Any certificate can provide encryption, but if the private key is known by a 3rd party, then in theory they can intercept the transmission and decrypt it. &lt;/p&gt;

&lt;p&gt;This can be avoided by ensuring that the certificates are trusted, i.e. we trust the issuer to protect it,&lt;/p&gt;

&lt;p&gt;So I think we should provide some different levels of validation:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;none (as per your patch)&lt;/li&gt;
	&lt;li&gt;certificate must be valid (as per FTPSTrustManager, POP3S, SMTPS)&lt;/li&gt;
	&lt;li&gt;full (i.e. use the defaults, don&apos;t override).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;ll add a TMFactory utility class that provides these.&lt;/p&gt;

&lt;p&gt;This would allow the user to choose the appropriate level for their application.&lt;/p&gt;</comment>
                            <comment id="13006504" author="bogdro" created="Mon, 14 Mar 2011 16:47:17 +0000"  >&lt;p&gt;Nice one. But now I have a question: why do you cast a TrustManagerFactory (which implements od extends nothing) to a X509TrustManager? Are you sure that this will work?&lt;/p&gt;

&lt;p&gt;I&apos;d add just three more methods to your factory (assuming the casts are OK):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; X509TrustManager getTrustManager(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; algorithm) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; NoSuchAlgorithmException {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; (X509TrustManager) TrustManagerFactory.getInstance(algorithm);
}
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; X509TrustManager getTrustManager(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; algorithm, Provider provider) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; NoSuchAlgorithmException {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; (X509TrustManager) TrustManagerFactory.getInstance(algorithm, provider);
}

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; X509TrustManager getTrustManager(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; algorithm, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; provider) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; NoSuchAlgorithmException {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; (X509TrustManager) TrustManagerFactory.getInstance(algorithm, provider);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;so that the user could choose the algorithm the TrustManager will be used for. This is basically delegating the calls to the TrustManagerFactory, but we have everything in one place.&lt;/p&gt;</comment>
                            <comment id="13006524" author="sebb@apache.org" created="Mon, 14 Mar 2011 17:16:27 +0000"  >&lt;p&gt;Oops! Good catch. Now fixed.&lt;/p&gt;

&lt;p&gt;Not sure it makes sense to wrap the other calls.&lt;/p&gt;</comment>
                            <comment id="13007541" author="bogdro" created="Wed, 16 Mar 2011 16:41:43 +0000"  >&lt;p&gt;Quick fixing &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Now that I see that the code has grown a bit, wrapping the other calls makes little sense. But now creating more methods, similar to the above (with an explicit algorithm or provider), with an extra parameter of a KeyStore makes more sense.&lt;/p&gt;

&lt;p&gt;Now the question is: will we always have an instance of X509TrustManager? Keytool allows creating other keys, not only RSA. But I&apos;m not sure. Anyway, perhaps the best solution is leave it as it is and have the user catch a ClassCastException if something went wrong. The only thing we could do is search the array for the first instance of X509TrustManager, which could in turn, return the non-first element (could it still be called &quot;the default&quot;?), which could cause even more mess. I&apos;m just thinking out loud, probably these problems will never happen, because the user should have prepared a proper keystore in the first place.&lt;/p&gt;

&lt;p&gt;I&apos;ve just remembered: if you accept my file, add a &quot;@see&quot; tag to the contructors that use SSLContexts and, independly of that, add a &quot;@see&quot; tag to the TrustManager-setters in FTPSClient, SMTPSClient and POP3SClient, so the users can find the new class.&lt;/p&gt;</comment>
                            <comment id="13007581" author="sebb@apache.org" created="Wed, 16 Mar 2011 17:31:29 +0000"  >&lt;p&gt;I&apos;m still working on this. &lt;/p&gt;

&lt;p&gt;Currently experimenting with a separate KeyManagerUtils class in parallel with the TrustManagerUtils class.&lt;/p&gt;

&lt;p&gt;These can hopefully be used directly with FTPClient using the set???Manager methods.&lt;/p&gt;

&lt;p&gt;I&apos;ve got that mostly working, but there are still some loose ends to tie up. Hopefully in the next few days.&lt;/p&gt;</comment>
                            <comment id="13009009" author="sebb@apache.org" created="Mon, 21 Mar 2011 02:57:38 +0000"  >&lt;p&gt;With the new KeyManagerUtils class, the code becomes:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;FTPSClient cl = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FTPSClient();

KeyStore ks = KeyManagerUtils.createKeyStore(&lt;span class=&quot;code-quote&quot;&gt;&quot;JKS&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;/path/to/privatekeystore.jks&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;storepassword&quot;&lt;/span&gt;);
KeyManager km = KeyManagerUtils.createClientKeyManager(ks, &lt;span class=&quot;code-quote&quot;&gt;&quot;privatekeyalias&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;keypassword&quot;&lt;/span&gt;);
cl.setKeyManager(km);

&lt;span class=&quot;code-comment&quot;&gt;// If the FTP server certificate is not trusted by the JVM, add &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;:
&lt;/span&gt;X509TrustManager tm = TrustManagerUtils.getAcceptAllTrustManager();
cl.setTrustManager(tm);

cl.connect(...);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The new class is slightly different from the original solution, as it does not use an explicit SSLContext to initialise the FTPSClient, nor does it use the KeyManagerFactory. This allows it to use the setKeyManager/setTrustManager methods.&lt;/p&gt;</comment>
                            <comment id="13009119" author="bogdro" created="Mon, 21 Mar 2011 13:03:02 +0000"  >&lt;p&gt;Good job. A simple class with a simple API. Different from mine, because it requires an alias of the certificate to be provided (mine didn&apos;t require), but simpler, which is good.&lt;/p&gt;

&lt;p&gt;One more thing I&apos;ve noticed recently: the &quot;S&quot; clients&apos; (SMTPS, POP3S, FTPS) constructors have an unnecessary line in their javadoc, a leftover after removing the exception description. Could you fix that?&lt;/p&gt;</comment>
                            <comment id="13009121" author="sebb@apache.org" created="Mon, 21 Mar 2011 13:21:30 +0000"  >&lt;p&gt;I added the alias in case the keystore contained multiple keys. &lt;br/&gt;
Having said that, perhaps it would be nice if the code allowed the alias to be omitted if there is only a single entry in the jar. I&apos;ll create a JIRA for that.&lt;/p&gt;

&lt;p&gt;I assume you mean the comment: &quot;is not available in the environment.&quot;.&lt;br/&gt;
Yes, I can remove that.&lt;/p&gt;</comment>
                            <comment id="13009160" author="bogdro" created="Mon, 21 Mar 2011 15:09:26 +0000"  >&lt;p&gt;Yes, that&apos;s precisely what I meant. Thank you!&lt;/p&gt;

&lt;p&gt;About the multiple keys: I assumed that only a keystore is required and the certificate is chosen basing on things like the Common Name field. I could be wrong, of course.&lt;/p&gt;</comment>
                            <comment id="13009199" author="sebb@apache.org" created="Mon, 21 Mar 2011 16:30:39 +0000"  >&lt;p&gt;It does look as if getClientAliases() and chooseClientAlias() can return a dummy value (at least with the Sun JVM when tested against Apache FTPServer) but obviously a matching key and certificate chain need to be provided by the KeyManager.&lt;/p&gt;

&lt;p&gt;For some servers, a specific key may be needed, so I think the alis could prove useful.&lt;/p&gt;</comment>
                            <comment id="13009641" author="bogdro" created="Tue, 22 Mar 2011 13:32:51 +0000"  >&lt;p&gt;You&apos;re right, the alias could be useful, but it may not always be necessary. I like the current solution of&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;keyAlias != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; ? keyAlias : findAlias(ks)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;It has both our ideas.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12473503" name="SSLContextsFactory.java" size="17629" author="bogdro" created="Sun, 13 Mar 2011 11:53:21 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>72029</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 35 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0l313:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>121141</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>