<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 20:43:53 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[NET-68] [net] TFTPClient&apos;s send file discards last ack</title>
                <link>https://issues.apache.org/jira/browse/NET-68</link>
                <project id="12310487" key="NET">Commons Net</project>
                    <description>&lt;p&gt;TFTPClient reads all acks just fine except the last-one when sending a file. I&lt;br/&gt;
figured this out when I tried to use the same TFTPClient-instance for something&lt;br/&gt;
else (reading a file) after sending a file. This ack was next in the buffer and&lt;br/&gt;
some exception was thrown (don&apos;t remember which anymore). &lt;/p&gt;

&lt;p&gt;I fixed this for myself using a flag (lastAckWait). Here is a the result of&lt;br/&gt;
diff-command:&lt;/p&gt;

&lt;p&gt;diff -u TFTPClient.java.original TFTPClient.java.patched&lt;br/&gt;
&amp;#8212; TFTPClient.java.original    2004-12-28 15:02:37.235997984 +0200&lt;br/&gt;
+++ TFTPClient.java.patched     2004-12-28 15:09:14.516602152 +0200&lt;br/&gt;
@@ -372,6 +372,7 @@&lt;/p&gt;

&lt;p&gt;         dataLength = lastBlock = hostPort = bytesRead = 0;&lt;br/&gt;
         block = 0;&lt;br/&gt;
+        boolean lastAckWait = false;&lt;/p&gt;

&lt;p&gt;         if (mode == TFTP.ASCII_MODE)&lt;br/&gt;
             input = new ToNetASCIIInputStream(input);&lt;br/&gt;
@@ -455,7 +456,10 @@&lt;br/&gt;
                         if (lastBlock == block)&lt;/p&gt;
                         {
                             ++block;
-                            break _receivePacket;
+                            if (lastAckWait)
+                              break _sendPacket;
+                            else
+                              break _receivePacket;
                         }
&lt;p&gt;                         else&lt;/p&gt;
                         {
@@ -501,9 +505,8 @@
             data.setData(_sendBuffer, 4, offset - 4);
             sent = data;
         }
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;while (dataLength == 0);&lt;br/&gt;
+        while (dataLength == 0 || lastAckWait);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;bufferedSend(sent);&lt;br/&gt;
         endBufferedOps();&lt;br/&gt;
     }&lt;/li&gt;
&lt;/ul&gt;




&lt;p&gt;By the way we have implemented a TFTP server also (heavily unit-tested). I could&lt;br/&gt;
try to contribute it back if it fits in commons net. There was some talk in the&lt;br/&gt;
web-pages of doing only client-side stuff for commons-net. &lt;/p&gt;

&lt;p&gt;-Perttu&lt;/p&gt;</description>
                <environment>&lt;p&gt;Operating System: Linux&lt;br/&gt;
Platform: PC&lt;/p&gt;</environment>
        <key id="12341961">NET-68</key>
            <summary>[net] TFTPClient&apos;s send file discards last ack</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="perttu.auramo@ekahau.com">Perttu Auramo</reporter>
                        <labels>
                    </labels>
                <created>Tue, 28 Dec 2004 22:37:48 +0000</created>
                <updated>Thu, 17 Jan 2008 00:36:11 +0000</updated>
                            <resolved>Sun, 27 Aug 2006 15:14:59 +0000</resolved>
                                    <version>1.3</version>
                                    <fixVersion>1.5</fixVersion>
                    <fixVersion>2.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="12408407" author="perttu.auramo@ekahau.com" created="Tue, 28 Dec 2004 22:39:53 +0000"  >&lt;p&gt;Created an attachment (id=13845)&lt;br/&gt;
The patch as a file&lt;/p&gt;</comment>
                            <comment id="12408408" author="rwinston@eircom.net" created="Fri, 15 Apr 2005 23:21:10 +0000"  >&lt;p&gt;Thanks Perttu. &lt;/p&gt;</comment>
                            <comment id="12408409" author="michael.enright@gmail.com" created="Fri, 27 May 2005 09:32:43 +0000"  >&lt;p&gt;I can&apos;t see how the flag in this patch helps anything. As far as I can tell, all&lt;br/&gt;
the lines in the patch that could make use of this new flag have + in front of&lt;br/&gt;
them. None of those lines set the flag to true, so the flag is always false and&lt;br/&gt;
the code pretty much does what it did before.&lt;/p&gt;

&lt;p&gt;There is another delta in the patch that changes how bufferedSend is called.&lt;br/&gt;
This worries me because I&apos;m having a problem where the last piece of the file&lt;br/&gt;
(or all of the file if it is small) is not sent to the server.&lt;/p&gt;</comment>
                            <comment id="12408410" author="michael.enright@gmail.com" created="Fri, 27 May 2005 09:58:57 +0000"  >&lt;p&gt;FWIW restoring the deleted call to bufferedSend corrected the symptoms I had.&lt;/p&gt;</comment>
                            <comment id="12408411" author="dfs@apache.org" created="Fri, 27 May 2005 10:49:21 +0000"  >&lt;p&gt;I concur with your assessment Michael.  I don&apos;t see what this patch does&lt;br/&gt;
other than break TFTPClient.sendFile.  Even if lastAckWait were true, the&lt;br/&gt;
method would go into an infinite loop at the end.  I&apos;m going to revert the&lt;br/&gt;
change.&lt;/p&gt;

&lt;p&gt;If the original issue reporter believes there is a bug in sendFile, then&lt;br/&gt;
we&apos;re going to need a test program that reproduces the bug.  Submitting&lt;br/&gt;
a patch with only anectdotal support for there being a problem is&lt;br/&gt;
insufficient.&lt;/p&gt;</comment>
                            <comment id="12408412" author="dfs@apache.org" created="Fri, 27 May 2005 11:12:23 +0000"  >&lt;p&gt;It is true that sendFile doesn&apos;t wait for a final ack (probably because&lt;br/&gt;
it was thought at the time that we didn&apos;t want to hang if the final ack&lt;br/&gt;
got lost).  Therefore, a UDP packet may remain queued for delivery to&lt;br/&gt;
user space, causing a problem on subsequent read operation on the same&lt;br/&gt;
socket.  However, a call to TFTP.discardPackets is the appropriate&lt;br/&gt;
(although imperfect if the last ack is delayed) workaround until we get&lt;br/&gt;
more information about the problem.&lt;/p&gt;</comment>
                            <comment id="12408413" author="dfs@apache.org" created="Wed, 29 Jun 2005 04:04:23 +0000"  >&lt;ul&gt;
	&lt;li&gt;
	&lt;ul&gt;
		&lt;li&gt;
		&lt;ul&gt;
			&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/NET-109&quot; title=&quot;TFTPClient.sendFile()  not sending last packet&quot; class=&quot;issue-link&quot; data-issue-key=&quot;NET-109&quot;&gt;&lt;del&gt;COM-2188&lt;/del&gt;&lt;/a&gt; has been marked as a duplicate of this bug. ***&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12430869" author="rwinston@eircom.net" created="Sun, 27 Aug 2006 15:14:59 +0000"  >&lt;p&gt;Daniel has reverted the fix.&lt;/p&gt;</comment>
                            <comment id="12436885" author="jhodgdon" created="Fri, 22 Sep 2006 15:31:39 +0000"  >&lt;p&gt;Neither the 1.41 release version of TFTPClient.java, nor the current nightly build version (as of Sept 15 2006) is working, actually. This bug is still happening. I will attach a zip file (which I just mistakenly put into Bugzilla, sorry!) with some test code.&lt;/p&gt;

&lt;p&gt;The nightly build version is definitely doing what the bug report stated: dropping the last ACK. When TFTPClient sends a file, it sends a data packet and waits for an ACK, but after the last data packet, it doesn&apos;t pick up the last ACK, and then when TFTPClient goes to send/receive another file from the same server, the first thing it gets is the last ACK from the previous send, and it reports an &quot;unexpected packet received&quot; and fails.&lt;/p&gt;

&lt;p&gt;The version from the 1.41 release doesn&apos;t work either &amp;#8211; I can&apos;t recall exactly what is wrong with it, actually, but I tested it and it does not work.&lt;/p&gt;

&lt;p&gt;The version I will attach does work. It would probably be a good idea to use something like this in the next release.&lt;/p&gt;

&lt;p&gt;I&apos;ll also attach my test code: a TFTPClientApp and TFTPServerApp that can be run on two different computers to test the workings of the TFTPClient class.&lt;/p&gt;</comment>
                            <comment id="12436887" author="jhodgdon" created="Fri, 22 Sep 2006 15:33:19 +0000"  >&lt;p&gt;This zip file contains a fix for TFTPClient.java, as well as TFTP test code. TFTPClientApp and TFTPServerApp need to be run on two separate computers &amp;#8211; see embedded doc for more information.&lt;/p&gt;</comment>
                            <comment id="12436895" author="jhodgdon" created="Fri, 22 Sep 2006 15:52:31 +0000"  >&lt;p&gt;Patch for suggested fix to TFTPClient.java&lt;/p&gt;</comment>
                            <comment id="12448992" author="rwinston@eircom.net" created="Sat, 11 Nov 2006 16:08:21 +0000"  >&lt;p&gt;I&apos;ve applied your patch to TFTPClient on the 2.0 branch. Thanks Jennifer.&lt;/p&gt;</comment>
                            <comment id="12559761" author="armbrust" created="Thu, 17 Jan 2008 00:32:00 +0000"  >&lt;p&gt;Why hasn&apos;t this patch been applied to 1.4?  What good does it do fixing in in 2.0, if that never gets built?&lt;/p&gt;

&lt;p&gt;The 1.4 release, currently available for download is quite simply, broken.  Files smaller than 1 block size simply aren&apos;t transferred, larger files are corrupted.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                                                <inwardlinks description="is blocked by">
                                        <issuelink>
            <issuekey id="12370119">NET-161</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12333300" name="ASF.LICENSE.NOT.GRANTED--patch" size="1107" author="perttu.auramo@ekahau.com" created="Tue, 28 Dec 2004 22:39:53 +0000"/>
                            <attachment id="12341406" name="TFTPstuff.zip" size="9453" author="jhodgdon" created="Fri, 22 Sep 2006 15:33:19 +0000"/>
                            <attachment id="12341409" name="lastack.patch" size="4053" author="jhodgdon" created="Fri, 22 Sep 2006 15:52:31 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_10010" key="com.atlassian.jira.plugin.system.customfieldtypes:importid">
                        <customfieldname>Bugzilla Id</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>32859</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>154407</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            17 years, 45 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0l2r3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>121096</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>