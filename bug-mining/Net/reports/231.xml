<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 20:45:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[NET-596] NullPointerException when disconnecting TelnetClient twice with JDK 7</title>
                <link>https://issues.apache.org/jira/browse/NET-596</link>
                <project id="12310487" key="NET">Commons Net</project>
                    <description>&lt;p&gt;When using the TelnetClient class, a &lt;tt&gt;NullPointerException&lt;/tt&gt; may occur when calling the &lt;tt&gt;disconnect&lt;/tt&gt; method twice, in the &lt;tt&gt;_closeOutputStream&lt;/tt&gt; method called under the hood, if the Telnet connection is lost (for instance, server is hardly shut down).&lt;/p&gt;

&lt;p&gt;1. The first call to &lt;tt&gt;disconnect&lt;/tt&gt; resets completely the TelnetClient instance.&lt;br/&gt;
2. The second call to &lt;tt&gt;disconnect&lt;/tt&gt; leads to the NPE exception, because the &lt;tt&gt;&amp;#95;output&amp;#95;&lt;/tt&gt; property is &lt;tt&gt;null&lt;/tt&gt;, in the &lt;tt&gt;_closeOutputStream&lt;/tt&gt; method.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;NOTE: the NPE does not occur with JDK 8, because, the first call to &lt;tt&gt;disconnect&lt;/tt&gt; throws an I/O exception (socket is closed), leaving the TelnetClient instance with a non-null &lt;tt&gt;&amp;#95;output&amp;#95;&lt;/tt&gt; property. Then a second call to disconnect does not throw a NPE. It seems the JDK 8 behaves differently when a client socket loses a connection. So there is also a bug with JDK 8, as disconnection shall close quietly resources without an I/O exception, and without leaving non-null resources, and then disconnect the client socket. The &lt;tt&gt;SocketClient.disconnect&lt;/tt&gt; is a good implementation to start with.&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;The problem is that the TelnetOutputStream class closes the Socket output stream under the hood, but doesn&apos;t check if it is null and doesn&apos;t reset it to null once done. &lt;em&gt;The implementation of the TelnetOutputStream is quite strange, as there is a cycling dependency between this class and the TelnetClient class. The &lt;tt&gt;TelnetClient&lt;/tt&gt; class shall handle itself the close of its internal resources, and disconnect the client socket. But this responsibility is delegates to the TelnetOutputStream.&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;Here&apos;s the stack trace of the NPE exception:&lt;/p&gt;
&lt;blockquote&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;java.lang.NullPointerException&lt;br/&gt;
     at org.apache.commons.net.telnet.TelnetClient._closeOutputStream(TelnetClient.java:83)&lt;br/&gt;
      at org.apache.commons.net.telnet.TelnetOutputStream.close(TelnetOutputStream.java:163)&lt;br/&gt;
      at org.apache.commons.net.telnet.TelnetClient.disconnect(TelnetClient.java:124)&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/blockquote&gt;

&lt;p&gt;A way to workaround this bug, is to always check if the &lt;tt&gt;TelnetClient&lt;/tt&gt; instance is connected, before calling the &lt;tt&gt;disconnect&lt;/tt&gt; method.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Both telnet client &amp;amp; server with JDK 7.&lt;br/&gt;
Bug not reproduced with JDK 8 (there&apos;s another bug with this JDK though, as mentioned in the description).&lt;/p&gt;</environment>
        <key id="12986816">NET-596</key>
            <summary>NullPointerException when disconnecting TelnetClient twice with JDK 7</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="vicente69">Vincent Bories-Azeau</reporter>
                        <labels>
                    </labels>
                <created>Tue, 5 Jul 2016 13:55:22 +0000</created>
                <updated>Tue, 14 Feb 2017 22:22:36 +0000</updated>
                            <resolved>Tue, 7 Feb 2017 23:53:22 +0000</resolved>
                                    <version>3.5</version>
                                    <fixVersion>3.6</fixVersion>
                                    <component>Telnet</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="15362875" author="garydgregory" created="Tue, 5 Jul 2016 17:57:55 +0000"  >&lt;p&gt;How about something like:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;### Eclipse Workspace Patch 1.0
#P commons-net
Index: src/main/java/org/apache/commons/net/telnet/TelnetClient.java
===================================================================
--- src/main/java/org/apache/commons/net/telnet/TelnetClient.java	(revision 1751512)
+++ src/main/java/org/apache/commons/net/telnet/TelnetClient.java	(working copy)
@@ -80,7 +80,10 @@
     }
     void _closeOutputStream() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException
     {
-        _output_.close();
+        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (_output_!= &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) 
+        {
+            _output_.close();
+        }
     }
 
     /***
@@ -120,9 +123,11 @@
         &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
             &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (__input != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                 __input.close();
+                __input = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
             }
             &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (__output != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                 __output.close();
+                __output = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
             }
         } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; { &lt;span class=&quot;code-comment&quot;&gt;// NET-594
&lt;/span&gt;             &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.disconnect();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15363098" author="vicente69" created="Tue, 5 Jul 2016 19:40:41 +0000"  >&lt;p&gt;I would set the &lt;tt&gt;&amp;#95;output&amp;#95;&lt;/tt&gt; property to &lt;tt&gt;null&lt;/tt&gt; in a &lt;tt&gt;finally&lt;/tt&gt; block, to ensure we don&apos;t close twice a stream whose first close has failed:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;void _closeOutputStream() throws IOException
{
    if (_output_ != null) {
        try {
            _output_.close();
        } catch (IOException e) {
            // Shall this exception be ignored, or let it be managed by the caller?
        } finally {
            // Whatever happens, the stream is considered closed.
            _output_ = null;
        }
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;For the second fix you proposed, which is not related to the issue I created, a &lt;tt&gt;try-finally&lt;/tt&gt; block must also surround each &lt;tt&gt;close&lt;/tt&gt; call, to ensure we attempt to close everything properly, like this:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;public void disconnect() throws IOException
{
    if (__input != null) {
        try {
            __input.close();
        } catch (IOException e) {
            // Shall this exception be ignored, or let it be managed by the caller?
        } finally {
            // Whatever happens, the stream is considered closed.
            __input = null;
        }
    }
    if (__output != null) {
        try {
            __output.close();
        } catch (IOException e) {
            // Shall this exception be ignored, or let it be managed by the caller?
        } finally {
            // Whatever happens, the stream is considered closed.
            __output = null;
        }
    }
    super.disconnect();
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;To me, I would catch IOExceptions and hide them. I consider at this moment that, whatever happens, the client must be closed. But, whatever the final policy is, the most important is to keep the client in a reusable state I guess. As I mentioned, the &lt;tt&gt;SocketClient.disconnect&lt;/tt&gt; method is a good example. The doc comments shall also be updated to explain clearly when exceptions may be thrown, and the behaviour of consecutive calls.&lt;br/&gt;
Thanks for your answer!&lt;/p&gt;</comment>
                            <comment id="15857054" author="sebb@apache.org" created="Tue, 7 Feb 2017 23:53:22 +0000"  >&lt;p&gt;URL: &lt;a href=&quot;http://svn.apache.org/viewvc?rev=1782091&amp;amp;view=rev&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?rev=1782091&amp;amp;view=rev&lt;/a&gt;&lt;br/&gt;
Log:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/NET-596&quot; title=&quot;NullPointerException when disconnecting TelnetClient twice with JDK 7&quot; class=&quot;issue-link&quot; data-issue-key=&quot;NET-596&quot;&gt;&lt;del&gt;NET-596&lt;/del&gt;&lt;/a&gt; NullPointerException when disconnecting TelnetClient twice with JDK 7&lt;/p&gt;

&lt;p&gt;Modified:&lt;br/&gt;
    commons/proper/net/trunk/src/changes/changes.xml&lt;br/&gt;
    commons/proper/net/trunk/src/main/java/org/apache/commons/net/telnet/TelnetClient.java&lt;/p&gt;
</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 40 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i30jdr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>