<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 20:45:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[NET-687] [FTPS] javax.net.ssl.SSLException: Unsupported or unrecognized SSL message</title>
                <link>https://issues.apache.org/jira/browse/NET-687</link>
                <project id="12310487" key="NET">Commons Net</project>
                    <description>&lt;p&gt;After adding the self signed polynesie.cer certificate to JVM security (&lt;em&gt;jdk-x.x.x/lib/security&lt;/em&gt;) :&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
keytool.exe -&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; -storepass &lt;span class=&quot;code-quote&quot;&gt;&quot;changeit&quot;&lt;/span&gt; -keystore &lt;span class=&quot;code-quote&quot;&gt;&quot;./cacerts&quot;&lt;/span&gt; -alias polynesie.cer -file ./polynesie.cer -noprompt&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;polynesie.cer obtained by copying certificate part from this command line result :&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
openssl s_client -connect ftp0.gov.pf:21 -starttls ftp&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Trying to retrieve a file with ftpes :&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java -cp commons-net-examples-3.5.jar;commons-net-3.5.jar examples/ftp/FTPClientExample -A -p TLS,&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt; -e -b ftp0.gov.pf DataVRS/fiche_Station_VRS_VAI1.pdf fiche_Station_VRS_VAI1.pdf&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Produce this exception :&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
javax.net.ssl.SSLException: Unsupported or unrecognized SSL message
        at java.base/sun.security.ssl.SSLSocketInputRecord.handleUnknownRecord(Unknown Source)
        at java.base/sun.security.ssl.SSLSocketInputRecord.decode(Unknown Source)
        at java.base/sun.security.ssl.SSLSocketImpl.readRecord(Unknown Source)
        at java.base/sun.security.ssl.SSLSocketImpl.readRecord(Unknown Source)
        at java.base/sun.security.ssl.SSLSocketImpl.performInitialHandshake(Unknown Source)
        at java.base/sun.security.ssl.SSLSocketImpl.startHandshake(Unknown Source)
        at java.base/sun.security.ssl.SSLSocketImpl.startHandshake(Unknown Source)
        at org.apache.commons.net.ftp.FTPSClient._openDataConnection_(FTPSClient.java:642)
        at org.apache.commons.net.ftp.FTPClient._retrieveFile(FTPClient.java:1907)
        at org.apache.commons.net.ftp.FTPClient.retrieveFile(FTPClient.java:1893)
        at testFTP2.FTPClientExample.main(FTPClientExample.java:513)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;It is probably the same error of ssl_reuse session as &lt;a href=&quot;https://issues.apache.org/jira/browse/NET-408&quot; title=&quot;problem connecting to ProFTPD with FTPES&quot; class=&quot;issue-link&quot; data-issue-key=&quot;NET-408&quot;&gt;NET-408&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Same try with ftp4j library reports this error :&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
code=522, message= SSL connection failed; session reuse required: see require_ssl_reuse option in vsftpd.conf man page
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment>&lt;p&gt;Tested with JDK 8, 11, 13, 14&lt;/p&gt;</environment>
        <key id="13324811">NET-687</key>
            <summary>[FTPS] javax.net.ssl.SSLException: Unsupported or unrecognized SSL message</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="mguichar">Mikael</reporter>
                        <labels>
                    </labels>
                <created>Thu, 27 Aug 2020 10:36:17 +0000</created>
                <updated>Sun, 3 Oct 2021 15:39:05 +0000</updated>
                            <resolved>Sun, 20 Sep 2020 16:29:33 +0000</resolved>
                                    <version>3.7</version>
                                    <fixVersion>3.7.1</fixVersion>
                                    <component>FTP</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17194169" author="jelle.evers@cofano.nl" created="Fri, 11 Sep 2020 09:51:16 +0000"  >&lt;p&gt;The issue is caused by the following commit:&lt;br/&gt;
 &lt;a href=&quot;https://github.com/apache/commons-net/commit/c660afa96016f6cd2de356439b58fa9c4443d467&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/commons-net/commit/c660afa96016f6cd2de356439b58fa9c4443d467&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This commit moves the SSL socket creation (from a normal socket) to a separate function in order to also use it when opening the data connection:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; Socket _openDataConnection_(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; command, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; arg)
            &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
        Socket socket = &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;._openDataConnection_(command, arg);
        socket = createSSLSocket(socket);
        _prepareDataSocket_(socket);
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (socket &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; SSLSocket) {
            SSLSocket sslSocket = (SSLSocket)socket;  

            sslSocket.setUseClientMode(isClientMode);
            sslSocket.setEnableSessionCreation(isCreation);

            &lt;span class=&quot;code-comment&quot;&gt;// server mode
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!isClientMode) {
                sslSocket.setNeedClientAuth(isNeedClientAuth);
                sslSocket.setWantClientAuth(isWantClientAuth);
            }
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (suites != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                sslSocket.setEnabledCipherSuites(suites);
            }
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (protocols != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                sslSocket.setEnabledProtocols(protocols);
            }
            sslSocket.startHandshake();
        }

        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; socket;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This might seem logical, but it is incorrect. The super call to &lt;em&gt;openDataConnection&lt;/em&gt; internally uses the socket factory to obtain a new socket. When we want the data connection to also use SSL, we execute a PROT P command to the server. This is done use the execPROT function:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void execPROT(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; prot) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; SSLException, IOException {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (prot == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            prot = DEFAULT_PROT;
        }
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!checkPROTValue(prot)) {
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IllegalArgumentException();
        }
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (FTPReply.COMMAND_OK != sendCommand(CMD_PROT, prot)) {
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SSLException(getReplyString());
        }
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (DEFAULT_PROT.equals(prot)) {
            setSocketFactory(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
            setServerSocketFactory(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
            setSocketFactory(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FTPSSocketFactory(context));
            setServerSocketFactory(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FTPSServerSocketFactory(context));
            initSslContext();
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This function sets the socket factory to be a FTPSSocketFactory when prot is P (P indicates we want an encrypted data channel, DEFAULT_PROT is C). The FTPSSocketFactory already returns SSL sockets when asked to build a new socket. The line added in the mentioned commit when opening the data connection thus builds a SSL socket over what is already a SSL socket. This causes the first SSL handshake to trigger another SSL handshake on the stacked SSL sockets and this eventually leads to the &quot;Unsupported or unrecognized SSL message&quot; exception because one of them tries to interpret application data as a handshake message.&lt;/p&gt;

&lt;p&gt;Removing the line added in the mentioned commit fixes the issue. I&apos;ve opened a pull request:&lt;br/&gt;
 &lt;a href=&quot;https://github.com/apache/commons-net/pull/59&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/commons-net/pull/59&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17194184" author="jelle.evers@cofano.nl" created="Fri, 11 Sep 2020 10:01:28 +0000"  >&lt;p&gt;As a sidenote to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mguichar&quot; class=&quot;user-hover&quot; rel=&quot;mguichar&quot;&gt;mguichar&lt;/a&gt; :&lt;/p&gt;

&lt;p&gt;It has nothing to do with SSL session reuse, this is a feature the library does not support very well. There are ways to work around this problem though (assuming you use version 3.6 of commons-net, since 3.7 is broken because of this issue). Have a look at the following article:&lt;br/&gt;
&lt;a href=&quot;https://eng.wealthfront.com/2016/06/10/connecting-to-an-ftps-server-with-ssl-session-reuse-in-java-7-and-8/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://eng.wealthfront.com/2016/06/10/connecting-to-an-ftps-server-with-ssl-session-reuse-in-java-7-and-8/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This article shows a way to reuse the control channel SSL session for the data channel. Even with this workaround you might still run into the same session reuse error. With JDK 8u161 or higher (also including JDK 9, 11, etc) you also need to set the following system property to &lt;em&gt;false&lt;/em&gt;:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
jdk.tls.useExtendedMasterSecret
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17199042" author="garydgregory" created="Sun, 20 Sep 2020 16:29:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mguichar&quot; class=&quot;user-hover&quot; rel=&quot;mguichar&quot;&gt;mguichar&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jelle.evers%40cofano.nl&quot; class=&quot;user-hover&quot; rel=&quot;jelle.evers@cofano.nl&quot;&gt;jelle.evers@cofano.nl&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Fixed in git master, please verify and close.&lt;/p&gt;

&lt;p&gt;TY!&lt;/p&gt;</comment>
                            <comment id="17406296" author="bade7n" created="Sat, 28 Aug 2021 20:18:44 +0000"  >&lt;p&gt;So now it is mandatory to `execPROT` for FTPS connections, otherwise, it sets for data connections plain socket only and timeout after a while because the other party is expecting a handshake.&lt;/p&gt;

&lt;p&gt;It has issues:&lt;/p&gt;

&lt;p&gt;1) for TLS control connections without PROT we try to use plain sockets for data transfer (why? isn&apos;t it logical to use SSL in this case?).&lt;/p&gt;

&lt;p&gt;2) all clients have to call `execPROT`. Which is i believe is fragile since it is mandatory now and it should be called before any data-related command.&lt;/p&gt;

&lt;p&gt;3) existing clients are not issuing PROT command, so it leads to incompatibility and issues in all of them (requires update)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17406415" author="garydgregory" created="Sun, 29 Aug 2021 14:27:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bade7n&quot; class=&quot;user-hover&quot; rel=&quot;bade7n&quot;&gt;bade7n&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I am not sure what you are looking for here.&lt;/p&gt;

&lt;p&gt;Are you thinking of proposing a PR to allow the behavior to be configurable?&#160;&lt;/p&gt;

&lt;p&gt;Are you using 3.8.0?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17406669" author="mguichar" created="Mon, 30 Aug 2021 10:25:04 +0000"  >&lt;p&gt;Thanks, I can access ftpes server without error anymore.&lt;br/&gt;
I close this tocket.&lt;/p&gt;</comment>
                            <comment id="17407704" author="bade7n" created="Tue, 31 Aug 2021 22:28:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ggregory&quot; class=&quot;user-hover&quot; rel=&quot;ggregory&quot;&gt;ggregory&lt;/a&gt;&lt;br/&gt;
I am looking for a solution. &lt;br/&gt;
At first, would be nice to decide if an encrypted control channel should lead to encryption in the data channels. Second to decide if `execPROT` is mandatory or optional.&lt;/p&gt;</comment>
                            <comment id="17423674" author="garydgregory" created="Sun, 3 Oct 2021 15:39:05 +0000"  >&lt;p&gt;Any thoughts @sebb?&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12311024" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>External issue ID</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;a href=&quot;https://issues.apache.org/jira/browse/NET-408&quot; title=&quot;problem connecting to ProFTPD with FTPES&quot; class=&quot;issue-link&quot; data-issue-key=&quot;NET-408&quot;&gt;NET-408&lt;/a&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 5 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0i4qg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>