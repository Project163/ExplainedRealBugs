<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 20:45:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[NET-550] Default FTPClient bufferSize results in very slow retrieve transfers</title>
                <link>https://issues.apache.org/jira/browse/NET-550</link>
                <project id="12310487" key="NET">Commons Net</project>
                    <description>&lt;p&gt;While experimenting with FTPClient, I discovered that if I don&apos;t call setBufferSize(), the default value is zero.  This results in retrieveFile() calling the version of InputStream.read() with no parameters, reading one byte at a time.  For comparison, the downloading a CD ISO image of about ~648MB took 18m10s with the default settings.  In contrast, calling setBufferSize(8192) took only 7.9s, an improvement of ~137x.&lt;/p&gt;

&lt;p&gt;Here is some sample code:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;FTPClient ftp = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FTPClient();
&lt;span class=&quot;code-comment&quot;&gt;// ftp.setBufferSize(8192);
&lt;/span&gt;ftp.setControlKeepAliveTimeout(300);
ftp.setCopyStreamListener(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CopyStreamListener() {
    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void bytesTransferred(&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; totalBytesTransferred, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; bytesTransferred, &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; streamSize) {
        &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;totalBytesTransferred: &quot;&lt;/span&gt; + totalBytesTransferred
            + &lt;span class=&quot;code-quote&quot;&gt;&quot;, bytesTransferred: &quot;&lt;/span&gt; + bytesTransferred + &lt;span class=&quot;code-quote&quot;&gt;&quot;, streamSize: &quot;&lt;/span&gt; + streamSize);
    }

    @Override &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void bytesTransferred(CopyStreamEvent event) {}
});
ftp.connect(host);
ftp.login(user, pass);
ftp.retrieveFile(file, outputStream);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The log message from the stream listener printed lots messages &quot;bytesTransferred: 1&quot; and totalBytesTransferred incremented by 1 each time.  This corresponds to the part of the code which reads one byte at a time with &lt;tt&gt;int inputStream.read()&lt;/tt&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12732582">NET-550</key>
            <summary>Default FTPClient bufferSize results in very slow retrieve transfers</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="geoffhardy">Geoffrey Hardy</reporter>
                        <labels>
                    </labels>
                <created>Thu, 7 Aug 2014 16:33:14 +0000</created>
                <updated>Thu, 26 Nov 2015 16:34:46 +0000</updated>
                            <resolved>Fri, 3 Jul 2015 16:40:22 +0000</resolved>
                                    <version>3.3</version>
                                    <fixVersion>3.4</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14089477" author="geoffhardy" created="Thu, 7 Aug 2014 17:16:51 +0000"  >&lt;p&gt;I &lt;em&gt;strongly&lt;/em&gt; disagree that this is a duplicate.  My complaint is the &lt;em&gt;default&lt;/em&gt; value for bufferSize.  I read several existing bug reports before posting this, but nothing directly addresses the default value of zero.  &lt;/p&gt;

&lt;p&gt;I also looked at the source code in the head, and bufferSize still has a default size of zero.  This is very annoying for new users of the client library &amp;#8211; it causes a dramatic effect on performance, and is very difficult to diagnose.  I discovered this by accident, and it took a lot of testing to figure it out.&lt;/p&gt;

&lt;p&gt;I also tried the proposed solution &amp;#8211; downloading a 3.4 snapshot &amp;#8211; but that did &lt;b&gt;not&lt;/b&gt; resolve the problem for me.&lt;/p&gt;</comment>
                            <comment id="14089627" author="b.eckenfels" created="Thu, 7 Aug 2014 19:07:14 +0000"  >&lt;p&gt;Hm, I was looking at the usage of this in VFS, because it is affected: it does not set an explicite buffer size. &lt;/p&gt;

&lt;p&gt;When I drill down into the 3.3 code, it looks like it correctly generated getBufferedXXXStream() for __bufferSize==0 (using default buffer size of 8k from Java bufferedxxxStream). However besides the buffered streams it also uses the buffer size for the copy loop. And in this case it does not use a default buffer. Which is quite strange because I wonder why read[byte&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;) works anywy. It only works because it has a read() fallback, which is clearly not the intention of the code.&lt;/p&gt;

&lt;p&gt;Attached is a proposed minimal fix, but instead of that the buffering should be reconsidered completely.&lt;/p&gt;</comment>
                            <comment id="14089643" author="b.eckenfels" created="Thu, 7 Aug 2014 19:15:56 +0000"  >&lt;p&gt;NB: the &quot;use default when 0&quot; is even documented in the Javadoc, so this is a mandatory fix anyway.&lt;/p&gt;</comment>
                            <comment id="14089664" author="b.eckenfels" created="Thu, 7 Aug 2014 19:28:22 +0000"  >&lt;p&gt;Actually looking at 3.4 the buffering situation is a bit better, but still two instances can be avoided:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Index: src/main/java/org/apache/commons/net/ftp/FTPClient.java                                                                
===================================================================                                                           
--- src/main/java/org/apache/commons/net/ftp/FTPClient.java     (Revision 1616569)                                            
+++ src/main/java/org/apache/commons/net/ftp/FTPClient.java     (Arbeitskopie)                                                
@@ -656,7 +656,7 @@                                                                                                           
         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (__fileType == ASCII_FILE_TYPE) {                                                                                 
             output = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ToNetASCIIOutputStream(getBufferedOutputStream(socket.getOutputStream()));                          
         } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {                                                                                                             
-            output = getBufferedOutputStream(socket.getOutputStream());                                                      
+            output = socket.getOutputStream();                                                                               
         }                                                                                                                    
                                                                                                                              
         CSL csl = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;                                                                                                      
@@ -1878,7 +1878,7 @@                                                                                                         
         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (__fileType == ASCII_FILE_TYPE) {                                                                                 
             input = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FromNetASCIIInputStream(getBufferedInputStream(socket.getInputStream()));                            
         } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {                                                                                                             
-            input = getBufferedInputStream(socket.getInputStream());                                                         
+            input = socket.getInputStream();                                                                                 
         }                                                                                                                    
                                                                                                                              
         CSL csl = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;                                                                                                      
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;BTW: the default buffer of Util.copyStream is 1k, when removing the above buffered wrappers I would also increase the default buffer of the Util to saner 8k.&lt;/p&gt;</comment>
                            <comment id="14089672" author="sebb@apache.org" created="Thu, 7 Aug 2014 19:36:13 +0000"  >&lt;blockquote&gt;&lt;p&gt;NB: the &quot;use default when 0&quot; is even documented in the Javadoc, so this is a mandatory fix anyway.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The same fix must be applied to the copyReader function.&lt;/p&gt;</comment>
                            <comment id="14089674" author="sebb@apache.org" created="Thu, 7 Aug 2014 19:38:51 +0000"  >&lt;p&gt;Fix in &lt;a href=&quot;https://issues.apache.org/jira/browse/NET-496&quot; title=&quot;Util copyReader/copyStream classes should use default buffer size for non-positive buffer size parameters&quot; class=&quot;issue-link&quot; data-issue-key=&quot;NET-496&quot;&gt;&lt;del&gt;NET-496&lt;/del&gt;&lt;/a&gt; had correct Javadoc but used the wrong size check&lt;/p&gt;</comment>
                            <comment id="14089677" author="b.eckenfels" created="Thu, 7 Aug 2014 19:40:12 +0000"  >&lt;p&gt;New patch version, fixing copyStream and copyReader.&lt;/p&gt;</comment>
                            <comment id="14089704" author="b.eckenfels" created="Thu, 7 Aug 2014 19:53:53 +0000"  >&lt;p&gt;net-buffercopy-ext.patch: Version using 8k, avoiding double-buffering and fixing javadocs. (does not include &lt;a href=&quot;https://issues.apache.org/jira/browse/NET-551&quot; title=&quot;Util copyReader calls CopyStreamListener.bytesTransferred with the incorrect value for bytesTransferred&quot; class=&quot;issue-link&quot; data-issue-key=&quot;NET-551&quot;&gt;&lt;del&gt;NET-551&lt;/del&gt;&lt;/a&gt;)&lt;/p&gt;</comment>
                            <comment id="14089717" author="sebb@apache.org" created="Thu, 7 Aug 2014 20:02:28 +0000"  >&lt;p&gt;Please can we fix one problem at a time?&lt;/p&gt;

&lt;p&gt;The original issue was caused by the incorrect size check, which effectively caused the code to use a buffer size of 1.&lt;/p&gt;

&lt;p&gt;If the default buffer size is to be changed, that should be done in a separate JIRA.&lt;br/&gt;
Likewise changes to double buffering need a new JIRA.&lt;br/&gt;
Changes to Javadoc formatting are yet another item.&lt;/p&gt;</comment>
                            <comment id="14089738" author="b.eckenfels" created="Thu, 7 Aug 2014 20:12:27 +0000"  >&lt;p&gt;Sure, I am not going to commit into that project, anyway. Feel free to disect the patch.&lt;/p&gt;</comment>
                            <comment id="14089988" author="sebb@apache.org" created="Thu, 7 Aug 2014 22:53:21 +0000"  >&lt;p&gt;@Geoffrey Thanks for raising the issue; sorry it was originally closed as a duplicate.&lt;/p&gt;

&lt;p&gt;Fixed:&lt;/p&gt;

&lt;p&gt;URL: &lt;a href=&quot;http://svn.apache.org/r1616617&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1616617&lt;/a&gt;&lt;br/&gt;
Log:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/NET-550&quot; title=&quot;Default FTPClient bufferSize results in very slow retrieve transfers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;NET-550&quot;&gt;&lt;del&gt;NET-550&lt;/del&gt;&lt;/a&gt; Default FTPClient bufferSize results in very slow retrieve transfers&lt;br/&gt;
Fix code in Util#copyStream (also copyReader) that failed to use the proper default for buffer size 0&lt;/p&gt;

&lt;p&gt;Modified:&lt;br/&gt;
    commons/proper/net/trunk/src/changes/changes.xml&lt;br/&gt;
    commons/proper/net/trunk/src/main/java/org/apache/commons/net/io/Util.java&lt;br/&gt;
    commons/proper/net/trunk/src/test/java/org/apache/commons/net/util/UtilTest.java&lt;/p&gt;

&lt;p&gt;============&lt;/p&gt;

&lt;p&gt;Note: other potential changes raised in the comments have not been addressed.&lt;/p&gt;</comment>
                            <comment id="14532842" author="geoffhardy" created="Thu, 7 May 2015 15:20:15 +0000"  >&lt;p&gt;I commented on this issue in Aug 2014 that I didn&apos;t agree that it was a duplicate.  The problem is with the &lt;em&gt;default&lt;/em&gt; value of &lt;tt&gt;bufferSize&lt;/tt&gt;.  I&apos;m reopening this because the default value causes the library to be extremely inefficient.  There is a workaround-&lt;del&gt;to set the value of &lt;tt&gt;bufferSize&lt;/tt&gt; explicitly, but I think it should have a more reasonable default value&lt;/del&gt;-e.g., 4KB.&lt;/p&gt;</comment>
                            <comment id="14571789" author="sebb@apache.org" created="Wed, 3 Jun 2015 22:55:26 +0000"  >&lt;p&gt;The default is currently 1024. Is that really very inefficient?&lt;/p&gt;</comment>
                            <comment id="14613302" author="sebb@apache.org" created="Fri, 3 Jul 2015 16:40:22 +0000"  >&lt;p&gt;Unless there is strong evidence that the default of 1k is inadequate, there seems to be nothing left to do here.&lt;/p&gt;</comment>
                            <comment id="14615836" author="geoffhardy" created="Mon, 6 Jul 2015 23:04:04 +0000"  >&lt;p&gt;Oops, I think I must have misread the comments.  My post from 07/May/15 doesn&apos;t make sense.&lt;/p&gt;

&lt;p&gt;Thanks for addressing this issue.  &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="12680654">NET-519</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12628944">NET-496</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12660445" name="net-buffercopy-ext.patch" size="9670" author="b.eckenfels" created="Thu, 7 Aug 2014 19:53:53 +0000"/>
                            <attachment id="12660441" name="net-buffercopy.patch" size="2385" author="b.eckenfels" created="Thu, 7 Aug 2014 19:40:12 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>410610</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 19 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1yn7r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>410604</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>