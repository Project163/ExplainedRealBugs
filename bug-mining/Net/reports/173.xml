<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 20:45:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[NET-426] FTPS: Hook to customize _openDataConnection_ SSLSocket before startHandshake() is called</title>
                <link>https://issues.apache.org/jira/browse/NET-426</link>
                <project id="12310487" key="NET">Commons Net</project>
                    <description>&lt;p&gt;Currently in FTPSClient class, there is protected &lt;em&gt;openDataConnection&lt;/em&gt; method, which create SSLSocket for data connection.  But there is no hook to customize the SSLSocket before startHandshake is called.  &lt;/p&gt;

&lt;p&gt;I need to know the remote host ip and port, which i can get for socket, and do custom setup to try to reuse SSL sessions from control connection socket.  Since the socket factory uses createSocket() method, I can&apos;t just use custom socket factory since I don&apos;t know the host and port.  I can&apos;t just override the &lt;em&gt;openDataConnection&lt;/em&gt;() method in my class since that will call the startHandshake().  &lt;/p&gt;

&lt;p&gt;So it would be nice if you can provide hook, much like &lt;em&gt;connectAction&lt;/em&gt;(), but for data connection before handshake is started.  You can pass the new data socket as argument to this hook method so one can get remote host and port information.  &lt;/p&gt;</description>
                <environment></environment>
        <key id="12528405">NET-426</key>
            <summary>FTPS: Hook to customize _openDataConnection_ SSLSocket before startHandshake() is called</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="ktp420">Ketan</reporter>
                        <labels>
                    </labels>
                <created>Sun, 23 Oct 2011 03:26:51 +0000</created>
                <updated>Mon, 5 Dec 2016 20:07:50 +0000</updated>
                            <resolved>Sat, 18 Aug 2012 01:21:22 +0000</resolved>
                                    <version>3.0.1</version>
                                    <fixVersion>3.1</fixVersion>
                    <fixVersion>3.2</fixVersion>
                                    <component>FTP</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="3600">1h</timeoriginalestimate>
                            <timeestimate seconds="3600">1h</timeestimate>
                                        <comments>
                            <comment id="13133567" author="ktp420" created="Sun, 23 Oct 2011 03:38:50 +0000"  >&lt;p&gt;patch which adds &lt;em&gt;prepareDataSocket&lt;/em&gt;(Socket socket) method to FTPSClient.java&lt;/p&gt;

&lt;p&gt;Maybe this should be in FTPClient instead of FTPSClient.java&lt;/p&gt;</comment>
                            <comment id="13133605" author="dkocher@sudo.ch" created="Sun, 23 Oct 2011 10:11:16 +0000"  >&lt;p&gt;Do you have a workaround for &lt;a href=&quot;https://issues.apache.org/jira/browse/NET-408&quot; title=&quot;problem connecting to ProFTPD with FTPES&quot; class=&quot;issue-link&quot; data-issue-key=&quot;NET-408&quot;&gt;NET-408&lt;/a&gt; with this?&lt;/p&gt;</comment>
                            <comment id="13133688" author="ktp420" created="Sun, 23 Oct 2011 16:46:50 +0000"  >&lt;p&gt;Noting that can be used in production code...but for testing I am thinking of using reflection to add the SSLSession from control channel socket to JSSE provider&apos;s cache based on host and port.  If the SSLSession is added before handshake then session is resumed.&lt;/p&gt;

&lt;p&gt;I did simple test based on Sun and IBM JSSE providers and it seems to work.  Again not idea solution but gets around for my needs since I can&apos;t change the VSFTPD config which requires ssl resume on data channel.  &lt;/p&gt;</comment>
                            <comment id="13134437" author="dkocher@sudo.ch" created="Mon, 24 Oct 2011 20:11:48 +0000"  >&lt;p&gt;I would be interested to see this workaround using reflection if you can share.&lt;/p&gt;</comment>
                            <comment id="13135229" author="ktp420" created="Tue, 25 Oct 2011 16:55:37 +0000"  >&lt;p&gt;Here is code snippet I was playing with.  I had this executed before data connection handshake starting. Note this is for SunJSSE provider since I had Sun&apos;s JVM installed:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
	SSLSocket sslControlSocket = (SSLSocket) controlConnectionSocket;
	&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; host = &lt;span class=&quot;code-quote&quot;&gt;&quot;host.used.to.connect.to.data.socket&quot;&lt;/span&gt;;
	&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; port = dataPort; &lt;span class=&quot;code-comment&quot;&gt;// dataSocket.getPort();
&lt;/span&gt;	&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
		SSLSession sess = sslControlSocket.getSession();
		SSLSessionContext sessions = sess.getSessionContext();
		&lt;span class=&quot;code-comment&quot;&gt;// SunJSSE 1.6 specific code
&lt;/span&gt;		Field cache = sessions.getClass().getDeclaredField(
			&lt;span class=&quot;code-quote&quot;&gt;&quot;sessionHostPortCache&quot;&lt;/span&gt;);
		cache.setAccessible(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
		&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; c = cache.get(sessions);
		&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; key = (host + &lt;span class=&quot;code-quote&quot;&gt;&quot;:&quot;&lt;/span&gt; + &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.valueOf(port))
			.toLowerCase();
		&lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;?&amp;gt; cc = &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.forName(&lt;span class=&quot;code-quote&quot;&gt;&quot;sun.security.util.Cache&quot;&lt;/span&gt;);
&lt;/span&gt;		&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;?&amp;gt; cc = c.getClass();
		cc.getDeclaredMethod(&lt;span class=&quot;code-quote&quot;&gt;&quot;put&quot;&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.class, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.class).invoke(
				c, key, sess);
	} &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
		&lt;span class=&quot;code-comment&quot;&gt;// TODO Auto-generated &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; block
&lt;/span&gt;		e.printStackTrace();
	}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; </comment>
                            <comment id="13136189" author="dkocher@sudo.ch" created="Wed, 26 Oct 2011 18:19:11 +0000"  >&lt;p&gt;Thanks for the sample. Will give it a try as well. I suggest one could override #verifyRemote to do the injection in the cache.&lt;/p&gt;</comment>
                            <comment id="13136335" author="ktp420" created="Wed, 26 Oct 2011 20:41:12 +0000"  >&lt;p&gt;Yes, I am using verifyRemote right now as workaround.&lt;/p&gt;</comment>
                            <comment id="13429508" author="ktp420" created="Mon, 6 Aug 2012 22:24:52 +0000"  >&lt;p&gt;the  &lt;em&gt;prepareDataSocket&lt;/em&gt; method doesn&apos;t work for retrieving and storing file since these methods call org.apache.commons.net.ftp.FTPClient.&lt;em&gt;openDataConnection&lt;/em&gt;(String, String) method, which does not call &lt;em&gt;prepareDataSocket&lt;/em&gt; method.&lt;/p&gt;

&lt;p&gt;Can we get this fixed?  Without this you still get errors.&lt;/p&gt;

&lt;p&gt;Here are the methods that are calling org.apache.commons.net.ftp.FTPClient.&lt;em&gt;openDataConnection&lt;/em&gt;(String, String)&lt;/p&gt;

&lt;p&gt;org.apache.commons.net.ftp - commons-net.jar&lt;br/&gt;
&lt;em&gt;openDataConnection&lt;/em&gt;(int, String)&lt;br/&gt;
_retrieveFile(String, String, OutputStream)&lt;br/&gt;
_retrieveFileStream(String, String)&lt;br/&gt;
_storeFile(String, String, InputStream)&lt;br/&gt;
_storeFileStream(String, String)&lt;/p&gt;</comment>
                            <comment id="13429574" author="sebb@apache.org" created="Mon, 6 Aug 2012 23:33:36 +0000"  >&lt;p&gt;Can you provide a new patch?&lt;/p&gt;</comment>
                            <comment id="13431234" author="ktp420" created="Wed, 8 Aug 2012 17:30:07 +0000"  >&lt;p&gt;New patch to make FTPSClient work with retrieve and send command.&lt;/p&gt;</comment>
                            <comment id="13437203" author="sebb@apache.org" created="Sat, 18 Aug 2012 01:21:22 +0000"  >&lt;p&gt;Thanks for the patch, implemented in:&lt;/p&gt;

&lt;p&gt;URL: &lt;a href=&quot;http://svn.apache.org/viewvc?rev=1374495&amp;amp;view=rev&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?rev=1374495&amp;amp;view=rev&lt;/a&gt;&lt;br/&gt;
Log:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/NET-426&quot; title=&quot;FTPS: Hook to customize _openDataConnection_ SSLSocket before startHandshake() is called&quot; class=&quot;issue-link&quot; data-issue-key=&quot;NET-426&quot;&gt;&lt;del&gt;NET-426&lt;/del&gt;&lt;/a&gt; FTPS: Hook to customize &lt;em&gt;openDataConnection&lt;/em&gt; SSLSocket before startHandshake() is called&lt;br/&gt;
Properly interface with FTPClient.openDataConnection(String, String)&lt;/p&gt;

&lt;p&gt;Modified:&lt;br/&gt;
    commons/proper/net/trunk/src/changes/changes.xml&lt;br/&gt;
    commons/proper/net/trunk/src/main/java/org/apache/commons/net/ftp/FTPSClient.java&lt;/p&gt;

&lt;p&gt;I changed the implementation of &lt;em&gt;openDataConnection&lt;/em&gt;(int command, String arg) to directly call &lt;em&gt;openDataConnection&lt;/em&gt;(String command, String arg) in the current class, as it seemed clearer than bouncing via the parent.&lt;/p&gt;</comment>
                            <comment id="15284248" author="hauser@acm.org" created="Mon, 16 May 2016 08:04:05 +0000"  >&lt;p&gt;with commons-net 3.3 it only worked, once I &lt;br/&gt;
&lt;a href=&quot;http://stackoverflow.com/questions/32398754/how-to-connect-to-ftps-server-with-data-connection-using-same-tls-session&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://stackoverflow.com/questions/32398754/how-to-connect-to-ftps-server-with-data-connection-using-same-tls-session&lt;/a&gt;&lt;br/&gt;
had problems to get preferences in the cyberduck example, but if I set always to &quot;true&quot; got it working.&lt;/p&gt;

&lt;p&gt;Even better if you store the session not only under the key based on &lt;br/&gt;
socket.getInetAddress().getHostName()&lt;br/&gt;
but also a second time under&lt;br/&gt;
socket.getInetAddress().getHostAddress()&lt;/p&gt;</comment>
                            <comment id="15723232" author="b.eckenfels" created="Mon, 5 Dec 2016 20:07:50 +0000"  >&lt;p&gt;BTW: I am discussing this Java JSSE shortcoming on OpenJDK security-dev here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://mail.openjdk.java.net/pipermail/security-dev/2016-December/015252.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://mail.openjdk.java.net/pipermail/security-dev/2016-December/015252.html&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12507562">NET-408</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12539894" name="FTPSClient.patch" size="2157" author="ktp420" created="Wed, 8 Aug 2012 17:30:07 +0000"/>
                            <attachment id="12500353" name="FTPSClient.patch" size="794" author="ktp420" created="Sun, 23 Oct 2011 03:38:50 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>214265</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 49 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0j0nz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>109036</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>