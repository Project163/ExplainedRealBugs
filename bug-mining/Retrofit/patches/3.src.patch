diff --git a/retrofit/pom.xml b/retrofit/pom.xml
index c7e5701e..2fe05241 100644
--- a/retrofit/pom.xml
+++ b/retrofit/pom.xml
@@ -52,6 +52,11 @@
       <artifactId>mockito-core</artifactId>
       <scope>test</scope>
     </dependency>
+    <dependency>
+      <groupId>com.google.guava</groupId>
+      <artifactId>guava</artifactId>
+      <scope>test</scope>
+    </dependency>
   </dependencies>
 
   <build>
diff --git a/retrofit/src/main/java/retrofit/http/Converter.java b/retrofit/src/main/java/retrofit/http/Converter.java
index e103f0e1..188a6efe 100644
--- a/retrofit/src/main/java/retrofit/http/Converter.java
+++ b/retrofit/src/main/java/retrofit/http/Converter.java
@@ -2,7 +2,8 @@
 package retrofit.http;
 
 import java.lang.reflect.Type;
-import retrofit.io.TypedBytes;
+import retrofit.io.TypedInput;
+import retrofit.io.TypedOutput;
 
 /**
  * Arbiter for converting objects to and from their representation in HTTP.
@@ -19,7 +20,7 @@ public interface Converter {
    * @throws ConversionException If conversion was unable to complete. This will trigger a call to
    * {@link Callback#failure(RetrofitError)} or throw a {@link retrofit.http.RetrofitError}.
    */
-  Object fromBody(byte[] body, Type type) throws ConversionException;
+  Object fromBody(TypedInput body, Type type) throws ConversionException;
 
   /**
    * Convert and object to an appropriate representation for HTTP transport.
@@ -27,5 +28,5 @@ public interface Converter {
    * @param object Object instance to convert.
    * @return Representation of the specified object as bytes.
    */
-  TypedBytes toBody(Object object);
+  TypedOutput toBody(Object object);
 }
diff --git a/retrofit/src/main/java/retrofit/http/GsonConverter.java b/retrofit/src/main/java/retrofit/http/GsonConverter.java
index d5b82978..d8f839d6 100644
--- a/retrofit/src/main/java/retrofit/http/GsonConverter.java
+++ b/retrofit/src/main/java/retrofit/http/GsonConverter.java
@@ -3,13 +3,13 @@ package retrofit.http;
 
 import com.google.gson.Gson;
 import com.google.gson.JsonParseException;
-import java.io.ByteArrayInputStream;
 import java.io.IOException;
 import java.io.InputStreamReader;
 import java.io.OutputStream;
 import java.io.UnsupportedEncodingException;
 import java.lang.reflect.Type;
-import retrofit.io.TypedBytes;
+import retrofit.io.TypedInput;
+import retrofit.io.TypedOutput;
 
 import static retrofit.http.RestAdapter.UTF_8;
 
@@ -25,29 +25,37 @@ public class GsonConverter implements Converter {
     this.gson = gson;
   }
 
-  @Override public Object fromBody(byte[] body, Type type) throws ConversionException {
+  @Override public Object fromBody(TypedInput body, Type type) throws ConversionException {
+    InputStreamReader isr = null;
     try {
-      InputStreamReader isr = new InputStreamReader(new ByteArrayInputStream(body), UTF_8);
+      isr = new InputStreamReader(body.in(), UTF_8);
       return gson.fromJson(isr, type);
     } catch (IOException e) {
       throw new ConversionException(e);
     } catch (JsonParseException e) {
       throw new ConversionException(e);
+    } finally {
+      if (isr != null) {
+        try {
+          isr.close();
+        } catch (IOException ignored) {
+        }
+      }
     }
   }
 
-  @Override public TypedBytes toBody(Object object) {
+  @Override public TypedOutput toBody(Object object) {
     try {
-      return new JsonTypedBytes(gson.toJson(object).getBytes(UTF_8));
+      return new JsonTypedOutput(gson.toJson(object).getBytes(UTF_8));
     } catch (UnsupportedEncodingException e) {
       throw new AssertionError(e);
     }
   }
 
-  static class JsonTypedBytes implements TypedBytes {
-    final byte[] jsonBytes;
+  static class JsonTypedOutput implements TypedOutput {
+    private final byte[] jsonBytes;
 
-    JsonTypedBytes(byte[] jsonBytes) {
+    JsonTypedOutput(byte[] jsonBytes) {
       this.jsonBytes = jsonBytes;
     }
 
@@ -55,7 +63,7 @@ public class GsonConverter implements Converter {
       return "application/json; charset=UTF-8";
     }
 
-    @Override public int length() {
+    @Override public long length() {
       return jsonBytes.length;
     }
 
diff --git a/retrofit/src/main/java/retrofit/http/RequestBuilder.java b/retrofit/src/main/java/retrofit/http/RequestBuilder.java
index 2d95f4c7..3bc060c2 100644
--- a/retrofit/src/main/java/retrofit/http/RequestBuilder.java
+++ b/retrofit/src/main/java/retrofit/http/RequestBuilder.java
@@ -10,8 +10,8 @@ import java.util.List;
 import java.util.Map;
 import java.util.Set;
 import retrofit.http.client.Request;
-import retrofit.io.StringTypedBytes;
-import retrofit.io.TypedBytes;
+import retrofit.io.TypedOutput;
+import retrofit.io.TypedString;
 
 import static retrofit.http.RestAdapter.UTF_8;
 import static retrofit.http.RestMethodInfo.NO_SINGLE_ENTITY;
@@ -124,8 +124,8 @@ final class RequestBuilder {
     }
     url.append(replacedPath);
 
-    TypedBytes body = null;
-    Map<String, TypedBytes> bodyParams = new LinkedHashMap<String, TypedBytes>();
+    TypedOutput body = null;
+    Map<String, TypedOutput> bodyParams = new LinkedHashMap<String, TypedOutput>();
     if (!methodInfo.restMethod.hasBody()) {
       for (int i = 0, count = paramList.size(); i < count; i++) {
         url.append((i == 0) ? '?' : '&');
@@ -136,21 +136,21 @@ final class RequestBuilder {
       if (methodInfo.isMultipart) {
         for (Parameter parameter : paramList) {
           Object value = parameter.getValue();
-          TypedBytes typedBytes;
-          if (value instanceof TypedBytes) {
-            typedBytes = (TypedBytes) value;
+          TypedOutput typedOutput;
+          if (value instanceof TypedOutput) {
+            typedOutput = (TypedOutput) value;
           } else {
-            typedBytes = new StringTypedBytes(value.toString());
+            typedOutput = new TypedString(value.toString());
           }
-          bodyParams.put(parameter.getName(), typedBytes);
+          bodyParams.put(parameter.getName(), typedOutput);
         }
       } else {
         body = converter.toBody(paramList);
       }
     } else if (methodInfo.singleEntityArgumentIndex != NO_SINGLE_ENTITY) {
       Object singleEntity = args[methodInfo.singleEntityArgumentIndex];
-      if (singleEntity instanceof TypedBytes) {
-        body = (TypedBytes) singleEntity;
+      if (singleEntity instanceof TypedOutput) {
+        body = (TypedOutput) singleEntity;
       } else {
         body = converter.toBody(singleEntity);
       }
diff --git a/retrofit/src/main/java/retrofit/http/RestAdapter.java b/retrofit/src/main/java/retrofit/http/RestAdapter.java
index 4b22c7f9..c0611cfa 100644
--- a/retrofit/src/main/java/retrofit/http/RestAdapter.java
+++ b/retrofit/src/main/java/retrofit/http/RestAdapter.java
@@ -2,7 +2,6 @@
 package retrofit.http;
 
 import java.io.IOException;
-import java.io.UnsupportedEncodingException;
 import java.lang.reflect.InvocationHandler;
 import java.lang.reflect.InvocationTargetException;
 import java.lang.reflect.Method;
@@ -21,7 +20,9 @@ import retrofit.http.Profiler.RequestInformation;
 import retrofit.http.client.Client;
 import retrofit.http.client.Request;
 import retrofit.http.client.Response;
-import retrofit.io.TypedBytes;
+import retrofit.io.TypedByteArray;
+import retrofit.io.TypedInput;
+import retrofit.io.TypedOutput;
 
 import static retrofit.http.Utils.SynchronousExecutor;
 
@@ -175,9 +176,10 @@ public class RestAdapter {
           profiler.afterCall(requestInfo, elapsedTime, statusCode, profilerObject);
         }
 
-        byte[] body = response.getBody();
+        TypedInput body = response.getBody();
         if (LOGGER.isLoggable(Level.FINE)) {
-          logResponseBody(url, body, statusCode, elapsedTime);
+          // Replace the response since the logger needs to consume the entire input stream.
+          body = logResponseBody(url, response.getStatus(), body, elapsedTime);
         }
 
         List<Header> headers = response.getHeaders();
@@ -213,15 +215,22 @@ public class RestAdapter {
     }
   }
 
-  private static void logResponseBody(String url, byte[] body, int statusCode, long elapsedTime)
-      throws UnsupportedEncodingException {
+  /** Log response data. Returns replacement {@link TypedInput}. */
+  private static TypedInput logResponseBody(String url, int statusCode, TypedInput body,
+      long elapsedTime) throws IOException {
     LOGGER.fine("---- HTTP " + statusCode + " from " + url + " (" + elapsedTime + "ms)");
-    String bodyString = new String(body, UTF_8);
-    for (int i = 0; i < body.length; i += LOG_CHUNK_SIZE) {
+
+    byte[] bodyBytes = Utils.streamToBytes(body.in());
+    String bodyString = new String(bodyBytes, UTF_8);
+    for (int i = 0; i < bodyString.length(); i += LOG_CHUNK_SIZE) {
       int end = Math.min(bodyString.length(), i + LOG_CHUNK_SIZE);
       LOGGER.fine(bodyString.substring(i, end));
     }
+
     LOGGER.fine("---- END HTTP");
+
+    // Since we consumed the entire input stream, return a new, identical one from its bytes.
+    return new TypedByteArray(body.mimeType(), bodyBytes);
   }
 
   private static Profiler.RequestInformation getRequestInfo(Server server,
@@ -229,7 +238,7 @@ public class RestAdapter {
     long contentLength = 0;
     String contentType = null;
 
-    TypedBytes body = request.getBody();
+    TypedOutput body = request.getBody();
     if (body != null) {
       contentLength = body.length();
       contentType = body.mimeType();
diff --git a/retrofit/src/main/java/retrofit/http/RestMethodInfo.java b/retrofit/src/main/java/retrofit/http/RestMethodInfo.java
index 463c2b0d..7551a732 100644
--- a/retrofit/src/main/java/retrofit/http/RestMethodInfo.java
+++ b/retrofit/src/main/java/retrofit/http/RestMethodInfo.java
@@ -11,7 +11,7 @@ import java.util.Set;
 import java.util.regex.Matcher;
 import java.util.regex.Pattern;
 import javax.inject.Named;
-import retrofit.io.TypedBytes;
+import retrofit.io.TypedOutput;
 
 /** Cached details about an interface method. */
 final class RestMethodInfo {
@@ -187,8 +187,8 @@ final class RestMethodInfo {
           String name = ((Named) parameterAnnotation).value();
           namedParams[i] = name;
           boolean isPathParam = pathParams.contains(name);
-          if (parameterType == TypedBytes.class && (isPathParam || !restMethod.hasBody())) {
-            throw new IllegalStateException("TypedBytes cannot be used as URL parameter.");
+          if (parameterType == TypedOutput.class && (isPathParam || !restMethod.hasBody())) {
+            throw new IllegalStateException("TypedOutput cannot be used as URL parameter.");
           }
           if (!isPathParam && !isMultipart && restMethod.hasBody()) {
             throw new IllegalStateException(
@@ -220,7 +220,7 @@ final class RestMethodInfo {
     }
     if (!restMethod.hasBody() && (isMultipart || singleEntityArgumentIndex != NO_SINGLE_ENTITY)) {
       throw new IllegalStateException(
-          "Non-body HTTP method cannot contain @SingleEntity or @TypedBytes.");
+          "Non-body HTTP method cannot contain @SingleEntity or @TypedOutput.");
     }
     this.namedParams = namedParams;
   }
diff --git a/retrofit/src/main/java/retrofit/http/RetrofitError.java b/retrofit/src/main/java/retrofit/http/RetrofitError.java
index 10d8d572..c9e26149 100644
--- a/retrofit/src/main/java/retrofit/http/RetrofitError.java
+++ b/retrofit/src/main/java/retrofit/http/RetrofitError.java
@@ -4,6 +4,7 @@ package retrofit.http;
 import java.io.IOException;
 import java.lang.reflect.Type;
 import retrofit.http.client.Response;
+import retrofit.io.TypedInput;
 
 public class RetrofitError extends RuntimeException {
   static RetrofitError networkError(String url, IOException exception) {
@@ -61,7 +62,7 @@ public class RetrofitError extends RuntimeException {
    * the generic type of the supplied {@link Callback} parameter.
    */
   public Object getBody() {
-    byte[] body = response.getBody();
+    TypedInput body = response.getBody();
     if (body == null) {
       return null;
     }
@@ -74,7 +75,7 @@ public class RetrofitError extends RuntimeException {
 
   /** HTTP response body converted to specified {@code type}. */
   public Object getBodyAs(Type type) {
-    byte[] body = response.getBody();
+    TypedInput body = response.getBody();
     if (body == null) {
       return null;
     }
diff --git a/retrofit/src/main/java/retrofit/http/SingleEntity.java b/retrofit/src/main/java/retrofit/http/SingleEntity.java
index 445ccb37..aa714785 100644
--- a/retrofit/src/main/java/retrofit/http/SingleEntity.java
+++ b/retrofit/src/main/java/retrofit/http/SingleEntity.java
@@ -4,8 +4,8 @@ package retrofit.http;
 /**
  * Use this annotation on a service method param when you want to directly control the request body
  * of a POST/PUT request (instead of sending in as request parameters or form-style request
- * body).  If the value of the parameter implements TypedBytes, the request body will be written
- * exactly as specified by the TypedBytes.writeTo object.  If it doesn't implement TypedBytes, the
+ * body).  If the value of the parameter implements TypedOutput, the request body will be written
+ * exactly as specified by the TypedOutput.writeTo object.  If it doesn't implement TypedOutput, the
  * object will be serialized into JSON and the result will be set directly as the request body.
  *
  * @author Eric Denman (edenman@squareup.com)
diff --git a/retrofit/src/main/java/retrofit/http/Utils.java b/retrofit/src/main/java/retrofit/http/Utils.java
index 2c01ac81..c5d89a64 100644
--- a/retrofit/src/main/java/retrofit/http/Utils.java
+++ b/retrofit/src/main/java/retrofit/http/Utils.java
@@ -1,6 +1,10 @@
 // Copyright 2012 Square, Inc.
+// Copyright 2007 The Guava Authors
 package retrofit.http;
 
+import java.io.ByteArrayOutputStream;
+import java.io.IOException;
+import java.io.InputStream;
 import java.lang.reflect.Type;
 import java.util.concurrent.Executor;
 import java.util.regex.Matcher;
@@ -11,6 +15,25 @@ import static retrofit.http.RestAdapter.UTF_8;
 
 final class Utils {
   private static final Pattern CHARSET = Pattern.compile("\\Wcharset=([^\\s;]+)", CASE_INSENSITIVE);
+  private static final int BUFFER_SIZE = 0x1000;
+
+  /**
+   * Creates a {@code byte[]} from reading the entirety of an {@link InputStream}. May return an
+   * empty array but never {@code null}.
+   * <p>
+   * Copied from Guava's {@code ByteStreams} class.
+   */
+  static byte[] streamToBytes(InputStream stream) throws IOException {
+    ByteArrayOutputStream baos = new ByteArrayOutputStream();
+    if (stream != null) {
+      byte[] buf = new byte[BUFFER_SIZE];
+      int r;
+      while ((r = stream.read(buf)) != -1) {
+        baos.write(buf, 0, r);
+      }
+    }
+    return baos.toByteArray();
+  }
 
   /**
    * Returns the generic supertype for {@code supertype}. For example, given a class
@@ -52,8 +75,8 @@ final class Utils {
     return toResolve;
   }
 
-  static String parseCharset(String headerValue) {
-    Matcher match = CHARSET.matcher(headerValue);
+  static String parseCharset(String mimeType) {
+    Matcher match = CHARSET.matcher(mimeType);
     if (match.find()) {
       return match.group(1).replaceAll("[\"\\\\]", "");
     }
diff --git a/retrofit/src/main/java/retrofit/http/client/ApacheClient.java b/retrofit/src/main/java/retrofit/http/client/ApacheClient.java
index 1d8eaac4..c4d1b348 100644
--- a/retrofit/src/main/java/retrofit/http/client/ApacheClient.java
+++ b/retrofit/src/main/java/retrofit/http/client/ApacheClient.java
@@ -24,12 +24,15 @@ import org.apache.http.impl.client.DefaultHttpClient;
 import org.apache.http.message.BasicHeader;
 import org.apache.http.util.EntityUtils;
 import retrofit.http.Header;
-import retrofit.io.TypedBytes;
+import retrofit.io.TypedByteArray;
+import retrofit.io.TypedOutput;
 
 import static org.apache.http.entity.mime.HttpMultipartMode.BROWSER_COMPATIBLE;
 
 /** A {@link Client} which uses an implementation of Apache's {@link HttpClient}. */
 public class ApacheClient implements Client {
+  private static final String HEADER_CONTENT_TYPE = "Content-Type";
+
   private final HttpClient client;
 
   /** Creates an instance backed by {@link DefaultHttpClient}. */
@@ -71,14 +74,21 @@ public class ApacheClient implements Client {
     String reason = statusLine.getReasonPhrase();
 
     List<Header> headers = new ArrayList<Header>();
+    String contentType = "application/octet-stream";
     for (org.apache.http.Header header : response.getAllHeaders()) {
-      headers.add(new Header(header.getName(), header.getValue()));
+      String name = header.getName();
+      String value = header.getValue();
+      if (name.equalsIgnoreCase(HEADER_CONTENT_TYPE)) {
+        contentType = value;
+      }
+      headers.add(new Header(name, value));
     }
 
-    byte[] body = null;
+    TypedByteArray body = null;
     HttpEntity entity = response.getEntity();
     if (entity != null) {
-      body = EntityUtils.toByteArray(entity);
+      byte[] bytes = EntityUtils.toByteArray(entity);
+      body = new TypedByteArray(contentType, bytes);
     }
 
     return new Response(status, reason, headers, body);
@@ -99,17 +109,16 @@ public class ApacheClient implements Client {
 
       // Add the content body, if any.
       if (!request.isMultipart()) {
-        TypedBytes body = request.getBody();
+        TypedOutput body = request.getBody();
         if (body != null) {
-          setEntity(new TypedBytesEntity(body));
+          setEntity(new TypedOutputEntity(body));
         }
       } else {
-        Map<String, TypedBytes> bodyParameters = request.getBodyParameters();
+        Map<String, TypedOutput> bodyParameters = request.getBodyParameters();
         if (bodyParameters != null && !bodyParameters.isEmpty()) {
           MultipartEntity entity = new MultipartEntity(BROWSER_COMPATIBLE);
-          for (Map.Entry<String, TypedBytes> entry : bodyParameters.entrySet()) {
-            String key = entry.getKey();
-            entity.addPart(key, new TypedBytesBody(entry.getValue(), key));
+          for (Map.Entry<String, TypedOutput> entry : bodyParameters.entrySet()) {
+            entity.addPart(entry.getKey(), new TypedOutputBody(entry.getValue()));
           }
           setEntity(entity);
         }
@@ -121,11 +130,11 @@ public class ApacheClient implements Client {
     }
   }
 
-  /** Adapts ContentBody to TypedBytes. */
-  private static class TypedBytesBody extends AbstractContentBody {
-    private final TypedBytes typedBytes;
+  /** Adapts {@link org.apache.http.entity.mime.content.ContentBody} to {@link TypedOutput}. */
+  private static class TypedOutputBody extends AbstractContentBody {
+    private final TypedOutput typedBytes;
 
-    TypedBytesBody(TypedBytes typedBytes, String baseName) {
+    TypedOutputBody(TypedOutput typedBytes) {
       super(typedBytes.mimeType());
       this.typedBytes = typedBytes;
     }
@@ -157,13 +166,13 @@ public class ApacheClient implements Client {
     }
   }
 
-  /** Container class for passing an entire {@link TypedBytes} as an HTTP request. */
-  static class TypedBytesEntity extends AbstractHttpEntity {
-    private final TypedBytes typedBytes;
+  /** Container class for passing an entire {@link TypedOutput} as an {@link HttpEntity}. */
+  static class TypedOutputEntity extends AbstractHttpEntity {
+    private final TypedOutput typedOutput;
 
-    TypedBytesEntity(TypedBytes typedBytes) {
-      this.typedBytes = typedBytes;
-      setContentType(typedBytes.mimeType());
+    TypedOutputEntity(TypedOutput typedOutput) {
+      this.typedOutput = typedOutput;
+      setContentType(typedOutput.mimeType());
     }
 
     @Override public boolean isRepeatable() {
@@ -171,17 +180,17 @@ public class ApacheClient implements Client {
     }
 
     @Override public long getContentLength() {
-      return typedBytes.length();
+      return typedOutput.length();
     }
 
     @Override public InputStream getContent() throws IOException {
       ByteArrayOutputStream out = new ByteArrayOutputStream();
-      typedBytes.writeTo(out);
+      typedOutput.writeTo(out);
       return new ByteArrayInputStream(out.toByteArray());
     }
 
     @Override public void writeTo(OutputStream out) throws IOException {
-      typedBytes.writeTo(out);
+      typedOutput.writeTo(out);
     }
 
     @Override public boolean isStreaming() {
diff --git a/retrofit/src/main/java/retrofit/http/client/Request.java b/retrofit/src/main/java/retrofit/http/client/Request.java
index a8d85a6c..aea5ab5c 100644
--- a/retrofit/src/main/java/retrofit/http/client/Request.java
+++ b/retrofit/src/main/java/retrofit/http/client/Request.java
@@ -4,7 +4,7 @@ import java.util.Collections;
 import java.util.List;
 import java.util.Map;
 import retrofit.http.Header;
-import retrofit.io.TypedBytes;
+import retrofit.io.TypedOutput;
 
 /** Encapsulates all of the information necessary to make an HTTP request. */
 public final class Request {
@@ -12,11 +12,11 @@ public final class Request {
   private final String url;
   private final List<Header> headers;
   private final boolean isMultipart;
-  private final TypedBytes body;
-  private Map<String, TypedBytes> bodyParameters;
+  private final TypedOutput body;
+  private Map<String, TypedOutput> bodyParameters;
 
   public Request(String method, String url, List<Header> headers, boolean isMultipart,
-      TypedBytes body, Map<String, TypedBytes> bodyParameters) {
+      TypedOutput body, Map<String, TypedOutput> bodyParameters) {
     if (method == null) {
       throw new NullPointerException("Method must not be null.");
     }
@@ -65,12 +65,12 @@ public final class Request {
    * Returns the request body for non-multipart requests, or {@code null} if the request has no
    * body.
    */
-  public TypedBytes getBody() {
+  public TypedOutput getBody() {
     return body;
   }
 
   /** Unmodifiable map of additional body parameters for multipart requests. */
-  public Map<String, TypedBytes> getBodyParameters() {
+  public Map<String, TypedOutput> getBodyParameters() {
     return bodyParameters;
   }
 }
diff --git a/retrofit/src/main/java/retrofit/http/client/Response.java b/retrofit/src/main/java/retrofit/http/client/Response.java
index 247dd175..326a3fea 100644
--- a/retrofit/src/main/java/retrofit/http/client/Response.java
+++ b/retrofit/src/main/java/retrofit/http/client/Response.java
@@ -5,15 +5,16 @@ import java.util.ArrayList;
 import java.util.Collections;
 import java.util.List;
 import retrofit.http.Header;
+import retrofit.io.TypedInput;
 
 /** An HTTP response. */
 public final class Response {
   private final int status;
   private final String reason;
   private final List<Header> headers;
-  private final byte[] body;
+  private final TypedInput body;
 
-  public Response(int status, String reason, List<Header> headers, byte[] body) {
+  public Response(int status, String reason, List<Header> headers, TypedInput body) {
     if (status < 200) {
       throw new IllegalArgumentException("Invalid status code: " + status);
     }
@@ -46,7 +47,7 @@ public final class Response {
   }
 
   /** Response body. May be {@code null}. */
-  public byte[] getBody() {
+  public TypedInput getBody() {
     return body;
   }
 }
diff --git a/retrofit/src/main/java/retrofit/http/client/Streams.java b/retrofit/src/main/java/retrofit/http/client/Streams.java
deleted file mode 100644
index f9a8abf8..00000000
--- a/retrofit/src/main/java/retrofit/http/client/Streams.java
+++ /dev/null
@@ -1,41 +0,0 @@
-/*
- * Copyright (C) 2007 The Guava Authors
- *
- * Licensed under the Apache License, Version 2.0 (the "License");
- * you may not use this file except in compliance with the License.
- * You may obtain a copy of the License at
- *
- * http://www.apache.org/licenses/LICENSE-2.0
- *
- * Unless required by applicable law or agreed to in writing, software
- * distributed under the License is distributed on an "AS IS" BASIS,
- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- * See the License for the specific language governing permissions and
- * limitations under the License.
- */
-package retrofit.http.client;
-
-import java.io.ByteArrayOutputStream;
-import java.io.IOException;
-import java.io.InputStream;
-
-/** Utility methods for working with streams. */
-class Streams {
-  private static final int BUFFER_SIZE = 0x1000;
-
-  /**
-   * Creates a {@code byte[]} from reading the entirety of an {@link InputStream}. May return an
-   * empty array but never {@code null}.
-   */
-  static byte[] readFully(InputStream stream) throws IOException {
-    ByteArrayOutputStream baos = new ByteArrayOutputStream();
-    if (stream != null) {
-      byte[] buf = new byte[BUFFER_SIZE];
-      int r;
-      while ((r = stream.read(buf)) != -1) {
-        baos.write(buf, 0, r);
-      }
-    }
-    return baos.toByteArray();
-  }
-}
diff --git a/retrofit/src/main/java/retrofit/http/client/TypedInputStream.java b/retrofit/src/main/java/retrofit/http/client/TypedInputStream.java
new file mode 100644
index 00000000..2d7d728d
--- /dev/null
+++ b/retrofit/src/main/java/retrofit/http/client/TypedInputStream.java
@@ -0,0 +1,21 @@
+// Copyright 2013 Square, Inc.
+package retrofit.http.client;
+
+import java.io.IOException;
+import java.io.InputStream;
+import retrofit.io.TypedInput;
+
+public class TypedInputStream implements TypedInput {
+
+  @Override public String mimeType() {
+    return null;
+  }
+
+  @Override public long length() {
+    return 0;
+  }
+
+  @Override public InputStream in() throws IOException {
+    return null;
+  }
+}
diff --git a/retrofit/src/main/java/retrofit/io/AbstractTypedBytes.java b/retrofit/src/main/java/retrofit/io/AbstractTypedBytes.java
deleted file mode 100644
index 942245af..00000000
--- a/retrofit/src/main/java/retrofit/io/AbstractTypedBytes.java
+++ /dev/null
@@ -1,28 +0,0 @@
-// Copyright 2010 Square, Inc.
-package retrofit.io;
-
-/**
- * Support for Typed values.
- *
- * @author Bob Lee (bob@squareup.com)
- */
-public abstract class AbstractTypedBytes implements TypedBytes {
-  private final String mimeType;
-
-  /**
-   * Stores the mime type.
-   *
-   * @throws NullPointerException if mimeType is null
-   */
-  public AbstractTypedBytes(String mimeType) {
-    if (mimeType == null) throw new NullPointerException("mimeType");
-    this.mimeType = mimeType;
-  }
-
-  public String mimeType() {
-    return mimeType;
-  }
-
-  /** Returns the length in bytes. */
-  public abstract int length();
-}
\ No newline at end of file
diff --git a/retrofit/src/main/java/retrofit/io/StringTypedBytes.java b/retrofit/src/main/java/retrofit/io/StringTypedBytes.java
deleted file mode 100644
index 255a65a1..00000000
--- a/retrofit/src/main/java/retrofit/io/StringTypedBytes.java
+++ /dev/null
@@ -1,27 +0,0 @@
-// Copyright 2013 Square, Inc.
-package retrofit.io;
-
-import java.io.IOException;
-import java.io.OutputStream;
-import java.io.UnsupportedEncodingException;
-
-public class StringTypedBytes extends AbstractTypedBytes {
-  private final byte[] bytes;
-
-  public StringTypedBytes(String string) {
-    super("text/plain; charset=UTF-8");
-    try {
-      bytes = string.getBytes("UTF-8");
-    } catch (UnsupportedEncodingException e) {
-      throw new AssertionError(e);
-    }
-  }
-
-  @Override public int length() {
-    return bytes.length;
-  }
-
-  @Override public void writeTo(OutputStream out) throws IOException {
-    out.write(bytes);
-  }
-}
diff --git a/retrofit/src/main/java/retrofit/io/TypedByteArray.java b/retrofit/src/main/java/retrofit/io/TypedByteArray.java
index 35619705..b56f63fd 100644
--- a/retrofit/src/main/java/retrofit/io/TypedByteArray.java
+++ b/retrofit/src/main/java/retrofit/io/TypedByteArray.java
@@ -1,7 +1,9 @@
 // Copyright 2010 Square, Inc.
 package retrofit.io;
 
+import java.io.ByteArrayInputStream;
 import java.io.IOException;
+import java.io.InputStream;
 import java.io.OutputStream;
 import java.util.Arrays;
 
@@ -10,7 +12,8 @@ import java.util.Arrays;
  *
  * @author Bob Lee (bob@squareup.com)
  */
-public class TypedByteArray extends AbstractTypedBytes {
+public class TypedByteArray implements TypedInput, TypedOutput {
+  private final String mimeType;
   private final byte[] bytes;
 
   /**
@@ -18,31 +21,52 @@ public class TypedByteArray extends AbstractTypedBytes {
    *
    * @throws NullPointerException if bytes or mimeType is null
    */
-  public TypedByteArray(byte[] bytes, String mimeType) {
-    super(mimeType);
-    if (bytes == null) throw new NullPointerException("bytes");
+  public TypedByteArray(String mimeType, byte[] bytes) {
+    if (mimeType == null) {
+      throw new NullPointerException("mimeType");
+    }
+    if (bytes == null) {
+      throw new NullPointerException("bytes");
+    }
+    this.mimeType = mimeType;
     this.bytes = bytes;
   }
 
-  public void writeTo(OutputStream out) throws IOException {
-    out.write(bytes);
+  public byte[] getBytes() {
+    return bytes;
   }
 
-  @Override public int length() {
+  @Override public String mimeType() {
+    return mimeType;
+  }
+
+  @Override public long length() {
     return bytes.length;
   }
 
+  @Override public void writeTo(OutputStream out) throws IOException {
+    out.write(bytes);
+  }
+
+  @Override public InputStream in() throws IOException {
+    return new ByteArrayInputStream(bytes);
+  }
+
   @Override public boolean equals(Object o) {
     if (this == o) return true;
+    if (o == null || getClass() != o.getClass()) return false;
 
-    if (o instanceof TypedByteArray) {
-      TypedByteArray rhs = (TypedByteArray) o;
-      return Arrays.equals(bytes, rhs.bytes);
-    }
-    return false;
+    TypedByteArray that = (TypedByteArray) o;
+
+    if (!Arrays.equals(bytes, that.bytes)) return false;
+    if (!mimeType.equals(that.mimeType)) return false;
+
+    return true;
   }
 
   @Override public int hashCode() {
-    return Arrays.hashCode(bytes);
+    int result = mimeType.hashCode();
+    result = 31 * result + Arrays.hashCode(bytes);
+    return result;
   }
 }
\ No newline at end of file
diff --git a/retrofit/src/main/java/retrofit/io/TypedFile.java b/retrofit/src/main/java/retrofit/io/TypedFile.java
index 2e79b515..c9ffbcda 100644
--- a/retrofit/src/main/java/retrofit/io/TypedFile.java
+++ b/retrofit/src/main/java/retrofit/io/TypedFile.java
@@ -4,6 +4,7 @@ package retrofit.io;
 import java.io.File;
 import java.io.FileInputStream;
 import java.io.IOException;
+import java.io.InputStream;
 import java.io.OutputStream;
 
 /**
@@ -11,7 +12,10 @@ import java.io.OutputStream;
  *
  * @author Bob Lee (bob@squareup.com)
  */
-public class TypedFile extends AbstractTypedBytes {
+public class TypedFile implements TypedInput, TypedOutput {
+  private static final int BUFFER_SIZE = 4096;
+
+  private final String mimeType;
   private final File file;
 
   /**
@@ -19,9 +23,14 @@ public class TypedFile extends AbstractTypedBytes {
    *
    * @throws NullPointerException if file or mimeType is null
    */
-  public TypedFile(File file, String mimeType) {
-    super(mimeType);
-    if (file == null) throw new NullPointerException("file");
+  public TypedFile(String mimeType, File file) {
+    if (mimeType == null) {
+      throw new NullPointerException("mimeType");
+    }
+    if (file == null) {
+      throw new NullPointerException("file");
+    }
+    this.mimeType = mimeType;
     this.file = file;
   }
 
@@ -30,8 +39,20 @@ public class TypedFile extends AbstractTypedBytes {
     return file;
   }
 
-  public void writeTo(OutputStream out) throws IOException {
-    byte[] buffer = new byte[4096];
+  @Override public String mimeType() {
+    return mimeType;
+  }
+
+  @Override public long length() {
+    return file.length();
+  }
+
+  @Override public InputStream in() throws IOException {
+    return new FileInputStream(file);
+  }
+
+  @Override public void writeTo(OutputStream out) throws IOException {
+    byte[] buffer = new byte[BUFFER_SIZE];
     FileInputStream in = new FileInputStream(file);
     try {
       int read;
@@ -74,8 +95,4 @@ public class TypedFile extends AbstractTypedBytes {
   @Override public int hashCode() {
     return file.hashCode();
   }
-
-  @Override public int length() {
-    return (int) file.length();
-  }
 }
diff --git a/retrofit/src/main/java/retrofit/io/TypedInput.java b/retrofit/src/main/java/retrofit/io/TypedInput.java
new file mode 100644
index 00000000..20997754
--- /dev/null
+++ b/retrofit/src/main/java/retrofit/io/TypedInput.java
@@ -0,0 +1,25 @@
+// Copyright 2013 Square, Inc.
+package retrofit.io;
+
+import java.io.IOException;
+import java.io.InputStream;
+
+/**
+ * Binary data with an associated mime type.
+ *
+ * @author Jake Wharton (jw@squareup.com)
+ */
+public interface TypedInput {
+
+  /** Returns the mime type. */
+  String mimeType();
+
+  /** Length in bytes. Returns {@code -1} if length is unknown. */
+  long length();
+
+  /**
+   * Read bytes as stream. Unless otherwise specified, this method may only be called once. It is
+   * the responsibility of the caller to close the stream.
+   */
+  InputStream in() throws IOException;
+}
diff --git a/retrofit/src/main/java/retrofit/io/TypedBytes.java b/retrofit/src/main/java/retrofit/io/TypedOutput.java
similarity index 82%
rename from retrofit/src/main/java/retrofit/io/TypedBytes.java
rename to retrofit/src/main/java/retrofit/io/TypedOutput.java
index 2ffd9458..ff62b8b8 100644
--- a/retrofit/src/main/java/retrofit/io/TypedBytes.java
+++ b/retrofit/src/main/java/retrofit/io/TypedOutput.java
@@ -1,4 +1,4 @@
-// Copyright 2010 Square, Inc.
+// Copyright 2013 Square, Inc.
 package retrofit.io;
 
 import java.io.IOException;
@@ -9,13 +9,13 @@ import java.io.OutputStream;
  *
  * @author Bob Lee (bob@squareup.com)
  */
-public interface TypedBytes {
+public interface TypedOutput {
 
   /** Returns the mime type. */
   String mimeType();
 
   /** Length in bytes. */
-  int length();
+  long length();
 
   /** Writes these bytes to the given output stream. */
   void writeTo(OutputStream out) throws IOException;
diff --git a/retrofit/src/main/java/retrofit/io/TypedString.java b/retrofit/src/main/java/retrofit/io/TypedString.java
new file mode 100644
index 00000000..57057083
--- /dev/null
+++ b/retrofit/src/main/java/retrofit/io/TypedString.java
@@ -0,0 +1,18 @@
+// Copyright 2013 Square, Inc.
+package retrofit.io;
+
+import java.io.UnsupportedEncodingException;
+
+public class TypedString extends TypedByteArray {
+  public TypedString(String string) {
+    super("text/plain; charset=UTF-8", convertToBytes(string));
+  }
+
+  private static byte[] convertToBytes(String string) {
+    try {
+      return string.getBytes("UTF-8");
+    } catch (UnsupportedEncodingException e) {
+      throw new RuntimeException(e);
+    }
+  }
+}
diff --git a/retrofit/src/test/java/retrofit/http/RequestBuilderTest.java b/retrofit/src/test/java/retrofit/http/RequestBuilderTest.java
index f804f01e..b122bb24 100644
--- a/retrofit/src/test/java/retrofit/http/RequestBuilderTest.java
+++ b/retrofit/src/test/java/retrofit/http/RequestBuilderTest.java
@@ -12,8 +12,8 @@ import java.util.List;
 import java.util.Set;
 import org.junit.Test;
 import retrofit.http.client.Request;
-import retrofit.io.StringTypedBytes;
-import retrofit.io.TypedBytes;
+import retrofit.io.TypedString;
+import retrofit.io.TypedOutput;
 
 import static org.fest.assertions.api.Assertions.assertThat;
 import static org.mockito.Mockito.mock;
@@ -180,7 +180,7 @@ public class RequestBuilderTest {
         .setUrl("http://example.com") //
         .setPath("/foo/bar/") //
         .addNamedParam("ping", "pong") //
-        .addNamedParam("kit", new StringTypedBytes("kat")) //
+        .addNamedParam("kit", new TypedString("kat")) //
         .setMultipart() //
         .build();
     assertThat(request.getMethod()).isEqualTo("POST");
@@ -217,7 +217,7 @@ public class RequestBuilderTest {
     assertThat(request.getUrl()).isEqualTo("http://example.com/foo/bar/");
   }
 
-  private static void assertTypedBytes(TypedBytes bytes, String expected) throws IOException {
+  private static void assertTypedBytes(TypedOutput bytes, String expected) throws IOException {
     assertThat(bytes).isNotNull();
     ByteArrayOutputStream baos = new ByteArrayOutputStream();
     bytes.writeTo(baos);
diff --git a/retrofit/src/test/java/retrofit/http/RestAdapterTest.java b/retrofit/src/test/java/retrofit/http/RestAdapterTest.java
index fc700318..1017cb8c 100644
--- a/retrofit/src/test/java/retrofit/http/RestAdapterTest.java
+++ b/retrofit/src/test/java/retrofit/http/RestAdapterTest.java
@@ -10,6 +10,7 @@ import org.junit.Test;
 import retrofit.http.client.Client;
 import retrofit.http.client.Request;
 import retrofit.http.client.Response;
+import retrofit.io.TypedString;
 
 import static org.fest.assertions.api.Assertions.assertThat;
 import static org.fest.assertions.api.Assertions.fail;
@@ -100,7 +101,7 @@ public class RestAdapterTest {
 
   @Test public void malformedResponseThrowsConversionException() throws Exception {
     when(mockClient.execute(any(Request.class))) //
-        .thenReturn(new Response(200, "OK", NO_HEADERS, "{".getBytes("UTF-8")));
+        .thenReturn(new Response(200, "OK", NO_HEADERS, new TypedString("{")));
 
     try {
       example.something();
@@ -108,7 +109,7 @@ public class RestAdapterTest {
     } catch (RetrofitError e) {
       assertThat(e.getResponse().getStatus()).isEqualTo(200);
       assertThat(e.getException()).isInstanceOf(ConversionException.class);
-      assertThat(e.getResponse().getBody()).isEqualTo("{".getBytes("UTF-8"));
+      assertThat(e.getResponse().getBody()).isEqualTo(new TypedString("{"));
     }
   }
 
diff --git a/retrofit/src/test/java/retrofit/http/RestMethodInfoTest.java b/retrofit/src/test/java/retrofit/http/RestMethodInfoTest.java
index 0fa75c57..6505bfa1 100644
--- a/retrofit/src/test/java/retrofit/http/RestMethodInfoTest.java
+++ b/retrofit/src/test/java/retrofit/http/RestMethodInfoTest.java
@@ -11,7 +11,7 @@ import java.util.Set;
 import javax.inject.Named;
 import org.junit.Ignore;
 import org.junit.Test;
-import retrofit.io.TypedBytes;
+import retrofit.io.TypedOutput;
 
 import static java.lang.annotation.ElementType.METHOD;
 import static java.lang.annotation.RetentionPolicy.RUNTIME;
@@ -534,7 +534,7 @@ public class RestMethodInfoTest {
 
   @Test public void singleEntityTypedBytes() {
     class Example {
-      @PUT("/") Response a(@SingleEntity TypedBytes o) {
+      @PUT("/") Response a(@SingleEntity TypedOutput o) {
         return null;
       }
     }
@@ -624,7 +624,7 @@ public class RestMethodInfoTest {
   @Test(expected = IllegalStateException.class)
   public void typedBytesUrlParam() {
     class Example {
-      @GET("/{a}") Response a(@Named("a") TypedBytes m) {
+      @GET("/{a}") Response a(@Named("a") TypedOutput m) {
         return null;
       }
     }
@@ -676,7 +676,7 @@ public class RestMethodInfoTest {
   @Test(expected = IllegalStateException.class)
   public void nonBodyHttpMethodWithTypedBytes() {
     class Example {
-      @GET("/") Response a(@Named("a") TypedBytes a) {
+      @GET("/") Response a(@Named("a") TypedOutput a) {
         return null;
       }
     }
@@ -689,7 +689,7 @@ public class RestMethodInfoTest {
   @Test public void simpleMultipart() {
     class Example {
       @Multipart @PUT("/")
-      Response a(@Named("a") TypedBytes a) {
+      Response a(@Named("a") TypedOutput a) {
         return null;
       }
     }
@@ -704,7 +704,7 @@ public class RestMethodInfoTest {
   @Test public void twoTypedBytesMultipart() {
     class Example {
       @Multipart @PUT("/")
-      Response a(@Named("a") TypedBytes a, @Named("b") TypedBytes b) {
+      Response a(@Named("a") TypedOutput a, @Named("b") TypedOutput b) {
         return null;
       }
     }
@@ -719,7 +719,7 @@ public class RestMethodInfoTest {
   @Test public void twoTypesMultipart() {
     class Example {
       @Multipart @PUT("/")
-      Response a(@Named("a") TypedBytes a, @Named("b") int b) {
+      Response a(@Named("a") TypedOutput a, @Named("b") int b) {
         return null;
       }
     }
diff --git a/retrofit/src/test/java/retrofit/http/client/ApacheClientTest.java b/retrofit/src/test/java/retrofit/http/client/ApacheClientTest.java
index 513aca5e..9dae5321 100644
--- a/retrofit/src/test/java/retrofit/http/client/ApacheClientTest.java
+++ b/retrofit/src/test/java/retrofit/http/client/ApacheClientTest.java
@@ -1,6 +1,7 @@
 // Copyright 2013 Square, Inc.
 package retrofit.http.client;
 
+import com.google.common.io.ByteStreams;
 import java.util.ArrayList;
 import java.util.LinkedHashMap;
 import java.util.List;
@@ -16,11 +17,10 @@ import org.apache.http.message.BasicHttpResponse;
 import org.apache.http.message.BasicStatusLine;
 import org.junit.Test;
 import retrofit.http.Header;
-import retrofit.io.StringTypedBytes;
-import retrofit.io.TypedBytes;
+import retrofit.io.TypedOutput;
+import retrofit.io.TypedString;
 
 import static org.fest.assertions.api.Assertions.assertThat;
-import static retrofit.http.client.ApacheClient.TypedBytesEntity;
 
 public class ApacheClientTest {
   private static final String HOST = "http://example.com";
@@ -40,7 +40,7 @@ public class ApacheClientTest {
   }
 
   @Test public void post() throws Exception {
-    TypedBytes body = new StringTypedBytes("hi");
+    TypedString body = new TypedString("hi");
     Request request = new Request("POST", HOST + "/foo/bar/", null, false, body, null);
     HttpUriRequest apacheRequest = ApacheClient.createRequest(request);
 
@@ -52,14 +52,14 @@ public class ApacheClientTest {
     HttpEntityEnclosingRequest entityRequest = (HttpEntityEnclosingRequest) apacheRequest;
     HttpEntity entity = entityRequest.getEntity();
     assertThat(entity).isNotNull();
-    assertBytes(Streams.readFully(entity.getContent()), "hi");
+    assertBytes(ByteStreams.toByteArray(entity.getContent()), "hi");
     assertThat(entity.getContentType().getValue()).isEqualTo("text/plain; charset=UTF-8");
   }
 
   @Test public void multipart() {
-    Map<String, TypedBytes> bodyParams = new LinkedHashMap<String, TypedBytes>();
-    bodyParams.put("foo", new StringTypedBytes("bar"));
-    bodyParams.put("ping", new StringTypedBytes("pong"));
+    Map<String, TypedOutput> bodyParams = new LinkedHashMap<String, TypedOutput>();
+    bodyParams.put("foo", new TypedString("bar"));
+    bodyParams.put("ping", new TypedString("pong"));
     Request request = new Request("POST", HOST + "/that/", null, true, null, bodyParams);
     HttpUriRequest apacheRequest = ApacheClient.createRequest(request);
 
@@ -93,16 +93,18 @@ public class ApacheClientTest {
   @Test public void response() throws Exception {
     StatusLine statusLine = new BasicStatusLine(HttpVersion.HTTP_1_1, 200, "OK");
     HttpResponse apacheResponse = new BasicHttpResponse(statusLine);
-    apacheResponse.setEntity(new TypedBytesEntity(new StringTypedBytes("hello")));
+    apacheResponse.setEntity(new ApacheClient.TypedOutputEntity(new TypedString("hello")));
+    apacheResponse.addHeader("Content-Type", "text/plain");
     apacheResponse.addHeader("foo", "bar");
     apacheResponse.addHeader("kit", "kat");
     Response response = ApacheClient.parseResponse(apacheResponse);
 
     assertThat(response.getStatus()).isEqualTo(200);
     assertThat(response.getReason()).isEqualTo("OK");
-    assertThat(response.getHeaders()).hasSize(2) //
-        .containsExactly(new Header("foo", "bar"), new Header("kit", "kat"));
-    assertBytes(response.getBody(), "hello");
+    assertThat(response.getHeaders()).hasSize(3) //
+        .containsOnly(new Header("foo", "bar"), new Header("kit", "kat"),
+            new Header("Content-Type", "text/plain"));
+    assertBytes(ByteStreams.toByteArray(response.getBody().in()), "hello");
   }
 
   @Test public void emptyResponse() throws Exception {
diff --git a/retrofit/src/test/java/retrofit/io/TypedByteArrayTest.java b/retrofit/src/test/java/retrofit/io/TypedByteArrayTest.java
index 07f6d594..99bec5da 100644
--- a/retrofit/src/test/java/retrofit/io/TypedByteArrayTest.java
+++ b/retrofit/src/test/java/retrofit/io/TypedByteArrayTest.java
@@ -9,9 +9,9 @@ public class TypedByteArrayTest {
   private static final String GIF = "image/gif";
 
   @Test public void objectEquals() {
-    TypedByteArray a1 = new TypedByteArray(new byte[] { 10, 20 }, GIF);
-    TypedByteArray a2 = new TypedByteArray(new byte[] { 10, 20 }, GIF);
-    TypedByteArray b = new TypedByteArray(new byte[] { 8, 12 }, GIF);
+    TypedByteArray a1 = new TypedByteArray(GIF, new byte[] { 10, 20 });
+    TypedByteArray a2 = new TypedByteArray(GIF, new byte[] { 10, 20 });
+    TypedByteArray b = new TypedByteArray(GIF, new byte[] { 8, 12 });
 
     assertThat(a1).isEqualTo(a2);
     assertThat(a1.hashCode()).isEqualTo(a2.hashCode());
diff --git a/retrofit/src/test/java/retrofit/io/TypedFileTest.java b/retrofit/src/test/java/retrofit/io/TypedFileTest.java
index 1a280556..d2f1a949 100644
--- a/retrofit/src/test/java/retrofit/io/TypedFileTest.java
+++ b/retrofit/src/test/java/retrofit/io/TypedFileTest.java
@@ -12,9 +12,9 @@ public class TypedFileTest {
   private static final String PNG = "image/png";
 
   @Test public void objectEquals() {
-    TypedFile a1 = new TypedFile(new File("a.png"), PNG);
-    TypedFile a2 = new TypedFile(new File("a.png"), PNG);
-    TypedFile b = new TypedFile(new File("b.png"), PNG);
+    TypedFile a1 = new TypedFile(PNG, new File("a.png"));
+    TypedFile a2 = new TypedFile(PNG, new File("a.png"));
+    TypedFile b = new TypedFile(PNG, new File("b.png"));
 
     assertThat(a1).isNotEqualTo(b);
     assertThat(a1.hashCode()).isNotEqualTo(b.hashCode());
@@ -25,14 +25,14 @@ public class TypedFileTest {
   @Test public void objectToString() {
     File file = new File("/path/to/file.png");
 
-    assertThat(new TypedFile(file, PNG).toString()) //
+    assertThat(new TypedFile(PNG, file).toString()) //
         .isEqualTo(file.getAbsolutePath() + " (image/png)");
   }
 
   @Test public void length() throws IOException {
     File tempFile = File.createTempFile("foo", ".tmp");
     try {
-      TypedFile typedFile = new TypedFile(tempFile, PNG);
+      TypedFile typedFile = new TypedFile(PNG, tempFile);
       assertThat(typedFile.length()).isZero();
 
       writeToFile(tempFile, new byte[] { 0, 1, 2, 3, 4 });
