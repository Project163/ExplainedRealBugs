{"url":"https://api.github.com/repos/rs/zerolog/issues/80","repository_url":"https://api.github.com/repos/rs/zerolog","labels_url":"https://api.github.com/repos/rs/zerolog/issues/80/labels{/name}","comments_url":"https://api.github.com/repos/rs/zerolog/issues/80/comments","events_url":"https://api.github.com/repos/rs/zerolog/issues/80/events","html_url":"https://github.com/rs/zerolog/issues/80","id":337669365,"node_id":"MDU6SXNzdWUzMzc2NjkzNjU=","number":80,"title":"Confusing behavior with context.Context integration","user":{"login":"bluekeyes","id":1745813,"node_id":"MDQ6VXNlcjE3NDU4MTM=","avatar_url":"https://avatars.githubusercontent.com/u/1745813?v=4","gravatar_id":"","url":"https://api.github.com/users/bluekeyes","html_url":"https://github.com/bluekeyes","followers_url":"https://api.github.com/users/bluekeyes/followers","following_url":"https://api.github.com/users/bluekeyes/following{/other_user}","gists_url":"https://api.github.com/users/bluekeyes/gists{/gist_id}","starred_url":"https://api.github.com/users/bluekeyes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bluekeyes/subscriptions","organizations_url":"https://api.github.com/users/bluekeyes/orgs","repos_url":"https://api.github.com/users/bluekeyes/repos","events_url":"https://api.github.com/users/bluekeyes/events{/privacy}","received_events_url":"https://api.github.com/users/bluekeyes/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2018-07-02T21:28:06Z","updated_at":"2018-07-03T01:23:54Z","closed_at":"2018-07-03T01:23:54Z","author_association":"NONE","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"First, thanks for this library; the API is easy to use and the `hlog` package is a nice bonus.\r\n\r\nWe recently started using `zerolog.Ctx` and `(Logger) WithContext` and were surprised to find that `WithContext` modified the context instead of creating a copy of the context with the modified logger. This means that when we set fields in functions that should only be visible to the functions they call, those fields are instead included on _all_ future log message.\r\n\r\nThis program demonstrates the issue (it happens more naturally in HTTP handlers):\r\n\r\n```go\r\npackage main\r\n\r\nimport (\r\n\t\"context\"\r\n\t\"github.com/rs/zerolog\"\r\n\t\"os\"\r\n)\r\n\r\nfunc process(ctx context.Context, id int) {\r\n\tlog := zerolog.Ctx(ctx).With().Int(\"id\", id).Logger()\r\n\tchild(log.WithContext(ctx))\r\n}\r\n\r\nfunc child(ctx context.Context) {\r\n\tzerolog.Ctx(ctx).Info().Msg(\"hello from child\")\r\n}\r\n\r\nfunc main() {\r\n\tctx := zerolog.New(os.Stdout).WithContext(context.Background())\r\n\r\n\tzerolog.Ctx(ctx).Info().Msg(\"processing 1\")\r\n\tprocess(ctx, 1)\r\n\r\n\tzerolog.Ctx(ctx).Info().Msg(\"processing 2\")\r\n\tprocess(ctx, 2)\r\n\r\n\tzerolog.Ctx(ctx).Info().Msg(\"done\")\r\n}\r\n```\r\n```\r\n# expected output\r\n{\"level\":\"info\",\"message\":\"processing 1\"}\r\n{\"level\":\"info\",\"id\":1,\"message\":\"hello from child\"}\r\n{\"level\":\"info\",\"message\":\"processing 2\"}\r\n{\"level\":\"info\",\"id\":2,\"message\":\"hello from child\"}\r\n{\"level\":\"info\",\"message\":\"done\"}\r\n\r\n# actual output\r\n{\"level\":\"info\",\"message\":\"processing 1\"}\r\n{\"level\":\"info\",\"id\":1,\"message\":\"hello from child\"}\r\n{\"level\":\"info\",\"id\":1,\"message\":\"processing 2\"}\r\n{\"level\":\"info\",\"id\":1,\"id\":2,\"message\":\"hello from child\"}\r\n{\"level\":\"info\",\"id\":1,\"id\":2,\"message\":\"done\"}\r\n```\r\n\r\nI did some digging in the history and it seems like this was added in 6a6144a10bde51f04fcdb0fbb0c50bca28a025f5 to support the `hlog` functions, which are more efficient when they can modify the existing logger and can reasonably expect to exist at the top of the middleware stack.\r\n\r\nHowever, at some later point, all those functions switched to use `(*Logger) UpdateContext`, which achieves the same thing. It seems like `(Logger) WithContext` is now only used to set the initial logger.\r\n\r\nI think this behavior goes against the expectations of `context.Context` (modifications are not visible to functions that were not passed the modified context) and makes it difficult to add new logging fields only for sections of a request handler.\r\n\r\nIs it possible that `(Logger) WithContext` could be reverted to always return a copy of the context if the logger is updated? \r\n\r\nIf not, do you have recommendations on how to work around this behavior? We're currently going to write our own functions to interact with the context, but it would be great if we could stick with the library functions.","closed_by":{"login":"rs","id":68232,"node_id":"MDQ6VXNlcjY4MjMy","avatar_url":"https://avatars.githubusercontent.com/u/68232?v=4","gravatar_id":"","url":"https://api.github.com/users/rs","html_url":"https://github.com/rs","followers_url":"https://api.github.com/users/rs/followers","following_url":"https://api.github.com/users/rs/following{/other_user}","gists_url":"https://api.github.com/users/rs/gists{/gist_id}","starred_url":"https://api.github.com/users/rs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rs/subscriptions","organizations_url":"https://api.github.com/users/rs/orgs","repos_url":"https://api.github.com/users/rs/repos","events_url":"https://api.github.com/users/rs/events{/privacy}","received_events_url":"https://api.github.com/users/rs/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rs/zerolog/issues/80/reactions","total_count":6,"+1":6,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rs/zerolog/issues/80/timeline","performed_via_github_app":null,"state_reason":"completed"}