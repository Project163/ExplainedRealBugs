diff --git a/framework/CHANGELOG.md b/framework/CHANGELOG.md
index a4fce97b7..7aaa89dcb 100644
--- a/framework/CHANGELOG.md
+++ b/framework/CHANGELOG.md
@@ -4,6 +4,7 @@ Yii Framework 2 Change Log
 2.0.39 under development
 ------------------------
 
+- Bug #18263: Fix writing `\yii\caching\FileCache` files to the same directory when `keyPrefix` is set (githubjeka)
 - Bug #18160, #18192: Fixed `registerFile` with argument depends set does not use the position and appendTimestamp argument, also modify the unit view (baleeny)
 - Bug #18290: Fix response with non-seekable streams (schmunk42)
 - Bug #16418: Fixed `yii\data\Pagination::getLinks()` to return links to the first and the last pages regardless of the current page (ptz-nerf, bizley)
diff --git a/framework/UPGRADE.md b/framework/UPGRADE.md
index b151c3345..6ae88d4a3 100644
--- a/framework/UPGRADE.md
+++ b/framework/UPGRADE.md
@@ -51,6 +51,12 @@ if you want to upgrade from version A to version C and there is
 version B between A and C, you need to follow the instructions
 for both A and B.
 
+Upgrade from Yii 2.0.38
+-----------------------
+
+* The storage structure of the file cache has been changed when you use `\yii\caching\FileCache::$keyPrefix`.
+It is worth warming up the cache again if there is a logical dependency when working with the file cache.
+
 Upgrade from Yii 2.0.37
 -----------------------
 
diff --git a/framework/caching/FileCache.php b/framework/caching/FileCache.php
index 08f292084..da71b1793 100644
--- a/framework/caching/FileCache.php
+++ b/framework/caching/FileCache.php
@@ -197,24 +197,31 @@ class FileCache extends Cache
     }
 
     /**
-     * Returns the cache file path given the cache key.
-     * @param string $key cache key
+     * Returns the cache file path given the normalized cache key.
+     * @param string $normalizedKey normalized cache key by [[buildKey]] method
      * @return string the cache file path
      */
-    protected function getCacheFile($key)
+    protected function getCacheFile($normalizedKey)
     {
+        $cacheKey = $normalizedKey;
+
+        if ($this->keyPrefix !== '') {
+            // Remove key prefix to avoid generating constant directory levels
+            $lenKeyPrefix = strlen($this->keyPrefix);
+            $cacheKey = substr_replace($normalizedKey, '', 0, $lenKeyPrefix);
+        }
+
+        $cachePath = $this->cachePath;
+
         if ($this->directoryLevel > 0) {
-            $base = $this->cachePath;
             for ($i = 0; $i < $this->directoryLevel; ++$i) {
-                if (($prefix = substr($key, $i + $i, 2)) !== false) {
-                    $base .= DIRECTORY_SEPARATOR . $prefix;
+                if (($subDirectory = substr($cacheKey, $i + $i, 2)) !== false) {
+                    $cachePath .= DIRECTORY_SEPARATOR . $subDirectory;
                 }
             }
-
-            return $base . DIRECTORY_SEPARATOR . $key . $this->cacheFileSuffix;
         }
 
-        return $this->cachePath . DIRECTORY_SEPARATOR . $key . $this->cacheFileSuffix;
+        return $cachePath . DIRECTORY_SEPARATOR . $normalizedKey . $this->cacheFileSuffix;
     }
 
     /**
diff --git a/tests/framework/caching/FileCacheTest.php b/tests/framework/caching/FileCacheTest.php
index 3f19ee6ac..55f2fcad1 100644
--- a/tests/framework/caching/FileCacheTest.php
+++ b/tests/framework/caching/FileCacheTest.php
@@ -53,6 +53,36 @@ class FileCacheTest extends CacheTestCase
         $this->assertFalse($cache->get('expire_testa'));
     }
 
+    public function testKeyPrefix()
+    {
+        $keyPrefix = 'foobar';
+        $key = uniqid('uid-cache_');
+        $cache = $this->getCacheInstance();
+        $cache->flush();
+
+        $cache->directoryLevel = 1;
+        $cache->keyPrefix = $keyPrefix;
+        $normalizeKey = $cache->buildKey($key);
+        $expectedDirectoryName = substr($normalizeKey, 6, 2);
+
+        $value = \time();
+
+        $refClass = new \ReflectionClass($cache);
+
+        $refMethodGetCacheFile = $refClass->getMethod('getCacheFile');
+        $refMethodGetCacheFile->setAccessible(true);
+        $refMethodGet = $refClass->getMethod('get');
+        $refMethodSet = $refClass->getMethod('set');
+
+        $cacheFile = $refMethodGetCacheFile->invoke($cache, $normalizeKey);
+
+        $this->assertTrue($refMethodSet->invoke($cache, $key, $value));
+        $this->assertContains($keyPrefix, basename($cacheFile));
+        $this->assertEquals($expectedDirectoryName, basename(dirname($cacheFile)), $cacheFile);
+        $this->assertTrue(is_dir(dirname($cacheFile)), 'File not found ' . $cacheFile);
+        $this->assertEquals($value, $refMethodGet->invoke($cache, $key));
+    }
+
     public function testCacheRenewalOnDifferentOwnership()
     {
         $TRAVIS_SECOND_USER = getenv('TRAVIS_SECOND_USER');
