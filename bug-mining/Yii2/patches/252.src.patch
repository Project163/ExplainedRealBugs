diff --git a/framework/CHANGELOG.md b/framework/CHANGELOG.md
index 8afa5a5a5..13f5f7acb 100644
--- a/framework/CHANGELOG.md
+++ b/framework/CHANGELOG.md
@@ -4,6 +4,7 @@ Yii Framework 2 Change Log
 2.0.12 under development
 --------------------------
 
+- Bug #13671: Fixed error handler trace to work correctly with XDebug (samdark)
 - Bug #13657: Fixed `yii\helpers\StringHelper::truncateHtml()` skip extra tags at the end (sam002)
 - Bug #7946 Fixed a bug when the `form` attribute was not propagated to the hidden input of the checkbox (Kolyunya)
 - Bug #13087: Fixed getting active validators for safe attribute (developeruz)
diff --git a/framework/views/errorHandler/exception.php b/framework/views/errorHandler/exception.php
index 03a384cf8..db3e88b05 100644
--- a/framework/views/errorHandler/exception.php
+++ b/framework/views/errorHandler/exception.php
@@ -378,13 +378,7 @@ body.mousedown pre {
     </div>
 
     <div class="call-stack">
-        <ul>
-            <?= $handler->renderCallStackItem($exception->getFile(), $exception->getLine(), null, null, [], 1) ?>
-            <?php for ($i = 0, $trace = $exception->getTrace(), $length = count($trace); $i < $length; ++$i): ?>
-                <?= $handler->renderCallStackItem(@$trace[$i]['file'] ?: null, @$trace[$i]['line'] ?: null,
-                    @$trace[$i]['class'] ?: null, @$trace[$i]['function'] ?: null, @$trace[$i]['args'] ?: [], $i + 2) ?>
-            <?php endfor; ?>
-        </ul>
+        <?= $handler->renderCallStack($exception) ?>
     </div>
 
     <div class="request">
diff --git a/framework/web/ErrorHandler.php b/framework/web/ErrorHandler.php
index b43d23567..dfeca722d 100644
--- a/framework/web/ErrorHandler.php
+++ b/framework/web/ErrorHandler.php
@@ -308,6 +308,30 @@ class ErrorHandler extends \yii\base\ErrorHandler
         ]);
     }
 
+    /**
+     * Renders call stack.
+     * @param \Exception $exception exception to get call stack from
+     * @return string HTML content of the rendered call stack.
+     */
+    public function renderCallStack(\Exception $exception)
+    {
+        $out = '<ul>';
+        $out .= $this->renderCallStackItem($exception->getFile(), $exception->getLine(), null, null, [], 1);
+        for ($i = 0, $trace = $exception->getTrace(), $length = count($trace); $i < $length; ++$i) {
+            $file = !empty($trace[$i]['file']) ? $trace[$i]['file'] : null;
+            $line = !empty($trace[$i]['line']) ? $trace[$i]['line'] : null;
+            $class = !empty($trace[$i]['class']) ? $trace[$i]['class'] : null;
+            $function = null;
+            if (!empty($trace[$i]['function']) && $trace[$i]['function'] !== 'unknown') {
+                $function = $trace[$i]['function'];
+            }
+            $args = !empty($trace[$i]['args']) ? $trace[$i]['args'] : [];
+            $out .= $this->renderCallStackItem($file, $line, $class, $function, $args, $i + 2);
+        }
+        $out .= '</ul>';
+        return $out;
+    }
+
     /**
      * Renders the global variables of the request.
      * List of global variables is defined in [[displayVars]].
