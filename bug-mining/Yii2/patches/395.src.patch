diff --git a/framework/CHANGELOG.md b/framework/CHANGELOG.md
index 2ef3721dc..9a7718ddf 100644
--- a/framework/CHANGELOG.md
+++ b/framework/CHANGELOG.md
@@ -3,7 +3,8 @@ Yii Framework 2 Change Log
 
 2.0.14 under development
 ------------------------
-- Bug #15356: Fixed multiple bugs in `yii\db\Query::getTablesUsedInFrom()` (vladis84)
+
+- Bug #15356: Fixed multiple bugs in `yii\db\Query::getTablesUsedInFrom()` (vladis84, samdark)
 - Bug #14157: Add support for loading default value `CURRENT_TIMESTAMP` of MySQL `datetime` field (rossoneri)
 - Bug #15046: Throw an `yii\web\HeadersAlreadySentException` if headers were sent before web response (dmirogin)
 - Enh #3087: Added `yii\helpers\BaseHtml::error()` "errorMethod" option to be able to customize errors display (yanggs07, developeruz)
diff --git a/framework/db/Query.php b/framework/db/Query.php
index 3a228745d..c9633ee8c 100644
--- a/framework/db/Query.php
+++ b/framework/db/Query.php
@@ -466,12 +466,14 @@ class Query extends Component implements QueryInterface
     {
         if (empty($this->from)) {
             return [];
-        } elseif (is_array($this->from)) {
+        }
+
+        if (is_array($this->from)) {
             $tableNames = $this->from;
         } elseif (is_string($this->from)) {
             $tableNames = preg_split('/\s*,\s*/', trim($this->from), -1, PREG_SPLIT_NO_EMPTY);
         } elseif ($this->from instanceof Expression) {
-            return (string) $this->from;
+            $tableNames[] = $this->from;
         } else {
             throw new InvalidConfigException(gettype($this->from) . ' in $from is not supported.');
         }
@@ -479,12 +481,12 @@ class Query extends Component implements QueryInterface
         // Clean up table names and aliases
         $cleanedUpTableNames = [];
         foreach ($tableNames as $alias => $tableName) {
-            if ($tableName instanceof self) {
-                $cleanedUpTableNames += $tableName->getTablesUsedInFrom();
-                
-                continue;
+            $tableNameString = $tableName;
+            if ($tableName instanceof Expression) {
+                $tableNameString = $tableName->expression;
             }
-            if (!is_string($alias)) {
+
+            if (!is_string($alias) && is_string($tableNameString)) {
                 $pattern = <<<PATTERN
 ~
 ^
@@ -494,6 +496,8 @@ class Query extends Component implements QueryInterface
     .*?
     (?:['"`\]]|}})
     |
+    \(.*?\)
+    |
     .*?
 )
 (?:
@@ -514,36 +518,38 @@ class Query extends Component implements QueryInterface
 $
 ~iux
 PATTERN;
-                if (preg_match($pattern, $tableName, $matches)) {
+                if (preg_match($pattern, $tableNameString, $matches)) {
                     if (isset($matches[1])) {
                         if (isset($matches[2])) {
-                            list(, $tableName, $alias) = $matches;
+                            list(, $tableNameString, $alias) = $matches;
                         } else {
-                            $tableName = $alias = $matches[1];
+                            $tableNameString = $alias = $matches[1];
                         }
                     }
                 }
             }
 
-            $tableName = str_replace(["'", '"', '`', '[', ']'], '', $tableName);
-            $alias = str_replace(["'", '"', '`', '[', ']'], '', $alias);
-
-            $cleanedUpTableNames[$this->encloseName($alias)] = $this->encloseName($tableName);
+            if ($tableName instanceof Expression) {
+                $cleanedUpTableNames[$this->ensureNameQuoted($alias)] = $tableNameString;
+            } elseif ($tableName instanceof self) {
+                $cleanedUpTableNames[$this->ensureNameQuoted($alias)] = $tableName;
+            } else {
+                $cleanedUpTableNames[$this->ensureNameQuoted($alias)] = $this->ensureNameQuoted($tableNameString);
+            }
         }
 
         return $cleanedUpTableNames;
     }
 
     /**
-     * Aliases or names  enclose into {{}}
+     * Ensures name is wrapped with {{ and }}
      * @param string $name
      * @return string
      */
-    private function encloseName($name)
+    private function ensureNameQuoted($name)
     {
+        $name = str_replace(["'", '"', '`', '[', ']'], '', $name);
         if ($name && !preg_match('/^{{.*}}$/', $name)) {
-            $name = trim($name, '{}');
-            
             return '{{' . $name . '}}';
         }
 
diff --git a/tests/framework/db/GetTablesAliasTestTrait.php b/tests/framework/db/GetTablesAliasTestTrait.php
index d59108de5..73ac3bc47 100644
--- a/tests/framework/db/GetTablesAliasTestTrait.php
+++ b/tests/framework/db/GetTablesAliasTestTrait.php
@@ -17,13 +17,24 @@ trait GetTablesAliasTestTrait
      */
     abstract protected function createQuery();
 
-    public function testGetTableNames_isFromArray()
+    public function testGetTableNames_isEmptyArray()
+    {
+        $query = $this->createQuery();
+        $query->from = [];
+
+        $tables = $query->getTablesUsedInFrom();
+
+        $this->assertEquals([], $tables);
+    }
+
+    public function testGetTableNames_isFromArrayWithAlias()
     {
         $query = $this->createQuery();
         $query->from = [
-            '{{prf}}' => '{{profile}}',
+            'prf' => 'profile',
             '{{usr}}' => '{{user}}',
             '{{a b}}' => '{{c d}}',
+            'post AS p',
         ];
 
         $tables = $query->getTablesUsedInFrom();
@@ -32,6 +43,23 @@ trait GetTablesAliasTestTrait
             '{{prf}}' => '{{profile}}',
             '{{usr}}' => '{{user}}',
             '{{a b}}' => '{{c d}}',
+            '{{p}}' => '{{post}}',
+        ], $tables);
+    }
+
+    public function testGetTableNames_isFromArrayWithoutAlias()
+    {
+        $query = $this->createQuery();
+        $query->from = [
+            '{{profile}}',
+            'user'
+        ];
+
+        $tables = $query->getTablesUsedInFrom();
+
+        $this->assertEquals([
+            '{{profile}}' => '{{profile}}',
+            '{{user}}' => '{{user}}',
         ], $tables);
     }
 
@@ -81,7 +109,7 @@ trait GetTablesAliasTestTrait
     /**
      * @see https://github.com/yiisoft/yii2/issues/14150
      */
-    public function testGetTableAliasFromPrefixedTableName()
+    public function testGetTableNames_isFromPrefixedTableName()
     {
         $query = $this->createQuery();
         $query->from = '{{%order_item}}';
@@ -96,7 +124,7 @@ trait GetTablesAliasTestTrait
     /**
      * @see https://github.com/yiisoft/yii2/issues/14211
      */
-    public function testGetTableAliasFromTableNameWithDatabase()
+    public function testGetTableNames_isFromTableNameWithDatabase()
     {
         $query = $this->createQuery();
         $query->from = 'tickets.workflows';
@@ -107,4 +135,41 @@ trait GetTablesAliasTestTrait
             '{{tickets.workflows}}' => '{{tickets.workflows}}',
         ], $tables);
     }
+
+    public function testGetTableNames_isFromAliasedExpression()
+    {
+        $query = $this->createQuery();
+        $query->from = new \yii\db\Expression('(SELECT id FROM user) x');
+
+        $tables = $query->getTablesUsedInFrom();
+
+        $this->assertEquals([
+            '{{x}}' => '(SELECT id FROM user)',
+        ], $tables);
+    }
+
+    public function testGetTableNames_isFromAliasedArrayWithExpression()
+    {
+        $query = $this->createQuery();
+        $query->from = ['x' => new \yii\db\Expression('(SELECT id FROM user)')];
+
+        $tables = $query->getTablesUsedInFrom();
+
+        $this->assertEquals([
+            '{{x}}' => '(SELECT id FROM user)',
+        ], $tables);
+    }
+
+    public function testGetTableNames_isFromAliasedSubquery()
+    {
+        $query = $this->createQuery();
+        $subQuery = $this->createQuery();
+        $subQuery->from('user');
+        $query->from(['x' => $subQuery]);
+        $expected = ['{{x}}' => $subQuery];
+
+        $tables = $query->getTablesUsedInFrom();
+
+        $this->assertEquals($expected, $tables);
+    }
 }
diff --git a/tests/framework/db/QueryTest.php b/tests/framework/db/QueryTest.php
index 9c5d271df..76ba062b7 100644
--- a/tests/framework/db/QueryTest.php
+++ b/tests/framework/db/QueryTest.php
@@ -583,109 +583,4 @@ abstract class QueryTest extends DatabaseTestCase
             '%ba',
         ]));
     }
-
-    public function testGetTablesUsedInFromEmptyFrom()
-    {
-        $query = new Query;
-        $query->from([]);
-
-        $tables = $query->getTablesUsedInFrom();
-
-        $this->assertEquals([], $tables);
-    }
-
-    public function testGetTablesUsedInFromIsArrayFromAndFilledAlias()
-    {
-        $query = new Query;
-        $query->from(['u' => '{user}']);
-
-        $tables = $query->getTablesUsedInFrom();
-
-        $this->assertEquals(['{{u}}' => '{{user}}'], $tables);
-    }
-
-    public function testGetTablesUsedInFromIsArrayFromAndNotFilledAlias()
-    {
-        $query = new Query;
-        $query->from(['user']);
-
-        $tables = $query->getTablesUsedInFrom();
-
-        $this->assertEquals(['{{user}}' => '{{user}}'], $tables);
-    }
-
-    public function testGetTablesUsedInFromIsArrayFromAndEmptyAlias()
-    {
-        $query = new Query;
-        $query->from(['user AS u']);
-
-        $tables = $query->getTablesUsedInFrom();
-
-        $this->assertEquals(['{{u}}' => '{{user}}'], $tables);
-    }
-
-    public function testGetTablesUsedInFromIsStringFrom()
-    {
-        $query = new Query;
-        $query->from('user AS u, customer AS c');
-        $expected = ['{{u}}' => '{{user}}', '{{c}}' => '{{customer}}'];
-
-        $tables = $query->getTablesUsedInFrom();
-
-        $this->assertEquals($expected, $tables);
-    }
-
-    public function testGetTablesUsedInFromIsExpressionFrom()
-    {
-        $query = new Query;
-        $expression = new \yii\db\Expression('(SELECT id from user) x');
-        $query->from($expression);
-
-        $tables = $query->getTablesUsedInFrom();
-
-        $this->assertEquals('(SELECT id from user) x', $tables);
-    }
-
-    public function testGetTablesUsedInFromIsQueryStringFrom()
-    {
-        $query = new Query;
-        $subQuery = "(SELECT * FROM `user` WHERE `active` = 1)";
-        $query->from(['activeusers' => $subQuery]);
-        $expected = ['{{activeusers}}' => '{{(SELECT * FROM user WHERE active = 1)}}'];
-
-        $tables = $query->getTablesUsedInFrom();
-
-        $this->assertEquals($expected, $tables);
-    }
-
-    public function testGetTablesUsedInFromIsQueryFrom()
-    {
-        $query = new Query;
-        $subQuery = new Query;
-        $subQuery->from('user');
-        $query->from(['x' => $subQuery]);
-        $expected = ['{{user}}' => '{{user}}'];
-
-        $tables = $query->getTablesUsedInFrom();
-
-        $this->assertEquals($expected, $tables);
-    }
-
-    public function testEncloseNameEnclosedName()
-    {
-        $query = new Query;
-
-        $enclosedName = $this->invokeMethod($query, 'encloseName', ['{{user}}']);
-
-        $this->assertEquals('{{user}}', $enclosedName);
-    }
-
-    public function testEncloseNameNotEnclosedName()
-    {
-        $query = new Query;
-
-        $enclosedName = $this->invokeMethod($query, 'encloseName', ['{user}']);
-
-        $this->assertEquals('{{user}}', $enclosedName);
-    }
 }
