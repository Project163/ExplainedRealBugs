diff --git a/framework/CHANGELOG.md b/framework/CHANGELOG.md
index 9032aeb29..fee219d34 100644
--- a/framework/CHANGELOG.md
+++ b/framework/CHANGELOG.md
@@ -46,6 +46,10 @@ Yii Framework 2 Change Log
 - Bug #13231: Fixed `destroy` method in `yii.gridView.js` which did not work as expected (arogachev)
 - Bug #13232: Event handlers were not detached with changed selector in `yii.gridView.js` (arogachev)
 - Bug #13277: Fixed invalid parsing of `--` ("End of Options" special argument) in CLI (rugabarbo)
+- Bug #13300: Allow pjax with "data-pjax" with no value in `yii.js` (arogachev)
+- Bug #13307: Preventing of race conditions in script filter in `yii.js` works incorrectly (arogachev)
+- Bug #13310: Handle relative and absolute URLs coincidence in CSS filter in `yii.js` (arogachev)
+- Bug #13312: `skipOuterContainers` option was incorrectly passed to pjax in `handleAction` in `yii.js` (arogachev)
 - Bug #13309: Fixes incorrect console width/height detecting with using Stty on Mac (nowm)
 - Bug #13326: Fixed wrong background color generation in `BaseConsole::renderColoredString()` (nowm, silverfire)
 - Bug #12133: Fixed `getDbTargets()` function in `yii\log\migrations\m141106_185632_log_init` that would create a log table correctly (bumstik)
diff --git a/framework/assets/yii.js b/framework/assets/yii.js
index 73484efb3..b37451b85 100644
--- a/framework/assets/yii.js
+++ b/framework/assets/yii.js
@@ -17,13 +17,13 @@
  * A module may be structured as follows:
  *
  * ```javascript
- * yii.sample = (function($) {
+ * window.yii.sample = (function($) {
  *     var pub = {
  *         // whether this module is currently active. If false, init() will not be called for this module
  *         // it will also not be called for all its child modules. If this property is undefined, it means true.
  *         isActive: true,
  *         init: function() {
- *             // ... module initialization code go here ...
+ *             // ... module initialization code goes here ...
  *         },
  *
  *         // ... other public functions and properties go here ...
@@ -32,7 +32,7 @@
  *     // ... private functions and properties go here ...
  *
  *     return pub;
- * })(jQuery);
+ * })(window.jQuery);
  * ```
  *
  * Using this structure, you can define public and private functions/properties for a module.
@@ -46,9 +46,9 @@ window.yii = (function ($) {
         /**
          * List of JS or CSS URLs that can be loaded multiple times via AJAX requests.
          * Each item may be represented as either an absolute URL or a relative one.
-         * Each item may contain a wildcart matching character `*`, that means one or more
+         * Each item may contain a wildcard matching character `*`, that means one or more
          * any characters on the position. For example:
-         *  - `/css/*.js` will match any file ending with `.js` in the `css` directory of the current web site
+         *  - `/css/*.css` will match any file ending with `.css` in the `css` directory of the current web site
          *  - `http*://cdn.example.com/*` will match any files on domain `cdn.example.com`, loaded with HTTP or HTTPS
          *  - `/js/myCustomScript.js?realm=*` will match file `/js/myCustomScript.js` with defined `realm` parameter
          */
@@ -56,7 +56,8 @@ window.yii = (function ($) {
         /**
          * The selector for clickable elements that need to support confirmation and form submission.
          */
-        clickableSelector: 'a, button, input[type="submit"], input[type="button"], input[type="reset"], input[type="image"]',
+        clickableSelector: 'a, button, input[type="submit"], input[type="button"], input[type="reset"], ' +
+        'input[type="image"]',
         /**
          * The selector for changeable elements that need to support confirmation and form submission.
          */
@@ -107,7 +108,7 @@ window.yii = (function ($) {
          * @param cancel a callback to be called when the user cancels the confirmation
          */
         confirm: function (message, ok, cancel) {
-            if (confirm(message)) {
+            if (window.confirm(message)) {
                 !ok || ok();
             } else {
                 !cancel || cancel();
@@ -143,74 +144,70 @@ window.yii = (function ($) {
          *             'name2' => 'value2',
          *         ],
          *     ],
-         * ];
+         * ]);
          * ```
          *
          * @param $e the jQuery representation of the element
+         * @param event Related event
          */
         handleAction: function ($e, event) {
             var $form = $e.attr('data-form') ? $('#' + $e.attr('data-form')) : $e.closest('form'),
                 method = !$e.data('method') && $form ? $form.attr('method') : $e.data('method'),
                 action = $e.attr('href'),
+                isValidAction = action && action !== '#',
                 params = $e.data('params'),
-                pjax = $e.data('pjax') || 0,
-                usePjax = pjax !== 0 && $.support.pjax,
-                pjaxPushState = !!$e.data('pjax-push-state'),
-                pjaxReplaceState = !!$e.data('pjax-replace-state'),
-                pjaxTimeout = $e.data('pjax-timeout'),
-                pjaxScrollTo = $e.data('pjax-scrollto'),
-                pjaxPushRedirect = $e.data('pjax-push-redirect'),
-                pjaxReplaceRedirect = $e.data('pjax-replace-redirect'),
-                pjaxSkipOuterContainers = $e.data('pjax-skip-outer-containers'),
+                areValidParams = params && $.isPlainObject(params),
+                pjax = $e.data('pjax'),
+                usePjax = pjax !== undefined && pjax !== 0 && $.support.pjax,
                 pjaxContainer,
                 pjaxOptions = {};
 
             if (usePjax) {
-                if ($e.data('pjax-container')) {
-                    pjaxContainer = $e.data('pjax-container');
-                } else {
-                    pjaxContainer = $e.closest('[data-pjax-container=""]');
-                }
-                // default to body if pjax container not found
+                pjaxContainer = $e.data('pjax-container') || $e.closest('[data-pjax-container]');
                 if (!pjaxContainer.length) {
                     pjaxContainer = $('body');
                 }
                 pjaxOptions = {
                     container: pjaxContainer,
-                    push: pjaxPushState,
-                    replace: pjaxReplaceState,
-                    scrollTo: pjaxScrollTo,
-                    pushRedirect: pjaxPushRedirect,
-                    replaceRedirect: pjaxReplaceRedirect,
-                    pjaxSkipOuterContainers: pjaxSkipOuterContainers,
-                    timeout: pjaxTimeout,
+                    push: !!$e.data('pjax-push-state'),
+                    replace: !!$e.data('pjax-replace-state'),
+                    scrollTo: $e.data('pjax-scrollto'),
+                    pushRedirect: $e.data('pjax-push-redirect'),
+                    replaceRedirect: $e.data('pjax-replace-redirect'),
+                    skipOuterContainers: $e.data('pjax-skip-outer-containers'),
+                    timeout: $e.data('pjax-timeout'),
                     originalEvent: event,
                     originalTarget: $e
-                }
+                };
             }
 
             if (method === undefined) {
-                if (action && action != '#') {
-                    if (usePjax) {
-                        $.pjax.click(event, pjaxOptions);
-                    } else {
-                        window.location = action;
-                    }
+                if (isValidAction) {
+                    usePjax ? $.pjax.click(event, pjaxOptions) : window.location.assign(action);
                 } else if ($e.is(':submit') && $form.length) {
                     if (usePjax) {
-                        $form.on('submit',function(e){
+                        $form.on('submit', function (e) {
                             $.pjax.submit(e, pjaxOptions);
-                        })
+                        });
                     }
                     $form.trigger('submit');
                 }
                 return;
             }
 
-            var newForm = !$form.length;
-            if (newForm) {
-                if (!action || !/(^\/|:\/\/)/.test(action)) {
-                    action = window.location.href;
+            var oldMethod,
+                oldAction,
+                newForm = !$form.length;
+            if (!newForm) {
+                oldMethod = $form.attr('method');
+                $form.attr('method', method);
+                if (isValidAction) {
+                    oldAction = $form.attr('action');
+                    $form.attr('action', action);
+                }
+            } else {
+                if (!isValidAction) {
+                    action = pub.getCurrentUrl();
                 }
                 $form = $('<form/>', {method: method, action: action});
                 var target = $e.attr('target');
@@ -219,9 +216,10 @@ window.yii = (function ($) {
                 }
                 if (!/(get|post)/i.test(method)) {
                     $form.append($('<input/>', {name: '_method', value: method, type: 'hidden'}));
-                    method = 'POST';
+                    method = 'post';
+                    $form.attr('method', method);
                 }
-                if (!/(get|head|options)/i.test(method)) {
+                if (/post/i.test(method)) {
                     var csrfParam = pub.getCsrfParam();
                     if (csrfParam) {
                         $form.append($('<input/>', {name: csrfParam, value: pub.getCsrfToken(), type: 'hidden'}));
@@ -232,49 +230,41 @@ window.yii = (function ($) {
 
             var activeFormData = $form.data('yiiActiveForm');
             if (activeFormData) {
-                // remember who triggers the form submission. This is used by yii.activeForm.js
+                // Remember the element triggered the form submission. This is used by yii.activeForm.js.
                 activeFormData.submitObject = $e;
             }
 
-            // temporarily add hidden inputs according to data-params
-            if (params && $.isPlainObject(params)) {
-                $.each(params, function (idx, obj) {
-                    $form.append($('<input/>').attr({name: idx, value: obj, type: 'hidden'}));
+            if (areValidParams) {
+                $.each(params, function (name, value) {
+                    $form.append($('<input/>').attr({name: name, value: value, type: 'hidden'}));
                 });
             }
 
-            var oldMethod = $form.attr('method');
-            $form.attr('method', method);
-            var oldAction = null;
-            if (action && action != '#') {
-                oldAction = $form.attr('action');
-                $form.attr('action', action);
-            }
             if (usePjax) {
-                $form.on('submit',function(e){
+                $form.on('submit', function (e) {
                     $.pjax.submit(e, pjaxOptions);
-                })
+                });
             }
+
             $form.trigger('submit');
-            $.when($form.data('yiiSubmitFinalizePromise')).then(
-                function () {
-                    if (oldAction != null) {
-                        $form.attr('action', oldAction);
-                    }
-                    $form.attr('method', oldMethod);
 
-                    // remove the temporarily added hidden inputs
-                    if (params && $.isPlainObject(params)) {
-                        $.each(params, function (idx, obj) {
-                            $('input[name="' + idx + '"]', $form).remove();
-                        });
-                    }
+            $.when($form.data('yiiSubmitFinalizePromise')).then(function () {
+                if (newForm) {
+                    $form.remove();
+                    return;
+                }
 
-                    if (newForm) {
-                        $form.remove();
-                    }
+                if (oldAction !== undefined) {
+                    $form.attr('action', oldAction);
+                }
+                $form.attr('method', oldMethod);
+
+                if (areValidParams) {
+                    $.each(params, function (name) {
+                        $('input[name="' + name + '"]', $form).remove();
+                    });
                 }
-            );
+            });
         },
 
         getQueryParams: function (url) {
@@ -284,67 +274,183 @@ window.yii = (function ($) {
             }
 
             var pairs = url.substring(pos + 1).split('#')[0].split('&'),
-                params = {},
-                pair,
-                i;
+                params = {};
 
-            for (i = 0; i < pairs.length; i++) {
-                pair = pairs[i].split('=');
+            for (var i = 0, len = pairs.length; i < len; i++) {
+                var pair = pairs[i].split('=');
                 var name = decodeURIComponent(pair[0].replace(/\+/g, '%20'));
                 var value = decodeURIComponent(pair[1].replace(/\+/g, '%20'));
-                if (name.length) {
-                    if (params[name] !== undefined) {
-                        if (!$.isArray(params[name])) {
-                            params[name] = [params[name]];
-                        }
-                        params[name].push(value || '');
-                    } else {
-                        params[name] = value || '';
+                if (!name.length) {
+                    continue;
+                }
+                if (params[name] === undefined) {
+                    params[name] = value || '';
+                } else {
+                    if (!$.isArray(params[name])) {
+                        params[name] = [params[name]];
                     }
+                    params[name].push(value || '');
                 }
             }
             return params;
         },
 
         initModule: function (module) {
-            if (module.isActive === undefined || module.isActive) {
-                if ($.isFunction(module.init)) {
-                    module.init();
-                }
-                $.each(module, function () {
-                    if ($.isPlainObject(this)) {
-                        pub.initModule(this);
-                    }
-                });
+            if (module.isActive !== undefined && !module.isActive) {
+                return;
             }
+            if ($.isFunction(module.init)) {
+                module.init();
+            }
+            $.each(module, function () {
+                if ($.isPlainObject(this)) {
+                    pub.initModule(this);
+                }
+            });
         },
 
         init: function () {
             initCsrfHandler();
             initRedirectHandler();
-            initScriptFilter();
+            initAssetFilters();
             initDataMethods();
+        },
+
+        /**
+         * Returns the URL of the current page without params and trailing slash. Separated and made public for testing.
+         * @returns {string}
+         */
+        getBaseCurrentUrl: function () {
+            return window.location.protocol + '//' + window.location.host;
+        },
+
+        /**
+         * Returns the URL of the current page. Used for testing, you can always call `window.location.href` manually
+         * instead.
+         * @returns {string}
+         */
+        getCurrentUrl: function () {
+            return window.location.href;
         }
     };
 
+    function initCsrfHandler() {
+        // automatically send CSRF token for all AJAX requests
+        $.ajaxPrefilter(function (options, originalOptions, xhr) {
+            if (!options.crossDomain && pub.getCsrfParam()) {
+                xhr.setRequestHeader('X-CSRF-Token', pub.getCsrfToken());
+            }
+        });
+        pub.refreshCsrfToken();
+    }
+
     function initRedirectHandler() {
         // handle AJAX redirection
-        $(document).ajaxComplete(function (event, xhr, settings) {
+        $(document).ajaxComplete(function (event, xhr) {
             var url = xhr && xhr.getResponseHeader('X-Redirect');
             if (url) {
-                window.location = url;
+                window.location.assign(url);
             }
         });
     }
 
-    function initCsrfHandler() {
-        // automatically send CSRF token for all AJAX requests
-        $.ajaxPrefilter(function (options, originalOptions, xhr) {
-            if (!options.crossDomain && pub.getCsrfParam()) {
-                xhr.setRequestHeader('X-CSRF-Token', pub.getCsrfToken());
+    function initAssetFilters() {
+        /**
+         * Used for storing loaded scripts and information about loading each script if it's in the process of loading.
+         * A single script can have one of the following values:
+         *
+         * - `undefined` - script was not loaded at all before or was loaded with error last time.
+         * - `true` (boolean) -  script was successfully loaded.
+         * - object - script is currently loading.
+         *
+         * In case of a value being an object the properties are:
+         * - `xhrList` - represents a queue of XHR requests sent to the same URL (related with this script) in the same
+         * small period of time.
+         * - `xhrDone` - boolean, acts like a locking mechanism. When one of the XHR requests in the queue is
+         * successfully completed, it will abort the rest of concurrent requests to the same URL until cleanup is done
+         * to prevent possible errors and race conditions.
+         * @type {{}}
+         */
+        var loadedScripts = {};
+
+        $('script[src]').each(function () {
+            var url = getAbsoluteUrl(this.src);
+            loadedScripts[url] = true;
+        });
+
+        $.ajaxPrefilter('script', function (options, originalOptions, xhr) {
+            if (options.dataType == 'jsonp') {
+                return;
             }
+
+            var url = getAbsoluteUrl(options.url),
+                forbiddenRepeatedLoad = loadedScripts[url] === true && !isReloadableAsset(url),
+                cleanupRunning = loadedScripts[url] !== undefined && loadedScripts[url]['xhrDone'] === true;
+
+            if (forbiddenRepeatedLoad || cleanupRunning) {
+                xhr.abort();
+                return;
+            }
+
+            if (loadedScripts[url] === undefined || loadedScripts[url] === true) {
+                loadedScripts[url] = {
+                    xhrList: [],
+                    xhrDone: false
+                };
+            }
+
+            xhr.done(function (data, textStatus, jqXHR) {
+                // If multiple requests were successfully loaded, perform cleanup only once
+                if (loadedScripts[jqXHR.yiiUrl]['xhrDone'] === true) {
+                    return;
+                }
+
+                loadedScripts[jqXHR.yiiUrl]['xhrDone'] = true;
+
+                for (var i = 0, len = loadedScripts[jqXHR.yiiUrl]['xhrList'].length; i < len; i++) {
+                    var singleXhr = loadedScripts[jqXHR.yiiUrl]['xhrList'][i];
+                    if (singleXhr && singleXhr.readyState !== XMLHttpRequest.DONE) {
+                        singleXhr.abort();
+                    }
+                }
+
+                loadedScripts[jqXHR.yiiUrl] = true;
+            }).fail(function (jqXHR, textStatus) {
+                if (textStatus === 'abort') {
+                    return;
+                }
+
+                delete loadedScripts[jqXHR.yiiUrl]['xhrList'][jqXHR.yiiIndex];
+
+                var allFailed = true;
+                for (var i = 0, len = loadedScripts[jqXHR.yiiUrl]['xhrList'].length; i < len; i++) {
+                    if (loadedScripts[jqXHR.yiiUrl]['xhrList'][i]) {
+                        allFailed = false;
+                    }
+                }
+
+                if (allFailed) {
+                    delete loadedScripts[jqXHR.yiiUrl];
+                }
+            });
+            // Use prefix for custom XHR properties to avoid possible conflicts with existing properties
+            xhr.yiiIndex = loadedScripts[url]['xhrList'].length;
+            xhr.yiiUrl = url;
+
+            loadedScripts[url]['xhrList'][xhr.yiiIndex] = xhr;
+        });
+
+        $(document).ajaxComplete(function () {
+            var styleSheets = [];
+            $('link[rel=stylesheet]').each(function () {
+                var url = getAbsoluteUrl(this.href);
+                if (isReloadableAsset(url)) {
+                    return;
+                }
+
+                $.inArray(url, styleSheets) === -1 ? styleSheets.push(url) : $(this).remove();
+            });
         });
-        pub.refreshCsrfToken();
     }
 
     function initDataMethods() {
@@ -374,13 +480,9 @@ window.yii = (function ($) {
             .on('change.yii', pub.changeableSelector, handler);
     }
 
-    function isReloadable(url) {
-        var hostInfo = getHostInfo();
-
+    function isReloadableAsset(url) {
         for (var i = 0; i < pub.reloadableScripts.length; i++) {
-            var rule = pub.reloadableScripts[i];
-            rule = rule.charAt(0) === '/' ? hostInfo + rule : rule;
-
+            var rule = getAbsoluteUrl(pub.reloadableScripts[i]);
             var match = new RegExp("^" + escapeRegExp(rule).split('\\*').join('.*') + "$").test(url);
             if (match === true) {
                 return true;
@@ -395,76 +497,18 @@ window.yii = (function ($) {
         return str.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g, "\\$&");
     }
 
-    function getHostInfo() {
-        return location.protocol + '//' + location.host;
-    }
-
-    function initScriptFilter() {
-        var hostInfo = getHostInfo();
-        var loadedScripts = {};
-
-        var scripts = $('script[src]').map(function () {
-            return this.src.charAt(0) === '/' ? hostInfo + this.src : this.src;
-        }).toArray();
-        for (var i = 0, len = scripts.length; i < len; i++) {
-            loadedScripts[scripts[i]] = true;
-        }
-
-        $.ajaxPrefilter('script', function (options, originalOptions, xhr) {
-            if (options.dataType == 'jsonp') {
-                return;
-            }
-
-            var url = options.url.charAt(0) === '/' ? hostInfo + options.url : options.url;
-
-            if (url in loadedScripts) {
-                var item = loadedScripts[url];
-
-                // If the concurrent XHR request is running and URL is not reloadable
-                if (item !== true && !isReloadable(url)) {
-                    // Abort the current XHR request when previous finished successfully
-                    item.done(function () {
-                        if (xhr && xhr.readyState !== 4) {
-                            xhr.abort();
-                        }
-                    });
-                    // Or abort previous XHR if the current one is loaded faster
-                    xhr.done(function () {
-                        if (item && item.readyState !== 4) {
-                            item.abort();
-                        }
-                    });
-                } else if (!isReloadable(url)) {
-                    xhr.abort();
-                }
-            } else {
-                loadedScripts[url] = xhr.done(function () {
-                    loadedScripts[url] = true;
-                }).fail(function () {
-                    delete loadedScripts[url];
-                });
-            }
-        });
-
-        $(document).ajaxComplete(function (event, xhr, settings) {
-            var styleSheets = [];
-            $('link[rel=stylesheet]').each(function () {
-                if (isReloadable(this.href)) {
-                    return;
-                }
-                if ($.inArray(this.href, styleSheets) == -1) {
-                    styleSheets.push(this.href)
-                } else {
-                    $(this).remove();
-                }
-            })
-        });
+    /**
+     * Returns absolute URL based on the given URL
+     * @param {string} url Initial URL
+     * @returns {string}
+     */
+    function getAbsoluteUrl(url) {
+        return url.charAt(0) === '/' ? pub.getBaseCurrentUrl() + url : url;
     }
 
     return pub;
-})(jQuery);
+})(window.jQuery);
 
-jQuery(function () {
-    yii.initModule(yii);
+window.jQuery(function () {
+    window.yii.initModule(window.yii);
 });
-
diff --git a/framework/web/Response.php b/framework/web/Response.php
index 2ec4d6b0f..539966ed6 100644
--- a/framework/web/Response.php
+++ b/framework/web/Response.php
@@ -782,7 +782,7 @@ class Response extends \yii\base\Response
      *
      * ```javascript
      * $document.ajaxComplete(function (event, xhr, settings) {
-     *     var url = xhr.getResponseHeader('X-Redirect');
+     *     var url = xhr && xhr.getResponseHeader('X-Redirect');
      *     if (url) {
      *         window.location = url;
      *     }
diff --git a/tests/js/data/yii.html b/tests/js/data/yii.html
new file mode 100644
index 000000000..ce040d641
--- /dev/null
+++ b/tests/js/data/yii.html
@@ -0,0 +1,194 @@
+<!doctype html>
+<html>
+  <head>
+    <meta charset="utf-8">
+    <meta name="csrf-param" content="_csrf">
+    <meta name="csrf-token" content="foobar">
+  </head>
+  <body id="body">
+    <div class="csrf">
+      <form id="form1">
+        <input name="_csrf" value="" type="hidden">
+      </form>
+
+      <form id="form2">
+        <input name="_csrf" value="" type="hidden">
+      </form>
+    </div>
+
+    <div class="handle-action">
+      <!-- The rest of pjax related attributes are set using JS to prevent copy pasting and for better readability -->
+
+      <div class="no-method">
+        <div class="invalid">
+          <div class="no-form">
+            <a class="link-no-href"></a>
+            <a class="link-empty-href" href=""></a>
+            <a class="link-anchor-href" href="#"></a>
+
+            <a class="link-no-href-pjax" data-pjax></a>
+            <a class="link-empty-href-pjax" href="" data-pjax></a>
+            <a class="link-anchor-href-pjax" href="#" data-pjax></a>
+
+            <input class="not-submit-no-form" type="text">
+            <input class="submit-no-form" type="submit">
+            <button class="submit-form-not-exist" data-form="not-existing-form"></button>
+
+            <input class="not-submit-no-form-pjax" type="text" data-pjax>
+            <input class="submit-no-form-pjax" type="submit" data-pjax>
+            <button class="submit-form-not-exist-pjax" data-form="not-existing-form" data-pjax></button>
+          </div>
+
+          <div class="form">
+            <form id="not-submit-separate-form">
+              <input name="query" value="a">
+            </form>
+
+            <button class="not-submit-outside-form" type="button" data-form="not-submit-separate-form"></button>
+            <form id="not-submit-parent-form">
+              <input class="not-submit-inside-form" type="reset">
+            </form>
+
+            <button class="not-submit-outside-form-pjax"
+                    type="button"
+                    data-form="not-submit-separate-form"
+                    data-pjax></button>
+            <form id="not-submit-parent-form-pjax">
+              <input class="not-submit-inside-form-pjax" type="reset" data-pjax>
+            </form>
+          </div>
+        </div>
+
+        <div class="valid">
+          <a class="link" href="/tests/index"></a>
+          <a class="link-pjax-0" href="/tests/index" data-pjax="0"></a>
+
+          <a class="link-pjax" href="/tests/index" data-pjax></a>
+          <a class="link-pjax-1" href="/tests/index" data-pjax="1"></a>
+          <a class="link-pjax-true" href="/tests/index" data-pjax="true"></a>
+
+          <div id="pjax-separate-container"></div>
+          <a class="link-pjax-outside-container"
+             href="/tests/index"
+             data-pjax
+             data-pjax-container="#pjax-separate-container"></a>
+
+          <div id="pjax-container-1" data-pjax-container>
+            <div id="pjax-container-2" data-pjax-container>
+              <a class="link-pjax-inside-container" href="/tests/index" data-pjax></a>
+            </div>
+          </div>
+
+          <form id="submit-separate-form">
+            <input name="query" value="a">
+          </form>
+
+          <input class="submit-outside-form" type="submit" data-form="submit-separate-form">
+          <form id="submit-parent-form">
+            <button class="submit-inside-form"></button>
+          </form>
+
+          <input class="submit-outside-form-pjax" type="submit" data-form="submit-separate-form" data-pjax>
+
+          <form id="submit-parent-form-pjax">
+            <button class="submit-inside-form-pjax" data-pjax></button>
+          </form>
+        </div>
+      </div>
+
+      <div class="method">
+        <div class="no-form">
+          <a class="bad-href" href="#" data-method="get"></a>
+          <a class="bad-params" href="/tests/index" data-method="get" data-params="{'foo':'1','bar':'2'}"></a>
+
+          <a class="get-params-target"
+             href="/tests/index"
+             target="_blank"
+             data-method="get"
+             data-params='{"foo":"1","bar":"2"}'></a>
+          <a class="head" href="/tests/index" data-method="head" data-params='{"foo":"1","bar":"2"}'></a>
+          <a class="post" href="/tests/index" data-method="post" data-params='{"foo":"1","bar":"2"}'></a>
+          <a class="post-upper-case" href="/tests/index" data-method="POST" data-params='{"foo":"1","bar":"2"}'></a>
+          <a class="put" href="/tests/index" data-method="put" data-params='{"foo":"1","bar":"2"}'></a>
+
+          <a class="get-params-pjax"
+             href="/tests/index"
+             data-method="get"
+             data-params='{"foo":"1","bar":"2"}'
+             data-pjax></a>
+        </div>
+
+        <div class="form">
+          <a class="new-action-new-method"
+             href="/search"
+             data-method="post"
+             data-form="method-form"
+             data-params='{"foo":"1","bar":"2"}'></a>
+          <a class="same-action-same-method"
+             href="/tests/search"
+             data-method="get"
+             data-form="method-form"
+             data-params='{"foo":"1","bar":"2"}'></a>
+          <a class="bad-action-new-method"
+             href="#"
+             data-method="post"
+             data-form="method-form"
+             data-params='{"foo":"1","bar":"2"}'></a>
+
+          <form id="method-form" method="get" action="/tests/search">
+            <input name="query" value="a">
+          </form>
+
+          <!-- https://github.com/yiisoft/yii2/pull/8014 -->
+
+          <a class="hidden-method-action"
+             href="/tests/search"
+             data-method="get"
+             data-form="form-hidden-method-action"
+             data-params='{"foo":"1","bar":"2"}'></a>
+
+          <form id="form-hidden-method-action" method="get" action="/tests/search">
+            <input name="query" value="a">
+            <input name="method" value="b" type="hidden">
+            <input name="action" value="c" type="hidden">
+          </form>
+
+          <a class="new-action-new-method-pjax"
+             href="/search"
+             data-method="post"
+             data-form="method-form"
+             data-params='{"foo":"1","bar":"2"}'
+             data-pjax></a>
+        </div>
+      </div>
+    </div>
+
+    <div class="data-methods">
+      <a id="data-methods-no-data" class="data-methods-element" href="/tests/index"></a>
+      <a id="data-methods-click-confirm"
+         class="data-methods-element"
+         href="/tests/index"
+         data-confirm="Are you sure?"></a>
+      <form>
+        <select id="data-methods-change" class="data-methods-element" data-method="get">
+          <option value="1">html</option>
+          <option value="2">css</option>
+        </select>
+      </form>
+    </div>
+
+    <div class="asset-filters">
+      <div class="scripts">
+        <script src="/js/existing1.js"></script>
+        <!-- To test correct work with absolute urls -->
+        <script src="http://foo.bar/js/existing2.js"></script>
+      </div>
+
+      <div class="stylesheets">
+        <link id="stylesheet1" href="/css/stylesheet1.css" rel="stylesheet">
+        <!-- To test correct work with absolute urls -->
+        <link id="stylesheet2" href="http://foo.bar/css/stylesheet2.css" rel="stylesheet">
+      </div>
+    </div>
+  </body>
+</html>
diff --git a/tests/js/tests/yii.test.js b/tests/js/tests/yii.test.js
new file mode 100644
index 000000000..ce0ce7c01
--- /dev/null
+++ b/tests/js/tests/yii.test.js
@@ -0,0 +1,1425 @@
+var assert = require('chai').assert;
+var sinon;
+var withData = require('leche').withData;
+var jsdom = require('mocha-jsdom');
+
+var fs = require('fs');
+var vm = require('vm');
+
+var StringUtils = {
+    /**
+     * Removes line breaks and redundant whitespaces from the given string. Used to compare HTML strings easier,
+     * regardless of the formatting.
+     * @param str Initial string to clean
+     * @returns {string} Cleaned string
+     */
+    cleanHTML: function (str) {
+        return str.replace(/\r?\n|\r|\s\s+/g, '');
+    }
+};
+
+describe('yii', function () {
+    var yiiPath = 'framework/assets/yii.js';
+    var jQueryPath = 'vendor/bower/jquery/dist/jquery.js';
+    var pjaxPath = 'vendor/bower/yii2-pjax/jquery.pjax.js';
+    var sandbox;
+    var $;
+    var yii;
+    var yiiGetBaseCurrentUrlStub;
+    var yiiGetCurrentUrlStub;
+
+    function registerPjax() {
+        var code = fs.readFileSync(pjaxPath);
+        var script = new vm.Script(code);
+        var sandbox = {jQuery: $, window: window, navigator: window.navigator};
+        var context = new vm.createContext(sandbox);
+        script.runInContext(context);
+    }
+
+    function registerTestableCode() {
+        registerPjax();
+
+        var code = fs.readFileSync(yiiPath);
+        var script = new vm.Script(code);
+        sandbox = {window: window, document: window.document, XMLHttpRequest: window.XMLHttpRequest};
+        var context = new vm.createContext(sandbox);
+
+        script.runInContext(context);
+        yii = sandbox.window.yii;
+    }
+
+    /**
+     * Mapping of pjax data attributes with according plugin options
+     * @type {{}}
+     */
+    var pjaxAttributes = {
+        'data-pjax-push-state': 'push',
+        'data-pjax-replace-state': 'replace',
+        'data-pjax-scrollto': 'scrollTo',
+        'data-pjax-push-redirect': 'pushRedirect',
+        'data-pjax-replace-redirect': 'replaceRedirect',
+        'data-pjax-skip-outer-containers': 'skipOuterContainers',
+        'data-pjax-timeout': 'timeout'
+    };
+
+    /**
+     * Add pjax related attributes to all elements with "data-pjax" attribute. Used to prevent copy pasting and for
+     * better readability of the test HTML data.
+     */
+    function addPjaxAttributes() {
+        $.each(pjaxAttributes, function (name, value) {
+            $('[data-pjax]').attr(name, value);
+        });
+    }
+
+    jsdom({
+        html: fs.readFileSync('tests/js/data/yii.html', 'utf-8'),
+        src: fs.readFileSync(jQueryPath, 'utf-8')
+    });
+
+    before(function () {
+        $ = window.$;
+        registerTestableCode();
+        sinon = require('sinon');
+        addPjaxAttributes();
+        yiiGetBaseCurrentUrlStub = sinon.stub(yii, 'getBaseCurrentUrl', function () {
+            return 'http://foo.bar';
+        });
+        yiiGetCurrentUrlStub = sinon.stub(yii, 'getCurrentUrl', function () {
+            return 'http://foo.bar/';
+        });
+    });
+
+    after(function () {
+        yiiGetBaseCurrentUrlStub.restore();
+        yiiGetCurrentUrlStub.restore();
+    });
+
+    describe('getCsrfParam method', function () {
+        it('should return current CSRF parameter name', function () {
+            assert.equal(yii.getCsrfParam(), '_csrf');
+        });
+    });
+
+    describe('getCsrfToken method', function () {
+        it('should return current CSRF parameter value', function () {
+            assert.equal(yii.getCsrfToken(), 'foobar');
+        });
+    });
+
+    describe('CSRF modifying methods', function () {
+        var initialCsrfParam;
+        var initialCsrfToken;
+
+        beforeEach(function () {
+            initialCsrfParam = $('meta[name="csrf-param"]').attr('content');
+            initialCsrfToken = $('meta[name="csrf-token"]').attr('content');
+        });
+
+        // Restore CSRF parameter name and value to initial values because they are used in different tests
+
+        afterEach(function () {
+            $('meta[name="csrf-param"]').attr('content', initialCsrfParam);
+            $('meta[name="csrf-token"]').attr('content', initialCsrfToken);
+        });
+
+        describe('setCsrfToken method', function () {
+            it('should update CSRF parameter name and value with new values', function () {
+                yii.setCsrfToken('_csrf1', 'foobar1');
+
+                assert.equal(yii.getCsrfParam(), '_csrf1');
+                assert.equal(yii.getCsrfToken(), 'foobar1');
+            });
+        });
+
+        describe('refreshCsrfToken method', function () {
+            it('should assign CSRF token values for all forms during initialization', function () {
+                assert.equal($('#form1').find('input[name="_csrf"]').val(), 'foobar');
+                assert.equal($('#form2').find('input[name="_csrf"]').val(), 'foobar');
+            });
+
+            it('should update CSRF token values for all forms after modifying current CSRF token value', function () {
+                $('meta[name="csrf-token"]').attr('content', 'foobar1');
+                yii.refreshCsrfToken();
+
+                assert.equal($('#form1').find('input[name="_csrf"]').val(), 'foobar1');
+                assert.equal($('#form2').find('input[name="_csrf"]').val(), 'foobar1');
+            });
+        });
+    });
+
+    describe('confirm method', function () {
+        var windowConfirmStub;
+        var confirmed;
+        var okSpy;
+        var cancelSpy;
+
+        beforeEach(function () {
+            windowConfirmStub = sinon.stub(window, 'confirm', function () {
+                return confirmed;
+            });
+            okSpy = sinon.spy();
+            cancelSpy = sinon.spy();
+        });
+
+        afterEach(function () {
+            windowConfirmStub.restore();
+            okSpy.reset();
+            cancelSpy.reset();
+        });
+
+        withData({
+            'ok and cancel not set, "OK" selected': [{
+                setOk: false,
+                setCancel: false,
+                confirmChoice: true,
+                expectOkCalled: false,
+                expectCancelCalled: false
+            }],
+            'ok and cancel not set, "Cancel" selected': [{
+                setOk: false,
+                setCancel: false,
+                confirmChoice: false,
+                expectOkCalled: false,
+                expectCancelCalled: false
+            }],
+            'ok set, "OK" selected': [{
+                setOk: true,
+                setCancel: false,
+                confirmChoice: true,
+                expectOkCalled: true,
+                expectCancelCalled: false
+            }],
+            'ok set, "Cancel" selected': [{
+                setOk: true,
+                setCancel: false,
+                confirmChoice: false,
+                expectOkCalled: false,
+                expectCancelCalled: false
+            }],
+            'cancel set, "OK" selected': [{
+                setOk: false,
+                setCancel: true,
+                confirmChoice: true,
+                expectOkCalled: false,
+                expectCancelCalled: false
+            }],
+            'cancel set, "Cancel" selected': [{
+                setOk: false,
+                setCancel: true,
+                confirmChoice: false,
+                expectOkCalled: false,
+                expectCancelCalled: true
+            }],
+            'ok and cancel set, "OK" selected': [{
+                setOk: true,
+                setCancel: true,
+                confirmChoice: true,
+                expectOkCalled: true,
+                expectCancelCalled: false
+            }],
+            'ok and cancel set, "Cancel" selected': [{
+                setOk: true,
+                setCancel: true,
+                confirmChoice: false,
+                expectOkCalled: false,
+                expectCancelCalled: true
+            }]
+        }, function (data) {
+            var setOk = data.setOk;
+            var setCancel = data.setCancel;
+            var confirmChoice = data.confirmChoice;
+            var expectOkCalled = data.expectOkCalled;
+            var expectCancelCalled = data.expectCancelCalled;
+
+            var message = 'should return undefined, confirm should be called once with according message, ';
+            if (expectOkCalled && !expectCancelCalled) {
+                message += 'ok callback should be called once';
+            } else if (!expectOkCalled && expectCancelCalled) {
+                message += 'cancel callback should be called once';
+            } else if (!expectOkCalled && !expectCancelCalled) {
+                message += 'ok and cancel callbacks should not be called';
+            } else {
+                message += 'ok and cancel callbacks should be called once';
+            }
+
+            it(message, function () {
+                confirmed = confirmChoice;
+                
+                var result = yii.confirm('Are you sure?', setOk ? okSpy : undefined, setCancel ? cancelSpy : undefined);
+                
+                assert.isUndefined(result);
+                assert.isTrue(windowConfirmStub.calledOnce);
+                assert.deepEqual(windowConfirmStub.getCall(0).args, ['Are you sure?']);
+                expectOkCalled ? assert.isTrue(okSpy.calledOnce) : assert.isFalse(okSpy.called);
+                expectCancelCalled ? assert.isTrue(cancelSpy.calledOnce) : assert.isFalse(cancelSpy.called);
+            });
+        });
+    });
+
+    describe('handleAction method', function () {
+        var windowLocationAssignStub;
+        var pjaxClickStub;
+        var pjaxSubmitStub;
+        var formSubmitsCount;
+        var initialFormsCount;
+        var $savedSubmittedForm;
+
+        beforeEach(function () {
+            windowLocationAssignStub = sinon.stub(window.location, 'assign');
+            pjaxClickStub = sinon.stub($.pjax, 'click');
+            pjaxSubmitStub = sinon.stub($.pjax, 'submit');
+            initialFormsCount = $('form').length;
+            countFormSubmits();
+        });
+
+        afterEach(function () {
+            windowLocationAssignStub.restore();
+            pjaxClickStub.restore();
+            pjaxSubmitStub.restore();
+            formSubmitsCount = undefined;
+            initialFormsCount = undefined;
+            $savedSubmittedForm = undefined;
+            $(document).off('submit');
+            $('form').off('submit');
+        });
+
+        function countFormSubmits() {
+            formSubmitsCount = 0;
+            $(document).on('submit', 'form', function () {
+                formSubmitsCount++;
+                $savedSubmittedForm = $(this).clone();
+
+                return false;
+            });
+        }
+
+        function verifyNoActions() {
+            assert.isFalse(windowLocationAssignStub.called);
+            assert.isFalse(pjaxClickStub.called);
+
+            assert.equal(formSubmitsCount, 0);
+            assert.isFalse(pjaxSubmitStub.called);
+            assert.equal($('form').length, initialFormsCount);
+        }
+
+        function verifyPageLoad(url) {
+            assert.isTrue(windowLocationAssignStub.calledOnce);
+            assert.deepEqual(windowLocationAssignStub.getCall(0).args, [url]);
+            assert.isFalse(pjaxClickStub.called);
+
+            assert.equal(formSubmitsCount, 0);
+            assert.isFalse(pjaxSubmitStub.called);
+            assert.equal($('form').length, initialFormsCount);
+        }
+
+        function verifyPageLoadWithPjax($element, event, pjaxContainerId) {
+            assert.isFalse(windowLocationAssignStub.called);
+            assert.isTrue(pjaxClickStub.calledOnce);
+
+            assert.equal(formSubmitsCount, 0);
+            assert.isFalse(pjaxSubmitStub.called);
+            assert.equal($('form').length, initialFormsCount);
+
+            assert.strictEqual(pjaxClickStub.getCall(0).args[0], event);
+
+            var pjaxOptions = pjaxClickStub.getCall(0).args[1];
+
+            // container needs to be checked separately
+
+            if (typeof pjaxOptions.container === 'string') {
+                assert.equal(pjaxOptions.container, '#' + pjaxContainerId || 'body');
+            } else {
+                assert.instanceOf(pjaxOptions.container, $);
+                assert.equal(pjaxOptions.container.attr('id'), pjaxContainerId || 'body');
+            }
+            delete pjaxOptions.container;
+
+            assert.deepEqual(pjaxOptions, {
+                push: true,
+                replace: true,
+                scrollTo: 'scrollTo',
+                pushRedirect: 'pushRedirect',
+                replaceRedirect: 'replaceRedirect',
+                skipOuterContainers: 'skipOuterContainers',
+                timeout: 'timeout',
+                originalEvent: event,
+                originalTarget: $element
+            });
+        }
+
+        function verifyFormSubmit($form) {
+            assert.isFalse(windowLocationAssignStub.called);
+            assert.isFalse(pjaxClickStub.called);
+
+            assert.equal(formSubmitsCount, 1);
+            assert.isFalse(pjaxSubmitStub.called);
+            assert.equal($('form').length, initialFormsCount);
+
+            if ($form) {
+                assert.equal($form.attr('id'), $savedSubmittedForm.attr('id'));
+            }
+        }
+
+        function verifyFormSubmitWithPjax($element, event, $form) {
+            assert.isFalse(windowLocationAssignStub.called);
+            assert.isFalse(pjaxClickStub.called);
+
+            assert.equal(formSubmitsCount, 1);
+            assert.isTrue(pjaxSubmitStub.calledOnce);
+            assert.equal($('form').length, initialFormsCount);
+
+            if ($form) {
+                assert.equal($form.attr('id'), $savedSubmittedForm.attr('id'));
+            }
+
+            var pjaxEvent = pjaxSubmitStub.getCall(0).args[0];
+            assert.instanceOf(pjaxEvent, $.Event);
+            assert.equal(pjaxEvent.type, 'submit');
+
+            var pjaxOptions = pjaxSubmitStub.getCall(0).args[1];
+
+            // container needs to be checked separately
+
+            assert.instanceOf(pjaxOptions.container, $);
+            assert.equal(pjaxOptions.container.attr('id'), 'body');
+            delete pjaxOptions.container;
+
+            assert.deepEqual(pjaxOptions, {
+                push: true,
+                replace: true,
+                scrollTo: 'scrollTo',
+                pushRedirect: 'pushRedirect',
+                replaceRedirect: 'replaceRedirect',
+                skipOuterContainers: 'skipOuterContainers',
+                timeout: 'timeout',
+                originalEvent: event,
+                originalTarget: $element
+            });
+        }
+
+        describe('with no data-method', function () {
+            var noActionsMessage = 'should not do any actions related with page load and form submit';
+            var pageLoadMessage = 'should load new page using the link from "href" attribute';
+            var pageLoadWithPjaxMessage = pageLoadMessage + ' with pjax';
+
+            describe('with invalid elements or configuration', function () {
+                describe('with no form', function () {
+                    withData({
+                        // Links
+                        'link, no href': ['.link-no-href'],
+                        'link, empty href': ['.link-empty-href'],
+                        'link, href contains anchor ("#") only': ['.link-anchor-href'],
+                        'link, no href, data-pjax': ['.link-no-href-pjax'],
+                        'link, empty href, data-pjax': ['.link-empty-href-pjax'],
+                        'link, href contains anchor ("#") only, data-pjax': ['.link-anchor-href-pjax'],
+                        // Not links
+                        'not submit, no form': ['.not-submit-no-form'],
+                        'submit, no form': ['.submit-no-form'],
+                        'submit, data-form, form does not exist': ['.submit-form-not-exist'],
+                        'not submit, no form, data-pjax': ['.not-submit-no-form-pjax'],
+                        'submit, no form, data-pjax': ['.submit-no-form-pjax'],
+                        'submit, data-form, form does not exist, data-pjax': ['.submit-form-not-exist-pjax']
+                    }, function (elementSelector) {
+                        it(noActionsMessage, function () {
+                            var $element = $('.handle-action .no-method .invalid .no-form').find(elementSelector);
+                            assert.lengthOf($element, 1);
+
+                            yii.handleAction($element);
+                            verifyNoActions();
+                        });
+                    });
+                });
+
+                describe('with form', function () {
+                    withData({
+                        'not submit, data-form': ['.not-submit-outside-form', '#not-submit-separate-form'],
+                        'not submit, inside a form': ['.not-submit-inside-form', '#not-submit-parent-form'],
+                        'not submit, data-form, data-pjax': [
+                            '.not-submit-outside-form-pjax', '#not-submit-separate-form'
+                        ],
+                        'not submit, inside a form, data-pjax': [
+                            '.not-submit-inside-form-pjax', '#not-submit-parent-form-pjax'
+                        ]
+                    }, function (elementSelector, formSelector) {
+                        it(noActionsMessage, function () {
+                            var $element = $('.handle-action .no-method .invalid .form').find(elementSelector);
+                            assert.lengthOf($element, 1);
+
+                            var $form = $(formSelector);
+                            assert.lengthOf($form, 1);
+
+                            yii.handleAction($element);
+                            verifyNoActions();
+                        });
+                    });
+                });
+            });
+
+            describe('with valid elements and configuration', function () {
+                describe('with no form', function () {
+                    withData({
+                        'link': ['.link'],
+                        'link, data-pjax="0"': ['.link-pjax-0']
+                    }, function (elementSelector) {
+                        it(pageLoadMessage, function () {
+                            var $element = $('.handle-action .no-method .valid').find(elementSelector);
+                            assert.lengthOf($element, 1);
+
+                            yii.handleAction($element);
+                            verifyPageLoad('/tests/index');
+                        });
+                    });
+
+                    describe('with link, data-pjax and no pjax support', function () {
+                        before(function () {
+                            $.support.pjax = false;
+                        });
+
+                        after(function () {
+                            $.support.pjax = true;
+                        });
+
+                        it(pageLoadMessage, function () {
+                            var $element = $('.handle-action .no-method .valid .link-pjax');
+                            assert.lengthOf($element, 1);
+
+                            yii.handleAction($element);
+                            verifyPageLoad('/tests/index');
+                        });
+                    });
+
+                    withData({
+                        'link, data-pjax': ['.link-pjax', 'body'],
+                        'link, data-pjax="1"': ['.link-pjax-1', 'body'],
+                        'link, data-pjax="true"': ['.link-pjax-true', 'body'],
+                        'link, data-pjax, outside a container': [
+                            '.link-pjax-outside-container', 'pjax-separate-container'
+                        ],
+                        'link href, data-pjax, inside a container': ['.link-pjax-inside-container', 'pjax-container-2']
+                    }, function (elementSelector, expectedPjaxContainerId) {
+                        it(pageLoadWithPjaxMessage, function () {
+                            var event = $.Event('click');
+                            var $element = $('.handle-action .no-method .valid').find(elementSelector);
+                            assert.lengthOf($element, 1);
+
+                            yii.handleAction($element, event);
+                            verifyPageLoadWithPjax($element, event, expectedPjaxContainerId);
+                        });
+                    });
+                });
+
+                describe('with form', function () {
+                    withData({
+                        'submit, data-form': ['.submit-outside-form', '#submit-separate-form'],
+                        'submit, inside a form': ['.submit-inside-form', '#submit-parent-form']
+                    }, function (elementSelector, formSelector) {
+                        it('should submit according existing form', function () {
+                            var $element = $('.handle-action .no-method .valid').find(elementSelector);
+                            assert.lengthOf($element, 1);
+
+                            var $form = $(formSelector);
+                            var initialFormHtml = $form.get(0).outerHTML;
+                            assert.lengthOf($form, 1);
+
+                            yii.handleAction($element);
+
+                            verifyFormSubmit($form);
+                            assert.equal($savedSubmittedForm.get(0).outerHTML, initialFormHtml);
+                        });
+                    });
+
+                    withData({
+                        'submit, data-form, data-pjax': ['.submit-outside-form-pjax', '#submit-separate-form'],
+                        'submit, inside a form, data-pjax': ['.submit-inside-form-pjax', '#submit-parent-form-pjax']
+                    }, function (elementSelector, formSelector) {
+                        it('should submit according existing form with pjax', function () {
+                            var event = $.Event('click');
+                            var $element = $('.handle-action .no-method .valid').find(elementSelector);
+                            assert.lengthOf($element, 1);
+
+                            var $form = $(formSelector);
+                            var initialFormHtml = $form.get(0).outerHTML;
+                            assert.lengthOf($form, 1);
+
+                            yii.handleAction($element, event);
+
+                            verifyFormSubmitWithPjax($element, event, $form);
+                            assert.equal($savedSubmittedForm.get(0).outerHTML, initialFormHtml);
+                        });
+                    });
+                });
+            });
+        });
+
+        describe('with data-method', function () {
+            describe('with no form', function () {
+                withData({
+                    'invalid href': [
+                        '.bad-href',
+                        '<form method="get" action="http://foo.bar/" style="display: none;"></form>'
+                    ],
+                    'invalid data-params': [
+                        '.bad-params',
+                        '<form method="get" action="/tests/index" style="display: none;"></form>'
+                    ],
+                    'data-method="get", data-params, target': [
+                        '.get-params-target',
+                        '<form method="get" action="/tests/index" target="_blank" style="display: none;">' +
+                        '<input name="foo" value="1" type="hidden">' +
+                        '<input name="bar" value="2" type="hidden">' +
+                        '</form>'
+                    ],
+                    'data-method="head", data-params': [
+                        '.head',
+                        '<form method="post" action="/tests/index" style="display: none;">' +
+                        '<input name="_method" value="head" type="hidden">' +
+                        '<input name="_csrf" value="foobar" type="hidden">' +
+                        '<input name="foo" value="1" type="hidden">' +
+                        '<input name="bar" value="2" type="hidden">' +
+                        '</form>'
+                    ],
+                    'data-method="post", data-params': [
+                        '.post',
+                        '<form method="post" action="/tests/index" style="display: none;">' +
+                        '<input name="_csrf" value="foobar" type="hidden">' +
+                        '<input name="foo" value="1" type="hidden">' +
+                        '<input name="bar" value="2" type="hidden">' +
+                        '</form>'
+                    ],
+                    'data-method="post", data-params, upper case': [
+                        '.post-upper-case',
+                        '<form method="POST" action="/tests/index" style="display: none;">' +
+                        '<input name="_csrf" value="foobar" type="hidden">' +
+                        '<input name="foo" value="1" type="hidden">' +
+                        '<input name="bar" value="2" type="hidden">' +
+                        '</form>'
+                    ],
+                    'data-method="put", data-params': [
+                        '.put',
+                        '<form method="post" action="/tests/index" style="display: none;">' +
+                        '<input name="_method" value="put" type="hidden">' +
+                        '<input name="_csrf" value="foobar" type="hidden">' +
+                        '<input name="foo" value="1" type="hidden">' +
+                        '<input name="bar" value="2" type="hidden">' +
+                        '</form>'
+                    ]
+                }, function (elementSelector, expectedFormHtml) {
+                    it('should create temporary form and submit it', function () {
+                        var $element = $('.handle-action .method .no-form').find(elementSelector);
+                        assert.lengthOf($element, 1);
+
+                        yii.handleAction($element);
+
+                        verifyFormSubmit();
+                        assert.equal($savedSubmittedForm.get(0).outerHTML, expectedFormHtml);
+                    });
+                });
+
+                describe('with data-method="get", data-params, data-pjax', function () {
+                    it('should create temporary form and submit it with pjax', function () {
+                        var event = $.Event('click');
+                        var $element = $('.handle-action .method .no-form .get-params-pjax');
+                        assert.lengthOf($element, 1);
+
+                        yii.handleAction($element, event);
+
+                        verifyFormSubmitWithPjax($element, event);
+
+                        var expectedFormHtml = '<form method="get" action="/tests/index" style="display: none;">' +
+                            '<input name="foo" value="1" type="hidden">' +
+                            '<input name="bar" value="2" type="hidden">' +
+                            '</form>';
+                        assert.equal($savedSubmittedForm.get(0).outerHTML, expectedFormHtml);
+                    });
+                });
+            });
+
+            describe('with form', function () {
+                withData({
+                    'data-form, new action, new method, data-params': [
+                        '.new-action-new-method',
+                        '#method-form',
+                        '<form id="method-form" method="post" action="/search">' +
+                        '<input name="query" value="a">' +
+                        '<input name="foo" value="1" type="hidden">' +
+                        '<input name="bar" value="2" type="hidden">' +
+                        '</form>'
+                    ],
+                    'data-form, same action, same method, data-params': [
+                        '.same-action-same-method',
+                        '#method-form',
+                        '<form id="method-form" method="get" action="/tests/search">' +
+                        '<input name="query" value="a">' +
+                        '<input name="foo" value="1" type="hidden">' +
+                        '<input name="bar" value="2" type="hidden">' +
+                        '</form>'
+                    ],
+                    'data-form, invalid action, new method, data-params': [
+                        '.bad-action-new-method',
+                        '#method-form',
+                        '<form id="method-form" method="post" action="/tests/search">' +
+                        '<input name="query" value="a">' +
+                        '<input name="foo" value="1" type="hidden">' +
+                        '<input name="bar" value="2" type="hidden">' +
+                        '</form>'
+                    ],
+                    // This is a test for this PR:
+                    // https://github.com/yiisoft/yii2/pull/8014
+                    //
+                    // However the bug currently can not be reproduced in jsdom:
+                    // https://github.com/tmpvar/jsdom/issues/1688
+                    'data-form, same action, same method, hidden "method" and "action" inputs in data-params': [
+                        '.hidden-method-action',
+                        '#form-hidden-method-action',
+                        '<form id="form-hidden-method-action" method="get" action="/tests/search">' +
+                        '<input name="query" value="a">' +
+                        '<input name="method" value="b" type="hidden">' +
+                        '<input name="action" value="c" type="hidden">' +
+                        '<input name="foo" value="1" type="hidden">' +
+                        '<input name="bar" value="2" type="hidden">' +
+                        '</form>'
+                    ]
+                }, function (elementSelector, formSelector, expectedSubmittedFormHtml) {
+                    var message = 'should modify according existing form, submit it and restore to initial condition';
+                    it(message, function () {
+                        var $element = $('.handle-action .method .form').find(elementSelector);
+                        assert.lengthOf($element, 1);
+
+                        var $form = $(formSelector);
+                        var initialFormHtml = $form.get(0).outerHTML;
+                        assert.lengthOf($form, 1);
+
+                        $form.data('yiiActiveForm', {});
+
+                        yii.handleAction($element);
+
+                        verifyFormSubmit($form);
+
+                        var submittedFormHtml = StringUtils.cleanHTML($savedSubmittedForm.get(0).outerHTML);
+                        assert.equal(submittedFormHtml, expectedSubmittedFormHtml);
+                        assert.equal($form.get(0).outerHTML, initialFormHtml);
+
+                        // When activeForm is used for this form, the element triggered the submit should be remembered
+                        // in jQuery data under according key
+                        assert.strictEqual($form.data('yiiActiveForm').submitObject, $element);
+                    });
+                });
+
+                describe('with data-form, new action, new method, data-params, data-pjax', function () {
+                    var message = 'should modify according existing form, submit it with pjax and restore to ' +
+                        ' initial condition';
+                    it(message, function () {
+                        var event = $.Event('click');
+                        var $element = $('.handle-action .method .form .new-action-new-method-pjax');
+                        assert.lengthOf($element, 1);
+
+                        var $form = $('#method-form');
+                        var initialFormHtml = $form.get(0).outerHTML;
+                        assert.lengthOf($form, 1);
+
+                        yii.handleAction($element, event);
+
+                        verifyFormSubmitWithPjax($element, event, $form);
+
+                        var expectedSubmittedFormHtml = '<form id="method-form" method="post" action="/search">' +
+                            '<input name="query" value="a">' +
+                            '<input name="foo" value="1" type="hidden">' +
+                            '<input name="bar" value="2" type="hidden">' +
+                            '</form>';
+                        var submittedFormHtml = StringUtils.cleanHTML($savedSubmittedForm.get(0).outerHTML);
+                        assert.equal(submittedFormHtml, expectedSubmittedFormHtml);
+                        assert.equal($form.get(0).outerHTML, initialFormHtml);
+                    });
+                });
+            });
+        });
+    });
+
+    describe('getQueryParams method', function () {
+        withData({
+            'no query parameters': ['/posts/index', {}],
+            'query parameters': ['/posts/index?foo=1&bar=2', {foo: '1', bar: '2'}],
+            'query parameter with multiple values (not array)': ['/posts/index?foo=1&foo=2', {'foo': ['1', '2']}],
+            'query parameter with multiple values (array)': ['/posts/index?foo[]=1&foo[]=2', {'foo[]': ['1', '2']}],
+            'anchor': ['/posts/index#post', {}],
+            'query parameters, anchor': ['/posts/index?foo=1&bar=2#post', {foo: '1', bar: '2'}],
+            'relative url, query parameters': ['?foo=1&bar=2', {foo: '1', bar: '2'}],
+            'relative url, anchor': ['#post', {}],
+            'relative url, query parameters, anchor': ['?foo=1&bar=2#post', {foo: '1', bar: '2'}],
+            'skipped parameter name': ['?foo=1&=2&baz=3#post', {foo: '1', baz: '3'}],
+            'skipped values': [
+                '?foo=&PostSearch[tags][]=1&PostSearch[tags][]=', {foo: '', 'PostSearch[tags][]': ['1', '']}
+            ],
+            'encoded URI component': ['/posts/index?query=' + encodeURIComponent('count >= 1'), {query: 'count >= 1'}],
+            // https://github.com/yiisoft/yii2/issues/11921
+            'encoded URI component, "+" signs': [
+                '/posts/index?next+celebration+day=Sunday+January+1st&' +
+                'increase+' + encodeURIComponent('++') + '+' + encodeURIComponent('%') +
+                '='
+                + encodeURIComponent('++') + '+20+' + encodeURIComponent('%'),
+                {'next celebration day': 'Sunday January 1st', 'increase ++ %': '++ 20 %'}
+            ],
+            'multiple arrays, anchor': [
+                '/posts/index?CategorySearch[id]=1&CategorySearch[name]=a' +
+                '&PostSearch[name]=b&PostSearch[category_id]=2&PostSearch[tags][]=3&PostSearch[tags][]=4' +
+                '&foo[]=5&foo[]=6&bar=7#post',
+                {
+                    'CategorySearch[id]': '1',
+                    'CategorySearch[name]': 'a',
+                    'PostSearch[name]': 'b',
+                    'PostSearch[category_id]': '2',
+                    'PostSearch[tags][]': ['3', '4'],
+                    'foo[]': ['5', '6'],
+                    bar: '7'
+                }
+            ]
+        }, function (url, expectedParams) {
+            it('should parse all query parameters from string and return them within a object', function () {
+                assert.deepEqual(yii.getQueryParams(url), expectedParams);
+            });
+        });
+    });
+
+    describe('initModule method', function () {
+        var calledInitMethods = [];
+        var rootModuleInit = function () {
+            calledInitMethods.push('rootModule');
+        };
+
+        afterEach(function () {
+            calledInitMethods = [];
+        });
+
+        withData({
+            'isActive is undefined in the root module': [
+                undefined,
+                rootModuleInit,
+                ['rootModule', 'isActiveUndefined', 'isActiveTrue', 'subModule', 'subModule2']
+            ],
+            'isActive is true in the root module': [
+                true,
+                rootModuleInit,
+                ['rootModule', 'isActiveUndefined', 'isActiveTrue', 'subModule', 'subModule2']
+            ],
+            'isActive is false in the root module': [false, rootModuleInit, []],
+            'isActive is undefined in the root module, init is not a method': [
+                undefined,
+                'init',
+                ['isActiveUndefined', 'isActiveTrue', 'subModule', 'subModule2']
+            ]
+        }, function (rootModuleIsActive, rootModuleInit, expectedCalledInitMethods) {
+            var message = 'should call init method in the root module and all submodules depending depending on ' +
+                'activity and if init is a valid method';
+            it(message, function () {
+                // Root module
+
+                var module = (function () {
+                    return {
+                        isActive: rootModuleIsActive,
+                        init: rootModuleInit
+                    };
+                })();
+
+                // Submodules
+
+                module.isActiveUndefined = (function () {
+                    return {
+                        init: function () {
+                            calledInitMethods.push('isActiveUndefined');
+                        }
+                    };
+                })();
+
+                module.isActiveTrue = (function () {
+                    return {
+                        isActive: true,
+                        init: function () {
+                            calledInitMethods.push('isActiveTrue');
+                        }
+                    };
+                })();
+
+                module.isActiveFalse = (function () {
+                    return {
+                        isActive: false,
+                        init: function () {
+                            calledInitMethods.push('isActiveFalse');
+                        }
+                    };
+                })();
+
+                module.initNotFunction = (function () {
+                    return {
+                        init: 'init'
+                    };
+                })();
+
+                module.someInteger = 1;
+                module.someString = 'string';
+
+                module.subModule = (function () {
+                    return {
+                        init: function () {
+                            calledInitMethods.push('subModule');
+                        }
+                    };
+                })();
+
+                module.subModule.subModule2 = (function () {
+                    return {
+                        init: function () {
+                            calledInitMethods.push('subModule2');
+                        }
+                    };
+                })();
+
+                yii.initModule(module);
+                assert.deepEqual(calledInitMethods, expectedCalledInitMethods);
+            });
+        });
+    });
+
+    describe('CSRF handler', function () {
+        var server;
+        var yiiGetCsrfParamStub;
+        var fakeCsrfParam;
+
+        beforeEach(function () {
+            server = sinon.fakeServer.create();
+            window.XMLHttpRequest = global.XMLHttpRequest;
+            yiiGetCsrfParamStub = sinon.stub(yii, 'getCsrfParam', function () {
+                return fakeCsrfParam;
+            })
+        });
+
+        afterEach(function () {
+            server.restore();
+            yiiGetCsrfParamStub.restore();
+        });
+
+        withData({
+            'crossDomain is false, csrfParam is not set': [false, undefined, undefined],
+            'crossDomain is false, csrfParam is set': [false, 'foobar', 'foobar'],
+            'crossDomain is true, csrfParam is not set': [true, undefined, undefined],
+            'crossDomain is true, csrfParam is set': [true, 'foobar', undefined]
+        }, function (crossDomain, csrfParam, expectedHeaderValue) {
+            var message = 'should add header with CSRF token to AJAX requests only when crossDomain is false and ' +
+                'csrf parameter is set';
+            it(message, function () {
+                fakeCsrfParam = csrfParam;
+                $.ajax({
+                    url: '/tests/index',
+                    crossDomain: crossDomain
+                });
+                server.requests[0].respond(200, {}, '');
+
+                assert.lengthOf(server.requests, 1);
+                assert.equal(server.requests[0].requestHeaders['X-CSRF-Token'], expectedHeaderValue);
+            });
+        });
+    });
+
+    describe('redirect handler', function () {
+        var windowLocationAssignStub;
+
+        beforeEach(function () {
+            windowLocationAssignStub = sinon.stub(window.location, 'assign');
+        });
+
+        afterEach(function () {
+            windowLocationAssignStub.restore();
+        });
+
+        // https://github.com/yiisoft/yii2/pull/10974
+        describe('with xhr undefined', function () {
+            it('should not perform redirect', function () {
+                var e = $.Event('ajaxComplete');
+                $('body').trigger(e);
+
+                assert.isFalse(windowLocationAssignStub.called);
+            });
+        });
+
+        describe('with xhr defined', function () {
+            var server;
+            var response = {result: 'OK'};
+
+            beforeEach(function () {
+                server = sinon.fakeServer.create();
+                window.XMLHttpRequest = global.XMLHttpRequest;
+            });
+
+            afterEach(function () {
+                server.restore();
+            });
+
+            describe('with custom header not set', function () {
+                it('should not perform redirect', function () {
+                    $.get('/tests/index');
+                    server.requests[0].respond(200, {}, '');
+
+                    assert.lengthOf(server.requests, 1);
+                    assert.isFalse(windowLocationAssignStub.called);
+                });
+            });
+
+            describe('with custom header set', function () {
+                it('should perform redirect', function () {
+                    $.get('/tests/index');
+                    server.requests[0].respond(200, {'X-Redirect': 'http://redirect.yii'}, '');
+
+                    assert.lengthOf(server.requests, 1);
+                    assert.isTrue(windowLocationAssignStub.calledOnce);
+                    assert.deepEqual(windowLocationAssignStub.getCall(0).args, ['http://redirect.yii']);
+                });
+            });
+        });
+    });
+
+    describe('asset filters', function () {
+        var server;
+        var ajaxDataType;
+        var jsResponse = {
+            status: 200,
+            headers: {'Content-Type': 'application/x-custom-javascript'},
+            body: 'var foobar = 1;'
+        };
+
+        before(function () {
+            // Sent ajax requests with dataType "script" and "jsonp" are not captured by Sinon's fake server.
+            // As a workaround we can use custom dataType.
+            // This $.ajaxPrefilter handler must be run after the one from yii.js.
+            ajaxDataType = 'customscript';
+            $.ajaxPrefilter('script', function () {
+                return ajaxDataType;
+            });
+            $.ajaxSetup({
+                accepts: {
+                    customscript: 'application/x-custom-javascript'
+                },
+                converters: {
+                    'text customscript': function (result) {
+                        return result;
+                    }
+                }
+            });
+        });
+
+        beforeEach(function () {
+            server = sinon.fakeServer.create();
+            // Allowed: /js/test.js, http://foo.bar/js/test.js
+            server.respondWith(/(http:\/\/foo\.bar)?\/js\/.+\.js/, [
+                jsResponse.status,
+                jsResponse.headers,
+                jsResponse.body
+            ]);
+            window.XMLHttpRequest = global.XMLHttpRequest;
+        });
+
+        after(function () {
+            ajaxDataType = 'script';
+        });
+
+        afterEach(function () {
+            server.restore();
+        });
+
+        function respondToRequestWithSuccess(requestIndex) {
+            server.requests[requestIndex].respond(jsResponse.status, jsResponse.headers, jsResponse.body);
+        }
+
+        function respondToRequestWithError(requestIndex) {
+            server.requests[requestIndex].respond(404, {}, '');
+        }
+
+        // Note: Please do not test loading of the script with the same name in different tests. After successful
+        // loading it will stay in loadedScripts and the load will be aborted unless this script is reloadable.
+
+        describe('with scripts', function () {
+            var XHR_UNSENT;
+            var XHR_OPENED;
+            var XHR_DONE;
+
+            before(function () {
+                XHR_UNSENT = window.XMLHttpRequest.UNSENT;
+                XHR_OPENED = window.XMLHttpRequest.OPENED;
+                XHR_DONE = window.XMLHttpRequest.DONE;
+            });
+
+            describe('with jsonp dataType', function () {
+                it('should load it as many times as it was requested', function () {
+                    $.ajax({
+                        url: '/js/jsonp.js',
+                        dataType: 'jsonp'
+                    });
+                    server.respond();
+
+                    $.ajax({
+                        url: '/js/jsonp.js',
+                        dataType: 'jsonp'
+                    });
+                    server.respond();
+
+                    assert.lengthOf(server.requests, 2);
+                    assert.equal(server.requests[0].readyState, XHR_DONE);
+                    assert.equal(server.requests[1].readyState, XHR_DONE);
+                });
+            });
+
+            describe('with scripts loaded on the page load', function () {
+                it('should prevent of loading them again for both relative and absolute urls', function () {
+                    $.getScript('/js/existing1.js');
+                    server.respond();
+
+                    $.getScript('http://foo.bar/js/existing1.js');
+                    server.respond();
+
+                    $.getScript('/js/existing2.js');
+                    server.respond();
+
+                    $.getScript('http://foo.bar/js/existing2.js');
+                    server.respond();
+
+                    assert.lengthOf(server.requests, 0);
+                });
+            });
+
+            describe('with script not loaded before', function () {
+                it('should load it only once for both relative and absolute urls', function () {
+                    $.getScript('/js/new.js');
+                    server.respond();
+
+                    $.getScript('/js/new.js');
+                    server.respond();
+
+                    $.getScript('http://foo.bar/js/new.js');
+                    server.respond();
+
+                    assert.lengthOf(server.requests, 1);
+                    assert.equal(server.requests[0].readyState, XHR_DONE);
+                });
+            });
+
+            describe('with reloadableScripts set', function () {
+                before(function () {
+                    yii.reloadableScripts = [
+                        '/js/reloadable.js',
+                        // https://github.com/yiisoft/yii2/issues/11494
+                        '/js/reloadable/script*.js'
+                    ];
+                });
+
+                after(function () {
+                    yii.reloadableScripts = [];
+                });
+
+                describe('with match', function () {
+                    withData({
+                        'relative url, exact': ['/js/reloadable.js'],
+                        'relative url, wildcard': ['http://foo.bar/js/reloadable/script1.js'],
+                        'absolute url, exact': ['http://foo.bar/js/reloadable.js'],
+                        'absolute url, wildcard': ['http://foo.bar/js/reloadable/script2.js']
+                    }, function (url) {
+                        it('should load it as many times as it was requested', function () {
+                            $.getScript(url);
+                            server.respond();
+
+                            $.getScript(url);
+                            server.respond();
+
+                            assert.lengthOf(server.requests, 2);
+                            assert.equal(server.requests[0].readyState, XHR_DONE);
+                            assert.equal(server.requests[1].readyState, XHR_DONE);
+                        });
+                    });
+                });
+
+                describe('with no match', function () {
+                    withData({
+                        'relative url': ['/js/not_reloadable.js'],
+                        'absolute url': ['http://foo.bar/js/reloadable/not_reloadable_script.js']
+                    }, function (url) {
+                        it('should load it only once for both relative and absolute urls', function () {
+                            $.getScript(url);
+                            server.respond();
+
+                            $.getScript(url);
+                            server.respond();
+
+                            assert.lengthOf(server.requests, 1);
+                            assert.equal(server.requests[0].readyState, XHR_DONE);
+                        });
+                    });
+                });
+
+                describe('with failed load after successful load and making it not reloadable', function () {
+                    it('should allow to load it again', function () {
+                        $.getScript('/js/reloadable/script_fail.js');
+                        respondToRequestWithSuccess(0);
+
+                        $.getScript('/js/reloadable/script_fail.js');
+                        respondToRequestWithError(1);
+                        yii.reloadableScripts = [];
+
+                        $.getScript('/js/reloadable/script_fail.js');
+                        respondToRequestWithError(2);
+
+                        assert.lengthOf(server.requests, 3);
+                        assert.equal(server.requests[0].readyState, XHR_DONE);
+                        assert.equal(server.requests[1].readyState, XHR_DONE);
+                        assert.equal(server.requests[2].readyState, XHR_DONE);
+                    });
+                });
+            });
+
+            // https://github.com/yiisoft/yii2/issues/10358
+            // https://github.com/yiisoft/yii2/issues/13307
+
+            describe('with concurrent requests', function () {
+                // Note: it's not possible to imitate successful loading of all requests, because after the first one
+                // loads, the rest will be aborted by yii.js (readyState will be 0 (UNSENT)).
+                // Sinon requires request to have state 1 (OPENED) for the response to be sent.
+                // Anyway one of the requests will be loaded at least a bit earlier than the others, so we can test
+                // that.
+                describe('with one successfully completed after one failed', function () {
+                    it('should abort remaining requests and disallow to load the script again', function () {
+                        $.getScript('/js/concurrent_success.js');
+                        $.getScript('/js/concurrent_success.js');
+                        $.getScript('/js/concurrent_success.js');
+
+                        assert.lengthOf(server.requests, 3);
+
+                        assert.equal(server.requests[0].readyState, XHR_OPENED);
+                        assert.equal(server.requests[1].readyState, XHR_OPENED);
+                        assert.equal(server.requests[2].readyState, XHR_OPENED);
+
+                        respondToRequestWithError(2);
+                        respondToRequestWithSuccess(1);
+
+                        assert.equal(server.requests[0].readyState, XHR_UNSENT);
+                        assert.isTrue(server.requests[0].aborted);
+                        assert.equal(server.requests[1].readyState, XHR_DONE);
+                        assert.isUndefined(server.requests[1].aborted);
+                        assert.equal(server.requests[2].readyState, XHR_DONE);
+                        assert.isUndefined(server.requests[2].aborted);
+
+                        $.getScript('/js/concurrent_success.js');
+                        server.respond();
+
+                        assert.lengthOf(server.requests, 3);
+                    });
+                });
+
+                describe('with all requests failed', function () {
+                    it('should allow to load the script again', function () {
+                        $.getScript('/js/concurrent_fail.js');
+                        $.getScript('/js/concurrent_fail.js');
+                        $.getScript('/js/concurrent_fail.js');
+
+                        respondToRequestWithError(0);
+                        respondToRequestWithError(1);
+                        respondToRequestWithError(2);
+
+                        $.getScript('/js/concurrent_fail.js');
+
+                        respondToRequestWithSuccess(3);
+
+                        assert.lengthOf(server.requests, 4);
+                        assert.equal(server.requests[0].readyState, XHR_DONE);
+                        assert.equal(server.requests[1].readyState, XHR_DONE);
+                        assert.equal(server.requests[2].readyState, XHR_DONE);
+                        assert.equal(server.requests[3].readyState, XHR_DONE);
+                    });
+                });
+
+                describe('with requests to different urls successfully completed', function () {
+                    it('should not cause any conflicts and disallow to load these scripts again', function () {
+                        $.getScript('/js/concurrent_url1.js');
+                        $.getScript('/js/concurrent_url2.js');
+
+                        $.getScript('/js/concurrent_url1.js');
+                        $.getScript('/js/concurrent_url2.js');
+
+                        respondToRequestWithSuccess(0);
+                        respondToRequestWithSuccess(3);
+
+                        $.getScript('/js/concurrent_url1.js');
+                        $.getScript('/js/concurrent_url2.js');
+
+                        assert.lengthOf(server.requests, 4);
+                        assert.equal(server.requests[0].readyState, XHR_DONE);
+                        assert.isUndefined(server.requests[0].aborted);
+                        assert.equal(server.requests[1].readyState, XHR_UNSENT);
+                        assert.isTrue(server.requests[1].aborted);
+                        assert.equal(server.requests[2].readyState, XHR_UNSENT);
+                        assert.isTrue(server.requests[2].aborted);
+                        assert.equal(server.requests[3].readyState, XHR_DONE);
+                        assert.isUndefined(server.requests[3].aborted);
+                    });
+                });
+            });
+        });
+
+        describe('with stylesheets', function () {
+            // Note: All added stylesheets for the tests must have ".added-stylesheet" class for the proper cleanup
+
+            afterEach(function () {
+                $('.added-stylesheet').remove();
+            });
+
+            describe('with not reloadable assets', function () {
+                it('should not allow to add duplicate stylesheets for both relative and absolute urls', function () {
+                    var $styleSheets = $('.asset-filters .stylesheets');
+                    assert.lengthOf($styleSheets, 1);
+
+                    $.get('/tests/index', function () {
+                        $styleSheets.append(
+                            '<link class="added-stylesheet" href="/css/stylesheet1.css" rel="stylesheet">'
+                        );
+                        $styleSheets.append(
+                            '<link class="added-stylesheet" href="/css/stylesheet2.css" rel="stylesheet">'
+                        );
+                    });
+
+                    server.requests[0].respond(200, {}, '');
+
+                    assert.lengthOf($('link[rel="stylesheet"]'), 2);
+                    assert.lengthOf($('#stylesheet1'), 1);
+                    assert.lengthOf($('#stylesheet2'), 1);
+                });
+            });
+
+            describe('with reloadable assets', function () {
+                before(function () {
+                    yii.reloadableScripts = [
+                        '/css/reloadable.css',
+                        // https://github.com/yiisoft/yii2/issues/11494
+                        '/css/reloadable/stylesheet*.css'
+                    ];
+                });
+
+                after(function () {
+                    yii.reloadableScripts = [];
+                });
+
+                it('should allow to add duplicate stylesheets for both relative and absolute urls', function () {
+                    var $styleSheets = $('.asset-filters .stylesheets');
+                    assert.lengthOf($styleSheets, 1);
+
+                    $.get('/tests/index', function () {
+                        $styleSheets.append(
+                            '<link class="added-stylesheet" href="/css/reloadable.css" rel="stylesheet">'
+                        );
+                        $styleSheets.append(
+                            '<link class="added-stylesheet" href="http://foo.bar/css/reloadable.css" rel="stylesheet">'
+                        );
+                        $styleSheets.append(
+                            '<link class="added-stylesheet" href="/css/reloadable/stylesheet1.css" rel="stylesheet">'
+                        );
+                        $styleSheets.append(
+                            '<link class="added-stylesheet" href="http://foo.bar/css/reloadable/stylesheet1.css" ' +
+                            'rel="stylesheet">'
+                        );
+                    });
+
+                    server.requests[0].respond(200, {}, '');
+
+                    assert.lengthOf($('link[rel=stylesheet]'), 6);
+                });
+            });
+        });
+    });
+
+    describe('data methods', function () {
+        var windowConfirmStub;
+        var yiiConfirmSpy;
+        var yiiHandleActionStub;
+        var extraEventHandlerSpy;
+
+        beforeEach(function () {
+            windowConfirmStub = sinon.stub(window, 'confirm', function () {
+                return true;
+            });
+            yiiConfirmSpy = sinon.spy(yii, 'confirm');
+            yiiHandleActionStub = sinon.stub(yii, 'handleAction');
+            extraEventHandlerSpy = sinon.spy();
+            $(window.document).on('click change', '.data-methods-element', extraEventHandlerSpy);
+        });
+
+        afterEach(function () {
+            windowConfirmStub.restore();
+            yiiConfirmSpy.restore();
+            yiiHandleActionStub.restore();
+            extraEventHandlerSpy.reset();
+            $(window.document).off('click change', '.data-methods-element');
+        });
+
+        describe('with data not set', function () {
+            it('should continue handling interaction with element', function () {
+                var event = $.Event('click');
+                var $element = $('#data-methods-no-data');
+                assert.lengthOf($element, 1);
+
+                $element.trigger(event);
+
+                assert.isFalse(yiiConfirmSpy.called);
+                assert.isFalse(yiiHandleActionStub.called);
+                assert.isTrue(extraEventHandlerSpy.calledOnce);
+            });
+        });
+
+        describe('with clickableSelector with data-confirm', function () {
+            it('should call confirm and handleAction methods', function () {
+                var event = $.Event('click');
+                var elementId = 'data-methods-click-confirm';
+                var $element = $('#' + elementId);
+                assert.lengthOf($element, 1);
+
+                $element.trigger(event);
+
+                assert.isTrue(yiiConfirmSpy.calledOnce);
+                assert.equal(yiiConfirmSpy.getCall(0).args[0], 'Are you sure?');
+                assert.isFunction(yiiConfirmSpy.getCall(0).args[1]);
+                // https://github.com/yiisoft/yii2/issues/10097
+                assert.instanceOf(yiiConfirmSpy.getCall(0).thisValue, window.HTMLAnchorElement);
+                assert.equal(yiiConfirmSpy.getCall(0).thisValue.id, elementId);
+
+                assert.isTrue(yiiHandleActionStub.calledOnce);
+                assert.equal(yiiHandleActionStub.getCall(0).args[0].attr('id'), elementId);
+                assert.strictEqual(yiiHandleActionStub.getCall(0).args[1], event);
+
+                assert.isFalse(extraEventHandlerSpy.called);
+            });
+        });
+
+        describe('with changeableSelector without data-confirm', function () {
+            var elementId = 'data-methods-change';
+            var $element;
+
+            before(function () {
+                $element = $('#' + elementId);
+            });
+
+            after(function () {
+                $element.val('');
+            });
+
+            it('should call handleAction method only', function () {
+                var event = $.Event('change');
+                assert.lengthOf($element, 1);
+
+                $element.val(1);
+                $element.trigger(event);
+
+                assert.isFalse(yiiConfirmSpy.called);
+
+                assert.isTrue(yiiHandleActionStub.calledOnce);
+                assert.equal(yiiHandleActionStub.getCall(0).args[0].attr('id'), elementId);
+                assert.strictEqual(yiiHandleActionStub.getCall(0).args[1], event);
+
+                assert.isFalse(extraEventHandlerSpy.called);
+            });
+        });
+    });
+});
