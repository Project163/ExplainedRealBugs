{"url":"https://api.github.com/repos/yiisoft/yii2/issues/19407","repository_url":"https://api.github.com/repos/yiisoft/yii2","labels_url":"https://api.github.com/repos/yiisoft/yii2/issues/19407/labels{/name}","comments_url":"https://api.github.com/repos/yiisoft/yii2/issues/19407/comments","events_url":"https://api.github.com/repos/yiisoft/yii2/issues/19407/events","html_url":"https://github.com/yiisoft/yii2/issues/19407","id":1244733106,"node_id":"I_kwDOADRbGc5KMR6y","number":19407,"title":"Unique validation rule needs to check if target attribute has previous validation errors","user":{"login":"xcopy","id":202339,"node_id":"MDQ6VXNlcjIwMjMzOQ==","avatar_url":"https://avatars.githubusercontent.com/u/202339?v=4","gravatar_id":"","url":"https://api.github.com/users/xcopy","html_url":"https://github.com/xcopy","followers_url":"https://api.github.com/users/xcopy/followers","following_url":"https://api.github.com/users/xcopy/following{/other_user}","gists_url":"https://api.github.com/users/xcopy/gists{/gist_id}","starred_url":"https://api.github.com/users/xcopy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/xcopy/subscriptions","organizations_url":"https://api.github.com/users/xcopy/orgs","repos_url":"https://api.github.com/users/xcopy/repos","events_url":"https://api.github.com/users/xcopy/events{/privacy}","received_events_url":"https://api.github.com/users/xcopy/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":33208443,"node_id":"MDU6TGFiZWwzMzIwODQ0Mw==","url":"https://api.github.com/repos/yiisoft/yii2/labels/type:bug","name":"type:bug","color":"e102d8","default":false,"description":"Bug"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/yiisoft/yii2/milestones/68","html_url":"https://github.com/yiisoft/yii2/milestone/68","labels_url":"https://api.github.com/repos/yiisoft/yii2/milestones/68/labels","id":7667923,"node_id":"MI_kwDOADRbGc4AdQDT","number":68,"title":"2.0.46","description":"","creator":{"login":"samdark","id":47294,"node_id":"MDQ6VXNlcjQ3Mjk0","avatar_url":"https://avatars.githubusercontent.com/u/47294?v=4","gravatar_id":"","url":"https://api.github.com/users/samdark","html_url":"https://github.com/samdark","followers_url":"https://api.github.com/users/samdark/followers","following_url":"https://api.github.com/users/samdark/following{/other_user}","gists_url":"https://api.github.com/users/samdark/gists{/gist_id}","starred_url":"https://api.github.com/users/samdark/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/samdark/subscriptions","organizations_url":"https://api.github.com/users/samdark/orgs","repos_url":"https://api.github.com/users/samdark/repos","events_url":"https://api.github.com/users/samdark/events{/privacy}","received_events_url":"https://api.github.com/users/samdark/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":102,"state":"closed","created_at":"2022-02-11T13:13:48Z","updated_at":"2022-08-18T22:21:13Z","due_on":null,"closed_at":"2022-08-18T22:21:13Z"},"comments":8,"created_at":"2022-05-23T07:56:52Z","updated_at":"2023-08-23T10:33:24Z","closed_at":"2022-07-29T06:47:36Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"<!--\r\nPlease use this issue tracker for bugs and feature requests only. In case you need support please use one of\r\nYii communities listed at https://github.com/yiisoft/yii2/wiki/communities\r\n-->\r\n\r\n### What steps will reproduce the problem?\r\n\r\n1. Create a `claim` table\r\n```php\r\n$this->createTable('{{%claim}}', [\r\n    'id' => $this->primaryKey(),\r\n    'event_date' => $this->date()->notNull(),\r\n]);\r\n```\r\n\r\n2. Create a `medication` table\r\n```php\r\n$this->createTable('{{%medication}}', [\r\n    'id' => $this->primaryKey(),\r\n    'name' => $this->string()->notNull()->unique(),\r\n]);\r\n```\r\n\r\n3. Create a junction table `claim_medication`\r\n```php\r\n$this->createTable('{{%claim_medication}}', [\r\n    'id' => $this->primaryKey(),\r\n    'claim_id' => $this->integer()->notNull(),\r\n    'medication_id' => $this->integer()->notNull(),\r\n]);\r\n\r\n$this->addForeignKey(\r\n    'fk-claim_medication-claim_id',\r\n    'claim_medication',\r\n    'claim_id',\r\n    'claim',\r\n    'id'\r\n);\r\n\r\n$this->addForeignKey(\r\n    'fk-claim_medication-medication_id',\r\n    'claim_medication',\r\n    'medication_id',\r\n    'medication',\r\n    'id'\r\n);\r\n\r\n// IMPORTANT: unique index on two columns\r\n$this->createIndex(\r\n    'idx-claim_medication-unique',\r\n    'claim_medication',\r\n    ['claim_id', 'medication_id'],\r\n    true\r\n);\r\n```\r\n\r\nGenerated rules in the `ClaimMedication` model:\r\n```php\r\npublic function rules()\r\n{\r\n    return [\r\n        [['claim_id', 'medication_id'], 'required'],\r\n        [['claim_id', 'medication_id'], 'default', 'value' => null],\r\n        [['claim_id', 'medication_id'], 'integer'],\r\n        [['strength', 'quantity', 'duration'], 'string', 'max' => 255],\r\n        [['claim_id', 'medication_id'], 'unique', 'targetAttribute' => ['claim_id', 'medication_id']],\r\n        [['claim_id'], 'exist', 'skipOnError' => true, 'targetClass' => Claim::className(), 'targetAttribute' => ['claim_id' => 'id']],\r\n        [['medication_id'], 'exist', 'skipOnError' => true, 'targetClass' => Medication::className(), 'targetAttribute' => ['medication_id' => 'id']],\r\n    ];\r\n}\r\n```\r\n\r\n4. Try to create a new `ClaimMedication` model\r\n```php\r\n$model = new app\\models\\ClaimMedication();\r\n\r\n// case 1\r\n$model->claim_id = 1;\r\n$model->medication_id = null;\r\n$model->save(); // all good, just one error: \"Medication ID cannot be blank.\"\r\n\r\n// case 2\r\n$model->claim_id = 1;\r\n$model->medication_id = 1;\r\n$model->save(); // all good, no errors\r\n\r\n// case 3\r\n$model->claim_id = 1;\r\n$model->medication_id = ''; // an empty string\r\n$model->save(); // not good\r\n```\r\n\r\n### What is the expected result?\r\n\r\nStill expecting a single error on case 3: `Medication ID cannot be blank.`\r\n\r\n### What do you get instead?\r\n\r\nDatabase exception on case 3 (i.e. `unique` rule in action):\r\n```php\r\nyii\\db\\Exception with message 'SQLSTATE[22P02]: Invalid text representation: 7 ERROR:  invalid input syntax for type integer: \"\"\r\nThe SQL being executed was: SELECT EXISTS(SELECT * FROM \"claim_medication\" WHERE (\"claim_medication\".\"claim_id\"=1) AND (\"claim_medication\".\"medication_id\"=''))'\r\n```\r\n\r\n### Additional info\r\n\r\n| Q                | A\r\n| ---------------- | ---\r\n| Yii version      | 2.0.46-dev\r\n| PHP version      | 7.4.29\r\n| Operating system | Ubuntu 20.04\r\n\r\n**IMPORTANT:** If I swap the order of the rules `required` & `default`, then everything works as expected. But this change may affect of other models. The problem occurs precisely when there is more than one attribute in the rule `unique`.","closed_by":{"login":"samdark","id":47294,"node_id":"MDQ6VXNlcjQ3Mjk0","avatar_url":"https://avatars.githubusercontent.com/u/47294?v=4","gravatar_id":"","url":"https://api.github.com/users/samdark","html_url":"https://github.com/samdark","followers_url":"https://api.github.com/users/samdark/followers","following_url":"https://api.github.com/users/samdark/following{/other_user}","gists_url":"https://api.github.com/users/samdark/gists{/gist_id}","starred_url":"https://api.github.com/users/samdark/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/samdark/subscriptions","organizations_url":"https://api.github.com/users/samdark/orgs","repos_url":"https://api.github.com/users/samdark/repos","events_url":"https://api.github.com/users/samdark/events{/privacy}","received_events_url":"https://api.github.com/users/samdark/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/yiisoft/yii2/issues/19407/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/yiisoft/yii2/issues/19407/timeline","performed_via_github_app":null,"state_reason":"completed"}