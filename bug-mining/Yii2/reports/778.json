{"url":"https://api.github.com/repos/yiisoft/yii2/issues/17174","repository_url":"https://api.github.com/repos/yiisoft/yii2","labels_url":"https://api.github.com/repos/yiisoft/yii2/issues/17174/labels{/name}","comments_url":"https://api.github.com/repos/yiisoft/yii2/issues/17174/comments","events_url":"https://api.github.com/repos/yiisoft/yii2/issues/17174/events","html_url":"https://github.com/yiisoft/yii2/issues/17174","id":415556096,"node_id":"MDU6SXNzdWU0MTU1NTYwOTY=","number":17174,"title":"unlink and link should also use the via on conditions of the relation","user":{"login":"Bhoft","id":1777147,"node_id":"MDQ6VXNlcjE3NzcxNDc=","avatar_url":"https://avatars.githubusercontent.com/u/1777147?v=4","gravatar_id":"","url":"https://api.github.com/users/Bhoft","html_url":"https://github.com/Bhoft","followers_url":"https://api.github.com/users/Bhoft/followers","following_url":"https://api.github.com/users/Bhoft/following{/other_user}","gists_url":"https://api.github.com/users/Bhoft/gists{/gist_id}","starred_url":"https://api.github.com/users/Bhoft/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Bhoft/subscriptions","organizations_url":"https://api.github.com/users/Bhoft/orgs","repos_url":"https://api.github.com/users/Bhoft/repos","events_url":"https://api.github.com/users/Bhoft/events{/privacy}","received_events_url":"https://api.github.com/users/Bhoft/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":33208443,"node_id":"MDU6TGFiZWwzMzIwODQ0Mw==","url":"https://api.github.com/repos/yiisoft/yii2/labels/type:bug","name":"type:bug","color":"e102d8","default":false,"description":"Bug"},{"id":115010082,"node_id":"MDU6TGFiZWwxMTUwMTAwODI=","url":"https://api.github.com/repos/yiisoft/yii2/labels/feature:db","name":"feature:db","color":"bfd4f2","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/yiisoft/yii2/milestones/62","html_url":"https://github.com/yiisoft/yii2/milestone/62","labels_url":"https://api.github.com/repos/yiisoft/yii2/milestones/62/labels","id":6494306,"node_id":"MDk6TWlsZXN0b25lNjQ5NDMwNg==","number":62,"title":"2.0.42","description":"","creator":{"login":"samdark","id":47294,"node_id":"MDQ6VXNlcjQ3Mjk0","avatar_url":"https://avatars.githubusercontent.com/u/47294?v=4","gravatar_id":"","url":"https://api.github.com/users/samdark","html_url":"https://github.com/samdark","followers_url":"https://api.github.com/users/samdark/followers","following_url":"https://api.github.com/users/samdark/following{/other_user}","gists_url":"https://api.github.com/users/samdark/gists{/gist_id}","starred_url":"https://api.github.com/users/samdark/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/samdark/subscriptions","organizations_url":"https://api.github.com/users/samdark/orgs","repos_url":"https://api.github.com/users/samdark/repos","events_url":"https://api.github.com/users/samdark/events{/privacy}","received_events_url":"https://api.github.com/users/samdark/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":47,"state":"closed","created_at":"2021-03-01T21:26:17Z","updated_at":"2021-05-05T21:15:45Z","due_on":null,"closed_at":"2021-05-05T21:15:45Z"},"comments":18,"created_at":"2019-02-28T10:38:43Z","updated_at":"2021-03-15T10:21:00Z","closed_at":"2021-03-14T16:04:10Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Hi \r\nI have a ManyMany relation between 2 Tables e.g. ReviewerInvites and Submissions.\r\nI have an allocation of \"multiple\" reviewer Types e.g. individual review, consensus review.\r\n\r\nTherefore i have an additional column \"reviewer_type\" in the junction Table.\r\nand defined constants like :\r\n\r\n```php\r\n    REVIEW_TYPE_INDIVIDUAL = 1\r\n    REVIEW_TYPE_CONSENSUS = 2\r\n```\r\n\r\nThe Junction Table has the following columns, \r\nsubmission_id, reviewer_invite_id, reviewer_type \r\n\r\n\r\nI could now have the relation in my Submission Model like this:\r\n\r\n```php\r\n    public function getConsensusReviewer()\r\n    {\r\n        return $this->hasMany(ReviewerAllocation::className(), ['submission_id' => 'id'])\r\n            ->andOnCondition(['reviewer_type' => self::REVIEW_TYPE_CONSENSUS]);\r\n    }\r\n\r\n    public function function getConsensusReviewers()\r\n    {\r\n        return $this->hasMany(Reviewer::className(), ['id' => 'reviewer_id'])\r\n             ->via('consensusReviewer');\r\n    }\r\n```\r\n\r\nthe same for the individual reviewers\r\n\r\n```php\r\n    public function getIndividualInvites()\r\n    {\r\n        return $this->hasMany(ReviewerInvite::className(), ['id' => 'reviewer_invite_id'])\r\n            ->via('individualReviewer');\r\n    }\r\n    public function getIndividualReviewer()\r\n    {\r\n        return $this->hasMany(ReviewerAllocation::className(), ['submission_id' => 'id'])\r\n            ->andOnCondition(['reviewer_type' => self::REVIEW_TYPE_INVIVIDUAL]);\r\n    }\r\n```\r\n\r\n\r\nEverything works except \"link()\" and \"unlink()\".\r\n\r\nFor \"link()\" i could use the \"extraColumns\" attribute to set the reviewer_type.\r\nBut when \"unlink()\" is used the On condition isn't used.\r\n\r\nThe SQL always deletes me entries for both reviewer_types:\r\ne.g.\r\n\r\n```sql\r\n    DELETE FROM `submission_reviewer_invite` WHERE (`submission_id`=70) AND (`reviewer_invite_id`=47) \r\n```\r\n\r\ninstead of:\r\n\r\n```sql\r\n    DELETE FROM `submission_reviewer_invite` WHERE (`submission_id`=70) AND (`reviewer_invite_id`=47) AND (`reviewer_type`=2)\r\n```\r\n\r\nI also tried to use viaTable instead of via and set the onCondition directly.\r\n\r\n```php\r\n    public function getIndividualInvites()\r\n    {\r\n        return $this->hasMany(ReviewerInvite::className(), ['id' => 'reviewer_invite_id'])\r\n\t  \t\t->viaTable('submission_reviewer_invite', ['submission_id' => 'id'], function ($query) {\r\n            $query->onCondition(['reviewer_type' => self::REVIEW_TYPE_INVIVIDUAL]);\r\n        });\r\n    }\r\n```\r\n\r\nSame result. \r\nThe additional attribute must be set via extraColumns for link() but for unlink() again the onCondition isn't used. And there is no other way then to create an manual find()->where()->delete() request.\r\n\r\nWhich lets you to the point that several ManyMany releation extensions couldn't been used in this case all which uses unlink() for deleting the relations.\r\nE.g. \r\nhttps://github.com/la-haute-societe/yii2-save-relations-behavior/pull/16/#pullrequestreview-74640908\r\nhttps://github.com/yii2tech/ar-linkmany\r\n\r\n\r\n\r\nSo I wonder why the viaRelation on and where conditions aren't used in e.g. unlink()?\r\n~~https://github.com/yiisoft/yii2/blob/master/framework/db/BaseActiveRecord.php#L1408~~\r\n\r\n\r\n\r\n\r\nWhere something like (after the line above) below would solve this issue:\r\n\r\n```php\r\n            foreach ($viaRelation->on as $key => $value) {\r\n                $columns[$key] = $value;\r\n            } \r\n```\r\n\r\n**Edit:**\r\ncorrect position is above these line because otherwise the key would go into the nulls array. \r\nhttps://github.com/yiisoft/yii2/blob/master/framework/db/BaseActiveRecord.php#L1413\r\n\r\n\r\nSomething similar should also be done for link() of course. \r\n          \r\nI mean if i link between some models where some  additional condition is used this should be a default value of the entry.\r\n\r\nAnd if you unlink no other then the related entries should be deleted.\r\n\r\n  \r\n\r\nI have seen that this kind of request was done multiple times:\r\nhttps://github.com/yiisoft/yii2/issues/14598\r\nhttps://github.com/yiisoft/yii2/issues/4932\r\n\r\n\r\n### Additional info\r\n\r\n| Q                | A\r\n| ---------------- | ---\r\n| Yii version      | 2.0.16?\r\n| PHP version      |  7.1.x\r\n| Operating system | Windows / Linux\r\n","closed_by":{"login":"samdark","id":47294,"node_id":"MDQ6VXNlcjQ3Mjk0","avatar_url":"https://avatars.githubusercontent.com/u/47294?v=4","gravatar_id":"","url":"https://api.github.com/users/samdark","html_url":"https://github.com/samdark","followers_url":"https://api.github.com/users/samdark/followers","following_url":"https://api.github.com/users/samdark/following{/other_user}","gists_url":"https://api.github.com/users/samdark/gists{/gist_id}","starred_url":"https://api.github.com/users/samdark/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/samdark/subscriptions","organizations_url":"https://api.github.com/users/samdark/orgs","repos_url":"https://api.github.com/users/samdark/repos","events_url":"https://api.github.com/users/samdark/events{/privacy}","received_events_url":"https://api.github.com/users/samdark/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/yiisoft/yii2/issues/17174/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/yiisoft/yii2/issues/17174/timeline","performed_via_github_app":null,"state_reason":"completed"}