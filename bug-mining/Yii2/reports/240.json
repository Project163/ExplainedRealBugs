{"url":"https://api.github.com/repos/yiisoft/yii2/issues/13537","repository_url":"https://api.github.com/repos/yiisoft/yii2","labels_url":"https://api.github.com/repos/yiisoft/yii2/issues/13537/labels{/name}","comments_url":"https://api.github.com/repos/yiisoft/yii2/issues/13537/comments","events_url":"https://api.github.com/repos/yiisoft/yii2/issues/13537/events","html_url":"https://github.com/yiisoft/yii2/issues/13537","id":205822743,"node_id":"MDU6SXNzdWUyMDU4MjI3NDM=","number":13537,"title":"Problems with using CasheSession and User::enableAutoLogin","user":{"login":"papalapa","id":6680467,"node_id":"MDQ6VXNlcjY2ODA0Njc=","avatar_url":"https://avatars.githubusercontent.com/u/6680467?v=4","gravatar_id":"","url":"https://api.github.com/users/papalapa","html_url":"https://github.com/papalapa","followers_url":"https://api.github.com/users/papalapa/followers","following_url":"https://api.github.com/users/papalapa/following{/other_user}","gists_url":"https://api.github.com/users/papalapa/gists{/gist_id}","starred_url":"https://api.github.com/users/papalapa/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/papalapa/subscriptions","organizations_url":"https://api.github.com/users/papalapa/orgs","repos_url":"https://api.github.com/users/papalapa/repos","events_url":"https://api.github.com/users/papalapa/events{/privacy}","received_events_url":"https://api.github.com/users/papalapa/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":33208443,"node_id":"MDU6TGFiZWwzMzIwODQ0Mw==","url":"https://api.github.com/repos/yiisoft/yii2/labels/type:bug","name":"type:bug","color":"e102d8","default":false,"description":"Bug"}],"state":"closed","locked":false,"assignee":{"login":"SilverFire","id":4499203,"node_id":"MDQ6VXNlcjQ0OTkyMDM=","avatar_url":"https://avatars.githubusercontent.com/u/4499203?v=4","gravatar_id":"","url":"https://api.github.com/users/SilverFire","html_url":"https://github.com/SilverFire","followers_url":"https://api.github.com/users/SilverFire/followers","following_url":"https://api.github.com/users/SilverFire/following{/other_user}","gists_url":"https://api.github.com/users/SilverFire/gists{/gist_id}","starred_url":"https://api.github.com/users/SilverFire/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SilverFire/subscriptions","organizations_url":"https://api.github.com/users/SilverFire/orgs","repos_url":"https://api.github.com/users/SilverFire/repos","events_url":"https://api.github.com/users/SilverFire/events{/privacy}","received_events_url":"https://api.github.com/users/SilverFire/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"SilverFire","id":4499203,"node_id":"MDQ6VXNlcjQ0OTkyMDM=","avatar_url":"https://avatars.githubusercontent.com/u/4499203?v=4","gravatar_id":"","url":"https://api.github.com/users/SilverFire","html_url":"https://github.com/SilverFire","followers_url":"https://api.github.com/users/SilverFire/followers","following_url":"https://api.github.com/users/SilverFire/following{/other_user}","gists_url":"https://api.github.com/users/SilverFire/gists{/gist_id}","starred_url":"https://api.github.com/users/SilverFire/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SilverFire/subscriptions","organizations_url":"https://api.github.com/users/SilverFire/orgs","repos_url":"https://api.github.com/users/SilverFire/repos","events_url":"https://api.github.com/users/SilverFire/events{/privacy}","received_events_url":"https://api.github.com/users/SilverFire/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/yiisoft/yii2/milestones/21","html_url":"https://github.com/yiisoft/yii2/milestone/21","labels_url":"https://api.github.com/repos/yiisoft/yii2/milestones/21/labels","id":1875845,"node_id":"MDk6TWlsZXN0b25lMTg3NTg0NQ==","number":21,"title":"2.0.12","description":"","creator":{"login":"cebe","id":189796,"node_id":"MDQ6VXNlcjE4OTc5Ng==","avatar_url":"https://avatars.githubusercontent.com/u/189796?v=4","gravatar_id":"","url":"https://api.github.com/users/cebe","html_url":"https://github.com/cebe","followers_url":"https://api.github.com/users/cebe/followers","following_url":"https://api.github.com/users/cebe/following{/other_user}","gists_url":"https://api.github.com/users/cebe/gists{/gist_id}","starred_url":"https://api.github.com/users/cebe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cebe/subscriptions","organizations_url":"https://api.github.com/users/cebe/orgs","repos_url":"https://api.github.com/users/cebe/repos","events_url":"https://api.github.com/users/cebe/events{/privacy}","received_events_url":"https://api.github.com/users/cebe/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":288,"state":"closed","created_at":"2016-07-11T13:42:09Z","updated_at":"2017-06-05T18:03:24Z","due_on":"2017-03-26T07:00:00Z","closed_at":"2017-06-05T18:03:24Z"},"comments":1,"created_at":"2017-02-07T08:45:40Z","updated_at":"2017-02-20T20:35:10Z","closed_at":"2017-02-20T20:35:10Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### What steps will reproduce the problem?\r\nTo run CacheSession use this settings:\r\n```php\r\n'user' => [\r\n  'identityClass'   => common\\modules\\user\\models\\User::className(),\r\n  'enableAutoLogin' => true, // use autologin\r\n],\r\n'session' => [\r\n  'class'        => yii\\web\\CacheSession::className(), // cache == MemCache\r\n  'cookieParams' => [\r\n    'lifetime' => 10, // to fast detect the problems\r\n  ],\r\n],\r\n```\r\nSign in the app with **Remember me** checkbox and wait for 10 seconds. After this time the session automatically ended. Then I click \"**Logout**\" link.\r\n\r\n### What is the expected result?\r\nUser must simply logged out.\r\n\r\n### What do you get instead?\r\nIn debug mode the site is throwing the warning:\r\n```code\r\nPHP Warning â€“ yii\\base\\ErrorException\r\nsession_regenerate_id(): Session object destruction failed. ID: user (path: /var/lib/php/sessions)\r\n```\r\n\r\n### What is the problem?\r\nWhen we are using **enableAutoLogin** and clicking to the **Logout** link, there are two steps in one request: first step is **Loging in** by cookie to the app, and second step **Loging out**. Both steps are accompanied by **regenerateID** [method](https://github.com/yiisoft/yii2/blob/master/framework/web/Session.php#L272-L288):\r\n```php\r\n    /**\r\n     * Updates the current session ID with a newly generated one .\r\n     * Please refer to <http://php.net/session_regenerate_id> for more details.\r\n     * @param boolean $deleteOldSession Whether to delete the old associated session file or not.\r\n     */\r\n    public function regenerateID($deleteOldSession = false)\r\n    {\r\n        if ($this->getIsActive()) {\r\n            // add @ to inhibit possible warning due to race condition\r\n            // https://github.com/yiisoft/yii2/pull/1812\r\n            if (YII_DEBUG && !headers_sent()) {\r\n                session_regenerate_id($deleteOldSession); // there is our problem place\r\n            } else {\r\n                @session_regenerate_id($deleteOldSession);\r\n            }\r\n        }\r\n    }\r\n```\r\nIn **Loging in** step this method is not running, because the session is not yet active. But session is activated after login and on second step session ID will be regenerated. All would be good, but **session_regenerate_id** is trigger other [method](https://github.com/yiisoft/yii2/blob/master/framework/web/CacheSession.php#L97-L106) - **CacheSession::destroySession($id)**:\r\n```php\r\n    /**\r\n     * Session destroy handler.\r\n     * Do not call this method directly.\r\n     * @param string $id session ID\r\n     * @return boolean whether session is destroyed successfully\r\n     */\r\n    public function destroySession($id)\r\n    {\r\n        return $this->cache->delete($this->calculateKey($id));\r\n    }\r\n```\r\nThis is our problem, because the cache cannot find the data by new generated key and throwing false.\r\nMaybe this it`s wrong, but the error occurs all the time.\r\nI think, check the key in cache before delete will solve the problem.\r\nFor example:\r\n```php\r\n    public function destroySession($id)\r\n    {\r\n        return !$this->cache->exists($this->calculateKey($id)) || $this->cache->delete($this->calculateKey($id));\r\n    }\r\n```\r\n\r\n### Additional info\r\nPS: Sorry for my Eng :-)\r\n\r\n| Q                | A\r\n| ---------------- | ---\r\n| Yii version      | 2.0.10\r\n| PHP version      | 7.0\r\n| Operating system | Ubuntu 14.04 x64\r\n","closed_by":{"login":"SilverFire","id":4499203,"node_id":"MDQ6VXNlcjQ0OTkyMDM=","avatar_url":"https://avatars.githubusercontent.com/u/4499203?v=4","gravatar_id":"","url":"https://api.github.com/users/SilverFire","html_url":"https://github.com/SilverFire","followers_url":"https://api.github.com/users/SilverFire/followers","following_url":"https://api.github.com/users/SilverFire/following{/other_user}","gists_url":"https://api.github.com/users/SilverFire/gists{/gist_id}","starred_url":"https://api.github.com/users/SilverFire/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SilverFire/subscriptions","organizations_url":"https://api.github.com/users/SilverFire/orgs","repos_url":"https://api.github.com/users/SilverFire/repos","events_url":"https://api.github.com/users/SilverFire/events{/privacy}","received_events_url":"https://api.github.com/users/SilverFire/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/yiisoft/yii2/issues/13537/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/yiisoft/yii2/issues/13537/timeline","performed_via_github_app":null,"state_reason":"completed"}