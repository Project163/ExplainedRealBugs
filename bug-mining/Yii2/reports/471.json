{"url":"https://api.github.com/repos/yiisoft/yii2/issues/15875","repository_url":"https://api.github.com/repos/yiisoft/yii2","labels_url":"https://api.github.com/repos/yiisoft/yii2/issues/15875/labels{/name}","comments_url":"https://api.github.com/repos/yiisoft/yii2/issues/15875/comments","events_url":"https://api.github.com/repos/yiisoft/yii2/issues/15875/events","html_url":"https://github.com/yiisoft/yii2/issues/15875","id":304168485,"node_id":"MDU6SXNzdWUzMDQxNjg0ODU=","number":15875,"title":"afterSave for new models flushes unsaved data","user":{"login":"yujin1st","id":2317913,"node_id":"MDQ6VXNlcjIzMTc5MTM=","avatar_url":"https://avatars.githubusercontent.com/u/2317913?v=4","gravatar_id":"","url":"https://api.github.com/users/yujin1st","html_url":"https://github.com/yujin1st","followers_url":"https://api.github.com/users/yujin1st/followers","following_url":"https://api.github.com/users/yujin1st/following{/other_user}","gists_url":"https://api.github.com/users/yujin1st/gists{/gist_id}","starred_url":"https://api.github.com/users/yujin1st/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yujin1st/subscriptions","organizations_url":"https://api.github.com/users/yujin1st/orgs","repos_url":"https://api.github.com/users/yujin1st/repos","events_url":"https://api.github.com/users/yujin1st/events{/privacy}","received_events_url":"https://api.github.com/users/yujin1st/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":33208443,"node_id":"MDU6TGFiZWwzMzIwODQ0Mw==","url":"https://api.github.com/repos/yiisoft/yii2/labels/type:bug","name":"type:bug","color":"e102d8","default":false,"description":"Bug"},{"id":33330247,"node_id":"MDU6TGFiZWwzMzMzMDI0Nw==","url":"https://api.github.com/repos/yiisoft/yii2/labels/status:ready%20for%20adoption","name":"status:ready for adoption","color":"02e10c","default":false,"description":"Feel free to implement this issue."},{"id":92646963,"node_id":"MDU6TGFiZWw5MjY0Njk2Mw==","url":"https://api.github.com/repos/yiisoft/yii2/labels/severity:important","name":"severity:important","color":"eb6420","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"cebe","id":189796,"node_id":"MDQ6VXNlcjE4OTc5Ng==","avatar_url":"https://avatars.githubusercontent.com/u/189796?v=4","gravatar_id":"","url":"https://api.github.com/users/cebe","html_url":"https://github.com/cebe","followers_url":"https://api.github.com/users/cebe/followers","following_url":"https://api.github.com/users/cebe/following{/other_user}","gists_url":"https://api.github.com/users/cebe/gists{/gist_id}","starred_url":"https://api.github.com/users/cebe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cebe/subscriptions","organizations_url":"https://api.github.com/users/cebe/orgs","repos_url":"https://api.github.com/users/cebe/repos","events_url":"https://api.github.com/users/cebe/events{/privacy}","received_events_url":"https://api.github.com/users/cebe/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"cebe","id":189796,"node_id":"MDQ6VXNlcjE4OTc5Ng==","avatar_url":"https://avatars.githubusercontent.com/u/189796?v=4","gravatar_id":"","url":"https://api.github.com/users/cebe","html_url":"https://github.com/cebe","followers_url":"https://api.github.com/users/cebe/followers","following_url":"https://api.github.com/users/cebe/following{/other_user}","gists_url":"https://api.github.com/users/cebe/gists{/gist_id}","starred_url":"https://api.github.com/users/cebe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cebe/subscriptions","organizations_url":"https://api.github.com/users/cebe/orgs","repos_url":"https://api.github.com/users/cebe/repos","events_url":"https://api.github.com/users/cebe/events{/privacy}","received_events_url":"https://api.github.com/users/cebe/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/yiisoft/yii2/milestones/25","html_url":"https://github.com/yiisoft/yii2/milestone/25","labels_url":"https://api.github.com/repos/yiisoft/yii2/milestones/25/labels","id":2562828,"node_id":"MDk6TWlsZXN0b25lMjU2MjgyOA==","number":25,"title":"2.0.16","description":"","creator":{"login":"cebe","id":189796,"node_id":"MDQ6VXNlcjE4OTc5Ng==","avatar_url":"https://avatars.githubusercontent.com/u/189796?v=4","gravatar_id":"","url":"https://api.github.com/users/cebe","html_url":"https://github.com/cebe","followers_url":"https://api.github.com/users/cebe/followers","following_url":"https://api.github.com/users/cebe/following{/other_user}","gists_url":"https://api.github.com/users/cebe/gists{/gist_id}","starred_url":"https://api.github.com/users/cebe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cebe/subscriptions","organizations_url":"https://api.github.com/users/cebe/orgs","repos_url":"https://api.github.com/users/cebe/repos","events_url":"https://api.github.com/users/cebe/events{/privacy}","received_events_url":"https://api.github.com/users/cebe/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":291,"state":"closed","created_at":"2017-06-05T18:03:36Z","updated_at":"2019-01-30T23:57:22Z","due_on":"2019-02-01T08:00:00Z","closed_at":"2019-01-30T23:57:22Z"},"comments":29,"created_at":"2018-03-11T15:45:01Z","updated_at":"2019-03-20T16:26:20Z","closed_at":"2018-06-29T23:06:58Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"After #13567 AR now flushed relational data, so there is new issue:\r\n\r\n### What steps will reproduce the problem?\r\n1. Create simple app with Order and OrderItem models.\r\n2. Load data in controller, create relational OrderItem records and populate relation 'items'\r\n```php\r\n// In Order \r\npublic function load($data, $formName = null) {\r\n  if (!parent::load($data, $formName)) return false;\r\n  $this->loadItems($data);\r\n  return true;\r\n}\r\n\r\n/// loading and populating data\r\nprivate function loadItems($data) {\r\n  if (!isset($data['items'])) {\r\n    return;\r\n  }\r\n  $items = $this->items;\r\n  foreach ($data['items'] as $info) {\r\n    $itemId = $info['itemId'];\r\n    if (isset($items[$itemId])) {\r\n      $items[$itemId]->load($info, '');\r\n    } else {\r\n      $item = new OrderItem([]);\r\n      $item->load($info, '');\r\n      $items[$itemId] = $item;\r\n    }\r\n  }\r\n  $this->populateRelation('items',$items);\r\n}\r\n\r\n\r\n```\r\n\r\n3. Validate, do something in beforeSave method and event\r\n3.1 Validate in Order model\r\n3.2 For example warehouse module can check item quantity before order creating in event\r\n4. Save items in afterSave\r\n```php\r\npublic function afterSave($insert, $changedAttributes) {\r\n  $this->saveItems();\r\n  parent::afterSave($insert, $changedAttributes);\r\n}\r\n\r\n```\r\n\r\n5. Do something with new items in afterSave method and event\r\n \r\n### What is the expected result?\r\nAll works fine, order data saved, relational data saved too\r\n\r\n### What do you get instead?\r\nAfter #13567 items relation with unfinished data is flushed, as Order model changes it's id, so you lose data\r\n\r\n### Additional info\r\nIt simple workflow allows to validate and process relational form data as ActiveRecord models with all it features and controllers remains thing. And you could use scenarios for complex relations, so models can be easily tested.\r\n\r\nI'm afraid this issue will be closed due contradiction with updated framework design, but i have a multiply applications that follows this workflow, so i don't know what to do ;(((\r\n\r\n| Q                | A\r\n| ---------------- | ---\r\n| Yii version      | 2.0.14\r\n","closed_by":{"login":"samdark","id":47294,"node_id":"MDQ6VXNlcjQ3Mjk0","avatar_url":"https://avatars.githubusercontent.com/u/47294?v=4","gravatar_id":"","url":"https://api.github.com/users/samdark","html_url":"https://github.com/samdark","followers_url":"https://api.github.com/users/samdark/followers","following_url":"https://api.github.com/users/samdark/following{/other_user}","gists_url":"https://api.github.com/users/samdark/gists{/gist_id}","starred_url":"https://api.github.com/users/samdark/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/samdark/subscriptions","organizations_url":"https://api.github.com/users/samdark/orgs","repos_url":"https://api.github.com/users/samdark/repos","events_url":"https://api.github.com/users/samdark/events{/privacy}","received_events_url":"https://api.github.com/users/samdark/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/yiisoft/yii2/issues/15875/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/yiisoft/yii2/issues/15875/timeline","performed_via_github_app":null,"state_reason":"completed"}