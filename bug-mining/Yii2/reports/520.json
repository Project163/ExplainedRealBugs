{"url":"https://api.github.com/repos/yiisoft/yii2/issues/16424","repository_url":"https://api.github.com/repos/yiisoft/yii2","labels_url":"https://api.github.com/repos/yiisoft/yii2/issues/16424/labels{/name}","comments_url":"https://api.github.com/repos/yiisoft/yii2/issues/16424/comments","events_url":"https://api.github.com/repos/yiisoft/yii2/issues/16424/events","html_url":"https://github.com/yiisoft/yii2/issues/16424","id":334047082,"node_id":"MDU6SXNzdWUzMzQwNDcwODI=","number":16424,"title":"Transaction Class Rollback Problem","user":{"login":"lenyy","id":10136403,"node_id":"MDQ6VXNlcjEwMTM2NDAz","avatar_url":"https://avatars.githubusercontent.com/u/10136403?v=4","gravatar_id":"","url":"https://api.github.com/users/lenyy","html_url":"https://github.com/lenyy","followers_url":"https://api.github.com/users/lenyy/followers","following_url":"https://api.github.com/users/lenyy/following{/other_user}","gists_url":"https://api.github.com/users/lenyy/gists{/gist_id}","starred_url":"https://api.github.com/users/lenyy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lenyy/subscriptions","organizations_url":"https://api.github.com/users/lenyy/orgs","repos_url":"https://api.github.com/users/lenyy/repos","events_url":"https://api.github.com/users/lenyy/events{/privacy}","received_events_url":"https://api.github.com/users/lenyy/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":33208443,"node_id":"MDU6TGFiZWwzMzIwODQ0Mw==","url":"https://api.github.com/repos/yiisoft/yii2/labels/type:bug","name":"type:bug","color":"e102d8","default":false,"description":"Bug"},{"id":33330247,"node_id":"MDU6TGFiZWwzMzMzMDI0Nw==","url":"https://api.github.com/repos/yiisoft/yii2/labels/status:ready%20for%20adoption","name":"status:ready for adoption","color":"02e10c","default":false,"description":"Feel free to implement this issue."}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/yiisoft/yii2/milestones/25","html_url":"https://github.com/yiisoft/yii2/milestone/25","labels_url":"https://api.github.com/repos/yiisoft/yii2/milestones/25/labels","id":2562828,"node_id":"MDk6TWlsZXN0b25lMjU2MjgyOA==","number":25,"title":"2.0.16","description":"","creator":{"login":"cebe","id":189796,"node_id":"MDQ6VXNlcjE4OTc5Ng==","avatar_url":"https://avatars.githubusercontent.com/u/189796?v=4","gravatar_id":"","url":"https://api.github.com/users/cebe","html_url":"https://github.com/cebe","followers_url":"https://api.github.com/users/cebe/followers","following_url":"https://api.github.com/users/cebe/following{/other_user}","gists_url":"https://api.github.com/users/cebe/gists{/gist_id}","starred_url":"https://api.github.com/users/cebe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cebe/subscriptions","organizations_url":"https://api.github.com/users/cebe/orgs","repos_url":"https://api.github.com/users/cebe/repos","events_url":"https://api.github.com/users/cebe/events{/privacy}","received_events_url":"https://api.github.com/users/cebe/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":291,"state":"closed","created_at":"2017-06-05T18:03:36Z","updated_at":"2019-01-30T23:57:22Z","due_on":"2019-02-01T08:00:00Z","closed_at":"2019-01-30T23:57:22Z"},"comments":2,"created_at":"2018-06-20T12:05:03Z","updated_at":"2018-10-22T21:24:19Z","closed_at":"2018-10-22T21:24:19Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Hello guys,\r\n\r\nSo by inspecting your [Transaction](https://github.com/yiisoft/yii2/blob/master/framework/db/Transaction.php) in the methods begin and rollback, im not sure if what you have is a bug or by design of the framework.\r\nBut in this piece of code from the method [begin](https://github.com/yiisoft/yii2/blob/master/framework/db/Transaction.php#L114)\r\n```php\r\n$schema = $this->db->getSchema();\r\nif ($schema->supportsSavepoint()) {\r\n            Yii::debug('Set savepoint ' . $this->_level, __METHOD__);\r\n            $schema->createSavepoint('LEVEL' . $this->_level);\r\n        } else {\r\n            Yii::info('Transaction not started: nested transaction not supported', __METHOD__);\r\n        }\r\n```\r\nyou don't throw an Exception, but in the piece of code from [rollback](https://github.com/yiisoft/yii2/blob/master/framework/db/Transaction.php#L175)\r\n```php\r\n$schema = $this->db->getSchema();\r\n        if ($schema->supportsSavepoint()) {\r\n            Yii::debug('Roll back to savepoint ' . $this->_level, __METHOD__);\r\n            $schema->rollBackSavepoint('LEVEL' . $this->_level);\r\n        } else {\r\n            Yii::info('Transaction not rolled back: nested transaction not supported', __METHOD__);\r\n            // throw an exception to fail the outer transaction\r\n            throw new Exception('Roll back failed: nested transaction not supported.');\r\n        }\r\n```\r\nyou throw an Exception if the schema doesn't support save point.\r\nThe first Question is:\r\nShouldn't the begin method throw the exception if SavePoint is not enabled?\r\n\r\nWell because this leads to unexpected behavior by the IDE when i try to catch the exceptions that are thrown by the transaction like this \r\n![screenshot_1](https://user-images.githubusercontent.com/10136403/41656942-8a9bde22-7489-11e8-8aaf-f7059aa2529b.png)\r\n\r\nTo me this feels really weird because we caught  an exception we should rollback but we need to have another try catch to catch the exception that the rollback might throw.\r\n\r\nThe solution would be to throw that exception in the method [begin](https://github.com/yiisoft/yii2/blob/master/framework/db/Transaction.php#L175) because we should not start a transaction that doesn't support SavePoint, at least by following your logic.\r\n\r\nAny help you need just say.\r\nCheers Pedro Rosa\r\n\r\n### Additional info\r\n\r\n| Q                | A\r\n| ---------------- | ---\r\n| Yii version      | Master\r\n| PHP version      |  Doesn't Matter\r\n| Operating system | Doesn't Matter\r\n","closed_by":{"login":"samdark","id":47294,"node_id":"MDQ6VXNlcjQ3Mjk0","avatar_url":"https://avatars.githubusercontent.com/u/47294?v=4","gravatar_id":"","url":"https://api.github.com/users/samdark","html_url":"https://github.com/samdark","followers_url":"https://api.github.com/users/samdark/followers","following_url":"https://api.github.com/users/samdark/following{/other_user}","gists_url":"https://api.github.com/users/samdark/gists{/gist_id}","starred_url":"https://api.github.com/users/samdark/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/samdark/subscriptions","organizations_url":"https://api.github.com/users/samdark/orgs","repos_url":"https://api.github.com/users/samdark/repos","events_url":"https://api.github.com/users/samdark/events{/privacy}","received_events_url":"https://api.github.com/users/samdark/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/yiisoft/yii2/issues/16424/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/yiisoft/yii2/issues/16424/timeline","performed_via_github_app":null,"state_reason":"completed"}