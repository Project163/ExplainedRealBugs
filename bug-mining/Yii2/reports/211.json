{"url":"https://api.github.com/repos/yiisoft/yii2/issues/13309","repository_url":"https://api.github.com/repos/yiisoft/yii2","labels_url":"https://api.github.com/repos/yiisoft/yii2/issues/13309/labels{/name}","comments_url":"https://api.github.com/repos/yiisoft/yii2/issues/13309/comments","events_url":"https://api.github.com/repos/yiisoft/yii2/issues/13309/events","html_url":"https://github.com/yiisoft/yii2/issues/13309","id":198312582,"node_id":"MDU6SXNzdWUxOTgzMTI1ODI=","number":13309,"title":"Incorrect console width/height detecting on Mac","user":{"login":"nowm","id":4413484,"node_id":"MDQ6VXNlcjQ0MTM0ODQ=","avatar_url":"https://avatars.githubusercontent.com/u/4413484?v=4","gravatar_id":"","url":"https://api.github.com/users/nowm","html_url":"https://github.com/nowm","followers_url":"https://api.github.com/users/nowm/followers","following_url":"https://api.github.com/users/nowm/following{/other_user}","gists_url":"https://api.github.com/users/nowm/gists{/gist_id}","starred_url":"https://api.github.com/users/nowm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nowm/subscriptions","organizations_url":"https://api.github.com/users/nowm/orgs","repos_url":"https://api.github.com/users/nowm/repos","events_url":"https://api.github.com/users/nowm/events{/privacy}","received_events_url":"https://api.github.com/users/nowm/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":33208443,"node_id":"MDU6TGFiZWwzMzIwODQ0Mw==","url":"https://api.github.com/repos/yiisoft/yii2/labels/type:bug","name":"type:bug","color":"e102d8","default":false,"description":"Bug"}],"state":"closed","locked":false,"assignee":{"login":"SilverFire","id":4499203,"node_id":"MDQ6VXNlcjQ0OTkyMDM=","avatar_url":"https://avatars.githubusercontent.com/u/4499203?v=4","gravatar_id":"","url":"https://api.github.com/users/SilverFire","html_url":"https://github.com/SilverFire","followers_url":"https://api.github.com/users/SilverFire/followers","following_url":"https://api.github.com/users/SilverFire/following{/other_user}","gists_url":"https://api.github.com/users/SilverFire/gists{/gist_id}","starred_url":"https://api.github.com/users/SilverFire/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SilverFire/subscriptions","organizations_url":"https://api.github.com/users/SilverFire/orgs","repos_url":"https://api.github.com/users/SilverFire/repos","events_url":"https://api.github.com/users/SilverFire/events{/privacy}","received_events_url":"https://api.github.com/users/SilverFire/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"SilverFire","id":4499203,"node_id":"MDQ6VXNlcjQ0OTkyMDM=","avatar_url":"https://avatars.githubusercontent.com/u/4499203?v=4","gravatar_id":"","url":"https://api.github.com/users/SilverFire","html_url":"https://github.com/SilverFire","followers_url":"https://api.github.com/users/SilverFire/followers","following_url":"https://api.github.com/users/SilverFire/following{/other_user}","gists_url":"https://api.github.com/users/SilverFire/gists{/gist_id}","starred_url":"https://api.github.com/users/SilverFire/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SilverFire/subscriptions","organizations_url":"https://api.github.com/users/SilverFire/orgs","repos_url":"https://api.github.com/users/SilverFire/repos","events_url":"https://api.github.com/users/SilverFire/events{/privacy}","received_events_url":"https://api.github.com/users/SilverFire/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/yiisoft/yii2/milestones/20","html_url":"https://github.com/yiisoft/yii2/milestone/20","labels_url":"https://api.github.com/repos/yiisoft/yii2/milestones/20/labels","id":1736699,"node_id":"MDk6TWlsZXN0b25lMTczNjY5OQ==","number":20,"title":"2.0.11","description":"","creator":{"login":"cebe","id":189796,"node_id":"MDQ6VXNlcjE4OTc5Ng==","avatar_url":"https://avatars.githubusercontent.com/u/189796?v=4","gravatar_id":"","url":"https://api.github.com/users/cebe","html_url":"https://github.com/cebe","followers_url":"https://api.github.com/users/cebe/followers","following_url":"https://api.github.com/users/cebe/following{/other_user}","gists_url":"https://api.github.com/users/cebe/gists{/gist_id}","starred_url":"https://api.github.com/users/cebe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cebe/subscriptions","organizations_url":"https://api.github.com/users/cebe/orgs","repos_url":"https://api.github.com/users/cebe/repos","events_url":"https://api.github.com/users/cebe/events{/privacy}","received_events_url":"https://api.github.com/users/cebe/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":276,"state":"closed","created_at":"2016-04-28T15:04:50Z","updated_at":"2017-11-11T22:55:39Z","due_on":"2016-12-18T08:00:00Z","closed_at":"2017-02-01T16:52:20Z"},"comments":2,"created_at":"2017-01-02T09:41:27Z","updated_at":"2017-01-14T09:53:21Z","closed_at":"2017-01-14T09:50:08Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### What steps will reproduce the problem?\r\n\r\n1. Create a new command:\r\n\r\n```php\r\n<?php\r\nnamespace app\\commands;\r\n\r\nuse yii\\console\\Controller;\r\nuse yii\\helpers\\BaseConsole;\r\n\r\nclass SttyController extends Controller\r\n{\r\n    public function actionIndex()\r\n    {\r\n        list($width, $height) = BaseConsole::getScreenSize(true);\r\n\r\n        $this->stdout(sprintf(\"Width: %s, height: %s%s\", $width, $height, PHP_EOL));\r\n    }\r\n}\r\n```\r\n2. Make sure you are in OS X (didn't try it in MacOS Sierra).\r\n\r\n3. Before running the `console` script, maximize the terminal window to make sure `tput` is failed to catch correct dimensions when is called from inside the script.\r\n\r\n4. Run `./console stty`\r\n\r\n### What is the expected result?\r\n\r\n    $ ./console stty\r\n    Width: 178, height: 48\r\n\r\n### What do you get instead?\r\n\r\n    $ ./console stty\r\n    Width: 80, height: 24\r\n\r\n### Additional info\r\n\r\n| Q                | A\r\n| ---------------- | ---\r\n| Yii version      | 2.*\r\n| PHP version      | 5.6.29\r\n| Operating system | OS X 10.11 El Capitan\r\n\r\n### Detailed case review\r\n\r\nThe `stty` command on Mac has different output formatting in comparison with GNU `stty`. Later shows sizes as: `rows N; columns M`. The Mac's `stty` shows it as `N rows; M columns`. The `\\yii\\helpers\\BaseConsole::getScreenSize()` method uses regular expression to check Stty's output which [RegExp] is correct for GNU, but incorrect for Mac. When this RegExp is failed, the `getScreenSize()` method is trying to check `tput cols` and `tput lines` values to determine terminal window dimensions. The `tput` command may output incorrect values, especially when the terminal window is maximized and the `tput` command is called from inside the script with the `exec()` function (See [this thread](http://stackoverflow.com/questions/14308166/tput-cols-doesnt-work-properly-in-a-script) on Stack Overflow for details).\r\n\r\nAs a result, when some Yii user is trying to get terminal sizes on Mac with using the `BaseConsole::getScreenSize()` method, he see something like `80` for width and `24` for height which is incorrect if the terminal window was resized before running the `./console` command.\r\n\r\nSample of GNU `stty` output:\r\n\r\n    me@home:~$ /usr/local/Cellar/coreutils/8.26/libexec/gnubin/stty -a\r\n    speed 38400 baud; rows 48; columns 178;\r\n    intr = ^C; quit = ^\\; erase = ^?; kill = ^U; eof = ^D; eol = <undef>; eol2 = <undef>; start = ^Q; stop = ^S; susp = ^Z; dsusp = ^Y; rprnt = ^R; werase = ^W; lnext = ^V;\r\n    discard = ^O; status = ^T; min = 1; time = 0;\r\n    -parenb -parodd cs8 hupcl -cstopb cread -clocal -crtscts\r\n    -ignbrk brkint -ignpar -parmrk -inpck -istrip -inlcr -igncr icrnl ixon -ixoff ixany imaxbel iutf8\r\n    opost -ocrnl onlcr -onocr -onlret -ofill -ofdel nl0 cr0 tab0 bs0 vt0 ff0\r\n    isig icanon iexten echo echoe echok -echonl -noflsh -tostop -echoprt echoctl echoke -flusho -extproc\r\n\r\nSample of Mac `stty` output:\r\n\r\n    me@home:~$ /bin/stty -a\r\n    speed 38400 baud; 48 rows; 178 columns;\r\n    lflags: icanon isig iexten echo echoe echok echoke -echonl echoctl\r\n        -echoprt -altwerase -noflsh -tostop -flusho pendin -nokerninfo\r\n        -extproc\r\n    iflags: -istrip icrnl -inlcr -igncr ixon -ixoff ixany imaxbel iutf8\r\n        -ignbrk brkint -inpck -ignpar -parmrk\r\n    oflags: opost onlcr -oxtabs -onocr -onlret\r\n    cflags: cread cs8 -parenb -parodd hupcl -clocal -cstopb -crtscts -dsrflow\r\n        -dtrflow -mdmbuf\r\n    cchars: discard = ^O; dsusp = ^Y; eof = ^D; eol = <undef>;\r\n        eol2 = <undef>; erase = ^?; intr = ^C; kill = ^U; lnext = ^V;\r\n        min = 1; quit = ^\\; reprint = ^R; start = ^Q; status = ^T;\r\n        stop = ^S; susp = ^Z; time = 0; werase = ^W;\r\n\r\n### Suggested fix\r\n\r\nUpdate the `\\yii\\helpers\\BaseConsole::getScreenSize()` method:\r\n\r\nChange this:\r\n\r\n```php\r\nif (exec('stty -a 2>&1', $stty) && preg_match('/rows\\s+(\\d+);\\s*columns\\s+(\\d+);/mi', implode(' ', $stty), $matches)) {\r\n    return $size = [(int)$matches[2], (int)$matches[1]];\r\n}\r\n```\r\n\r\nto this:\r\n\r\n```php\r\nif (exec('stty -a 2>&1', $stty)) {\r\n    $stty = implode(' ', $stty);\r\n\r\n    if (preg_match('/rows\\s+(\\d+);\\s*columns\\s+(\\d+);/mi', $stty, $matches)) {\r\n        return $size = [(int)$matches[2], (int)$matches[1]];\r\n    }\r\n\r\n    if (preg_match('/(\\d+)\\s+rows;\\s*(\\d+)\\s+columns;/mi', $stty, $matches)) {\r\n        return $size = [(int)$matches[2], (int)$matches[1]];\r\n    }\r\n}\r\n```\r\n","closed_by":{"login":"SilverFire","id":4499203,"node_id":"MDQ6VXNlcjQ0OTkyMDM=","avatar_url":"https://avatars.githubusercontent.com/u/4499203?v=4","gravatar_id":"","url":"https://api.github.com/users/SilverFire","html_url":"https://github.com/SilverFire","followers_url":"https://api.github.com/users/SilverFire/followers","following_url":"https://api.github.com/users/SilverFire/following{/other_user}","gists_url":"https://api.github.com/users/SilverFire/gists{/gist_id}","starred_url":"https://api.github.com/users/SilverFire/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SilverFire/subscriptions","organizations_url":"https://api.github.com/users/SilverFire/orgs","repos_url":"https://api.github.com/users/SilverFire/repos","events_url":"https://api.github.com/users/SilverFire/events{/privacy}","received_events_url":"https://api.github.com/users/SilverFire/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/yiisoft/yii2/issues/13309/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/yiisoft/yii2/issues/13309/timeline","performed_via_github_app":null,"state_reason":"completed"}