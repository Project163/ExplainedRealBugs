{"url":"https://api.github.com/repos/yiisoft/yii2/issues/18904","repository_url":"https://api.github.com/repos/yiisoft/yii2","labels_url":"https://api.github.com/repos/yiisoft/yii2/issues/18904/labels{/name}","comments_url":"https://api.github.com/repos/yiisoft/yii2/issues/18904/comments","events_url":"https://api.github.com/repos/yiisoft/yii2/issues/18904/events","html_url":"https://github.com/yiisoft/yii2/issues/18904","id":1006870211,"node_id":"I_kwDOADRbGc48A57D","number":18904,"title":"Captcha hash for client-side verification can be improved","user":{"login":"hexkir","id":4928273,"node_id":"MDQ6VXNlcjQ5MjgyNzM=","avatar_url":"https://avatars.githubusercontent.com/u/4928273?v=4","gravatar_id":"","url":"https://api.github.com/users/hexkir","html_url":"https://github.com/hexkir","followers_url":"https://api.github.com/users/hexkir/followers","following_url":"https://api.github.com/users/hexkir/following{/other_user}","gists_url":"https://api.github.com/users/hexkir/gists{/gist_id}","starred_url":"https://api.github.com/users/hexkir/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hexkir/subscriptions","organizations_url":"https://api.github.com/users/hexkir/orgs","repos_url":"https://api.github.com/users/hexkir/repos","events_url":"https://api.github.com/users/hexkir/events{/privacy}","received_events_url":"https://api.github.com/users/hexkir/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":33330247,"node_id":"MDU6TGFiZWwzMzMzMDI0Nw==","url":"https://api.github.com/repos/yiisoft/yii2/labels/status:ready%20for%20adoption","name":"status:ready for adoption","color":"02e10c","default":false,"description":"Feel free to implement this issue."},{"id":33332028,"node_id":"MDU6TGFiZWwzMzMzMjAyOA==","url":"https://api.github.com/repos/yiisoft/yii2/labels/type:enhancement","name":"type:enhancement","color":"d7e102","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2021-09-24T22:38:22Z","updated_at":"2021-09-28T06:55:57Z","closed_at":"2021-09-28T06:55:57Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Captcha validation in `framework/assets/yii.validation.js:254` and method `\\yii\\captcha\\CaptchaAction::generateValidationHash` that are used for generating and checking hash code are not bulletproof, because they just convert chars to integer representations and then return a sum of integers.\r\n\r\nWith that, Captcha will be validated on client side with any given string when hash sum equals to actual Captcha's hash sum.\r\nFor instance, `fedcba` will be client-side valid for captcha **`abcdef`**.\r\n\r\nIt's not a critical issue, because on server side Yii2 checks strings, not hashes, but still it's a bad UI experience for a visitor.\r\n\r\nLet's check:\r\n- **abcdef** => ord(a) + ord(b) + ord(c) + ord(d) + ord(e) + ord(f) = 97 + 98 + 99 + 100 + 101 + 102 = **597**\r\n- fedcba => ord(f) + ord(e) + ord(d) + ord(c) + ord(b) + ord(a) = 102 + 101 + 100 + 99 + 98 + 97 = **597**\r\n\r\nAny other chars combination where final sum matches, works too:\r\n- 1wieuj => ord(1) + ord(w) + ord(i) + ord(e) + ord(u) + ord(j) => 49 + 119 + 105 + 101 + 117 + 106 = **597**\r\n- flyxb0 => ord(f) + ord(l) + ord(y) + ord(x) + ord(b) + ord(0) => 102 + 108 + 121 + 120 + 98 + 48 = **597**\r\n- aaaaap => ord(a) + ord(a) + ord(a) + ord(a) + ord(a) + ord(p) => 97 + 97 + 97 + 97 + 97 + 112 = **597**\r\n\r\n\r\n### What steps will reproduce the problem?\r\n- Get Yii2\r\n- Go to 'Contact' page or any other page with Captcha\r\n- Shuffle in any order Captcha characters and put them into field\r\n\r\n### What is the expected result?\r\n- Captcha validation failure\r\n\r\n### What do you get instead?\r\n- Successful Captcha validation (client-side)\r\n\r\n### Additional info\r\nFrom the first sight, client-side issue can be solved by shifting integer to `$i` bits left in each iteration, like so:\r\n\r\nPHP:\r\n`$h += ord($code[$i]) << $i;`\r\n\r\nJS:\r\n`h += v.charCodeAt(i) << i;`\r\n\r\nThis will give us importance of the characters order. Please let me know if you think it's ok and PR can be created.\r\n\r\n------\r\n(this part can be skipped ðŸ˜ƒ )\r\nThough this is absolutely not critical, we do expose hash in plain HTML, like so:\r\n```\r\nyii.validation.captcha(value, messages, {\r\n    \"hash\": 597,\r\n    \"hashKey\": \"yiiCaptcha/site/captcha\",\r\n    \"caseSensitive\": false,\r\n    \"message\": \"The verification code is incorrect.\"\r\n}\r\n```\r\n\r\nMy guess: knowing how exactly hash code is being calculated, and in case of automated OCR solving methods, spammers can significantly increase their chances to solve Captcha.\r\n\r\nFor example, let's assume that OCR has recognized with high probability that Captcha is _`abcd?f`_ (one unknown symbol) and hash sum is _597_. With that, they don't even need to guess, the missing char is: 597 - 496 = 101 => chr(101) = _e_.\r\n\r\nIf there are two unclear chars like _`ab?de?`_, we just need to find such characters that give us in a sum _201_ (597 - 396 = 201). We see from JS that Captcha is case insensitive, so it gives us characters in a range: [ord(97)..ord(104)] => [a..h], because with any char greater than ord(104) we would exceed the limit of 201. With that, the only possible combinations are:\r\n\r\n| Guess                | Result\r\n| ---------------- | ---\r\n| h (104) a (97) | abhdea\r\n| g (103) b (98) | abgdeb\r\n| f (102) c (99) | abfdec\r\n| e (101) d (100) | abeded\r\n| d (100) e (101) | abddee\r\n| **c (99) f (102)** | **abcdef**\r\n| b (98) g (103) | abbdeg\r\n| a (97) h (104) | abadeh\r\n\r\nWith 3 missing chars, situation changes, but not dramatically.\r\nIn case of _`???def`_ we will have maximum 10 possible combinations.\r\nIn case of _`abc???`_ we will have maximum 91 possible combinations.\r\nIn case of _`afl???`_ (captcha `aflpuz`) we will have maximum 136 possible combinations.\r\n\r\nThis also applies to extensions where exactly the same methods are used: bootstrap4, swiftmailer, faker, etc.\r\n\r\n| Q                | A\r\n| ---------------- | ---\r\n| Yii version      | 2.0.*\r\n| PHP version      | *\r\n| Operating system | *\r\n","closed_by":{"login":"samdark","id":47294,"node_id":"MDQ6VXNlcjQ3Mjk0","avatar_url":"https://avatars.githubusercontent.com/u/47294?v=4","gravatar_id":"","url":"https://api.github.com/users/samdark","html_url":"https://github.com/samdark","followers_url":"https://api.github.com/users/samdark/followers","following_url":"https://api.github.com/users/samdark/following{/other_user}","gists_url":"https://api.github.com/users/samdark/gists{/gist_id}","starred_url":"https://api.github.com/users/samdark/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/samdark/subscriptions","organizations_url":"https://api.github.com/users/samdark/orgs","repos_url":"https://api.github.com/users/samdark/repos","events_url":"https://api.github.com/users/samdark/events{/privacy}","received_events_url":"https://api.github.com/users/samdark/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/yiisoft/yii2/issues/18904/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/yiisoft/yii2/issues/18904/timeline","performed_via_github_app":null,"state_reason":"completed"}