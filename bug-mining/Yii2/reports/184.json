{"url":"https://api.github.com/repos/yiisoft/yii2/issues/13159","repository_url":"https://api.github.com/repos/yiisoft/yii2","labels_url":"https://api.github.com/repos/yiisoft/yii2/issues/13159/labels{/name}","comments_url":"https://api.github.com/repos/yiisoft/yii2/issues/13159/comments","events_url":"https://api.github.com/repos/yiisoft/yii2/issues/13159/events","html_url":"https://github.com/yiisoft/yii2/issues/13159","id":194252667,"node_id":"MDU6SXNzdWUxOTQyNTI2Njc=","number":13159,"title":" destroy method in yii.captcha.js doesn't work as expected","user":{"login":"arogachev","id":8326201,"node_id":"MDQ6VXNlcjgzMjYyMDE=","avatar_url":"https://avatars.githubusercontent.com/u/8326201?v=4","gravatar_id":"","url":"https://api.github.com/users/arogachev","html_url":"https://github.com/arogachev","followers_url":"https://api.github.com/users/arogachev/followers","following_url":"https://api.github.com/users/arogachev/following{/other_user}","gists_url":"https://api.github.com/users/arogachev/gists{/gist_id}","starred_url":"https://api.github.com/users/arogachev/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/arogachev/subscriptions","organizations_url":"https://api.github.com/users/arogachev/orgs","repos_url":"https://api.github.com/users/arogachev/repos","events_url":"https://api.github.com/users/arogachev/events{/privacy}","received_events_url":"https://api.github.com/users/arogachev/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":496861903,"node_id":"MDU6TGFiZWw0OTY4NjE5MDM=","url":"https://api.github.com/repos/yiisoft/yii2/labels/JS","name":"JS","color":"006b75","default":false,"description":"JavaScript related"}],"state":"closed","locked":false,"assignee":{"login":"SilverFire","id":4499203,"node_id":"MDQ6VXNlcjQ0OTkyMDM=","avatar_url":"https://avatars.githubusercontent.com/u/4499203?v=4","gravatar_id":"","url":"https://api.github.com/users/SilverFire","html_url":"https://github.com/SilverFire","followers_url":"https://api.github.com/users/SilverFire/followers","following_url":"https://api.github.com/users/SilverFire/following{/other_user}","gists_url":"https://api.github.com/users/SilverFire/gists{/gist_id}","starred_url":"https://api.github.com/users/SilverFire/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SilverFire/subscriptions","organizations_url":"https://api.github.com/users/SilverFire/orgs","repos_url":"https://api.github.com/users/SilverFire/repos","events_url":"https://api.github.com/users/SilverFire/events{/privacy}","received_events_url":"https://api.github.com/users/SilverFire/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"SilverFire","id":4499203,"node_id":"MDQ6VXNlcjQ0OTkyMDM=","avatar_url":"https://avatars.githubusercontent.com/u/4499203?v=4","gravatar_id":"","url":"https://api.github.com/users/SilverFire","html_url":"https://github.com/SilverFire","followers_url":"https://api.github.com/users/SilverFire/followers","following_url":"https://api.github.com/users/SilverFire/following{/other_user}","gists_url":"https://api.github.com/users/SilverFire/gists{/gist_id}","starred_url":"https://api.github.com/users/SilverFire/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SilverFire/subscriptions","organizations_url":"https://api.github.com/users/SilverFire/orgs","repos_url":"https://api.github.com/users/SilverFire/repos","events_url":"https://api.github.com/users/SilverFire/events{/privacy}","received_events_url":"https://api.github.com/users/SilverFire/received_events","type":"User","user_view_type":"public","site_admin":false},{"login":"arogachev","id":8326201,"node_id":"MDQ6VXNlcjgzMjYyMDE=","avatar_url":"https://avatars.githubusercontent.com/u/8326201?v=4","gravatar_id":"","url":"https://api.github.com/users/arogachev","html_url":"https://github.com/arogachev","followers_url":"https://api.github.com/users/arogachev/followers","following_url":"https://api.github.com/users/arogachev/following{/other_user}","gists_url":"https://api.github.com/users/arogachev/gists{/gist_id}","starred_url":"https://api.github.com/users/arogachev/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/arogachev/subscriptions","organizations_url":"https://api.github.com/users/arogachev/orgs","repos_url":"https://api.github.com/users/arogachev/repos","events_url":"https://api.github.com/users/arogachev/events{/privacy}","received_events_url":"https://api.github.com/users/arogachev/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/yiisoft/yii2/milestones/20","html_url":"https://github.com/yiisoft/yii2/milestone/20","labels_url":"https://api.github.com/repos/yiisoft/yii2/milestones/20/labels","id":1736699,"node_id":"MDk6TWlsZXN0b25lMTczNjY5OQ==","number":20,"title":"2.0.11","description":"","creator":{"login":"cebe","id":189796,"node_id":"MDQ6VXNlcjE4OTc5Ng==","avatar_url":"https://avatars.githubusercontent.com/u/189796?v=4","gravatar_id":"","url":"https://api.github.com/users/cebe","html_url":"https://github.com/cebe","followers_url":"https://api.github.com/users/cebe/followers","following_url":"https://api.github.com/users/cebe/following{/other_user}","gists_url":"https://api.github.com/users/cebe/gists{/gist_id}","starred_url":"https://api.github.com/users/cebe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cebe/subscriptions","organizations_url":"https://api.github.com/users/cebe/orgs","repos_url":"https://api.github.com/users/cebe/repos","events_url":"https://api.github.com/users/cebe/events{/privacy}","received_events_url":"https://api.github.com/users/cebe/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":276,"state":"closed","created_at":"2016-04-28T15:04:50Z","updated_at":"2017-11-11T22:55:39Z","due_on":"2016-12-18T08:00:00Z","closed_at":"2017-02-01T16:52:20Z"},"comments":6,"created_at":"2016-12-08T05:48:38Z","updated_at":"2016-12-17T21:32:08Z","closed_at":"2016-12-17T15:00:30Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Let's say we want to use captcha plugin on some image:\r\n\r\n```html\r\n<img id=\"captcha\" src=\"/site/captcha/\">\r\n```\r\n\r\njQuery plugin initialization:\r\n\r\n```js\r\n$('#captcha').yiiCaptcha({\r\n    refreshUrl: '/site/captcha?refresh=1',\r\n    hashKey: 'yiiCaptcha/site/captcha'\r\n});\r\n```\r\n\r\nThen we decide to destroy it:\r\n\r\n```js\r\n$('#captcha').yiiCaptcha('destroy');\r\n```\r\n\r\nWith each repeated initialization:\r\n\r\n```js\r\n$('#captcha').yiiCaptcha({\r\n    refreshUrl: '/site/captcha?refresh=1',\r\n    hashKey: 'yiiCaptcha/site/captcha'\r\n});\r\n```\r\n\r\nclick on the captcha will generate 1 more extra AJAX request. This is because click event handler was not removed correctly. Here is the current implementation:\r\n\r\n```js\r\ndestroy: function () {\r\n    return this.each(function () {\r\n        $(window).unbind('.yiiCaptcha');\r\n        $(this).removeData('yiiCaptcha');\r\n    });\r\n},\r\n```\r\n\r\nWhy unbind event handlers from `window` and in the loop which is even more weird? We call destroy on specific element(s), so this will be correct:\r\n\r\n```js\r\ndestroy: function () {\r\n    return this.each(function () {\r\n        var $e = $(this);\r\n        $e.unbind('.yiiCaptcha');\r\n        $e.removeData('yiiCaptcha');\r\n    });\r\n},\r\n```\r\n\r\nAlso loop is completely useless here because `this` is jQuery object on which `destroy` called from, we can unbind event handlers and remove data without any loops here:\r\n\r\n```js\r\ndestroy: function () {\r\n    var $e = $(this);\r\n    $e.unbind('.yiiCaptcha');\r\n    $e.removeData('yiiCaptcha');\r\n    return $e;\r\n},\r\n```\r\n\r\nFurther improvements:\r\n\r\n- `this` is already jQuery object, so there is no need to wrap it with `$(...)`.\r\n\r\n- From docs to [unbind](http://api.jquery.com/unbind/):\r\n\r\n> As of jQuery 3.0, .unbind() has been deprecated. It was superseded by the .off() method since jQuery 1.7, so its use was already discouraged.\r\n\r\nAnd by the way event handler is initially attached with `.on`:\r\n\r\n```js\r\n$e.on('click.yiiCaptcha', function () {\r\n    methods.refresh.apply($e);\r\n    return false;\r\n});\r\n```\r\n\r\nso it's better to remove it in similar fashion.\r\n\r\nSo the final replacement will be:\r\n\r\n```js\r\ndestroy: function () {\r\n    this.unbind('.yiiCaptcha');\r\n    this.removeData('yiiCaptcha');\r\n    return this;\r\n},\r\n```\r\n\r\nI guess this problem did not pop out eariler because the usage of captcha is usually limited to just tuning it on server side without making any JS changes, and lack of tests obviously.\r\n\r\nIn #12936 I haven't posted problems in separate issues, so do it for `yii.captcha.js` now to be more clear.\r\n\r\nThe same applies to other JS plugins such as `yii.gridView.js`.","closed_by":{"login":"arogachev","id":8326201,"node_id":"MDQ6VXNlcjgzMjYyMDE=","avatar_url":"https://avatars.githubusercontent.com/u/8326201?v=4","gravatar_id":"","url":"https://api.github.com/users/arogachev","html_url":"https://github.com/arogachev","followers_url":"https://api.github.com/users/arogachev/followers","following_url":"https://api.github.com/users/arogachev/following{/other_user}","gists_url":"https://api.github.com/users/arogachev/gists{/gist_id}","starred_url":"https://api.github.com/users/arogachev/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/arogachev/subscriptions","organizations_url":"https://api.github.com/users/arogachev/orgs","repos_url":"https://api.github.com/users/arogachev/repos","events_url":"https://api.github.com/users/arogachev/events{/privacy}","received_events_url":"https://api.github.com/users/arogachev/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/yiisoft/yii2/issues/13159/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/yiisoft/yii2/issues/13159/timeline","performed_via_github_app":null,"state_reason":"completed"}