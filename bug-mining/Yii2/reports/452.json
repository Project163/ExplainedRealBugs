{"url":"https://api.github.com/repos/yiisoft/yii2/issues/15829","repository_url":"https://api.github.com/repos/yiisoft/yii2","labels_url":"https://api.github.com/repos/yiisoft/yii2/issues/15829/labels{/name}","comments_url":"https://api.github.com/repos/yiisoft/yii2/issues/15829/comments","events_url":"https://api.github.com/repos/yiisoft/yii2/issues/15829/events","html_url":"https://github.com/yiisoft/yii2/issues/15829","id":302089184,"node_id":"MDU6SXNzdWUzMDIwODkxODQ=","number":15829,"title":"Error during saving of data to PostgreSQL 9.4 JSONB","user":{"login":"dmitry-kulikov","id":3766212,"node_id":"MDQ6VXNlcjM3NjYyMTI=","avatar_url":"https://avatars.githubusercontent.com/u/3766212?v=4","gravatar_id":"","url":"https://api.github.com/users/dmitry-kulikov","html_url":"https://github.com/dmitry-kulikov","followers_url":"https://api.github.com/users/dmitry-kulikov/followers","following_url":"https://api.github.com/users/dmitry-kulikov/following{/other_user}","gists_url":"https://api.github.com/users/dmitry-kulikov/gists{/gist_id}","starred_url":"https://api.github.com/users/dmitry-kulikov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dmitry-kulikov/subscriptions","organizations_url":"https://api.github.com/users/dmitry-kulikov/orgs","repos_url":"https://api.github.com/users/dmitry-kulikov/repos","events_url":"https://api.github.com/users/dmitry-kulikov/events{/privacy}","received_events_url":"https://api.github.com/users/dmitry-kulikov/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":33208443,"node_id":"MDU6TGFiZWwzMzIwODQ0Mw==","url":"https://api.github.com/repos/yiisoft/yii2/labels/type:bug","name":"type:bug","color":"e102d8","default":false,"description":"Bug"},{"id":295699936,"node_id":"MDU6TGFiZWwyOTU2OTk5MzY=","url":"https://api.github.com/repos/yiisoft/yii2/labels/PostgreSQL","name":"PostgreSQL","color":"006b75","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"SilverFire","id":4499203,"node_id":"MDQ6VXNlcjQ0OTkyMDM=","avatar_url":"https://avatars.githubusercontent.com/u/4499203?v=4","gravatar_id":"","url":"https://api.github.com/users/SilverFire","html_url":"https://github.com/SilverFire","followers_url":"https://api.github.com/users/SilverFire/followers","following_url":"https://api.github.com/users/SilverFire/following{/other_user}","gists_url":"https://api.github.com/users/SilverFire/gists{/gist_id}","starred_url":"https://api.github.com/users/SilverFire/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SilverFire/subscriptions","organizations_url":"https://api.github.com/users/SilverFire/orgs","repos_url":"https://api.github.com/users/SilverFire/repos","events_url":"https://api.github.com/users/SilverFire/events{/privacy}","received_events_url":"https://api.github.com/users/SilverFire/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"SilverFire","id":4499203,"node_id":"MDQ6VXNlcjQ0OTkyMDM=","avatar_url":"https://avatars.githubusercontent.com/u/4499203?v=4","gravatar_id":"","url":"https://api.github.com/users/SilverFire","html_url":"https://github.com/SilverFire","followers_url":"https://api.github.com/users/SilverFire/followers","following_url":"https://api.github.com/users/SilverFire/following{/other_user}","gists_url":"https://api.github.com/users/SilverFire/gists{/gist_id}","starred_url":"https://api.github.com/users/SilverFire/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SilverFire/subscriptions","organizations_url":"https://api.github.com/users/SilverFire/orgs","repos_url":"https://api.github.com/users/SilverFire/repos","events_url":"https://api.github.com/users/SilverFire/events{/privacy}","received_events_url":"https://api.github.com/users/SilverFire/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/yiisoft/yii2/milestones/31","html_url":"https://github.com/yiisoft/yii2/milestone/31","labels_url":"https://api.github.com/repos/yiisoft/yii2/milestones/31/labels","id":3141306,"node_id":"MDk6TWlsZXN0b25lMzE0MTMwNg==","number":31,"title":"2.0.14.2","description":"","creator":{"login":"SilverFire","id":4499203,"node_id":"MDQ6VXNlcjQ0OTkyMDM=","avatar_url":"https://avatars.githubusercontent.com/u/4499203?v=4","gravatar_id":"","url":"https://api.github.com/users/SilverFire","html_url":"https://github.com/SilverFire","followers_url":"https://api.github.com/users/SilverFire/followers","following_url":"https://api.github.com/users/SilverFire/following{/other_user}","gists_url":"https://api.github.com/users/SilverFire/gists{/gist_id}","starred_url":"https://api.github.com/users/SilverFire/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SilverFire/subscriptions","organizations_url":"https://api.github.com/users/SilverFire/orgs","repos_url":"https://api.github.com/users/SilverFire/repos","events_url":"https://api.github.com/users/SilverFire/events{/privacy}","received_events_url":"https://api.github.com/users/SilverFire/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":38,"state":"closed","created_at":"2018-02-25T08:18:03Z","updated_at":"2018-03-13T14:17:25Z","due_on":"2018-03-04T08:00:00Z","closed_at":"2018-03-13T14:17:25Z"},"comments":3,"created_at":"2018-03-04T14:18:35Z","updated_at":"2018-03-04T18:26:02Z","closed_at":"2018-03-04T18:26:02Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"\r\n### What steps will reproduce the problem?\r\n\r\n```\r\nphp vendor/bin/phpunit --verbose tests/framework/db/pgsql/ActiveRecordTest.php\r\n```\r\nPostgreSQL 9.4\r\n\r\n### What is the expected result?\r\n\r\nTests passed.\r\n\r\n### What do you get instead?\r\n\r\nTests fell:\r\n\r\n```\r\nPHPUnit 4.8.34 by Sebastian Bergmann and contributors.\r\n\r\nRuntime:\tPHP 5.5.9-1ubuntu4.23 with Xdebug 2.2.3\r\nConfiguration:\t/media/veracrypt1/yii/yii-2/yii2/phpunit.xml.dist\r\n\r\n......E..EE...................................................... 65 / 99 ( 65%)\r\n..................................\r\n\r\nTime: 1.19 minutes, Memory: 17.25MB\r\n\r\nThere were 3 errors:\r\n\r\n1) yiiunit\\framework\\db\\pgsql\\ActiveRecordTest::testArrayValues with data set \"simple arrays values\" (array(array(yii\\db\\ArrayExpression Object (...), yii\\db\\ArrayExpression Object (...)), array(yii\\db\\ArrayExpression Object (...), yii\\db\\ArrayExpression Object (...)), array(array(1, null, array(1, 3, 5))), array(array(null, 'a', 'b', '\\\"', '{\"af\"}')), array(yii\\db\\ArrayExpression Object (...))))\r\nyii\\db\\Exception: SQLSTATE[42804]: Datatype mismatch: 7 ERROR:  column \"jsonb_col\" is of type jsonb but expression is of type json\r\nLINE 1: ...::text[], ARRAY[$7]::text[]]::text[][], $8::json, $9::json, ...\r\n                                                             ^\r\nHINT:  You will need to rewrite or cast the expression.\r\nThe SQL being executed was: INSERT INTO \"array_and_json_types\" (\"intarray_col\", \"textarray2_col\", \"json_col\", \"jsonb_col\", \"jsonarray_col\") VALUES (ARRAY[1, -2, NULL, '42']::int4[], ARRAY[ARRAY['text']::text[], ARRAY[NULL]::text[], ARRAY[1]::text[]]::text[][], '{\"a\":1,\"b\":null,\"c\":[1,3,5]}'::json, '[null,\"a\",\"b\",\"\\\\\\\"\",\"{\\\"af\\\"}\"]'::json, ARRAY['[\",\",\"null\",true,\"false\",\"f\"]']::json[]) RETURNING \"id\"\r\n\r\n/media/veracrypt1/yii/yii-2/yii2/framework/db/Schema.php:664\r\n/media/veracrypt1/yii/yii-2/yii2/framework/db/Command.php:1263\r\n/media/veracrypt1/yii/yii-2/yii2/framework/db/Command.php:1148\r\n/media/veracrypt1/yii/yii-2/yii2/framework/db/Command.php:413\r\n/media/veracrypt1/yii/yii-2/yii2/framework/db/pgsql/Schema.php:618\r\n/media/veracrypt1/yii/yii-2/yii2/framework/db/ActiveRecord.php:515\r\n/media/veracrypt1/yii/yii-2/yii2/framework/db/ActiveRecord.php:481\r\n/media/veracrypt1/yii/yii-2/yii2/framework/db/BaseActiveRecord.php:669\r\n/media/veracrypt1/yii/yii-2/yii2/tests/framework/db/pgsql/ActiveRecordTest.php:190\r\n/media/veracrypt1/yii/yii-2/yii2/vendor/phpunit/phpunit/phpunit:52\r\n\r\nCaused by\r\nPDOException: SQLSTATE[42804]: Datatype mismatch: 7 ERROR:  column \"jsonb_col\" is of type jsonb but expression is of type json\r\nLINE 1: ...::text[], ARRAY[$7]::text[]]::text[][], $8::json, $9::json, ...\r\n                                                             ^\r\nHINT:  You will need to rewrite or cast the expression.\r\n\r\n/media/veracrypt1/yii/yii-2/yii2/framework/db/Command.php:1258\r\n/media/veracrypt1/yii/yii-2/yii2/framework/db/Command.php:1148\r\n/media/veracrypt1/yii/yii-2/yii2/framework/db/Command.php:413\r\n/media/veracrypt1/yii/yii-2/yii2/framework/db/pgsql/Schema.php:618\r\n/media/veracrypt1/yii/yii-2/yii2/framework/db/ActiveRecord.php:515\r\n/media/veracrypt1/yii/yii-2/yii2/framework/db/ActiveRecord.php:481\r\n/media/veracrypt1/yii/yii-2/yii2/framework/db/BaseActiveRecord.php:669\r\n/media/veracrypt1/yii/yii-2/yii2/tests/framework/db/pgsql/ActiveRecordTest.php:190\r\n/media/veracrypt1/yii/yii-2/yii2/vendor/phpunit/phpunit/phpunit:52\r\n\r\n...\r\n```\r\n\r\n### Additional info\r\n\r\n| Q                | A\r\n| ---------------- | ---\r\n| Yii version      | 2.0.14.1\r\n| PHP version      | 5.5\r\n| Operating system | Ubuntu 14.04\r\n\r\nI think you should change https://github.com/yiisoft/yii2/blob/d5d4b8b0f5f242ded42e836a15ed885bf5daa201/framework/db/pgsql/ColumnSchema.php#L67\r\nto\r\n```php\r\n            return new JsonExpression($value, $this->dbType);\r\n```\r\nat least it fixed tests for me.\r\nBtw you use `dbType` here https://github.com/yiisoft/yii2/blob/d5d4b8b0f5f242ded42e836a15ed885bf5daa201/framework/db/pgsql/ColumnSchema.php#L64\r\nIf my suggestion is correct please also consider similar change in\r\nhttps://github.com/yiisoft/yii2/blob/d5d4b8b0f5f242ded42e836a15ed885bf5daa201/framework/db/mysql/ColumnSchema.php#L42 for consistency. Unfortunately I cannot test it.","closed_by":{"login":"SilverFire","id":4499203,"node_id":"MDQ6VXNlcjQ0OTkyMDM=","avatar_url":"https://avatars.githubusercontent.com/u/4499203?v=4","gravatar_id":"","url":"https://api.github.com/users/SilverFire","html_url":"https://github.com/SilverFire","followers_url":"https://api.github.com/users/SilverFire/followers","following_url":"https://api.github.com/users/SilverFire/following{/other_user}","gists_url":"https://api.github.com/users/SilverFire/gists{/gist_id}","starred_url":"https://api.github.com/users/SilverFire/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SilverFire/subscriptions","organizations_url":"https://api.github.com/users/SilverFire/orgs","repos_url":"https://api.github.com/users/SilverFire/repos","events_url":"https://api.github.com/users/SilverFire/events{/privacy}","received_events_url":"https://api.github.com/users/SilverFire/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/yiisoft/yii2/issues/15829/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/yiisoft/yii2/issues/15829/timeline","performed_via_github_app":null,"state_reason":"completed"}