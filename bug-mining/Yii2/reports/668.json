{"url":"https://api.github.com/repos/yiisoft/yii2/issues/17909","repository_url":"https://api.github.com/repos/yiisoft/yii2","labels_url":"https://api.github.com/repos/yiisoft/yii2/issues/17909/labels{/name}","comments_url":"https://api.github.com/repos/yiisoft/yii2/issues/17909/comments","events_url":"https://api.github.com/repos/yiisoft/yii2/issues/17909/events","html_url":"https://github.com/yiisoft/yii2/issues/17909","id":576017116,"node_id":"MDU6SXNzdWU1NzYwMTcxMTY=","number":17909,"title":"DB schema and driver name not cleared when connection is closed","user":{"login":"brandonkelly","id":47792,"node_id":"MDQ6VXNlcjQ3Nzky","avatar_url":"https://avatars.githubusercontent.com/u/47792?v=4","gravatar_id":"","url":"https://api.github.com/users/brandonkelly","html_url":"https://github.com/brandonkelly","followers_url":"https://api.github.com/users/brandonkelly/followers","following_url":"https://api.github.com/users/brandonkelly/following{/other_user}","gists_url":"https://api.github.com/users/brandonkelly/gists{/gist_id}","starred_url":"https://api.github.com/users/brandonkelly/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/brandonkelly/subscriptions","organizations_url":"https://api.github.com/users/brandonkelly/orgs","repos_url":"https://api.github.com/users/brandonkelly/repos","events_url":"https://api.github.com/users/brandonkelly/events{/privacy}","received_events_url":"https://api.github.com/users/brandonkelly/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":33208443,"node_id":"MDU6TGFiZWwzMzIwODQ0Mw==","url":"https://api.github.com/repos/yiisoft/yii2/labels/type:bug","name":"type:bug","color":"e102d8","default":false,"description":"Bug"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/yiisoft/yii2/milestones/50","html_url":"https://github.com/yiisoft/yii2/milestone/50","labels_url":"https://api.github.com/repos/yiisoft/yii2/milestones/50/labels","id":5003263,"node_id":"MDk6TWlsZXN0b25lNTAwMzI2Mw==","number":50,"title":"2.0.33","description":"","creator":{"login":"samdark","id":47294,"node_id":"MDQ6VXNlcjQ3Mjk0","avatar_url":"https://avatars.githubusercontent.com/u/47294?v=4","gravatar_id":"","url":"https://api.github.com/users/samdark","html_url":"https://github.com/samdark","followers_url":"https://api.github.com/users/samdark/followers","following_url":"https://api.github.com/users/samdark/following{/other_user}","gists_url":"https://api.github.com/users/samdark/gists{/gist_id}","starred_url":"https://api.github.com/users/samdark/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/samdark/subscriptions","organizations_url":"https://api.github.com/users/samdark/orgs","repos_url":"https://api.github.com/users/samdark/repos","events_url":"https://api.github.com/users/samdark/events{/privacy}","received_events_url":"https://api.github.com/users/samdark/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":53,"state":"closed","created_at":"2020-01-14T10:54:09Z","updated_at":"2020-03-24T20:06:00Z","due_on":null,"closed_at":"2020-03-24T20:06:00Z"},"comments":0,"created_at":"2020-03-05T06:12:36Z","updated_at":"2020-03-12T21:16:14Z","closed_at":"2020-03-12T21:16:10Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"When a DB connection is closed, the schema is meant to be cleared, but only if `$this->_pdo` is set:\r\n\r\nhttps://github.com/yiisoft/yii2/blob/fd6ccb615c7f75b15c9bee7f2921f012c3cc2845/framework/db/Connection.php#L654-L657\r\n\r\nIf something happened to call `getSchema()` before the connection was open, it seems like that should still be cleared as well, especially since there is no other way to unset the schema.\r\n\r\nLikewise, there is no way to clear the memoized driver name. `setDriverName()` assumes that a string will be passed and runs `strtolower()` on it, leaving no room for `null` to be passed:\r\n\r\nhttps://github.com/yiisoft/yii2/blob/fd6ccb615c7f75b15c9bee7f2921f012c3cc2845/framework/db/Connection.php#L975-L978\r\n\r\nThese are both problematic if you need to change the driver for the existing connection object (rather than create a whole new connection object).\r\n\r\nWe potentially have a need to do that in Craft during initial DB setup. We can’t simply swap out the `db` component because a reference to the old connection is still stored on other components like the queue (`$this->db`).\r\n\r\n### What steps will reproduce the problem?\r\n\r\n1. Call `Yii::$app->db->close()`\r\n2. Change `Yii::$app->db->dsn` to something else\r\n\r\n### What is the expected result?\r\n\r\nThe `$_driverName` and `$_schema` properties will be reset.\r\n\r\n### What do you get instead?\r\n\r\n`$_driverName` will remain set to its prior value, and `$_schema` will only be reset if `$_pdo` wasn’t `null`.\r\n\r\n### Additional info\r\n\r\n| Q                | A\r\n| ---------------- | ---\r\n| Yii version      | 2.0.32\r\n| PHP version      | n/a\r\n| Operating system | n/a\r\n","closed_by":{"login":"samdark","id":47294,"node_id":"MDQ6VXNlcjQ3Mjk0","avatar_url":"https://avatars.githubusercontent.com/u/47294?v=4","gravatar_id":"","url":"https://api.github.com/users/samdark","html_url":"https://github.com/samdark","followers_url":"https://api.github.com/users/samdark/followers","following_url":"https://api.github.com/users/samdark/following{/other_user}","gists_url":"https://api.github.com/users/samdark/gists{/gist_id}","starred_url":"https://api.github.com/users/samdark/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/samdark/subscriptions","organizations_url":"https://api.github.com/users/samdark/orgs","repos_url":"https://api.github.com/users/samdark/repos","events_url":"https://api.github.com/users/samdark/events{/privacy}","received_events_url":"https://api.github.com/users/samdark/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/yiisoft/yii2/issues/17909/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/yiisoft/yii2/issues/17909/timeline","performed_via_github_app":null,"state_reason":"completed"}