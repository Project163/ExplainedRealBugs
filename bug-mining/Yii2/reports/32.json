{"url":"https://api.github.com/repos/yiisoft/yii2/issues/11283","repository_url":"https://api.github.com/repos/yiisoft/yii2","labels_url":"https://api.github.com/repos/yiisoft/yii2/issues/11283/labels{/name}","comments_url":"https://api.github.com/repos/yiisoft/yii2/issues/11283/comments","events_url":"https://api.github.com/repos/yiisoft/yii2/issues/11283/events","html_url":"https://github.com/yiisoft/yii2/issues/11283","id":146133970,"node_id":"MDU6SXNzdWUxNDYxMzM5NzA=","number":11283,"title":"ActiveRecord::unlink() is unnecessarily nulling foreign key property","user":{"login":"PMan2","id":16500320,"node_id":"MDQ6VXNlcjE2NTAwMzIw","avatar_url":"https://avatars.githubusercontent.com/u/16500320?v=4","gravatar_id":"","url":"https://api.github.com/users/PMan2","html_url":"https://github.com/PMan2","followers_url":"https://api.github.com/users/PMan2/followers","following_url":"https://api.github.com/users/PMan2/following{/other_user}","gists_url":"https://api.github.com/users/PMan2/gists{/gist_id}","starred_url":"https://api.github.com/users/PMan2/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/PMan2/subscriptions","organizations_url":"https://api.github.com/users/PMan2/orgs","repos_url":"https://api.github.com/users/PMan2/repos","events_url":"https://api.github.com/users/PMan2/events{/privacy}","received_events_url":"https://api.github.com/users/PMan2/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"samdark","id":47294,"node_id":"MDQ6VXNlcjQ3Mjk0","avatar_url":"https://avatars.githubusercontent.com/u/47294?v=4","gravatar_id":"","url":"https://api.github.com/users/samdark","html_url":"https://github.com/samdark","followers_url":"https://api.github.com/users/samdark/followers","following_url":"https://api.github.com/users/samdark/following{/other_user}","gists_url":"https://api.github.com/users/samdark/gists{/gist_id}","starred_url":"https://api.github.com/users/samdark/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/samdark/subscriptions","organizations_url":"https://api.github.com/users/samdark/orgs","repos_url":"https://api.github.com/users/samdark/repos","events_url":"https://api.github.com/users/samdark/events{/privacy}","received_events_url":"https://api.github.com/users/samdark/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"samdark","id":47294,"node_id":"MDQ6VXNlcjQ3Mjk0","avatar_url":"https://avatars.githubusercontent.com/u/47294?v=4","gravatar_id":"","url":"https://api.github.com/users/samdark","html_url":"https://github.com/samdark","followers_url":"https://api.github.com/users/samdark/followers","following_url":"https://api.github.com/users/samdark/following{/other_user}","gists_url":"https://api.github.com/users/samdark/gists{/gist_id}","starred_url":"https://api.github.com/users/samdark/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/samdark/subscriptions","organizations_url":"https://api.github.com/users/samdark/orgs","repos_url":"https://api.github.com/users/samdark/repos","events_url":"https://api.github.com/users/samdark/events{/privacy}","received_events_url":"https://api.github.com/users/samdark/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/yiisoft/yii2/milestones/16","html_url":"https://github.com/yiisoft/yii2/milestone/16","labels_url":"https://api.github.com/repos/yiisoft/yii2/milestones/16/labels","id":1242959,"node_id":"MDk6TWlsZXN0b25lMTI0Mjk1OQ==","number":16,"title":"2.0.8","description":"","creator":{"login":"cebe","id":189796,"node_id":"MDQ6VXNlcjE4OTc5Ng==","avatar_url":"https://avatars.githubusercontent.com/u/189796?v=4","gravatar_id":"","url":"https://api.github.com/users/cebe","html_url":"https://github.com/cebe","followers_url":"https://api.github.com/users/cebe/followers","following_url":"https://api.github.com/users/cebe/following{/other_user}","gists_url":"https://api.github.com/users/cebe/gists{/gist_id}","starred_url":"https://api.github.com/users/cebe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cebe/subscriptions","organizations_url":"https://api.github.com/users/cebe/orgs","repos_url":"https://api.github.com/users/cebe/repos","events_url":"https://api.github.com/users/cebe/events{/privacy}","received_events_url":"https://api.github.com/users/cebe/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":261,"state":"closed","created_at":"2015-08-05T22:18:21Z","updated_at":"2016-06-20T13:18:51Z","due_on":"2016-04-25T07:00:00Z","closed_at":"2016-04-28T15:04:35Z"},"comments":1,"created_at":"2016-04-05T23:10:18Z","updated_at":"2016-04-06T09:43:00Z","closed_at":"2016-04-06T09:42:08Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Hello,\nI have problem with foreach on line 1307 in BaseActiveRecord.php, which is nulling foreign key property of parent model.\nI'm using custom delete behavior, where I cancel \"real\" model deletion and I just set the \"deleted\" attribute to \"true\" instead.\n\nImportant part of my custom delete behavior code:\n\n``` php\npublic function beforeDelete($event) {\n    ...\n    $owner->{$this->deletedAttribute} = true;\n    $owner->save();\n    $event->isValid = false;\n}\n```\n\nSo imho it would be correct to keep foreign key value, but only when \"$delete\" parameter is set to \"true\", so it won't break the other functionality.\n\n**Original code:**\n\n``` php\nforeach ($relation->link as $a => $b) {\n    $model->$a = null;\n}\n$delete ? $model->delete() : $model->save(false);\n```\n\n**Altered code:**\n\n``` php\nif (!$delete) {\n    foreach ($relation->link as $a => $b) {\n        $model->$a = null;\n    }\n}\n$delete ? $model->delete() : $model->save(false);\n```\n\nWhen programmer want to unlink without delete, it will do the nullification of foreign key, which is OK. But when he wants to delete foreign model, it will keep the foreign key value. This doesn't matter when you do \"real\" delete (foreign model will be deleted anyway), but when you override deletion in behavior by updating \"deleted\" attribute, you keep data in database and when the non-nullable foreign key is nullified, the SQL update crashes.\n\nCheers and thanks.\n\n~PMan\n### Additional info\n\n| Q | A |\n| --- | --- |\n| Yii version | 2.0.6 |\n| PHP version | 5.5.30 |\n| Operating system | Win 8.1 |\n","closed_by":{"login":"samdark","id":47294,"node_id":"MDQ6VXNlcjQ3Mjk0","avatar_url":"https://avatars.githubusercontent.com/u/47294?v=4","gravatar_id":"","url":"https://api.github.com/users/samdark","html_url":"https://github.com/samdark","followers_url":"https://api.github.com/users/samdark/followers","following_url":"https://api.github.com/users/samdark/following{/other_user}","gists_url":"https://api.github.com/users/samdark/gists{/gist_id}","starred_url":"https://api.github.com/users/samdark/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/samdark/subscriptions","organizations_url":"https://api.github.com/users/samdark/orgs","repos_url":"https://api.github.com/users/samdark/repos","events_url":"https://api.github.com/users/samdark/events{/privacy}","received_events_url":"https://api.github.com/users/samdark/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/yiisoft/yii2/issues/11283/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/yiisoft/yii2/issues/11283/timeline","performed_via_github_app":null,"state_reason":"completed"}