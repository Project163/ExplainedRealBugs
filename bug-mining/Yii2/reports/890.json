{"url":"https://api.github.com/repos/yiisoft/yii2/issues/19927","repository_url":"https://api.github.com/repos/yiisoft/yii2","labels_url":"https://api.github.com/repos/yiisoft/yii2/issues/19927/labels{/name}","comments_url":"https://api.github.com/repos/yiisoft/yii2/issues/19927/comments","events_url":"https://api.github.com/repos/yiisoft/yii2/issues/19927/events","html_url":"https://github.com/yiisoft/yii2/issues/19927","id":1853232170,"node_id":"I_kwDOADRbGc5udhQq","number":19927,"title":"Possible bugs in message command when saving to DB","user":{"login":"atrandafir","id":3097251,"node_id":"MDQ6VXNlcjMwOTcyNTE=","avatar_url":"https://avatars.githubusercontent.com/u/3097251?v=4","gravatar_id":"","url":"https://api.github.com/users/atrandafir","html_url":"https://github.com/atrandafir","followers_url":"https://api.github.com/users/atrandafir/followers","following_url":"https://api.github.com/users/atrandafir/following{/other_user}","gists_url":"https://api.github.com/users/atrandafir/gists{/gist_id}","starred_url":"https://api.github.com/users/atrandafir/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/atrandafir/subscriptions","organizations_url":"https://api.github.com/users/atrandafir/orgs","repos_url":"https://api.github.com/users/atrandafir/repos","events_url":"https://api.github.com/users/atrandafir/events{/privacy}","received_events_url":"https://api.github.com/users/atrandafir/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":33208443,"node_id":"MDU6TGFiZWwzMzIwODQ0Mw==","url":"https://api.github.com/repos/yiisoft/yii2/labels/type:bug","name":"type:bug","color":"e102d8","default":false,"description":"Bug"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/yiisoft/yii2/milestones/75","html_url":"https://github.com/yiisoft/yii2/milestone/75","labels_url":"https://api.github.com/repos/yiisoft/yii2/milestones/75/labels","id":10007738,"node_id":"MI_kwDOADRbGc4AmLS6","number":75,"title":"2.0.50","description":"","creator":{"login":"bizley","id":8577314,"node_id":"MDQ6VXNlcjg1NzczMTQ=","avatar_url":"https://avatars.githubusercontent.com/u/8577314?v=4","gravatar_id":"","url":"https://api.github.com/users/bizley","html_url":"https://github.com/bizley","followers_url":"https://api.github.com/users/bizley/followers","following_url":"https://api.github.com/users/bizley/following{/other_user}","gists_url":"https://api.github.com/users/bizley/gists{/gist_id}","starred_url":"https://api.github.com/users/bizley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bizley/subscriptions","organizations_url":"https://api.github.com/users/bizley/orgs","repos_url":"https://api.github.com/users/bizley/repos","events_url":"https://api.github.com/users/bizley/events{/privacy}","received_events_url":"https://api.github.com/users/bizley/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":67,"state":"closed","created_at":"2023-10-05T15:49:03Z","updated_at":"2024-05-30T17:24:04Z","due_on":null,"closed_at":"2024-05-30T17:24:04Z"},"comments":4,"created_at":"2023-08-16T13:19:14Z","updated_at":"2023-10-18T13:41:01Z","closed_at":"2023-10-16T07:17:06Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### What steps will reproduce the problem?\r\n\r\n#### First part - Set up messages and make them save to DB\r\n\r\nhttps://www.yiiframework.com/doc/api/2.0/yii-i18n-dbmessagesource\r\n\r\n`common/config/messages.php`  \r\n\r\n```\r\n<?php\r\n\r\nreturn [\r\n\t...\r\n    'languages' => array_keys([\r\n\t\t'es' => 'Español',\r\n\t\t'ca' => 'Català',\r\n\t\t'en' => 'English',\r\n\t]),\r\n    'removeUnused' => true,\r\n    'markUnused' => true,\r\n    ...\r\n    // 'db' output format is for saving messages to database.\r\n    'format' => 'db',\r\n    ...\r\n];\r\n```\r\n\r\nAlso make sure you create the required tables by running the migration as instructed in API link.\r\n\r\nNow add some translations inside some php files in your application:  \r\n```\r\n<p><?php echo Yii::t('app', 'This is my first translation string'); ?></p>\r\n```\r\n\r\nThen run the messages command with your configuration file:  \r\n\r\n```\r\nyii message common/config/messages.php\r\n```\r\n\r\nUntil here, everything should have worked as expected and the translations are also working fine.\r\n\r\nIf you look into the DB you have both the source messages and the translation messages (NULL) rows inserted. You just have to edit the translations rows and add your translations.\r\n\r\n#### Second part\r\n\r\nThis is where the `bugs` occur.\r\n\r\nAdd a new language into your configuration file:  \r\n\r\n```\r\n<?php\r\n\r\nreturn [\r\n\t...\r\n    'languages' => array_keys([\r\n\t\t'es' => 'Español',\r\n\t\t'ca' => 'Català',\r\n\t\t'en' => 'English',\r\n                'af' => 'Afrikaans', // <-- new language here\r\n\t]),\r\n    ...\r\n];\r\n```\r\n\r\nAnd also add a new translation string somewhere inside your application:  \r\n\r\n```\r\n<p><?php echo Yii::t('app', 'This is a new translation string'); ?></p>\r\n```\r\n\r\nNow run the messages command again:  \r\n\r\n```\r\nyii message common/config/messages.php\r\n```\r\n\r\n### What is the expected result?\r\n\r\n- I expect the command to insert the new string in the source table\r\n- I expect the command to insert the NULL translation into the message table\r\n- I expect the command to not break\r\n- I expect the command, if run at a later time, to check and rebuild all the missing rows if the data is incomplete\r\n- I expect the command to consider obsolete the translations of a language that is no longer used and mark/delete them\r\n\r\n### What do you get instead?\r\n\r\n- The command inserts the new source message\r\n- The command inserts the NULL translation ONCE\r\n- The command then tries to insert another NULL translation for the same key (id-lang) because it considers the new added language as a missing language\r\n- I get a MySQL FK error and the remaining queries get cancelled and never get the chance to run so the messages table becomes incomplete\r\n- Also if I remove a language and run the command, the rows in the messages table are not removed\r\n\r\n```\r\n2023-07-31 12:43:37 [-][-][-][error][yii\\db\\IntegrityException] PDOException: SQLSTATE[23000]: Integrity constraint violation: 1062 Duplicate entry '366-af' for key 'PRIMARY' in /var/>\r\nStack trace:\r\n#0 /var/www/vhosts/example.com/httpdocs/vendor/yiisoft/yii2/db/Command.php(1302): PDOStatement->execute()\r\n#1 /var/www/vhosts/example.com/httpdocs/vendor/yiisoft/yii2/db/Command.php(1102): yii\\db\\Command->internalExecute()\r\n#2 /var/www/vhosts/example.com/httpdocs/vendor/yiisoft/yii2/console/controllers/MessageController.php(421): yii\\db\\Command->execute()\r\n#3 /var/www/vhosts/example.com/httpdocs/vendor/yiisoft/yii2/console/controllers/MessageController.php(331): yii\\console\\controllers\\MessageController->saveMessagesToDb()\r\n#4 [internal function]: yii\\console\\controllers\\MessageController->actionExtract()\r\n#5 /var/www/vhosts/example.com/httpdocs/vendor/yiisoft/yii2/base/InlineAction.php(57): call_user_func_array()\r\n#6 /var/www/vhosts/example.com/httpdocs/vendor/yiisoft/yii2/base/Controller.php(178): yii\\base\\InlineAction->runWithParams()\r\n#7 /var/www/vhosts/example.com/httpdocs/vendor/yiisoft/yii2/console/Controller.php(180): yii\\base\\Controller->runAction()\r\n#8 /var/www/vhosts/example.com/httpdocs/vendor/yiisoft/yii2/base/Module.php(552): yii\\console\\Controller->runAction()\r\n#9 /var/www/vhosts/example.com/httpdocs/vendor/yiisoft/yii2/console/Application.php(180): yii\\base\\Module->runAction()\r\n#10 /var/www/vhosts/example.com/httpdocs/vendor/yiisoft/yii2/console/Application.php(147): yii\\console\\Application->runAction()\r\n#11 /var/www/vhosts/example.com/httpdocs/vendor/yiisoft/yii2/base/Application.php(384): yii\\console\\Application->handleRequest()\r\n#12 /var/www/vhosts/example.com/httpdocs/yii(23): yii\\base\\Application->run()\r\n#13 {main}\r\n\r\n```\r\n\r\n### Additional info\r\n\r\n| Q                | A\r\n| ---------------- | ---\r\n| Yii version      | 2.0.48.1\r\n| PHP version      | 8.1.19\r\n| Operating system | Windows 11\r\n","closed_by":{"login":"samdark","id":47294,"node_id":"MDQ6VXNlcjQ3Mjk0","avatar_url":"https://avatars.githubusercontent.com/u/47294?v=4","gravatar_id":"","url":"https://api.github.com/users/samdark","html_url":"https://github.com/samdark","followers_url":"https://api.github.com/users/samdark/followers","following_url":"https://api.github.com/users/samdark/following{/other_user}","gists_url":"https://api.github.com/users/samdark/gists{/gist_id}","starred_url":"https://api.github.com/users/samdark/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/samdark/subscriptions","organizations_url":"https://api.github.com/users/samdark/orgs","repos_url":"https://api.github.com/users/samdark/repos","events_url":"https://api.github.com/users/samdark/events{/privacy}","received_events_url":"https://api.github.com/users/samdark/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/yiisoft/yii2/issues/19927/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/yiisoft/yii2/issues/19927/timeline","performed_via_github_app":null,"state_reason":"completed"}