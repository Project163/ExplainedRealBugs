<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:33:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[JCRVLT-699] Installation of Sub Packages fails if Maven Reproducible Builds are enabled</title>
                <link>https://issues.apache.org/jira/browse/JCRVLT-699</link>
                <project id="12314920" key="JCRVLT">Jackrabbit FileVault</project>
                    <description>&lt;p&gt;if a container package containing one or multiple sub packages is installed, the sub packages automatically get installed as well. if this container package is updated with new content but same (snapshot) versions of the sub packages, the sub packages reinstalled as well, reflecting the updated content of the sub packages&lt;/p&gt;

&lt;p&gt;however, with version 3.6.6 and up, this update of already installed sub packages fails, if the sub packages are created with &quot;reproducible builds&quot; enabled, which has the effect that the &quot;created&quot; date in the package properties remains unchanged&lt;/p&gt;

&lt;p&gt;i&apos;ve created a small test project to reproduce the problem on &lt;a href=&quot;https://github.com/stefanseifert/filevault-subpackage-install-issues&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/stefanseifert/filevault-subpackage-install-issues&lt;/a&gt; - steps to reproduce the problem:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;build project and upload and install the package &quot;app1-all&quot;&lt;/li&gt;
	&lt;li&gt;open &lt;tt&gt;/content/app1.html&lt;/tt&gt; - it shows &quot;Title 1&quot;&lt;/li&gt;
	&lt;li&gt;change this title in &lt;tt&gt;app1-content/src/main/content/jcr_root/content/app1/.content.xml&lt;/tt&gt; to &quot;Title 2&quot;&lt;/li&gt;
	&lt;li&gt;rebuild project and upload and install the package &quot;app1-all&quot;&lt;/li&gt;
	&lt;li&gt;open &lt;tt&gt;/content/app1.html&lt;/tt&gt; - it still shows &quot;Title 1&quot;&lt;br/&gt;
expected: it should show &quot;Title 2&quot;&lt;/li&gt;
	&lt;li&gt;workaround: re-install the contained sub-package &quot;app1-content&quot; manually, then the title is updated&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;the problem does not occur if:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;the property &lt;tt&gt;project.build.outputTimestamp&lt;/tt&gt; is removed from the project&lt;/li&gt;
	&lt;li&gt;or filevault 3.4.0 is used&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;so there was a change between 3.4.0 and 3.6.6 that introduced a problem with installing sub packages with reproducible builds enabled. i&apos;ve debugged a bit but was not able to look deeper - but if i put a breakpoint in the &quot;PackageTransformer&quot; where it checks whether the package was already installed &quot;externally&quot; via &lt;tt&gt;pkg.isInstalled()&lt;/tt&gt; on the sub packages this returns false with 3.4.0 and true with 3.6.6. the vlt:definition node of the package shows a mixture of updated content, and properties reflecting the previous install, whereas with 3.4.0 only the updated properties are displayed.&lt;/p&gt;

&lt;p&gt;i tested the issue with AEMaaCS 2022.11.9850 (using filevault 3.4.0), AEMaaCS 2022.12.10488 (using 3.6.6) and 2023.2.11289 (using 3.6.9.T20230216120000-0a9b076a) - but i assume it can be reproduced with sling only as well.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13529289">JCRVLT-699</key>
            <summary>Installation of Sub Packages fails if Maven Reproducible Builds are enabled</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kwin">Konrad Windszus</assignee>
                                    <reporter username="sseifert">Stefan Seifert</reporter>
                        <labels>
                    </labels>
                <created>Mon, 20 Mar 2023 18:12:50 +0000</created>
                <updated>Wed, 19 Jul 2023 13:22:57 +0000</updated>
                            <resolved>Wed, 22 Mar 2023 15:40:50 +0000</resolved>
                                    <version>3.6.6</version>
                                    <fixVersion>package-maven-plugin-1.3.4</fixVersion>
                    <fixVersion>3.7.0</fixVersion>
                                    <component>vlt</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17702879" author="sseifert@pro-vision.de" created="Mon, 20 Mar 2023 18:13:57 +0000"  >&lt;p&gt;(accidentally used the wrong ticket type, should be &quot;bug&quot;, but i&apos;m not allowed to change it)&lt;/p&gt;</comment>
                            <comment id="17703106" author="kwin" created="Tue, 21 Mar 2023 08:58:41 +0000"  >&lt;p&gt;The issue is that with reproducible build enabled the created date of the package is hard-coded: &lt;a href=&quot;https://github.com/apache/jackrabbit-filevault-package-maven-plugin/blob/f094341f8244d5d636d992699c762df13b88d84b/src/main/java/org/apache/jackrabbit/filevault/maven/packaging/mojo/GenerateMetadataMojo.java#L982-L986&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/jackrabbit-filevault-package-maven-plugin/blob/f094341f8244d5d636d992699c762df13b88d84b/src/main/java/org/apache/jackrabbit/filevault/maven/packaging/mojo/GenerateMetadataMojo.java#L982-L986&lt;/a&gt; (derived from the &lt;tt&gt;build.outputTimestamp&lt;/tt&gt;). Therefore the logic in &lt;a href=&quot;https://github.com/apache/jackrabbit-filevault/blob/870ac10e12a767c6f4a15e4d9d76fe88523ac97f/vault-core/src/main/java/org/apache/jackrabbit/vault/packaging/registry/impl/JcrPackageRegistry.java#L425&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/jackrabbit-filevault/blob/870ac10e12a767c6f4a15e4d9d76fe88523ac97f/vault-core/src/main/java/org/apache/jackrabbit/vault/packaging/registry/impl/JcrPackageRegistry.java#L425&lt;/a&gt; would transfer the metadata from the old to the new package (i.e. keep the lastUnwrapped). Subsequently &lt;a href=&quot;https://github.com/apache/jackrabbit-filevault/blob/870ac10e12a767c6f4a15e4d9d76fe88523ac97f/vault-core/src/main/java/org/apache/jackrabbit/vault/packaging/impl/JcrPackageImpl.java#L185&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/jackrabbit-filevault/blob/870ac10e12a767c6f4a15e4d9d76fe88523ac97f/vault-core/src/main/java/org/apache/jackrabbit/vault/packaging/impl/JcrPackageImpl.java#L185&lt;/a&gt; returns true.&lt;/p&gt;

&lt;p&gt;There are two possible fixes: &lt;br/&gt;
a) In FileVault never take over existing metadata definition for SNAPSHOTs (requires a new FileVault version at run time)&lt;br/&gt;
b) In the Maven Plugin never use the hardcoded created date for SNAPSHOTs (just requires a new Maven plugin version at build time). This would effectively disable reproducible builds for SNAPSHOTs (which makes sense from my perspective)&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sseifert&quot; class=&quot;user-hover&quot; rel=&quot;sseifert&quot;&gt;sseifert&lt;/a&gt; WDYT?&lt;/p&gt;</comment>
                            <comment id="17703136" author="sseifert@pro-vision.de" created="Tue, 21 Mar 2023 10:29:28 +0000"  >&lt;p&gt;i think in general having the reproducible build feature in the package plugin working as it is is a good thing and should be kept, so i do not favor b)&lt;/p&gt;

&lt;p&gt;the check in &lt;a href=&quot;https://github.com/apache/jackrabbit-filevault/blob/870ac10e12a767c6f4a15e4d9d76fe88523ac97f/vault-core/src/main/java/org/apache/jackrabbit/vault/packaging/registry/impl/JcrPackageRegistry.java#L425&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/jackrabbit-filevault/blob/870ac10e12a767c6f4a15e4d9d76fe88523ac97f/vault-core/src/main/java/org/apache/jackrabbit/vault/packaging/registry/impl/JcrPackageRegistry.java#L425&lt;/a&gt; is very simplistic by only looking at the created date. wouldn&apos;t it be better to&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;actually compare the package content, not sure if this is possible e.g. by comparing a hash value&lt;/li&gt;
	&lt;li&gt;or to always replace the package if a -SNAPSHOT version is used?&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;so a) sounds like a good solution to me, although it takes longer to get updated in all affected runtimes.&lt;/p&gt;</comment>
                            <comment id="17703137" author="sseifert@pro-vision.de" created="Tue, 21 Mar 2023 10:30:37 +0000"  >&lt;p&gt;and why did it work with filevault 3.4.0 - using the same maven plugin version?&lt;/p&gt;</comment>
                            <comment id="17703225" author="kwin" created="Tue, 21 Mar 2023 14:12:59 +0000"  >&lt;blockquote&gt;&lt;p&gt;and why did it work with filevault 3.4.0 - using the same maven plugin version?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I don&apos;t know yet. Can you help debugging this version and see if &lt;a href=&quot;https://github.com/apache/jackrabbit-filevault/blob/870ac10e12a767c6f4a15e4d9d76fe88523ac97f/vault-core/src/main/java/org/apache/jackrabbit/vault/packaging/registry/impl/JcrPackageRegistry.java#L425&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/jackrabbit-filevault/blob/870ac10e12a767c6f4a15e4d9d76fe88523ac97f/vault-core/src/main/java/org/apache/jackrabbit/vault/packaging/registry/impl/JcrPackageRegistry.java#L425&lt;/a&gt; kicks in?&lt;/p&gt;

&lt;p&gt;I would still go for b) to make it work again with FileVault 3.4.0+. Do you have a convincing good use case why reproducible builds need to work with SNAPSHOTs? &lt;/p&gt;

&lt;p&gt;In addition it would be good to improve the robustness of copying over definition from old to new packages, so a fix for a) should be done as well.&lt;/p&gt;</comment>
                            <comment id="17703230" author="sseifert@pro-vision.de" created="Tue, 21 Mar 2023 14:22:34 +0000"  >&lt;p&gt;ah, i did not read proposal a) exactly, i missed the point you want to disable it only when a -SNAPSHOT version is used. this should work, and reproducible build is definitely not required for SNAPSHOT packages. on the other hand, it feels like a hack to make this distinction in setting the creation date.&lt;/p&gt;</comment>
                            <comment id="17703241" author="sseifert@pro-vision.de" created="Tue, 21 Mar 2023 14:46:47 +0000"  >&lt;p&gt;i debugged the code around &lt;a href=&quot;https://github.com/apache/jackrabbit-filevault/blob/870ac10e12a767c6f4a15e4d9d76fe88523ac97f/vault-core/src/main/java/org/apache/jackrabbit/vault/packaging/registry/impl/JcrPackageRegistry.java#L425&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/jackrabbit-filevault/blob/870ac10e12a767c6f4a15e4d9d76fe88523ac97f/vault-core/src/main/java/org/apache/jackrabbit/vault/packaging/registry/impl/JcrPackageRegistry.java#L425&lt;/a&gt; while installing an affected packages to filevault 3.4.0:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;the code is executed, but def.getCreated() returns null&lt;/li&gt;
	&lt;li&gt;looking during the install process at /etc/packages/app1/app1-content-1.0.0-SNAPSHOT.zip/jcr:content/vlt:definition shows that jcr:created is indeed missing - but other properties from the just uploaded package are present, e.g. an updated jcr:description.&lt;/li&gt;
	&lt;li&gt;but the uploaded package does contain a create property, probably it&apos;s ignored with filevault 3.4.0&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17703253" author="kwin" created="Tue, 21 Mar 2023 15:07:49 +0000"  >&lt;p&gt;Thanks for debugging.&lt;br/&gt;
Unfortunately there is no checksum available at the time where this check happens (and calculating it would introduce a major performance loss), so we can either always drop metadata for overwritten SNAPSHOTs (i.e. always reinstall, even if not necessary) because even taking into consideration additional metadata would probably not trigger it or keep the current heuristic of only considering the createdDate.&lt;/p&gt;

&lt;p&gt;There is &lt;a href=&quot;https://docs.oracle.com/javase/8/docs/api/java/util/zip/ZipEntry.html#getCrc--&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://docs.oracle.com/javase/8/docs/api/java/util/zip/ZipEntry.html#getCrc--&lt;/a&gt; but there is no equivalent in the Content Package Archive interface (&lt;a href=&quot;https://github.com/apache/jackrabbit-filevault/blob/870ac10e12a767c6f4a15e4d9d76fe88523ac97f/vault-core/src/main/java/org/apache/jackrabbit/vault/fs/io/Archive.java#L124&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/jackrabbit-filevault/blob/870ac10e12a767c6f4a15e4d9d76fe88523ac97f/vault-core/src/main/java/org/apache/jackrabbit/vault/fs/io/Archive.java#L124&lt;/a&gt;) and also iterating through all entries is expensive when you deal with an arbitrary input stream.&lt;/p&gt;</comment>
                            <comment id="17703716" author="kwin" created="Wed, 22 Mar 2023 15:40:50 +0000"  >&lt;p&gt;Fixed in &lt;a href=&quot;https://github.com/apache/jackrabbit-filevault/commit/cdd957198664c7e7ba980578803ac722a5934a73&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/jackrabbit-filevault/commit/cdd957198664c7e7ba980578803ac722a5934a73&lt;/a&gt; (Vault-Core) and &lt;a href=&quot;https://github.com/apache/jackrabbit-filevault-package-maven-plugin/commit/f6f58df54122141e7ef336a6dea510151ca1676e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/jackrabbit-filevault-package-maven-plugin/commit/f6f58df54122141e7ef336a6dea510151ca1676e&lt;/a&gt; (Maven Plugin)&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13038053">JCRVLT-155</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13264467">JCRVLT-387</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 33 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1gpsw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>