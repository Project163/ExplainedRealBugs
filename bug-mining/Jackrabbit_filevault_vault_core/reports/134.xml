<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:33:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[JCRVLT-544] Creation of folders based on parent&apos;s default nodetype instead of nt:folder causing regression</title>
                <link>https://issues.apache.org/jira/browse/JCRVLT-544</link>
                <project id="12314920" key="JCRVLT">Jackrabbit FileVault</project>
                    <description>&lt;p&gt;The change of &lt;a href=&quot;https://issues.apache.org/jira/browse/JCRVLT-417&quot; title=&quot;Intermediate Node Types should be default node type of parent node type definition instead of &amp;quot;nt:folder&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;JCRVLT-417&quot;&gt;&lt;del&gt;JCRVLT-417&lt;/del&gt;&lt;/a&gt; makes folder creation fall back to the nodetypes declared in the  nodetype constraint of the primary type. This can cause regressions with existing packages.&lt;br/&gt;
In the given case the nodetype cq:Component allows a child node definition with primaryType nt:base (which nt:folder derives from) - yet as nt:base has no childNodeDefinitions declared any substructures fail to install.  The nodeType definition of cq:Component is correct as it &quot;allows&quot; anything deriving from nt:base, whereas only the derived nodeTypes open up further options like substructures.&lt;/p&gt;

&lt;p&gt;//cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kwin&quot; class=&quot;user-hover&quot; rel=&quot;kwin&quot;&gt;kwin&lt;/a&gt; introducing the behavioral change.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13386794">JCRVLT-544</key>
            <summary>Creation of folders based on parent&apos;s default nodetype instead of nt:folder causing regression</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kwin">Konrad Windszus</assignee>
                                    <reporter username="dsuess">Dominik S&#252;&#223;</reporter>
                        <labels>
                    </labels>
                <created>Wed, 30 Jun 2021 13:37:31 +0000</created>
                <updated>Tue, 5 Oct 2021 14:25:31 +0000</updated>
                            <resolved>Mon, 5 Jul 2021 15:30:52 +0000</resolved>
                                    <version>3.4.4</version>
                                    <fixVersion>3.5.4</fixVersion>
                                    <component>vlt</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17372055" author="kwin" created="Wed, 30 Jun 2021 14:55:57 +0000"  >&lt;p&gt;The default node type is orthogonal to allowed child nodes. It is a separately maintained in the CND file (and inside the repository). In the CND default node types are given as &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
= ns:defaultType
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Currently the CND of &lt;tt&gt;cq:Component&lt;/tt&gt; looks like this&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[cq:Component] &amp;gt; mix:title, nt:folder, sling:ResourceSuperType
  - dialogPath (string)
  - cq:noDecoration (&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;)
  - allowedChildren (string) multiple
  - * (undefined)
  - cq:isContainer (&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;)
  - allowedParents (string) multiple
  - * (undefined) multiple
  - cq:cellName (string)
  - componentGroup (string)
  + dialog (nt:base) = nt:unstructured
  + design_dialog (nt:base) = nt:unstructured
  + cq:htmlTag (nt:base) = nt:unstructured
  + * (nt:base) = nt:base multiple version
  + cq:infoProviders (nt:base) = nt:unstructured
  + cq:editConfig (cq:EditConfig) = cq:EditConfig
  + icon.png (nt:file)
  + cq:childEditConfig (cq:EditConfig) = cq:EditConfig
  + thumbnail.png (nt:file)
  + virtual (nt:base) = sling:Folder

...

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;while it should IMHO rather look like this&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
...
 + * (nt:base) = nt:folder multiple version
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I still think that relying on the default node type is in general much better than always falling back to &lt;tt&gt;nt:folder&lt;/tt&gt;. But obviously this may cause regressions for node types not defining a proper default type like &lt;tt&gt;cq:Component&lt;/tt&gt;. I would still like to see a real world example package relying on nt:folder&apos;s below cq:Component. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dsuess&quot; class=&quot;user-hover&quot; rel=&quot;dsuess&quot;&gt;dsuess&lt;/a&gt; Can you share such a package?&lt;/p&gt;</comment>
                            <comment id="17372063" author="dsuess" created="Wed, 30 Jun 2021 15:06:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kwin&quot; class=&quot;user-hover&quot; rel=&quot;kwin&quot;&gt;kwin&lt;/a&gt; - I agree that based on what we know about component structures as of today nt:folder (or even nt:unstructured) might have been  a better choice. The definition in itself is valid and leaves it up to the &quot;client&quot; (vault in this case) to use other derivates. The nt:base case is  bit unfortunate as it is (atypically) a rather constrained &quot;supertype&quot;.&lt;/p&gt;

&lt;p&gt; The real world example that you can check within the AEM SDK would be &quot;cq-integration-searchpromote-content&quot;  (path: /libs/foundation/components/page/productfeed ). This contains a substructure under productfeed (childnode sp) which fails to install as productfeed gets set up with nt:base.&lt;/p&gt;</comment>
                            <comment id="17372074" author="kwin" created="Wed, 30 Jun 2021 15:23:25 +0000"  >&lt;p&gt;I am thinking about falling back to &lt;tt&gt;nt:folder&lt;/tt&gt; for a hardcoded list of default types. This list of (probably) wrong default types is &lt;tt&gt;nt:base&lt;/tt&gt; and &lt;tt&gt;nt:hierarchyNode&lt;/tt&gt;. WDYT, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dsuess&quot; class=&quot;user-hover&quot; rel=&quot;dsuess&quot;&gt;dsuess&lt;/a&gt;? &lt;/p&gt;</comment>
                            <comment id="17372092" author="dsuess" created="Wed, 30 Jun 2021 15:58:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kwin&quot; class=&quot;user-hover&quot; rel=&quot;kwin&quot;&gt;kwin&lt;/a&gt; it certainly would eliminate the known dominant cases but there is a remaining  risk of breaking in other cases. I know custom nodetypes are not too frequent, but a hardcoded list may miss on cases and we may need to append further mappings eventually. &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cziegeler&quot; class=&quot;user-hover&quot; rel=&quot;cziegeler&quot;&gt;cziegeler&lt;/a&gt; any thoughts based on the recent corresponding discussions and changes for repoinit (covering similar registration cases).&lt;/p&gt;</comment>
                            <comment id="17372097" author="cziegeler" created="Wed, 30 Jun 2021 16:11:45 +0000"  >&lt;p&gt;The change of &lt;a href=&quot;https://issues.apache.org/jira/browse/JCRVLT-417&quot; title=&quot;Intermediate Node Types should be default node type of parent node type definition instead of &amp;quot;nt:folder&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;JCRVLT-417&quot;&gt;&lt;del&gt;JCRVLT-417&lt;/del&gt;&lt;/a&gt; creates regressions; it is unclear to me whether that change is trying to fix a theoretical or practical problem. If it is theoretical we could think about reverting.&lt;br/&gt;
If that is not an option, then something similar to what repoinit tried to do sounds reasonable to me: try without specifying a nodetype, if that fails, provide a default one. (see &lt;a href=&quot;https://github.com/apache/sling-org-apache-sling-jcr-repoinit/blob/master/src/main/java/org/apache/sling/jcr/repoinit/impl/AclVisitor.java#L172&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/sling-org-apache-sling-jcr-repoinit/blob/master/src/main/java/org/apache/sling/jcr/repoinit/impl/AclVisitor.java#L172&lt;/a&gt;) .&lt;br/&gt;
If the solution used in repoinit is not working, I think we need to come up with a reliable solution and use the same approach in both places. Maintaining a list of known types might resolve the immediate issue. But its not maintainable. Shouldn&apos;t it be possible to inspect the node type and see if a default child node type is specified?&lt;/p&gt;</comment>
                            <comment id="17372122" author="kwin" created="Wed, 30 Jun 2021 17:14:25 +0000"  >&lt;blockquote&gt;&lt;p&gt;&#160;The change of &lt;a href=&quot;https://issues.apache.org/jira/browse/JCRVLT-417&quot; title=&quot;Intermediate Node Types should be default node type of parent node type definition instead of &amp;quot;nt:folder&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;JCRVLT-417&quot;&gt;&lt;del&gt;JCRVLT-417&lt;/del&gt;&lt;/a&gt; creates regressions; it is unclear to me whether that change is trying to fix a theoretical or practical problem. If it is theoretical we could think about reverting.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Please read the description of &lt;a href=&quot;https://issues.apache.org/jira/browse/JCRVLT-417&quot; title=&quot;Intermediate Node Types should be default node type of parent node type definition instead of &amp;quot;nt:folder&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;JCRVLT-417&quot;&gt;&lt;del&gt;JCRVLT-417&lt;/del&gt;&lt;/a&gt; and also &lt;a href=&quot;https://issues.apache.org/jira/browse/JCRVLT-413?focusedCommentId=17039756&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-17039756&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/JCRVLT-413?focusedCommentId=17039756&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-17039756&lt;/a&gt;. A concrete use case is described at &lt;a href=&quot;https://issues.apache.org/jira/browse/JCRVLT-403?focusedCommentId=17026237&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-17026237&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/JCRVLT-403?focusedCommentId=17026237&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-17026237&lt;/a&gt;.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;try without specifying a nodetype, if that fails, provide a default one.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We do that already, compare with &lt;a href=&quot;https://github.com/apache/jackrabbit-filevault/blob/4590f8f71b01e51fe2faaec26f86fa5af2a5c8e8/vault-core/src/main/java/org/apache/jackrabbit/vault/fs/impl/io/FolderArtifactHandler.java#L87&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/jackrabbit-filevault/blob/4590f8f71b01e51fe2faaec26f86fa5af2a5c8e8/vault-core/src/main/java/org/apache/jackrabbit/vault/fs/impl/io/FolderArtifactHandler.java#L87&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Shouldn&apos;t it be possible to inspect the node type and see if a default child node type is specified?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, we do that already, but as described in this issue, &lt;tt&gt;cq:Component&lt;/tt&gt; defines a default child node, but of the wrong type.&lt;/p&gt;</comment>
                            <comment id="17372380" author="cziegeler" created="Thu, 1 Jul 2021 04:45:21 +0000"  >&lt;p&gt;It looks to me like the current check is either not correct or not sufficient. Oak does some checks and then fails, so it seems to me that the solution is to do similar checks as Oak does internally&lt;/p&gt;</comment>
                            <comment id="17372393" author="kwin" created="Thu, 1 Jul 2021 05:18:52 +0000"  >&lt;p&gt;I am happy to review any other PR providing an alternative solution. I personally don&#8217;t know which other check would help at the time of creating the intermediate node&#8230;&lt;/p&gt;</comment>
                            <comment id="17372395" author="dsuess" created="Thu, 1 Jul 2021 05:26:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kwin&quot; class=&quot;user-hover&quot; rel=&quot;kwin&quot;&gt;kwin&lt;/a&gt; instead of prechecking we could catch the case where the exception is being thrown and readjust the parent nodetype (only in case it is part of the package installation)&lt;/p&gt;</comment>
                            <comment id="17372397" author="kwin" created="Thu, 1 Jul 2021 05:32:04 +0000"  >&lt;p&gt;Please provide a PR. &lt;/p&gt;</comment>
                            <comment id="17372515" author="dsuess" created="Thu, 1 Jul 2021 08:17:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kwin&quot; class=&quot;user-hover&quot; rel=&quot;kwin&quot;&gt;kwin&lt;/a&gt; I can try but I&apos;ll be out for roughly the next 4 weeks, therefore I suggest for now to revert this change in the meantime as it creates a regression while the previous behavior did work for 10+ years. I agree that it would  be nice to better follow the descriptive nature of CNDs where possible but the practical and theoretical cases make the current version of vault not adoptable into production. History tells that if we find a case that we could control we always find further cases rooted in customer code that we cannot control and have to stay backwards compatible as well.&lt;/p&gt;</comment>
                            <comment id="17372536" author="kwin" created="Thu, 1 Jul 2021 08:46:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dsuess&quot; class=&quot;user-hover&quot; rel=&quot;dsuess&quot;&gt;dsuess&lt;/a&gt; First of all the changed behaviour was proposed by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tripod&quot; class=&quot;user-hover&quot; rel=&quot;tripod&quot;&gt;tripod&lt;/a&gt; and for a good reason! This has been implemented 5 releases ago&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/warning.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; so we cannot just revert. This is open source and Adobe is just one consumer (out of potentially many). I proposed a PR which fixes your issue. So from my perspective there are now three options:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;We can merge the PR as proposed as soon as you add some IT&lt;/li&gt;
	&lt;li&gt;We leave the behaviour in place&lt;/li&gt;
	&lt;li&gt;You come up with an alternative solution&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="17372592" author="dsuess" created="Thu, 1 Jul 2021 09:49:09 +0000"  >&lt;p&gt; HI &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kwin&quot; class=&quot;user-hover&quot; rel=&quot;kwin&quot;&gt;kwin&lt;/a&gt; - sorry I didn&apos;t receive a notification about the PR so I saw your request for PR the only option. If you have a working PR I certainly can validate and crosscheck if this fixes the issue at hand. There is a remaining rest risk and we probably should revisit (I can do after my PTO) if we have a more robust fallback. I&apos;ll have a look at the PR and will check if it eliminates the detected breaking cases.&lt;/p&gt;</comment>
                            <comment id="17372596" author="kwin" created="Thu, 1 Jul 2021 09:55:00 +0000"  >&lt;p&gt;The status of this ticket is &quot;Patch available&quot;, the GH PR is linked in this ticket and also I mentioned you explicitly in &lt;a href=&quot;https://github.com/apache/jackrabbit-filevault/pull/155&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/jackrabbit-filevault/pull/155&lt;/a&gt;. How come you didn&apos;t receive a notification?&lt;/p&gt;</comment>
                            <comment id="17372662" author="dsuess" created="Thu, 1 Jul 2021 11:22:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kwin&quot; class=&quot;user-hover&quot; rel=&quot;kwin&quot;&gt;kwin&lt;/a&gt; I somehow never receive (or somewhere filter out) notifications around status changes or links being added - I somehow only receive  notifications on comments and as you didn#t explicitly comment I somehow didn&apos;t notice when you added this. WRT the PR mention I am not sure, it did work the last days but I didn&apos;t receive one for this one (as mail) so far.&lt;/p&gt;</comment>
                            <comment id="17374899" author="kwin" created="Mon, 5 Jul 2021 15:30:52 +0000"  >&lt;p&gt;Fixed in &lt;a href=&quot;https://github.com/apache/jackrabbit-filevault/commit/5a8d280d66d0ae9e20c7a820d9a27691d8a62b53&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/jackrabbit-filevault/commit/5a8d280d66d0ae9e20c7a820d9a27691d8a62b53&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13289256">JCRVLT-417</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 18 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0sgl4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>