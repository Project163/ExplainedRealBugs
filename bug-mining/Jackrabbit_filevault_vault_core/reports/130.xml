<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:33:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[JCRVLT-525] FSPackageRegistry: XML registry files can become corrupt</title>
                <link>https://issues.apache.org/jira/browse/JCRVLT-525</link>
                <project id="12314920" key="JCRVLT">Jackrabbit FileVault</project>
                    <description>&lt;p&gt;When the FSPackageRegistry is updated, it can happen that the XML files become corrupt when they are updated. They are not truncated when they are rewritten, and if they become shorter, there are remnants of the old XML after the end of the newly written XML, so that there is a SAXParseException when they are read again (e.g. after restarting the server, see stacktrace below).&lt;/p&gt;

&lt;p&gt;The problem is pretty simple: in&#160;org.apache.jackrabbit.vault.packaging.registry.impl.FSInstallState#save(java.nio.file.Path) the file is opened with&#160;StandardOpenOption.CREATE, but it needs&#160;StandardOpenOption.TRUNCATE_EXISTING, like this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (OutputStream out = Files.newOutputStream(file, StandardOpenOption.CREATE, StandardOpenOption.TRUNCATE_EXISTING)) { 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I&apos;m worried a little that the best way to deal with those files would be to write the content to a temporary file, and replace the old one with the newly written one after that&apos;s been saved completely to disk. Otherwise they can become corrupted for other reasons, too, e.g. if the writing fails before it&apos;s completed.&lt;/p&gt;

&lt;p&gt;I stumbled over this when I&apos;m using the Sling Feature Launcher and apply to &lt;a href=&quot;https://github.com/apache/sling-org-apache-sling-jcr-packageinit&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;org.apache.sling.jcr.packageinit&lt;/a&gt;&#160;triggered by&#160;&lt;a href=&quot;https://github.com/apache/sling-org-apache-sling-feature-extension-content&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;org.apache.sling.extension.content&lt;/a&gt;&#160;to deploy content packages from the feature launcher.&lt;/p&gt;

&lt;p&gt;By the way: the files become shorter that they originally contain a workspaceFilter section when they are initially written by org.apache.sling.jcr.packageinit , and that section disappears when the packages are updated when they are installed. That smells like a problem, but I&apos;m not sure about that. I&apos;ll append a stacktrace of the point when they are written, too.&lt;/p&gt;

&lt;p&gt;Log messages during restart with the stacktrace where the reading fails:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[INFO][INFO] Apache Sling Application Launcher[INFO] ---------------------------------[INFO] Initializing...[INFO] Artifact Repositories: [jar:file:/Users/hps/dev/composum/composum-launch/feature/composumstarter/target/composum-launcher-feature-composumstarter-1.2.1-SNAPSHOT-oak_tar-launcher.jar!/lib][INFO] Assembling &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; feature model...[INFO][INFO] Assembling launcher...[Fatal Error] composum-platform-models-&lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt;-1.3.1-SNAPSHOT.xml:5:2: Content is not allowed in trailing section.[ERROR] Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; assembling launcher: Configuration file syntax error. java.io.IOException: Configuration file syntax error.
	at shaded.org.apache.jackrabbit.vault.packaging.registry.impl.FSInstallState.fromStream(FSInstallState.java:245)
	at shaded.org.apache.jackrabbit.vault.packaging.registry.impl.FSInstallState.fromFile(FSInstallState.java:173)
	at shaded.org.apache.jackrabbit.vault.packaging.registry.impl.FSPackageRegistry.loadPackageCache(FSPackageRegistry.java:604)
	at shaded.org.apache.jackrabbit.vault.packaging.registry.impl.FSPackageRegistry.&amp;lt;init&amp;gt;(FSPackageRegistry.java:127)
	at org.apache.sling.feature.extension.content.ContentHandler.buildExecutionPlan(ContentHandler.java:72)
	at org.apache.sling.feature.extension.content.ContentHandler.handle(ContentHandler.java:127)
	at org.apache.sling.feature.launcher.impl.FeatureProcessor.prepareLauncher(FeatureProcessor.java:212)
	at org.apache.sling.feature.launcher.impl.Bootstrap.run(Bootstrap.java:160)
	at org.apache.sling.feature.launcher.impl.Main.main(Main.java:200)
	at com.composum.platform.feature.nodesstarter.LaunchFromEmbeddedFAR.run(LaunchFromEmbeddedFAR.java:65)
	at com.composum.platform.feature.nodesstarter.LaunchFromEmbeddedFAR.main(LaunchFromEmbeddedFAR.java:55)
Caused by: org.xml.sax.SAXParseException; systemId: file:&lt;span class=&quot;code-comment&quot;&gt;///Users/hps/dev/composum/composum-launch/feature/composumstarter/target/launcher/repository/packageregistry/com/composum/platform/composum-platform-models-&lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt;-1.3.1-SNAPSHOT.xml; lineNumber: 5; columnNumber: 2; Content is not allowed in trailing section.
&lt;/span&gt;	at java.xml/com.sun.org.apache.xerces.internal.parsers.DOMParser.parse(DOMParser.java:261)
	at java.xml/com.sun.org.apache.xerces.internal.jaxp.DocumentBuilderImpl.parse(DocumentBuilderImpl.java:339)
	at java.xml/javax.xml.parsers.DocumentBuilder.parse(DocumentBuilder.java:151)
	at shaded.org.apache.jackrabbit.vault.packaging.registry.impl.FSInstallState.fromStream(FSInstallState.java:193)
	... 10 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Stacktrace where the files are written (and corrupted):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
put:198, FSInstallStateCache (org.apache.jackrabbit.vault.packaging.registry.impl)
updatePackageStatus:166, FSInstallStateCache (org.apache.jackrabbit.vault.packaging.registry.impl)
installPackage:627, FSPackageRegistry (org.apache.jackrabbit.vault.packaging.registry.impl)
doInstall:193, PackageTaskImpl (org.apache.jackrabbit.vault.packaging.registry.impl)
execute:118, PackageTaskImpl (org.apache.jackrabbit.vault.packaging.registry.impl)
execute:129, ExecutionPlanImpl (org.apache.jackrabbit.vault.packaging.registry.impl)
execute:344, ExecutionPlanBuilderImpl (org.apache.jackrabbit.vault.packaging.registry.impl)
processRepository:165, ExecutionPlanRepoInitializer (org.apache.sling.jcr.packageinit.impl)
addingService:473, AbstractSlingRepositoryManager$2 (org.apache.sling.jcr.base)
addingService:462, AbstractSlingRepositoryManager$2 (org.apache.sling.jcr.base)
customizerAdding:943, ServiceTracker$Tracked (org.osgi.util.tracker)
customizerAdding:871, ServiceTracker$Tracked (org.osgi.util.tracker)
trackAdding:256, AbstractTracked (org.osgi.util.tracker)
track:229, AbstractTracked (org.osgi.util.tracker)
serviceChanged:903, ServiceTracker$Tracked (org.osgi.util.tracker)
invokeServiceListenerCallback:990, EventDispatcher (org.apache.felix.framework)
fireEventImmediately:838, EventDispatcher (org.apache.felix.framework)
fireServiceEvent:545, EventDispatcher (org.apache.felix.framework)
fireServiceEvent:4833, Felix (org.apache.felix.framework)
registerService:3804, Felix (org.apache.felix.framework)
registerService:328, BundleContextImpl (org.apache.felix.framework)
register:929, AbstractComponentManager$3 (org.apache.felix.scr.impl.manager)
register:915, AbstractComponentManager$3 (org.apache.felix.scr.impl.manager)
changeRegistration:133, RegistrationManager (org.apache.felix.scr.impl.manager)
registerService:984, AbstractComponentManager (org.apache.felix.scr.impl.manager)
activateInternal:752, AbstractComponentManager (org.apache.felix.scr.impl.manager)
enableInternal:674, AbstractComponentManager (org.apache.felix.scr.impl.manager)
enable:437, AbstractComponentManager (org.apache.felix.scr.impl.manager)
enableComponents:667, ConfigurableComponentHolder (org.apache.felix.scr.impl.manager)
initialEnable:305, BundleComponentActivator (org.apache.felix.scr.impl)
loadComponents:554, Activator (org.apache.felix.scr.impl)
access$200:70, Activator (org.apache.felix.scr.impl)
start:421, Activator$ScrExtension (org.apache.felix.scr.impl)
createExtension:196, AbstractExtender (org.apache.felix.scr.impl)
modifiedBundle:169, AbstractExtender (org.apache.felix.scr.impl)
modifiedBundle:49, AbstractExtender (org.apache.felix.scr.impl)
customizerModified:488, BundleTracker$Tracked (org.osgi.util.tracker)
customizerModified:420, BundleTracker$Tracked (org.osgi.util.tracker)
track:232, AbstractTracked (org.osgi.util.tracker)
bundleChanged:450, BundleTracker$Tracked (org.osgi.util.tracker)
invokeBundleListenerCallback:915, EventDispatcher (org.apache.felix.framework)
fireEventImmediately:834, EventDispatcher (org.apache.felix.framework)
fireBundleEvent:516, EventDispatcher (org.apache.felix.framework)
fireBundleEvent:4817, Felix (org.apache.felix.framework)
startBundle:2336, Felix (org.apache.felix.framework)
setActiveStartLevel:1539, Felix (org.apache.felix.framework)
run:308, FrameworkStartLevelImpl (org.apache.felix.framework)
run:834, &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; (java.lang)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;Sling-Starter 12-SNAPSHOT with JDK 11 on MacOS&lt;/p&gt;</environment>
        <key id="13380975">JCRVLT-525</key>
            <summary>FSPackageRegistry: XML registry files can become corrupt</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kwin">Konrad Windszus</assignee>
                                    <reporter username="hanspeterstoerr">Hans-Peter Stoerr</reporter>
                        <labels>
                    </labels>
                <created>Fri, 28 May 2021 12:29:56 +0000</created>
                <updated>Tue, 5 Oct 2021 14:25:37 +0000</updated>
                            <resolved>Fri, 11 Jun 2021 08:01:19 +0000</resolved>
                                    <version>3.5.0</version>
                                    <fixVersion>3.5.4</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17354247" author="hanspeterstoerr" created="Mon, 31 May 2021 06:55:28 +0000"  >&lt;p&gt;I&apos;ve created a simple PR that solves the immediate problem, so that I can actually restart my server. I guess a write and move file solution would be more appropriate, but that&apos;d require some testing and I currently don&apos;t have time to do something extensive here. It&apos;d be nice if that could make it&apos;s way into the &quot;official&quot; snapshot, so we could use that for now.&lt;/p&gt;

&lt;p&gt;BTW: a conceivable compromise that&apos;s easy to implement would be to save the XML into a ByteArrayOutputStream first, and then write that into the file. That&apos;d remove most of the remaining risk of the remaining corruption risk, namely that an exception in&#160;save(OutputStream out) would leave a corrupted XML file in the registry. After all the XML files are very short, and an exception during writing it is quite unlikely. I could change the PR that way, if you want. That could look like:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void save(Path file) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
        Files.createDirectories(file.getParent());
        ByteArrayOutputStream buf = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ByteArrayOutputStream();
        save(buf);
        Files.copy(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ByteArrayInputStream(buf.toByteArray()), file, StandardCopyOption.REPLACE_EXISTING);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;Thank you very much for your nice work on all these wonderful libraries!&lt;/p&gt;</comment>
                            <comment id="17356175" author="hanspeterstoerr" created="Thu, 3 Jun 2021 05:37:31 +0000"  >&lt;p&gt;Is there a chance that at least the &lt;a href=&quot;https://github.com/apache/jackrabbit-filevault/pull/142/files&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;simple solution&lt;/a&gt; gets merged soon? Otherwise I&apos;ll have to create private release for our corporate repository for now. Not a big problem, but I&apos;d have to know. Thank you!&lt;/p&gt;</comment>
                            <comment id="17356301" author="kwin" created="Thu, 3 Jun 2021 09:19:58 +0000"  >&lt;p&gt;I merged the fix in &lt;a href=&quot;https://github.com/apache/jackrabbit-filevault/commit/a8ded5b2dd1f10ef8f00fa64b80f311109049876.&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/jackrabbit-filevault/commit/a8ded5b2dd1f10ef8f00fa64b80f311109049876.&lt;/a&gt;&#160;What is still outstanding is a test covering this.&lt;/p&gt;</comment>
                            <comment id="17357119" author="hanspeterstoerr" created="Fri, 4 Jun 2021 07:31:19 +0000"  >&lt;p&gt;Thank you! Shouldn&apos;t there be a 3.5.1-SNAPSHOT in &lt;a href=&quot;https://repository.apache.org/content/groups/snapshots/org/apache/jackrabbit/vault/org.apache.jackrabbit.vault/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://repository.apache.org/content/groups/snapshots/org/apache/jackrabbit/vault/org.apache.jackrabbit.vault/&lt;/a&gt;&#160;? I hoped that&apos;d save me from uploading that to our repositories. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17357149" author="kwin" created="Fri, 4 Jun 2021 08:07:50 +0000"  >&lt;p&gt;I just deployed a new SNAPSHOT. That doesn&apos;t happen automatically but must be triggered manually for now.&lt;/p&gt;</comment>
                            <comment id="17361525" author="kwin" created="Fri, 11 Jun 2021 08:01:19 +0000"  >&lt;p&gt;Added test in&#160;&lt;a href=&quot;https://github.com/apache/jackrabbit-filevault/commit/585f264a925ec79011062fa72eb64dd1c80ffe82&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/jackrabbit-filevault/commit/585f264a925ec79011062fa72eb64dd1c80ffe82&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 22 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0rgrc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>