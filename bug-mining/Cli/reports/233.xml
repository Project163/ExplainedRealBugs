<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sun Nov 09 05:51:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CLI-341] HelpFormatter infinite loop with 0 width input </title>
                <link>https://issues.apache.org/jira/browse/CLI-341</link>
                <project id="12310463" key="CLI">Commons CLI</project>
                    <description>&lt;p&gt;I am writing to report an infinite loop bug in the HelpFormatter class when the width parameter is set to 0. Despite existing protective code meant to prevent this issue, the infinite loop still occurs under certain conditions.&lt;br/&gt;
&#160;&lt;br/&gt;
&lt;b&gt;Problem Description:&lt;/b&gt;&lt;br/&gt;
When calling HelpFormatter.printOptions() or any method that uses appendWrappedText() with width=0, the application enters an infinite loop, eventually causing heap space exhaustion.&lt;br/&gt;
&#160;&lt;br/&gt;
&#160;&lt;br/&gt;
&lt;b&gt;Test Cases:&lt;/b&gt;&lt;br/&gt;
public class HelpFormatterTest&#160;{&lt;br/&gt;
@Test&lt;br/&gt;
public void&#160;&lt;b&gt;shouldHandleZeroWidthGracefully&lt;/b&gt;() {&lt;br/&gt;
HelpFormatter formatter&#160;= new HelpFormatter();&lt;br/&gt;
Options options&#160;= new Options();&lt;br/&gt;
options.addOption(&quot;h&quot;, &quot;help&quot;, false, &quot;Show help&quot;);&lt;br/&gt;
StringWriter out&#160;= new StringWriter();&lt;br/&gt;
PrintWriter pw&#160;= new PrintWriter(out);&lt;br/&gt;
&lt;em&gt;// execute - this will trigger an infinite loop, but will be interrupted by @Timeout annotation&lt;/em&gt;&lt;br/&gt;
try&#160;&lt;/p&gt;
{
formatter.printOptions(pw, 0, options, 1, 3);
_// if we get here, it means there was no infinite loop (expected behavior after fix)_
String result&#160;= out.toString();
assertNotNull(result, &quot;Result should not be null after fix&quot;);
}
&lt;p&gt; catch&#160;(Throwable&#160;&lt;em&gt;t&lt;/em&gt;) &lt;/p&gt;
{
_// before the fix, this would catch the timeout exception_
fail(&quot;printOptions with width=0 should not cause infinite loop or throw exception&quot;);
}
&lt;p&gt;}&lt;br/&gt;
@Test&lt;br/&gt;
public void&#160;&lt;b&gt;demonstrateInfiniteLoopMechanism&lt;/b&gt;() &lt;/p&gt;
{
HelpFormatter formatter&#160;= new HelpFormatter();
_// directly test findWrapPos method to demonstrate the root cause_
String text&#160;= &quot;Hello World&quot;;
int pos&#160;= formatter.findWrapPos(text, 0, 0);
_// verify: when width=0, findWrapPos returns 0 (for non-empty text)_
assertEquals(0, pos, &quot;findWrapPos with width=0 returns 0, causing infinite loop&quot;);
_// this means the text will never be consumed, because substring(0) returns the entire string_
}
&lt;p&gt;}&lt;br/&gt;
&#160;&lt;br/&gt;
&#160;&lt;br/&gt;
&lt;b&gt;Test Results:&lt;/b&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;{*}INFO{*}&amp;#93;&lt;/span&gt; Running org.apache.commons.cli.&lt;b&gt;HelpFormatterTest&lt;/b&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;{*}ERROR{*}&amp;#93;&lt;/span&gt;&#160;&lt;b&gt;Tests run: 2&lt;/b&gt;,&#160;&lt;b&gt;Failures: 1&lt;/b&gt;, Errors: 0, Skipped: 0, Time elapsed: 25.60 s&#160;&lt;b&gt;&amp;lt;&amp;lt;&amp;lt; FAILURE!&lt;/b&gt;&#160;-- in org.apache.commons.cli.&lt;b&gt;HelpFormatterTest&lt;/b&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;{*}ERROR{*}&amp;#93;&lt;/span&gt; org.apache.commons.cli.HelpFormatterTest.shouldHandleZeroWidthGracefully &amp;#8211; Time elapsed: 25.60 s &amp;lt;&amp;lt;&amp;lt; FAILURE!&lt;br/&gt;
org.opentest4j.AssertionFailedError: printOptions with width=0 should not cause infinite loop or throw exception&lt;br/&gt;
at org.junit.jupiter.api.AssertionUtils.fail(AssertionUtils.java:38)&lt;br/&gt;
at org.junit.jupiter.api.Assertions.fail(Assertions.java:138)&lt;br/&gt;
at org.apache.commons.cli.HelpFormatterTest.shouldHandleZeroWidthGracefully(HelpFormatterTest.java:54)&lt;br/&gt;
at java.lang.reflect.Method.invoke(Method.java:498)&lt;br/&gt;
at java.util.ArrayList.forEach(ArrayList.java:1259)&lt;br/&gt;
at java.util.ArrayList.forEach(ArrayList.java:1259)&lt;br/&gt;
&#160;&lt;br/&gt;
&#160;&lt;br/&gt;
&lt;b&gt;Root Cause Analysis:&lt;/b&gt;&lt;br/&gt;
I&apos;ve identified the exact mechanism causing the infinite loop:&lt;br/&gt;
1. `findWrapPos(text, 0, 0)` returns 0 for non-empty text (confirmed by my test)&lt;br/&gt;
2. In `appendWrappedText()` at line 504: `pos = findWrapPos(render, width, 0);`&lt;br/&gt;
3. When pos=0, line 526: `appendable.append(rtrim(render.substring(0, pos)))` appends empty string&lt;br/&gt;
4. Line 509 adds a newline&lt;br/&gt;
5. Lines 510-512: The protective code sets `nextLineTabStopPos = 1` when `nextLineTabStopPos &amp;gt;= width`&lt;br/&gt;
6. However, line 517: `render = padding + render.substring(pos).trim();`&#160;&lt;br/&gt;
&#160; &#160;- Since pos=0, `render.substring(0)` returns the entire string&lt;br/&gt;
&#160; &#160;- The text is never consumed, so the loop continues infinitely&lt;br/&gt;
&#160;&lt;br/&gt;
The protective code (lines 510-513) doesn&apos;t help because:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;It&#160;only adjusts `nextLineTabStopPos`&#160;&lt;/li&gt;
	&lt;li&gt;It doesn&apos;t address that `pos` remains 0, causing text to never be consumed&lt;/li&gt;
	&lt;li&gt;Each iteration adds a newline and creates new String objects, eventually causing heap exhaustion&lt;br/&gt;
&#160;&lt;br/&gt;
&#160;&lt;br/&gt;
&#160;&lt;br/&gt;
&lt;b&gt;Current Code (HelpFormatter.java, lines 501-528):&lt;/b&gt;&lt;br/&gt;
&amp;lt;A extends Appendable&amp;gt; A appendWrappedText(final A appendable, final int width, final int nextLineTabStop, final String text) throws IOException {&lt;br/&gt;
&#160; &#160; &#160; &#160; String render = text;&lt;br/&gt;
&#160; &#160; &#160; &#160; int nextLineTabStopPos = nextLineTabStop;&lt;br/&gt;
&#160; &#160; &#160; &#160; int pos = findWrapPos(render, width, 0);&lt;br/&gt;
&#160; &#160; &#160; &#160; if (pos == -1) 
{
&#160; &#160; &#160; &#160; &#160; &#160; appendable.append(rtrim(render));
&#160; &#160; &#160; &#160; &#160; &#160; return appendable;
&#160; &#160; &#160; &#160; }
&lt;p&gt;&#160; &#160; &#160; &#160; appendable.append(rtrim(render.substring(0, pos))).append(getNewLine());&lt;br/&gt;
&#160; &#160; &#160; &#160; if (nextLineTabStopPos &amp;gt;= width) &lt;/p&gt;
{
&#160; &#160; &#160; &#160; &#160; &#160; // stops infinite loop happening
&#160; &#160; &#160; &#160; &#160; &#160; nextLineTabStopPos = 1;
&#160; &#160; &#160; &#160; }
&lt;p&gt;&#160; &#160; &#160; &#160; // all following lines must be padded with nextLineTabStop space characters&lt;br/&gt;
&#160; &#160; &#160; &#160; final String padding = createPadding(nextLineTabStopPos);&lt;br/&gt;
&#160; &#160; &#160; &#160; while (true) &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {&#160; &#160; &#160; &#160; &#160; &#160; render = padding + render.substring(pos).trim();&#160; &#160; &#160; &#160; &#160; &#160; pos = findWrapPos(render, width, 0);&#160; &#160; &#160; &#160; &#160; &#160; if (pos == -1) {
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; appendable.append(render);
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; return appendable;
&#160; &#160; &#160; &#160; &#160; &#160; }&#160; &#160; &#160; &#160; &#160; &#160; if (render.length() &amp;gt; width &amp;amp;&amp;amp; pos == nextLineTabStopPos - 1) {
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; pos = width;
&#160; &#160; &#160; &#160; &#160; &#160; }&#160; &#160; &#160; &#160; &#160; &#160; appendable.append(rtrim(render.substring(0, pos))).append(getNewLine());&#160; &#160; &#160; &#160; }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;&#160; &#160; }&lt;br/&gt;
&#160;&lt;br/&gt;
&#160;&lt;br/&gt;
&lt;b&gt;Why the Existing Protection Fails:&lt;/b&gt;&lt;br/&gt;
The comment &quot;stops infinite loop happening&quot; suggests awareness of this issue, but the fix only addresses `nextLineTabStopPos`, not the core problem that `findWrapPos` returns 0 when width=0, preventing text consumption.&lt;br/&gt;
&#160;&lt;br/&gt;
&#160;&lt;br/&gt;
&lt;b&gt;Proposed Solutions:&lt;/b&gt;&lt;br/&gt;
1. Add width validation (recommended):&lt;br/&gt;
&amp;lt;A extends Appendable&amp;gt; A appendWrappedText(final A appendable, final int width,&#160;&lt;br/&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;final int nextLineTabStop, final String text) throws IOException {&lt;br/&gt;
&#160; &#160; if (width &amp;lt;= 0) &lt;/p&gt;
{
&#160; &#160; &#160; &#160; throw new IllegalArgumentException(&quot;Width must be positive, was: &quot; + width);
&#160; &#160; }
&lt;p&gt;&#160; &#160; // existing code...&lt;br/&gt;
}&lt;br/&gt;
&#160;&lt;br/&gt;
2. Handle width=0 as special case:&lt;br/&gt;
if (width &amp;lt;= 0) &lt;/p&gt;
{
&#160; &#160; appendable.append(text);
&#160; &#160; return appendable;
}
&lt;p&gt;&#160;&lt;br/&gt;
3. Ensure minimum effective width:&lt;br/&gt;
int effectiveWidth = Math.max(width, 1);&lt;br/&gt;
int pos = findWrapPos(render, effectiveWidth, 0);&lt;br/&gt;
&#160;&lt;br/&gt;
&lt;b&gt;Impact:&lt;/b&gt;&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;Any application passing width=0 to HelpFormatter will experience heap exhaustion&lt;/li&gt;
	&lt;li&gt;Current protective code is insufficient for the width=0 edge case&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="13621469">CLI-341</key>
            <summary>HelpFormatter infinite loop with 0 width input </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ggregory">Gary D. Gregory</assignee>
                                    <reporter username="rickydong">Ruiqi Dong</reporter>
                        <labels>
                    </labels>
                <created>Sat, 21 Jun 2025 12:49:43 +0000</created>
                <updated>Wed, 25 Jun 2025 10:27:45 +0000</updated>
                            <resolved>Wed, 25 Jun 2025 10:27:45 +0000</resolved>
                                    <version>1.10.0</version>
                                    <fixVersion>1.10.0</fixVersion>
                                    <component>Help formatter</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="1800">0.5h</timeoriginalestimate>
                            <timeestimate seconds="1800">0.5h</timeestimate>
                                        <comments>
                            <comment id="17985125" author="garydgregory" created="Sat, 21 Jun 2025 20:35:50 +0000"  >&lt;p&gt;Hello &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rickydong&quot; class=&quot;user-hover&quot; rel=&quot;rickydong&quot;&gt;rickydong&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;Thank you for your report.&lt;/p&gt;

&lt;p&gt;This is now fixed in git master and snapshot builds in &lt;a href=&quot;https://repository.apache.org/content/repositories/snapshots/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://repository.apache.org/content/repositories/snapshots/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;A width of &amp;lt;= 0 is now effectively a no-op.&lt;/p&gt;

&lt;p&gt;Please verify and close if appropriate for your use case.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17985266" author="JIRAUSER310071" created="Mon, 23 Jun 2025 08:48:06 +0000"  >&lt;p&gt;Thanks for your update.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13077130" name="HelpFormatter.java" size="41250" author="rickydong" created="Sat, 21 Jun 2025 12:49:24 +0000"/>
                            <attachment id="13077129" name="HelpFormatterTest.java" size="2717" author="rickydong" created="Sat, 21 Jun 2025 12:49:39 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            19 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1wfdk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>