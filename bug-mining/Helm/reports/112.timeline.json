[{"url":"https://api.github.com/repos/helm/helm/issues/comments/1424539028","html_url":"https://github.com/helm/helm/issues/11805#issuecomment-1424539028","issue_url":"https://api.github.com/repos/helm/helm/issues/11805","id":1424539028,"node_id":"IC_kwDOApspmc5U6L2U","user":{"login":"Segflow","id":2049730,"node_id":"MDQ6VXNlcjIwNDk3MzA=","avatar_url":"https://avatars.githubusercontent.com/u/2049730?v=4","gravatar_id":"","url":"https://api.github.com/users/Segflow","html_url":"https://github.com/Segflow","followers_url":"https://api.github.com/users/Segflow/followers","following_url":"https://api.github.com/users/Segflow/following{/other_user}","gists_url":"https://api.github.com/users/Segflow/gists{/gist_id}","starred_url":"https://api.github.com/users/Segflow/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Segflow/subscriptions","organizations_url":"https://api.github.com/users/Segflow/orgs","repos_url":"https://api.github.com/users/Segflow/repos","events_url":"https://api.github.com/users/Segflow/events{/privacy}","received_events_url":"https://api.github.com/users/Segflow/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-02-09T17:15:39Z","updated_at":"2023-02-09T17:15:39Z","body":"According to this code:\r\n```\r\n\r\n// Run executes the installation with Context\r\nfunc (i *Install) RunWithContext(ctx context.Context, chrt *chart.Chart, vals map[string]interface{}) (*release.Release, error) {\r\n        ...\r\n        rChan := make(chan resultMessage)\r\n\tdoneChan := make(chan struct{})\r\n\tdefer close(doneChan)\r\n\tgo i.performInstall(rChan, rel, toBeAdopted, resources)\r\n\tgo i.handleContext(ctx, rChan, doneChan, rel)\r\n\tresult := <-rChan\r\n\t//start preformInstall go routine\r\n\treturn result.r, result.e\r\n}\r\n``` \r\n\r\nWe read from `rChan` only once. But both `performInstall` and `handleContext` do call `reportToRun` (more then once) which tries to send to rChan.\r\n\r\nSo basically rChan is getting consumed only once why we send to it more then once. ","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/helm/helm/issues/comments/1424539028/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"Segflow","id":2049730,"node_id":"MDQ6VXNlcjIwNDk3MzA=","avatar_url":"https://avatars.githubusercontent.com/u/2049730?v=4","gravatar_id":"","url":"https://api.github.com/users/Segflow","html_url":"https://github.com/Segflow","followers_url":"https://api.github.com/users/Segflow/followers","following_url":"https://api.github.com/users/Segflow/following{/other_user}","gists_url":"https://api.github.com/users/Segflow/gists{/gist_id}","starred_url":"https://api.github.com/users/Segflow/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Segflow/subscriptions","organizations_url":"https://api.github.com/users/Segflow/orgs","repos_url":"https://api.github.com/users/Segflow/repos","events_url":"https://api.github.com/users/Segflow/events{/privacy}","received_events_url":"https://api.github.com/users/Segflow/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":8485307514,"node_id":"LE_lADOApspmc5eEnMdzwAAAAH5w4R6","url":"https://api.github.com/repos/helm/helm/issues/events/8485307514","actor":{"login":"joejulian","id":952828,"node_id":"MDQ6VXNlcjk1MjgyOA==","avatar_url":"https://avatars.githubusercontent.com/u/952828?v=4","gravatar_id":"","url":"https://api.github.com/users/joejulian","html_url":"https://github.com/joejulian","followers_url":"https://api.github.com/users/joejulian/followers","following_url":"https://api.github.com/users/joejulian/following{/other_user}","gists_url":"https://api.github.com/users/joejulian/gists{/gist_id}","starred_url":"https://api.github.com/users/joejulian/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/joejulian/subscriptions","organizations_url":"https://api.github.com/users/joejulian/orgs","repos_url":"https://api.github.com/users/joejulian/repos","events_url":"https://api.github.com/users/joejulian/events{/privacy}","received_events_url":"https://api.github.com/users/joejulian/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2023-02-10T01:42:55Z","label":{"name":"bug","color":"e11d21"},"performed_via_github_app":null},{"id":8485308241,"node_id":"LE_lADOApspmc5eEnMdzwAAAAH5w4dR","url":"https://api.github.com/repos/helm/helm/issues/events/8485308241","actor":{"login":"joejulian","id":952828,"node_id":"MDQ6VXNlcjk1MjgyOA==","avatar_url":"https://avatars.githubusercontent.com/u/952828?v=4","gravatar_id":"","url":"https://api.github.com/users/joejulian","html_url":"https://github.com/joejulian","followers_url":"https://api.github.com/users/joejulian/followers","following_url":"https://api.github.com/users/joejulian/following{/other_user}","gists_url":"https://api.github.com/users/joejulian/gists{/gist_id}","starred_url":"https://api.github.com/users/joejulian/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/joejulian/subscriptions","organizations_url":"https://api.github.com/users/joejulian/orgs","repos_url":"https://api.github.com/users/joejulian/repos","events_url":"https://api.github.com/users/joejulian/events{/privacy}","received_events_url":"https://api.github.com/users/joejulian/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2023-02-10T01:43:08Z","label":{"name":"help wanted","color":"006b75"},"performed_via_github_app":null},{"url":"https://api.github.com/repos/helm/helm/issues/comments/1425062633","html_url":"https://github.com/helm/helm/issues/11805#issuecomment-1425062633","issue_url":"https://api.github.com/repos/helm/helm/issues/11805","id":1425062633,"node_id":"IC_kwDOApspmc5U8Lrp","user":{"login":"joejulian","id":952828,"node_id":"MDQ6VXNlcjk1MjgyOA==","avatar_url":"https://avatars.githubusercontent.com/u/952828?v=4","gravatar_id":"","url":"https://api.github.com/users/joejulian","html_url":"https://github.com/joejulian","followers_url":"https://api.github.com/users/joejulian/followers","following_url":"https://api.github.com/users/joejulian/following{/other_user}","gists_url":"https://api.github.com/users/joejulian/gists{/gist_id}","starred_url":"https://api.github.com/users/joejulian/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/joejulian/subscriptions","organizations_url":"https://api.github.com/users/joejulian/orgs","repos_url":"https://api.github.com/users/joejulian/repos","events_url":"https://api.github.com/users/joejulian/events{/privacy}","received_events_url":"https://api.github.com/users/joejulian/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-02-10T01:43:59Z","updated_at":"2023-02-10T01:43:59Z","body":"Have you checked to see if that's still in main?","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/helm/helm/issues/comments/1425062633/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"joejulian","id":952828,"node_id":"MDQ6VXNlcjk1MjgyOA==","avatar_url":"https://avatars.githubusercontent.com/u/952828?v=4","gravatar_id":"","url":"https://api.github.com/users/joejulian","html_url":"https://github.com/joejulian","followers_url":"https://api.github.com/users/joejulian/followers","following_url":"https://api.github.com/users/joejulian/following{/other_user}","gists_url":"https://api.github.com/users/joejulian/gists{/gist_id}","starred_url":"https://api.github.com/users/joejulian/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/joejulian/subscriptions","organizations_url":"https://api.github.com/users/joejulian/orgs","repos_url":"https://api.github.com/users/joejulian/repos","events_url":"https://api.github.com/users/joejulian/events{/privacy}","received_events_url":"https://api.github.com/users/joejulian/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/helm/helm/issues/comments/1425772755","html_url":"https://github.com/helm/helm/issues/11805#issuecomment-1425772755","issue_url":"https://api.github.com/repos/helm/helm/issues/11805","id":1425772755,"node_id":"IC_kwDOApspmc5U-5DT","user":{"login":"Segflow","id":2049730,"node_id":"MDQ6VXNlcjIwNDk3MzA=","avatar_url":"https://avatars.githubusercontent.com/u/2049730?v=4","gravatar_id":"","url":"https://api.github.com/users/Segflow","html_url":"https://github.com/Segflow","followers_url":"https://api.github.com/users/Segflow/followers","following_url":"https://api.github.com/users/Segflow/following{/other_user}","gists_url":"https://api.github.com/users/Segflow/gists{/gist_id}","starred_url":"https://api.github.com/users/Segflow/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Segflow/subscriptions","organizations_url":"https://api.github.com/users/Segflow/orgs","repos_url":"https://api.github.com/users/Segflow/repos","events_url":"https://api.github.com/users/Segflow/events{/privacy}","received_events_url":"https://api.github.com/users/Segflow/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-02-10T12:56:42Z","updated_at":"2023-02-10T12:56:42Z","body":"Yes, it's the same code in `main` ","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/helm/helm/issues/comments/1425772755/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":1,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"Segflow","id":2049730,"node_id":"MDQ6VXNlcjIwNDk3MzA=","avatar_url":"https://avatars.githubusercontent.com/u/2049730?v=4","gravatar_id":"","url":"https://api.github.com/users/Segflow","html_url":"https://github.com/Segflow","followers_url":"https://api.github.com/users/Segflow/followers","following_url":"https://api.github.com/users/Segflow/following{/other_user}","gists_url":"https://api.github.com/users/Segflow/gists{/gist_id}","starred_url":"https://api.github.com/users/Segflow/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Segflow/subscriptions","organizations_url":"https://api.github.com/users/Segflow/orgs","repos_url":"https://api.github.com/users/Segflow/repos","events_url":"https://api.github.com/users/Segflow/events{/privacy}","received_events_url":"https://api.github.com/users/Segflow/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/helm/helm/issues/comments/1426584963","html_url":"https://github.com/helm/helm/issues/11805#issuecomment-1426584963","issue_url":"https://api.github.com/repos/helm/helm/issues/11805","id":1426584963,"node_id":"IC_kwDOApspmc5VB_WD","user":{"login":"zhanghaohao","id":8748244,"node_id":"MDQ6VXNlcjg3NDgyNDQ=","avatar_url":"https://avatars.githubusercontent.com/u/8748244?v=4","gravatar_id":"","url":"https://api.github.com/users/zhanghaohao","html_url":"https://github.com/zhanghaohao","followers_url":"https://api.github.com/users/zhanghaohao/followers","following_url":"https://api.github.com/users/zhanghaohao/following{/other_user}","gists_url":"https://api.github.com/users/zhanghaohao/gists{/gist_id}","starred_url":"https://api.github.com/users/zhanghaohao/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zhanghaohao/subscriptions","organizations_url":"https://api.github.com/users/zhanghaohao/orgs","repos_url":"https://api.github.com/users/zhanghaohao/repos","events_url":"https://api.github.com/users/zhanghaohao/events{/privacy}","received_events_url":"https://api.github.com/users/zhanghaohao/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-02-11T02:54:48Z","updated_at":"2023-02-11T02:54:48Z","body":"I have seen the same problem in my program.\r\nMy program build helm client and call (*Upgrade)RunWithContext to perform upgrade/install.\r\nAfter the program runs for a period, it ends up with OOM.\r\nso i used pprof to parse the memory allocation and goroutine, i noticed memory leak and goroutine leak.\r\nmemory allocation flame graph as follow:\r\n![截屏2023-02-11 10 44 48](https://user-images.githubusercontent.com/8748244/218235168-7550487c-978b-4236-b9e5-6dc7f218d2ce.jpg)\r\ngoroutine flame graph as follow :\r\n![截屏2023-02-11 10 50 13](https://user-images.githubusercontent.com/8748244/218235250-5604391a-a816-437d-8eb9-dbad140ca13b.jpg)\r\n\r\nWhen we run helm client command to call (*Upgrade)RunWithContext, it is fine, because the main func exits after upgrade/install finished. but if we develop program by call (*Upgrade)RunWithContext, the main func will not exit(until we want it exit), and the goroutine leak happens, will caused memory leak which is a bigger problem.","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/helm/helm/issues/comments/1426584963/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"zhanghaohao","id":8748244,"node_id":"MDQ6VXNlcjg3NDgyNDQ=","avatar_url":"https://avatars.githubusercontent.com/u/8748244?v=4","gravatar_id":"","url":"https://api.github.com/users/zhanghaohao","html_url":"https://github.com/zhanghaohao","followers_url":"https://api.github.com/users/zhanghaohao/followers","following_url":"https://api.github.com/users/zhanghaohao/following{/other_user}","gists_url":"https://api.github.com/users/zhanghaohao/gists{/gist_id}","starred_url":"https://api.github.com/users/zhanghaohao/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zhanghaohao/subscriptions","organizations_url":"https://api.github.com/users/zhanghaohao/orgs","repos_url":"https://api.github.com/users/zhanghaohao/repos","events_url":"https://api.github.com/users/zhanghaohao/events{/privacy}","received_events_url":"https://api.github.com/users/zhanghaohao/received_events","type":"User","user_view_type":"public","site_admin":false}},{"actor":{"login":"zhanghaohao","id":8748244,"node_id":"MDQ6VXNlcjg3NDgyNDQ=","avatar_url":"https://avatars.githubusercontent.com/u/8748244?v=4","gravatar_id":"","url":"https://api.github.com/users/zhanghaohao","html_url":"https://github.com/zhanghaohao","followers_url":"https://api.github.com/users/zhanghaohao/followers","following_url":"https://api.github.com/users/zhanghaohao/following{/other_user}","gists_url":"https://api.github.com/users/zhanghaohao/gists{/gist_id}","starred_url":"https://api.github.com/users/zhanghaohao/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zhanghaohao/subscriptions","organizations_url":"https://api.github.com/users/zhanghaohao/orgs","repos_url":"https://api.github.com/users/zhanghaohao/repos","events_url":"https://api.github.com/users/zhanghaohao/events{/privacy}","received_events_url":"https://api.github.com/users/zhanghaohao/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-02-11T03:09:21Z","updated_at":"2023-02-11T03:09:21Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/helm/helm/issues/10439","repository_url":"https://api.github.com/repos/helm/helm","labels_url":"https://api.github.com/repos/helm/helm/issues/10439/labels{/name}","comments_url":"https://api.github.com/repos/helm/helm/issues/10439/comments","events_url":"https://api.github.com/repos/helm/helm/issues/10439/events","html_url":"https://github.com/helm/helm/issues/10439","id":1072356941,"node_id":"I_kwDOApspmc4_6t5N","number":10439,"title":"Memory leak in the upgrade action","user":{"login":"jkmw","id":10705308,"node_id":"MDQ6VXNlcjEwNzA1MzA4","avatar_url":"https://avatars.githubusercontent.com/u/10705308?v=4","gravatar_id":"","url":"https://api.github.com/users/jkmw","html_url":"https://github.com/jkmw","followers_url":"https://api.github.com/users/jkmw/followers","following_url":"https://api.github.com/users/jkmw/following{/other_user}","gists_url":"https://api.github.com/users/jkmw/gists{/gist_id}","starred_url":"https://api.github.com/users/jkmw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jkmw/subscriptions","organizations_url":"https://api.github.com/users/jkmw/orgs","repos_url":"https://api.github.com/users/jkmw/repos","events_url":"https://api.github.com/users/jkmw/events{/privacy}","received_events_url":"https://api.github.com/users/jkmw/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":778135666,"node_id":"MDU6TGFiZWw3NzgxMzU2NjY=","url":"https://api.github.com/repos/helm/helm/labels/bug","name":"bug","color":"e11d21","default":true,"description":"Categorizes issue or PR as related to a bug."}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2021-12-06T16:37:05Z","updated_at":"2023-02-11T03:10:28Z","closed_at":"2021-12-07T16:48:12Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":43723161,"node_id":"MDEwOlJlcG9zaXRvcnk0MzcyMzE2MQ==","name":"helm","full_name":"helm/helm","private":false,"owner":{"login":"helm","id":15859888,"node_id":"MDEyOk9yZ2FuaXphdGlvbjE1ODU5ODg4","avatar_url":"https://avatars.githubusercontent.com/u/15859888?v=4","gravatar_id":"","url":"https://api.github.com/users/helm","html_url":"https://github.com/helm","followers_url":"https://api.github.com/users/helm/followers","following_url":"https://api.github.com/users/helm/following{/other_user}","gists_url":"https://api.github.com/users/helm/gists{/gist_id}","starred_url":"https://api.github.com/users/helm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/helm/subscriptions","organizations_url":"https://api.github.com/users/helm/orgs","repos_url":"https://api.github.com/users/helm/repos","events_url":"https://api.github.com/users/helm/events{/privacy}","received_events_url":"https://api.github.com/users/helm/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/helm/helm","description":"The Kubernetes Package Manager","fork":false,"url":"https://api.github.com/repos/helm/helm","forks_url":"https://api.github.com/repos/helm/helm/forks","keys_url":"https://api.github.com/repos/helm/helm/keys{/key_id}","collaborators_url":"https://api.github.com/repos/helm/helm/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/helm/helm/teams","hooks_url":"https://api.github.com/repos/helm/helm/hooks","issue_events_url":"https://api.github.com/repos/helm/helm/issues/events{/number}","events_url":"https://api.github.com/repos/helm/helm/events","assignees_url":"https://api.github.com/repos/helm/helm/assignees{/user}","branches_url":"https://api.github.com/repos/helm/helm/branches{/branch}","tags_url":"https://api.github.com/repos/helm/helm/tags","blobs_url":"https://api.github.com/repos/helm/helm/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/helm/helm/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/helm/helm/git/refs{/sha}","trees_url":"https://api.github.com/repos/helm/helm/git/trees{/sha}","statuses_url":"https://api.github.com/repos/helm/helm/statuses/{sha}","languages_url":"https://api.github.com/repos/helm/helm/languages","stargazers_url":"https://api.github.com/repos/helm/helm/stargazers","contributors_url":"https://api.github.com/repos/helm/helm/contributors","subscribers_url":"https://api.github.com/repos/helm/helm/subscribers","subscription_url":"https://api.github.com/repos/helm/helm/subscription","commits_url":"https://api.github.com/repos/helm/helm/commits{/sha}","git_commits_url":"https://api.github.com/repos/helm/helm/git/commits{/sha}","comments_url":"https://api.github.com/repos/helm/helm/comments{/number}","issue_comment_url":"https://api.github.com/repos/helm/helm/issues/comments{/number}","contents_url":"https://api.github.com/repos/helm/helm/contents/{+path}","compare_url":"https://api.github.com/repos/helm/helm/compare/{base}...{head}","merges_url":"https://api.github.com/repos/helm/helm/merges","archive_url":"https://api.github.com/repos/helm/helm/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/helm/helm/downloads","issues_url":"https://api.github.com/repos/helm/helm/issues{/number}","pulls_url":"https://api.github.com/repos/helm/helm/pulls{/number}","milestones_url":"https://api.github.com/repos/helm/helm/milestones{/number}","notifications_url":"https://api.github.com/repos/helm/helm/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/helm/helm/labels{/name}","releases_url":"https://api.github.com/repos/helm/helm/releases{/id}","deployments_url":"https://api.github.com/repos/helm/helm/deployments","created_at":"2015-10-06T01:07:32Z","updated_at":"2025-11-09T19:00:10Z","pushed_at":"2025-11-09T12:57:10Z","git_url":"git://github.com/helm/helm.git","ssh_url":"git@github.com:helm/helm.git","clone_url":"https://github.com/helm/helm.git","svn_url":"https://github.com/helm/helm","homepage":"https://helm.sh","size":25851,"stargazers_count":28930,"watchers_count":28930,"language":"Go","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":true,"has_pages":false,"has_discussions":false,"forks_count":7393,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":448,"license":{"key":"apache-2.0","name":"Apache License 2.0","spdx_id":"Apache-2.0","url":"https://api.github.com/licenses/apache-2.0","node_id":"MDc6TGljZW5zZTI="},"allow_forking":true,"is_template":false,"web_commit_signoff_required":true,"topics":["chart","charts","cncf","helm","kubernetes"],"visibility":"public","forks":7393,"open_issues":448,"watchers":28930,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"During the upgrade action we noticed a memory leak which only occurs when helm is used as a \"library\" and not as a cli tool.\r\n\r\nActually, there are two places:\r\n\r\n1. The [`performUpgrade`](https://github.com/helm/helm/blob/1d11fcb5d3f3bf00dbe6fe31b8412839a96b3dc4/pkg/action/upgrade.go#L260) method waits [at this point](https://github.com/helm/helm/blob/1d11fcb5d3f3bf00dbe6fe31b8412839a96b3dc4/pkg/action/upgrade.go#L326) for the `rChan`, which is either filled by the `releasingUpgrade` or `handleContext` method. If the result comes from `releasingUpgrade()`, then [`handleContext()`](https://github.com/helm/helm/blob/1d11fcb5d3f3bf00dbe6fe31b8412839a96b3dc4/pkg/action/upgrade.go#L344) will wait until the context ([`ctx`](https://github.com/helm/helm/blob/1d11fcb5d3f3bf00dbe6fe31b8412839a96b3dc4/pkg/action/upgrade.go#L347)) is cancelled, which in most cases will never happen and keeps the routine running.\r\n\r\n2. If [`ctx`](https://github.com/helm/helm/blob/1d11fcb5d3f3bf00dbe6fe31b8412839a96b3dc4/pkg/action/upgrade.go#L347) is indeed cancelled, `handleContext()` calls `reportToPerformUpgrade()` which fills the already [consumed `rChan`](https://github.com/helm/helm/blob/1d11fcb5d3f3bf00dbe6fe31b8412839a96b3dc4/pkg/action/upgrade.go#L339). However, this is never read because the only consumer (`performUpgrade()`) has already returned; The routine remains running forever.\r\n\r\n---\r\n\r\nOutput of `helm version`:\r\n```shell\r\nversion.BuildInfo{Version:\"v3.7.1\", GitCommit:\"1d11fcb5d3f3bf00dbe6fe31b8412839a96b3dc4\", GitTreeState:\"clean\", GoVersion:\"go1.16.9\"}\r\n```\r\n\r\n","reactions":{"url":"https://api.github.com/repos/helm/helm/issues/10439/reactions","total_count":5,"+1":5,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/helm/helm/issues/10439/timeline","performed_via_github_app":null,"state_reason":"completed"}},"event":"cross-referenced"},{"url":"https://api.github.com/repos/helm/helm/issues/comments/1432900915","html_url":"https://github.com/helm/helm/issues/11805#issuecomment-1432900915","issue_url":"https://api.github.com/repos/helm/helm/issues/11805","id":1432900915,"node_id":"IC_kwDOApspmc5VaFUz","user":{"login":"Segflow","id":2049730,"node_id":"MDQ6VXNlcjIwNDk3MzA=","avatar_url":"https://avatars.githubusercontent.com/u/2049730?v=4","gravatar_id":"","url":"https://api.github.com/users/Segflow","html_url":"https://github.com/Segflow","followers_url":"https://api.github.com/users/Segflow/followers","following_url":"https://api.github.com/users/Segflow/following{/other_user}","gists_url":"https://api.github.com/users/Segflow/gists{/gist_id}","starred_url":"https://api.github.com/users/Segflow/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Segflow/subscriptions","organizations_url":"https://api.github.com/users/Segflow/orgs","repos_url":"https://api.github.com/users/Segflow/repos","events_url":"https://api.github.com/users/Segflow/events{/privacy}","received_events_url":"https://api.github.com/users/Segflow/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-02-16T10:58:07Z","updated_at":"2023-02-16T10:58:07Z","body":"@joejulian is there any plan to work on this issue soon? ","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/helm/helm/issues/comments/1432900915/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"Segflow","id":2049730,"node_id":"MDQ6VXNlcjIwNDk3MzA=","avatar_url":"https://avatars.githubusercontent.com/u/2049730?v=4","gravatar_id":"","url":"https://api.github.com/users/Segflow","html_url":"https://github.com/Segflow","followers_url":"https://api.github.com/users/Segflow/followers","following_url":"https://api.github.com/users/Segflow/following{/other_user}","gists_url":"https://api.github.com/users/Segflow/gists{/gist_id}","starred_url":"https://api.github.com/users/Segflow/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Segflow/subscriptions","organizations_url":"https://api.github.com/users/Segflow/orgs","repos_url":"https://api.github.com/users/Segflow/repos","events_url":"https://api.github.com/users/Segflow/events{/privacy}","received_events_url":"https://api.github.com/users/Segflow/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":8535645394,"node_id":"MEE_lADOApspmc5eEnMdzwAAAAH8w5zS","url":"https://api.github.com/repos/helm/helm/issues/events/8535645394","actor":{"login":"joejulian","id":952828,"node_id":"MDQ6VXNlcjk1MjgyOA==","avatar_url":"https://avatars.githubusercontent.com/u/952828?v=4","gravatar_id":"","url":"https://api.github.com/users/joejulian","html_url":"https://github.com/joejulian","followers_url":"https://api.github.com/users/joejulian/followers","following_url":"https://api.github.com/users/joejulian/following{/other_user}","gists_url":"https://api.github.com/users/joejulian/gists{/gist_id}","starred_url":"https://api.github.com/users/joejulian/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/joejulian/subscriptions","organizations_url":"https://api.github.com/users/joejulian/orgs","repos_url":"https://api.github.com/users/joejulian/repos","events_url":"https://api.github.com/users/joejulian/events{/privacy}","received_events_url":"https://api.github.com/users/joejulian/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2023-02-16T10:58:08Z","performed_via_github_app":null},{"id":8535645413,"node_id":"SE_lADOApspmc5eEnMdzwAAAAH8w5zl","url":"https://api.github.com/repos/helm/helm/issues/events/8535645413","actor":{"login":"joejulian","id":952828,"node_id":"MDQ6VXNlcjk1MjgyOA==","avatar_url":"https://avatars.githubusercontent.com/u/952828?v=4","gravatar_id":"","url":"https://api.github.com/users/joejulian","html_url":"https://github.com/joejulian","followers_url":"https://api.github.com/users/joejulian/followers","following_url":"https://api.github.com/users/joejulian/following{/other_user}","gists_url":"https://api.github.com/users/joejulian/gists{/gist_id}","starred_url":"https://api.github.com/users/joejulian/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/joejulian/subscriptions","organizations_url":"https://api.github.com/users/joejulian/orgs","repos_url":"https://api.github.com/users/joejulian/repos","events_url":"https://api.github.com/users/joejulian/events{/privacy}","received_events_url":"https://api.github.com/users/joejulian/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2023-02-16T10:58:08Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/helm/helm/issues/comments/1436176251","html_url":"https://github.com/helm/helm/issues/11805#issuecomment-1436176251","issue_url":"https://api.github.com/repos/helm/helm/issues/11805","id":1436176251,"node_id":"IC_kwDOApspmc5Vmk97","user":{"login":"zhanghaohao","id":8748244,"node_id":"MDQ6VXNlcjg3NDgyNDQ=","avatar_url":"https://avatars.githubusercontent.com/u/8748244?v=4","gravatar_id":"","url":"https://api.github.com/users/zhanghaohao","html_url":"https://github.com/zhanghaohao","followers_url":"https://api.github.com/users/zhanghaohao/followers","following_url":"https://api.github.com/users/zhanghaohao/following{/other_user}","gists_url":"https://api.github.com/users/zhanghaohao/gists{/gist_id}","starred_url":"https://api.github.com/users/zhanghaohao/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zhanghaohao/subscriptions","organizations_url":"https://api.github.com/users/zhanghaohao/orgs","repos_url":"https://api.github.com/users/zhanghaohao/repos","events_url":"https://api.github.com/users/zhanghaohao/events{/privacy}","received_events_url":"https://api.github.com/users/zhanghaohao/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-02-20T01:34:30Z","updated_at":"2023-02-20T02:02:38Z","body":"this problem had been solved according to the code in tag: v3.9.4\r\n\r\n```\r\n\tgo u.releasingUpgrade(rChan, upgradedRelease, current, target, originalRelease)  \r\n\tgo u.handleContext(ctx, doneChan, ctxChan, upgradedRelease)  \r\n\tselect {  \r\n\tcase result := <-rChan:\r\n\t\treturn result.r, result.e\r\n\tcase result := <-ctxChan:\r\n\t\treturn result.r, result.e\r\n\t}\r\n```\r\n\r\nrelated issue #10439 \r\ncould close the issue now\r\n","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/helm/helm/issues/comments/1436176251/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"zhanghaohao","id":8748244,"node_id":"MDQ6VXNlcjg3NDgyNDQ=","avatar_url":"https://avatars.githubusercontent.com/u/8748244?v=4","gravatar_id":"","url":"https://api.github.com/users/zhanghaohao","html_url":"https://github.com/zhanghaohao","followers_url":"https://api.github.com/users/zhanghaohao/followers","following_url":"https://api.github.com/users/zhanghaohao/following{/other_user}","gists_url":"https://api.github.com/users/zhanghaohao/gists{/gist_id}","starred_url":"https://api.github.com/users/zhanghaohao/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zhanghaohao/subscriptions","organizations_url":"https://api.github.com/users/zhanghaohao/orgs","repos_url":"https://api.github.com/users/zhanghaohao/repos","events_url":"https://api.github.com/users/zhanghaohao/events{/privacy}","received_events_url":"https://api.github.com/users/zhanghaohao/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/helm/helm/issues/comments/1436535769","html_url":"https://github.com/helm/helm/issues/11805#issuecomment-1436535769","issue_url":"https://api.github.com/repos/helm/helm/issues/11805","id":1436535769,"node_id":"IC_kwDOApspmc5Vn8vZ","user":{"login":"Segflow","id":2049730,"node_id":"MDQ6VXNlcjIwNDk3MzA=","avatar_url":"https://avatars.githubusercontent.com/u/2049730?v=4","gravatar_id":"","url":"https://api.github.com/users/Segflow","html_url":"https://github.com/Segflow","followers_url":"https://api.github.com/users/Segflow/followers","following_url":"https://api.github.com/users/Segflow/following{/other_user}","gists_url":"https://api.github.com/users/Segflow/gists{/gist_id}","starred_url":"https://api.github.com/users/Segflow/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Segflow/subscriptions","organizations_url":"https://api.github.com/users/Segflow/orgs","repos_url":"https://api.github.com/users/Segflow/repos","events_url":"https://api.github.com/users/Segflow/events{/privacy}","received_events_url":"https://api.github.com/users/Segflow/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-02-20T08:24:34Z","updated_at":"2023-02-20T08:24:57Z","body":"No that in the upgrade release path not install release path","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/helm/helm/issues/comments/1436535769/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"Segflow","id":2049730,"node_id":"MDQ6VXNlcjIwNDk3MzA=","avatar_url":"https://avatars.githubusercontent.com/u/2049730?v=4","gravatar_id":"","url":"https://api.github.com/users/Segflow","html_url":"https://github.com/Segflow","followers_url":"https://api.github.com/users/Segflow/followers","following_url":"https://api.github.com/users/Segflow/following{/other_user}","gists_url":"https://api.github.com/users/Segflow/gists{/gist_id}","starred_url":"https://api.github.com/users/Segflow/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Segflow/subscriptions","organizations_url":"https://api.github.com/users/Segflow/orgs","repos_url":"https://api.github.com/users/Segflow/repos","events_url":"https://api.github.com/users/Segflow/events{/privacy}","received_events_url":"https://api.github.com/users/Segflow/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/helm/helm/issues/comments/1439365686","html_url":"https://github.com/helm/helm/issues/11805#issuecomment-1439365686","issue_url":"https://api.github.com/repos/helm/helm/issues/11805","id":1439365686,"node_id":"IC_kwDOApspmc5Vyvo2","user":{"login":"zhanghaohao","id":8748244,"node_id":"MDQ6VXNlcjg3NDgyNDQ=","avatar_url":"https://avatars.githubusercontent.com/u/8748244?v=4","gravatar_id":"","url":"https://api.github.com/users/zhanghaohao","html_url":"https://github.com/zhanghaohao","followers_url":"https://api.github.com/users/zhanghaohao/followers","following_url":"https://api.github.com/users/zhanghaohao/following{/other_user}","gists_url":"https://api.github.com/users/zhanghaohao/gists{/gist_id}","starred_url":"https://api.github.com/users/zhanghaohao/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zhanghaohao/subscriptions","organizations_url":"https://api.github.com/users/zhanghaohao/orgs","repos_url":"https://api.github.com/users/zhanghaohao/repos","events_url":"https://api.github.com/users/zhanghaohao/events{/privacy}","received_events_url":"https://api.github.com/users/zhanghaohao/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-02-22T02:52:54Z","updated_at":"2023-02-22T02:53:34Z","body":"@Segflow sorry, i didnot notice that you are mentioning install release path rather than upgrade release path.\r\nafter reading the install code carefully, i realized that it should not lead to goroutine leak in normal cases.\r\n```\r\n// Run executes the installation with Context\r\nfunc (i *Install) RunWithContext(ctx context.Context, chrt *chart.Chart, vals map[string]interface{}) (*release.Release, error) {\r\n        ...\r\n        rChan := make(chan resultMessage)\r\n\tdoneChan := make(chan struct{})\r\n\tdefer close(doneChan)\r\n\tgo i.performInstall(rChan, rel, toBeAdopted, resources)\r\n\tgo i.handleContext(ctx, rChan, doneChan, rel)\r\n\tresult := <-rChan\r\n\t//start preformInstall go routine\r\n\treturn result.r, result.e\r\n}\r\n```\r\naccording to the above code, in normal cases, `performInstall` should finish with result sent to `rChan`,  and `result := <-rChan` is unblocked, then close `doneChan` before return.  \r\nthe `close(doneChan)` will lead `handleContext` goroutine return. this is what we expected.\r\n```\r\nfunc (i *Install) handleContext(ctx context.Context, c chan<- resultMessage, done chan struct{}, rel *release.Release) {\r\n\tselect {\r\n\tcase <-ctx.Done():\r\n\t\terr := ctx.Err()\r\n\t\ti.reportToRun(c, rel, err)\r\n\tcase <-done:\r\n\t\treturn\r\n\t}\r\n}\r\n```\r\n\r\n@Segflow how do you think about this?\r\n","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/helm/helm/issues/comments/1439365686/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"zhanghaohao","id":8748244,"node_id":"MDQ6VXNlcjg3NDgyNDQ=","avatar_url":"https://avatars.githubusercontent.com/u/8748244?v=4","gravatar_id":"","url":"https://api.github.com/users/zhanghaohao","html_url":"https://github.com/zhanghaohao","followers_url":"https://api.github.com/users/zhanghaohao/followers","following_url":"https://api.github.com/users/zhanghaohao/following{/other_user}","gists_url":"https://api.github.com/users/zhanghaohao/gists{/gist_id}","starred_url":"https://api.github.com/users/zhanghaohao/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zhanghaohao/subscriptions","organizations_url":"https://api.github.com/users/zhanghaohao/orgs","repos_url":"https://api.github.com/users/zhanghaohao/repos","events_url":"https://api.github.com/users/zhanghaohao/events{/privacy}","received_events_url":"https://api.github.com/users/zhanghaohao/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":8576642818,"node_id":"MEE_lADOApspmc5eEnMdzwAAAAH_NS8C","url":"https://api.github.com/repos/helm/helm/issues/events/8576642818","actor":{"login":"Segflow","id":2049730,"node_id":"MDQ6VXNlcjIwNDk3MzA=","avatar_url":"https://avatars.githubusercontent.com/u/2049730?v=4","gravatar_id":"","url":"https://api.github.com/users/Segflow","html_url":"https://github.com/Segflow","followers_url":"https://api.github.com/users/Segflow/followers","following_url":"https://api.github.com/users/Segflow/following{/other_user}","gists_url":"https://api.github.com/users/Segflow/gists{/gist_id}","starred_url":"https://api.github.com/users/Segflow/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Segflow/subscriptions","organizations_url":"https://api.github.com/users/Segflow/orgs","repos_url":"https://api.github.com/users/Segflow/repos","events_url":"https://api.github.com/users/Segflow/events{/privacy}","received_events_url":"https://api.github.com/users/Segflow/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2023-02-22T02:52:55Z","performed_via_github_app":null},{"id":8576642825,"node_id":"SE_lADOApspmc5eEnMdzwAAAAH_NS8J","url":"https://api.github.com/repos/helm/helm/issues/events/8576642825","actor":{"login":"Segflow","id":2049730,"node_id":"MDQ6VXNlcjIwNDk3MzA=","avatar_url":"https://avatars.githubusercontent.com/u/2049730?v=4","gravatar_id":"","url":"https://api.github.com/users/Segflow","html_url":"https://github.com/Segflow","followers_url":"https://api.github.com/users/Segflow/followers","following_url":"https://api.github.com/users/Segflow/following{/other_user}","gists_url":"https://api.github.com/users/Segflow/gists{/gist_id}","starred_url":"https://api.github.com/users/Segflow/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Segflow/subscriptions","organizations_url":"https://api.github.com/users/Segflow/orgs","repos_url":"https://api.github.com/users/Segflow/repos","events_url":"https://api.github.com/users/Segflow/events{/privacy}","received_events_url":"https://api.github.com/users/Segflow/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2023-02-22T02:52:55Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/helm/helm/issues/comments/1449826005","html_url":"https://github.com/helm/helm/issues/11805#issuecomment-1449826005","issue_url":"https://api.github.com/repos/helm/helm/issues/11805","id":1449826005,"node_id":"IC_kwDOApspmc5WapbV","user":{"login":"Segflow","id":2049730,"node_id":"MDQ6VXNlcjIwNDk3MzA=","avatar_url":"https://avatars.githubusercontent.com/u/2049730?v=4","gravatar_id":"","url":"https://api.github.com/users/Segflow","html_url":"https://github.com/Segflow","followers_url":"https://api.github.com/users/Segflow/followers","following_url":"https://api.github.com/users/Segflow/following{/other_user}","gists_url":"https://api.github.com/users/Segflow/gists{/gist_id}","starred_url":"https://api.github.com/users/Segflow/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Segflow/subscriptions","organizations_url":"https://api.github.com/users/Segflow/orgs","repos_url":"https://api.github.com/users/Segflow/repos","events_url":"https://api.github.com/users/Segflow/events{/privacy}","received_events_url":"https://api.github.com/users/Segflow/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-03-01T10:33:50Z","updated_at":"2023-03-01T10:33:50Z","body":"The issue is `performInstall` also calls `reportToRun`, this leads to have both \r\n```\r\n\tgo i.performInstall(rChan, rel, toBeAdopted, resources)\r\n\tgo i.handleContext(ctx, rChan, doneChan, rel)\r\n```\r\n\r\nSend to the channel. We have this issue in our production","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/helm/helm/issues/comments/1449826005/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"Segflow","id":2049730,"node_id":"MDQ6VXNlcjIwNDk3MzA=","avatar_url":"https://avatars.githubusercontent.com/u/2049730?v=4","gravatar_id":"","url":"https://api.github.com/users/Segflow","html_url":"https://github.com/Segflow","followers_url":"https://api.github.com/users/Segflow/followers","following_url":"https://api.github.com/users/Segflow/following{/other_user}","gists_url":"https://api.github.com/users/Segflow/gists{/gist_id}","starred_url":"https://api.github.com/users/Segflow/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Segflow/subscriptions","organizations_url":"https://api.github.com/users/Segflow/orgs","repos_url":"https://api.github.com/users/Segflow/repos","events_url":"https://api.github.com/users/Segflow/events{/privacy}","received_events_url":"https://api.github.com/users/Segflow/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/helm/helm/issues/comments/1452917466","html_url":"https://github.com/helm/helm/issues/11805#issuecomment-1452917466","issue_url":"https://api.github.com/repos/helm/helm/issues/11805","id":1452917466,"node_id":"IC_kwDOApspmc5WmcLa","user":{"login":"zhanghaohao","id":8748244,"node_id":"MDQ6VXNlcjg3NDgyNDQ=","avatar_url":"https://avatars.githubusercontent.com/u/8748244?v=4","gravatar_id":"","url":"https://api.github.com/users/zhanghaohao","html_url":"https://github.com/zhanghaohao","followers_url":"https://api.github.com/users/zhanghaohao/followers","following_url":"https://api.github.com/users/zhanghaohao/following{/other_user}","gists_url":"https://api.github.com/users/zhanghaohao/gists{/gist_id}","starred_url":"https://api.github.com/users/zhanghaohao/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zhanghaohao/subscriptions","organizations_url":"https://api.github.com/users/zhanghaohao/orgs","repos_url":"https://api.github.com/users/zhanghaohao/repos","events_url":"https://api.github.com/users/zhanghaohao/events{/privacy}","received_events_url":"https://api.github.com/users/zhanghaohao/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-03-03T03:43:06Z","updated_at":"2023-03-03T03:44:05Z","body":"i guess the `case <-ctx.Done()` in `handleContext ` is triggered in your case, this could lead to goroutine leak due to `performInstall` and `handleContext` both are sending to `rChan`.\r\nbut goroutine leak donot happen in other cases.\r\n\r\nPlease correct me if i am wrong.","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/helm/helm/issues/comments/1452917466/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"zhanghaohao","id":8748244,"node_id":"MDQ6VXNlcjg3NDgyNDQ=","avatar_url":"https://avatars.githubusercontent.com/u/8748244?v=4","gravatar_id":"","url":"https://api.github.com/users/zhanghaohao","html_url":"https://github.com/zhanghaohao","followers_url":"https://api.github.com/users/zhanghaohao/followers","following_url":"https://api.github.com/users/zhanghaohao/following{/other_user}","gists_url":"https://api.github.com/users/zhanghaohao/gists{/gist_id}","starred_url":"https://api.github.com/users/zhanghaohao/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zhanghaohao/subscriptions","organizations_url":"https://api.github.com/users/zhanghaohao/orgs","repos_url":"https://api.github.com/users/zhanghaohao/repos","events_url":"https://api.github.com/users/zhanghaohao/events{/privacy}","received_events_url":"https://api.github.com/users/zhanghaohao/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/helm/helm/issues/comments/1453146174","html_url":"https://github.com/helm/helm/issues/11805#issuecomment-1453146174","issue_url":"https://api.github.com/repos/helm/helm/issues/11805","id":1453146174,"node_id":"IC_kwDOApspmc5WnUA-","user":{"login":"Segflow","id":2049730,"node_id":"MDQ6VXNlcjIwNDk3MzA=","avatar_url":"https://avatars.githubusercontent.com/u/2049730?v=4","gravatar_id":"","url":"https://api.github.com/users/Segflow","html_url":"https://github.com/Segflow","followers_url":"https://api.github.com/users/Segflow/followers","following_url":"https://api.github.com/users/Segflow/following{/other_user}","gists_url":"https://api.github.com/users/Segflow/gists{/gist_id}","starred_url":"https://api.github.com/users/Segflow/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Segflow/subscriptions","organizations_url":"https://api.github.com/users/Segflow/orgs","repos_url":"https://api.github.com/users/Segflow/repos","events_url":"https://api.github.com/users/Segflow/events{/privacy}","received_events_url":"https://api.github.com/users/Segflow/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-03-03T08:19:39Z","updated_at":"2023-03-03T08:19:39Z","body":"indeed","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/helm/helm/issues/comments/1453146174/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"Segflow","id":2049730,"node_id":"MDQ6VXNlcjIwNDk3MzA=","avatar_url":"https://avatars.githubusercontent.com/u/2049730?v=4","gravatar_id":"","url":"https://api.github.com/users/Segflow","html_url":"https://github.com/Segflow","followers_url":"https://api.github.com/users/Segflow/followers","following_url":"https://api.github.com/users/Segflow/following{/other_user}","gists_url":"https://api.github.com/users/Segflow/gists{/gist_id}","starred_url":"https://api.github.com/users/Segflow/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Segflow/subscriptions","organizations_url":"https://api.github.com/users/Segflow/orgs","repos_url":"https://api.github.com/users/Segflow/repos","events_url":"https://api.github.com/users/Segflow/events{/privacy}","received_events_url":"https://api.github.com/users/Segflow/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/helm/helm/issues/comments/1501682593","html_url":"https://github.com/helm/helm/issues/11805#issuecomment-1501682593","issue_url":"https://api.github.com/repos/helm/helm/issues/11805","id":1501682593,"node_id":"IC_kwDOApspmc5Zgduh","user":{"login":"Segflow","id":2049730,"node_id":"MDQ6VXNlcjIwNDk3MzA=","avatar_url":"https://avatars.githubusercontent.com/u/2049730?v=4","gravatar_id":"","url":"https://api.github.com/users/Segflow","html_url":"https://github.com/Segflow","followers_url":"https://api.github.com/users/Segflow/followers","following_url":"https://api.github.com/users/Segflow/following{/other_user}","gists_url":"https://api.github.com/users/Segflow/gists{/gist_id}","starred_url":"https://api.github.com/users/Segflow/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Segflow/subscriptions","organizations_url":"https://api.github.com/users/Segflow/orgs","repos_url":"https://api.github.com/users/Segflow/repos","events_url":"https://api.github.com/users/Segflow/events{/privacy}","received_events_url":"https://api.github.com/users/Segflow/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-04-10T11:03:21Z","updated_at":"2023-04-10T11:03:21Z","body":"Any update on this please?\r\n","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/helm/helm/issues/comments/1501682593/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"Segflow","id":2049730,"node_id":"MDQ6VXNlcjIwNDk3MzA=","avatar_url":"https://avatars.githubusercontent.com/u/2049730?v=4","gravatar_id":"","url":"https://api.github.com/users/Segflow","html_url":"https://github.com/Segflow","followers_url":"https://api.github.com/users/Segflow/followers","following_url":"https://api.github.com/users/Segflow/following{/other_user}","gists_url":"https://api.github.com/users/Segflow/gists{/gist_id}","starred_url":"https://api.github.com/users/Segflow/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Segflow/subscriptions","organizations_url":"https://api.github.com/users/Segflow/orgs","repos_url":"https://api.github.com/users/Segflow/repos","events_url":"https://api.github.com/users/Segflow/events{/privacy}","received_events_url":"https://api.github.com/users/Segflow/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":8963024102,"node_id":"UE_lADOApspmc5eEnMdzwAAAAIWPOTm","url":"https://api.github.com/repos/helm/helm/issues/events/8963024102","actor":{"login":"kkocha","id":64531971,"node_id":"MDQ6VXNlcjY0NTMxOTcx","avatar_url":"https://avatars.githubusercontent.com/u/64531971?v=4","gravatar_id":"","url":"https://api.github.com/users/kkocha","html_url":"https://github.com/kkocha","followers_url":"https://api.github.com/users/kkocha/followers","following_url":"https://api.github.com/users/kkocha/following{/other_user}","gists_url":"https://api.github.com/users/kkocha/gists{/gist_id}","starred_url":"https://api.github.com/users/kkocha/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kkocha/subscriptions","organizations_url":"https://api.github.com/users/kkocha/orgs","repos_url":"https://api.github.com/users/kkocha/repos","events_url":"https://api.github.com/users/kkocha/events{/privacy}","received_events_url":"https://api.github.com/users/kkocha/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"unsubscribed","commit_id":null,"commit_url":null,"created_at":"2023-04-10T11:19:44Z","performed_via_github_app":null},{"id":8967046821,"node_id":"REFE_lADOApspmc5eEnMdzwAAAAIWekal","url":"https://api.github.com/repos/helm/helm/issues/events/8967046821","actor":{"login":"mattfarina","id":62991,"node_id":"MDQ6VXNlcjYyOTkx","avatar_url":"https://avatars.githubusercontent.com/u/62991?v=4","gravatar_id":"","url":"https://api.github.com/users/mattfarina","html_url":"https://github.com/mattfarina","followers_url":"https://api.github.com/users/mattfarina/followers","following_url":"https://api.github.com/users/mattfarina/following{/other_user}","gists_url":"https://api.github.com/users/mattfarina/gists{/gist_id}","starred_url":"https://api.github.com/users/mattfarina/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mattfarina/subscriptions","organizations_url":"https://api.github.com/users/mattfarina/orgs","repos_url":"https://api.github.com/users/mattfarina/repos","events_url":"https://api.github.com/users/mattfarina/events{/privacy}","received_events_url":"https://api.github.com/users/mattfarina/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"7c9d636f40e751c775cd1baea5ef2fd4f7139f6e","commit_url":"https://api.github.com/repos/mattfarina/helm/commits/7c9d636f40e751c775cd1baea5ef2fd4f7139f6e","created_at":"2023-04-10T20:51:00Z","performed_via_github_app":null},{"actor":{"login":"mattfarina","id":62991,"node_id":"MDQ6VXNlcjYyOTkx","avatar_url":"https://avatars.githubusercontent.com/u/62991?v=4","gravatar_id":"","url":"https://api.github.com/users/mattfarina","html_url":"https://github.com/mattfarina","followers_url":"https://api.github.com/users/mattfarina/followers","following_url":"https://api.github.com/users/mattfarina/following{/other_user}","gists_url":"https://api.github.com/users/mattfarina/gists{/gist_id}","starred_url":"https://api.github.com/users/mattfarina/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mattfarina/subscriptions","organizations_url":"https://api.github.com/users/mattfarina/orgs","repos_url":"https://api.github.com/users/mattfarina/repos","events_url":"https://api.github.com/users/mattfarina/events{/privacy}","received_events_url":"https://api.github.com/users/mattfarina/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-04-10T20:51:27Z","updated_at":"2023-04-10T20:51:27Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/helm/helm/issues/11978","repository_url":"https://api.github.com/repos/helm/helm","labels_url":"https://api.github.com/repos/helm/helm/issues/11978/labels{/name}","comments_url":"https://api.github.com/repos/helm/helm/issues/11978/comments","events_url":"https://api.github.com/repos/helm/helm/issues/11978/events","html_url":"https://github.com/helm/helm/pull/11978","id":1661345481,"node_id":"PR_kwDOApspmc5N9skq","number":11978,"title":"Fix goroutine leak in action install","user":{"login":"mattfarina","id":62991,"node_id":"MDQ6VXNlcjYyOTkx","avatar_url":"https://avatars.githubusercontent.com/u/62991?v=4","gravatar_id":"","url":"https://api.github.com/users/mattfarina","html_url":"https://github.com/mattfarina","followers_url":"https://api.github.com/users/mattfarina/followers","following_url":"https://api.github.com/users/mattfarina/following{/other_user}","gists_url":"https://api.github.com/users/mattfarina/gists{/gist_id}","starred_url":"https://api.github.com/users/mattfarina/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mattfarina/subscriptions","organizations_url":"https://api.github.com/users/mattfarina/orgs","repos_url":"https://api.github.com/users/mattfarina/repos","events_url":"https://api.github.com/users/mattfarina/events{/privacy}","received_events_url":"https://api.github.com/users/mattfarina/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":676174034,"node_id":"MDU6TGFiZWw2NzYxNzQwMzQ=","url":"https://api.github.com/repos/helm/helm/labels/size/S","name":"size/S","color":"77bb00","default":false,"description":"Denotes a PR that changes 10-29 lines, ignoring generated files."},{"id":817666543,"node_id":"MDU6TGFiZWw4MTc2NjY1NDM=","url":"https://api.github.com/repos/helm/helm/labels/picked","name":"picked","color":"0e8a16","default":false,"description":"Indicates that a PR has been cherry-picked into the next release candidate."}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/helm/helm/milestones/129","html_url":"https://github.com/helm/helm/milestone/129","labels_url":"https://api.github.com/repos/helm/helm/milestones/129/labels","id":9136344,"node_id":"MI_kwDOApspmc4Ai2jY","number":129,"title":"3.11.3","description":"","creator":{"login":"mattfarina","id":62991,"node_id":"MDQ6VXNlcjYyOTkx","avatar_url":"https://avatars.githubusercontent.com/u/62991?v=4","gravatar_id":"","url":"https://api.github.com/users/mattfarina","html_url":"https://github.com/mattfarina","followers_url":"https://api.github.com/users/mattfarina/followers","following_url":"https://api.github.com/users/mattfarina/following{/other_user}","gists_url":"https://api.github.com/users/mattfarina/gists{/gist_id}","starred_url":"https://api.github.com/users/mattfarina/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mattfarina/subscriptions","organizations_url":"https://api.github.com/users/mattfarina/orgs","repos_url":"https://api.github.com/users/mattfarina/repos","events_url":"https://api.github.com/users/mattfarina/events{/privacy}","received_events_url":"https://api.github.com/users/mattfarina/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":8,"state":"closed","created_at":"2023-03-08T20:57:31Z","updated_at":"2023-04-12T18:56:20Z","due_on":"2023-04-12T07:00:00Z","closed_at":"2023-04-12T18:56:20Z"},"comments":1,"created_at":"2023-04-10T20:51:26Z","updated_at":"2023-04-11T16:19:39Z","closed_at":"2023-04-11T15:20:36Z","author_association":"COLLABORATOR","type":null,"active_lock_reason":null,"draft":false,"repository":{"id":43723161,"node_id":"MDEwOlJlcG9zaXRvcnk0MzcyMzE2MQ==","name":"helm","full_name":"helm/helm","private":false,"owner":{"login":"helm","id":15859888,"node_id":"MDEyOk9yZ2FuaXphdGlvbjE1ODU5ODg4","avatar_url":"https://avatars.githubusercontent.com/u/15859888?v=4","gravatar_id":"","url":"https://api.github.com/users/helm","html_url":"https://github.com/helm","followers_url":"https://api.github.com/users/helm/followers","following_url":"https://api.github.com/users/helm/following{/other_user}","gists_url":"https://api.github.com/users/helm/gists{/gist_id}","starred_url":"https://api.github.com/users/helm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/helm/subscriptions","organizations_url":"https://api.github.com/users/helm/orgs","repos_url":"https://api.github.com/users/helm/repos","events_url":"https://api.github.com/users/helm/events{/privacy}","received_events_url":"https://api.github.com/users/helm/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/helm/helm","description":"The Kubernetes Package Manager","fork":false,"url":"https://api.github.com/repos/helm/helm","forks_url":"https://api.github.com/repos/helm/helm/forks","keys_url":"https://api.github.com/repos/helm/helm/keys{/key_id}","collaborators_url":"https://api.github.com/repos/helm/helm/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/helm/helm/teams","hooks_url":"https://api.github.com/repos/helm/helm/hooks","issue_events_url":"https://api.github.com/repos/helm/helm/issues/events{/number}","events_url":"https://api.github.com/repos/helm/helm/events","assignees_url":"https://api.github.com/repos/helm/helm/assignees{/user}","branches_url":"https://api.github.com/repos/helm/helm/branches{/branch}","tags_url":"https://api.github.com/repos/helm/helm/tags","blobs_url":"https://api.github.com/repos/helm/helm/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/helm/helm/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/helm/helm/git/refs{/sha}","trees_url":"https://api.github.com/repos/helm/helm/git/trees{/sha}","statuses_url":"https://api.github.com/repos/helm/helm/statuses/{sha}","languages_url":"https://api.github.com/repos/helm/helm/languages","stargazers_url":"https://api.github.com/repos/helm/helm/stargazers","contributors_url":"https://api.github.com/repos/helm/helm/contributors","subscribers_url":"https://api.github.com/repos/helm/helm/subscribers","subscription_url":"https://api.github.com/repos/helm/helm/subscription","commits_url":"https://api.github.com/repos/helm/helm/commits{/sha}","git_commits_url":"https://api.github.com/repos/helm/helm/git/commits{/sha}","comments_url":"https://api.github.com/repos/helm/helm/comments{/number}","issue_comment_url":"https://api.github.com/repos/helm/helm/issues/comments{/number}","contents_url":"https://api.github.com/repos/helm/helm/contents/{+path}","compare_url":"https://api.github.com/repos/helm/helm/compare/{base}...{head}","merges_url":"https://api.github.com/repos/helm/helm/merges","archive_url":"https://api.github.com/repos/helm/helm/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/helm/helm/downloads","issues_url":"https://api.github.com/repos/helm/helm/issues{/number}","pulls_url":"https://api.github.com/repos/helm/helm/pulls{/number}","milestones_url":"https://api.github.com/repos/helm/helm/milestones{/number}","notifications_url":"https://api.github.com/repos/helm/helm/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/helm/helm/labels{/name}","releases_url":"https://api.github.com/repos/helm/helm/releases{/id}","deployments_url":"https://api.github.com/repos/helm/helm/deployments","created_at":"2015-10-06T01:07:32Z","updated_at":"2025-11-09T19:00:10Z","pushed_at":"2025-11-09T12:57:10Z","git_url":"git://github.com/helm/helm.git","ssh_url":"git@github.com:helm/helm.git","clone_url":"https://github.com/helm/helm.git","svn_url":"https://github.com/helm/helm","homepage":"https://helm.sh","size":25851,"stargazers_count":28930,"watchers_count":28930,"language":"Go","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":true,"has_pages":false,"has_discussions":false,"forks_count":7393,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":448,"license":{"key":"apache-2.0","name":"Apache License 2.0","spdx_id":"Apache-2.0","url":"https://api.github.com/licenses/apache-2.0","node_id":"MDc6TGljZW5zZTI="},"allow_forking":true,"is_template":false,"web_commit_signoff_required":true,"topics":["chart","charts","cncf","helm","kubernetes"],"visibility":"public","forks":7393,"open_issues":448,"watchers":28930,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"pull_request":{"url":"https://api.github.com/repos/helm/helm/pulls/11978","html_url":"https://github.com/helm/helm/pull/11978","diff_url":"https://github.com/helm/helm/pull/11978.diff","patch_url":"https://github.com/helm/helm/pull/11978.patch","merged_at":"2023-04-11T15:20:36Z"},"body":"During the install process there was a place where an install process could be stuck trying to write to a channel. This would happen when a context had completed prior to performInstall finishing. In a short running Helm Client this was not a problem. But, for long running applications that use Helm as an SDK there are problems where a memory leak ends up happening due to goroutines never being able to complete.\r\n\r\nThis fix provides a means for performInstall to write to its channel using the method already used to fix the upgrade issue of the same kind.\r\n\r\n<!--  Thanks for sending a pull request!  Here are some tips for you:\r\n1. Make sure to read the Contributing Guide before submitting your PR: https://github.com/helm/helm/blob/main/CONTRIBUTING.md\r\n2. If this PR closes another issue, add 'closes #<issue number>' somewhere in the PR summary. GitHub will automatically close that issue when this PR gets merged. Alternatively, adding 'refs #<issue number>' will not close the issue, but help provide the reviewer more context.-->\r\n\r\n**What this PR does / why we need it**: Fixes a memory leak described in #11805\r\n\r\n**Special notes for your reviewer**:\r\n\r\n**If applicable**:\r\n- [ ] this PR contains documentation\r\n- [ ] this PR contains unit tests\r\n- [ ] this PR has been tested for backwards compatibility\r\n","reactions":{"url":"https://api.github.com/repos/helm/helm/issues/11978/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/helm/helm/issues/11978/timeline","performed_via_github_app":null,"state_reason":null}},"event":"cross-referenced"},{"url":"https://api.github.com/repos/helm/helm/issues/comments/1502306810","html_url":"https://github.com/helm/helm/issues/11805#issuecomment-1502306810","issue_url":"https://api.github.com/repos/helm/helm/issues/11805","id":1502306810,"node_id":"IC_kwDOApspmc5Zi2H6","user":{"login":"mattfarina","id":62991,"node_id":"MDQ6VXNlcjYyOTkx","avatar_url":"https://avatars.githubusercontent.com/u/62991?v=4","gravatar_id":"","url":"https://api.github.com/users/mattfarina","html_url":"https://github.com/mattfarina","followers_url":"https://api.github.com/users/mattfarina/followers","following_url":"https://api.github.com/users/mattfarina/following{/other_user}","gists_url":"https://api.github.com/users/mattfarina/gists{/gist_id}","starred_url":"https://api.github.com/users/mattfarina/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mattfarina/subscriptions","organizations_url":"https://api.github.com/users/mattfarina/orgs","repos_url":"https://api.github.com/users/mattfarina/repos","events_url":"https://api.github.com/users/mattfarina/events{/privacy}","received_events_url":"https://api.github.com/users/mattfarina/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-04-10T20:52:34Z","updated_at":"2023-04-10T20:52:34Z","body":"There's a PR to address this at https://github.com/helm/helm/pull/11978","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/helm/helm/issues/comments/1502306810/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"mattfarina","id":62991,"node_id":"MDQ6VXNlcjYyOTkx","avatar_url":"https://avatars.githubusercontent.com/u/62991?v=4","gravatar_id":"","url":"https://api.github.com/users/mattfarina","html_url":"https://github.com/mattfarina","followers_url":"https://api.github.com/users/mattfarina/followers","following_url":"https://api.github.com/users/mattfarina/following{/other_user}","gists_url":"https://api.github.com/users/mattfarina/gists{/gist_id}","starred_url":"https://api.github.com/users/mattfarina/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mattfarina/subscriptions","organizations_url":"https://api.github.com/users/mattfarina/orgs","repos_url":"https://api.github.com/users/mattfarina/repos","events_url":"https://api.github.com/users/mattfarina/events{/privacy}","received_events_url":"https://api.github.com/users/mattfarina/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":8975286768,"node_id":"CE_lADOApspmc5eEnMdzwAAAAIW-AHw","url":"https://api.github.com/repos/helm/helm/issues/events/8975286768","actor":{"login":"mattfarina","id":62991,"node_id":"MDQ6VXNlcjYyOTkx","avatar_url":"https://avatars.githubusercontent.com/u/62991?v=4","gravatar_id":"","url":"https://api.github.com/users/mattfarina","html_url":"https://github.com/mattfarina","followers_url":"https://api.github.com/users/mattfarina/followers","following_url":"https://api.github.com/users/mattfarina/following{/other_user}","gists_url":"https://api.github.com/users/mattfarina/gists{/gist_id}","starred_url":"https://api.github.com/users/mattfarina/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mattfarina/subscriptions","organizations_url":"https://api.github.com/users/mattfarina/orgs","repos_url":"https://api.github.com/users/mattfarina/repos","events_url":"https://api.github.com/users/mattfarina/events{/privacy}","received_events_url":"https://api.github.com/users/mattfarina/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"closed","commit_id":"7c9d636f40e751c775cd1baea5ef2fd4f7139f6e","commit_url":"https://api.github.com/repos/helm/helm/commits/7c9d636f40e751c775cd1baea5ef2fd4f7139f6e","created_at":"2023-04-11T15:20:48Z","state_reason":null,"performed_via_github_app":null},{"id":8975959803,"node_id":"REFE_lADOApspmc5eEnMdzwAAAAIXAkb7","url":"https://api.github.com/repos/helm/helm/issues/events/8975959803","actor":{"login":"mattfarina","id":62991,"node_id":"MDQ6VXNlcjYyOTkx","avatar_url":"https://avatars.githubusercontent.com/u/62991?v=4","gravatar_id":"","url":"https://api.github.com/users/mattfarina","html_url":"https://github.com/mattfarina","followers_url":"https://api.github.com/users/mattfarina/followers","following_url":"https://api.github.com/users/mattfarina/following{/other_user}","gists_url":"https://api.github.com/users/mattfarina/gists{/gist_id}","starred_url":"https://api.github.com/users/mattfarina/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mattfarina/subscriptions","organizations_url":"https://api.github.com/users/mattfarina/orgs","repos_url":"https://api.github.com/users/mattfarina/repos","events_url":"https://api.github.com/users/mattfarina/events{/privacy}","received_events_url":"https://api.github.com/users/mattfarina/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"4a3a2683536b4d46639dc7460846e44f426e5e01","commit_url":"https://api.github.com/repos/helm/helm/commits/4a3a2683536b4d46639dc7460846e44f426e5e01","created_at":"2023-04-11T16:20:24Z","performed_via_github_app":null},{"actor":{"login":"anr-tonic","id":107938807,"node_id":"U_kgDOBm8D9w","avatar_url":"https://avatars.githubusercontent.com/u/107938807?v=4","gravatar_id":"","url":"https://api.github.com/users/anr-tonic","html_url":"https://github.com/anr-tonic","followers_url":"https://api.github.com/users/anr-tonic/followers","following_url":"https://api.github.com/users/anr-tonic/following{/other_user}","gists_url":"https://api.github.com/users/anr-tonic/gists{/gist_id}","starred_url":"https://api.github.com/users/anr-tonic/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/anr-tonic/subscriptions","organizations_url":"https://api.github.com/users/anr-tonic/orgs","repos_url":"https://api.github.com/users/anr-tonic/repos","events_url":"https://api.github.com/users/anr-tonic/events{/privacy}","received_events_url":"https://api.github.com/users/anr-tonic/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-05-18T14:30:59Z","updated_at":"2023-05-18T14:30:59Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/helm/helm/issues/12086","repository_url":"https://api.github.com/repos/helm/helm","labels_url":"https://api.github.com/repos/helm/helm/issues/12086/labels{/name}","comments_url":"https://api.github.com/repos/helm/helm/issues/12086/comments","events_url":"https://api.github.com/repos/helm/helm/issues/12086/events","html_url":"https://github.com/helm/helm/issues/12086","id":1715745767,"node_id":"I_kwDOApspmc5mRDPn","number":12086,"title":"performInstall go routine continues running after context is cancelled","user":{"login":"anr-tonic","id":107938807,"node_id":"U_kgDOBm8D9w","avatar_url":"https://avatars.githubusercontent.com/u/107938807?v=4","gravatar_id":"","url":"https://api.github.com/users/anr-tonic","html_url":"https://github.com/anr-tonic","followers_url":"https://api.github.com/users/anr-tonic/followers","following_url":"https://api.github.com/users/anr-tonic/following{/other_user}","gists_url":"https://api.github.com/users/anr-tonic/gists{/gist_id}","starred_url":"https://api.github.com/users/anr-tonic/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/anr-tonic/subscriptions","organizations_url":"https://api.github.com/users/anr-tonic/orgs","repos_url":"https://api.github.com/users/anr-tonic/repos","events_url":"https://api.github.com/users/anr-tonic/events{/privacy}","received_events_url":"https://api.github.com/users/anr-tonic/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":562692416,"node_id":"MDU6TGFiZWw1NjI2OTI0MTY=","url":"https://api.github.com/repos/helm/helm/labels/in%20progress","name":"in progress","color":"11DD11","default":false,"description":null},{"id":778135666,"node_id":"MDU6TGFiZWw3NzgxMzU2NjY=","url":"https://api.github.com/repos/helm/helm/labels/bug","name":"bug","color":"e11d21","default":true,"description":"Categorizes issue or PR as related to a bug."}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2023-05-18T14:30:59Z","updated_at":"2023-08-25T03:30:42Z","closed_at":null,"author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":43723161,"node_id":"MDEwOlJlcG9zaXRvcnk0MzcyMzE2MQ==","name":"helm","full_name":"helm/helm","private":false,"owner":{"login":"helm","id":15859888,"node_id":"MDEyOk9yZ2FuaXphdGlvbjE1ODU5ODg4","avatar_url":"https://avatars.githubusercontent.com/u/15859888?v=4","gravatar_id":"","url":"https://api.github.com/users/helm","html_url":"https://github.com/helm","followers_url":"https://api.github.com/users/helm/followers","following_url":"https://api.github.com/users/helm/following{/other_user}","gists_url":"https://api.github.com/users/helm/gists{/gist_id}","starred_url":"https://api.github.com/users/helm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/helm/subscriptions","organizations_url":"https://api.github.com/users/helm/orgs","repos_url":"https://api.github.com/users/helm/repos","events_url":"https://api.github.com/users/helm/events{/privacy}","received_events_url":"https://api.github.com/users/helm/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/helm/helm","description":"The Kubernetes Package Manager","fork":false,"url":"https://api.github.com/repos/helm/helm","forks_url":"https://api.github.com/repos/helm/helm/forks","keys_url":"https://api.github.com/repos/helm/helm/keys{/key_id}","collaborators_url":"https://api.github.com/repos/helm/helm/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/helm/helm/teams","hooks_url":"https://api.github.com/repos/helm/helm/hooks","issue_events_url":"https://api.github.com/repos/helm/helm/issues/events{/number}","events_url":"https://api.github.com/repos/helm/helm/events","assignees_url":"https://api.github.com/repos/helm/helm/assignees{/user}","branches_url":"https://api.github.com/repos/helm/helm/branches{/branch}","tags_url":"https://api.github.com/repos/helm/helm/tags","blobs_url":"https://api.github.com/repos/helm/helm/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/helm/helm/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/helm/helm/git/refs{/sha}","trees_url":"https://api.github.com/repos/helm/helm/git/trees{/sha}","statuses_url":"https://api.github.com/repos/helm/helm/statuses/{sha}","languages_url":"https://api.github.com/repos/helm/helm/languages","stargazers_url":"https://api.github.com/repos/helm/helm/stargazers","contributors_url":"https://api.github.com/repos/helm/helm/contributors","subscribers_url":"https://api.github.com/repos/helm/helm/subscribers","subscription_url":"https://api.github.com/repos/helm/helm/subscription","commits_url":"https://api.github.com/repos/helm/helm/commits{/sha}","git_commits_url":"https://api.github.com/repos/helm/helm/git/commits{/sha}","comments_url":"https://api.github.com/repos/helm/helm/comments{/number}","issue_comment_url":"https://api.github.com/repos/helm/helm/issues/comments{/number}","contents_url":"https://api.github.com/repos/helm/helm/contents/{+path}","compare_url":"https://api.github.com/repos/helm/helm/compare/{base}...{head}","merges_url":"https://api.github.com/repos/helm/helm/merges","archive_url":"https://api.github.com/repos/helm/helm/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/helm/helm/downloads","issues_url":"https://api.github.com/repos/helm/helm/issues{/number}","pulls_url":"https://api.github.com/repos/helm/helm/pulls{/number}","milestones_url":"https://api.github.com/repos/helm/helm/milestones{/number}","notifications_url":"https://api.github.com/repos/helm/helm/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/helm/helm/labels{/name}","releases_url":"https://api.github.com/repos/helm/helm/releases{/id}","deployments_url":"https://api.github.com/repos/helm/helm/deployments","created_at":"2015-10-06T01:07:32Z","updated_at":"2025-11-09T19:00:10Z","pushed_at":"2025-11-09T12:57:10Z","git_url":"git://github.com/helm/helm.git","ssh_url":"git@github.com:helm/helm.git","clone_url":"https://github.com/helm/helm.git","svn_url":"https://github.com/helm/helm","homepage":"https://helm.sh","size":25851,"stargazers_count":28930,"watchers_count":28930,"language":"Go","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":true,"has_pages":false,"has_discussions":false,"forks_count":7393,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":448,"license":{"key":"apache-2.0","name":"Apache License 2.0","spdx_id":"Apache-2.0","url":"https://api.github.com/licenses/apache-2.0","node_id":"MDc6TGljZW5zZTI="},"allow_forking":true,"is_template":false,"web_commit_signoff_required":true,"topics":["chart","charts","cncf","helm","kubernetes"],"visibility":"public","forks":7393,"open_issues":448,"watchers":28930,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"[Small reproduction and copy of this report here](https://github.com/anr-tonic/helm-repro/tree/main)\r\n\r\n# Background\r\n\r\nWe have an installer that uses helm as an SDK to install several charts needed\r\nfor our product to work. We noticed that after we implemented functionality to\r\nabort an installation that we would still receive output to stdout from helm\r\nafter the context provided to `RunWithContext` is canceled. In our case, it\r\nappears that it is because use the helm provided wait functionality.\r\n\r\nIn this report, I'm picking on `action.Install` as its where I've spent the\r\nmost time, however `action.Upgrade` also exposes a `RunWithContext` method that\r\nappears to have similar characteristics to Install's.\r\n\r\nWhile it is possible for our installer to work around this issue by\r\nimplementing our own wait logic, there are other avenues to trigger this\r\nbehavior:\r\n\r\n* Requiring post-install hooks to run after chart resources have become\r\n  available\r\n* pre-install hook that does not become ready before the context is cancelled\r\n  by the caller\r\n\r\nTheoretically, a pre-install hook could run for timeout - 1, the context would\r\ncancel, but the creation of k8s resources and wait could still happen until the\r\ntimeout expires. I haven't attempted to contrive a scenario to examine what\r\nwould actually happen in this case.\r\n\r\n# Cause\r\n\r\nEven though `RunWithContext` will return control to the caller after its\r\ncontext has been canceled, the `performInstall` go routine is still running in\r\nthe background because it does not participate in using the context passed to\r\n`RunWithContext`.\r\n\r\nMethods on `kube.Interface` also do not participate in using a context. When\r\ncalling `kube.Client` methods that invoke a method on\r\n`k8s.io/client-go/kubernetes/ClientSet` that requires a context, it uses\r\n`context.Background()`, often combined with `context.WithTimeout` from a\r\n`time.Duration` that has been passed down.\r\n\r\n# Possible solution\r\n\r\nSimilar to other extensions to `kube.Interface` that seek to avoid breaking\r\nbackwards compatibility, an additional interface could be created that exposes\r\nmethods that accept `context.Context` instead of `time.Duration`. The\r\nimplementations of the existing non context aware methods then delegate to\r\nimplementations of this interface. This would additionally require methods on\r\ntypes like `kube.waiter` to accept this context instead of constructing one\r\nfrom the background context and a timeout value. Roughly:\r\n\r\n\r\n```go\r\ntype InterfaceWithContext interface {\r\n    WaitWithContext(context.Context, ResourceList) error\r\n    WatchUntilReadyWithContext(context.Context, ResourceList) error\r\n    WaitAndGetCompletedPodPhaseWithContext(context.Context, string) (v1.PodPhase, error)\r\n    WaitForDeleteWithContext(context.Context, ResourceList) error\r\n}\r\n\r\nfunc (c *Client) Wait(resources ResourceList, timeout time.Duration) {\r\n    return c.WaitWithContext(\r\n        context.WithTimeout(context.Background(), timeout),\r\n        resources,\r\n    )\r\n}\r\n\r\nfunc (c *Client) WaitWithContext(ctx context.Context, resources ResourceList) error {\r\n\tcs, err := c.getKubeClient()\r\n\tif err != nil {\r\n\t\treturn err\r\n\t}\r\n\tchecker := NewReadyChecker(cs, c.Log, PausedAsReady(true))\r\n\tw := waiter{\r\n\t\tc:       checker,\r\n\t\tlog:     c.Log,\r\n                //timeout field removed\r\n\t}\r\n\treturn w.waitForResources(ctx, resources)\r\n}\r\n```\r\n\r\n`performInstall` is then responsible for accepting `RunWithContext`'s context\r\nand passing it into `kube.InterfaceWithContext` methods (if available via type\r\ncasting). Additionally, the unexported `Configuration.execHook` should be\r\nupdated to accept this context instead of a duration.\r\n\r\nIf desired, this implementation _could_ remove the channels used between\r\n`RunWithContext`, `performInstall` and `handleContext` since the context is\r\nuser provided. It is worth noting there are several issues and fixes for these\r\nchannels:\r\n\r\n* #10489\r\n* #11805\r\n* #11971\r\n* #11978\r\n\r\nActions that do not expose a `RunWithContext` method but would need to interact\r\nwith methods now requesting a context should use `context.TODO()` instead of\r\n`context.Background()` where necessary to signal that they should be expanded\r\nto support contexts.\r\n\r\nWhen Helm 4 is being prepared, the existing non-context aware methods on\r\n`kube.Interface` can be replaced with the matching context aware methods.\r\nActions using `context.TODO()` can be expanded into accepting a\r\n`context.Context` which will be passed in place of the `TODO` context.","reactions":{"url":"https://api.github.com/repos/helm/helm/issues/12086/reactions","total_count":4,"+1":4,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/helm/helm/issues/12086/timeline","performed_via_github_app":null,"state_reason":null}},"event":"cross-referenced"}]