{"url":"https://api.github.com/repos/helm/helm/issues/6566","repository_url":"https://api.github.com/repos/helm/helm","labels_url":"https://api.github.com/repos/helm/helm/issues/6566/labels{/name}","comments_url":"https://api.github.com/repos/helm/helm/issues/6566/comments","events_url":"https://api.github.com/repos/helm/helm/issues/6566/events","html_url":"https://github.com/helm/helm/issues/6566","id":502107954,"node_id":"MDU6SXNzdWU1MDIxMDc5NTQ=","number":6566,"title":"consider making apiextv1beta1.AddToScheme something that can only be called once","user":{"login":"rudoi","id":12792264,"node_id":"MDQ6VXNlcjEyNzkyMjY0","avatar_url":"https://avatars.githubusercontent.com/u/12792264?v=4","gravatar_id":"","url":"https://api.github.com/users/rudoi","html_url":"https://github.com/rudoi","followers_url":"https://api.github.com/users/rudoi/followers","following_url":"https://api.github.com/users/rudoi/following{/other_user}","gists_url":"https://api.github.com/users/rudoi/gists{/gist_id}","starred_url":"https://api.github.com/users/rudoi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rudoi/subscriptions","organizations_url":"https://api.github.com/users/rudoi/orgs","repos_url":"https://api.github.com/users/rudoi/repos","events_url":"https://api.github.com/users/rudoi/events{/privacy}","received_events_url":"https://api.github.com/users/rudoi/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":778135666,"node_id":"MDU6TGFiZWw3NzgxMzU2NjY=","url":"https://api.github.com/repos/helm/helm/labels/bug","name":"bug","color":"e11d21","default":true,"description":"Categorizes issue or PR as related to a bug."},{"id":926755770,"node_id":"MDU6TGFiZWw5MjY3NTU3NzA=","url":"https://api.github.com/repos/helm/helm/labels/v3.x","name":"v3.x","color":"e82969","default":false,"description":"Issues and Pull Requests related to the major version v3"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2019-10-03T14:38:44Z","updated_at":"2020-01-17T19:32:03Z","closed_at":"2020-01-17T19:32:03Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I'm doing some work on a Kubernetes controller that deploys Helm charts to multiple remote clusters through a CRD. Regularly, I'd have this controller reconcile the Custom Resources concurrently, but there's a race condition caused by concurrent writes to scheme.Scheme.\r\n\r\nTaking a look at `kube.New` today: \r\nhttps://github.com/helm/helm/blob/5c592dcca685b3e5887e3c241bb2a73a43191f62/pkg/kube/client.go#L62\r\n\r\nThe call to `AddToScheme`, behind the scenes appends to a slice. This means that attempting to call AddToScheme concurrently can cause a panic. \r\n\r\nThe good news is, because that scheme.Scheme is globally available, we only need to add the CRD types once, no matter how many Kube clients we need to create. So, I'd like to propose perhaps wrapping that AddToScheme in a `sync.Once` or something of that nature.\r\n\r\nI understand that mine is a pretty specific use case, and I'd be happy to contribute any fixes for making Helm more controller-friendly. Thanks!\r\n","closed_by":{"login":"bacongobbler","id":1360539,"node_id":"MDQ6VXNlcjEzNjA1Mzk=","avatar_url":"https://avatars.githubusercontent.com/u/1360539?v=4","gravatar_id":"","url":"https://api.github.com/users/bacongobbler","html_url":"https://github.com/bacongobbler","followers_url":"https://api.github.com/users/bacongobbler/followers","following_url":"https://api.github.com/users/bacongobbler/following{/other_user}","gists_url":"https://api.github.com/users/bacongobbler/gists{/gist_id}","starred_url":"https://api.github.com/users/bacongobbler/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bacongobbler/subscriptions","organizations_url":"https://api.github.com/users/bacongobbler/orgs","repos_url":"https://api.github.com/users/bacongobbler/repos","events_url":"https://api.github.com/users/bacongobbler/events{/privacy}","received_events_url":"https://api.github.com/users/bacongobbler/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/helm/helm/issues/6566/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/helm/helm/issues/6566/timeline","performed_via_github_app":null,"state_reason":"completed"}