{"url":"https://api.github.com/repos/helm/helm/issues/11773","repository_url":"https://api.github.com/repos/helm/helm","labels_url":"https://api.github.com/repos/helm/helm/issues/11773/labels{/name}","comments_url":"https://api.github.com/repos/helm/helm/issues/11773/comments","events_url":"https://api.github.com/repos/helm/helm/issues/11773/events","html_url":"https://github.com/helm/helm/issues/11773","id":1561514309,"node_id":"I_kwDOApspmc5dEtFF","number":11773,"title":"Helm upgrade for charts that contain statefulsets with .spec.updateStrategy.rollingUpdate.partition is incorrect.","user":{"login":"amannijhawan","id":1563216,"node_id":"MDQ6VXNlcjE1NjMyMTY=","avatar_url":"https://avatars.githubusercontent.com/u/1563216?v=4","gravatar_id":"","url":"https://api.github.com/users/amannijhawan","html_url":"https://github.com/amannijhawan","followers_url":"https://api.github.com/users/amannijhawan/followers","following_url":"https://api.github.com/users/amannijhawan/following{/other_user}","gists_url":"https://api.github.com/users/amannijhawan/gists{/gist_id}","starred_url":"https://api.github.com/users/amannijhawan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/amannijhawan/subscriptions","organizations_url":"https://api.github.com/users/amannijhawan/orgs","repos_url":"https://api.github.com/users/amannijhawan/repos","events_url":"https://api.github.com/users/amannijhawan/events{/privacy}","received_events_url":"https://api.github.com/users/amannijhawan/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":562692416,"node_id":"MDU6TGFiZWw1NjI2OTI0MTY=","url":"https://api.github.com/repos/helm/helm/labels/in%20progress","name":"in progress","color":"11DD11","default":false,"description":null},{"id":778135666,"node_id":"MDU6TGFiZWw3NzgxMzU2NjY=","url":"https://api.github.com/repos/helm/helm/labels/bug","name":"bug","color":"e11d21","default":true,"description":"Categorizes issue or PR as related to a bug."}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2023-01-29T23:50:14Z","updated_at":"2023-03-30T16:39:31Z","closed_at":"2023-03-30T16:39:31Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Output of `helm version`: \r\n```\r\n[centos@dev-server-centos helm]$ helm version\r\nversion.BuildInfo{Version:\"v3.10.3\", GitCommit:\"835b7334cfe2e5e27870ab3ed4135f136eecc704\", GitTreeState:\"clean\", GoVersion:\"go1.18.9\"}\r\n```\r\n\r\nOutput of `kubectl version`:\r\n```\r\nClient Version: version.Info{Major:\"1\", Minor:\"22+\", GitVersion:\"v1.22.14-dispatcher-dirty\", GitCommit:\"009f3ac5f1d09b1ec5d4dc811b6032271fe61f75\", GitTreeState:\"dirty\", BuildDate:\"2022-09-19T01:31:36Z\", GoVersion:\"go1.16.15\", Compiler:\"gc\", Platform:\"linux/amd64\"}\r\nServer Version: version.Info{Major:\"1\", Minor:\"22\", GitVersion:\"v1.22.15-gke.2500\", GitCommit:\"fbf2f97a417bed01195ce67ab3c222d68f06f8b7\", GitTreeState:\"clean\", BuildDate:\"2022-10-26T09:24:45Z\", GoVersion:\"go1.16.15b7\", Compiler:\"gc\", Platform:\"linux/amd64\"}\r\n\r\n```\r\n\r\nCloud Provider/Platform (AKS, GKE, Minikube etc.):  GKE\r\n\r\n\r\nHi Helm Maintainers. \r\n\r\nIn our testing we found that helm upgrade for charts that contain statefulsets with .spec.updateStrategy.rollingUpdate.partition does not function as expected. When using with a **--wait** and **--timeout** parameter the following command always hangs \r\n`helm upgrade helm-test ./ --debug --timeout=900s --wait -n test-helm`\r\n\r\nHere is a simple chart that recreates this issue. \r\nhttps://github.com/amannijhawan/helm-test-case-anijhawan/blob/gh-pages/example-0.1.0.tgz\r\n\r\nSteps to reproduce:\r\n1.  Create a local scratch dir\r\n     `mkdir repro `\r\n2. Download the helm package     \r\n   `cd repro &&  wget https://github.com/amannijhawan/helm-test-case-anijhawan/raw/gh-pages/example-0.1.0.tgz`\r\n3. Unarchive Package\r\n    `tar -xvzf example-0.1.0.tgz` \r\n4. Create an isolated namesapce\r\n     `kubectl create ns repro`\r\n5. Helm install the chart.\r\n    `helm install helm-test .   -n repro` \r\n6. Attempt Helm Upgrade\r\n    `helm upgrade helm-test  ./ --debug --timeout=100s --wait --values=upgrade.yaml  -n repro`\r\nWe see that the helm upgrade fails with the following logs. \r\n\r\n**Edited to included the full output that shows the correct logs**\r\n```\r\n[centos@dev-server-centos helm-test-case-anijhawan]$ helm upgrade helm-test  ./ --debug --timeout=100s --wait   -n repro\r\nupgrade.go:142: [debug] preparing upgrade for helm-test\r\nupgrade.go:150: [debug] performing update for helm-test\r\nupgrade.go:322: [debug] creating upgraded release for helm-test\r\nclient.go:229: [debug] checking 2 resources for changes\r\nclient.go:512: [debug] Looks like there are no changes for Service \"nginx\"\r\nclient.go:521: [debug] Patch StatefulSet \"web\" in namespace repro\r\nupgrade.go:394: [debug] waiting for release helm-test resources (created: 0 updated: 2  deleted: 0)\r\nwait.go:66: [debug] beginning wait for 2 resources with timeout of 1m40s\r\nready.go:362: [debug] StatefulSet is not ready: repro/web. update has not yet been observed\r\nready.go:393: [debug] StatefulSet is not ready: repro/web. 2 out of 3 expected pods are ready\r\nready.go:393: [debug] StatefulSet is not ready: repro/web. 2 out of 3 expected pods are ready\r\nready.go:393: [debug] StatefulSet is not ready: repro/web. 2 out of 3 expected pods are ready\r\nready.go:398: [debug] StatefulSet is not ready: repro/web. currentRevision web-6b4fd5c9f6 does not yet match updateRevision web-545c9585b7\r\nready.go:398: [debug] StatefulSet is not ready: repro/web. currentRevision web-6b4fd5c9f6 does not yet match updateRevision web-545c9585b7\r\nready.go:398: [debug] StatefulSet is not ready: repro/web. currentRevision web-6b4fd5c9f6 does not yet match updateRevision web-545c9585b7\r\nready.go:398: [debug] StatefulSet is not ready: repro/web. currentRevision web-6b4fd5c9f6 does not yet match updateRevision web-545c9585b7\r\nready.go:398: [debug] StatefulSet is not ready: repro/web. currentRevision web-6b4fd5c9f6 does not yet match updateRevision web-545c9585b7\r\nready.go:398: [debug] StatefulSet is not ready: repro/web. currentRevision web-6b4fd5c9f6 does not yet match updateRevision web-545c9585b7\r\nready.go:398: [debug] StatefulSet is not ready: repro/web. currentRevision web-6b4fd5c9f6 does not yet match updateRevision web-545c9585b7\r\nready.go:398: [debug] StatefulSet is not ready: repro/web. currentRevision web-6b4fd5c9f6 does not yet match updateRevision web-545c9585b7\r\nready.go:398: [debug] StatefulSet is not ready: repro/web. currentRevision web-6b4fd5c9f6 does not yet match updateRevision web-545c9585b7\r\nready.go:398: [debug] StatefulSet is not ready: repro/web. currentRevision web-6b4fd5c9f6 does not yet match updateRevision web-545c9585b7\r\nready.go:398: [debug] StatefulSet is not ready: repro/web. currentRevision web-6b4fd5c9f6 does not yet match updateRevision web-545c9585b7\r\nready.go:398: [debug] StatefulSet is not ready: repro/web. currentRevision web-6b4fd5c9f6 does not yet match updateRevision web-545c9585b7\r\nready.go:398: [debug] StatefulSet is not ready: repro/web. currentRevision web-6b4fd5c9f6 does not yet match updateRevision web-545c9585b7\r\nready.go:398: [debug] StatefulSet is not ready: repro/web. currentRevision web-6b4fd5c9f6 does not yet match updateRevision web-545c9585b7\r\nready.go:398: [debug] StatefulSet is not ready: repro/web. currentRevision web-6b4fd5c9f6 does not yet match updateRevision web-545c9585b7\r\nready.go:398: [debug] StatefulSet is not ready: repro/web. currentRevision web-6b4fd5c9f6 does not yet match updateRevision web-545c9585b7\r\nready.go:398: [debug] StatefulSet is not ready: repro/web. currentRevision web-6b4fd5c9f6 does not yet match updateRevision web-545c9585b7\r\nready.go:398: [debug] StatefulSet is not ready: repro/web. currentRevision web-6b4fd5c9f6 does not yet match updateRevision web-545c9585b7\r\nready.go:398: [debug] StatefulSet is not ready: repro/web. currentRevision web-6b4fd5c9f6 does not yet match updateRevision web-545c9585b7\r\nready.go:398: [debug] StatefulSet is not ready: repro/web. currentRevision web-6b4fd5c9f6 does not yet match updateRevision web-545c9585b7\r\nready.go:398: [debug] StatefulSet is not ready: repro/web. currentRevision web-6b4fd5c9f6 does not yet match updateRevision web-545c9585b7\r\nready.go:398: [debug] StatefulSet is not ready: repro/web. currentRevision web-6b4fd5c9f6 does not yet match updateRevision web-545c9585b7\r\nready.go:398: [debug] StatefulSet is not ready: repro/web. currentRevision web-6b4fd5c9f6 does not yet match updateRevision web-545c9585b7\r\nready.go:398: [debug] StatefulSet is not ready: repro/web. currentRevision web-6b4fd5c9f6 does not yet match updateRevision web-545c9585b7\r\nready.go:398: [debug] StatefulSet is not ready: repro/web. currentRevision web-6b4fd5c9f6 does not yet match updateRevision web-545c9585b7\r\nready.go:398: [debug] StatefulSet is not ready: repro/web. currentRevision web-6b4fd5c9f6 does not yet match updateRevision web-545c9585b7\r\nready.go:398: [debug] StatefulSet is not ready: repro/web. currentRevision web-6b4fd5c9f6 does not yet match updateRevision web-545c9585b7\r\nready.go:398: [debug] StatefulSet is not ready: repro/web. currentRevision web-6b4fd5c9f6 does not yet match updateRevision web-545c9585b7\r\nready.go:398: [debug] StatefulSet is not ready: repro/web. currentRevision web-6b4fd5c9f6 does not yet match updateRevision web-545c9585b7\r\nready.go:398: [debug] StatefulSet is not ready: repro/web. currentRevision web-6b4fd5c9f6 does not yet match updateRevision web-545c9585b7\r\nready.go:398: [debug] StatefulSet is not ready: repro/web. currentRevision web-6b4fd5c9f6 does not yet match updateRevision web-545c9585b7\r\nready.go:398: [debug] StatefulSet is not ready: repro/web. currentRevision web-6b4fd5c9f6 does not yet match updateRevision web-545c9585b7\r\nready.go:398: [debug] StatefulSet is not ready: repro/web. currentRevision web-6b4fd5c9f6 does not yet match updateRevision web-545c9585b7\r\nready.go:398: [debug] StatefulSet is not ready: repro/web. currentRevision web-6b4fd5c9f6 does not yet match updateRevision web-545c9585b7\r\nready.go:398: [debug] StatefulSet is not ready: repro/web. currentRevision web-6b4fd5c9f6 does not yet match updateRevision web-545c9585b7\r\nready.go:398: [debug] StatefulSet is not ready: repro/web. currentRevision web-6b4fd5c9f6 does not yet match updateRevision web-545c9585b7\r\nready.go:398: [debug] StatefulSet is not ready: repro/web. currentRevision web-6b4fd5c9f6 does not yet match updateRevision web-545c9585b7\r\nready.go:398: [debug] StatefulSet is not ready: repro/web. currentRevision web-6b4fd5c9f6 does not yet match updateRevision web-545c9585b7\r\nready.go:398: [debug] StatefulSet is not ready: repro/web. currentRevision web-6b4fd5c9f6 does not yet match updateRevision web-545c9585b7\r\nready.go:398: [debug] StatefulSet is not ready: repro/web. currentRevision web-6b4fd5c9f6 does not yet match updateRevision web-545c9585b7\r\nready.go:398: [debug] StatefulSet is not ready: repro/web. currentRevision web-6b4fd5c9f6 does not yet match updateRevision web-545c9585b7\r\nready.go:398: [debug] StatefulSet is not ready: repro/web. currentRevision web-6b4fd5c9f6 does not yet match updateRevision web-545c9585b7\r\nready.go:398: [debug] StatefulSet is not ready: repro/web. currentRevision web-6b4fd5c9f6 does not yet match updateRevision web-545c9585b7\r\nready.go:398: [debug] StatefulSet is not ready: repro/web. currentRevision web-6b4fd5c9f6 does not yet match updateRevision web-545c9585b7\r\nready.go:398: [debug] StatefulSet is not ready: repro/web. currentRevision web-6b4fd5c9f6 does not yet match updateRevision web-545c9585b7\r\nready.go:398: [debug] StatefulSet is not ready: repro/web. currentRevision web-6b4fd5c9f6 does not yet match updateRevision web-545c9585b7\r\nupgrade.go:434: [debug] warning: Upgrade \"helm-test\" failed: timed out waiting for the condition\r\nError: UPGRADE FAILED: timed out waiting for the condition\r\nhelm.go:84: [debug] timed out waiting for the condition\r\nUPGRADE FAILED\r\nmain.newUpgradeCmd.func2\r\n\thelm.sh/helm/v3/cmd/helm/upgrade.go:201\r\ngithub.com/spf13/cobra.(*Command).execute\r\n\tgithub.com/spf13/cobra@v1.5.0/command.go:872\r\ngithub.com/spf13/cobra.(*Command).ExecuteC\r\n\tgithub.com/spf13/cobra@v1.5.0/command.go:990\r\ngithub.com/spf13/cobra.(*Command).Execute\r\n\tgithub.com/spf13/cobra@v1.5.0/command.go:918\r\nmain.main\r\n\thelm.sh/helm/v3/cmd/helm/helm.go:83\r\nruntime.main\r\n\truntime/proc.go:250\r\nruntime.goexit\r\n\truntime/asm_amd64.s:1571\r\n[centos@dev-server-centos helm-test-case-anijhawan]$ ^C\r\n\r\n```\r\nHowever at this point we can check that the upgrade has been successfully applied to one pod matching the current value of partition. \r\n\r\n\r\n```\r\n[centos@dev-server-centos helm-test-case-anijhawan]$ kubectl get pod web-2 -o yaml   -nrepro | grep -a5 resource\r\n    blockOwnerDeletion: true\r\n    controller: true\r\n    kind: StatefulSet\r\n    name: web\r\n    uid: 416718f4-f8bd-4f3e-b193-439571269248\r\n  resourceVersion: \"816068910\"\r\n  uid: dcd81ea4-376e-419f-b437-087a58f34819\r\nspec:\r\n  containers:\r\n  - image: k8s.gcr.io/nginx-slim:0.8\r\n    imagePullPolicy: IfNotPresent\r\n    name: nginx\r\n    ports:\r\n    - containerPort: 80\r\n      name: web\r\n      protocol: TCP\r\n    resources:\r\n      requests:\r\n        memory: 256Mi\r\n    terminationMessagePath: /dev/termination-log\r\n    terminationMessagePolicy: File\r\n    volumeMounts:\r\n[centos@dev-server-centos helm-test-case-anijhawan]$ kubectl get pod web-1 -o yaml   -nrepro | grep -a5 resource\r\n    blockOwnerDeletion: true\r\n    controller: true\r\n    kind: StatefulSet\r\n    name: web\r\n    uid: 416718f4-f8bd-4f3e-b193-439571269248\r\n  resourceVersion: \"816067417\"\r\n  uid: 7522e2ae-1578-40b7-8bcc-aba3a56b685c\r\nspec:\r\n  containers:\r\n  - image: k8s.gcr.io/nginx-slim:0.8\r\n    imagePullPolicy: IfNotPresent\r\n    name: nginx\r\n    ports:\r\n    - containerPort: 80\r\n      name: web\r\n      protocol: TCP\r\n    resources:\r\n      requests:\r\n        memory: 500Mi\r\n    terminationMessagePath: /dev/termination-log\r\n    terminationMessagePolicy: File\r\n    volumeMounts:\r\n```\r\n\r\nThe issue seems to be this check in ready.go thats assuming the upgrade hasn't been applied yet.\r\nhttps://github.com/helm/helm/blob/76157c6d06f981a42bfbb9ec636bae5443cb2c8f/pkg/kube/ready.go#L397\r\n\r\n\r\n\r\n","closed_by":{"login":"technosophos","id":89193,"node_id":"MDQ6VXNlcjg5MTkz","avatar_url":"https://avatars.githubusercontent.com/u/89193?v=4","gravatar_id":"","url":"https://api.github.com/users/technosophos","html_url":"https://github.com/technosophos","followers_url":"https://api.github.com/users/technosophos/followers","following_url":"https://api.github.com/users/technosophos/following{/other_user}","gists_url":"https://api.github.com/users/technosophos/gists{/gist_id}","starred_url":"https://api.github.com/users/technosophos/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/technosophos/subscriptions","organizations_url":"https://api.github.com/users/technosophos/orgs","repos_url":"https://api.github.com/users/technosophos/repos","events_url":"https://api.github.com/users/technosophos/events{/privacy}","received_events_url":"https://api.github.com/users/technosophos/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/helm/helm/issues/11773/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/helm/helm/issues/11773/timeline","performed_via_github_app":null,"state_reason":"completed"}