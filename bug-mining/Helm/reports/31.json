{"url":"https://api.github.com/repos/helm/helm/issues/7279","repository_url":"https://api.github.com/repos/helm/helm","labels_url":"https://api.github.com/repos/helm/helm/issues/7279/labels{/name}","comments_url":"https://api.github.com/repos/helm/helm/issues/7279/comments","events_url":"https://api.github.com/repos/helm/helm/issues/7279/events","html_url":"https://github.com/helm/helm/issues/7279","id":540954475,"node_id":"MDU6SXNzdWU1NDA5NTQ0NzU=","number":7279,"title":"Moving CRDs from templates/ to crds/ results in CRDs being deleted","user":{"login":"PhilGrayson","id":143456,"node_id":"MDQ6VXNlcjE0MzQ1Ng==","avatar_url":"https://avatars.githubusercontent.com/u/143456?v=4","gravatar_id":"","url":"https://api.github.com/users/PhilGrayson","html_url":"https://github.com/PhilGrayson","followers_url":"https://api.github.com/users/PhilGrayson/followers","following_url":"https://api.github.com/users/PhilGrayson/following{/other_user}","gists_url":"https://api.github.com/users/PhilGrayson/gists{/gist_id}","starred_url":"https://api.github.com/users/PhilGrayson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/PhilGrayson/subscriptions","organizations_url":"https://api.github.com/users/PhilGrayson/orgs","repos_url":"https://api.github.com/users/PhilGrayson/repos","events_url":"https://api.github.com/users/PhilGrayson/events{/privacy}","received_events_url":"https://api.github.com/users/PhilGrayson/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":269212356,"node_id":"MDU6TGFiZWwyNjkyMTIzNTY=","url":"https://api.github.com/repos/helm/helm/labels/question/support","name":"question/support","color":"cc317c","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2019-12-20T11:44:28Z","updated_at":"2020-01-09T20:53:10Z","closed_at":"2020-01-09T20:53:09Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Output of `helm version`:\r\n```\r\nversion.BuildInfo{Version:\"v3.0.1\", GitCommit:\"7c22ef9ce89e0ebeb7125ba2ebf7d421f3e82ffa\", GitTreeState:\"clean\", GoVersion:\"go1.13.4\"}\r\n```\r\n\r\nOutput of `kubectl version`:\r\n```\r\nClient Version: version.Info{Major:\"1\", Minor:\"11\", GitVersion:\"v1.11.3\", GitCommit:\"a4529464e4629c21224b3d52edfe0ea91b072862\", GitTreeState:\"clean\", BuildDate:\"2018-09-09T18:02:47Z\", GoVersion:\"go1.10.3\", Compiler:\"gc\", Platform:\"darwin/amd64\"}\r\nServer Version: version.Info{Major:\"1\", Minor:\"14\", GitVersion:\"v1.14.7\", GitCommit:\"8fca2ec50a6133511b771a11559e24191b1aa2b4\", GitTreeState:\"clean\", BuildDate:\"2019-09-18T14:39:02Z\", GoVersion:\"go1.12.9\", Compiler:\"gc\", Platform:\"linux/amd64\"}\r\n```\r\n\r\nCloud Provider/Platform (AKS, GKE, Minikube etc.): \r\nN/A. Tested on Kubernetes in Docker-for-Mac. Also on on-premise Kubernetes deployments.\r\n\r\n---\r\n\r\nI have a chart with CustomResourceDefinitions defined in the `templates/` directory. I used the 2to3 plugin to migrate my deployments from Helm v2 to v3. I'm now trying to move the CustomResourceDefinitions from `templates/` to `crds/` as per the best practices. \r\n\r\nI'm not able to perform the move without Helm 3 deleting the CustomResourceDefinitions. I think this is a bug since the documentation is quite clear that Helm does not delete CRDs (https://helm.sh/docs/topics/charts/#custom-resource-definitions-crds)\r\n>CRDs are never deleted. Deleting a CRD automatically deletes all of the CRDâ€™s contents across all namespaces in the cluster. Consequently, Helm will not delete CRDs.\r\n\r\n### Steps to replicate\r\nSetup and install a minimum chart.\r\n```\r\nmkdir crd-issue\r\nmkdir crd-issue/templates\r\nmkdir crd-issue/crds\r\n\r\ncd crd-issue\r\n\r\ncat > Chart.yaml <<EOF\r\nname: crd-issue\r\nversion: 0.0.1\r\nEOF\r\n\r\ncat > templates/crd.yaml <<EOF\r\napiVersion: apiextensions.k8s.io/v1beta1\r\nkind: CustomResourceDefinition\r\nmetadata:\r\n  name: greetings.example.com\r\nspec:\r\n  group: example.com\r\n  version: v1\r\n  scope: Namespaced\r\n  names:\r\n    plural: greetings\r\n    singular: greeting\r\n    kind: Greeting\r\nEOF\r\n\r\nhelm upgrade --install crd-issue .\r\n```\r\n\r\nVerify the CRD has been installed.\r\n```\r\nkubectl get crd greetings.example.com\r\nNAME                    CREATED AT\r\ngreetings.example.com   2019-12-20T11:23:05Z\r\n```\r\n\r\nMove the CustomResourceDefinition into the `crds/` directory and upgrade\r\n```\r\nmv templates/crd.yaml crds\r\nhelm upgrade --install crd-issue .\r\n```\r\n\r\nVerify the CRD has been deleted\r\n```\r\nkubectl get crd greetings.example.com\r\nNo resources found.\r\nError from server (NotFound): customresourcedefinitions.apiextensions.k8s.io \"greetings.example.com\" not found\r\n```\r\n\r\n### Fix thoughts\r\nI'm wondering if Helm can be updated to never issue a delete for a CRD. For example by placing guards around calls to Kubernetes Delete API.\r\nI'm happy to have a go at implementing such a feature. It'll be good to get a maintainer's thought about where best to put such a guard. ","closed_by":{"login":"PhilGrayson","id":143456,"node_id":"MDQ6VXNlcjE0MzQ1Ng==","avatar_url":"https://avatars.githubusercontent.com/u/143456?v=4","gravatar_id":"","url":"https://api.github.com/users/PhilGrayson","html_url":"https://github.com/PhilGrayson","followers_url":"https://api.github.com/users/PhilGrayson/followers","following_url":"https://api.github.com/users/PhilGrayson/following{/other_user}","gists_url":"https://api.github.com/users/PhilGrayson/gists{/gist_id}","starred_url":"https://api.github.com/users/PhilGrayson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/PhilGrayson/subscriptions","organizations_url":"https://api.github.com/users/PhilGrayson/orgs","repos_url":"https://api.github.com/users/PhilGrayson/repos","events_url":"https://api.github.com/users/PhilGrayson/events{/privacy}","received_events_url":"https://api.github.com/users/PhilGrayson/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/helm/helm/issues/7279/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/helm/helm/issues/7279/timeline","performed_via_github_app":null,"state_reason":"completed"}