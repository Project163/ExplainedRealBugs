{"url":"https://api.github.com/repos/helm/helm/issues/7159","repository_url":"https://api.github.com/repos/helm/helm","labels_url":"https://api.github.com/repos/helm/helm/issues/7159/labels{/name}","comments_url":"https://api.github.com/repos/helm/helm/issues/7159/comments","events_url":"https://api.github.com/repos/helm/helm/issues/7159/events","html_url":"https://github.com/helm/helm/issues/7159","id":533225558,"node_id":"MDU6SXNzdWU1MzMyMjU1NTg=","number":7159,"title":"cannot install service account token due to install order","user":{"login":"dastrobu","id":1847260,"node_id":"MDQ6VXNlcjE4NDcyNjA=","avatar_url":"https://avatars.githubusercontent.com/u/1847260?v=4","gravatar_id":"","url":"https://api.github.com/users/dastrobu","html_url":"https://github.com/dastrobu","followers_url":"https://api.github.com/users/dastrobu/followers","following_url":"https://api.github.com/users/dastrobu/following{/other_user}","gists_url":"https://api.github.com/users/dastrobu/gists{/gist_id}","starred_url":"https://api.github.com/users/dastrobu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dastrobu/subscriptions","organizations_url":"https://api.github.com/users/dastrobu/orgs","repos_url":"https://api.github.com/users/dastrobu/repos","events_url":"https://api.github.com/users/dastrobu/events{/privacy}","received_events_url":"https://api.github.com/users/dastrobu/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":778135666,"node_id":"MDU6TGFiZWw3NzgxMzU2NjY=","url":"https://api.github.com/repos/helm/helm/labels/bug","name":"bug","color":"e11d21","default":true,"description":"Categorizes issue or PR as related to a bug."}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2019-12-05T09:26:11Z","updated_at":"2022-08-18T02:00:31Z","closed_at":"2020-01-08T18:04:34Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Given a chart containing the following template \r\n```yaml\r\napiVersion: v1\r\nautomountServiceAccountToken: false\r\nkind: ServiceAccount\r\nmetadata:\r\n  name: tmp\r\nsecrets:\r\n- name: tmp\r\n---\r\napiVersion: v1\r\nkind: Secret\r\nmetadata:\r\n  name: tmp\r\n  annotations:\r\n    kubernetes.io/service-account.name: tmp-token\r\ntype: kubernetes.io/service-account-token\r\n```\r\nHelm will install the service account token (Secret) first and Kubernetes will instantly delete this secret, since no service account is available for this secret (see [Token Controller](https://kubernetes.io/docs/reference/access-authn-authz/service-accounts-admin/#token-controller)). \r\nThen Helm installs the service account, but the token is gone. \r\nWhen doing an upgrade of the Helm release after the initial install the token is generated as expected. \r\n\r\nThe reason for this behavior is the current [KindSortOrder](https://github.com/helm/helm/blob/9b42702a4bced339ff424a78ad68dd6be6e1a80a/pkg/releaseutil/kind_sorter.go#L27) where secrets come before service accounts. \r\nCurrently I cannot see why one would ever need a secret before a service account, but there are good reasons for the other way around. \r\nI propose to change the order and install service accounts before secrets. \r\n\r\nOutput of `helm version`:\r\n```\r\nversion.BuildInfo{Version:\"v3.0.0\", GitCommit:\"e29ce2a54e96cd02ccfce88bee4f58bb6e2a28b6\", GitTreeState:\"clean\", GoVersion:\"go1.13.4\"}\r\n```\r\nOutput of `kubectl version`:\r\n```\r\nClient Version: version.Info{Major:\"1\", Minor:\"14\", GitVersion:\"v1.14.4\", GitCommit:\"a87e9a978f65a8303aa9467537aa59c18122cbf9\", GitTreeState:\"clean\", BuildDate:\"2019-07-08T08:51:16Z\", GoVersion:\"go1.12.5\", Compiler:\"gc\", Platform:\"darwin/amd64\"}\r\nServer Version: version.Info{Major:\"1\", Minor:\"16\", GitVersion:\"v1.16.3\", GitCommit:\"b3cbbae08ec52a7fc73d334838e18d17e8512749\", GitTreeState:\"clean\", BuildDate:\"2019-11-16T01:01:59Z\", GoVersion:\"go1.12.12\", Compiler:\"gc\", Platform:\"linux/amd64\"}\r\n```\r\nCloud Provider/Platform (AKS, GKE, Minikube etc.): \r\nkind\r\n","closed_by":{"login":"bacongobbler","id":1360539,"node_id":"MDQ6VXNlcjEzNjA1Mzk=","avatar_url":"https://avatars.githubusercontent.com/u/1360539?v=4","gravatar_id":"","url":"https://api.github.com/users/bacongobbler","html_url":"https://github.com/bacongobbler","followers_url":"https://api.github.com/users/bacongobbler/followers","following_url":"https://api.github.com/users/bacongobbler/following{/other_user}","gists_url":"https://api.github.com/users/bacongobbler/gists{/gist_id}","starred_url":"https://api.github.com/users/bacongobbler/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bacongobbler/subscriptions","organizations_url":"https://api.github.com/users/bacongobbler/orgs","repos_url":"https://api.github.com/users/bacongobbler/repos","events_url":"https://api.github.com/users/bacongobbler/events{/privacy}","received_events_url":"https://api.github.com/users/bacongobbler/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/helm/helm/issues/7159/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/helm/helm/issues/7159/timeline","performed_via_github_app":null,"state_reason":"completed"}