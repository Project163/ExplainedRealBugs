{"url":"https://api.github.com/repos/helm/helm/issues/13128","repository_url":"https://api.github.com/repos/helm/helm","labels_url":"https://api.github.com/repos/helm/helm/issues/13128/labels{/name}","comments_url":"https://api.github.com/repos/helm/helm/issues/13128/comments","events_url":"https://api.github.com/repos/helm/helm/issues/13128/events","html_url":"https://github.com/helm/helm/issues/13128","id":2360501019,"node_id":"I_kwDOApspmc6MsmMb","number":13128,"title":"Custom burst limit settings don't apply to discovery","user":{"login":"evanfoster","id":15820709,"node_id":"MDQ6VXNlcjE1ODIwNzA5","avatar_url":"https://avatars.githubusercontent.com/u/15820709?v=4","gravatar_id":"","url":"https://api.github.com/users/evanfoster","html_url":"https://github.com/evanfoster","followers_url":"https://api.github.com/users/evanfoster/followers","following_url":"https://api.github.com/users/evanfoster/following{/other_user}","gists_url":"https://api.github.com/users/evanfoster/gists{/gist_id}","starred_url":"https://api.github.com/users/evanfoster/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/evanfoster/subscriptions","organizations_url":"https://api.github.com/users/evanfoster/orgs","repos_url":"https://api.github.com/users/evanfoster/repos","events_url":"https://api.github.com/users/evanfoster/events{/privacy}","received_events_url":"https://api.github.com/users/evanfoster/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":778135666,"node_id":"MDU6TGFiZWw3NzgxMzU2NjY=","url":"https://api.github.com/repos/helm/helm/labels/bug","name":"bug","color":"e11d21","default":true,"description":"Categorizes issue or PR as related to a bug."}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2024-06-18T18:57:58Z","updated_at":"2024-06-20T16:26:45Z","closed_at":"2024-06-20T16:26:45Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Helm currently has the `--burst-limit`/`$HELM_BURST_LIMIT` options, which allows users to give Helm more headroom when making bursty API requests. I've seen it said that setting `--burst-limit` will help with rate limiting issues on clusters with large numbers of CRDs, since the number of requests required for discovery goes up as the number of CRDs increases.\r\n\r\nUnfortunately, this is not the case: https://github.com/helm/helm/blob/a2a324e51165388448be8caaf8737b7fd2f1a19a/pkg/cli/environment.go#L127\r\n\r\nHere, Helm sets `k8s.io/client-go/rest.Config.Burst`. When `genericclioptions` instantiates a discovery client, it overrides `Config.Burst` with `ConfigFlags.discoveryBurst`: https://github.com/kubernetes/kubernetes/blob/3f9b79fc119d064d00939f91567b48d9ada7dc43/staging/src/k8s.io/cli-runtime/pkg/genericclioptions/config_flags.go#L281\r\n\r\nThis means that no matter what `--burst-limit` is set to, `generricclioptions` (and by extension, Helm) will only allow a burst limit of 300 for discovery. I found this because I was helping someone deal with client-side throttling on a large cluster.\r\n\r\nThere are two ways this issue could be addressed:\r\n1. Add a separate `--discovery-burst-limit`/`$HELM_DISCOVERY_BURST_LIMIT` flag that would independently set `generricclioptions.ConfigFlags.discoveryBurst`\r\n2. Set `generricclioptions.ConfigFlags.discoveryBurst` to the value of `--burst-limit`\r\n\r\nThe benefit to the first approach is flexibility. However, I don't know if we even need that flexibility (there's talk of removing client-side throttling now that APF is a thing). The second approach is nice because it's a very small change and makes the `--burst-limit` flag meet people's expectations. To me, the second approach seems to be more inline with the principle of least astonishment. Here's the diff:\r\n```diff\r\ndiff --git a/pkg/cli/environment.go b/pkg/cli/environment.go\r\nindex ba103252..d5101c68 100644\r\n--- a/pkg/cli/environment.go\r\n+++ b/pkg/cli/environment.go\r\n@@ -112,7 +112,7 @@ func New() *EnvSettings {\r\n \tenv.Debug, _ = strconv.ParseBool(os.Getenv(\"HELM_DEBUG\"))\r\n \r\n \t// bind to kubernetes config flags\r\n-\tenv.config = &genericclioptions.ConfigFlags{\r\n+\tconfig := &genericclioptions.ConfigFlags{\r\n \t\tNamespace:        &env.namespace,\r\n \t\tContext:          &env.KubeContext,\r\n \t\tBearerToken:      &env.KubeToken,\r\n@@ -133,6 +133,8 @@ func New() *EnvSettings {\r\n \t\t\treturn config\r\n \t\t},\r\n \t}\r\n+\tenv.config = config.WithDiscoveryBurst(env.BurstLimit)\r\n+\r\n \treturn env\r\n }\r\n```\r\n\r\nI'll be submitting a PR shortly based off of this diff.\r\n\r\nEDIT: I see a flaw in my approach. The above diff won't be exactly what I'm submitting, but it represents the intent at least.","closed_by":{"login":"mattfarina","id":62991,"node_id":"MDQ6VXNlcjYyOTkx","avatar_url":"https://avatars.githubusercontent.com/u/62991?v=4","gravatar_id":"","url":"https://api.github.com/users/mattfarina","html_url":"https://github.com/mattfarina","followers_url":"https://api.github.com/users/mattfarina/followers","following_url":"https://api.github.com/users/mattfarina/following{/other_user}","gists_url":"https://api.github.com/users/mattfarina/gists{/gist_id}","starred_url":"https://api.github.com/users/mattfarina/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mattfarina/subscriptions","organizations_url":"https://api.github.com/users/mattfarina/orgs","repos_url":"https://api.github.com/users/mattfarina/repos","events_url":"https://api.github.com/users/mattfarina/events{/privacy}","received_events_url":"https://api.github.com/users/mattfarina/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/helm/helm/issues/13128/reactions","total_count":3,"+1":3,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/helm/helm/issues/13128/timeline","performed_via_github_app":null,"state_reason":"completed"}