{"url":"https://api.github.com/repos/helm/helm/issues/8248","repository_url":"https://api.github.com/repos/helm/helm","labels_url":"https://api.github.com/repos/helm/helm/issues/8248/labels{/name}","comments_url":"https://api.github.com/repos/helm/helm/issues/8248/comments","events_url":"https://api.github.com/repos/helm/helm/issues/8248/events","html_url":"https://github.com/helm/helm/issues/8248","id":630131910,"node_id":"MDU6SXNzdWU2MzAxMzE5MTA=","number":8248,"title":"OCI: Use manifest digest vs. tarball digest","user":{"login":"jdolitsky","id":393494,"node_id":"MDQ6VXNlcjM5MzQ5NA==","avatar_url":"https://avatars.githubusercontent.com/u/393494?v=4","gravatar_id":"","url":"https://api.github.com/users/jdolitsky","html_url":"https://github.com/jdolitsky","followers_url":"https://api.github.com/users/jdolitsky/followers","following_url":"https://api.github.com/users/jdolitsky/following{/other_user}","gists_url":"https://api.github.com/users/jdolitsky/gists{/gist_id}","starred_url":"https://api.github.com/users/jdolitsky/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jdolitsky/subscriptions","organizations_url":"https://api.github.com/users/jdolitsky/orgs","repos_url":"https://api.github.com/users/jdolitsky/repos","events_url":"https://api.github.com/users/jdolitsky/events{/privacy}","received_events_url":"https://api.github.com/users/jdolitsky/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":335802899,"node_id":"MDU6TGFiZWwzMzU4MDI4OTk=","url":"https://api.github.com/repos/helm/helm/labels/proposal","name":"proposal","color":"0052cc","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2020-06-03T16:11:08Z","updated_at":"2020-06-29T21:55:02Z","closed_at":"2020-06-29T21:55:02Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"For OCI artifacts, the top-level \"envelope\" of the artifact is the manifest. This is equally as unique as the chart tarball layer. Currently, on \"helm chart save\", \"helm chart list\", and others, the digest displayed is that of the chart tarball layer.\r\n\r\nHere is some example output from `helm chart save`:\r\n```\r\n$ helm chart save mychart/ localhost:5000/myrepo/mychart:2.7.0\r\nref:     localhost:5000/myrepo/mychart:2.7.0\r\ndigest:  1b251d38cfe948dfc0a5745b7af5ca574ecb61e52aed10b19039db39af6e1617\r\nsize:    2.4 KiB\r\nname:    mychart\r\nversion: 0.1.0\r\n2.7.0: saved\r\n```\r\n\r\nThe digest displayed here is `1b251d38cfe948dfc0a5745b7af5ca574ecb61e52aed10b19039db39af6e1617`. This is that of the chart tarball, represented by `layers[0].digest` in the manifest:\r\n\r\n```\r\n$ cat ~/Library/Caches/helm/registry/cache/blobs/sha256/31fb454efb3c69fafe53672598006790122269a1b3b458607dbe106aba7059ef | jq\r\n{\r\n  \"schemaVersion\": 2,\r\n  \"config\": {\r\n    \"mediaType\": \"application/vnd.cncf.helm.config.v1+json\",\r\n    \"digest\": \"sha256:8ec7c0f2f6860037c19b54c3cfbab48d9b4b21b485a93d87b64690fdb68c2111\",\r\n    \"size\": 117\r\n  },\r\n  \"layers\": [\r\n    {\r\n      \"mediaType\": \"application/tar+gzip\",\r\n      \"digest\": \"sha256:1b251d38cfe948dfc0a5745b7af5ca574ecb61e52aed10b19039db39af6e1617\",\r\n      \"size\": 2487\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\nInstead, the digest displayed should be `31fb454efb3c69fafe53672598006790122269a1b3b458607dbe106aba7059ef`, the digest of the manifest itself.\r\n\r\nThis also affects the output of `helm chart list` (note the DIGEST column, displaying first 7 characters of the digest):\r\n\r\n```\r\n$ helm chart list\r\nREF                                                     NAME                    VERSION DIGEST  SIZE            CREATED\r\nlocalhost:5000/myrepo/mychart:2.7.0                     mychart                 2.7.0   84059d7 454 B           27 seconds\r\nlocalhost:5000/stable/acs-engine-autoscaler:2.2.2       acs-engine-autoscaler   2.2.2   d8d6762 4.3 KiB         2 hours\r\nlocalhost:5000/stable/aerospike:0.2.1                   aerospike               0.2.1   4aff638 3.7 KiB         2 hours\r\nlocalhost:5000/stable/airflow:0.13.0                    airflow                 0.13.0  c46cc43 28.1 KiB        2 hours\r\nlocalhost:5000/stable/anchore-engine:0.10.0             anchore-engine          0.10.0  3f3dcd7 34.3 KiB \r\n```\r\n\r\nFrom a registry's perspective, manifests are a \"first-class citizen\" which is used to further determine metadata and any included layers (such as the chart tarball layer).\r\n\r\nThe proposal here is to change this digest to use the manifest digest instead. This would normally be considered a breaking change, but the OCI feature set is still in experimental mode.","closed_by":{"login":"jdolitsky","id":393494,"node_id":"MDQ6VXNlcjM5MzQ5NA==","avatar_url":"https://avatars.githubusercontent.com/u/393494?v=4","gravatar_id":"","url":"https://api.github.com/users/jdolitsky","html_url":"https://github.com/jdolitsky","followers_url":"https://api.github.com/users/jdolitsky/followers","following_url":"https://api.github.com/users/jdolitsky/following{/other_user}","gists_url":"https://api.github.com/users/jdolitsky/gists{/gist_id}","starred_url":"https://api.github.com/users/jdolitsky/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jdolitsky/subscriptions","organizations_url":"https://api.github.com/users/jdolitsky/orgs","repos_url":"https://api.github.com/users/jdolitsky/repos","events_url":"https://api.github.com/users/jdolitsky/events{/privacy}","received_events_url":"https://api.github.com/users/jdolitsky/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/helm/helm/issues/8248/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/helm/helm/issues/8248/timeline","performed_via_github_app":null,"state_reason":"completed"}