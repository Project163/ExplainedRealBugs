{"url":"https://api.github.com/repos/helm/helm/issues/9710","repository_url":"https://api.github.com/repos/helm/helm","labels_url":"https://api.github.com/repos/helm/helm/issues/9710/labels{/name}","comments_url":"https://api.github.com/repos/helm/helm/issues/9710/comments","events_url":"https://api.github.com/repos/helm/helm/issues/9710/events","html_url":"https://github.com/helm/helm/issues/9710","id":893555419,"node_id":"MDU6SXNzdWU4OTM1NTU0MTk=","number":9710,"title":"Conflict error because resource quota version is old","user":{"login":"andreaskaris","id":3291433,"node_id":"MDQ6VXNlcjMyOTE0MzM=","avatar_url":"https://avatars.githubusercontent.com/u/3291433?v=4","gravatar_id":"","url":"https://api.github.com/users/andreaskaris","html_url":"https://github.com/andreaskaris","followers_url":"https://api.github.com/users/andreaskaris/followers","following_url":"https://api.github.com/users/andreaskaris/following{/other_user}","gists_url":"https://api.github.com/users/andreaskaris/gists{/gist_id}","starred_url":"https://api.github.com/users/andreaskaris/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andreaskaris/subscriptions","organizations_url":"https://api.github.com/users/andreaskaris/orgs","repos_url":"https://api.github.com/users/andreaskaris/repos","events_url":"https://api.github.com/users/andreaskaris/events{/privacy}","received_events_url":"https://api.github.com/users/andreaskaris/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":562692416,"node_id":"MDU6TGFiZWw1NjI2OTI0MTY=","url":"https://api.github.com/repos/helm/helm/labels/in%20progress","name":"in progress","color":"11DD11","default":false,"description":null},{"id":778135666,"node_id":"MDU6TGFiZWw3NzgxMzU2NjY=","url":"https://api.github.com/repos/helm/helm/labels/bug","name":"bug","color":"e11d21","default":true,"description":"Categorizes issue or PR as related to a bug."}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":16,"created_at":"2021-05-17T17:39:41Z","updated_at":"2025-06-24T11:59:31Z","closed_at":"2024-10-17T15:36:01Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"This is a direct consequence of https://github.com/kubernetes/kubernetes/issues/67761\r\n\r\nWhen helm gets a 409 Conflict, it will not retry:\r\nhttps://github.com/helm/helm/blob/51097a55f14f208e5382d730d85662580887976a/pkg/kube/client.go#L371\r\n\r\nHowever, as a sonsequence of https://github.com/kubernetes/kubernetes/issues/67761 and until that is fixed, helm should retry when it receives a `409` that's a result of a manipulation of kind `resourcequota` \r\n\r\nI am using an older version of OpenShift (4.6.17) with the latest helm built from this repository.\r\n\r\nIt does not happen a lot, but it does, and the following script helped me catch it. In https://github.com/kubernetes/kubernetes/issues/67761, they talked about how this would fail when installing gitlab, so I used that helm chart.\r\n\r\n~~~\r\ncat << 'FOE' > test_gitlab.sh\r\n#!/bin/bash\r\n\r\nfunction create_project() {\r\n    oc new-project gitlab || oc project gitlab\r\n    cat <<'EOF' | oc apply -f -\r\napiVersion: v1\r\nkind: ResourceQuota\r\nmetadata:\r\n  name: quota\r\nspec:\r\n  hard:\r\n    configmaps: \"62\"\r\n    limits.cpu: \"170\"\r\n    limits.memory: 260Gi\r\n    openshift.io/imagestreams: \"0\"\r\n    persistentvolumeclaims: \"50\"\r\n    pods: \"100\"\r\n    replicationcontrollers: \"50\"\r\n    requests.cpu: \"71\"\r\n    requests.memory: 205Gi\r\n    requests.storage: 350Gi\r\n    limits.cpu: \"71\"\r\n    limits.memory: 205Gi\r\n    requests.storage: 350Gi\r\n    resourcequotas: \"1\"\r\n    secrets: \"512\"\r\n    services: \"70\"\r\n    services.nodeports: \"5\"\r\nEOF\r\ncat <<'EOF' | oc apply -f -\r\napiVersion: v1\r\nkind: LimitRange\r\nmetadata:\r\n  name: cpu-limit-range\r\nspec:\r\n  limits:\r\n  - default:\r\n      memory: 256Mi\r\n      cpu: 125m\r\n    defaultRequest:\r\n      cpu: 125m\r\n      memory: 128Mi\r\n    type: Container\r\nEOF\r\n    oc adm policy add-scc-to-user privileged -z default\r\n    oc adm policy add-scc-to-user privileged -z gitlab-shared-secrets\r\n}\r\n\r\nfunction delete_project() {\r\n    oc project default\r\n    oc delete project gitlab\r\n    if [ \"$?\" != \"1\" ]; then\r\n        echo \"Sleeping for 60 seconds to give the project time to be deleted\"\r\n        sleep 60\r\n    fi\r\n}\r\n\r\nfunction install_gitlab() {\r\n    helm upgrade --debug --install gitlab gitlab/gitlab   --timeout 600s   --set global.hosts.domain=example.com   --set global.hosts.externalIP=10.10.10.10   --set certmanager-issuer.email=me@example.com\r\n    if [ \"$?\" == \"0\" ]; then\r\n        GREEN='\\033[0;32m'\r\n        NC='\\033[0m' # No Color\r\n        printf \"${GREEN}SUCCEED${NC}\\n\"\r\n    else\r\n        RED='\\033[0;31m'\r\n        NC='\\033[0m' # No Color\r\n        printf \"${RED}FAIL${NC}\\n\"\r\n\texit 1\r\n    fi\r\n}\r\n\r\nfunction uninstall_gitlab() {\r\n    helm uninstall gitlab\r\n}\r\n\r\ndelete_project\r\nwhile true; do \r\n    echo \"=== $(date) ===\"\r\n    echo \"=== Create project ===\"\r\n    create_project\r\n    echo \"=== Install gitlab ===\"\r\n    install_gitlab    \r\n    sleep 5\r\n    echo \"=== Uninstall gitlab ===\"\r\n    uninstall_gitlab\r\n    echo \"=== Delete project ===\"\r\n    delete_project\r\ndone\r\nFOE\r\nbash -x test_gitlab.sh 2>&1 | tee -a test_gitlab.log\r\n~~~\r\n\r\nI created a debug build of helm:\r\n~~~\r\n[akaris@linux helm]$ git diff |cat\r\ndiff --git a/pkg/kube/client.go b/pkg/kube/client.go\r\nindex 34079e7a..90388235 100644\r\n--- a/pkg/kube/client.go\r\n+++ b/pkg/kube/client.go\r\n@@ -120,7 +120,40 @@ func (c *Client) IsReachable() error {\r\n // Create creates Kubernetes resources specified in the resource list.\r\n func (c *Client) Create(resources ResourceList) (*Result, error) {\r\n \tc.Log(\"creating %d resource(s)\", len(resources))\r\n-\tif err := perform(resources, createResource); err != nil {\r\n+\r\n+\tcreateResourceLogger := func(info *resource.Info) error {\r\n+\t\tc.Log(\"Creating resource: {\" +\r\n+\t\t\t\"Time UnixNano: \" + fmt.Sprintf(\"%v\", time.Now().UnixNano()) + \", \" +\r\n+\t\t\t\"Name: \" + info.Name + \", \" +\r\n+\t\t\t\"Namespace: \" + info.Namespace + \", \" +\r\n+\t\t\t\"Source: \" + info.Source + \", \" +\r\n+\t\t\t\"ResourceVersion: \" + info.ResourceVersion +\r\n+\t\t\t\"}\")\r\n+\t\tj, err := json.Marshal(info.Object)\r\n+\t\tif err == nil {\r\n+\t\t\tc.Log(\"==> Object: \" + string(j))\r\n+\t\t} else {\r\n+\t\t\tc.Log(\"Could not marshal Name \" + info.Name + \" Namespace \" + info.Namespace)\r\n+\t\t}\r\n+\t\treturnErr := createResource(info)\r\n+\t\tif returnErr != nil {\r\n+\t\t\tc.Log(\r\n+\t\t\t\t\"FAILED Time UnixNano: \" + fmt.Sprintf(\"%v\", time.Now().UnixNano()) +\r\n+\t\t\t\t\t\" Name: \" + info.Name +\r\n+\t\t\t\t\t\", Namespace: \" + info.Namespace +\r\n+\t\t\t\t\t\", ERROR: \" + returnErr.Error(),\r\n+\t\t\t)\r\n+\t\t\terrJson, errErr := json.Marshal(returnErr)\r\n+\t\t\tif errErr == nil {\r\n+\t\t\t\tc.Log(\"==> ERROR JSON: \" + string(errJson))\r\n+\t\t\t} else {\r\n+\t\t\t\tc.Log(\"Could not marshal ERROR\")\r\n+\t\t\t}\r\n+\t\t}\r\n+\t\treturn returnErr\r\n+\t}\r\n+\r\n+\tif err := perform(resources, createResourceLogger); err != nil {\r\n \t\treturn nil, err\r\n \t}\r\n \treturn &Result{Created: resources}, nil\r\n~~~\r\n\r\nPlease find the output for a failed run attached. In helm, one should be able to work around this easily by retrying a `perform` if it returns a 409. Notwithstanding, the actual kubernetes issues here https://github.com/kubernetes/kubernetes/issues/67761 should be fixed instead of asking every client to fix this client side, but as far as  I can see, pending a solution on the kubernetes side, clients implement a retry to work around this.\r\n\r\n","closed_by":{"login":"mattfarina","id":62991,"node_id":"MDQ6VXNlcjYyOTkx","avatar_url":"https://avatars.githubusercontent.com/u/62991?v=4","gravatar_id":"","url":"https://api.github.com/users/mattfarina","html_url":"https://github.com/mattfarina","followers_url":"https://api.github.com/users/mattfarina/followers","following_url":"https://api.github.com/users/mattfarina/following{/other_user}","gists_url":"https://api.github.com/users/mattfarina/gists{/gist_id}","starred_url":"https://api.github.com/users/mattfarina/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mattfarina/subscriptions","organizations_url":"https://api.github.com/users/mattfarina/orgs","repos_url":"https://api.github.com/users/mattfarina/repos","events_url":"https://api.github.com/users/mattfarina/events{/privacy}","received_events_url":"https://api.github.com/users/mattfarina/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/helm/helm/issues/9710/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/helm/helm/issues/9710/timeline","performed_via_github_app":null,"state_reason":"completed"}