{"url":"https://api.github.com/repos/helm/helm/issues/7600","repository_url":"https://api.github.com/repos/helm/helm","labels_url":"https://api.github.com/repos/helm/helm/issues/7600/labels{/name}","comments_url":"https://api.github.com/repos/helm/helm/issues/7600/comments","events_url":"https://api.github.com/repos/helm/helm/issues/7600/events","html_url":"https://github.com/helm/helm/issues/7600","id":565618599,"node_id":"MDU6SXNzdWU1NjU2MTg1OTk=","number":7600,"title":"Charts cache is not resilient to running several Helm instances in parallel","user":{"login":"misha-ridge","id":39945810,"node_id":"MDQ6VXNlcjM5OTQ1ODEw","avatar_url":"https://avatars.githubusercontent.com/u/39945810?v=4","gravatar_id":"","url":"https://api.github.com/users/misha-ridge","html_url":"https://github.com/misha-ridge","followers_url":"https://api.github.com/users/misha-ridge/followers","following_url":"https://api.github.com/users/misha-ridge/following{/other_user}","gists_url":"https://api.github.com/users/misha-ridge/gists{/gist_id}","starred_url":"https://api.github.com/users/misha-ridge/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/misha-ridge/subscriptions","organizations_url":"https://api.github.com/users/misha-ridge/orgs","repos_url":"https://api.github.com/users/misha-ridge/repos","events_url":"https://api.github.com/users/misha-ridge/events{/privacy}","received_events_url":"https://api.github.com/users/misha-ridge/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":562687520,"node_id":"MDU6TGFiZWw1NjI2ODc1MjA=","url":"https://api.github.com/repos/helm/helm/labels/feature","name":"feature","color":"0052cc","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2020-02-15T00:06:26Z","updated_at":"2020-03-26T12:51:44Z","closed_at":"2020-03-26T12:51:44Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I have noticed the following failure in CI logs:\r\n\r\n```\r\nError: file '/var/lib/jenkins/workspace/Main builds/PR checks@2/_build/helm/cache/helm/repository/nginx-ingress-1.24.7.tgz' does not appear to be a gzipped archive; got 'application/octet-stream'\r\n```\r\n\r\nOur build system runs several `helm` commands in parallel. It appears that one of them tried to access the cached chart file while another was writing to it (checking timestamps in log files and on the filesystem supports this conclusion).\r\n\r\nIt looks like writing a chart file to a Helm cache is not atomic, and analysis of source code supports that: `ChartDownloader.DownloadTo` opens the target file and writes to it.\r\n\r\nI am going to submit a PR that makes sure that `ChartDownloader.DownloadTo` writes the file to the filesystem atomically (via temp file + rename), so `helm` will never see the partial file.\r\n\r\nOutput of `helm version`:\r\n\r\n```\r\nversion.BuildInfo{Version:\"v3.0.2\", GitCommit:\"19e47ee3283ae98139d98460de796c1be1e3975f\", GitTreeState:\"clean\", GoVersion:\"go1.13.5\"}\r\n```\r\n\r\nOutput of `kubectl version`:\r\n\r\n```\r\nClient Version: version.Info{Major:\"1\", Minor:\"15\", GitVersion:\"v1.15.5\", GitCommit:\"20c265fef0741dd71a66480e35bd69f18351daea\", GitTreeState:\"clean\", BuildDate:\"2019-10-15T19:16:51Z\", GoVersion:\"go1.12.10\", Compiler:\"gc\", Platform:\"darwin/amd64\"}\r\nServer Version: version.Info{Major:\"1\", Minor:\"13+\", GitVersion:\"v1.13.12-gke.25\", GitCommit:\"654de8cac69f1fc5db6f2de0b88d6d027bc15828\", GitTreeState:\"clean\", BuildDate:\"2020-01-14T06:01:20Z\", GoVersion:\"go1.12.11b4\", Compiler:\"gc\", Platform:\"linux/amd64\"}\r\n```\r\n\r\nCloud Provider/Platform (AKS, GKE, Minikube etc.):  GKE\r\n\r\n","closed_by":{"login":"hickeyma","id":14892004,"node_id":"MDQ6VXNlcjE0ODkyMDA0","avatar_url":"https://avatars.githubusercontent.com/u/14892004?v=4","gravatar_id":"","url":"https://api.github.com/users/hickeyma","html_url":"https://github.com/hickeyma","followers_url":"https://api.github.com/users/hickeyma/followers","following_url":"https://api.github.com/users/hickeyma/following{/other_user}","gists_url":"https://api.github.com/users/hickeyma/gists{/gist_id}","starred_url":"https://api.github.com/users/hickeyma/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hickeyma/subscriptions","organizations_url":"https://api.github.com/users/hickeyma/orgs","repos_url":"https://api.github.com/users/hickeyma/repos","events_url":"https://api.github.com/users/hickeyma/events{/privacy}","received_events_url":"https://api.github.com/users/hickeyma/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/helm/helm/issues/7600/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/helm/helm/issues/7600/timeline","performed_via_github_app":null,"state_reason":"completed"}