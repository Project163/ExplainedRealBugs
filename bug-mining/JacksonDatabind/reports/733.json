{"url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/4733","repository_url":"https://api.github.com/repos/FasterXML/jackson-databind","labels_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/4733/labels{/name}","comments_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/4733/comments","events_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/4733/events","html_url":"https://github.com/FasterXML/jackson-databind/issues/4733","id":2568948701,"node_id":"I_kwDOAC5e2c6ZHwvd","number":4733,"title":"Wrong serialization of Type Ids for certain types of Enum values","user":{"login":"nlisker","id":37422899,"node_id":"MDQ6VXNlcjM3NDIyODk5","avatar_url":"https://avatars.githubusercontent.com/u/37422899?v=4","gravatar_id":"","url":"https://api.github.com/users/nlisker","html_url":"https://github.com/nlisker","followers_url":"https://api.github.com/users/nlisker/followers","following_url":"https://api.github.com/users/nlisker/following{/other_user}","gists_url":"https://api.github.com/users/nlisker/gists{/gist_id}","starred_url":"https://api.github.com/users/nlisker/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nlisker/subscriptions","organizations_url":"https://api.github.com/users/nlisker/orgs","repos_url":"https://api.github.com/users/nlisker/repos","events_url":"https://api.github.com/users/nlisker/events{/privacy}","received_events_url":"https://api.github.com/users/nlisker/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":3895061927,"node_id":"LA_kwDOAC5e2c7oKe2n","url":"https://api.github.com/repos/FasterXML/jackson-databind/labels/enum","name":"enum","color":"A596C8","default":false,"description":"Related to handling of Enum values"},{"id":6636564281,"node_id":"LA_kwDOAC5e2c8AAAABi5HvOQ","url":"https://api.github.com/repos/FasterXML/jackson-databind/labels/2.18","name":"2.18","color":"1D76DB","default":false,"description":"Issues planned at 2.18 or later"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":10,"created_at":"2024-10-06T22:41:41Z","updated_at":"2024-11-05T01:28:59Z","closed_at":"2024-11-05T01:28:59Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Search before asking\r\n\r\n- [X] I searched in the [issues](https://github.com/FasterXML/jackson-databind/issues) and found nothing similar.\r\n\r\n### Describe the bug\r\n\r\nThis class serializes and deserializes enum constants. I assume that when serializing there should be enough info to deserialize it, and if deserialization fails, then it's a bug.\r\n\r\n```java\r\n@JsonTypeInfo(use = Id.___) // see values below\r\n@JsonSubTypes({\r\n\t@JsonSubTypes.Type(value = A.class),\r\n})\r\ninterface Inter {\r\n\r\n\tdefault void yes() {}\r\n\r\n\tenum A implements Inter {\r\n\t\r\n\t\tA1,\r\n\t\tA2 {\r\n\t\t\t@Override\r\n\t\t\tpublic void yes() {\r\n\t\t\t\t\r\n\t\t\t}\r\n\t\t},\r\n\t}\r\n}\r\n\r\npublic class Start {\r\n\r\n\tpublic static void main(String[] args) throws JsonProcessingException {\r\n\t\tJsonMapper MAPPER = JsonMapper.builder().build();\r\n\t\tvar string1 = MAPPER.writeValueAsString(Inter.A.A1);\r\n\t\tSystem.out.println(string1);\r\n\t\tvar string2 = MAPPER.writeValueAsString(Inter.A.A2);\r\n\t\tSystem.out.println(string2);\r\n\t\tA value1 = MAPPER.readValue(string1, Inter.A.class);\r\n\t\tSystem.out.println(value1);\r\n\t\tA value2 = MAPPER.readValue(string2, Inter.A.class);\r\n\t\tSystem.out.println(value2);\r\n\t}\r\n}\r\n```\r\n\r\nResults for `Id` values:\r\n\r\n**CLASS**\r\n```\r\n[\"example.Inter$A\",\"A1\"]\r\n[\"example.Inter$A\",\"A2\"]\r\nA1\r\nA2\r\n```\r\n\r\n**NONE**\r\n```\r\n\"A1\"\r\n\"A2\"\r\nA1\r\nA2\r\n```\r\n\r\n**MINIMAL_CLASS**\r\n```\r\n[\".Inter$A\",\"A1\"]\r\n[\".Inter$A$1\",\"A2\"]\r\nA1\r\nException in thread \"main\" com.fasterxml.jackson.databind.exc.InvalidDefinitionException: No enum constants for class example.Inter$A$1\r\n at [Source: REDACTED (`StreamReadFeature.INCLUDE_SOURCE_IN_LOCATION` disabled); line: 1, column: 15]\r\n\tat com.fasterxml.jackson.databind.exc.InvalidDefinitionException.from(InvalidDefinitionException.java:67)\r\n\tat com.fasterxml.jackson.databind.DeserializationContext.reportBadDefinition(DeserializationContext.java:1888)\r\n\tat com.fasterxml.jackson.databind.deser.DeserializerCache._createAndCache2(DeserializerCache.java:321)\r\n\tat com.fasterxml.jackson.databind.deser.DeserializerCache._createAndCacheValueDeserializer(DeserializerCache.java:284)\r\n\tat com.fasterxml.jackson.databind.deser.DeserializerCache.findValueDeserializer(DeserializerCache.java:174)\r\n\tat com.fasterxml.jackson.databind.DeserializationContext.findContextualValueDeserializer(DeserializationContext.java:636)\r\n\tat com.fasterxml.jackson.databind.jsontype.impl.TypeDeserializerBase._findDeserializer(TypeDeserializerBase.java:203)\r\n\tat com.fasterxml.jackson.databind.jsontype.impl.AsArrayTypeDeserializer._deserialize(AsArrayTypeDeserializer.java:100)\r\n\tat com.fasterxml.jackson.databind.jsontype.impl.AsArrayTypeDeserializer.deserializeTypedFromScalar(AsArrayTypeDeserializer.java:69)\r\n\tat com.fasterxml.jackson.databind.deser.std.StdScalarDeserializer.deserializeWithType(StdScalarDeserializer.java:66)\r\n\tat com.fasterxml.jackson.databind.deser.impl.TypeWrappedDeserializer.deserialize(TypeWrappedDeserializer.java:74)\r\n\tat com.fasterxml.jackson.databind.deser.DefaultDeserializationContext.readRootValue(DefaultDeserializationContext.java:342)\r\n\tat com.fasterxml.jackson.databind.ObjectMapper._readMapAndClose(ObjectMapper.java:4917)\r\n\tat com.fasterxml.jackson.databind.ObjectMapper.readValue(ObjectMapper.java:3860)\r\n\tat com.fasterxml.jackson.databind.ObjectMapper.readValue(ObjectMapper.java:3828)\r\n\tat example.Start.main(Start.java:41)\r\n```\r\n\r\n**NAME**\r\n```\r\n[\"Inter$A\",\"A1\"]\r\n[\"Inter$A$1\",\"A2\"]\r\nA1\r\nException in thread \"main\" com.fasterxml.jackson.databind.exc.InvalidTypeIdException: Could not resolve type id 'Inter$A$1' as a subtype of `example.Inter$A`: known type ids = [Inter$A]\r\n at [Source: REDACTED (`StreamReadFeature.INCLUDE_SOURCE_IN_LOCATION` disabled); line: 1, column: 14]\r\n\tat com.fasterxml.jackson.databind.exc.InvalidTypeIdException.from(InvalidTypeIdException.java:43)\r\n\tat com.fasterxml.jackson.databind.DeserializationContext.invalidTypeIdException(DeserializationContext.java:2041)\r\n\tat com.fasterxml.jackson.databind.DeserializationContext.handleUnknownTypeId(DeserializationContext.java:1590)\r\n\tat com.fasterxml.jackson.databind.jsontype.impl.TypeDeserializerBase._handleUnknownTypeId(TypeDeserializerBase.java:300)\r\n\tat com.fasterxml.jackson.databind.jsontype.impl.TypeDeserializerBase._findDeserializer(TypeDeserializerBase.java:165)\r\n\tat com.fasterxml.jackson.databind.jsontype.impl.AsArrayTypeDeserializer._deserialize(AsArrayTypeDeserializer.java:100)\r\n\tat com.fasterxml.jackson.databind.jsontype.impl.AsArrayTypeDeserializer.deserializeTypedFromScalar(AsArrayTypeDeserializer.java:69)\r\n\tat com.fasterxml.jackson.databind.deser.std.StdScalarDeserializer.deserializeWithType(StdScalarDeserializer.java:66)\r\n\tat com.fasterxml.jackson.databind.deser.impl.TypeWrappedDeserializer.deserialize(TypeWrappedDeserializer.java:74)\r\n\tat com.fasterxml.jackson.databind.deser.DefaultDeserializationContext.readRootValue(DefaultDeserializationContext.java:342)\r\n\tat com.fasterxml.jackson.databind.ObjectMapper._readMapAndClose(ObjectMapper.java:4917)\r\n\tat com.fasterxml.jackson.databind.ObjectMapper.readValue(ObjectMapper.java:3860)\r\n\tat com.fasterxml.jackson.databind.ObjectMapper.readValue(ObjectMapper.java:3828)\r\n\tat example.Start.main(Start.java:41)\r\n```\r\n\r\n**SIMPLE_NAME**\r\n```\r\n[\"A\",\"A1\"]\r\n[\"1\",\"A2\"] <--- serializing as 1 looks especially wrong since it strips out the A$\r\nA1\r\nException in thread \"main\" com.fasterxml.jackson.databind.exc.InvalidTypeIdException: Could not resolve type id '1' as a subtype of `example.Inter$A`: known type ids = [A]\r\n at [Source: REDACTED (`StreamReadFeature.INCLUDE_SOURCE_IN_LOCATION` disabled); line: 1, column: 6]\r\n\tat com.fasterxml.jackson.databind.exc.InvalidTypeIdException.from(InvalidTypeIdException.java:43)\r\n\tat com.fasterxml.jackson.databind.DeserializationContext.invalidTypeIdException(DeserializationContext.java:2041)\r\n\tat com.fasterxml.jackson.databind.DeserializationContext.handleUnknownTypeId(DeserializationContext.java:1590)\r\n\tat com.fasterxml.jackson.databind.jsontype.impl.TypeDeserializerBase._handleUnknownTypeId(TypeDeserializerBase.java:300)\r\n\tat com.fasterxml.jackson.databind.jsontype.impl.TypeDeserializerBase._findDeserializer(TypeDeserializerBase.java:165)\r\n\tat com.fasterxml.jackson.databind.jsontype.impl.AsArrayTypeDeserializer._deserialize(AsArrayTypeDeserializer.java:100)\r\n\tat com.fasterxml.jackson.databind.jsontype.impl.AsArrayTypeDeserializer.deserializeTypedFromScalar(AsArrayTypeDeserializer.java:69)\r\n\tat com.fasterxml.jackson.databind.deser.std.StdScalarDeserializer.deserializeWithType(StdScalarDeserializer.java:66)\r\n\tat com.fasterxml.jackson.databind.deser.impl.TypeWrappedDeserializer.deserialize(TypeWrappedDeserializer.java:74)\r\n\tat com.fasterxml.jackson.databind.deser.DefaultDeserializationContext.readRootValue(DefaultDeserializationContext.java:342)\r\n\tat com.fasterxml.jackson.databind.ObjectMapper._readMapAndClose(ObjectMapper.java:4917)\r\n\tat com.fasterxml.jackson.databind.ObjectMapper.readValue(ObjectMapper.java:3860)\r\n\tat com.fasterxml.jackson.databind.ObjectMapper.readValue(ObjectMapper.java:3828)\r\n\tat example.Start.main(Start.java:41)\r\n```\r\n\r\n**DEDUCTION**\r\n```\r\n\"A1\"\r\n\"A2\"\r\nException in thread \"main\" com.fasterxml.jackson.databind.exc.MismatchedInputException: Unexpected token (VALUE_STRING), expected START_ARRAY: need Array value to contain `As.WRAPPER_ARRAY` type information for class example.Inter$A\r\n at [Source: REDACTED (`StreamReadFeature.INCLUDE_SOURCE_IN_LOCATION` disabled); line: 1, column: 1]\r\n\tat com.fasterxml.jackson.databind.exc.MismatchedInputException.from(MismatchedInputException.java:59)\r\n\tat com.fasterxml.jackson.databind.DeserializationContext.wrongTokenException(DeserializationContext.java:1914)\r\n\tat com.fasterxml.jackson.databind.DeserializationContext.reportWrongTokenException(DeserializationContext.java:1699)\r\n\tat com.fasterxml.jackson.databind.jsontype.impl.AsArrayTypeDeserializer._locateTypeId(AsArrayTypeDeserializer.java:150)\r\n\tat com.fasterxml.jackson.databind.jsontype.impl.AsArrayTypeDeserializer._deserialize(AsArrayTypeDeserializer.java:99)\r\n\tat com.fasterxml.jackson.databind.jsontype.impl.AsArrayTypeDeserializer.deserializeTypedFromScalar(AsArrayTypeDeserializer.java:69)\r\n\tat com.fasterxml.jackson.databind.deser.std.StdScalarDeserializer.deserializeWithType(StdScalarDeserializer.java:66)\r\n\tat com.fasterxml.jackson.databind.deser.impl.TypeWrappedDeserializer.deserialize(TypeWrappedDeserializer.java:74)\r\n\tat com.fasterxml.jackson.databind.deser.DefaultDeserializationContext.readRootValue(DefaultDeserializationContext.java:342)\r\n\tat com.fasterxml.jackson.databind.ObjectMapper._readMapAndClose(ObjectMapper.java:4917)\r\n\tat com.fasterxml.jackson.databind.ObjectMapper.readValue(ObjectMapper.java:3860)\r\n\tat com.fasterxml.jackson.databind.ObjectMapper.readValue(ObjectMapper.java:3828)\r\n\tat example.Start.main(Start.java:39)\r\n```\r\n\r\nI'm not sure what is considered correct behavior. Except for `DEDUCTION`, I would assume they should all pass.\r\n\r\n### Version Information\r\n\r\n2.18.0\r\n2.17.2","closed_by":{"login":"cowtowncoder","id":55065,"node_id":"MDQ6VXNlcjU1MDY1","avatar_url":"https://avatars.githubusercontent.com/u/55065?v=4","gravatar_id":"","url":"https://api.github.com/users/cowtowncoder","html_url":"https://github.com/cowtowncoder","followers_url":"https://api.github.com/users/cowtowncoder/followers","following_url":"https://api.github.com/users/cowtowncoder/following{/other_user}","gists_url":"https://api.github.com/users/cowtowncoder/gists{/gist_id}","starred_url":"https://api.github.com/users/cowtowncoder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cowtowncoder/subscriptions","organizations_url":"https://api.github.com/users/cowtowncoder/orgs","repos_url":"https://api.github.com/users/cowtowncoder/repos","events_url":"https://api.github.com/users/cowtowncoder/events{/privacy}","received_events_url":"https://api.github.com/users/cowtowncoder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/4733/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/4733/timeline","performed_via_github_app":null,"state_reason":"completed"}