{"url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/3045","repository_url":"https://api.github.com/repos/FasterXML/jackson-databind","labels_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/3045/labels{/name}","comments_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/3045/comments","events_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/3045/events","html_url":"https://github.com/FasterXML/jackson-databind/issues/3045","id":801998141,"node_id":"MDU6SXNzdWU4MDE5OTgxNDE=","number":3045,"title":"Bug in polymorphic deserialization with `@JsonCreator`, `@JsonAnySetter`, `JsonTypeInfo.As.EXTERNAL_PROPERTY`","user":{"login":"martineaus83","id":78589770,"node_id":"MDQ6VXNlcjc4NTg5Nzcw","avatar_url":"https://avatars.githubusercontent.com/u/78589770?v=4","gravatar_id":"","url":"https://api.github.com/users/martineaus83","html_url":"https://github.com/martineaus83","followers_url":"https://api.github.com/users/martineaus83/followers","following_url":"https://api.github.com/users/martineaus83/following{/other_user}","gists_url":"https://api.github.com/users/martineaus83/gists{/gist_id}","starred_url":"https://api.github.com/users/martineaus83/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martineaus83/subscriptions","organizations_url":"https://api.github.com/users/martineaus83/orgs","repos_url":"https://api.github.com/users/martineaus83/repos","events_url":"https://api.github.com/users/martineaus83/events{/privacy}","received_events_url":"https://api.github.com/users/martineaus83/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/FasterXML/jackson-databind/milestones/128","html_url":"https://github.com/FasterXML/jackson-databind/milestone/128","labels_url":"https://api.github.com/repos/FasterXML/jackson-databind/milestones/128/labels","id":6359554,"node_id":"MDk6TWlsZXN0b25lNjM1OTU1NA==","number":128,"title":"2.12.2","description":"Released on 03-Mar-2021. Release notes: https://github.com/FasterXML/jackson/wiki/Jackson-Release-2.12.2","creator":{"login":"cowtowncoder","id":55065,"node_id":"MDQ6VXNlcjU1MDY1","avatar_url":"https://avatars.githubusercontent.com/u/55065?v=4","gravatar_id":"","url":"https://api.github.com/users/cowtowncoder","html_url":"https://github.com/cowtowncoder","followers_url":"https://api.github.com/users/cowtowncoder/followers","following_url":"https://api.github.com/users/cowtowncoder/following{/other_user}","gists_url":"https://api.github.com/users/cowtowncoder/gists{/gist_id}","starred_url":"https://api.github.com/users/cowtowncoder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cowtowncoder/subscriptions","organizations_url":"https://api.github.com/users/cowtowncoder/orgs","repos_url":"https://api.github.com/users/cowtowncoder/repos","events_url":"https://api.github.com/users/cowtowncoder/events{/privacy}","received_events_url":"https://api.github.com/users/cowtowncoder/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":13,"state":"closed","created_at":"2021-01-27T17:56:09Z","updated_at":"2021-03-04T04:00:28Z","due_on":"2021-03-03T08:00:00Z","closed_at":"2021-03-04T03:56:28Z"},"comments":3,"created_at":"2021-02-05T09:22:40Z","updated_at":"2021-02-20T02:54:33Z","closed_at":"2021-02-20T02:54:33Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I'm using Jackson for a while in simply way. I've just tried some more difficult tricks and I found a strange behaviour. \r\n\r\nWhen I've combined JsonCreator annotation with a JsonTypeInfo.As.EXTERNAL_PROPERTY resolver, then the result is not the same than if I had not put the @JsonCreator. \r\n\r\nMy example is simple : I want to deserialize this String :\r\n\r\n```\r\n{ \"time\":345,\r\n  \"type\":\"track\",\r\n  \"data\":{\"data-internal\":\"toto\"}\r\n}\r\n```\r\n\r\nMy classes are\r\n```\r\n\r\n\tpublic static class MyData {\r\n\t\t@JsonAnySetter\r\n\t\tpublic HashMap data = new HashMap();\r\n\t\t@Override\r\n\t\tpublic String toString() {\r\n\t\t\tStringBuilder buf = new StringBuilder();\r\n\t\t\tbuf.append(\"[\");\r\n\t\t\tSet<Entry> entrySet = data.entrySet();\r\n\t\t\tfor (Entry e : entrySet) {\r\n\t\t\t\tbuf.append(\"[\").append(e.getKey()).append(\"=\").append(e.getValue()).append(\"]\");\r\n\t\t\t}\r\n\t\t\tbuf.append(\"]\");\r\n\t\t\treturn buf.toString();\r\n\t\t}\r\n\t}\r\n\r\n\tpublic static class MyJson {\r\n\t\tprivate long time;\r\n\t\tprivate String type;\r\n\t\tprivate Object data;\r\n\r\n\t\tpublic MyJson() {\r\n\t\t}\r\n\t\tpublic long getTime() {\r\n\t\t\treturn time;\r\n\t\t}\r\n\t\tpublic void setTime(long time) {\r\n\t\t\tthis.time = time;\r\n\t\t}\r\n\t\tpublic String getType() {\r\n\t\t\treturn type;\r\n\t\t}\r\n\t\tpublic void setType(String type) {\r\n\t\t\tthis.type = type;\r\n\t\t}\r\n\t\tpublic Object getData() {\r\n\t\t\treturn data;\r\n\t\t}\r\n\t\t@JsonTypeInfo(use = JsonTypeInfo.Id.CLASS, include = JsonTypeInfo.As.EXTERNAL_PROPERTY, property = \"type\")\r\n\t\t@JsonTypeIdResolver(ChildBaseByParentTypeResolver.class)\r\n\t\tpublic void setData(Object data) {\r\n\t\t\tthis.data = data;\r\n\t\t}\r\n\t}\r\n\r\n\tpublic static class MyJson2 {\r\n\t\tprivate final long time;\r\n\t\tprivate String type;\r\n\t\tprivate Object data;\r\n\r\n\t\t@JsonCreator\r\n\t\tpublic MyJson2(@JsonProperty(\"time\") long t) {\r\n\t\t\tSystem.out.println(\"MyJson2<init>\");\r\n\t\t\ttime = t;\r\n\t\t}\r\n\t\tpublic long getTime() {\r\n\t\t\treturn time;\r\n\t\t}\r\n\t\tpublic String getType() {\r\n\t\t\treturn type;\r\n\t\t}\r\n\t\tpublic void setType(String type) {\r\n\t\t\tthis.type = type;\r\n\t\t}\r\n\t\tpublic Object getData() {\r\n\t\t\treturn data;\r\n\t\t}\r\n\t\t@JsonTypeInfo(use = JsonTypeInfo.Id.CLASS, include = JsonTypeInfo.As.EXTERNAL_PROPERTY, property = \"type\")\r\n\t\t@JsonTypeIdResolver(ChildBaseByParentTypeResolver.class)\r\n\t\tpublic void setData(Object data) {\r\n\t\t\tthis.data = data;\r\n\t\t}\r\n\t}\r\n\r\n```\r\nWhen I launch the the two deserialization, I have the next results \r\n\r\n```\r\ncontent = {\"time\":345,\"type\":\"track\",\"data\":{\"data-internal\":\"toto\"}}\r\nMyJson result\r\ntime=345\r\ntype=track\r\ndata=class com.navalgroup.sdms.ac.model.impl.test.TestDeserialisation$MyData ; [[data-internal=toto]]\r\n\r\nMyJson2 result\r\ntime=345\r\ntype=null\r\ndata=null\r\n\r\n```\r\n\r\nWhen I've got the sources and I've tried to debug the unexpected MyJson2 result, I've lost myself in BeanDeserializer.deserializeUsingPropertyBasedWithExternalTypeId. The Json datas seem to be put in TokenBuffer which doesn't seem used.\r\n\r\nI attached a fully executed Java File with my test classes.\r\n[TestDeserialisation.zip](https://github.com/FasterXML/jackson-databind/files/5931364/TestDeserialisation.zip)\r\n\r\nThanks for your attention","closed_by":{"login":"cowtowncoder","id":55065,"node_id":"MDQ6VXNlcjU1MDY1","avatar_url":"https://avatars.githubusercontent.com/u/55065?v=4","gravatar_id":"","url":"https://api.github.com/users/cowtowncoder","html_url":"https://github.com/cowtowncoder","followers_url":"https://api.github.com/users/cowtowncoder/followers","following_url":"https://api.github.com/users/cowtowncoder/following{/other_user}","gists_url":"https://api.github.com/users/cowtowncoder/gists{/gist_id}","starred_url":"https://api.github.com/users/cowtowncoder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cowtowncoder/subscriptions","organizations_url":"https://api.github.com/users/cowtowncoder/orgs","repos_url":"https://api.github.com/users/cowtowncoder/repos","events_url":"https://api.github.com/users/cowtowncoder/events{/privacy}","received_events_url":"https://api.github.com/users/cowtowncoder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/3045/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/3045/timeline","performed_via_github_app":null,"state_reason":"completed"}