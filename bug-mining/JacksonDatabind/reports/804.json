{"url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/4656","repository_url":"https://api.github.com/repos/FasterXML/jackson-databind","labels_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/4656/labels{/name}","comments_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/4656/comments","events_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/4656/events","html_url":"https://github.com/FasterXML/jackson-databind/issues/4656","id":2451369154,"node_id":"I_kwDOAC5e2c6SHOzC","number":4656,"title":"`DeserializationProblemHandler.handleUnexpectedToken()` cast Object to String","user":{"login":"yacine-pc","id":77629406,"node_id":"MDQ6VXNlcjc3NjI5NDA2","avatar_url":"https://avatars.githubusercontent.com/u/77629406?v=4","gravatar_id":"","url":"https://api.github.com/users/yacine-pc","html_url":"https://github.com/yacine-pc","followers_url":"https://api.github.com/users/yacine-pc/followers","following_url":"https://api.github.com/users/yacine-pc/following{/other_user}","gists_url":"https://api.github.com/users/yacine-pc/gists{/gist_id}","starred_url":"https://api.github.com/users/yacine-pc/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yacine-pc/subscriptions","organizations_url":"https://api.github.com/users/yacine-pc/orgs","repos_url":"https://api.github.com/users/yacine-pc/repos","events_url":"https://api.github.com/users/yacine-pc/events{/privacy}","received_events_url":"https://api.github.com/users/yacine-pc/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":2457821256,"node_id":"MDU6TGFiZWwyNDU3ODIxMjU2","url":"https://api.github.com/repos/FasterXML/jackson-databind/labels/has-failing-test","name":"has-failing-test","color":"4e8a16","default":false,"description":"Indicates that there exists a test case (under `failing/`) to reproduce the issue"},{"id":8506095424,"node_id":"LA_kwDOAC5e2c8AAAAB-wC3QA","url":"https://api.github.com/repos/FasterXML/jackson-databind/labels/2.20","name":"2.20","color":"1D76DB","default":false,"description":"Issues planned at 2.20 or later"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/FasterXML/jackson-databind/milestones/181","html_url":"https://github.com/FasterXML/jackson-databind/milestone/181","labels_url":"https://api.github.com/repos/FasterXML/jackson-databind/milestones/181/labels","id":12791387,"node_id":"MI_kwDOAC5e2c4Awy5b","number":181,"title":"2.20.0","description":null,"creator":{"login":"cowtowncoder","id":55065,"node_id":"MDQ6VXNlcjU1MDY1","avatar_url":"https://avatars.githubusercontent.com/u/55065?v=4","gravatar_id":"","url":"https://api.github.com/users/cowtowncoder","html_url":"https://github.com/cowtowncoder","followers_url":"https://api.github.com/users/cowtowncoder/followers","following_url":"https://api.github.com/users/cowtowncoder/following{/other_user}","gists_url":"https://api.github.com/users/cowtowncoder/gists{/gist_id}","starred_url":"https://api.github.com/users/cowtowncoder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cowtowncoder/subscriptions","organizations_url":"https://api.github.com/users/cowtowncoder/orgs","repos_url":"https://api.github.com/users/cowtowncoder/repos","events_url":"https://api.github.com/users/cowtowncoder/events{/privacy}","received_events_url":"https://api.github.com/users/cowtowncoder/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":18,"state":"closed","created_at":"2025-04-26T00:26:36Z","updated_at":"2025-10-30T23:28:38Z","due_on":null,"closed_at":"2025-10-30T23:28:38Z"},"comments":6,"created_at":"2024-08-06T17:27:14Z","updated_at":"2025-05-18T04:21:52Z","closed_at":"2025-05-18T03:20:56Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Search before asking\n\n- [X] I searched in the [issues](https://github.com/FasterXML/jackson-databind/issues) and found nothing similar.\n\n### Describe the bug\n\nI am currently migrating from Jackson version 2.10.0 to 2.15.1 and I seem to be encountering a bug. When attempting to deserialize JSON into a POJO, a JsonMappingException (Cf. Stacktrace below) is thrown for the age field in the simplified code snippet provided below. The same code works perfectly with version 2.10.0.\r\n\n\n### Version Information\n\n2.15.2\n\n### Reproduction\n\n```\r\nimport com.fasterxml.jackson.core.JsonParser;\r\nimport com.fasterxml.jackson.core.JsonProcessingException;\r\nimport com.fasterxml.jackson.core.JsonToken;\r\nimport com.fasterxml.jackson.databind.DeserializationContext;\r\nimport com.fasterxml.jackson.databind.JavaType;\r\nimport com.fasterxml.jackson.databind.JsonNode;\r\nimport com.fasterxml.jackson.databind.ObjectMapper;\r\nimport com.fasterxml.jackson.databind.deser.DeserializationProblemHandler;\r\n\r\nimport java.io.IOException;\r\n\r\nclass Person {\r\n    public String id;\r\n    public String name;\r\n    public Long age;\r\n}\r\n\r\nclass MongoTypeProblemHandler extends DeserializationProblemHandler {\r\n    protected static final String NUMBER_LONG_KEY = \"$numberLong\";\r\n\r\n    @Override\r\n    public Object handleUnexpectedToken(DeserializationContext ctxt, JavaType targetType, JsonToken t, JsonParser p, String failureMsg) throws IOException {\r\n        if (targetType.getRawClass().equals(Long.class) && JsonToken.START_OBJECT.equals(t)) {\r\n            JsonNode tree = p.readValueAsTree();\r\n            if (tree.get(NUMBER_LONG_KEY) != null) {\r\n                try {\r\n                    return Long.parseLong(tree.get(NUMBER_LONG_KEY).asText());\r\n                } catch (NumberFormatException e) {\r\n                }\r\n            }\r\n        }\r\n        return NOT_HANDLED;\r\n    }\r\n}\r\n\r\npublic class Main {\r\n    public static void main(String[] args) {\r\n        String json = \"{\\\"id\\\":  \\\"12ab\\\", \\\"name\\\": \\\"Bob\\\", \\\"age\\\": {\\\"$numberLong\\\": \\\"10\\\"}}\";\r\n\r\n        ObjectMapper objectMapper = new ObjectMapper();\r\n        objectMapper.addHandler(new MongoTypeProblemHandler());\r\n        try {\r\n            Person person = objectMapper.readValue(json, Person.class);\r\n            System.out.println(\"id:\" + person.id);\r\n            System.out.println(\"name:\" + person.name);\r\n            System.out.println(\"age:\" + person.age);\r\n        } catch (JsonProcessingException e) {\r\n            throw new RuntimeException(e);\r\n        }\r\n\r\n    }\r\n}\r\n```\r\n\n\n### Expected behavior\n\nIt should deserialize the JSON to POJO like version 2.10.0 for example\n\n### Additional context\n\nException in thread \"main\" java.lang.RuntimeException: com.fasterxml.jackson.databind.JsonMappingException: class java.lang.Long cannot be cast to class java.lang.String (java.lang.Long and java.lang.String are in module java.base of loader 'bootstrap') (through reference chain: org.example.Person[\"age\"])\r\n\tat org.example.Main.main(Main.java:50)\r\nCaused by: com.fasterxml.jackson.databind.JsonMappingException: class java.lang.Long cannot be cast to class java.lang.String (java.lang.Long and java.lang.String are in module java.base of loader 'bootstrap') (through reference chain: org.example.Person[\"age\"])\r\n\tat com.fasterxml.jackson.databind.JsonMappingException.wrapWithPath(JsonMappingException.java:402)\r\n\tat com.fasterxml.jackson.databind.JsonMappingException.wrapWithPath(JsonMappingException.java:361)\r\n\tat com.fasterxml.jackson.databind.deser.BeanDeserializerBase.wrapAndThrow(BeanDeserializerBase.java:1853)\r\n\tat com.fasterxml.jackson.databind.deser.BeanDeserializer.vanillaDeserialize(BeanDeserializer.java:316)\r\n\tat com.fasterxml.jackson.databind.deser.BeanDeserializer.deserialize(BeanDeserializer.java:177)\r\n\tat com.fasterxml.jackson.databind.deser.DefaultDeserializationContext.readRootValue(DefaultDeserializationContext.java:323)\r\n\tat com.fasterxml.jackson.databind.ObjectMapper._readMapAndClose(ObjectMapper.java:4825)\r\n\tat com.fasterxml.jackson.databind.ObjectMapper.readValue(ObjectMapper.java:3772)\r\n\tat com.fasterxml.jackson.databind.ObjectMapper.readValue(ObjectMapper.java:3740)\r\n\tat org.example.Main.main(Main.java:45)\r\nCaused by: java.lang.ClassCastException: class java.lang.Long cannot be cast to class java.lang.String (java.lang.Long and java.lang.String are in module java.base of loader 'bootstrap')\r\n\tat com.fasterxml.jackson.databind.DeserializationContext.extractScalarFromObject(DeserializationContext.java:943)\r\n\tat com.fasterxml.jackson.databind.deser.std.StdDeserializer._parseLong(StdDeserializer.java:949)\r\n\tat com.fasterxml.jackson.databind.deser.std.NumberDeserializers$LongDeserializer.deserialize(NumberDeserializers.java:575)\r\n\tat com.fasterxml.jackson.databind.deser.std.NumberDeserializers$LongDeserializer.deserialize(NumberDeserializers.java:550)\r\n\tat com.fasterxml.jackson.databind.deser.impl.FieldProperty.deserializeAndSet(FieldProperty.java:138)\r\n\tat com.fasterxml.jackson.databind.deser.BeanDeserializer.vanillaDeserialize(BeanDeserializer.java:314)\r\n\t... 6 more","closed_by":{"login":"cowtowncoder","id":55065,"node_id":"MDQ6VXNlcjU1MDY1","avatar_url":"https://avatars.githubusercontent.com/u/55065?v=4","gravatar_id":"","url":"https://api.github.com/users/cowtowncoder","html_url":"https://github.com/cowtowncoder","followers_url":"https://api.github.com/users/cowtowncoder/followers","following_url":"https://api.github.com/users/cowtowncoder/following{/other_user}","gists_url":"https://api.github.com/users/cowtowncoder/gists{/gist_id}","starred_url":"https://api.github.com/users/cowtowncoder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cowtowncoder/subscriptions","organizations_url":"https://api.github.com/users/cowtowncoder/orgs","repos_url":"https://api.github.com/users/cowtowncoder/repos","events_url":"https://api.github.com/users/cowtowncoder/events{/privacy}","received_events_url":"https://api.github.com/users/cowtowncoder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/4656/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/4656/timeline","performed_via_github_app":null,"state_reason":"completed"}