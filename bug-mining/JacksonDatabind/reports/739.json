{"url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/4680","repository_url":"https://api.github.com/repos/FasterXML/jackson-databind","labels_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/4680/labels{/name}","comments_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/4680/comments","events_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/4680/events","html_url":"https://github.com/FasterXML/jackson-databind/issues/4680","id":2489571391,"node_id":"I_kwDOAC5e2c6UY9g_","number":4680,"title":"Custom key deserialiser registered for `Object.class` in nested Map object is ignored when Map key type not defined","user":{"login":"devdanylo","id":26978790,"node_id":"MDQ6VXNlcjI2OTc4Nzkw","avatar_url":"https://avatars.githubusercontent.com/u/26978790?v=4","gravatar_id":"","url":"https://api.github.com/users/devdanylo","html_url":"https://github.com/devdanylo","followers_url":"https://api.github.com/users/devdanylo/followers","following_url":"https://api.github.com/users/devdanylo/following{/other_user}","gists_url":"https://api.github.com/users/devdanylo/gists{/gist_id}","starred_url":"https://api.github.com/users/devdanylo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/devdanylo/subscriptions","organizations_url":"https://api.github.com/users/devdanylo/orgs","repos_url":"https://api.github.com/users/devdanylo/repos","events_url":"https://api.github.com/users/devdanylo/events{/privacy}","received_events_url":"https://api.github.com/users/devdanylo/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":7098892157,"node_id":"LA_kwDOAC5e2c8AAAABpyB_fQ","url":"https://api.github.com/repos/FasterXML/jackson-databind/labels/2.19","name":"2.19","color":"1D76DB","default":false,"description":"Issues planned at 2.19 or later"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":12,"created_at":"2024-08-27T14:36:03Z","updated_at":"2024-11-05T05:25:31Z","closed_at":"2024-11-05T05:13:20Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Search before asking\r\n\r\n- [X] I searched in the [issues](https://github.com/FasterXML/jackson-databind/issues) and found nothing similar.\r\n\r\n### Describe the bug\r\n\r\nI'm working on a piece of software which accepts arbitrary JSON, flattens it, and then writes it to CSV. The main issue here is that we don't know the schema of the JSONâ€”it can be anything. This, in turn, results in untyped deserialization.\r\n\r\nBefore starting processing of the parsed object, the field names must be sanitised (yes, it's crucial to sanitise the field names during the parsing phase). Unfortunately `UntypedObjectDeserializerNR` ignores the custom key deserialiser I'm trying to provide:\r\n\r\n```java\r\npackage libraries;\r\n\r\nimport com.fasterxml.jackson.databind.DeserializationContext;\r\nimport com.fasterxml.jackson.databind.KeyDeserializer;\r\nimport com.fasterxml.jackson.databind.ObjectMapper;\r\nimport com.fasterxml.jackson.databind.module.SimpleModule;\r\nimport org.junit.jupiter.api.Assertions;\r\nimport org.junit.jupiter.api.Test;\r\n\r\nimport java.util.Map;\r\n\r\npublic class ObjectMapperTest {\r\n\r\n    @Test\r\n    void customKeyDeserializerShouldBeUsedWhenTypeNotDefined() throws Exception {\r\n        // given\r\n        var json = \"\"\"\r\n                {\r\n                    \"name*\": \"Erik\",\r\n                    \"address*\": {\r\n                        \"city*\": {\r\n                            \"id*\": 1,\r\n                            \"name*\": \"Berlin\"\r\n                        },\r\n                        \"street*\": \"Elvirastr\"\r\n                    }\r\n                }\r\n                                \r\n                \"\"\";\r\n\r\n        var objectMapper = new ObjectMapper();\r\n        var keySanitizationModule = new SimpleModule(\"key-sanitization\");\r\n        keySanitizationModule.addKeyDeserializer(String.class, new KeyDeserializer() {\r\n            @Override\r\n            public Object deserializeKey(String key, DeserializationContext ctxt) {\r\n                return key.replace(\"*\", \"_\");\r\n            }\r\n        });\r\n        objectMapper.registerModule(keySanitizationModule);\r\n\r\n        // when\r\n        var result = objectMapper.readValue(json, Object.class);\r\n\r\n        // then\r\n        Assertions.assertEquals(\"Erik\", ((Map<String, Object>) result).get(\"name_\"));\r\n\r\n        var addressMap = (Map<String, Object>) ((Map<String, Object>) result).get(\"address_\");\r\n        Assertions.assertEquals(\"Elvirastr\", addressMap.get(\"street_\"));\r\n\r\n        var cityMap = (Map<String, Object>) addressMap.get(\"city_\");\r\n        Assertions.assertEquals(1, cityMap.get(\"id_\"));\r\n        Assertions.assertEquals(\"Berlin\", cityMap.get(\"name_\"));\r\n    }\r\n}\r\n```\r\n\r\nI have 2 questions in regards of this behaviour: \r\n1. Is that something expected?\r\n2. Is there a workaround for the problem in question?\r\n\r\n### Version Information\r\n\r\n2.14.3\r\n\r\n### Reproduction\r\n\r\n_No response_\r\n\r\n### Expected behavior\r\n\r\n_No response_\r\n\r\n### Additional context\r\n\r\n_No response_","closed_by":{"login":"cowtowncoder","id":55065,"node_id":"MDQ6VXNlcjU1MDY1","avatar_url":"https://avatars.githubusercontent.com/u/55065?v=4","gravatar_id":"","url":"https://api.github.com/users/cowtowncoder","html_url":"https://github.com/cowtowncoder","followers_url":"https://api.github.com/users/cowtowncoder/followers","following_url":"https://api.github.com/users/cowtowncoder/following{/other_user}","gists_url":"https://api.github.com/users/cowtowncoder/gists{/gist_id}","starred_url":"https://api.github.com/users/cowtowncoder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cowtowncoder/subscriptions","organizations_url":"https://api.github.com/users/cowtowncoder/orgs","repos_url":"https://api.github.com/users/cowtowncoder/repos","events_url":"https://api.github.com/users/cowtowncoder/events{/privacy}","received_events_url":"https://api.github.com/users/cowtowncoder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/4680/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/4680/timeline","performed_via_github_app":null,"state_reason":"completed"}