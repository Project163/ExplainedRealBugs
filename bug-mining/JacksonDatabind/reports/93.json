{"url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/676","repository_url":"https://api.github.com/repos/FasterXML/jackson-databind","labels_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/676/labels{/name}","comments_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/676/comments","events_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/676/events","html_url":"https://github.com/FasterXML/jackson-databind/issues/676","id":54053776,"node_id":"MDU6SXNzdWU1NDA1Mzc3Ng==","number":676,"title":"Deserialization of class with generic collection inside depends on how is was deserialized first time","user":{"login":"lunaticare","id":947471,"node_id":"MDQ6VXNlcjk0NzQ3MQ==","avatar_url":"https://avatars.githubusercontent.com/u/947471?v=4","gravatar_id":"","url":"https://api.github.com/users/lunaticare","html_url":"https://github.com/lunaticare","followers_url":"https://api.github.com/users/lunaticare/followers","following_url":"https://api.github.com/users/lunaticare/following{/other_user}","gists_url":"https://api.github.com/users/lunaticare/gists{/gist_id}","starred_url":"https://api.github.com/users/lunaticare/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lunaticare/subscriptions","organizations_url":"https://api.github.com/users/lunaticare/orgs","repos_url":"https://api.github.com/users/lunaticare/repos","events_url":"https://api.github.com/users/lunaticare/events{/privacy}","received_events_url":"https://api.github.com/users/lunaticare/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/FasterXML/jackson-databind/milestones/32","html_url":"https://github.com/FasterXML/jackson-databind/milestone/32","labels_url":"https://api.github.com/repos/FasterXML/jackson-databind/milestones/32/labels","id":1084507,"node_id":"MDk6TWlsZXN0b25lMTA4NDUwNw==","number":32,"title":"2.5.4","description":null,"creator":{"login":"cowtowncoder","id":55065,"node_id":"MDQ6VXNlcjU1MDY1","avatar_url":"https://avatars.githubusercontent.com/u/55065?v=4","gravatar_id":"","url":"https://api.github.com/users/cowtowncoder","html_url":"https://github.com/cowtowncoder","followers_url":"https://api.github.com/users/cowtowncoder/followers","following_url":"https://api.github.com/users/cowtowncoder/following{/other_user}","gists_url":"https://api.github.com/users/cowtowncoder/gists{/gist_id}","starred_url":"https://api.github.com/users/cowtowncoder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cowtowncoder/subscriptions","organizations_url":"https://api.github.com/users/cowtowncoder/orgs","repos_url":"https://api.github.com/users/cowtowncoder/repos","events_url":"https://api.github.com/users/cowtowncoder/events{/privacy}","received_events_url":"https://api.github.com/users/cowtowncoder/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":8,"state":"closed","created_at":"2015-04-27T05:42:53Z","updated_at":"2021-03-04T04:03:33Z","due_on":null,"closed_at":"2021-03-04T04:03:33Z"},"comments":8,"created_at":"2015-01-12T13:34:40Z","updated_at":"2015-05-08T12:48:36Z","closed_at":"2015-05-08T03:12:05Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Hi everyone!\n\nAfter migration from Jackson 1.9.x to 2.x (the problem can be reproduced in 2.5.0) I've got a problem deserializing generic collections.\nHere's the test that documents the behavour.\nAm I doing something wrong?\n\n``` java\npackage com.fasterxml.jackson.databind.test;\n\nimport com.fasterxml.jackson.annotation.JsonTypeInfo;\nimport com.fasterxml.jackson.databind.ObjectMapper;\nimport com.fasterxml.jackson.databind.annotation.JsonSerialize;\nimport com.google.common.collect.ImmutableList;\nimport com.google.common.collect.ImmutableMap;\nimport org.json.JSONException;\nimport org.json.JSONObject;\nimport org.junit.Test;\nimport org.skyscreamer.jsonassert.JSONAssert;\n\nimport java.io.IOException;\nimport java.util.Date;\nimport java.util.Map;\n\nimport static org.junit.Assert.assertEquals;\nimport static org.junit.Assert.assertNotEquals;\n\n/**\n * Deserialization of class with generic collection inside depends on how is was deserialized first time.\n */\npublic class JacksonPolymorphicDeSerFailTest {\n    private static final int TIMESTAMP = 123456;\n    private final MapContainer originMap =\n            new MapContainer(ImmutableMap.<String, Object>of(\"DateValue\", new Date(TIMESTAMP)));\n\n    /**\n     * If the class was first deserialized as polymorphic field,\n     * deserialization will fail at complex type.\n     */\n    @Test\n    public void testFactorsSerializationFail() throws IOException, JSONException {\n        ObjectMapper mapper = new ObjectMapper();\n\n        // incorrect\n        MapContainer deserMapBad = createDeSerMapContainer(originMap, mapper);\n        assertNotEquals(originMap, deserMapBad);\n        assertEquals(ImmutableList.of(\"java.util.Date\", TIMESTAMP),\n                deserMapBad.getMap().get(\"DateValue\"));\n\n        // incorrect again\n        assertNotEquals(originMap, mapper.readValue(mapper.writeValueAsString(originMap),\n                MapContainer.class));\n    }\n\n    /**\n     * If the class was first deserialized as is,\n     * deserialization will work correctly.\n     */\n    @Test\n    public void testFactorsSerializationMagicGood() throws IOException, JSONException {\n        ObjectMapper mapper = new ObjectMapper();\n        // commenting out the following statement will fail the test\n        assertEquals(new MapContainer(ImmutableMap.<String, Object>of(\"1\", 1)),\n                mapper.readValue(\n                        mapper.writeValueAsString(new MapContainer(ImmutableMap.<String, Object>of(\"1\", 1))),\n                        MapContainer.class));\n\n        MapContainer deserMapGood = createDeSerMapContainer(originMap, mapper);\n        // correct\n        assertEquals(originMap, deserMapGood);\n        assertEquals(new Date(TIMESTAMP), deserMapGood.getMap().get(\"DateValue\"));\n\n        // correct again\n        assertEquals(originMap, mapper.readValue(mapper.writeValueAsString(originMap), MapContainer.class));\n    }\n\n    private static MapContainer createDeSerMapContainer(MapContainer originMap, ObjectMapper mapper)\n            throws JSONException, IOException {\n        PolymorphicValueWrapper result = new PolymorphicValueWrapper();\n        result.setValue(originMap);\n        String json = mapper.writeValueAsString(result);\n        System.out.println(\"Original map json: \" + json);\n        JSONAssert.assertEquals(\"{\\\"value\\\":{\\\"@class\\\":\"\n                        + \"\\\"com.fasterxml.jackson.databind.test.JacksonPolymorphicDeSerFailTest$MapContainer\\\",\"\n                        + \"\\\"map\\\":{\\\"DateValue\\\":[\\\"java.util.Date\\\",123456]}}}\",\n                new JSONObject(json), true);\n        PolymorphicValueWrapper deserializedResult = mapper.readValue(json, PolymorphicValueWrapper.class);\n        System.out.println(\"Deserialized map json: \" + mapper.writeValueAsString(deserializedResult));\n        return (MapContainer) deserializedResult.getValue();\n    }\n\n    @JsonSerialize(include = JsonSerialize.Inclusion.NON_NULL)\n    public static class MapContainer {\n        @JsonTypeInfo(use = JsonTypeInfo.Id.CLASS,\n                include = JsonTypeInfo.As.PROPERTY,\n                property = \"@class\")\n        private Map<String, Object> map;\n\n        public MapContainer() { }\n\n        public MapContainer(Map<String, Object> map) {\n            this.map = map;\n        }\n\n        public Map<String, Object> getMap() {\n            return map;\n        }\n\n        public void setMap(Map<String, Object> map) {\n            this.map = map;\n        }\n\n        @Override\n        public boolean equals(Object o) {\n            if (this == o) {\n                return true;\n            }\n            if (o == null || getClass() != o.getClass()) {\n                return false;\n            }\n\n            MapContainer that = (MapContainer) o;\n\n            if (map != null ? !map.equals(that.map) : that.map != null) {\n                return false;\n            }\n\n            return true;\n        }\n\n        @Override\n        public int hashCode() {\n            return map != null ? map.hashCode() : 0;\n        }\n\n        @Override\n        public String toString() {\n            return \"MapContainer{\" +\n                    \"map=\" + map +\n                    '}';\n        }\n    }\n\n    @JsonSerialize(include = JsonSerialize.Inclusion.NON_NULL)\n    public static class PolymorphicValueWrapper {\n        @JsonTypeInfo(use = JsonTypeInfo.Id.CLASS,\n                include = JsonTypeInfo.As.PROPERTY,\n                property = \"@class\")\n        private Object value;\n\n        public Object getValue() {\n            return value;\n        }\n\n        public void setValue(Object value) {\n            this.value = value;\n        }\n    }\n}\n```\n","closed_by":{"login":"cowtowncoder","id":55065,"node_id":"MDQ6VXNlcjU1MDY1","avatar_url":"https://avatars.githubusercontent.com/u/55065?v=4","gravatar_id":"","url":"https://api.github.com/users/cowtowncoder","html_url":"https://github.com/cowtowncoder","followers_url":"https://api.github.com/users/cowtowncoder/followers","following_url":"https://api.github.com/users/cowtowncoder/following{/other_user}","gists_url":"https://api.github.com/users/cowtowncoder/gists{/gist_id}","starred_url":"https://api.github.com/users/cowtowncoder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cowtowncoder/subscriptions","organizations_url":"https://api.github.com/users/cowtowncoder/orgs","repos_url":"https://api.github.com/users/cowtowncoder/repos","events_url":"https://api.github.com/users/cowtowncoder/events{/privacy}","received_events_url":"https://api.github.com/users/cowtowncoder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/676/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/676/timeline","performed_via_github_app":null,"state_reason":"completed"}