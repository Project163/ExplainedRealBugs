{"url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/1679","repository_url":"https://api.github.com/repos/FasterXML/jackson-databind","labels_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/1679/labels{/name}","comments_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/1679/comments","events_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/1679/events","html_url":"https://github.com/FasterXML/jackson-databind/issues/1679","id":238655869,"node_id":"MDU6SXNzdWUyMzg2NTU4Njk=","number":1679,"title":"`StackOverflowError` in Dynamic `StdKeySerializer`","user":{"login":"kpronovost","id":29552222,"node_id":"MDQ6VXNlcjI5NTUyMjIy","avatar_url":"https://avatars.githubusercontent.com/u/29552222?v=4","gravatar_id":"","url":"https://api.github.com/users/kpronovost","html_url":"https://github.com/kpronovost","followers_url":"https://api.github.com/users/kpronovost/followers","following_url":"https://api.github.com/users/kpronovost/following{/other_user}","gists_url":"https://api.github.com/users/kpronovost/gists{/gist_id}","starred_url":"https://api.github.com/users/kpronovost/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kpronovost/subscriptions","organizations_url":"https://api.github.com/users/kpronovost/orgs","repos_url":"https://api.github.com/users/kpronovost/repos","events_url":"https://api.github.com/users/kpronovost/events{/privacy}","received_events_url":"https://api.github.com/users/kpronovost/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/FasterXML/jackson-databind/milestones/81","html_url":"https://github.com/FasterXML/jackson-databind/milestone/81","labels_url":"https://api.github.com/repos/FasterXML/jackson-databind/milestones/81/labels","id":2583626,"node_id":"MDk6TWlsZXN0b25lMjU4MzYyNg==","number":81,"title":"2.8.10","description":"Release notes: https://github.com/FasterXML/jackson/wiki/Jackson-Release-2.8.10","creator":{"login":"cowtowncoder","id":55065,"node_id":"MDQ6VXNlcjU1MDY1","avatar_url":"https://avatars.githubusercontent.com/u/55065?v=4","gravatar_id":"","url":"https://api.github.com/users/cowtowncoder","html_url":"https://github.com/cowtowncoder","followers_url":"https://api.github.com/users/cowtowncoder/followers","following_url":"https://api.github.com/users/cowtowncoder/following{/other_user}","gists_url":"https://api.github.com/users/cowtowncoder/gists{/gist_id}","starred_url":"https://api.github.com/users/cowtowncoder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cowtowncoder/subscriptions","organizations_url":"https://api.github.com/users/cowtowncoder/orgs","repos_url":"https://api.github.com/users/cowtowncoder/repos","events_url":"https://api.github.com/users/cowtowncoder/events{/privacy}","received_events_url":"https://api.github.com/users/cowtowncoder/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":8,"state":"closed","created_at":"2017-06-14T20:03:01Z","updated_at":"2021-03-04T04:34:09Z","due_on":"2017-08-24T07:00:00Z","closed_at":"2021-03-04T04:34:09Z"},"comments":8,"created_at":"2017-06-26T20:12:51Z","updated_at":"2017-06-27T20:06:11Z","closed_at":"2017-06-27T20:06:11Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"There seem to be a problem (checked and doesn't seem to be fixed in latest version) with the serialize method of the Dynamic static class of the StdKeySerializer. \r\n```\r\n        @Override\r\n        public void serialize(Object value, JsonGenerator g, SerializerProvider provider)\r\n                throws IOException\r\n        {\r\n            Class<?> cls = value.getClass();\r\n            PropertySerializerMap m = _dynamicSerializers;\r\n            JsonSerializer<Object> ser = m.serializerFor(cls);\r\n            if (ser == null) {\r\n                ser = _findAndAddDynamic(m, cls, provider);\r\n            }\r\n            ser.serialize(value, g, provider);\r\n        }\r\n```\r\n\r\nThe problem comes from the fact that when `ser` is `null`, the new `ser` returned by `_findAndAddDynamic` is incorrectly filled.\r\n\r\n```\r\n        protected JsonSerializer<Object> _findAndAddDynamic(PropertySerializerMap map,\r\n                Class<?> type, SerializerProvider provider) throws JsonMappingException\r\n        {\r\n            PropertySerializerMap.SerializerAndMapResult result =\r\n                    // null -> for now we won't keep ref or pass BeanProperty; could change\r\n                    map.findAndAddKeySerializer(type, provider, null);\r\n            // did we get a new map of serializers? If so, start using it\r\n            if (map != result.map) {\r\n                _dynamicSerializers = result.map;\r\n            }\r\n            return result.serializer;\r\n        }\r\n```\r\nSo say we are in `ser#1`, `ser#1._dynamicSerializers` now has the correct `PropertySerializerMap$Single`. However, `result.serializer._dynamicSerializers ` has `PropertySerializerMap$Empty`.\r\nTherefore, a new call with that result `ser#2` is made which ends up creating an infinite loop.\r\n\r\nPossible fix:\r\n- replace `_dynamicSerializers = result.map;` by `result.serializer._dynamicSerializers  = result.map`\r\n\r\nIf I'm mistaken please let me know, but It seems obvious when debugging that something's is not working as intended\r\n","closed_by":{"login":"cowtowncoder","id":55065,"node_id":"MDQ6VXNlcjU1MDY1","avatar_url":"https://avatars.githubusercontent.com/u/55065?v=4","gravatar_id":"","url":"https://api.github.com/users/cowtowncoder","html_url":"https://github.com/cowtowncoder","followers_url":"https://api.github.com/users/cowtowncoder/followers","following_url":"https://api.github.com/users/cowtowncoder/following{/other_user}","gists_url":"https://api.github.com/users/cowtowncoder/gists{/gist_id}","starred_url":"https://api.github.com/users/cowtowncoder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cowtowncoder/subscriptions","organizations_url":"https://api.github.com/users/cowtowncoder/orgs","repos_url":"https://api.github.com/users/cowtowncoder/repos","events_url":"https://api.github.com/users/cowtowncoder/events{/privacy}","received_events_url":"https://api.github.com/users/cowtowncoder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/1679/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/1679/timeline","performed_via_github_app":null,"state_reason":"completed"}