{"url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/4920","repository_url":"https://api.github.com/repos/FasterXML/jackson-databind","labels_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/4920/labels{/name}","comments_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/4920/comments","events_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/4920/events","html_url":"https://github.com/FasterXML/jackson-databind/issues/4920","id":2806353635,"node_id":"I_kwDOAC5e2c6nRY7j","number":4920,"title":"Creator properties are ignored on abstract types when collecting bean properties, breaking AsExternalTypeDeserializer","user":{"login":"zhenlin-pay2","id":90177043,"node_id":"MDQ6VXNlcjkwMTc3MDQz","avatar_url":"https://avatars.githubusercontent.com/u/90177043?v=4","gravatar_id":"","url":"https://api.github.com/users/zhenlin-pay2","html_url":"https://github.com/zhenlin-pay2","followers_url":"https://api.github.com/users/zhenlin-pay2/followers","following_url":"https://api.github.com/users/zhenlin-pay2/following{/other_user}","gists_url":"https://api.github.com/users/zhenlin-pay2/gists{/gist_id}","starred_url":"https://api.github.com/users/zhenlin-pay2/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zhenlin-pay2/subscriptions","organizations_url":"https://api.github.com/users/zhenlin-pay2/orgs","repos_url":"https://api.github.com/users/zhenlin-pay2/repos","events_url":"https://api.github.com/users/zhenlin-pay2/events{/privacy}","received_events_url":"https://api.github.com/users/zhenlin-pay2/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":6636564281,"node_id":"LA_kwDOAC5e2c8AAAABi5HvOQ","url":"https://api.github.com/repos/FasterXML/jackson-databind/labels/2.18","name":"2.18","color":"1D76DB","default":false,"description":"Issues planned at 2.18 or later"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/FasterXML/jackson-databind/milestones/172","html_url":"https://github.com/FasterXML/jackson-databind/milestone/172","labels_url":"https://api.github.com/repos/FasterXML/jackson-databind/milestones/172/labels","id":12026947,"node_id":"MI_kwDOAC5e2c4At4RD","number":172,"title":"2.18.3","description":null,"creator":{"login":"cowtowncoder","id":55065,"node_id":"MDQ6VXNlcjU1MDY1","avatar_url":"https://avatars.githubusercontent.com/u/55065?v=4","gravatar_id":"","url":"https://api.github.com/users/cowtowncoder","html_url":"https://github.com/cowtowncoder","followers_url":"https://api.github.com/users/cowtowncoder/followers","following_url":"https://api.github.com/users/cowtowncoder/following{/other_user}","gists_url":"https://api.github.com/users/cowtowncoder/gists{/gist_id}","starred_url":"https://api.github.com/users/cowtowncoder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cowtowncoder/subscriptions","organizations_url":"https://api.github.com/users/cowtowncoder/orgs","repos_url":"https://api.github.com/users/cowtowncoder/repos","events_url":"https://api.github.com/users/cowtowncoder/events{/privacy}","received_events_url":"https://api.github.com/users/cowtowncoder/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":10,"state":"closed","created_at":"2024-12-10T23:57:03Z","updated_at":"2025-10-30T23:29:04Z","due_on":null,"closed_at":"2025-10-30T23:29:04Z"},"comments":13,"created_at":"2025-01-23T09:17:24Z","updated_at":"2025-02-25T23:07:43Z","closed_at":"2025-02-25T23:07:42Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Search before asking\n\n- [x] I searched in the [issues](https://github.com/FasterXML/jackson-databind/issues) and found nothing similar.\n\n### Describe the bug\n\nWhen using Jackson with frameworks such as [Immutables](https://immutables.github.io/) where users are expected to write bean definitions as abstract types and let the framework generate concrete implementations, Jackson annotations on the abstract type sometimes have no effect, or worse, trigger bugs. This appears to be due to the assumption in `BeanDeserializerFactory.addBeanProps` that creator properties do not need to be considered for abstract types. In particular, deserialisation fails with a bizarre exception in in the following situation:\n\n* The type to be deserialised is abstract but with a defined `ValueInstantiator` (e.g. from a`@JsonCreator` annotated factory method).\n* The property to be deserialised has a getter but no setter.\n* The type of the property to be deserialised is also abstract.\n* The getter has a `@JsonTypeInfo` annotation with `include = JsonTypeInfo.As.EXTERNAL_PROPERTY`.\n\n\n\n### Version Information\n\n2.17.1\n\n### Reproduction\n\nSee attached: [example.zip](https://github.com/user-attachments/files/18517891/example.zip)\n\n\n### Expected behavior\n\n_No response_\n\n### Additional context\n\nDeserialisation fails with the following exception:\n```\nUnexpected token (VALUE_STRING), expected START_ARRAY: need Array value to contain `As.WRAPPER_ARRAY` type information for class example.TypedData$Value\n at [Source: REDACTED (`StreamReadFeature.INCLUDE_SOURCE_IN_LOCATION` disabled); line: 2, column: 20] (through reference chain: example.TypedData[\"value\"])\ncom.fasterxml.jackson.databind.exc.MismatchedInputException: Unexpected token (VALUE_STRING), expected START_ARRAY: need Array value to contain `As.WRAPPER_ARRAY` type information for class example.TypedData$Value\n at [Source: REDACTED (`StreamReadFeature.INCLUDE_SOURCE_IN_LOCATION` disabled); line: 2, column: 20] (through reference chain: papaya.struct.jackson.TypedData[\"value\"])\n\tat com.fasterxml.jackson.databind.exc.MismatchedInputException.from(MismatchedInputException.java:59)\n\tat com.fasterxml.jackson.databind.DeserializationContext.wrongTokenException(DeserializationContext.java:1913)\n\tat com.fasterxml.jackson.databind.DeserializationContext.reportWrongTokenException(DeserializationContext.java:1699)\n\tat com.fasterxml.jackson.databind.jsontype.impl.AsArrayTypeDeserializer._locateTypeId(AsArrayTypeDeserializer.java:141)\n\tat com.fasterxml.jackson.databind.jsontype.impl.AsArrayTypeDeserializer._deserialize(AsArrayTypeDeserializer.java:96)\n\tat com.fasterxml.jackson.databind.jsontype.impl.AsArrayTypeDeserializer.deserializeTypedFromObject(AsArrayTypeDeserializer.java:61)\n\tat com.fasterxml.jackson.databind.deser.AbstractDeserializer.deserializeWithType(AbstractDeserializer.java:263)\n\tat com.fasterxml.jackson.databind.deser.SettableBeanProperty.deserialize(SettableBeanProperty.java:542)\n\tat com.fasterxml.jackson.databind.deser.BeanDeserializer._deserializeWithErrorWrapping(BeanDeserializer.java:570)\n\tat com.fasterxml.jackson.databind.deser.BeanDeserializer._deserializeUsingPropertyBased(BeanDeserializer.java:440)\n\tat com.fasterxml.jackson.databind.deser.BeanDeserializerBase.deserializeFromObjectUsingNonDefault(BeanDeserializerBase.java:1493)\n\tat com.fasterxml.jackson.databind.deser.BeanDeserializer.deserializeFromObject(BeanDeserializer.java:348)\n\tat com.fasterxml.jackson.databind.deser.BeanDeserializer.deserialize(BeanDeserializer.java:185)\n\tat com.fasterxml.jackson.databind.deser.DefaultDeserializationContext.readRootValue(DefaultDeserializationContext.java:342)\n\tat com.fasterxml.jackson.databind.ObjectMapper._readMapAndClose(ObjectMapper.java:4905)\n\tat com.fasterxml.jackson.databind.ObjectMapper.readValue(ObjectMapper.java:3848)\n\tat com.fasterxml.jackson.databind.ObjectMapper.readValue(ObjectMapper.java:3816)\n```\n\nNotice that the call chain goes through `BeanDeserializer.deserializeFromObjectUsingNonDefault` rather than the expected `BeanDeserializer.deserializeWithExternalTypeId`. This is because `_externalTypeIdHandler` is `null`, which is because when `BeanDeserializerBase.resolve` is called, `_beanProperties` is empty (!), which is because `BeanDeserializerFactory.addBeanProps` ignores creator properties when the type is abstract. Changing the value of `isConcrete` in `addBeanProps` to `true` while running in a debugger suffices to fix this problem, though I cannot say if this has any other effects.","closed_by":{"login":"cowtowncoder","id":55065,"node_id":"MDQ6VXNlcjU1MDY1","avatar_url":"https://avatars.githubusercontent.com/u/55065?v=4","gravatar_id":"","url":"https://api.github.com/users/cowtowncoder","html_url":"https://github.com/cowtowncoder","followers_url":"https://api.github.com/users/cowtowncoder/followers","following_url":"https://api.github.com/users/cowtowncoder/following{/other_user}","gists_url":"https://api.github.com/users/cowtowncoder/gists{/gist_id}","starred_url":"https://api.github.com/users/cowtowncoder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cowtowncoder/subscriptions","organizations_url":"https://api.github.com/users/cowtowncoder/orgs","repos_url":"https://api.github.com/users/cowtowncoder/repos","events_url":"https://api.github.com/users/cowtowncoder/events{/privacy}","received_events_url":"https://api.github.com/users/cowtowncoder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/4920/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/4920/timeline","performed_via_github_app":null,"state_reason":"completed"}