{"url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/3068","repository_url":"https://api.github.com/repos/FasterXML/jackson-databind","labels_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/3068/labels{/name}","comments_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/3068/comments","events_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/3068/events","html_url":"https://github.com/FasterXML/jackson-databind/issues/3068","id":816205651,"node_id":"MDU6SXNzdWU4MTYyMDU2NTE=","number":3068,"title":"`MapDeserializer` forcing `JsonMappingException` wrapping even if WRAP_EXCEPTIONS set to false","user":{"login":"perkss","id":24793711,"node_id":"MDQ6VXNlcjI0NzkzNzEx","avatar_url":"https://avatars.githubusercontent.com/u/24793711?v=4","gravatar_id":"","url":"https://api.github.com/users/perkss","html_url":"https://github.com/perkss","followers_url":"https://api.github.com/users/perkss/followers","following_url":"https://api.github.com/users/perkss/following{/other_user}","gists_url":"https://api.github.com/users/perkss/gists{/gist_id}","starred_url":"https://api.github.com/users/perkss/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/perkss/subscriptions","organizations_url":"https://api.github.com/users/perkss/orgs","repos_url":"https://api.github.com/users/perkss/repos","events_url":"https://api.github.com/users/perkss/events{/privacy}","received_events_url":"https://api.github.com/users/perkss/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/FasterXML/jackson-databind/milestones/128","html_url":"https://github.com/FasterXML/jackson-databind/milestone/128","labels_url":"https://api.github.com/repos/FasterXML/jackson-databind/milestones/128/labels","id":6359554,"node_id":"MDk6TWlsZXN0b25lNjM1OTU1NA==","number":128,"title":"2.12.2","description":"Released on 03-Mar-2021. Release notes: https://github.com/FasterXML/jackson/wiki/Jackson-Release-2.12.2","creator":{"login":"cowtowncoder","id":55065,"node_id":"MDQ6VXNlcjU1MDY1","avatar_url":"https://avatars.githubusercontent.com/u/55065?v=4","gravatar_id":"","url":"https://api.github.com/users/cowtowncoder","html_url":"https://github.com/cowtowncoder","followers_url":"https://api.github.com/users/cowtowncoder/followers","following_url":"https://api.github.com/users/cowtowncoder/following{/other_user}","gists_url":"https://api.github.com/users/cowtowncoder/gists{/gist_id}","starred_url":"https://api.github.com/users/cowtowncoder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cowtowncoder/subscriptions","organizations_url":"https://api.github.com/users/cowtowncoder/orgs","repos_url":"https://api.github.com/users/cowtowncoder/repos","events_url":"https://api.github.com/users/cowtowncoder/events{/privacy}","received_events_url":"https://api.github.com/users/cowtowncoder/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":13,"state":"closed","created_at":"2021-01-27T17:56:09Z","updated_at":"2021-03-04T04:00:28Z","due_on":"2021-03-03T08:00:00Z","closed_at":"2021-03-04T03:56:28Z"},"comments":5,"created_at":"2021-02-25T08:25:41Z","updated_at":"2021-02-26T18:31:52Z","closed_at":"2021-02-26T01:45:11Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Describe the bug**\r\nI am upgrading a project from 1.9.13 to 2.12.1. The WRAP_EXCEPTION feature was added in since that as we have a custom exception now being wrapped. \r\n\r\nThe project adds a Deserializer and overrides deserialize where it throws a custom exception. We do not want this exception to be wrapped but it now gets wrapped as a JsonMappingException. Even setting WRAP_EXCEPTION to false it still wraps the exception. \r\n\r\nThe code calls [wrapAndThrow](https://github.com/FasterXML/jackson-databind/blob/jackson-databind-2.12.1/src/main/java/com/fasterxml/jackson/databind/deser/std/MapDeserializer.java#L621) and then wraps the exception [ContainerDeserializerBase](https://github.com/FasterXML/jackson-databind/blob/jackson-databind-2.12.1/src/main/java/com/fasterxml/jackson/databind/deser/std/ContainerDeserializerBase.java#L173). \r\n\r\nThen when handled as its already been wrapped by a `JsonMappingException` it is a instance of `IOException` so it will not unwrap the exception in the code [BeanDeserializerBase](https://github.com/FasterXML/jackson-databind/blob/jackson-databind-2.12.1/src/main/java/com/fasterxml/jackson/databind/deser/BeanDeserializerBase.java#L1825).\r\n\r\nShould we be able to get the underlying exception here or is this by design to force this wrapping? \r\n\r\n**Version information**\r\n2.12.1\r\n\r\n**To Reproduce**\r\n```java\r\nimport com.fasterxml.jackson.annotation.JsonCreator;\r\nimport com.fasterxml.jackson.annotation.JsonIgnoreProperties;\r\nimport com.fasterxml.jackson.annotation.JsonProperty;\r\nimport com.fasterxml.jackson.core.JsonParser;\r\nimport com.fasterxml.jackson.core.JsonProcessingException;\r\nimport com.fasterxml.jackson.core.Version;\r\nimport com.fasterxml.jackson.databind.*;\r\nimport com.fasterxml.jackson.databind.module.SimpleModule;\r\nimport com.fasterxml.jackson.databind.node.ArrayNode;\r\nimport com.fasterxml.jackson.databind.node.ObjectNode;\r\nimport org.junit.jupiter.api.Assertions;\r\nimport org.junit.jupiter.api.Test;\r\n\r\nimport java.io.IOException;\r\nimport java.util.Collections;\r\nimport java.util.Map;\r\n\r\npublic class JacksonIssue {\r\n\r\n    private static final ObjectMapper OBJECT_MAPPER = getObjectMapper();\r\n\r\n    private static ObjectMapper getObjectMapper() {\r\n        ObjectMapper mapper = new ObjectMapper();\r\n        mapper.configure(DeserializationFeature.WRAP_EXCEPTIONS, false);\r\n        mapper.configure(SerializationFeature.WRAP_EXCEPTIONS, false);\r\n\r\n        SimpleModule module = new SimpleModule(\"SimpleModule\", new Version(1, 0, 0, \"\"));\r\n\r\n        module.addDeserializer(MyContainerModel.class, new JsonDeserializer<MyContainerModel>() {\r\n            @Override\r\n            public MyContainerModel deserialize(JsonParser p, DeserializationContext ctxt) throws IOException, JsonProcessingException {\r\n                throw new CustomException(\"This gets wrapped\");\r\n            }\r\n        });\r\n\r\n        mapper.addMixIn(MyJobModel.class, MyJsonJobModelMixIn.class);\r\n        mapper.addMixIn(MyContainerModel.class, MyJsonContainerModelMixIn.class);\r\n\r\n        mapper.registerModule(module);\r\n\r\n        return mapper;\r\n    }\r\n\r\n\r\n    @Test\r\n    void wrapExceptionIgnored() throws JsonProcessingException {\r\n        ObjectNode jobModelJson = buildJobModelJson();\r\n        ObjectNode containerModelJson = (ObjectNode) jobModelJson.get(\"containers\").get(\"1\");\r\n        containerModelJson.remove(\"processor-id\");\r\n\r\n        String jsonString = new ObjectMapper().writeValueAsString(jobModelJson);\r\n\r\n        Assertions.assertThrows(CustomException.class, () -> {\r\n            OBJECT_MAPPER.readValue(jsonString, MyJobModel.class);\r\n        });\r\n    }\r\n\r\n\r\n    private static ObjectNode buildJobModelJson() {\r\n        ObjectMapper objectMapper = new ObjectMapper();\r\n\r\n        ObjectNode model = objectMapper.createObjectNode();\r\n        model.put(\"system\", \"foo\");\r\n        model.put(\"stream\", \"bar\");\r\n        model.put(\"partition\", 1);\r\n\r\n        ArrayNode containerModel1TaskTestSSPsJson = objectMapper.createArrayNode();\r\n        containerModel1TaskTestSSPsJson.add(model);\r\n\r\n        ObjectNode model2 = objectMapper.createObjectNode();\r\n        model2.put(\"task-name\", \"test\");\r\n        model2.put(\"changelog-partition\", 2);\r\n        model2.put(\"task-mode\", \"Active\");\r\n\r\n        ObjectNode containerModel1TasksJson = objectMapper.createObjectNode();\r\n        containerModel1TasksJson.put(\"test\", model);\r\n\r\n        ObjectNode containerModel1Json = objectMapper.createObjectNode();\r\n        containerModel1Json.put(\"processor-id\", \"1\");\r\n        containerModel1Json.put(\"tasks\", containerModel1TasksJson);\r\n\r\n        ObjectNode containersJson = objectMapper.createObjectNode();\r\n        containersJson.put(\"1\", containerModel1Json);\r\n\r\n        ObjectNode jobModelJson = objectMapper.createObjectNode();\r\n        jobModelJson.put(\"containers\", containersJson);\r\n\r\n        return jobModelJson;\r\n    }\r\n\r\n\r\n    public abstract class MyJsonContainerModelMixIn {\r\n        static final String PROCESSOR_ID_KEY = \"processor-id\";\r\n        static final String CONTAINER_ID_KEY = \"container-id\";\r\n        static final String TASKS_KEY = \"tasks\";\r\n\r\n        public MyJsonContainerModelMixIn() {\r\n        }\r\n\r\n        @JsonProperty(\"processor-id\")\r\n        abstract String getId();\r\n\r\n    }\r\n\r\n    @JsonIgnoreProperties(\r\n            ignoreUnknown = true\r\n    )\r\n    public abstract class MyJsonJobModelMixIn {\r\n        @JsonCreator\r\n        public MyJsonJobModelMixIn(@JsonProperty(\"containers\") Map<String, MyContainerModel> containers) {\r\n        }\r\n\r\n        @JsonProperty(\"containers\")\r\n        abstract Map<String, MyContainerModel> getContainers();\r\n    }\r\n\r\n\r\n    public static class MyContainerModel {\r\n        private final String id;\r\n\r\n        public MyContainerModel(String id) {\r\n            this.id = id;\r\n        }\r\n\r\n        public String getId() {\r\n            return this.id;\r\n        }\r\n\r\n\r\n    }\r\n\r\n    public static class MyJobModel {\r\n        private final Map<String, MyContainerModel> containers;\r\n        public int maxChangeLogStreamPartitions;\r\n\r\n        @JsonCreator\r\n        public MyJobModel(Map<String, MyContainerModel> containers) {\r\n            this.containers = Collections.unmodifiableMap(containers);\r\n            this.maxChangeLogStreamPartitions = 0;\r\n\r\n        }\r\n\r\n\r\n        public Map<String, MyContainerModel> getContainers() {\r\n            return this.containers;\r\n        }\r\n\r\n\r\n    }\r\n\r\n\r\n}\r\n```\r\n\r\n```java\r\npublic class CustomException extends RuntimeException {\r\n    private static final long serialVersionUID = 1L;\r\n\r\n    public CustomException() {\r\n        super();\r\n    }\r\n\r\n    public CustomException(String s, Throwable t) {\r\n        super(s, t);\r\n    }\r\n\r\n    public CustomException(String s) {\r\n        super(s);\r\n    }\r\n\r\n    public CustomException(Throwable t) {\r\n        super(t);\r\n    }\r\n}\r\n```\r\n\r\n**Expected behavior**\r\n<jacksonissue.CustomException> but was: <com.fasterxml.jackson.databind.JsonMappingException>\r\n\r\n**Additional context**\r\nThis is due to trying to upgrade Apache Samza from a very old Jackson version where they throw an exception like the case above referenced [here](https://github.com/apache/samza/blob/master/samza-core/src/main/java/org/apache/samza/serializers/model/SamzaObjectMapper.java#L121)\r\n","closed_by":{"login":"cowtowncoder","id":55065,"node_id":"MDQ6VXNlcjU1MDY1","avatar_url":"https://avatars.githubusercontent.com/u/55065?v=4","gravatar_id":"","url":"https://api.github.com/users/cowtowncoder","html_url":"https://github.com/cowtowncoder","followers_url":"https://api.github.com/users/cowtowncoder/followers","following_url":"https://api.github.com/users/cowtowncoder/following{/other_user}","gists_url":"https://api.github.com/users/cowtowncoder/gists{/gist_id}","starred_url":"https://api.github.com/users/cowtowncoder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cowtowncoder/subscriptions","organizations_url":"https://api.github.com/users/cowtowncoder/orgs","repos_url":"https://api.github.com/users/cowtowncoder/repos","events_url":"https://api.github.com/users/cowtowncoder/events{/privacy}","received_events_url":"https://api.github.com/users/cowtowncoder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/3068/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/3068/timeline","performed_via_github_app":null,"state_reason":"completed"}