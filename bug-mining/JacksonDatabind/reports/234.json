{"url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/1035","repository_url":"https://api.github.com/repos/FasterXML/jackson-databind","labels_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/1035/labels{/name}","comments_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/1035/comments","events_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/1035/events","html_url":"https://github.com/FasterXML/jackson-databind/issues/1035","id":120300188,"node_id":"MDU6SXNzdWUxMjAzMDAxODg=","number":1035,"title":"`@JsonAnySetter` assumes key of `String`, does not consider declared type; should","user":{"login":"MichaelRFairhurst","id":1627771,"node_id":"MDQ6VXNlcjE2Mjc3NzE=","avatar_url":"https://avatars.githubusercontent.com/u/1627771?v=4","gravatar_id":"","url":"https://api.github.com/users/MichaelRFairhurst","html_url":"https://github.com/MichaelRFairhurst","followers_url":"https://api.github.com/users/MichaelRFairhurst/followers","following_url":"https://api.github.com/users/MichaelRFairhurst/following{/other_user}","gists_url":"https://api.github.com/users/MichaelRFairhurst/gists{/gist_id}","starred_url":"https://api.github.com/users/MichaelRFairhurst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MichaelRFairhurst/subscriptions","organizations_url":"https://api.github.com/users/MichaelRFairhurst/orgs","repos_url":"https://api.github.com/users/MichaelRFairhurst/repos","events_url":"https://api.github.com/users/MichaelRFairhurst/events{/privacy}","received_events_url":"https://api.github.com/users/MichaelRFairhurst/received_events","type":"User","user_view_type":"public","site_admin":true},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/FasterXML/jackson-databind/milestones/63","html_url":"https://github.com/FasterXML/jackson-databind/milestone/63","labels_url":"https://api.github.com/repos/FasterXML/jackson-databind/milestones/63/labels","id":2003215,"node_id":"MDk6TWlsZXN0b25lMjAwMzIxNQ==","number":63,"title":"2.9.0","description":"Release notes: https://github.com/FasterXML/jackson/wiki/Jackson-Release-2.9","creator":{"login":"cowtowncoder","id":55065,"node_id":"MDQ6VXNlcjU1MDY1","avatar_url":"https://avatars.githubusercontent.com/u/55065?v=4","gravatar_id":"","url":"https://api.github.com/users/cowtowncoder","html_url":"https://github.com/cowtowncoder","followers_url":"https://api.github.com/users/cowtowncoder/followers","following_url":"https://api.github.com/users/cowtowncoder/following{/other_user}","gists_url":"https://api.github.com/users/cowtowncoder/gists{/gist_id}","starred_url":"https://api.github.com/users/cowtowncoder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cowtowncoder/subscriptions","organizations_url":"https://api.github.com/users/cowtowncoder/orgs","repos_url":"https://api.github.com/users/cowtowncoder/repos","events_url":"https://api.github.com/users/cowtowncoder/events{/privacy}","received_events_url":"https://api.github.com/users/cowtowncoder/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":45,"state":"closed","created_at":"2016-09-14T06:07:39Z","updated_at":"2021-03-04T04:46:44Z","due_on":"2017-07-30T07:00:00Z","closed_at":"2021-03-04T04:46:44Z"},"comments":2,"created_at":"2015-12-03T23:56:46Z","updated_at":"2016-10-06T06:22:07Z","closed_at":"2016-10-06T06:22:07Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I previously was deserializing the following fields via JSON\n\n```\nprivate Map<CityStateCountrySplitter, Metrics> cityMetrics;\nprivate Map<Integer, Metric> dmaCodeMetrics;\nprivate Map<String, Metric> interestMetrics;\n```\n\nBut suddenly the Maps we were getting from this third party included some new fields, where both the keys and the values differed from what we were getting before.\n\n```\n{\"dmaCodeMetrics\":{123:{...},456:{...},...,\"raw_count\":55},...}\n```\n\nWe always get these new values, and want to keep them, so I moved over to use a new object that defines that new field plus @JsonAnySetter. Essentially I'm trying to create an object that acts like a HashMap<K, V> but has some known fields that I want to deserialize specially.\n\n```\n// old class\nprivate Breakdown<CityStateCountrySplitter> cityMetrics;\nprivate Breakdown<Integer> dmaCodeMetrics;\nprivate Breakdown<String> interestMetrics;\n\n// Breakdown.java\nprivate int raw_count;\nprivate Map<T, Metrics> metrics;\n\n@JsonAnySetter\npublic void addBreakdownPoint(T key, Metrics value) {\n    metrics.add(key, value);\n}\n```\n\nAt first everything seemed to work. @JsonAnySetter figures out to deserialize my value as a Metrics object, and deserialization doesn't throw any exceptions. But jackson always passes a String into 'key'. Thanks to erasure, it happily accepts the wrong data, until I go to use it where I get class cast exceptions.\n### Unit Test\n\n```\n  private static class MyGeneric<T> {\n\n      private String staticallyMappedProperty;\n      private Map<T, Integer> dynamicallyMappedProperties = new HashMap<T, Integer>();\n\n      public String getStaticallyMappedProperty() {\n          return staticallyMappedProperty;\n      }\n\n      @JsonAnySetter\n      public void addDynamicallyMappedProperty(T key, int value) {\n          dynamicallyMappedProperties.put(key, value);\n      }\n\n    public void setStaticallyMappedProperty(String staticallyMappedProperty) {\n          this.staticallyMappedProperty = staticallyMappedProperty;\n      }\n\n      @JsonAnyGetter\n      public Map<T, Integer> getDynamicallyMappedProperties() {\n          return dynamicallyMappedProperties;\n      }\n  }\n\n  private static class MyWrapper {\n      private MyGeneric<String> myStringGeneric;\n      private MyGeneric<Integer> myIntegerGeneric;\n\n      public MyGeneric<String> getMyStringGeneric() {\n          return myStringGeneric;\n      }\n\n    public void setMyStringGeneric(MyGeneric<String> myStringGeneric) {\n          this.myStringGeneric = myStringGeneric;\n      }\n\n      public MyGeneric<Integer> getMyIntegerGeneric() {\n          return myIntegerGeneric;\n      }\n\n    public void setMyIntegerGeneric(MyGeneric<Integer> myIntegerGeneric) {\n          this.myIntegerGeneric = myIntegerGeneric;\n      }\n  }\n\n  @Test\n  public void test() throws JsonParseException, JsonMappingException, IOException {\n      ObjectMapper mapper = new ObjectMapper();\n\n      Map<String, Integer> stringGenericMap = new HashMap<String, Integer>();\n      stringGenericMap.put(\"testStringKey\", 5);\n      Map<Integer, Integer> integerGenericMap = new HashMap<Integer, Integer>();\n      integerGenericMap.put(111, 6);\n\n      MyWrapper deserialized = mapper.readValue(\"{\\\"myStringGeneric\\\":{\\\"staticallyMappedProperty\\\":\\\"Test\\\",\\\"testStringKey\\\":5},\\\"myIntegerGeneric\\\":{\\\"staticallyMappedProperty\\\":\\\"Test2\\\",\\\"111\\\":6}}\", MyWrapper.class);\n      MyGeneric<String> stringGeneric = deserialized.getMyStringGeneric();\n      MyGeneric<Integer> integerGeneric = deserialized.getMyIntegerGeneric();\n\n      assertNotNull(stringGeneric);\n      assertEquals(stringGeneric.getStaticallyMappedProperty(), \"Test\");\n      for(Map.Entry<String, Integer> entry : stringGeneric.getDynamicallyMappedProperties().entrySet()) {\n          assertTrue(\"A key in MyGeneric<String> is not an String.\", entry.getKey() instanceof String);\n          assertTrue(\"A value in MyGeneric<Integer> is not an Integer.\", entry.getValue() instanceof Integer);\n      }\n      assertEquals(stringGeneric.getDynamicallyMappedProperties(), stringGenericMap);\n\n      assertNotNull(integerGeneric);\n      assertEquals(integerGeneric.getStaticallyMappedProperty(), \"Test2\");\n      for(Map.Entry<Integer, Integer> entry : integerGeneric.getDynamicallyMappedProperties().entrySet()) {\n          assertTrue(\"A key in MyGeneric<Integer> is not an Integer.\", entry.getKey() instanceof Integer);\n          assertTrue(\"A value in MyGeneric<Integer> is not an Integer.\", entry.getValue() instanceof Integer);\n      }\n      assertEquals(integerGeneric.getDynamicallyMappedProperties(), integerGenericMap);\n  }\n```\n\nThis test fails with\n\n```\njava.lang.AssertionError: A key in MyGeneric<Integer> is not an Integer.\n```\n","closed_by":{"login":"cowtowncoder","id":55065,"node_id":"MDQ6VXNlcjU1MDY1","avatar_url":"https://avatars.githubusercontent.com/u/55065?v=4","gravatar_id":"","url":"https://api.github.com/users/cowtowncoder","html_url":"https://github.com/cowtowncoder","followers_url":"https://api.github.com/users/cowtowncoder/followers","following_url":"https://api.github.com/users/cowtowncoder/following{/other_user}","gists_url":"https://api.github.com/users/cowtowncoder/gists{/gist_id}","starred_url":"https://api.github.com/users/cowtowncoder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cowtowncoder/subscriptions","organizations_url":"https://api.github.com/users/cowtowncoder/orgs","repos_url":"https://api.github.com/users/cowtowncoder/repos","events_url":"https://api.github.com/users/cowtowncoder/events{/privacy}","received_events_url":"https://api.github.com/users/cowtowncoder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/1035/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/1035/timeline","performed_via_github_app":null,"state_reason":"completed"}