{"url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/3328","repository_url":"https://api.github.com/repos/FasterXML/jackson-databind","labels_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/3328/labels{/name}","comments_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/3328/comments","events_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/3328/events","html_url":"https://github.com/FasterXML/jackson-databind/issues/3328","id":1059035707,"node_id":"I_kwDOAC5e2c4_H5o7","number":3328,"title":"Possible DoS if using JDK serialization to serialize `JsonNode` [CVE-2021-46877]","user":{"login":"cowtowncoder","id":55065,"node_id":"MDQ6VXNlcjU1MDY1","avatar_url":"https://avatars.githubusercontent.com/u/55065?v=4","gravatar_id":"","url":"https://api.github.com/users/cowtowncoder","html_url":"https://github.com/cowtowncoder","followers_url":"https://api.github.com/users/cowtowncoder/followers","following_url":"https://api.github.com/users/cowtowncoder/following{/other_user}","gists_url":"https://api.github.com/users/cowtowncoder/gists{/gist_id}","starred_url":"https://api.github.com/users/cowtowncoder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cowtowncoder/subscriptions","organizations_url":"https://api.github.com/users/cowtowncoder/orgs","repos_url":"https://api.github.com/users/cowtowncoder/repos","events_url":"https://api.github.com/users/cowtowncoder/events{/privacy}","received_events_url":"https://api.github.com/users/cowtowncoder/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":776337784,"node_id":"MDU6TGFiZWw3NzYzMzc3ODQ=","url":"https://api.github.com/repos/FasterXML/jackson-databind/labels/CVE","name":"CVE","color":"e0577c","default":false,"description":"Issues related to public CVEs (security vuln reports)"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/FasterXML/jackson-databind/milestones/135","html_url":"https://github.com/FasterXML/jackson-databind/milestone/135","labels_url":"https://api.github.com/repos/FasterXML/jackson-databind/milestones/135/labels","id":7500437,"node_id":"MI_kwDOAC5e2c4AcnKV","number":135,"title":"2.12.6","description":null,"creator":{"login":"cowtowncoder","id":55065,"node_id":"MDQ6VXNlcjU1MDY1","avatar_url":"https://avatars.githubusercontent.com/u/55065?v=4","gravatar_id":"","url":"https://api.github.com/users/cowtowncoder","html_url":"https://github.com/cowtowncoder","followers_url":"https://api.github.com/users/cowtowncoder/followers","following_url":"https://api.github.com/users/cowtowncoder/following{/other_user}","gists_url":"https://api.github.com/users/cowtowncoder/gists{/gist_id}","starred_url":"https://api.github.com/users/cowtowncoder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cowtowncoder/subscriptions","organizations_url":"https://api.github.com/users/cowtowncoder/orgs","repos_url":"https://api.github.com/users/cowtowncoder/repos","events_url":"https://api.github.com/users/cowtowncoder/events{/privacy}","received_events_url":"https://api.github.com/users/cowtowncoder/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":1,"state":"open","created_at":"2021-12-19T06:42:21Z","updated_at":"2021-12-19T06:42:21Z","due_on":null,"closed_at":null},"comments":21,"created_at":"2021-11-20T02:09:34Z","updated_at":"2023-03-24T16:49:50Z","closed_at":"2021-12-04T16:55:53Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"There is a report on possible DoS attack, against certain versions of Jackson 2.10.x - 2.13.x (does not affect earlier versions like 2.9, nor future 2.14 and 3.0).\r\n\r\nCVE: https://nvd.nist.gov/vuln/detail/CVE-2021-46877\r\n\r\nFix has been included in versions:\r\n\r\n* 2.12.6\r\n* 2.13.1\r\n\r\nNo current plans to back-porting into 2.10 or 2.11 branches (2.9 and earlier not affected).\r\n\r\n------\r\n\r\n# CVE description\r\n\r\n## Applicability\r\n\r\nThe vulnerability is available only when using _JDK serialization_ to serialize, deserialize `JsonNode` values: this is not something most users ever do, nor is it recommended for general usage.\r\n\r\nSo, any other use of `JsonNode` is completely unrelated to the reported CVE: this ONLY APPLIES WITH JDK SERIALIZATION.\r\n\r\n## Example\r\n\r\nSo how does one use JDK Serialization with Jackson's `JsonNode`?\r\n\r\nExample of such usage (copied from test `NodeJDKSerializationTest.java`) is:\r\n\r\n```\r\nObjectNode root = MAPPER.createObjectNode();\r\nroot.put(\"answer\", 42);\r\n// Instead of usual \"write as JSON\" (using \"node.toString()\" or serialize using ObjectMapper)\r\n// something wants to use JDK serialization: some caching frameworks do this\r\n\r\nByteArrayOutputStream bytes = new ByteArrayOutputStream();\r\nObjectOutputStream obOut = new ObjectOutputStream(bytes);\r\nobOut.writeObject(root);\r\nobOut.close();\r\nbyte[] jdkSer = bytes.toByteArray();\r\n\r\n// and somewhere something wants to read it back like so:\r\nObjectInputStream objIn = new ObjectInputStream(new ByteArrayInputStream(jdkSer));\r\nObjectNode fromSer = (ObjectNode) objIn.readObject();\r\n\r\n// ^^^^ to cause DoD, attacker would need to produce a specifically changed version of\r\n//    payload!\r\n```\r\n\r\nThe issue with JDK serialization is due to combination of format used and original code (see class `NodeSerialization` for  details).\r\n\r\nFirst: `JsonNode` is serialized as a sequence of bytes where first 4 bytes indicate length of actual content; and contents are JSON serialization itself. When reading it back (JDK deserialization) length is read first, original code allocates a `byte[]` with that size, and then contents are read. This works, functionally speaking.\r\n\r\nBut if attacker provides, instead, a payload that contains only 4-byte length, with value of `Integer.MAX_VALUE`, then decoder will:\r\n\r\n1. Read the length\r\n2. Allocate 2 gig `byte[]` array\r\n3. If it succeeds, try to read contents, fail\r\n\r\nThe problem here is that during step (2), a large buffer allocation may well run process out of (heap) memory -- especially so if attacker manages to inject multiple broken messages.\r\n\r\nFix is to avoid eager allocation of big buffers and only allocate buffers as needed, along reading of the payload.\r\n\r\n\r\n\r\n\r\n\r\n\r\n","closed_by":{"login":"cowtowncoder","id":55065,"node_id":"MDQ6VXNlcjU1MDY1","avatar_url":"https://avatars.githubusercontent.com/u/55065?v=4","gravatar_id":"","url":"https://api.github.com/users/cowtowncoder","html_url":"https://github.com/cowtowncoder","followers_url":"https://api.github.com/users/cowtowncoder/followers","following_url":"https://api.github.com/users/cowtowncoder/following{/other_user}","gists_url":"https://api.github.com/users/cowtowncoder/gists{/gist_id}","starred_url":"https://api.github.com/users/cowtowncoder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cowtowncoder/subscriptions","organizations_url":"https://api.github.com/users/cowtowncoder/orgs","repos_url":"https://api.github.com/users/cowtowncoder/repos","events_url":"https://api.github.com/users/cowtowncoder/events{/privacy}","received_events_url":"https://api.github.com/users/cowtowncoder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/3328/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/3328/timeline","performed_via_github_app":null,"state_reason":"completed"}