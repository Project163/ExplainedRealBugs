{"url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/1998","repository_url":"https://api.github.com/repos/FasterXML/jackson-databind","labels_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/1998/labels{/name}","comments_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/1998/comments","events_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/1998/events","html_url":"https://github.com/FasterXML/jackson-databind/issues/1998","id":313738806,"node_id":"MDU6SXNzdWUzMTM3Mzg4MDY=","number":1998,"title":"Removing \"type\" attribute with Mixin not taken in account if using ObjectMapper.copy()","user":{"login":"SBKila","id":11612777,"node_id":"MDQ6VXNlcjExNjEyNzc3","avatar_url":"https://avatars.githubusercontent.com/u/11612777?v=4","gravatar_id":"","url":"https://api.github.com/users/SBKila","html_url":"https://github.com/SBKila","followers_url":"https://api.github.com/users/SBKila/followers","following_url":"https://api.github.com/users/SBKila/following{/other_user}","gists_url":"https://api.github.com/users/SBKila/gists{/gist_id}","starred_url":"https://api.github.com/users/SBKila/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SBKila/subscriptions","organizations_url":"https://api.github.com/users/SBKila/orgs","repos_url":"https://api.github.com/users/SBKila/repos","events_url":"https://api.github.com/users/SBKila/events{/privacy}","received_events_url":"https://api.github.com/users/SBKila/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/FasterXML/jackson-databind/milestones/92","html_url":"https://github.com/FasterXML/jackson-databind/milestone/92","labels_url":"https://api.github.com/repos/FasterXML/jackson-databind/milestones/92/labels","id":3246804,"node_id":"MDk6TWlsZXN0b25lMzI0NjgwNA==","number":92,"title":"2.9.6","description":"Release notes: https://github.com/FasterXML/jackson/wiki/Jackson-Release-2.9.6","creator":{"login":"cowtowncoder","id":55065,"node_id":"MDQ6VXNlcjU1MDY1","avatar_url":"https://avatars.githubusercontent.com/u/55065?v=4","gravatar_id":"","url":"https://api.github.com/users/cowtowncoder","html_url":"https://github.com/cowtowncoder","followers_url":"https://api.github.com/users/cowtowncoder/followers","following_url":"https://api.github.com/users/cowtowncoder/following{/other_user}","gists_url":"https://api.github.com/users/cowtowncoder/gists{/gist_id}","starred_url":"https://api.github.com/users/cowtowncoder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cowtowncoder/subscriptions","organizations_url":"https://api.github.com/users/cowtowncoder/orgs","repos_url":"https://api.github.com/users/cowtowncoder/repos","events_url":"https://api.github.com/users/cowtowncoder/events{/privacy}","received_events_url":"https://api.github.com/users/cowtowncoder/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":23,"state":"closed","created_at":"2018-04-06T03:10:15Z","updated_at":"2021-03-04T04:11:20Z","due_on":"2018-06-12T07:00:00Z","closed_at":"2021-03-04T04:11:20Z"},"comments":3,"created_at":"2018-04-12T13:56:56Z","updated_at":"2018-04-19T21:39:53Z","closed_at":"2018-04-19T05:40:28Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Hi,\r\n\r\n# Objectif\r\nI'd like to remove several attributes and in particular type from serialization output\r\n\r\n# What I'm doing\r\n\r\nI'm using Mixin concept to remove the attribute 'type' like follow.\r\n`@JsonTypeInfo(use = JsonTypeInfo.Id.NONE, include = JsonTypeInfo.As.EXISTING_PROPERTY)`\r\n\r\nI have a static ObjectMapper created with all my default settings and I clone it `.copy();`  each time I need to use a new one.\r\n\r\n1. When only one object is used all perfectly working. **_testA_OK_**\r\n2. But if I use more than one mapper, Mixin are taken in account expect `@JsonTypeInfo(use = JsonTypeInfo.Id.NONE, include = JsonTypeInfo.As.EXISTING_PROPERTY)` **_testB_OK_**\r\n3. If I replace ObjectMapper.copy() by a new ObjectMapper(), all perfectly working **_testC_OK_**\r\n\r\n\r\n# JUnit Test class \r\n`\r\npublic class ObjectMapperCopyTest {\r\n\r\n    private static final ObjectMapper DEFAULT_MAPPER;\r\n    final static String FULLMODEL=\"{\\\"format\\\":\\\"1.0\\\",\\\"child\\\":{\\\"type\\\":\\\"CHILD_B\\\",\\\"name\\\":\\\"testB\\\"},\\\"notVisible\\\":\\\"should not be present\\\"}\";\r\n    final static String EXPECTED=\"{\\\"format\\\":\\\"1.0\\\",\\\"child\\\":{\\\"name\\\":\\\"testB\\\"}}\";\r\n    static {\r\n        DEFAULT_MAPPER = new ObjectMapper().setSerializationInclusion(JsonInclude.Include.NON_EMPTY)\r\n                .configure(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS, false)\r\n                .configure(MapperFeature.ALLOW_COERCION_OF_SCALARS, false)\r\n                .configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, true)\r\n                .configure(JsonParser.Feature.ALLOW_COMMENTS, true)\r\n                .registerModule(new JavaTimeModule())\r\n                .findAndRegisterModules();\r\n    }\r\n\r\n    public class MyModelView {\r\n    }\r\n\r\n    interface MixinConfig {\r\n        interface MyModelRoot {\r\n            @JsonView(MyModelView.class)\r\n            public String getFormat();\r\n\r\n            @JsonView(MyModelView.class)\r\n            public MyModelChildBase getChild();\r\n        }\r\n\r\n        @JsonTypeInfo(use = JsonTypeInfo.Id.NONE, include = JsonTypeInfo.As.EXISTING_PROPERTY) interface MyModelChildBase {\r\n            @JsonView(MyModelView.class)\r\n            public String getName();\r\n        }\r\n\r\n    }\r\n\r\n    class MyModelRoot {\r\n        @JsonProperty\r\n        @NotNull\r\n        private String format = \"1.0\";\r\n\r\n        public String getFormat() {\r\n            return format;\r\n        }\r\n        @JsonProperty\r\n        private MyModelChildBase child;\r\n\r\n        public MyModelChildBase getChild() {\r\n            return child;\r\n        }\r\n\r\n        public void setChild(MyModelChildBase child) {\r\n            this.child = child;\r\n        }\r\n\r\n        @JsonProperty\r\n        @NotNull\r\n        private String notVisible = \"should not be present\";\r\n\r\n        public String getNotVisible() {\r\n            return notVisible;\r\n        }\r\n    }\r\n\r\n    @JsonTypeInfo(use = JsonTypeInfo.Id.NAME, property = \"type\")\r\n    @JsonSubTypes({\r\n            @JsonSubTypes.Type(value = MyChildA.class, name = \"CHILD_A\")\r\n            ,\r\n            @JsonSubTypes.Type(value = MyChildB.class, name = \"CHILD_B\")\r\n    })\r\n    abstract class MyModelChildBase {\r\n        @JsonProperty\r\n        private String name;\r\n\r\n        public String getName() {\r\n            return name;\r\n        }\r\n\r\n        @JsonIgnore\r\n        public void setName(String name) {\r\n            this.name = name;\r\n        }\r\n    }\r\n\r\n    class MyChildA extends MyModelChildBase {\r\n        public MyChildA(String name) {\r\n            setName(name);\r\n        }\r\n\r\n    }\r\n\r\n    class MyChildB extends MyModelChildBase {\r\n        public MyChildB(String name) {\r\n            setName(name);\r\n        }\r\n    }\r\n\r\n    @Test\r\n    public void testA_OK() {\r\n\r\n        MyModelRoot myModelInstance = new MyModelRoot();\r\n        myModelInstance.setChild(new MyChildB(\"testB\"));\r\n\r\n        ObjectMapper myObjectMapper = DEFAULT_MAPPER.copy();\r\n\r\n        myObjectMapper.addMixIn(MyModelRoot.class, MixinConfig.MyModelRoot.class)\r\n                .addMixIn(MyModelChildBase.class, MixinConfig.MyModelChildBase.class)\r\n                .disable(MapperFeature.DEFAULT_VIEW_INCLUSION)\r\n                .setConfig(myObjectMapper.getSerializationConfig().withView(MyModelView.class));\r\n\r\n        String result = getString(myModelInstance, myObjectMapper);\r\n        System.out.println(\"result: \"+result);\r\n        Assert.assertEquals(EXPECTED, result);\r\n\r\n    }\r\n\r\n\r\n    @Test\r\n    public void testB_KO() {\r\n\r\n        MyModelRoot myModelInstance = new MyModelRoot();\r\n        myModelInstance.setChild(new MyChildB(\"testB\"));\r\n\r\n        ObjectMapper myObjectMapper = DEFAULT_MAPPER.copy();\r\n\r\n        String postResult = getString(myModelInstance, myObjectMapper);\r\n        Assert.assertEquals(FULLMODEL, postResult);\r\n        System.out.println(\"postResult: \"+postResult);\r\n\r\n        myObjectMapper = DEFAULT_MAPPER.copy();\r\n        myObjectMapper.addMixIn(MyModelRoot.class, MixinConfig.MyModelRoot.class)\r\n                .addMixIn(MyModelChildBase.class, MixinConfig.MyModelChildBase.class)\r\n                .disable(MapperFeature.DEFAULT_VIEW_INCLUSION)\r\n                .setConfig(myObjectMapper.getSerializationConfig().withView(MyModelView.class));\r\n\r\n        String result = getString(myModelInstance, myObjectMapper);\r\n        System.out.println(\"result: \"+result);\r\n        Assert.assertEquals(EXPECTED, result);\r\n\r\n    }\r\n\r\n    @Test\r\n    public void testC_OK() {\r\n\r\n        MyModelRoot myModelInstance = new MyModelRoot();\r\n        myModelInstance.setChild(new MyChildB(\"testB\"));\r\n\r\n        ObjectMapper myObjectMapper = getObjectMapper();\r\n\r\n        String postResult = getString(myModelInstance, myObjectMapper);\r\n        Assert.assertEquals(FULLMODEL, postResult);\r\n        System.out.println(\"postResult: \"+postResult);\r\n\r\n        myObjectMapper = getObjectMapper();\r\n\r\n        myObjectMapper.addMixIn(MyModelRoot.class, MixinConfig.MyModelRoot.class)\r\n                .addMixIn(MyModelChildBase.class, MixinConfig.MyModelChildBase.class)\r\n                .disable(MapperFeature.DEFAULT_VIEW_INCLUSION)\r\n                .setConfig(myObjectMapper.getSerializationConfig().withView(MyModelView.class));\r\n\r\n        String result = getString(myModelInstance, myObjectMapper);\r\n        System.out.println(\"result: \"+result);\r\n        Assert.assertEquals(EXPECTED, result);\r\n\r\n    }\r\n\r\n    private ObjectMapper getObjectMapper() {\r\n        return new ObjectMapper().setSerializationInclusion(JsonInclude.Include.NON_EMPTY)\r\n                .configure(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS, false)\r\n                .configure(MapperFeature.ALLOW_COERCION_OF_SCALARS, false)\r\n                .configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, true)\r\n                .configure(JsonParser.Feature.ALLOW_COMMENTS, true)\r\n                .registerModule(new JavaTimeModule())\r\n                .findAndRegisterModules();\r\n    }\r\n\r\n    private String getString(MyModelRoot myModelInstance, ObjectMapper myObjectMapper) {\r\n        CharArrayWriter writer = new CharArrayWriter();\r\n        try {\r\n            myObjectMapper.writerFor(MyModelRoot.class).writeValue(writer, myModelInstance);\r\n\r\n        } catch (IOException e) {\r\n            e.printStackTrace();\r\n        }\r\n        return writer.toString();\r\n    }\r\n}\r\n`","closed_by":{"login":"cowtowncoder","id":55065,"node_id":"MDQ6VXNlcjU1MDY1","avatar_url":"https://avatars.githubusercontent.com/u/55065?v=4","gravatar_id":"","url":"https://api.github.com/users/cowtowncoder","html_url":"https://github.com/cowtowncoder","followers_url":"https://api.github.com/users/cowtowncoder/followers","following_url":"https://api.github.com/users/cowtowncoder/following{/other_user}","gists_url":"https://api.github.com/users/cowtowncoder/gists{/gist_id}","starred_url":"https://api.github.com/users/cowtowncoder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cowtowncoder/subscriptions","organizations_url":"https://api.github.com/users/cowtowncoder/orgs","repos_url":"https://api.github.com/users/cowtowncoder/repos","events_url":"https://api.github.com/users/cowtowncoder/events{/privacy}","received_events_url":"https://api.github.com/users/cowtowncoder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/1998/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/1998/timeline","performed_via_github_app":null,"state_reason":"completed"}