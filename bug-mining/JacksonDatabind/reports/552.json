{"url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/2725","repository_url":"https://api.github.com/repos/FasterXML/jackson-databind","labels_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/2725/labels{/name}","comments_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/2725/comments","events_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/2725/events","html_url":"https://github.com/FasterXML/jackson-databind/issues/2725","id":620308589,"node_id":"MDU6SXNzdWU2MjAzMDg1ODk=","number":2725,"title":"JsonCreator on static method in Enum and Enum used as key in map fails randomly","user":{"login":"BigMichi1","id":91786,"node_id":"MDQ6VXNlcjkxNzg2","avatar_url":"https://avatars.githubusercontent.com/u/91786?v=4","gravatar_id":"","url":"https://api.github.com/users/BigMichi1","html_url":"https://github.com/BigMichi1","followers_url":"https://api.github.com/users/BigMichi1/followers","following_url":"https://api.github.com/users/BigMichi1/following{/other_user}","gists_url":"https://api.github.com/users/BigMichi1/gists{/gist_id}","starred_url":"https://api.github.com/users/BigMichi1/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BigMichi1/subscriptions","organizations_url":"https://api.github.com/users/BigMichi1/orgs","repos_url":"https://api.github.com/users/BigMichi1/repos","events_url":"https://api.github.com/users/BigMichi1/events{/privacy}","received_events_url":"https://api.github.com/users/BigMichi1/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/FasterXML/jackson-databind/milestones/114","html_url":"https://github.com/FasterXML/jackson-databind/milestone/114","labels_url":"https://api.github.com/repos/FasterXML/jackson-databind/milestones/114/labels","id":5382606,"node_id":"MDk6TWlsZXN0b25lNTM4MjYwNg==","number":114,"title":"2.11.1","description":"Release notes: https://github.com/FasterXML/jackson/wiki/Jackson-Release-2.11.1","creator":{"login":"cowtowncoder","id":55065,"node_id":"MDQ6VXNlcjU1MDY1","avatar_url":"https://avatars.githubusercontent.com/u/55065?v=4","gravatar_id":"","url":"https://api.github.com/users/cowtowncoder","html_url":"https://github.com/cowtowncoder","followers_url":"https://api.github.com/users/cowtowncoder/followers","following_url":"https://api.github.com/users/cowtowncoder/following{/other_user}","gists_url":"https://api.github.com/users/cowtowncoder/gists{/gist_id}","starred_url":"https://api.github.com/users/cowtowncoder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cowtowncoder/subscriptions","organizations_url":"https://api.github.com/users/cowtowncoder/orgs","repos_url":"https://api.github.com/users/cowtowncoder/repos","events_url":"https://api.github.com/users/cowtowncoder/events{/privacy}","received_events_url":"https://api.github.com/users/cowtowncoder/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":10,"state":"closed","created_at":"2020-05-04T21:18:01Z","updated_at":"2021-03-04T04:21:58Z","due_on":"2020-06-25T07:00:00Z","closed_at":"2021-03-04T04:21:58Z"},"comments":6,"created_at":"2020-05-18T15:37:55Z","updated_at":"2020-05-19T22:50:53Z","closed_at":"2020-05-19T22:50:53Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"given this piece of code and jackson-databind 2.10.3\r\n```java\r\n\r\nimport java.util.HashMap;\r\nimport java.util.Map;\r\n\r\nimport com.fasterxml.jackson.annotation.JsonCreator;\r\nimport com.fasterxml.jackson.annotation.JsonValue;\r\nimport com.fasterxml.jackson.core.JsonProcessingException;\r\nimport com.fasterxml.jackson.core.type.TypeReference;\r\nimport com.fasterxml.jackson.databind.ObjectMapper;\r\n\r\npublic class Test {\r\n    public static void main(String[] args) throws JsonProcessingException {\r\n        final ObjectMapper mapper = new ObjectMapper();\r\n\r\n        final Map<TestEnum, String> input = new HashMap<>();\r\n        input.put(TestEnum.FOO, \"Hello\");\r\n        final String inputJson = mapper.writeValueAsString(input);\r\n        System.out.println(\"inputJson = \" + inputJson);\r\n\r\n        final Map<TestEnum, String> output = mapper.readValue(inputJson, new TypeReference<Map<TestEnum, String>>() {\r\n        });\r\n        System.out.println(\"output = \" + output);\r\n    }\r\n\r\n    private enum TestEnum {\r\n        FOO(1);\r\n\r\n        private final int i;\r\n\r\n        TestEnum(final int i) {\r\n            this.i = i;\r\n        }\r\n\r\n        @JsonValue\r\n        public int getI() {\r\n            return i;\r\n        }\r\n\r\n        @JsonCreator\r\n        public static TestEnum getByIntegerId(final Integer id) {\r\n            return id == FOO.i ? FOO : null;\r\n        }\r\n\r\n        @JsonCreator\r\n        public static TestEnum getByStringId(final String id) {\r\n            return Integer.parseInt(id) == FOO.i ? FOO : null;\r\n        }\r\n    }\r\n}\r\n```\r\nand running it on multiple computers the output is different.\r\nsometimes it works and the map is deserialized correctly and sometimes it does not work and fails with `Exception in thread \"main\" java.lang.IllegalArgumentException: Parameter #0 type for factory method ([method foo.Test$TestEnum#getByIntegerId(1 params)]) not suitable, must be java.lang.String\r\n`\r\n\r\nnow when I change the order of the methods annotated with JsonCreator it works, but then it started to fail on other computers with the same exception as above.\r\n\r\nI tried to debug this and found out that sometimes the order of the annotated methods is different that is iterated over in `BasicDeserializerFactory#_createEnumKeyDeserializer` when taking a look at the `beanDesc.getFactoryMethods()` methods. These list of methods as far as I could see is created in `AnnotatedCreatorCollector#_findPotentialFactories` via `ClassUtil.getClassMethods` which then calls `ClassUtil.getDeclaredMethods(cls)` and this is using `Class#getDeclaredMethods` which as written in the JavaDoc that the methods `elements in the returned array are not sorted and are not in any particular order.` So this is now probably the root of the issues which I can see. And as the loop stops with the exception after the first candidate has been checked in `BasicDeserializerFactory` the remaining methods are not taken into consideration.\r\n\r\nFrom my perspective, all annotated methods need to be checked before the exception can be thrown or at least the annotation parser should fail when multiple creators are detected. \r\n","closed_by":{"login":"cowtowncoder","id":55065,"node_id":"MDQ6VXNlcjU1MDY1","avatar_url":"https://avatars.githubusercontent.com/u/55065?v=4","gravatar_id":"","url":"https://api.github.com/users/cowtowncoder","html_url":"https://github.com/cowtowncoder","followers_url":"https://api.github.com/users/cowtowncoder/followers","following_url":"https://api.github.com/users/cowtowncoder/following{/other_user}","gists_url":"https://api.github.com/users/cowtowncoder/gists{/gist_id}","starred_url":"https://api.github.com/users/cowtowncoder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cowtowncoder/subscriptions","organizations_url":"https://api.github.com/users/cowtowncoder/orgs","repos_url":"https://api.github.com/users/cowtowncoder/repos","events_url":"https://api.github.com/users/cowtowncoder/events{/privacy}","received_events_url":"https://api.github.com/users/cowtowncoder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/2725/reactions","total_count":7,"+1":6,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":1},"timeline_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/2725/timeline","performed_via_github_app":null,"state_reason":"completed"}