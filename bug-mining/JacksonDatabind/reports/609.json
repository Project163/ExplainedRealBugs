{"url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/3235","repository_url":"https://api.github.com/repos/FasterXML/jackson-databind","labels_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/3235/labels{/name}","comments_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/3235/comments","events_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/3235/events","html_url":"https://github.com/FasterXML/jackson-databind/issues/3235","id":963726301,"node_id":"MDU6SXNzdWU5NjM3MjYzMDE=","number":3235,"title":"`USE_BASE_TYPE_AS_DEFAULT_IMPL` not working with `DefaultTypeResolverBuilder`","user":{"login":"sialais","id":41794887,"node_id":"MDQ6VXNlcjQxNzk0ODg3","avatar_url":"https://avatars.githubusercontent.com/u/41794887?v=4","gravatar_id":"","url":"https://api.github.com/users/sialais","html_url":"https://github.com/sialais","followers_url":"https://api.github.com/users/sialais/followers","following_url":"https://api.github.com/users/sialais/following{/other_user}","gists_url":"https://api.github.com/users/sialais/gists{/gist_id}","starred_url":"https://api.github.com/users/sialais/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sialais/subscriptions","organizations_url":"https://api.github.com/users/sialais/orgs","repos_url":"https://api.github.com/users/sialais/repos","events_url":"https://api.github.com/users/sialais/events{/privacy}","received_events_url":"https://api.github.com/users/sialais/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2021-08-09T07:36:13Z","updated_at":"2021-09-19T03:52:16Z","closed_at":"2021-09-19T03:15:25Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Describe the bug**\r\nDefaultTypeResolverBuilder can not find the right class while enable `MapperFeature.USE_BASE_TYPE_AS_DEFAULT_IMPL` and default type for abstract at the same time.\r\n\r\n**Version information**\r\n`2.12.4`, \r\n\r\n**To Reproduce**\r\nhere's example with four tests:\r\n\r\n```java\r\n\r\n@Slf4j\r\npublic class TypeResolverTesting {\r\n\r\n    public static class Foo {\r\n        public String strFoo;\r\n    }\r\n\r\n    public static class Bar {\r\n        public String strBar;\r\n        public Map mapBar;\r\n    }\r\n\r\n    public static class MapFooBar {\r\n        public Map fooBar;\r\n    }\r\n\r\n    public static class ExplicitFooBar {\r\n        public Foo foo;\r\n        public Bar bar;\r\n    }\r\n\r\n    private <T> T deserializationTest(String input, Class<T> type) throws Exception {\r\n        ObjectMapper objectMapper = new ObjectMapper();\r\n        objectMapper.registerModule(new SimpleModule().addAbstractTypeMapping(Map.class, LinkedHashMap.class));\r\n        objectMapper.enable(MapperFeature.USE_BASE_TYPE_AS_DEFAULT_IMPL);\r\n\r\n        // init & setting default typing\r\n        TypeResolverBuilder<?> typer = new ObjectMapper.DefaultTypeResolverBuilder(\r\n                ObjectMapper.DefaultTyping.NON_FINAL, LaissezFaireSubTypeValidator.instance);\r\n        // we'll always use full class name, when using defaulting\r\n        typer = typer.init(JsonTypeInfo.Id.CLASS, null);\r\n        typer = typer.inclusion(JsonTypeInfo.As.PROPERTY);\r\n        objectMapper.setDefaultTyping(typer);\r\n\r\n        return objectMapper.readValue(input, type);\r\n    }\r\n\r\n    @Test\r\n    void testFoo() throws Exception {\r\n        // Test Passed\r\n        String sFoo = \"{\" +\r\n                \"      \\\"strFoo\\\": \\\"foooooo\\\"\" +\r\n                \"    }\";\r\n        assert null != deserializationTest(sFoo, Foo.class);\r\n    }\r\n\r\n    @Test\r\n    void testBar() throws Exception{\r\n        // Test Failed with missing type id property '@class'\r\n        String sBar = \"{\" +\r\n                \"      \\\"strBar\\\": \\\"fooooooy\\\",\" +\r\n                \"      \\\"mapBar\\\": {\" +\r\n                \"        \\\"a\\\": \\\"aaaa\\\",\" +\r\n                \"        \\\"b\\\": \\\"bbbb\\\"\" +\r\n                \"      }\" +\r\n                \"    }\";\r\n        assert null != deserializationTest(sBar, Bar.class);\r\n    }\r\n\r\n    @Test\r\n    void testMapFooBar() throws Exception {\r\n        // Test Failed with missing type id property '@class' for TypeResolverTesting$Bar.\r\n        // test will pass while adding \"@class\": \"test.example.TypeResolverTesting$MapFooBar\" to object mapFooBar\r\n        // but still failed adding \"@class\": \"test.example.TypeResolverTesting$Bar\" to object bar ( resolve TypeResolverTesting$MapFooBar failed )\r\n\r\n        String s = \"{\" +\r\n                \"  \\\"fooBar\\\": {\" +\r\n                \"    \\\"x\\\": {\" +\r\n                \"      \\\"strFoo\\\": \\\"foooooox\\\"\" +\r\n                \"    },\" +\r\n                \"    \\\"y\\\": {\" +\r\n                \"      \\\"strBar\\\": \\\"fooooooy\\\",\" +\r\n                \"      \\\"mapBar\\\": {\" +\r\n                \"        \\\"a\\\": \\\"aaaa\\\",\" +\r\n                \"        \\\"b\\\": \\\"bbbb\\\"\" +\r\n                \"      }\" +\r\n                \"    }\" +\r\n                \"  }\" +\r\n                \"}\";\r\n        assert null != deserializationTest(s, MapFooBar.class);\r\n    }\r\n\r\n    @Test\r\n    void testExplicitFooBar() throws Exception {\r\n        // Test Passed\r\n        String s = \"  {\" +\r\n                \"  \\\"@class\\\": \\\"test.example.TypeResolverTesting$ExplicitFooBar\\\",\" +\r\n                \"    \\\"foo\\\": {\" +\r\n                \"      \\\"strFoo\\\": \\\"foooooo\\\"\" +\r\n                \"    },\" +\r\n                \"    \\\"bar\\\": {\" +\r\n                \"      \\\"strBar\\\": \\\"barrrrr\\\",\" +\r\n                \"      \\\"mapBar\\\": {\" +\r\n                \"        \\\"a\\\": \\\"aaaa\\\",\" +\r\n                \"        \\\"b\\\": \\\"bbbb\\\"\" +\r\n                \"      }\" +\r\n                \"    }\" +\r\n                \"  }\";\r\n        assert null != deserializationTest(s, ExplicitFooBar.class);\r\n    }\r\n}\r\n```\r\n\r\n**Expected behavior**\r\nAll tests in reproduce example should passed.\r\n\r\n**Additional context**\r\n\r\nProblem\r\n mainly caused by `defineDefaultImpl` in [StdTypeResolverBuilder](https://github.com/FasterXML/jackson-databind/blob/2.13/src/main/java/com/fasterxml/jackson/databind/jsontype/impl/StdTypeResolverBuilder.java#L173).\r\n\r\nif Map resolved is in prior to Foo/Bar, then\r\nvariable `_defaultImpl` in StdTypeResolverBuilder has been given a value for `AbstractTypeMapping` and then it is not null, and Type Resolve failed.\r\nIn contrast, if Foo/Bar resolved first, or Map has not been resolved, `defineDefaultImpl` is null, then`USE_BASE_TYPE_AS_DEFAULT_IMPL` will work.\r\n\r\n\r\n\r\n","closed_by":{"login":"cowtowncoder","id":55065,"node_id":"MDQ6VXNlcjU1MDY1","avatar_url":"https://avatars.githubusercontent.com/u/55065?v=4","gravatar_id":"","url":"https://api.github.com/users/cowtowncoder","html_url":"https://github.com/cowtowncoder","followers_url":"https://api.github.com/users/cowtowncoder/followers","following_url":"https://api.github.com/users/cowtowncoder/following{/other_user}","gists_url":"https://api.github.com/users/cowtowncoder/gists{/gist_id}","starred_url":"https://api.github.com/users/cowtowncoder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cowtowncoder/subscriptions","organizations_url":"https://api.github.com/users/cowtowncoder/orgs","repos_url":"https://api.github.com/users/cowtowncoder/repos","events_url":"https://api.github.com/users/cowtowncoder/events{/privacy}","received_events_url":"https://api.github.com/users/cowtowncoder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/3235/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/3235/timeline","performed_via_github_app":null,"state_reason":"completed"}