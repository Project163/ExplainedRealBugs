{"url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/1551","repository_url":"https://api.github.com/repos/FasterXML/jackson-databind","labels_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/1551/labels{/name}","comments_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/1551/comments","events_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/1551/events","html_url":"https://github.com/FasterXML/jackson-databind/issues/1551","id":213340228,"node_id":"MDU6SXNzdWUyMTMzNDAyMjg=","number":1551,"title":"`JsonMappingException` with polymorphic type and `JsonIdentityInfo` when basic type is abstract","user":{"login":"acm073","id":13672944,"node_id":"MDQ6VXNlcjEzNjcyOTQ0","avatar_url":"https://avatars.githubusercontent.com/u/13672944?v=4","gravatar_id":"","url":"https://api.github.com/users/acm073","html_url":"https://github.com/acm073","followers_url":"https://api.github.com/users/acm073/followers","following_url":"https://api.github.com/users/acm073/following{/other_user}","gists_url":"https://api.github.com/users/acm073/gists{/gist_id}","starred_url":"https://api.github.com/users/acm073/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/acm073/subscriptions","organizations_url":"https://api.github.com/users/acm073/orgs","repos_url":"https://api.github.com/users/acm073/repos","events_url":"https://api.github.com/users/acm073/events{/privacy}","received_events_url":"https://api.github.com/users/acm073/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/FasterXML/jackson-databind/milestones/75","html_url":"https://github.com/FasterXML/jackson-databind/milestone/75","labels_url":"https://api.github.com/repos/FasterXML/jackson-databind/milestones/75/labels","id":2487377,"node_id":"MDk6TWlsZXN0b25lMjQ4NzM3Nw==","number":75,"title":"2.9.0.pr4","description":null,"creator":{"login":"cowtowncoder","id":55065,"node_id":"MDQ6VXNlcjU1MDY1","avatar_url":"https://avatars.githubusercontent.com/u/55065?v=4","gravatar_id":"","url":"https://api.github.com/users/cowtowncoder","html_url":"https://github.com/cowtowncoder","followers_url":"https://api.github.com/users/cowtowncoder/followers","following_url":"https://api.github.com/users/cowtowncoder/following{/other_user}","gists_url":"https://api.github.com/users/cowtowncoder/gists{/gist_id}","starred_url":"https://api.github.com/users/cowtowncoder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cowtowncoder/subscriptions","organizations_url":"https://api.github.com/users/cowtowncoder/orgs","repos_url":"https://api.github.com/users/cowtowncoder/repos","events_url":"https://api.github.com/users/cowtowncoder/events{/privacy}","received_events_url":"https://api.github.com/users/cowtowncoder/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":10,"state":"closed","created_at":"2017-04-28T03:32:01Z","updated_at":"2021-03-04T04:04:33Z","due_on":null,"closed_at":"2021-03-04T04:04:33Z"},"comments":5,"created_at":"2017-03-10T13:25:31Z","updated_at":"2017-05-03T03:11:07Z","closed_at":"2017-05-03T03:07:31Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Hi,\r\n\r\nI just came across this issue: when deserializing a polymorphic type from just the type id, deserialization fails when the base class is abstract.\r\n\r\nIn more detail:\r\nThe type hierarchy:\r\n\r\n    @JsonTypeInfo(use = JsonTypeInfo.Id.CLASS, include = JsonTypeInfo.As.PROPERTY,\r\n        property = \"@class\")\r\n    public abstract class Vehicle {\r\n        private String vehicleId;\r\n        public String getVehicleId() { return vehicleId; }\r\n        public void setVehicleId(String vehicleId) { this.vehicleId = vehicleId; }\r\n    }\r\n\r\n    public class Car extends Vehicle {\r\n        private int numberOfDoors;\r\n        public int getNumberOfDoors() { return numberOfDoors; }\r\n        public void setNumberOfDoors(int numberOfDoors) { this.numberOfDoors = numberOfDoors; }\r\n    }\r\n\r\nThe type that holds a vehicle:\r\n\r\n    public class VehicleOwner {\r\n        @JsonIdentityInfo(generator = ObjectIdGenerators.PropertyGenerator.class, property = \"vehicleId\")\r\n        @JsonIdentityReference(alwaysAsId = false)\r\n        private Vehicle ownedVehicle;\r\n        public Vehicle getOwnedVehicle() { return ownedVehicle; }\r\n        public void setOwnedVehicle(Vehicle ownedVehicle) { this.ownedVehicle = ownedVehicle; }\r\n    }\r\n\r\nTest code:\r\n\r\n    @Test\r\n    public void testSerializeDeserialize() throws IOException {\r\n        Car c = new Car();\r\n        c.setVehicleId(\"123\");\r\n        c.setNumberOfDoors(2);\r\n        // both owners own the same vehicle (car sharing ;-))\r\n        VehicleOwner v1 = new VehicleOwner();\r\n        v1.setOwnedVehicle(c);\r\n        VehicleOwner v2 = new VehicleOwner();\r\n        v2.setOwnedVehicle(c);\r\n\r\n        ObjectMapper objectMapper = new ObjectMapper();\r\n        objectMapper.enable(SerializationFeature.INDENT_OUTPUT);\r\n        String serialized = objectMapper.writeValueAsString(asList(v1, v2));\r\n        System.out.println(serialized);\r\n\r\n        VehicleOwner[] deserialized = objectMapper.readValue(serialized, VehicleOwner[].class);\r\n        assertEquals(2, deserialized.length);\r\n        assertEquals(deserialized[0].getOwnedVehicle(), deserialized[1].getOwnedVehicle());\r\n    }\r\n\r\nSerialization result (as expected, first instance is fully serialized, second one just by ID):\r\n\r\n    [ {\r\n      \"ownedVehicle\" : {\r\n        \"@class\" : \"Car\",\r\n        \"vehicleId\" : \"123\",\r\n        \"numberOfDoors\" : 2\r\n      }\r\n    }, {\r\n      \"ownedVehicle\" : \"123\"\r\n    } ]\r\n\r\nDeserialization FAILS:\r\n`com.fasterxml.jackson.databind.JsonMappingException: Unexpected token (VALUE_STRING), expected FIELD_NAME: missing property '@class' that is to contain type id  (for class Vehicle)`\r\n\r\nHowever, when the \"abstract\" modifier is removed from the `Vehicle` class, the test succeeds.","closed_by":{"login":"cowtowncoder","id":55065,"node_id":"MDQ6VXNlcjU1MDY1","avatar_url":"https://avatars.githubusercontent.com/u/55065?v=4","gravatar_id":"","url":"https://api.github.com/users/cowtowncoder","html_url":"https://github.com/cowtowncoder","followers_url":"https://api.github.com/users/cowtowncoder/followers","following_url":"https://api.github.com/users/cowtowncoder/following{/other_user}","gists_url":"https://api.github.com/users/cowtowncoder/gists{/gist_id}","starred_url":"https://api.github.com/users/cowtowncoder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cowtowncoder/subscriptions","organizations_url":"https://api.github.com/users/cowtowncoder/orgs","repos_url":"https://api.github.com/users/cowtowncoder/repos","events_url":"https://api.github.com/users/cowtowncoder/events{/privacy}","received_events_url":"https://api.github.com/users/cowtowncoder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/1551/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/1551/timeline","performed_via_github_app":null,"state_reason":"completed"}