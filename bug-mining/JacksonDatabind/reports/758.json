{"url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/4878","repository_url":"https://api.github.com/repos/FasterXML/jackson-databind","labels_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/4878/labels{/name}","comments_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/4878/comments","events_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/4878/events","html_url":"https://github.com/FasterXML/jackson-databind/issues/4878","id":2763985334,"node_id":"I_kwDOAC5e2c6kvxG2","number":4878,"title":"When serializing a Map via Converter(StdDelegatingSerializer), a NullPointerException is thrown due to missing key serializer","user":{"login":"k163377","id":24751011,"node_id":"MDQ6VXNlcjI0NzUxMDEx","avatar_url":"https://avatars.githubusercontent.com/u/24751011?v=4","gravatar_id":"","url":"https://api.github.com/users/k163377","html_url":"https://github.com/k163377","followers_url":"https://api.github.com/users/k163377/followers","following_url":"https://api.github.com/users/k163377/following{/other_user}","gists_url":"https://api.github.com/users/k163377/gists{/gist_id}","starred_url":"https://api.github.com/users/k163377/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/k163377/subscriptions","organizations_url":"https://api.github.com/users/k163377/orgs","repos_url":"https://api.github.com/users/k163377/repos","events_url":"https://api.github.com/users/k163377/events{/privacy}","received_events_url":"https://api.github.com/users/k163377/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":6636564281,"node_id":"LA_kwDOAC5e2c8AAAABi5HvOQ","url":"https://api.github.com/repos/FasterXML/jackson-databind/labels/2.18","name":"2.18","color":"1D76DB","default":false,"description":"Issues planned at 2.18 or later"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2024-12-31T05:51:45Z","updated_at":"2025-01-26T12:24:48Z","closed_at":"2025-01-26T04:30:36Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Search before asking\n\n- [X] I searched in the [issues](https://github.com/FasterXML/jackson-databind/issues) and found nothing similar.\n\n### Describe the bug\n\nFor a class that wraps a `Map`, registering and serializing a `StdDelegatingSerializer` with a `Converter` that unwraps it will throw the following error\r\n\r\n```\r\ncom.fasterxml.jackson.databind.JsonMappingException: Cannot invoke \"com.fasterxml.jackson.databind.JsonSerializer.serialize(Object, com.fasterxml.jackson.core.JsonGenerator, com.fasterxml.jackson.databind.SerializerProvider)\" because \"keySerializer\" is null (through reference chain: java.util.ImmutableCollections$Map1[\"a\"])\r\n\r\n\tat com.fasterxml.jackson.databind.JsonMappingException.wrapWithPath(JsonMappingException.java:400)\r\n\tat com.fasterxml.jackson.databind.JsonMappingException.wrapWithPath(JsonMappingException.java:359)\r\n\tat com.fasterxml.jackson.databind.ser.std.StdSerializer.wrapAndThrow(StdSerializer.java:324)\r\n\tat com.fasterxml.jackson.databind.ser.std.MapSerializer.serializeFields(MapSerializer.java:810)\r\n\tat com.fasterxml.jackson.databind.ser.std.MapSerializer.serializeWithoutTypeInfo(MapSerializer.java:763)\r\n\tat com.fasterxml.jackson.databind.ser.std.MapSerializer.serialize(MapSerializer.java:719)\r\n\tat com.fasterxml.jackson.databind.ser.std.MapSerializer.serialize(MapSerializer.java:34)\r\n\tat com.fasterxml.jackson.databind.ser.std.StdDelegatingSerializer.serialize(StdDelegatingSerializer.java:166)\r\n\tat com.fasterxml.jackson.databind.ser.DefaultSerializerProvider._serialize(DefaultSerializerProvider.java:503)\r\n\tat com.fasterxml.jackson.databind.ser.DefaultSerializerProvider.serializeValue(DefaultSerializerProvider.java:342)\r\n\tat com.fasterxml.jackson.databind.ObjectMapper._writeValueAndClose(ObjectMapper.java:4838)\r\n\tat com.fasterxml.jackson.databind.ObjectMapper.writeValueAsString(ObjectMapper.java:4079)\r\n\tat com.fasterxml.jackson.databind.Kotlin873Test.directTest(Kotlin873Test.java:61)\r\n\tat java.base/jdk.internal.reflect.DirectMethodHandleAccessor.invoke(DirectMethodHandleAccessor.java:103)\r\n\tat java.base/java.lang.reflect.Method.invoke(Method.java:580)\r\n\tat org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:59)\r\n\tat org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)\r\n\tat org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:56)\r\n\tat org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)\r\n\tat org.junit.runners.ParentRunner$3.evaluate(ParentRunner.java:306)\r\n\tat org.junit.runners.BlockJUnit4ClassRunner$1.evaluate(BlockJUnit4ClassRunner.java:100)\r\n\tat org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:366)\r\n\tat org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:103)\r\n\tat org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:63)\r\n\tat org.junit.runners.ParentRunner$4.run(ParentRunner.java:331)\r\n\tat org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:79)\r\n\tat org.junit.runners.ParentRunner.runChildren(ParentRunner.java:329)\r\n\tat org.junit.runners.ParentRunner.access$100(ParentRunner.java:66)\r\n\tat org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:293)\r\n\tat org.junit.runners.ParentRunner$3.evaluate(ParentRunner.java:306)\r\n\tat org.junit.runners.ParentRunner.run(ParentRunner.java:413)\r\n\tat org.junit.runner.JUnitCore.run(JUnitCore.java:137)\r\n\tat com.intellij.junit4.JUnit4IdeaTestRunner.startRunnerWithArgs(JUnit4IdeaTestRunner.java:69)\r\n\tat com.intellij.rt.junit.IdeaTestRunner$Repeater$1.execute(IdeaTestRunner.java:38)\r\n\tat com.intellij.rt.execution.junit.TestsRepeater.repeat(TestsRepeater.java:11)\r\n\tat com.intellij.rt.junit.IdeaTestRunner$Repeater.startRunnerWithArgs(IdeaTestRunner.java:35)\r\n\tat com.intellij.rt.junit.JUnitStarter.prepareStreamsAndStart(JUnitStarter.java:232)\r\n\tat com.intellij.rt.junit.JUnitStarter.main(JUnitStarter.java:55)\r\nCaused by: java.lang.NullPointerException: Cannot invoke \"com.fasterxml.jackson.databind.JsonSerializer.serialize(Object, com.fasterxml.jackson.core.JsonGenerator, com.fasterxml.jackson.databind.SerializerProvider)\" because \"keySerializer\" is null\r\n\tat com.fasterxml.jackson.databind.ser.std.MapSerializer.serializeFields(MapSerializer.java:796)\r\n\t... 34 more\r\n```\n\n### Version Information\n\nConfirmed on 2.18(7144db0ebdfddcd46509a23442bba2d43dd3ad5c) and 2.19(6729641f6a5e9c40c428328e73f5281b8ce529bb) branches.\n\n### Reproduction\n\nYou can run it by pasting it into `src/test/java/com/fasterxml/jackson/databind`.\r\n\r\n```java\r\npackage com.fasterxml.jackson.databind;\r\n\r\nimport com.fasterxml.jackson.core.JsonProcessingException;\r\nimport com.fasterxml.jackson.databind.module.SimpleModule;\r\nimport com.fasterxml.jackson.databind.module.SimpleSerializers;\r\nimport com.fasterxml.jackson.databind.ser.std.StdDelegatingSerializer;\r\nimport com.fasterxml.jackson.databind.util.StdConverter;\r\nimport org.junit.Test;\r\n\r\nimport java.util.Map;\r\n\r\npublic class Kotlin873Test {\r\n    // region: DTO Definitions\r\n    static class MapWrapper {\r\n        private final Map<String, Object> value;\r\n\r\n        MapWrapper(Map<String, Object> value) {\r\n            this.value = value;\r\n        }\r\n\r\n        public Map<String, Object> getValue() {\r\n            return value;\r\n        }\r\n    }\r\n    // endregion\r\n\r\n    // region: Jackson settings\r\n    static class WrapperConverter extends StdConverter<MapWrapper, Object> {\r\n        @Override\r\n        public Object convert(MapWrapper value) {\r\n            return value.getValue();\r\n        }\r\n    }\r\n\r\n    static class MySerializers extends SimpleSerializers {\r\n        @Override\r\n        public JsonSerializer<?> findSerializer(SerializationConfig config, JavaType type, BeanDescription beanDesc) {\r\n            Class<?> rawClass = type.getRawClass();\r\n            if (MapWrapper.class.isAssignableFrom(rawClass)) {\r\n                return new StdDelegatingSerializer(new WrapperConverter());\r\n            }\r\n            return super.findSerializer(config, type, beanDesc);\r\n        }\r\n    }\r\n\r\n    private final ObjectMapper mapper;\r\n\r\n    public Kotlin873Test() {\r\n        SimpleModule sm = new SimpleModule();\r\n        sm.setSerializers(new MySerializers());\r\n        mapper = new ObjectMapper().registerModule(sm);\r\n    }\r\n    // endregion\r\n\r\n    private final MapWrapper wrapper = new MapWrapper(Map.of(\"a\", 1));\r\n\r\n    @Test\r\n    public void directTest() throws JsonProcessingException {\r\n        String json = mapper.writeValueAsString(wrapper);\r\n        System.out.println(json);\r\n    }\r\n}\r\n```\n\n### Expected behavior\n\nAt least it shouldn't be a `NullPointerException`.\n\n### Additional context\n\nThis error can be suppressed by changing the definition of `WrapperConverter` as follows to make the specification to generics concrete.\r\n\r\n```java\r\nstatic class WrapperConverter extends StdConverter<MapWrapper, Map<String, Object>> {\r\n    @Override\r\n    public Map<String, Object> convert(MapWrapper value) {\r\n        return value.getValue();\r\n    }\r\n}\r\n```\r\n\r\nThis was not done because I was trying to reproduce [a problem that had been reported to `kotlin-module`](https://github.com/FasterXML/jackson-module-kotlin/issues/873).","closed_by":{"login":"cowtowncoder","id":55065,"node_id":"MDQ6VXNlcjU1MDY1","avatar_url":"https://avatars.githubusercontent.com/u/55065?v=4","gravatar_id":"","url":"https://api.github.com/users/cowtowncoder","html_url":"https://github.com/cowtowncoder","followers_url":"https://api.github.com/users/cowtowncoder/followers","following_url":"https://api.github.com/users/cowtowncoder/following{/other_user}","gists_url":"https://api.github.com/users/cowtowncoder/gists{/gist_id}","starred_url":"https://api.github.com/users/cowtowncoder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cowtowncoder/subscriptions","organizations_url":"https://api.github.com/users/cowtowncoder/orgs","repos_url":"https://api.github.com/users/cowtowncoder/repos","events_url":"https://api.github.com/users/cowtowncoder/events{/privacy}","received_events_url":"https://api.github.com/users/cowtowncoder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/4878/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/4878/timeline","performed_via_github_app":null,"state_reason":"completed"}