{"url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/2821","repository_url":"https://api.github.com/repos/FasterXML/jackson-databind","labels_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/2821/labels{/name}","comments_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/2821/comments","events_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/2821/events","html_url":"https://github.com/FasterXML/jackson-databind/issues/2821","id":680934065,"node_id":"MDU6SXNzdWU2ODA5MzQwNjU=","number":2821,"title":"Json serialization fails or a specific case that contains generics & static methods with generic parameters","user":{"login":"lhotari","id":66864,"node_id":"MDQ6VXNlcjY2ODY0","avatar_url":"https://avatars.githubusercontent.com/u/66864?v=4","gravatar_id":"","url":"https://api.github.com/users/lhotari","html_url":"https://github.com/lhotari","followers_url":"https://api.github.com/users/lhotari/followers","following_url":"https://api.github.com/users/lhotari/following{/other_user}","gists_url":"https://api.github.com/users/lhotari/gists{/gist_id}","starred_url":"https://api.github.com/users/lhotari/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lhotari/subscriptions","organizations_url":"https://api.github.com/users/lhotari/orgs","repos_url":"https://api.github.com/users/lhotari/repos","events_url":"https://api.github.com/users/lhotari/events{/privacy}","received_events_url":"https://api.github.com/users/lhotari/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/FasterXML/jackson-databind/milestones/116","html_url":"https://github.com/FasterXML/jackson-databind/milestone/116","labels_url":"https://api.github.com/repos/FasterXML/jackson-databind/milestones/116/labels","id":5762549,"node_id":"MDk6TWlsZXN0b25lNTc2MjU0OQ==","number":116,"title":"2.11.3","description":"Release notes: https://github.com/FasterXML/jackson/wiki/Jackson-Release-2.11.3\r\n","creator":{"login":"cowtowncoder","id":55065,"node_id":"MDQ6VXNlcjU1MDY1","avatar_url":"https://avatars.githubusercontent.com/u/55065?v=4","gravatar_id":"","url":"https://api.github.com/users/cowtowncoder","html_url":"https://github.com/cowtowncoder","followers_url":"https://api.github.com/users/cowtowncoder/followers","following_url":"https://api.github.com/users/cowtowncoder/following{/other_user}","gists_url":"https://api.github.com/users/cowtowncoder/gists{/gist_id}","starred_url":"https://api.github.com/users/cowtowncoder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cowtowncoder/subscriptions","organizations_url":"https://api.github.com/users/cowtowncoder/orgs","repos_url":"https://api.github.com/users/cowtowncoder/repos","events_url":"https://api.github.com/users/cowtowncoder/events{/privacy}","received_events_url":"https://api.github.com/users/cowtowncoder/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":6,"state":"closed","created_at":"2020-08-12T03:52:01Z","updated_at":"2021-03-04T04:20:43Z","due_on":"2020-10-02T07:00:00Z","closed_at":"2021-03-04T04:20:43Z"},"comments":19,"created_at":"2020-08-18T10:53:17Z","updated_at":"2020-10-20T17:44:23Z","closed_at":"2020-09-06T00:21:44Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Reproducing the issue\r\n\r\nI wasn't able to analyze the exact reason, however I have created a repository that reproduces the issue.\r\nThe problem seem to occur only with a certain structure and I wasn't yet able to isolate it further.\r\n\r\n[The test case that reproduces the issue](https://github.com/lhotari/jackson-bug-2020-08-18/blob/master/src/test/java/com/github/lhotari/jacksonbug/JacksonBugTest.java) \r\nReferences [CloudEvent](https://github.com/cloudevents/sdk-java/blob/v1.3.0/api/src/main/java/io/cloudevents/CloudEvent.java), [CloudEventImpl](https://github.com/cloudevents/sdk-java/blob/v1.3.0/api/src/main/java/io/cloudevents/v1/CloudEventImpl.java) and [AttributesImpl](https://github.com/cloudevents/sdk-java/blob/v1.3.0/api/src/main/java/io/cloudevents/v1/AttributesImpl.java) classes from CloudEvents Java SDK 1.3.0 .\r\n\r\n\r\nto reproduce:\r\n```\r\ngit clone https://github.com/lhotari/jackson-bug-2020-08-18\r\ncd jackson-bug-2020-08-18\r\n./gradlew test\r\n```\r\n\r\nfails with exception.\r\n```\r\ncom.github.lhotari.jacksonbug.JacksonBugTest > reproduceSerializerBug() FAILED\r\n    com.fasterxml.jackson.databind.JsonMappingException: Strange Map type java.util.Map: cannot determine type parameters (through reference chain: com.github.lhotari.jacksonbug.JacksonBugTest$MyValue[\"events\"]->java.util.Collections$SingletonList[0]->io.cloudevents.v1.CloudEventImpl[\"attributes\"])\r\n        at com.fasterxml.jackson.databind.JsonMappingException.from(JsonMappingException.java:295)\r\n        at com.fasterxml.jackson.databind.SerializerProvider.reportMappingProblem(SerializerProvider.java:1309)\r\n        at com.fasterxml.jackson.databind.SerializerProvider._createAndCacheUntypedSerializer(SerializerProvider.java:1447)\r\n        at com.fasterxml.jackson.databind.SerializerProvider.findValueSerializer(SerializerProvider.java:562)\r\n        at com.fasterxml.jackson.databind.ser.impl.UnwrappingBeanPropertyWriter._findAndAddDynamic(UnwrappingBeanPropertyWriter.java:211)\r\n        at com.fasterxml.jackson.databind.ser.impl.UnwrappingBeanPropertyWriter.serializeAsField(UnwrappingBeanPropertyWriter.java:102)\r\n        at com.fasterxml.jackson.databind.ser.std.BeanSerializerBase.serializeFields(BeanSerializerBase.java:755)\r\n        at com.fasterxml.jackson.databind.ser.BeanSerializer.serialize(BeanSerializer.java:178)\r\n        at com.fasterxml.jackson.databind.ser.impl.IndexedListSerializer.serializeContents(IndexedListSerializer.java:119)\r\n        at com.fasterxml.jackson.databind.ser.impl.IndexedListSerializer.serialize(IndexedListSerializer.java:79)\r\n        at com.fasterxml.jackson.databind.ser.impl.IndexedListSerializer.serialize(IndexedListSerializer.java:18)\r\n        at com.fasterxml.jackson.databind.ser.BeanPropertyWriter.serializeAsField(BeanPropertyWriter.java:728)\r\n        at com.fasterxml.jackson.databind.ser.std.BeanSerializerBase.serializeFields(BeanSerializerBase.java:755)\r\n        at com.fasterxml.jackson.databind.ser.BeanSerializer.serialize(BeanSerializer.java:178)\r\n        at com.fasterxml.jackson.databind.ser.DefaultSerializerProvider._serialize(DefaultSerializerProvider.java:480)\r\n        at com.fasterxml.jackson.databind.ser.DefaultSerializerProvider.serializeValue(DefaultSerializerProvider.java:319)\r\n        at com.fasterxml.jackson.databind.ObjectMapper._writeValueAndClose(ObjectMapper.java:4407)\r\n        at com.fasterxml.jackson.databind.ObjectMapper.writeValueAsString(ObjectMapper.java:3661)\r\n        at com.github.lhotari.jacksonbug.JacksonBugTest.reproduceSerializerBug(JacksonBugTest.java:39)\r\n\r\n        Caused by:\r\n        java.lang.IllegalArgumentException: Strange Map type java.util.Map: cannot determine type parameters\r\n            at com.fasterxml.jackson.databind.type.TypeFactory._mapType(TypeFactory.java:1178)\r\n            at com.fasterxml.jackson.databind.type.TypeFactory._fromWellKnownClass(TypeFactory.java:1471)\r\n            at com.fasterxml.jackson.databind.type.TypeFactory._fromClass(TypeFactory.java:1414)\r\n            at com.fasterxml.jackson.databind.type.TypeFactory.constructType(TypeFactory.java:705)\r\n            at com.fasterxml.jackson.databind.introspect.AnnotatedClass.resolveType(AnnotatedClass.java:229)\r\n            at com.fasterxml.jackson.databind.introspect.AnnotatedMethod.getParameterType(AnnotatedMethod.java:143)\r\n            at com.fasterxml.jackson.databind.introspect.AnnotatedWithParams.getParameter(AnnotatedWithParams.java:86)\r\n            at com.fasterxml.jackson.databind.introspect.POJOPropertiesCollector._addCreators(POJOPropertiesCollector.java:500)\r\n            at com.fasterxml.jackson.databind.introspect.POJOPropertiesCollector.collectAll(POJOPropertiesCollector.java:327)\r\n            at com.fasterxml.jackson.databind.introspect.POJOPropertiesCollector.getJsonValueAccessor(POJOPropertiesCollector.java:203)\r\n            at com.fasterxml.jackson.databind.introspect.BasicBeanDescription.findJsonValueAccessor(BasicBeanDescription.java:252)\r\n            at com.fasterxml.jackson.databind.ser.BasicSerializerFactory.findSerializerByAnnotations(BasicSerializerFactory.java:396)\r\n            at com.fasterxml.jackson.databind.ser.BeanSerializerFactory._createSerializer2(BeanSerializerFactory.java:216)\r\n            at com.fasterxml.jackson.databind.ser.BeanSerializerFactory.createSerializer(BeanSerializerFactory.java:165)\r\n            at com.fasterxml.jackson.databind.SerializerProvider._createUntypedSerializer(SerializerProvider.java:1474)\r\n            at com.fasterxml.jackson.databind.SerializerProvider._createAndCacheUntypedSerializer(SerializerProvider.java:1442)\r\n            ... 16 more\r\n```\r\n\r\n## Comments\r\n\r\n* Test passes with Jackson 2.11.1 version, but fails with [2.11.2](https://github.com/FasterXML/jackson/wiki/Jackson-Release-2.11.2) .\r\n* [Diff between Jackson 2.11.2 and 2.11.1](https://github.com/FasterXML/jackson-databind/compare/jackson-databind-2.11.1...jackson-databind-2.11.2)\r\n\r\nChanges in TypeFactory.constructType in 2.11.2 for https://github.com/FasterXML/jackson-databind/issues/2796 might have caused the change in behavior.\r\nLooks like the problem that https://github.com/FasterXML/jackson-databind/commit/910edfb634f55cdb8d78ac7d9caf00d8133a11e6 fixes could have been similar.\r\n\r\nBy debugging it can be seen that resolving parameter types with the bindings in AnnotedClass doesn't produce the correct result.\r\n\r\nAnother observation here is that the method that is been processed by Jackson is produced by a lambda. The method name in the repro case is `private static void io.cloudevents.v1.AttributesImpl.lambda$marshal$3(java.util.Map,java.time.ZonedDateTime)`\r\n\r\nThe failure seems to happen when Jackson tries to resolve the parameters for this method generated by the lambda defined at this location:\r\n\r\nhttps://github.com/cloudevents/sdk-java/blob/361a34cc639ddaa75b2a5080f117fc282be7625b/api/src/main/java/io/cloudevents/v1/AttributesImpl.java#L172-L173","closed_by":{"login":"cowtowncoder","id":55065,"node_id":"MDQ6VXNlcjU1MDY1","avatar_url":"https://avatars.githubusercontent.com/u/55065?v=4","gravatar_id":"","url":"https://api.github.com/users/cowtowncoder","html_url":"https://github.com/cowtowncoder","followers_url":"https://api.github.com/users/cowtowncoder/followers","following_url":"https://api.github.com/users/cowtowncoder/following{/other_user}","gists_url":"https://api.github.com/users/cowtowncoder/gists{/gist_id}","starred_url":"https://api.github.com/users/cowtowncoder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cowtowncoder/subscriptions","organizations_url":"https://api.github.com/users/cowtowncoder/orgs","repos_url":"https://api.github.com/users/cowtowncoder/repos","events_url":"https://api.github.com/users/cowtowncoder/events{/privacy}","received_events_url":"https://api.github.com/users/cowtowncoder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/2821/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/2821/timeline","performed_via_github_app":null,"state_reason":"completed"}