{"url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/1705","repository_url":"https://api.github.com/repos/FasterXML/jackson-databind","labels_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/1705/labels{/name}","comments_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/1705/comments","events_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/1705/events","html_url":"https://github.com/FasterXML/jackson-databind/issues/1705","id":243437891,"node_id":"MDU6SXNzdWUyNDM0Mzc4OTE=","number":1705,"title":"Non-generic interface method hides type resolution info from generic base class","user":{"login":"tbartley","id":3344028,"node_id":"MDQ6VXNlcjMzNDQwMjg=","avatar_url":"https://avatars.githubusercontent.com/u/3344028?v=4","gravatar_id":"","url":"https://api.github.com/users/tbartley","html_url":"https://github.com/tbartley","followers_url":"https://api.github.com/users/tbartley/followers","following_url":"https://api.github.com/users/tbartley/following{/other_user}","gists_url":"https://api.github.com/users/tbartley/gists{/gist_id}","starred_url":"https://api.github.com/users/tbartley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tbartley/subscriptions","organizations_url":"https://api.github.com/users/tbartley/orgs","repos_url":"https://api.github.com/users/tbartley/repos","events_url":"https://api.github.com/users/tbartley/events{/privacy}","received_events_url":"https://api.github.com/users/tbartley/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/FasterXML/jackson-databind/milestones/83","html_url":"https://github.com/FasterXML/jackson-databind/milestone/83","labels_url":"https://api.github.com/repos/FasterXML/jackson-databind/milestones/83/labels","id":2719689,"node_id":"MDk6TWlsZXN0b25lMjcxOTY4OQ==","number":83,"title":"2.9.1","description":"Release notes: https://github.com/FasterXML/jackson/wiki/Jackson-Release-2.9.1","creator":{"login":"cowtowncoder","id":55065,"node_id":"MDQ6VXNlcjU1MDY1","avatar_url":"https://avatars.githubusercontent.com/u/55065?v=4","gravatar_id":"","url":"https://api.github.com/users/cowtowncoder","html_url":"https://github.com/cowtowncoder","followers_url":"https://api.github.com/users/cowtowncoder/followers","following_url":"https://api.github.com/users/cowtowncoder/following{/other_user}","gists_url":"https://api.github.com/users/cowtowncoder/gists{/gist_id}","starred_url":"https://api.github.com/users/cowtowncoder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cowtowncoder/subscriptions","organizations_url":"https://api.github.com/users/cowtowncoder/orgs","repos_url":"https://api.github.com/users/cowtowncoder/repos","events_url":"https://api.github.com/users/cowtowncoder/events{/privacy}","received_events_url":"https://api.github.com/users/cowtowncoder/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":10,"state":"closed","created_at":"2017-08-23T23:44:50Z","updated_at":"2021-03-04T04:47:09Z","due_on":"2017-09-07T07:00:00Z","closed_at":"2021-03-04T04:47:09Z"},"comments":11,"created_at":"2017-07-17T15:40:02Z","updated_at":"2017-09-29T02:32:50Z","closed_at":"2017-09-29T02:32:50Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I saw this issue via MongoJack and haven't yet been able to construct a pure jackson databind test case but it seems that in some circumstances a class definition like the following:\r\n\r\n```\r\npublic interface I {\r\n   String getT();\r\n}\r\n\r\npublic class A<T> {\r\n    private T t;\r\n    public A(T t) { this.t = t; }\r\n    public T getT() { return t; }\r\n}\r\n\r\npublic class B extends A<String> implements I {\r\n    public B(String t) { super(t); }\r\n}\r\n```\r\n\r\ncan result in the type information required to resolve the type of `t` to a String is lost.\r\n\r\nThis happens because in AnnotatedClass._addMemberMethods is this code:\r\n\r\n```\r\n                /* 06-Jan-2010, tatu: [JACKSON-450] Except that if method we saw first is\r\n                 *   from an interface, and we now find a non-interface definition, we should\r\n                 *   use this method, but with combination of annotations.\r\n                 *   This helps (or rather, is essential) with JAXB annotations and\r\n                 *   may also result in faster method calls (interface calls are slightly\r\n                 *   costlier than regular method calls)\r\n                 */\r\n                if (old.getDeclaringClass().isInterface() && !m.getDeclaringClass().isInterface()) {\r\n                    methods.add(old.withMethod(m));\r\n                }\r\n```\r\n\r\nIn my test, the interface getter is discovered first and so plays the role of \"old\", then the base class getter is being added and so the original definintion of the method is simply adjusted with a reference to the method being processed. However the method from the interface has no type resolution information since the interface is not defined with generics so the type resolution information is lost and thus `t` can end up being serialialised as Object instead of String and so a serialisation failure occurs.\r\n\r\nI implemented a fix as follows. To AnnotatedMethod add the method:\r\n\r\n```\r\n    public AnnotatedMethod withContextAndMethod(TypeResolutionContext ctxt, Method m) {\r\n        return new AnnotatedMethod(ctxt, m, _annotations, _paramAnnotations);\r\n    }\r\n```\r\n\r\nand then change the code in AnnotatedClass to:\r\n\r\n```\r\n                if (old.getDeclaringClass().isInterface() && !m.getDeclaringClass().isInterface()) {\r\n                    methods.add(old.withContextAndMethod(typeContext, m));\r\n                }\r\n```\r\n\r\nwhich resolved my problem. Happy to submit a pull request, but I haven't got the CLA ready yet and I would also like some help constructing a pure Jackson unit test to replicate the issue.\r\n\r\nTo be specific about my MongoJack reproducer:\r\n\r\n```\r\npublic interface I {\r\n   String getT();\r\n}\r\n\r\npublic class A<T> {\r\n    private T t;\r\n    public A(T t) { this.t = t; }\r\n    public T getT() { return t; }\r\n}\r\n\r\npublic class B extends A<String> implements I {\r\n    public B(String t) { super(t); }\r\n}\r\n\r\n@Test\r\npublic void test() {\r\n\t\tObjectMapper om = new ObjectMapper();\r\n\t\tMongoJackModule.configure(om);\r\n\t\tDBQuery.Query query = DBQuery.is(\"_id\", \"t\");\r\n\r\n\t\tJavaType bType = om.getTypeFactory().constructType(B.class);\r\n\t\tDBObject serialized = SerializationUtils.serializeQuery(om, bType, query);\r\n\t\tSystem.out.println(serialized);\r\n}\r\n```\r\n\r\nPrints `{ \"_id\": \"t\" }` as expected with my fix and throws this exception without it:\r\n\r\n```\r\norg.mongojack.MongoJsonMappingException: Error serializing value t in DBQuery operation _id\r\n\tat org.mongojack.internal.util.SerializationUtils.serializeQueryField(SerializationUtils.java:266)\r\n\tat org.mongojack.internal.util.SerializationUtils.serializeQueryCondition(SerializationUtils.java:182)\r\n\tat org.mongojack.internal.util.SerializationUtils.serializeQuery(SerializationUtils.java:155)\r\n\tat org.mongojack.internal.util.SerializationUtils.serializeQuery(SerializationUtils.java:143)\r\n\tat bugs.jackson.selfpolymorph.test(selfpolymorph.java:69)\r\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\r\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n\tat java.lang.reflect.Method.invoke(Method.java:498)\r\n\tat org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:50)\r\n\tat org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)\r\n\tat org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:47)\r\n\tat org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)\r\n\tat org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:325)\r\n\tat org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:78)\r\n\tat org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:57)\r\n\tat org.junit.runners.ParentRunner$3.run(ParentRunner.java:290)\r\n\tat org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:71)\r\n\tat org.junit.runners.ParentRunner.runChildren(ParentRunner.java:288)\r\n\tat org.junit.runners.ParentRunner.access$000(ParentRunner.java:58)\r\n\tat org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:268)\r\n\tat org.junit.runners.ParentRunner.run(ParentRunner.java:363)\r\n\tat org.eclipse.jdt.internal.junit4.runner.JUnit4TestReference.run(JUnit4TestReference.java:86)\r\n\tat org.eclipse.jdt.internal.junit.runner.TestExecution.run(TestExecution.java:38)\r\n\tat org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:459)\r\n\tat org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:678)\r\n\tat org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.run(RemoteTestRunner.java:382)\r\n\tat org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.main(RemoteTestRunner.java:192)\r\nCaused by: com.fasterxml.jackson.databind.JsonMappingException: No serializer found for class java.lang.String and no properties discovered to create BeanSerializer (to avoid exception, disable SerializationFeature.FAIL_ON_EMPTY_BEANS)\r\n\tat com.fasterxml.jackson.databind.JsonMappingException.from(JsonMappingException.java:284)\r\n\tat com.fasterxml.jackson.databind.SerializerProvider.mappingException(SerializerProvider.java:1110)\r\n\tat com.fasterxml.jackson.databind.SerializerProvider.reportMappingProblem(SerializerProvider.java:1135)\r\n\tat com.fasterxml.jackson.databind.ser.impl.UnknownSerializer.failForEmpty(UnknownSerializer.java:69)\r\n\tat com.fasterxml.jackson.databind.ser.impl.UnknownSerializer.serialize(UnknownSerializer.java:32)\r\n\tat org.mongojack.internal.util.SerializationUtils.serializeQueryField(SerializationUtils.java:264)\r\n\t... 27 more\r\n\r\n```\r\n\r\nMy testing has been using the 2.8 branch of jackson databind.","closed_by":{"login":"cowtowncoder","id":55065,"node_id":"MDQ6VXNlcjU1MDY1","avatar_url":"https://avatars.githubusercontent.com/u/55065?v=4","gravatar_id":"","url":"https://api.github.com/users/cowtowncoder","html_url":"https://github.com/cowtowncoder","followers_url":"https://api.github.com/users/cowtowncoder/followers","following_url":"https://api.github.com/users/cowtowncoder/following{/other_user}","gists_url":"https://api.github.com/users/cowtowncoder/gists{/gist_id}","starred_url":"https://api.github.com/users/cowtowncoder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cowtowncoder/subscriptions","organizations_url":"https://api.github.com/users/cowtowncoder/orgs","repos_url":"https://api.github.com/users/cowtowncoder/repos","events_url":"https://api.github.com/users/cowtowncoder/events{/privacy}","received_events_url":"https://api.github.com/users/cowtowncoder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/1705/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/FasterXML/jackson-databind/issues/1705/timeline","performed_via_github_app":null,"state_reason":"completed"}