{"url":"https://api.github.com/repos/LuckyPennySoftware/AutoMapper/issues/3563","repository_url":"https://api.github.com/repos/LuckyPennySoftware/AutoMapper","labels_url":"https://api.github.com/repos/LuckyPennySoftware/AutoMapper/issues/3563/labels{/name}","comments_url":"https://api.github.com/repos/LuckyPennySoftware/AutoMapper/issues/3563/comments","events_url":"https://api.github.com/repos/LuckyPennySoftware/AutoMapper/issues/3563/events","html_url":"https://github.com/LuckyPennySoftware/AutoMapper/issues/3563","id":793324611,"node_id":"MDU6SXNzdWU3OTMzMjQ2MTE=","number":3563,"title":"Query projection with subquery can generate non-compiling expression","user":{"login":"Erythnul","id":17799396,"node_id":"MDQ6VXNlcjE3Nzk5Mzk2","avatar_url":"https://avatars.githubusercontent.com/u/17799396?v=4","gravatar_id":"","url":"https://api.github.com/users/Erythnul","html_url":"https://github.com/Erythnul","followers_url":"https://api.github.com/users/Erythnul/followers","following_url":"https://api.github.com/users/Erythnul/following{/other_user}","gists_url":"https://api.github.com/users/Erythnul/gists{/gist_id}","starred_url":"https://api.github.com/users/Erythnul/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Erythnul/subscriptions","organizations_url":"https://api.github.com/users/Erythnul/orgs","repos_url":"https://api.github.com/users/Erythnul/repos","events_url":"https://api.github.com/users/Erythnul/events{/privacy}","received_events_url":"https://api.github.com/users/Erythnul/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":92629237,"node_id":"MDU6TGFiZWw5MjYyOTIzNw==","url":"https://api.github.com/repos/LuckyPennySoftware/AutoMapper/labels/Bug","name":"Bug","color":"e11d21","default":false,"description":null}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/LuckyPennySoftware/AutoMapper/milestones/39","html_url":"https://github.com/LuckyPennySoftware/AutoMapper/milestone/39","labels_url":"https://api.github.com/repos/LuckyPennySoftware/AutoMapper/milestones/39/labels","id":5908278,"node_id":"MDk6TWlsZXN0b25lNTkwODI3OA==","number":39,"title":"11.0.0","description":"","creator":{"login":"lbargaoanu","id":4517428,"node_id":"MDQ6VXNlcjQ1MTc0Mjg=","avatar_url":"https://avatars.githubusercontent.com/u/4517428?v=4","gravatar_id":"","url":"https://api.github.com/users/lbargaoanu","html_url":"https://github.com/lbargaoanu","followers_url":"https://api.github.com/users/lbargaoanu/followers","following_url":"https://api.github.com/users/lbargaoanu/following{/other_user}","gists_url":"https://api.github.com/users/lbargaoanu/gists{/gist_id}","starred_url":"https://api.github.com/users/lbargaoanu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lbargaoanu/subscriptions","organizations_url":"https://api.github.com/users/lbargaoanu/orgs","repos_url":"https://api.github.com/users/lbargaoanu/repos","events_url":"https://api.github.com/users/lbargaoanu/events{/privacy}","received_events_url":"https://api.github.com/users/lbargaoanu/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":17,"state":"closed","created_at":"2020-09-23T06:22:12Z","updated_at":"2022-01-07T16:53:59Z","due_on":null,"closed_at":"2022-01-07T16:53:59Z"},"comments":7,"created_at":"2021-01-25T12:04:42Z","updated_at":"2024-01-28T10:05:27Z","closed_at":"2021-01-25T17:16:10Z","author_association":"NONE","type":null,"active_lock_reason":"resolved","sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Hey guys,\r\n\r\nI've run into an issue with query projection when subqueries are included.\r\nI've spent some time debugging and seeing if I could get it fixed up, I've got a pull request coming up with a fix that definitely works for my scenario and most probably other ones as well.\r\nThe code isn't the most elegant, but I'm not exactly at home in your source so I tried to keep my additions small and easily readable. If you've got a better way of fixing this problem, I'll gladly change the source (or feel free to change it yourself and fix up the pull request before merging).\r\n\r\nMore details in the reproduction repo:\r\n\r\nhttps://github.com/Erythnul/AutomapperIssue\r\n\r\n### Source/destination types\r\n\r\n```csharp\r\n\r\n//Source\r\npublic class Order\r\n{\r\n    public Guid Id { get; set; }\r\n    public Guid CustomerId { get; set; }\r\n\r\n    public int? MostImportantOrderLine { get; set; }\r\n\r\n    public ICollection<OrderLine> OrderLines { get; set; } = null!;\r\n}\r\npublic class OrderLine\r\n{\r\n    public Guid Id { get; set; }\r\n    public Guid OrderId { get; set; }\r\n\r\n    public int OrderLineNumber { get; set; }\r\n    public string Description { get; set; } = null!;\r\n\r\n    public Order Order { get; set; } = null!;\r\n}\r\n\r\n//Destination\r\npublic class OrderModel\r\n{\r\n    public OrderSubModel? OrderSubModel { get; set; }\r\n    public OrderLineModel? MostImportantOrderLine { get; set; }\r\n}\r\n\r\npublic class OrderSubModel\r\n{\r\n    public Guid? OrderId { get; set; }\r\n}\r\n\r\npublic class OrderLineModel\r\n{\r\n    public Guid OrderLineId { get; set; }\r\n    public string Description { get; set; } = string.Empty;\r\n}\r\n```\r\n\r\n### Mapping configuration\r\n\r\n```csharp\r\nnew MapperConfiguration(cfg =>\r\n{\r\n    cfg.CreateMap<Entities.Order, Dtos.OrderModel>()\r\n        .ForMember(dst => dst.OrderSubModel, opt => opt.MapFrom(src => src.MostImportantOrderLine != null ? src : null))\r\n        .ForMember(dst => dst.MostImportantOrderLine, opt =>\r\n        {\r\n            opt.MapFrom(src => src.OrderLines.FirstOrDefault(x => x.OrderLineNumber == src.MostImportantOrderLine));\r\n        });\r\n\r\n    cfg.CreateMap<Entities.Order, Dtos.OrderSubModel>()\r\n        .ForMember(dst => dst.OrderId, opt => opt.MapFrom(src => src.Id));\r\n\r\n    cfg.CreateMap<Entities.OrderLine, Dtos.OrderLineModel>()\r\n        .ForMember(dst => dst.OrderLineId, opt => opt.MapFrom(src => src.Id))\r\n        .ForMember(dst => dst.Description, opt => opt.MapFrom(src => src.Description));\r\n});\r\n```\r\n\r\n### Version: 10.1.1\r\n\r\n### Expected behavior\r\n\r\n```csharp\r\n//projectedQuery.Expression\r\nqueryable.Select(\r\n    dtoOrder => new Object_1548421275___MostImportantOrderLine_MostImportantOrderLine_MostImportantOrderLine\r\n    {\r\n        __MostImportantOrderLine = dtoOrder.OrderLines.FirstOrDefault(x => ((int?)x.OrderLineNumber) == dtoOrder.MostImportantOrderLine),\r\n        MostImportantOrderLine = dtoOrder.MostImportantOrderLine,\r\n        Id = dtoOrder.Id\r\n    }).Select(\r\n    dtoLet => new Dtos.OrderModel\r\n    {\r\n        MostImportantOrderLine = (dtoLet.__MostImportantOrderLine == null)\r\n            ? null\r\n            : new Dtos.OrderLineModel\r\n            {\r\n                Description = dtoLet.__MostImportantOrderLine.Description,\r\n                OrderLineId = dtoLet.__MostImportantOrderLine.Id\r\n            },\r\n        OrderSubModel = (((dtoLet.MostImportantOrderLine != null) ? dtoLet : null) == null)\r\n            ? null\r\n            : new Dtos.OrderSubModel\r\n            {\r\n                OrderId = (Guid?)((dtoLet.MostImportantOrderLine != null) ? dtoLet : null).Id\r\n            }\r\n    });\r\n```\r\n\r\n### Actual behavior\r\n\r\n```csharp\r\n//projectedQuery.Expression\r\nqueryable.Select(\r\n    dtoOrder => new Object_1548421275___MostImportantOrderLine_MostImportantOrderLine_MostImportantOrderLine\r\n    {\r\n        __MostImportantOrderLine = dtoOrder.OrderLines.FirstOrDefault(x => ((int?)x.OrderLineNumber) == dtoOrder.MostImportantOrderLine),\r\n        MostImportantOrderLine = dtoOrder.MostImportantOrderLine\r\n        //, Id = dtoOrder.Id\r\n        // Doesn't collect OrderId into dtoLet, is also not added as possible field to Proxy Object above\r\n    }).Select(\r\n    dtoLet => new Dtos.OrderModel\r\n    {\r\n        MostImportantOrderLine = (dtoLet.__MostImportantOrderLine == null)\r\n            ? null\r\n            : new Dtos.OrderLineModel\r\n            {\r\n                Description = dtoLet.__MostImportantOrderLine.Description,\r\n                OrderLineId = dtoLet.__MostImportantOrderLine.Id\r\n            },\r\n        OrderSubModel = (((dtoLet.MostImportantOrderLine != null) ? dtoOrder : null) == null) //Doesn't compile, should be dtoLet\r\n            ? null\r\n            : new Dtos.OrderSubModel\r\n            {\r\n                OrderId = (Guid?)((dtoLet.MostImportantOrderLine != null) ? dtoOrder : null).Id //Doesn't compile, should be dtoLet\r\n            }\r\n    });\r\n```\r\n\r\n### Steps to reproduce\r\n\r\nhttps://github.com/Erythnul/AutomapperIssue\r\n\r\n```csharp\r\nvar orders = new[]\r\n{\r\n    new Order\r\n    {\r\n        Id = Guid.Parse(\"00000000-0000-0000-0000-000000000001\"),\r\n        MostImportantOrderLine = 1,\r\n        OrderLines = new List<OrderLine>\r\n        {\r\n            new OrderLine\r\n            {\r\n                Id = Guid.Parse(\"00000000-0000-0000-0000-000000000101\"),\r\n                OrderId = Guid.Parse(\"00000000-0000-0000-0000-000000000001\"),\r\n                OrderLineNumber = 1,\r\n                Description = \"ChessSet\"\r\n            }\r\n        }\r\n    }\r\n}.AsQueryable();\r\n\r\nvar projection = orders.ProjectTo<OrderModel>(Configuration);\r\nvar orderModel = projection.First(); //throws\r\n```\r\n","closed_by":{"login":"lbargaoanu","id":4517428,"node_id":"MDQ6VXNlcjQ1MTc0Mjg=","avatar_url":"https://avatars.githubusercontent.com/u/4517428?v=4","gravatar_id":"","url":"https://api.github.com/users/lbargaoanu","html_url":"https://github.com/lbargaoanu","followers_url":"https://api.github.com/users/lbargaoanu/followers","following_url":"https://api.github.com/users/lbargaoanu/following{/other_user}","gists_url":"https://api.github.com/users/lbargaoanu/gists{/gist_id}","starred_url":"https://api.github.com/users/lbargaoanu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lbargaoanu/subscriptions","organizations_url":"https://api.github.com/users/lbargaoanu/orgs","repos_url":"https://api.github.com/users/lbargaoanu/repos","events_url":"https://api.github.com/users/lbargaoanu/events{/privacy}","received_events_url":"https://api.github.com/users/lbargaoanu/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/LuckyPennySoftware/AutoMapper/issues/3563/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/LuckyPennySoftware/AutoMapper/issues/3563/timeline","performed_via_github_app":null,"state_reason":"completed"}