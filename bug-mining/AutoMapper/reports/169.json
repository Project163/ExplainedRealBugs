{"url":"https://api.github.com/repos/LuckyPennySoftware/AutoMapper/issues/1857","repository_url":"https://api.github.com/repos/LuckyPennySoftware/AutoMapper","labels_url":"https://api.github.com/repos/LuckyPennySoftware/AutoMapper/issues/1857/labels{/name}","comments_url":"https://api.github.com/repos/LuckyPennySoftware/AutoMapper/issues/1857/comments","events_url":"https://api.github.com/repos/LuckyPennySoftware/AutoMapper/issues/1857/events","html_url":"https://github.com/LuckyPennySoftware/AutoMapper/issues/1857","id":196287617,"node_id":"MDU6SXNzdWUxOTYyODc2MTc=","number":1857,"title":"Exception when mapping null to `Nullable` for ctor param","user":{"login":"jakubfijalkowski","id":357096,"node_id":"MDQ6VXNlcjM1NzA5Ng==","avatar_url":"https://avatars.githubusercontent.com/u/357096?v=4","gravatar_id":"","url":"https://api.github.com/users/jakubfijalkowski","html_url":"https://github.com/jakubfijalkowski","followers_url":"https://api.github.com/users/jakubfijalkowski/followers","following_url":"https://api.github.com/users/jakubfijalkowski/following{/other_user}","gists_url":"https://api.github.com/users/jakubfijalkowski/gists{/gist_id}","starred_url":"https://api.github.com/users/jakubfijalkowski/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jakubfijalkowski/subscriptions","organizations_url":"https://api.github.com/users/jakubfijalkowski/orgs","repos_url":"https://api.github.com/users/jakubfijalkowski/repos","events_url":"https://api.github.com/users/jakubfijalkowski/events{/privacy}","received_events_url":"https://api.github.com/users/jakubfijalkowski/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2016-12-18T17:30:08Z","updated_at":"2019-05-07T03:09:47Z","closed_at":"2016-12-19T14:13:15Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":"resolved","sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Consider this:\r\n```csharp\r\npublic class Dest\r\n{\r\n    public int? Value1 { get; }\r\n\r\n    public Dest(int? thing)\r\n    {\r\n        this.Value1 = thing;\r\n    }\r\n}\r\n\r\npublic class Source\r\n{\r\n    public int? Value { get; set; }\r\n}\r\n\r\npublic static void Main(string[] args)\r\n{\r\n    Mapper.Initialize(ctx =>\r\n        ctx.CreateMap<Source, Dest>()\r\n            .ForCtorParam(\"thing\", c => c.ResolveUsing(s => s.Value)));\r\n\r\n    Mapper.Map<Dest>(new Source { Value = 1 }); // This works\r\n    Mapper.Map<Dest>(new Source { Value = null }); // This throws \"Missing type map Object -> Nullable`1\"\r\n}\r\n```\r\nThe reason for this is that `ICtorParamConfigurationExpression` forces the result of `s => s.Value` to be `object` and when building the expression for the ctor parameter ([here](https://github.com/AutoMapper/AutoMapper/blob/c968f34e58eed73e7cb40e8e52849408693eddb6/src/AutoMapper/ConstructorParameterMap.cs#L43)), it tries to convert `object` to `Nullable` (using configuration, as there is no matching `IObjectMapper`). This works when the result is non-null (`AssignableMapper` may be used when performing the mapping, because runtime types are known), but not when the value is null (even though it is convertible to `Nullable`, but the mapper does not know it).\r\n\r\nOf course, I am aware that `MapFrom` should be used (which works as expected) in this example, but it is not sufficient in some scenarios (e.g. using `ResolutionContext` to get value from the `Items` collection).\r\n\r\nI see a couple of fixes:\r\n * Create `IObjectMapper` specifically for this purpose - i.e. mapping `object` to `Nullable` when source is `null` and using other mapper otherwise (just like `NullableSourceMapper`),\r\n * Provide `ICtorParamConfigurationExpression.MapFrom<TDest>(Expression<Func<TSource, ResolutionContext, TDest>> resolver)` and make another `if` in [ConstructorParameterMap.ResolveSource](https://github.com/AutoMapper/AutoMapper/blob/c968f34e58eed73e7cb40e8e52849408693eddb6/src/AutoMapper/ConstructorParameterMap.cs#L46-L69),\r\n * Switch `ICtorParamConfigurationExpression.Resolve` to use `Expression`s - rather bad (will break things),\r\n * Handle `null -> Nullable` conversion right in [ConstructorParameterMap.CreateExpression](https://github.com/AutoMapper/AutoMapper/blob/c968f34e58eed73e7cb40e8e52849408693eddb6/src/AutoMapper/ConstructorParameterMap.cs#L41-L43) - bad, too.\r\n\r\nI can prepare the fix, but I really don't know which way is the most appropriate.","closed_by":{"login":"jbogard","id":104498,"node_id":"MDQ6VXNlcjEwNDQ5OA==","avatar_url":"https://avatars.githubusercontent.com/u/104498?v=4","gravatar_id":"","url":"https://api.github.com/users/jbogard","html_url":"https://github.com/jbogard","followers_url":"https://api.github.com/users/jbogard/followers","following_url":"https://api.github.com/users/jbogard/following{/other_user}","gists_url":"https://api.github.com/users/jbogard/gists{/gist_id}","starred_url":"https://api.github.com/users/jbogard/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jbogard/subscriptions","organizations_url":"https://api.github.com/users/jbogard/orgs","repos_url":"https://api.github.com/users/jbogard/repos","events_url":"https://api.github.com/users/jbogard/events{/privacy}","received_events_url":"https://api.github.com/users/jbogard/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/LuckyPennySoftware/AutoMapper/issues/1857/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/LuckyPennySoftware/AutoMapper/issues/1857/timeline","performed_via_github_app":null,"state_reason":"completed"}