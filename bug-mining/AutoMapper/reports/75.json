{"url":"https://api.github.com/repos/LuckyPennySoftware/AutoMapper/issues/452","repository_url":"https://api.github.com/repos/LuckyPennySoftware/AutoMapper","labels_url":"https://api.github.com/repos/LuckyPennySoftware/AutoMapper/issues/452/labels{/name}","comments_url":"https://api.github.com/repos/LuckyPennySoftware/AutoMapper/issues/452/comments","events_url":"https://api.github.com/repos/LuckyPennySoftware/AutoMapper/issues/452/events","html_url":"https://github.com/LuckyPennySoftware/AutoMapper/issues/452","id":26966036,"node_id":"MDU6SXNzdWUyNjk2NjAzNg==","number":452,"title":"DataReader mapping returns wrong type - BuilderKey.Equals() is wrong","user":{"login":"rlaveycal","id":6595659,"node_id":"MDQ6VXNlcjY1OTU2NTk=","avatar_url":"https://avatars.githubusercontent.com/u/6595659?v=4","gravatar_id":"","url":"https://api.github.com/users/rlaveycal","html_url":"https://github.com/rlaveycal","followers_url":"https://api.github.com/users/rlaveycal/followers","following_url":"https://api.github.com/users/rlaveycal/following{/other_user}","gists_url":"https://api.github.com/users/rlaveycal/gists{/gist_id}","starred_url":"https://api.github.com/users/rlaveycal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rlaveycal/subscriptions","organizations_url":"https://api.github.com/users/rlaveycal/orgs","repos_url":"https://api.github.com/users/rlaveycal/repos","events_url":"https://api.github.com/users/rlaveycal/events{/privacy}","received_events_url":"https://api.github.com/users/rlaveycal/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":92629237,"node_id":"MDU6TGFiZWw5MjYyOTIzNw==","url":"https://api.github.com/repos/LuckyPennySoftware/AutoMapper/labels/Bug","name":"Bug","color":"e11d21","default":false,"description":null}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/LuckyPennySoftware/AutoMapper/milestones/8","html_url":"https://github.com/LuckyPennySoftware/AutoMapper/milestone/8","labels_url":"https://api.github.com/repos/LuckyPennySoftware/AutoMapper/milestones/8/labels","id":546697,"node_id":"MDk6TWlsZXN0b25lNTQ2Njk3","number":8,"title":"3.2.0","description":"","creator":{"login":"jbogard","id":104498,"node_id":"MDQ6VXNlcjEwNDQ5OA==","avatar_url":"https://avatars.githubusercontent.com/u/104498?v=4","gravatar_id":"","url":"https://api.github.com/users/jbogard","html_url":"https://github.com/jbogard","followers_url":"https://api.github.com/users/jbogard/followers","following_url":"https://api.github.com/users/jbogard/following{/other_user}","gists_url":"https://api.github.com/users/jbogard/gists{/gist_id}","starred_url":"https://api.github.com/users/jbogard/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jbogard/subscriptions","organizations_url":"https://api.github.com/users/jbogard/orgs","repos_url":"https://api.github.com/users/jbogard/repos","events_url":"https://api.github.com/users/jbogard/events{/privacy}","received_events_url":"https://api.github.com/users/jbogard/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":49,"state":"closed","created_at":"2014-01-24T16:31:56Z","updated_at":"2014-04-25T14:41:28Z","due_on":null,"closed_at":"2014-04-15T12:58:17Z"},"comments":4,"created_at":"2014-02-05T14:56:41Z","updated_at":"2019-05-08T14:06:16Z","closed_at":"2014-04-10T00:38:59Z","author_association":"NONE","type":null,"active_lock_reason":"resolved","sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I've been having an intermittent problem with mapping from a IDataRecord (SqlDataReader) to a variety of POCO objects. All my data records are identical (same column names) but I can map them into different classes.\n\nA typical error would be \n\n```\n\"X.DistributorSummary\" is not of type \"X.ShareClassSummary\" and cannot be used in this generic collection.\nParameter name: value\n   at System.ThrowHelper.ThrowWrongValueTypeArgumentException(Object value, Type targetType)\n   at System.Collections.Generic.List`1.System.Collections.IList.Add(Object item)\n   at AutoMapper.Mappers.DataReaderMapper.LoadDataReaderViaList(IDataReader dataReader, IMappingEngineRunner mapper, Build buildFrom, ResolutionContext resolveUsingContext, Type elementType)\n```\n\nI think I've tracked the problem down to the way that DataReaderMapper checks for an existing builder\n\n``` C#\nprivate static Build CreateBuilder(Type destinationType, IDataRecord dataRecord)\n    {\n        Build builder;\n        BuilderKey builderKey = new BuilderKey(destinationType, dataRecord);\n        if (_builderCache.TryGetValue(builderKey, out builder))\n        {\n            return builder;\n         }\n```\n\nThis in turn relies on DataReaderMapper.BuilderKey.Equals()\n\n``` C#\n            public override bool Equals(object obj)\n            {\n                var builderKey = obj as BuilderKey;\n                if (builderKey == null)\n                    return false;\n\n                if (this._dataRecordNames.Count != builderKey._dataRecordNames.Count)\n                    return false;\n\n                for (int i = 0; i < _dataRecordNames.Count; i++)\n                {\n                    if (this._dataRecordNames[i] != builderKey._dataRecordNames[i])\n                        return false;\n                }\n                return true;\n            }\n```\n\nThis implementation only checks the names of the dara record fields match. It doesn't check that the destination type also matches. Therefore the following should be added before the for loop:\n\n``` C#\nif(this._destinationType.FullName != builderKey._destinationType.FullName)\n  return false;\n```\n","closed_by":{"login":"jbogard","id":104498,"node_id":"MDQ6VXNlcjEwNDQ5OA==","avatar_url":"https://avatars.githubusercontent.com/u/104498?v=4","gravatar_id":"","url":"https://api.github.com/users/jbogard","html_url":"https://github.com/jbogard","followers_url":"https://api.github.com/users/jbogard/followers","following_url":"https://api.github.com/users/jbogard/following{/other_user}","gists_url":"https://api.github.com/users/jbogard/gists{/gist_id}","starred_url":"https://api.github.com/users/jbogard/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jbogard/subscriptions","organizations_url":"https://api.github.com/users/jbogard/orgs","repos_url":"https://api.github.com/users/jbogard/repos","events_url":"https://api.github.com/users/jbogard/events{/privacy}","received_events_url":"https://api.github.com/users/jbogard/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/LuckyPennySoftware/AutoMapper/issues/452/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/LuckyPennySoftware/AutoMapper/issues/452/timeline","performed_via_github_app":null,"state_reason":"completed"}