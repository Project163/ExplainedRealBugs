{"url":"https://api.github.com/repos/LuckyPennySoftware/AutoMapper/issues/264","repository_url":"https://api.github.com/repos/LuckyPennySoftware/AutoMapper","labels_url":"https://api.github.com/repos/LuckyPennySoftware/AutoMapper/issues/264/labels{/name}","comments_url":"https://api.github.com/repos/LuckyPennySoftware/AutoMapper/issues/264/comments","events_url":"https://api.github.com/repos/LuckyPennySoftware/AutoMapper/issues/264/events","html_url":"https://github.com/LuckyPennySoftware/AutoMapper/issues/264","id":7951749,"node_id":"MDU6SXNzdWU3OTUxNzQ5","number":264,"title":"Map to a list of destination object that set properties in the ctor throws an AutoMapperMappingException","user":{"login":"jibedoubleve","id":2678545,"node_id":"MDQ6VXNlcjI2Nzg1NDU=","avatar_url":"https://avatars.githubusercontent.com/u/2678545?v=4","gravatar_id":"","url":"https://api.github.com/users/jibedoubleve","html_url":"https://github.com/jibedoubleve","followers_url":"https://api.github.com/users/jibedoubleve/followers","following_url":"https://api.github.com/users/jibedoubleve/following{/other_user}","gists_url":"https://api.github.com/users/jibedoubleve/gists{/gist_id}","starred_url":"https://api.github.com/users/jibedoubleve/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jibedoubleve/subscriptions","organizations_url":"https://api.github.com/users/jibedoubleve/orgs","repos_url":"https://api.github.com/users/jibedoubleve/repos","events_url":"https://api.github.com/users/jibedoubleve/events{/privacy}","received_events_url":"https://api.github.com/users/jibedoubleve/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/LuckyPennySoftware/AutoMapper/milestones/1","html_url":"https://github.com/LuckyPennySoftware/AutoMapper/milestone/1","labels_url":"https://api.github.com/repos/LuckyPennySoftware/AutoMapper/milestones/1/labels","id":197138,"node_id":"MDk6TWlsZXN0b25lMTk3MTM4","number":1,"title":"2.2.1","description":"","creator":{"login":"jbogard","id":104498,"node_id":"MDQ6VXNlcjEwNDQ5OA==","avatar_url":"https://avatars.githubusercontent.com/u/104498?v=4","gravatar_id":"","url":"https://api.github.com/users/jbogard","html_url":"https://github.com/jbogard","followers_url":"https://api.github.com/users/jbogard/followers","following_url":"https://api.github.com/users/jbogard/following{/other_user}","gists_url":"https://api.github.com/users/jbogard/gists{/gist_id}","starred_url":"https://api.github.com/users/jbogard/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jbogard/subscriptions","organizations_url":"https://api.github.com/users/jbogard/orgs","repos_url":"https://api.github.com/users/jbogard/repos","events_url":"https://api.github.com/users/jbogard/events{/privacy}","received_events_url":"https://api.github.com/users/jbogard/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":15,"state":"closed","created_at":"2012-10-17T18:26:06Z","updated_at":"2013-02-18T21:40:29Z","due_on":null,"closed_at":"2013-02-18T21:40:29Z"},"comments":1,"created_at":"2012-10-29T21:25:03Z","updated_at":"2019-05-08T18:06:49Z","closed_at":"2012-11-15T03:13:44Z","author_association":"NONE","type":null,"active_lock_reason":"resolved","sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Here's a small unit test that reproduces the issue (It throws a AutoMapperMappingException):\n\n```\n    Mapper.Reset();\n    Mapper.CreateMap<ItemToMap, ItemToMapDto>();\n    Mapper.CreateMap<Tag, TagDto>();\n\n    var tag = new Tag() ;\n\n    List<ItemToMap> entities = new List<ItemToMap>();\n\n    for (int i = 0; i < 10; i++)\n    {\n        entities.Add(new ItemToMap()\n        {\n            Name = Guid.NewGuid().ToString(),\n            Tag = tag,\n        });\n    }\n\n    var dto = Mapper.Map<List<ItemToMap>, List<ItemToMapDto>>(entities);\n```\n\nHere are the classes\n\n```\npublic class ItemToMapDto\n{\n    public ItemToMapDto()\n    {\n        /* Remove the line below and the mapping works correctly*/\n        this.Tag = new TagDto() { Name = Guid.NewGuid().ToString() };\n    }\n    public string Name { get; set; }\n    public TagDto Tag { get; set; }\n}\npublic class TagDto\n{\n    public string Name { get; set; }\n    public bool IsTrue { get; set; }\n}\npublic class ItemToMap\n{\n    public string Name { get; set; }\n    public Tag Tag { get; set; }\n}\npublic class Tag\n{\n    public string Name { get; set; }\n    public bool IsTrue { get; set; }\n}\n```\n\nIn AutoMapper version 1.1, in the PropertyMapMappingStrategy there was a check on UseDestinationValue to see whether to replace the existing value or not. Now it doesn't exist anymore.\n\nWhen choosing the mapping strategy the method IsMatch returns False on the CacheMappingStrategy because DestinationValue is not null. But in the PropertyMapMappingStrategy, this same method crashes because a ResolutionContext with the same hash code already exists in the cache.\n\nI don't have the problem anymore if I replace the line 111 in the file TypeMapObjectMapperRegistry.cs (PropertyMapMappingStrategy.MapPropertyValue(ResolutionContext context, IMappingEngineRunner mapper, object mappedObject, PropertyMap propertyMap):\n\n```\nobject destinationValue = propertyMap.DestinationProperty.GetValue(mappedObject);\n```\n\nwith this one:\n\n```\nobject destinationValue = (propertyMap.UseDestinationValue)\n    ? propertyMap.DestinationProperty.GetValue(mappedObject)\n    : null;\n```\n","closed_by":{"login":"jbogard","id":104498,"node_id":"MDQ6VXNlcjEwNDQ5OA==","avatar_url":"https://avatars.githubusercontent.com/u/104498?v=4","gravatar_id":"","url":"https://api.github.com/users/jbogard","html_url":"https://github.com/jbogard","followers_url":"https://api.github.com/users/jbogard/followers","following_url":"https://api.github.com/users/jbogard/following{/other_user}","gists_url":"https://api.github.com/users/jbogard/gists{/gist_id}","starred_url":"https://api.github.com/users/jbogard/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jbogard/subscriptions","organizations_url":"https://api.github.com/users/jbogard/orgs","repos_url":"https://api.github.com/users/jbogard/repos","events_url":"https://api.github.com/users/jbogard/events{/privacy}","received_events_url":"https://api.github.com/users/jbogard/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/LuckyPennySoftware/AutoMapper/issues/264/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/LuckyPennySoftware/AutoMapper/issues/264/timeline","performed_via_github_app":null,"state_reason":"completed"}