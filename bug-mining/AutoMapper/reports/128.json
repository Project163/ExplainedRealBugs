{"url":"https://api.github.com/repos/LuckyPennySoftware/AutoMapper/issues/1297","repository_url":"https://api.github.com/repos/LuckyPennySoftware/AutoMapper","labels_url":"https://api.github.com/repos/LuckyPennySoftware/AutoMapper/issues/1297/labels{/name}","comments_url":"https://api.github.com/repos/LuckyPennySoftware/AutoMapper/issues/1297/comments","events_url":"https://api.github.com/repos/LuckyPennySoftware/AutoMapper/issues/1297/events","html_url":"https://github.com/LuckyPennySoftware/AutoMapper/issues/1297","id":156175741,"node_id":"MDU6SXNzdWUxNTYxNzU3NDE=","number":1297,"title":"AutoMapper 5.0.0-beta-1 with ASP.NET Core RC2 throws System.ArgumentException: An item with the same key has already been added","user":{"login":"iberodev","id":5520769,"node_id":"MDQ6VXNlcjU1MjA3Njk=","avatar_url":"https://avatars.githubusercontent.com/u/5520769?v=4","gravatar_id":"","url":"https://api.github.com/users/iberodev","html_url":"https://github.com/iberodev","followers_url":"https://api.github.com/users/iberodev/followers","following_url":"https://api.github.com/users/iberodev/following{/other_user}","gists_url":"https://api.github.com/users/iberodev/gists{/gist_id}","starred_url":"https://api.github.com/users/iberodev/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/iberodev/subscriptions","organizations_url":"https://api.github.com/users/iberodev/orgs","repos_url":"https://api.github.com/users/iberodev/repos","events_url":"https://api.github.com/users/iberodev/events{/privacy}","received_events_url":"https://api.github.com/users/iberodev/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":92629237,"node_id":"MDU6TGFiZWw5MjYyOTIzNw==","url":"https://api.github.com/repos/LuckyPennySoftware/AutoMapper/labels/Bug","name":"Bug","color":"e11d21","default":false,"description":null}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/LuckyPennySoftware/AutoMapper/milestones/20","html_url":"https://github.com/LuckyPennySoftware/AutoMapper/milestone/20","labels_url":"https://api.github.com/repos/LuckyPennySoftware/AutoMapper/milestones/20/labels","id":1773095,"node_id":"MDk6TWlsZXN0b25lMTc3MzA5NQ==","number":20,"title":"5.0.0","description":"","creator":{"login":"jbogard","id":104498,"node_id":"MDQ6VXNlcjEwNDQ5OA==","avatar_url":"https://avatars.githubusercontent.com/u/104498?v=4","gravatar_id":"","url":"https://api.github.com/users/jbogard","html_url":"https://github.com/jbogard","followers_url":"https://api.github.com/users/jbogard/followers","following_url":"https://api.github.com/users/jbogard/following{/other_user}","gists_url":"https://api.github.com/users/jbogard/gists{/gist_id}","starred_url":"https://api.github.com/users/jbogard/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jbogard/subscriptions","organizations_url":"https://api.github.com/users/jbogard/orgs","repos_url":"https://api.github.com/users/jbogard/repos","events_url":"https://api.github.com/users/jbogard/events{/privacy}","received_events_url":"https://api.github.com/users/jbogard/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":59,"state":"closed","created_at":"2016-05-18T04:29:49Z","updated_at":"2016-07-04T16:32:15Z","due_on":null,"closed_at":"2016-06-28T13:25:48Z"},"comments":4,"created_at":"2016-05-22T21:59:49Z","updated_at":"2019-05-07T15:15:00Z","closed_at":"2016-06-15T15:54:53Z","author_association":"NONE","type":null,"active_lock_reason":"resolved","sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I am getting an exception since I migrated to ASP.NET Core RC2 and upgraded to AutoMapper 5.0.0-beta-1. This worked fine before, that is the strange part.\n\nThe scenario is something like this (simplified):\nI have these entities:\n\n```\n public class Consignment\n {\n        public int Id { get; set; }\n        public List<Package> Packages { get; set; }\n        public List<TransportEquipment> TransportEquipment { get; set; }\n}\n\npublic class TransportEquipment\n{\n        public int Id { get; set; }\n        public int ConsignmentId { get; set; }\n        public Consignment Consignment { get; set; }\n}\n\npublic class Package\n {\n        public int Id { get; set; }\n        public int ConsignmentId { get; set; }\n        public Consignment Consignment { get; set; }\n}\n```\n\nAnd these service models\n\n```\npublic class Consignment \n{\n        public int Id { get; set; }\n        public List<PackageSummary> PackageSummaries { get; set; }\n        public List<TransportEquipmentSummary> TransportEquipmentSummaries { get; set; }\n}\n\npublic class PackageSummary\n{\n        public int Id { get; set; }\n}\n\npublic class TransportEquipmentSummary\n{\n        public int Id { get; set; }\n}\n\n```\n\nAnd I am trying to map a ConsignmentEntity to a Consignment service model so I have this type configurator\n\n```\n\npublic class ConsignmentEntityToConsignmentAutoMapperTypeConfigurator : IAutoMapperTypeConfigurator\n    {\n        public void Configure(IMapperConfiguration mapperConfiguration)\n        {\n            mapperConfiguration.CreateMap<Data.Models.Consignment, Consignment>()\n                .ForMember(dest => dest.Id, opt => opt.MapFrom(c => c.Id))\n                .ForMember(dest => dest.TransportEquipmentSummaries, opt => opt.MapFrom(c => c.TransportEquipment != null ?\n                    c.TransportEquipment : Enumerable.Empty<Data.Models.TransportEquipment>().ToList()))\n                .ForMember(dest => dest.PackageSummaries, opt => opt.MapFrom(c => c.Packages != null ?\n                    c.Packages : Enumerable.Empty<Data.Models.Package>().ToList()))\n        }\n    }\n```\n\nAnd these other mappings for the nested lists\n\n```\npublic class PackageEntityToPackageSummaryAutoMapperTypeConfigurator : IAutoMapperTypeConfigurator\n{\n        public void Configure(IMapperConfiguration mapperConfiguration)\n        {\n            mapperConfiguration.CreateMap<Data.Models.Package, PackageSummary>()\n                .ForMember(dest => dest.Id, opt => opt.MapFrom(p => p.Id))\n        }\n}\n\npublic class TransportEquipmentEntityToTransportEquipmentSummaryAutoMapperTypeConfigurator : IAutoMapperTypeConfigurator\n{\n        public void Configure(IMapperConfiguration mapperConfiguration)\n        {\n            mapperConfiguration.CreateMap<Data.Models.TransportEquipment, TransportEquipmentSummary>()\n                .ForMember(dest => dest.Id, opt => opt.MapFrom(t => t.Id))\n        }\n}\n```\n\nAnd the exception is \n\n```\n> System.Reflection.TargetInvocationException: Exception has been thrown by the target of an invocation. ---> System.ArgumentException: An item with the same key has already been added. Key: MyModels.TransportEquipment Single[TransportEquipment](System.Collections.Generic.IEnumerable`1[MyModels.TransportEquipment])\n>    at System.ThrowHelper.ThrowAddingDuplicateWithKeyArgumentException(Object key)\n>    at System.Collections.Generic.Dictionary`2.Insert(TKey key, TValue value, Boolean add)\n>    at System.Linq.Enumerable.ToDictionary[TSource,TKey,TElement](List`1 source, Func`2 keySelector, Func`2 elementSelector, IEqualityComparer`1 comparer)\n>    at AutoMapper.Configuration.Conventions.SourceToDestinationNameMapperAttributesMember.<>c__DisplayClass1_0.<GetMatchingMemberInfo>b__0(TypeDetails ti)\n>    at System.Collections.Concurrent.ConcurrentDictionary`2.GetOrAdd(TKey key, Func`2 valueFactory)\n>    at AutoMapper.Configuration.Conventions.SourceToDestinationNameMapperAttributesMember.GetMatchingMemberInfo(IGetTypeInfoMembers getTypeInfoMembers, TypeDetails typeInfo, Type destType, Type destMemberType, String nameToSearch)\n>    at AutoMapper.Configuration.Conventions.ParentSourceToDestinationNameMapper.GetMatchingMemberInfo(TypeDetails typeInfo, Type destType, Type destMemberType, String nameToSearch)\n>    at AutoMapper.Configuration.Conventions.DefaultMember.MapDestinationPropertyToSource(IProfileConfiguration options, TypeDetails sourceType, Type destType, Type destMemberType, String nameToSearch, LinkedList`1 resolvers, IMemberConfiguration parent)\n>    at AutoMapper.Configuration.Conventions.MemberConfiguration.MapDestinationPropertyToSource(IProfileConfiguration options, TypeDetails sourceType, Type destType, Type destMemberType, String nameToSearch, LinkedList`1 resolvers)\n>    at AutoMapper.Configuration.Conventions.NameSplitMember.MapDestinationPropertyToSource(IProfileConfiguration options, TypeDetails sourceType, Type destType, Type destMemberType, String nameToSearch, LinkedList`1 resolvers, IMemberConfiguration parent)\n>    at AutoMapper.Configuration.Conventions.MemberConfiguration.MapDestinationPropertyToSource(IProfileConfiguration options, TypeDetails sourceType, Type destType, Type destMemberType, String nameToSearch, LinkedList`1 resolvers)\n>    at AutoMapper.TypeMapFactory.<>c__DisplayClass1_0.<MapDestinationPropertyToSource>b__0(IMemberConfiguration _)\n>    at System.Linq.Enumerable.Any[TSource](IEnumerable`1 source, Func`2 predicate)\n>    at AutoMapper.TypeMapFactory.CreateTypeMap(Type sourceType, Type destinationType, IProfileConfiguration options, MemberList memberList)\n>    at AutoMapper.Profile.BuildTypeMap(TypeMapRegistry typeMapRegistry, ITypeMapConfiguration config)\n>    at AutoMapper.Profile.AutoMapper.IProfileConfiguration.Register(TypeMapRegistry typeMapRegistry)\n>    at AutoMapper.MapperConfiguration.Seal()\n>    at AutoMapper.MapperConfiguration..ctor(Action`1 configure, IEnumerable`1 mappers)\n>    at AutoMapper.Mapper.Initialize(Action`1 config)\n>    at MyMvc.Startup.Configure(IApplicationBuilder app, ILoggerFactory loggerFactory, MyContextSeedData seeder, IEnumerable`1 autoMapperTypeConfigurations) in C:\\gitrepos\\MyApi\\src\\MyMvc\\Startup.cs:line 258\n>    --- End of inner exception stack trace ---\n>    at System.RuntimeMethodHandle.InvokeMethod(Object target, Object[] arguments, Signature sig, Boolean constructor)\n>    at System.Reflection.RuntimeMethodInfo.UnsafeInvokeInternal(Object obj, Object[] parameters, Object[] arguments)\n>    at System.Reflection.RuntimeMethodInfo.Invoke(Object obj, BindingFlags invokeAttr, Binder binder, Object[] parameters, CultureInfo culture)\n>    at Microsoft.AspNetCore.Hosting.Startup.ConfigureBuilder.Invoke(Object instance, IApplicationBuilder builder)\n>    at Microsoft.AspNetCore.Hosting.Internal.WebHost.BuildApplication()\n```\n\n**What does it mean this exception? What duplicate key?** I am trying to find out why it does not like the Mapping for the TransportEquipment list and why the Packages is all good despite being both similar in structure.\n\nHas anybody tried something similar with the latest version? Is it a bug? Maybe something to do with a circular reference due to the fact that both my Package and TransportEquipment have a reference to a Consignmnet? (Although I don't see how, because the destination mapping is something quite simple)\n","closed_by":{"login":"jbogard","id":104498,"node_id":"MDQ6VXNlcjEwNDQ5OA==","avatar_url":"https://avatars.githubusercontent.com/u/104498?v=4","gravatar_id":"","url":"https://api.github.com/users/jbogard","html_url":"https://github.com/jbogard","followers_url":"https://api.github.com/users/jbogard/followers","following_url":"https://api.github.com/users/jbogard/following{/other_user}","gists_url":"https://api.github.com/users/jbogard/gists{/gist_id}","starred_url":"https://api.github.com/users/jbogard/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jbogard/subscriptions","organizations_url":"https://api.github.com/users/jbogard/orgs","repos_url":"https://api.github.com/users/jbogard/repos","events_url":"https://api.github.com/users/jbogard/events{/privacy}","received_events_url":"https://api.github.com/users/jbogard/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/LuckyPennySoftware/AutoMapper/issues/1297/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/LuckyPennySoftware/AutoMapper/issues/1297/timeline","performed_via_github_app":null,"state_reason":"completed"}