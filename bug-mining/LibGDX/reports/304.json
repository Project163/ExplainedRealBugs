{"url":"https://api.github.com/repos/libgdx/libgdx/issues/2970","repository_url":"https://api.github.com/repos/libgdx/libgdx","labels_url":"https://api.github.com/repos/libgdx/libgdx/issues/2970/labels{/name}","comments_url":"https://api.github.com/repos/libgdx/libgdx/issues/2970/comments","events_url":"https://api.github.com/repos/libgdx/libgdx/issues/2970/events","html_url":"https://github.com/libgdx/libgdx/issues/2970","id":63577526,"node_id":"MDU6SXNzdWU2MzU3NzUyNg==","number":2970,"title":"Instantiating `Music` from an Android `FileDescriptor`","user":{"login":"manta","id":11437612,"node_id":"MDQ6VXNlcjExNDM3NjEy","avatar_url":"https://avatars.githubusercontent.com/u/11437612?v=4","gravatar_id":"","url":"https://api.github.com/users/manta","html_url":"https://github.com/manta","followers_url":"https://api.github.com/users/manta/followers","following_url":"https://api.github.com/users/manta/following{/other_user}","gists_url":"https://api.github.com/users/manta/gists{/gist_id}","starred_url":"https://api.github.com/users/manta/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/manta/subscriptions","organizations_url":"https://api.github.com/users/manta/orgs","repos_url":"https://api.github.com/users/manta/repos","events_url":"https://api.github.com/users/manta/events{/privacy}","received_events_url":"https://api.github.com/users/manta/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":59604218,"node_id":"MDU6TGFiZWw1OTYwNDIxOA==","url":"https://api.github.com/repos/libgdx/libgdx/labels/android","name":"android","color":"0052cc","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2015-03-22T21:13:23Z","updated_at":"2015-11-04T05:30:56Z","closed_at":"2015-11-04T05:30:56Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"The way `Music` instances are created in LibGDX is through `Gdx.audio.newMusic(FileHandle)` &mdash; creating the `FileHandle` argument requires that users have the path to the file they want to play. There are legitimate situations where this path cannot be obtained, so a `Music` instance cannot be created.\n## The problem\n\nOne situation where the path cannot be obtained is when starting an `Intent` that asks the user to select a file from the device.\n\n```\nIntent intent = new Intent();\nintent.setAction(Intent.ACTION_PICK);\nintent.setData(android.provider.MediaStore.Audio.Media.EXTERNAL_CONTENT_URI);\nactivity.startActivityForResult(Intent.createChooser(intent, \"Select song\"), 0);\n```\n\nAfter the above `Activity` is completed, the `onActivityResult` method is called. Now we can try to obtain the path from `data` argument. However, we cannot do this directly. We have to query the database and look for the value of the `MediaStore.MediaColumns.DATA` column. \n\n```\nvoid onActivityResult(int requestCode, int resultCode, Intent data) {\n    Uri uri = data.getData();\n    String[] cols = { MediaStore.MediaColumns.DATA };\n    try (Cursor cursor = activity.getContentResolver().query(uri, cols, null, null, null)) {\n        cursor.moveToFirst();\n        int columnIndex = cursor.getColumnIndex(cols[0]);\n        this.path = cursor.getString(columnIndex);\n    } catch (Exception e) {\n        // Can throw if moveToFirst() fails.\n    }\n}\n```\n\nThe call to `cursor.moveToFirst()` can fail because there is no guarantee that the `DATA` column is available. Note that a missing `DATA` column does not mean the file is invalid or that it cannot be played. The `uri` object still is a valid `content://` id and it can be used to obtain a `FileDescriptor` that can then be passed to Android's [`MediaPlayer`](http://developer.android.com/reference/android/media/MediaPlayer.html#setDataSource%28java.io.FileDescriptor%29).\n\nFortunatelly, LibGDX uses `MediaPlayer` internally in `AndroidAudio`. _Un_fortunatelly LibGDX does not offer a mechanism through which the `MediaPlayer` can be passed an instance of a `FileDescriptor` &mdash; there is no `AndroidAudio.newMusic(FileDescriptor)`.\n## Proposed solution\n### Backend changes\n\nThe proposed solution is to add a new method `AndroidMusic newMusic(FileDescriptor)` to the `AndroidAudio` class. This would only be available on Android (it's not part of the generic `Audio` interface).\n\nBelow is a first draft of what the method would do. It is based on the already existing [`newMusic(FileHandle)`](https://github.com/libgdx/libgdx/blob/master/backends/gdx-backend-android/src/com/badlogic/gdx/backends/android/AndroidAudio.java#L99) method.\n\n```\npublic AndroidMusic newMusic(FileDescriptor file) {\n    if (soundPool == null) {\n        throw new GdxRuntimeException(\"Android audio is not enabled by the application config.\");\n    }\n\n    MediaPlayer mediaPlayer = new MediaPlayer();\n\n    try {      \n        mediaPlayer.setDataSource(file);\n        mediaPlayer.prepare();\n\n        AndroidMusic music = new AndroidMusic(this, mediaPlayer);\n        synchronized (musics) {\n            musics.add(music);\n        }\n        return music;\n    } catch (Exception ex) {\n        throw new GdxRuntimeException(\"Error loading audio file: \" + file, ex);\n    }\n}\n```\n### Usage\n\nHere is an example of how the user would modify the `onActivityResult` method to use the new functionality.\n\n```\nvoid onActivityResult(int requestCode, int resultCode, Intent data) {\n    Uri uri = data.getData();\n    ContentResolver resolver = this.getContentResolver();  // `this` is an `Activity`\n    try (ParcelFileDescriptor parcelFile = resolver.openFileDescriptor(uri, \"r\")) {\n        FileDescriptor file = parcelFile.getFileDescriptor();\n        AndroidAudio audio = (AndroidAudio) Gdx.audio;\n        this.theMusicWeWanted = audio.newMusic(file);\n    } catch (Exception e) {\n    }\n}\n```\n\nAfter obtaining `this.theMusicWeWanted` we can then [somehow](https://github.com/libgdx/libgdx/wiki/Interfacing-with-platform-specific-code) pass it back to the core application.\n","closed_by":{"login":"MobiDevelop","id":1095464,"node_id":"MDQ6VXNlcjEwOTU0NjQ=","avatar_url":"https://avatars.githubusercontent.com/u/1095464?v=4","gravatar_id":"","url":"https://api.github.com/users/MobiDevelop","html_url":"https://github.com/MobiDevelop","followers_url":"https://api.github.com/users/MobiDevelop/followers","following_url":"https://api.github.com/users/MobiDevelop/following{/other_user}","gists_url":"https://api.github.com/users/MobiDevelop/gists{/gist_id}","starred_url":"https://api.github.com/users/MobiDevelop/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MobiDevelop/subscriptions","organizations_url":"https://api.github.com/users/MobiDevelop/orgs","repos_url":"https://api.github.com/users/MobiDevelop/repos","events_url":"https://api.github.com/users/MobiDevelop/events{/privacy}","received_events_url":"https://api.github.com/users/MobiDevelop/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/libgdx/libgdx/issues/2970/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/libgdx/libgdx/issues/2970/timeline","performed_via_github_app":null,"state_reason":"completed"}