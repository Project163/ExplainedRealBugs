{"url":"https://api.github.com/repos/libgdx/libgdx/issues/4164","repository_url":"https://api.github.com/repos/libgdx/libgdx","labels_url":"https://api.github.com/repos/libgdx/libgdx/issues/4164/labels{/name}","comments_url":"https://api.github.com/repos/libgdx/libgdx/issues/4164/comments","events_url":"https://api.github.com/repos/libgdx/libgdx/issues/4164/events","html_url":"https://github.com/libgdx/libgdx/issues/4164","id":161752397,"node_id":"MDU6SXNzdWUxNjE3NTIzOTc=","number":4164,"title":"btRaycastVehicle wheels never collide with objects part of collision group","user":{"login":"Bolt-Head","id":19981350,"node_id":"MDQ6VXNlcjE5OTgxMzUw","avatar_url":"https://avatars.githubusercontent.com/u/19981350?v=4","gravatar_id":"","url":"https://api.github.com/users/Bolt-Head","html_url":"https://github.com/Bolt-Head","followers_url":"https://api.github.com/users/Bolt-Head/followers","following_url":"https://api.github.com/users/Bolt-Head/following{/other_user}","gists_url":"https://api.github.com/users/Bolt-Head/gists{/gist_id}","starred_url":"https://api.github.com/users/Bolt-Head/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Bolt-Head/subscriptions","organizations_url":"https://api.github.com/users/Bolt-Head/orgs","repos_url":"https://api.github.com/users/Bolt-Head/repos","events_url":"https://api.github.com/users/Bolt-Head/events{/privacy}","received_events_url":"https://api.github.com/users/Bolt-Head/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2016-06-22T18:23:50Z","updated_at":"2016-10-15T18:55:34Z","closed_at":"2016-10-15T18:55:34Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"#### Issue details\n\nThe btRaycastVehicle chasis correctly collides with other objects of the same collision group, however the wheels will always fall through the surface. This means the btRaycastVehicle only works if collision groups and filters are never used in the world.  This is briefly discussed on the Bullet forums:\nhttp://bulletphysics.org/Bullet/phpBB3/viewtopic.php?f=9&t=5494&start=0\n#### Reproduction steps/code\n\nThis can be observed by creating a modified VehicleTest:\n\n```\npublic class VehicleFilterTest extends VehicleTest {\n\n    @Override\n    public BulletWorld createWorld() {\n        //Force all objects to same collision group and filter\n        final short filterGroup = (1 << 11);\n        final short filterMask = filterGroup;\n\n        BulletWorld filterWorld = new BulletWorld() {\n            @Override\n            public void add (final BulletEntity entity) {\n            super.add(entity);\n            if (entity.body != null) {\n                if (entity.body instanceof btRigidBody)\n                    ((btDiscreteDynamicsWorld)collisionWorld).addRigidBody((btRigidBody)entity.body,filterGroup,filterMask);\n                else\n                    collisionWorld.addCollisionObject(entity.body,filterGroup,filterMask);\n                // Store the index of the entity in the collision object.\n                entity.body.setUserValue(entities.size - 1);\n            }\n            }\n        };\n        return filterWorld;\n    }\n}\n```\n\nThe fix is to override the rayCast() function of the btVehicleRaycaster that is given in the btRaycastVehicle constructor and set the collision group and filter of the ray before performing a rayTest.\n\nI wrote out what _should_ be potential solution below. Only the new setCollisionFilterMask(int) and setCollisionFilterGroup(int) functions would have to be exposed through the JNI.\n\n```\n//------------------------------ btFilterableVehicleRaycaster.h-------------------------------------\n#ifndef BT_FILTERABLE_VEHICLE_RAYCASTER_H\n#define BT_FILTERABLE_VEHICLE_RAYCASTER_H\n\n#include \"LinearMath/btVector3.h\"\n\n\nclass btFilterableVehicleRaycaster : public btDefaultVehicleRaycaster\n{\npublic:\n\n    short int m_collisionFilterMask;\n    short int m_collisionFilterGroup;\n\npublic:\n    virtual void setCollisionFilterMask(short int collisionFilterMask);\n    virtual void setCollisionFilterGroup(short int collisionFilterGroup);\n\n};\n\n#endif // BT_FILTERABLE_VEHICLE_RAYCASTER_H\n\n\n//------------------------------ btFilterableVehicleRaycaster.cpp-------------------------------------\n#include \"btFilterableVehicleRaycaster.h\"\n\nbtFilterableVehicleRaycaster(btDynamicsWorld* world)\n        :m_dynamicsWorld(world), \n        m_collisionFilterMask(btBroadphaseProxy::AllFilter),\n        m_collisionFilterGroup(btBroadphaseProxy::DefaultFilter)\n\n    {\n    }\n\nvoid btFilterableVehicleRaycaster::setCollisionFilterMask(short int collisionFilterMask)\n{\n    m_collisionFilterMask = collisionFilterMask;\n}\n\nvoid btFilterableVehicleRaycaster::setCollisionFilterGroup(short int collisionFilterGroup)\n{\n    m_collisionFilterGroup = collisionFilterGroup;\n}\n\nvoid* btFilterableVehicleRaycaster::castRay(const btVector3& from,const btVector3& to, btVehicleRaycasterResult& result)\n{\n\n    btCollisionWorld::ClosestRayResultCallback rayCallback(from,to);\n\n    rayCallback.m_collisionFilterMask = m_collisionFilterMask;\n    rayCallback.m_collisionFilterGroup = m_collisionFilterGroup;\n\n    m_dynamicsWorld->rayTest(from, to, rayCallback);\n\n    if (rayCallback.hasHit())\n    {\n\n        const btRigidBody* body = btRigidBody::upcast(rayCallback.m_collisionObject);\n        if (body && body->hasContactResponse())\n        {\n            result.m_hitPointInWorld = rayCallback.m_hitPointWorld;\n            result.m_hitNormalInWorld = rayCallback.m_hitNormalWorld;\n            result.m_hitNormalInWorld.normalize();\n            result.m_distFraction = rayCallback.m_closestHitFraction;\n            return (void*)body;\n        }\n    }\n    return 0;\n}\n```\n\nI'm working on setting up an build environment for the native sources, but if someone already has one set up is able to submit a PR before then, it would be greatly appreciated. \n","closed_by":{"login":"xoppa","id":2349087,"node_id":"MDQ6VXNlcjIzNDkwODc=","avatar_url":"https://avatars.githubusercontent.com/u/2349087?v=4","gravatar_id":"","url":"https://api.github.com/users/xoppa","html_url":"https://github.com/xoppa","followers_url":"https://api.github.com/users/xoppa/followers","following_url":"https://api.github.com/users/xoppa/following{/other_user}","gists_url":"https://api.github.com/users/xoppa/gists{/gist_id}","starred_url":"https://api.github.com/users/xoppa/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/xoppa/subscriptions","organizations_url":"https://api.github.com/users/xoppa/orgs","repos_url":"https://api.github.com/users/xoppa/repos","events_url":"https://api.github.com/users/xoppa/events{/privacy}","received_events_url":"https://api.github.com/users/xoppa/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/libgdx/libgdx/issues/4164/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/libgdx/libgdx/issues/4164/timeline","performed_via_github_app":null,"state_reason":"completed"}