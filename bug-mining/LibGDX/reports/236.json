{"url":"https://api.github.com/repos/libgdx/libgdx/issues/3035","repository_url":"https://api.github.com/repos/libgdx/libgdx","labels_url":"https://api.github.com/repos/libgdx/libgdx/issues/3035/labels{/name}","comments_url":"https://api.github.com/repos/libgdx/libgdx/issues/3035/comments","events_url":"https://api.github.com/repos/libgdx/libgdx/issues/3035/events","html_url":"https://github.com/libgdx/libgdx/issues/3035","id":69552657,"node_id":"MDU6SXNzdWU2OTU1MjY1Nw==","number":3035,"title":"Font wrapping error (floating point rounding error)","user":{"login":"RobRendell","id":1848870,"node_id":"MDQ6VXNlcjE4NDg4NzA=","avatar_url":"https://avatars.githubusercontent.com/u/1848870?v=4","gravatar_id":"","url":"https://api.github.com/users/RobRendell","html_url":"https://github.com/RobRendell","followers_url":"https://api.github.com/users/RobRendell/followers","following_url":"https://api.github.com/users/RobRendell/following{/other_user}","gists_url":"https://api.github.com/users/RobRendell/gists{/gist_id}","starred_url":"https://api.github.com/users/RobRendell/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/RobRendell/subscriptions","organizations_url":"https://api.github.com/users/RobRendell/orgs","repos_url":"https://api.github.com/users/RobRendell/repos","events_url":"https://api.github.com/users/RobRendell/events{/privacy}","received_events_url":"https://api.github.com/users/RobRendell/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2015-04-20T10:06:12Z","updated_at":"2015-04-21T11:25:45Z","closed_at":"2015-04-21T11:25:45Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I've stumbled across an error when wrapping the text of labels.  It's due to a floating point error in GlyphLayout, so is extremely sensitive to its input, but the following code should reproduce it:\n\n```\npublic class FontWrapIssue extends ApplicationAdapter {\n\n    private static final float GAME_WIDTH = 230.4f;\n\n    private Stage stage;\n\n    @Override\n    public void create () {\n        float gameScale = GAME_WIDTH / Gdx.graphics.getWidth();\n        int gameHeight = (int) (Gdx.graphics.getHeight() * gameScale + 0.5);\n        stage = new Stage(new FitViewport(GAME_WIDTH, gameHeight));\n        Gdx.input.setInputProcessor(stage);\n        resize(Gdx.graphics.getWidth(), Gdx.graphics.getHeight());\n        FreeTypeFontGenerator generator = new FreeTypeFontGenerator(Gdx.files.internal(\"data/arial.ttf\"));\n        FreeTypeFontGenerator.FreeTypeFontParameter parameter = new FreeTypeFontGenerator.FreeTypeFontParameter();\n        parameter.size = (int) (20 / gameScale + 0.5);\n        BitmapFont font = generator.generateFont(parameter);\n        font.getData().setScale(gameScale);\n        Label.LabelStyle labelStyle = new Label.LabelStyle();\n        labelStyle.font = font;\n        labelStyle.fontColor = Color.WHITE;\n        String text = \"test with wHVVVl wHVVVl issue\";\n        Table table = new Table();\n        table.setFillParent(true);\n        addLabel(table, text, labelStyle);\n        stage.addActor(table);\n        table.debug();\n    }\n\n    private void addLabel(Table table, String text, Label.LabelStyle labelStyle) {\n        Label label = new Label(text, labelStyle);\n        label.setWrap(true);\n        table.add(label).fillX().expandX().row();\n    }\n\n    @Override\n    public void render () {\n        Gdx.gl.glClearColor(0, 0, 0, 1);\n        Gdx.gl.glClear(GL20.GL_COLOR_BUFFER_BIT);\n        stage.act(Gdx.graphics.getDeltaTime());\n        stage.draw();\n    }\n\n    public static void main (String[] args) throws Exception {\n        new LwjglApplication(new FontWrapIssue());\n    }\n}\n```\n\nScreenshot where you can see the text wrapping outside the Label's boundary:\n![fontwrapissue](https://cloud.githubusercontent.com/assets/1848870/7227694/01420e9a-e796-11e4-8cea-50c7f741d945.png)\n\nThe floating point error occurs when the glyphRun is wrapped (in version 1.5.6, `GlyphLayout.java` lines 287-288 and the loop at 297).  To work out the the width of the wrapped run, the code calculates backwards from the current position by subtracting the xAdvances of the glyphs that overshot the desired width (including any white space).  However, due to floating point rounding errors the result can occasionally be slightly smaller than the result of summing all the xAdvances of the glyphs leading up to the wrap point (i.e. we have `x + w1 + w2 + ...  - w1 - w2 - ...` giving a result different from x).\n\nThat error alone would just result in the text wrapping in the wrong place.  The reason the text of the `Label` goes outside its boundary is because the code in `Label.computeSize()` that calculates the bounds of the label always uses the actor's width as the targetWidth passed to `layout.setText()`, so it doesn't care about the error in the run length.  The code in `Label.layout()` however calculates the targetWidth based on the computed bounds, which will be fractionally too narrow in the case when this floating point error occurs.  IMHO, `Label.layout()` should always use a targetWidth that matches whatever `Label.computeSize()` uses (for wrapped text at least), so there is never a discrepancy.\n","closed_by":{"login":"NathanSweet","id":434010,"node_id":"MDQ6VXNlcjQzNDAxMA==","avatar_url":"https://avatars.githubusercontent.com/u/434010?v=4","gravatar_id":"","url":"https://api.github.com/users/NathanSweet","html_url":"https://github.com/NathanSweet","followers_url":"https://api.github.com/users/NathanSweet/followers","following_url":"https://api.github.com/users/NathanSweet/following{/other_user}","gists_url":"https://api.github.com/users/NathanSweet/gists{/gist_id}","starred_url":"https://api.github.com/users/NathanSweet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/NathanSweet/subscriptions","organizations_url":"https://api.github.com/users/NathanSweet/orgs","repos_url":"https://api.github.com/users/NathanSweet/repos","events_url":"https://api.github.com/users/NathanSweet/events{/privacy}","received_events_url":"https://api.github.com/users/NathanSweet/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/libgdx/libgdx/issues/3035/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/libgdx/libgdx/issues/3035/timeline","performed_via_github_app":null,"state_reason":"completed"}