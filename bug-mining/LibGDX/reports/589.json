{"url":"https://api.github.com/repos/libgdx/libgdx/issues/7513","repository_url":"https://api.github.com/repos/libgdx/libgdx","labels_url":"https://api.github.com/repos/libgdx/libgdx/issues/7513/labels{/name}","comments_url":"https://api.github.com/repos/libgdx/libgdx/issues/7513/comments","events_url":"https://api.github.com/repos/libgdx/libgdx/issues/7513/events","html_url":"https://github.com/libgdx/libgdx/issues/7513","id":2665829899,"node_id":"I_kwDOAFH-b86e5VYL","number":7513,"title":"BSpline Test Failures and Suggested Fixes","user":{"login":"leschli","id":159204984,"node_id":"U_kgDOCX1GeA","avatar_url":"https://avatars.githubusercontent.com/u/159204984?v=4","gravatar_id":"","url":"https://api.github.com/users/leschli","html_url":"https://github.com/leschli","followers_url":"https://api.github.com/users/leschli/followers","following_url":"https://api.github.com/users/leschli/following{/other_user}","gists_url":"https://api.github.com/users/leschli/gists{/gist_id}","starred_url":"https://api.github.com/users/leschli/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/leschli/subscriptions","organizations_url":"https://api.github.com/users/leschli/orgs","repos_url":"https://api.github.com/users/leschli/repos","events_url":"https://api.github.com/users/leschli/events{/privacy}","received_events_url":"https://api.github.com/users/leschli/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2024-11-17T12:53:48Z","updated_at":"2025-03-09T12:22:33Z","closed_at":"2025-03-09T12:22:33Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"#### Issue details\r\nAfter running several tests on the BSpline.java class, multiple issues were identified, particularly when dealing with non-continuous splines, approximations, and derivatives. The tests highlighted incorrect or NaN results in certain edge cases, suggesting potential problems with the current implementation of spline interpolation and derivative calculations.\r\n\r\n#### Reproduction steps/code\r\nTo reproduce the issue, run the following tests from the BSplineTest class:\r\n\r\n1. testApproximation: This test checks if the approximation of spline values returns correct results for a given input. It fails when the expected value is 0.5, but the returned value is NaN.\r\n\r\n2. testCubicSplineNonContinuous: Tests cubic spline behavior for non-continuous cases, where the expected value is 0.5, but the result is 0.45833334, showing a discrepancy.\r\n\r\n3. testCubicDerivative: This test checks if the cubic spline derivative calculation produces the correct value. It expects 2.0, but the returned value is 1.0.\r\n\r\n4. testEdgeCases: Tests edge cases where the expected result is 0.0, but the function returns 1.0.\r\n\r\n5. testCubicSplineContinuous: Tests cubic spline behavior when it is continuous. The expected value is 0.75, but the function returns 1.0.\r\n\r\nThese tests consistently produce incorrect or unexpected values, suggesting problems in the BSpline.java implementation.\r\n\r\n#### The code\r\n```\r\npackage com.badlogic.gdx.math;\r\n\r\nimport org.junit.Assert;\r\nimport org.junit.Test;\r\n\r\n public class BSplineTest {\r\n\r\n    /**\r\n     * Test to validate basic cubic spline interpolation with non-continuous control points.\r\n     */\r\n    @Test\r\n    public void testCubicSplineNonContinuous() {\r\n        Vector3[] controlPoints = {\r\n            new Vector3(0, 0, 0),\r\n            new Vector3(1, 1, 0),\r\n            new Vector3(2, 0, 0),\r\n            new Vector3(3, -1, 0)\r\n        };\r\n        BSpline<Vector3> spline = new BSpline<>(controlPoints, 3, false);\r\n\r\n        Vector3 result = new Vector3();\r\n        spline.valueAt(result, 0.5f); // Testing at t = 0.5\r\n\r\n        // Expected value at t = 0.5 is approximate\r\n        Vector3 expected = new Vector3(1.5f, 0.5f, 0); // Expected value based on curve shape\r\n        Assert.assertEquals(expected.x, result.x, 0.001f);\r\n        Assert.assertEquals(expected.y, result.y, 0.001f);\r\n        Assert.assertEquals(expected.z, result.z, 0.001f);\r\n    }\r\n\r\n    /**\r\n     * Test to validate cubic spline interpolation with continuous control points.\r\n     */\r\n    @Test\r\n    public void testCubicSplineContinuous() {\r\n        Vector3[] controlPoints = {\r\n            new Vector3(0, 0, 0),\r\n            new Vector3(1, 1, 0),\r\n            new Vector3(2, 0, 0),\r\n            new Vector3(3, -1, 0)\r\n        };\r\n        BSpline<Vector3> spline = new BSpline<>(controlPoints, 3, true);\r\n\r\n        Vector3 result = new Vector3();\r\n        spline.valueAt(result, 0.25f); // Testing at t = 0.25\r\n\r\n        // Expected value at t = 0.25 is approximate\r\n        Vector3 expected = new Vector3(0.75f, 0.75f, 0); // Expected value based on curve shape\r\n        Assert.assertEquals(expected.x, result.x, 0.001f);\r\n        Assert.assertEquals(expected.y, result.y, 0.001f);\r\n        Assert.assertEquals(expected.z, result.z, 0.001f);\r\n    }\r\n\r\n    /**\r\n     * Test to validate derivative calculation at a specific point.\r\n     */\r\n    @Test\r\n    public void testCubicDerivative() {\r\n        Vector3[] controlPoints = {\r\n            new Vector3(0, 0, 0),\r\n            new Vector3(1, 1, 0),\r\n            new Vector3(2, 0, 0),\r\n            new Vector3(3, -1, 0)\r\n        };\r\n        BSpline<Vector3> spline = new BSpline<>(controlPoints, 3, false);\r\n\r\n        Vector3 derivative = new Vector3();\r\n        spline.derivativeAt(derivative, 0.5f); // Testing derivative at t = 0.5\r\n\r\n        // Expected derivative value is approximate\r\n        Vector3 expectedDerivative = new Vector3(2, -1, 0); // Expected derivative based on curve shape\r\n        Assert.assertEquals(expectedDerivative.x, derivative.x, 0.001f);\r\n        Assert.assertEquals(expectedDerivative.y, derivative.y, 0.001f);\r\n        Assert.assertEquals(expectedDerivative.z, derivative.z, 0.001f);\r\n    }\r\n\r\n    /**\r\n     * Test to validate approximation of the nearest point on the spline.\r\n     */\r\n    @Test\r\n    public void testApproximation() {\r\n        Vector3[] controlPoints = {\r\n            new Vector3(0, 0, 0),\r\n            new Vector3(1, 1, 0),\r\n            new Vector3(2, 0, 0),\r\n            new Vector3(3, -1, 0)\r\n        };\r\n        BSpline<Vector3> spline = new BSpline<>(controlPoints, 3, false);\r\n\r\n        Vector3 point = new Vector3(1.5f, 0.5f, 0);\r\n        float t = spline.approximate(point);\r\n\r\n        // t should be approximately 0.5\r\n        Assert.assertEquals(0.5f, t, 0.01f);\r\n    }\r\n\r\n    /**\r\n     * Test to validate continuity in a continuous spline.\r\n     */\r\n    @Test\r\n    public void testSplineContinuity() {\r\n        Vector3[] controlPoints = {\r\n            new Vector3(0, 0, 0),\r\n            new Vector3(1, 1, 0),\r\n            new Vector3(2, 0, 0),\r\n            new Vector3(3, -1, 0)\r\n        };\r\n        BSpline<Vector3> spline = new BSpline<>(controlPoints, 3, true);\r\n\r\n        Vector3 start = new Vector3();\r\n        Vector3 end = new Vector3();\r\n        spline.valueAt(start, 0.0f);\r\n        spline.valueAt(end, 1.0f);\r\n\r\n        // For a continuous spline, the start and end points should be equal\r\n        Assert.assertEquals(start.x, end.x, 0.001f);\r\n        Assert.assertEquals(start.y, end.y, 0.001f);\r\n        Assert.assertEquals(start.z, end.z, 0.001f);\r\n    }\r\n\r\n    /**\r\n     * Test to validate calculation with edge cases (t = 0 and t = 1).\r\n     */\r\n    @Test\r\n    public void testEdgeCases() {\r\n        Vector3[] controlPoints = {\r\n            new Vector3(0, 0, 0),\r\n            new Vector3(1, 1, 0),\r\n            new Vector3(2, 0, 0),\r\n            new Vector3(3, -1, 0)\r\n        };\r\n        BSpline<Vector3> spline = new BSpline<>(controlPoints, 3, false);\r\n\r\n        Vector3 start = new Vector3();\r\n        Vector3 end = new Vector3();\r\n        spline.valueAt(start, 0.0f); // Testing at t = 0\r\n        spline.valueAt(end, 1.0f);   // Testing at t = 1\r\n\r\n        // Start point should match the first control point\r\n        Assert.assertEquals(controlPoints[0].x, start.x, 0.001f);\r\n        Assert.assertEquals(controlPoints[0].y, start.y, 0.001f);\r\n        Assert.assertEquals(controlPoints[0].z, start.z, 0.001f);\r\n\r\n        // End point should match the last control point\r\n        Assert.assertEquals(controlPoints[3].x, end.x, 0.001f);\r\n        Assert.assertEquals(controlPoints[3].y, end.y, 0.001f);\r\n        Assert.assertEquals(controlPoints[3].z, end.z, 0.001f);\r\n    }\r\n}\r\n\r\n```\r\n\r\n#### Stacktrace\r\n```\r\n// Test Results from BSplineTest.java\r\n\r\ntestApproximation(com.badlogic.gdx.math.BSplineTest)\r\njava.lang.AssertionError: expected:<0.5> but was:<NaN>\r\n\tat org.junit.Assert.fail(Assert.java:89)\r\n\tat org.junit.Assert.failNotEquals(Assert.java:835)\r\n\tat org.junit.Assert.assertEquals(Assert.java:577)\r\n\tat org.junit.Assert.assertEquals(Assert.java:701)\r\n\tat com.badlogic.gdx.math.BSplineTest.testApproximation(BSplineTest.java:94)\r\n\t...\r\n\r\ntestCubicSplineNonContinuous(com.badlogic.gdx.math.BSplineTest)\r\njava.lang.AssertionError: expected:<0.5> but was:<0.45833334>\r\n\tat org.junit.Assert.fail(Assert.java:89)\r\n\tat org.junit.Assert.failNotEquals(Assert.java:835)\r\n\tat org.junit.Assert.assertEquals(Assert.java:577)\r\n\tat org.junit.Assert.assertEquals(Assert.java:701)\r\n\tat com.badlogic.gdx.math.BSplineTest.testCubicSplineNonContinuous(BSplineTest.java:27)\r\n\t...\r\n\r\ntestCubicDerivative(com.badlogic.gdx.math.BSplineTest)\r\njava.lang.AssertionError: expected:<2.0> but was:<1.0>\r\n\tat org.junit.Assert.fail(Assert.java:89)\r\n\tat org.junit.Assert.failNotEquals(Assert.java:835)\r\n\tat org.junit.Assert.assertEquals(Assert.java:577)\r\n\tat org.junit.Assert.assertEquals(Assert.java:701)\r\n\tat com.badlogic.gdx.math.BSplineTest.testCubicDerivative(BSplineTest.java:72)\r\n\t...\r\n\r\ntestEdgeCases(com.badlogic.gdx.math.BSplineTest)\r\njava.lang.AssertionError: expected:<0.0> but was:<1.0>\r\n\tat org.junit.Assert.fail(Assert.java:89)\r\n\tat org.junit.Assert.failNotEquals(Assert.java:835)\r\n\tat org.junit.Assert.assertEquals(Assert.java:577)\r\n\tat org.junit.Assert.assertEquals(Assert.java:701)\r\n\tat com.badlogic.gdx.math.BSplineTest.testEdgeCases(BSplineTest.java:140)\r\n\t...\r\n\r\ntestCubicSplineContinuous(com.badlogic.gdx.math.BSplineTest)\r\njava.lang.AssertionError: expected:<0.75> but was:<1.0>\r\n\tat org.junit.Assert.fail(Assert.java:89)\r\n\tat org.junit.Assert.failNotEquals(Assert.java:835)\r\n\tat org.junit.Assert.assertEquals(Assert.java:577)\r\n\tat org.junit.Assert.assertEquals(Assert.java:701)\r\n\tat com.badlogic.gdx.math.BSplineTest.testCubicSplineContinuous(BSplineTest.java:49)\r\n\t...\r\n```\r\n\r\n\r\n**Proposed Fix:**\r\nIt seems that the issues arise due to:\r\n\r\n1. Index Handling: The handling of the control point indices and boundary conditions is incorrect in certain cases, leading to NaN values or unexpected results at the edges.\r\n2. Approximation Calculation: There may be errors in how the approximation method calculates spline values, especially near the boundaries.\r\n3. Derivative Calculations: The derivative function might need adjustments to correctly handle non-continuous splines.\r\n\r\nThe proposed changes include:\r\n\r\n- Refining index handling to avoid out-of-bounds access or incorrect interpolation at spline edges.\r\n- Improving the approximation method to ensure correct results across the spline range.\r\n- Revising the derivative calculation logic for more accurate derivative values.\r\n- Ensuring that edge cases (such as out-of-bound inputs) are correctly handled.\r\n\r\n**Is it useful and feasible to apply these fixes?**\r\nI believe applying these fixes would improve the robustness and correctness of the spline calculations in the library. I would appreciate feedback on whether these changes align with the goals of the project and if I should proceed with implementing them.","closed_by":{"login":"Tom-Ski","id":4346114,"node_id":"MDQ6VXNlcjQzNDYxMTQ=","avatar_url":"https://avatars.githubusercontent.com/u/4346114?v=4","gravatar_id":"","url":"https://api.github.com/users/Tom-Ski","html_url":"https://github.com/Tom-Ski","followers_url":"https://api.github.com/users/Tom-Ski/followers","following_url":"https://api.github.com/users/Tom-Ski/following{/other_user}","gists_url":"https://api.github.com/users/Tom-Ski/gists{/gist_id}","starred_url":"https://api.github.com/users/Tom-Ski/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Tom-Ski/subscriptions","organizations_url":"https://api.github.com/users/Tom-Ski/orgs","repos_url":"https://api.github.com/users/Tom-Ski/repos","events_url":"https://api.github.com/users/Tom-Ski/events{/privacy}","received_events_url":"https://api.github.com/users/Tom-Ski/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/libgdx/libgdx/issues/7513/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/libgdx/libgdx/issues/7513/timeline","performed_via_github_app":null,"state_reason":"completed"}