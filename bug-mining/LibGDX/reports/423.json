{"url":"https://api.github.com/repos/libgdx/libgdx/issues/4268","repository_url":"https://api.github.com/repos/libgdx/libgdx","labels_url":"https://api.github.com/repos/libgdx/libgdx/issues/4268/labels{/name}","comments_url":"https://api.github.com/repos/libgdx/libgdx/issues/4268/comments","events_url":"https://api.github.com/repos/libgdx/libgdx/issues/4268/events","html_url":"https://github.com/libgdx/libgdx/issues/4268","id":172880740,"node_id":"MDU6SXNzdWUxNzI4ODA3NDA=","number":4268,"title":"Fix for getPosition() on OpenALMusic","user":{"login":"riqueaalves","id":21214278,"node_id":"MDQ6VXNlcjIxMjE0Mjc4","avatar_url":"https://avatars.githubusercontent.com/u/21214278?v=4","gravatar_id":"","url":"https://api.github.com/users/riqueaalves","html_url":"https://github.com/riqueaalves","followers_url":"https://api.github.com/users/riqueaalves/followers","following_url":"https://api.github.com/users/riqueaalves/following{/other_user}","gists_url":"https://api.github.com/users/riqueaalves/gists{/gist_id}","starred_url":"https://api.github.com/users/riqueaalves/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/riqueaalves/subscriptions","organizations_url":"https://api.github.com/users/riqueaalves/orgs","repos_url":"https://api.github.com/users/riqueaalves/repos","events_url":"https://api.github.com/users/riqueaalves/events{/privacy}","received_events_url":"https://api.github.com/users/riqueaalves/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":11336980,"node_id":"MDU6TGFiZWwxMTMzNjk4MA==","url":"https://api.github.com/repos/libgdx/libgdx/labels/bug","name":"bug","color":"fc2929","default":true,"description":null},{"id":119244972,"node_id":"MDU6TGFiZWwxMTkyNDQ5NzI=","url":"https://api.github.com/repos/libgdx/libgdx/labels/desktop","name":"desktop","color":"0052cc","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2016-08-24T07:14:29Z","updated_at":"2017-09-04T16:59:29Z","closed_at":"2017-09-04T16:59:29Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Please ensure you have given all the following requested information in your report.\n#### Issue details\n\nAfter trying to sync some music on desktop, I found out that music.getPosition() does not always return accurate values. This is due to the field \"renderedSeconds\" being set to 0 once there isn't data to be put on one of the buffer, even with the other two buffers still not processed.\n#### Reproduction steps/code\n\nThe music being used for this example was .wav, 10s long, 16bit, 44100Hz, mono --> 10s_2bytes_44100Hz = 882000 bytes of music. It was set to loop and, on the first loop, the method music.getPosition() did not go all the way to 10s, instead only went to 9.287981859s before going back to 0, and here is why: \n\nThe class OpenALMusic uses three byte buffers of maximum size 40960 bytes each to transfer data to the audio device. In this example it is needed 21 buffers of size 40960 bytes and 1 of size 21840 bytes to pass all the 882000 bytes of music data on each loop. The problem is that a parameter that gives the information on music.getPosition() is reset once there is no data on ONE of the buffers, not all three.\n\nIn this example: the last three buffers sizes of the loop are: 1-40960 bytes; 2-40960 bytes; 3-21840 bytes. Once the first buffer is completely processed, the music is reset, taking music.getPosition() to 0 again, but there still was (40960+21840)bytes = 0.712018141s of data before the end of the loop.\n\nThe following code snippet is from OpenALMusic. The update() method calls fill(int bufferID) and resets renderedSeconds to 0 once there isn't data to be put on one of the three buffers, leading to a value of 0 being returned from getPosition() before the end of the loop.\n\n``` java\npublic float getPosition () {\n      if (audio.noDevice) return 0;\n      if (sourceID == -1) return 0;\n      return renderedSeconds + alGetSourcef(sourceID, AL11.AL_SEC_OFFSET);\n   }\n\npublic void update () {\n      if (audio.noDevice) return;\n      if (sourceID == -1) return;\n\n      boolean end = false;\n      int buffers = alGetSourcei(sourceID, AL_BUFFERS_PROCESSED);\n      while (buffers-- > 0) {\n         int bufferID = alSourceUnqueueBuffers(sourceID);\n         if (bufferID == AL_INVALID_VALUE) break;\n         renderedSeconds += secondsPerBuffer;\n         if (end) continue;\n         if (fill(bufferID))\n            alSourceQueueBuffers(sourceID, bufferID);\n         else\n            end = true;\n      }\n      if (end && alGetSourcei(sourceID, AL_BUFFERS_QUEUED) == 0) {\n         stop();\n         if (onCompletionListener != null) onCompletionListener.onCompletion(this);\n      }\n\n      // A buffer underflow will cause the source to stop.\n      if (isPlaying && alGetSourcei(sourceID, AL_SOURCE_STATE) != AL_PLAYING) alSourcePlay(sourceID);\n   }\n\nprivate boolean fill (int bufferID) {\n      tempBuffer.clear();\n      int length = read(tempBytes);\n      if (length <= 0) {\n         if (isLooping) {\n            loop();\n            renderedSeconds = 0;\n            length = read(tempBytes);\n            if (length <= 0) return false;\n         } else\n            return false;\n      }\n      tempBuffer.put(tempBytes, 0, length).flip();\n      alBufferData(bufferID, format, tempBuffer, sampleRate);\n      return true;\n   }\n```\n#### Version of LibGDX and/or relevant dependencies\n\n1.9.4\n#### Stacktrace\n\n``` java\n//Please provide the stacktrace if applicable \n```\n#### Please select the affected platforms\n- [ ] Android\n- [ ] iOS (robovm)\n- [ ] iOS (MOE)\n- [ ] HTML/GWT\n- [X] Windows\n- [X] Linux\n- [X] MacOS\n","closed_by":{"login":"Tom-Ski","id":4346114,"node_id":"MDQ6VXNlcjQzNDYxMTQ=","avatar_url":"https://avatars.githubusercontent.com/u/4346114?v=4","gravatar_id":"","url":"https://api.github.com/users/Tom-Ski","html_url":"https://github.com/Tom-Ski","followers_url":"https://api.github.com/users/Tom-Ski/followers","following_url":"https://api.github.com/users/Tom-Ski/following{/other_user}","gists_url":"https://api.github.com/users/Tom-Ski/gists{/gist_id}","starred_url":"https://api.github.com/users/Tom-Ski/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Tom-Ski/subscriptions","organizations_url":"https://api.github.com/users/Tom-Ski/orgs","repos_url":"https://api.github.com/users/Tom-Ski/repos","events_url":"https://api.github.com/users/Tom-Ski/events{/privacy}","received_events_url":"https://api.github.com/users/Tom-Ski/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/libgdx/libgdx/issues/4268/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/libgdx/libgdx/issues/4268/timeline","performed_via_github_app":null,"state_reason":"completed"}