[{"url":"https://api.github.com/repos/libgdx/libgdx/issues/comments/238059139","html_url":"https://github.com/libgdx/libgdx/issues/4186#issuecomment-238059139","issue_url":"https://api.github.com/repos/libgdx/libgdx/issues/4186","id":238059139,"node_id":"MDEyOklzc3VlQ29tbWVudDIzODA1OTEzOQ==","user":{"login":"NathanSweet","id":434010,"node_id":"MDQ6VXNlcjQzNDAxMA==","avatar_url":"https://avatars.githubusercontent.com/u/434010?v=4","gravatar_id":"","url":"https://api.github.com/users/NathanSweet","html_url":"https://github.com/NathanSweet","followers_url":"https://api.github.com/users/NathanSweet/followers","following_url":"https://api.github.com/users/NathanSweet/following{/other_user}","gists_url":"https://api.github.com/users/NathanSweet/gists{/gist_id}","starred_url":"https://api.github.com/users/NathanSweet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/NathanSweet/subscriptions","organizations_url":"https://api.github.com/users/NathanSweet/orgs","repos_url":"https://api.github.com/users/NathanSweet/repos","events_url":"https://api.github.com/users/NathanSweet/events{/privacy}","received_events_url":"https://api.github.com/users/NathanSweet/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2016-08-07T02:16:04Z","updated_at":"2016-08-07T02:16:04Z","body":"Is there a simpler test? Eg if there is something wrong with Array.sort, narrow it down and show an Array.sort call that is wrong.\n","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/libgdx/libgdx/issues/comments/238059139/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"NathanSweet","id":434010,"node_id":"MDQ6VXNlcjQzNDAxMA==","avatar_url":"https://avatars.githubusercontent.com/u/434010?v=4","gravatar_id":"","url":"https://api.github.com/users/NathanSweet","html_url":"https://github.com/NathanSweet","followers_url":"https://api.github.com/users/NathanSweet/followers","following_url":"https://api.github.com/users/NathanSweet/following{/other_user}","gists_url":"https://api.github.com/users/NathanSweet/gists{/gist_id}","starred_url":"https://api.github.com/users/NathanSweet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/NathanSweet/subscriptions","organizations_url":"https://api.github.com/users/NathanSweet/orgs","repos_url":"https://api.github.com/users/NathanSweet/repos","events_url":"https://api.github.com/users/NathanSweet/events{/privacy}","received_events_url":"https://api.github.com/users/NathanSweet/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/libgdx/libgdx/issues/comments/238083025","html_url":"https://github.com/libgdx/libgdx/issues/4186#issuecomment-238083025","issue_url":"https://api.github.com/repos/libgdx/libgdx/issues/4186","id":238083025,"node_id":"MDEyOklzc3VlQ29tbWVudDIzODA4MzAyNQ==","user":{"login":"Bolt-Head","id":19981350,"node_id":"MDQ6VXNlcjE5OTgxMzUw","avatar_url":"https://avatars.githubusercontent.com/u/19981350?v=4","gravatar_id":"","url":"https://api.github.com/users/Bolt-Head","html_url":"https://github.com/Bolt-Head","followers_url":"https://api.github.com/users/Bolt-Head/followers","following_url":"https://api.github.com/users/Bolt-Head/following{/other_user}","gists_url":"https://api.github.com/users/Bolt-Head/gists{/gist_id}","starred_url":"https://api.github.com/users/Bolt-Head/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Bolt-Head/subscriptions","organizations_url":"https://api.github.com/users/Bolt-Head/orgs","repos_url":"https://api.github.com/users/Bolt-Head/repos","events_url":"https://api.github.com/users/Bolt-Head/events{/privacy}","received_events_url":"https://api.github.com/users/Bolt-Head/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2016-08-07T13:41:45Z","updated_at":"2016-08-07T13:41:45Z","body":"This is the shortest test case I was able to make and still have it show incorrect results. I unrolled the psuedo-random for-loop for clarity.\n\nThe result of the failed sorts are:\nFailed Sort: 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 13, 13, 13, 13, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 13, 13, 13, \n\nIf the sort was ran a second time it would show the correct masks of all the non-color instances (mask of 9) and then the color instances (mask of 13). But this is not always true with hundreds of renderables as many sorts consecutive sorts can still give incorrect results.\n\nAlthough the ArrayList.sort() is always able to sort it correctly the first time, I am not sure if it is something directly wrong with Array.sort or something wrong with one of the comparisons used in the sorting process. Because Array.sort works in every other context I tested, it might point to something being wrong in the attributes sorting logic. \n\nThe [ModelCache.sorter ](https://github.com/libgdx/libgdx/blob/master/gdx/src/com/badlogic/gdx/graphics/g3d/ModelCache.java#L143) sorts on the vertex attributes, then on a matching attributes sorts on material, and then sorts on primitive (which are the same in this test). I noticed if the material doesn't have a color attribute then the test passes which might point to something in [Attributes.compareTo](https://github.com/libgdx/libgdx/blob/master/gdx/src/com/badlogic/gdx/graphics/g3d/Attributes.java#L217) not behaving correctly.\n\n```\nimport java.util.Comparator;\n\nimport com.badlogic.gdx.ApplicationAdapter;\nimport com.badlogic.gdx.Gdx;\nimport com.badlogic.gdx.graphics.Color;\nimport com.badlogic.gdx.graphics.VertexAttributes.Usage;\nimport com.badlogic.gdx.graphics.g3d.Material;\nimport com.badlogic.gdx.graphics.g3d.Model;\nimport com.badlogic.gdx.graphics.g3d.ModelCache;\nimport com.badlogic.gdx.graphics.g3d.ModelInstance;\nimport com.badlogic.gdx.graphics.g3d.Renderable;\nimport com.badlogic.gdx.graphics.g3d.attributes.ColorAttribute;\nimport com.badlogic.gdx.graphics.g3d.utils.ModelBuilder;\nimport com.badlogic.gdx.utils.Array;\nimport com.badlogic.gdx.utils.Pool;\n\npublic class ModelCacheTest extends ApplicationAdapter {\n\n    private ModelBuilder modelBuilder = new ModelBuilder();\n    private final Comparator<Renderable> comparator = new ModelCache.Sorter();\n\n    @Override\n    public void create() {\n\n        final Material materialRed = new Material();\n        //If a color is not added to the material Array.sort will sort correctly\n        materialRed.set(ColorAttribute.createDiffuse(Color.RED));\n\n        //Two model types, one with position and normal, and the other with a packed color\n        Model basic = modelBuilder.createBox(1, 1, 1, materialRed,\n                Usage.Position | Usage.Normal);\n        Model color = modelBuilder.createBox(1, 1, 1, materialRed,\n                Usage.Position | Usage.ColorPacked | Usage.Normal);\n\n        //If any of these lines are removed it will be sorted correctly.\n        final Array<ModelInstance> instances = new Array<ModelInstance>();\n        instances.add(new ModelInstance(basic));\n        instances.add(new ModelInstance(basic));\n        instances.add(new ModelInstance(basic));\n        instances.add(new ModelInstance(basic));\n        instances.add(new ModelInstance(color));\n        instances.add(new ModelInstance(basic));\n        instances.add(new ModelInstance(color));\n        instances.add(new ModelInstance(basic));\n        instances.add(new ModelInstance(basic));\n        instances.add(new ModelInstance(basic));\n        instances.add(new ModelInstance(basic));\n        instances.add(new ModelInstance(basic));\n        instances.add(new ModelInstance(color));\n        instances.add(new ModelInstance(basic));\n        instances.add(new ModelInstance(color));\n        instances.add(new ModelInstance(basic));\n        instances.add(new ModelInstance(basic));\n        instances.add(new ModelInstance(basic));\n        instances.add(new ModelInstance(basic));\n        instances.add(new ModelInstance(basic));\n        instances.add(new ModelInstance(color));\n        instances.add(new ModelInstance(basic));\n        instances.add(new ModelInstance(color));\n        instances.add(new ModelInstance(basic));\n        instances.add(new ModelInstance(basic));\n        instances.add(new ModelInstance(basic));\n        instances.add(new ModelInstance(basic));\n        instances.add(new ModelInstance(basic));\n        instances.add(new ModelInstance(color));\n        instances.add(new ModelInstance(basic));\n        instances.add(new ModelInstance(color));\n        instances.add(new ModelInstance(basic));\n\n        final Array<Renderable> renderables = getRenderables(instances);\n\n        // Sort masks and print masks (incorrect results)\n        renderables.sort(comparator);\n\n        StringBuilder builder = new StringBuilder();\n        for (int i = 0; i < renderables.size; i++) {\n            builder.append(renderables.get(i).meshPart.mesh.getVertexAttributes().getMask()).append(\", \");\n        }\n\n        Gdx.app.log(\"Failed Sort\", builder.toString());\n    }\n\n    private final Pool<Renderable> fakeRenderablesPool = new Pool<Renderable>() {\n        @Override\n        protected Renderable newObject() {\n            return new Renderable();\n        }\n    };\n\n    private Array<Renderable> getRenderables(Array<ModelInstance> instances) {\n        Array<Renderable> renderables = new Array<Renderable>();\n\n        for (ModelInstance instance : instances) {\n            instance.getRenderables(renderables, fakeRenderablesPool);\n        }\n        return renderables;\n    }\n\n    @Override\n    public void render() {\n    }\n}\n```\n","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/libgdx/libgdx/issues/comments/238083025/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"Bolt-Head","id":19981350,"node_id":"MDQ6VXNlcjE5OTgxMzUw","avatar_url":"https://avatars.githubusercontent.com/u/19981350?v=4","gravatar_id":"","url":"https://api.github.com/users/Bolt-Head","html_url":"https://github.com/Bolt-Head","followers_url":"https://api.github.com/users/Bolt-Head/followers","following_url":"https://api.github.com/users/Bolt-Head/following{/other_user}","gists_url":"https://api.github.com/users/Bolt-Head/gists{/gist_id}","starred_url":"https://api.github.com/users/Bolt-Head/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Bolt-Head/subscriptions","organizations_url":"https://api.github.com/users/Bolt-Head/orgs","repos_url":"https://api.github.com/users/Bolt-Head/repos","events_url":"https://api.github.com/users/Bolt-Head/events{/privacy}","received_events_url":"https://api.github.com/users/Bolt-Head/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":747751032,"node_id":"MDExOkNsb3NlZEV2ZW50NzQ3NzUxMDMy","url":"https://api.github.com/repos/libgdx/libgdx/issues/events/747751032","actor":{"login":"xoppa","id":2349087,"node_id":"MDQ6VXNlcjIzNDkwODc=","avatar_url":"https://avatars.githubusercontent.com/u/2349087?v=4","gravatar_id":"","url":"https://api.github.com/users/xoppa","html_url":"https://github.com/xoppa","followers_url":"https://api.github.com/users/xoppa/followers","following_url":"https://api.github.com/users/xoppa/following{/other_user}","gists_url":"https://api.github.com/users/xoppa/gists{/gist_id}","starred_url":"https://api.github.com/users/xoppa/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/xoppa/subscriptions","organizations_url":"https://api.github.com/users/xoppa/orgs","repos_url":"https://api.github.com/users/xoppa/repos","events_url":"https://api.github.com/users/xoppa/events{/privacy}","received_events_url":"https://api.github.com/users/xoppa/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"closed","commit_id":"47113f25e76829c7092940ceb1c6065d4668ca7d","commit_url":"https://api.github.com/repos/libgdx/libgdx/commits/47113f25e76829c7092940ceb1c6065d4668ca7d","created_at":"2016-08-07T19:19:35Z","state_reason":null,"performed_via_github_app":null},{"url":"https://api.github.com/repos/libgdx/libgdx/issues/comments/238102714","html_url":"https://github.com/libgdx/libgdx/issues/4186#issuecomment-238102714","issue_url":"https://api.github.com/repos/libgdx/libgdx/issues/4186","id":238102714,"node_id":"MDEyOklzc3VlQ29tbWVudDIzODEwMjcxNA==","user":{"login":"xoppa","id":2349087,"node_id":"MDQ6VXNlcjIzNDkwODc=","avatar_url":"https://avatars.githubusercontent.com/u/2349087?v=4","gravatar_id":"","url":"https://api.github.com/users/xoppa","html_url":"https://github.com/xoppa","followers_url":"https://api.github.com/users/xoppa/followers","following_url":"https://api.github.com/users/xoppa/following{/other_user}","gists_url":"https://api.github.com/users/xoppa/gists{/gist_id}","starred_url":"https://api.github.com/users/xoppa/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/xoppa/subscriptions","organizations_url":"https://api.github.com/users/xoppa/orgs","repos_url":"https://api.github.com/users/xoppa/repos","events_url":"https://api.github.com/users/xoppa/events{/privacy}","received_events_url":"https://api.github.com/users/xoppa/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2016-08-07T19:24:05Z","updated_at":"2016-08-07T19:24:05Z","body":"Thanks. Turns out that this is caused by a nested sort. Material uses lazy sort which is invoked in the compareTo function when it hasnt been sorted before and some other criteria. This causes the `Sort` singleton to be reused, which breaks the current active sort operation.\n\nAs quick fix, I've added a sort whenever an attribute is added or removed. This adds some overhead, but should be good enough.\n","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/libgdx/libgdx/issues/comments/238102714/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"xoppa","id":2349087,"node_id":"MDQ6VXNlcjIzNDkwODc=","avatar_url":"https://avatars.githubusercontent.com/u/2349087?v=4","gravatar_id":"","url":"https://api.github.com/users/xoppa","html_url":"https://github.com/xoppa","followers_url":"https://api.github.com/users/xoppa/followers","following_url":"https://api.github.com/users/xoppa/following{/other_user}","gists_url":"https://api.github.com/users/xoppa/gists{/gist_id}","starred_url":"https://api.github.com/users/xoppa/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/xoppa/subscriptions","organizations_url":"https://api.github.com/users/xoppa/orgs","repos_url":"https://api.github.com/users/xoppa/repos","events_url":"https://api.github.com/users/xoppa/events{/privacy}","received_events_url":"https://api.github.com/users/xoppa/received_events","type":"User","user_view_type":"public","site_admin":false}}]