diff --git a/src/Psalm/Internal/Visitor/ReflectorVisitor.php b/src/Psalm/Internal/Visitor/ReflectorVisitor.php
index 13ed460aa..6cb020f6c 100644
--- a/src/Psalm/Internal/Visitor/ReflectorVisitor.php
+++ b/src/Psalm/Internal/Visitor/ReflectorVisitor.php
@@ -1966,115 +1966,6 @@ class ReflectorVisitor extends PhpParser\NodeVisitorAbstract implements PhpParse
             }
         }
 
-        if ($docblock_info->return_type) {
-            $storage->has_template_return_type =
-                $template_types !== null &&
-                count(
-                    array_intersect(
-                        Type::tokenize($docblock_info->return_type),
-                        array_keys($template_types)
-                    )
-                ) > 0;
-
-            $docblock_return_type = $docblock_info->return_type;
-
-            if (!$fake_method
-                && $docblock_info->return_type_line_number
-                && $docblock_info->return_type_start
-                && $docblock_info->return_type_end
-            ) {
-                $storage->return_type_location = new CodeLocation\DocblockTypeLocation(
-                    $this->file_scanner,
-                    $docblock_info->return_type_start,
-                    $docblock_info->return_type_end,
-                    $docblock_info->return_type_line_number
-                );
-            } else {
-                $storage->return_type_location = new CodeLocation(
-                    $this->file_scanner,
-                    $stmt,
-                    null,
-                    false,
-                    !$fake_method
-                        ? CodeLocation::FUNCTION_PHPDOC_RETURN_TYPE
-                        : CodeLocation::FUNCTION_PHPDOC_METHOD,
-                    $docblock_info->return_type
-                );
-            }
-
-            if ($docblock_return_type) {
-                try {
-                    $fixed_type_tokens = Type::fixUpLocalType(
-                        $docblock_return_type,
-                        $this->aliases,
-                        $this->function_template_types + $this->class_template_types,
-                        $this->type_aliases
-                    );
-
-                    $storage->return_type = Type::parseTokens(
-                        $fixed_type_tokens,
-                        null,
-                        $this->function_template_types + $this->class_template_types
-                    );
-
-                    $storage->return_type->setFromDocblock();
-
-                    if ($storage->signature_return_type) {
-                        $all_typehint_types_match = true;
-                        $signature_return_atomic_types = $storage->signature_return_type->getTypes();
-
-                        foreach ($storage->return_type->getTypes() as $key => $type) {
-                            if (isset($signature_return_atomic_types[$key])) {
-                                $type->from_docblock = false;
-                            } else {
-                                $all_typehint_types_match = false;
-                            }
-                        }
-
-                        if ($all_typehint_types_match) {
-                            $storage->return_type->from_docblock = false;
-                        }
-
-                        if ($storage->signature_return_type->isNullable()
-                            && !$storage->return_type->isNullable()
-                        ) {
-                            $storage->return_type->addType(new Type\Atomic\TNull());
-                        }
-                    }
-
-                    $storage->return_type->queueClassLikesForScanning($this->codebase, $this->file_storage);
-                } catch (TypeParseTreeException $e) {
-                    if (IssueBuffer::accepts(
-                        new InvalidDocblock(
-                            $e->getMessage() . ' in docblock for ' . $cased_function_id,
-                            new CodeLocation($this->file_scanner, $stmt, null, true)
-                        )
-                    )) {
-                    }
-
-                    $storage->has_docblock_issues = true;
-                }
-            }
-
-            if ($storage->return_type && $docblock_info->ignore_nullable_return) {
-                $storage->return_type->ignore_nullable_issues = true;
-            }
-
-            if ($storage->return_type && $docblock_info->ignore_falsable_return) {
-                $storage->return_type->ignore_falsable_issues = true;
-            }
-
-            if ($stmt->returnsByRef() && $storage->return_type) {
-                $storage->return_type->by_ref = true;
-            }
-
-            if ($docblock_info->return_type_line_number && !$fake_method) {
-                $storage->return_type_location->setCommentLine($docblock_info->return_type_line_number);
-            }
-
-            $storage->return_type_description = $docblock_info->return_type_description;
-        }
-
         foreach ($docblock_info->globals as $global) {
             try {
                 $storage->global_types[$global['name']] = Type::parseTokens(
@@ -2120,7 +2011,6 @@ class ReflectorVisitor extends PhpParser\NodeVisitorAbstract implements PhpParse
             );
         }
 
-
         foreach ($docblock_info->params_out as $docblock_param_out) {
             $param_name = substr($docblock_param_out['name'], 1);
 
@@ -2195,6 +2085,115 @@ class ReflectorVisitor extends PhpParser\NodeVisitorAbstract implements PhpParse
             }
         }
 
+        if ($docblock_info->return_type) {
+            $storage->has_template_return_type =
+                $template_types !== null &&
+                count(
+                    array_intersect(
+                        Type::tokenize($docblock_info->return_type),
+                        array_keys($template_types)
+                    )
+                ) > 0;
+
+            $docblock_return_type = $docblock_info->return_type;
+
+            if (!$fake_method
+                && $docblock_info->return_type_line_number
+                && $docblock_info->return_type_start
+                && $docblock_info->return_type_end
+            ) {
+                $storage->return_type_location = new CodeLocation\DocblockTypeLocation(
+                    $this->file_scanner,
+                    $docblock_info->return_type_start,
+                    $docblock_info->return_type_end,
+                    $docblock_info->return_type_line_number
+                );
+            } else {
+                $storage->return_type_location = new CodeLocation(
+                    $this->file_scanner,
+                    $stmt,
+                    null,
+                    false,
+                    !$fake_method
+                        ? CodeLocation::FUNCTION_PHPDOC_RETURN_TYPE
+                        : CodeLocation::FUNCTION_PHPDOC_METHOD,
+                    $docblock_info->return_type
+                );
+            }
+
+            if ($docblock_return_type) {
+                try {
+                    $fixed_type_tokens = Type::fixUpLocalType(
+                        $docblock_return_type,
+                        $this->aliases,
+                        $this->function_template_types + $this->class_template_types,
+                        $this->type_aliases
+                    );
+
+                    $storage->return_type = Type::parseTokens(
+                        $fixed_type_tokens,
+                        null,
+                        $this->function_template_types + $this->class_template_types
+                    );
+
+                    $storage->return_type->setFromDocblock();
+
+                    if ($storage->signature_return_type) {
+                        $all_typehint_types_match = true;
+                        $signature_return_atomic_types = $storage->signature_return_type->getTypes();
+
+                        foreach ($storage->return_type->getTypes() as $key => $type) {
+                            if (isset($signature_return_atomic_types[$key])) {
+                                $type->from_docblock = false;
+                            } else {
+                                $all_typehint_types_match = false;
+                            }
+                        }
+
+                        if ($all_typehint_types_match) {
+                            $storage->return_type->from_docblock = false;
+                        }
+
+                        if ($storage->signature_return_type->isNullable()
+                            && !$storage->return_type->isNullable()
+                        ) {
+                            $storage->return_type->addType(new Type\Atomic\TNull());
+                        }
+                    }
+
+                    $storage->return_type->queueClassLikesForScanning($this->codebase, $this->file_storage);
+                } catch (TypeParseTreeException $e) {
+                    if (IssueBuffer::accepts(
+                        new InvalidDocblock(
+                            $e->getMessage() . ' in docblock for ' . $cased_function_id,
+                            new CodeLocation($this->file_scanner, $stmt, null, true)
+                        )
+                    )) {
+                    }
+
+                    $storage->has_docblock_issues = true;
+                }
+            }
+
+            if ($storage->return_type && $docblock_info->ignore_nullable_return) {
+                $storage->return_type->ignore_nullable_issues = true;
+            }
+
+            if ($storage->return_type && $docblock_info->ignore_falsable_return) {
+                $storage->return_type->ignore_falsable_issues = true;
+            }
+
+            if ($stmt->returnsByRef() && $storage->return_type) {
+                $storage->return_type->by_ref = true;
+            }
+
+            if ($docblock_info->return_type_line_number && !$fake_method) {
+                $storage->return_type_location->setCommentLine($docblock_info->return_type_line_number);
+            }
+
+            $storage->return_type_description = $docblock_info->return_type_description;
+        }
+
         return $storage;
     }
 
@@ -2418,6 +2417,20 @@ class ReflectorVisitor extends PhpParser\NodeVisitorAbstract implements PhpParse
                 $storage->template_types ?: []
             );
 
+            if ($storage->template_types) {
+                foreach ($storage->template_types as $t => $type_map) {
+                    foreach ($type_map as $obj => [$type]) {
+                        if ($type->isMixed() && $docblock_param['type'] === 'class-string<' . $t . '>') {
+                            $storage->template_types[$t][$obj] = [Type::getObject()];
+
+                            if (isset($this->function_template_types[$t])) {
+                                $this->function_template_types[$t][$obj] = $storage->template_types[$t][$obj];
+                            }
+                        }
+                    }
+                }
+            }
+
             if (!$docblock_param_variadic && $storage_param->is_variadic && $new_param_type->hasArray()) {
                 /** @var Type\Atomic\TArray|Type\Atomic\ObjectLike */
                 $array_type = $new_param_type->getTypes()['array'];
diff --git a/tests/Template/TemplateTest.php b/tests/Template/TemplateTest.php
index d2b8e7197..edc4b7900 100644
--- a/tests/Template/TemplateTest.php
+++ b/tests/Template/TemplateTest.php
@@ -3341,6 +3341,21 @@ class TemplateTest extends TestCase
                     $mario->ame = "Luigi";',
                 'error_message' => 'InvalidArgument - src' . DIRECTORY_SEPARATOR . 'somefile.php:47:29 - Argument 1 of CharacterRow::__set expects string(id)|string(name)|string(height), string(ame) provided',
             ],
+            'constrainTemplateTypeWhenClassStringUsed' => [
+                '<?php
+                    class GenericObjectFactory {
+                       /**
+                        * @psalm-template T
+                        * @psalm-param class-string<T> $type
+                        * @psalm-return T
+                        */
+                        public function getObject(string $type)
+                        {
+                            return 3;
+                        }
+                    }',
+                'error_message' => 'InvalidReturnStatement'
+            ],
         ];
     }
 }
