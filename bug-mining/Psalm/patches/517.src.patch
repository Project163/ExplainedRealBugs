diff --git a/src/Psalm/Internal/Analyzer/Statements/ExpressionAnalyzer.php b/src/Psalm/Internal/Analyzer/Statements/ExpressionAnalyzer.php
index a164e4b9b..144be707c 100644
--- a/src/Psalm/Internal/Analyzer/Statements/ExpressionAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/Statements/ExpressionAnalyzer.php
@@ -1942,7 +1942,11 @@ class ExpressionAnalyzer
         $valid_strings = [];
         $castable_types = [];
 
-        foreach ($stmt_type->getAtomicTypes() as $atomic_type) {
+        $atomic_types = $stmt_type->getAtomicTypes();
+
+        while ($atomic_types) {
+            $atomic_type = array_pop($atomic_types);
+
             if ($atomic_type instanceof TString) {
                 $valid_strings[] = $atomic_type;
                 continue;
@@ -1993,6 +1997,12 @@ class ExpressionAnalyzer
                 continue;
             }
 
+            if ($atomic_type instanceof Type\Atomic\TTemplateParam) {
+                $atomic_types = array_merge($atomic_types, $atomic_type->as->getAtomicTypes());
+
+                continue;
+            }
+
             $invalid_casts[] = $atomic_type->getId();
         }
 
diff --git a/tests/Template/FunctionTemplateTest.php b/tests/Template/FunctionTemplateTest.php
index f2ed5ae38..13f23b915 100644
--- a/tests/Template/FunctionTemplateTest.php
+++ b/tests/Template/FunctionTemplateTest.php
@@ -959,6 +959,16 @@ class FunctionTemplateTest extends TestCase
                         echo $value;
                     }'
             ],
+            'allowTemplatedCast' => [
+                '<?php
+                    /**
+                     * @psalm-template Tk of array-key
+                     * @psalm-param Tk $key
+                     */
+                    function at($key) : void {
+                        echo (string) $key;
+                    }'
+            ],
         ];
     }
 
