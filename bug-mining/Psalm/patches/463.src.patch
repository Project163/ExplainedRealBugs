diff --git a/src/Psalm/Context.php b/src/Psalm/Context.php
index b8117a637..4385bc40f 100644
--- a/src/Psalm/Context.php
+++ b/src/Psalm/Context.php
@@ -266,11 +266,14 @@ class Context
     public $branch_point;
 
     /**
-     * If we're inside case statements we allow continue; statements as an alias of break;
+     * What does break mean in this context?
      *
-     * @var bool
+     * 'loop' means we're breaking out of a loop,
+     * 'switch' means we're breaking out of a switch
+     *
+     * @var list<'loop'|'switch'>
      */
-    public $inside_case = false;
+    public $break_types = [];
 
     /**
      * @var bool
diff --git a/src/Psalm/Internal/Analyzer/FunctionLike/ReturnTypeAnalyzer.php b/src/Psalm/Internal/Analyzer/FunctionLike/ReturnTypeAnalyzer.php
index 8e5b956f2..815b9b334 100644
--- a/src/Psalm/Internal/Analyzer/FunctionLike/ReturnTypeAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/FunctionLike/ReturnTypeAnalyzer.php
@@ -188,7 +188,7 @@ class ReturnTypeAnalyzer
                 $function_stmts,
                 $type_provider,
                 $codebase->config->exit_functions,
-                false,
+                [],
                 false
             ) !== [ScopeAnalyzer::ACTION_END]
         ) {
diff --git a/src/Psalm/Internal/Analyzer/ScopeAnalyzer.php b/src/Psalm/Internal/Analyzer/ScopeAnalyzer.php
index bfa2065dc..f3f4daa52 100644
--- a/src/Psalm/Internal/Analyzer/ScopeAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/ScopeAnalyzer.php
@@ -22,6 +22,15 @@ class ScopeAnalyzer
     const ACTION_NONE = 'NONE';
     const ACTION_RETURN = 'RETURN';
 
+    private const ACTIONS = [
+        self::ACTION_END,
+        self::ACTION_BREAK,
+        self::ACTION_CONTINUE,
+        self::ACTION_LEAVE_SWITCH,
+        self::ACTION_NONE,
+        self::ACTION_RETURN
+    ];
+
     /**
      * @param   array<PhpParser\Node\Stmt>   $stmts
      *
@@ -62,16 +71,16 @@ class ScopeAnalyzer
 
     /**
      * @param   array<PhpParser\Node> $stmts
-     * @param   bool $in_switch when checking inside a switch statement, continue is an alias of break
      * @param   bool $return_is_exit Exit and Throw statements are treated differently from return if this is false
+     * @param   list<'loop'|'switch'> $break_types
      *
-     * @return  string[] one or more of 'LEAVE', 'CONTINUE', 'BREAK' (or empty if no single action is found)
+     * @return  list<value-of<self::ACTIONS>>
      */
     public static function getFinalControlActions(
         array $stmts,
         ?\Psalm\Internal\Provider\NodeDataProvider $nodes,
         array $exit_functions,
-        $in_switch = false,
+        array $break_types = [],
         $return_is_exit = true
     ) {
         if (empty($stmts)) {
@@ -146,7 +155,8 @@ class ScopeAnalyzer
             }
 
             if ($stmt instanceof PhpParser\Node\Stmt\Continue_) {
-                if ($in_switch
+                if ($break_types
+                    && end($break_types) === 'switch'
                     && (!$stmt->num || !$stmt->num instanceof PhpParser\Node\Scalar\LNumber || $stmt->num->value < 2)
                 ) {
                     return [self::ACTION_LEAVE_SWITCH];
@@ -156,7 +166,8 @@ class ScopeAnalyzer
             }
 
             if ($stmt instanceof PhpParser\Node\Stmt\Break_) {
-                if ($in_switch
+                if ($break_types
+                    && end($break_types) === 'switch'
                     && (!$stmt->num || !$stmt->num instanceof PhpParser\Node\Scalar\LNumber || $stmt->num->value < 2)
                 ) {
                     return [self::ACTION_LEAVE_SWITCH];
@@ -166,9 +177,15 @@ class ScopeAnalyzer
             }
 
             if ($stmt instanceof PhpParser\Node\Stmt\If_) {
-                $if_statement_actions = self::getFinalControlActions($stmt->stmts, $nodes, $exit_functions, $in_switch);
+                $if_statement_actions = self::getFinalControlActions(
+                    $stmt->stmts,
+                    $nodes,
+                    $exit_functions,
+                    $break_types
+                );
+
                 $else_statement_actions = $stmt->else
-                    ? self::getFinalControlActions($stmt->else->stmts, $nodes, $exit_functions, $in_switch)
+                    ? self::getFinalControlActions($stmt->else->stmts, $nodes, $exit_functions, $break_types)
                     : [];
 
                 $all_same = count($if_statement_actions) === 1
@@ -183,7 +200,7 @@ class ScopeAnalyzer
                             $elseif->stmts,
                             $nodes,
                             $exit_functions,
-                            $in_switch
+                            $break_types
                         );
 
                         $all_same = $all_same && $elseif_control_actions == $if_statement_actions;
@@ -215,7 +232,7 @@ class ScopeAnalyzer
                 for ($d = count($stmt->cases) - 1; $d >= 0; --$d) {
                     $case = $stmt->cases[$d];
 
-                    $case_actions = self::getFinalControlActions($case->stmts, $nodes, $exit_functions, true);
+                    $case_actions = self::getFinalControlActions($case->stmts, $nodes, $exit_functions, ['switch']);
 
                     if (array_intersect([
                         self::ACTION_LEAVE_SWITCH,
@@ -252,8 +269,15 @@ class ScopeAnalyzer
 
             if ($stmt instanceof PhpParser\Node\Stmt\Do_
                 || $stmt instanceof PhpParser\Node\Stmt\While_
+                || $stmt instanceof PhpParser\Node\Stmt\Foreach_
+                || $stmt instanceof PhpParser\Node\Stmt\For_
             ) {
-                $do_actions = self::getFinalControlActions($stmt->stmts, $nodes, $exit_functions);
+                $do_actions = self::getFinalControlActions(
+                    $stmt->stmts,
+                    $nodes,
+                    $exit_functions,
+                    array_merge($break_types, ['loop'])
+                );
 
                 $control_actions = array_merge($control_actions, $do_actions);
             }
@@ -263,7 +287,7 @@ class ScopeAnalyzer
                     $stmt->stmts,
                     $nodes,
                     $exit_functions,
-                    $in_switch
+                    $break_types
                 );
 
                 if ($stmt->catches) {
@@ -274,7 +298,7 @@ class ScopeAnalyzer
                             $catch->stmts,
                             $nodes,
                             $exit_functions,
-                            $in_switch
+                            $break_types
                         );
 
                         $all_same = $all_same && $try_statement_actions == $catch_actions;
@@ -295,7 +319,7 @@ class ScopeAnalyzer
                             $stmt->finally->stmts,
                             $nodes,
                             $exit_functions,
-                            $in_switch
+                            $break_types
                         );
 
                         if (!in_array(self::ACTION_NONE, $finally_statement_actions, true)) {
@@ -308,13 +332,13 @@ class ScopeAnalyzer
                     }
                 }
 
-                $control_actions = array_merge($control_actions, $try_statement_actions);
+                $control_actions = \array_merge($control_actions, $try_statement_actions);
             }
         }
 
         $control_actions[] = self::ACTION_NONE;
 
-        return array_unique($control_actions);
+        return array_values(array_unique($control_actions));
     }
 
     /**
diff --git a/src/Psalm/Internal/Analyzer/Statements/Block/DoAnalyzer.php b/src/Psalm/Internal/Analyzer/Statements/Block/DoAnalyzer.php
index 87867c9d2..9902a6b61 100644
--- a/src/Psalm/Internal/Analyzer/Statements/Block/DoAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/Statements/Block/DoAnalyzer.php
@@ -32,8 +32,7 @@ class DoAnalyzer
         Context $context
     ) {
         $do_context = clone $context;
-
-        $do_context->inside_case = false;
+        $do_context->break_types[] = 'loop';
 
         $codebase = $statements_analyzer->getCodebase();
 
diff --git a/src/Psalm/Internal/Analyzer/Statements/Block/ForAnalyzer.php b/src/Psalm/Internal/Analyzer/Statements/Block/ForAnalyzer.php
index 903479f14..7eada12cc 100644
--- a/src/Psalm/Internal/Analyzer/Statements/Block/ForAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/Statements/Block/ForAnalyzer.php
@@ -66,7 +66,7 @@ class ForAnalyzer
         $for_context = clone $context;
 
         $for_context->inside_loop = true;
-        $for_context->inside_case = false;
+        $for_context->break_types[] = 'loop';
 
         $codebase = $statements_analyzer->getCodebase();
 
diff --git a/src/Psalm/Internal/Analyzer/Statements/Block/ForeachAnalyzer.php b/src/Psalm/Internal/Analyzer/Statements/Block/ForeachAnalyzer.php
index 0d502a041..e75ccfc57 100644
--- a/src/Psalm/Internal/Analyzer/Statements/Block/ForeachAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/Statements/Block/ForeachAnalyzer.php
@@ -226,7 +226,7 @@ class ForeachAnalyzer
         }
 
         $foreach_context->inside_loop = true;
-        $foreach_context->inside_case = false;
+        $foreach_context->break_types[] = 'loop';
 
         if ($codebase->alter_code) {
             $foreach_context->branch_point =
diff --git a/src/Psalm/Internal/Analyzer/Statements/Block/IfAnalyzer.php b/src/Psalm/Internal/Analyzer/Statements/Block/IfAnalyzer.php
index f2b63ae11..98d5ed3e9 100644
--- a/src/Psalm/Internal/Analyzer/Statements/Block/IfAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/Statements/Block/IfAnalyzer.php
@@ -746,7 +746,7 @@ class IfAnalyzer
             $stmt->stmts,
             $statements_analyzer->node_data,
             $codebase->config->exit_functions,
-            $outer_context->inside_case
+            $outer_context->break_types
         );
 
         $has_ending_statements = $final_actions === [ScopeAnalyzer::ACTION_END];
@@ -1254,7 +1254,7 @@ class IfAnalyzer
             $elseif->stmts,
             $statements_analyzer->node_data,
             $codebase->config->exit_functions,
-            $outer_context->inside_case
+            $outer_context->break_types
         );
         // has a return/throw at end
         $has_ending_statements = $final_actions === [ScopeAnalyzer::ACTION_END];
@@ -1605,7 +1605,7 @@ class IfAnalyzer
                 $else->stmts,
                 $statements_analyzer->node_data,
                 $codebase->config->exit_functions,
-                $outer_context->inside_case
+                $outer_context->break_types
             )
             : [ScopeAnalyzer::ACTION_NONE];
         // has a return/throw at end
diff --git a/src/Psalm/Internal/Analyzer/Statements/Block/LoopAnalyzer.php b/src/Psalm/Internal/Analyzer/Statements/Block/LoopAnalyzer.php
index 7b887156d..20e0ef5aa 100644
--- a/src/Psalm/Internal/Analyzer/Statements/Block/LoopAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/Statements/Block/LoopAnalyzer.php
@@ -88,7 +88,8 @@ class LoopAnalyzer
         $final_actions = ScopeAnalyzer::getFinalControlActions(
             $stmts,
             $statements_analyzer->node_data,
-            Config::getInstance()->exit_functions
+            Config::getInstance()->exit_functions,
+            $loop_scope->loop_context->break_types
         );
 
         $does_always_break = $final_actions === [ScopeAnalyzer::ACTION_BREAK];
diff --git a/src/Psalm/Internal/Analyzer/Statements/Block/SwitchAnalyzer.php b/src/Psalm/Internal/Analyzer/Statements/Block/SwitchAnalyzer.php
index da9589005..419721b5b 100644
--- a/src/Psalm/Internal/Analyzer/Statements/Block/SwitchAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/Statements/Block/SwitchAnalyzer.php
@@ -77,7 +77,7 @@ class SwitchAnalyzer
                 $case->stmts,
                 $statements_analyzer->node_data,
                 $config->exit_functions,
-                true
+                ['switch']
             );
 
             if (!in_array(ScopeAnalyzer::ACTION_NONE, $case_actions, true)) {
@@ -428,7 +428,7 @@ class SwitchAnalyzer
             );
         }
 
-        $case_context->inside_case = true;
+        $case_context->break_types[] = 'switch';
 
         $switch_scope->leftover_statements = [];
         $switch_scope->leftover_case_equality_expr = null;
diff --git a/src/Psalm/Internal/Analyzer/Statements/Block/TryAnalyzer.php b/src/Psalm/Internal/Analyzer/Statements/Block/TryAnalyzer.php
index da53df23c..034164b17 100644
--- a/src/Psalm/Internal/Analyzer/Statements/Block/TryAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/Statements/Block/TryAnalyzer.php
@@ -90,7 +90,7 @@ class TryAnalyzer
             $stmt->stmts,
             $statements_analyzer->node_data,
             $codebase->config->exit_functions,
-            $context->inside_case
+            $context->break_types
         );
 
         /** @var array<string, bool> */
@@ -355,7 +355,7 @@ class TryAnalyzer
                 $catch->stmts,
                 $statements_analyzer->node_data,
                 $codebase->config->exit_functions,
-                $context->inside_case
+                $context->break_types
             );
 
             foreach ($issues_to_suppress as $issue_to_suppress) {
diff --git a/src/Psalm/Internal/Analyzer/Statements/Block/WhileAnalyzer.php b/src/Psalm/Internal/Analyzer/Statements/Block/WhileAnalyzer.php
index 4d3c76945..96e3a21dc 100644
--- a/src/Psalm/Internal/Analyzer/Statements/Block/WhileAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/Statements/Block/WhileAnalyzer.php
@@ -40,7 +40,7 @@ class WhileAnalyzer
         $while_context = clone $context;
 
         $while_context->inside_loop = true;
-        $while_context->inside_case = false;
+        $while_context->break_types[] = 'loop';
 
         $codebase = $statements_analyzer->getCodebase();
 
diff --git a/src/Psalm/Internal/Analyzer/StatementsAnalyzer.php b/src/Psalm/Internal/Analyzer/StatementsAnalyzer.php
index 1b8af4801..f7b9ce80e 100644
--- a/src/Psalm/Internal/Analyzer/StatementsAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/StatementsAnalyzer.php
@@ -391,10 +391,21 @@ class StatementsAnalyzer extends SourceAnalyzer implements StatementsSource
                 SwitchAnalyzer::analyze($this, $stmt, $context);
             } elseif ($stmt instanceof PhpParser\Node\Stmt\Break_) {
                 $loop_scope = $context->loop_scope;
+
+                $leaving_switch = true;
+
                 if ($loop_scope && $original_context) {
-                    if ($context->inside_case && !$stmt->num) {
+                    if ($context->break_types
+                        && \end($context->break_types) === 'switch'
+                        && (!$stmt->num
+                            || !$stmt->num instanceof PhpParser\Node\Scalar\LNumber
+                            || $stmt->num->value < 2
+                        )
+                    ) {
                         $loop_scope->final_actions[] = ScopeAnalyzer::ACTION_LEAVE_SWITCH;
                     } else {
+                        $leaving_switch = false;
+
                         $loop_scope->final_actions[] = ScopeAnalyzer::ACTION_BREAK;
                     }
 
@@ -432,7 +443,7 @@ class StatementsAnalyzer extends SourceAnalyzer implements StatementsSource
                         }
                     }
 
-                    if ($context->collect_references && (!$context->case_scope || $stmt->num)) {
+                    if ($context->collect_references && !$leaving_switch) {
                         foreach ($context->unreferenced_vars as $var_id => $locations) {
                             if (isset($loop_scope->unreferenced_vars[$var_id])) {
                                 $loop_scope->unreferenced_vars[$var_id] += $locations;
@@ -446,7 +457,7 @@ class StatementsAnalyzer extends SourceAnalyzer implements StatementsSource
                 }
 
                 $case_scope = $context->case_scope;
-                if ($case_scope) {
+                if ($case_scope && $leaving_switch) {
                     foreach ($context->vars_in_scope as $var_id => $type) {
                         if ($case_scope->parent_context !== $context) {
                             if ($case_scope->break_vars === null) {
@@ -477,8 +488,11 @@ class StatementsAnalyzer extends SourceAnalyzer implements StatementsSource
                 $has_returned = true;
             } elseif ($stmt instanceof PhpParser\Node\Stmt\Continue_) {
                 $loop_scope = $context->loop_scope;
+
+                $leaving_switch = true;
+
                 if ($loop_scope === null) {
-                    if (!$context->inside_case) {
+                    if (!$context->break_types) {
                         if (IssueBuffer::accepts(
                             new ContinueOutsideLoop(
                                 'Continue call outside loop context',
@@ -490,9 +504,16 @@ class StatementsAnalyzer extends SourceAnalyzer implements StatementsSource
                         }
                     }
                 } elseif ($original_context) {
-                    if ($context->inside_case && !$stmt->num) {
+                    if ($context->break_types
+                        && \end($context->break_types) === 'switch'
+                        && (!$stmt->num
+                            || !$stmt->num instanceof PhpParser\Node\Scalar\LNumber
+                            || $stmt->num->value < 2
+                        )
+                    ) {
                         $loop_scope->final_actions[] = ScopeAnalyzer::ACTION_LEAVE_SWITCH;
                     } else {
+                        $leaving_switch = false;
                         $loop_scope->final_actions[] = ScopeAnalyzer::ACTION_CONTINUE;
                     }
 
@@ -546,7 +567,7 @@ class StatementsAnalyzer extends SourceAnalyzer implements StatementsSource
                 }
 
                 $case_scope = $context->case_scope;
-                if ($case_scope && $context->collect_references) {
+                if ($case_scope && $context->collect_references && $leaving_switch) {
                     foreach ($context->unreferenced_vars as $var_id => $locations) {
                         if (isset($case_scope->unreferenced_vars[$var_id])) {
                             $case_scope->unreferenced_vars[$var_id] += $locations;
diff --git a/src/Psalm/Internal/Visitor/ReflectorVisitor.php b/src/Psalm/Internal/Visitor/ReflectorVisitor.php
index 25922913d..342bdc758 100644
--- a/src/Psalm/Internal/Visitor/ReflectorVisitor.php
+++ b/src/Psalm/Internal/Visitor/ReflectorVisitor.php
@@ -1919,7 +1919,7 @@ class ReflectorVisitor extends PhpParser\NodeVisitorAbstract implements PhpParse
                             $function_stmt->stmts,
                             null,
                             $this->config->exit_functions,
-                            false,
+                            [],
                             false
                         );
 
diff --git a/tests/UnusedVariableTest.php b/tests/UnusedVariableTest.php
index 4ecc7d32a..38a415815 100644
--- a/tests/UnusedVariableTest.php
+++ b/tests/UnusedVariableTest.php
@@ -1392,6 +1392,22 @@ class UnusedVariableTest extends TestCase
 
                     echo $a;'
             ],
+            'breakInForeachInsideSwitch' => [
+                '<?php
+                    function foo(string $b) : void {
+                        switch ($b){
+                            case "foo":
+                                $a = null;
+                                foreach ([1,2,3] as $f){
+                                    if ($f == 2) {
+                                        $a = $f;
+                                        break;
+                                    }
+                                }
+                                echo $a;
+                        }
+                    }'
+            ],
         ];
     }
 
