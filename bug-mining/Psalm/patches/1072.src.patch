diff --git a/src/Psalm/Internal/Analyzer/FunctionLikeAnalyzer.php b/src/Psalm/Internal/Analyzer/FunctionLikeAnalyzer.php
index 61abcce16..ba8269dc4 100644
--- a/src/Psalm/Internal/Analyzer/FunctionLikeAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/FunctionLikeAnalyzer.php
@@ -970,7 +970,8 @@ abstract class FunctionLikeAnalyzer extends SourceAnalyzer
                         false,
                         false,
                         $this->function instanceof ClassMethod
-                            && strtolower($this->function->name->name) !== '__construct'
+                            && strtolower($this->function->name->name) !== '__construct',
+                        $context->calling_method_id
                     ) === false) {
                         $check_stmts = false;
                     }
diff --git a/tests/FileUpdates/TemporaryUpdateTest.php b/tests/FileUpdates/TemporaryUpdateTest.php
index 599e53bf4..e28869366 100644
--- a/tests/FileUpdates/TemporaryUpdateTest.php
+++ b/tests/FileUpdates/TemporaryUpdateTest.php
@@ -862,6 +862,178 @@ class TemporaryUpdateTest extends \Psalm\Tests\TestCase
                 ],
                 'error_positions' => [[196], []],
             ],
+            'changeUseShouldInvalidateBadReturn' => [
+                [
+                    [
+                        getcwd() . DIRECTORY_SEPARATOR . 'A.php' => '<?php
+                            namespace Foo {
+                                use Baz\B;
+
+                                class A {
+                                    public function foo() : ?B {
+                                        return null;
+                                    }
+                                }
+                            }
+
+                            namespace Bar {
+                                class B {}
+                            }',
+                    ],
+                    [
+                        getcwd() . DIRECTORY_SEPARATOR . 'A.php' => '<?php
+                            namespace Foo {
+                                use Bar\B;
+
+                                class A {
+                                    public function foo() : ?B {
+                                        return null;
+                                    }
+                                }
+                            }
+
+                            namespace Bar {
+                                class B {}
+                            }',
+                    ],
+                ],
+                'error_positions' => [[196], []],
+            ],'changeUseShouldInvalidateBadDocblockReturn' => [
+                [
+                    [
+                        getcwd() . DIRECTORY_SEPARATOR . 'A.php' => '<?php
+                            namespace Foo {
+                                use Baz\B;
+
+                                class A {
+                                    /** @return ?B */
+                                    public function foo() {
+                                        return null;
+                                    }
+                                }
+                            }
+
+                            namespace Bar {
+                                class B {}
+                            }',
+                    ],
+                    [
+                        getcwd() . DIRECTORY_SEPARATOR . 'A.php' => '<?php
+                            namespace Foo {
+                                use Bar\B;
+
+                                class A {
+                                    /** @return ?B */
+                                    public function foo() {
+                                        return null;
+                                    }
+                                }
+                            }
+
+                            namespace Bar {
+                                class B {}
+                            }',
+                    ],
+                ],
+                'error_positions' => [[184], []],
+            ],
+            'changeUseShouldInvalidateBadParam' => [
+                [
+                    [
+                        getcwd() . DIRECTORY_SEPARATOR . 'A.php' => '<?php
+                            namespace Foo {
+                                use Baz\B;
+
+                                class A {
+                                    public function foo(B $b) : void {}
+                                }
+                            }
+
+                            namespace Bar {
+                                class B {}
+                            }',
+                    ],
+                    [
+                        getcwd() . DIRECTORY_SEPARATOR . 'A.php' => '<?php
+                            namespace Foo {
+                                use Bar\B;
+
+                                class A {
+                                    public function foo(B $b) : void {}
+                                }
+                            }
+
+                            namespace Bar {
+                                class B {}
+                            }',
+                    ],
+                ],
+                'error_positions' => [[192], []],
+            ],
+            'changeUseShouldInvalidateBadDocblockParam' => [
+                [
+                    [
+                        getcwd() . DIRECTORY_SEPARATOR . 'A.php' => '<?php
+                            namespace Foo {
+                                use Baz\B;
+
+                                class A {
+                                    /** @param B $b */
+                                    public function foo($b) : void {}
+                                }
+                            }
+
+                            namespace Bar {
+                                class B {}
+                            }',
+                    ],
+                    [
+                        getcwd() . DIRECTORY_SEPARATOR . 'A.php' => '<?php
+                            namespace Foo {
+                                use Bar\B;
+
+                                class A {
+                                    /** @param B $b */
+                                    public function foo($b) : void {}
+                                }
+                            }
+
+                            namespace Bar {
+                                class B {}
+                            }',
+                    ],
+                ],
+                'error_positions' => [[183], []],
+            ],
+            'changeUseShouldInvalidateBadParam' => [
+                [
+                    [
+                        getcwd() . DIRECTORY_SEPARATOR . 'A.php' => '<?php
+                            namespace Foo {
+                                use Baz\B;
+
+                                class A extends B {}
+                            }
+
+                            namespace Bar {
+                                class B {}
+                            }',
+                    ],
+                    [
+                        getcwd() . DIRECTORY_SEPARATOR . 'A.php' => '<?php
+                            namespace Foo {
+                                use Bar\B;
+
+                                class A extends B {}
+                            }
+
+                            namespace Bar {
+                                class B {}
+                            }',
+                    ],
+                ],
+                'error_positions' => [[142], []],
+            ],
             'fixMissingProperty' => [
                 [
                     [
diff --git a/tests/Template/FunctionTemplateTest.php b/tests/Template/FunctionTemplateTest.php
index f8c5436c1..10ab916a2 100644
--- a/tests/Template/FunctionTemplateTest.php
+++ b/tests/Template/FunctionTemplateTest.php
@@ -1511,14 +1511,24 @@ class FunctionTemplateTest extends TestCase
             'isArrayCheckOnTemplated' => [
                 '<?php
                     /**
-                     * @psalm-pure
                      * @template TIterable of iterable
                      */
-                    function toList(iterable $iterable): void
-                    {
+                    function toList(iterable $iterable): void {
                         if (is_array($iterable)) {}
                     }'
             ],
+            'transformNestedTemplateWherePossible' => [
+                '<?php
+                    /**
+                     * @template TValue
+                     * @template TArray of non-empty-array<TValue>
+                     * @param TArray $arr
+                     * @return TValue
+                     */
+                    function toList(array $arr): array {
+                        return reset($arr);
+                    }'
+            ],
         ];
     }
 
