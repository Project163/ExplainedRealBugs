diff --git a/src/Psalm/Internal/Codebase/Analyzer.php b/src/Psalm/Internal/Codebase/Analyzer.php
index e17a9955c..15be1c979 100644
--- a/src/Psalm/Internal/Codebase/Analyzer.php
+++ b/src/Psalm/Internal/Codebase/Analyzer.php
@@ -1233,11 +1233,12 @@ class Analyzer
      */
     public function updateFile($file_path, $dry_run)
     {
-        $new_return_type_manipulations = FunctionDocblockManipulator::getManipulationsForFile($file_path);
-
-        $other_manipulations = FileManipulationBuffer::getManipulationsForFile($file_path);
+        FileManipulationBuffer::add(
+            $file_path,
+            FunctionDocblockManipulator::getManipulationsForFile($file_path)
+        );
 
-        $file_manipulations = array_merge($new_return_type_manipulations, $other_manipulations);
+        $file_manipulations = FileManipulationBuffer::getManipulationsForFile($file_path);
 
         if (!$file_manipulations) {
             return;
@@ -1249,22 +1250,27 @@ class Analyzer
              * @return int
              */
             function (FileManipulation $a, FileManipulation $b) {
-                if ($a->start === $b->start) {
-                    if ($b->end === $a->end) {
+                if ($b->end === $a->end) {
+                    if ($a->start === $b->start) {
+
                         return $b->insertion_text > $a->insertion_text ? 1 : -1;
                     }
 
-                    return $b->end > $a->end ? 1 : -1;
+                    return $b->start > $a->start ? 1 : -1;
                 }
 
-                return $b->start > $a->start ? 1 : -1;
+                return $b->end > $a->end ? 1 : -1;
             }
         );
 
+        $last_start = \PHP_INT_MAX;
         $existing_contents = $this->file_provider->getContents($file_path);
 
         foreach ($file_manipulations as $manipulation) {
-            $existing_contents = $manipulation->transform($existing_contents);
+            if ($manipulation->start <= $last_start) {
+                $existing_contents = $manipulation->transform($existing_contents);
+                $last_start = $manipulation->start;
+            }
         }
 
         if ($dry_run) {
diff --git a/src/Psalm/Type/Reconciler.php b/src/Psalm/Type/Reconciler.php
index 5f2f4bd93..1f05e255d 100644
--- a/src/Psalm/Type/Reconciler.php
+++ b/src/Psalm/Type/Reconciler.php
@@ -125,6 +125,7 @@ class Reconciler
                         $new_base_key = $base_key . '[' . $array_key . ']';
 
                         if (strpos($array_key, '\'') !== false) {
+                            $new_types[$base_key][] = ['~array', '~ArrayAccess'];
                             $new_types[$base_key][] = ['!string'];
                             $new_types[$base_key][] = ['!=falsy'];
                         }
diff --git a/tests/FileManipulation/UnusedCodeManipulationTest.php b/tests/FileManipulation/UnusedCodeManipulationTest.php
index 94eb32d35..e1083aaab 100644
--- a/tests/FileManipulation/UnusedCodeManipulationTest.php
+++ b/tests/FileManipulation/UnusedCodeManipulationTest.php
@@ -348,6 +348,23 @@ class UnusedCodeManipulationTest extends FileManipulationTest
                 ['PossiblyUnusedMethod'],
                 true,
             ],
+            'removePossiblyUnusedMethodAndMissingReturnType' => [
+                '<?php
+                    class A {
+                        public function foo() {}
+                    }
+
+                    new A();',
+                '<?php
+                    class A {
+
+                    }
+
+                    new A();',
+                '7.1',
+                ['PossiblyUnusedMethod', 'MissingReturnType'],
+                true,
+            ],
             'removePossiblyUnusedPropertyWithDocblock' => [
                 '<?php
                     class A {
