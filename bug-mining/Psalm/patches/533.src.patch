diff --git a/src/Psalm/Internal/Analyzer/Statements/Expression/CallAnalyzer.php b/src/Psalm/Internal/Analyzer/Statements/Expression/CallAnalyzer.php
index 796214069..c4d3d015c 100644
--- a/src/Psalm/Internal/Analyzer/Statements/Expression/CallAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/Statements/Expression/CallAnalyzer.php
@@ -505,6 +505,8 @@ class CallAnalyzer
                         $codebase,
                         $statements_analyzer,
                         null,
+                        null,
+                        null,
                         'fn-' . $context->calling_function_id
                     );
 
@@ -599,6 +601,7 @@ class CallAnalyzer
                         $codebase,
                         $statements_analyzer,
                         $statements_analyzer->node_data->getType($arg->value),
+                        $argument_offset,
                         'fn-' . $context->calling_function_id
                     );
 
@@ -1317,6 +1320,7 @@ class CallAnalyzer
                         $codebase,
                         $statements_analyzer,
                         $arg_value_type,
+                        $argument_offset,
                         $context->self,
                         $context->calling_function_id,
                         false
@@ -1531,6 +1535,7 @@ class CallAnalyzer
                         $codebase,
                         $statements_analyzer,
                         clone $param->default_type,
+                        $i,
                         $context->self,
                         $context->calling_function_id,
                         true
@@ -1729,6 +1734,7 @@ class CallAnalyzer
                         $codebase,
                         $statements_analyzer,
                         $statements_analyzer->node_data->getType($arg->value),
+                        $argument_offset,
                         'fn-' . $context->calling_function_id
                     );
 
@@ -1750,6 +1756,7 @@ class CallAnalyzer
                         $codebase,
                         $statements_analyzer,
                         $statements_analyzer->node_data->getType($arg->value),
+                        $argument_offset,
                         'fn-' . $context->calling_function_id
                     );
 
@@ -1840,6 +1847,7 @@ class CallAnalyzer
                 $codebase,
                 $statements_analyzer,
                 $arg_value_type,
+                $argument_offset,
                 $context->self ?: 'fn-' . $context->calling_function_id
             );
 
@@ -1849,6 +1857,7 @@ class CallAnalyzer
                 $codebase,
                 $statements_analyzer,
                 $arg_value_type,
+                $argument_offset,
                 $context->self ?: 'fn-' . $context->calling_function_id
             );
         }
@@ -1894,6 +1903,7 @@ class CallAnalyzer
                 $codebase,
                 $statements_analyzer,
                 $arg_type_param,
+                $argument_offset,
                 $context->self,
                 $context->calling_function_id
             );
@@ -2464,6 +2474,7 @@ class CallAnalyzer
                     $codebase,
                     $statements_analyzer,
                     $input_type,
+                    $i,
                     $context->self,
                     $context->calling_function_id
                 );
diff --git a/src/Psalm/Internal/Provider/ReturnTypeProvider/ArrayMapReturnTypeProvider.php b/src/Psalm/Internal/Provider/ReturnTypeProvider/ArrayMapReturnTypeProvider.php
index 804285874..14a5a3359 100644
--- a/src/Psalm/Internal/Provider/ReturnTypeProvider/ArrayMapReturnTypeProvider.php
+++ b/src/Psalm/Internal/Provider/ReturnTypeProvider/ArrayMapReturnTypeProvider.php
@@ -282,6 +282,7 @@ class ArrayMapReturnTypeProvider implements \Psalm\Plugin\Hook\FunctionReturnTyp
                         $codebase,
                         $statements_source,
                         $array_arg_type->value,
+                        0,
                         $context->self,
                         $context->calling_function_id
                     );
diff --git a/src/Psalm/Internal/Type/TemplateResult.php b/src/Psalm/Internal/Type/TemplateResult.php
index 86c5458a4..e6384dd70 100644
--- a/src/Psalm/Internal/Type/TemplateResult.php
+++ b/src/Psalm/Internal/Type/TemplateResult.php
@@ -12,13 +12,13 @@ class TemplateResult
     public $template_types;
 
     /**
-     * @var array<string, array<string, array{0: Union, 1?: int}>>
+     * @var array<string, array<string, array{0: Union, 1?: int, 2?: ?int}>>
      */
     public $generic_params;
 
     /**
      * @param  array<string, array<string, array{0: Union}>> $template_types
-     * @param  array<string, array<string, array{0: Union, 1?: int}>> $generic_params
+     * @param  array<string, array<string, array{0: Union, 1?: int, 2?: ?int}>> $generic_params
      */
     public function __construct(array $template_types, array $generic_params)
     {
diff --git a/src/Psalm/Internal/Type/UnionTemplateHandler.php b/src/Psalm/Internal/Type/UnionTemplateHandler.php
index 5c1ccd50e..01fec9668 100644
--- a/src/Psalm/Internal/Type/UnionTemplateHandler.php
+++ b/src/Psalm/Internal/Type/UnionTemplateHandler.php
@@ -24,6 +24,7 @@ class UnionTemplateHandler
         ?Codebase $codebase,
         ?StatementsAnalyzer $statements_analyzer,
         ?Union $input_type,
+        ?int $input_arg_offset = null,
         ?string $calling_class = null,
         ?string $calling_function = null,
         bool $replace = true,
@@ -46,6 +47,7 @@ class UnionTemplateHandler
                     $codebase,
                     $statements_analyzer,
                     $input_type,
+                    $input_arg_offset,
                     $calling_class,
                     $calling_function,
                     $replace,
@@ -92,6 +94,7 @@ class UnionTemplateHandler
         ?Codebase $codebase,
         ?StatementsAnalyzer $statements_analyzer,
         ?Union $input_type,
+        ?int $input_arg_offset,
         ?string $calling_class,
         ?string $calling_function,
         bool $replace,
@@ -113,6 +116,7 @@ class UnionTemplateHandler
                 $atomic_type,
                 $key,
                 $input_type,
+                $input_arg_offset,
                 $calling_class,
                 $calling_function,
                 $template_result,
@@ -134,6 +138,7 @@ class UnionTemplateHandler
                 return self::handleTemplateParamClassStandin(
                     $atomic_type,
                     $input_type,
+                    $input_arg_offset,
                     $template_result,
                     $depth,
                     $was_single
@@ -253,6 +258,7 @@ class UnionTemplateHandler
             $codebase,
             $statements_analyzer,
             $matching_atomic_type,
+            $input_arg_offset,
             $calling_class,
             $calling_function,
             $replace,
@@ -379,6 +385,7 @@ class UnionTemplateHandler
         Atomic\TTemplateParam $atomic_type,
         string $key,
         ?Union $input_type,
+        ?int $input_arg_offset,
         ?string $calling_class,
         ?string $calling_function,
         TemplateResult $template_result,
@@ -493,17 +500,18 @@ class UnionTemplateHandler
                 if (isset(
                     $template_result->generic_params[$param_name_key][$atomic_type->defining_class][0]
                 )) {
-                    $existing_depth = $template_result->generic_params
+                    $existing_generic_param = $template_result->generic_params
                         [$param_name_key]
-                        [$atomic_type->defining_class]
-                        [1]
-                        ?? -1;
+                        [$atomic_type->defining_class];
 
-                    if ($existing_depth > $depth) {
+                    $existing_depth = $existing_generic_param[1] ?? -1;
+                    $existing_arg_offset = $existing_generic_param[2] ?? $input_arg_offset;
+
+                    if ($existing_depth > $depth && $input_arg_offset === $existing_arg_offset) {
                         return $atomic_types ?: [$atomic_type];
                     }
 
-                    if ($existing_depth === $depth) {
+                    if ($existing_depth === $depth || $input_arg_offset !== $existing_arg_offset) {
                         $generic_param = \Psalm\Type::combineUnionTypes(
                             $template_result->generic_params
                                 [$param_name_key]
@@ -518,6 +526,7 @@ class UnionTemplateHandler
                 $template_result->generic_params[$param_name_key][$atomic_type->defining_class] = [
                     $generic_param,
                     $depth,
+                    $input_arg_offset
                 ];
             }
 
@@ -546,6 +555,7 @@ class UnionTemplateHandler
     public static function handleTemplateParamClassStandin(
         Atomic\TTemplateParamClass $atomic_type,
         ?Union $input_type,
+        ?int $input_arg_offset,
         TemplateResult $template_result,
         int $depth,
         bool $was_single
@@ -609,6 +619,7 @@ class UnionTemplateHandler
                     $template_result->generic_params[$atomic_type->param_name][$atomic_type->defining_class] = [
                         $generic_param,
                         $depth,
+                        $input_arg_offset
                     ];
                 }
             }
diff --git a/src/Psalm/Type/Atomic.php b/src/Psalm/Type/Atomic.php
index 4bac08846..0b7bec5e6 100644
--- a/src/Psalm/Type/Atomic.php
+++ b/src/Psalm/Type/Atomic.php
@@ -863,6 +863,7 @@ abstract class Atomic
         Codebase $codebase = null,
         ?StatementsAnalyzer $statements_analyer = null,
         Type\Atomic $input_type = null,
+        ?int $input_arg_offset = null,
         ?string $calling_class = null,
         ?string $calling_function = null,
         bool $replace = true,
diff --git a/src/Psalm/Type/Atomic/CallableTrait.php b/src/Psalm/Type/Atomic/CallableTrait.php
index 8a9ee4f50..717997ffb 100644
--- a/src/Psalm/Type/Atomic/CallableTrait.php
+++ b/src/Psalm/Type/Atomic/CallableTrait.php
@@ -200,6 +200,7 @@ trait CallableTrait
         Codebase $codebase = null,
         ?StatementsAnalyzer $statements_analyzer = null,
         Atomic $input_type = null,
+        ?int $input_arg_offset = null,
         ?string $calling_class = null,
         ?string $calling_function = null,
         bool $replace = true,
@@ -228,6 +229,7 @@ trait CallableTrait
                     $codebase,
                     $statements_analyzer,
                     $input_param_type,
+                    $input_arg_offset,
                     $calling_class,
                     $calling_function,
                     $replace,
@@ -247,6 +249,7 @@ trait CallableTrait
                 $codebase,
                 $statements_analyzer,
                 $input_type->return_type,
+                $input_arg_offset,
                 $calling_class,
                 $calling_function,
                 $replace,
diff --git a/src/Psalm/Type/Atomic/GenericTrait.php b/src/Psalm/Type/Atomic/GenericTrait.php
index 645bb72ca..e1dcf528f 100644
--- a/src/Psalm/Type/Atomic/GenericTrait.php
+++ b/src/Psalm/Type/Atomic/GenericTrait.php
@@ -168,6 +168,7 @@ trait GenericTrait
         ?Codebase $codebase = null,
         ?StatementsAnalyzer $statements_analyzer = null,
         Atomic $input_type = null,
+        ?int $input_arg_offset = null,
         ?string $calling_class = null,
         ?string $calling_function = null,
         bool $replace = true,
@@ -207,6 +208,7 @@ trait GenericTrait
                 $codebase,
                 $statements_analyzer,
                 $input_type_param,
+                $input_arg_offset,
                 $calling_class,
                 $calling_function,
                 $replace,
diff --git a/src/Psalm/Type/Atomic/ObjectLike.php b/src/Psalm/Type/Atomic/ObjectLike.php
index 68882c637..d7df2ac9c 100644
--- a/src/Psalm/Type/Atomic/ObjectLike.php
+++ b/src/Psalm/Type/Atomic/ObjectLike.php
@@ -314,9 +314,10 @@ class ObjectLike extends \Psalm\Type\Atomic
 
     public function replaceTemplateTypesWithStandins(
         TemplateResult $template_result,
-        Codebase $codebase = null,
-        StatementsAnalyzer $statements_analyzer = null,
+        ?Codebase $codebase = null,
+        ?StatementsAnalyzer $statements_analyzer = null,
         Atomic $input_type = null,
+        ?int $input_arg_offset = null,
         ?string $calling_class = null,
         ?string $calling_function = null,
         bool $replace = true,
@@ -340,6 +341,7 @@ class ObjectLike extends \Psalm\Type\Atomic
                 $codebase,
                 $statements_analyzer,
                 $input_type_param,
+                $input_arg_offset,
                 $calling_class,
                 $calling_function,
                 $replace,
diff --git a/src/Psalm/Type/Atomic/TClassStringMap.php b/src/Psalm/Type/Atomic/TClassStringMap.php
index 7ad256a60..7a628eda0 100644
--- a/src/Psalm/Type/Atomic/TClassStringMap.php
+++ b/src/Psalm/Type/Atomic/TClassStringMap.php
@@ -147,9 +147,10 @@ class TClassStringMap extends \Psalm\Type\Atomic
 
     public function replaceTemplateTypesWithStandins(
         TemplateResult $template_result,
-        Codebase $codebase = null,
-        StatementsAnalyzer $statements_analyzer = null,
+        ?Codebase $codebase = null,
+        ?StatementsAnalyzer $statements_analyzer = null,
         Atomic $input_type = null,
+        ?int $input_arg_offset = null,
         ?string $calling_class = null,
         ?string $calling_function = null,
         bool $replace = true,
@@ -188,6 +189,7 @@ class TClassStringMap extends \Psalm\Type\Atomic
                 $codebase,
                 $statements_analyzer,
                 $input_type_param,
+                $input_arg_offset,
                 $calling_class,
                 $calling_function,
                 $replace,
diff --git a/src/Psalm/Type/Atomic/TList.php b/src/Psalm/Type/Atomic/TList.php
index f8f9f3cde..051a7b79f 100644
--- a/src/Psalm/Type/Atomic/TList.php
+++ b/src/Psalm/Type/Atomic/TList.php
@@ -117,9 +117,10 @@ class TList extends \Psalm\Type\Atomic
 
     public function replaceTemplateTypesWithStandins(
         TemplateResult $template_result,
-        Codebase $codebase = null,
-        StatementsAnalyzer $statements_analyzer = null,
+        ?Codebase $codebase = null,
+        ?StatementsAnalyzer $statements_analyzer = null,
         Atomic $input_type = null,
+        ?int $input_arg_offset = null,
         ?string $calling_class = null,
         ?string $calling_function = null,
         bool $replace = true,
@@ -158,6 +159,7 @@ class TList extends \Psalm\Type\Atomic
                 $codebase,
                 $statements_analyzer,
                 $input_type_param,
+                $input_arg_offset,
                 $calling_class,
                 $calling_function,
                 $replace,
diff --git a/src/Psalm/Type/Atomic/TObjectWithProperties.php b/src/Psalm/Type/Atomic/TObjectWithProperties.php
index 0f152f387..03bb6e21f 100644
--- a/src/Psalm/Type/Atomic/TObjectWithProperties.php
+++ b/src/Psalm/Type/Atomic/TObjectWithProperties.php
@@ -245,9 +245,10 @@ class TObjectWithProperties extends TObject
 
     public function replaceTemplateTypesWithStandins(
         TemplateResult $template_result,
-        Codebase $codebase = null,
-        StatementsAnalyzer $statements_analyzer = null,
+        ?Codebase $codebase = null,
+        ?StatementsAnalyzer $statements_analyzer = null,
         Atomic $input_type = null,
+        ?int $input_arg_offset = null,
         ?string $calling_class = null,
         ?string $calling_function = null,
         bool $replace = true,
@@ -271,6 +272,7 @@ class TObjectWithProperties extends TObject
                 $codebase,
                 $statements_analyzer,
                 $input_type_param,
+                $input_arg_offset,
                 $calling_class,
                 $calling_function,
                 $replace,
diff --git a/tests/Template/ClassTemplateTest.php b/tests/Template/ClassTemplateTest.php
index 71d14b543..6ffebe167 100644
--- a/tests/Template/ClassTemplateTest.php
+++ b/tests/Template/ClassTemplateTest.php
@@ -2435,6 +2435,42 @@ class ClassTemplateTest extends TestCase
                         }
                     }'
             ],
+            'unionClassStringInferenceAndDefaultEmptyArray' => [
+                '<?php
+                    class A{}
+
+                    $packages = Collection::fromClassString(A::class);
+
+                    /**
+                     * @template T
+                     */
+                    class Collection{
+                        /** @var array<T> $items */
+                        protected $items = [];
+
+                        /**
+                         * @param array<string, T> $items
+                         */
+                        public function __construct(array $items = [])
+                        {
+                            $this->items = $items;
+                        }
+
+                        /**
+                         * @template C as object
+                         * @param class-string<C> $classString
+                         * @param array<string, C> $elements
+                         * @return Collection<C>
+                         */
+                        public static function fromClassString(string $classString, array $elements = []) : Collection
+                        {
+                            return new Collection($elements);
+                        }
+                    }',
+                [
+                    '$packages' => 'Collection<A>'
+                ]
+            ],
         ];
     }
 
