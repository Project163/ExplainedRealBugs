diff --git a/src/Psalm/Internal/Analyzer/Statements/Block/ForeachAnalyzer.php b/src/Psalm/Internal/Analyzer/Statements/Block/ForeachAnalyzer.php
index 20a5b095d..daefc6bff 100644
--- a/src/Psalm/Internal/Analyzer/Statements/Block/ForeachAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/Statements/Block/ForeachAnalyzer.php
@@ -291,6 +291,13 @@ class ForeachAnalyzer
                         );
                     }
                 } else {
+                    if ($context->collect_references
+                        && !isset($context->vars_in_scope[$var_id])
+                        && isset($inner_loop_context->unreferenced_vars[$var_id])
+                    ) {
+                        $context->unreferenced_vars[$var_id] = $inner_loop_context->unreferenced_vars[$var_id];
+                    }
+
                     $context->vars_in_scope[$var_id] = $type;
                 }
             }
diff --git a/src/Psalm/Internal/Analyzer/Statements/Block/LoopAnalyzer.php b/src/Psalm/Internal/Analyzer/Statements/Block/LoopAnalyzer.php
index bd55f53d6..1751ebdd9 100644
--- a/src/Psalm/Internal/Analyzer/Statements/Block/LoopAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/Statements/Block/LoopAnalyzer.php
@@ -273,8 +273,9 @@ class LoopAnalyzer
                 }
 
                 if ($inner_context->collect_references) {
-                    foreach ($inner_context->unreferenced_vars as $var_id => $_) {
+                    foreach ($inner_context->unreferenced_vars as $var_id => $locations) {
                         if (!isset($pre_outer_context->vars_in_scope[$var_id])) {
+                            $loop_scope->unreferenced_vars[$var_id] = $locations;
                             unset($inner_context->unreferenced_vars[$var_id]);
                         }
                     }
diff --git a/tests/UnusedVariableTest.php b/tests/UnusedVariableTest.php
index 3a891d50b..901de33da 100644
--- a/tests/UnusedVariableTest.php
+++ b/tests/UnusedVariableTest.php
@@ -1034,6 +1034,18 @@ class UnusedVariableTest extends TestCase
                         }
                     }'
             ],
+            'setInLoopThatsAlwaysEntered' => [
+                '<?php
+                    /**
+                     * @param non-empty-array<int> $a
+                     */
+                    function getLastNum(array $a): int {
+                        foreach ($a as $num) {
+                            $last = $num;
+                        }
+                        return $last;
+                    }'
+            ],
         ];
     }
 
@@ -1712,6 +1724,19 @@ class UnusedVariableTest extends TestCase
                     }',
                 'error_message' => 'UnusedVariable',
             ],
+            'setInLoopThatsAlwaysEnteredButNotReferenced' => [
+                '<?php
+                    /**
+                     * @param non-empty-array<int> $a
+                     */
+                    function getLastNum(array $a): int {
+                        foreach ($a as $num) {
+                            $last = $num;
+                        }
+                        return 4;
+                    }',
+                'error_message' => 'UnusedVariable',
+            ],
         ];
     }
 }
