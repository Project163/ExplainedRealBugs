diff --git a/src/Psalm/Codebase.php b/src/Psalm/Codebase.php
index ae1dd2410..211e43c1e 100644
--- a/src/Psalm/Codebase.php
+++ b/src/Psalm/Codebase.php
@@ -814,19 +814,19 @@ class Codebase
      *
      * @param  string       $method_id
      * @param  CodeLocation|null $code_location
-     * @param  string       $calling_method_id
+     * @param  string       $calling_function_id
      *
      * @return bool
      */
     public function methodExists(
         string $method_id,
         CodeLocation $code_location = null,
-        $calling_method_id = null,
+        $calling_function_id = null,
         string $file_path = null
     ) {
         return $this->methods->methodExists(
             $method_id,
-            $calling_method_id,
+            $calling_function_id,
             $code_location,
             null,
             $file_path
diff --git a/src/Psalm/Context.php b/src/Psalm/Context.php
index 5ecf8cf3c..bc45e334c 100644
--- a/src/Psalm/Context.php
+++ b/src/Psalm/Context.php
@@ -305,7 +305,7 @@ class Context
     /**
      * @var string|null
      */
-    public $calling_method_id;
+    public $calling_function_id;
 
     /**
      * @var bool
diff --git a/src/Psalm/Internal/Analyzer/FunctionLikeAnalyzer.php b/src/Psalm/Internal/Analyzer/FunctionLikeAnalyzer.php
index a8b27d3a0..66ddb391c 100644
--- a/src/Psalm/Internal/Analyzer/FunctionLikeAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/FunctionLikeAnalyzer.php
@@ -318,9 +318,10 @@ abstract class FunctionLikeAnalyzer extends SourceAnalyzer
 
             MethodAnalyzer::checkMethodSignatureMustOmitReturnType($storage, $codeLocation);
 
-            $context->calling_method_id = strtolower($method_id);
+            $context->calling_function_id = strtolower($method_id);
         } elseif ($this->function instanceof Function_) {
             $cased_method_id = $this->function->name->name;
+            $context->calling_function_id = strtolower($cased_method_id);
         } else { // Closure
             if ($storage->return_type) {
                 $closure_return_type = ExpressionAnalyzer::fleshOutType(
@@ -662,7 +663,7 @@ abstract class FunctionLikeAnalyzer extends SourceAnalyzer
                             $this,
                             $input_type,
                             $storage->throw_locations[$expected_exception],
-                            $context->calling_method_id
+                            $context->calling_function_id
                         );
                     }
                 }
@@ -1169,7 +1170,7 @@ abstract class FunctionLikeAnalyzer extends SourceAnalyzer
                     $this,
                     $param_name_node,
                     $resolved_name,
-                    $context->calling_method_id,
+                    $context->calling_function_id,
                     false,
                     true
                 );
@@ -1203,7 +1204,7 @@ abstract class FunctionLikeAnalyzer extends SourceAnalyzer
                     $this,
                     $return_name_node,
                     $resolved_name,
-                    $context->calling_method_id,
+                    $context->calling_function_id,
                     false,
                     true
                 );
@@ -1228,7 +1229,7 @@ abstract class FunctionLikeAnalyzer extends SourceAnalyzer
                 $this,
                 $replace_type,
                 $storage->return_type_location,
-                $context->calling_method_id
+                $context->calling_function_id
             );
         }
 
@@ -1252,7 +1253,7 @@ abstract class FunctionLikeAnalyzer extends SourceAnalyzer
                     $this,
                     $replace_type,
                     $function_param->type_location,
-                    $context->calling_method_id
+                    $context->calling_function_id
                 );
             }
         }
diff --git a/src/Psalm/Internal/Analyzer/MethodAnalyzer.php b/src/Psalm/Internal/Analyzer/MethodAnalyzer.php
index 5fe9842d3..199964aad 100644
--- a/src/Psalm/Internal/Analyzer/MethodAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/MethodAnalyzer.php
@@ -145,7 +145,7 @@ class MethodAnalyzer extends FunctionLikeAnalyzer
      * @param  string       $method_id
      * @param  CodeLocation $code_location
      * @param  string[]     $suppressed_issues
-     * @param  string|null  $calling_method_id
+     * @param  string|null  $calling_function_id
      *
      * @return bool|null
      */
@@ -154,12 +154,12 @@ class MethodAnalyzer extends FunctionLikeAnalyzer
         $method_id,
         CodeLocation $code_location,
         array $suppressed_issues,
-        $calling_method_id = null
+        $calling_function_id = null
     ) {
         if ($codebase->methods->methodExists(
             $method_id,
-            $calling_method_id,
-            $calling_method_id !== $method_id ? $code_location : null,
+            $calling_function_id,
+            $calling_function_id !== $method_id ? $code_location : null,
             null,
             $code_location->file_path
         )) {
diff --git a/src/Psalm/Internal/Analyzer/Statements/Block/ForeachAnalyzer.php b/src/Psalm/Internal/Analyzer/Statements/Block/ForeachAnalyzer.php
index f122676f4..b5a10c54d 100644
--- a/src/Psalm/Internal/Analyzer/Statements/Block/ForeachAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/Statements/Block/ForeachAnalyzer.php
@@ -141,7 +141,7 @@ class ForeachAnalyzer
                         $statements_analyzer,
                         $comment_type,
                         $type_location,
-                        $context->calling_method_id
+                        $context->calling_function_id
                     );
                 }
             }
diff --git a/src/Psalm/Internal/Analyzer/Statements/Block/TryAnalyzer.php b/src/Psalm/Internal/Analyzer/Statements/Block/TryAnalyzer.php
index 9a36cc05c..a31397b5a 100644
--- a/src/Psalm/Internal/Analyzer/Statements/Block/TryAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/Statements/Block/TryAnalyzer.php
@@ -210,7 +210,7 @@ class TryAnalyzer
                         $statements_analyzer,
                         $catch_type,
                         $fq_catch_class,
-                        $context->calling_method_id
+                        $context->calling_function_id
                     );
                 }
 
diff --git a/src/Psalm/Internal/Analyzer/Statements/Expression/Assignment/ArrayAssignmentAnalyzer.php b/src/Psalm/Internal/Analyzer/Statements/Expression/Assignment/ArrayAssignmentAnalyzer.php
index 22748c6e7..fdaa81586 100644
--- a/src/Psalm/Internal/Analyzer/Statements/Expression/Assignment/ArrayAssignmentAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/Statements/Expression/Assignment/ArrayAssignmentAnalyzer.php
@@ -565,7 +565,7 @@ class ArrayAssignmentAnalyzer
                             [],
                             [
                                 $offset_type_part->param_name => [
-                                    ($offset_type_part->defining_class ?? '') => [
+                                    $offset_type_part->defining_class => [
                                         new Type\Union([
                                             new Type\Atomic\TTemplateParam(
                                                 $class_string_map->param_name,
diff --git a/src/Psalm/Internal/Analyzer/Statements/Expression/Assignment/PropertyAssignmentAnalyzer.php b/src/Psalm/Internal/Analyzer/Statements/Expression/Assignment/PropertyAssignmentAnalyzer.php
index 5b7e34023..c3779f37c 100644
--- a/src/Psalm/Internal/Analyzer/Statements/Expression/Assignment/PropertyAssignmentAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/Statements/Expression/Assignment/PropertyAssignmentAnalyzer.php
@@ -163,7 +163,7 @@ class PropertyAssignmentAnalyzer
                 if ($stmt->name instanceof PhpParser\Node\Identifier) {
                     $codebase->analyzer->addMixedMemberName(
                         '$' . $stmt->name->name,
-                        $context->calling_method_id ?: $statements_analyzer->getFileName()
+                        $context->calling_function_id ?: $statements_analyzer->getFileName()
                     );
                 }
 
@@ -639,9 +639,9 @@ class PropertyAssignmentAnalyzer
                             && !($context->self
                                 && ($appearing_property_class === $context->self
                                     || $codebase->classExtends($context->self, $appearing_property_class))
-                                && (!$context->calling_method_id
-                                    || \strpos($context->calling_method_id, '::__construct')
-                                    || \strpos($context->calling_method_id, '::unserialize')
+                                && (!$context->calling_function_id
+                                    || \strpos($context->calling_function_id, '::__construct')
+                                    || \strpos($context->calling_function_id, '::unserialize')
                                     || $property_pure_compatible)
                             )
                         ) {
@@ -1087,7 +1087,7 @@ class PropertyAssignmentAnalyzer
             if ($fq_class_name && !$context->ignore_variable_property) {
                 $codebase->analyzer->addMixedMemberName(
                     strtolower($fq_class_name) . '::$',
-                    $context->calling_method_id ?: $statements_analyzer->getFileName()
+                    $context->calling_function_id ?: $statements_analyzer->getFileName()
                 );
             }
 
@@ -1134,7 +1134,7 @@ class PropertyAssignmentAnalyzer
                 $statements_analyzer,
                 $stmt->class,
                 $fq_class_name,
-                $context->calling_method_id
+                $context->calling_function_id
             );
 
             if (!$moved_class) {
diff --git a/src/Psalm/Internal/Analyzer/Statements/Expression/AssignmentAnalyzer.php b/src/Psalm/Internal/Analyzer/Statements/Expression/AssignmentAnalyzer.php
index 360ddfc36..138a4e453 100644
--- a/src/Psalm/Internal/Analyzer/Statements/Expression/AssignmentAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/Statements/Expression/AssignmentAnalyzer.php
@@ -162,7 +162,7 @@ class AssignmentAnalyzer
                                 $statements_analyzer,
                                 $var_comment_type,
                                 $type_location,
-                                $context->calling_method_id
+                                $context->calling_function_id
                             );
                         }
                     }
@@ -720,7 +720,7 @@ class AssignmentAnalyzer
                             if ($type instanceof Type\Atomic\TNamedObject) {
                                 $codebase->analyzer->addMixedMemberName(
                                     strtolower($type->value) . '::$',
-                                    $context->calling_method_id ?: $statements_analyzer->getFileName()
+                                    $context->calling_function_id ?: $statements_analyzer->getFileName()
                                 );
                             }
                         }
diff --git a/src/Psalm/Internal/Analyzer/Statements/Expression/Call/FunctionCallAnalyzer.php b/src/Psalm/Internal/Analyzer/Statements/Expression/Call/FunctionCallAnalyzer.php
index f14f5bb82..e56adbc03 100644
--- a/src/Psalm/Internal/Analyzer/Statements/Expression/Call/FunctionCallAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/Statements/Expression/Call/FunctionCallAnalyzer.php
@@ -488,7 +488,9 @@ class FunctionCallAnalyzer extends \Psalm\Internal\Analyzer\Statements\Expressio
                         if ($function_storage && $function_storage->template_types) {
                             foreach ($function_storage->template_types as $template_name => $_) {
                                 if (!isset($template_result->generic_params[$template_name])) {
-                                    $template_result->generic_params[$template_name] = ['' => [Type::getEmpty(), 0]];
+                                    $template_result->generic_params[$template_name] = [
+                                        'fn-' . $function_id => [Type::getEmpty(), 0]
+                                    ];
                                 }
                             }
                         }
diff --git a/src/Psalm/Internal/Analyzer/Statements/Expression/Call/MethodCallAnalyzer.php b/src/Psalm/Internal/Analyzer/Statements/Expression/Call/MethodCallAnalyzer.php
index 24d96d72e..176d94b4d 100644
--- a/src/Psalm/Internal/Analyzer/Statements/Expression/Call/MethodCallAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/Statements/Expression/Call/MethodCallAnalyzer.php
@@ -524,7 +524,7 @@ class MethodCallAnalyzer extends \Psalm\Internal\Analyzer\Statements\Expression\
                         if ($stmt->name instanceof PhpParser\Node\Identifier) {
                             $codebase->analyzer->addMixedMemberName(
                                 strtolower($stmt->name->name),
-                                $context->calling_method_id ?: $statements_analyzer->getFileName()
+                                $context->calling_function_id ?: $statements_analyzer->getFileName()
                             );
                         }
 
@@ -682,7 +682,7 @@ class MethodCallAnalyzer extends \Psalm\Internal\Analyzer\Statements\Expression\
             if (!$context->ignore_variable_method) {
                 $codebase->analyzer->addMixedMemberName(
                     strtolower($fq_class_name) . '::',
-                    $context->calling_method_id ?: $statements_analyzer->getFileName()
+                    $context->calling_function_id ?: $statements_analyzer->getFileName()
                 );
             }
 
@@ -705,7 +705,7 @@ class MethodCallAnalyzer extends \Psalm\Internal\Analyzer\Statements\Expression\
 
         if (!$codebase->methods->methodExists(
             $method_id,
-            $context->calling_method_id,
+            $context->calling_function_id,
             $codebase->collect_references ? new CodeLocation($source, $stmt->name) : null,
             null,
             $statements_analyzer->getFilePath()
@@ -734,7 +734,7 @@ class MethodCallAnalyzer extends \Psalm\Internal\Analyzer\Statements\Expression\
             if (!$interface_has_method
                 && $codebase->methods->methodExists(
                     $fq_class_name . '::__call',
-                    $context->calling_method_id
+                    $context->calling_function_id
                 )
             ) {
                 if (isset($class_storage->pseudo_methods[$method_name_lc])) {
@@ -866,7 +866,7 @@ class MethodCallAnalyzer extends \Psalm\Internal\Analyzer\Statements\Expression\
 
         if (!$codebase->methods->methodExists(
             $method_id,
-            $context->calling_method_id,
+            $context->calling_function_id,
             $method_id !== $source_method_id ? new CodeLocation($source, $stmt->name) : null
         )
             || ($config->use_phpdoc_method_without_magic_or_parent
@@ -973,8 +973,8 @@ class MethodCallAnalyzer extends \Psalm\Internal\Analyzer\Statements\Expression\
             );
         }
 
-        if ($context->collect_initializations && $context->calling_method_id) {
-            list($calling_method_class) = explode('::', $context->calling_method_id);
+        if ($context->collect_initializations && $context->calling_function_id) {
+            list($calling_method_class) = explode('::', $context->calling_function_id);
             $codebase->file_reference_provider->addMethodReferenceToClassMember(
                 $calling_method_class . '::__construct',
                 strtolower($method_id)
diff --git a/src/Psalm/Internal/Analyzer/Statements/Expression/Call/NewAnalyzer.php b/src/Psalm/Internal/Analyzer/Statements/Expression/Call/NewAnalyzer.php
index 2b5cb3d7a..8f9847663 100644
--- a/src/Psalm/Internal/Analyzer/Statements/Expression/Call/NewAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/Statements/Expression/Call/NewAnalyzer.php
@@ -57,11 +57,11 @@ class NewAnalyzer extends \Psalm\Internal\Analyzer\Statements\Expression\CallAna
             if (!in_array(strtolower($stmt->class->parts[0]), ['self', 'static', 'parent'], true)) {
                 $aliases = $statements_analyzer->getAliases();
 
-                if ($context->calling_method_id
+                if ($context->calling_function_id
                     && !$stmt->class instanceof PhpParser\Node\Name\FullyQualified
                 ) {
                     $codebase->file_reference_provider->addMethodReferenceToClassMember(
-                        $context->calling_method_id,
+                        $context->calling_function_id,
                         'use:' . $stmt->class->parts[0] . ':' . \md5($statements_analyzer->getFilePath())
                     );
                 }
@@ -282,7 +282,7 @@ class NewAnalyzer extends \Psalm\Internal\Analyzer\Statements\Expression\CallAna
                     $statements_analyzer,
                     $stmt->class,
                     $fq_class_name,
-                    $context->calling_method_id
+                    $context->calling_function_id
                 );
             }
 
@@ -381,7 +381,7 @@ class NewAnalyzer extends \Psalm\Internal\Analyzer\Statements\Expression\CallAna
 
                 if ($codebase->methods->methodExists(
                     $fq_class_name . '::__construct',
-                    $context->calling_method_id,
+                    $context->calling_function_id,
                     $context->collect_references ? new CodeLocation($statements_analyzer->getSource(), $stmt) : null,
                     null,
                     $statements_analyzer->getFilePath()
diff --git a/src/Psalm/Internal/Analyzer/Statements/Expression/Call/StaticCallAnalyzer.php b/src/Psalm/Internal/Analyzer/Statements/Expression/Call/StaticCallAnalyzer.php
index cdffd7e3e..2b570ab96 100644
--- a/src/Psalm/Internal/Analyzer/Statements/Expression/Call/StaticCallAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/Statements/Expression/Call/StaticCallAnalyzer.php
@@ -116,11 +116,11 @@ class StaticCallAnalyzer extends \Psalm\Internal\Analyzer\Statements\Expression\
             } elseif ($context->check_classes) {
                 $aliases = $statements_analyzer->getAliases();
 
-                if ($context->calling_method_id
+                if ($context->calling_function_id
                     && !$stmt->class instanceof PhpParser\Node\Name\FullyQualified
                 ) {
                     $codebase->file_reference_provider->addMethodReferenceToClassMember(
-                        $context->calling_method_id,
+                        $context->calling_function_id,
                         'use:' . $stmt->class->parts[0] . ':' . \md5($statements_analyzer->getFilePath())
                     );
                 }
@@ -297,7 +297,7 @@ class StaticCallAnalyzer extends \Psalm\Internal\Analyzer\Statements\Expression\
                     if ($stmt->name instanceof PhpParser\Node\Identifier) {
                         $codebase->analyzer->addMixedMemberName(
                             strtolower($stmt->name->name),
-                            $context->calling_method_id ?: $statements_analyzer->getFileName()
+                            $context->calling_function_id ?: $statements_analyzer->getFileName()
                         );
                     }
 
@@ -400,7 +400,7 @@ class StaticCallAnalyzer extends \Psalm\Internal\Analyzer\Statements\Expression\
 
                 if (!$codebase->methods->methodExists(
                     $method_id,
-                    $context->calling_method_id,
+                    $context->calling_function_id,
                     $codebase->collect_references ? new CodeLocation($source, $stmt->name) : null,
                     null,
                     $statements_analyzer->getFilePath()
@@ -413,7 +413,7 @@ class StaticCallAnalyzer extends \Psalm\Internal\Analyzer\Statements\Expression\
                 ) {
                     if ($codebase->methods->methodExists(
                         $fq_class_name . '::__callStatic',
-                        $context->calling_method_id,
+                        $context->calling_function_id,
                         $codebase->collect_references ? new CodeLocation($source, $stmt->name) : null,
                         null,
                         $statements_analyzer->getFilePath()
@@ -524,7 +524,7 @@ class StaticCallAnalyzer extends \Psalm\Internal\Analyzer\Statements\Expression\
                     $method_id,
                     new CodeLocation($source, $stmt),
                     $statements_analyzer->getSuppressedIssues(),
-                    $context->calling_method_id
+                    $context->calling_function_id
                 );
 
                 if (!$does_method_exist) {
@@ -544,7 +544,7 @@ class StaticCallAnalyzer extends \Psalm\Internal\Analyzer\Statements\Expression\
                             $statements_analyzer,
                             $stmt->class,
                             $fq_class_name,
-                            $context->calling_method_id
+                            $context->calling_function_id
                         );
                     }
 
@@ -1010,7 +1010,7 @@ class StaticCallAnalyzer extends \Psalm\Internal\Analyzer\Statements\Expression\
                                     $statements_analyzer,
                                     $stmt->class,
                                     $new_fq_class_name,
-                                    $context->calling_method_id,
+                                    $context->calling_function_id,
                                     strtolower($old_declaring_fq_class_name) !== strtolower($new_fq_class_name),
                                     $stmt->class->parts[0] === 'self'
                                 )) {
@@ -1102,7 +1102,7 @@ class StaticCallAnalyzer extends \Psalm\Internal\Analyzer\Statements\Expression\
                 if (!$context->ignore_variable_method) {
                     $codebase->analyzer->addMixedMemberName(
                         strtolower($fq_class_name) . '::',
-                        $context->calling_method_id ?: $statements_analyzer->getFileName()
+                        $context->calling_function_id ?: $statements_analyzer->getFileName()
                     );
                 }
 
@@ -1128,7 +1128,7 @@ class StaticCallAnalyzer extends \Psalm\Internal\Analyzer\Statements\Expression\
                     $statements_analyzer,
                     $stmt->class,
                     $fq_class_name,
-                    $context->calling_method_id,
+                    $context->calling_function_id,
                     false,
                     $stmt->class->parts[0] === 'self'
                 );
diff --git a/src/Psalm/Internal/Analyzer/Statements/Expression/CallAnalyzer.php b/src/Psalm/Internal/Analyzer/Statements/Expression/CallAnalyzer.php
index 0df49124e..a17e84dd0 100644
--- a/src/Psalm/Internal/Analyzer/Statements/Expression/CallAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/Statements/Expression/CallAnalyzer.php
@@ -457,7 +457,8 @@ class CallAnalyzer
                                         new Type\Union([
                                             new Type\Atomic\TTemplateParam(
                                                 'ArrayValue',
-                                                Type::getMixed()
+                                                Type::getMixed(),
+                                                $method_id
                                             )
                                         ])
                                     )
@@ -478,7 +479,7 @@ class CallAnalyzer
                         $replace_template_result,
                         $codebase,
                         null,
-                        null
+                        'fn-' . $context->calling_function_id
                     );
 
                     $replaced_type->replaceTemplateTypesWithArgTypes(
@@ -538,7 +539,7 @@ class CallAnalyzer
 
                 if (count($args) === 2
                     && (($argument_offset === 0 && $method_id === 'array_filter')
-                        || ($argument_offset === 1 || $method_id === 'array_map'))
+                        || ($argument_offset === 1 && $method_id === 'array_map'))
                 ) {
                     $generic_param_type = new Type\Union([
                         new Type\Atomic\TArray([
@@ -546,13 +547,14 @@ class CallAnalyzer
                             new Type\Union([
                                 new Type\Atomic\TTemplateParam(
                                     'ArrayValue',
-                                    Type::getMixed()
+                                    Type::getMixed(),
+                                    $method_id
                                 )
                             ])
                         ])
                     ]);
 
-                    $template_types = ['ArrayValue' => ['' => [Type::getMixed()]]];
+                    $template_types = ['ArrayValue' => [$method_id => [Type::getMixed()]]];
 
                     $replace_template_result = new \Psalm\Internal\Type\TemplateResult(
                         $template_types,
@@ -564,7 +566,7 @@ class CallAnalyzer
                         $replace_template_result,
                         $codebase,
                         $statements_analyzer->node_data->getType($arg->value),
-                        null
+                        'fn-' . $context->calling_function_id
                     );
 
                     if ($replace_template_result->generic_params) {
@@ -718,6 +720,7 @@ class CallAnalyzer
 
         $builtin_array_functions = [
             'shuffle', 'sort', 'rsort', 'usort', 'ksort', 'asort',
+            'uasort',
             'krsort', 'arsort', 'natcasesort', 'natsort', 'reset',
             'end', 'next', 'prev', 'array_pop', 'array_shift',
         ];
@@ -1246,7 +1249,7 @@ class CallAnalyzer
                         $template_result,
                         $codebase,
                         $arg_value_type,
-                        $context->self ?: '',
+                        $context->self ?: 'fn-' . $context->calling_function_id,
                         false
                     );
 
@@ -1431,7 +1434,7 @@ class CallAnalyzer
                         $template_result,
                         $codebase,
                         clone $param->default_type,
-                        null,
+                        'fn-' . $context->calling_function_id,
                         true
                     );
                 }
@@ -1626,7 +1629,7 @@ class CallAnalyzer
                         $template_result,
                         $codebase,
                         $statements_analyzer->node_data->getType($arg->value),
-                        null
+                        'fn-' . $context->calling_function_id
                     );
 
                     if ($template_result->generic_params) {
@@ -1646,7 +1649,7 @@ class CallAnalyzer
                         $template_result,
                         $codebase,
                         $statements_analyzer->node_data->getType($arg->value),
-                        null
+                        'fn-' . $context->calling_function_id
                     );
 
                     if ($template_result->generic_params) {
@@ -1727,7 +1730,7 @@ class CallAnalyzer
                 $empty_template_result,
                 $codebase,
                 $arg_value_type,
-                $context->self ?: ''
+                $context->self ?: 'fn-' . $context->calling_function_id
             );
 
             $arg_type = UnionTemplateHandler::replaceTemplateTypesWithStandins(
@@ -1735,7 +1738,7 @@ class CallAnalyzer
                 $empty_template_result,
                 $codebase,
                 $arg_value_type,
-                $context->self ?: ''
+                $context->self ?: 'fn-' . $context->calling_function_id
             );
         }
 
@@ -1769,17 +1772,17 @@ class CallAnalyzer
                 $template_result,
                 $codebase,
                 $arg_type_param,
-                $context->self ?: ''
+                $context->self ?: 'fn-' . $context->calling_function_id
             );
 
             foreach ($bindable_template_params as $template_type) {
                 if (!isset(
                     $template_result->generic_params
                         [$template_type->param_name]
-                        [$template_type->defining_class ?: '']
+                        [$template_type->defining_class]
                 )) {
                     $template_result->generic_params[$template_type->param_name] = [
-                        ($template_type->defining_class ?: '') => [clone $template_type->as, 0]
+                        ($template_type->defining_class) => [clone $template_type->as, 0]
                     ];
                 }
             }
@@ -2593,7 +2596,7 @@ class CallAnalyzer
                     $potential_method_id = TypeAnalyzer::getCallableMethodIdFromObjectLike(
                         $input_type_part,
                         $codebase,
-                        $context->calling_method_id,
+                        $context->calling_function_id,
                         $statements_analyzer->getFilePath()
                     );
 
@@ -2609,7 +2612,7 @@ class CallAnalyzer
                 if (strpos($potential_method_id, '::')) {
                     $codebase->methods->methodExists(
                         $potential_method_id,
-                        $context->calling_method_id,
+                        $context->calling_function_id,
                         null,
                         $statements_analyzer,
                         $statements_analyzer->getFilePath()
@@ -3506,7 +3509,7 @@ class CallAnalyzer
                 $changed_var_ids,
                 $asserted_keys,
                 $statements_analyzer,
-                $template_type_map,
+                ($statements_analyzer->getTemplateTypeMap() ?: []) + $template_type_map,
                 $context->inside_loop,
                 new CodeLocation($statements_analyzer->getSource(), $expr)
             );
diff --git a/src/Psalm/Internal/Analyzer/Statements/Expression/Fetch/ArrayFetchAnalyzer.php b/src/Psalm/Internal/Analyzer/Statements/Expression/Fetch/ArrayFetchAnalyzer.php
index 898b304f3..656ae3642 100644
--- a/src/Psalm/Internal/Analyzer/Statements/Expression/Fetch/ArrayFetchAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/Statements/Expression/Fetch/ArrayFetchAnalyzer.php
@@ -754,7 +754,7 @@ class ArrayFetchAnalyzer
                                     [],
                                     [
                                         $offset_type_part->param_name => [
-                                            ($offset_type_part->defining_class ?: '') => [
+                                            $offset_type_part->defining_class => [
                                                 new Type\Union([
                                                     new TTemplateParam(
                                                         $type->param_name,
diff --git a/src/Psalm/Internal/Analyzer/Statements/Expression/Fetch/ClassConstFetchAnalyzer.php b/src/Psalm/Internal/Analyzer/Statements/Expression/Fetch/ClassConstFetchAnalyzer.php
index a1173b01a..ac8ac2f2f 100644
--- a/src/Psalm/Internal/Analyzer/Statements/Expression/Fetch/ClassConstFetchAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/Statements/Expression/Fetch/ClassConstFetchAnalyzer.php
@@ -99,7 +99,7 @@ class ClassConstFetchAnalyzer
                     $statements_analyzer,
                     $stmt->class,
                     $fq_class_name,
-                    $context->calling_method_id,
+                    $context->calling_function_id,
                     false,
                     $stmt->class->parts[0] === 'self'
                 );
@@ -257,9 +257,9 @@ class ClassConstFetchAnalyzer
                 return;
             }
 
-            if ($context->calling_method_id) {
+            if ($context->calling_function_id) {
                 $codebase->file_reference_provider->addMethodReferenceToClassMember(
-                    $context->calling_method_id,
+                    $context->calling_function_id,
                     strtolower($fq_class_name) . '::' . $stmt->name->name
                 );
             }
diff --git a/src/Psalm/Internal/Analyzer/Statements/Expression/Fetch/PropertyFetchAnalyzer.php b/src/Psalm/Internal/Analyzer/Statements/Expression/Fetch/PropertyFetchAnalyzer.php
index 27f23a231..1bed56497 100644
--- a/src/Psalm/Internal/Analyzer/Statements/Expression/Fetch/PropertyFetchAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/Statements/Expression/Fetch/PropertyFetchAnalyzer.php
@@ -260,7 +260,7 @@ class PropertyFetchAnalyzer
             if ($stmt->name instanceof PhpParser\Node\Identifier) {
                 $codebase->analyzer->addMixedMemberName(
                     '$' . $stmt->name->name,
-                    $context->calling_method_id ?: $statements_analyzer->getFileName()
+                    $context->calling_function_id ?: $statements_analyzer->getFileName()
                 );
             }
 
@@ -324,7 +324,7 @@ class PropertyFetchAnalyzer
                     if ($type instanceof Type\Atomic\TNamedObject) {
                         $codebase->analyzer->addMixedMemberName(
                             strtolower($type->value) . '::$',
-                            $context->calling_method_id ?: $statements_analyzer->getFileName()
+                            $context->calling_function_id ?: $statements_analyzer->getFileName()
                         );
                     }
                 }
@@ -962,11 +962,11 @@ class PropertyFetchAnalyzer
             } else {
                 $aliases = $statements_analyzer->getAliases();
 
-                if ($context->calling_method_id
+                if ($context->calling_function_id
                     && !$stmt->class instanceof PhpParser\Node\Name\FullyQualified
                 ) {
                     $codebase->file_reference_provider->addMethodReferenceToClassMember(
-                        $context->calling_method_id,
+                        $context->calling_function_id,
                         'use:' . $stmt->class->parts[0] . ':' . \md5($statements_analyzer->getFilePath())
                     );
                 }
@@ -995,10 +995,10 @@ class PropertyFetchAnalyzer
 
             if ($fq_class_name
                 && $codebase->methods_to_move
-                && $context->calling_method_id
-                && isset($codebase->methods_to_move[strtolower($context->calling_method_id)])
+                && $context->calling_function_id
+                && isset($codebase->methods_to_move[strtolower($context->calling_function_id)])
             ) {
-                $destination_method_id = $codebase->methods_to_move[strtolower($context->calling_method_id)];
+                $destination_method_id = $codebase->methods_to_move[strtolower($context->calling_function_id)];
 
                 $codebase->classlikes->airliftClassLikeReference(
                     $fq_class_name,
@@ -1031,7 +1031,7 @@ class PropertyFetchAnalyzer
             if ($fq_class_name) {
                 $codebase->analyzer->addMixedMemberName(
                     strtolower($fq_class_name) . '::$',
-                    $context->calling_method_id ?: $statements_analyzer->getFileName()
+                    $context->calling_function_id ?: $statements_analyzer->getFileName()
                 );
             }
 
@@ -1142,7 +1142,7 @@ class PropertyFetchAnalyzer
                 $statements_analyzer,
                 $stmt->class,
                 $fq_class_name,
-                $context->calling_method_id
+                $context->calling_function_id
             );
 
             if (!$moved_class) {
diff --git a/src/Psalm/Internal/Analyzer/Statements/Expression/TernaryAnalyzer.php b/src/Psalm/Internal/Analyzer/Statements/Expression/TernaryAnalyzer.php
index 725652b62..ac50c31fd 100644
--- a/src/Psalm/Internal/Analyzer/Statements/Expression/TernaryAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/Statements/Expression/TernaryAnalyzer.php
@@ -152,7 +152,7 @@ class TernaryAnalyzer
                 $changed_var_ids,
                 $cond_referenced_var_ids,
                 $statements_analyzer,
-                [],
+                $statements_analyzer->getTemplateTypeMap() ?: [],
                 $if_context->inside_loop,
                 new CodeLocation($statements_analyzer->getSource(), $stmt->cond)
             );
@@ -192,7 +192,7 @@ class TernaryAnalyzer
                 $changed_var_ids,
                 $cond_referenced_var_ids,
                 $statements_analyzer,
-                [],
+                $statements_analyzer->getTemplateTypeMap() ?: [],
                 $t_else_context->inside_loop,
                 new CodeLocation($statements_analyzer->getSource(), $stmt->else)
             );
diff --git a/src/Psalm/Internal/Analyzer/Statements/ExpressionAnalyzer.php b/src/Psalm/Internal/Analyzer/Statements/ExpressionAnalyzer.php
index a2d04f642..8b51a2b98 100644
--- a/src/Psalm/Internal/Analyzer/Statements/ExpressionAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/Statements/ExpressionAnalyzer.php
@@ -166,7 +166,7 @@ class ExpressionAnalyzer
                             $statements_analyzer,
                             $stmt,
                             $context->self,
-                            $context->calling_method_id
+                            $context->calling_function_id
                         );
                     }
 
@@ -535,7 +535,7 @@ class ExpressionAnalyzer
                 }
             }
 
-            $use_context->calling_method_id = $context->calling_method_id;
+            $use_context->calling_function_id = $context->calling_function_id;
 
             $closure_analyzer->analyze($use_context, $statements_analyzer->node_data, $context, false, $byref_uses);
 
@@ -683,7 +683,7 @@ class ExpressionAnalyzer
                             $statements_analyzer,
                             $stmt->class,
                             $fq_class_name,
-                            $context->calling_method_id
+                            $context->calling_function_id
                         );
                     }
                 }
diff --git a/src/Psalm/Internal/Analyzer/Statements/ReturnAnalyzer.php b/src/Psalm/Internal/Analyzer/Statements/ReturnAnalyzer.php
index e06718daf..5f0d9f20a 100644
--- a/src/Psalm/Internal/Analyzer/Statements/ReturnAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/Statements/ReturnAnalyzer.php
@@ -109,7 +109,7 @@ class ReturnAnalyzer
                         $statements_analyzer,
                         $comment_type,
                         $type_location,
-                        $context->calling_method_id
+                        $context->calling_function_id
                     );
                 }
 
diff --git a/src/Psalm/Internal/Analyzer/StatementsAnalyzer.php b/src/Psalm/Internal/Analyzer/StatementsAnalyzer.php
index 0763e3481..9ca879854 100644
--- a/src/Psalm/Internal/Analyzer/StatementsAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/StatementsAnalyzer.php
@@ -1486,7 +1486,7 @@ class StatementsAnalyzer extends SourceAnalyzer implements StatementsSource
                                 $this,
                                 $var_comment_type,
                                 $type_location,
-                                $context->calling_method_id
+                                $context->calling_function_id
                             );
                         }
 
diff --git a/src/Psalm/Internal/Analyzer/TypeAnalyzer.php b/src/Psalm/Internal/Analyzer/TypeAnalyzer.php
index 375d5666c..3e9ee014e 100644
--- a/src/Psalm/Internal/Analyzer/TypeAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/TypeAnalyzer.php
@@ -668,10 +668,13 @@ class TypeAnalyzer
     ) : bool {
         if ($container_type_part instanceof TTemplateParam && $input_type_part instanceof TTemplateParam) {
             if ($container_type_part->param_name !== $input_type_part->param_name
-                || (string)$container_type_part->defining_class !== (string)$input_type_part->defining_class
+                || ((string)$container_type_part->defining_class !== (string)$input_type_part->defining_class
+                    && \substr($input_type_part->defining_class, 0, 3) !== 'fn-'
+                    && \substr($container_type_part->defining_class, 0, 3) !== 'fn-')
             ) {
                 if ($container_type_part->defining_class
                     && $input_type_part->defining_class
+                    && \substr($input_type_part->defining_class, 0, 3) !== 'fn-'
                 ) {
                     $input_class_storage = $codebase->classlike_storage_provider->get(
                         $input_type_part->defining_class
@@ -1154,6 +1157,23 @@ class TypeAnalyzer
             return true;
         }
 
+        if ($container_type_part instanceof TNonEmptyString
+            && get_class($input_type_part) === TString::class
+        ) {
+            if ($atomic_comparison_result) {
+                $atomic_comparison_result->type_coerced = true;
+            }
+
+            return false;
+        }
+
+        if ($container_type_part instanceof TNonEmptyString
+            && $input_type_part instanceof TLiteralString
+            && $input_type_part->value === ''
+        ) {
+            return false;
+        }
+
         if ((get_class($container_type_part) === TString::class
                 || get_class($container_type_part) === TNonEmptyString::class
                 || get_class($container_type_part) === TSingleLetter::class)
@@ -1729,7 +1749,7 @@ class TypeAnalyzer
     public static function getCallableMethodIdFromObjectLike(
         ObjectLike $input_type_part,
         Codebase $codebase = null,
-        string $calling_method_id = null,
+        string $calling_function_id = null,
         string $file_name = null
     ) {
         if (!isset($input_type_part->properties[0])
@@ -1748,12 +1768,12 @@ class TypeAnalyzer
                 return 'not-callable';
             }
 
-            if ($codebase && ($calling_method_id || $file_name)) {
+            if ($codebase && ($calling_function_id || $file_name)) {
                 foreach ($lhs->getTypes() as $lhs_atomic_type) {
                     if ($lhs_atomic_type instanceof TNamedObject) {
                         $codebase->analyzer->addMixedMemberName(
                             strtolower($lhs_atomic_type->value) . '::',
-                            $calling_method_id ?: $file_name
+                            $calling_function_id ?: $file_name
                         );
                     }
                 }
@@ -1787,10 +1807,10 @@ class TypeAnalyzer
         }
 
         if (!$class_name) {
-            if ($codebase && ($calling_method_id || $file_name)) {
+            if ($codebase && ($calling_function_id || $file_name)) {
                 $codebase->analyzer->addMixedMemberName(
                     strtolower($method_name),
-                    $calling_method_id ?: $file_name
+                    $calling_function_id ?: $file_name
                 );
             }
 
diff --git a/src/Psalm/Internal/Codebase/ClassLikes.php b/src/Psalm/Internal/Codebase/ClassLikes.php
index 2b09cc29d..0637d76a7 100644
--- a/src/Psalm/Internal/Codebase/ClassLikes.php
+++ b/src/Psalm/Internal/Codebase/ClassLikes.php
@@ -1028,7 +1028,7 @@ class ClassLikes
         \Psalm\StatementsSource $source,
         PhpParser\Node $class_name_node,
         string $fq_class_name,
-        ?string $calling_method_id,
+        ?string $calling_function_id,
         bool $force_change = false,
         bool $was_self = false
     ) : bool {
@@ -1037,10 +1037,10 @@ class ClassLikes
         // if we're inside a moved class static method
         if ($codebase->methods_to_move
             && $calling_fq_class_name
-            && $calling_method_id
-            && isset($codebase->methods_to_move[strtolower($calling_method_id)])
+            && $calling_function_id
+            && isset($codebase->methods_to_move[strtolower($calling_function_id)])
         ) {
-            $destination_class = explode('::', $codebase->methods_to_move[strtolower($calling_method_id)])[0];
+            $destination_class = explode('::', $codebase->methods_to_move[strtolower($calling_function_id)])[0];
 
             $intended_fq_class_name = strtolower($calling_fq_class_name) === strtolower($fq_class_name)
                 && isset($codebase->classes_to_move[strtolower($calling_fq_class_name)])
@@ -1208,7 +1208,7 @@ class ClassLikes
         \Psalm\StatementsSource $source,
         Type\Union $type,
         CodeLocation $type_location,
-        ?string $calling_method_id
+        ?string $calling_function_id
     ) : void {
         $calling_fq_class_name = $source->getFQCLN();
 
@@ -1217,12 +1217,12 @@ class ClassLikes
         // if we're inside a moved class static method
         if ($codebase->methods_to_move
             && $calling_fq_class_name
-            && $calling_method_id
-            && isset($codebase->methods_to_move[strtolower($calling_method_id)])
+            && $calling_function_id
+            && isset($codebase->methods_to_move[strtolower($calling_function_id)])
         ) {
             $bounds = $type_location->getSelectionBounds();
 
-            $destination_class = explode('::', $codebase->methods_to_move[strtolower($calling_method_id)])[0];
+            $destination_class = explode('::', $codebase->methods_to_move[strtolower($calling_function_id)])[0];
 
             $this->airliftClassDefinedDocblockType(
                 $type,
diff --git a/src/Psalm/Internal/Codebase/Methods.php b/src/Psalm/Internal/Codebase/Methods.php
index 18321663f..6c694a4b6 100644
--- a/src/Psalm/Internal/Codebase/Methods.php
+++ b/src/Psalm/Internal/Codebase/Methods.php
@@ -85,14 +85,14 @@ class Methods
      * Whether or not a given method exists
      *
      * @param  string       $method_id
-     * @param  ?string      $calling_method_id
+     * @param  ?string      $calling_function_id
      * @param  CodeLocation|null $code_location
      *
      * @return bool
      */
     public function methodExists(
         $method_id,
-        $calling_method_id = null,
+        $calling_function_id = null,
         CodeLocation $code_location = null,
         StatementsSource $source = null,
         string $file_path = null
@@ -116,8 +116,8 @@ class Methods
             }
         }
 
-        if ($calling_method_id) {
-            $calling_method_id = strtolower($calling_method_id);
+        if ($calling_function_id) {
+            $calling_function_id = strtolower($calling_function_id);
         }
 
         $old_method_id = null;
@@ -135,7 +135,7 @@ class Methods
 
             $declaring_method_id_lc = strtolower($declaring_method_id);
 
-            if ($calling_method_id === $declaring_method_id_lc) {
+            if ($calling_function_id === $declaring_method_id_lc) {
                 return true;
             }
 
@@ -146,9 +146,9 @@ class Methods
                 && isset($class_storage->potential_declaring_method_ids[$method_name])
             ) {
                 foreach ($class_storage->potential_declaring_method_ids[$method_name] as $potential_id => $_) {
-                    if ($calling_method_id) {
+                    if ($calling_function_id) {
                         $this->file_reference_provider->addMethodReferenceToClassMember(
-                            $calling_method_id,
+                            $calling_function_id,
                             $potential_id
                         );
                     } elseif ($file_path) {
@@ -159,9 +159,9 @@ class Methods
                     }
                 }
             } else {
-                if ($calling_method_id) {
+                if ($calling_function_id) {
                     $this->file_reference_provider->addMethodReferenceToClassMember(
-                        $calling_method_id,
+                        $calling_function_id,
                         $declaring_method_id_lc
                     );
                 } elseif ($file_path) {
@@ -189,9 +189,9 @@ class Methods
                     );
                 }
 
-                if ($calling_method_id) {
+                if ($calling_function_id) {
                     $this->file_reference_provider->addMethodReferenceToClassMember(
-                        $calling_method_id,
+                        $calling_function_id,
                         $interface_method_id_lc
                     );
                 } elseif ($file_path) {
@@ -217,10 +217,10 @@ class Methods
                         );
                     }
 
-                    if ($calling_method_id) {
+                    if ($calling_function_id) {
                         // also store failures in case the method is added later
                         $this->file_reference_provider->addMethodReferenceToClassMember(
-                            $calling_method_id,
+                            $calling_function_id,
                             strtolower($overridden_method_id)
                         );
                     } elseif ($file_path) {
@@ -255,10 +255,10 @@ class Methods
         foreach ($class_storage->parent_classes + $class_storage->used_traits as $potential_future_declaring_fqcln) {
             $potential_id = strtolower($potential_future_declaring_fqcln) . '::' . $method_name;
 
-            if ($calling_method_id) {
+            if ($calling_function_id) {
                 // also store failures in case the method is added later
                 $this->file_reference_provider->addMethodReferenceToMissingClassMember(
-                    $calling_method_id,
+                    $calling_function_id,
                     $potential_id
                 );
             } elseif ($file_path) {
@@ -269,10 +269,10 @@ class Methods
             }
         }
 
-        if ($calling_method_id) {
+        if ($calling_function_id) {
             // also store failures in case the method is added later
             $this->file_reference_provider->addMethodReferenceToMissingClassMember(
-                $calling_method_id,
+                $calling_function_id,
                 strtolower($method_id)
             );
         } elseif ($file_path) {
diff --git a/src/Psalm/Internal/Codebase/Properties.php b/src/Psalm/Internal/Codebase/Properties.php
index bb4f9a9f9..5c2c14e65 100644
--- a/src/Psalm/Internal/Codebase/Properties.php
+++ b/src/Psalm/Internal/Codebase/Properties.php
@@ -99,9 +99,9 @@ class Properties
         if (isset($class_storage->declaring_property_ids[$property_name])) {
             $declaring_property_class = $class_storage->declaring_property_ids[$property_name];
 
-            if ($context && $context->calling_method_id) {
+            if ($context && $context->calling_function_id) {
                 $this->file_reference_provider->addMethodReferenceToClassMember(
-                    $context->calling_method_id,
+                    $context->calling_function_id,
                     strtolower($declaring_property_class) . '::$' . $property_name
                 );
             } elseif ($source) {
@@ -121,9 +121,9 @@ class Properties
             return true;
         }
 
-        if ($context && $context->calling_method_id) {
+        if ($context && $context->calling_function_id) {
             $this->file_reference_provider->addMethodReferenceToMissingClassMember(
-                $context->calling_method_id,
+                $context->calling_function_id,
                 strtolower($fq_class_name) . '::$' . $property_name
             );
         } elseif ($source) {
diff --git a/src/Psalm/Internal/Provider/FileReferenceProvider.php b/src/Psalm/Internal/Provider/FileReferenceProvider.php
index 2cd6d43a0..7950f4d43 100644
--- a/src/Psalm/Internal/Provider/FileReferenceProvider.php
+++ b/src/Psalm/Internal/Provider/FileReferenceProvider.php
@@ -570,24 +570,24 @@ class FileReferenceProvider
     /**
      * @return void
      */
-    public function addMethodReferenceToClassMember(string $calling_method_id, string $referenced_member_id)
+    public function addMethodReferenceToClassMember(string $calling_function_id, string $referenced_member_id)
     {
         if (!isset(self::$method_references_to_class_members[$referenced_member_id])) {
-            self::$method_references_to_class_members[$referenced_member_id] = [$calling_method_id => true];
+            self::$method_references_to_class_members[$referenced_member_id] = [$calling_function_id => true];
         } else {
-            self::$method_references_to_class_members[$referenced_member_id][$calling_method_id] = true;
+            self::$method_references_to_class_members[$referenced_member_id][$calling_function_id] = true;
         }
     }
 
     /**
      * @return void
      */
-    public function addMethodReferenceToMissingClassMember(string $calling_method_id, string $referenced_member_id)
+    public function addMethodReferenceToMissingClassMember(string $calling_function_id, string $referenced_member_id)
     {
         if (!isset(self::$method_references_to_missing_class_members[$referenced_member_id])) {
-            self::$method_references_to_missing_class_members[$referenced_member_id] = [$calling_method_id => true];
+            self::$method_references_to_missing_class_members[$referenced_member_id] = [$calling_function_id => true];
         } else {
-            self::$method_references_to_missing_class_members[$referenced_member_id][$calling_method_id] = true;
+            self::$method_references_to_missing_class_members[$referenced_member_id][$calling_function_id] = true;
         }
     }
 
diff --git a/src/Psalm/Internal/Provider/ReturnTypeProvider/ArrayMapReturnTypeProvider.php b/src/Psalm/Internal/Provider/ReturnTypeProvider/ArrayMapReturnTypeProvider.php
index 1167f76f8..9bcf5b181 100644
--- a/src/Psalm/Internal/Provider/ReturnTypeProvider/ArrayMapReturnTypeProvider.php
+++ b/src/Psalm/Internal/Provider/ReturnTypeProvider/ArrayMapReturnTypeProvider.php
@@ -152,7 +152,7 @@ class ArrayMapReturnTypeProvider implements \Psalm\Plugin\Hook\FunctionReturnTyp
 
                                 if (!$codebase->methods->methodExists(
                                     $mapping_function_id_part,
-                                    $context->calling_method_id,
+                                    $context->calling_function_id,
                                     $codebase->collect_references
                                         ? new CodeLocation(
                                             $statements_source,
diff --git a/src/Psalm/Internal/Provider/ReturnTypeProvider/ArrayReduceReturnTypeProvider.php b/src/Psalm/Internal/Provider/ReturnTypeProvider/ArrayReduceReturnTypeProvider.php
index fecd49165..72f765f77 100644
--- a/src/Psalm/Internal/Provider/ReturnTypeProvider/ArrayReduceReturnTypeProvider.php
+++ b/src/Psalm/Internal/Provider/ReturnTypeProvider/ArrayReduceReturnTypeProvider.php
@@ -222,7 +222,7 @@ class ArrayReduceReturnTypeProvider implements \Psalm\Plugin\Hook\FunctionReturn
 
                             if (!$codebase->methods->methodExists(
                                 $mapping_function_id_part,
-                                $context->calling_method_id,
+                                $context->calling_function_id,
                                 $codebase->collect_references
                                     ? new CodeLocation(
                                         $statements_source,
diff --git a/src/Psalm/Internal/Type/TemplateResult.php b/src/Psalm/Internal/Type/TemplateResult.php
index 86c5458a4..239f697d5 100644
--- a/src/Psalm/Internal/Type/TemplateResult.php
+++ b/src/Psalm/Internal/Type/TemplateResult.php
@@ -7,18 +7,18 @@ use Psalm\Type\Union;
 class TemplateResult
 {
     /**
-     * @var array<string, array<string, array{0: Union}>>
+     * @var array<string, array<non-empty-string, array{0: Union}>>
      */
     public $template_types;
 
     /**
-     * @var array<string, array<string, array{0: Union, 1?: int}>>
+     * @var array<string, array<non-empty-string, array{0: Union, 1?: int}>>
      */
     public $generic_params;
 
     /**
-     * @param  array<string, array<string, array{0: Union}>> $template_types
-     * @param  array<string, array<string, array{0: Union, 1?: int}>> $generic_params
+     * @param  array<string, array<non-empty-string, array{0: Union}>> $template_types
+     * @param  array<string, array<non-empty-string, array{0: Union, 1?: int}>> $generic_params
      */
     public function __construct(array $template_types, array $generic_params)
     {
diff --git a/src/Psalm/Internal/Type/UnionTemplateHandler.php b/src/Psalm/Internal/Type/UnionTemplateHandler.php
index dbb3d799a..837bb57c7 100644
--- a/src/Psalm/Internal/Type/UnionTemplateHandler.php
+++ b/src/Psalm/Internal/Type/UnionTemplateHandler.php
@@ -99,7 +99,7 @@ class UnionTemplateHandler
         }
 
         if ($atomic_type instanceof Atomic\TTemplateParam
-            && isset($template_result->template_types[$atomic_type->param_name][$atomic_type->defining_class ?: ''])
+            && isset($template_result->template_types[$atomic_type->param_name][$atomic_type->defining_class])
         ) {
             $a = self::handleTemplateParamStandin(
                 $atomic_type,
@@ -138,13 +138,15 @@ class UnionTemplateHandler
 
                 $include_first = true;
 
-                if (isset($template_result->template_types[$atomic_type->array_param_name][$atomic_type->defining_class ?: ''])
-                    && isset($template_result->generic_params[$atomic_type->offset_param_name][''])
+                if (isset($template_result->template_types[$atomic_type->array_param_name][$atomic_type->defining_class])
+                    && !empty($template_result->generic_params[$atomic_type->offset_param_name])
                 ) {
                     $array_template_type
-                        = $template_result->template_types[$atomic_type->array_param_name][$atomic_type->defining_class ?: ''][0];
+                        = $template_result->template_types[$atomic_type->array_param_name][$atomic_type->defining_class][0];
                     $offset_template_type
-                        = $template_result->generic_params[$atomic_type->offset_param_name][''][0];
+                        = array_values(
+                            $template_result->generic_params[$atomic_type->offset_param_name]
+                        )[0][0];
 
                     if ($array_template_type->isSingle()
                         && $offset_template_type->isSingle()
@@ -187,9 +189,9 @@ class UnionTemplateHandler
 
                 $include_first = true;
 
-                if (isset($template_result->template_types[$atomic_type->param_name][$atomic_type->defining_class ?: ''])) {
+                if (isset($template_result->template_types[$atomic_type->param_name][$atomic_type->defining_class])) {
                     $template_type
-                        = $template_result->template_types[$atomic_type->param_name][$atomic_type->defining_class ?: ''][0];
+                        = $template_result->template_types[$atomic_type->param_name][$atomic_type->defining_class][0];
 
                     if ($template_type->isSingle()) {
                         $template_type = array_values($template_type->getTypes())[0];
@@ -397,9 +399,9 @@ class UnionTemplateHandler
 
                     // @codingStandardsIgnoreStart
                     if ($replacement_atomic_type instanceof Atomic\TTemplateKeyOf
-                        && isset($template_result->template_types[$replacement_atomic_type->param_name][$replacement_atomic_type->defining_class ?: ''][0])
+                        && isset($template_result->template_types[$replacement_atomic_type->param_name][$replacement_atomic_type->defining_class][0])
                     ) {
-                        $keyed_template = $template_result->template_types[$replacement_atomic_type->param_name][$replacement_atomic_type->defining_class ?: ''][0];
+                        $keyed_template = $template_result->template_types[$replacement_atomic_type->param_name][$replacement_atomic_type->defining_class][0];
 
                         if ($keyed_template->isSingle()) {
                             $keyed_template = array_values($keyed_template->getTypes())[0];
@@ -566,12 +568,12 @@ class UnionTemplateHandler
                 $generic_param = new Union($valid_input_atomic_types);
                 $generic_param->setFromDocblock();
 
-                $template_result->generic_params[$atomic_type->param_name][$atomic_type->defining_class ?: ''] = [
+                $template_result->generic_params[$atomic_type->param_name][$atomic_type->defining_class] = [
                     $generic_param,
                     $depth,
                 ];
             } elseif ($was_single) {
-                $template_result->generic_params[$atomic_type->param_name][$atomic_type->defining_class ?: ''] = [
+                $template_result->generic_params[$atomic_type->param_name][$atomic_type->defining_class] = [
                     \Psalm\Type::getMixed(),
                     $depth,
                 ];
diff --git a/src/Psalm/Internal/Visitor/ReflectorVisitor.php b/src/Psalm/Internal/Visitor/ReflectorVisitor.php
index 7d617412d..6603207b4 100644
--- a/src/Psalm/Internal/Visitor/ReflectorVisitor.php
+++ b/src/Psalm/Internal/Visitor/ReflectorVisitor.php
@@ -2194,7 +2194,7 @@ class ReflectorVisitor extends PhpParser\NodeVisitorAbstract implements PhpParse
                     $storage->has_docblock_issues = true;
                 } else {
                     $storage->template_types[$template_name] = [
-                        '' => [$template_type],
+                        'fn-' . strtolower($cased_function_id) => [$template_type],
                     ];
                 }
 
@@ -2417,7 +2417,7 @@ class ReflectorVisitor extends PhpParser\NodeVisitorAbstract implements PhpParse
                                     ? (string)$template_type
                                     : 'object',
                                 $template_atomic_type,
-                                $template_class
+                                $template_class ?: 'fn-' . strtolower($cased_function_id)
                             ),
                         ]);
 
diff --git a/src/Psalm/Storage/Assertion.php b/src/Psalm/Storage/Assertion.php
index ce5229afb..70f5e16ff 100644
--- a/src/Psalm/Storage/Assertion.php
+++ b/src/Psalm/Storage/Assertion.php
@@ -51,7 +51,13 @@ class Assertion
                                 foreach ($template_type_map[$rule_token[0]] as list($type)) {
                                     $substitute = true;
 
-                                    $rule_token[0] = $type->getKey();
+                                    $first_type = \array_values($type->getTypes())[0];
+
+                                    if ($first_type instanceof \Psalm\Type\Atomic\TTemplateParam) {
+                                        $rule_token[0] = $first_type->param_name;
+                                    } else {
+                                        $rule_token[0] = $first_type->getKey();
+                                    }
                                 }
                             }
                         }
diff --git a/src/Psalm/Type.php b/src/Psalm/Type.php
index 1267a44ab..994e0ec3c 100644
--- a/src/Psalm/Type.php
+++ b/src/Psalm/Type.php
@@ -690,7 +690,9 @@ abstract class Type
 
             $array_defining_class = array_keys($template_type_map[$array_param_name])[0];
 
-            if ($offset_defining_class !== $array_defining_class) {
+            if ($offset_defining_class !== $array_defining_class
+                && substr($offset_defining_class, 0, 3) !== 'fn-'
+            ) {
                 throw new TypeParseTreeException('Template params are defined in different locations');
             }
 
@@ -762,7 +764,7 @@ abstract class Type
     private static function getGenericParamClass(
         string $param_name,
         Union $as,
-        string $defining_class = null
+        string $defining_class
     ) : Atomic\TTemplateParamClass {
         if ($as->hasMixed()) {
             return new Atomic\TTemplateParamClass(
diff --git a/src/Psalm/Type/Atomic/CallableTrait.php b/src/Psalm/Type/Atomic/CallableTrait.php
index 2eaab7b82..95a04a3fa 100644
--- a/src/Psalm/Type/Atomic/CallableTrait.php
+++ b/src/Psalm/Type/Atomic/CallableTrait.php
@@ -224,7 +224,7 @@ trait CallableTrait
                     $template_result,
                     $codebase,
                     $input_param_type,
-                    null,
+                    $calling_class,
                     $replace,
                     !$add_upper_bound,
                     $depth
@@ -241,7 +241,7 @@ trait CallableTrait
                 $template_result,
                 $codebase,
                 $input_type->return_type,
-                null,
+                $calling_class,
                 $replace,
                 $add_upper_bound
             );
diff --git a/src/Psalm/Type/Atomic/TTemplateIndexedAccess.php b/src/Psalm/Type/Atomic/TTemplateIndexedAccess.php
index db5e5f1da..9016fc21a 100644
--- a/src/Psalm/Type/Atomic/TTemplateIndexedAccess.php
+++ b/src/Psalm/Type/Atomic/TTemplateIndexedAccess.php
@@ -14,14 +14,17 @@ class TTemplateIndexedAccess extends \Psalm\Type\Atomic
     public $offset_param_name;
 
     /**
-     * @var ?string
+     * @var non-empty-string
      */
     public $defining_class;
 
+    /**
+     * @param non-empty-string $defining_class
+     */
     public function __construct(
         string $array_param_name,
         string $offset_param_name,
-        ?string $defining_class
+        string $defining_class
     ) {
         $this->array_param_name = $array_param_name;
         $this->offset_param_name = $offset_param_name;
diff --git a/src/Psalm/Type/Atomic/TTemplateKeyOf.php b/src/Psalm/Type/Atomic/TTemplateKeyOf.php
index e4b27688e..69b101e71 100644
--- a/src/Psalm/Type/Atomic/TTemplateKeyOf.php
+++ b/src/Psalm/Type/Atomic/TTemplateKeyOf.php
@@ -9,13 +9,16 @@ class TTemplateKeyOf extends TArrayKey
     public $param_name;
 
     /**
-     * @var ?string
+     * @var non-empty-string
      */
     public $defining_class;
 
+    /**
+     * @param non-empty-string $defining_class
+     */
     public function __construct(
         string $param_name,
-        ?string $defining_class
+        string $defining_class
     ) {
         $this->param_name = $param_name;
         $this->defining_class = $defining_class;
diff --git a/src/Psalm/Type/Atomic/TTemplateParam.php b/src/Psalm/Type/Atomic/TTemplateParam.php
index b8db26e48..af1ce9d4e 100644
--- a/src/Psalm/Type/Atomic/TTemplateParam.php
+++ b/src/Psalm/Type/Atomic/TTemplateParam.php
@@ -24,14 +24,14 @@ class TTemplateParam extends \Psalm\Type\Atomic
     public $as;
 
     /**
-     * @var ?string
+     * @var string
      */
     public $defining_class;
 
     /**
      * @param string $param_name
      */
-    public function __construct($param_name, Union $extends, string $defining_class = null)
+    public function __construct($param_name, Union $extends, string $defining_class)
     {
         $this->param_name = $param_name;
         $this->as = $extends;
@@ -166,7 +166,10 @@ class TTemplateParam extends \Psalm\Type\Atomic
             return;
         }
 
-        if ($prevent_template_covariance && $this->defining_class) {
+        if ($prevent_template_covariance
+            && $this->defining_class
+            && \substr($this->defining_class, 0, 3) !== 'fn-'
+        ) {
             $codebase = $source->getCodebase();
 
             $class_storage = $codebase->classlike_storage_provider->get($this->defining_class);
diff --git a/src/Psalm/Type/Atomic/TTemplateParamClass.php b/src/Psalm/Type/Atomic/TTemplateParamClass.php
index 422d3778a..e4be300c3 100644
--- a/src/Psalm/Type/Atomic/TTemplateParamClass.php
+++ b/src/Psalm/Type/Atomic/TTemplateParamClass.php
@@ -19,18 +19,19 @@ class TTemplateParamClass extends TClassString
     public $as_type;
 
     /**
-     * @var ?string
+     * @var non-empty-string
      */
     public $defining_class;
 
     /**
+     * @param non-empty-string $defining_class
      * @param string $param_name
      */
     public function __construct(
         string $param_name,
-        string $as = 'object',
-        TNamedObject $as_type = null,
-        string $defining_class = null
+        string $as,
+        ?TNamedObject $as_type,
+        string $defining_class
     ) {
         $this->param_name = $param_name;
         $this->as = $as;
diff --git a/src/Psalm/Type/Union.php b/src/Psalm/Type/Union.php
index 747e0af09..65f1506d0 100644
--- a/src/Psalm/Type/Union.php
+++ b/src/Psalm/Type/Union.php
@@ -1170,8 +1170,8 @@ class Union
                     }
                 }
             } elseif ($atomic_type instanceof Type\Atomic\TTemplateParamClass) {
-                $template_type = isset($template_types[$atomic_type->param_name][$atomic_type->defining_class ?: ''])
-                    ? clone $template_types[$atomic_type->param_name][$atomic_type->defining_class ?: ''][0]
+                $template_type = isset($template_types[$atomic_type->param_name][$atomic_type->defining_class])
+                    ? clone $template_types[$atomic_type->param_name][$atomic_type->defining_class][0]
                     : Type::getMixed();
 
                 foreach ($template_type->types as $template_type_part) {
@@ -1197,13 +1197,15 @@ class Union
 
                 $template_type = null;
 
-                if (isset($template_types[$atomic_type->array_param_name][$atomic_type->defining_class ?: ''])
-                    && isset($template_types[$atomic_type->offset_param_name][''])
+                if (isset($template_types[$atomic_type->array_param_name][$atomic_type->defining_class])
+                    && !empty($template_types[$atomic_type->offset_param_name])
                 ) {
                     $array_template_type
-                        = $template_types[$atomic_type->array_param_name][$atomic_type->defining_class ?: ''][0];
+                        = $template_types[$atomic_type->array_param_name][$atomic_type->defining_class][0];
                     $offset_template_type
-                        = $template_types[$atomic_type->offset_param_name][''][0];
+                        = array_values(
+                            $template_types[$atomic_type->offset_param_name]
+                        )[0][0];
 
                     if ($array_template_type->isSingle()
                         && $offset_template_type->isSingle()
diff --git a/tests/Template/FunctionTemplateTest.php b/tests/Template/FunctionTemplateTest.php
index 9e861edc1..d3ab3e197 100644
--- a/tests/Template/FunctionTemplateTest.php
+++ b/tests/Template/FunctionTemplateTest.php
@@ -878,6 +878,20 @@ class FunctionTemplateTest extends TestCase
                        return $v;
                     }'
             ],
+            'uasortCallable' => [
+                '<?php
+                    /**
+                     * @template T of object
+                     * @psalm-param array<T> $collection
+                     * @psalm-param callable(T, T): int $sorter
+                     * @psalm-return array<T>
+                     */
+                    function order(array $collection, callable $sorter): array {
+                        usort($collection, $sorter);
+
+                        return $collection;
+                    }'
+            ],
         ];
     }
 
diff --git a/tests/TypeParseTest.php b/tests/TypeParseTest.php
index 0782a71a2..b8f60075d 100644
--- a/tests/TypeParseTest.php
+++ b/tests/TypeParseTest.php
@@ -784,7 +784,7 @@ class TypeParseTest extends TestCase
                 null,
                 [
                     'T' => ['' => [Type::getArray()]],
-                    'K' => ['' => [new Type\Union([new Type\Atomic\TTemplateKeyOf('T', null)])]],
+                    'K' => ['' => [new Type\Union([new Type\Atomic\TTemplateKeyOf('T', 'fn-foo')])]],
                 ]
             )
         );
