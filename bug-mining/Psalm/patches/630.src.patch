diff --git a/src/Psalm/Internal/Analyzer/Statements/Block/ForeachAnalyzer.php b/src/Psalm/Internal/Analyzer/Statements/Block/ForeachAnalyzer.php
index 4533cd371..727063ecc 100644
--- a/src/Psalm/Internal/Analyzer/Statements/Block/ForeachAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/Statements/Block/ForeachAnalyzer.php
@@ -64,7 +64,8 @@ class ForeachAnalyzer
                 $var_comments = CommentAnalyzer::getTypeFromComment(
                     $doc_comment,
                     $statements_analyzer->getSource(),
-                    $statements_analyzer->getSource()->getAliases()
+                    $statements_analyzer->getSource()->getAliases(),
+                    $statements_analyzer->getTemplateTypeMap() ?: []
                 );
             } catch (DocblockParseException $e) {
                 if (IssueBuffer::accepts(
diff --git a/tests/Template/ClassTemplateTest.php b/tests/Template/ClassTemplateTest.php
index aa196682f..e54b532bd 100644
--- a/tests/Template/ClassTemplateTest.php
+++ b/tests/Template/ClassTemplateTest.php
@@ -2611,6 +2611,50 @@ class ClassTemplateTest extends TestCase
                         }
                     }'
             ],
+            'noCrashTemplateInsideGenerator' => [
+                '<?php
+                    namespace Foo;
+
+                    /**
+                     * @template T
+                     */
+                    final class Set
+                    {
+                        /** @var \Iterator<T> */
+                        private \Iterator $values;
+
+                        /**
+                         * @param \Iterator<T> $values
+                         */
+                        public function __construct(\Iterator $values)
+                        {
+                            $this->values = $values;
+                        }
+
+                        /**
+                         * @param T $element
+                         *
+                         * @return self<T>
+                         */
+                        public function __invoke($element): self
+                        {
+                            return new self(
+                                (
+                                    function($values, $element): \Generator {
+                                        /** @var T $value */
+                                        foreach ($values as $value) {
+                                            yield $value;
+                                        }
+
+                                        yield $element;
+                                    }
+                                )($this->values, $element),
+                            );
+                        }
+                    }',
+                [],
+                ['MissingClosureParamType']
+            ],
         ];
     }
 
