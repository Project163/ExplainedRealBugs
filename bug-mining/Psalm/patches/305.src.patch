diff --git a/src/Psalm/Internal/Analyzer/ClassAnalyzer.php b/src/Psalm/Internal/Analyzer/ClassAnalyzer.php
index daebd11fb..1ed32a93a 100644
--- a/src/Psalm/Internal/Analyzer/ClassAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/ClassAnalyzer.php
@@ -1704,11 +1704,35 @@ class ClassAnalyzer extends ClassLikeAnalyzer
                 $class_storage = $codebase->classlike_storage_provider->get($declaring_class_name);
             }
 
+            if ($class_storage->template_types) {
+                $template_params = [];
+
+                foreach ($class_storage->template_types as $param_name => $template_map) {
+                    $key = array_keys($template_map)[0];
+
+                    $template_params[] = new Type\Union([
+                        new Type\Atomic\TTemplateParam(
+                            $param_name,
+                            reset($template_map)[0],
+                            $key
+                        )
+                    ]);
+                }
+
+                $this_object_type = new Type\Atomic\TGenericObject(
+                    $original_fq_classlike_name,
+                    $template_params
+                );
+            } else {
+                $this_object_type = new Type\Atomic\TNamedObject($original_fq_classlike_name);
+            }
+
             $class_template_params = Statements\Expression\Call\MethodCallAnalyzer::getClassTemplateParams(
                 $codebase,
                 $class_storage,
                 $original_fq_classlike_name,
-                strtolower($stmt->name->name)
+                strtolower($stmt->name->name),
+                $this_object_type
             ) ?: [];
 
             $template_result = new \Psalm\Internal\Type\TemplateResult(
diff --git a/src/Psalm/Internal/Analyzer/FunctionLikeAnalyzer.php b/src/Psalm/Internal/Analyzer/FunctionLikeAnalyzer.php
index e4ecb815a..0df25ed69 100644
--- a/src/Psalm/Internal/Analyzer/FunctionLikeAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/FunctionLikeAnalyzer.php
@@ -169,6 +169,9 @@ abstract class FunctionLikeAnalyzer extends SourceAnalyzer implements Statements
 
             $method_id = (string)$this->getMethodId($context->self);
 
+            $fq_class_name = (string)$context->self;
+            $class_storage = $classlike_storage_provider->get($fq_class_name);
+
             if ($add_mutations) {
                 $hash = md5($real_method_id . '::' . $context->getScopeSummary());
 
@@ -177,7 +180,30 @@ abstract class FunctionLikeAnalyzer extends SourceAnalyzer implements Statements
                     return null;
                 }
             } elseif ($context->self) {
-                $context->vars_in_scope['$this'] = new Type\Union([new TNamedObject($context->self)]);
+                if ($class_storage->template_types) {
+                    $template_params = [];
+
+                    foreach ($class_storage->template_types as $param_name => $template_map) {
+                        $key = array_keys($template_map)[0];
+
+                        $template_params[] = new Type\Union([
+                            new Type\Atomic\TTemplateParam(
+                                $param_name,
+                                reset($template_map)[0],
+                                $key
+                            )
+                        ]);
+                    }
+
+                    $this_object_type = new Type\Atomic\TGenericObject(
+                        $context->self,
+                        $template_params
+                    );
+                } else {
+                    $this_object_type = new TNamedObject($context->self);
+                }
+
+                $context->vars_in_scope['$this'] = new Type\Union([$this_object_type]);
 
                 if ($storage->external_mutation_free
                     && !$storage->mutation_free_inferred
@@ -192,10 +218,6 @@ abstract class FunctionLikeAnalyzer extends SourceAnalyzer implements Statements
                 $context->vars_possibly_in_scope['$this'] = true;
             }
 
-            $fq_class_name = (string)$context->self;
-
-            $class_storage = $classlike_storage_provider->get($fq_class_name);
-
             if ($class_storage->has_visitor_issues) {
                 return null;
             }
diff --git a/src/Psalm/Internal/Analyzer/Statements/Expression/Assignment/ArrayAssignmentAnalyzer.php b/src/Psalm/Internal/Analyzer/Statements/Expression/Assignment/ArrayAssignmentAnalyzer.php
index 4880b88fb..b61c75625 100644
--- a/src/Psalm/Internal/Analyzer/Statements/Expression/Assignment/ArrayAssignmentAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/Statements/Expression/Assignment/ArrayAssignmentAnalyzer.php
@@ -6,6 +6,8 @@ use Psalm\Internal\Analyzer\Statements\Expression\Fetch\ArrayFetchAnalyzer;
 use Psalm\Internal\Analyzer\Statements\ExpressionAnalyzer;
 use Psalm\Internal\Analyzer\StatementsAnalyzer;
 use Psalm\Context;
+use Psalm\IssueBuffer;
+use Psalm\Issue\InvalidArrayAssignment;
 use Psalm\Type;
 use Psalm\Type\Atomic\ObjectLike;
 use Psalm\Type\Atomic\TArray;
@@ -584,6 +586,25 @@ class ArrayAssignmentAnalyzer
             $context->vars_in_scope[$root_var_id] = $root_type;
         }
 
+        if ($root_array_expr instanceof PhpParser\Node\Expr\MethodCall
+            || $root_array_expr instanceof PhpParser\Node\Expr\StaticCall
+            || $root_array_expr instanceof PhpParser\Node\Expr\FuncCall
+        ) {
+            if ($root_type->hasArray()) {
+                if (IssueBuffer::accepts(
+                    new InvalidArrayAssignment(
+                        'Assigning to the output of a function has no effect',
+                        new \Psalm\CodeLocation($statements_analyzer->getSource(), $root_array_expr)
+                    ),
+                    $statements_analyzer->getSuppressedIssues()
+                )
+                ) {
+                    // do nothing
+                }
+            }
+
+        }
+
         return null;
     }
 }
diff --git a/src/Psalm/Internal/Analyzer/Statements/Expression/Call/MethodCallAnalyzer.php b/src/Psalm/Internal/Analyzer/Statements/Expression/Call/MethodCallAnalyzer.php
index 450f05fd7..ab73af488 100644
--- a/src/Psalm/Internal/Analyzer/Statements/Expression/Call/MethodCallAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/Statements/Expression/Call/MethodCallAnalyzer.php
@@ -50,6 +50,7 @@ use function array_search;
 use function array_keys;
 use function in_array;
 use Psalm\Internal\Taint\Source;
+use Doctrine\Instantiator\Exception\UnexpectedValueException;
 
 /**
  * @internal
@@ -1499,6 +1500,8 @@ class MethodCallAnalyzer extends \Psalm\Internal\Analyzer\Statements\Expression\
 
         $template_types = $class_storage->template_types;
 
+        $candidate_class_storages = [$class_storage];
+
         if ($calling_class_storage->template_type_extends
             && $method_name
             && !empty($non_trait_class_storage->overridden_method_ids[$method_name])
@@ -1510,24 +1513,35 @@ class MethodCallAnalyzer extends \Psalm\Internal\Analyzer\Statements\Expression\
                 $overridden_storage = $codebase->methods->getStorage($overridden_method_id);
 
                 if (!$overridden_storage->return_type) {
-                    return null;
+                    continue;
                 }
 
                 if ($overridden_storage->return_type->isNull()) {
-                    return null;
+                    continue;
                 }
 
                 list($fq_overridden_class) = explode('::', $overridden_method_id);
 
                 $overridden_class_storage = $codebase->classlike_storage_provider->get($fq_overridden_class);
 
+                $overridden_template_types = $overridden_class_storage->template_types;
+
                 if (!$template_types) {
-                    $template_types = $overridden_class_storage->template_types;
-                } elseif ($overridden_class_storage->template_types) {
-                    $template_types = array_merge($overridden_class_storage->template_types, $template_types);
+                    $template_types = $overridden_template_types;
+                } elseif ($overridden_template_types) {
+                    foreach ($overridden_template_types as $template_name => $template_map) {
+                        if (isset($template_types[$template_name])) {
+                            $template_types[$template_name] = array_merge(
+                                $template_types[$template_name],
+                                $template_map
+                            );
+                        } else {
+                            $template_types[$template_name] = $template_map;
+                        }
+                    }
                 }
 
-                $class_storage = $overridden_class_storage;
+                $candidate_class_storages[] = $overridden_class_storage;
             }
         }
 
@@ -1637,13 +1651,16 @@ class MethodCallAnalyzer extends \Psalm\Internal\Analyzer\Statements\Expression\
 
                 $i++;
             }
-        } else {
-            foreach ($template_types as $type_name => $type_map) {
-                foreach ($type_map as list($type)) {
-                    if ($class_storage !== $calling_class_storage
-                        && isset($e[$class_storage->name][$type_name])
+        }
+
+        foreach ($template_types as $type_name => $type_map) {
+            foreach ($type_map as list($type)) {
+                foreach ($candidate_class_storages as $candidate_class_storage) {
+                    if ($candidate_class_storage !== $calling_class_storage
+                        && isset($e[$candidate_class_storage->name][$type_name])
+                        && !isset($class_template_params[$type_name][$candidate_class_storage->name])
                     ) {
-                        $input_type_extends = $e[$class_storage->name][$type_name];
+                        $input_type_extends = $e[$candidate_class_storage->name][$type_name];
 
                         $output_type_extends = null;
 
@@ -1669,15 +1686,15 @@ class MethodCallAnalyzer extends \Psalm\Internal\Analyzer\Statements\Expression\
                             }
                         }
 
-                        $class_template_params[$type_name][$class_storage->name] = [
-                            $output_type_extends ?: Type::getEmpty()
+                        $class_template_params[$type_name][$candidate_class_storage->name] = [
+                            $output_type_extends ?: Type::getMixed()
                         ];
                     }
+                }
 
-                    if ($lhs_var_id !== '$this') {
-                        if (!isset($class_template_params[$type_name])) {
-                            $class_template_params[$type_name][$class_storage->name] = [$type];
-                        }
+                if ($lhs_var_id !== '$this') {
+                    if (!isset($class_template_params[$type_name])) {
+                        $class_template_params[$type_name][$class_storage->name] = [$type];
                     }
                 }
             }
diff --git a/src/Psalm/Type/Atomic/HasIntersectionTrait.php b/src/Psalm/Type/Atomic/HasIntersectionTrait.php
index 06e3fd62c..79c7936f5 100644
--- a/src/Psalm/Type/Atomic/HasIntersectionTrait.php
+++ b/src/Psalm/Type/Atomic/HasIntersectionTrait.php
@@ -102,6 +102,22 @@ trait HasIntersectionTrait
         $this->extra_types = $new_types;
     }
 
+    /**
+     * @return list<Type\Atomic\TTemplateParam>
+     */
+    public function getIntersectionTemplateTypes() : array
+    {
+        $template_types = [];
+
+        if ($this->extra_types) {
+            foreach ($this->extra_types as $extra_type) {
+                $template_types = \array_merge($template_types, $extra_type->getTemplateTypes());
+            }
+        }
+
+        return $template_types;
+    }
+
     /**
      * @param  StatementsSource $source
      * @param  CodeLocation     $code_location
diff --git a/src/Psalm/Type/Atomic/TNamedObject.php b/src/Psalm/Type/Atomic/TNamedObject.php
index 0f5da9918..d7be5033a 100644
--- a/src/Psalm/Type/Atomic/TNamedObject.php
+++ b/src/Psalm/Type/Atomic/TNamedObject.php
@@ -118,6 +118,14 @@ class TNamedObject extends Atomic
         $this->replaceIntersectionTemplateTypesWithArgTypes($template_types, $codebase);
     }
 
+    /**
+     * @return list<Type\Atomic\TTemplateParam>
+     */
+    public function getTemplateTypes() : array
+    {
+        return $this->getIntersectionTemplateTypes();
+    }
+
     /**
      * @param  StatementsSource $source
      * @param  CodeLocation     $code_location
diff --git a/tests/ArrayAssignmentTest.php b/tests/ArrayAssignmentTest.php
index d38e4f8ac..7e6a459c4 100644
--- a/tests/ArrayAssignmentTest.php
+++ b/tests/ArrayAssignmentTest.php
@@ -1463,6 +1463,17 @@ class ArrayAssignmentTest extends TestCase
                     }',
                 'error_message' => 'InvalidReturnStatement',
             ],
+            'preventArrayAssignmentOnReturnValue' => [
+                '<?php
+                    class A {
+                        public function foo() : array {
+                            return [1, 2, 3];
+                        }
+                    }
+
+                    (new A)->foo()[3] = 5;',
+                'error_message' => 'InvalidArrayAssignment',
+            ],
         ];
     }
 }
diff --git a/tests/Template/ClassTemplateExtendsTest.php b/tests/Template/ClassTemplateExtendsTest.php
index b6ee7a298..979d68be4 100644
--- a/tests/Template/ClassTemplateExtendsTest.php
+++ b/tests/Template/ClassTemplateExtendsTest.php
@@ -1610,6 +1610,54 @@ class ClassTemplateExtendsTest extends TestCase
                         use T;
                     }',
             ],
+            'extendWithEnoughArgs' => [
+                '<?php
+                    /**
+                     * @template TKey of array-key
+                     * @template T
+                     * @template-extends IteratorAggregate<TKey, T>
+                     */
+                    interface Collection extends IteratorAggregate
+                    {
+                    }
+
+                    /**
+                     * @template T
+                     * @template TKey of array-key
+                     * @template-implements Collection<TKey, T>
+                     */
+                    class ArrayCollection implements Collection
+                    {
+                        /**
+                         * @psalm-var array<TKey, T>
+                         */
+                        private $elements;
+
+                        /**
+                         * @psalm-param array<TKey, T> $elements
+                         */
+                        public function __construct(array $elements = [])
+                        {
+                            $this->elements = $elements;
+                        }
+
+                        public function getIterator()
+                        {
+                            return new ArrayIterator($this->elements);
+                        }
+
+                        /**
+                         * @psalm-suppress MissingTemplateParam
+                         *
+                         * @psalm-param array<T> $elements
+                         * @psalm-return ArrayCollection<T>
+                         */
+                        protected function createFrom(array $elements)
+                        {
+                            return new static($elements);
+                        }
+                    }',
+            ],
             'extendWithTooFewArgs' => [
                 '<?php
                     /**
@@ -1712,7 +1760,7 @@ class ClassTemplateExtendsTest extends TestCase
                         }
                     }',
             ],
-            'implementsAndExtendsWithTemplate' => [
+            'implementsAndExtendsWithTemplateReturningValid' => [
                 '<?php
                     /**
                      * @template TReal
@@ -3167,7 +3215,7 @@ class ClassTemplateExtendsTest extends TestCase
                     }',
                 'error_message' => 'InvalidReturnType',
             ],
-            'implementsAndExtendsWithTemplate' => [
+            'implementsAndExtendsWithTemplateReturningInvalid' => [
                 '<?php
                     /**
                      * @template TReal
@@ -3316,6 +3364,116 @@ class ClassTemplateExtendsTest extends TestCase
                     }',
                 'error_message' => 'InvalidReturnStatement'
             ],
+            'possiblyNullReferenceOnTraitDefinedMethod' => [
+                '<?php
+                    /**
+                     * @template TKey as array-key
+                     * @template TValue
+                     */
+                    trait T1 {
+                        /**
+                         * @var array<TKey, TValue>
+                         */
+                        protected $mocks = [];
+
+                        /**
+                         * @param TKey $offset
+                         * @return TValue|null
+                         * @psalm-suppress LessSpecificImplementedReturnType
+                         * @psalm-suppress ImplementedParamTypeMismatch
+                         */
+                        public function offsetGet($offset) {
+                            return $this->mocks[$offset] ?? null;
+                        }
+                    }
+
+                    /**
+                     * @template TKey as array-key
+                     * @template TValue
+                     */
+                    interface Arr {
+                        /**
+                         * @param TKey $offset
+                         * @return TValue|null
+                         */
+                        public function offsetGet($offset);
+                    }
+
+                    /**
+                     * @template TKey as array-key
+                     * @template TValue
+                     * @implements Arr<TKey, TValue>
+                     */
+                    class C implements Arr {
+                        /** @use T1<TKey, TValue> */
+                        use T1;
+
+                        /**
+                         * @param TKey $offset
+                         * @psalm-suppress MixedMethodCall
+                         */
+                        public function foo($offset) : void {
+                            $this->offsetGet($offset)->bar();
+                        }
+                    }',
+                'error_message' => 'PossiblyNullReference'
+            ],
+            'possiblyNullReferenceOnTraitDefinedMethodExtended' => [
+                '<?php
+                    /**
+                     * @template TKey as array-key
+                     * @template TValue
+                     */
+                    trait T1 {
+                        /**
+                         * @var array<TKey, TValue>
+                         */
+                        protected $mocks = [];
+
+                        /**
+                         * @param TKey $offset
+                         * @return TValue|null
+                         * @psalm-suppress LessSpecificImplementedReturnType
+                         * @psalm-suppress ImplementedParamTypeMismatch
+                         */
+                        public function offsetGet($offset) {
+                            return $this->mocks[$offset] ?? null;
+                        }
+                    }
+
+                    /**
+                     * @template TKey as array-key
+                     * @template TValue
+                     */
+                    interface Arr {
+                        /**
+                         * @param TKey $offset
+                         * @return TValue|null
+                         */
+                        public function offsetGet($offset);
+                    }
+
+                    /**
+                     * @template TKey as array-key
+                     * @template TValue
+                     * @implements Arr<TKey, TValue>
+                     */
+                    class C implements Arr {
+                        /** @use T1<TKey, TValue> */
+                        use T1;
+                    }
+
+                    class D extends C {
+                        /**
+                         * @param mixed $offset
+                         * @psalm-suppress MixedArgument
+                         */
+                        public function foo($offset) : void {
+                            $this->offsetGet($offset)->bar();
+                        }
+                    }',
+                'error_message' => 'MixedMethodCall'
+            ],
         ];
     }
 }
