diff --git a/src/Psalm/Internal/Analyzer/ProjectAnalyzer.php b/src/Psalm/Internal/Analyzer/ProjectAnalyzer.php
index d856ac000..e74f8a706 100644
--- a/src/Psalm/Internal/Analyzer/ProjectAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/ProjectAnalyzer.php
@@ -11,6 +11,7 @@ use Psalm\Internal\Provider\ClassLikeStorageProvider;
 use Psalm\Internal\Provider\FileProvider;
 use Psalm\Internal\Provider\FileReferenceProvider;
 use Psalm\Internal\Provider\ParserCacheProvider;
+use Psalm\Internal\Provider\ProjectCacheProvider;
 use Psalm\Internal\Provider\Providers;
 use Psalm\Issue\InvalidFalsableReturnType;
 use Psalm\Issue\InvalidNullableReturnType;
@@ -117,6 +118,9 @@ class ProjectAnalyzer
     /** @var ?ParserCacheProvider */
     private $parser_cache_provider;
 
+    /** @var ?ProjectCacheProvider */
+    public $project_cache_provider;
+
     /** @var FileReferenceProvider */
     private $file_reference_provider;
 
@@ -229,6 +233,7 @@ class ProjectAnalyzer
         }
 
         $this->parser_cache_provider = $providers->parser_cache_provider;
+        $this->project_cache_provider = $providers->project_cache_provider;
         $this->file_provider = $providers->file_provider;
         $this->classlike_storage_provider = $providers->classlike_storage_provider;
         $this->file_reference_provider = $providers->file_reference_provider;
@@ -262,6 +267,16 @@ class ProjectAnalyzer
             $this->addProjectFile($file_path);
         }
 
+        if ($this->project_cache_provider && $this->project_cache_provider->hasLockfileChanged()) {
+            $this->progress->debug(
+                'Composer lockfile change detected, clearing cache' . "\n"
+            );
+
+            Config::removeCacheDirectory($config->getCacheDirectory());
+
+            $this->project_cache_provider->updateComposerLockHash();
+        }
+
         self::$instance = $this;
     }
 
@@ -475,8 +490,8 @@ class ProjectAnalyzer
 
         if ($is_diff
             && $reference_cache
-            && $this->parser_cache_provider
-            && $this->parser_cache_provider->canDiffFiles()
+            && $this->project_cache_provider
+            && $this->project_cache_provider->canDiffFiles()
         ) {
             $deleted_files = $this->file_reference_provider->getDeletedReferencedFiles();
             $diff_files = $deleted_files;
@@ -553,9 +568,9 @@ class ProjectAnalyzer
             true
         );
 
-        if ($this->parser_cache_provider) {
+        if ($this->project_cache_provider && $this->parser_cache_provider) {
             $removed_parser_files = $this->parser_cache_provider->deleteOldParserCaches(
-                $is_diff ? $this->parser_cache_provider->getLastRun() : $start_checks
+                $is_diff ? $this->project_cache_provider->getLastRun() : $start_checks
             );
 
             if ($removed_parser_files) {
@@ -1009,13 +1024,13 @@ class ProjectAnalyzer
     {
         $file_extensions = $config->getFileExtensions();
 
-        if (!$this->parser_cache_provider) {
+        if (!$this->parser_cache_provider || !$this->project_cache_provider) {
             throw new \UnexpectedValueException('Parser cache provider cannot be null here');
         }
 
         $diff_files = [];
 
-        $last_run = $this->parser_cache_provider->getLastRun();
+        $last_run = $this->project_cache_provider->getLastRun();
 
         $file_paths = $this->file_provider->getFilesInDir($dir_name, $file_extensions);
 
diff --git a/src/Psalm/Internal/Provider/ParserCacheProvider.php b/src/Psalm/Internal/Provider/ParserCacheProvider.php
index b25ad5eec..a274ccc16 100644
--- a/src/Psalm/Internal/Provider/ParserCacheProvider.php
+++ b/src/Psalm/Internal/Provider/ParserCacheProvider.php
@@ -34,12 +34,6 @@ class ParserCacheProvider
     const FILE_HASHES = 'file_hashes_json';
     const PARSER_CACHE_DIRECTORY = 'php-parser';
     const FILE_CONTENTS_CACHE_DIRECTORY = 'file-caches';
-    const GOOD_RUN_NAME = 'good_run';
-
-    /**
-     * @var int|null
-     */
-    private $last_run = null;
 
     /**
      * A map of filename hashes to contents hashes
@@ -334,31 +328,19 @@ class ParserCacheProvider
     }
 
     /**
-     * @return bool
-     */
-    public function canDiffFiles()
-    {
-        $cache_directory = Config::getInstance()->getCacheDirectory();
-
-        return $cache_directory && file_exists($cache_directory . DIRECTORY_SEPARATOR . self::GOOD_RUN_NAME);
-    }
-
-    /**
-     * @param float $start_time
+     * @param  float $time_before
      *
-     * @return void
+     * @return int
      */
-    public function processSuccessfulRun($start_time)
+    public function deleteOldParserCaches($time_before)
     {
         $cache_directory = Config::getInstance()->getCacheDirectory();
 
-        if (!$cache_directory) {
-            return;
+        if ($cache_directory) {
+            return 0;
         }
 
-        $run_cache_location = $cache_directory . DIRECTORY_SEPARATOR . self::GOOD_RUN_NAME;
-
-        touch($run_cache_location, (int)$start_time);
+        $removed_count = 0;
 
         $cache_directory .= DIRECTORY_SEPARATOR . self::PARSER_CACHE_DIRECTORY;
 
@@ -372,44 +354,29 @@ class ParserCacheProvider
                     continue;
                 }
 
-                touch($full_path);
-            }
-        }
-    }
-
-    /**
-     * @return int
-     */
-    public function getLastRun()
-    {
-        if ($this->last_run === null) {
-            $cache_directory = Config::getInstance()->getCacheDirectory();
-
-            if (file_exists($cache_directory . DIRECTORY_SEPARATOR . self::GOOD_RUN_NAME)) {
-                $this->last_run = filemtime($cache_directory . DIRECTORY_SEPARATOR . self::GOOD_RUN_NAME);
-            } else {
-                $this->last_run = 0;
+                if (filemtime($full_path) < $time_before && is_writable($full_path)) {
+                    unlink($full_path);
+                    ++$removed_count;
+                }
             }
         }
 
-        return $this->last_run;
+        return $removed_count;
     }
 
     /**
-     * @param  float $time_before
+     * @param float $start_time
      *
-     * @return int
+     * @return void
      */
-    public function deleteOldParserCaches($time_before)
+    public function processSuccessfulRun()
     {
         $cache_directory = Config::getInstance()->getCacheDirectory();
 
-        if ($cache_directory) {
-            return 0;
+        if (!$cache_directory) {
+            return;
         }
 
-        $removed_count = 0;
-
         $cache_directory .= DIRECTORY_SEPARATOR . self::PARSER_CACHE_DIRECTORY;
 
         if (is_dir($cache_directory)) {
@@ -422,14 +389,9 @@ class ParserCacheProvider
                     continue;
                 }
 
-                if (filemtime($full_path) < $time_before && is_writable($full_path)) {
-                    unlink($full_path);
-                    ++$removed_count;
-                }
+                touch($full_path);
             }
         }
-
-        return $removed_count;
     }
 
     /**
diff --git a/src/Psalm/Internal/Provider/ProjectCacheProvider.php b/src/Psalm/Internal/Provider/ProjectCacheProvider.php
new file mode 100644
index 000000000..23a52da2a
--- /dev/null
+++ b/src/Psalm/Internal/Provider/ProjectCacheProvider.php
@@ -0,0 +1,144 @@
+<?php
+namespace Psalm\Internal\Provider;
+
+use const DIRECTORY_SEPARATOR;
+use function file_exists;
+use function file_get_contents;
+use function file_put_contents;
+use function is_array;
+use function is_readable;
+use Psalm\Internal\Analyzer\IssueData;
+use Psalm\Config;
+use function serialize;
+use function unserialize;
+
+/**
+ * @psalm-type  TaggedCodeType = array<int, array{0: int, 1: string}>
+ */
+/**
+ * Used to determine which files reference other files, necessary for using the --diff
+ * option from the command line.
+ */
+class ProjectCacheProvider
+{
+    const GOOD_RUN_NAME = 'good_run';
+    const COMPOSER_LOCK_HASH = 'composer_lock_hash';
+
+    /**
+     * @var int|null
+     */
+    private $last_run = null;
+
+    /**
+     * @var string|null
+     */
+    private $composer_lock_hash = null;
+
+    private $composer_lock_location;
+
+    public function __construct(string $composer_lock_location)
+    {
+        $this->composer_lock_location = $composer_lock_location;
+    }
+
+    /**
+     * @return bool
+     */
+    public function canDiffFiles()
+    {
+        $cache_directory = Config::getInstance()->getCacheDirectory();
+
+        return $cache_directory && file_exists($cache_directory . DIRECTORY_SEPARATOR . self::GOOD_RUN_NAME);
+    }
+
+    /**
+     * @param float $start_time
+     *
+     * @return void
+     */
+    public function processSuccessfulRun($start_time)
+    {
+        $cache_directory = Config::getInstance()->getCacheDirectory();
+
+        if (!$cache_directory) {
+            return;
+        }
+
+        $run_cache_location = $cache_directory . DIRECTORY_SEPARATOR . self::GOOD_RUN_NAME;
+
+        \touch($run_cache_location, (int)$start_time);
+    }
+
+    /**
+     * @return int
+     */
+    public function getLastRun()
+    {
+        if ($this->last_run === null) {
+            $cache_directory = Config::getInstance()->getCacheDirectory();
+
+            if (file_exists($cache_directory . DIRECTORY_SEPARATOR . self::GOOD_RUN_NAME)) {
+                $this->last_run = \filemtime($cache_directory . DIRECTORY_SEPARATOR . self::GOOD_RUN_NAME);
+            } else {
+                $this->last_run = 0;
+            }
+        }
+
+        return $this->last_run;
+    }
+
+    public function hasLockfileChanged() : bool
+    {
+        if (!file_exists($this->composer_lock_location)) {
+            return true;
+        }
+
+        $lockfile_contents = file_get_contents($this->composer_lock_location);
+
+        if (!$lockfile_contents) {
+            return true;
+        }
+
+        $sha1 = \sha1($lockfile_contents);
+
+        $changed = $sha1 !== $this->getComposerLockHash();
+
+        $this->composer_lock_hash = $sha1;
+
+        return $changed;
+    }
+
+    public function updateComposerLockHash() : void
+    {
+        $cache_directory = Config::getInstance()->getCacheDirectory();
+
+        if (!$cache_directory || !$this->composer_lock_hash) {
+            return;
+        }
+
+        if (!file_exists($cache_directory)) {
+            \mkdir($cache_directory, 0777, true);
+        }
+
+        $lock_hash_location = $cache_directory . DIRECTORY_SEPARATOR . self::COMPOSER_LOCK_HASH;
+
+        file_put_contents($lock_hash_location, $this->composer_lock_hash);
+    }
+
+    protected function getComposerLockHash() : string
+    {
+        if ($this->composer_lock_hash === null) {
+            $cache_directory = Config::getInstance()->getCacheDirectory();
+
+            $lock_hash_location = $cache_directory . DIRECTORY_SEPARATOR . self::COMPOSER_LOCK_HASH;
+
+            if (file_exists($lock_hash_location)) {
+                $this->composer_lock_hash = file_get_contents($lock_hash_location) ?: '';
+            } else {
+                $this->composer_lock_hash = '';
+            }
+        }
+
+        return $this->composer_lock_hash;
+    }
+}
diff --git a/src/Psalm/Internal/Provider/Providers.php b/src/Psalm/Internal/Provider/Providers.php
index 86fefa13b..eba376d9b 100644
--- a/src/Psalm/Internal/Provider/Providers.php
+++ b/src/Psalm/Internal/Provider/Providers.php
@@ -36,15 +36,22 @@ class Providers
      */
     public $file_reference_provider;
 
+    /**
+     * @var ?ProjectCacheProvider
+     */
+    public $project_cache_provider;
+
     public function __construct(
         FileProvider $file_provider,
-        ParserCacheProvider $parser_cache_provider = null,
-        FileStorageCacheProvider $file_storage_cache_provider = null,
-        ClassLikeStorageCacheProvider $classlike_storage_cache_provider = null,
-        FileReferenceCacheProvider $file_reference_cache_provider = null
+        ?ParserCacheProvider $parser_cache_provider = null,
+        ?FileStorageCacheProvider $file_storage_cache_provider = null,
+        ?ClassLikeStorageCacheProvider $classlike_storage_cache_provider = null,
+        ?FileReferenceCacheProvider $file_reference_cache_provider = null,
+        ?ProjectCacheProvider $project_cache_provider = null
     ) {
         $this->file_provider = $file_provider;
         $this->parser_cache_provider = $parser_cache_provider;
+        $this->project_cache_provider = $project_cache_provider;
 
         $this->file_storage_provider = new FileStorageProvider($file_storage_cache_provider);
         $this->classlike_storage_provider = new ClassLikeStorageProvider($classlike_storage_cache_provider);
diff --git a/src/Psalm/IssueBuffer.php b/src/Psalm/IssueBuffer.php
index f5c3d2285..d503b78d7 100644
--- a/src/Psalm/IssueBuffer.php
+++ b/src/Psalm/IssueBuffer.php
@@ -614,8 +614,12 @@ class IssueBuffer
         if ($is_full && $start_time) {
             $codebase->file_reference_provider->removeDeletedFilesFromReferences();
 
+            if ($project_analyzer->project_cache_provider) {
+                $project_analyzer->project_cache_provider->processSuccessfulRun($start_time);
+            }
+
             if ($codebase->statements_provider->parser_cache_provider) {
-                $codebase->statements_provider->parser_cache_provider->processSuccessfulRun($start_time);
+                $codebase->statements_provider->parser_cache_provider->processSuccessfulRun();
             }
         }
 
diff --git a/src/psalm-language-server.php b/src/psalm-language-server.php
index 83eb9e375..0de70d77d 100644
--- a/src/psalm-language-server.php
+++ b/src/psalm-language-server.php
@@ -227,7 +227,8 @@ $providers = new Psalm\Internal\Provider\Providers(
     new Psalm\Internal\Provider\ParserCacheProvider($config),
     new Psalm\Internal\Provider\FileStorageCacheProvider($config),
     new Psalm\Internal\Provider\ClassLikeStorageCacheProvider($config),
-    new Psalm\Internal\Provider\FileReferenceCacheProvider($config)
+    new Psalm\Internal\Provider\FileReferenceCacheProvider($config),
+    new Psalm\Internal\Provider\ProjectCacheProvider($current_dir . DIRECTORY_SEPARATOR . 'composer.lock')
 );
 
 $project_analyzer = new ProjectAnalyzer(
diff --git a/src/psalm-refactor.php b/src/psalm-refactor.php
index 3bc753dcb..75f01de9c 100644
--- a/src/psalm-refactor.php
+++ b/src/psalm-refactor.php
@@ -242,7 +242,9 @@ $providers = new Psalm\Internal\Provider\Providers(
     new Psalm\Internal\Provider\FileProvider(),
     new Psalm\Internal\Provider\ParserCacheProvider($config, false),
     new Psalm\Internal\Provider\FileStorageCacheProvider($config),
-    new Psalm\Internal\Provider\ClassLikeStorageCacheProvider($config)
+    new Psalm\Internal\Provider\ClassLikeStorageCacheProvider($config),
+    null,
+    new Psalm\Internal\Provider\ProjectCacheProvider($current_dir . DIRECTORY_SEPARATOR . 'composer.lock')
 );
 
 $debug = array_key_exists('debug', $options);
diff --git a/src/psalm.php b/src/psalm.php
index 3c9654bb9..6ffd08d8b 100644
--- a/src/psalm.php
+++ b/src/psalm.php
@@ -503,7 +503,8 @@ if (isset($options['no-cache']) || isset($options['i'])) {
         new Provider\ParserCacheProvider($config, !$no_file_cache),
         $file_storage_cache_provider,
         $classlike_storage_cache_provider,
-        new Provider\FileReferenceCacheProvider($config)
+        new Provider\FileReferenceCacheProvider($config),
+        new Provider\ProjectCacheProvider($current_dir . DIRECTORY_SEPARATOR . 'composer.lock')
     );
 }
 
diff --git a/src/psalter.php b/src/psalter.php
index 7b9a272ea..7a62dbf35 100644
--- a/src/psalter.php
+++ b/src/psalter.php
@@ -212,7 +212,9 @@ if (isset($options['no-cache'])) {
         new Psalm\Internal\Provider\FileProvider(),
         new Psalm\Internal\Provider\ParserCacheProvider($config, false),
         new Psalm\Internal\Provider\FileStorageCacheProvider($config),
-        new Psalm\Internal\Provider\ClassLikeStorageCacheProvider($config)
+        new Psalm\Internal\Provider\ClassLikeStorageCacheProvider($config),
+        null,
+        new Psalm\Internal\Provider\ProjectCacheProvider($current_dir . DIRECTORY_SEPARATOR . 'composer.lock')
     );
 }
 
diff --git a/tests/FileUpdates/AnalyzedMethodTest.php b/tests/FileUpdates/AnalyzedMethodTest.php
index 2efb24638..31505d946 100644
--- a/tests/FileUpdates/AnalyzedMethodTest.php
+++ b/tests/FileUpdates/AnalyzedMethodTest.php
@@ -31,7 +31,8 @@ class AnalyzedMethodTest extends \Psalm\Tests\TestCase
             new \Psalm\Tests\Internal\Provider\ParserInstanceCacheProvider(),
             null,
             null,
-            new Provider\FakeFileReferenceCacheProvider()
+            new Provider\FakeFileReferenceCacheProvider(),
+            new \Psalm\Tests\Internal\Provider\ProjectCacheProvider()
         );
 
         $this->project_analyzer = new ProjectAnalyzer(
diff --git a/tests/FileUpdates/CachedStorageTest.php b/tests/FileUpdates/CachedStorageTest.php
index e0861268d..d1a0c59f9 100644
--- a/tests/FileUpdates/CachedStorageTest.php
+++ b/tests/FileUpdates/CachedStorageTest.php
@@ -31,7 +31,8 @@ class CachedStorageTest extends \Psalm\Tests\TestCase
             new Provider\ParserInstanceCacheProvider(),
             new Provider\FileStorageInstanceCacheProvider(),
             new Provider\ClassLikeStorageInstanceCacheProvider(),
-            new Provider\FakeFileReferenceCacheProvider()
+            new Provider\FakeFileReferenceCacheProvider(),
+            new Provider\ProjectCacheProvider()
         );
 
         $this->project_analyzer = new ProjectAnalyzer(
diff --git a/tests/FileUpdates/ErrorAfterUpdateTest.php b/tests/FileUpdates/ErrorAfterUpdateTest.php
index aac53b58b..861d8e651 100644
--- a/tests/FileUpdates/ErrorAfterUpdateTest.php
+++ b/tests/FileUpdates/ErrorAfterUpdateTest.php
@@ -32,7 +32,8 @@ class ErrorAfterUpdateTest extends \Psalm\Tests\TestCase
             new \Psalm\Tests\Internal\Provider\ParserInstanceCacheProvider(),
             null,
             null,
-            new Provider\FakeFileReferenceCacheProvider()
+            new Provider\FakeFileReferenceCacheProvider(),
+            new \Psalm\Tests\Internal\Provider\ProjectCacheProvider()
         );
 
         $this->project_analyzer = new ProjectAnalyzer(
diff --git a/tests/FileUpdates/ErrorFixTest.php b/tests/FileUpdates/ErrorFixTest.php
index b0a43b14e..1f315bc86 100644
--- a/tests/FileUpdates/ErrorFixTest.php
+++ b/tests/FileUpdates/ErrorFixTest.php
@@ -32,7 +32,8 @@ class ErrorFixTest extends \Psalm\Tests\TestCase
             new \Psalm\Tests\Internal\Provider\ParserInstanceCacheProvider(),
             null,
             null,
-            new Provider\FakeFileReferenceCacheProvider()
+            new Provider\FakeFileReferenceCacheProvider(),
+            new \Psalm\Tests\Internal\Provider\ProjectCacheProvider()
         );
 
         $this->project_analyzer = new ProjectAnalyzer(
diff --git a/tests/FileUpdates/TemporaryUpdateTest.php b/tests/FileUpdates/TemporaryUpdateTest.php
index 28faaef12..efe393713 100644
--- a/tests/FileUpdates/TemporaryUpdateTest.php
+++ b/tests/FileUpdates/TemporaryUpdateTest.php
@@ -35,7 +35,8 @@ class TemporaryUpdateTest extends \Psalm\Tests\TestCase
             new \Psalm\Tests\Internal\Provider\ParserInstanceCacheProvider(),
             null,
             null,
-            new Provider\FakeFileReferenceCacheProvider()
+            new Provider\FakeFileReferenceCacheProvider(),
+            new \Psalm\Tests\Internal\Provider\ProjectCacheProvider()
         );
 
         $this->project_analyzer = new ProjectAnalyzer(
diff --git a/tests/Internal/Provider/ParserInstanceCacheProvider.php b/tests/Internal/Provider/ParserInstanceCacheProvider.php
index 4f8885764..9bbc78178 100644
--- a/tests/Internal/Provider/ParserInstanceCacheProvider.php
+++ b/tests/Internal/Provider/ParserInstanceCacheProvider.php
@@ -26,11 +26,6 @@ class ParserInstanceCacheProvider extends \Psalm\Internal\Provider\ParserCachePr
      */
     private $statements_cache_time = [];
 
-    /**
-     * @var int
-     */
-    private $last_run = 0;
-
     public function __construct()
     {
     }
@@ -102,30 +97,4 @@ class ParserInstanceCacheProvider extends \Psalm\Internal\Provider\ParserCachePr
     {
         $this->file_contents_cache[$file_path] = $file_contents;
     }
-
-    /**
-     * @return int
-     */
-    public function getLastRun()
-    {
-        return $this->last_run;
-    }
-
-    /**
-     * @param float $start_time
-     *
-     * @return void
-     */
-    public function processSuccessfulRun($start_time)
-    {
-        $this->last_run = (int) $start_time;
-    }
-
-    /**
-     * @return bool
-     */
-    public function canDiffFiles()
-    {
-        return $this->last_run > 0;
-    }
 }
diff --git a/tests/Internal/Provider/ProjectCacheProvider.php b/tests/Internal/Provider/ProjectCacheProvider.php
new file mode 100644
index 000000000..7f7b2520d
--- /dev/null
+++ b/tests/Internal/Provider/ProjectCacheProvider.php
@@ -0,0 +1,52 @@
+<?php
+namespace Psalm\Tests\Internal\Provider;
+
+use function microtime;
+use PhpParser;
+
+class ProjectCacheProvider extends \Psalm\Internal\Provider\ProjectCacheProvider
+{
+    /**
+     * @var int
+     */
+    private $last_run = 0;
+
+    public function __construct()
+    {
+    }
+
+    /**
+     * @return int
+     */
+    public function getLastRun()
+    {
+        return $this->last_run;
+    }
+
+    /**
+     * @param float $start_time
+     *
+     * @return void
+     */
+    public function processSuccessfulRun($start_time)
+    {
+        $this->last_run = (int) $start_time;
+    }
+
+    /**
+     * @return bool
+     */
+    public function canDiffFiles()
+    {
+        return $this->last_run > 0;
+    }
+
+    public function hasLockfileChanged() : bool
+    {
+        return true;
+    }
+
+    public function updateComposerLockHash() : void
+    {
+    }
+}
diff --git a/tests/LanguageServer/CompletionTest.php b/tests/LanguageServer/CompletionTest.php
index 819e743e7..22fc2cea0 100644
--- a/tests/LanguageServer/CompletionTest.php
+++ b/tests/LanguageServer/CompletionTest.php
@@ -29,7 +29,8 @@ class CompletionTest extends \Psalm\Tests\TestCase
             new \Psalm\Tests\Internal\Provider\ParserInstanceCacheProvider(),
             null,
             null,
-            new Provider\FakeFileReferenceCacheProvider()
+            new Provider\FakeFileReferenceCacheProvider(),
+            new \Psalm\Tests\Internal\Provider\ProjectCacheProvider()
         );
 
         $this->project_analyzer = new ProjectAnalyzer(
diff --git a/tests/LanguageServer/SymbolLookupTest.php b/tests/LanguageServer/SymbolLookupTest.php
index db39cfe4b..1ac7d901c 100644
--- a/tests/LanguageServer/SymbolLookupTest.php
+++ b/tests/LanguageServer/SymbolLookupTest.php
@@ -29,7 +29,8 @@ class SymbolLookupTest extends \Psalm\Tests\TestCase
             new \Psalm\Tests\Internal\Provider\ParserInstanceCacheProvider(),
             null,
             null,
-            new Provider\FakeFileReferenceCacheProvider()
+            new Provider\FakeFileReferenceCacheProvider(),
+            new \Psalm\Tests\Internal\Provider\ProjectCacheProvider()
         );
 
         $this->project_analyzer = new ProjectAnalyzer(
