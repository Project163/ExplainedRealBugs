diff --git a/src/Psalm/Internal/Analyzer/FileAnalyzer.php b/src/Psalm/Internal/Analyzer/FileAnalyzer.php
index df53b1373..7371112ce 100644
--- a/src/Psalm/Internal/Analyzer/FileAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/FileAnalyzer.php
@@ -276,6 +276,11 @@ class FileAnalyzer extends SourceAnalyzer implements StatementsSource
             return;
         }
 
+        // this can happen when stubbing
+        if (!$this->codebase->classOrInterfaceExists($stmt->name->name)) {
+            return;
+        }
+
         if ($stmt instanceof PhpParser\Node\Stmt\Class_) {
             $class_analyzer = new ClassAnalyzer($stmt, $this, $stmt->name->name);
 
diff --git a/tests/ClassStringTest.php b/tests/ClassStringTest.php
index d689b3b5a..0d4287702 100644
--- a/tests/ClassStringTest.php
+++ b/tests/ClassStringTest.php
@@ -660,6 +660,24 @@ class ClassStringTest extends TestCase
                     /** @param class-string<Example> $className */
                     function takesExampleClassString(string $className): void {}'
             ],
+            'noCrashOnPolyfill' => [
+                '<?php
+                    if (class_exists(My_Parent::class) && !class_exists(My_Extend::class)) {
+                        /**
+                         * Extended class
+                         */
+                        class My_Extend extends My_Parent {
+                            /**
+                             * Construct
+                             *
+                             * @return void
+                             */
+                            public function __construct() {
+                                echo "foo";
+                            }
+                        }
+                    }',
+            ],
         ];
     }
 
@@ -798,6 +816,7 @@ class ClassStringTest extends TestCase
                     }',
                 'error_message' => 'InvalidReturnStatement',
             ],
+
         ];
     }
 }
