diff --git a/src/Psalm/Internal/Codebase/Functions.php b/src/Psalm/Internal/Codebase/Functions.php
index 700e88879..c8fad58a2 100644
--- a/src/Psalm/Internal/Codebase/Functions.php
+++ b/src/Psalm/Internal/Codebase/Functions.php
@@ -67,22 +67,14 @@ class Functions
             return self::$stubbed_functions[strtolower($function_id)];
         }
 
-        if ($this->reflection->hasFunction($function_id)) {
-            return $this->reflection->getFunctionStorage($function_id);
-        }
+        $file_storage = null;
 
         if ($statements_analyzer) {
             $root_file_path = $statements_analyzer->getRootFilePath();
             $checked_file_path = $statements_analyzer->getFilePath();
-        } elseif (!$root_file_path || !$checked_file_path) {
-            throw new \UnexpectedValueException(
-                'Expecting non-empty $root_file_path and $checked_file_path'
-            );
-        }
 
-        $file_storage = $this->file_storage_provider->get($root_file_path);
+            $file_storage = $this->file_storage_provider->get($root_file_path);
 
-        if ($statements_analyzer) {
             $function_analyzers = $statements_analyzer->getFunctionAnalyzers();
 
             if (isset($function_analyzers[$function_id])) {
@@ -99,6 +91,20 @@ class Functions
             }
         }
 
+        if (!$root_file_path || !$checked_file_path) {
+            if ($this->reflection->hasFunction($function_id)) {
+                return $this->reflection->getFunctionStorage($function_id);
+            }
+
+            throw new \UnexpectedValueException(
+                'Expecting non-empty $root_file_path and $checked_file_path'
+            );
+        }
+
+        if ($this->reflection->hasFunction($function_id)) {
+            return $this->reflection->getFunctionStorage($function_id);
+        }
+
         if (!isset($file_storage->declaring_function_ids[$function_id])) {
             if ($checked_file_path !== $root_file_path) {
                 $file_storage = $this->file_storage_provider->get($checked_file_path);
diff --git a/src/Psalm/Internal/Codebase/Reflection.php b/src/Psalm/Internal/Codebase/Reflection.php
index 7e244f545..bf2a0edb5 100644
--- a/src/Psalm/Internal/Codebase/Reflection.php
+++ b/src/Psalm/Internal/Codebase/Reflection.php
@@ -337,6 +337,10 @@ class Reflection
 
             $callmap_callable = null;
 
+            if (isset(self::$builtin_functions[$function_id])) {
+                return;
+            }
+
             $storage = self::$builtin_functions[$function_id] = new FunctionLikeStorage();
 
             if (CallMap::inCallMap($function_id)) {
