diff --git a/src/Psalm/Internal/Analyzer/Statements/Block/IfAnalyzer.php b/src/Psalm/Internal/Analyzer/Statements/Block/IfAnalyzer.php
index 8416bb470..fcf7d2f59 100644
--- a/src/Psalm/Internal/Analyzer/Statements/Block/IfAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/Statements/Block/IfAnalyzer.php
@@ -530,7 +530,9 @@ class IfAnalyzer
                     || !isset($context->vars_in_scope[$var_id])
                 ) {
                     $context->unreferenced_vars[$var_id] = $locations;
-                } elseif (isset($if_scope->possibly_assigned_var_ids[$var_id])) {
+                } elseif (isset($if_scope->possibly_assigned_var_ids[$var_id])
+                    || isset($if_context->possibly_assigned_var_ids[$var_id])
+                ) {
                     if (!isset($context->unreferenced_vars[$var_id])) {
                         $context->unreferenced_vars[$var_id] = $locations;
                     } else {
diff --git a/src/Psalm/Internal/Visitor/ReflectorVisitor.php b/src/Psalm/Internal/Visitor/ReflectorVisitor.php
index 85cc7a517..7233cd9c1 100644
--- a/src/Psalm/Internal/Visitor/ReflectorVisitor.php
+++ b/src/Psalm/Internal/Visitor/ReflectorVisitor.php
@@ -2069,7 +2069,7 @@ class ReflectorVisitor extends PhpParser\NodeVisitorAbstract implements PhpParse
 
         if ($docblock_info->template_typeofs) {
             foreach ($docblock_info->template_typeofs as $template_typeof) {
-                foreach ($storage->params as $i => $param) {
+                foreach ($storage->params as $param) {
                     if ($param->name === $template_typeof['param_name']) {
                         $param_type_nullable = $param->type && $param->type->isNullable();
 
diff --git a/tests/UnusedVariableTest.php b/tests/UnusedVariableTest.php
index ac4e61cf5..ba28eead4 100644
--- a/tests/UnusedVariableTest.php
+++ b/tests/UnusedVariableTest.php
@@ -921,6 +921,20 @@ class UnusedVariableTest extends TestCase
                         }
                     }',
             ],
+            'useParamInsideIfLoop' => [
+                '<?php
+                    function foo() : void {
+                        $a = 1;
+
+                        if (rand(0, 1)) {
+                            while (rand(0, 1)) {
+                                $a = 2;
+                            }
+                        }
+
+                        echo $a;
+                    }',
+            ],
         ];
     }
 
@@ -1438,6 +1452,61 @@ class UnusedVariableTest extends TestCase
                     }',
                 'error_message' => 'UnusedVariable',
             ],
+            'detectUnusedVariableInsideIfLoop' => [
+                '<?php
+                    function foo() : void {
+                        $a = 1;
+
+                        if (rand(0, 1)) {
+                            while (rand(0, 1)) {
+                                $a = 2;
+                            }
+                        }
+                    }',
+                'error_message' => 'UnusedVariable',
+            ],
+            'detectUnusedVariableInsideIfElseLoop' => [
+                '<?php
+                    function foo() : void {
+                        $a = 1;
+
+                        if (rand(0, 1)) {
+                        } else {
+                            while (rand(0, 1)) {
+                                $a = 2;
+                            }
+                        }
+                    }',
+                'error_message' => 'UnusedVariable',
+            ],
+            'detectUnusedVariableInsideIfElseifLoop' => [
+                '<?php
+                    function foo() : void {
+                        $a = 1;
+
+                        if (rand(0, 1)) {
+                        } elseif (rand(0, 1)) {
+                            while (rand(0, 1)) {
+                                $a = 2;
+                            }
+                        }
+                    }',
+                'error_message' => 'UnusedVariable',
+            ],
+            'detectUnusedVariableInsideIfLoopWithEchoInside' => [
+                '<?php
+                    function foo() : void {
+                        $a = 1;
+
+                        if (rand(0, 1)) {
+                            while (rand(0, 1)) {
+                                $a = 2;
+                                echo $a;
+                            }
+                        }
+                    }',
+                'error_message' => 'UnusedVariable',
+            ],
         ];
     }
 }
diff --git a/tests/fixtures/symlinktest/ignored/b b/tests/fixtures/symlinktest/ignored/b
index 579c85a7f..5daf371aa 120000
--- a/tests/fixtures/symlinktest/ignored/b
+++ b/tests/fixtures/symlinktest/ignored/b
@@ -1 +1 @@
-/Users/brownma/Desktop/git/psalm/tests/fixtures/symlinktest/a
\ No newline at end of file
+/Users/matthewbrown/Desktop/vimeo/git/psalm/tests/fixtures/symlinktest/a
\ No newline at end of file
