diff --git a/src/Psalm/Internal/Analyzer/FunctionLike/ReturnTypeAnalyzer.php b/src/Psalm/Internal/Analyzer/FunctionLike/ReturnTypeAnalyzer.php
index b9cee3f07..7883eaab5 100644
--- a/src/Psalm/Internal/Analyzer/FunctionLike/ReturnTypeAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/FunctionLike/ReturnTypeAnalyzer.php
@@ -15,6 +15,7 @@ use Psalm\Internal\Analyzer\SourceAnalyzer;
 use Psalm\Internal\Analyzer\Statements\Expression\Call\ClassTemplateParamCollector;
 use Psalm\Internal\Analyzer\StatementsAnalyzer;
 use Psalm\Internal\Type\Comparator\UnionTypeComparator;
+use Psalm\Internal\Type\Comparator\TypeComparisonResult;
 use Psalm\CodeLocation;
 use Psalm\Context;
 use Psalm\Internal\FileManipulation\FunctionDocblockManipulator;
@@ -453,7 +454,7 @@ class ReturnTypeAnalyzer
                 return null;
             }
 
-            $union_comparison_results = new \Psalm\Internal\Type\Comparator\TypeComparisonResult();
+            $union_comparison_results = new TypeComparisonResult();
 
             if (!UnionTypeComparator::isContainedBy(
                 $codebase,
@@ -824,11 +825,16 @@ class ReturnTypeAnalyzer
             }
         }
 
+        $union_comparison_result = new TypeComparisonResult();
+
         if (!UnionTypeComparator::isContainedBy(
             $codebase,
             $fleshed_out_return_type,
-            $fleshed_out_signature_type
-        )
+            $fleshed_out_signature_type,
+            false,
+            false,
+            $union_comparison_result
+        ) && !$union_comparison_result->type_coerced_from_mixed
         ) {
             if ($codebase->alter_code
                 && isset($project_analyzer->getIssuesToFix()['MismatchingDocblockReturnType'])
diff --git a/src/Psalm/Internal/Analyzer/FunctionLikeAnalyzer.php b/src/Psalm/Internal/Analyzer/FunctionLikeAnalyzer.php
index 6a12ff3bb..bfe0cb9d1 100644
--- a/src/Psalm/Internal/Analyzer/FunctionLikeAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/FunctionLikeAnalyzer.php
@@ -962,7 +962,11 @@ abstract class FunctionLikeAnalyzer extends SourceAnalyzer
                     $param_type,
                     $context->self,
                     $context->self,
-                    $this->getParentFQCLN()
+                    $this->getParentFQCLN(),
+                    true,
+                    false,
+                    false,
+                    true
                 );
 
                 if ($function_param->type_location) {
diff --git a/src/Psalm/Internal/Analyzer/Statements/Expression/Call/ArgumentAnalyzer.php b/src/Psalm/Internal/Analyzer/Statements/Expression/Call/ArgumentAnalyzer.php
index 9eca88ea3..ac456c476 100644
--- a/src/Psalm/Internal/Analyzer/Statements/Expression/Call/ArgumentAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/Statements/Expression/Call/ArgumentAnalyzer.php
@@ -252,7 +252,8 @@ class ArgumentAnalyzer
             $parent_class,
             true,
             false,
-            $static_classlike_storage ? $static_classlike_storage->final : false
+            $static_classlike_storage ? $static_classlike_storage->final : false,
+            true
         );
 
         if ($class_generic_params) {
@@ -378,7 +379,8 @@ class ArgumentAnalyzer
                 $parent_class,
                 true,
                 false,
-                $static_classlike_storage ? $static_classlike_storage->final : false
+                $static_classlike_storage ? $static_classlike_storage->final : false,
+                true
             );
         }
 
diff --git a/src/Psalm/Internal/Analyzer/Statements/Expression/Call/FunctionCallReturnTypeFetcher.php b/src/Psalm/Internal/Analyzer/Statements/Expression/Call/FunctionCallReturnTypeFetcher.php
index f7674e6d6..13f54f646 100644
--- a/src/Psalm/Internal/Analyzer/Statements/Expression/Call/FunctionCallReturnTypeFetcher.php
+++ b/src/Psalm/Internal/Analyzer/Statements/Expression/Call/FunctionCallReturnTypeFetcher.php
@@ -118,7 +118,11 @@ class FunctionCallReturnTypeFetcher
                             $return_type,
                             null,
                             null,
-                            null
+                            null,
+                            true,
+                            false,
+                            false,
+                            true
                         );
 
                         $return_type_location = $function_storage->return_type_location;
diff --git a/src/Psalm/Internal/Analyzer/Statements/Expression/Call/Method/MethodCallReturnTypeFetcher.php b/src/Psalm/Internal/Analyzer/Statements/Expression/Call/Method/MethodCallReturnTypeFetcher.php
index c77f042c5..be47962fd 100644
--- a/src/Psalm/Internal/Analyzer/Statements/Expression/Call/Method/MethodCallReturnTypeFetcher.php
+++ b/src/Psalm/Internal/Analyzer/Statements/Expression/Call/Method/MethodCallReturnTypeFetcher.php
@@ -120,7 +120,11 @@ class MethodCallReturnTypeFetcher
                 $return_type_candidate,
                 $fq_class_name,
                 $static_type,
-                $class_storage->parent_class
+                $class_storage->parent_class,
+                true,
+                false,
+                false,
+                true
             );
         } else {
             $self_fq_class_name = $fq_class_name;
@@ -152,7 +156,8 @@ class MethodCallReturnTypeFetcher
                     true,
                     false,
                     $static_type instanceof Type\Atomic\TNamedObject
-                        && $codebase->classlike_storage_provider->get($static_type->value)->final
+                        && $codebase->classlike_storage_provider->get($static_type->value)->final,
+                    true
                 );
 
                 $return_type_location = $codebase->methods->getMethodReturnTypeLocation(
diff --git a/src/Psalm/Internal/Type/NegatedAssertionReconciler.php b/src/Psalm/Internal/Type/NegatedAssertionReconciler.php
index 2a09888ab..3ed836023 100644
--- a/src/Psalm/Internal/Type/NegatedAssertionReconciler.php
+++ b/src/Psalm/Internal/Type/NegatedAssertionReconciler.php
@@ -224,7 +224,7 @@ class NegatedAssertionReconciler extends Reconciler
                         continue;
                     }
 
-                    $new_type_part = Atomic::create($assertion);
+                    $new_type_part = Atomic::create($assertion, null, $template_type_map);
 
                     if (!$new_type_part instanceof TNamedObject) {
                         continue;
diff --git a/src/Psalm/Internal/Type/TypeExpander.php b/src/Psalm/Internal/Type/TypeExpander.php
index c5cc96ac0..d58dc3ba8 100644
--- a/src/Psalm/Internal/Type/TypeExpander.php
+++ b/src/Psalm/Internal/Type/TypeExpander.php
@@ -31,7 +31,8 @@ class TypeExpander
         ?string $parent_class,
         bool $evaluate_class_constants = true,
         bool $evaluate_conditional_types = false,
-        bool $final = false
+        bool $final = false,
+        bool $expand_generic = false
     ): Type\Union {
         $return_type = clone $return_type;
 
@@ -48,7 +49,8 @@ class TypeExpander
                 $parent_class,
                 $evaluate_class_constants,
                 $evaluate_conditional_types,
-                $final
+                $final,
+                $expand_generic
             );
 
             if (is_array($parts)) {
@@ -95,7 +97,8 @@ class TypeExpander
         ?string $parent_class,
         bool $evaluate_class_constants = true,
         bool $evaluate_conditional_types = false,
-        bool $final = false
+        bool $final = false,
+        bool $expand_generic = false
     ) {
         if ($return_type instanceof TNamedObject
             || $return_type instanceof TTemplateParam
@@ -129,6 +132,38 @@ class TypeExpander
             }
 
             if ($return_type instanceof TNamedObject) {
+                if ($expand_generic
+                    && \get_class($return_type) === TNamedObject::class
+                    && !$return_type->extra_types
+                    && $codebase->classOrInterfaceExists($return_type->value)
+                ) {
+                    $value = $codebase->classlikes->getUnAliasedName($return_type->value);
+                    $container_class_storage = $codebase->classlike_storage_provider->get(
+                        $value
+                    );
+
+                    if ($container_class_storage->template_types
+                        && \array_filter(
+                            $container_class_storage->template_types,
+                            function ($type_map) {
+                                return !reset($type_map)->hasMixed();
+                            }
+                        )
+                    ) {
+                        $return_type = new Type\Atomic\TGenericObject(
+                            $return_type->value,
+                            \array_values(
+                                \array_map(
+                                    function ($type_map) {
+                                        return clone reset($type_map);
+                                    },
+                                    $container_class_storage->template_types
+                                )
+                            )
+                        );
+                    }
+                }
+
                 $return_type_lc = strtolower($return_type->value);
 
                 if ($static_class_type && ($return_type_lc === 'static' || $return_type_lc === '$this')) {
@@ -190,7 +225,8 @@ class TypeExpander
                 $parent_class,
                 $evaluate_class_constants,
                 $evaluate_conditional_types,
-                $final
+                $final,
+                $expand_generic
             );
 
             if ($new_as_type instanceof TNamedObject) {
@@ -206,7 +242,8 @@ class TypeExpander
                 $parent_class,
                 $evaluate_class_constants,
                 $evaluate_conditional_types,
-                $final
+                $final,
+                $expand_generic
             );
 
             $return_type->as = $new_as_type;
@@ -303,7 +340,9 @@ class TypeExpander
                                 $static_class_type,
                                 $parent_class,
                                 $evaluate_class_constants,
-                                $evaluate_conditional_types
+                                $evaluate_conditional_types,
+                                $final,
+                                $expand_generic
                             );
 
                             if (is_array($recursively_fleshed_out_type)) {
@@ -380,7 +419,8 @@ class TypeExpander
                     $parent_class,
                     $evaluate_class_constants,
                     $evaluate_conditional_types,
-                    $final
+                    $final,
+                    $expand_generic
                 );
 
                 if (\is_array($new_value_type)) {
@@ -412,7 +452,8 @@ class TypeExpander
                 $parent_class,
                 $evaluate_class_constants,
                 $evaluate_conditional_types,
-                $final
+                $final,
+                $expand_generic
             );
 
             if (!is_array($new_value_types)) {
@@ -446,7 +487,8 @@ class TypeExpander
                     $parent_class,
                     $evaluate_class_constants,
                     $evaluate_conditional_types,
-                    $final
+                    $final,
+                    $expand_generic
                 );
             }
         } elseif ($return_type instanceof Type\Atomic\TKeyedArray) {
@@ -459,7 +501,8 @@ class TypeExpander
                     $parent_class,
                     $evaluate_class_constants,
                     $evaluate_conditional_types,
-                    $final
+                    $final,
+                    $expand_generic
                 );
             }
         } elseif ($return_type instanceof Type\Atomic\TList) {
@@ -471,7 +514,8 @@ class TypeExpander
                 $parent_class,
                 $evaluate_class_constants,
                 $evaluate_conditional_types,
-                $final
+                $final,
+                $expand_generic
             );
         }
 
@@ -485,7 +529,8 @@ class TypeExpander
                     $parent_class,
                     $evaluate_class_constants,
                     $evaluate_conditional_types,
-                    $final
+                    $final,
+                    $expand_generic
                 );
             }
         }
@@ -504,7 +549,8 @@ class TypeExpander
                             $parent_class,
                             $evaluate_class_constants,
                             $evaluate_conditional_types,
-                            $final
+                            $final,
+                            $expand_generic
                         );
                     }
                 }
@@ -518,7 +564,8 @@ class TypeExpander
                     $parent_class,
                     $evaluate_class_constants,
                     $evaluate_conditional_types,
-                    $final
+                    $final,
+                    $expand_generic
                 );
             }
         }
@@ -537,7 +584,8 @@ class TypeExpander
                             $parent_class,
                             $evaluate_class_constants,
                             $evaluate_conditional_types,
-                            $final
+                            $final,
+                            $expand_generic
                         );
 
                         if (!is_array($candidate)) {
@@ -557,7 +605,8 @@ class TypeExpander
                         $parent_class,
                         $evaluate_class_constants,
                         $evaluate_conditional_types,
-                        $final
+                        $final,
+                        $expand_generic
                     );
 
                     $candidate_types = is_array($candidate) ? $candidate : [$candidate];
@@ -579,7 +628,8 @@ class TypeExpander
                         $parent_class,
                         $evaluate_class_constants,
                         $evaluate_conditional_types,
-                        $final
+                        $final,
+                        $expand_generic
                     );
 
                     $candidate_types = is_array($candidate) ? $candidate : [$candidate];
@@ -654,7 +704,8 @@ class TypeExpander
                 $parent_class,
                 $evaluate_class_constants,
                 $evaluate_conditional_types,
-                $final
+                $final,
+                $expand_generic
             );
 
             $return_type->if_type = self::expandUnion(
@@ -665,7 +716,8 @@ class TypeExpander
                 $parent_class,
                 $evaluate_class_constants,
                 $evaluate_conditional_types,
-                $final
+                $final,
+                $expand_generic
             );
 
             $return_type->else_type = self::expandUnion(
@@ -676,7 +728,8 @@ class TypeExpander
                 $parent_class,
                 $evaluate_class_constants,
                 $evaluate_conditional_types,
-                $final
+                $final,
+                $expand_generic
             );
         }
 
diff --git a/tests/Template/ClassTemplateTest.php b/tests/Template/ClassTemplateTest.php
index 6bc37624d..e40fb3da9 100644
--- a/tests/Template/ClassTemplateTest.php
+++ b/tests/Template/ClassTemplateTest.php
@@ -3309,6 +3309,19 @@ class ClassTemplateTest extends TestCase
                         }
                     }'
             ],
+            'templatedTypeWithLimitGoesIntoTemplatedType' => [
+                '<?php
+                    /**
+                     * @template T as object
+                     */
+                    abstract class A {}
+
+                    function takesA(A $a) : void {}
+
+                    function foo(A $a) : void {
+                        takesA($a);
+                    }',
+            ],
         ];
     }
 
@@ -3914,6 +3927,40 @@ class ClassTemplateTest extends TestCase
                     }',
                 'error_message' => 'InvalidScalarArgument',
             ],
+            'limitTemplateTypeWithSameName' => [
+                '<?php
+                    /**
+                     * @template T as object
+                     */
+                    abstract class A {}
+
+                    function takesA(A $a) : void {}
+
+                    /** @param A<stdClass> $a */
+                    function foo(A $a) : void {
+                        takesA($a);
+                    }',
+                'error_message' => 'InvalidArgument',
+            ],
+            'limitTemplateTypeExtended' => [
+                '<?php
+
+                    /**
+                     * @template T as object
+                     */
+                    abstract class A {}
+
+                    /**
+                     * @extends A<stdClass>
+                     */
+                    class AChild extends A {}
+
+                    function takesA(A $a) : void {}
+
+                    $child = new AChild();
+                    takesA($child);',
+                'error_message' => 'InvalidArgument',
+            ],
         ];
     }
 }
