diff --git a/src/Psalm/Internal/Analyzer/StatementsAnalyzer.php b/src/Psalm/Internal/Analyzer/StatementsAnalyzer.php
index 5f132a719..1fc80b4ee 100644
--- a/src/Psalm/Internal/Analyzer/StatementsAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/StatementsAnalyzer.php
@@ -1386,7 +1386,8 @@ class StatementsAnalyzer extends SourceAnalyzer implements StatementsSource
             return $file_storage_provider->get($constant_file_path)->constants[$fq_const_name];
         }
 
-        return ConstFetchAnalyzer::getGlobalConstType($codebase, $fq_const_name, $const_name);
+        return ConstFetchAnalyzer::getGlobalConstType($codebase, $fq_const_name, $const_name)
+            ?? ConstFetchAnalyzer::getGlobalConstType($codebase, $const_name, $const_name);
     }
 
     /**
diff --git a/src/Psalm/Internal/Visitor/ReflectorVisitor.php b/src/Psalm/Internal/Visitor/ReflectorVisitor.php
index 0caec4647..a546c6b1f 100644
--- a/src/Psalm/Internal/Visitor/ReflectorVisitor.php
+++ b/src/Psalm/Internal/Visitor/ReflectorVisitor.php
@@ -597,6 +597,7 @@ class ReflectorVisitor extends PhpParser\NodeVisitorAbstract implements PhpParse
                         $second_arg_value,
                         $this->aliases
                     ) ?: Type::getMixed();
+
                     if ($this->functionlike_storages && !$this->config->hoist_constants) {
                         $functionlike_storage =
                             $this->functionlike_storages[count($this->functionlike_storages) - 1];
@@ -605,6 +606,10 @@ class ReflectorVisitor extends PhpParser\NodeVisitorAbstract implements PhpParse
                         $this->file_storage->constants[$const_name] = $const_type;
                         $this->file_storage->declaring_constants[$const_name] = $this->file_path;
                     }
+
+                    if ($this->codebase->register_stub_files || $this->codebase->register_autoload_files) {
+                        $this->codebase->addGlobalConstantType($const_name, $const_type);
+                    }
                 }
             }
         }
diff --git a/tests/StubTest.php b/tests/StubTest.php
index c38f37167..859b05090 100644
--- a/tests/StubTest.php
+++ b/tests/StubTest.php
@@ -85,7 +85,7 @@ class StubTest extends TestCase
     /**
      * @return void
      */
-    public function testStubFile()
+    public function testStubFileClass()
     {
         $this->project_analyzer = $this->getProjectAnalyzerWithConfig(
             TestConfig::loadFromXML(
@@ -108,11 +108,49 @@ class StubTest extends TestCase
         $this->addFile(
             $file_path,
             '<?php
-                $a = new SystemClass();
-                echo SystemClass::HELLO;
+                namespace A\B\C;
 
+                $a = new \SystemClass();
                 $b = $a->foo(5, "hello");
-                $c = SystemClass::bar(5, "hello");'
+                $c = \SystemClass::bar(5, "hello");
+                echo \SystemClass::HELLO;'
+        );
+
+        $this->analyzeFile($file_path, new Context());
+    }
+
+    /**
+     * @return void
+     */
+    public function testStubFileConstant()
+    {
+        $this->project_analyzer = $this->getProjectAnalyzerWithConfig(
+            TestConfig::loadFromXML(
+                dirname(__DIR__),
+                '<?xml version="1.0"?>
+                <psalm>
+                    <projectFiles>
+                        <directory name="src" />
+                    </projectFiles>
+
+                    <stubs>
+                        <file name="tests/stubs/systemclass.php" />
+                    </stubs>
+                </psalm>'
+            )
+        );
+
+        $file_path = getcwd() . '/src/somefile.php';
+
+        $this->addFile(
+            $file_path,
+            '<?php
+                namespace A\B\C;
+
+                $d = ROOT_CONST_CONSTANT;
+                $e = \ROOT_CONST_CONSTANT;
+                $f = ROOT_DEFINE_CONSTANT;
+                $g = \ROOT_DEFINE_CONSTANT;'
         );
 
         $this->analyzeFile($file_path, new Context());
diff --git a/tests/stubs/systemclass.php b/tests/stubs/systemclass.php
index a6d703d79..3487a8986 100644
--- a/tests/stubs/systemclass.php
+++ b/tests/stubs/systemclass.php
@@ -1,5 +1,8 @@
 <?php
 
+const ROOT_CONST_CONSTANT = 5;
+define('ROOT_DEFINE_CONSTANT', 10);
+
 class SystemClass
 {
     const HELLO = 'hello';
