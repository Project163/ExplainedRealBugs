diff --git a/src/Psalm/Internal/Analyzer/Statements/ReturnAnalyzer.php b/src/Psalm/Internal/Analyzer/Statements/ReturnAnalyzer.php
index 4deb4090d..b60933056 100644
--- a/src/Psalm/Internal/Analyzer/Statements/ReturnAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/Statements/ReturnAnalyzer.php
@@ -165,25 +165,27 @@ class ReturnAnalyzer
                     if ($storage instanceof \Psalm\Storage\MethodStorage) {
                         list($fq_class_name, $method_name) = explode('::', $cased_method_id);
 
-                        if ($fq_class_name !== $context->self) {
-                            $class_storage = $codebase->classlike_storage_provider->get($fq_class_name);
-
-                            $found_generic_params = MethodCallAnalyzer::getClassTemplateParams(
-                                $codebase,
-                                $class_storage,
-                                $fq_class_name,
-                                strtolower($method_name),
-                                null,
-                                null
-                            );
+                        $class_storage = $codebase->classlike_storage_provider->get($fq_class_name);
+
+                        $found_generic_params = MethodCallAnalyzer::getClassTemplateParams(
+                            $codebase,
+                            $class_storage,
+                            $fq_class_name,
+                            strtolower($method_name),
+                            null,
+                            null
+                        );
+
+                        if ($found_generic_params) {
+                            foreach ($found_generic_params as $template_name => $_) {
+                                unset($found_generic_params[$template_name][$fq_class_name]);
+                            }
 
-                            if ($found_generic_params) {
-                                $local_return_type = clone $local_return_type;
+                            $local_return_type = clone $local_return_type;
 
-                                $local_return_type->replaceTemplateTypesWithArgTypes(
-                                    $found_generic_params
-                                );
-                            }
+                            $local_return_type->replaceTemplateTypesWithArgTypes(
+                                $found_generic_params
+                            );
                         }
                     }
 
diff --git a/src/Psalm/Internal/Analyzer/TypeAnalyzer.php b/src/Psalm/Internal/Analyzer/TypeAnalyzer.php
index 1f553e477..b57a173b1 100644
--- a/src/Psalm/Internal/Analyzer/TypeAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/TypeAnalyzer.php
@@ -612,10 +612,36 @@ class TypeAnalyzer
         &$to_string_cast = null,
         &$type_coerced_from_scalar = null
     ) {
+        if ($container_type_part instanceof TTemplateParam && $input_type_part instanceof TTemplateParam) {
+            if ($container_type_part->param_name !== $input_type_part->param_name
+                || (string)$container_type_part->defining_class !== (string)$input_type_part->defining_class
+            ) {
+                if ($container_type_part->defining_class
+                    && $input_type_part->defining_class
+                ) {
+                    $input_class_storage = $codebase->classlike_storage_provider->get(
+                        $input_type_part->defining_class
+                    );
+
+                    if (isset($input_class_storage->template_type_extends
+                            [$container_type_part->defining_class]
+                            [$container_type_part->param_name])
+                    ) {
+                        return true;
+                    }
+                }
+
+                return false;
+            }
+
+            return true;
+        }
+
         if ($container_type_part instanceof TMixed
             || ($container_type_part instanceof TTemplateParam
                 && $container_type_part->as->isMixed()
-                && !$container_type_part->extra_types)
+                && !$container_type_part->extra_types
+                && $input_type_part instanceof TMixed)
         ) {
             if (get_class($container_type_part) === TEmptyMixed::class
                 && get_class($input_type_part) === TMixed::class
@@ -675,7 +701,8 @@ class TypeAnalyzer
 
         if ($input_type_part->shallowEquals($container_type_part)
             || (($input_type_part instanceof TNamedObject
-                    || $input_type_part instanceof TTemplateParam
+                    || ($input_type_part instanceof TTemplateParam
+                        && $input_type_part->as->hasObjectType())
                     || $input_type_part instanceof TIterable)
                 && ($container_type_part instanceof TNamedObject
                     || ($container_type_part instanceof TTemplateParam
@@ -702,10 +729,6 @@ class TypeAnalyzer
         }
 
         if ($container_type_part instanceof TTemplateParam && $input_type_part instanceof TTemplateParam) {
-            if ($container_type_part->param_name !== $input_type_part->param_name) {
-                return false;
-            }
-
             return self::isContainedBy(
                 $codebase,
                 $input_type_part->as,
@@ -735,7 +758,7 @@ class TypeAnalyzer
                     $to_string_cast,
                     $type_coerced_from_scalar
                 )) {
-                    if ($allow_interface_equality || !$input_type_part instanceof TNamedObject) {
+                    if ($allow_interface_equality || $input_type_part instanceof TArray) {
                         return true;
                     }
                 }
@@ -745,6 +768,25 @@ class TypeAnalyzer
         }
 
         if ($input_type_part instanceof TTemplateParam) {
+            if ($input_type_part->extra_types) {
+                foreach ($input_type_part->extra_types as $extra_type) {
+                    if (self::isAtomicContainedBy(
+                        $codebase,
+                        $extra_type,
+                        $container_type_part,
+                        $allow_interface_equality,
+                        $allow_float_int_equality,
+                        $has_scalar_match,
+                        $type_coerced,
+                        $type_coerced_from_mixed,
+                        $to_string_cast,
+                        $type_coerced_from_scalar
+                    )) {
+                        return true;
+                    }
+                }
+            }
+
             foreach ($input_type_part->as->getTypes() as $input_as_type_part) {
                 if ($input_as_type_part instanceof TNull && $container_type_part instanceof TNull) {
                     continue;
diff --git a/src/Psalm/Internal/Codebase/Populator.php b/src/Psalm/Internal/Codebase/Populator.php
index c68882f94..48dac9355 100644
--- a/src/Psalm/Internal/Codebase/Populator.php
+++ b/src/Psalm/Internal/Codebase/Populator.php
@@ -493,6 +493,13 @@ class Populator
                                 = $template_type[0];
                         }
                     }
+
+                    if ($parent_storage->template_type_extends) {
+                        $storage->template_type_extends = array_merge(
+                            $storage->template_type_extends,
+                            $parent_storage->template_type_extends
+                        );
+                    }
                 }
             } elseif ($parent_storage->template_type_extends) {
                 $storage->template_type_extends = array_merge(
diff --git a/tests/Template/ClassTemplateExtendsTest.php b/tests/Template/ClassTemplateExtendsTest.php
index 67df229b2..6662249a7 100644
--- a/tests/Template/ClassTemplateExtendsTest.php
+++ b/tests/Template/ClassTemplateExtendsTest.php
@@ -663,6 +663,23 @@ class ClassTemplateExtendsTest extends TestCase
                         $foo->bar();
                     }',
             ],
+            'constructExtendedArrayIteratorWithTemplateExtends' => [
+                '<?php
+                    /**
+                     * @template TKey as array-key
+                     * @template TValue
+                     * @template-extends ArrayIterator<TKey, TValue>
+                     */
+                    class Collection1 extends ArrayIterator{}
+
+                    class Collection2 extends Collection1{}
+
+                    class Collection3 extends Collection2{}
+
+                    $a = new Collection1(["a" => "b"]);
+                    $a = new Collection2(["a" => "b"]);
+                    $a = new Collection3(["a" => "b"]);',
+            ],
             'iterateOverExtendedArrayObjectWithoutParam' => [
                 '<?php
                     class O {}
@@ -2395,23 +2412,25 @@ class ClassTemplateExtendsTest extends TestCase
             'extendsTwiceSameNameLastDoesNotExtend' => [
                 '<?php
                     /**
-                     * @template T
+                     * @template T1
                      */
                     class Container
                     {
                         /**
-                         * @var T
+                         * @var T1
                          */
                         private $v;
+
                         /**
-                         * @param T $v
+                         * @param T1 $v
                          */
                         public function __construct($v)
                         {
                             $this->v = $v;
                         }
+
                         /**
-                         * @return T
+                         * @return T1
                          */
                         public function getValue()
                         {
@@ -2420,14 +2439,11 @@ class ClassTemplateExtendsTest extends TestCase
                     }
 
                     /**
-                     * @template T
-                     * @template-extends Container<T>
+                     * @template T2
+                     * @template-extends Container<T2>
                      */
                     class ChildContainer extends Container {}
 
-                    /**
-                     * @template T
-                     */
                     class GrandChildContainer extends ChildContainer {}
 
                     $fc = new GrandChildContainer(5);
diff --git a/tests/Template/FunctionTemplateTest.php b/tests/Template/FunctionTemplateTest.php
index f1a3c56f4..9dbf4cd3b 100644
--- a/tests/Template/FunctionTemplateTest.php
+++ b/tests/Template/FunctionTemplateTest.php
@@ -526,7 +526,9 @@ class FunctionTemplateTest extends TestCase
                         if ($return instanceof Generator) {
                             return [$gen->getReturn()];
                         }
-                        return [$gen];
+                        /** @var array<int, TReturn> */
+                        $wrapped_gen = [$gen];
+                        return $wrapped_gen;
                     }
 
                     $arr = call(
@@ -1045,6 +1047,18 @@ class FunctionTemplateTest extends TestCase
                     }',
                 'error_message' => 'InvalidReturnStatement'
             ],
+            'preventReturningString' => [
+                '<?php
+                    /**
+                     * @template T
+                     * @psalm-param T $t
+                     * @return T
+                     */
+                    function mirror($t) {
+                        return "string";
+                    }',
+                'error_message' => 'InvalidReturnStatement'
+            ],
         ];
     }
 }
