diff --git a/src/Psalm/Internal/Analyzer/Statements/Expression/Assignment/ArrayAssignmentAnalyzer.php b/src/Psalm/Internal/Analyzer/Statements/Expression/Assignment/ArrayAssignmentAnalyzer.php
index 75ecf8b26..9ffd8bb2f 100644
--- a/src/Psalm/Internal/Analyzer/Statements/Expression/Assignment/ArrayAssignmentAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/Statements/Expression/Assignment/ArrayAssignmentAnalyzer.php
@@ -496,11 +496,7 @@ class ArrayAssignmentAnalyzer
                 }
             }
         } elseif ($root_var_id) {
-            if ($context->hasVariable($root_var_id, $statements_analyzer)) {
-                $context->vars_in_scope[$root_var_id] = $root_type;
-            } else {
-                $context->vars_in_scope[$root_var_id] = $root_type;
-            }
+            $context->vars_in_scope[$root_var_id] = $root_type;
         }
 
         return null;
diff --git a/src/Psalm/Internal/Analyzer/Statements/Expression/Fetch/VariableFetchAnalyzer.php b/src/Psalm/Internal/Analyzer/Statements/Expression/Fetch/VariableFetchAnalyzer.php
index 456a8f8d9..c7b9e508d 100644
--- a/src/Psalm/Internal/Analyzer/Statements/Expression/Fetch/VariableFetchAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/Statements/Expression/Fetch/VariableFetchAnalyzer.php
@@ -147,7 +147,7 @@ class VariableFetchAnalyzer
 
         $var_name = '$' . $stmt->name;
 
-        if (!$context->hasVariable($var_name, $statements_analyzer)) {
+        if (!$context->hasVariable($var_name, !$array_assignment ? $statements_analyzer : null)) {
             if (!isset($context->vars_possibly_in_scope[$var_name]) ||
                 !$statements_analyzer->getFirstAppearance($var_name)
             ) {
diff --git a/tests/Template/FunctionClassStringTemplateTest.php b/tests/Template/FunctionClassStringTemplateTest.php
index 174744288..62503a03d 100644
--- a/tests/Template/FunctionClassStringTemplateTest.php
+++ b/tests/Template/FunctionClassStringTemplateTest.php
@@ -504,7 +504,36 @@ class FunctionClassStringTemplateTest extends TestCase
 
                     f(A::class);
                     f(B::class);',
-                ],
+            ],
+            'compareToExactClassString' => [
+                '<?php
+                    /**
+                     * @template T as object
+                     */
+                    class Type
+                    {
+                        /** @var class-string<T> */
+                        private $typeName;
+
+                        /**
+                         * @param class-string<T> $typeName
+                         */
+                        public function __construct(string $typeName) {
+                            $this->typeName = $typeName;
+                        }
+
+                        /**
+                         * @param mixed $value
+                         * @return T
+                         */
+                        public function cast($value) {
+                            if (is_object($value) && get_class($value) === $this->typeName) {
+                                return $value;
+                            }
+                            throw new RuntimeException();
+                        }
+                    }'
+            ],
         ];
     }
 
diff --git a/tests/UnusedVariableTest.php b/tests/UnusedVariableTest.php
index dda7ffdc1..ccd237cb8 100644
--- a/tests/UnusedVariableTest.php
+++ b/tests/UnusedVariableTest.php
@@ -1630,6 +1630,14 @@ class UnusedVariableTest extends TestCase
                     }',
                 'error_message' => 'UnusedVariable',
             ],
+            'detectUselessArrayAssignment' => [
+                '<?php
+                    function foo() : void {
+                        $a = [];
+                        $a[0] = 1;
+                    }',
+                'error_message' => 'UnusedVariable',
+            ],
         ];
     }
 }
