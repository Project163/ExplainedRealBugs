diff --git a/src/Psalm/Context.php b/src/Psalm/Context.php
index a91040535..d437c6497 100644
--- a/src/Psalm/Context.php
+++ b/src/Psalm/Context.php
@@ -147,6 +147,13 @@ class Context
      */
     public $clauses = [];
 
+    /**
+     * A list of hashed clauses that have already been factored in
+     *
+     * @var list<string>
+     */
+    public $reconciled_expression_clauses = [];
+
     /**
      * Whether or not to do a deep analysis and collect mutations to this context
      *
@@ -280,6 +287,16 @@ class Context
      */
     public $case_scope = null;
 
+    /**
+     * @var Context|null
+     */
+    public $if_context = null;
+
+    /**
+     * @var \Psalm\Internal\Scope\IfScope|null
+     */
+    public $if_scope = null;
+
     /**
      * @var bool
      */
@@ -487,31 +504,62 @@ class Context
     }
 
     /**
+     * This removes all clauses that are invalidated because
+     * all possibilities are overwritten by changed var ids
+     *
+     * @param  Clause[]             $clauses
      * @param  array<string, bool>  $changed_var_ids
      *
-     * @return void
+     * @return list<Clause>
      */
-    public function removeReconciledClauses(array $changed_var_ids)
+    public static function removeOverwrittenClauses(array $clauses, array $changed_var_ids)
     {
-        $this->clauses = \array_values(
-            array_filter(
-                $this->clauses,
-                /** @return bool */
-                function (Clause $c) use ($changed_var_ids) {
-                    if ($c->wedge) {
-                        return true;
-                    }
+        $included_clauses = [];
 
-                    foreach ($c->possibilities as $key => $_) {
-                        if (isset($changed_var_ids[$key])) {
-                            return false;
-                        }
-                    }
+        foreach ($clauses as $c) {
+            if ($c->wedge) {
+                $included_clauses[] = $c;
+                continue;
+            }
 
-                    return true;
+            if (!\array_diff_key($c->possibilities, $changed_var_ids)) {
+                continue;
+            }
+
+            $included_clauses[] = $c;
+        }
+
+        return $included_clauses;
+    }
+
+    /**
+     * @param  Clause[]             $clauses
+     * @param  array<string, bool>  $changed_var_ids
+     *
+     * @return array{0: list<Clause>, list<Clause>}
+     */
+    public static function removeReconciledClauses(array $clauses, array $changed_var_ids)
+    {
+        $included_clauses = [];
+        $rejected_clauses = [];
+
+        foreach ($clauses as $c) {
+            if ($c->wedge) {
+                $included_clauses[] = $c;
+                continue;
+            }
+
+            foreach ($c->possibilities as $key => $_) {
+                if (isset($changed_var_ids[$key])) {
+                    $rejected_clauses[] = $c;
+                    continue 2;
                 }
-            )
-        );
+            }
+
+            $included_clauses[] = $c;
+        }
+
+        return [$included_clauses, $rejected_clauses];
     }
 
     /**
diff --git a/src/Psalm/Internal/Analyzer/Statements/Block/IfAnalyzer.php b/src/Psalm/Internal/Analyzer/Statements/Block/IfAnalyzer.php
index da0b5425c..709cc104f 100644
--- a/src/Psalm/Internal/Analyzer/Statements/Block/IfAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/Statements/Block/IfAnalyzer.php
@@ -88,6 +88,7 @@ class IfAnalyzer
             );
 
             $if_context = $if_conditional_scope->if_context;
+
             $original_context = $if_conditional_scope->original_context;
             $cond_referenced_var_ids = $if_conditional_scope->cond_referenced_var_ids;
             $cond_assigned_var_ids = $if_conditional_scope->cond_assigned_var_ids;
@@ -138,6 +139,15 @@ class IfAnalyzer
             )
         );
 
+        $entry_clauses = $context->clauses;
+
+        if ($if_scope->if_cond_changed_var_ids) {
+            $entry_clauses = Context::removeOverwrittenClauses(
+                $entry_clauses,
+                $if_scope->if_cond_changed_var_ids
+            );
+        }
+
         // this will see whether any of the clauses in set A conflict with the clauses in set B
         AlgebraAnalyzer::checkForParadox(
             $context->clauses,
@@ -152,7 +162,22 @@ class IfAnalyzer
             $if_clauses = Algebra::simplifyCNF($if_clauses);
         }
 
-        $if_context->clauses = Algebra::simplifyCNF(array_merge($context->clauses, $if_clauses));
+        $if_context_clauses = array_merge($entry_clauses, $if_clauses);
+
+        $if_context->clauses = Algebra::simplifyCNF($if_context_clauses);
+
+        if ($if_context->reconciled_expression_clauses) {
+            $reconciled_expression_clauses = $if_context->reconciled_expression_clauses;
+
+            $if_context->clauses = array_values(
+                array_filter(
+                    $if_context->clauses,
+                    function ($c) use ($reconciled_expression_clauses) {
+                        return !in_array($c->getHash(), $reconciled_expression_clauses);
+                    }
+                )
+            );
+        }
 
         // define this before we alter local claues after reconciliation
         $if_scope->reasonable_clauses = $if_context->clauses;
@@ -231,7 +256,7 @@ class IfAnalyzer
             }
 
             if ($changed_var_ids) {
-                $if_context->removeReconciledClauses($changed_var_ids);
+                $if_context->clauses = Context::removeReconciledClauses($if_context->clauses, $changed_var_ids)[0];
             }
 
             $if_scope->if_cond_changed_var_ids = $changed_var_ids;
@@ -475,16 +500,9 @@ class IfAnalyzer
         IfScope $if_scope,
         ?int $branch_point
     ) {
-        // get the first expression in the if, which should be evaluated on its own
-        // this allows us to update the context of $matches in
-        // if (!preg_match('/a/', 'aa', $matches)) {
-        //   exit
-        // }
-        // echo $matches[0];
-        $first_if_cond_expr = self::getDefinitelyEvaluatedExpression($cond);
-
         $entry_clauses = [];
 
+        // used when evaluating elseifs
         if ($if_scope->negated_clauses) {
             $entry_clauses = array_merge($outer_context->clauses, $if_scope->negated_clauses);
 
@@ -528,6 +546,16 @@ class IfAnalyzer
             }
         }
 
+        // get the first expression in the if, which should be evaluated on its own
+        // this allows us to update the context of $matches in
+        // if (!preg_match('/a/', 'aa', $matches)) {
+        //   exit
+        // }
+        // echo $matches[0];
+        $externally_applied_if_cond_expr = self::getDefinitelyEvaluatedExpressionAfterIf($cond);
+
+        $internally_applied_if_cond_expr = self::getDefinitelyEvaluatedExpressionInsideIf($cond);
+
         $outer_context->inside_conditional = true;
 
         $pre_condition_vars_in_scope = $outer_context->vars_in_scope;
@@ -538,8 +566,18 @@ class IfAnalyzer
         $pre_assigned_var_ids = $outer_context->assigned_var_ids;
         $outer_context->assigned_var_ids = [];
 
-        if ($first_if_cond_expr) {
-            if (ExpressionAnalyzer::analyze($statements_analyzer, $first_if_cond_expr, $outer_context) === false) {
+        $if_context = null;
+
+        if ($internally_applied_if_cond_expr !== $externally_applied_if_cond_expr) {
+            $if_context = clone $outer_context;
+        }
+
+        if ($externally_applied_if_cond_expr) {
+            if (ExpressionAnalyzer::analyze(
+                $statements_analyzer,
+                $externally_applied_if_cond_expr,
+                $outer_context
+            ) === false) {
                 throw new \Psalm\Exception\ScopeAnalysisException();
             }
         }
@@ -558,7 +596,13 @@ class IfAnalyzer
 
         $outer_context->inside_conditional = false;
 
-        $if_context = clone $outer_context;
+        if (!$if_context) {
+            $if_context = clone $outer_context;
+        }
+
+        $if_conditional_context = clone $if_context;
+        $if_conditional_context->if_context = $if_context;
+        $if_conditional_context->if_scope = $if_scope;
 
         if ($codebase->alter_code) {
             $if_context->branch_point = $branch_point;
@@ -568,22 +612,24 @@ class IfAnalyzer
         // to $outer_context don't mess with elseif/else blocks
         $original_context = clone $outer_context;
 
-        $if_context->inside_conditional = true;
+        $if_conditional_context->inside_conditional = true;
 
-        if ($first_if_cond_expr !== $cond) {
+        if ($internally_applied_if_cond_expr !== $cond
+            || $externally_applied_if_cond_expr !== $cond
+        ) {
             $assigned_var_ids = $outer_context->assigned_var_ids;
-            $if_context->assigned_var_ids = [];
+            $if_conditional_context->assigned_var_ids = [];
 
             $referenced_var_ids = $outer_context->referenced_var_ids;
-            $if_context->referenced_var_ids = [];
+            $if_conditional_context->referenced_var_ids = [];
 
-            if (ExpressionAnalyzer::analyze($statements_analyzer, $cond, $if_context) === false) {
+            if (ExpressionAnalyzer::analyze($statements_analyzer, $cond, $if_conditional_context) === false) {
                 throw new \Psalm\Exception\ScopeAnalysisException();
             }
 
             /** @var array<string, bool> */
-            $more_cond_referenced_var_ids = $if_context->referenced_var_ids;
-            $if_context->referenced_var_ids = array_merge(
+            $more_cond_referenced_var_ids = $if_conditional_context->referenced_var_ids;
+            $if_conditional_context->referenced_var_ids = array_merge(
                 $more_cond_referenced_var_ids,
                 $referenced_var_ids
             );
@@ -594,8 +640,8 @@ class IfAnalyzer
             );
 
             /** @var array<string, bool> */
-            $more_cond_assigned_var_ids = $if_context->assigned_var_ids;
-            $if_context->assigned_var_ids = array_merge(
+            $more_cond_assigned_var_ids = $if_conditional_context->assigned_var_ids;
+            $if_conditional_context->assigned_var_ids = array_merge(
                 $more_cond_assigned_var_ids,
                 $assigned_var_ids
             );
@@ -620,7 +666,7 @@ class IfAnalyzer
                 return true;
             },
             array_diff_key(
-                $if_context->vars_in_scope,
+                $if_conditional_context->vars_in_scope,
                 $pre_condition_vars_in_scope,
                 $cond_referenced_var_ids,
                 $cond_assigned_var_ids
@@ -646,7 +692,7 @@ class IfAnalyzer
 
         $cond_referenced_var_ids = array_merge($newish_var_ids, $cond_referenced_var_ids);
 
-        $if_context->inside_conditional = false;
+        $if_conditional_context->inside_conditional = false;
 
         return new \Psalm\Internal\Scope\IfConditionalScope(
             $if_context,
@@ -1039,12 +1085,29 @@ class IfAnalyzer
             $cond_assigned_var_ids
         );
 
-        $elseif_context->clauses = Algebra::simplifyCNF(
-            array_merge(
+        if ($if_scope->if_cond_changed_var_ids) {
+            $entry_clauses = Context::removeOverwrittenClauses(
                 $entry_clauses,
-                $elseif_clauses
-            )
-        );
+                $if_scope->if_cond_changed_var_ids
+            );
+        }
+
+        $elseif_context_clauses = array_merge($entry_clauses, $elseif_clauses);
+
+        if ($elseif_context->reconciled_expression_clauses) {
+            $reconciled_expression_clauses = $elseif_context->reconciled_expression_clauses;
+
+            $elseif_context_clauses = array_values(
+                array_filter(
+                    $elseif_context_clauses,
+                    function ($c) use ($reconciled_expression_clauses) {
+                        return !in_array($c->getHash(), $reconciled_expression_clauses);
+                    }
+                )
+            );
+        }
+
+        $elseif_context->clauses = Algebra::simplifyCNF($elseif_context_clauses);
 
         try {
             if (array_filter(
@@ -1124,7 +1187,10 @@ class IfAnalyzer
             $elseif_context->vars_in_scope = $elseif_vars_reconciled;
 
             if ($changed_var_ids) {
-                $elseif_context->removeReconciledClauses($changed_var_ids);
+                $elseif_context->clauses = Context::removeReconciledClauses(
+                    $elseif_context->clauses,
+                    $changed_var_ids
+                )[0];
             }
         }
 
@@ -1462,7 +1528,7 @@ class IfAnalyzer
 
             $else_context->vars_in_scope = $else_vars_reconciled;
 
-            $else_context->removeReconciledClauses($changed_var_ids);
+            $else_context->clauses = Context::removeReconciledClauses($else_context->clauses, $changed_var_ids)[0];
         }
 
         $old_else_context = clone $else_context;
@@ -1691,19 +1757,59 @@ class IfAnalyzer
      *
      * @return PhpParser\Node\Expr|null
      */
-    public static function getDefinitelyEvaluatedExpression(PhpParser\Node\Expr $stmt)
+    private static function getDefinitelyEvaluatedExpressionAfterIf(PhpParser\Node\Expr $stmt)
     {
         if ($stmt instanceof PhpParser\Node\Expr\BinaryOp) {
             if ($stmt instanceof PhpParser\Node\Expr\BinaryOp\BooleanAnd
                 || $stmt instanceof PhpParser\Node\Expr\BinaryOp\LogicalAnd
                 || $stmt instanceof PhpParser\Node\Expr\BinaryOp\LogicalXor
             ) {
-                return self::getDefinitelyEvaluatedExpression($stmt->left);
+                return self::getDefinitelyEvaluatedExpressionAfterIf($stmt->left);
             }
 
             return $stmt;
         }
 
+        if ($stmt instanceof PhpParser\Node\Expr\BooleanNot) {
+            $inner_stmt = self::getDefinitelyEvaluatedExpressionInsideIf($stmt->expr);
+
+            if ($inner_stmt !== $stmt->expr) {
+                return $inner_stmt;
+            }
+        }
+
+        return $stmt;
+    }
+
+    /**
+     * Returns statements that are definitely evaluated before any statements inside
+     * the if block
+     *
+     * @param  PhpParser\Node\Expr $stmt
+     *
+     * @return PhpParser\Node\Expr|null
+     */
+    private static function getDefinitelyEvaluatedExpressionInsideIf(PhpParser\Node\Expr $stmt)
+    {
+        if ($stmt instanceof PhpParser\Node\Expr\BinaryOp) {
+            if ($stmt instanceof PhpParser\Node\Expr\BinaryOp\BooleanOr
+                || $stmt instanceof PhpParser\Node\Expr\BinaryOp\LogicalOr
+                || $stmt instanceof PhpParser\Node\Expr\BinaryOp\LogicalXor
+            ) {
+                return self::getDefinitelyEvaluatedExpressionInsideIf($stmt->left);
+            }
+
+            return $stmt;
+        }
+
+        if ($stmt instanceof PhpParser\Node\Expr\BooleanNot) {
+            $inner_stmt = self::getDefinitelyEvaluatedExpressionAfterIf($stmt->expr);
+
+            if ($inner_stmt !== $stmt->expr) {
+                return $inner_stmt;
+            }
+        }
+
         return $stmt;
     }
 }
diff --git a/src/Psalm/Internal/Analyzer/Statements/Block/LoopAnalyzer.php b/src/Psalm/Internal/Analyzer/Statements/Block/LoopAnalyzer.php
index 3f236140e..e59e1b6d7 100644
--- a/src/Psalm/Internal/Analyzer/Statements/Block/LoopAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/Statements/Block/LoopAnalyzer.php
@@ -309,6 +309,8 @@ class LoopAnalyzer
                     unset($inner_context->vars_in_scope[$var_id]);
                 }
 
+                $inner_context->clauses = $pre_loop_context->clauses;
+
                 $analyzer->setMixedCountsForFile($statements_analyzer->getFilePath(), $original_mixed_counts);
                 IssueBuffer::startRecording();
 
diff --git a/src/Psalm/Internal/Analyzer/Statements/Block/SwitchAnalyzer.php b/src/Psalm/Internal/Analyzer/Statements/Block/SwitchAnalyzer.php
index a2767c85e..f8b6f83bb 100644
--- a/src/Psalm/Internal/Analyzer/Statements/Block/SwitchAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/Statements/Block/SwitchAnalyzer.php
@@ -514,7 +514,7 @@ class SwitchAnalyzer
             }
 
             if ($changed_var_ids) {
-                $case_context->removeReconciledClauses($changed_var_ids);
+                $case_context->clauses = Context::removeReconciledClauses($case_context->clauses, $changed_var_ids)[0];
             }
         }
 
diff --git a/src/Psalm/Internal/Analyzer/Statements/Expression/BinaryOpAnalyzer.php b/src/Psalm/Internal/Analyzer/Statements/Expression/BinaryOpAnalyzer.php
index b8cb82954..abd7e119b 100644
--- a/src/Psalm/Internal/Analyzer/Statements/Expression/BinaryOpAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/Statements/Expression/BinaryOpAnalyzer.php
@@ -85,20 +85,33 @@ class BinaryOpAnalyzer
             );
 
             $pre_referenced_var_ids = $context->referenced_var_ids;
-            $context->referenced_var_ids = [];
             $original_vars_in_scope = $context->vars_in_scope;
 
             $pre_assigned_var_ids = $context->assigned_var_ids;
 
-            if (ExpressionAnalyzer::analyze($statements_analyzer, $stmt->left, $context) === false) {
+            $left_context = clone $context;
+
+            $left_context->referenced_var_ids = [];
+            $left_context->assigned_var_ids = [];
+
+            /** @var list<string> */
+            $left_context->reconciled_expression_clauses = [];
+
+            if (ExpressionAnalyzer::analyze($statements_analyzer, $stmt->left, $left_context) === false) {
                 return false;
             }
 
+            foreach ($left_context->vars_in_scope as $var_id => $type) {
+                if (isset($left_context->assigned_var_ids[$var_id])) {
+                    $context->vars_in_scope[$var_id] = $type;
+                }
+            }
+
             /** @var array<string, bool> */
-            $new_referenced_var_ids = $context->referenced_var_ids;
+            $new_referenced_var_ids = $left_context->referenced_var_ids;
             $context->referenced_var_ids = array_merge($pre_referenced_var_ids, $new_referenced_var_ids);
 
-            $new_assigned_var_ids = array_diff_key($context->assigned_var_ids, $pre_assigned_var_ids);
+            $new_assigned_var_ids = array_diff_key($left_context->assigned_var_ids, $pre_assigned_var_ids);
 
             $new_referenced_var_ids = array_diff_key($new_referenced_var_ids, $new_assigned_var_ids);
 
@@ -116,13 +129,28 @@ class BinaryOpAnalyzer
                 ARRAY_FILTER_USE_KEY
             );
 
-            $simplified_clauses = Algebra::simplifyCNF(array_merge($context->clauses, $left_clauses));
+            $context_clauses = array_merge($left_context->clauses, $left_clauses);
+
+            if ($left_context->reconciled_expression_clauses) {
+                $reconciled_expression_clauses = $left_context->reconciled_expression_clauses;
+
+                $context_clauses = array_values(
+                    array_filter(
+                        $context_clauses,
+                        function ($c) use ($reconciled_expression_clauses) {
+                            return !\in_array($c->getHash(), $reconciled_expression_clauses);
+                        }
+                    )
+                );
+            }
+
+            $simplified_clauses = Algebra::simplifyCNF($context_clauses);
 
             $left_type_assertions = Algebra::getTruthsFromFormula($simplified_clauses);
 
             $changed_var_ids = [];
 
-            $op_context = clone $context;
+            $right_context = clone $left_context;
 
             if ($left_type_assertions) {
                 // while in an and, we allow scope to boil over to support
@@ -138,52 +166,83 @@ class BinaryOpAnalyzer
                     new CodeLocation($statements_analyzer->getSource(), $stmt)
                 );
 
-                $op_context->vars_in_scope = $op_vars_in_scope;
+                $right_context->vars_in_scope = $op_vars_in_scope;
+
+                if ($context->if_scope) {
+                    $context->if_scope->if_cond_changed_var_ids += $changed_var_ids;
+                }
             }
 
-            $op_context->removeReconciledClauses($changed_var_ids);
+            $partitioned_clauses = Context::removeReconciledClauses($left_clauses, $changed_var_ids);
 
-            if (ExpressionAnalyzer::analyze($statements_analyzer, $stmt->right, $op_context) === false) {
+            $right_context->clauses = $partitioned_clauses[0];
+
+            if (ExpressionAnalyzer::analyze($statements_analyzer, $stmt->right, $right_context) === false) {
                 return false;
             }
 
             $context->referenced_var_ids = array_merge(
-                $op_context->referenced_var_ids,
-                $context->referenced_var_ids
+                $right_context->referenced_var_ids,
+                $left_context->referenced_var_ids
             );
 
             if ($context->collect_references) {
-                $context->unreferenced_vars = $op_context->unreferenced_vars;
+                $context->unreferenced_vars = $right_context->unreferenced_vars;
             }
 
-            foreach ($op_context->vars_in_scope as $var_id => $type) {
-                if (isset($context->vars_in_scope[$var_id])) {
-                    $context->vars_in_scope[$var_id] = Type::combineUnionTypes(
-                        $context->vars_in_scope[$var_id],
-                        $type,
-                        $codebase
-                    );
-                }
+            if ($context->inside_conditional) {
+                $context->updateChecks($right_context);
+
+                $context->vars_possibly_in_scope = array_merge(
+                    $right_context->vars_possibly_in_scope,
+                    $left_context->vars_possibly_in_scope
+                );
+
+                $context->assigned_var_ids = array_merge(
+                    $left_context->assigned_var_ids,
+                    $right_context->assigned_var_ids
+                );
             }
 
-            if ($context->inside_conditional) {
-                foreach ($op_context->vars_in_scope as $var => $type) {
-                    if (!isset($context->vars_in_scope[$var]) && !$type->possibly_undefined) {
-                        $context->vars_in_scope[$var] = $type;
+            if ($context->if_context && !$context->inside_negation) {
+                $context->vars_in_scope = $right_context->vars_in_scope;
+                $if_context = $context->if_context;
+
+                foreach ($right_context->vars_in_scope as $var_id => $type) {
+                    if (!isset($if_context->vars_in_scope[$var_id])) {
+                        $if_context->vars_in_scope[$var_id] = $type;
+                    } elseif (isset($context->vars_in_scope[$var_id])) {
+                        $if_context->vars_in_scope[$var_id] = $context->vars_in_scope[$var_id];
                     }
                 }
 
-                $context->updateChecks($op_context);
-
-                $context->vars_possibly_in_scope = array_merge(
-                    $op_context->vars_possibly_in_scope,
-                    $context->vars_possibly_in_scope
+                $if_context->referenced_var_ids = array_merge(
+                    $context->referenced_var_ids,
+                    $if_context->referenced_var_ids
                 );
 
-                $context->assigned_var_ids = array_merge(
+                $if_context->assigned_var_ids = array_merge(
                     $context->assigned_var_ids,
-                    $op_context->assigned_var_ids
+                    $if_context->assigned_var_ids
                 );
+
+                if ($context->collect_references) {
+                    $if_context->unreferenced_vars = $context->unreferenced_vars;
+                }
+
+                $if_context->reconciled_expression_clauses = array_merge(
+                    $context->if_context->reconciled_expression_clauses,
+                    array_map(
+                        function ($c) {
+                            return $c->getHash();
+                        },
+                        $partitioned_clauses[1]
+                    )
+                );
+
+                $if_context->updateChecks($context);
+            } else {
+                $context->vars_in_scope = $left_context->vars_in_scope;
             }
         } elseif ($stmt instanceof PhpParser\Node\Expr\BinaryOp\BooleanOr ||
             $stmt instanceof PhpParser\Node\Expr\BinaryOp\LogicalOr
@@ -193,28 +252,36 @@ class BinaryOpAnalyzer
 
             $pre_assigned_var_ids = $context->assigned_var_ids;
 
-            $pre_op_context = clone $context;
-            $pre_op_context->parent_context = $context;
+            $left_context = clone $context;
+            $left_context->parent_context = $context;
+            $left_context->assigned_var_ids = [];
 
-            if (ExpressionAnalyzer::analyze($statements_analyzer, $stmt->left, $pre_op_context) === false) {
+            if (ExpressionAnalyzer::analyze($statements_analyzer, $stmt->left, $left_context) === false) {
                 return false;
             }
 
-            foreach ($pre_op_context->vars_in_scope as $var_id => $type) {
+            foreach ($left_context->vars_in_scope as $var_id => $type) {
                 if (!isset($context->vars_in_scope[$var_id])) {
-                    $context->vars_in_scope[$var_id] = clone $type;
+                    if (isset($left_context->assigned_var_ids[$var_id])) {
+                        $context->vars_in_scope[$var_id] = clone $type;
+                    }
                 } else {
                     $context->vars_in_scope[$var_id] = Type::combineUnionTypes(
                         $context->vars_in_scope[$var_id],
-                        $type
+                        $type,
+                        $codebase
                     );
                 }
             }
 
-            $new_referenced_var_ids = $pre_op_context->referenced_var_ids;
-            $pre_op_context->referenced_var_ids = array_merge($pre_referenced_var_ids, $new_referenced_var_ids);
+            if ($context->collect_references) {
+                $context->unreferenced_vars = $left_context->unreferenced_vars;
+            }
+
+            $new_referenced_var_ids = $left_context->referenced_var_ids;
+            $left_context->referenced_var_ids = array_merge($pre_referenced_var_ids, $new_referenced_var_ids);
 
-            $new_assigned_var_ids = array_diff_key($pre_op_context->assigned_var_ids, $pre_assigned_var_ids);
+            $new_assigned_var_ids = array_diff_key($left_context->assigned_var_ids, $pre_assigned_var_ids);
 
             $new_referenced_var_ids = array_diff_key($new_referenced_var_ids, $new_assigned_var_ids);
 
@@ -231,9 +298,22 @@ class BinaryOpAnalyzer
                 return false;
             }
 
+            if ($left_context->reconciled_expression_clauses) {
+                $reconciled_expression_clauses = $left_context->reconciled_expression_clauses;
+
+                $negated_left_clauses = array_values(
+                    array_filter(
+                        $negated_left_clauses,
+                        function ($c) use ($reconciled_expression_clauses) {
+                            return !\in_array($c->getHash(), $reconciled_expression_clauses);
+                        }
+                    )
+                );
+            }
+
             $clauses_for_right_analysis = Algebra::simplifyCNF(
                 array_merge(
-                    $pre_op_context->clauses,
+                    $context->clauses,
                     $negated_left_clauses
                 )
             );
@@ -242,19 +322,19 @@ class BinaryOpAnalyzer
 
             $changed_var_ids = [];
 
-            $op_context = clone $pre_op_context;
+            $op_context = clone $context;
 
             if ($negated_type_assertions) {
                 // while in an or, we allow scope to boil over to support
                 // statements of the form if ($x === null || $x->foo())
                 $op_vars_in_scope = Reconciler::reconcileKeyedTypes(
                     $negated_type_assertions,
-                    $pre_op_context->vars_in_scope,
+                    $op_context->vars_in_scope,
                     $changed_var_ids,
                     $new_referenced_var_ids,
                     $statements_analyzer,
                     [],
-                    $pre_op_context->inside_loop,
+                    $left_context->inside_loop,
                     new CodeLocation($statements_analyzer->getSource(), $stmt)
                 );
                 $op_context->vars_in_scope = $op_vars_in_scope;
@@ -263,10 +343,33 @@ class BinaryOpAnalyzer
             $op_context->clauses = $clauses_for_right_analysis;
 
             if ($changed_var_ids) {
-                $op_context->removeReconciledClauses($changed_var_ids);
-                $context->removeReconciledClauses($changed_var_ids);
+                $partitioned_clauses = Context::removeReconciledClauses($op_context->clauses, $changed_var_ids);
+                $op_context->clauses = $partitioned_clauses[0];
+                $op_context->reconciled_expression_clauses = array_merge(
+                    $context->reconciled_expression_clauses,
+                    array_map(
+                        function ($c) {
+                            return $c->getHash();
+                        },
+                        $partitioned_clauses[1]
+                    )
+                );
+
+                $partitioned_clauses = Context::removeReconciledClauses($context->clauses, $changed_var_ids);
+                $context->clauses = $partitioned_clauses[0];
+                $context->reconciled_expression_clauses = array_merge(
+                    $context->reconciled_expression_clauses,
+                    array_map(
+                        function ($c) {
+                            return $c->getHash();
+                        },
+                        $partitioned_clauses[1]
+                    )
+                );
             }
 
+            $op_context->if_context = null;
+
             if (ExpressionAnalyzer::analyze($statements_analyzer, $stmt->right, $op_context) === false) {
                 return false;
             }
@@ -276,17 +379,18 @@ class BinaryOpAnalyzer
                     if (isset($context->vars_in_scope[$var_id])) {
                         $context->vars_in_scope[$var_id] = Type::combineUnionTypes(
                             $context->vars_in_scope[$var_id],
-                            $type
+                            $type,
+                            $codebase
                         );
                     }
                 }
             } elseif ($stmt->left instanceof PhpParser\Node\Expr\Assign) {
                 $var_id = ExpressionAnalyzer::getVarId($stmt->left->var, $context->self);
 
-                if ($var_id && isset($pre_op_context->vars_in_scope[$var_id])) {
+                if ($var_id && isset($left_context->vars_in_scope[$var_id])) {
                     $left_inferred_reconciled = AssertionReconciler::reconcile(
                         '!falsy',
-                        clone $pre_op_context->vars_in_scope[$var_id],
+                        clone $left_context->vars_in_scope[$var_id],
                         '',
                         $statements_analyzer,
                         $context->inside_loop,
@@ -330,6 +434,38 @@ class BinaryOpAnalyzer
                 }
             }
 
+            if ($context->if_context) {
+                $if_context = $context->if_context;
+
+                foreach ($op_context->vars_in_scope as $var_id => $type) {
+                    if (isset($if_context->vars_in_scope[$var_id])) {
+                        $if_context->vars_in_scope[$var_id] = Type::combineUnionTypes(
+                            $type,
+                            $if_context->vars_in_scope[$var_id],
+                            $codebase
+                        );
+                    } elseif (isset($left_context->vars_in_scope[$var_id])) {
+                        $if_context->vars_in_scope[$var_id] = $left_context->vars_in_scope[$var_id];
+                    }
+                }
+
+                $if_context->referenced_var_ids = array_merge(
+                    $context->referenced_var_ids,
+                    $if_context->referenced_var_ids
+                );
+
+                $if_context->assigned_var_ids = array_merge(
+                    $context->assigned_var_ids,
+                    $if_context->assigned_var_ids
+                );
+
+                if ($context->collect_references) {
+                    $if_context->unreferenced_vars = $context->unreferenced_vars;
+                }
+
+                $if_context->updateChecks($context);
+            }
+
             $context->vars_possibly_in_scope = array_merge(
                 $op_context->vars_possibly_in_scope,
                 $context->vars_possibly_in_scope
@@ -496,7 +632,11 @@ class BinaryOpAnalyzer
 
             foreach ($t_if_context->vars_in_scope as $var_id => $type) {
                 if (isset($context->vars_in_scope[$var_id])) {
-                    $context->vars_in_scope[$var_id] = Type::combineUnionTypes($context->vars_in_scope[$var_id], $type);
+                    $context->vars_in_scope[$var_id] = Type::combineUnionTypes(
+                        $context->vars_in_scope[$var_id],
+                        $type,
+                        $codebase
+                    );
                 } else {
                     $context->vars_in_scope[$var_id] = $type;
                 }
@@ -571,7 +711,11 @@ class BinaryOpAnalyzer
 
                 $statements_analyzer->node_data->setType($stmt, $stmt_type);
             } else {
-                $stmt_type = Type::combineUnionTypes($lhs_type, $stmt_right_type);
+                $stmt_type = Type::combineUnionTypes(
+                    $lhs_type,
+                    $stmt_right_type,
+                    $codebase
+                );
 
                 $statements_analyzer->node_data->setType($stmt, $stmt_type);
             }
diff --git a/src/Psalm/Internal/Analyzer/Statements/Expression/Fetch/ConstFetchAnalyzer.php b/src/Psalm/Internal/Analyzer/Statements/Expression/Fetch/ConstFetchAnalyzer.php
index fcd6f7c6b..4516c9f74 100644
--- a/src/Psalm/Internal/Analyzer/Statements/Expression/Fetch/ConstFetchAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/Statements/Expression/Fetch/ConstFetchAnalyzer.php
@@ -103,7 +103,7 @@ class ConstFetchAnalyzer
 
         $predefined_constants = $codebase->config->getPredefinedConstants();
 
-        if ($fq_const_name && array_key_exists($fq_const_name, $predefined_constants)
+        if (($fq_const_name && array_key_exists($fq_const_name, $predefined_constants))
             || array_key_exists($const_name, $predefined_constants)
         ) {
             switch ($const_name) {
diff --git a/src/Psalm/Internal/Analyzer/Statements/Expression/TernaryAnalyzer.php b/src/Psalm/Internal/Analyzer/Statements/Expression/TernaryAnalyzer.php
index e0373f445..802841cac 100644
--- a/src/Psalm/Internal/Analyzer/Statements/Expression/TernaryAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/Statements/Expression/TernaryAnalyzer.php
@@ -83,7 +83,6 @@ class TernaryAnalyzer
             }
         }
 
-
         $if_clauses = array_values(
             array_map(
                 /**
@@ -108,7 +107,22 @@ class TernaryAnalyzer
             )
         );
 
-        $ternary_clauses = Algebra::simplifyCNF(array_merge($context->clauses, $if_clauses));
+        $ternary_clauses = array_merge($context->clauses, $if_clauses);
+
+        if ($if_context->reconciled_expression_clauses) {
+            $reconciled_expression_clauses = $if_context->reconciled_expression_clauses;
+
+            $ternary_clauses = array_values(
+                array_filter(
+                    $ternary_clauses,
+                    function ($c) use ($reconciled_expression_clauses) {
+                        return !\in_array($c->getHash(), $reconciled_expression_clauses);
+                    }
+                )
+            );
+        }
+
+        $ternary_clauses = Algebra::simplifyCNF($ternary_clauses);
 
         $negated_clauses = Algebra::negateFormula($if_clauses);
 
diff --git a/src/Psalm/Internal/LanguageServer/ProtocolStreamReader.php b/src/Psalm/Internal/LanguageServer/ProtocolStreamReader.php
index 23c4e751c..e296d9c59 100644
--- a/src/Psalm/Internal/LanguageServer/ProtocolStreamReader.php
+++ b/src/Psalm/Internal/LanguageServer/ProtocolStreamReader.php
@@ -51,8 +51,14 @@ class ProtocolStreamReader implements ProtocolReader
              * @psalm-suppress MixedReturnTypeCoercion
              */
             function () use ($input) : \Generator {
-                while ($this->is_accepting_new_requests && ($chunk = yield $input->read()) !== null) {
-                    /** @var string $chunk */
+                while ($this->is_accepting_new_requests) {
+                    /** @var ?string $chunk */
+                    $chunk = yield $input->read();
+
+                    if ($chunk === null) {
+                        break;
+                    }
+
                     if ($this->readMessages($chunk) > 0) {
                         $this->emit('readMessageGroup');
                     }
diff --git a/tests/TypeReconciliation/ConditionalTest.php b/tests/TypeReconciliation/ConditionalTest.php
index df01515a9..b760a9fe6 100644
--- a/tests/TypeReconciliation/ConditionalTest.php
+++ b/tests/TypeReconciliation/ConditionalTest.php
@@ -1840,6 +1840,21 @@ class ConditionalTest extends \Psalm\Tests\TestCase
                         return false;
                     }'
             ],
+            'assertVarRedefinedInIfWithAnd' => [
+                '<?php
+                    class O {}
+
+                    /**
+                     * @param mixed $value
+                     */
+                    function exampleWithAnd($value): O {
+                        if (is_string($value) && ($value = rand(0, 1) ? new O : null) !== null) {
+                            return $value;
+                        }
+
+                        return new O();
+                    }'
+            ],
             'SKIPPED-assertVarRedefinedInIfWithOr' => [
                 '<?php
                     class O {}
@@ -1855,6 +1870,25 @@ class ConditionalTest extends \Psalm\Tests\TestCase
                         return $value;
                     }'
             ],
+            'assertVarRedefinedInIfWithExtraIf' => [
+                '<?php
+                    class O {}
+
+                    /**
+                     * @param mixed $value
+                     */
+                    function exampleWithOr($value): O {
+                        if (!is_string($value)) {
+                            return new O();
+                        }
+
+                        if (($value = rand(0, 1) ? new O : null) === null) {
+                            return new O();
+                        }
+
+                        return $value;
+                    }'
+            ],
             'SKIPPED-assertVarRedefinedInOpWithAnd' => [
                 '<?php
                     class O {
@@ -1864,7 +1898,7 @@ class ConditionalTest extends \Psalm\Tests\TestCase
                     /** @var mixed */
                     $value = $_GET["foo"];
 
-                    $a = is_string($value) && (($value = rand(0, 1) ? new O : null) !== null) && $value->foo();',
+                    $a = is_string($value) && (($valu = rand(0, 1) ? new O : null) !== null) && $valu->foo();',
                 [
                     '$a' => 'bool',
                 ]
@@ -1883,21 +1917,6 @@ class ConditionalTest extends \Psalm\Tests\TestCase
                     '$a' => 'bool',
                 ]
             ],
-            'SKIPPED-assertVarRedefinedInIfWithAnd' => [
-                '<?php
-                    class O {}
-
-                    /**
-                     * @param mixed $value
-                     */
-                    function exampleWithAnd($value): O {
-                        if (is_string($value) && ($value = rand(0, 1) ? new O : null) !== null) {
-                            return $value;
-                        }
-
-                        return new O();
-                    }'
-            ],
             'assertVarInOrAfterAnd' => [
                 '<?php
                     class A {}
