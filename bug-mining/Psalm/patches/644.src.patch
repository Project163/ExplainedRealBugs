diff --git a/examples/plugins/FunctionCasingChecker.php b/examples/plugins/FunctionCasingChecker.php
index fed04903f..7622a2477 100644
--- a/examples/plugins/FunctionCasingChecker.php
+++ b/examples/plugins/FunctionCasingChecker.php
@@ -92,7 +92,7 @@ class FunctionCasingChecker implements AfterFunctionCallAnalysisInterface, After
                 $statements_source instanceof \Psalm\Internal\Analyzer\StatementsAnalyzer
                     ? $statements_source
                     : null,
-                $function_id
+                strtolower($function_id)
             );
 
             if (!$function_storage->cased_name) {
diff --git a/src/Psalm/Codebase.php b/src/Psalm/Codebase.php
index 2271d235c..d858d26ff 100644
--- a/src/Psalm/Codebase.php
+++ b/src/Psalm/Codebase.php
@@ -872,7 +872,7 @@ class Codebase
             return $this->methods->getStorage($declaring_method_id);
         }
 
-        return $this->functions->getStorage($statements_analyzer, $function_id);
+        return $this->functions->getStorage($statements_analyzer, strtolower($function_id));
     }
 
     /**
@@ -1307,7 +1307,7 @@ class Codebase
             $params = $method_storage->params;
         } else {
             try {
-                $function_storage = $this->functions->getStorage(null, $function_symbol);
+                $function_storage = $this->functions->getStorage(null, strtolower($function_symbol));
 
                 $params = $function_storage->params;
             } catch (\Exception $exception) {
diff --git a/src/Psalm/Internal/Analyzer/FunctionLikeAnalyzer.php b/src/Psalm/Internal/Analyzer/FunctionLikeAnalyzer.php
index 4f0bcdf00..e1c3daad8 100644
--- a/src/Psalm/Internal/Analyzer/FunctionLikeAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/FunctionLikeAnalyzer.php
@@ -1549,7 +1549,7 @@ abstract class FunctionLikeAnalyzer extends SourceAnalyzer
             throw new \UnexpectedValueException('This is weird');
         }
 
-        return $codebase->functions->getStorage($statements_analyzer, $function_id);
+        return $codebase->functions->getStorage($statements_analyzer, strtolower($function_id));
     }
 
     public function getId() : string
diff --git a/src/Psalm/Internal/Analyzer/StatementsAnalyzer.php b/src/Psalm/Internal/Analyzer/StatementsAnalyzer.php
index 25e023510..c0322e094 100644
--- a/src/Psalm/Internal/Analyzer/StatementsAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/StatementsAnalyzer.php
@@ -724,7 +724,7 @@ class StatementsAnalyzer extends SourceAnalyzer implements StatementsSource
 
                             $function_storage = $codebase->functions->getStorage(
                                 $this,
-                                $method_id
+                                strtolower($method_id)
                             );
 
                             $return_type = $function_storage->return_type;
diff --git a/src/Psalm/Internal/Analyzer/TypeAnalyzer.php b/src/Psalm/Internal/Analyzer/TypeAnalyzer.php
index 60f72ec14..7d4b4b919 100644
--- a/src/Psalm/Internal/Analyzer/TypeAnalyzer.php
+++ b/src/Psalm/Internal/Analyzer/TypeAnalyzer.php
@@ -1869,7 +1869,7 @@ class TypeAnalyzer
             try {
                 $function_storage = $codebase->functions->getStorage(
                     $statements_analyzer,
-                    $input_type_part->value
+                    strtolower($input_type_part->value)
                 );
 
                 return new TCallable(
diff --git a/src/Psalm/Internal/Codebase/Functions.php b/src/Psalm/Internal/Codebase/Functions.php
index 462ae7c0e..298a01399 100644
--- a/src/Psalm/Internal/Codebase/Functions.php
+++ b/src/Psalm/Internal/Codebase/Functions.php
@@ -28,7 +28,7 @@ class Functions
     private $file_storage_provider;
 
     /**
-     * @var array<string, FunctionLikeStorage>
+     * @var array<lowercase-string, FunctionLikeStorage>
      */
     private static $stubbed_functions;
 
@@ -57,14 +57,21 @@ class Functions
         self::$stubbed_functions = [];
     }
 
+    /**
+     * @param lowercase-string $function_id
+     */
     public function getStorage(
         ?StatementsAnalyzer $statements_analyzer,
         string $function_id,
         ?string $root_file_path = null,
         ?string $checked_file_path = null
     ) : FunctionLikeStorage {
-        if (isset(self::$stubbed_functions[strtolower($function_id)])) {
-            return self::$stubbed_functions[strtolower($function_id)];
+        if ($function_id[0] === '\\') {
+            $function_id = substr($function_id, 1);
+        }
+
+        if (isset(self::$stubbed_functions[$function_id])) {
+            return self::$stubbed_functions[$function_id];
         }
 
         $file_storage = null;
diff --git a/src/Psalm/Internal/Scanner/PhpStormMetaScanner.php b/src/Psalm/Internal/Scanner/PhpStormMetaScanner.php
index 06ea5d0b2..6aea4ff49 100644
--- a/src/Psalm/Internal/Scanner/PhpStormMetaScanner.php
+++ b/src/Psalm/Internal/Scanner/PhpStormMetaScanner.php
@@ -300,7 +300,7 @@ class PhpStormMetaScanner
 
                         $storage = $statements_analyzer->getCodebase()->functions->getStorage(
                             $statements_analyzer,
-                            $function_id
+                            strtolower($function_id)
                         );
 
                         return $storage->return_type ?: Type::getMixed();
@@ -335,7 +335,7 @@ class PhpStormMetaScanner
 
                         $storage = $statements_analyzer->getCodebase()->functions->getStorage(
                             $statements_analyzer,
-                            $function_id
+                            strtolower($function_id)
                         );
 
                         return $storage->return_type ?: Type::getMixed();
@@ -385,7 +385,7 @@ class PhpStormMetaScanner
 
                         $storage = $statements_analyzer->getCodebase()->functions->getStorage(
                             $statements_analyzer,
-                            $function_id
+                            strtolower($function_id)
                         );
 
                         return $storage->return_type ?: Type::getMixed();
diff --git a/tests/Template/FunctionTemplateTest.php b/tests/Template/FunctionTemplateTest.php
index faa5e09a7..df1f29b06 100644
--- a/tests/Template/FunctionTemplateTest.php
+++ b/tests/Template/FunctionTemplateTest.php
@@ -1227,6 +1227,33 @@ class FunctionTemplateTest extends TestCase
 
                     createProxy(A::class, function(object $o):void {})->bar();'
             ],
+            'bottomTypeInNamespacedCallableShouldMatch' => [
+                '<?php
+                    namespace Ns;
+
+                    /**
+                     * @template T
+                     * @param class-string<T> $className
+                     * @param callable(T):void $outmaker
+                     * @return T
+                     */
+                    function createProxy(
+                        string $className,
+                        callable $outmaker
+                    ) : object {
+                        $t = new $className();
+                        $outmaker($t);
+                        return $t;
+                    }
+
+                    class A {
+                        public function bar() : void {}
+                    }
+
+                    function foo(A $o):void {}
+
+                    createProxy(A::class, \'Ns\foo\')->bar();',
+            ],
         ];
     }
 
@@ -1736,6 +1763,36 @@ class FunctionTemplateTest extends TestCase
                     createProxy(A::class, function(B $o):void {})->bar();',
                 'error_message' => 'InvalidArgument'
             ],
+            'bottomTypeInNamespacedCallableShouldClash' => [
+                '<?php
+                    namespace Ns;
+
+                    /**
+                     * @template T
+                     * @param class-string<T> $className
+                     * @param callable(T):void $outmaker
+                     * @return T
+                     */
+                    function createProxy(
+                        string $className,
+                        callable $outmaker
+                    ) : object {
+                        $t = new $className();
+                        $outmaker($t);
+                        return $t;
+                    }
+
+                    class A {
+                        public function bar() : void {}
+                    }
+
+                    class B {}
+
+                    function foo(B $o):void {}
+
+                    createProxy(A::class, \'Ns\foo\')->bar();',
+                'error_message' => 'InvalidArgument'
+            ],
         ];
     }
 }
