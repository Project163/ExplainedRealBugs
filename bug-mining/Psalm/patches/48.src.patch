diff --git a/src/Psalm/Internal/Codebase/Scanner.php b/src/Psalm/Internal/Codebase/Scanner.php
index 1b333daad..ba1ee0cf1 100644
--- a/src/Psalm/Internal/Codebase/Scanner.php
+++ b/src/Psalm/Internal/Codebase/Scanner.php
@@ -632,7 +632,11 @@ class Scanner
 
             if ($this->codebase->register_autoload_files) {
                 foreach ($file_storage->functions as $function_storage) {
-                    $this->codebase->functions->addGlobalFunction($function_storage->cased_name, $function_storage);
+                    if ($this->codebase->register_stub_files
+                        || $this->codebase->functions->hasStubbedFunction($function_storage->cased_name)
+                    ) {
+                        $this->codebase->functions->addGlobalFunction($function_storage->cased_name, $function_storage);
+                    }
                 }
 
                 foreach ($file_storage->constants as $name => $type) {
diff --git a/src/Psalm/Internal/Visitor/ReflectorVisitor.php b/src/Psalm/Internal/Visitor/ReflectorVisitor.php
index 7233cd9c1..41363d6bd 100644
--- a/src/Psalm/Internal/Visitor/ReflectorVisitor.php
+++ b/src/Psalm/Internal/Visitor/ReflectorVisitor.php
@@ -1279,7 +1279,10 @@ class ReflectorVisitor extends PhpParser\NodeVisitorAbstract implements PhpParse
             $storage = new FunctionLikeStorage();
 
             if ($this->codebase->register_stub_files || $this->codebase->register_autoload_files) {
-                if (isset($this->file_storage->functions[$function_id])) {
+                if (isset($this->file_storage->functions[$function_id])
+                    && ($this->codebase->register_stub_files
+                        || !$this->codebase->functions->hasStubbedFunction($function_id))
+                ) {
                     $this->codebase->functions->addGlobalFunction(
                         $function_id,
                         $this->file_storage->functions[$function_id]
@@ -1331,7 +1334,10 @@ class ReflectorVisitor extends PhpParser\NodeVisitorAbstract implements PhpParse
                 }
             }
 
-            if ($this->codebase->register_stub_files || $this->codebase->register_autoload_files) {
+            if ($this->codebase->register_stub_files
+                || ($this->codebase->register_autoload_files
+                    && !$this->codebase->functions->hasStubbedFunction($function_id))
+            ) {
                 $this->codebase->functions->addGlobalFunction($function_id, $storage);
             }
 
