{"url":"https://api.github.com/repos/vimeo/psalm/issues/4778","repository_url":"https://api.github.com/repos/vimeo/psalm","labels_url":"https://api.github.com/repos/vimeo/psalm/issues/4778/labels{/name}","comments_url":"https://api.github.com/repos/vimeo/psalm/issues/4778/comments","events_url":"https://api.github.com/repos/vimeo/psalm/issues/4778/events","html_url":"https://github.com/vimeo/psalm/issues/4778","id":757307820,"node_id":"MDU6SXNzdWU3NTczMDc4MjA=","number":4778,"title":"Incorrect RedundantCast and lack of MixedArgumentTypeCoercion with array-key type","user":{"login":"theodorejb","id":3053271,"node_id":"MDQ6VXNlcjMwNTMyNzE=","avatar_url":"https://avatars.githubusercontent.com/u/3053271?v=4","gravatar_id":"","url":"https://api.github.com/users/theodorejb","html_url":"https://github.com/theodorejb","followers_url":"https://api.github.com/users/theodorejb/followers","following_url":"https://api.github.com/users/theodorejb/following{/other_user}","gists_url":"https://api.github.com/users/theodorejb/gists{/gist_id}","starred_url":"https://api.github.com/users/theodorejb/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/theodorejb/subscriptions","organizations_url":"https://api.github.com/users/theodorejb/orgs","repos_url":"https://api.github.com/users/theodorejb/repos","events_url":"https://api.github.com/users/theodorejb/events{/privacy}","received_events_url":"https://api.github.com/users/theodorejb/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":486061586,"node_id":"MDU6TGFiZWw0ODYwNjE1ODY=","url":"https://api.github.com/repos/vimeo/psalm/labels/bug","name":"bug","color":"ee0701","default":true,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":15,"created_at":"2020-12-04T18:22:47Z","updated_at":"2020-12-06T17:03:46Z","closed_at":"2020-12-06T16:08:04Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I have an array which contains both string and integer keys. After upgrading from Psalm 3.14.2 to 4.3.1, I ran into a couple different issues with this code:\r\n\r\n1. When looping over the array in the constructor method, Psalm fails to show a `MixedArgumentTypeCoercion` error when passing the array key to a function that requires a string. However, Psalm correctly shows this error when the same code is placed in another function called by the constructor.\r\n2. In the function called by the constructor, even though Psalm correctly shows an error when directly passing the array key to a function expecting an int, if I cast the array key to a string to avoid a runtime TypeError, Psalm incorrectly shows a `RedundantCast` error.\r\n\r\n```php\r\n<?php\r\n\r\ndeclare(strict_types=1);\r\n\r\nclass Thing\r\n{\r\n    public function __construct(\r\n        public string $name,\r\n        public string $value,\r\n    ) {}\r\n}\r\n\r\nnew Foo([\r\n    new Thing('foo', 'bar'),\r\n    // Foo::__construct will cause the string '123' to end up as an int array key\r\n    new Thing('123', 'baz'),\r\n]);\r\n\r\nclass Foo\r\n{\r\n    /**\r\n     * @var array<mixed, string>\r\n     */\r\n    public array $map;\r\n\r\n    /**\r\n     * @param Thing[] $things\r\n     */\r\n    public function __construct(array $things)\r\n    {\r\n        $this->map = [];\r\n\r\n        foreach ($things as $thing) {\r\n            $this->map[$thing->name] = $thing->value;\r\n        }\r\n\r\n        // map may now contain some string keys and some int keys\r\n\r\n        foreach ($this->map as $key => $value) {\r\n            // $key may be an int, but Psalm fails to produce the error it does inside useMap()\r\n            echo strlen($key);\r\n        }\r\n\r\n        $this->useMap();\r\n    }\r\n\r\n    public function useMap(): void\r\n    {\r\n        foreach ($this->map as $key => $value) {\r\n            // this line correctly causes an error\r\n            echo strlen($key); // MixedArgumentTypeCoercion: Argument 1 of strlen expects string, parent type of array-key provided\r\n\r\n            // this line incorrectly says the cast is redundant\r\n            echo strlen((string) $key); // RedundantCast: Redundant cast to string\r\n        }\r\n    }\r\n}\r\n```","closed_by":{"login":"muglug","id":2292638,"node_id":"MDQ6VXNlcjIyOTI2Mzg=","avatar_url":"https://avatars.githubusercontent.com/u/2292638?v=4","gravatar_id":"","url":"https://api.github.com/users/muglug","html_url":"https://github.com/muglug","followers_url":"https://api.github.com/users/muglug/followers","following_url":"https://api.github.com/users/muglug/following{/other_user}","gists_url":"https://api.github.com/users/muglug/gists{/gist_id}","starred_url":"https://api.github.com/users/muglug/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/muglug/subscriptions","organizations_url":"https://api.github.com/users/muglug/orgs","repos_url":"https://api.github.com/users/muglug/repos","events_url":"https://api.github.com/users/muglug/events{/privacy}","received_events_url":"https://api.github.com/users/muglug/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/vimeo/psalm/issues/4778/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/vimeo/psalm/issues/4778/timeline","performed_via_github_app":null,"state_reason":"completed"}