{"url":"https://api.github.com/repos/vimeo/psalm/issues/4010","repository_url":"https://api.github.com/repos/vimeo/psalm","labels_url":"https://api.github.com/repos/vimeo/psalm/issues/4010/labels{/name}","comments_url":"https://api.github.com/repos/vimeo/psalm/issues/4010/comments","events_url":"https://api.github.com/repos/vimeo/psalm/issues/4010/events","html_url":"https://github.com/vimeo/psalm/issues/4010","id":680571287,"node_id":"MDU6SXNzdWU2ODA1NzEyODc=","number":4010,"title":"Memory Leak in AtomicMethodCallAnalyzer.php on line 203","user":{"login":"donatj","id":133747,"node_id":"MDQ6VXNlcjEzMzc0Nw==","avatar_url":"https://avatars.githubusercontent.com/u/133747?v=4","gravatar_id":"","url":"https://api.github.com/users/donatj","html_url":"https://github.com/donatj","followers_url":"https://api.github.com/users/donatj/followers","following_url":"https://api.github.com/users/donatj/following{/other_user}","gists_url":"https://api.github.com/users/donatj/gists{/gist_id}","starred_url":"https://api.github.com/users/donatj/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/donatj/subscriptions","organizations_url":"https://api.github.com/users/donatj/orgs","repos_url":"https://api.github.com/users/donatj/repos","events_url":"https://api.github.com/users/donatj/events{/privacy}","received_events_url":"https://api.github.com/users/donatj/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":486061586,"node_id":"MDU6TGFiZWw0ODYwNjE1ODY=","url":"https://api.github.com/repos/vimeo/psalm/labels/bug","name":"bug","color":"ee0701","default":true,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":16,"created_at":"2020-08-17T22:51:52Z","updated_at":"2021-01-27T17:54:42Z","closed_at":"2021-01-27T17:48:39Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I've been running Psalm for a while without issue, but suddenly on upgrading to 3.12 I started seeing this out of memory error.\r\n\r\nI am currently running the newest version: `Psalm 3.14.1@9822043ca46d6682b76097bfa97d7c450eef9e90` and still seeing the issue.\r\n\r\nI've increased the allowed ram upto 32 gb and I still get the error, which leads me to believe there is a memory leak.\r\n\r\n```\r\nScanning files...\r\nAnalyzing files...\r\n\r\nPHP Fatal error:  Allowed memory size of 8589934592 bytes exhausted (tried to allocate 4294967304 bytes) in /Users/jdonat/.composer/vendor/vimeo/psalm/src/Psalm/Internal/Analyzer/Statements/Expression/Call/Method/AtomicMethodCallAnalyzer.php on line 203\r\nFatal error: Allowed memory size of 8589934592 bytes exhausted (tried to allocate 4294967304 bytes) in /Users/jdonat/.composer/vendor/vimeo/psalm/src/Psalm/Internal/Analyzer/Statements/Expression/Call/Method/AtomicMethodCallAnalyzer.php on line 203\r\n\r\n```\r\n\r\nUsing the `--debug` flag I was able to narrow it down to this file - I've whittled several thousand lines of code down to just the part that seems to be triggering the error. \r\n\r\n<details>\r\n\r\nGetting rid of any of these lines seems to make the error go away. \r\n\r\nGetting rid of *any* of the IFs makes the error go away.\r\n\r\n```php\r\n<?php\r\n\r\nnamespace Mappers\\User;\r\n\r\nuse Objects\\User\\UserAwarenessInterfaces\\AdminAwareUserInterface;\r\nuse Objects\\User\\UserAwarenessInterfaces\\ContactInformationAwareUserInterface;\r\nuse Objects\\User\\UserAwarenessInterfaces\\CourseAwareUserInterface;\r\nuse Objects\\User\\UserAwarenessInterfaces\\RidAwareUserInterface;\r\nuse Objects\\User\\UserAwarenessInterfaces\\RosterAwareUserInterface;\r\nuse Objects\\User\\UserFactory;\r\n\r\nclass UserMapper {\r\n\r\n\tprotected $factory;\r\n\r\n\tpublic function __construct(\r\n\t\tUserFactory $userFactory\r\n\t) {\r\n\t\t$this->factory = $userFactory;\r\n\t}\r\n\r\n\tprotected function makeFromRecords( array $data ) {\r\n\t\t$user = $this->factory->make(0, 0, 0, 0, 0, '', '', '', '', '', '', 0, 0, 0, 0, false, 0);\r\n\r\n\t\tif( $user instanceof CourseAwareUserInterface ) {\r\n\t\t\t//foo\r\n\t\t}\r\n\r\n\t\tif( $user instanceof AdminAwareUserInterface ) {\r\n\t\t\t//foo\r\n\t\t}\r\n\r\n\t\tif( $user instanceof RosterAwareUserInterface ) {\r\n\t\t\t//foo\r\n\t\t}\r\n\r\n\t\tif( $user instanceof RidAwareUserInterface ) {\r\n\t\t\t//foo\r\n\t\t}\r\n\r\n\t\tif( $user instanceof ContactInformationAwareUserInterface ) {\r\n\t\t\t$user->setEmailAddress('');\r\n\t\t}\r\n\t}\r\n\r\n}\r\n\r\n```\r\n\r\n</details>\r\n\r\nI suspected *maybe* the interfaces formed a triangle or something, but as far as I can tell none of them reference any of the other ones. \r\n\r\nI'm not sure how much this helps, but here's a very chart of the inheritance tree however.\r\n\r\n![merged2](https://user-images.githubusercontent.com/133747/90451704-04598e80-e0b2-11ea-8664-d0b41f93b9d1.png)\r\n\r\nI'd personally *love* to just dump the full code up here for you guys, but I can't. If you think it will help, I can probably go through and anonymize them as best of my ability, but I'm avoiding the effort currentlyâ€¦\r\n\r\nLet me know if there's anything else I can provide to help you with this. I'm very happy to help.\r\n","closed_by":{"login":"muglug","id":2292638,"node_id":"MDQ6VXNlcjIyOTI2Mzg=","avatar_url":"https://avatars.githubusercontent.com/u/2292638?v=4","gravatar_id":"","url":"https://api.github.com/users/muglug","html_url":"https://github.com/muglug","followers_url":"https://api.github.com/users/muglug/followers","following_url":"https://api.github.com/users/muglug/following{/other_user}","gists_url":"https://api.github.com/users/muglug/gists{/gist_id}","starred_url":"https://api.github.com/users/muglug/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/muglug/subscriptions","organizations_url":"https://api.github.com/users/muglug/orgs","repos_url":"https://api.github.com/users/muglug/repos","events_url":"https://api.github.com/users/muglug/events{/privacy}","received_events_url":"https://api.github.com/users/muglug/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/vimeo/psalm/issues/4010/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/vimeo/psalm/issues/4010/timeline","performed_via_github_app":null,"state_reason":"completed"}