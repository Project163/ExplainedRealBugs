{"url":"https://api.github.com/repos/vimeo/psalm/issues/4916","repository_url":"https://api.github.com/repos/vimeo/psalm","labels_url":"https://api.github.com/repos/vimeo/psalm/issues/4916/labels{/name}","comments_url":"https://api.github.com/repos/vimeo/psalm/issues/4916/comments","events_url":"https://api.github.com/repos/vimeo/psalm/issues/4916/events","html_url":"https://github.com/vimeo/psalm/issues/4916","id":776442109,"node_id":"MDU6SXNzdWU3NzY0NDIxMDk=","number":4916,"title":"`$this` outside a class is accepted with `@psalm-scope-this`, but not with `@var ... $this`","user":{"login":"lukasbestle","id":1595007,"node_id":"MDQ6VXNlcjE1OTUwMDc=","avatar_url":"https://avatars.githubusercontent.com/u/1595007?v=4","gravatar_id":"","url":"https://api.github.com/users/lukasbestle","html_url":"https://github.com/lukasbestle","followers_url":"https://api.github.com/users/lukasbestle/followers","following_url":"https://api.github.com/users/lukasbestle/following{/other_user}","gists_url":"https://api.github.com/users/lukasbestle/gists{/gist_id}","starred_url":"https://api.github.com/users/lukasbestle/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lukasbestle/subscriptions","organizations_url":"https://api.github.com/users/lukasbestle/orgs","repos_url":"https://api.github.com/users/lukasbestle/repos","events_url":"https://api.github.com/users/lukasbestle/events{/privacy}","received_events_url":"https://api.github.com/users/lukasbestle/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2020-12-30T12:53:29Z","updated_at":"2021-01-03T01:44:35Z","closed_at":"2021-01-03T01:44:35Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Use-case\r\n\r\nMy codebase uses bound `$this` variables in closures in quite a few places (using `Closure::call(object $newthis)`), mostly outside a class (meaning: a closure is directly returned from a configuration file and then called from a class it is injected to).\r\n\r\nSimplified demonstration snippet: https://psalm.dev/r/fe823c6796\r\n\r\nIf `@psalm-scope-this` is used instead of `@var`, it works. This is because [only `@psalm-scope-this` fakes the \"this class\"](https://github.com/vimeo/psalm/blob/4.3.2/src/Psalm/Internal/Analyzer/StatementsAnalyzer.php#L680): https://psalm.dev/r/1c6322da42\r\n\r\n## Output (for the first demonstration snippet with `@var`)\r\n\r\n```\r\nScanning files...\r\nAnalyzing files...\r\n\r\nE\r\n\r\nERROR: InvalidScope - test.php:5:3 - Use of $this in non-class context (see https://psalm.dev/013)\r\n  /** @var \\Exception $this */\r\n  $this->getMessage();\r\n\r\n\r\n------------------------------\r\n1 errors found\r\n------------------------------\r\n\r\nChecks took 0.98 seconds and used 231.681MB of memory\r\nPsalm was unable to infer types in the codebase\r\n```\r\n\r\n## Expected behavior\r\n\r\nAs `@var` can also be understood by IDEs and is much more universal as `@psalm-scope-this`, it would be great if I could use `@var` annotations everywhere, even outside classes.\r\n\r\nRequired change: `@var` annotations should set the \"faked this class\" if the annotated var is `$this`.\r\n\r\n## Psalm version I used for testing\r\n\r\n```\r\nPsalm dev-master@3b6550f892b97039bcdca0bd44f89c791da0c883\r\n```","closed_by":{"login":"muglug","id":2292638,"node_id":"MDQ6VXNlcjIyOTI2Mzg=","avatar_url":"https://avatars.githubusercontent.com/u/2292638?v=4","gravatar_id":"","url":"https://api.github.com/users/muglug","html_url":"https://github.com/muglug","followers_url":"https://api.github.com/users/muglug/followers","following_url":"https://api.github.com/users/muglug/following{/other_user}","gists_url":"https://api.github.com/users/muglug/gists{/gist_id}","starred_url":"https://api.github.com/users/muglug/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/muglug/subscriptions","organizations_url":"https://api.github.com/users/muglug/orgs","repos_url":"https://api.github.com/users/muglug/repos","events_url":"https://api.github.com/users/muglug/events{/privacy}","received_events_url":"https://api.github.com/users/muglug/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/vimeo/psalm/issues/4916/reactions","total_count":3,"+1":3,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/vimeo/psalm/issues/4916/timeline","performed_via_github_app":null,"state_reason":"completed"}