{"url":"https://api.github.com/repos/vimeo/psalm/issues/2340","repository_url":"https://api.github.com/repos/vimeo/psalm","labels_url":"https://api.github.com/repos/vimeo/psalm/issues/2340/labels{/name}","comments_url":"https://api.github.com/repos/vimeo/psalm/issues/2340/comments","events_url":"https://api.github.com/repos/vimeo/psalm/issues/2340/events","html_url":"https://github.com/vimeo/psalm/issues/2340","id":522557016,"node_id":"MDU6SXNzdWU1MjI1NTcwMTY=","number":2340,"title":"Improperly-stubbed functions interfering with callmap records","user":{"login":"Girgias","id":7906688,"node_id":"MDQ6VXNlcjc5MDY2ODg=","avatar_url":"https://avatars.githubusercontent.com/u/7906688?v=4","gravatar_id":"","url":"https://api.github.com/users/Girgias","html_url":"https://github.com/Girgias","followers_url":"https://api.github.com/users/Girgias/followers","following_url":"https://api.github.com/users/Girgias/following{/other_user}","gists_url":"https://api.github.com/users/Girgias/gists{/gist_id}","starred_url":"https://api.github.com/users/Girgias/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Girgias/subscriptions","organizations_url":"https://api.github.com/users/Girgias/orgs","repos_url":"https://api.github.com/users/Girgias/repos","events_url":"https://api.github.com/users/Girgias/events{/privacy}","received_events_url":"https://api.github.com/users/Girgias/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2019-11-14T00:47:26Z","updated_at":"2019-11-14T14:27:52Z","closed_at":"2019-11-14T14:27:25Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I tried to reduce my problematic method using the online example tool, but the problem seems to disapear when I trim stuff down.\r\n\r\nI get the following errors:\r\n```cli\r\nERROR: MixedInferredReturnType - src/Lexer.php:392:16 - Could not verify return type 'string' for Girgias\\CSSParser\\Lexer::consumeEscapedCodePoint\r\n     * @return string A valid code point\r\n\r\n\r\nERROR: MixedAssignment - src/Lexer.php:420:13 - Cannot assign $unicodeCodePoint to a mixed type\r\n            $unicodeCodePoint = mb_chr(hexdec($hexNumber), \"UTF-8\");\r\n\r\n\r\nERROR: MixedReturnStatement - src/Lexer.php:424:20 - Could not infer a return type\r\n            return $unicodeCodePoint;\r\n```\r\n\r\nFor this method:\r\n```php\r\n/**\r\n * Section 4.3.7 of the CSS syntax 3 specification\r\n *\r\n * The specification assumes that the first Hex have already been consumed\r\n * This is not the case with this implementation\r\n *\r\n * \tIt assumes that the U+005C REVERSE SOLIDUS (\\) has already been consumed and that the next input\r\n *  code point has already been verified to be part of a valid escape. It will return a code point.\r\n *\r\n * @see https://www.w3.org/TR/css-syntax-3/#consume-an-escaped-code-point\r\n *\r\n * @return string A valid code point\r\n */\r\nprivate function consumeEscapedCodePoint(): string\r\n{\r\n    // Use custom implementation of readWhile as there is a limit of six (6) hexadecimal characters to consume\r\n    if (Definitions::isHexadecimalDigit($this->inputStream->peek())) {\r\n        $iterator = 0;\r\n        $hexNumber = \"\";\r\n        while (\r\n            $this->inputStream->isEndOfStream() === false\r\n            && Definitions::isHexadecimalDigit($this->inputStream->peek())\r\n            && $iterator < 6\r\n        ) {\r\n            $hexNumber .= $this->inputStream->next();\r\n            $iterator++;\r\n        }\r\n            /** As per the spec \"If the next input code point is whitespace, consume it as well.\" */\r\n            if (Definitions::isWhitespace($this->inputStream->peek())) {\r\n                $this->inputStream->next();\r\n            }\r\n            if (\r\n                hexdec($hexNumber) === 0\r\n                || preg_match(Definitions::IS_SURROGATES_CODE_POINTS, $hexNumber) === 1\r\n                || hexdec($hexNumber) > Definitions::MAXIMUM_ALLOWED_CODE_POINT\r\n            ) {\r\n            return Definitions::REPLACEMENT_CHARACTER;\r\n        }\r\n\r\n        $unicodeCodePoint = mb_chr(hexdec($hexNumber), \"UTF-8\");\r\n        if ($unicodeCodePoint === false) {\r\n            throw new \\RuntimeException(\"mb_chr failed on hex value :[\".$hexNumber.\"]\");\r\n        }\r\n        return $unicodeCodePoint;\r\n    }\r\n    if ($this->inputStream->isEndOfStream()) {\r\n        // TODO Parse Error;\r\n        return Definitions::REPLACEMENT_CHARACTER;\r\n    }\r\n    return $this->inputStream->next();\r\n}\r\n```\r\n\r\nThe problematic call is ``mb_chr`` but I don't see why Psalm is shouting at me here.\r\nIs this possibly due to running on PHP 7.4? (I did ran Psalm with PHP 7.3. and it didn't seem to have an effect but who knows)","closed_by":{"login":"muglug","id":2292638,"node_id":"MDQ6VXNlcjIyOTI2Mzg=","avatar_url":"https://avatars.githubusercontent.com/u/2292638?v=4","gravatar_id":"","url":"https://api.github.com/users/muglug","html_url":"https://github.com/muglug","followers_url":"https://api.github.com/users/muglug/followers","following_url":"https://api.github.com/users/muglug/following{/other_user}","gists_url":"https://api.github.com/users/muglug/gists{/gist_id}","starred_url":"https://api.github.com/users/muglug/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/muglug/subscriptions","organizations_url":"https://api.github.com/users/muglug/orgs","repos_url":"https://api.github.com/users/muglug/repos","events_url":"https://api.github.com/users/muglug/events{/privacy}","received_events_url":"https://api.github.com/users/muglug/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/vimeo/psalm/issues/2340/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/vimeo/psalm/issues/2340/timeline","performed_via_github_app":null,"state_reason":"completed"}