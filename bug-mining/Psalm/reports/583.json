{"url":"https://api.github.com/repos/vimeo/psalm/issues/3009","repository_url":"https://api.github.com/repos/vimeo/psalm","labels_url":"https://api.github.com/repos/vimeo/psalm/issues/3009/labels{/name}","comments_url":"https://api.github.com/repos/vimeo/psalm/issues/3009/comments","events_url":"https://api.github.com/repos/vimeo/psalm/issues/3009/events","html_url":"https://github.com/vimeo/psalm/issues/3009","id":586203868,"node_id":"MDU6SXNzdWU1ODYyMDM4Njg=","number":3009,"title":"Method return type provided by plugin is not used","user":{"login":"Daeroni","id":1648961,"node_id":"MDQ6VXNlcjE2NDg5NjE=","avatar_url":"https://avatars.githubusercontent.com/u/1648961?v=4","gravatar_id":"","url":"https://api.github.com/users/Daeroni","html_url":"https://github.com/Daeroni","followers_url":"https://api.github.com/users/Daeroni/followers","following_url":"https://api.github.com/users/Daeroni/following{/other_user}","gists_url":"https://api.github.com/users/Daeroni/gists{/gist_id}","starred_url":"https://api.github.com/users/Daeroni/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Daeroni/subscriptions","organizations_url":"https://api.github.com/users/Daeroni/orgs","repos_url":"https://api.github.com/users/Daeroni/repos","events_url":"https://api.github.com/users/Daeroni/events{/privacy}","received_events_url":"https://api.github.com/users/Daeroni/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":486061586,"node_id":"MDU6TGFiZWw0ODYwNjE1ODY=","url":"https://api.github.com/repos/vimeo/psalm/labels/bug","name":"bug","color":"ee0701","default":true,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2020-03-23T13:21:28Z","updated_at":"2020-03-23T17:26:01Z","closed_at":"2020-03-23T17:26:01Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"If a plugin implementing MethodReturnTypeProviderInterface returns a type for a method, it is not used, and instead psalm seems to assume the return value is mixed. This used to work, but broke for some reason in commit 50cddb5350cc573994221b286ae655d884a2f402\r\n\r\nThe following crude patch to the tests can be used to test the bug:\r\n\r\n```\r\ndiff --git a/tests/Config/Plugin/Hook/FooMethodProvider.php b/tests/Config/Plugin/Hook/FooMethodProvider.php\r\nindex fd2d52ae0..9672bd81a 100644\r\n--- a/tests/Config/Plugin/Hook/FooMethodProvider.php\r\n+++ b/tests/Config/Plugin/Hook/FooMethodProvider.php\r\n@@ -34,7 +34,7 @@ class FooMethodProvider implements\r\n         StatementsSource $source = null,\r\n         CodeLocation $code_location = null\r\n     ) {\r\n-        return $method_name_lc === 'magicmethod';\r\n+        return $method_name_lc === 'magicmethod' || $method_name_lc === 'magicmethod2';\r\n     }\r\n \r\n     /**\r\n@@ -82,6 +82,10 @@ class FooMethodProvider implements\r\n         string $called_fq_classlike_name = null,\r\n         string $called_method_name = null\r\n     ) {\r\n-        return Type::getString();\r\n+        if ($method_name == 'magicmethod') {\r\n+            return Type::getString();\r\n+        } else {\r\n+            return new \\Psalm\\Type\\Union([new \\Psalm\\Type\\Atomic\\TNamedObject('NS\\\\Foo2')]);\r\n+        }\r\n     }\r\n }\r\ndiff --git a/tests/Config/PluginTest.php b/tests/Config/PluginTest.php\r\nindex e7e96c47c..87c127c14 100644\r\n--- a/tests/Config/PluginTest.php\r\n+++ b/tests/Config/PluginTest.php\r\n@@ -582,11 +582,22 @@ class PluginTest extends \\Psalm\\Tests\\TestCase\r\n             '<?php\r\n                 namespace Ns;\r\n \r\n+                interface I {}\r\n+                class Foo2 implements I {\r\n+                    public function id(): int { return 1; }\r\n+                }\r\n                 class Foo {}\r\n \r\n+                function i(I $i): void {\r\n+                }\r\n+\r\n                 $foo = new Foo();\r\n                 echo $foo->magicMethod(\"hello\");\r\n-                echo $foo::magicMethod(\"hello\");'\r\n+                echo $foo::magicMethod(\"hello\");\r\n+\r\n+                $foo2 = $foo->magicMethod2(\"test\");\r\n+                i($foo2);\r\n+                echo $foo2->id();'\r\n         );\r\n \r\n         $this->analyzeFile($file_path, new Context());\r\n```\r\n\r\non the previous commit c5fa07920c9d44792425a3c92047cfd39f9e1f07 `vendor/bin/phpunit --filter testMethodProviderHooks --no-coverage` will return `OK (2 tests, 2 assertions)`, but on the next commit 50cddb5350cc573994221b286ae655d884a2f402 (and every commit after that) we get:\r\n\r\n```\r\nPHPUnit 8.5.2 by Sebastian Bergmann and contributors.\r\n\r\nRuntime:       PHP 7.4.4 with Xdebug 2.9.3\r\nConfiguration: /home/teemu/psalm/phpunit.xml.dist\r\n\r\nE.                                                                  2 / 2 (100%)\r\n\r\nTime: 700 ms, Memory: 52.00 MB\r\n\r\nThere was 1 error:\r\n\r\n1) Psalm\\Tests\\Config\\PluginTest::testMethodProviderHooks\r\nPsalm\\Exception\\CodeException: UndefinedInterfaceMethod - src/somefile.php:19:29 - Method Ns\\I::id does not exist\r\n\r\n/home/teemu/psalm/src/Psalm/IssueBuffer.php:222\r\n/home/teemu/psalm/src/Psalm/IssueBuffer.php:92\r\n/home/teemu/psalm/src/Psalm/Internal/Analyzer/Statements/Expression/Call/MethodCallAnalyzer.php:306\r\n/home/teemu/psalm/src/Psalm/Internal/Analyzer/Statements/ExpressionAnalyzer.php:135\r\n/home/teemu/psalm/src/Psalm/Internal/Analyzer/StatementsAnalyzer.php:596\r\n/home/teemu/psalm/src/Psalm/Internal/Analyzer/NamespaceAnalyzer.php:96\r\n/home/teemu/psalm/src/Psalm/Internal/Analyzer/FileAnalyzer.php:243\r\n/home/teemu/psalm/src/Psalm/Internal/Analyzer/FileAnalyzer.php:182\r\n/home/teemu/psalm/tests/TestCase.php:124\r\n/home/teemu/psalm/tests/Config/PluginTest.php:603\r\n\r\nERRORS!\r\nTests: 2, Assertions: 2, Errors: 1.\r\n```","closed_by":{"login":"muglug","id":2292638,"node_id":"MDQ6VXNlcjIyOTI2Mzg=","avatar_url":"https://avatars.githubusercontent.com/u/2292638?v=4","gravatar_id":"","url":"https://api.github.com/users/muglug","html_url":"https://github.com/muglug","followers_url":"https://api.github.com/users/muglug/followers","following_url":"https://api.github.com/users/muglug/following{/other_user}","gists_url":"https://api.github.com/users/muglug/gists{/gist_id}","starred_url":"https://api.github.com/users/muglug/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/muglug/subscriptions","organizations_url":"https://api.github.com/users/muglug/orgs","repos_url":"https://api.github.com/users/muglug/repos","events_url":"https://api.github.com/users/muglug/events{/privacy}","received_events_url":"https://api.github.com/users/muglug/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/vimeo/psalm/issues/3009/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/vimeo/psalm/issues/3009/timeline","performed_via_github_app":null,"state_reason":"completed"}