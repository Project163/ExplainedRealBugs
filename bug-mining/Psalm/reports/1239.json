{"url":"https://api.github.com/repos/vimeo/psalm/issues/8983","repository_url":"https://api.github.com/repos/vimeo/psalm","labels_url":"https://api.github.com/repos/vimeo/psalm/issues/8983/labels{/name}","comments_url":"https://api.github.com/repos/vimeo/psalm/issues/8983/comments","events_url":"https://api.github.com/repos/vimeo/psalm/issues/8983/events","html_url":"https://github.com/vimeo/psalm/issues/8983","id":1507746111,"node_id":"I_kwDOBG8K985Z3mE_","number":8983,"title":"When using a large union type in an array key, analysis fails due to a wider type being picked for the array","user":{"login":"Ocramius","id":154256,"node_id":"MDQ6VXNlcjE1NDI1Ng==","avatar_url":"https://avatars.githubusercontent.com/u/154256?v=4","gravatar_id":"","url":"https://api.github.com/users/Ocramius","html_url":"https://github.com/Ocramius","followers_url":"https://api.github.com/users/Ocramius/followers","following_url":"https://api.github.com/users/Ocramius/following{/other_user}","gists_url":"https://api.github.com/users/Ocramius/gists{/gist_id}","starred_url":"https://api.github.com/users/Ocramius/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Ocramius/subscriptions","organizations_url":"https://api.github.com/users/Ocramius/orgs","repos_url":"https://api.github.com/users/Ocramius/repos","events_url":"https://api.github.com/users/Ocramius/events{/privacy}","received_events_url":"https://api.github.com/users/Ocramius/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-12-22T11:56:22Z","updated_at":"2022-12-29T09:48:06Z","closed_at":"2022-12-29T09:48:06Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Take following example @ https://psalm.dev/r/7158d77465 : \r\n\r\n```php\r\n<?php\r\n\r\n/** @psalm-type LargeUnion = self::* */\r\nclass SomeConstants\r\n{\r\n    const A0=0;\r\n    const A1=1;\r\n    const A2=2;\r\n    const A3=3;\r\n    const A4=4;\r\n    const A5=5;\r\n    const A6=6;\r\n    const A7=7;\r\n    const A8=8;\r\n    const A9=9;\r\n    const A10=10;\r\n    const A11=11;\r\n    const A12=12;\r\n    const A13=13;\r\n    const A14=14;\r\n    const A15=15;\r\n    const A16=16;\r\n    const A17=17;\r\n    const A18=18;\r\n    const A19=19;\r\n    const A20=20;\r\n    const A21=21;\r\n    const A22=22;\r\n    const A23=23;\r\n    const A24=24;\r\n    const A25=25;\r\n    const A26=26;\r\n    const A27=27;\r\n    const A28=28;\r\n    const A29=29;\r\n    const A30=30;\r\n    const A31=31;\r\n    const A32=32;\r\n    const A33=33;\r\n    const A34=34;\r\n    const A35=35;\r\n    const A36=36;\r\n    const A37=37;\r\n    const A38=38;\r\n    const A39=39;\r\n    const A40=40;\r\n    const A41=41;\r\n    const A42=42;\r\n    const A43=43;\r\n    const A44=44;\r\n    const A45=45;\r\n    const A46=46;\r\n    const A47=47;\r\n    const A48=48;\r\n    const A49=49;\r\n    const A50=50;\r\n    const A51=51;\r\n    const A52=52;\r\n    const A53=53;\r\n    const A54=54;\r\n    const A55=55;\r\n    const A56=56;\r\n    const A57=57;\r\n    const A58=58;\r\n    const A59=59;\r\n    const A60=60;\r\n    const A61=61;\r\n    const A62=62;\r\n    const A63=63;\r\n    const A64=64;\r\n    const A65=65;\r\n    const A66=66;\r\n    const A67=67;\r\n    const A68=68;\r\n    const A69=69;\r\n    const A70=70;\r\n    const A71=71;\r\n    const A72=72;\r\n    const A73=73;\r\n    const A74=74;\r\n    const A75=75;\r\n    const A76=76;\r\n    const A77=77;\r\n    const A78=78;\r\n    const A79=79;\r\n    const A80=80;\r\n    const A81=81;\r\n    const A82=82;\r\n    const A83=83;\r\n    const A84=84;\r\n    const A85=85;\r\n    const A86=86;\r\n    const A87=87;\r\n    const A88=88;\r\n    const A89=89;\r\n    const A90=90;\r\n    const A91=91;\r\n    const A92=92;\r\n    const A93=93;\r\n    const A94=94;\r\n    const A95=95;\r\n    const A96=96;\r\n    const A97=97;\r\n    const A98=98;\r\n    const A99=99;\r\n    const A100=100;\r\n}\r\n\r\n/** @return LargeUnion */\r\nfunction produceValue(): int { throw new \\Exception('irrelevant'); }\r\n\r\n/** @param array<LargeUnion, mixed> $input */\r\nfunction useUnion(array $input): void { throw new \\Exception('irrelevant' . json_encode($input)); }\r\n\r\n/** @psalm-trace $value */\r\n$value = produceValue();\r\n/** @psalm-trace $input */\r\n$input = [$value => 'foo'];\r\n\r\nuseUnion($input);\r\n```\r\n\r\nWhile Psalm correctly understands `$value` being a `LargeUnion`, it gives up in the `$input = [$value => 'foo'];` expression, which becomes a `non-empty-array<int<0, max>, 'foo'>`:\r\n\r\n```\r\nPsalm output (using commit 390da64): \r\n\r\nINFO: [Trace](https://psalm.dev/224) - 116:1 - $value: 0|1|2|3|4|5|6|7|8|9|10|11|12|13|14|15|16|17|18|19|20|21|22|23|24|25|26|27|28|29|30|31|32|33|34|35|36|37|38|39|40|41|42|43|44|45|46|47|48|49|50|51|52|53|54|55|56|57|58|59|60|61|62|63|64|65|66|67|68|69|70|71|72|73|74|75|76|77|78|79|80|81|82|83|84|85|86|87|88|89|90|91|92|93|94|95|96|97|98|99|100\r\n\r\nINFO: [Trace](https://psalm.dev/224) - 118:1 - $input: non-empty-array<int<0, max>, 'foo'>\r\n\r\nERROR: [InvalidArgument](https://psalm.dev/004) - 120:10 - Argument 1 of useUnion expects array<0|1|2|3|4|5|6|7|8|9|10|11|12|13|14|15|16|17|18|19|20|21|22|23|24|25|26|27|28|29|30|31|32|33|34|35|36|37|38|39|40|41|42|43|44|45|46|47|48|49|50|51|52|53|54|55|56|57|58|59|60|61|62|63|64|65|66|67|68|69|70|71|72|73|74|75|76|77|78|79|80|81|82|83|84|85|86|87|88|89|90|91|92|93|94|95|96|97|98|99|100, mixed>, but non-empty-array<int<0, max>, 'foo'> provided\r\n```\r\n\r\nThe `maxShapedArraySize=\"1000\"` configuration does not seem to help here either.\r\n\r\nReducing to less than `30` constants fixes the problem ( https://psalm.dev/r/c17fe8ddca ) , making it a look for `30` in the codebase:\r\n\r\n```php\r\n<?php\r\n\r\n/** @psalm-type LargeUnion = self::* */\r\nclass SomeConstants\r\n{\r\n    const A0=0;\r\n    const A1=1;\r\n    const A2=2;\r\n    const A3=3;\r\n    const A4=4;\r\n    const A5=5;\r\n    const A6=6;\r\n    const A7=7;\r\n    const A8=8;\r\n    const A9=9;\r\n    const A10=10;\r\n    const A11=11;\r\n    const A12=12;\r\n    const A13=13;\r\n    const A14=14;\r\n    const A15=15;\r\n    const A16=16;\r\n    const A17=17;\r\n    const A18=18;\r\n    const A19=19;\r\n    const A20=20;\r\n    const A21=21;\r\n    const A22=22;\r\n    const A23=23;\r\n    const A24=24;\r\n    const A25=25;\r\n    const A26=26;\r\n    const A27=27;\r\n    const A28=28;\r\n    const A29=29;\r\n}\r\n\r\n/** @return LargeUnion */\r\nfunction produceValue(): int { throw new \\Exception('irrelevant'); }\r\n\r\n/** @param array<LargeUnion, mixed> $input */\r\nfunction useUnion(array $input): void { throw new \\Exception('irrelevant' . json_encode($input)); }\r\n\r\n/** @psalm-trace $value */\r\n$value = produceValue();\r\n/** @psalm-trace $input */\r\n$input = [$value => 'foo'];\r\n\r\nuseUnion($input);\r\n```\r\n```\r\nPsalm output (using commit 390da64): \r\n\r\nINFO: [Trace](https://psalm.dev/224) - 45:1 - $value: 0|1|2|3|4|5|6|7|8|9|10|11|12|13|14|15|16|17|18|19|20|21|22|23|24|25|26|27|28|29\r\n\r\nINFO: [Trace](https://psalm.dev/224) - 47:1 - $input: non-empty-array<0|1|2|3|4|5|6|7|8|9|10|11|12|13|14|15|16|17|18|19|20|21|22|23|24|25|26|27|28|29, 'foo'>\r\n```\r\n\r\nI found some relevant code references:\r\n\r\n * https://github.com/vimeo/psalm/blob/390da64150da5c4ac1bd09e7c88e4cf1633fb85b/src/Psalm/Internal/Analyzer/Statements/Expression/SimpleTypeInferer.php#L513-L567\r\n * https://github.com/vimeo/psalm/blob/390da64150da5c4ac1bd09e7c88e4cf1633fb85b/src/Psalm/Internal/Analyzer/Statements/Expression/ArrayAnalyzer.php#L57-L106","closed_by":{"login":"orklah","id":9605520,"node_id":"MDQ6VXNlcjk2MDU1MjA=","avatar_url":"https://avatars.githubusercontent.com/u/9605520?v=4","gravatar_id":"","url":"https://api.github.com/users/orklah","html_url":"https://github.com/orklah","followers_url":"https://api.github.com/users/orklah/followers","following_url":"https://api.github.com/users/orklah/following{/other_user}","gists_url":"https://api.github.com/users/orklah/gists{/gist_id}","starred_url":"https://api.github.com/users/orklah/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/orklah/subscriptions","organizations_url":"https://api.github.com/users/orklah/orgs","repos_url":"https://api.github.com/users/orklah/repos","events_url":"https://api.github.com/users/orklah/events{/privacy}","received_events_url":"https://api.github.com/users/orklah/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/vimeo/psalm/issues/8983/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/vimeo/psalm/issues/8983/timeline","performed_via_github_app":null,"state_reason":"completed"}