<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:53:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[EMAIL-96] Email.getMailSession() is a mess</title>
                <link>https://issues.apache.org/jira/browse/EMAIL-96</link>
                <project id="12310474" key="EMAIL">Commons Email</project>
                    <description>&lt;p&gt;Email.getMailSession() is a mess&lt;/p&gt;

&lt;p&gt;This bug initially was going to address only the excessive permissions required by Email.getMailSession().  My examination of how this might best be remedied led me to the revelation that the problems with this method, and their effects on the entire class are quite extraordinary.  (To be fair, some of the blame should be placed squarely upon other members of this class.)&lt;/p&gt;

&lt;p&gt;Excess permission requirements&lt;br/&gt;
--------------------------------------------&lt;/p&gt;

&lt;p&gt;The Email.getMailSession() method, when running under a SecurityManager, requires permission to be granted to read and write ALL properties (java.util.PropertyPermission * read, write).  This, despite the fact that only a handful of properties are applicable to sending mail.&lt;/p&gt;

&lt;p&gt;The permission requirement stems from the following line:&lt;/p&gt;

&lt;p&gt;        Properties properties = new Properties(System.getProperties());&lt;/p&gt;

&lt;p&gt;As far as I can tell, Commons-Email reads only &quot;mail.smtp.from&quot; and &quot;mail.smtp.host&quot; from the system properties for use as default values.  Commons-Email does not appear to write any system properties.&lt;/p&gt;

&lt;p&gt;Therefore, something along these lines would greatly reduce the permissions required to send mail using Commons-Email:&lt;/p&gt;

&lt;p&gt;        Properties properties = new Properties();&lt;br/&gt;
        properties.setProperty(MAIL_SMTP_FROM, System.getProperty(MAIL_SMTP_FROM));&lt;br/&gt;
        properties.setProperty(MAIL_HOST, System.getProperty(MAIL_HOST));&lt;/p&gt;

&lt;p&gt;On top of all of this, getMailSession() does not use AccessController.doPrivileged() to isolate the code requiring the permission grants.&lt;/p&gt;

&lt;p&gt;My thought was to submit a patch refactoring the class, adding a createDefaultProperties() method to do all of this.&lt;/p&gt;

&lt;p&gt;But then...&lt;br/&gt;
--------------&lt;/p&gt;

&lt;p&gt;During my examination of the code, I noticed that getMailSession() is documented with the following JavaDoc comment:&lt;/p&gt;

&lt;p&gt;        Initialise a mailsession object&lt;/p&gt;

&lt;p&gt;That would be an appropriate description for an initMailSession() method.  For getMailSession(), I would have expected something more along the lines of:&lt;/p&gt;

&lt;p&gt;   Determines the Session used when sending this Email, creating the Session if necessary.&lt;/p&gt;

&lt;p&gt;(I would also refactor the class such that getMailSession() delegates creation and initialization of a mail Session to a createMailSession() method.)&lt;/p&gt;

&lt;p&gt;However, buildMimeMessage() &lt;b&gt;does&lt;/b&gt; treat getMailSession() as though it is initMailSession(), e.g.:&lt;/p&gt;

&lt;p&gt;        this.getMailSession();&lt;br/&gt;
        this.message = this.createMimeMessage(this.session);&lt;/p&gt;

&lt;p&gt;One might have expected a simple createMimeMessage(getMailSession()), rather than using getMailSession() for its side effect and then accessing the data member directly.  A bit confusing, but it got me thinking.&lt;/p&gt;

&lt;p&gt;Suppose I do something like this:&lt;/p&gt;

&lt;p&gt;        System.getProperties().setProperty(&quot;mail.smtp.host&quot;, &quot;smtp.example.com&quot;);&lt;br/&gt;
        Email email =new SimpleEmail();&lt;br/&gt;
        email.getMailSession();&lt;br/&gt;
        email.setHostName(&quot;mail.example.com&quot;);&lt;br/&gt;
        email.setSmtpPort(26);&lt;br/&gt;
        email.setSsl(true);&lt;br/&gt;
        email.addTo(&quot;someone@example.com&quot;, &quot;Someone&quot;);&lt;br/&gt;
        email.setFrom(&quot;me@example.com&quot;, &quot;Me&quot;);&lt;br/&gt;
        email.setSubject(&quot;Test&quot;);&lt;br/&gt;
        email.setMsg(&quot;This is a test.&quot;);&lt;br/&gt;
        email.send();&lt;/p&gt;

&lt;p&gt;Q. What SMTP server is contacted to relay the mail?&lt;br/&gt;
A. smtp.example.com&lt;/p&gt;

&lt;p&gt;Q. On what port is the SMTP server contacted?&lt;br/&gt;
A. 25&lt;/p&gt;

&lt;p&gt;Q. Is SSL used when communicating with the SMTP server?&lt;br/&gt;
A. No.&lt;/p&gt;

&lt;p&gt;Q. What mail host and port will be reported in any error message?&lt;br/&gt;
A. mail.example.com: 26&lt;/p&gt;

&lt;p&gt;The problems here are:&lt;br/&gt;
 a) The call to getMailSession() initializes the Session used by Email&lt;br/&gt;
 b) subsequent setXxxx() calls don&apos;t write through to the already-initialized Session&lt;br/&gt;
 c) any EmailException thrown by sendMimeMessage() uses values obtained from the getter methods, which prefer local data members rather than Session properties&lt;/p&gt;

&lt;p&gt;I suppose one could argue that getMailSession(), despite its misleading name, clearly states that it initializes the Session, thereby sealing the attributes despite subsequent setXxxx() calls.  In that case the JavaDoc comments should clearly note this.  That would leave Commons Email with a confusing and stinky API.  Problem &apos;c&apos; listed above would still need to be addressed.&lt;/p&gt;

&lt;p&gt;How truly fixable this class is without breaking the API is probably dependent upon whether javax.mail.Session accepts changes written to the Properties object returned by its getProperties() method.  The JavaMail API does not seem to specify that behavior.&lt;/p&gt;

&lt;p&gt;I will cheerfully accept any corrections, major or minor.  I imagine anyone reading this has spent far more time with the code involved than I have.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12468003">EMAIL-96</key>
            <summary>Email.getMailSession() is a mess</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sgoeschl">Siegfried Goeschl</assignee>
                                    <reporter username="nc">NC</reporter>
                        <labels>
                    </labels>
                <created>Mon, 28 Jun 2010 02:04:25 +0000</created>
                <updated>Fri, 11 Jan 2013 15:47:41 +0000</updated>
                            <resolved>Sun, 31 Oct 2010 16:24:43 +0000</resolved>
                                    <version>1.2</version>
                                    <fixVersion>1.3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12893824" author="sgoeschl" created="Thu, 29 Jul 2010 21:10:07 +0000"  >&lt;p&gt;Well, the confusing and stinky API has hopefully some value ... &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;/p&gt;

&lt;p&gt;+) the assumption that javax.mail.session will honor those changes is risky &lt;br/&gt;
+) I will have a look at the remaining points in two weeks time&lt;/p&gt;</comment>
                            <comment id="12924727" author="sgoeschl" created="Mon, 25 Oct 2010 21:24:48 +0000"  >&lt;p&gt;It took more than two weeks but some points you mentioned are rather difficult&lt;/p&gt;

&lt;p&gt;+) The underlying JavaMail use more than the to system properties but the relevant properies are prefixed with &quot;mail&quot; - not sure if that helps your security manager problem - we are talking about thirty different properties and different mail providers might add their own.&lt;/p&gt;

&lt;p&gt;+) can you help with AccessController.doPrivileged()?!  I have no experience with that and also no way to test it&lt;/p&gt;

&lt;p&gt;+) I updated the javadoc of getMailSession()&lt;/p&gt;

&lt;p&gt;+) change MimeMessage creation to &quot;this.createMimeMessage(this.getMailSession())&quot;&lt;/p&gt;</comment>
                            <comment id="12926731" author="sgoeschl" created="Sun, 31 Oct 2010 16:23:56 +0000"  >&lt;p&gt;Throwing an IllegalStateException when the user tries to modify mai session settings when the mail session is already supplied or created. This might break invalid but existing code.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>56895</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 3 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0tmmv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>170976</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>