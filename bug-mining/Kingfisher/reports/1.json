{"url":"https://api.github.com/repos/onevcat/Kingfisher/issues/1511","repository_url":"https://api.github.com/repos/onevcat/Kingfisher","labels_url":"https://api.github.com/repos/onevcat/Kingfisher/issues/1511/labels{/name}","comments_url":"https://api.github.com/repos/onevcat/Kingfisher/issues/1511/comments","events_url":"https://api.github.com/repos/onevcat/Kingfisher/issues/1511/events","html_url":"https://github.com/onevcat/Kingfisher/issues/1511","id":702872729,"node_id":"MDU6SXNzdWU3MDI4NzI3Mjk=","number":1511,"title":"Crashes on SessionDelegate.remove() when canceling Download Task","user":{"login":"jgarcia-mirego","id":69209458,"node_id":"MDQ6VXNlcjY5MjA5NDU4","avatar_url":"https://avatars.githubusercontent.com/u/69209458?v=4","gravatar_id":"","url":"https://api.github.com/users/jgarcia-mirego","html_url":"https://github.com/jgarcia-mirego","followers_url":"https://api.github.com/users/jgarcia-mirego/followers","following_url":"https://api.github.com/users/jgarcia-mirego/following{/other_user}","gists_url":"https://api.github.com/users/jgarcia-mirego/gists{/gist_id}","starred_url":"https://api.github.com/users/jgarcia-mirego/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jgarcia-mirego/subscriptions","organizations_url":"https://api.github.com/users/jgarcia-mirego/orgs","repos_url":"https://api.github.com/users/jgarcia-mirego/repos","events_url":"https://api.github.com/users/jgarcia-mirego/events{/privacy}","received_events_url":"https://api.github.com/users/jgarcia-mirego/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2020-09-16T15:41:25Z","updated_at":"2020-10-28T14:08:34Z","closed_at":"2020-10-28T14:08:34Z","author_association":"NONE","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Check List\r\n\r\nThanks for considering to open an issue. Before you submit your issue, please confirm these boxes are checked.\r\n\r\n- [x] I have read the [wiki page](https://github.com/onevcat/Kingfisher/wiki) and [cheat sheet](https://github.com/onevcat/Kingfisher/wiki/Cheat-Sheet), but there is no information I need.\r\n- [x] I have searched in [existing issues](https://github.com/onevcat/Kingfisher/issues?utf8=âœ“&q=is%3Aissue), but did not find a same one.\r\n- [x] I want to report a problem instead of asking a question. It'd better to use [kingfisher tag in Stack Overflow](http://stackoverflow.com/questions/tagged/kingfisher) to ask a question.\r\n\r\n### Issue Description\r\n\r\n#### What\r\n\r\nWe are using Kingfisher to download images for our iOS app and I have encountered many crashes when trying to cancel a download task\r\n\r\n**EXC_BAD_ACCESS KERN_INVALID_ADDRESS 0x0000000000000020**\r\n\r\n```\r\nCrashed: com.apple.main-thread\r\n0  CFNetwork                      0x18436b058 HTTPParser::HTTPParser(__CFAllocator const*, HTTPParserClient*, HTTPParser*) + 44\r\n1  CFNetwork                      0x18424b27c HTTPMessage::commonInitialization(unsigned char, HTTPMessage const*) + 212\r\n2  CFNetwork                      0x18424b27c HTTPMessage::commonInitialization(unsigned char, HTTPMessage const*) + 212\r\n3  CFNetwork                      0x18424b41c HTTPMessage::HTTPMessage(HTTPMessage const*) + 112\r\n4  CFNetwork                      0x18436c1dc HTTPRequestMessage::HTTPRequestMessage(HTTPRequestMessage const*) + 36\r\n5  CFNetwork                      0x18422a74c HTTPRequest::HTTPRequest(HTTPRequest const*) + 24\r\n6  CFNetwork                      0x18422ce8c URLRequest::initialize(URLRequest const*, unsigned char) + 656\r\n7  CFNetwork                      0x1841e2bd8 _createRequestCopy(__CFAllocator const*, _CFURLRequest const*, unsigned char) + 152\r\n8  CFNetwork                      0x184355de0 -[NSURLRequest mutableCopyWithZone:] + 44\r\n9  libswiftFoundation.dylib       0x105a95a0c URLRequest.init(_bridged:) + 77948\r\n10 libswiftFoundation.dylib       0x105a99344 static URLRequest._unconditionallyBridgeFromObjectiveC(_:) + 92596\r\n11 Kingfisher                     0x102fb5788 SessionDelegate.remove(_:) + 93 (SessionDelegate.swift:93)\r\n12 Kingfisher                     0x102fb566c closure #1 in SessionDelegate.add(_:url:callback:) + 1000 (<compiler-generated>:1000)\r\n13 Kingfisher                     0x102fb9eb0 partial apply for thunk for @escaping @callee_guaranteed (@guaranteed SessionDelegate, @unowned Int, @in_guaranteed SessionDataTask.TaskCallback) -> () + 84 (<compiler-generated>:84)\r\n14 Kingfisher                     0x102f46734 specialized closure #1 in Delegate.delegate<A>(on:block:) + 96 (<compiler-generated>:96)\r\n15 Kingfisher                     0x102fb9f34 partial apply for specialized closure #1 in Delegate.delegate<A>(on:block:) + 28 (<compiler-generated>:28)\r\n16 Kingfisher                     0x102fb14d0 SessionDataTask.cancel(token:) + 356 (<compiler-generated>:356)\r\n17 Kingfisher                     0x102f6de18 DownloadTask.cancel() + 74 (ImageDownloader.swift:74)\r\n18 MyApp                          0x1011e55f4 UIImageView.cancel() + 4310799860 (<compiler-generated>:4310799860)\r\n...\r\n...\r\n```\r\n\r\nFor example we call this method when reusing cells in a tableview, where we cancel requests for cells that are not longer visible. We have created an extension on UIImageView to define convenience methods like cancel()\r\n\r\nWhat could be the reason for this crash? The download task in our code is an optional, so even when the object is not there anymore, calling image?.downloadTask.cancel() should not create crashes, should not even trigger those methods.\r\n\r\nHere is a Sample code of what we do:\r\n\r\n```\r\nfunc fetchImage(fromURL url: URL, completion: @escaping (UIImage?, NSError?) -> Void) -> MyAppDownloadTask {    \r\n\t\r\n\tlet resource = ImageResource(downloadURL: url)\r\n\tlet options: KingfisherOptionsInfo = [.targetCache(cache), .downloader(downloader)]\r\n\r\n\tlet task = KingfisherManager.shared.retrieveImage(with: resource, options: options, progressBlock: nil) { result in\r\n\r\n\tswitch result {\r\n\t\tcase .success(let value):\r\n\t\t\tcompletion(value.image, nil)\r\n\t\tcase .failure(let error):\r\n\t\t\tcompletion(nil, error.toNSError())\r\n\t}\r\n        }\r\n\r\n\treturn MyAppDownloadTask(task: task)\r\n}\r\n\r\nprivate class MyAppDownloadTask {\r\n\r\n\tlet task: DownloadTask? // KingFisher task\r\n\r\n\tinit(task: DownloadTask?) {\r\n\t\tself.task = task\r\n\t}\r\n\r\n\tfunc cancel() {\r\n\t\ttask?.cancel()\r\n\t}\r\n}\r\n```\r\n\r\nWe call the cancel method when reusing cells in our collection view:\r\n\r\n```\r\noverride func prepareForReuse() {\r\n\tsuper.prepareForReuse()\r\n\tdownloadTask.cancel()\r\n}\r\n```\r\n\r\n#### Reproduce\r\n\r\nI cannot share the URL that we call, but we've notice that it happens most of the time when the network request have been canceled from the server.\r\n\r\nInfo from New Relic:\r\n\r\n```\r\nnetworkErrorCode: -999\r\nconnectionType: LTE\r\nnetworkError: cancelled\r\nrequestMethod: GET\r\ntypeOfImage: PNG\r\n```\r\n\r\n#### Other Comments\r\n\r\nThe UI updates (assign of UIImageViews) and the cancelation of request when are happening are being done in the Main Thread.\r\n\r\n<!-- Love Kingfisher? Please consider supporting our collective:\r\nðŸ‘‰  https://opencollective.com/Kingfisher/donate -->\r\n","closed_by":{"login":"onevcat","id":1019875,"node_id":"MDQ6VXNlcjEwMTk4NzU=","avatar_url":"https://avatars.githubusercontent.com/u/1019875?v=4","gravatar_id":"","url":"https://api.github.com/users/onevcat","html_url":"https://github.com/onevcat","followers_url":"https://api.github.com/users/onevcat/followers","following_url":"https://api.github.com/users/onevcat/following{/other_user}","gists_url":"https://api.github.com/users/onevcat/gists{/gist_id}","starred_url":"https://api.github.com/users/onevcat/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/onevcat/subscriptions","organizations_url":"https://api.github.com/users/onevcat/orgs","repos_url":"https://api.github.com/users/onevcat/repos","events_url":"https://api.github.com/users/onevcat/events{/privacy}","received_events_url":"https://api.github.com/users/onevcat/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/onevcat/Kingfisher/issues/1511/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/onevcat/Kingfisher/issues/1511/timeline","performed_via_github_app":null,"state_reason":"completed"}