<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 07:17:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SUREFIRE-2058] Corrupted STDOUT by directly writing to native stream in forked JVM 1 with UTF-8 console logging</title>
                <link>https://issues.apache.org/jira/browse/SUREFIRE-2058</link>
                <project id="12317927" key="SUREFIRE">Maven Surefire (Moved to GitHub Issues)</project>
                    <description>&lt;p&gt;&#160;With 3.0.0-M6 surefire and slf4j + logback, most test runs end up with:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[WARNING] Corrupted channel by directly writing to &lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt; stream in forked JVM 1. &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;This only affects &lt;b&gt;3.0.0-M6&lt;/b&gt; (3.0.0-M5 version is working fine in test project).&lt;/p&gt;

&lt;p&gt;&#160;&lt;br/&gt;
After some digging, there are two different scenarios (most likely caused by the same issue):&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;2-byte character at position 1023 (or N * 1024 - 1) in log message is causing the following warning
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[WARNING] Corrupted channel by directly writing to &lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt; stream in forked JVM 1.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;To reproduce this issue logback (with slf4j) should be used. &lt;br/&gt;
Not able to reproduce with System.out.println.&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;4-byte character at position 1023 (or N * 1024 - 1) in log message.&lt;br/&gt;
Can be reproduced with System.out.println (logback not required in this case).&lt;br/&gt;
This blocks surefire entirely at (from jstack):
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;fork-1-event-thread&quot;&lt;/span&gt; #30 daemon prio=5 os_prio=0 cpu=32350.09ms elapsed=32.94s tid=0x00007ff8292d7800 nid=0x3caef runnable  [0x00007ff7876f6000]
   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: RUNNABLE
	at org.apache.maven.surefire.api.stream.AbstractStreamDecoder.decodeString(AbstractStreamDecoder.java:350)
	at org.apache.maven.surefire.api.stream.AbstractStreamDecoder.readString(AbstractStreamDecoder.java:322)
	at org.apache.maven.surefire.api.stream.AbstractStreamDecoder.readString(AbstractStreamDecoder.java:196)
	at org.apache.maven.surefire.stream.EventDecoder.decode(EventDecoder.java:176)
	at org.apache.maven.plugin.surefire.extensions.EventConsumerThread.run(EventConsumerThread.java:73)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Project with reproducible tests (for both scenarios, more in README):&lt;br/&gt;
&lt;a href=&quot;https://github.com/zoltanmeze/surefire-corrupted-channel&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/zoltanmeze/surefire-corrupted-channel&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;One workaround on M6 for now is to use different charset (instead of default UTF-8) or limit message size.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13437787">SUREFIRE-2058</key>
            <summary>Corrupted STDOUT by directly writing to native stream in forked JVM 1 with UTF-8 console logging</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tibordigana">Tibor Digana</assignee>
                                    <reporter username="zoltan.meze">Zoltan Meze</reporter>
                        <labels>
                    </labels>
                <created>Tue, 5 Apr 2022 09:15:59 +0000</created>
                <updated>Fri, 4 Jul 2025 07:41:49 +0000</updated>
                            <resolved>Tue, 26 Apr 2022 21:08:13 +0000</resolved>
                                    <version>3.0.0-M6</version>
                                    <fixVersion>3.0.0-M7</fixVersion>
                                    <component>JUnit 5.x support</component>
                    <component>Maven Surefire Plugin</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="17518885" author="JIRAUSER287608" created="Thu, 7 Apr 2022 13:32:36 +0000"  >&lt;p&gt;I believe this is caused by not clearing output buffer after reading chunks in AbstractStreamDecoder#readString.&lt;br/&gt;
In first iteration decodeString end up with underflow, decoding only 1023 out of 1024 characters and leaving 1 space in output char buffer. Because the 1 remaining space, the output is never flipped/cleared and second iteration always end up with overflow.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;In first scenario it force reads one additional byte. This fills output buffer completely so it is able to exit the loop. Leftover input bytes (line feed) are leaving the channel corrupted.&lt;/li&gt;
	&lt;li&gt;In second scenario output buffer after overflow always ends up with 1 leftover space remaining. This is causing readString to be stuck in infinite loop.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I am currently testing this, seems to be working fine. But not sure if this is correct approach, I am not familiar with this code.&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/maven-surefire/compare/master...zoltanmeze:SUREFIRE-2058&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/maven-surefire/compare/master...zoltanmeze:SUREFIRE-2058&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Edit:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;First scenario can be also reproduced with sout with:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.print(joinedText + &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.lineSeparator());&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17528411" author="tibor17" created="Tue, 26 Apr 2022 21:08:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=maven-surefire.git;a=commit;h=754dd9c45315ff9de20a83c2a0f11af3112159ec&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=maven-surefire.git;a=commit;h=754dd9c45315ff9de20a83c2a0f11af3112159ec&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17552812" author="JIRAUSER290819" created="Fri, 10 Jun 2022 15:32:51 +0000"  >&lt;p&gt;The consequence of this is quite significant - we have just upgraded to 3.0.0-M6 from 3.0.0-M3 and have found that some test goals (with JUnit4 tests) have been marked as passing even though there are test failures, in each problematic case this warning was produced, but it doesn&apos;t cause a failure and means the actual results are hidden.&#160;&lt;/p&gt;</comment>
                            <comment id="17553041" author="JIRAUSER287608" created="Sat, 11 Jun 2022 07:20:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=richardh-alfa&quot; class=&quot;user-hover&quot; rel=&quot;richardh-alfa&quot;&gt;richardh-alfa&lt;/a&gt; New version 3.0.0-M7 is out now. Can you try on that one?&lt;/p&gt;</comment>
                            <comment id="17553669" author="jglick@netbeans.org" created="Mon, 13 Jun 2022 15:36:54 +0000"  >&lt;p&gt;I was able to confirm that M7 fixes at least one variety of the stream corruption problem mentioned in the plugin FAQ. (&lt;a href=&quot;https://github.com/jenkinsci/plugin-pom/pull/557#issuecomment-1154075116&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;details&lt;/a&gt;) Thanks!&lt;/p&gt;</comment>
                            <comment id="17553681" author="JIRAUSER290819" created="Mon, 13 Jun 2022 15:59:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zoltan.meze&quot; class=&quot;user-hover&quot; rel=&quot;zoltan.meze&quot;&gt;zoltan.meze&lt;/a&gt; yes - we&apos;ve upgraded onwards to 3.0.0-M7 and the tests failures started showing up properly and failing the builds again, so we&apos;re all good. Thanks.&lt;/p&gt;</comment>
                            <comment id="17995477" author="olamy" created="Fri, 4 Jul 2025 07:41:49 +0000"  >&lt;p&gt;This project has moved from Jira to GitHub Issues. This issue was migrated to &lt;a href=&quot;https://github.com/apache/maven-surefire/issues/3148&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;apache/maven-surefire#3148&lt;/a&gt;. &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13441827">SUREFIRE-2079</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13227032">SUREFIRE-1659</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13354573">SUREFIRE-1881</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13438173">SUREFIRE-2061</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            18 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z115ig:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>