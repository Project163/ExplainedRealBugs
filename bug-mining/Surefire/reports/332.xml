<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 07:10:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SUREFIRE-946] Maven hangs on SIGTERM when using Surefire forking (CommandLineUtils.ProcessHook)</title>
                <link>https://issues.apache.org/jira/browse/SUREFIRE-946</link>
                <project id="12317927" key="SUREFIRE">Maven Surefire (Moved to GitHub Issues)</project>
                    <description>&lt;p&gt;Java 7u7, Surefire with JUnit &lt;tt&gt;forkMode=&quot;perthread&quot;&lt;/tt&gt; + &lt;tt&gt;threadCount=&quot;1&quot;&lt;/tt&gt; + &lt;tt&gt;reuseForks=&quot;true&quot;&lt;/tt&gt;. After pressing Ctrl-C to stop the Maven test run, the process hangs and must be killed with SIGKILL. From the thread dump, &lt;tt&gt;CommandLineUtils.ProcessHook&lt;/tt&gt; and &lt;tt&gt;StreamFeeder&lt;/tt&gt; look responsible.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12810404">SUREFIRE-946</key>
            <summary>Maven hangs on SIGTERM when using Surefire forking (CommandLineUtils.ProcessHook)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="krosenvold">Kristian Rosenvold</assignee>
                                    <reporter username="jglick">Jesse N. Glick</reporter>
                        <labels>
                    </labels>
                <created>Thu, 3 Jan 2013 15:13:09 +0000</created>
                <updated>Fri, 4 Jul 2025 07:20:06 +0000</updated>
                            <resolved>Tue, 29 Jan 2013 00:51:32 +0000</resolved>
                                    <version>2.13</version>
                                    <fixVersion>2.14</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14455694" author="jglick" created="Thu, 3 Jan 2013 15:15:33 +0000"  >&lt;p&gt;Java 7u9, sorry.&lt;/p&gt;</comment>
                            <comment id="14455672" author="krosenvold" created="Fri, 4 Jan 2013 02:57:22 +0000"  >&lt;p&gt;Ca you find out if this is related to the &quot;reuseForks&quot; parameter, or if it also happens without it ?&lt;/p&gt;</comment>
                            <comment id="14455695" author="krosenvold" created="Fri, 4 Jan 2013 04:38:16 +0000"  >&lt;p&gt;@andreas I think this means LazyTestsToRun line 110 goes puking forever because we try to read a line that never arrives from the killed maven process. Adding a shutdown hook to the plugin that sends termination signal to the fork is probably the way to go. I would actually consider using this same hook to always terminate the forked process, since that&apos;s one of our oldest open issues.&lt;/p&gt;

&lt;p&gt;There is always some dark magic voodo involved when reading/writing process input, I hope this will work. &lt;/p&gt;
</comment>
                            <comment id="14455736" author="agudian" created="Fri, 4 Jan 2013 04:53:24 +0000"  >&lt;p&gt;@kristian: I&apos;d like to give it a try. Can you assign the issue to me?&lt;/p&gt;</comment>
                            <comment id="14455749" author="krosenvold" created="Fri, 4 Jan 2013 06:02:30 +0000"  >&lt;p&gt;Doh; seems like we&apos;d have to make you a committer for me to do that.&lt;/p&gt;

&lt;p&gt;So in the meantime I&apos;ll just keep track of your work here &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14455737" author="agudian" created="Fri, 4 Jan 2013 06:16:08 +0000"  >&lt;p&gt;Fine with me &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14455781" author="jglick" created="Fri, 4 Jan 2013 10:24:14 +0000"  >&lt;p&gt;Seems to happen only when &lt;tt&gt;reuseForks=&quot;true&quot;&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Regardless of possible logic errors reading lines that never arrive, the immediate problem is that shutdown hooks must be very conservative so they are sure to complete promptly, and &lt;tt&gt;CommandLineUtils.ProcessHook&lt;/tt&gt; seems to be deadlocking; it should not call &lt;tt&gt;Process.destroy&lt;/tt&gt; without a timeout. (It could fork a thread calling &lt;tt&gt;destroy&lt;/tt&gt; and wait a second or two for it to complete, else give up.) I am not sure this shutdown hook is actually necessary at all&#151;AFAIK Java would destroy the spawned process at shutdown anyway.&lt;/p&gt;

&lt;p&gt;Since &lt;tt&gt;CommandLineUtils&lt;/tt&gt; seems to buggy in this respect, I would recommend not using it at all. Just use &lt;tt&gt;ProcessBuilder&lt;/tt&gt; directly.&lt;/p&gt;</comment>
                            <comment id="14455673" author="krosenvold" created="Sat, 5 Jan 2013 02:15:55 +0000"  >{begin rant}
&lt;p&gt;Hundreds of tear-stained blog posts have been written about java process forking and the jdk issue tracker is littered with unsolved bugs in process forking. Unfortunately the people who wrote ProcessBuilder did not fully appreciate all the subtleties of these bugs. I spent quite a lot of time trying to make ProcessBuilder stable for the selenium project, and my conclusion was that ProcessBuilder does not handle the process streams correctly, and was broken and deadlock prone for all released jdk versions at the time I tested this (about a year ago).&lt;/p&gt;

&lt;p&gt;This is the code that runs millions of forks every day and has done so for numerous years, in terms of stability and reliability it outperforms ProcessBuilder by a wide margin.&lt;/p&gt;
{end rant}

&lt;p&gt;I have long since supressed the details of the numerous traumatic ways process forking can fail regarding stream handling. Looking at the code now, I think the issue might be that the streams are not closed in the shutdown hook (If I remember correctly the kill -3 will not run the finally block in executeCommandLineAsCallable). I think the process failing to exit is simply because&lt;br/&gt;
we&apos;re not closing the streams properly. &lt;/p&gt;


&lt;p&gt;I&apos;m thinking adding these to the current shutdown hook might do it:&lt;/p&gt;

&lt;p&gt;                   if ( inputFeeder != null )&lt;/p&gt;
                    {
                        inputFeeder.close();
                    }

&lt;p&gt;                    outputPumper.close();&lt;/p&gt;

&lt;p&gt;                    errorPumper.close();&lt;/p&gt;

&lt;p&gt;(It&apos;s probably wise trying to fix this one problem first before moving onto more esoteric stuff like heartbeats...)&lt;/p&gt;

&lt;p&gt;I clearly seem to remember one of the tearstained blogposts about terminating forks that were waiting for output from stdin. The details escape me &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;In this context we might consider switching rpc mechanism entirely to something like named pipes. The 2-way communications between two java processes using stdio is really one of the reasons I&apos;ve held back on implementing this feature in the first place. Suggestions are welcome as I&apos;m still thinking about this on the 5th year or so &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;/p&gt;


&lt;p&gt;BTW: The shutdown hook is necessary for some reason (probably more bugs). The explanation can be found by looking at history for ant/commons-exec/plexus-utils. I believe the original commit in plexus has a fairly extensive issue history.&lt;/p&gt;</comment>
                            <comment id="14455651" author="agudian" created="Sat, 5 Jan 2013 14:15:12 +0000"  >&lt;p&gt;On my Windows PC, hitting Ctrl+C correctly kills all processes. From the stack dumps, it looked to me as if the &lt;em&gt;forked&lt;/em&gt; process was killed off without the main process knowing. So I executed some test classes from which one calls &lt;tt&gt;System.exit(0)&lt;/tt&gt; in its test method. Bang, I got the exact same stack dumps.&lt;/p&gt;

&lt;p&gt;I fixed that by adding a shutdown hook in the forked process that will say &quot;bye&quot; to the main process if everything went fine, and report an abnormal termination if something else went wrong (such as a test calling &lt;tt&gt;System.exit&lt;/tt&gt;). The main process then closes the &lt;tt&gt;TestProvidingInputStream&lt;/tt&gt;, allowing the &lt;tt&gt;StreamFeeder&lt;/tt&gt; thread to terminate.&lt;/p&gt;

&lt;p&gt;Still, in case the shutdown hooks are not executed (e.g. due to &lt;tt&gt;Runtime.halt(..)&lt;/tt&gt; or some other brutal external process termination, we will end up having the same problem. We would be back with that heartbeat thing... &lt;/p&gt;

&lt;p&gt;Pull-request is open.&lt;/p&gt;</comment>
                            <comment id="14455750" author="agudian" created="Sat, 5 Jan 2013 14:17:21 +0000"  >&lt;p&gt;Added patch file containing the commits of github pull request &lt;a href=&quot;https://github.com/apache/maven-surefire/pull/20&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/maven-surefire/pull/20&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14455719" author="jglick" created="Mon, 7 Jan 2013 08:56:46 +0000"  >&lt;p&gt;Regardless of why the subprocess is failing to exit, the fact remains that the current &lt;tt&gt;ProcessHook&lt;/tt&gt; tries to acquire a lock during a shutdown hook with no timeout and no guarantee that this lock will be released in a timely fashion. Making it more likely for the subprocess to exit &amp;ldquo;cleanly&amp;rdquo; may make this bug less likely to occur but will not completely prevent it. Supplementing Andreas&amp;rsquo; fix with a patch to &lt;tt&gt;ProcessHook&lt;/tt&gt; to impose a timeout on the call to &lt;tt&gt;Process.destroy&lt;/tt&gt; still seems like a good idea.&lt;/p&gt;</comment>
                            <comment id="14455738" author="agudian" created="Mon, 7 Jan 2013 14:09:26 +0000"  >&lt;p&gt;Where do you see &lt;tt&gt;ProcessHook&lt;/tt&gt; acquiring a lock? I think terminating the forked VM is not the problem. &lt;br/&gt;
I think the (remaining) problem is if the forked VM terminates &lt;em&gt;without&lt;/em&gt; executing its own shutdown hook.&lt;/p&gt;

&lt;p&gt;Do you have any means to test this fix for your scenario?&lt;/p&gt;</comment>
                            <comment id="14455625" author="agudian" created="Mon, 7 Jan 2013 14:11:11 +0000"  >&lt;p&gt;@Kristian: what do you think, should we aim to add a heartbeat-feature for the the coming release?&lt;/p&gt;</comment>
                            <comment id="14455595" author="jglick" created="Mon, 7 Jan 2013 14:14:17 +0000"  >&lt;p&gt;Acquiring the lock:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-none&quot;&gt;&quot;CommandlineUtils process shutdown hook&quot; prio=10 tid=0x6757a800 nid=0x29b1 waiting for monitor entry [0x678ad000]
   java.lang.Thread.State: BLOCKED (on object monitor)
	at java.io.BufferedOutputStream.flush(BufferedOutputStream.java:140)
	- waiting to lock &amp;lt;0xa7b292c8&amp;gt; (a java.lang.UNIXProcess$ProcessPipeOutputStream)
	at java.io.FilterOutputStream.close(FilterOutputStream.java:157)
	at java.lang.UNIXProcess.destroy(UNIXProcess.java:234)
	at org.apache.maven.surefire.shade.org.apache.maven.shared.utils.cli.CommandLineUtils$ProcessHook.run(CommandLineUtils.java:74)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Testing fix: I will try to do so soon.&lt;/p&gt;</comment>
                            <comment id="14455697" author="agudian" created="Mon, 7 Jan 2013 14:23:39 +0000"  >&lt;p&gt;Damn, I didn&apos;t see that. Then the fix might not work for you. What OS are you on?&lt;/p&gt;</comment>
                            <comment id="14455767" author="agudian" created="Mon, 7 Jan 2013 14:27:53 +0000"  >&lt;p&gt;Give me some minutes before starting to compile, I already see what I have to do...&lt;/p&gt;</comment>
                            <comment id="14455790" author="agudian" created="Mon, 7 Jan 2013 14:48:49 +0000"  >&lt;p&gt;Ok, please try &lt;a href=&quot;https://github.com/agudian/maven-surefire/tree/SUREFIRE-946&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/agudian/maven-surefire/tree/SUREFIRE-946&lt;/a&gt; (&lt;a href=&quot;https://github.com/agudian/maven-surefire/archive/SUREFIRE-946.zip&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/agudian/maven-surefire/archive/SUREFIRE-946.zip&lt;/a&gt;)&lt;/p&gt;</comment>
                            <comment id="14455674" author="jglick" created="Mon, 7 Jan 2013 14:51:40 +0000"  >&lt;p&gt;Linux 3.2.0 (Ubuntu 12.04), sorry for not mentioning this initially.&lt;/p&gt;</comment>
                            <comment id="14455626" author="jglick" created="Tue, 8 Jan 2013 14:38:22 +0000"  >&lt;p&gt;Proposed fix works in my case at least.&lt;/p&gt;

&lt;p&gt;FYI my test case is: &lt;a href=&quot;https://github.com/jenkinsci/jenkins/pull/667&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jenkinsci/jenkins/pull/667&lt;/a&gt; (just edit root &lt;tt&gt;pom.xml&lt;/tt&gt; to use &lt;tt&gt;2.14-SNAPSHOT&lt;/tt&gt; then run &lt;tt&gt;mvn -DskipTests install &amp;amp;&amp;amp; mvn -f test/pom.xml surefire:test&lt;/tt&gt; and press Ctrl-C after some tests have started)&lt;/p&gt;</comment>
                            <comment id="14455720" author="agudian" created="Tue, 8 Jan 2013 15:03:07 +0000"  >&lt;p&gt;Great, thanks for your test.&lt;/p&gt;

&lt;p&gt;Then for &lt;tt&gt;reuseForks=true&lt;/tt&gt; the crash detection and behaviour when terminating the main process now at least works just as good or bad as for the other forked test executions in 2.13.4.&lt;/p&gt;</comment>
                            <comment id="14455652" author="krosenvold" created="Wed, 9 Jan 2013 02:36:23 +0000"  >&lt;p&gt;I want to study this issue/fix a little closer before committing anything, so I&apos;ll push this through once I get time to sit down properly with it, which will stil be a few days from now. &lt;/p&gt;</comment>
                            <comment id="14455596" author="krosenvold" created="Wed, 9 Jan 2013 11:44:45 +0000"  >&lt;p&gt;I have looked at the patch, and applied it to trunk in e54dbd810f62fe723800f11279b881bff244b707&lt;/p&gt;

&lt;p&gt;@andreas: I have a couple of minor considerations I&apos;d like your input on;&lt;/p&gt;

&lt;p&gt;TestProvidingInputStream has synchronized read method. As far as I can tell the use of this class is confined to a single thread? If this is not the case, then &quot;close&quot; must be synchronized (or &quot;closed&quot; volatile), since there is mismatched synchronization on this variable in the class. (Both reads and writes need to be synchronized for correctness). BUt it seems like this class is NotThreadSafe ?&lt;/p&gt;


&lt;p&gt;In forkedBooter, I&apos;m not sure I understand the added value provided by the ForkingRunListener.BOOTERCODE_CRASH, since by my meagre understanding, anything that is not BOOTERCODE_BYE implies a crash ?&lt;br/&gt;
(Which was the existing logic)&lt;/p&gt;

</comment>
                            <comment id="14455751" author="krosenvold" created="Wed, 9 Jan 2013 11:47:12 +0000"  >&lt;p&gt;Btw the &quot;timeout-forked&quot; IT-project can be run with  mvn -DsleepLength=1000000 -Dsurefire.version=2.14-SNAPSHOT -DforkMode=perthread -DreuseForks=true -DthreadCount=2 test&lt;/p&gt;

&lt;p&gt;to test this issue. It might even be possble to make a testcase for this, /me wonders.&lt;/p&gt;</comment>
                            <comment id="14455739" author="agudian" created="Wed, 9 Jan 2013 13:09:01 +0000"  >&lt;p&gt;@Kristian:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;indeed, &lt;tt&gt;closed&lt;/tt&gt; needs to be volatile. Then it should be thread-safe again.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;BOOTERCODE_CRASH&lt;/tt&gt; is the way for the forked process to let the main process know that it terminated unexpectedly. The reason why I added this is to repair the crash-detection, which would not work without actively closing the TestProvidingInputStream at some point. See the extended CrashDetectionIT: it fails without that part of the fix (well, to be more precise: the test will hang). However, as I have mentioned in one of my comments above, this only fixes the crash detection for those cases where the VM is still able to execute the shutdown hook successfully. To really fix it for that case as well, I yet have not any other idea than to implement the heart-beat feature. Hmm, or perhaps if we extend the CommandLineUtils to allow passing a custom hook to execute before it starts waiting on the streams. That could work, I guess and I could remove the BOOTERCODE_CRASH stuff again... I&apos;ll try that... &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/li&gt;
	&lt;li&gt;Integration-Tests: yeah. For the VM termination in the forked process, I extended the CrashDetectionIT. To test the brutal VM crash of the forked process, I will further extend it (and call Runtime#halt). The exact issue that Jesse had was that the main process tried to shut down, but the locks held in the TestProvidingInputStream prevented the shutdown hooks to finish. So what we would need is a test that sends a kill signal to the main process started by the IT. I don&apos;t know the internal guts of the Verifier - but is that possible? Ok, looked at Process#destroy() and it seems do-able. Requires some more work on CommandLineUtils, Verifier and everything in between. Sounds like fun &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14455791" author="krosenvold" created="Wed, 9 Jan 2013 13:18:39 +0000"  >&lt;p&gt;I think it depends if CommandlineUtils leaks the pid or allows killing by external handle. I know we have this in selenium but I don&apos;t remember here &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14455675" author="agudian" created="Wed, 9 Jan 2013 13:24:03 +0000"  >&lt;p&gt;It already has the ability to pass a timeout for the process. I would add another option to tell it to &lt;tt&gt;killProcessAfterTimeout&lt;/tt&gt; - and then in that case let it call Process#destroy(). That should do it, right?&lt;/p&gt;</comment>
                            <comment id="14455768" author="krosenvold" created="Wed, 9 Jan 2013 14:02:16 +0000"  >&lt;p&gt;Before that I think you need to take a look at ConsoleOutputIT, which was broken with this fix &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;It fails on the assert for &quot;Printline in shutdown hook&quot;, which I assume is because  we send BYE in the shutdown hook, and the hook with soutv runs afterwards. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;This fails because the CI runs on jdk1.5 and that has a different iteration order of maps than 1.6, and the shutdown hooks are in a map; which means they dont have a predictable order.&lt;/p&gt;</comment>
                            <comment id="14455723" author="krosenvold" created="Wed, 9 Jan 2013 14:05:50 +0000"  >&lt;p&gt;I&apos;m thinking the shutdown hook could be &quot;not used&quot; when we terminate normally, so the successful flow of events does not have to depend on a shutdown hook - like it used to be. So we basically add &amp;amp; remove the shutdown hook in the normal flow of events, and send BYE without involving the hook. While the test runs, the hook is in place and will catch dirty stuff happening in the test ?&lt;/p&gt;</comment>
                            <comment id="14455627" author="agudian" created="Wed, 9 Jan 2013 14:11:08 +0000"  >&lt;p&gt;I guess I&apos;ll first try to remove it all together by adding that callback to CommandLineUtils... Then there would only be a problem in case &lt;tt&gt;Process&lt;/tt&gt; does not get when the forked process is termintated - does that happen?&lt;/p&gt;</comment>
                            <comment id="14455653" author="krosenvold" created="Wed, 9 Jan 2013 14:17:28 +0000"  >&lt;p&gt;Process termination is a tremendous PITA. Do not expect this to work at all.&lt;/p&gt;

&lt;p&gt;I think it might be safer to send a &quot;TERMINATE&quot; down the commlink and do System.exit() in the fork.&lt;/p&gt;</comment>
                            <comment id="14455740" author="agudian" created="Wed, 9 Jan 2013 16:24:17 +0000"  >&lt;p&gt;OK, check my latest push... It fixes all the broken ITs, it now even works in case the forked process calls Runtime#halt, and I removed BOOTERCODE_CRASH. Also added an IT for the initial problem described in this issue (Surefire946KillMainProcessInReusableForkIT), and extended the CrashDetectionIT to test reuseForks with Runtime#halt.&lt;/p&gt;

&lt;p&gt;This still relys on Process#waitFor to work in case no timeout was given. So we&apos;re not getting better than in 2.12.4, but I hope it&apos;s not worse either.&lt;/p&gt;

&lt;p&gt;Oh, and... I had to modify maven-verifier (for Surefire946KillMainProcessInReusableForkIT) and maven-shared-utils (for the IT and the actual fix). I pushed that to &lt;a href=&quot;https://github.com/agudian/maven-shared/tree/SUREFIRE-946&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/agudian/maven-shared/tree/SUREFIRE-946&lt;/a&gt;, but did not yet file a pull-request. I&apos;d like your feedback first... &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14455792" author="agudian" created="Thu, 10 Jan 2013 01:58:30 +0000"  >&lt;p&gt;Having thought about this over night, I&apos;m pretty sure my Surefire946KillMainProcessInReusableForkIT does not yet test anything, as a) verifier does not fork by default in the current configuration, and b) I&apos;d have to add some code to check if the process already terminated (e.g. by checking if the thread named &lt;tt&gt;Thread.currentThread().getName()+ &quot;-ProcessKiller&quot;&lt;/tt&gt; is still alive). I&apos;ll fix that tonight.&lt;/p&gt;</comment>
                            <comment id="14455722" author="krosenvold" created="Thu, 10 Jan 2013 08:27:49 +0000"  >&lt;p&gt;I&apos;m not planning to re-release verifier right now; can we do without the changes for this patch ? Does that only affect the IT ?&lt;/p&gt;</comment>
                            <comment id="14455742" author="krosenvold" created="Tue, 29 Jan 2013 00:51:32 +0000"  >&lt;p&gt;Fixed in a series of patches &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17994350" author="olamy" created="Fri, 4 Jul 2025 07:20:06 +0000"  >&lt;p&gt;This project has moved from Jira to GitHub Issues. This issue was migrated to &lt;a href=&quot;https://github.com/apache/maven-surefire/issues/1615&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;apache/maven-surefire#1615&lt;/a&gt;. &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12720150" name="SUREFIRE-946.patch" size="9153" author="agudian" created="Sat, 5 Jan 2013 14:17:21 +0000"/>
                            <attachment id="12720334" name="stack.txt" size="20637" author="jglick" created="Thu, 3 Jan 2013 15:13:09 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            18 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2bd4n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>