<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 07:17:50 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SUREFIRE-2135] On Unix-like OS and JDK 18+ Surefire kills the forked JVM if PpidChecker is active and argLine is set to -Dfile.encoding=UTF-16</title>
                <link>https://issues.apache.org/jira/browse/SUREFIRE-2135</link>
                <project id="12317927" key="SUREFIRE">Maven Surefire (Moved to GitHub Issues)</project>
                    <description>&lt;p&gt;This breaks the continuous build on Java 18 and 19 because the integration test &lt;tt&gt;ConsoleOutputIT#properNewlinesAndEncodingWithDifferentEncoding&lt;/tt&gt; fails.&lt;/p&gt;
&lt;h3&gt;&lt;a name=&quot;Stepstoreproduce&quot;&gt;&lt;/a&gt;Steps to reproduce&lt;/h3&gt;

&lt;p&gt;A minimum project to reproduce the issue requires a unit test and the following surefire configuration:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-xml&quot;&gt;
  &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;build&amp;gt;&lt;/span&gt;
     &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;plugins&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;plugin&amp;gt;&lt;/span&gt;
           &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;groupId&amp;gt;&lt;/span&gt;org.apache.maven.plugins&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/groupId&amp;gt;&lt;/span&gt;
           &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;artifactId&amp;gt;&lt;/span&gt;maven-surefire-plugin&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/artifactId&amp;gt;&lt;/span&gt;
           &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;version&amp;gt;&lt;/span&gt;3.0.0-M7&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/version&amp;gt;&lt;/span&gt;
	       &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;configuration&amp;gt;&lt;/span&gt;
               &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;enableProcessChecker&amp;gt;&lt;/span&gt;all&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/enableProcessChecker&amp;gt;&lt;/span&gt;
           &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/configuration&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/plugin&amp;gt;&lt;/span&gt;
     &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/plugins&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/build&amp;gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The following output will be produced upon executing &lt;tt&gt;mvn test&lt;/tt&gt;:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[ERROR] Failed to execute goal org.apache.maven.plugins:maven-surefire-plugin:3.0.0-M7:test (default-test) on project myproject:
[ERROR] Please refer to /home/ogapa/code/maven-samples/utf16/target/surefire-reports for the individual test results.
[ERROR] Please refer to dump files (if any exist) [date].dump, [date]-jvmRun[N].dump and [date].dumpstream.
[ERROR] The forked VM terminated without properly saying goodbye. VM crash or System.exit called?
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;with the following stacktrace&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.maven.surefire.booter.SurefireBooterForkException: Error occurred in starting fork, check output in log
        at org.apache.maven.plugin.surefire.booterclient.ForkStarter.fork(ForkStarter.java:635)
        at org.apache.maven.plugin.surefire.booterclient.ForkStarter.run(ForkStarter.java:311)
        at org.apache.maven.plugin.surefire.booterclient.ForkStarter.run(ForkStarter.java:268)
        at org.apache.maven.plugin.surefire.AbstractSurefireMojo.executeProvider(AbstractSurefireMojo.java:1334)
        at org.apache.maven.plugin.surefire.AbstractSurefireMojo.executeAfterPreconditionsChecked(AbstractSurefireMojo.java:1167)
        at org.apache.maven.plugin.surefire.AbstractSurefireMojo.execute(AbstractSurefireMojo.java:931)
        at org.apache.maven.plugin.DefaultBuildPluginManager.executeMojo(DefaultBuildPluginManager.java:137)
        at org.apache.maven.lifecycle.internal.MojoExecutor.doExecute2(MojoExecutor.java:370)
        at org.apache.maven.lifecycle.internal.MojoExecutor.doExecute(MojoExecutor.java:351)
        at org.apache.maven.lifecycle.internal.MojoExecutor.execute(MojoExecutor.java:215)
        at org.apache.maven.lifecycle.internal.MojoExecutor.execute(MojoExecutor.java:171)
        at org.apache.maven.lifecycle.internal.MojoExecutor.execute(MojoExecutor.java:163)
        at org.apache.maven.lifecycle.internal.LifecycleModuleBuilder.buildProject(LifecycleModuleBuilder.java:117)
        at org.apache.maven.lifecycle.internal.LifecycleModuleBuilder.buildProject(LifecycleModuleBuilder.java:81)
        at org.apache.maven.lifecycle.internal.builder.singlethreaded.SingleThreadedBuilder.build(SingleThreadedBuilder.java:56)
        at org.apache.maven.lifecycle.internal.LifecycleStarter.execute(LifecycleStarter.java:128)
        at org.apache.maven.DefaultMaven.doExecute(DefaultMaven.java:294)
        at org.apache.maven.DefaultMaven.doExecute(DefaultMaven.java:192)
        at org.apache.maven.DefaultMaven.execute(DefaultMaven.java:105)
        at org.apache.maven.cli.MavenCli.execute(MavenCli.java:960)
        at org.apache.maven.cli.MavenCli.doMain(MavenCli.java:293)
        at org.apache.maven.cli.MavenCli.main(MavenCli.java:196)
        at java.base/jdk.internal.reflect.DirectMethodHandleAccessor.invoke(DirectMethodHandleAccessor.java:104)
        at java.base/java.lang.reflect.Method.invoke(Method.java:577)
        at org.codehaus.plexus.classworlds.launcher.Launcher.launchEnhanced(Launcher.java:282)
        at org.codehaus.plexus.classworlds.launcher.Launcher.launch(Launcher.java:225)
        at org.codehaus.plexus.classworlds.launcher.Launcher.mainWithExitCode(Launcher.java:406)
        at org.codehaus.plexus.classworlds.launcher.Launcher.main(Launcher.java:347)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;All versions between 3.0.0-M4 and 3.0.0-M7 are affected. I could not reproduce it with versions before 3.0.0-M4.&lt;/p&gt;
&lt;h3&gt;&lt;a name=&quot;Rootcauseanalysis&quot;&gt;&lt;/a&gt;Root cause analysis&lt;/h3&gt;

&lt;p&gt;In the log of the failed test the following line gives an indication as to what the cause is:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[ERROR] Surefire is going to kill self fork JVM. Maven process died.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;em&gt;Note: There is a race condition. If the test is fast enough (&amp;lt; 20 ms), the build may actually be successful despite the attempted killing of the self fork JVM. The exit code of the mvn process is still 1 though, not 0.&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;The above output is produced by the &lt;tt&gt;ForkedBooter&lt;/tt&gt; class if &lt;tt&gt;PpidChecker#isProcessAlive&lt;/tt&gt; returns false but the ping scheduler is not shut down yet.&lt;/p&gt;

&lt;p&gt;Debugging into &lt;tt&gt;PpidChecker&lt;/tt&gt; I found the reason why &lt;tt&gt;PpidChecker#isProcessAlive&lt;/tt&gt; returns false:&lt;/p&gt;

&lt;p&gt;The &lt;tt&gt;PpidChecker&lt;/tt&gt; uses the command &lt;tt&gt;ps -o etime,pid &amp;lt;PID&amp;gt;&lt;/tt&gt; to check if the elapsed time is still increasing, but if &lt;tt&gt;file.encoding&lt;/tt&gt; is set to UTF-16, it fails to parse the &lt;tt&gt;ps&lt;/tt&gt; output. Parsing fails because the &lt;tt&gt;java.util.Scanner&lt;/tt&gt; it uses for that job is configured with &lt;tt&gt;Charset#defaultCharset&lt;/tt&gt;, meaning it expects the &lt;tt&gt;InputStream&lt;/tt&gt; of the &lt;tt&gt;ps&lt;/tt&gt; output to produce UTF-16. It is however UTF-8 on basically all Unix-like systems.&lt;/p&gt;
&lt;h3&gt;&lt;a name=&quot;So%2ChowdidthiscodeworkbeforeJava18%3F&quot;&gt;&lt;/a&gt;So, how did this code work before Java 18?&lt;/h3&gt;

&lt;p&gt;It didn&apos;t. The only reason this didn&apos;t surface before is that there was another bug that prevented the &lt;tt&gt;PpidChecker&lt;/tt&gt; from even getting that far. In Java versions &amp;lt; 18 the &lt;tt&gt;ProcessBuilder#start&lt;/tt&gt; call fails if &lt;tt&gt;file.encoding&lt;/tt&gt; is set to UTF-16, with an exception message saying &quot;java.io.IOException: Cannot run program &quot;/bin/sh&quot;: error=2, No such file or directory&quot; which leads to &lt;tt&gt;PpidChecker#isProcessAlive&lt;/tt&gt; throwing an exception. That exception leads to the process check being aborted, but is then swallowed in the &lt;tt&gt;ForkedBooter&lt;/tt&gt; class.&lt;/p&gt;

&lt;p&gt;The &lt;tt&gt;ProcessBuilder&lt;/tt&gt; bug was apparently fixed in Java 18 which led to this problem surfacing.&lt;/p&gt;
&lt;h3&gt;&lt;a name=&quot;Suggestionofafix&quot;&gt;&lt;/a&gt;Suggestion of a fix&lt;/h3&gt;

&lt;p&gt;In Java 17 the additional system property &lt;tt&gt;native.encoding&lt;/tt&gt; was &lt;a href=&quot;https://bugs.openjdk.org/browse/JDK-8266075&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;introduced&lt;/a&gt;. Since we are dealing with the output of a native OS command, this is the correct encoding to use for this particular use case - if it is present.&lt;/p&gt;

&lt;p&gt;In case the system property is missing, we can use UTF-8 as a reasonable default since almost all modern Unix-like systems use UTF-8 as a system encoding by default.&lt;/p&gt;

&lt;p&gt;So, when configuring the &lt;tt&gt;java.util.Scanner&lt;/tt&gt; it uses to parse the output of the &lt;tt&gt;ps&lt;/tt&gt; command, I suggest the &lt;tt&gt;PpidChecker&lt;/tt&gt; should configure it based on the system property &lt;tt&gt;native.encoding&lt;/tt&gt; and fall back to UTF-8 if the system property is absent, i.e. in Java versions before 17.&lt;/p&gt;</description>
                <environment>Unix-like OS, JDK 18 or higher</environment>
        <key id="13514640">SUREFIRE-2135</key>
            <summary>On Unix-like OS and JDK 18+ Surefire kills the forked JVM if PpidChecker is active and argLine is set to -Dfile.encoding=UTF-16</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sjaranowski">Slawomir Jaranowski</assignee>
                                    <reporter username="andpab">Andreas Pabst</reporter>
                        <labels>
                    </labels>
                <created>Sun, 18 Dec 2022 21:12:42 +0000</created>
                <updated>Fri, 4 Jul 2025 07:43:34 +0000</updated>
                            <resolved>Mon, 19 Dec 2022 14:41:32 +0000</resolved>
                                    <version>3.0.0-M4</version>
                    <version>3.0.0-M5</version>
                    <version>3.0.0-M6</version>
                    <version>3.0.0-M7</version>
                                    <fixVersion>3.0.0-M8</fixVersion>
                                    <component>process forking</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17995568" author="olamy" created="Fri, 4 Jul 2025 07:43:34 +0000"  >&lt;p&gt;This project has moved from Jira to GitHub Issues. This issue was migrated to &lt;a href=&quot;https://github.com/apache/maven-surefire/issues/2739&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;apache/maven-surefire#2739&lt;/a&gt;. &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            18 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1e7xc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>