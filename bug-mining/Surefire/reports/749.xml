<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 07:18:01 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SUREFIRE-2190] optional dependencies and JPMS modules confuse surefire</title>
                <link>https://issues.apache.org/jira/browse/SUREFIRE-2190</link>
                <project id="12317927" key="SUREFIRE">Maven Surefire (Moved to GitHub Issues)</project>
                    <description>&lt;p&gt;The surefire plugin, when executing tests for JPMS code, patches the test code &quot;into&quot; the module under test (using &lt;tt&gt;--patch-module&lt;/tt&gt;).&#160;This work for compile+runtime dependencies (`requires`) but not for compile required/runtime optional dependencies (&lt;tt&gt;requires static&lt;/tt&gt;).&lt;/p&gt;

&lt;p&gt;The plugin only adds the module under test using &lt;tt&gt;--add-modules module.under.test.id&lt;/tt&gt; to the JVM that is executing the test classes. As &lt;tt&gt;requires static&lt;/tt&gt; dependencies are not loaded transitively, any dependency that is optional for the main artifact but required for test code is not found.&lt;/p&gt;

&lt;p&gt;clone and build the test repo: &lt;a href=&quot;https://github.com/hgschmie/msurefire2190&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/hgschmie/msurefire2190&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This repo contains three artifacts with identical code:&lt;/p&gt;

&lt;p&gt;thing1 builds a main artifact without JPMS&lt;br/&gt;
thing2 builds a main artifact with a strong (&lt;tt&gt;requires&lt;/tt&gt;) dependency on jakarta.annotation.&lt;br/&gt;
thing3 builds a main artifact with a compile-only (&lt;tt&gt;requires static&lt;/tt&gt;) dependency on jakarta.annotation.&lt;br/&gt;
The code and its test classes are otherwise identical.&lt;/p&gt;

&lt;p&gt;Running &lt;tt&gt;mvn -DskipTests&lt;/tt&gt; clean install builds all three modules and the test code.&lt;/p&gt;

&lt;p&gt;Running &lt;tt&gt;mvn surefire:test&lt;/tt&gt; passes the tests in the first two modules but fails in the third.&lt;/p&gt;

&lt;p&gt;Explanation:&lt;/p&gt;

&lt;p&gt;The surefire plugin, when it executes tests using JPMS adds all referenced modules to the module path (in this case the module under test itself and the jakarta.annotations-api jar). It then adds the main module using &lt;tt&gt;--add-modules&lt;/tt&gt; and patches this module with the test classes (using &lt;tt&gt;-patch-module&lt;/tt&gt;, so that the test classes execute as part of the module.&lt;/p&gt;

&lt;p&gt;In case of a compile+runtime (&lt;tt&gt;requires&lt;/tt&gt;) relationship, the JVM will find the required JPMS module on the module path and add it as accessible. This is why the &quot;thing2&quot; tests pass.&lt;/p&gt;

&lt;p&gt;In case of a compile only/runtime optional (&lt;tt&gt;requires static&lt;/tt&gt;) relationship, the JVM will not add the module transitively as it is considered a compilation-only dependency. For the code under test to be able to access the classes from jakarta.annotation, they must be declared as a module. However, the test code only adds the module under test with &lt;tt&gt;--add-modules&lt;/tt&gt;. So the test classes do not find any classes from the jakarta.annotation module and the test fails.&lt;/p&gt;

&lt;p&gt;The fix is simple: Instead of just adding the module under test using &lt;tt&gt;--add-modules&lt;/tt&gt;, the surefire plugin should use &lt;tt&gt;-add-modules ALL-MODULE-PATH&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Which is correct, because the code is not looking for compile time only dependencies but actual runtime dependencies where the code under execution may also need to access optional runtime dependencies (see&lt;br/&gt;
&lt;a href=&quot;https://nipafx.dev/java-modules-optional-dependencies/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://nipafx.dev/java-modules-optional-dependencies/&lt;/a&gt; for a slightly longer explanation).&lt;/p&gt;</description>
                <environment></environment>
        <key id="13547933">SUREFIRE-2190</key>
            <summary>optional dependencies and JPMS modules confuse surefire</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="henning">Henning Schmiedehausen</assignee>
                                    <reporter username="henning">Henning Schmiedehausen</reporter>
                        <labels>
                    </labels>
                <created>Sat, 19 Aug 2023 05:15:46 +0000</created>
                <updated>Fri, 4 Jul 2025 07:44:03 +0000</updated>
                            <resolved>Fri, 1 Sep 2023 18:51:40 +0000</resolved>
                                    <version>3.1.2</version>
                                    <fixVersion>3.2.0</fixVersion>
                    <fixVersion>3.2.1</fixVersion>
                                    <component>JUnit 5.x support</component>
                    <component>Maven Surefire Plugin</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17756238" author="githubbot" created="Sat, 19 Aug 2023 05:51:47 +0000"  >&lt;p&gt;hgschmie opened a new pull request, #668:&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/maven-surefire/pull/668&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/maven-surefire/pull/668&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;   Include all modules on the module path to the root modules. This fixes&lt;br/&gt;
   test code that uses dependencies that are declared as optional&lt;br/&gt;
   (`require static`) for the main artifact to access these dependencies.&lt;/p&gt;

&lt;p&gt;   maven surefire plugin struggles with optional dependencies for the main artifact and test code.&lt;/p&gt;

&lt;p&gt;   Check out the test repo at &lt;a href=&quot;https://github.com/hgschmie/msurefire2190&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/hgschmie/msurefire2190&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;   This repo contains three artifacts with identical code:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;thing1 builds a main artifact without JPMS&lt;/li&gt;
	&lt;li&gt;thing2 builds a main artifact with a strong (`requires`) dependency on jakarta.annotation.&lt;/li&gt;
	&lt;li&gt;thing3 builds a main artifact with a compile-only (`requires static`) dependency on jakarta annotations.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;   The code and its test classes are otherwise identical.&lt;/p&gt;

&lt;p&gt;   Running `mvn -DskipTests clean install` builds all three modules and the test code.&lt;/p&gt;

&lt;p&gt;   Running `mvn surefire:test` passes the tests in the first two modules but fails in the third.&lt;/p&gt;

&lt;p&gt;   The surefire plugin, when it executes tests using JPMS adds all&lt;br/&gt;
   referenced modules to the module path (in this case the module under&lt;br/&gt;
   test itself and the jakarta.annotations-api jar). It then adds the&lt;br/&gt;
   main module using `--add-modules` and patches this module with the&lt;br/&gt;
   test classes (so that the test classes execute as part of the module).&lt;/p&gt;

&lt;p&gt;   In case of a `requires` relationship, the JVM will find the required&lt;br/&gt;
   JPMS module and add it as accessible. This is why the &quot;thing2&quot; tests&lt;br/&gt;
   pass.&lt;/p&gt;

&lt;p&gt;   In case of a `requires static` relationship, the JVM will not add the&lt;br/&gt;
   module transitively as it is considered a compilation-only&lt;br/&gt;
   dependency. For the code under test to be able to access the classes&lt;br/&gt;
   from `jakarta.annotation`, they must be declared as a module. However,&lt;br/&gt;
   the test code only adds the module under test with `--add-modules`.&lt;/p&gt;


&lt;hr /&gt;

&lt;p&gt;   The fix for this is pretty simple but must be done in the surefire&lt;br/&gt;
   plugin. Instead of adding `--add-modules &amp;lt;... module id under test..&amp;gt;`,&lt;br/&gt;
   it needs to add `--add-modules ALL-MODULE-PATH`. Which is&lt;br/&gt;
   correct, because the code is not looking for compile time only&lt;br/&gt;
   dependencies but actual runtime dependencies where the code under&lt;br/&gt;
   execution may also need to access optional runtime dependencies (see&lt;br/&gt;
   &lt;a href=&quot;https://nipafx.dev/java-modules-optional-dependencies/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://nipafx.dev/java-modules-optional-dependencies/&lt;/a&gt; for a slightly&lt;br/&gt;
   longer explanation).&lt;/p&gt;


&lt;p&gt;   Following this checklist to help us incorporate your&lt;br/&gt;
   contribution quickly and easily:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;X&amp;#93;&lt;/span&gt; Make sure there is a &lt;span class=&quot;error&quot;&gt;&amp;#91;JIRA issue&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://issues.apache.org/jira/browse/SUREFIRE&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SUREFIRE&lt;/a&gt;) filed&lt;br/&gt;
          for the change (usually before you start working on it).  Trivial changes like typos do not&lt;br/&gt;
          require a JIRA issue.  Your pull request should address just this issue, without&lt;br/&gt;
          pulling in other changes.&lt;/li&gt;
	&lt;li&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;X&amp;#93;&lt;/span&gt; Each commit in the pull request should have a meaningful subject line and body.&lt;/li&gt;
	&lt;li&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;X&amp;#93;&lt;/span&gt; Format the pull request title like `&lt;span class=&quot;error&quot;&gt;&amp;#91;SUREFIRE-XXX&amp;#93;&lt;/span&gt; - Fixes bug in ApproximateQuantiles`,&lt;br/&gt;
          where you replace `SUREFIRE-XXX` with the appropriate JIRA issue. Best practice&lt;br/&gt;
          is to use the JIRA issue title in the pull request title and in the first line of the&lt;br/&gt;
          commit message.&lt;/li&gt;
	&lt;li&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;X&amp;#93;&lt;/span&gt; Write a pull request description that is detailed enough to understand what the pull request does, how, and why.&lt;/li&gt;
	&lt;li&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;X&amp;#93;&lt;/span&gt; Run `mvn clean install` to make sure basic checks pass. A more thorough check will&lt;br/&gt;
          be performed on your pull request automatically.&lt;/li&gt;
	&lt;li&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;X&amp;#93;&lt;/span&gt; You have run the integration tests successfully (`mvn -Prun-its clean install`).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;   To make clear that you license your contribution under&lt;br/&gt;
   the &lt;span class=&quot;error&quot;&gt;&amp;#91;Apache License Version 2.0, January 2004&amp;#93;&lt;/span&gt;(&lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;)&lt;br/&gt;
   you have to acknowledge this by using the following check-box.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;X&amp;#93;&lt;/span&gt; I hereby declare this contribution to be licenced under the &lt;span class=&quot;error&quot;&gt;&amp;#91;Apache License Version 2.0, January 2004&amp;#93;&lt;/span&gt;(&lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;)&lt;/li&gt;
&lt;/ul&gt;



</comment>
                            <comment id="17756512" author="githubbot" created="Sun, 20 Aug 2023 10:39:44 +0000"  >&lt;p&gt;olamy commented on PR #668:&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/maven-surefire/pull/668#issuecomment-1685250697&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/maven-surefire/pull/668#issuecomment-1685250697&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;   this looks to be a sensible enough change to have an IT test. Can you extract one from your test project?&lt;/p&gt;

</comment>
                            <comment id="17756583" author="githubbot" created="Sun, 20 Aug 2023 20:30:38 +0000"  >&lt;p&gt;hgschmie commented on PR #668:&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/maven-surefire/pull/668#issuecomment-1685391151&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/maven-surefire/pull/668#issuecomment-1685391151&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;   yes. let me add this to the pr&lt;/p&gt;

</comment>
                            <comment id="17758151" author="githubbot" created="Wed, 23 Aug 2023 16:41:12 +0000"  >&lt;p&gt;hgschmie merged PR #668:&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/maven-surefire/pull/668&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/maven-surefire/pull/668&lt;/a&gt;&lt;/p&gt;

</comment>
                            <comment id="17784351" author="githubbot" created="Thu, 9 Nov 2023 10:21:24 +0000"  >&lt;p&gt;olamy commented on PR #668:&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/maven-surefire/pull/668#issuecomment-1803555265&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/maven-surefire/pull/668#issuecomment-1803555265&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;   this has broken Jetty 12 build&lt;br/&gt;
   ```&lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;INFO&amp;#93;&lt;/span&gt; -------------------------------------------------------&lt;br/&gt;
   13:33:32 000]&lt;span class=&quot;error&quot;&gt;&amp;#91;info&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;gc&amp;#93;&lt;/span&gt; Using G1&lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;ERROR&amp;#93;&lt;/span&gt; Error occurred during initialization of boot layer&lt;br/&gt;
   &lt;span class=&quot;error&quot;&gt;&amp;#91;ERROR&amp;#93;&lt;/span&gt; java.lang.module.FindException: Module jakarta.interceptor not found, required by jakarta.transaction&lt;br/&gt;
   ```&lt;/p&gt;


</comment>
                            <comment id="17995594" author="olamy" created="Fri, 4 Jul 2025 07:44:03 +0000"  >&lt;p&gt;This project has moved from Jira to GitHub Issues. This issue was migrated to &lt;a href=&quot;https://github.com/apache/maven-surefire/issues/2837&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;apache/maven-surefire#2837&lt;/a&gt;. &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            18 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1jw08:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>