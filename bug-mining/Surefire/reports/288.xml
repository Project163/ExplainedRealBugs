<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 07:10:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SUREFIRE-869] Parallel test execution on class level runs not all tests but some twice</title>
                <link>https://issues.apache.org/jira/browse/SUREFIRE-869</link>
                <project id="12317927" key="SUREFIRE">Maven Surefire (Moved to GitHub Issues)</project>
                    <description>&lt;p&gt;When I run JUnit tests in parallel on the class level, Surefire behaves somehow erratically. For instance, having test classes TestA and TestB, Surefire sometimes runs TestA twice, TestB twice at other times - but never TestA and TestB in parallel.&lt;/p&gt;

&lt;p&gt;I attached a simple Maven project that helps reproduce this issue. Via &lt;tt&gt;mvn test -P sequential&lt;/tt&gt; you can execute two test classes sequentially:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;...
-------------------------------------------------------
 T E S T S
-------------------------------------------------------
Running mavendebug.TestAppFirstTest
-----------------&amp;gt; TestAppFirstTest.test()
Tests run: 1, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 0.036 sec
Running mavendebug.TestAppSecondTest
-----------------&amp;gt; TestAppSecondTest.test()
Tests run: 1, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 0 sec

Results :

Tests run: 2, Failures: 0, Errors: 0, Skipped: 0
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Running &lt;tt&gt;mvn test&lt;/tt&gt; instead runs tests in parallel:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;...
-------------------------------------------------------
 T E S T S
-------------------------------------------------------

-------------------------------------------------------
 T E S T S
-------------------------------------------------------
Concurrency config is parallel=&apos;classes&apos;, perCoreThreadCount=false, threadCount=4, useUnlimitedThreads=false
Concurrency config is parallel=&apos;classes&apos;, perCoreThreadCount=false, threadCount=4, useUnlimitedThreads=false
Running mavendebug.TestAppSecondTest
Running mavendebug.TestAppSecondTest
-----------------&amp;gt; TestAppSecondTest.test()
-----------------&amp;gt; TestAppSecondTest.test()
Tests run: 1, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 0.002 sec
Tests run: 1, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 0.002 sec

Results :

Tests run: 2, Failures: 0, Errors: 0, Skipped: 0
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;As you can see, TestAppSecondTest is executed twice, while test TestAppFirstTest is not executed at all.&lt;/p&gt;

&lt;p&gt;Please note: I chose Blocker as priority as this caused (1) that our extensive test suite was not executed completely during the last weeks which we only discovered today, and (2) that caused tests that run against a database to fail with unexpected constraint violations just because those tests where executed twice in parallel.&lt;/p&gt;</description>
                <environment>Apache Maven 3.0.4 (r1232337; 2012-01-17 09:44:56+0100)&lt;br/&gt;
Maven home: /opt/local/share/java/maven3&lt;br/&gt;
Java version: 1.7.0_04, vendor: Oracle Corporation&lt;br/&gt;
Java home: /Library/Java/JavaVirtualMachines/1.7.0.jdk/Contents/Home/jre&lt;br/&gt;
Default locale: en_US, platform encoding: UTF-8&lt;br/&gt;
OS name: &amp;quot;mac os x&amp;quot;, version: &amp;quot;10.7.4&amp;quot;, arch: &amp;quot;x86_64&amp;quot;, family: &amp;quot;mac&amp;quot;&lt;br/&gt;
JUnit 4.10</environment>
        <key id="12810340">SUREFIRE-869</key>
            <summary>Parallel test execution on class level runs not all tests but some twice</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="krosenvold">Kristian Rosenvold</assignee>
                                    <reporter username="mburger">Martin Burger</reporter>
                        <labels>
                    </labels>
                <created>Thu, 24 May 2012 05:09:06 +0000</created>
                <updated>Fri, 4 Jul 2025 07:18:46 +0000</updated>
                            <resolved>Tue, 19 Jun 2012 14:27:05 +0000</resolved>
                                    <version>2.12</version>
                                    <fixVersion>2.12.1</fixVersion>
                                    <component>Junit 4.7+ (parallel) support</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14455437" author="ggarciao" created="Mon, 18 Jun 2012 11:52:44 +0000"  >&lt;p&gt;I&apos;m getting exactly the same issue with this configuration:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&amp;lt;plugin&amp;gt;
    &amp;lt;groupId&amp;gt;org.apache.maven.plugins&amp;lt;/groupId&amp;gt;
    &amp;lt;artifactId&amp;gt;maven-surefire-plugin&amp;lt;/artifactId&amp;gt;
    &amp;lt;version&amp;gt;2.12&amp;lt;/version&amp;gt;
    &amp;lt;configuration&amp;gt;
      &amp;lt;forkMode&amp;gt;perthread&amp;lt;/forkMode&amp;gt;
      &amp;lt;threadCount&amp;gt;2&amp;lt;/threadCount&amp;gt;
    &amp;lt;/configuration&amp;gt;
&amp;lt;/plugin&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14455513" author="ggarciao" created="Tue, 19 Jun 2012 10:29:43 +0000"  >&lt;p&gt;&lt;b&gt;I found the problem:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;Surefire use the &lt;em&gt;ForkStater.runSuitesForkPerTestSet()&lt;/em&gt; method to create the forks. Its create a thread for each fork to be created because it waits for each fork to gather the results (a &lt;em&gt;RunResult&lt;/em&gt; object).&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Callable&amp;lt;RunResult&amp;gt; pf = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Callable&amp;lt;RunResult&amp;gt;()
{
   &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; RunResult call() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; fork( testSet, properties, forkClient, fileReporterFactory.getGlobalRunStatistics() );
   }
};
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;b&gt;The problem is the &lt;em&gt;properties&lt;/em&gt; passed to the fork.&lt;/b&gt; This is a shared reference between all the &lt;em&gt;Callable&lt;/em&gt; thread created! Inside the &lt;em&gt;fork()&lt;/em&gt; method this property is changed to fit the test suite configuration (see &lt;em&gt;BooterSerializer.serialize()&lt;/em&gt;) and due to the fact that it is shared, every thread will change it producing the erratic behavior on the execution of the test suites.&lt;/p&gt;

&lt;p&gt;I have a simple solution: cloning the property passed to the &lt;em&gt;fork()&lt;/em&gt; method like this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Callable&amp;lt;RunResult&amp;gt; pf = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Callable&amp;lt;RunResult&amp;gt;()
{
   &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; RunResult call() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; fork( testSet, (Properties) properties.clone(), forkClient, fileReporterFactory.getGlobalRunStatistics() );
   }
};
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I tested and is working fine.&lt;/p&gt;</comment>
                            <comment id="14455400" author="krosenvold" created="Tue, 19 Jun 2012 14:27:05 +0000"  >&lt;p&gt;Fixed in r1351807, thanks for tracking down the problem&lt;/p&gt;</comment>
                            <comment id="17994278" author="olamy" created="Fri, 4 Jul 2025 07:18:46 +0000"  >&lt;p&gt;This project has moved from Jira to GitHub Issues. This issue was migrated to &lt;a href=&quot;https://github.com/apache/maven-surefire/issues/1464&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;apache/maven-surefire#1464&lt;/a&gt;. &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12720209" name="parallel-tests.tgz" size="2499" author="mburger" created="Thu, 24 May 2012 05:09:06 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            18 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2bgvz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>