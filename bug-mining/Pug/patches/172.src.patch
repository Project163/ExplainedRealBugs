diff --git a/.gitattributes b/.gitattributes
new file mode 100644
index 0000000..749ae81
--- /dev/null
+++ b/.gitattributes
@@ -0,0 +1 @@
+*   text=auto eol=lf
diff --git a/packages/pug-linker/index.js b/packages/pug-linker/index.js
index 2d6d902..e7993e8 100644
--- a/packages/pug-linker/index.js
+++ b/packages/pug-linker/index.js
@@ -77,9 +77,8 @@ function flattenParentBlocks(parentBlocks, accumulator) {
   parentBlocks.forEach(function (parentBlock) {
     if (parentBlock.parents) {
       flattenParentBlocks(parentBlock.parents, accumulator);
-    } else {
-      accumulator.push(parentBlock);
     }
+    accumulator.push(parentBlock);
   });
   return accumulator;
 }
diff --git a/packages/pug-linker/test/__snapshots__/index.test.js.snap b/packages/pug-linker/test/__snapshots__/index.test.js.snap
index bfbf2f6..5e64d97 100644
--- a/packages/pug-linker/test/__snapshots__/index.test.js.snap
+++ b/packages/pug-linker/test/__snapshots__/index.test.js.snap
@@ -2242,6 +2242,74 @@ Object {
         "mode": "replace",
         "name": "content",
         "nodes": Array [
+          Object {
+            "attributeBlocks": Array [],
+            "attrs": Array [
+              Object {
+                "mustEscape": false,
+                "name": "class",
+                "val": "\'last\'",
+              },
+              Object {
+                "mustEscape": false,
+                "name": "class",
+                "val": "\'prepend\'",
+              },
+            ],
+            "block": Object {
+              "filename": "layout.multi.append.prepend.block.pug",
+              "line": 13,
+              "nodes": Array [
+                Object {
+                  "filename": "layout.multi.append.prepend.block.pug",
+                  "line": 13,
+                  "type": "Text",
+                  "val": "Last prepend must appear at top",
+                },
+              ],
+              "type": "Block",
+            },
+            "filename": "layout.multi.append.prepend.block.pug",
+            "isInline": false,
+            "line": 13,
+            "name": "p",
+            "selfClosing": false,
+            "type": "Tag",
+          },
+          Object {
+            "attributeBlocks": Array [],
+            "attrs": Array [
+              Object {
+                "mustEscape": false,
+                "name": "class",
+                "val": "\'first\'",
+              },
+              Object {
+                "mustEscape": false,
+                "name": "class",
+                "val": "\'prepend\'",
+              },
+            ],
+            "block": Object {
+              "filename": "layout.multi.append.prepend.block.pug",
+              "line": 7,
+              "nodes": Array [
+                Object {
+                  "filename": "layout.multi.append.prepend.block.pug",
+                  "line": 7,
+                  "type": "Text",
+                  "val": "Something prepended to content",
+                },
+              ],
+              "type": "Block",
+            },
+            "filename": "layout.multi.append.prepend.block.pug",
+            "isInline": false,
+            "line": 7,
+            "name": "p",
+            "selfClosing": false,
+            "type": "Tag",
+          },
           Object {
             "attributeBlocks": Array [],
             "attrs": Array [
@@ -2271,6 +2339,74 @@ Object {
             "selfClosing": false,
             "type": "Tag",
           },
+          Object {
+            "attributeBlocks": Array [],
+            "attrs": Array [
+              Object {
+                "mustEscape": false,
+                "name": "class",
+                "val": "\'first\'",
+              },
+              Object {
+                "mustEscape": false,
+                "name": "class",
+                "val": "\'append\'",
+              },
+            ],
+            "block": Object {
+              "filename": "layout.multi.append.prepend.block.pug",
+              "line": 4,
+              "nodes": Array [
+                Object {
+                  "filename": "layout.multi.append.prepend.block.pug",
+                  "line": 4,
+                  "type": "Text",
+                  "val": "Something appended to content",
+                },
+              ],
+              "type": "Block",
+            },
+            "filename": "layout.multi.append.prepend.block.pug",
+            "isInline": false,
+            "line": 4,
+            "name": "p",
+            "selfClosing": false,
+            "type": "Tag",
+          },
+          Object {
+            "attributeBlocks": Array [],
+            "attrs": Array [
+              Object {
+                "mustEscape": false,
+                "name": "class",
+                "val": "\'last\'",
+              },
+              Object {
+                "mustEscape": false,
+                "name": "class",
+                "val": "\'append\'",
+              },
+            ],
+            "block": Object {
+              "filename": "layout.multi.append.prepend.block.pug",
+              "line": 10,
+              "nodes": Array [
+                Object {
+                  "filename": "layout.multi.append.prepend.block.pug",
+                  "line": 10,
+                  "type": "Text",
+                  "val": "Last append must be most last",
+                },
+              ],
+              "type": "Block",
+            },
+            "filename": "layout.multi.append.prepend.block.pug",
+            "isInline": false,
+            "line": 10,
+            "name": "p",
+            "selfClosing": false,
+            "type": "Tag",
+          },
         ],
         "parents": Array [
           Object {
diff --git a/packages/pug/test/shadowed-block/__snapshots__/index.test.js.snap b/packages/pug/test/shadowed-block/__snapshots__/index.test.js.snap
new file mode 100644
index 0000000..c1446e4
--- /dev/null
+++ b/packages/pug/test/shadowed-block/__snapshots__/index.test.js.snap
@@ -0,0 +1,3 @@
+exports[`test layout with shadowed block 1`] = `"<!-- layout.pug: root--><!-- index.pug: shadowed-->"`;
+
+exports[`test layout with shadowed block 2`] = `"<!-- layout.pug: root--><!-- index.pug: shadowed-->"`;
diff --git a/packages/pug/test/shadowed-block/base.pug b/packages/pug/test/shadowed-block/base.pug
new file mode 100644
index 0000000..7148cac
--- /dev/null
+++ b/packages/pug/test/shadowed-block/base.pug
@@ -0,0 +1,4 @@
+block root
+  // base.pug: root
+  block shadowed
+    // base.pug: shadowed
diff --git a/packages/pug/test/shadowed-block/index.pug b/packages/pug/test/shadowed-block/index.pug
new file mode 100644
index 0000000..dabca48
--- /dev/null
+++ b/packages/pug/test/shadowed-block/index.pug
@@ -0,0 +1,4 @@
+extends ./layout.pug
+
+block shadowed
+  // index.pug: shadowed
diff --git a/packages/pug/test/shadowed-block/index.test.js b/packages/pug/test/shadowed-block/index.test.js
new file mode 100644
index 0000000..82f82f4
--- /dev/null
+++ b/packages/pug/test/shadowed-block/index.test.js
@@ -0,0 +1,14 @@
+const pug = require('../../');
+
+test('layout with shadowed block', () => {
+  const outputWithAjax = pug.renderFile(
+    __dirname + '/index.pug',
+    {ajax: true}
+  );
+  const outputWithoutAjax = pug.renderFile(
+    __dirname + '/index.pug',
+    {ajax: false}
+  );
+  expect(outputWithAjax).toMatchSnapshot();
+  expect(outputWithoutAjax).toMatchSnapshot();
+});
diff --git a/packages/pug/test/shadowed-block/layout.pug b/packages/pug/test/shadowed-block/layout.pug
new file mode 100644
index 0000000..fa27d25
--- /dev/null
+++ b/packages/pug/test/shadowed-block/layout.pug
@@ -0,0 +1,6 @@
+extends ./base.pug
+
+block root
+  // layout.pug: root
+  block shadowed
+    // layout.pug: shadowed
