diff --git a/lib/parser.js b/lib/parser.js
index d0037b9..04a31f0 100644
--- a/lib/parser.js
+++ b/lib/parser.js
@@ -143,36 +143,40 @@ Parser.prototype = {
       for (var name in this.mixins)
         ast.unshift(this.mixins[name]);
       return ast;
-    } else  {
-      // console.dir(this.blocks);
-      this.blocks.reverse();
-      var blocksHash = {};
-      for (var i in this.blocks) {
-        if (!( ({}).hasOwnProperty.call(blocksHash, [this.blocks[i].name]) )) {
-          // console.log('new ' + this.blocks[i].mode + ' ' + this.blocks[i].name + ' ' + this.blocks[i].line);
-          blocksHash[this.blocks[i].name] = this.blocks[i];
-        } else {
-          // console.log(this.blocks[i].mode + ' ' + this.blocks[i].name + ' ' + this.blocks[i].line);
-          switch (this.blocks[i].mode) {
-            case 'replace':
-              blocksHash[this.blocks[i].name].nodes = this.blocks[i].nodes;
-              break;
-            case 'append':
-              blocksHash[this.blocks[i].name].nodes = blocksHash[this.blocks[i].name].nodes.concat(this.blocks[i].nodes);
-              break;
-            case 'prepend':
-              blocksHash[this.blocks[i].name].nodes = this.blocks[i].nodes.concat(blocksHash[this.blocks[i].name].nodes);
-              break;
-          }
-          this.blocks[i] = blocksHash[this.blocks[i].name];
-        }
-      }
-      // console.dir(blocksHash.content.nodes);
+    } else {
+      this.handleBlocks();
     }
 
     return block;
   },
 
+  /**
+   * Handle blocks, appends and prepends. Must be called from must deep parser (which parses template that does not extends another template).
+   * @api private
+   */
+
+  handleBlocks: function() {
+    this.blocks.reverse();
+    var blocksHash = {}; // blockName: block object
+    for (var i in this.blocks) {
+      if (!( ({}).hasOwnProperty.call(blocksHash, [this.blocks[i].name]) )) { // just safe call to blocksHash.hasOwnProperty
+        blocksHash[this.blocks[i].name] = this.blocks[i];
+      } else {
+        switch (this.blocks[i].mode) {
+          case 'append':
+            blocksHash[this.blocks[i].name].nodes = blocksHash[this.blocks[i].name].nodes.concat(this.blocks[i].nodes);
+            break;
+          case 'prepend':
+            blocksHash[this.blocks[i].name].nodes = this.blocks[i].nodes.concat(blocksHash[this.blocks[i].name].nodes);
+            break;
+          default:
+            blocksHash[this.blocks[i].name].nodes = this.blocks[i].nodes;
+        }
+        this.blocks[i] = blocksHash[this.blocks[i].name];
+      }
+    }
+  },
+
   /**
    * Expect the given type, or throw an exception.
    *
@@ -446,21 +450,6 @@ Parser.prototype = {
       ? this.block()
       : new nodes.Block(new nodes.Literal(''));
 
-    // var prev = this.blocks[name];
-
-    // if (prev) {
-    //   switch (prev.mode) {
-    //     case 'append':
-    //       block.nodes = block.nodes.concat(prev.nodes);
-    //       prev = block;
-    //       break;
-    //     case 'prepend':
-    //       block.nodes = prev.nodes.concat(block.nodes);
-    //       prev = block;
-    //       break;
-    //   }
-    // }
-
     block.mode = mode;
     block.name = name;
     this.blocks.push(block);
@@ -502,7 +491,6 @@ Parser.prototype = {
     var path = join(dir, path);
     var str = fs.readFileSync(path, 'utf8');
     var parser = new Parser(str, path, this.options);
-    // parser.blocks = utils.merge({}, this.blocks);
     parser.blocks = utils.merge([], this.blocks);
 
     parser.mixins = this.mixins;
diff --git a/test/cases/layout.multi.append.prepend.block.html b/test/cases/layout.multi.append.prepend.block.html
index f96e65e..107fbea 100644
--- a/test/cases/layout.multi.append.prepend.block.html
+++ b/test/cases/layout.multi.append.prepend.block.html
@@ -1,5 +1,8 @@
-<p>prepended content 2</p>
-<p>prepended content 1</p>
-<p>redefined content</p>
-<p>appended content 1</p>
-<p>appended content 2</p>
\ No newline at end of file
+<p class="first prepend">Last prepend must appear at top</p>
+<p class="first prepend">Something prepended to content</p>
+<div class="content">Defined content</div>
+<p class="first append">Something appended to content</p>
+<p class="last append">Last append must be most last</p>
+<script src="foo.js"></script>
+<script src="/app.js"></script>
+<script src="jquery.js"></script>
\ No newline at end of file
diff --git a/test/cases/layout.multi.append.prepend.block.jade b/test/cases/layout.multi.append.prepend.block.jade
index ab920f8..05f3960 100644
--- a/test/cases/layout.multi.append.prepend.block.jade
+++ b/test/cases/layout.multi.append.prepend.block.jade
@@ -1,13 +1,19 @@
 extends ../fixtures/multi-append-prepend-block/redefine
 
 append content
-	p appended content 1
+	p.first.append Something appended to content
 
 prepend content
-	p prepended content 1
+	p.first.prepend Something prepended to content
 
 append content
-	p appended content 2
+	p.last.append Last append must be most last
 
 prepend content
-	p prepended content 2
\ No newline at end of file
+	p.first.prepend Last prepend must appear at top
+
+append head
+	script(src='jquery.js')
+
+prepend head
+	script(src='foo.js')
diff --git a/test/fixtures/multi-append-prepend-block/redefine.jade b/test/fixtures/multi-append-prepend-block/redefine.jade
index 308ff47..b0e3449 100644
--- a/test/fixtures/multi-append-prepend-block/redefine.jade
+++ b/test/fixtures/multi-append-prepend-block/redefine.jade
@@ -1,5 +1,5 @@
 extends root
 
-
 block content
-	p redefined content
\ No newline at end of file
+	.content
+		| Defined content
\ No newline at end of file
diff --git a/test/fixtures/multi-append-prepend-block/root.jade b/test/fixtures/multi-append-prepend-block/root.jade
index 0a8837f..8e3334a 100644
--- a/test/fixtures/multi-append-prepend-block/root.jade
+++ b/test/fixtures/multi-append-prepend-block/root.jade
@@ -1,2 +1,5 @@
 block content
-	p default content
\ No newline at end of file
+	| default content
+
+block head
+	script(src='/app.js')
\ No newline at end of file
