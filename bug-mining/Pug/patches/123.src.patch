diff --git a/lib/compiler.js b/lib/compiler.js
index 867f1f0..b040289 100644
--- a/lib/compiler.js
+++ b/lib/compiler.js
@@ -7,8 +7,14 @@ var selfClosing = require('./self-closing');
 var runtime = require('./runtime');
 var utils = require('./utils');
 var parseJSExpression = require('character-parser').parseMax;
-var isConstant = require('constantinople');
-var toConstant = require('constantinople').toConstant;
+var constantinople = require('constantinople');
+
+function isConstant(src) {
+  return constantinople(src, {jade: runtime, 'jade_interp': undefined});
+}
+function toConstant(src) {
+  return constantinople.toConstant(src, {jade: runtime, 'jade_interp': undefined});
+}
 
 
 /**
@@ -76,7 +82,6 @@ Compiler.prototype = {
    */
 
   setDoctype: function(name){
-    name = name || 'default';
     this.doctype = doctypes[name.toLowerCase()] || '<!DOCTYPE ' + name + '>';
     this.terse = this.doctype.toLowerCase() == '<!doctype html>';
     this.xml = 0 == this.doctype.indexOf('<?xml');
@@ -101,17 +106,9 @@ Compiler.prototype = {
           this.buffer(match[3], true);
           return;
         } else {
-          try {
-            var rest = match[3];
-            var range = parseJSExpression(rest);
-            var code = ('!' == match[2] ? '' : 'jade.escape') + "((jade_interp = " + range.src + ") == null ? '' : jade_interp)";
-          } catch (ex) {
-            throw ex;
-            //didn't match, just as if escaped
-            this.buffer(match[2] + '{', false);
-            this.buffer(match[3], true);
-            return;
-          }
+          var rest = match[3];
+          var range = parseJSExpression(rest);
+          var code = ('!' == match[2] ? '' : 'jade.escape') + "((jade_interp = " + range.src + ") == null ? '' : jade_interp)";
           this.bufferExpression(code);
           this.buffer(rest.substr(range.end + 1), true);
           return;
@@ -144,9 +141,8 @@ Compiler.prototype = {
    */
 
   bufferExpression: function (src) {
-    var fn = Function('', 'return (' + src + ');');
     if (isConstant(src)) {
-      return this.buffer(fn(), false)
+      return this.buffer(toConstant(src) + '', false)
     }
     if (this.lastBufferedIdx == this.buf.length) {
       if (this.lastBufferedType === 'text') this.lastBuffered += '"';
@@ -488,7 +484,6 @@ Compiler.prototype = {
     var text = filter.block.nodes.map(
       function(node){ return node.val; }
     ).join('\n');
-    filter.attrs = filter.attrs || {};
     filter.attrs.filename = this.options.filename;
     this.buffer(filters(filter.name, text, filter.attrs), true);
   },
@@ -668,7 +663,7 @@ Compiler.prototype = {
           if (escaped && !(key.indexOf('data') === 0)) {
             val = 'jade.escape(' + val + ')';
           } else if (escaped) {
-            val = '(typeof (jade_interp = ' + val + ') == "string" ? jade.escape(jade_interp) : jade_interp)"';
+            val = '(typeof (jade_interp = ' + val + ') == "string" ? jade.escape(jade_interp) : jade_interp)';
           }
           buf.push(JSON.stringify(key) + ': ' + val);
         }
@@ -680,12 +675,12 @@ Compiler.prototype = {
       } else {
         this.bufferExpression('jade.cls([' + classes.join(',') + '], ' + JSON.stringify(classEscaping) + ')');
       }
-    } else {
+    } else if (classes.length) {
       if (classes.every(isConstant)) {
         classes = JSON.stringify(runtime.joinClasses(classes.map(toConstant).map(runtime.joinClasses).map(function (cls, i) {
           return classEscaping[i] ? runtime.escape(cls) : cls;
         })));
-      } else if (classes.length) {
+      } else {
         classes = '(jade_interp = ' + JSON.stringify(classEscaping) + ',' +
           ' jade.joinClasses([' + classes.join(',') + '].map(jade.joinClasses).map(function (cls, i) {' +
           '   return jade_interp[i] ? jade.escape(cls) : cls' +
diff --git a/package.json b/package.json
index fc397f2..1345cf5 100644
--- a/package.json
+++ b/package.json
@@ -17,7 +17,7 @@
     "character-parser": "1.2.0",
     "monocle": "1.1.51",
     "with": "~2.0.0",
-    "constantinople": "~1.0.2"
+    "constantinople": "~2.0.0"
   },
   "devDependencies": {
     "coffee-script": "*",
diff --git a/test/cases/filters.coffeescript.html b/test/cases/filters.coffeescript.html
index 45fb20a..e14001a 100644
--- a/test/cases/filters.coffeescript.html
+++ b/test/cases/filters.coffeescript.html
@@ -5,4 +5,5 @@
   regexp = /\n/;
 
 }).call(this);
+(function(){var n;n={square:function(n){return n*n}}}).call(this);
 </script>
\ No newline at end of file
diff --git a/test/cases/filters.coffeescript.jade b/test/cases/filters.coffeescript.jade
index 8a119c9..3941b44 100644
--- a/test/cases/filters.coffeescript.jade
+++ b/test/cases/filters.coffeescript.jade
@@ -1,3 +1,6 @@
 script(type='text/javascript')
   :coffeescript
     regexp = /\n/
+  :coffeescript(minify=true)
+    math =
+      square: (value) -> value * value
\ No newline at end of file
diff --git a/test/cases/mixin.attrs.html b/test/cases/mixin.attrs.html
index ec90d03..db76cf4 100644
--- a/test/cases/mixin.attrs.html
+++ b/test/cases/mixin.attrs.html
@@ -23,4 +23,4 @@
   <div class="bottom class1 class2">
   </div>
 </body>
-<div attr1="foo" attr2="bar" class="thing thunk" attr3="baz"></div>
\ No newline at end of file
+<div attr1="foo" attr2="bar" class="thing foo bar thunk" attr3="baz" data-foo="&lt;biz&gt;" data-bar="<biz>"></div>
\ No newline at end of file
diff --git a/test/cases/mixin.attrs.jade b/test/cases/mixin.attrs.jade
index 9f4b4fc..d346b86 100644
--- a/test/cases/mixin.attrs.jade
+++ b/test/cases/mixin.attrs.jade
@@ -31,4 +31,6 @@ body
 mixin foo
   div.thing(attr1='foo', attr2='bar')&attributes(attributes)
 
-+foo(attr3='baz').thunk
+- var val = '<biz>'
+- var classes = ['foo', 'bar']
++foo(attr3='baz' data-foo=val data-bar!=val class=classes).thunk
diff --git a/test/error.reporting.js b/test/error.reporting.js
index 297cc19..e61f1a0 100644
--- a/test/error.reporting.js
+++ b/test/error.reporting.js
@@ -145,4 +145,18 @@ describe('error reporting', function () {
       assert(/`doctype 5` is deprecated, you must now use `doctype html`/.test(err.message))
     });
   });
+  describe('if you throw something that isn\'t an error', function () {
+    it('just rethrows without modification', function () {
+      var err = getError('- throw "foo"');
+      assert(err === 'foo');
+    });
+  });
+  describe('import without a filename for a basedir', function () {
+    it('throws an error', function () {
+      var err = getError('include foo.jade');
+      assert(/the "filename" option is required to use/.test(err.message));
+      var err = getError('include /foo.jade');
+      assert(/the "basedir" option is required to use/.test(err.message));
+    })
+  });
 });
