{"url":"https://api.github.com/repos/airbnb/lottie-android/issues/1648","repository_url":"https://api.github.com/repos/airbnb/lottie-android","labels_url":"https://api.github.com/repos/airbnb/lottie-android/issues/1648/labels{/name}","comments_url":"https://api.github.com/repos/airbnb/lottie-android/issues/1648/comments","events_url":"https://api.github.com/repos/airbnb/lottie-android/issues/1648/events","html_url":"https://github.com/airbnb/lottie-android/issues/1648","id":720045841,"node_id":"MDU6SXNzdWU3MjAwNDU4NDE=","number":1648,"title":"Files loaded via setAnimationFromUrl are not cached in memory.","user":{"login":"clownba0t","id":4664640,"node_id":"MDQ6VXNlcjQ2NjQ2NDA=","avatar_url":"https://avatars.githubusercontent.com/u/4664640?v=4","gravatar_id":"","url":"https://api.github.com/users/clownba0t","html_url":"https://github.com/clownba0t","followers_url":"https://api.github.com/users/clownba0t/followers","following_url":"https://api.github.com/users/clownba0t/following{/other_user}","gists_url":"https://api.github.com/users/clownba0t/gists{/gist_id}","starred_url":"https://api.github.com/users/clownba0t/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clownba0t/subscriptions","organizations_url":"https://api.github.com/users/clownba0t/orgs","repos_url":"https://api.github.com/users/clownba0t/repos","events_url":"https://api.github.com/users/clownba0t/events{/privacy}","received_events_url":"https://api.github.com/users/clownba0t/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1460035932,"node_id":"MDU6TGFiZWwxNDYwMDM1OTMy","url":"https://api.github.com/repos/airbnb/lottie-android/labels/Non-Rendering%20Bug","name":"Non-Rendering Bug","color":"186199","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2020-10-13T09:24:18Z","updated_at":"2020-10-24T22:12:38Z","closed_at":"2020-10-24T22:12:38Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Link to fork with a repro in the issue-repro module**\r\n\r\nURL: https://github.com/clownba0t/lottie-android/tree/issue-url-animation-file-no-memory-cache\r\n\r\n**NOTES:**\r\n\r\n* The repro is in the `issue-url-animation-file-no-memory-cache` branch - _not_ `master`. This is because I couldn't actually build `master`, `v3.4.4`, or `v3.4.3` on Android Studio 4.0 or 4.1, seemingly due to the use of an RC version of the Android gradle plugin. Rather than allowing AS to update the plugin and potentially introducing unrelated changes as a result, I decided to use `v3.4.2` as a base instead.\r\n* The repro is extremely minimal, and verification of the issue requires use of the debugger in Android Studio rather than visual/log inspection (see steps to reproduce below for more details).\r\n\r\n**Describe the bug**\r\n\r\nA very similar issue, #978, was opened a few years ago. It was subsequently closed in #986, which claims to add memory caching for files downloaded asynchronously via URL. However, it appears that these animation files are not actually being stored in the memory cache. In particular (for my use case), this affects `LottieAnimationView.setAnimationFromUrl`.\r\n\r\nI investigated this with the debugger. Using the sample app linked above, I discovered the following:\r\n\r\n`setAnimationFromUrl` calls `LottieCompositionFactory.fromUrl` with no 3rd parameter (cache key), so a cache key is automatically generated by prepending `url_` to the beginning of the URL. The cache key used in the app is therefore:\r\n `url_https://raw.githubusercontent.com/airbnb/lottie-ios/master/Example/lottie-swift/TestAnimations/PinJump.json`.\r\n\r\nWhen the app has been clean installed and is opened, all of the caches (memory, task, and disk) return misses, so the file is fetched from the URL. This is expected.\r\n\r\nAfter closing the app and opening it again, the memory cache and task cache return misses, but the disk cache returns a hit, so the file is _not_ fetched from the URL. This is expected.\r\n\r\nKeeping the app open and tapping the reload button (which simply calls `setAnimationFromUrl` with the same URL), the memory cache returns a miss. This is _not_ expected.\r\n\r\nI had a deeper look, and it appears that the issue is related to how the generated cache key mentioned above is used. It's first used to check the memory and task caches, which is fine. If both checks result in misses, the generated cache key is then passed to `NetworkFetcher`. However, it's not ultimately used as a cache key in that class - rather, the presence or absence (`null`) of it is simply used to determine whether disk and memory caching will be enabled or not. When actually interacting with the caches, `NetworkFetcher` uses the URL as the cache key.\r\n\r\nThis is fine for the disk cache because both gets and puts are managed by `NetworkFetcher`. For the memory cache, though, it's not, because the get (back in `LottieCompositionFactory`, before creating the `NetworkFetcher`) uses the generated cache key but the put (in `NetworkFetcher`) uses the URL.\r\n\r\nI think a solution would need to revolve around ensuring that the cache keys used to get and put animation files loaded via URL from and to the memory cache are the same. I tried modifying `NetworkFetcher` to keep the provided cache key as a member variable and use it in place of the URL when interacting with the caches, and it seemed to work well - using the debugging approach detailed above again, I was able to confirm that the animation came out of memory cache rather than disk cache when hitting the reload button. I pushed my modifications in a separate branch - see diff [here](https://github.com/clownba0t/lottie-android/compare/issue-url-animation-file-no-memory-cache...clownba0t:resolution-url-animation-file-no-memory-cache?expand=1).\r\n\r\nIt's entirely possible that I've missed something obvious, in which case I'm terribly sorry. If not, I hope this report helps!\r\n\r\n**Steps To Reproduce**\r\n\r\nNOTE: This requires use of the debugger in Android Studio.\r\n\r\nCheck out the `issue-url-animation-file-no-memory-cache` branch in the linked repo above. Then, place breakpoints at:\r\n\r\n* `LottieCompositionFactory` line 479\r\n* `NetworkFetcher` line 46\r\n\r\nBuild and install the app on a device (physical or emulator) for debugging. Be sure to use `Run -> Debug 'issue-repro'` rather than simply starting the app and then attaching the debugger.\r\n\r\nWhen the app starts, use the debugger to confirm the cache hits and misses for the initial load of the animation. Use the \"Reload\" button at the bottom of the screen to trigger loading the file again, and continue to use the debugger to verify the cache hits and misses and see what's changed.","closed_by":{"login":"gpeal","id":1307745,"node_id":"MDQ6VXNlcjEzMDc3NDU=","avatar_url":"https://avatars.githubusercontent.com/u/1307745?v=4","gravatar_id":"","url":"https://api.github.com/users/gpeal","html_url":"https://github.com/gpeal","followers_url":"https://api.github.com/users/gpeal/followers","following_url":"https://api.github.com/users/gpeal/following{/other_user}","gists_url":"https://api.github.com/users/gpeal/gists{/gist_id}","starred_url":"https://api.github.com/users/gpeal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gpeal/subscriptions","organizations_url":"https://api.github.com/users/gpeal/orgs","repos_url":"https://api.github.com/users/gpeal/repos","events_url":"https://api.github.com/users/gpeal/events{/privacy}","received_events_url":"https://api.github.com/users/gpeal/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/airbnb/lottie-android/issues/1648/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/airbnb/lottie-android/issues/1648/timeline","performed_via_github_app":null,"state_reason":"completed"}