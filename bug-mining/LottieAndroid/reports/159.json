{"url":"https://api.github.com/repos/airbnb/lottie-android/issues/1214","repository_url":"https://api.github.com/repos/airbnb/lottie-android","labels_url":"https://api.github.com/repos/airbnb/lottie-android/issues/1214/labels{/name}","comments_url":"https://api.github.com/repos/airbnb/lottie-android/issues/1214/comments","events_url":"https://api.github.com/repos/airbnb/lottie-android/issues/1214/events","html_url":"https://github.com/airbnb/lottie-android/issues/1214","id":444613847,"node_id":"MDU6SXNzdWU0NDQ2MTM4NDc=","number":1214,"title":"Lottie 3.0.1 is incompatible with Robolectric test","user":{"login":"boduan-coder","id":45017529,"node_id":"MDQ6VXNlcjQ1MDE3NTI5","avatar_url":"https://avatars.githubusercontent.com/u/45017529?v=4","gravatar_id":"","url":"https://api.github.com/users/boduan-coder","html_url":"https://github.com/boduan-coder","followers_url":"https://api.github.com/users/boduan-coder/followers","following_url":"https://api.github.com/users/boduan-coder/following{/other_user}","gists_url":"https://api.github.com/users/boduan-coder/gists{/gist_id}","starred_url":"https://api.github.com/users/boduan-coder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/boduan-coder/subscriptions","organizations_url":"https://api.github.com/users/boduan-coder/orgs","repos_url":"https://api.github.com/users/boduan-coder/repos","events_url":"https://api.github.com/users/boduan-coder/events{/privacy}","received_events_url":"https://api.github.com/users/boduan-coder/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2019-05-15T19:47:35Z","updated_at":"2019-05-15T21:24:03Z","closed_at":"2019-05-15T21:24:03Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"With Lottie 2.2.x, the unit test back by Robolectric works well with Lottie animation. But in 3.0.1, it starts to fail some test cases due to timeout(). Below is the root cause analysis:\r\n\r\nThe animation does be played for both version 2.2.x and 3.0.1 at unit test since the system animation scale is 1.0 instead of 0. And the way the LottieAnimation works in unit test is to cooperate with [ShadowLegacyChoreographer](https://github.com/robolectric/robolectric/blob/f9b5f5d4dc3b2b6acb8ec8614994569d0537bba9/shadows/framework/src/main/java/org/robolectric/shadows/ShadowLegacyChoreographer.java) to [accelerate](https://github.com/robolectric/robolectric/blob/f9b5f5d4dc3b2b6acb8ec8614994569d0537bba9/shadows/framework/src/main/java/org/robolectric/shadows/ShadowLegacyChoreographer.java#L153) the animation process without changing the test or app logic. And test case can control the pending/scheduled thread using APIs like: Robolectric.getForegroundThreadScheduler().advanceBy(delay, TimeUnit.MILLISECONDS).\r\n\r\nThe reasons 3.0.1 doesn't work is because:\r\nIn [LottieValueAnimator.java#doFrame()](https://github.com/airbnb/lottie-android/blob/3a4eacdac8ea921ed9b32d0e5dab18cf4b6d9d2a/lottie/src/main/java/com/airbnb/lottie/utils/LottieValueAnimator.java#L85), it doesn't honor the **frameTimeNanos** injected by [ShadowLegacyChoreographer](https://github.com/robolectric/robolectric/blob/f9b5f5d4dc3b2b6acb8ec8614994569d0537bba9/shadows/framework/src/main/java/org/robolectric/shadows/ShadowLegacyChoreographer.java) (in Lottie 2.2.x, it did honor it because it inherits the frameCallback from [ValueAnimator.java](https://android.googlesource.com/platform/frameworks/base/+/master/core/java/android/animation/ValueAnimator.java#1422)) so that the animation cannot be accelerated and lead to test case's timeout (some test cases wait the main thread never become idle to proceed). This can be fixed by using **frameTimeNanos** from **Choreographer** instead of using System.nanos() unless it was to fix some other issues. I tested the change locally and it doesn't seem to break anything.\r\n","closed_by":{"login":"gpeal","id":1307745,"node_id":"MDQ6VXNlcjEzMDc3NDU=","avatar_url":"https://avatars.githubusercontent.com/u/1307745?v=4","gravatar_id":"","url":"https://api.github.com/users/gpeal","html_url":"https://github.com/gpeal","followers_url":"https://api.github.com/users/gpeal/followers","following_url":"https://api.github.com/users/gpeal/following{/other_user}","gists_url":"https://api.github.com/users/gpeal/gists{/gist_id}","starred_url":"https://api.github.com/users/gpeal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gpeal/subscriptions","organizations_url":"https://api.github.com/users/gpeal/orgs","repos_url":"https://api.github.com/users/gpeal/repos","events_url":"https://api.github.com/users/gpeal/events{/privacy}","received_events_url":"https://api.github.com/users/gpeal/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/airbnb/lottie-android/issues/1214/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/airbnb/lottie-android/issues/1214/timeline","performed_via_github_app":null,"state_reason":"completed"}