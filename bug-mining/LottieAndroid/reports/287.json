{"url":"https://api.github.com/repos/airbnb/lottie-android/issues/2273","repository_url":"https://api.github.com/repos/airbnb/lottie-android","labels_url":"https://api.github.com/repos/airbnb/lottie-android/issues/2273/labels{/name}","comments_url":"https://api.github.com/repos/airbnb/lottie-android/issues/2273/comments","events_url":"https://api.github.com/repos/airbnb/lottie-android/issues/2273/events","html_url":"https://github.com/airbnb/lottie-android/issues/2273","id":1652350504,"node_id":"I_kwDOBC8mW85ifN4o","number":2273,"title":"Dynamic Properties don't survive composition change","user":{"login":"rharter","id":1296750,"node_id":"MDQ6VXNlcjEyOTY3NTA=","avatar_url":"https://avatars.githubusercontent.com/u/1296750?v=4","gravatar_id":"","url":"https://api.github.com/users/rharter","html_url":"https://github.com/rharter","followers_url":"https://api.github.com/users/rharter/followers","following_url":"https://api.github.com/users/rharter/following{/other_user}","gists_url":"https://api.github.com/users/rharter/gists{/gist_id}","starred_url":"https://api.github.com/users/rharter/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rharter/subscriptions","organizations_url":"https://api.github.com/users/rharter/orgs","repos_url":"https://api.github.com/users/rharter/repos","events_url":"https://api.github.com/users/rharter/events{/privacy}","received_events_url":"https://api.github.com/users/rharter/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1460035932,"node_id":"MDU6TGFiZWwxNDYwMDM1OTMy","url":"https://api.github.com/repos/airbnb/lottie-android/labels/Non-Rendering%20Bug","name":"Non-Rendering Bug","color":"186199","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2023-04-03T16:00:44Z","updated_at":"2023-05-09T00:43:01Z","closed_at":"2023-05-09T00:43:01Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Steps To Reproduce**\r\nSteps to reproduce the behavior:\r\n\r\n1. Create a composition from a lottie file with named layers.\r\n2. Use `rememberLottieDynamicProperties` to configure dynamic colors for named layers.\r\n3. Add some action that recomposes and **changes the remembered composition**.\r\n\r\n**Expected Result**\r\nDynamic properties are applied after the composition is updated.\r\n\r\n**Actual Result**\r\nDynamic properties are no longer applied to the new composition.\r\n\r\n**Analysis**\r\nWhen a `LottieAnimation` is rendered, [dynamicProperties are applied](https://github.com/airbnb/lottie-android/blob/master/lottie-compose/src/main/java/com/airbnb/lottie/compose/LottieAnimation.kt#L112) to the underlying `LottieDrawable` only once, via [addValueCallbacks()](https://github.com/airbnb/lottie-android/blob/cb72e02d0b11ac31b0b5ba852476cb7c7c6db770/lottie/src/main/java/com/airbnb/lottie/LottieDrawable.java#L1145), which adds the callbacks to the `compositionLayer`. However, when the composition of a `LottieDrawable` is updated, the [existing compositionLayer is destroyed and a new one is created](https://github.com/airbnb/lottie-android/blob/cb72e02d0b11ac31b0b5ba852476cb7c7c6db770/lottie/src/main/java/com/airbnb/lottie/LottieDrawable.java#L306). This means that any callbacks previously applied by dynamic properties are lost.\r\n\r\nI **think** an approach to fix this might be to simply add the composition as a key to the [setDynamicProperties remember](https://github.com/airbnb/lottie-android/blob/master/lottie-compose/src/main/java/com/airbnb/lottie/compose/LottieAnimation.kt#L89) statement.\r\n\r\n**Repro**\r\n\r\nThe following sample reproduces the issue using an interactive preview. Clicking on the buttons switches the displayed animation, and you can see that the dynamically colored layers are no longer dynamically colored after the composition is changed.\r\n\r\n```kotlin\r\n@Composable\r\nfun Illustration(\r\n    @RawRes resId: Int,\r\n    modifier: Modifier = Modifier,\r\n) {\r\n    val composition by rememberLottieComposition(LottieCompositionSpec.RawRes(resId))\r\n    val dynamicProperties = rememberDefaultDynamicProperties()\r\n\r\n    LottieAnimation(\r\n        composition = composition,\r\n        dynamicProperties = dynamicProperties,\r\n        modifier = modifier,\r\n        isPlaying = true,\r\n        iterations = LottieConstants.IterateForever,\r\n        alignment = Alignment.Center,\r\n        contentScale = ContentScale.Fit,\r\n    )\r\n}\r\n\r\nprivate fun rememberDefaultDynamicProperties(resId: Int): LottieDynamicProperties {\r\n    return rememberLottieDynamicProperties(\r\n        rememberLottieDynamicProperty(\r\n            property = LottieProperty.COLOR,\r\n            value = MaterialTheme.colors.surface.toArgb(),\r\n            keyPath = arrayOf(\"**\", \"dynamic-line/background\", \"**\"),\r\n        ),\r\n        rememberLottieDynamicProperty(\r\n            property = LottieProperty.COLOR,\r\n            value = MaterialTheme.colors.onSurface.toArgb(),\r\n            keyPath = arrayOf(\"**\", \"dynamic-line/foreground\", \"**\"),\r\n        ),\r\n    )\r\n}\r\n\r\n@Preview\r\n@Composable\r\nfun Preview() {\r\n    var illustration by remember { mutableStateOf(R.raw.animation_one) }\r\n    Column {\r\n        MaterialTheme {\r\n            Surface {\r\n                Row {\r\n                    Illustration(\r\n                        resId = illustration,\r\n                        modifier = Modifier.width(100.dp).aspectRatio(1f),\r\n                    )\r\n                    Illustration(\r\n                        resId = R.raw.animation_one,\r\n                        modifier = Modifier.width(100.dp).aspectRatio(1f),\r\n                    )\r\n                    Illustration(\r\n                        resId = R.raw.animation_two,\r\n                        modifier = Modifier.width(100.dp).aspectRatio(1f),\r\n                    )\r\n                }\r\n            }\r\n        }\r\n        Row(\r\n            horizontalArrangement = Arrangement.SpaceEvenly,\r\n            modifier = Modifier.width(300.dp),\r\n        ) {\r\n            Button(onClick = { illustration = R.raw.animation_one }) {\r\n                Text(\"One\")\r\n            }\r\n            Button(onClick = { illustration = R.raw.animation_two }) {\r\n                Text(\"Two\")\r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n**Workaround**\r\nAdding a bogus dynamic property that takes the resId into account causes the remembered dynamic properties to be updated with the composition, fixing the issue.\r\n\r\n```diff\r\n @Composable\r\n-private fun rememberDefaultDynamicProperties(): LottieDynamicProperties {\r\n+private fun rememberDefaultDynamicProperties(resId: Int): LottieDynamicProperties {\r\n     return rememberLottieDynamicProperties(\r\n        rememberLottieDynamicProperty(\r\n            property = LottieProperty.COLOR,\r\n            value = MaterialTheme.colors.surface.toArgb(),\r\n            keyPath = arrayOf(\"**\", \"dynamic-line/background\", \"**\"),\r\n        ),\r\n        rememberLottieDynamicProperty(\r\n            property = LottieProperty.COLOR,\r\n            value = MaterialTheme.colors.onSurface.toArgb(),\r\n            keyPath = arrayOf(\"**\", \"dynamic-line/foreground\", \"**\"),\r\n        ),\r\n+      rememberLottieDynamicProperty(\r\n+        property = LottieProperty.COLOR,\r\n+        value = MaterialTheme.colors.onSurface.toArgb(),\r\n+        keyPath = arrayOf(\"$resId\"),\r\n+      ),\r\n    )\r\n }\r\n```","closed_by":{"login":"gpeal","id":1307745,"node_id":"MDQ6VXNlcjEzMDc3NDU=","avatar_url":"https://avatars.githubusercontent.com/u/1307745?v=4","gravatar_id":"","url":"https://api.github.com/users/gpeal","html_url":"https://github.com/gpeal","followers_url":"https://api.github.com/users/gpeal/followers","following_url":"https://api.github.com/users/gpeal/following{/other_user}","gists_url":"https://api.github.com/users/gpeal/gists{/gist_id}","starred_url":"https://api.github.com/users/gpeal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gpeal/subscriptions","organizations_url":"https://api.github.com/users/gpeal/orgs","repos_url":"https://api.github.com/users/gpeal/repos","events_url":"https://api.github.com/users/gpeal/events{/privacy}","received_events_url":"https://api.github.com/users/gpeal/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/airbnb/lottie-android/issues/2273/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/airbnb/lottie-android/issues/2273/timeline","performed_via_github_app":null,"state_reason":"completed"}