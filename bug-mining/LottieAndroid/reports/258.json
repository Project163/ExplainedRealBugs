{"url":"https://api.github.com/repos/airbnb/lottie-android/issues/2029","repository_url":"https://api.github.com/repos/airbnb/lottie-android","labels_url":"https://api.github.com/repos/airbnb/lottie-android/issues/2029/labels{/name}","comments_url":"https://api.github.com/repos/airbnb/lottie-android/issues/2029/comments","events_url":"https://api.github.com/repos/airbnb/lottie-android/issues/2029/events","html_url":"https://github.com/airbnb/lottie-android/issues/2029","id":1157060351,"node_id":"I_kwDOBC8mW85E91b_","number":2029,"title":"Memory leak in sample app leaking ShowcaseFragment","user":{"login":"amanjeetsingh150","id":12881364,"node_id":"MDQ6VXNlcjEyODgxMzY0","avatar_url":"https://avatars.githubusercontent.com/u/12881364?v=4","gravatar_id":"","url":"https://api.github.com/users/amanjeetsingh150","html_url":"https://github.com/amanjeetsingh150","followers_url":"https://api.github.com/users/amanjeetsingh150/followers","following_url":"https://api.github.com/users/amanjeetsingh150/following{/other_user}","gists_url":"https://api.github.com/users/amanjeetsingh150/gists{/gist_id}","starred_url":"https://api.github.com/users/amanjeetsingh150/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/amanjeetsingh150/subscriptions","organizations_url":"https://api.github.com/users/amanjeetsingh150/orgs","repos_url":"https://api.github.com/users/amanjeetsingh150/repos","events_url":"https://api.github.com/users/amanjeetsingh150/events{/privacy}","received_events_url":"https://api.github.com/users/amanjeetsingh150/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1460035932,"node_id":"MDU6TGFiZWwxNDYwMDM1OTMy","url":"https://api.github.com/repos/airbnb/lottie-android/labels/Non-Rendering%20Bug","name":"Non-Rendering Bug","color":"186199","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-03-02T11:25:22Z","updated_at":"2022-04-23T18:04:20Z","closed_at":"2022-04-23T18:04:20Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"*Lottie is supported and developed on nights and weekends. Issues from [Lottie sponsors](https://github.com/users/gpeal/sponsorship) will be prioritized.*\r\n\r\n**Describe the bug**\r\nMemory leak in Lottie android sample app. Found following two leaks in the sample app:\r\n\r\n<details>\r\n<summary>1st Leak</summary>\r\n<pre>\r\n```\r\n┬───\r\n│ GC Root: Thread object\r\n│\r\n├─ android.os.HandlerThread instance\r\n│    Leaking: NO (PathClassLoader↓ is not leaking)\r\n│    Thread name: 'epoxy'\r\n│    ↓ Thread.contextClassLoader\r\n├─ dalvik.system.PathClassLoader instance\r\n│    Leaking: NO (EpoxyRecyclerView↓ is not leaking and A ClassLoader is never leaking)\r\n│    ↓ ClassLoader.runtimeInternalObjects\r\n├─ java.lang.Object[] array\r\n│    Leaking: NO (EpoxyRecyclerView↓ is not leaking)\r\n│    ↓ Object[1120]\r\n├─ com.airbnb.epoxy.EpoxyRecyclerView class\r\n│    Leaking: NO (a class is never leaking)\r\n│    ↓ static EpoxyRecyclerView.ACTIVITY_RECYCLER_POOL\r\n│                               ~~~~~~~~~~~~~~~~~~~~~~\r\n├─ com.airbnb.epoxy.ActivityRecyclerPool instance\r\n│    Leaking: UNKNOWN\r\n│    Retaining 52 B in 3 objects\r\n│    ↓ ActivityRecyclerPool.pools\r\n│                           ~~~~~\r\n├─ java.util.ArrayList instance\r\n│    Leaking: UNKNOWN\r\n│    Retaining 40 B in 2 objects\r\n│    ↓ ArrayList[0]\r\n│               ~~~\r\n├─ com.airbnb.epoxy.PoolReference instance\r\n│    Leaking: UNKNOWN\r\n│    Retaining 1.1 MB in 4174 objects\r\n│    ↓ PoolReference.viewPool\r\n│                    ~~~~~~~~\r\n├─ com.airbnb.epoxy.UnboundedViewPool instance\r\n│    Leaking: UNKNOWN\r\n│    Retaining 1.1 MB in 4172 objects\r\n│    ↓ UnboundedViewPool.scrapHeaps\r\n│                        ~~~~~~~~~~\r\n├─ android.util.SparseArray instance\r\n│    Leaking: UNKNOWN\r\n│    Retaining 1.1 MB in 4156 objects\r\n│    ↓ SparseArray.mValues\r\n│                  ~~~~~~~\r\n├─ java.lang.Object[] array\r\n│    Leaking: UNKNOWN\r\n│    Retaining 1.1 MB in 4154 objects\r\n│    ↓ Object[1]\r\n│            ~~~\r\n├─ java.util.LinkedList instance\r\n│    Leaking: UNKNOWN\r\n│    Retaining 425.9 kB in 1222 objects\r\n│    ↓ LinkedList[0]\r\n│                ~~~\r\n├─ com.airbnb.epoxy.EpoxyViewHolder instance\r\n│    Leaking: UNKNOWN\r\n│    Retaining 52.3 kB in 137 objects\r\n│    ↓ RecyclerView$ViewHolder.itemView\r\n│                              ~~~~~~~~\r\n├─ com.airbnb.lottie.samples.views.AnimationItemView instance\r\n│    Leaking: UNKNOWN\r\n│    Retaining 52.2 kB in 136 objects\r\n│    View not part of a window view hierarchy\r\n│    View.mAttachInfo is null (view detached)\r\n│    View.mWindowAttachCount = 1\r\n│    mContext instance of com.airbnb.lottie.samples.MainActivity with mDestroyed = false\r\n│    ↓ ViewGroup.mChildren\r\n│                ~~~~~~~~~\r\n├─ android.view.View[] array\r\n│    Leaking: UNKNOWN\r\n│    Retaining 48 B in 1 objects\r\n│    ↓ View[0]\r\n│          ~~~\r\n├─ android.widget.LinearLayout instance\r\n│    Leaking: UNKNOWN\r\n│    Retaining 1.9 kB in 36 objects\r\n│    View not part of a window view hierarchy\r\n│    View.mAttachInfo is null (view detached)\r\n│    View.mWindowAttachCount = 1\r\n│    mContext instance of com.airbnb.lottie.samples.MainActivity with mDestroyed = false\r\n│    ↓ View.mListenerInfo\r\n│           ~~~~~~~~~~~~~\r\n├─ android.view.View$ListenerInfo instance\r\n│    Leaking: UNKNOWN\r\n│    Retaining 108 B in 2 objects\r\n│    ↓ View$ListenerInfo.mOnClickListener\r\n│                        ~~~~~~~~~~~~~~~~\r\n├─ com.airbnb.lottie.samples.ShowcaseFragment$buildModels$1$$ExternalSyntheticLambda0 instance\r\n│    Leaking: UNKNOWN\r\n│    Retaining 16 B in 1 objects\r\n│    ↓ ShowcaseFragment$buildModels$1$$ExternalSyntheticLambda0.f$0\r\n│                                                               ~~~\r\n╰→ com.airbnb.lottie.samples.ShowcaseFragment instance\r\n​     Leaking: YES (Fragment#mFragmentManager is null)\r\n```\r\n</pre>\r\n</details>\r\n\r\n<details>\r\n<summary>2nd leak</summary>\r\n<pre>\r\n```\r\n┬───\r\n│ GC Root: Thread object\r\n│\r\n├─ android.os.HandlerThread instance\r\n│    Leaking: NO (PathClassLoader↓ is not leaking)\r\n│    Thread name: 'epoxy'\r\n│    ↓ Thread.contextClassLoader\r\n├─ dalvik.system.PathClassLoader instance\r\n│    Leaking: NO (EpoxyRecyclerView↓ is not leaking and A ClassLoader is never leaking)\r\n│    ↓ ClassLoader.runtimeInternalObjects\r\n├─ java.lang.Object[] array\r\n│    Leaking: NO (EpoxyRecyclerView↓ is not leaking)\r\n│    ↓ Object[1120]\r\n├─ com.airbnb.epoxy.EpoxyRecyclerView class\r\n│    Leaking: NO (a class is never leaking)\r\n│    ↓ static EpoxyRecyclerView.ACTIVITY_RECYCLER_POOL\r\n│                               ~~~~~~~~~~~~~~~~~~~~~~\r\n├─ com.airbnb.epoxy.ActivityRecyclerPool instance\r\n│    Leaking: UNKNOWN\r\n│    Retaining 52 B in 3 objects\r\n│    ↓ ActivityRecyclerPool.pools\r\n│                           ~~~~~\r\n├─ java.util.ArrayList instance\r\n│    Leaking: UNKNOWN\r\n│    Retaining 40 B in 2 objects\r\n│    ↓ ArrayList[0]\r\n│               ~~~\r\n├─ com.airbnb.epoxy.PoolReference instance\r\n│    Leaking: UNKNOWN\r\n│    Retaining 1.1 MB in 4174 objects\r\n│    ↓ PoolReference.viewPool\r\n│                    ~~~~~~~~\r\n├─ com.airbnb.epoxy.UnboundedViewPool instance\r\n│    Leaking: UNKNOWN\r\n│    Retaining 1.1 MB in 4172 objects\r\n│    ↓ UnboundedViewPool.scrapHeaps\r\n│                        ~~~~~~~~~~\r\n├─ android.util.SparseArray instance\r\n│    Leaking: UNKNOWN\r\n│    Retaining 1.1 MB in 4156 objects\r\n│    ↓ SparseArray.mValues\r\n│                  ~~~~~~~\r\n├─ java.lang.Object[] array\r\n│    Leaking: UNKNOWN\r\n│    Retaining 1.1 MB in 4154 objects\r\n│    ↓ Object[4]\r\n│            ~~~\r\n├─ java.util.LinkedList instance\r\n│    Leaking: UNKNOWN\r\n│    Retaining 11.2 kB in 314 objects\r\n│    ↓ LinkedList[0]\r\n│                ~~~\r\n├─ com.airbnb.epoxy.EpoxyViewHolder instance\r\n│    Leaking: UNKNOWN\r\n│    Retaining 5.4 kB in 151 objects\r\n│    ↓ RecyclerView$ViewHolder.itemView\r\n│                              ~~~~~~~~\r\n├─ com.airbnb.lottie.samples.views.ShowcaseCarousel instance\r\n│    Leaking: UNKNOWN\r\n│    Retaining 5.3 kB in 149 objects\r\n│    View not part of a window view hierarchy\r\n│    View.mAttachInfo is null (view detached)\r\n│    View.mWindowAttachCount = 1\r\n│    mContext instance of com.airbnb.lottie.samples.MainActivity with mDestroyed = false\r\n│    ↓ ShowcaseCarousel.items\r\n│                       ~~~~~\r\n├─ java.util.Arrays$ArrayList instance\r\n│    Leaking: UNKNOWN\r\n│    Retaining 36 B in 2 objects\r\n│    ↓ Arrays$ArrayList.a\r\n│                       ~\r\n├─ com.airbnb.lottie.samples.model.ShowcaseItem[] array\r\n│    Leaking: UNKNOWN\r\n│    Retaining 20 B in 1 objects\r\n│    ↓ ShowcaseItem[0]\r\n│                  ~~~\r\n├─ com.airbnb.lottie.samples.model.ShowcaseItem instance\r\n│    Leaking: UNKNOWN\r\n│    Retaining 36 B in 2 objects\r\n│    ↓ ShowcaseItem.clickListener\r\n│                   ~~~~~~~~~~~~~\r\n├─ com.airbnb.lottie.samples.ShowcaseFragment$showcaseItems$1 instance\r\n│    Leaking: UNKNOWN\r\n│    Retaining 16 B in 1 objects\r\n│    Anonymous subclass of kotlin.jvm.internal.Lambda\r\n│    ↓ ShowcaseFragment$showcaseItems$1.this$0\r\n│                                       ~~~~~~\r\n╰→ com.airbnb.lottie.samples.ShowcaseFragment instance\r\n​     Leaking: YES (Fragment#mFragmentManager is null)  \r\n</pre>\r\n</details>\r\n\r\n\r\n**Description**:  Both of them seem like due to lambda somehow ending up keeping a reference to the outside fragment (ShowcaseFragment). Can be validated by decompiling to java code. Following is the screenshot of the reason for the 1st leak where the 2nd constructor parameter is a fragment:\r\n\r\n<img src=\"https://user-images.githubusercontent.com/12881364/156346150-64bf6d3e-6f9a-44f4-bbf5-66370ec0f6c6.png\"/>\r\n\r\n\r\n**Steps To Reproduce**\r\nSteps to reproduce the behavior:\r\n\r\nSwitching tabs from Showcase → Preview → LottieFiles. Attaching the video below:\r\n\r\nhttps://user-images.githubusercontent.com/12881364/156351787-8c76ca57-632c-4d4f-bed1-5aaae2b47982.mp4\r\n\r\n\r\n","closed_by":{"login":"gpeal","id":1307745,"node_id":"MDQ6VXNlcjEzMDc3NDU=","avatar_url":"https://avatars.githubusercontent.com/u/1307745?v=4","gravatar_id":"","url":"https://api.github.com/users/gpeal","html_url":"https://github.com/gpeal","followers_url":"https://api.github.com/users/gpeal/followers","following_url":"https://api.github.com/users/gpeal/following{/other_user}","gists_url":"https://api.github.com/users/gpeal/gists{/gist_id}","starred_url":"https://api.github.com/users/gpeal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gpeal/subscriptions","organizations_url":"https://api.github.com/users/gpeal/orgs","repos_url":"https://api.github.com/users/gpeal/repos","events_url":"https://api.github.com/users/gpeal/events{/privacy}","received_events_url":"https://api.github.com/users/gpeal/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/airbnb/lottie-android/issues/2029/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/airbnb/lottie-android/issues/2029/timeline","performed_via_github_app":null,"state_reason":"completed"}