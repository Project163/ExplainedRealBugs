diff --git a/src/main/java/com/google/devtools/build/lib/shell/Command.java b/src/main/java/com/google/devtools/build/lib/shell/Command.java
index 3fef6d2db7..94ad339511 100644
--- a/src/main/java/com/google/devtools/build/lib/shell/Command.java
+++ b/src/main/java/com/google/devtools/build/lib/shell/Command.java
@@ -176,10 +176,10 @@ public final class Command implements DescribableExecutionUnit {
    * </ul>
    *
    * @param commandLineElements elements of raw command line to execute
-   * @param environmentVariables environment variables to replace JVM's environment variables; may
-   *     be null
-   * @param workingDirectory working directory for execution; if null, the VM's current working
-   *     directory is used
+   * @param environmentVariables environment variables for the child process, or null to inherit
+   *     them from the parent
+   * @param workingDirectory working directory for the child process, or null to inherit it from the
+   *     parent
    * @param timeout timeout; a value less than or equal to 0 is treated as no timeout
    * @throws IllegalArgumentException if commandLine is null or empty
    */
diff --git a/src/main/java/com/google/devtools/build/lib/shell/SubprocessBuilder.java b/src/main/java/com/google/devtools/build/lib/shell/SubprocessBuilder.java
index bf22691718..f343a67b13 100644
--- a/src/main/java/com/google/devtools/build/lib/shell/SubprocessBuilder.java
+++ b/src/main/java/com/google/devtools/build/lib/shell/SubprocessBuilder.java
@@ -125,7 +125,7 @@ public class SubprocessBuilder {
 
   /**
    * Sets the environment passed to the child process. If null, inherit the environment of the
-   * server.
+   * parent. The default is to inherit.
    */
   @CanIgnoreReturnValue
   public SubprocessBuilder setEnv(@Nullable Map<String, String> env) {
diff --git a/src/main/java/com/google/devtools/build/lib/shell/WindowsSubprocessFactory.java b/src/main/java/com/google/devtools/build/lib/shell/WindowsSubprocessFactory.java
index 55d7d288e9..d55ec5eca1 100644
--- a/src/main/java/com/google/devtools/build/lib/shell/WindowsSubprocessFactory.java
+++ b/src/main/java/com/google/devtools/build/lib/shell/WindowsSubprocessFactory.java
@@ -14,6 +14,7 @@
 
 package com.google.devtools.build.lib.shell;
 
+import com.google.common.collect.ImmutableList;
 import com.google.devtools.build.lib.shell.SubprocessBuilder.StreamAction;
 import com.google.devtools.build.lib.vfs.PathFragment;
 import com.google.devtools.build.lib.windows.WindowsProcesses;
@@ -120,37 +121,34 @@ public class WindowsSubprocessFactory implements SubprocessFactory {
   }
 
   /** Converts an environment map to the format expected in lpEnvironment by CreateProcess(). */
-  private static byte[] convertEnvToNative(Map<String, String> envMap) throws IOException {
-    Map<String, String> realEnv = new TreeMap<>(String.CASE_INSENSITIVE_ORDER);
-    Map<String, String> systemEnv = new TreeMap<>(String.CASE_INSENSITIVE_ORDER);
+  private static byte[] convertEnvToNative(Map<String, String> envMap) {
+    Map<String, String> fullEnv = new TreeMap<>(String.CASE_INSENSITIVE_ORDER);
+
     if (envMap != null) {
-      realEnv.putAll(envMap);
-    }
-    // It is fine to use System.getenv to get default SYSTEMROOT and SYSTEMDRIVE, because they are
-    // very special system environment variables and Bazel's client and server are running on the
-    // same machine, so it should be the same in client environment.
-    systemEnv.putAll(System.getenv());
-    // Some versions of MSVCRT.DLL and tools require SYSTEMROOT and SYSTEMDRIVE to be set. They are
-    // very common environment variables on Windows, so we add these environment variables
-    // regardless of whether the caller requested it or not.
-    String[] systemEnvironmentVars = {"SYSTEMROOT", "SYSTEMDRIVE"};
-    for (String env : systemEnvironmentVars) {
-      if (realEnv.getOrDefault(env, null) == null) {
-        String value = systemEnv.getOrDefault(env, null);
-        if (value != null) {
-          realEnv.put(env, value);
+      fullEnv.putAll(envMap);
+      // Some versions of MSVCRT.DLL and tools require SYSTEMROOT and SYSTEMDRIVE to be set. They
+      // are very common environment variables on Windows, so we add these environment variables
+      // regardless of whether the caller requested it or not.
+      for (String env : ImmutableList.of("SYSTEMROOT", "SYSTEMDRIVE")) {
+        if (fullEnv.getOrDefault(env, null) == null) {
+          String value = System.getenv(env);
+          if (value != null) {
+            fullEnv.put(env, value);
+          }
         }
       }
+    } else {
+      fullEnv.putAll(System.getenv());
     }
 
-    if (realEnv.isEmpty()) {
+    if (fullEnv.isEmpty()) {
       // Special case: CreateProcess() always expects the environment block to be terminated
       // with two zeros.
       return "\0".getBytes(StandardCharsets.UTF_16LE);
     }
 
     StringBuilder result = new StringBuilder();
-    for (Map.Entry<String, String> entry : realEnv.entrySet()) {
+    for (Map.Entry<String, String> entry : fullEnv.entrySet()) {
       if (entry.getKey().contains("=")) {
         // lpEnvironment requires no '=' in environment variable name, but on Windows,
         // System.getenv() returns environment variables like '=C:' or '=ExitCode', so it can't
diff --git a/src/test/java/com/google/devtools/build/lib/shell/CommandTest.java b/src/test/java/com/google/devtools/build/lib/shell/CommandTest.java
index 7091291dcc..495284695f 100644
--- a/src/test/java/com/google/devtools/build/lib/shell/CommandTest.java
+++ b/src/test/java/com/google/devtools/build/lib/shell/CommandTest.java
@@ -17,6 +17,7 @@ import static com.google.common.truth.Truth.assertThat;
 import static com.google.common.truth.Truth.assertWithMessage;
 import static org.junit.Assert.assertThrows;
 
+import com.google.common.base.Strings;
 import com.google.common.collect.ImmutableMap;
 import com.google.devtools.build.lib.testutil.BlazeTestUtils;
 import com.google.devtools.build.lib.testutil.TestConstants;
@@ -95,10 +96,27 @@ public class CommandTest {
   }
 
   @Test
-  public void testEnvironment() throws Exception {
-    Map<String, String> env = Collections.singletonMap("FOO", "BAR");
-    Command command = new Command(new String[] {"/bin/sh", "-c", "echo $FOO"}, env, null);
-    checkSuccess(command.execute(), "BAR\n");
+  public void testNonEmptyEnvironment() throws Exception {
+    ImmutableMap<String, String> env = ImmutableMap.of("FOO", "abc", "BAR", "def");
+    Command command = new Command(new String[] {"/bin/sh", "-c", "echo $FOO $BAR"}, env, null);
+    checkSuccess(command.execute(), "abc def\n");
+  }
+
+  @Test
+  public void testEmptyEnvironment() throws Exception {
+    // Check only that TZ was not inherited instead of verifying the entire environment.
+    assertThat(Strings.nullToEmpty(System.getenv("TZ"))).isNotEmpty();
+    Command command =
+        new Command(new String[] {"/bin/sh", "-c", "echo $TZ"}, ImmutableMap.of(), null);
+    checkSuccess(command.execute(), "\n");
+  }
+
+  @Test
+  public void testInheritedEnvironment() throws Exception {
+    // Check only that TZ was inherited instead of verifying the entire environment.
+    assertThat(Strings.nullToEmpty(System.getenv("TZ"))).isNotEmpty();
+    Command command = new Command(new String[] {"/bin/sh", "-c", "echo $TZ"}, null, null);
+    checkSuccess(command.execute(), System.getenv("TZ") + "\n");
   }
 
   @Test
diff --git a/src/test/java/com/google/devtools/build/lib/windows/BUILD b/src/test/java/com/google/devtools/build/lib/windows/BUILD
index 69892aa2d3..0f1284678a 100644
--- a/src/test/java/com/google/devtools/build/lib/windows/BUILD
+++ b/src/test/java/com/google/devtools/build/lib/windows/BUILD
@@ -55,6 +55,7 @@ java_binary(
     name = "MockSubprocess",
     testonly = 1,
     srcs = ["MockSubprocess.java"],
+    deps = ["//third_party:guava"],
 )
 
 cc_binary(
diff --git a/src/test/java/com/google/devtools/build/lib/windows/MockSubprocess.java b/src/test/java/com/google/devtools/build/lib/windows/MockSubprocess.java
index 5d5d8e243b..27f81b6794 100644
--- a/src/test/java/com/google/devtools/build/lib/windows/MockSubprocess.java
+++ b/src/test/java/com/google/devtools/build/lib/windows/MockSubprocess.java
@@ -14,6 +14,7 @@
 
 package com.google.devtools.build.lib.windows;
 
+import com.google.common.base.Strings;
 import java.io.PrintStream;
 import java.nio.charset.Charset;
 import java.nio.file.Paths;
@@ -62,7 +63,7 @@ public class MockSubprocess {
 
       case '$':
         // Environment variable
-        buf = System.getenv(arg.substring(2)).getBytes(UTF8);
+        buf = Strings.nullToEmpty(System.getenv(arg.substring(2))).getBytes(UTF8);
         break;
 
       case '.':
diff --git a/src/test/java/com/google/devtools/build/lib/windows/WindowsSubprocessTest.java b/src/test/java/com/google/devtools/build/lib/windows/WindowsSubprocessTest.java
index 1248fba3a1..fec7ab9d71 100644
--- a/src/test/java/com/google/devtools/build/lib/windows/WindowsSubprocessTest.java
+++ b/src/test/java/com/google/devtools/build/lib/windows/WindowsSubprocessTest.java
@@ -18,6 +18,7 @@ import static com.google.common.truth.Truth.assertThat;
 import static java.nio.charset.StandardCharsets.UTF_8;
 import static org.junit.Assert.assertThrows;
 
+import com.google.common.base.Strings;
 import com.google.common.collect.ImmutableList;
 import com.google.common.collect.ImmutableMap;
 import com.google.devtools.build.lib.shell.ShellUtils;
@@ -70,12 +71,12 @@ public class WindowsSubprocessTest {
     SubprocessBuilder subprocessBuilder = new SubprocessBuilder(WindowsSubprocessFactory.INSTANCE);
     subprocessBuilder.setWorkingDirectory(new File("."));
     subprocessBuilder.setArgv(ImmutableList.of(mockBinary, "-jar", mockSubprocess, "O$SYSTEMROOT"));
+    subprocessBuilder.setEnv(ImmutableMap.of());
     process = subprocessBuilder.start();
     process.waitFor();
     assertThat(process.exitValue()).isEqualTo(0);
 
-    byte[] buf = new byte[11];
-    process.getInputStream().read(buf);
+    byte[] buf = process.getInputStream().readAllBytes();
     assertThat(new String(buf, UTF_8).trim()).isEqualTo(System.getenv("SYSTEMROOT").trim());
   }
 
@@ -85,12 +86,12 @@ public class WindowsSubprocessTest {
     subprocessBuilder.setWorkingDirectory(new File("."));
     subprocessBuilder.setArgv(
         ImmutableList.of(mockBinary, "-jar", mockSubprocess, "O$SYSTEMDRIVE"));
+    subprocessBuilder.setEnv(ImmutableMap.of());
     process = subprocessBuilder.start();
     process.waitFor();
     assertThat(process.exitValue()).isEqualTo(0);
 
-    byte[] buf = new byte[3];
-    process.getInputStream().read(buf);
+    byte[] buf = process.getInputStream().readAllBytes();
     assertThat(new String(buf, UTF_8).trim()).isEqualTo(System.getenv("SYSTEMDRIVE").trim());
   }
 
@@ -105,8 +106,7 @@ public class WindowsSubprocessTest {
     process.waitFor();
     assertThat(process.exitValue()).isEqualTo(0);
 
-    byte[] buf = new byte[16];
-    process.getInputStream().read(buf);
+    byte[] buf = process.getInputStream().readAllBytes();
     assertThat(new String(buf, UTF_8).trim()).isEqualTo("C:\\MySystemRoot");
   }
 
@@ -122,11 +122,58 @@ public class WindowsSubprocessTest {
     process.waitFor();
     assertThat(process.exitValue()).isEqualTo(0);
 
-    byte[] buf = new byte[3];
-    process.getInputStream().read(buf);
+    byte[] buf = process.getInputStream().readAllBytes();
     assertThat(new String(buf, UTF_8).trim()).isEqualTo("X:");
   }
 
+  @Test
+  public void testEmptyEnvironment() throws Exception {
+    // Check only that TZ was not inherited instead of verifying the entire environment.
+    assertThat(Strings.nullToEmpty(System.getenv("TZ"))).isNotEmpty();
+    SubprocessBuilder subprocessBuilder = new SubprocessBuilder(WindowsSubprocessFactory.INSTANCE);
+    subprocessBuilder.setWorkingDirectory(new File("."));
+    subprocessBuilder.setArgv(ImmutableList.of(mockBinary, "-jar", mockSubprocess, "O$TZ"));
+    subprocessBuilder.setEnv(ImmutableMap.of());
+    process = subprocessBuilder.start();
+    process.waitFor();
+    assertThat(process.exitValue()).isEqualTo(0);
+
+    byte[] buf = process.getInputStream().readAllBytes();
+    assertThat(new String(buf, UTF_8).trim()).isEmpty();
+  }
+
+  @Test
+  public void testNonEmptyEnvironment() throws Exception {
+    // Check only that TZ was not inherited instead of verifying the entire environment.
+    assertThat(Strings.nullToEmpty(System.getenv("TZ"))).isNotEmpty();
+    SubprocessBuilder subprocessBuilder = new SubprocessBuilder(WindowsSubprocessFactory.INSTANCE);
+    subprocessBuilder.setWorkingDirectory(new File("."));
+    subprocessBuilder.setArgv(
+        ImmutableList.of(mockBinary, "-jar", mockSubprocess, "O$FOO", "O$BAR", "O$TZ"));
+    subprocessBuilder.setEnv(ImmutableMap.of("FOO", "abc", "BAR", "def"));
+    process = subprocessBuilder.start();
+    process.waitFor();
+    assertThat(process.exitValue()).isEqualTo(0);
+
+    byte[] buf = process.getInputStream().readAllBytes();
+    assertThat(new String(buf, UTF_8).trim()).isEqualTo("abcdef");
+  }
+
+  @Test
+  public void testInheritedEnvironment() throws Exception {
+    // Check only that TZ was inherited instead of verifying the entire environment.
+    assertThat(Strings.nullToEmpty(System.getenv("TZ"))).isNotEmpty();
+    SubprocessBuilder subprocessBuilder = new SubprocessBuilder(WindowsSubprocessFactory.INSTANCE);
+    subprocessBuilder.setWorkingDirectory(new File("."));
+    subprocessBuilder.setArgv(ImmutableList.of(mockBinary, "-jar", mockSubprocess, "O$TZ"));
+    process = subprocessBuilder.start();
+    process.waitFor();
+    assertThat(process.exitValue()).isEqualTo(0);
+
+    byte[] buf = process.getInputStream().readAllBytes();
+    assertThat(new String(buf, UTF_8).trim()).isEqualTo(System.getenv("TZ"));
+  }
+
   @Test
   public void testStreamAvailable_zeroAfterClose() throws Exception {
     SubprocessBuilder subprocessBuilder = new SubprocessBuilder(WindowsSubprocessFactory.INSTANCE);
@@ -183,8 +230,7 @@ public class WindowsSubprocessTest {
 
       // The subprocess printed its argv[1] in parentheses, e.g. (foo).
       // Assert that it printed exactly the *original* argument in parentheses.
-      byte[] buf = new byte[1000];
-      process.getInputStream().read(buf);
+      byte[] buf = process.getInputStream().readAllBytes();
       String actual = new String(buf, UTF_8).trim();
       assertThat(actual).isEqualTo("(" + arg.original + ")");
     }
