diff --git a/src/main/java/com/google/devtools/build/lib/analysis/starlark/StarlarkCustomCommandLine.java b/src/main/java/com/google/devtools/build/lib/analysis/starlark/StarlarkCustomCommandLine.java
index e5eb482c6c..e865c97460 100644
--- a/src/main/java/com/google/devtools/build/lib/analysis/starlark/StarlarkCustomCommandLine.java
+++ b/src/main/java/com/google/devtools/build/lib/analysis/starlark/StarlarkCustomCommandLine.java
@@ -512,7 +512,8 @@ public class StarlarkCustomCommandLine extends CommandLine {
         ActionKeyContext actionKeyContext,
         Fingerprint fingerprint,
         @Nullable InputMetadataProvider inputMetadataProvider,
-        CoreOptions.OutputPathsMode outputPathsMode)
+        CoreOptions.OutputPathsMode outputPathsMode,
+        RepositoryMapping mainRepoMapping)
         throws CommandLineExpansionException, InterruptedException {
       StarlarkCallable mapEach = null;
       Location location = null;
@@ -569,6 +570,10 @@ public class StarlarkCustomCommandLine extends CommandLine {
           }
         } else {
           fingerprint.addInt(stringificationType.ordinal());
+          if (stringificationType == StringificationType.LABEL) {
+            fingerprint.addStringMap(
+                Maps.transformValues(mainRepoMapping.entries(), RepositoryName::getName));
+          }
           actionKeyContext.addNestedSetToFingerprint(fingerprint, values);
         }
       } else {
@@ -597,7 +602,7 @@ public class StarlarkCustomCommandLine extends CommandLine {
               starlarkSemantics);
         } else {
           for (Object value : maybeExpandedValues) {
-            addSingleObjectToFingerprint(fingerprint, value);
+            addSingleObjectToFingerprint(fingerprint, value, mainRepoMapping);
           }
         }
       }
@@ -822,9 +827,13 @@ public class StarlarkCustomCommandLine extends CommandLine {
       return argi;
     }
 
-    static int addToFingerprint(List<Object> arguments, int argi, Fingerprint fingerprint) {
+    static int addToFingerprint(
+        List<Object> arguments,
+        int argi,
+        Fingerprint fingerprint,
+        @Nullable RepositoryMapping mainRepoMapping) {
       Object object = arguments.get(argi++);
-      addSingleObjectToFingerprint(fingerprint, object);
+      addSingleObjectToFingerprint(fingerprint, object, mainRepoMapping);
       String formatStr = (String) arguments.get(argi++);
       fingerprint.addString(formatStr);
       fingerprint.addUUID(SINGLE_FORMATTED_ARG_UUID);
@@ -958,7 +967,7 @@ public class StarlarkCustomCommandLine extends CommandLine {
   private static Object /* String | DerivedArtifact */ expandToCommandLine(
       Object object, @Nullable RepositoryMapping mainRepoMapping) {
     // Label arguments are rare, so we don't bother rendering them lazily.
-    if (mainRepoMapping != null && object instanceof Label label) {
+    if (object instanceof Label label) {
       return label.getDisplayForm(mainRepoMapping);
     }
 
@@ -968,13 +977,14 @@ public class StarlarkCustomCommandLine extends CommandLine {
         : CommandLineItem.expandToCommandLine(object);
   }
 
-  private static void addSingleObjectToFingerprint(Fingerprint fingerprint, Object object) {
+  private static void addSingleObjectToFingerprint(
+      Fingerprint fingerprint, Object object, @Nullable RepositoryMapping mainRepoMapping) {
+    if (object instanceof Label label) {
+      fingerprint.addString(label.getDisplayForm(mainRepoMapping));
+      return;
+    }
     StringificationType stringificationType =
-        switch (object) {
-          case FileApi ignored -> StringificationType.FILE;
-          case Label ignored -> StringificationType.LABEL;
-          default -> StringificationType.DEFAULT;
-        };
+        object instanceof FileApi ? StringificationType.FILE : StringificationType.DEFAULT;
     fingerprint.addInt(stringificationType.ordinal());
     fingerprint.addString(CommandLineItem.expandToCommandLine(object));
   }
@@ -1047,11 +1057,12 @@ public class StarlarkCustomCommandLine extends CommandLine {
       throws CommandLineExpansionException, InterruptedException {
     List<Object> arguments = rawArgsAsList();
     int size;
-    if (arguments.getLast() instanceof RepositoryMapping mainRepoMapping) {
-      fingerprint.addStringMap(
-          Maps.transformValues(mainRepoMapping.entries(), RepositoryName::getName));
+    RepositoryMapping mainRepoMapping;
+    if (arguments.getLast() instanceof RepositoryMapping mapping) {
+      mainRepoMapping = mapping;
       size = arguments.size() - 1;
     } else {
+      mainRepoMapping = null;
       size = arguments.size();
     }
     for (int argi = 0; argi < size; ) {
@@ -1065,11 +1076,12 @@ public class StarlarkCustomCommandLine extends CommandLine {
                     actionKeyContext,
                     fingerprint,
                     inputMetadataProvider,
-                    effectiveOutputPathsMode);
+                    effectiveOutputPathsMode,
+                    mainRepoMapping);
       } else if (arg == SINGLE_FORMATTED_ARG_MARKER) {
-        argi = SingleFormattedArg.addToFingerprint(arguments, argi, fingerprint);
+        argi = SingleFormattedArg.addToFingerprint(arguments, argi, fingerprint, mainRepoMapping);
       } else {
-        addSingleObjectToFingerprint(fingerprint, arg);
+        addSingleObjectToFingerprint(fingerprint, arg, mainRepoMapping);
       }
     }
   }
diff --git a/src/test/java/com/google/devtools/build/lib/starlark/StarlarkRuleImplementationFunctionsTest.java b/src/test/java/com/google/devtools/build/lib/starlark/StarlarkRuleImplementationFunctionsTest.java
index 02aca32205..3434e7fb77 100644
--- a/src/test/java/com/google/devtools/build/lib/starlark/StarlarkRuleImplementationFunctionsTest.java
+++ b/src/test/java/com/google/devtools/build/lib/starlark/StarlarkRuleImplementationFunctionsTest.java
@@ -3546,6 +3546,151 @@ public final class StarlarkRuleImplementationFunctionsTest extends BuildViewTest
     assertThat(getDigest(commandLine1)).isEqualTo(getDigest(commandLine2));
   }
 
+  @Test
+  public void starlarkCustomCommandLineKeyComputation_singleLabel_repoMappingChanges_relevant()
+      throws Exception {
+    setRuleContext(createRuleContext("//foo:foo"));
+
+    var mainRepoMapping1 =
+        RepositoryMapping.create(
+            ImmutableMap.of("apparent1", RepositoryName.createUnvalidated("canonical+")),
+            RepositoryName.MAIN);
+    var mainRepoMapping2 =
+        RepositoryMapping.create(
+            ImmutableMap.of("apparent2", RepositoryName.createUnvalidated("canonical+")),
+            RepositoryName.MAIN);
+    var args =
+        """
+        args = ruleContext.actions.args()
+        args.add(Label("@@canonical+//foo:bar"))
+        """;
+    var commandLine1 = getCommandLine(mainRepoMapping1, args);
+    var commandLine2 = getCommandLine(mainRepoMapping2, args);
+
+    assertThat(ImmutableList.copyOf(commandLine1.arguments()))
+        .isNotEqualTo(ImmutableList.copyOf(commandLine2.arguments()));
+    assertThat(getDigest(commandLine1)).isNotEqualTo(getDigest(commandLine2));
+  }
+
+  @Test
+  public void starlarkCustomCommandLineKeyComputation_singleLabel_repoMappingChanges_notRelevant()
+      throws Exception {
+    setRuleContext(createRuleContext("//foo:foo"));
+
+    var mainRepoMapping1 =
+        RepositoryMapping.create(
+            ImmutableMap.of(
+                "apparent", RepositoryName.createUnvalidated("canonical+"),
+                "other_repo1", RepositoryName.createUnvalidated("other_repo+")),
+            RepositoryName.MAIN);
+    var mainRepoMapping2 =
+        RepositoryMapping.create(
+            ImmutableMap.of(
+                "apparent", RepositoryName.createUnvalidated("canonical+"),
+                "other_repo2", RepositoryName.createUnvalidated("other_repo+")),
+            RepositoryName.MAIN);
+    var args =
+        """
+        args = ruleContext.actions.args()
+        args.add(Label("@@canonical+//foo:bar"))
+        """;
+    var commandLine1 = getCommandLine(mainRepoMapping1, args);
+    var commandLine2 = getCommandLine(mainRepoMapping2, args);
+
+    assertThat(commandLine1.arguments())
+        .containsExactlyElementsIn(commandLine2.arguments())
+        .inOrder();
+    assertThat(getDigest(commandLine1)).isEqualTo(getDigest(commandLine2));
+  }
+
+  @Test
+  public void starlarkCustomCommandLineKeyComputation_listOfLabels_repoMappingChanges_relevant()
+      throws Exception {
+    setRuleContext(createRuleContext("//foo:foo"));
+
+    var mainRepoMapping1 =
+        RepositoryMapping.create(
+            ImmutableMap.of("apparent1", RepositoryName.createUnvalidated("canonical+")),
+            RepositoryName.MAIN);
+    var mainRepoMapping2 =
+        RepositoryMapping.create(
+            ImmutableMap.of("apparent2", RepositoryName.createUnvalidated("canonical+")),
+            RepositoryName.MAIN);
+    var args =
+        """
+        args = ruleContext.actions.args()
+        args.add_all([Label("@@canonical+//foo:bar"), Label("@@canonical+//foo:baz")])
+        """;
+    var commandLine1 = getCommandLine(mainRepoMapping1, args);
+    var commandLine2 = getCommandLine(mainRepoMapping2, args);
+
+    assertThat(ImmutableList.copyOf(commandLine1.arguments()))
+        .isNotEqualTo(ImmutableList.copyOf(commandLine2.arguments()));
+    assertThat(getDigest(commandLine1)).isNotEqualTo(getDigest(commandLine2));
+  }
+
+  @Test
+  public void starlarkCustomCommandLineKeyComputation_listOfLabels_repoMappingChanges_notRelevant()
+      throws Exception {
+    setRuleContext(createRuleContext("//foo:foo"));
+
+    var mainRepoMapping1 =
+        RepositoryMapping.create(
+            ImmutableMap.of(
+                "apparent",
+                RepositoryName.createUnvalidated("canonical+"),
+                "other_repo1",
+                RepositoryName.createUnvalidated("other_repo+")),
+            RepositoryName.MAIN);
+    var mainRepoMapping2 =
+        RepositoryMapping.create(
+            ImmutableMap.of(
+                "apparent",
+                RepositoryName.createUnvalidated("canonical+"),
+                "other_repo2",
+                RepositoryName.createUnvalidated("other_repo+")),
+            RepositoryName.MAIN);
+    var args =
+        """
+        args = ruleContext.actions.args()
+        args.add_all([Label("@@canonical+//foo:bar"), Label("@@canonical+//foo:baz")])
+        """;
+    var commandLine1 = getCommandLine(mainRepoMapping1, args);
+    var commandLine2 = getCommandLine(mainRepoMapping2, args);
+
+    assertThat(commandLine1.arguments())
+        .containsExactlyElementsIn(commandLine2.arguments())
+        .inOrder();
+    assertThat(getDigest(commandLine1)).isEqualTo(getDigest(commandLine2));
+  }
+
+  @Test
+  public void
+      starlarkCustomCommandLineKeyComputation_nestedSetOfLabels_repoMappingChanges_relevant()
+          throws Exception {
+    setRuleContext(createRuleContext("//foo:foo"));
+
+    var mainRepoMapping1 =
+        RepositoryMapping.create(
+            ImmutableMap.of("apparent1", RepositoryName.createUnvalidated("canonical+")),
+            RepositoryName.MAIN);
+    var mainRepoMapping2 =
+        RepositoryMapping.create(
+            ImmutableMap.of("apparent2", RepositoryName.createUnvalidated("canonical+")),
+            RepositoryName.MAIN);
+    var args =
+        """
+        args = ruleContext.actions.args()
+        args.add_all(depset([Label("@@canonical+//foo:bar"), Label("@@canonical+//foo:baz")]))
+        """;
+    var commandLine1 = getCommandLine(mainRepoMapping1, args);
+    var commandLine2 = getCommandLine(mainRepoMapping2, args);
+
+    assertThat(ImmutableList.copyOf(commandLine1.arguments()))
+        .isNotEqualTo(ImmutableList.copyOf(commandLine2.arguments()));
+    assertThat(getDigest(commandLine1)).isNotEqualTo(getDigest(commandLine2));
+  }
+
   @Test
   public void starlarkCustomCommandLineKeyComputation_labelVsString() throws Exception {
     setRuleContext(createRuleContext("//foo:foo"));
