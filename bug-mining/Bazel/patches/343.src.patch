diff --git a/src/main/java/com/google/devtools/build/lib/buildtool/AqueryProcessor.java b/src/main/java/com/google/devtools/build/lib/buildtool/AqueryProcessor.java
index f5ef0b1245..7756266c26 100644
--- a/src/main/java/com/google/devtools/build/lib/buildtool/AqueryProcessor.java
+++ b/src/main/java/com/google/devtools/build/lib/buildtool/AqueryProcessor.java
@@ -16,6 +16,7 @@ package com.google.devtools.build.lib.buildtool;
 import com.google.common.collect.ImmutableList;
 import com.google.common.collect.ImmutableMap;
 import com.google.devtools.build.lib.actions.CommandLineExpansionException;
+import com.google.devtools.build.lib.analysis.ConfiguredAspect;
 import com.google.devtools.build.lib.analysis.ConfiguredTargetValue;
 import com.google.devtools.build.lib.analysis.actions.TemplateExpansionException;
 import com.google.devtools.build.lib.analysis.config.BuildConfigurationValue;
@@ -41,6 +42,7 @@ import com.google.devtools.build.lib.runtime.QueryRuntimeHelper.QueryRuntimeHelp
 import com.google.devtools.build.lib.server.FailureDetails.ActionQuery;
 import com.google.devtools.build.lib.server.FailureDetails.ActionQuery.Code;
 import com.google.devtools.build.lib.server.FailureDetails.FailureDetail;
+import com.google.devtools.build.lib.skyframe.AspectKeyCreator;
 import com.google.devtools.build.lib.skyframe.SequencedSkyframeExecutor;
 import com.google.devtools.build.lib.skyframe.actiongraph.v2.ActionGraphDump;
 import com.google.devtools.build.lib.skyframe.actiongraph.v2.AqueryConsumingOutputHandler;
@@ -146,6 +148,7 @@ public final class AqueryProcessor extends PostAnalysisQueryProcessor<Configured
       CommandEnvironment env,
       TopLevelConfigurations topLevelConfigurations,
       ImmutableMap<String, BuildConfigurationValue> transitiveConfigurations,
+      ImmutableMap<AspectKeyCreator.AspectKey, ConfiguredAspect> topLevelAspects,
       WalkableGraph walkableGraph) {
     ImmutableList<QueryFunction> extraFunctions =
         new ImmutableList.Builder<QueryFunction>()
diff --git a/src/main/java/com/google/devtools/build/lib/buildtool/CqueryProcessor.java b/src/main/java/com/google/devtools/build/lib/buildtool/CqueryProcessor.java
index 70b15b23ed..fb593ab25e 100644
--- a/src/main/java/com/google/devtools/build/lib/buildtool/CqueryProcessor.java
+++ b/src/main/java/com/google/devtools/build/lib/buildtool/CqueryProcessor.java
@@ -15,6 +15,7 @@ package com.google.devtools.build.lib.buildtool;
 
 import com.google.common.collect.ImmutableList;
 import com.google.common.collect.ImmutableMap;
+import com.google.devtools.build.lib.analysis.ConfiguredAspect;
 import com.google.devtools.build.lib.analysis.config.BuildConfigurationValue;
 import com.google.devtools.build.lib.cmdline.TargetPattern;
 import com.google.devtools.build.lib.packages.semantics.BuildLanguageOptions;
@@ -26,6 +27,7 @@ import com.google.devtools.build.lib.query2.cquery.CqueryOptions;
 import com.google.devtools.build.lib.query2.engine.QueryEnvironment.QueryFunction;
 import com.google.devtools.build.lib.query2.engine.QueryExpression;
 import com.google.devtools.build.lib.runtime.CommandEnvironment;
+import com.google.devtools.build.lib.skyframe.AspectKeyCreator;
 import com.google.devtools.build.skyframe.WalkableGraph;
 import net.starlark.java.eval.StarlarkSemantics;
 
@@ -48,8 +50,8 @@ public final class CqueryProcessor extends PostAnalysisQueryProcessor<CqueryNode
       CommandEnvironment env,
       TopLevelConfigurations configurations,
       ImmutableMap<String, BuildConfigurationValue> transitiveConfigurations,
-      WalkableGraph walkableGraph)
-      throws InterruptedException {
+      ImmutableMap<AspectKeyCreator.AspectKey, ConfiguredAspect> topLevelAspects,
+      WalkableGraph walkableGraph) {
     ImmutableList<QueryFunction> extraFunctions =
         new ImmutableList.Builder<QueryFunction>()
             .addAll(ConfiguredTargetQueryEnvironment.CQUERY_FUNCTIONS)
@@ -65,6 +67,7 @@ public final class CqueryProcessor extends PostAnalysisQueryProcessor<CqueryNode
         extraFunctions,
         configurations,
         transitiveConfigurations,
+        topLevelAspects,
         mainRepoTargetParser,
         env.getPackageManager().getPackagePath(),
         () -> walkableGraph,
diff --git a/src/main/java/com/google/devtools/build/lib/buildtool/PostAnalysisQueryProcessor.java b/src/main/java/com/google/devtools/build/lib/buildtool/PostAnalysisQueryProcessor.java
index 048dc2966e..75b0f1416f 100644
--- a/src/main/java/com/google/devtools/build/lib/buildtool/PostAnalysisQueryProcessor.java
+++ b/src/main/java/com/google/devtools/build/lib/buildtool/PostAnalysisQueryProcessor.java
@@ -17,6 +17,7 @@ import static com.google.common.collect.ImmutableMap.toImmutableMap;
 
 import com.google.common.collect.ImmutableMap;
 import com.google.devtools.build.lib.analysis.AnalysisResult;
+import com.google.devtools.build.lib.analysis.ConfiguredAspect;
 import com.google.devtools.build.lib.analysis.ViewCreationFailedException;
 import com.google.devtools.build.lib.analysis.config.BuildConfigurationValue;
 import com.google.devtools.build.lib.buildtool.BuildTool.ExitException;
@@ -39,6 +40,7 @@ import com.google.devtools.build.lib.runtime.QueryRuntimeHelper.QueryRuntimeHelp
 import com.google.devtools.build.lib.server.FailureDetails.ActionQuery;
 import com.google.devtools.build.lib.server.FailureDetails.FailureDetail;
 import com.google.devtools.build.lib.server.FailureDetails.Query;
+import com.google.devtools.build.lib.skyframe.AspectKeyCreator;
 import com.google.devtools.build.lib.skyframe.SkyframeExecutorWrappingWalkableGraph;
 import com.google.devtools.build.lib.util.DetailedExitCode;
 import com.google.devtools.build.lib.util.ExitCode;
@@ -97,6 +99,7 @@ public abstract class PostAnalysisQueryProcessor<T> implements BuildTool.Analysi
             env,
             runtime,
             new TopLevelConfigurations(analysisResult.getTopLevelTargetsWithConfigs()),
+            analysisResult.getAspectsMap(),
             env.getSkyframeExecutor().getTransitiveConfigurationKeys(),
             queryRuntimeHelper,
             queryExpression);
@@ -139,6 +142,7 @@ public abstract class PostAnalysisQueryProcessor<T> implements BuildTool.Analysi
       CommandEnvironment env,
       TopLevelConfigurations topLevelConfigurations,
       ImmutableMap<String, BuildConfigurationValue> transitiveConfigurations,
+      ImmutableMap<AspectKeyCreator.AspectKey, ConfiguredAspect> topLevelAspects,
       WalkableGraph walkableGraph)
       throws InterruptedException;
 
@@ -158,10 +162,14 @@ public abstract class PostAnalysisQueryProcessor<T> implements BuildTool.Analysi
       CommandEnvironment env,
       BlazeRuntime runtime,
       TopLevelConfigurations topLevelConfigurations,
+      ImmutableMap<AspectKeyCreator.AspectKey, ConfiguredAspect> topLevelAspects,
       Collection<SkyKey> transitiveConfigurationKeys,
       QueryRuntimeHelper queryRuntimeHelper,
       QueryExpression queryExpression)
-      throws InterruptedException, QueryException, IOException, QueryRuntimeHelperException,
+      throws InterruptedException,
+          QueryException,
+          IOException,
+          QueryRuntimeHelperException,
           OptionsParsingException {
     WalkableGraph walkableGraph =
         SkyframeExecutorWrappingWalkableGraph.of(env.getSkyframeExecutor());
@@ -170,7 +178,12 @@ public abstract class PostAnalysisQueryProcessor<T> implements BuildTool.Analysi
 
     PostAnalysisQueryEnvironment<T> postAnalysisQueryEnvironment =
         getQueryEnvironment(
-            request, env, topLevelConfigurations, transitiveConfigurations, walkableGraph);
+            request,
+            env,
+            topLevelConfigurations,
+            transitiveConfigurations,
+            topLevelAspects,
+            walkableGraph);
 
     Iterable<NamedThreadSafeOutputFormatterCallback<T>> callbacks =
         postAnalysisQueryEnvironment.getDefaultOutputFormatters(
@@ -217,7 +230,7 @@ public abstract class PostAnalysisQueryProcessor<T> implements BuildTool.Analysi
     }
     callback.start();
     callback.process(aggregateResultsCallback.getResult());
-    callback.close(/*failFast=*/ !result.getSuccess());
+    callback.close(/* failFast= */ !result.getSuccess());
 
     queryRuntimeHelper.afterQueryOutputIsWritten();
   }
diff --git a/src/main/java/com/google/devtools/build/lib/query2/cquery/ConfiguredTargetAccessor.java b/src/main/java/com/google/devtools/build/lib/query2/cquery/ConfiguredTargetAccessor.java
index 049d0929e8..bbea510537 100644
--- a/src/main/java/com/google/devtools/build/lib/query2/cquery/ConfiguredTargetAccessor.java
+++ b/src/main/java/com/google/devtools/build/lib/query2/cquery/ConfiguredTargetAccessor.java
@@ -13,13 +13,16 @@
 // limitations under the License.
 package com.google.devtools.build.lib.query2.cquery;
 
+import static com.google.common.collect.ImmutableListMultimap.toImmutableListMultimap;
 
 import com.google.common.base.Preconditions;
+import com.google.common.base.Suppliers;
 import com.google.common.collect.ImmutableList;
 import com.google.common.collect.ImmutableListMultimap;
 import com.google.common.collect.ImmutableMap;
 import com.google.common.collect.ImmutableSet;
 import com.google.common.collect.Multimaps;
+import com.google.devtools.build.lib.analysis.ConfiguredAspect;
 import com.google.devtools.build.lib.analysis.ConfiguredTarget;
 import com.google.devtools.build.lib.analysis.ConfiguredTargetValue;
 import com.google.devtools.build.lib.analysis.config.ConfigMatchingProvider;
@@ -42,14 +45,17 @@ import com.google.devtools.build.lib.query2.engine.QueryException;
 import com.google.devtools.build.lib.query2.engine.QueryExpression;
 import com.google.devtools.build.lib.query2.engine.QueryVisibility;
 import com.google.devtools.build.lib.server.FailureDetails.ConfigurableQuery;
+import com.google.devtools.build.lib.skyframe.AspectKeyCreator;
 import com.google.devtools.build.lib.skyframe.ConfiguredTargetKey;
 import com.google.devtools.build.skyframe.SkyFunction;
 import com.google.devtools.build.skyframe.SkyValue;
 import com.google.devtools.build.skyframe.WalkableGraph;
 import com.google.devtools.build.skyframe.state.EnvironmentForUtilities;
 import java.util.List;
+import java.util.Map;
 import java.util.Objects;
 import java.util.Set;
+import java.util.function.Supplier;
 
 /**
  * A {@link TargetAccessor} for {@link ConfiguredTarget} objects.
@@ -61,9 +67,13 @@ public class ConfiguredTargetAccessor implements TargetAccessor<CqueryNode> {
   private final WalkableGraph walkableGraph;
   private final ConfiguredTargetQueryEnvironment queryEnvironment;
   private final SkyFunction.LookupEnvironment lookupEnvironment;
+  private final Supplier<ImmutableListMultimap<ConfiguredTargetKey, ConfiguredAspect>>
+      topLevelAspectsByTarget;
 
   public ConfiguredTargetAccessor(
-      WalkableGraph walkableGraph, ConfiguredTargetQueryEnvironment queryEnvironment) {
+      WalkableGraph walkableGraph,
+      ConfiguredTargetQueryEnvironment queryEnvironment,
+      ImmutableMap<AspectKeyCreator.AspectKey, ConfiguredAspect> topLevelAspects) {
     this.walkableGraph = walkableGraph;
     this.queryEnvironment = queryEnvironment;
     this.lookupEnvironment =
@@ -80,6 +90,16 @@ public class ConfiguredTargetAccessor implements TargetAccessor<CqueryNode> {
                     "Thread interrupted in the middle of looking up: " + key, e);
               }
             });
+    this.topLevelAspectsByTarget =
+        queryEnvironment.isSettingEnabled(QueryEnvironment.Setting.INCLUDE_ASPECTS)
+            ? Suppliers.memoize(
+                () ->
+                    topLevelAspects.entrySet().stream()
+                        .collect(
+                            toImmutableListMultimap(
+                                entry -> entry.getKey().getBaseConfiguredTargetKey(),
+                                Map.Entry::getValue)))
+            : Suppliers.ofInstance(ImmutableListMultimap.of());
   }
 
   @Override
@@ -159,7 +179,7 @@ public class ConfiguredTargetAccessor implements TargetAccessor<CqueryNode> {
             rule,
             configConditions,
             keyedConfiguredTarget.getConfigurationChecksum(),
-            /*alwaysSucceed=*/ false);
+            /* alwaysSucceed= */ false);
     if (!attributeMapper.has(attrName)) {
       throw new QueryException(
           caller,
@@ -263,4 +283,12 @@ public class ConfiguredTargetAccessor implements TargetAccessor<CqueryNode> {
                         .build()))
             .getConfiguredTarget();
   }
+
+  /** Returns the top-level aspects applied to the given {@link CqueryNode}. */
+  ImmutableList<ConfiguredAspect> getTopLevelAspects(CqueryNode cn) {
+    if (!(cn.getLookupKey() instanceof ConfiguredTargetKey key)) {
+      return ImmutableList.of();
+    }
+    return topLevelAspectsByTarget.get().get(key);
+  }
 }
diff --git a/src/main/java/com/google/devtools/build/lib/query2/cquery/ConfiguredTargetQueryEnvironment.java b/src/main/java/com/google/devtools/build/lib/query2/cquery/ConfiguredTargetQueryEnvironment.java
index 907d659389..d87e86b6ef 100644
--- a/src/main/java/com/google/devtools/build/lib/query2/cquery/ConfiguredTargetQueryEnvironment.java
+++ b/src/main/java/com/google/devtools/build/lib/query2/cquery/ConfiguredTargetQueryEnvironment.java
@@ -23,6 +23,7 @@ import com.google.common.util.concurrent.Futures;
 import com.google.common.util.concurrent.MoreExecutors;
 import com.google.devtools.build.lib.actions.ActionLookupKey;
 import com.google.devtools.build.lib.analysis.AspectValue;
+import com.google.devtools.build.lib.analysis.ConfiguredAspect;
 import com.google.devtools.build.lib.analysis.ConfiguredTarget;
 import com.google.devtools.build.lib.analysis.ConfiguredTargetValue;
 import com.google.devtools.build.lib.analysis.TopLevelArtifactContext;
@@ -79,6 +80,7 @@ import net.starlark.java.eval.StarlarkSemantics;
 public class ConfiguredTargetQueryEnvironment extends PostAnalysisQueryEnvironment<CqueryNode> {
   /** Common query functions and cquery specific functions. */
   public static final ImmutableList<QueryFunction> FUNCTIONS = populateFunctions();
+
   /** Cquery specific functions. */
   public static final ImmutableList<QueryFunction> CQUERY_FUNCTIONS = getCqueryFunctions();
 
@@ -101,13 +103,13 @@ public class ConfiguredTargetQueryEnvironment extends PostAnalysisQueryEnvironme
       Iterable<QueryFunction> extraFunctions,
       TopLevelConfigurations topLevelConfigurations,
       ImmutableMap<String, BuildConfigurationValue> transitiveConfigurations,
+      ImmutableMap<AspectKey, ConfiguredAspect> topLevelAspects,
       TargetPattern.Parser mainRepoTargetParser,
       PathPackageLocator pkgPath,
       Supplier<WalkableGraph> walkableGraphSupplier,
       Set<Setting> settings,
       TopLevelArtifactContext topLevelArtifactContext,
-      LabelPrinter labelPrinter)
-      throws InterruptedException {
+      LabelPrinter labelPrinter) {
     super(
         keepGoing,
         eventHandler,
@@ -119,7 +121,8 @@ public class ConfiguredTargetQueryEnvironment extends PostAnalysisQueryEnvironme
         walkableGraphSupplier,
         settings,
         labelPrinter);
-    this.accessor = new ConfiguredTargetAccessor(walkableGraphSupplier.get(), this);
+    this.accessor =
+        new ConfiguredTargetAccessor(walkableGraphSupplier.get(), this, topLevelAspects);
     this.configuredTargetKeyExtractor = CqueryNode::getLookupKey;
     this.topLevelArtifactContext = topLevelArtifactContext;
   }
@@ -130,19 +133,20 @@ public class ConfiguredTargetQueryEnvironment extends PostAnalysisQueryEnvironme
       Iterable<QueryFunction> extraFunctions,
       TopLevelConfigurations topLevelConfigurations,
       ImmutableMap<String, BuildConfigurationValue> transitiveConfigurations,
+      ImmutableMap<AspectKey, ConfiguredAspect> topLevelAspects,
       TargetPattern.Parser mainRepoTargetParser,
       PathPackageLocator pkgPath,
       Supplier<WalkableGraph> walkableGraphSupplier,
       CqueryOptions cqueryOptions,
       TopLevelArtifactContext topLevelArtifactContext,
-      LabelPrinter labelPrinter)
-      throws InterruptedException {
+      LabelPrinter labelPrinter) {
     this(
         keepGoing,
         eventHandler,
         extraFunctions,
         topLevelConfigurations,
         transitiveConfigurations,
+        topLevelAspects,
         mainRepoTargetParser,
         pkgPath,
         walkableGraphSupplier,
@@ -322,15 +326,14 @@ public class ConfiguredTargetQueryEnvironment extends PostAnalysisQueryEnvironme
   @Nullable
   protected CqueryNode getValueFromKey(SkyKey key) throws InterruptedException {
     SkyValue value = getConfiguredTargetValue(key);
-    if (value == null) {
-      return null;
-    } else if (value instanceof ConfiguredTargetValue configuredTargetValue) {
-      return configuredTargetValue.getConfiguredTarget();
-    } else if (value instanceof AspectValue && key instanceof AspectKey aspectValue) {
-      return aspectValue;
-    } else {
-      throw new IllegalStateException("unknown value type for CqueryNode");
-    }
+    return switch (value) {
+      case ConfiguredTargetValue configuredTargetValue ->
+          configuredTargetValue.getConfiguredTarget();
+      // The value is intentionally ignored as the key implements CqueryNode.
+      case AspectValue ignored when key instanceof AspectKey aspectKey -> aspectKey;
+      case null -> null;
+      default -> throw new IllegalStateException("unknown value type for CqueryNode");
+    };
   }
 
   /**
diff --git a/src/main/java/com/google/devtools/build/lib/query2/cquery/FilesOutputFormatterCallback.java b/src/main/java/com/google/devtools/build/lib/query2/cquery/FilesOutputFormatterCallback.java
index ced31ea3be..c75085a9d8 100644
--- a/src/main/java/com/google/devtools/build/lib/query2/cquery/FilesOutputFormatterCallback.java
+++ b/src/main/java/com/google/devtools/build/lib/query2/cquery/FilesOutputFormatterCallback.java
@@ -13,6 +13,8 @@
 // limitations under the License.
 package com.google.devtools.build.lib.query2.cquery;
 
+import com.google.common.collect.ImmutableList;
+import com.google.common.collect.Iterables;
 import com.google.devtools.build.lib.actions.Artifact;
 import com.google.devtools.build.lib.analysis.ConfiguredTarget;
 import com.google.devtools.build.lib.analysis.TopLevelArtifactContext;
@@ -41,7 +43,7 @@ public class FilesOutputFormatterCallback extends CqueryThreadsafeCallback {
       TopLevelArtifactContext topLevelArtifactContext) {
     // Different targets may provide the same artifact, so we deduplicate the collection of all
     // results at the end.
-    super(eventHandler, options, out, skyframeExecutor, accessor, /*uniquifyResults=*/ true);
+    super(eventHandler, options, out, skyframeExecutor, accessor, /* uniquifyResults= */ true);
     this.topLevelArtifactContext = topLevelArtifactContext;
   }
 
@@ -60,15 +62,18 @@ public class FilesOutputFormatterCallback extends CqueryThreadsafeCallback {
         continue;
       }
 
-      TopLevelArtifactHelper.getAllArtifactsToBuild(cf, topLevelArtifactContext)
-          .getImportantArtifacts()
-          .toList()
-          .stream()
-          .filter(
-              artifact ->
-                  TopLevelArtifactHelper.shouldDisplay(artifact) || artifact.isSourceArtifact())
-          .map(Artifact::getExecPathString)
-          .forEach(this::addResult);
+      for (var configuredObject :
+          Iterables.concat(ImmutableList.of(cf), accessor.getTopLevelAspects(cf))) {
+        TopLevelArtifactHelper.getAllArtifactsToBuild(configuredObject, topLevelArtifactContext)
+            .getImportantArtifacts()
+            .toList()
+            .stream()
+            .filter(
+                artifact ->
+                    TopLevelArtifactHelper.shouldDisplay(artifact) || artifact.isSourceArtifact())
+            .map(Artifact::getExecPathString)
+            .forEach(this::addResult);
+      }
     }
   }
 }
diff --git a/src/test/java/com/google/devtools/build/lib/query2/aquery/ActionGraphQueryHelper.java b/src/test/java/com/google/devtools/build/lib/query2/aquery/ActionGraphQueryHelper.java
index 0811f918a7..a33a0a667f 100644
--- a/src/test/java/com/google/devtools/build/lib/query2/aquery/ActionGraphQueryHelper.java
+++ b/src/test/java/com/google/devtools/build/lib/query2/aquery/ActionGraphQueryHelper.java
@@ -15,6 +15,7 @@ package com.google.devtools.build.lib.query2.aquery;
 
 import com.google.common.collect.ImmutableList;
 import com.google.common.collect.ImmutableMap;
+import com.google.devtools.build.lib.analysis.ConfiguredAspect;
 import com.google.devtools.build.lib.analysis.ConfiguredTargetValue;
 import com.google.devtools.build.lib.analysis.config.BuildConfigurationValue;
 import com.google.devtools.build.lib.packages.LabelPrinter;
@@ -22,6 +23,7 @@ import com.google.devtools.build.lib.query2.PostAnalysisQueryEnvironment;
 import com.google.devtools.build.lib.query2.PostAnalysisQueryEnvironment.TopLevelConfigurations;
 import com.google.devtools.build.lib.query2.engine.QueryEnvironment.QueryFunction;
 import com.google.devtools.build.lib.query2.testutil.PostAnalysisQueryHelper;
+import com.google.devtools.build.lib.skyframe.AspectKeyCreator;
 import com.google.devtools.build.skyframe.WalkableGraph;
 
 /** Helper class for aquery test */
@@ -31,7 +33,8 @@ public class ActionGraphQueryHelper extends PostAnalysisQueryHelper<ConfiguredTa
   protected PostAnalysisQueryEnvironment<ConfiguredTargetValue> getPostAnalysisQueryEnvironment(
       WalkableGraph walkableGraph,
       TopLevelConfigurations topLevelConfigurations,
-      ImmutableMap<String, BuildConfigurationValue> transitiveConfigurations) {
+      ImmutableMap<String, BuildConfigurationValue> transitiveConfigurations,
+      ImmutableMap<AspectKeyCreator.AspectKey, ConfiguredAspect> topLevelAspects) {
     ImmutableList<QueryFunction> extraFunctions =
         ImmutableList.copyOf(ActionGraphQueryEnvironment.AQUERY_FUNCTIONS);
     return new ActionGraphQueryEnvironment(
diff --git a/src/test/java/com/google/devtools/build/lib/query2/aquery/BUILD b/src/test/java/com/google/devtools/build/lib/query2/aquery/BUILD
index 4a5a36be54..683c109f63 100644
--- a/src/test/java/com/google/devtools/build/lib/query2/aquery/BUILD
+++ b/src/test/java/com/google/devtools/build/lib/query2/aquery/BUILD
@@ -16,11 +16,13 @@ java_library(
     testonly = 1,
     srcs = ["ActionGraphQueryHelper.java"],
     deps = [
+        "//src/main/java/com/google/devtools/build/lib/analysis:analysis_cluster",
         "//src/main/java/com/google/devtools/build/lib/analysis:configured_target_value",
         "//src/main/java/com/google/devtools/build/lib/analysis/config:build_configuration",
         "//src/main/java/com/google/devtools/build/lib/packages:label_printer",
         "//src/main/java/com/google/devtools/build/lib/query2",
         "//src/main/java/com/google/devtools/build/lib/query2/engine",
+        "//src/main/java/com/google/devtools/build/lib/skyframe:aspect_key_creator",
         "//src/main/java/com/google/devtools/build/skyframe",
         "//src/test/java/com/google/devtools/build/lib/query2/testutil",
         "//third_party:guava",
diff --git a/src/test/java/com/google/devtools/build/lib/query2/cquery/BUILD b/src/test/java/com/google/devtools/build/lib/query2/cquery/BUILD
index f322b2dcfd..b273a23c84 100644
--- a/src/test/java/com/google/devtools/build/lib/query2/cquery/BUILD
+++ b/src/test/java/com/google/devtools/build/lib/query2/cquery/BUILD
@@ -100,11 +100,13 @@ java_library(
     testonly = 1,
     srcs = ["ConfiguredTargetQueryHelper.java"],
     deps = [
+        "//src/main/java/com/google/devtools/build/lib/analysis:analysis_cluster",
         "//src/main/java/com/google/devtools/build/lib/analysis/config:build_configuration",
         "//src/main/java/com/google/devtools/build/lib/packages:label_printer",
         "//src/main/java/com/google/devtools/build/lib/query2",
         "//src/main/java/com/google/devtools/build/lib/query2/common:cquery-node",
         "//src/main/java/com/google/devtools/build/lib/query2/engine",
+        "//src/main/java/com/google/devtools/build/lib/skyframe:aspect_key_creator",
         "//src/main/java/com/google/devtools/build/skyframe",
         "//src/test/java/com/google/devtools/build/lib/analysis/util",
         "//src/test/java/com/google/devtools/build/lib/query2/testutil",
diff --git a/src/test/java/com/google/devtools/build/lib/query2/cquery/ConfiguredTargetQueryHelper.java b/src/test/java/com/google/devtools/build/lib/query2/cquery/ConfiguredTargetQueryHelper.java
index 862ea21c57..25a48d9bab 100644
--- a/src/test/java/com/google/devtools/build/lib/query2/cquery/ConfiguredTargetQueryHelper.java
+++ b/src/test/java/com/google/devtools/build/lib/query2/cquery/ConfiguredTargetQueryHelper.java
@@ -15,6 +15,7 @@ package com.google.devtools.build.lib.query2.cquery;
 
 import com.google.common.collect.ImmutableList;
 import com.google.common.collect.ImmutableMap;
+import com.google.devtools.build.lib.analysis.ConfiguredAspect;
 import com.google.devtools.build.lib.analysis.config.BuildConfigurationValue;
 import com.google.devtools.build.lib.analysis.util.AnalysisTestCase;
 import com.google.devtools.build.lib.packages.LabelPrinter;
@@ -23,6 +24,7 @@ import com.google.devtools.build.lib.query2.common.CqueryNode;
 import com.google.devtools.build.lib.query2.engine.QueryEnvironment.QueryFunction;
 import com.google.devtools.build.lib.query2.testutil.AbstractQueryTest.QueryHelper;
 import com.google.devtools.build.lib.query2.testutil.PostAnalysisQueryHelper;
+import com.google.devtools.build.lib.skyframe.AspectKeyCreator;
 import com.google.devtools.build.skyframe.WalkableGraph;
 
 /**
@@ -37,8 +39,8 @@ public class ConfiguredTargetQueryHelper extends PostAnalysisQueryHelper<CqueryN
   protected ConfiguredTargetQueryEnvironment getPostAnalysisQueryEnvironment(
       WalkableGraph walkableGraph,
       TopLevelConfigurations topLevelConfigurations,
-      ImmutableMap<String, BuildConfigurationValue> transitiveConfigurations)
-      throws InterruptedException {
+      ImmutableMap<String, BuildConfigurationValue> transitiveConfigurations,
+      ImmutableMap<AspectKeyCreator.AspectKey, ConfiguredAspect> topLevelAspects) {
     ImmutableList<QueryFunction> extraFunctions =
         ImmutableList.copyOf(ConfiguredTargetQueryEnvironment.CQUERY_FUNCTIONS);
     return new ConfiguredTargetQueryEnvironment(
@@ -47,6 +49,7 @@ public class ConfiguredTargetQueryHelper extends PostAnalysisQueryHelper<CqueryN
         extraFunctions,
         topLevelConfigurations,
         transitiveConfigurations,
+        topLevelAspects,
         mainRepoTargetParser,
         analysisHelper.getPackageManager().getPackagePath(),
         () -> walkableGraph,
diff --git a/src/test/java/com/google/devtools/build/lib/query2/cquery/FilesOutputFormatterCallbackTest.java b/src/test/java/com/google/devtools/build/lib/query2/cquery/FilesOutputFormatterCallbackTest.java
index 5b1c0862ca..8b25bfa8bf 100644
--- a/src/test/java/com/google/devtools/build/lib/query2/cquery/FilesOutputFormatterCallbackTest.java
+++ b/src/test/java/com/google/devtools/build/lib/query2/cquery/FilesOutputFormatterCallbackTest.java
@@ -13,6 +13,7 @@
 // limitations under the License.
 package com.google.devtools.build.lib.query2.cquery;
 
+import static com.google.common.collect.ImmutableList.toImmutableList;
 import static com.google.common.truth.Truth.assertThat;
 import static java.nio.charset.StandardCharsets.UTF_8;
 
@@ -24,6 +25,7 @@ import com.google.devtools.build.lib.analysis.TopLevelArtifactContext;
 import com.google.devtools.build.lib.events.Reporter;
 import com.google.devtools.build.lib.query2.PostAnalysisQueryEnvironment;
 import com.google.devtools.build.lib.query2.common.CqueryNode;
+import com.google.devtools.build.lib.query2.engine.QueryEnvironment;
 import com.google.devtools.build.lib.query2.engine.QueryExpression;
 import com.google.devtools.build.lib.query2.engine.QueryParser;
 import java.io.ByteArrayOutputStream;
@@ -32,6 +34,7 @@ import java.util.Arrays;
 import java.util.LinkedHashSet;
 import java.util.List;
 import java.util.Set;
+import java.util.regex.Pattern;
 import java.util.stream.Collectors;
 import org.junit.Before;
 import org.junit.Test;
@@ -46,43 +49,77 @@ public final class FilesOutputFormatterCallbackTest extends ConfiguredTargetQuer
   public void defineSimpleRule() throws Exception {
     writeFile(
         "defs/rules.bzl",
-        "def _r_impl(ctx):",
-        "    default_file = ctx.actions.declare_file(ctx.attr.name + '_default_file')",
-        "    output_group_only = ctx.actions.declare_file(ctx.attr.name + '_output_group_only')",
-        "    runfile = ctx.actions.declare_file(ctx.attr.name + '_runfile')",
-        "    executable_only = ctx.actions.declare_file(ctx.attr.name + '_executable')",
-        "    files = [default_file, output_group_only, runfile, executable_only]",
-        "    ctx.actions.run_shell(",
-        "        outputs = files,",
-        "        command = '\\n'.join(['touch %s' % file.path for file in files]),",
-        "    )",
-        "    return [",
-        "        DefaultInfo(",
-        "            executable = executable_only,",
-        "            files = depset(",
-        "                direct = [",
-        "                    default_file,",
-        "                    ctx.file._implicit_source_dep,",
-        "                    ctx.file.explicit_source_dep,",
-        "                ],",
-        "                transitive = [info[DefaultInfo].files for info in ctx.attr.deps]",
-        "            ),",
-        "            runfiles = ctx.runfiles([runfile]),",
-        "        ),",
-        "        OutputGroupInfo(",
-        "            foobar = [output_group_only, ctx.file.explicit_source_dep],",
-        "        ),",
-        "    ]",
-        "r = rule(",
-        "    implementation = _r_impl,",
-        "    executable = True,",
-        "    attrs = {",
-        "        'deps': attr.label_list(),",
-        "        '_implicit_source_dep': attr.label(default = 'rules.bzl', allow_single_file ="
-            + " True),",
-        "        'explicit_source_dep': attr.label(allow_single_file = True),",
-        "    },",
-        ")");
+        """
+        AspectInfo = provider()
+        def _r_impl(ctx):
+            default_file = ctx.actions.declare_file(ctx.attr.name + '_default_file')
+            output_group_only = ctx.actions.declare_file(ctx.attr.name + '_output_group_only')
+            runfile = ctx.actions.declare_file(ctx.attr.name + '_runfile')
+            executable_only = ctx.actions.declare_file(ctx.attr.name + '_executable')
+            files = [default_file, output_group_only, runfile, executable_only]
+            ctx.actions.run_shell(
+                outputs = files,
+                command = '\\n'.join(['touch %s' % file.path for file in files]),
+            )
+            return [
+                DefaultInfo(
+                    executable = executable_only,
+                    files = depset(
+                        direct = [
+                            default_file,
+                            ctx.file._implicit_source_dep,
+                            ctx.file.explicit_source_dep,
+                        ],
+                        transitive = [info[DefaultInfo].files for info in ctx.attr.deps]
+                    ),
+                    runfiles = ctx.runfiles([runfile]),
+                ),
+                OutputGroupInfo(
+                    foobar = [output_group_only, ctx.file.explicit_source_dep],
+                ),
+            ]
+        r = rule(
+            implementation = _r_impl,
+            executable = True,
+            attrs = {
+                'deps': attr.label_list(),
+                '_implicit_source_dep': attr.label(default = 'rules.bzl', allow_single_file = True),
+                'explicit_source_dep': attr.label(allow_single_file = True),
+            },
+        )
+        def _a_impl(target, ctx):
+            custom_output_group = ctx.actions.declare_file(target.label.name + '_custom_aspect_a_file')
+            shared_output_group = ctx.actions.declare_file(target.label.name + '_shared_aspect_a_file')
+            ctx.actions.run_shell(
+                outputs = [custom_output_group, shared_output_group],
+                command = "touch %s && touch %s" % (custom_output_group.path, shared_output_group.path),
+            )
+            return [
+                OutputGroupInfo(
+                    aspect_files = depset([custom_output_group]),
+                    foobar = depset([shared_output_group]),
+                ),
+                # Collides with aspect b.
+                AspectInfo(),
+            ]
+        a = aspect(implementation = _a_impl)
+        def _b_impl(target, ctx):
+            custom_output_group = ctx.actions.declare_file(target.label.name + '_custom_aspect_b_file')
+            shared_output_group = ctx.actions.declare_file(target.label.name + '_shared_aspect_b_file')
+            ctx.actions.run_shell(
+                outputs = [custom_output_group, shared_output_group],
+                command = "touch %s && touch %s" % (custom_output_group.path, shared_output_group.path),
+            )
+            return [
+                OutputGroupInfo(
+                    aspect_files = depset([custom_output_group]),
+                    foobar = depset([shared_output_group]),
+                ),
+                # Collides with aspect a.
+                AspectInfo(),
+            ]
+        b = aspect(implementation = _b_impl)
+        """);
     writeFile("defs/BUILD", "exports_files(['rules.bzl'])");
     writeFile(
         "pkg/BUILD",
@@ -102,13 +139,14 @@ public final class FilesOutputFormatterCallbackTest extends ConfiguredTargetQuer
         """);
   }
 
-  private List<String> getOutput(String queryExpression, List<String> outputGroups)
-      throws Exception {
+  private ImmutableList<String> getOutput(
+      String queryExpression, List<String> outputGroups, String... aspects) throws Exception {
     QueryExpression expression = QueryParser.parse(queryExpression, getDefaultFunctions());
     Set<String> targetPatternSet = new LinkedHashSet<>();
     expression.collectTargetPatterns(targetPatternSet);
     PostAnalysisQueryEnvironment<CqueryNode> env =
-        ((ConfiguredTargetQueryHelper) helper).getPostAnalysisQueryEnvironment(targetPatternSet);
+        ((ConfiguredTargetQueryHelper) helper)
+            .getPostAnalysisQueryEnvironment(targetPatternSet, Arrays.asList(aspects));
 
     ByteArrayOutputStream output = new ByteArrayOutputStream();
     FilesOutputFormatterCallback callback =
@@ -124,7 +162,10 @@ public final class FilesOutputFormatterCallbackTest extends ConfiguredTargetQuer
                 false,
                 OutputGroupInfo.determineOutputGroups(outputGroups, ValidationMode.OFF, false)));
     env.evaluateQuery(expression, callback);
-    return Arrays.asList(output.toString(UTF_8).split("\n"));
+    return Pattern.compile("\n")
+        .splitAsStream(output.toString(UTF_8))
+        .filter(line -> !line.isEmpty())
+        .collect(toImmutableList());
   }
 
   @Test
@@ -160,6 +201,85 @@ public final class FilesOutputFormatterCallbackTest extends ConfiguredTargetQuer
         sourceAndGeneratedFiles.get(true), "pkg/other_output_group_only");
   }
 
+  @Test
+  public void withAspect_customOutputGroupOnly() throws Exception {
+    helper.setQuerySettings(QueryEnvironment.Setting.INCLUDE_ASPECTS);
+    List<String> output =
+        getOutput("//pkg:other", ImmutableList.of("aspect_files"), "//defs:rules.bzl%a");
+    var sourceAndGeneratedFiles =
+        output.stream()
+            .collect(Collectors.<String>partitioningBy(path -> path.matches("^[^/]*-out/.*")));
+    assertThat(sourceAndGeneratedFiles.get(false)).isEmpty();
+    assertContainsExactlyWithBinDirPrefix(
+        sourceAndGeneratedFiles.get(true), "pkg/other_custom_aspect_a_file");
+  }
+
+  @Test
+  public void withAspect_sharedOutputGroupOnly() throws Exception {
+    helper.setQuerySettings(QueryEnvironment.Setting.INCLUDE_ASPECTS);
+    List<String> output =
+        getOutput("//pkg:other", ImmutableList.of("foobar"), "//defs:rules.bzl%a");
+    var sourceAndGeneratedFiles =
+        output.stream()
+            .collect(Collectors.<String>partitioningBy(path -> path.matches("^[^/]*-out/.*")));
+    assertThat(sourceAndGeneratedFiles.get(false)).containsExactly("pkg/BUILD");
+    assertContainsExactlyWithBinDirPrefix(
+        sourceAndGeneratedFiles.get(true),
+        "pkg/other_output_group_only",
+        "pkg/other_shared_aspect_a_file");
+  }
+
+  @Test
+  public void withAspects_customOutputGroupOnly() throws Exception {
+    helper.setQuerySettings(QueryEnvironment.Setting.INCLUDE_ASPECTS);
+    List<String> output =
+        getOutput(
+            "//pkg:other",
+            ImmutableList.of("aspect_files"),
+            "//defs:rules.bzl%a",
+            "//defs:rules.bzl%b");
+    var sourceAndGeneratedFiles =
+        output.stream()
+            .collect(Collectors.<String>partitioningBy(path -> path.matches("^[^/]*-out/.*")));
+    assertThat(sourceAndGeneratedFiles.get(false)).isEmpty();
+    assertContainsExactlyWithBinDirPrefix(
+        sourceAndGeneratedFiles.get(true),
+        "pkg/other_custom_aspect_b_file",
+        "pkg/other_custom_aspect_a_file");
+  }
+
+  @Test
+  public void withAspects_sharedOutputGroupOnly() throws Exception {
+    helper.setQuerySettings(QueryEnvironment.Setting.INCLUDE_ASPECTS);
+    List<String> output =
+        getOutput(
+            "//pkg:other", ImmutableList.of("foobar"), "//defs:rules.bzl%a", "//defs:rules.bzl%b");
+    var sourceAndGeneratedFiles =
+        output.stream()
+            .collect(Collectors.<String>partitioningBy(path -> path.matches("^[^/]*-out/.*")));
+    assertThat(sourceAndGeneratedFiles.get(false)).containsExactly("pkg/BUILD");
+    assertContainsExactlyWithBinDirPrefix(
+        sourceAndGeneratedFiles.get(true),
+        "pkg/other_output_group_only",
+        "pkg/other_shared_aspect_b_file",
+        "pkg/other_shared_aspect_a_file");
+  }
+
+  @Test
+  public void withAspects_noIncludeAspects() throws Exception {
+    // Explicitly omit INCLUDE_ASPECTS.
+    helper.setQuerySettings();
+    List<String> output =
+        getOutput(
+            "//pkg:other", ImmutableList.of("foobar"), "//defs:rules.bzl%a", "//defs:rules.bzl%b");
+    var sourceAndGeneratedFiles =
+        output.stream()
+            .collect(Collectors.<String>partitioningBy(path -> path.matches("^[^/]*-out/.*")));
+    assertThat(sourceAndGeneratedFiles.get(false)).containsExactly("pkg/BUILD");
+    assertContainsExactlyWithBinDirPrefix(
+        sourceAndGeneratedFiles.get(true), "pkg/other_output_group_only");
+  }
+
   private static void assertContainsExactlyWithBinDirPrefix(
       List<String> output, String... binDirRelativePaths) {
     if (binDirRelativePaths.length == 0) {
diff --git a/src/test/java/com/google/devtools/build/lib/query2/testutil/BUILD b/src/test/java/com/google/devtools/build/lib/query2/testutil/BUILD
index 16445444bc..52a8f1886e 100644
--- a/src/test/java/com/google/devtools/build/lib/query2/testutil/BUILD
+++ b/src/test/java/com/google/devtools/build/lib/query2/testutil/BUILD
@@ -44,6 +44,7 @@ java_library(
         "//src/main/java/com/google/devtools/build/lib/query2/common:abstract-blaze-query-env",
         "//src/main/java/com/google/devtools/build/lib/query2/common:universe-scope",
         "//src/main/java/com/google/devtools/build/lib/query2/engine",
+        "//src/main/java/com/google/devtools/build/lib/skyframe:aspect_key_creator",
         "//src/main/java/com/google/devtools/build/lib/skyframe:precomputed_value",
         "//src/main/java/com/google/devtools/build/lib/skyframe:skyframe_cluster",
         "//src/main/java/com/google/devtools/build/lib/skyframe/packages:PackageFactoryBuilderWithSkyframeForTesting",
diff --git a/src/test/java/com/google/devtools/build/lib/query2/testutil/PostAnalysisQueryHelper.java b/src/test/java/com/google/devtools/build/lib/query2/testutil/PostAnalysisQueryHelper.java
index 4ccf026d28..070cb69f78 100644
--- a/src/test/java/com/google/devtools/build/lib/query2/testutil/PostAnalysisQueryHelper.java
+++ b/src/test/java/com/google/devtools/build/lib/query2/testutil/PostAnalysisQueryHelper.java
@@ -20,6 +20,7 @@ import com.google.common.collect.ImmutableList;
 import com.google.common.collect.ImmutableMap;
 import com.google.common.collect.Lists;
 import com.google.devtools.build.lib.analysis.AnalysisResult;
+import com.google.devtools.build.lib.analysis.ConfiguredAspect;
 import com.google.devtools.build.lib.analysis.ConfiguredRuleClassProvider;
 import com.google.devtools.build.lib.analysis.config.BuildConfigurationValue;
 import com.google.devtools.build.lib.analysis.util.AnalysisTestCase;
@@ -43,6 +44,7 @@ import com.google.devtools.build.lib.query2.engine.QueryUtil;
 import com.google.devtools.build.lib.query2.engine.QueryUtil.AggregateAllOutputFormatterCallback;
 import com.google.devtools.build.lib.query2.testutil.AbstractQueryTest.QueryHelper;
 import com.google.devtools.build.lib.server.FailureDetails.Query;
+import com.google.devtools.build.lib.skyframe.AspectKeyCreator;
 import com.google.devtools.build.lib.skyframe.SkyframeExecutor;
 import com.google.devtools.build.lib.skyframe.SkyframeExecutorWrappingWalkableGraph;
 import com.google.devtools.build.lib.testutil.Scratch;
@@ -198,6 +200,11 @@ public abstract class PostAnalysisQueryHelper<T> extends AbstractQueryHelper<T>
 
   public PostAnalysisQueryEnvironment<T> getPostAnalysisQueryEnvironment(
       Collection<String> universe) throws Exception {
+    return getPostAnalysisQueryEnvironment(universe, ImmutableList.of());
+  }
+
+  public PostAnalysisQueryEnvironment<T> getPostAnalysisQueryEnvironment(
+      Collection<String> universe, Iterable<String> aspects) throws Exception {
     if (ImmutableList.copyOf(universe)
         .equals(ImmutableList.of(PostAnalysisQueryTest.DEFAULT_UNIVERSE))) {
       throw new QueryException(
@@ -205,8 +212,8 @@ public abstract class PostAnalysisQueryHelper<T> extends AbstractQueryHelper<T>
               + "or setting explicitly through query helper.",
           Query.Code.QUERY_UNKNOWN);
     }
-    AnalysisResult analysisResult;
-    analysisResult = analysisHelper.update(universe.toArray(new String[0]));
+    AnalysisResult analysisResult =
+        analysisHelper.update(ImmutableList.copyOf(aspects), universe.toArray(new String[0]));
     WalkableGraph walkableGraph =
         SkyframeExecutorWrappingWalkableGraph.of(analysisHelper.getSkyframeExecutor());
     ImmutableMap<String, BuildConfigurationValue> transitiveConfigurations =
@@ -216,7 +223,8 @@ public abstract class PostAnalysisQueryHelper<T> extends AbstractQueryHelper<T>
     return getPostAnalysisQueryEnvironment(
         walkableGraph,
         new TopLevelConfigurations(analysisResult.getTopLevelTargetsWithConfigs()),
-        transitiveConfigurations);
+        transitiveConfigurations,
+        analysisResult.getAspectsMap());
   }
 
   private static ImmutableMap<String, BuildConfigurationValue> getTransitiveConfigurations(
@@ -240,11 +248,13 @@ public abstract class PostAnalysisQueryHelper<T> extends AbstractQueryHelper<T>
    * @param transitiveConfigurations all configurations available in the build graph (including
    *     those produced by configuration transitions in the top-level targets' transitive deps),
    *     keyed by the configurations' checksums
+   * @param topLevelAspects the top-level aspects to apply
    */
   protected abstract PostAnalysisQueryEnvironment<T> getPostAnalysisQueryEnvironment(
       WalkableGraph walkableGraph,
       TopLevelConfigurations topLevelConfigurations,
-      ImmutableMap<String, BuildConfigurationValue> transitiveConfigurations)
+      ImmutableMap<String, BuildConfigurationValue> transitiveConfigurations,
+      ImmutableMap<AspectKeyCreator.AspectKey, ConfiguredAspect> topLevelAspects)
       throws InterruptedException;
 
   @Override
@@ -331,8 +341,9 @@ public abstract class PostAnalysisQueryHelper<T> extends AbstractQueryHelper<T>
     }
 
     @Override
-    protected AnalysisResult update(String... labels) throws Exception {
-      return super.update(labels);
+    protected AnalysisResult update(ImmutableList<String> aspects, String... labels)
+        throws Exception {
+      return super.update(aspects, labels);
     }
 
     protected SkyframeExecutor getSkyframeExecutor() {
