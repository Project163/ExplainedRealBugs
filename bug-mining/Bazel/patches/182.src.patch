diff --git a/src/main/java/com/google/devtools/build/lib/actions/AbstractAction.java b/src/main/java/com/google/devtools/build/lib/actions/AbstractAction.java
index 6b8dcb74f0..2d4eda3a73 100644
--- a/src/main/java/com/google/devtools/build/lib/actions/AbstractAction.java
+++ b/src/main/java/com/google/devtools/build/lib/actions/AbstractAction.java
@@ -368,13 +368,9 @@ public abstract class AbstractAction extends ActionKeyComputer implements Action
   private String replaceProgressMessagePlaceholders(
       String progressMessage, @Nullable RepositoryMapping mainRepositoryMapping) {
     if (progressMessage.contains("%{label}") && owner.getLabel() != null) {
-      String labelString;
-      if (mainRepositoryMapping != null) {
-        labelString = owner.getLabel().getDisplayForm(mainRepositoryMapping);
-      } else {
-        labelString = owner.getLabel().toString();
-      }
-      progressMessage = progressMessage.replace("%{label}", labelString);
+      progressMessage =
+          progressMessage.replace(
+              "%{label}", owner.getLabel().getDisplayForm(mainRepositoryMapping));
     }
     if (progressMessage.contains("%{output}") && getPrimaryOutput() != null) {
       progressMessage =
diff --git a/src/main/java/com/google/devtools/build/lib/analysis/BazelRuleAnalysisThreadContext.java b/src/main/java/com/google/devtools/build/lib/analysis/BazelRuleAnalysisThreadContext.java
index 21767620d4..ff214d1ab7 100644
--- a/src/main/java/com/google/devtools/build/lib/analysis/BazelRuleAnalysisThreadContext.java
+++ b/src/main/java/com/google/devtools/build/lib/analysis/BazelRuleAnalysisThreadContext.java
@@ -14,8 +14,8 @@
 
 package com.google.devtools.build.lib.analysis;
 
+import com.google.devtools.build.lib.cmdline.BazelStarlarkContext;
 import com.google.devtools.build.lib.cmdline.Label;
-import com.google.devtools.build.lib.packages.BazelStarlarkContext;
 import com.google.errorprone.annotations.CanIgnoreReturnValue;
 import javax.annotation.Nullable;
 import net.starlark.java.eval.EvalException;
@@ -33,7 +33,7 @@ public class BazelRuleAnalysisThreadContext extends BazelStarlarkContext {
    * @param ruleContext is the {@link RuleContext} of the rule for analysis of a rule or aspect
    */
   public BazelRuleAnalysisThreadContext(RuleContext ruleContext) {
-    super(Phase.ANALYSIS);
+    super(Phase.ANALYSIS, ruleContext.getAnalysisEnvironment()::getMainRepoMapping);
     this.ruleContext = ruleContext;
   }
 
diff --git a/src/main/java/com/google/devtools/build/lib/analysis/config/StarlarkDefinedConfigTransition.java b/src/main/java/com/google/devtools/build/lib/analysis/config/StarlarkDefinedConfigTransition.java
index 77c39d9f18..6eff8d3ecc 100644
--- a/src/main/java/com/google/devtools/build/lib/analysis/config/StarlarkDefinedConfigTransition.java
+++ b/src/main/java/com/google/devtools/build/lib/analysis/config/StarlarkDefinedConfigTransition.java
@@ -31,14 +31,14 @@ import com.google.devtools.build.lib.analysis.config.CoreOptions.IncludeConfigFr
 import com.google.devtools.build.lib.analysis.config.CoreOptions.OutputDirectoryNamingScheme;
 import com.google.devtools.build.lib.analysis.config.CoreOptions.OutputPathsMode;
 import com.google.devtools.build.lib.analysis.config.transitions.PatchTransition;
+import com.google.devtools.build.lib.cmdline.BazelStarlarkContext;
+import com.google.devtools.build.lib.cmdline.BazelStarlarkContext.Phase;
 import com.google.devtools.build.lib.cmdline.Label;
 import com.google.devtools.build.lib.cmdline.Label.PackageContext;
 import com.google.devtools.build.lib.cmdline.LabelSyntaxException;
 import com.google.devtools.build.lib.cmdline.RepositoryMapping;
 import com.google.devtools.build.lib.events.Event;
 import com.google.devtools.build.lib.events.EventHandler;
-import com.google.devtools.build.lib.packages.BazelStarlarkContext;
-import com.google.devtools.build.lib.packages.BazelStarlarkContext.Phase;
 import com.google.devtools.build.lib.packages.Rule;
 import com.google.devtools.build.lib.packages.RuleTransitionData;
 import com.google.devtools.build.lib.packages.StructImpl;
@@ -552,7 +552,7 @@ public abstract class StarlarkDefinedConfigTransition implements ConfigurationTr
         // Create a new {@link BazelStarlarkContext} for the new thread. We need to
         // create a new context every time because {@link BazelStarlarkContext}s
         // should be confined to a single thread.
-        new BazelStarlarkContext(Phase.ANALYSIS).storeInThread(thread);
+        new BazelStarlarkContext(Phase.ANALYSIS, /* mainRepoMapping= */ null).storeInThread(thread);
 
         result =
             Starlark.fastcall(
diff --git a/src/main/java/com/google/devtools/build/lib/analysis/configuredtargets/RuleConfiguredTarget.java b/src/main/java/com/google/devtools/build/lib/analysis/configuredtargets/RuleConfiguredTarget.java
index d44f51037a..1ad0e808df 100644
--- a/src/main/java/com/google/devtools/build/lib/analysis/configuredtargets/RuleConfiguredTarget.java
+++ b/src/main/java/com/google/devtools/build/lib/analysis/configuredtargets/RuleConfiguredTarget.java
@@ -55,7 +55,7 @@ import javax.annotation.Nullable;
 import net.starlark.java.eval.Dict;
 import net.starlark.java.eval.Printer;
 import net.starlark.java.eval.Starlark;
-import net.starlark.java.eval.StarlarkSemantics;
+import net.starlark.java.eval.StarlarkThread;
 
 /**
  * A {@link com.google.devtools.build.lib.analysis.ConfiguredTarget} that is produced by a rule.
@@ -254,7 +254,7 @@ public final class RuleConfiguredTarget extends AbstractConfiguredTarget {
   }
 
   @Override
-  public void debugPrint(Printer printer, StarlarkSemantics semantics) {
+  public void debugPrint(Printer printer, StarlarkThread thread) {
     // Show the names of the provider keys that this target propagates.
     // Provider key names might potentially be *private* information, and thus a comprehensive
     // list of provider keys should not be exposed in any way other than for debug information.
diff --git a/src/main/java/com/google/devtools/build/lib/analysis/starlark/Args.java b/src/main/java/com/google/devtools/build/lib/analysis/starlark/Args.java
index cade026c9e..b451eb528c 100644
--- a/src/main/java/com/google/devtools/build/lib/analysis/starlark/Args.java
+++ b/src/main/java/com/google/devtools/build/lib/analysis/starlark/Args.java
@@ -71,7 +71,7 @@ public abstract class Args implements CommandLineArgsApi {
   }
 
   @Override
-  public void debugPrint(Printer printer, StarlarkSemantics semantics) {
+  public void debugPrint(Printer printer, StarlarkThread thread) {
     try {
       printer.append(
           Joiner.on(" ").join(build(/* mainRepoMappingSupplier= */ () -> null).arguments()));
diff --git a/src/main/java/com/google/devtools/build/lib/analysis/starlark/StarlarkRuleClassFunctions.java b/src/main/java/com/google/devtools/build/lib/analysis/starlark/StarlarkRuleClassFunctions.java
index b7ed56111a..02d2a8227d 100644
--- a/src/main/java/com/google/devtools/build/lib/analysis/starlark/StarlarkRuleClassFunctions.java
+++ b/src/main/java/com/google/devtools/build/lib/analysis/starlark/StarlarkRuleClassFunctions.java
@@ -54,6 +54,7 @@ import com.google.devtools.build.lib.analysis.platform.ConstraintValueInfo;
 import com.google.devtools.build.lib.analysis.starlark.StarlarkAttrModule.Descriptor;
 import com.google.devtools.build.lib.analysis.test.TestConfiguration;
 import com.google.devtools.build.lib.cmdline.BazelModuleContext;
+import com.google.devtools.build.lib.cmdline.BazelStarlarkContext;
 import com.google.devtools.build.lib.cmdline.Label;
 import com.google.devtools.build.lib.cmdline.LabelSyntaxException;
 import com.google.devtools.build.lib.cmdline.RepositoryMapping;
@@ -66,7 +67,6 @@ import com.google.devtools.build.lib.packages.Attribute;
 import com.google.devtools.build.lib.packages.Attribute.StarlarkComputedDefaultTemplate;
 import com.google.devtools.build.lib.packages.AttributeTransitionData;
 import com.google.devtools.build.lib.packages.AttributeValueSource;
-import com.google.devtools.build.lib.packages.BazelStarlarkContext;
 import com.google.devtools.build.lib.packages.BuildSetting;
 import com.google.devtools.build.lib.packages.BuildType;
 import com.google.devtools.build.lib.packages.BuiltinRestriction;
diff --git a/src/main/java/com/google/devtools/build/lib/bazel/bzlmod/BazelModuleResolutionValue.java b/src/main/java/com/google/devtools/build/lib/bazel/bzlmod/BazelModuleResolutionValue.java
index 5b1d45e5ab..3dc6849db4 100644
--- a/src/main/java/com/google/devtools/build/lib/bazel/bzlmod/BazelModuleResolutionValue.java
+++ b/src/main/java/com/google/devtools/build/lib/bazel/bzlmod/BazelModuleResolutionValue.java
@@ -29,7 +29,7 @@ import java.util.Optional;
  * graphs.
  */
 @AutoValue
-abstract class BazelModuleResolutionValue implements SkyValue {
+public abstract class BazelModuleResolutionValue implements SkyValue {
 
   @SerializationConstant
   public static final SkyKey KEY = () -> SkyFunctions.BAZEL_MODULE_RESOLUTION;
diff --git a/src/main/java/com/google/devtools/build/lib/bazel/bzlmod/ModuleFileValue.java b/src/main/java/com/google/devtools/build/lib/bazel/bzlmod/ModuleFileValue.java
index da64efb9ff..c6a8d08bea 100644
--- a/src/main/java/com/google/devtools/build/lib/bazel/bzlmod/ModuleFileValue.java
+++ b/src/main/java/com/google/devtools/build/lib/bazel/bzlmod/ModuleFileValue.java
@@ -117,7 +117,7 @@ public abstract class ModuleFileValue implements SkyValue {
   /** {@link SkyKey} for {@link ModuleFileValue} computation. */
   @AutoCodec
   @AutoValue
-  abstract static class Key implements SkyKey {
+  public abstract static class Key implements SkyKey {
     private static final SkyKeyInterner<Key> interner = SkyKey.newInterner();
 
     abstract ModuleKey getModuleKey();
diff --git a/src/main/java/com/google/devtools/build/lib/bazel/bzlmod/NonRegistryOverride.java b/src/main/java/com/google/devtools/build/lib/bazel/bzlmod/NonRegistryOverride.java
index 8ec22314e9..a5464d828a 100644
--- a/src/main/java/com/google/devtools/build/lib/bazel/bzlmod/NonRegistryOverride.java
+++ b/src/main/java/com/google/devtools/build/lib/bazel/bzlmod/NonRegistryOverride.java
@@ -15,6 +15,7 @@
 
 package com.google.devtools.build.lib.bazel.bzlmod;
 
+import com.google.common.collect.ImmutableSet;
 import com.google.devtools.build.lib.bazel.bzlmod.BazelModuleInspectorValue.AugmentedModule.ResolutionReason;
 
 /**
@@ -25,6 +26,14 @@ import com.google.devtools.build.lib.bazel.bzlmod.BazelModuleInspectorValue.Augm
  */
 public interface NonRegistryOverride extends ModuleOverride {
 
+  // Starlark rules loaded from bazel_tools that may define Bazel module repositories with
+  // non-registry overrides and thus must be loaded without relying on any other modules or the main
+  // repo mapping.
+  ImmutableSet<String> BOOTSTRAP_RULE_CLASSES =
+      ImmutableSet.of(
+          ArchiveRepoSpecBuilder.HTTP_ARCHIVE_PATH + "%http_archive",
+          GitRepoSpecBuilder.GIT_REPO_PATH + "%git_repository");
+
   /** Returns the {@link RepoSpec} that defines this repository. */
   RepoSpec getRepoSpec();
 
diff --git a/src/main/java/com/google/devtools/build/lib/bazel/bzlmod/SingleExtensionEvalFunction.java b/src/main/java/com/google/devtools/build/lib/bazel/bzlmod/SingleExtensionEvalFunction.java
index 755284f305..5fc38d2940 100644
--- a/src/main/java/com/google/devtools/build/lib/bazel/bzlmod/SingleExtensionEvalFunction.java
+++ b/src/main/java/com/google/devtools/build/lib/bazel/bzlmod/SingleExtensionEvalFunction.java
@@ -34,6 +34,8 @@ import com.google.devtools.build.lib.bazel.repository.RepositoryOptions.Lockfile
 import com.google.devtools.build.lib.bazel.repository.downloader.DownloadManager;
 import com.google.devtools.build.lib.bazel.repository.starlark.StarlarkRepositoryModule.RepositoryRuleFunction;
 import com.google.devtools.build.lib.cmdline.BazelModuleContext;
+import com.google.devtools.build.lib.cmdline.BazelStarlarkContext;
+import com.google.devtools.build.lib.cmdline.BazelStarlarkContext.Phase;
 import com.google.devtools.build.lib.cmdline.Label;
 import com.google.devtools.build.lib.cmdline.LabelConstants;
 import com.google.devtools.build.lib.cmdline.LabelSyntaxException;
@@ -132,6 +134,12 @@ public class SingleExtensionEvalFunction implements SkyFunction {
     if (starlarkSemantics == null) {
       return null;
     }
+    RepositoryMappingValue mainRepoMappingValue =
+        (RepositoryMappingValue)
+            env.getValue(RepositoryMappingValue.KEY_FOR_ROOT_MODULE_WITHOUT_WORKSPACE_REPOS);
+    if (mainRepoMappingValue == null) {
+      return null;
+    }
 
     ModuleExtensionId extensionId = (ModuleExtensionId) skyKey.argument();
     SingleExtensionUsagesValue usagesValue =
@@ -182,7 +190,12 @@ public class SingleExtensionEvalFunction implements SkyFunction {
     // Run that extension!
     env.getListener().post(ModuleExtensionEvaluationProgress.ongoing(extensionId, "starting"));
     RunModuleExtensionResult moduleExtensionResult =
-        extension.run(env, usagesValue, starlarkSemantics, extensionId);
+        extension.run(
+            env,
+            usagesValue,
+            starlarkSemantics,
+            extensionId,
+            mainRepoMappingValue.getRepositoryMapping());
     if (moduleExtensionResult == null) {
       return null;
     }
@@ -524,7 +537,8 @@ public class SingleExtensionEvalFunction implements SkyFunction {
         Environment env,
         SingleExtensionUsagesValue usagesValue,
         StarlarkSemantics starlarkSemantics,
-        ModuleExtensionId extensionId)
+        ModuleExtensionId extensionId,
+        RepositoryMapping repositoryMapping)
         throws InterruptedException, SingleExtensionEvalFunctionException;
   }
 
@@ -676,7 +690,8 @@ public class SingleExtensionEvalFunction implements SkyFunction {
         Environment env,
         SingleExtensionUsagesValue usagesValue,
         StarlarkSemantics starlarkSemantics,
-        ModuleExtensionId extensionId)
+        ModuleExtensionId extensionId,
+        RepositoryMapping mainRepositoryMapping)
         throws InterruptedException, SingleExtensionEvalFunctionException {
       var generatedRepoSpecs = ImmutableMap.<String, RepoSpec>builderWithExpectedSize(repos.size());
       // Instantiate the repos one by one.
@@ -845,7 +860,8 @@ public class SingleExtensionEvalFunction implements SkyFunction {
         Environment env,
         SingleExtensionUsagesValue usagesValue,
         StarlarkSemantics starlarkSemantics,
-        ModuleExtensionId extensionId)
+        ModuleExtensionId extensionId,
+        RepositoryMapping mainRepositoryMapping)
         throws InterruptedException, SingleExtensionEvalFunctionException {
       ModuleExtensionEvalStarlarkThreadContext threadContext =
           new ModuleExtensionEvalStarlarkThreadContext(
@@ -869,6 +885,8 @@ public class SingleExtensionEvalFunction implements SkyFunction {
         thread.setPrintHandler(Event.makeDebugPrintHandler(env.getListener()));
         moduleContext = createContext(env, usagesValue, starlarkSemantics, extensionId);
         threadContext.storeInThread(thread);
+        new BazelStarlarkContext(Phase.WORKSPACE, () -> mainRepositoryMapping)
+            .storeInThread(thread);
         // This is used by the `Label()` constructor in Starlark, to record any attempts to resolve
         // apparent repo names to canonical repo names. See #20721 for why this is necessary.
         thread.setThreadLocal(Label.RepoMappingRecorder.class, repoMappingRecorder);
diff --git a/src/main/java/com/google/devtools/build/lib/bazel/bzlmod/TypeCheckedTag.java b/src/main/java/com/google/devtools/build/lib/bazel/bzlmod/TypeCheckedTag.java
index b9601be57f..e6d5c4eb21 100644
--- a/src/main/java/com/google/devtools/build/lib/bazel/bzlmod/TypeCheckedTag.java
+++ b/src/main/java/com/google/devtools/build/lib/bazel/bzlmod/TypeCheckedTag.java
@@ -24,7 +24,7 @@ import javax.annotation.Nullable;
 import net.starlark.java.annot.StarlarkBuiltin;
 import net.starlark.java.eval.EvalException;
 import net.starlark.java.eval.Printer;
-import net.starlark.java.eval.StarlarkSemantics;
+import net.starlark.java.eval.StarlarkThread;
 import net.starlark.java.eval.Structure;
 import net.starlark.java.spelling.SpellChecker;
 import net.starlark.java.syntax.Location;
@@ -150,7 +150,7 @@ public class TypeCheckedTag implements Structure {
   }
 
   @Override
-  public void debugPrint(Printer printer, StarlarkSemantics semantics) {
+  public void debugPrint(Printer printer, StarlarkThread thread) {
     printer.append(String.format("'%s' tag at %s", tagClassName, location));
   }
 }
diff --git a/src/main/java/com/google/devtools/build/lib/bazel/repository/starlark/BUILD b/src/main/java/com/google/devtools/build/lib/bazel/repository/starlark/BUILD
index bbc23ef10f..ec879778d6 100644
--- a/src/main/java/com/google/devtools/build/lib/bazel/repository/starlark/BUILD
+++ b/src/main/java/com/google/devtools/build/lib/bazel/repository/starlark/BUILD
@@ -46,6 +46,7 @@ java_library(
         "//src/main/java/com/google/devtools/build/lib/skyframe:directory_tree_digest_value",
         "//src/main/java/com/google/devtools/build/lib/skyframe:ignored_package_prefixes_value",
         "//src/main/java/com/google/devtools/build/lib/skyframe:precomputed_value",
+        "//src/main/java/com/google/devtools/build/lib/skyframe:repository_mapping_value",
         "//src/main/java/com/google/devtools/build/lib/starlarkbuildapi/repository",
         "//src/main/java/com/google/devtools/build/lib/util",
         "//src/main/java/com/google/devtools/build/lib/util:string",
diff --git a/src/main/java/com/google/devtools/build/lib/bazel/repository/starlark/StarlarkRepositoryFunction.java b/src/main/java/com/google/devtools/build/lib/bazel/repository/starlark/StarlarkRepositoryFunction.java
index 63545a9f3e..478d99a4c0 100644
--- a/src/main/java/com/google/devtools/build/lib/bazel/repository/starlark/StarlarkRepositoryFunction.java
+++ b/src/main/java/com/google/devtools/build/lib/bazel/repository/starlark/StarlarkRepositoryFunction.java
@@ -23,13 +23,15 @@ import com.google.common.collect.ImmutableSet;
 import com.google.common.collect.Table;
 import com.google.devtools.build.lib.analysis.BlazeDirectories;
 import com.google.devtools.build.lib.analysis.RuleDefinition;
+import com.google.devtools.build.lib.bazel.bzlmod.NonRegistryOverride;
 import com.google.devtools.build.lib.bazel.repository.RepositoryResolvedEvent;
 import com.google.devtools.build.lib.bazel.repository.downloader.DownloadManager;
+import com.google.devtools.build.lib.cmdline.BazelStarlarkContext;
 import com.google.devtools.build.lib.cmdline.Label;
 import com.google.devtools.build.lib.cmdline.LabelConstants;
+import com.google.devtools.build.lib.cmdline.RepositoryMapping;
 import com.google.devtools.build.lib.cmdline.RepositoryName;
 import com.google.devtools.build.lib.events.Event;
-import com.google.devtools.build.lib.packages.BazelStarlarkContext;
 import com.google.devtools.build.lib.packages.Rule;
 import com.google.devtools.build.lib.packages.semantics.BuildLanguageOptions;
 import com.google.devtools.build.lib.pkgcache.PathPackageLocator;
@@ -46,6 +48,7 @@ import com.google.devtools.build.lib.runtime.ProcessWrapper;
 import com.google.devtools.build.lib.runtime.RepositoryRemoteExecutor;
 import com.google.devtools.build.lib.skyframe.IgnoredPackagePrefixesValue;
 import com.google.devtools.build.lib.skyframe.PrecomputedValue;
+import com.google.devtools.build.lib.skyframe.RepositoryMappingValue;
 import com.google.devtools.build.lib.vfs.FileSystemUtils;
 import com.google.devtools.build.lib.vfs.Path;
 import com.google.devtools.build.lib.vfs.PathFragment;
@@ -242,6 +245,27 @@ public final class StarlarkRepositoryFunction extends RepositoryFunction {
       return null;
     }
 
+    boolean enableBzlmod = starlarkSemantics.getBool(BuildLanguageOptions.ENABLE_BZLMOD);
+    @Nullable RepositoryMapping mainRepoMapping;
+    String ruleClass =
+        rule.getRuleClassObject().getRuleDefinitionEnvironmentLabel().getUnambiguousCanonicalForm()
+            + "%"
+            + rule.getRuleClass();
+    if (NonRegistryOverride.BOOTSTRAP_RULE_CLASSES.contains(ruleClass)) {
+      // Avoid a cycle.
+      mainRepoMapping = null;
+    } else if (enableBzlmod || !isWorkspaceRepo(rule)) {
+      var mainRepoMappingValue =
+          (RepositoryMappingValue)
+              env.getValue(RepositoryMappingValue.KEY_FOR_ROOT_MODULE_WITHOUT_WORKSPACE_REPOS);
+      if (mainRepoMappingValue == null) {
+        return null;
+      }
+      mainRepoMapping = mainRepoMappingValue.getRepositoryMapping();
+    } else {
+      mainRepoMapping = rule.getPackage().getRepositoryMapping();
+    }
+
     IgnoredPackagePrefixesValue ignoredPackagesValue =
         (IgnoredPackagePrefixesValue) env.getValue(IgnoredPackagePrefixesValue.key());
     if (env.valuesMissing()) {
@@ -264,7 +288,8 @@ public final class StarlarkRepositoryFunction extends RepositoryFunction {
         thread.setThreadLocal(Label.RepoMappingRecorder.class, repoMappingRecorder);
       }
 
-      new BazelStarlarkContext(BazelStarlarkContext.Phase.LOADING).storeInThread(thread); // "fetch"
+      new BazelStarlarkContext(BazelStarlarkContext.Phase.LOADING, () -> mainRepoMapping)
+          .storeInThread(thread); // "fetch"
 
       StarlarkRepositoryContext starlarkRepositoryContext =
           new StarlarkRepositoryContext(
diff --git a/src/main/java/com/google/devtools/build/lib/bazel/repository/starlark/StarlarkRepositoryModule.java b/src/main/java/com/google/devtools/build/lib/bazel/repository/starlark/StarlarkRepositoryModule.java
index 4c43f17b82..2a14a9ed5c 100644
--- a/src/main/java/com/google/devtools/build/lib/bazel/repository/starlark/StarlarkRepositoryModule.java
+++ b/src/main/java/com/google/devtools/build/lib/bazel/repository/starlark/StarlarkRepositoryModule.java
@@ -28,12 +28,12 @@ import com.google.devtools.build.lib.bazel.bzlmod.ModuleExtension;
 import com.google.devtools.build.lib.bazel.bzlmod.ModuleExtensionEvalStarlarkThreadContext;
 import com.google.devtools.build.lib.bazel.bzlmod.TagClass;
 import com.google.devtools.build.lib.cmdline.BazelModuleContext;
+import com.google.devtools.build.lib.cmdline.BazelStarlarkContext;
 import com.google.devtools.build.lib.cmdline.Label;
 import com.google.devtools.build.lib.cmdline.LabelSyntaxException;
 import com.google.devtools.build.lib.events.EventHandler;
 import com.google.devtools.build.lib.packages.Attribute;
 import com.google.devtools.build.lib.packages.AttributeValueSource;
-import com.google.devtools.build.lib.packages.BazelStarlarkContext;
 import com.google.devtools.build.lib.packages.BzlInitThreadContext;
 import com.google.devtools.build.lib.packages.Package;
 import com.google.devtools.build.lib.packages.RuleClass;
diff --git a/src/main/java/com/google/devtools/build/lib/cmdline/BUILD b/src/main/java/com/google/devtools/build/lib/cmdline/BUILD
index 89ab67d81d..87ab69d055 100644
--- a/src/main/java/com/google/devtools/build/lib/cmdline/BUILD
+++ b/src/main/java/com/google/devtools/build/lib/cmdline/BUILD
@@ -17,6 +17,7 @@ java_library(
     srcs = [
         "BazelCompileContext.java",
         "BazelModuleContext.java",
+        "BazelStarlarkContext.java",
         "Label.java",
         "LabelCodec.java",
         "LabelConstants.java",
diff --git a/src/main/java/com/google/devtools/build/lib/packages/BazelStarlarkContext.java b/src/main/java/com/google/devtools/build/lib/cmdline/BazelStarlarkContext.java
similarity index 90%
rename from src/main/java/com/google/devtools/build/lib/packages/BazelStarlarkContext.java
rename to src/main/java/com/google/devtools/build/lib/cmdline/BazelStarlarkContext.java
index 325628b4c4..d9dcd10fa5 100644
--- a/src/main/java/com/google/devtools/build/lib/packages/BazelStarlarkContext.java
+++ b/src/main/java/com/google/devtools/build/lib/cmdline/BazelStarlarkContext.java
@@ -11,9 +11,11 @@
 // WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 // See the License for the specific language governing permissions and
 // limitations under the License.
-package com.google.devtools.build.lib.packages;
+package com.google.devtools.build.lib.cmdline;
 
 import com.google.common.base.Preconditions;
+import com.google.devtools.build.lib.supplier.InterruptibleSupplier;
+import javax.annotation.Nullable;
 import net.starlark.java.eval.EvalException;
 import net.starlark.java.eval.Starlark;
 import net.starlark.java.eval.StarlarkThread;
@@ -94,12 +96,15 @@ public class BazelStarlarkContext implements StarlarkThread.UncheckedExceptionCo
 
   // TODO(b/236456122): Eliminate Phase, migrate analysisRuleLabel to a separate context class.
   private final Phase phase;
+  @Nullable private final InterruptibleSupplier<RepositoryMapping> mainRepoMappingSupplier;
 
   /**
    * @param phase the phase to which this Starlark thread belongs
    */
-  public BazelStarlarkContext(Phase phase) {
+  public BazelStarlarkContext(
+      Phase phase, @Nullable InterruptibleSupplier<RepositoryMapping> mainRepoMappingSupplier) {
     this.phase = Preconditions.checkNotNull(phase);
+    this.mainRepoMappingSupplier = mainRepoMappingSupplier;
   }
 
   /** Returns the phase associated with this context. */
@@ -107,6 +112,15 @@ public class BazelStarlarkContext implements StarlarkThread.UncheckedExceptionCo
     return phase;
   }
 
+  /**
+   * The repository mapping applicable to the main repository. This is purely meant to support
+   * {@link Label#debugPrint}.
+   */
+  @Nullable
+  public RepositoryMapping getMainRepoMapping() throws InterruptedException {
+    return mainRepoMappingSupplier == null ? null : mainRepoMappingSupplier.get();
+  }
+
   @Override
   public String getContextForUncheckedException() {
     return phase.toString();
diff --git a/src/main/java/com/google/devtools/build/lib/cmdline/Label.java b/src/main/java/com/google/devtools/build/lib/cmdline/Label.java
index 3d2443802e..8bc742638e 100644
--- a/src/main/java/com/google/devtools/build/lib/cmdline/Label.java
+++ b/src/main/java/com/google/devtools/build/lib/cmdline/Label.java
@@ -63,10 +63,14 @@ import net.starlark.java.eval.StarlarkValue;
     name = "Label",
     category = DocCategory.BUILTIN,
     doc =
-        "A BUILD target identifier."
-            + "<p>For every <code>Label</code> instance <code>l</code>, the string representation"
-            + " <code>str(l)</code> has the property that <code>Label(str(l)) == l</code>,"
-            + " regardless of where the <code>Label()</code> call occurs.")
+        "A BUILD target identifier.<p>For every <code>Label</code> instance <code>l</code>, the"
+            + " string representation <code>str(l)</code> has the property that <code>Label(str(l))"
+            + " == l</code>, regardless of where the <code>Label()</code> call occurs.<p>When"
+            + " passed as positional arguments to <code>print()</code> or <code>fail()</code>,"
+            + " <code>Label</code> use a string representation optimized for human readability"
+            + " instead. This representation uses an <a"
+            + " href=\"/external/overview#apparent-repo-name\">apparent repository name</a> from"
+            + " the perspective of the main repository if possible.")
 @Immutable
 @ThreadSafe
 public final class Label implements Comparable<Label>, StarlarkValue, SkyKey, CommandLineItem {
@@ -442,7 +446,7 @@ public final class Label implements Comparable<Label>, StarlarkValue, SkyKey, Co
    * @param mainRepositoryMapping the {@link RepositoryMapping} of the main repository
    * @return analogous to {@link PackageIdentifier#getDisplayForm(RepositoryMapping)}
    */
-  public String getDisplayForm(RepositoryMapping mainRepositoryMapping) {
+  public String getDisplayForm(@Nullable RepositoryMapping mainRepositoryMapping) {
     return packageIdentifier.getDisplayForm(mainRepositoryMapping) + ":" + name;
   }
 
@@ -655,6 +659,17 @@ public final class Label implements Comparable<Label>, StarlarkValue, SkyKey, Co
     printer.append(")");
   }
 
+  @Override
+  public void debugPrint(Printer printer, StarlarkThread thread) {
+    RepositoryMapping mainRepoMapping;
+    try {
+      mainRepoMapping = BazelStarlarkContext.fromOrFail(thread).getMainRepoMapping();
+    } catch (EvalException | InterruptedException e) {
+      mainRepoMapping = null;
+    }
+    printer.append(getDisplayForm(mainRepoMapping));
+  }
+
   @Override
   public void str(Printer printer, StarlarkSemantics semantics) {
     if (getRepository().isMain()
diff --git a/src/main/java/com/google/devtools/build/lib/cmdline/PackageIdentifier.java b/src/main/java/com/google/devtools/build/lib/cmdline/PackageIdentifier.java
index 4271d0d670..5611913f17 100644
--- a/src/main/java/com/google/devtools/build/lib/cmdline/PackageIdentifier.java
+++ b/src/main/java/com/google/devtools/build/lib/cmdline/PackageIdentifier.java
@@ -24,6 +24,7 @@ import com.google.devtools.build.lib.vfs.PathFragment;
 import com.google.devtools.build.skyframe.SkyFunctionName;
 import com.google.devtools.build.skyframe.SkyKey;
 import com.google.devtools.build.skyframe.SkyKey.SkyKeyInterner;
+import javax.annotation.Nullable;
 import javax.annotation.concurrent.Immutable;
 
 /**
@@ -226,7 +227,7 @@ public final class PackageIdentifier implements SkyKey, Comparable<PackageIdenti
    *       <dd>only with Bzlmod if the current package belongs to a repository that is not visible
    *           from the main module
    */
-  public String getDisplayForm(RepositoryMapping mainRepositoryMapping) {
+  public String getDisplayForm(@Nullable RepositoryMapping mainRepositoryMapping) {
     return repository.getDisplayForm(mainRepositoryMapping) + "//" + pkgName;
   }
 
diff --git a/src/main/java/com/google/devtools/build/lib/cmdline/RepositoryName.java b/src/main/java/com/google/devtools/build/lib/cmdline/RepositoryName.java
index 3747008f2c..d7435f7fb6 100644
--- a/src/main/java/com/google/devtools/build/lib/cmdline/RepositoryName.java
+++ b/src/main/java/com/google/devtools/build/lib/cmdline/RepositoryName.java
@@ -249,13 +249,15 @@ public final class RepositoryName {
    *       <dt><code>@protobuf</code>
    *       <dd>if this repository is a WORKSPACE dependency and its <code>name</code> is "protobuf",
    *           or if this repository is a Bzlmod dependency of the main module and its apparent name
-   *           is "protobuf"
+   *           is "protobuf" (in both cases only if mainRepositoryMapping is not null)
    *       <dt><code>@@protobuf~3.19.2</code>
    *       <dd>only with Bzlmod, if this a repository that is not visible from the main module
    */
-  public String getDisplayForm(RepositoryMapping mainRepositoryMapping) {
+  public String getDisplayForm(@Nullable RepositoryMapping mainRepositoryMapping) {
     Preconditions.checkArgument(
-        mainRepositoryMapping.ownerRepo() == null || mainRepositoryMapping.ownerRepo().isMain());
+        mainRepositoryMapping == null
+            || mainRepositoryMapping.ownerRepo() == null
+            || mainRepositoryMapping.ownerRepo().isMain());
     if (!isVisible()) {
       return getNameWithAt();
     }
@@ -263,6 +265,9 @@ public final class RepositoryName {
       // Packages in the main repository can always use repo-relative form.
       return "";
     }
+    if (mainRepositoryMapping == null) {
+      return getNameWithAt();
+    }
     if (!mainRepositoryMapping.usesStrictDeps()) {
       // If the main repository mapping is not using strict visibility, then Bzlmod is certainly
       // disabled, which means that canonical and apparent names can be used interchangeably from
diff --git a/src/main/java/com/google/devtools/build/lib/packages/BuildGlobals.java b/src/main/java/com/google/devtools/build/lib/packages/BuildGlobals.java
index 2ae17ab492..eda38a5761 100644
--- a/src/main/java/com/google/devtools/build/lib/packages/BuildGlobals.java
+++ b/src/main/java/com/google/devtools/build/lib/packages/BuildGlobals.java
@@ -15,6 +15,7 @@ package com.google.devtools.build.lib.packages;
 
 import com.google.devtools.build.docgen.annot.GlobalMethods;
 import com.google.devtools.build.docgen.annot.GlobalMethods.Environment;
+import com.google.devtools.build.lib.cmdline.BazelStarlarkContext;
 import com.google.devtools.build.lib.cmdline.Label;
 import com.google.devtools.build.lib.cmdline.LabelSyntaxException;
 import com.google.devtools.build.lib.packages.TargetDefinitionContext.NameConflictException;
diff --git a/src/main/java/com/google/devtools/build/lib/packages/BzlInitThreadContext.java b/src/main/java/com/google/devtools/build/lib/packages/BzlInitThreadContext.java
index 757f74278c..571a62c6eb 100644
--- a/src/main/java/com/google/devtools/build/lib/packages/BzlInitThreadContext.java
+++ b/src/main/java/com/google/devtools/build/lib/packages/BzlInitThreadContext.java
@@ -16,7 +16,9 @@ package com.google.devtools.build.lib.packages;
 
 import com.google.common.collect.ImmutableMap;
 import com.google.devtools.build.lib.analysis.RuleDefinitionEnvironment;
+import com.google.devtools.build.lib.cmdline.BazelStarlarkContext;
 import com.google.devtools.build.lib.cmdline.Label;
+import com.google.devtools.build.lib.cmdline.RepositoryMapping;
 import com.google.devtools.build.lib.cmdline.RepositoryName;
 import com.google.errorprone.annotations.CanIgnoreReturnValue;
 import java.util.Optional;
@@ -57,15 +59,16 @@ public final class BzlInitThreadContext extends BazelStarlarkContext
    * @param networkAllowlistForTests an allowlist for rule classes created by this thread
    * @param fragmentNameToClass a map from configuration fragment name to configuration fragment
    *     class, such as "apple" to AppleConfiguration.class
-   * @param symbolGenerator symbol generator for this context
+   * @param mainRepoMapping the repository mapping of the main repository
    */
   public BzlInitThreadContext(
       Label bzlFile,
       byte[] transitiveDigest,
       RepositoryName toolsRepository,
       Optional<Label> networkAllowlistForTests,
-      ImmutableMap<String, Class<?>> fragmentNameToClass) {
-    super(BazelStarlarkContext.Phase.LOADING);
+      ImmutableMap<String, Class<?>> fragmentNameToClass,
+      RepositoryMapping mainRepoMapping) {
+    super(BazelStarlarkContext.Phase.LOADING, () -> mainRepoMapping);
     this.bzlFile = bzlFile;
     this.transitiveDigest = transitiveDigest;
     this.toolsRepository = toolsRepository;
diff --git a/src/main/java/com/google/devtools/build/lib/packages/Package.java b/src/main/java/com/google/devtools/build/lib/packages/Package.java
index 1976b059b9..0f2bda7264 100644
--- a/src/main/java/com/google/devtools/build/lib/packages/Package.java
+++ b/src/main/java/com/google/devtools/build/lib/packages/Package.java
@@ -29,6 +29,7 @@ import com.google.common.collect.Maps;
 import com.google.devtools.build.lib.bugreport.BugReport;
 import com.google.devtools.build.lib.cmdline.BazelModuleContext;
 import com.google.devtools.build.lib.cmdline.BazelModuleContext.LoadGraphVisitor;
+import com.google.devtools.build.lib.cmdline.BazelStarlarkContext;
 import com.google.devtools.build.lib.cmdline.Label;
 import com.google.devtools.build.lib.cmdline.LabelConstants;
 import com.google.devtools.build.lib.cmdline.LabelSyntaxException;
@@ -756,6 +757,7 @@ public class Package {
       Optional<String> associatedModuleVersion,
       boolean noImplicitFileExport,
       RepositoryMapping repositoryMapping,
+      RepositoryMapping mainRepositoryMapping,
       @Nullable Semaphore cpuBoundSemaphore,
       PackageOverheadEstimator packageOverheadEstimator,
       @Nullable ImmutableMap<Location, String> generatorMap,
@@ -773,6 +775,7 @@ public class Package {
         associatedModuleVersion,
         noImplicitFileExport,
         repositoryMapping,
+        mainRepositoryMapping,
         cpuBoundSemaphore,
         packageOverheadEstimator,
         generatorMap,
@@ -800,6 +803,7 @@ public class Package {
         /* associatedModuleVersion= */ Optional.empty(),
         noImplicitFileExport,
         /* repositoryMapping= */ mainRepoMapping,
+        /* mainRepositoryMapping= */ mainRepoMapping,
         /* cpuBoundSemaphore= */ null,
         packageOverheadEstimator,
         /* generatorMap= */ null,
@@ -823,6 +827,7 @@ public class Package {
             /* associatedModuleVersion= */ Optional.empty(),
             noImplicitFileExport,
             repoMapping,
+            /* mainRepoMapping= */ null,
             /* cpuBoundSemaphore= */ null,
             PackageOverheadEstimator.NOOP_ESTIMATOR,
             /* generatorMap= */ null,
@@ -1060,7 +1065,7 @@ public class Package {
     private boolean alreadyBuilt = false;
 
     private Builder(
-        BazelStarlarkContext.Phase phase,
+        Phase phase,
         SymbolGenerator<?> symbolGenerator,
         PackageSettings packageSettings,
         PackageIdentifier id,
@@ -1070,6 +1075,7 @@ public class Package {
         Optional<String> associatedModuleVersion,
         boolean noImplicitFileExport,
         RepositoryMapping repositoryMapping,
+        @Nullable RepositoryMapping mainRepositoryMapping,
         @Nullable Semaphore cpuBoundSemaphore,
         PackageOverheadEstimator packageOverheadEstimator,
         @Nullable ImmutableMap<Location, String> generatorMap,
@@ -1077,7 +1083,7 @@ public class Package {
         // Maybe convert null -> LEGACY_OFF, assuming that's the correct default.
         @Nullable ConfigSettingVisibilityPolicy configSettingVisibilityPolicy,
         @Nullable Globber globber) {
-      super(phase);
+      super(phase, mainRepositoryMapping);
       this.symbolGenerator = symbolGenerator;
 
       Metadata metadata = new Metadata();
diff --git a/src/main/java/com/google/devtools/build/lib/packages/PackageFactory.java b/src/main/java/com/google/devtools/build/lib/packages/PackageFactory.java
index 3c78104b5d..d51353b382 100644
--- a/src/main/java/com/google/devtools/build/lib/packages/PackageFactory.java
+++ b/src/main/java/com/google/devtools/build/lib/packages/PackageFactory.java
@@ -234,6 +234,7 @@ public final class PackageFactory {
       Optional<String> associatedModuleVersion,
       StarlarkSemantics starlarkSemantics,
       RepositoryMapping repositoryMapping,
+      RepositoryMapping mainRepositoryMapping,
       @Nullable Semaphore cpuBoundSemaphore,
       @Nullable ImmutableMap<Location, String> generatorMap,
       @Nullable ConfigSettingVisibilityPolicy configSettingVisibilityPolicy,
@@ -247,6 +248,7 @@ public final class PackageFactory {
         associatedModuleVersion,
         starlarkSemantics.getBool(BuildLanguageOptions.INCOMPATIBLE_NO_IMPLICIT_FILE_EXPORT),
         repositoryMapping,
+        mainRepositoryMapping,
         cpuBoundSemaphore,
         packageOverheadEstimator,
         generatorMap,
diff --git a/src/main/java/com/google/devtools/build/lib/packages/RuleFactory.java b/src/main/java/com/google/devtools/build/lib/packages/RuleFactory.java
index 9414b20e96..3c59e5727f 100644
--- a/src/main/java/com/google/devtools/build/lib/packages/RuleFactory.java
+++ b/src/main/java/com/google/devtools/build/lib/packages/RuleFactory.java
@@ -17,6 +17,7 @@ package com.google.devtools.build.lib.packages;
 import com.google.common.base.Preconditions;
 import com.google.common.collect.ImmutableList;
 import com.google.common.collect.ImmutableMap;
+import com.google.devtools.build.lib.cmdline.BazelStarlarkContext;
 import com.google.devtools.build.lib.cmdline.Label;
 import com.google.devtools.build.lib.cmdline.LabelSyntaxException;
 import com.google.devtools.build.lib.packages.Attribute.StarlarkComputedDefaultTemplate.CannotPrecomputeDefaultsException;
diff --git a/src/main/java/com/google/devtools/build/lib/packages/StarlarkCallbackHelper.java b/src/main/java/com/google/devtools/build/lib/packages/StarlarkCallbackHelper.java
index 35795f2ddb..5290a5aa08 100644
--- a/src/main/java/com/google/devtools/build/lib/packages/StarlarkCallbackHelper.java
+++ b/src/main/java/com/google/devtools/build/lib/packages/StarlarkCallbackHelper.java
@@ -15,6 +15,7 @@ package com.google.devtools.build.lib.packages;
 
 import com.google.common.collect.ImmutableList;
 import com.google.common.collect.ImmutableMap;
+import com.google.devtools.build.lib.cmdline.BazelStarlarkContext;
 import com.google.devtools.build.lib.events.Event;
 import com.google.devtools.build.lib.events.EventHandler;
 import net.starlark.java.eval.EvalException;
@@ -69,7 +70,8 @@ public final class StarlarkCallbackHelper {
       // But I don't think implicit outputs or computed defaults care about identity.
       StarlarkThread thread = StarlarkThread.createTransient(mu, starlarkSemantics);
       thread.setPrintHandler(Event.makeDebugPrintHandler(eventHandler));
-      new BazelStarlarkContext(BazelStarlarkContext.Phase.LOADING).storeInThread(thread);
+      new BazelStarlarkContext(BazelStarlarkContext.Phase.LOADING, /* mainRepoMapping= */ null)
+          .storeInThread(thread);
       return Starlark.call(
           thread, callback, buildArgumentList(struct, arguments), /*kwargs=*/ ImmutableMap.of());
     } catch (ClassCastException | IllegalArgumentException e) { // TODO(adonovan): investigate
diff --git a/src/main/java/com/google/devtools/build/lib/packages/StarlarkNativeModule.java b/src/main/java/com/google/devtools/build/lib/packages/StarlarkNativeModule.java
index d7cc82d36e..94b77d9675 100644
--- a/src/main/java/com/google/devtools/build/lib/packages/StarlarkNativeModule.java
+++ b/src/main/java/com/google/devtools/build/lib/packages/StarlarkNativeModule.java
@@ -25,6 +25,7 @@ import com.google.common.collect.Iterables;
 import com.google.common.collect.Iterators;
 import com.google.common.collect.UnmodifiableIterator;
 import com.google.common.flogger.GoogleLogger;
+import com.google.devtools.build.lib.cmdline.BazelStarlarkContext;
 import com.google.devtools.build.lib.cmdline.Label;
 import com.google.devtools.build.lib.cmdline.LabelSyntaxException;
 import com.google.devtools.build.lib.cmdline.LabelValidator;
diff --git a/src/main/java/com/google/devtools/build/lib/packages/TargetDefinitionContext.java b/src/main/java/com/google/devtools/build/lib/packages/TargetDefinitionContext.java
index 86283dd8f6..8a8a41e0c6 100644
--- a/src/main/java/com/google/devtools/build/lib/packages/TargetDefinitionContext.java
+++ b/src/main/java/com/google/devtools/build/lib/packages/TargetDefinitionContext.java
@@ -14,6 +14,9 @@
 
 package com.google.devtools.build.lib.packages;
 
+import com.google.devtools.build.lib.cmdline.BazelStarlarkContext;
+import com.google.devtools.build.lib.cmdline.RepositoryMapping;
+
 /**
  * A context object, usually stored in a {@link StarlarkThread}, upon which rules and symbolic
  * macros can be instantiated.
@@ -40,7 +43,7 @@ public abstract class TargetDefinitionContext extends BazelStarlarkContext {
     }
   }
 
-  protected TargetDefinitionContext(Phase phase) {
-    super(phase);
+  protected TargetDefinitionContext(Phase phase, RepositoryMapping mainRepoMapping) {
+    super(phase, () -> mainRepoMapping);
   }
 }
diff --git a/src/main/java/com/google/devtools/build/lib/rules/cpp/CcLinkingContext.java b/src/main/java/com/google/devtools/build/lib/rules/cpp/CcLinkingContext.java
index 1794531b75..7ffeaddebe 100644
--- a/src/main/java/com/google/devtools/build/lib/rules/cpp/CcLinkingContext.java
+++ b/src/main/java/com/google/devtools/build/lib/rules/cpp/CcLinkingContext.java
@@ -276,23 +276,23 @@ public class CcLinkingContext implements CcLinkingContextApi<Artifact> {
     }
 
     @Override
-    public void debugPrint(Printer printer, StarlarkSemantics semantics) {
+    public void debugPrint(Printer printer, StarlarkThread thread) {
       printer.append("<LinkerInput(owner=");
       if (owner == null) {
         printer.append("[null owner, uses old create_linking_context API]");
       } else {
-        owner.debugPrint(printer, semantics);
+        owner.debugPrint(printer, thread);
       }
       printer.append(", libraries=[");
       for (LibraryToLink libraryToLink : libraries) {
-        libraryToLink.debugPrint(printer, semantics);
+        libraryToLink.debugPrint(printer, thread);
         printer.append(", ");
       }
       printer.append("], userLinkFlags=[");
       printer.append(Joiner.on(", ").join(userLinkFlags));
       printer.append("], nonCodeInputs=[");
       for (Artifact nonCodeInput : nonCodeInputs) {
-        nonCodeInput.debugPrint(printer, semantics);
+        nonCodeInput.debugPrint(printer, thread);
         printer.append(", ");
       }
       // TODO(cparsons): Add debug repesentation of linkstamps.
@@ -390,10 +390,10 @@ public class CcLinkingContext implements CcLinkingContextApi<Artifact> {
   @Nullable private final ExtraLinkTimeLibraries extraLinkTimeLibraries;
 
   @Override
-  public void debugPrint(Printer printer, StarlarkSemantics semantics) {
+  public void debugPrint(Printer printer, StarlarkThread thread) {
     printer.append("<CcLinkingContext([");
     for (LinkerInput linkerInput : linkerInputs.toList()) {
-      linkerInput.debugPrint(printer, semantics);
+      linkerInput.debugPrint(printer, thread);
       printer.append(", ");
     }
     printer.append("])>");
diff --git a/src/main/java/com/google/devtools/build/lib/rules/cpp/FeatureConfigurationForStarlark.java b/src/main/java/com/google/devtools/build/lib/rules/cpp/FeatureConfigurationForStarlark.java
index 0b04c1e650..5da29f7207 100644
--- a/src/main/java/com/google/devtools/build/lib/rules/cpp/FeatureConfigurationForStarlark.java
+++ b/src/main/java/com/google/devtools/build/lib/rules/cpp/FeatureConfigurationForStarlark.java
@@ -62,7 +62,7 @@ public class FeatureConfigurationForStarlark implements FeatureConfigurationApi
   }
 
   @Override
-  public void debugPrint(Printer printer, StarlarkSemantics semantics) {
+  public void debugPrint(Printer printer, StarlarkThread thread) {
     printer.append("<FeatureConfiguration(");
     printer.append(Joiner.on(", ").join(featureConfiguration.getEnabledFeatureNames()));
     printer.append(")>");
diff --git a/src/main/java/com/google/devtools/build/lib/rules/cpp/LibraryToLink.java b/src/main/java/com/google/devtools/build/lib/rules/cpp/LibraryToLink.java
index 447f6d9c88..0b0dcebc6f 100644
--- a/src/main/java/com/google/devtools/build/lib/rules/cpp/LibraryToLink.java
+++ b/src/main/java/com/google/devtools/build/lib/rules/cpp/LibraryToLink.java
@@ -33,7 +33,6 @@ import net.starlark.java.eval.EvalException;
 import net.starlark.java.eval.Printer;
 import net.starlark.java.eval.Sequence;
 import net.starlark.java.eval.StarlarkList;
-import net.starlark.java.eval.StarlarkSemantics;
 import net.starlark.java.eval.StarlarkThread;
 
 /** Encapsulates information for linking a library. */
@@ -308,7 +307,7 @@ public abstract class LibraryToLink implements LibraryToLinkApi<Artifact, LtoBac
   }
 
   @Override
-  public final void debugPrint(Printer printer, StarlarkSemantics semantics) {
+  public final void debugPrint(Printer printer, StarlarkThread thread) {
     printer.append("<LibraryToLink(");
     printer.append(
         Joiner.on(", ")
diff --git a/src/main/java/com/google/devtools/build/lib/skyframe/BUILD b/src/main/java/com/google/devtools/build/lib/skyframe/BUILD
index 7f08125e19..0f1af40433 100644
--- a/src/main/java/com/google/devtools/build/lib/skyframe/BUILD
+++ b/src/main/java/com/google/devtools/build/lib/skyframe/BUILD
@@ -2590,6 +2590,7 @@ java_library(
         ":sky_functions",
         "//src/main/java/com/google/devtools/build/lib/bazel/bzlmod:module_extension",
         "//src/main/java/com/google/devtools/build/lib/bazel/bzlmod:repo_rule_value",
+        "//src/main/java/com/google/devtools/build/lib/bazel/bzlmod:resolution",
         "//src/main/java/com/google/devtools/build/lib/cmdline",
         "//src/main/java/com/google/devtools/build/lib/events",
         "//src/main/java/com/google/devtools/build/lib/packages",
diff --git a/src/main/java/com/google/devtools/build/lib/skyframe/BzlLoadFunction.java b/src/main/java/com/google/devtools/build/lib/skyframe/BzlLoadFunction.java
index ba6d18f754..3b6311df38 100644
--- a/src/main/java/com/google/devtools/build/lib/skyframe/BzlLoadFunction.java
+++ b/src/main/java/com/google/devtools/build/lib/skyframe/BzlLoadFunction.java
@@ -762,6 +762,11 @@ public class BzlLoadFunction implements SkyFunction {
     if (repoMapping == null) {
       return null;
     }
+    RepositoryMapping mainRepoMapping =
+        getMainRepositoryMapping(key, builtins.starlarkSemantics, env);
+    if (mainRepoMapping == null) {
+      return null;
+    }
     Label.RepoMappingRecorder repoMappingRecorder = new Label.RepoMappingRecorder();
     ImmutableList<Pair<String, Location>> programLoads = getLoadsFromProgram(prog);
     ImmutableList<Label> loadLabels =
@@ -858,7 +863,8 @@ public class BzlLoadFunction implements SkyFunction {
             transitiveDigest,
             ruleClassProvider.getToolsRepository(),
             ruleClassProvider.getNetworkAllowlistForTests(),
-            ruleClassProvider.getConfigurationFragmentMap());
+            ruleClassProvider.getConfigurationFragmentMap(),
+            mainRepoMapping);
 
     // executeBzlFile may post events to the Environment's handler, but events do not matter when
     // caching BzlLoadValues. Note that executing the code mutates the Module and
@@ -972,6 +978,32 @@ public class BzlLoadFunction implements SkyFunction {
     return repositoryMappingValue.getRepositoryMapping();
   }
 
+  @Nullable
+  private static RepositoryMapping getMainRepositoryMapping(
+      BzlLoadValue.Key key, StarlarkSemantics starlarkSemantics, Environment env)
+      throws InterruptedException {
+    boolean bzlmod = starlarkSemantics.getBool(BuildLanguageOptions.ENABLE_BZLMOD);
+    RepositoryMappingValue.Key repoMappingKey;
+    if (key instanceof BzlLoadValue.KeyForBuild) {
+      repoMappingKey = RepositoryMappingValue.key(RepositoryName.MAIN);
+    } else if ((key instanceof BzlLoadValue.KeyForBzlmod
+            && !(key instanceof BzlLoadValue.KeyForBzlmodBootstrap))
+        || (bzlmod && key instanceof BzlLoadValue.KeyForWorkspace)) {
+      // Since the main repo mapping requires evaluating WORKSPACE, but WORKSPACE can load from
+      // extension repos, requesting the full main repo mapping would cause a cycle.
+      repoMappingKey = RepositoryMappingValue.KEY_FOR_ROOT_MODULE_WITHOUT_WORKSPACE_REPOS;
+    } else {
+      // For builtins, @bazel_tools, and legacy WORKSPACE, the key's local repo mapping can be used
+      // as the main repo mapping.
+      return getRepositoryMapping(key, starlarkSemantics, env);
+    }
+    var mainRepositoryMappingValue = (RepositoryMappingValue) env.getValue(repoMappingKey);
+    if (mainRepositoryMappingValue == null) {
+      return null;
+    }
+    return mainRepositoryMappingValue.getRepositoryMapping();
+  }
+
   /**
    * Validates a label appearing in a {@code load()} statement, throwing {@link
    * LabelSyntaxException} on failure.
diff --git a/src/main/java/com/google/devtools/build/lib/skyframe/BzlmodRepoCycleReporter.java b/src/main/java/com/google/devtools/build/lib/skyframe/BzlmodRepoCycleReporter.java
index 982ae64672..823e615d9d 100644
--- a/src/main/java/com/google/devtools/build/lib/skyframe/BzlmodRepoCycleReporter.java
+++ b/src/main/java/com/google/devtools/build/lib/skyframe/BzlmodRepoCycleReporter.java
@@ -20,8 +20,11 @@ import com.google.common.base.Predicate;
 import com.google.common.base.Predicates;
 import com.google.common.collect.ImmutableList;
 import com.google.common.collect.Iterables;
+import com.google.devtools.build.lib.bazel.bzlmod.BazelDepGraphValue;
+import com.google.devtools.build.lib.bazel.bzlmod.BazelModuleResolutionValue;
 import com.google.devtools.build.lib.bazel.bzlmod.BzlmodRepoRuleValue;
 import com.google.devtools.build.lib.bazel.bzlmod.ModuleExtensionId;
+import com.google.devtools.build.lib.bazel.bzlmod.ModuleFileValue;
 import com.google.devtools.build.lib.cmdline.Label;
 import com.google.devtools.build.lib.cmdline.PackageIdentifier;
 import com.google.devtools.build.lib.events.Event;
@@ -72,6 +75,15 @@ public class BzlmodRepoCycleReporter implements CyclesReporter.SingleCycleReport
   private static final Predicate<SkyKey> IS_WORKSPACE_FILE =
       SkyFunctions.isSkyFunction(WorkspaceFileValue.WORKSPACE_FILE);
 
+  private static final Predicate<SkyKey> IS_MODULE_RESOLUTION =
+      SkyFunctions.isSkyFunction(SkyFunctions.BAZEL_MODULE_RESOLUTION);
+
+  private static final Predicate<SkyKey> IS_DEP_GRAPH =
+      SkyFunctions.isSkyFunction(SkyFunctions.BAZEL_DEP_GRAPH);
+
+  private static final Predicate<SkyKey> IS_MODULE_FILE =
+      SkyFunctions.isSkyFunction(SkyFunctions.MODULE_FILE);
+
   private static void requestRepoDefinitions(
       ExtendedEventHandler eventHandler, Iterable<SkyKey> repos) {
     for (SkyKey repo : repos) {
@@ -117,7 +129,10 @@ public class BzlmodRepoCycleReporter implements CyclesReporter.SingleCycleReport
                 IS_MODULE_EXTENSION_REPO_MAPPING_ENTRIES,
                 IS_PACKAGE,
                 IS_EXTERNAL_PACKAGE,
-                IS_WORKSPACE_FILE))
+                IS_WORKSPACE_FILE,
+                IS_MODULE_RESOLUTION,
+                IS_DEP_GRAPH,
+                IS_MODULE_FILE))
         && Iterables.any(cycle, Predicates.or(IS_REPO_RULE, IS_EXTENSION_IMPL))) {
       StringBuilder cycleMessage =
           new StringBuilder(
@@ -131,7 +146,10 @@ public class BzlmodRepoCycleReporter implements CyclesReporter.SingleCycleReport
                   IS_EXTENSION_IMPL,
                   IS_BZL_LOAD,
                   IS_REPO_MAPPING,
-                  IS_WORKSPACE_FILE));
+                  IS_WORKSPACE_FILE,
+                  IS_MODULE_RESOLUTION,
+                  IS_DEP_GRAPH,
+                  IS_MODULE_FILE));
       Function<Object, String> printer =
           rawInput -> {
             SkyKey input = (SkyKey) rawInput;
@@ -148,6 +166,12 @@ public class BzlmodRepoCycleReporter implements CyclesReporter.SingleCycleReport
               return String.format("repository mapping of %s", key.repoName());
             } else if (input.argument() instanceof WorkspaceFileValue.WorkspaceFileKey) {
               return "WORKSPACE file";
+            } else if (input.argument() == BazelModuleResolutionValue.KEY) {
+              return "module resolution";
+            } else if (input.argument() == BazelDepGraphValue.KEY) {
+              return "module dependency graph";
+            } else if (input.argument() instanceof ModuleFileValue.Key) {
+              return "module file of " + input.argument();
             } else {
               Preconditions.checkArgument(input.argument() instanceof BzlLoadValue.Key);
               return ((BzlLoadValue.Key) input.argument()).getLabel().toString();
diff --git a/src/main/java/com/google/devtools/build/lib/skyframe/BzlmodRepoRuleFunction.java b/src/main/java/com/google/devtools/build/lib/skyframe/BzlmodRepoRuleFunction.java
index 0601ffebbf..06ee5eade3 100644
--- a/src/main/java/com/google/devtools/build/lib/skyframe/BzlmodRepoRuleFunction.java
+++ b/src/main/java/com/google/devtools/build/lib/skyframe/BzlmodRepoRuleFunction.java
@@ -18,13 +18,10 @@ package com.google.devtools.build.lib.skyframe;
 import com.google.common.base.Preconditions;
 import com.google.common.collect.ImmutableList;
 import com.google.common.collect.ImmutableMap;
-import com.google.common.collect.ImmutableSet;
 import com.google.devtools.build.lib.analysis.BlazeDirectories;
-import com.google.devtools.build.lib.bazel.bzlmod.ArchiveRepoSpecBuilder;
 import com.google.devtools.build.lib.bazel.bzlmod.BazelDepGraphValue;
 import com.google.devtools.build.lib.bazel.bzlmod.BzlmodRepoRuleCreator;
 import com.google.devtools.build.lib.bazel.bzlmod.BzlmodRepoRuleValue;
-import com.google.devtools.build.lib.bazel.bzlmod.GitRepoSpecBuilder;
 import com.google.devtools.build.lib.bazel.bzlmod.ModuleExtensionId;
 import com.google.devtools.build.lib.bazel.bzlmod.ModuleFileValue;
 import com.google.devtools.build.lib.bazel.bzlmod.ModuleFileValue.RootModuleFileValue;
@@ -51,7 +48,6 @@ import com.google.devtools.build.skyframe.SkyKey;
 import com.google.devtools.build.skyframe.SkyValue;
 import java.util.Map.Entry;
 import java.util.Optional;
-import java.util.Set;
 import javax.annotation.Nullable;
 import net.starlark.java.eval.EvalException;
 import net.starlark.java.eval.Module;
@@ -214,13 +210,6 @@ public final class BzlmodRepoRuleFunction implements SkyFunction {
     }
   }
 
-  // Starlark rules loaded from bazel_tools that may define Bazel module repositories and thus must
-  // be loaded without relying on any other modules.
-  private static final Set<String> BOOTSTRAP_RULE_CLASSES =
-      ImmutableSet.of(
-          ArchiveRepoSpecBuilder.HTTP_ARCHIVE_PATH + "%http_archive",
-          GitRepoSpecBuilder.GIT_REPO_PATH + "%git_repository");
-
   /** Loads modules from the given bzl file. */
   private ImmutableMap<String, Module> loadBzlModules(
       Environment env, String bzlFile, String ruleClass, StarlarkSemantics starlarkSemantics)
@@ -248,7 +237,7 @@ public final class BzlmodRepoRuleFunction implements SkyFunction {
 
     Preconditions.checkArgument(loadLabels.size() == 1);
     ImmutableList<BzlLoadValue.Key> keys;
-    if (BOOTSTRAP_RULE_CLASSES.contains(ruleClass)) {
+    if (NonRegistryOverride.BOOTSTRAP_RULE_CLASSES.contains(ruleClass)) {
       keys = ImmutableList.of(BzlLoadValue.keyForBzlmodBootstrap(loadLabels.get(0)));
     } else {
       keys = ImmutableList.of(BzlLoadValue.keyForBzlmod(loadLabels.get(0)));
diff --git a/src/main/java/com/google/devtools/build/lib/skyframe/PackageFunction.java b/src/main/java/com/google/devtools/build/lib/skyframe/PackageFunction.java
index d1152c57e6..95eb6d0531 100644
--- a/src/main/java/com/google/devtools/build/lib/skyframe/PackageFunction.java
+++ b/src/main/java/com/google/devtools/build/lib/skyframe/PackageFunction.java
@@ -30,6 +30,7 @@ import com.google.devtools.build.lib.cmdline.LabelConstants;
 import com.google.devtools.build.lib.cmdline.LabelSyntaxException;
 import com.google.devtools.build.lib.cmdline.PackageIdentifier;
 import com.google.devtools.build.lib.cmdline.RepositoryMapping;
+import com.google.devtools.build.lib.cmdline.RepositoryName;
 import com.google.devtools.build.lib.events.Event;
 import com.google.devtools.build.lib.io.FileSymlinkException;
 import com.google.devtools.build.lib.io.InconsistentFilesystemException;
@@ -926,6 +927,8 @@ public abstract class PackageFunction implements SkyFunction {
     RepositoryMappingValue repositoryMappingValue =
         (RepositoryMappingValue)
             env.getValue(RepositoryMappingValue.key(packageId.getRepository()));
+    RepositoryMappingValue mainRepositoryMappingValue =
+        (RepositoryMappingValue) env.getValue(RepositoryMappingValue.key(RepositoryName.MAIN));
     RootedPath buildFileRootedPath = packageLookupValue.getRootedPath(packageId);
     FileValue buildFileValue = getBuildFileValue(env, buildFileRootedPath);
     RuleVisibility defaultVisibility = PrecomputedValue.DEFAULT_VISIBILITY.get(env);
@@ -961,6 +964,7 @@ public abstract class PackageFunction implements SkyFunction {
     }
     String workspaceName = workspaceNameValue.getName();
     RepositoryMapping repositoryMapping = repositoryMappingValue.getRepositoryMapping();
+    RepositoryMapping mainRepositoryMapping = mainRepositoryMappingValue.getRepositoryMapping();
     ImmutableSet<PathFragment> repositoryIgnoredPatterns =
         repositoryIgnoredPackagePrefixes.getPatterns();
     Label preludeLabel = null;
@@ -1108,6 +1112,7 @@ public abstract class PackageFunction implements SkyFunction {
               repositoryMappingValue.getAssociatedModuleVersion(),
               starlarkBuiltinsValue.starlarkSemantics,
               repositoryMapping,
+              mainRepositoryMapping,
               cpuBoundSemaphore.get(),
               /* (Nullable) */ compiled.generatorMap,
               configSettingVisibilityPolicy,
diff --git a/src/main/java/net/starlark/java/eval/MethodLibrary.java b/src/main/java/net/starlark/java/eval/MethodLibrary.java
index 9e3f978bd8..b8d206ad10 100644
--- a/src/main/java/net/starlark/java/eval/MethodLibrary.java
+++ b/src/main/java/net/starlark/java/eval/MethodLibrary.java
@@ -841,14 +841,14 @@ class MethodLibrary {
       if (needSeparator) {
         printer.append(sep);
       }
-      printer.debugPrint(msg, thread.getSemantics());
+      printer.debugPrint(msg, thread);
       needSeparator = true;
     }
     for (Object arg : args) {
       if (needSeparator) {
         printer.append(sep);
       }
-      printer.debugPrint(arg, thread.getSemantics());
+      printer.debugPrint(arg, thread);
       needSeparator = true;
     }
     throw Starlark.errorf("%s", printer.toString());
@@ -882,7 +882,7 @@ class MethodLibrary {
     String separator = "";
     for (Object x : args) {
       p.append(separator);
-      p.debugPrint(x, thread.getSemantics());
+      p.debugPrint(x, thread);
       separator = sep;
     }
     // The PRINT_TEST_MARKER key is used in tests to verify the effects of command-line options.
diff --git a/src/main/java/net/starlark/java/eval/Printer.java b/src/main/java/net/starlark/java/eval/Printer.java
index 1215f0ef3d..8bfc4626e6 100644
--- a/src/main/java/net/starlark/java/eval/Printer.java
+++ b/src/main/java/net/starlark/java/eval/Printer.java
@@ -114,13 +114,13 @@ public class Printer {
    *
    * <p>Implementations of StarlarkValue may define their own behavior of {@code debugPrint}.
    */
-  public Printer debugPrint(Object o, StarlarkSemantics semantics) {
+  public Printer debugPrint(Object o, StarlarkThread thread) {
     if (o instanceof StarlarkValue) {
-      ((StarlarkValue) o).debugPrint(this, semantics);
+      ((StarlarkValue) o).debugPrint(this, thread);
       return this;
     }
 
-    return this.str(o, semantics);
+    return this.str(o, thread.getSemantics());
   }
 
   /**
diff --git a/src/main/java/net/starlark/java/eval/StarlarkValue.java b/src/main/java/net/starlark/java/eval/StarlarkValue.java
index 851626d634..c4ae15ef76 100644
--- a/src/main/java/net/starlark/java/eval/StarlarkValue.java
+++ b/src/main/java/net/starlark/java/eval/StarlarkValue.java
@@ -57,8 +57,8 @@ public interface StarlarkValue {
    *
    * @param printer a printer to be used for formatting nested values.
    */
-  default void debugPrint(Printer printer, StarlarkSemantics semantics) {
-    str(printer, semantics);
+  default void debugPrint(Printer printer, StarlarkThread thread) {
+    str(printer, thread.getSemantics());
   }
 
   /** Returns the truth-value of this Starlark value. */
diff --git a/src/test/java/com/google/devtools/build/lib/cmdline/LabelTest.java b/src/test/java/com/google/devtools/build/lib/cmdline/LabelTest.java
index 8a09a566f2..f099781f30 100644
--- a/src/test/java/com/google/devtools/build/lib/cmdline/LabelTest.java
+++ b/src/test/java/com/google/devtools/build/lib/cmdline/LabelTest.java
@@ -419,6 +419,12 @@ public class LabelTest {
         .isEqualTo("@unremapped//:unremapped");
   }
 
+  @Test
+  public void testDisplayFormNullMapping() throws Exception {
+    assertThat(displayFormFor("//foo/bar:bar", null)).isEqualTo("//foo/bar:bar");
+    assertThat(displayFormFor("@@foo//bar:bar", null)).isEqualTo("@@foo//bar:bar");
+  }
+
   private static String shorthandDisplayFormFor(
       String rawLabel, RepositoryMapping repositoryMapping) throws Exception {
     return Label.parseCanonical(rawLabel).getShorthandDisplayForm(repositoryMapping);
diff --git a/src/test/java/com/google/devtools/build/lib/cmdline/PackageIdentifierTest.java b/src/test/java/com/google/devtools/build/lib/cmdline/PackageIdentifierTest.java
index 07f025f3f2..3336ed9052 100644
--- a/src/test/java/com/google/devtools/build/lib/cmdline/PackageIdentifierTest.java
+++ b/src/test/java/com/google/devtools/build/lib/cmdline/PackageIdentifierTest.java
@@ -120,6 +120,7 @@ public class PackageIdentifierTest {
                 RepositoryMapping.create(
                     ImmutableMap.of("foo", RepositoryName.create("bar")), RepositoryName.MAIN)))
         .isEqualTo("//some/pkg");
+    assertThat(pkg.getDisplayForm(null)).isEqualTo("//some/pkg");
   }
 
   @Test
@@ -139,5 +140,6 @@ public class PackageIdentifierTest {
                     ImmutableMap.of("local", RepositoryName.create("other_repo")),
                     RepositoryName.MAIN)))
         .isEqualTo("@@canonical//some/pkg");
+    assertThat(pkg.getDisplayForm(null)).isEqualTo("@@canonical//some/pkg");
   }
 }
diff --git a/src/test/java/com/google/devtools/build/lib/cmdline/RepositoryNameTest.java b/src/test/java/com/google/devtools/build/lib/cmdline/RepositoryNameTest.java
index 482f2d2e77..71cb12ac7e 100644
--- a/src/test/java/com/google/devtools/build/lib/cmdline/RepositoryNameTest.java
+++ b/src/test/java/com/google/devtools/build/lib/cmdline/RepositoryNameTest.java
@@ -105,4 +105,21 @@ public class RepositoryNameTest {
                 .getDisplayForm(repositoryMapping))
         .isEqualTo("@@[unknown repo 'local' requested from @@owner]");
   }
+
+  @Test
+  public void testGetDisplayFormWithNullMapping() throws Exception {
+    assertThat(RepositoryName.create("").getDisplayForm(null)).isEmpty();
+    assertThat(RepositoryName.create("canonical").getDisplayForm(null)).isEqualTo("@@canonical");
+
+    assertThat(
+            RepositoryName.create("")
+                .toNonVisible(RepositoryName.create("owner"))
+                .getDisplayForm(null))
+        .isEqualTo("@@[unknown repo '' requested from @@owner]");
+    assertThat(
+            RepositoryName.create("canonical")
+                .toNonVisible(RepositoryName.create("owner"))
+                .getDisplayForm(null))
+        .isEqualTo("@@[unknown repo 'canonical' requested from @@owner]");
+  }
 }
diff --git a/src/test/java/com/google/devtools/build/lib/packages/PackageTest.java b/src/test/java/com/google/devtools/build/lib/packages/PackageTest.java
index 99c70114af..8b56fdc446 100644
--- a/src/test/java/com/google/devtools/build/lib/packages/PackageTest.java
+++ b/src/test/java/com/google/devtools/build/lib/packages/PackageTest.java
@@ -168,6 +168,7 @@ public class PackageTest {
         Optional.empty(),
         /* noImplicitFileExport= */ true,
         /* repositoryMapping= */ RepositoryMapping.ALWAYS_FALLBACK,
+        /* mainRepositoryMapping= */ null,
         /* cpuBoundSemaphore= */ null,
         PackageOverheadEstimator.NOOP_ESTIMATOR,
         /* generatorMap= */ null,
diff --git a/src/test/java/com/google/devtools/build/lib/packages/RuleClassTest.java b/src/test/java/com/google/devtools/build/lib/packages/RuleClassTest.java
index ced3bf236d..f4fcc16bc5 100644
--- a/src/test/java/com/google/devtools/build/lib/packages/RuleClassTest.java
+++ b/src/test/java/com/google/devtools/build/lib/packages/RuleClassTest.java
@@ -271,6 +271,7 @@ public final class RuleClassTest extends PackageLoadingTestCase {
         Optional.empty(),
         StarlarkSemantics.DEFAULT,
         /* repositoryMapping= */ RepositoryMapping.ALWAYS_FALLBACK,
+        /* mainRepositoryMapping= */ null,
         /* cpuBoundSemaphore= */ null,
         /* generatorMap= */ null,
         /* configSettingVisibilityPolicy= */ null,
diff --git a/src/test/java/com/google/devtools/build/lib/packages/RuleFactoryTest.java b/src/test/java/com/google/devtools/build/lib/packages/RuleFactoryTest.java
index 23e4705bc7..73f13601f2 100644
--- a/src/test/java/com/google/devtools/build/lib/packages/RuleFactoryTest.java
+++ b/src/test/java/com/google/devtools/build/lib/packages/RuleFactoryTest.java
@@ -63,6 +63,7 @@ public final class RuleFactoryTest extends PackageLoadingTestCase {
             Optional.empty(),
             StarlarkSemantics.DEFAULT,
             /* repositoryMapping= */ RepositoryMapping.ALWAYS_FALLBACK,
+            /* mainRepositoryMapping= */ null,
             /* cpuBoundSemaphore= */ null,
             /* generatorMap= */ null,
             /* configSettingVisibilityPolicy= */ null,
diff --git a/src/test/java/com/google/devtools/build/lib/starlark/StarlarkIntegrationTest.java b/src/test/java/com/google/devtools/build/lib/starlark/StarlarkIntegrationTest.java
index b048c182e5..1c092c130c 100644
--- a/src/test/java/com/google/devtools/build/lib/starlark/StarlarkIntegrationTest.java
+++ b/src/test/java/com/google/devtools/build/lib/starlark/StarlarkIntegrationTest.java
@@ -1743,7 +1743,7 @@ public class StarlarkIntegrationTest extends BuildViewTestCase {
 
     getConfiguredTarget("//test/starlark:cr");
     assertContainsEvent("output function cr");
-    assertContainsEvent("implementation @@//test/starlark:cr");
+    assertContainsEvent("implementation //test/starlark:cr");
   }
 
   @Test
diff --git a/src/test/java/com/google/devtools/build/lib/starlark/StarlarkRuleImplementationFunctionsTest.java b/src/test/java/com/google/devtools/build/lib/starlark/StarlarkRuleImplementationFunctionsTest.java
index 89aa723382..9da6d9c2a8 100644
--- a/src/test/java/com/google/devtools/build/lib/starlark/StarlarkRuleImplementationFunctionsTest.java
+++ b/src/test/java/com/google/devtools/build/lib/starlark/StarlarkRuleImplementationFunctionsTest.java
@@ -80,6 +80,7 @@ import java.util.regex.Pattern;
 import net.starlark.java.annot.Param;
 import net.starlark.java.annot.StarlarkMethod;
 import net.starlark.java.eval.EvalException;
+import net.starlark.java.eval.Mutability;
 import net.starlark.java.eval.Printer;
 import net.starlark.java.eval.Sequence;
 import net.starlark.java.eval.Starlark;
@@ -3718,7 +3719,13 @@ args.add_all(depset([Label("@@canonical1~//foo:bar"), Label("@@canonical2~//foo:
     setRuleContext(createRuleContext("//foo:foo"));
     ev.exec("args = ruleContext.actions.args()", "args.add_all(['--foo', '--bar'])");
     Args args = (Args) ev.eval("args");
-    assertThat(new Printer().debugPrint(args, getStarlarkSemantics()).toString())
+    assertThat(
+            new Printer()
+                .debugPrint(
+                    args,
+                    StarlarkThread.createTransient(
+                        Mutability.create("test"), getStarlarkSemantics()))
+                .toString())
         .isEqualTo("--foo --bar");
   }
 
diff --git a/src/test/java/com/google/devtools/build/lib/starlark/util/BazelEvaluationTestCase.java b/src/test/java/com/google/devtools/build/lib/starlark/util/BazelEvaluationTestCase.java
index bfe573a175..b8909972de 100644
--- a/src/test/java/com/google/devtools/build/lib/starlark/util/BazelEvaluationTestCase.java
+++ b/src/test/java/com/google/devtools/build/lib/starlark/util/BazelEvaluationTestCase.java
@@ -164,7 +164,8 @@ public final class BazelEvaluationTestCase {
             /* transitiveDigest= */ new byte[0], // dummy value for tests
             TestConstants.TOOLS_REPOSITORY,
             /* networkAllowlistForTests= */ Optional.empty(),
-            fragmentNameToClass)
+            fragmentNameToClass,
+            /* mainRepoMapping= */ null)
         .storeInThread(thread);
   }
 
diff --git a/src/test/java/net/starlark/java/eval/StarlarkEvaluationTest.java b/src/test/java/net/starlark/java/eval/StarlarkEvaluationTest.java
index e08bcd86bd..9b5ebf5980 100644
--- a/src/test/java/net/starlark/java/eval/StarlarkEvaluationTest.java
+++ b/src/test/java/net/starlark/java/eval/StarlarkEvaluationTest.java
@@ -377,7 +377,7 @@ public final class StarlarkEvaluationTest {
         useStarlarkThread = true)
     public String withArgsAndThread(
         StarlarkInt pos1, boolean pos2, boolean named, Sequence<?> args, StarlarkThread thread) {
-      String argsString = debugPrintArgs(args, thread.getSemantics());
+      String argsString = debugPrintArgs(args, thread);
       return "with_args_and_thread("
           + pos1
           + ", "
@@ -416,9 +416,11 @@ public final class StarlarkEvaluationTest {
           @Param(name = "foo", named = true, positional = true),
         },
         extraPositionals = @Param(name = "args"),
-        extraKeywords = @Param(name = "kwargs"))
-    public String withArgsAndKwargs(String foo, Tuple args, Dict<String, Object> kwargs) {
-      String argsString = debugPrintArgs(args, StarlarkSemantics.DEFAULT);
+        extraKeywords = @Param(name = "kwargs"),
+        useStarlarkThread = true)
+    public String withArgsAndKwargs(
+        String foo, Tuple args, Dict<String, Object> kwargs, StarlarkThread thread) {
+      String argsString = debugPrintArgs(args, thread);
       String kwargsString =
           "kwargs("
               + kwargs
@@ -436,12 +438,12 @@ public final class StarlarkEvaluationTest {
     }
   }
 
-  private static String debugPrintArgs(Iterable<?> args, StarlarkSemantics semantics) {
+  private static String debugPrintArgs(Iterable<?> args, StarlarkThread thread) {
     Printer p = new Printer();
     p.append("args(");
     String sep = "";
     for (Object arg : args) {
-      p.append(sep).debugPrint(arg, semantics);
+      p.append(sep).debugPrint(arg, thread);
       sep = ", ";
     }
     return p.append(")").toString();
diff --git a/src/test/py/bazel/bzlmod/bazel_module_test.py b/src/test/py/bazel/bzlmod/bazel_module_test.py
index 683869eeef..2dc0137210 100644
--- a/src/test/py/bazel/bzlmod/bazel_module_test.py
+++ b/src/test/py/bazel/bzlmod/bazel_module_test.py
@@ -943,6 +943,98 @@ class BazelModuleTest(test_base.TestBase):
     _, stdout, _ = self.RunBazel(['run', '//:main'])
     self.assertIn('main function => aaa@1.0', stdout)
 
+  def testLabelDebugPrint(self):
+    """Tests that print emits labels in display form."""
+    self.ScratchFile(
+        'MODULE.bazel',
+        [
+            'bazel_dep(name="other_module", version="1.0")',
+            (
+                'local_path_override(module_name="other_module",'
+                ' path="other_module")'
+            ),
+            'ext = use_extension("//:defs.bzl", "my_ext")',
+            'use_repo(ext, "repo")',
+        ],
+    )
+
+    self.ScratchFile(
+        'WORKSPACE.bzlmod',
+        [
+            'load("//:defs.bzl", "my_repo")',
+            'my_repo(name = "workspace_repo", type = "workspace")',
+        ],
+    )
+
+    self.ScratchFile(
+        'other_module/MODULE.bazel',
+        ['module(name="other_module", version="1.0")'],
+    )
+
+    self.ScratchFile(
+        'defs.bzl',
+        [
+            (
+                'print("toplevel", Label("//:foo"),'
+                ' Label("@other_module//:bar"),'
+                ' Label("@@canonical_name//:baz"))'
+            ),
+            'def _repo_impl(ctx):',
+            (
+                '  print("repo:" + ctx.attr.type, Label("//:foo"),'
+                ' Label("@other_module//:bar"),'
+                ' Label("@@canonical_name//:baz"))'
+            ),
+            '  ctx.file("BUILD")',
+            '  ctx.file("data.bzl", "repo_data = \\"repo\\"")',
+            (
+                'my_repo = repository_rule(implementation=_repo_impl,'
+                ' attrs={"type":attr.string()})'
+            ),
+            'def _ext_impl(ctx):',
+            (
+                '  print("ext", Label("//:foo"), Label("@other_module//:bar"),'
+                ' Label("@@canonical_name//:baz"))'
+            ),
+            '  my_repo(name = "repo", type = "module")',
+            'my_ext = module_extension(implementation=_ext_impl)',
+            'def _rule_impl(ctx):',
+            (
+                '  print("rule", Label("//:foo"), Label("@other_module//:bar"),'
+                ' Label("@@canonical_name//:baz"))'
+            ),
+            'my_rule = rule(implementation=_rule_impl)',
+        ],
+    )
+    self.ScratchFile(
+        'BUILD',
+        [
+            'load("@repo//:data.bzl", "repo_data")',
+            'load("@workspace_repo//:data.bzl", "repo_data")',
+            'load(":defs.bzl", "my_rule")',
+            'my_rule(name = "my_rule")',
+        ],
+    )
+
+    _, _, stderr = self.RunBazel(['build', '--enable_workspace', '//:my_rule'])
+    stderr = '\n'.join(stderr)
+    self.assertIn(
+        'toplevel //:foo @other_module//:bar @@canonical_name//:baz', stderr
+    )
+    self.assertIn(
+        'repo:module //:foo @other_module//:bar @@canonical_name//:baz', stderr
+    )
+    self.assertIn(
+        'repo:workspace //:foo @other_module//:bar @@canonical_name//:baz',
+        stderr,
+    )
+    self.assertIn(
+        'ext //:foo @other_module//:bar @@canonical_name//:baz', stderr
+    )
+    self.assertIn(
+        'rule //:foo @other_module//:bar @@canonical_name//:baz', stderr
+    )
+
 
 if __name__ == '__main__':
   absltest.main()
diff --git a/src/test/shell/bazel/platforms_test.sh b/src/test/shell/bazel/platforms_test.sh
index 77b17a410d..e3b34d6146 100755
--- a/src/test/shell/bazel/platforms_test.sh
+++ b/src/test/shell/bazel/platforms_test.sh
@@ -111,7 +111,7 @@ platform(
 EOF
 
   bazel build --experimental_platforms_api=true :a &> $TEST_log || fail "Build failed"
-  expect_log 'The label is: @@//:my_platform'
+  expect_log 'The label is: //:my_platform'
 }
 
 run_suite "platform repo test"
diff --git a/src/test/shell/bazel/starlark_repository_test.sh b/src/test/shell/bazel/starlark_repository_test.sh
index a53803f14d..0355da9b90 100755
--- a/src/test/shell/bazel/starlark_repository_test.sh
+++ b/src/test/shell/bazel/starlark_repository_test.sh
@@ -3269,4 +3269,45 @@ EOF
   true
 }
 
+function test_legacy_label_print() {
+    WRKDIR=$(mktemp -d "${TEST_TMPDIR}/testXXXXXX")
+    cd "${WRKDIR}"
+    cat > WORKSPACE <<'EOF'
+load("//:my_repository_rule.bzl", "my_repository_rule")
+
+my_repository_rule(
+    name = "my_first_repo",
+)
+
+my_repository_rule(
+    name = "my_second_repo",
+)
+EOF
+    cat > my_repository_rule.bzl <<'EOF'
+def _my_repository_rule_impl(rctx):
+    print("main repo:", Label("@@//:foo"), str(Label("@@//:foo")))
+    print("my_first_repo:", Label("@my_first_repo//:foo"), str(Label("@my_first_repo//:foo")))
+    print("my_second_repo:", Label("@my_first_repo//:foo"), str(Label("@my_first_repo//:foo")))
+    rctx.file("WORKSPACE")
+    rctx.file("BUILD", "filegroup(name='foo',visibility=['//visibility:public'])")
+
+my_repository_rule = repository_rule(
+    implementation = _my_repository_rule_impl,
+)
+EOF
+    cat > BUILD <<'EOF'
+filegroup(
+    name = "foo",
+    srcs = [
+        "@my_first_repo//:foo",
+        "@my_second_repo//:foo",
+    ],
+)
+EOF
+    bazel build --noenable_bzlmod //:foo >& $TEST_log || fail "expected bazel to succeed"
+    expect_log "main repo: //:foo @//:foo"
+    expect_log "my_first_repo: @my_first_repo//:foo @my_first_repo//:foo"
+    expect_log "my_second_repo: @my_first_repo//:foo @my_first_repo//:foo"
+}
+
 run_suite "local repository tests"
