diff --git a/src/main/java/com/google/devtools/build/lib/bazel/bzlmod/ArchiveRepoSpecBuilder.java b/src/main/java/com/google/devtools/build/lib/bazel/bzlmod/ArchiveRepoSpecBuilder.java
index e8773d42e9..e0139bcf3b 100644
--- a/src/main/java/com/google/devtools/build/lib/bazel/bzlmod/ArchiveRepoSpecBuilder.java
+++ b/src/main/java/com/google/devtools/build/lib/bazel/bzlmod/ArchiveRepoSpecBuilder.java
@@ -67,18 +67,6 @@ public class ArchiveRepoSpecBuilder {
     return this;
   }
 
-  @CanIgnoreReturnValue
-  public ArchiveRepoSpecBuilder setPatchCmds(ImmutableList<String> patchCmds) {
-    attrBuilder.put("patch_cmds", patchCmds);
-    return this;
-  }
-
-  @CanIgnoreReturnValue
-  public ArchiveRepoSpecBuilder setPatchStrip(int patchStrip) {
-    attrBuilder.put("patch_args", ImmutableList.of("-p" + patchStrip));
-    return this;
-  }
-
   @CanIgnoreReturnValue
   public ArchiveRepoSpecBuilder setRemotePatches(ImmutableMap<String, String> remotePatches) {
     attrBuilder.put("remote_patches", remotePatches);
@@ -98,6 +86,13 @@ public class ArchiveRepoSpecBuilder {
     return this;
   }
 
+  @CanIgnoreReturnValue
+  public ArchiveRepoSpecBuilder setRemoteModuleFile(RemoteFile remoteModuleFile) {
+    attrBuilder.put("remote_module_file_urls", remoteModuleFile.urls());
+    attrBuilder.put("remote_module_file_integrity", remoteModuleFile.integrity());
+    return this;
+  }
+
   @CanIgnoreReturnValue
   public ArchiveRepoSpecBuilder setRemotePatchStrip(int remotePatchStrip) {
     attrBuilder.put("remote_patch_strip", StarlarkInt.of(remotePatchStrip));
diff --git a/src/main/java/com/google/devtools/build/lib/bazel/bzlmod/GitRepoSpecBuilder.java b/src/main/java/com/google/devtools/build/lib/bazel/bzlmod/GitRepoSpecBuilder.java
index dca37da5b1..5886d4fb80 100644
--- a/src/main/java/com/google/devtools/build/lib/bazel/bzlmod/GitRepoSpecBuilder.java
+++ b/src/main/java/com/google/devtools/build/lib/bazel/bzlmod/GitRepoSpecBuilder.java
@@ -75,18 +75,11 @@ public class GitRepoSpecBuilder {
   }
 
   @CanIgnoreReturnValue
-  public GitRepoSpecBuilder setPatches(List<Label> patches) {
-    return setAttr("patches", patches);
-  }
-
-  @CanIgnoreReturnValue
-  public GitRepoSpecBuilder setPatchArgs(List<String> patchArgs) {
-    return setAttr("patch_args", patchArgs);
-  }
-
-  @CanIgnoreReturnValue
-  public GitRepoSpecBuilder setPatchCmds(List<String> patchCmds) {
-    return setAttr("patch_cmds", patchCmds);
+  public GitRepoSpecBuilder setRemoteModuleFile(
+      ArchiveRepoSpecBuilder.RemoteFile remoteModuleFile) {
+    attrBuilder.put("remote_module_file_urls", remoteModuleFile.urls());
+    attrBuilder.put("remote_module_file_integrity", remoteModuleFile.integrity());
+    return this;
   }
 
   public RepoSpec build() {
diff --git a/src/main/java/com/google/devtools/build/lib/bazel/bzlmod/IndexRegistry.java b/src/main/java/com/google/devtools/build/lib/bazel/bzlmod/IndexRegistry.java
index c158c23c60..d0b680e65f 100644
--- a/src/main/java/com/google/devtools/build/lib/bazel/bzlmod/IndexRegistry.java
+++ b/src/main/java/com/google/devtools/build/lib/bazel/bzlmod/IndexRegistry.java
@@ -22,6 +22,7 @@ import com.google.common.base.Preconditions;
 import com.google.common.base.Strings;
 import com.google.common.collect.ImmutableList;
 import com.google.common.collect.ImmutableMap;
+import com.google.devtools.build.lib.bazel.bzlmod.ArchiveRepoSpecBuilder.RemoteFile;
 import com.google.devtools.build.lib.bazel.bzlmod.Version.ParseException;
 import com.google.devtools.build.lib.bazel.repository.downloader.Checksum;
 import com.google.devtools.build.lib.bazel.repository.downloader.Checksum.MissingChecksumException;
@@ -145,9 +146,10 @@ public class IndexRegistry implements Registry {
       maybeContent = Optional.of(doGrabFile(downloadManager, url, eventHandler, useChecksum));
       return maybeContent.get();
     } finally {
-      if ((knownFileHashesMode == KnownFileHashesMode.USE_AND_UPDATE
-              || knownFileHashesMode == KnownFileHashesMode.USE_IMMUTABLE_AND_UPDATE)
-          && useChecksum) {
+      // We intentionally don't check knownFileHashesMode here: The checksums of module files are
+      // always needed for the remote_module_file_integrity attributes of the http_archive backing
+      // the module repo.
+      if (useChecksum) {
         eventHandler.post(RegistryFileDownloadEvent.create(url, maybeContent));
       }
     }
@@ -240,12 +242,15 @@ public class IndexRegistry implements Registry {
   public ModuleFile getModuleFile(
       ModuleKey key, ExtendedEventHandler eventHandler, DownloadManager downloadManager)
       throws IOException, InterruptedException, NotFoundException {
-    String url =
-        constructUrl(getUrl(), "modules", key.name(), key.version().toString(), "MODULE.bazel");
+    String url = constructModuleFileUrl(key);
     byte[] content = grabFile(url, eventHandler, downloadManager, /* useChecksum= */ true);
     return ModuleFile.create(content, url);
   }
 
+  private String constructModuleFileUrl(ModuleKey key) {
+    return constructUrl(getUrl(), "modules", key.name(), key.version().toString(), "MODULE.bazel");
+  }
+
   /** Represents fields available in {@code bazel_registry.json} for the registry. */
   private static class BazelRegistryJson {
     String[] mirrors;
@@ -333,7 +338,10 @@ public class IndexRegistry implements Registry {
 
   @Override
   public RepoSpec getRepoSpec(
-      ModuleKey key, ExtendedEventHandler eventHandler, DownloadManager downloadManager)
+      ModuleKey key,
+      ImmutableMap<String, Optional<Checksum>> moduleFileHashes,
+      ExtendedEventHandler eventHandler,
+      DownloadManager downloadManager)
       throws IOException, InterruptedException {
     String jsonUrl = getSourceJsonUrl(key);
     Optional<String> jsonString =
@@ -348,8 +356,14 @@ public class IndexRegistry implements Registry {
       case "archive" -> {
         ArchiveSourceJson typedSourceJson =
             parseJson(jsonString.get(), jsonUrl, ArchiveSourceJson.class);
+        var moduleFileUrl = constructModuleFileUrl(key);
+        var moduleFileChecksum = moduleFileHashes.get(moduleFileUrl).get();
         return createArchiveRepoSpec(
-            typedSourceJson, getBazelRegistryJson(eventHandler, downloadManager), key);
+            typedSourceJson,
+            moduleFileUrl,
+            moduleFileChecksum,
+            getBazelRegistryJson(eventHandler, downloadManager),
+            key);
       }
       case "local_path" -> {
         LocalPathSourceJson typedSourceJson =
@@ -360,7 +374,9 @@ public class IndexRegistry implements Registry {
       case "git_repository" -> {
         GitRepoSourceJson typedSourceJson =
             parseJson(jsonString.get(), jsonUrl, GitRepoSourceJson.class);
-        return createGitRepoSpec(typedSourceJson);
+        var moduleFileUrl = constructModuleFileUrl(key);
+        var moduleFileChecksum = moduleFileHashes.get(moduleFileUrl).get();
+        return createGitRepoSpec(typedSourceJson, moduleFileUrl, moduleFileChecksum);
       }
       default ->
           throw new IOException(
@@ -424,7 +440,11 @@ public class IndexRegistry implements Registry {
   }
 
   private RepoSpec createArchiveRepoSpec(
-      ArchiveSourceJson sourceJson, Optional<BazelRegistryJson> bazelRegistryJson, ModuleKey key)
+      ArchiveSourceJson sourceJson,
+      String moduleFileUrl,
+      Checksum moduleFileChecksum,
+      Optional<BazelRegistryJson> bazelRegistryJson,
+      ModuleKey key)
       throws IOException {
     URL sourceUrl = sourceJson.url;
     if (sourceUrl == null) {
@@ -498,12 +518,16 @@ public class IndexRegistry implements Registry {
         .setStripPrefix(Strings.nullToEmpty(sourceJson.stripPrefix))
         .setRemotePatches(remotePatches.buildOrThrow())
         .setOverlay(overlay)
+        .setRemoteModuleFile(
+            new RemoteFile(
+                moduleFileChecksum.toSubresourceIntegrity(), ImmutableList.of(moduleFileUrl)))
         .setRemotePatchStrip(sourceJson.patchStrip)
         .setArchiveType(sourceJson.archiveType)
         .build();
   }
 
-  private RepoSpec createGitRepoSpec(GitRepoSourceJson sourceJson) {
+  private RepoSpec createGitRepoSpec(
+      GitRepoSourceJson sourceJson, String moduleFileUrl, Checksum moduleFileChecksum) {
     return new GitRepoSpecBuilder()
         .setRemote(sourceJson.remote)
         .setCommit(sourceJson.commit)
@@ -512,6 +536,9 @@ public class IndexRegistry implements Registry {
         .setInitSubmodules(sourceJson.initSubmodules)
         .setVerbose(sourceJson.verbose)
         .setStripPrefix(sourceJson.stripPrefix)
+        .setRemoteModuleFile(
+            new RemoteFile(
+                moduleFileChecksum.toSubresourceIntegrity(), ImmutableList.of(moduleFileUrl)))
         .build();
   }
 
diff --git a/src/main/java/com/google/devtools/build/lib/bazel/bzlmod/Registry.java b/src/main/java/com/google/devtools/build/lib/bazel/bzlmod/Registry.java
index b2825c0373..6c0a886ddf 100644
--- a/src/main/java/com/google/devtools/build/lib/bazel/bzlmod/Registry.java
+++ b/src/main/java/com/google/devtools/build/lib/bazel/bzlmod/Registry.java
@@ -16,6 +16,7 @@
 package com.google.devtools.build.lib.bazel.bzlmod;
 
 import com.google.common.collect.ImmutableMap;
+import com.google.devtools.build.lib.bazel.repository.downloader.Checksum;
 import com.google.devtools.build.lib.bazel.repository.downloader.DownloadManager;
 import com.google.devtools.build.lib.events.ExtendedEventHandler;
 import com.google.devtools.build.skyframe.NotComparableSkyValue;
@@ -50,7 +51,10 @@ public interface Registry extends NotComparableSkyValue {
    * by {@code key} should be materialized as a repo.
    */
   RepoSpec getRepoSpec(
-      ModuleKey key, ExtendedEventHandler eventHandler, DownloadManager downloadManager)
+      ModuleKey key,
+      ImmutableMap<String, Optional<Checksum>> moduleFileHashes,
+      ExtendedEventHandler eventHandler,
+      DownloadManager downloadManager)
       throws IOException, InterruptedException;
 
   /**
diff --git a/src/main/java/com/google/devtools/build/lib/bazel/bzlmod/RegistryFileDownloadEvent.java b/src/main/java/com/google/devtools/build/lib/bazel/bzlmod/RegistryFileDownloadEvent.java
index 8278d11cc0..4b373fd2f4 100644
--- a/src/main/java/com/google/devtools/build/lib/bazel/bzlmod/RegistryFileDownloadEvent.java
+++ b/src/main/java/com/google/devtools/build/lib/bazel/bzlmod/RegistryFileDownloadEvent.java
@@ -34,8 +34,8 @@ public record RegistryFileDownloadEvent(String uri, Optional<Checksum> checksum)
   static ImmutableMap<String, Optional<Checksum>> collectToMap(Collection<Postable> postables) {
     ImmutableMap.Builder<String, Optional<Checksum>> builder = ImmutableMap.builder();
     for (Postable postable : postables) {
-      if (postable instanceof RegistryFileDownloadEvent event) {
-        builder.put(event.uri(), event.checksum());
+      if (postable instanceof RegistryFileDownloadEvent(String uri, Optional<Checksum> checksum)) {
+        builder.put(uri, checksum);
       }
     }
     return builder.buildKeepingLast();
diff --git a/src/main/java/com/google/devtools/build/lib/bazel/bzlmod/RepoSpecFunction.java b/src/main/java/com/google/devtools/build/lib/bazel/bzlmod/RepoSpecFunction.java
index fc4a18eb3f..5fb8c80729 100644
--- a/src/main/java/com/google/devtools/build/lib/bazel/bzlmod/RepoSpecFunction.java
+++ b/src/main/java/com/google/devtools/build/lib/bazel/bzlmod/RepoSpecFunction.java
@@ -45,13 +45,23 @@ public class RepoSpecFunction implements SkyFunction {
     if (registry == null) {
       return null;
     }
+    ModuleFileValue moduleFileValue =
+        (ModuleFileValue) env.getValue(ModuleFileValue.key(key.moduleKey()));
+    if (moduleFileValue == null) {
+      return null;
+    }
 
     StoredEventHandler downloadEvents = new StoredEventHandler();
     RepoSpec repoSpec;
     try (SilentCloseable c =
         Profiler.instance()
             .profile(ProfilerTask.BZLMOD, () -> "compute repo spec: " + key.moduleKey())) {
-      repoSpec = registry.getRepoSpec(key.moduleKey(), downloadEvents, this.downloadManager);
+      repoSpec =
+          registry.getRepoSpec(
+              key.moduleKey(),
+              moduleFileValue.registryFileHashes(),
+              downloadEvents,
+              this.downloadManager);
     } catch (IOException e) {
       throw new RepoSpecException(
           ExternalDepsException.withCauseAndMessage(
diff --git a/src/test/java/com/google/devtools/build/lib/bazel/bzlmod/FakeRegistry.java b/src/test/java/com/google/devtools/build/lib/bazel/bzlmod/FakeRegistry.java
index bc7d66895a..b0d111fbcd 100644
--- a/src/test/java/com/google/devtools/build/lib/bazel/bzlmod/FakeRegistry.java
+++ b/src/test/java/com/google/devtools/build/lib/bazel/bzlmod/FakeRegistry.java
@@ -80,7 +80,10 @@ public class FakeRegistry implements Registry {
 
   @Override
   public RepoSpec getRepoSpec(
-      ModuleKey key, ExtendedEventHandler eventHandler, DownloadManager downloadManager) {
+      ModuleKey key,
+      ImmutableMap<String, Optional<Checksum>> moduleFileHashes,
+      ExtendedEventHandler eventHandler,
+      DownloadManager downloadManager) {
     RepoSpec repoSpec =
         LocalPathRepoSpecs.create(rootPath + "/" + key.getCanonicalRepoNameWithVersion().getName());
     eventHandler.post(
diff --git a/src/test/java/com/google/devtools/build/lib/bazel/bzlmod/IndexRegistryTest.java b/src/test/java/com/google/devtools/build/lib/bazel/bzlmod/IndexRegistryTest.java
index 2c09abbd54..7484f58f54 100644
--- a/src/test/java/com/google/devtools/build/lib/bazel/bzlmod/IndexRegistryTest.java
+++ b/src/test/java/com/google/devtools/build/lib/bazel/bzlmod/IndexRegistryTest.java
@@ -187,6 +187,7 @@ public class IndexRegistryTest extends FoundationTestCase {
         "  \"integrity\": \"sha256-blah\",",
         "  \"strip_prefix\": \"pref\"",
         "}");
+    server.serve("/modules/foo/1.0/MODULE.bazel", "module(name = \"foo\", version = \"1.0\")");
     server.serve(
         "/modules/bar/2.0/source.json",
         "{",
@@ -198,6 +199,7 @@ public class IndexRegistryTest extends FoundationTestCase {
         "  },",
         "  \"patch_strip\": 3",
         "}");
+    server.serve("/modules/bar/2.0/MODULE.bazel", "module(name = \"bar\", version = \"2.0\")");
     server.serve(
         "/modules/baz/3.0/source.json",
         """
@@ -209,7 +211,16 @@ public class IndexRegistryTest extends FoundationTestCase {
             }
         }
         """);
+    server.serve("/modules/baz/3.0/MODULE.bazel", "module(name = \"baz\", version = \"3.0\")");
     server.start();
+    var moduleFileRegistryHashes =
+        ImmutableMap.of(
+            server.getUrl() + "/modules/foo/1.0/MODULE.bazel",
+            Optional.of(sha256("module(name = \"foo\", version = \"1.0\")")),
+            server.getUrl() + "/modules/baz/3.0/MODULE.bazel",
+            Optional.of(sha256("module(name = \"baz\", version = \"3.0\")")),
+            server.getUrl() + "/modules/bar/2.0/MODULE.bazel",
+            Optional.of(sha256("module(name = \"bar\", version = \"2.0\")")));
 
     Registry registry =
         registryFactory.createRegistry(
@@ -218,7 +229,9 @@ public class IndexRegistryTest extends FoundationTestCase {
             ImmutableMap.of(),
             ImmutableMap.of(),
             Optional.empty());
-    assertThat(registry.getRepoSpec(createModuleKey("foo", "1.0"), reporter, downloadManager))
+    assertThat(
+            registry.getRepoSpec(
+                createModuleKey("foo", "1.0"), moduleFileRegistryHashes, reporter, downloadManager))
         .isEqualTo(
             new ArchiveRepoSpecBuilder()
                 .setUrls(
@@ -232,9 +245,16 @@ public class IndexRegistryTest extends FoundationTestCase {
                 .setStripPrefix("pref")
                 .setRemotePatches(ImmutableMap.of())
                 .setOverlay(ImmutableMap.of())
+                .setRemoteModuleFile(
+                    new ArchiveRepoSpecBuilder.RemoteFile(
+                        sha256("module(name = \"foo\", version = \"1.0\")")
+                            .toSubresourceIntegrity(),
+                        ImmutableList.of(server.getUrl() + "/modules/foo/1.0/MODULE.bazel")))
                 .setRemotePatchStrip(0)
                 .build());
-    assertThat(registry.getRepoSpec(createModuleKey("bar", "2.0"), reporter, downloadManager))
+    assertThat(
+            registry.getRepoSpec(
+                createModuleKey("bar", "2.0"), moduleFileRegistryHashes, reporter, downloadManager))
         .isEqualTo(
             new ArchiveRepoSpecBuilder()
                 .setUrls(
@@ -251,8 +271,15 @@ public class IndexRegistryTest extends FoundationTestCase {
                             "sha256-kek"))
                 .setRemotePatchStrip(3)
                 .setOverlay(ImmutableMap.of())
+                .setRemoteModuleFile(
+                    new ArchiveRepoSpecBuilder.RemoteFile(
+                        sha256("module(name = \"bar\", version = \"2.0\")")
+                            .toSubresourceIntegrity(),
+                        ImmutableList.of(server.getUrl() + "/modules/bar/2.0/MODULE.bazel")))
                 .build());
-    assertThat(registry.getRepoSpec(createModuleKey("baz", "3.0"), reporter, downloadManager))
+    assertThat(
+            registry.getRepoSpec(
+                createModuleKey("baz", "3.0"), moduleFileRegistryHashes, reporter, downloadManager))
         .isEqualTo(
             new ArchiveRepoSpecBuilder()
                 .setUrls(
@@ -270,11 +297,68 @@ public class IndexRegistryTest extends FoundationTestCase {
                             // URLs in the registry itself are not mirrored.
                             ImmutableList.of(
                                 server.getUrl() + "/modules/baz/3.0/overlay/BUILD.bazel"))))
+                .setRemoteModuleFile(
+                    new ArchiveRepoSpecBuilder.RemoteFile(
+                        sha256("module(name = \"baz\", version = \"3.0\")")
+                            .toSubresourceIntegrity(),
+                        ImmutableList.of(server.getUrl() + "/modules/baz/3.0/MODULE.bazel")))
                 .setRemotePatches(ImmutableMap.of())
                 .setRemotePatchStrip(0)
                 .build());
   }
 
+  @Test
+  public void testGetGitRepoSpec() throws Exception {
+    server.serve(
+        "/bazel_registry.json",
+        """
+        {
+          "mirrors": [
+            "https://mirror.bazel.build/",
+            "file:///home/bazel/mymirror/"
+          ]
+        }
+        """);
+    server.serve(
+        "/modules/foo/1.0/source.json",
+        """
+        {
+            "type": "git_repository",
+            "remote": "https://github.com/raspberrypi/pico-sdk.git",
+            "commit": "4b6e647590213f253f2789ad9026df1d00f38c5d"
+        }
+        """);
+    server.serve("/modules/foo/1.0/MODULE.bazel", "module(name = \"foo\", version = \"1.0\")");
+    server.start();
+    var moduleFileRegistryHashes =
+        ImmutableMap.of(
+            server.getUrl() + "/modules/foo/1.0/MODULE.bazel",
+            Optional.of(sha256("module(name = \"foo\", version = \"1.0\")")));
+
+    Registry registry =
+        registryFactory.createRegistry(
+            server.getUrl(),
+            LockfileMode.UPDATE,
+            ImmutableMap.of(),
+            ImmutableMap.of(),
+            Optional.empty());
+    assertThat(
+            registry.getRepoSpec(
+                createModuleKey("foo", "1.0"), moduleFileRegistryHashes, reporter, downloadManager))
+        .isEqualTo(
+            new GitRepoSpecBuilder()
+                .setRemote("https://github.com/raspberrypi/pico-sdk.git")
+                .setCommit("4b6e647590213f253f2789ad9026df1d00f38c5d")
+                .setInitSubmodules(false)
+                .setVerbose(false)
+                .setRemoteModuleFile(
+                    new ArchiveRepoSpecBuilder.RemoteFile(
+                        sha256("module(name = \"foo\", version = \"1.0\")")
+                            .toSubresourceIntegrity(),
+                        ImmutableList.of(server.getUrl() + "/modules/foo/1.0/MODULE.bazel")))
+                .build());
+  }
+
   @Test
   public void testGetLocalPathRepoSpec() throws Exception {
     server.serve("/bazel_registry.json", "{", "  \"module_base_path\": \"/hello/foo\"", "}");
@@ -293,7 +377,9 @@ public class IndexRegistryTest extends FoundationTestCase {
             ImmutableMap.of(),
             ImmutableMap.of(),
             Optional.empty());
-    assertThat(registry.getRepoSpec(createModuleKey("foo", "1.0"), reporter, downloadManager))
+    assertThat(
+            registry.getRepoSpec(
+                createModuleKey("foo", "1.0"), ImmutableMap.of(), reporter, downloadManager))
         .isEqualTo(LocalPathRepoSpecs.create("/hello/bar/project_x"));
   }
 
@@ -308,6 +394,7 @@ public class IndexRegistryTest extends FoundationTestCase {
         "  \"integrity\": \"sha256-blah\",",
         "  \"strip_prefix\": \"pref\"",
         "}");
+    server.serve("/modules/foo/1.0/MODULE.bazel", "module(name = \"foo\", version = \"1.0\")");
 
     Registry registry =
         registryFactory.createRegistry(
@@ -316,7 +403,14 @@ public class IndexRegistryTest extends FoundationTestCase {
             ImmutableMap.of(),
             ImmutableMap.of(),
             Optional.empty());
-    assertThat(registry.getRepoSpec(createModuleKey("foo", "1.0"), reporter, downloadManager))
+    assertThat(
+            registry.getRepoSpec(
+                createModuleKey("foo", "1.0"),
+                ImmutableMap.of(
+                    server.getUrl() + "/modules/foo/1.0/MODULE.bazel",
+                    Optional.of(sha256("module(name = \"foo\", version = \"1.0\")"))),
+                reporter,
+                downloadManager))
         .isEqualTo(
             new ArchiveRepoSpecBuilder()
                 .setUrls(ImmutableList.of("http://mysite.com/thing.zip"))
@@ -324,6 +418,11 @@ public class IndexRegistryTest extends FoundationTestCase {
                 .setStripPrefix("pref")
                 .setRemotePatches(ImmutableMap.of())
                 .setOverlay(ImmutableMap.of())
+                .setRemoteModuleFile(
+                    new ArchiveRepoSpecBuilder.RemoteFile(
+                        sha256("module(name = \"foo\", version = \"1.0\")")
+                            .toSubresourceIntegrity(),
+                        ImmutableList.of(server.getUrl() + "/modules/foo/1.0/MODULE.bazel")))
                 .setRemotePatchStrip(0)
                 .build());
   }
@@ -356,7 +455,9 @@ public class IndexRegistryTest extends FoundationTestCase {
             Optional.empty());
     assertThrows(
         IOException.class,
-        () -> registry.getRepoSpec(createModuleKey("foo", "1.0"), reporter, downloadManager));
+        () ->
+            registry.getRepoSpec(
+                createModuleKey("foo", "1.0"), ImmutableMap.of(), reporter, downloadManager));
   }
 
   @Test
@@ -406,6 +507,9 @@ public class IndexRegistryTest extends FoundationTestCase {
         "  \"integrity\": \"sha256-blah\",",
         "  \"archive_type\": \"zip\"",
         "}");
+    server.serve(
+        "/modules/archive_type/1.0/MODULE.bazel",
+        "module(name = \"archive_type\", version = \"1.0\")");
     server.start();
 
     Registry registry =
@@ -416,7 +520,13 @@ public class IndexRegistryTest extends FoundationTestCase {
             ImmutableMap.of(),
             Optional.empty());
     assertThat(
-            registry.getRepoSpec(createModuleKey("archive_type", "1.0"), reporter, downloadManager))
+            registry.getRepoSpec(
+                createModuleKey("archive_type", "1.0"),
+                ImmutableMap.of(
+                    server.getUrl() + "/modules/archive_type/1.0/MODULE.bazel",
+                    Optional.of(sha256("module(name = \"archive_type\", version = \"1.0\")"))),
+                reporter,
+                downloadManager))
         .isEqualTo(
             new ArchiveRepoSpecBuilder()
                 .setUrls(ImmutableList.of("https://mysite.com/thing?format=zip"))
@@ -426,6 +536,12 @@ public class IndexRegistryTest extends FoundationTestCase {
                 .setRemotePatches(ImmutableMap.of())
                 .setRemotePatchStrip(0)
                 .setOverlay(ImmutableMap.of())
+                .setRemoteModuleFile(
+                    new ArchiveRepoSpecBuilder.RemoteFile(
+                        sha256("module(name = \"archive_type\", version = \"1.0\")")
+                            .toSubresourceIntegrity(),
+                        ImmutableList.of(
+                            server.getUrl() + "/modules/archive_type/1.0/MODULE.bazel")))
                 .build());
   }
 
@@ -571,7 +687,9 @@ public class IndexRegistryTest extends FoundationTestCase {
     Registry registry =
         registryFactory.createRegistry(
             server.getUrl(), LockfileMode.UPDATE, knownFiles, ImmutableMap.of(), Optional.empty());
-    assertThat(registry.getRepoSpec(createModuleKey("foo", "1.0"), reporter, downloadManager))
+    assertThat(
+            registry.getRepoSpec(
+                createModuleKey("foo", "1.0"), ImmutableMap.of(), reporter, downloadManager))
         .isEqualTo(LocalPathRepoSpecs.create("/hello/bar/project_x"));
 
     var recordedChecksums = eventRecorder.getRecordedHashes();
@@ -594,7 +712,9 @@ public class IndexRegistryTest extends FoundationTestCase {
     // changes.
     server.unserve("/bazel_registry.json");
     server.unserve("/modules/foo/1.0/source.json");
-    assertThat(registry.getRepoSpec(createModuleKey("foo", "1.0"), reporter, downloadManager))
+    assertThat(
+            registry.getRepoSpec(
+                createModuleKey("foo", "1.0"), ImmutableMap.of(), reporter, downloadManager))
         .isEqualTo(LocalPathRepoSpecs.create("/hello/bar/project_x"));
   }
 
@@ -632,7 +752,9 @@ public class IndexRegistryTest extends FoundationTestCase {
     var e =
         assertThrows(
             IOException.class,
-            () -> registry.getRepoSpec(createModuleKey("foo", "1.0"), reporter, downloadManager));
+            () ->
+                registry.getRepoSpec(
+                    createModuleKey("foo", "1.0"), ImmutableMap.of(), reporter, downloadManager));
     assertThat(e)
         .hasMessageThat()
         .isEqualTo(
@@ -677,7 +799,9 @@ public class IndexRegistryTest extends FoundationTestCase {
     var e =
         assertThrows(
             IOException.class,
-            () -> registry.getRepoSpec(createModuleKey("foo", "1.0"), reporter, downloadManager));
+            () ->
+                registry.getRepoSpec(
+                    createModuleKey("foo", "1.0"), ImmutableMap.of(), reporter, downloadManager));
     assertThat(e)
         .hasMessageThat()
         .isEqualTo(
diff --git a/src/test/java/com/google/devtools/build/lib/blackbox/tests/workspace/PatchApiBlackBoxTest.java b/src/test/java/com/google/devtools/build/lib/blackbox/tests/workspace/PatchApiBlackBoxTest.java
index fbb6c420c5..cef81708a4 100644
--- a/src/test/java/com/google/devtools/build/lib/blackbox/tests/workspace/PatchApiBlackBoxTest.java
+++ b/src/test/java/com/google/devtools/build/lib/blackbox/tests/workspace/PatchApiBlackBoxTest.java
@@ -62,8 +62,6 @@ public class PatchApiBlackBoxTest extends AbstractBlackBoxTest {
                 "patch_cmds_win": attr.string_list(default = []),
                 "build_file": attr.label(allow_single_file = True),
                 "build_file_content": attr.string(),
-                "workspace_file": attr.label(),
-                "workspace_file_content": attr.string(),
             }
 
             def _patched_repo_implementation(ctx):
diff --git a/src/test/py/bazel/bzlmod/mod_command_test.py b/src/test/py/bazel/bzlmod/mod_command_test.py
index 311b484ee2..0c7354c690 100644
--- a/src/test/py/bazel/bzlmod/mod_command_test.py
+++ b/src/test/py/bazel/bzlmod/mod_command_test.py
@@ -454,6 +454,11 @@ class ModCommandTest(test_base.TestBase):
     )
     self.assertRegex(stdout.pop(4), r'^  urls = \[".*"\],$')
     self.assertRegex(stdout.pop(4), r'^  integrity = ".*",$')
+    self.assertRegex(
+        stdout.pop(7),
+        r'^  remote_module_file_urls = \[".*/modules/bar/2.0/MODULE.bazel"\],$',
+    )
+    self.assertRegex(stdout.pop(7), r'^  remote_module_file_integrity = ".*",$')
     self.assertRegex(stdout.pop(19), r'^  path = ".*",$')
     # lines after '# Rule local_repository defined at (most recent call last):'
     stdout.pop(23)
@@ -462,6 +467,10 @@ class ModCommandTest(test_base.TestBase):
     stdout.pop(45)
     self.assertRegex(stdout.pop(50), r'^  urls = \[".*"\],$')
     self.assertRegex(stdout.pop(50), r'^  integrity = ".*",$')
+    self.assertRegex(stdout.pop(53), r'^  remote_module_file_urls = \[".*"\],$')
+    self.assertRegex(
+        stdout.pop(53), r'^  remote_module_file_integrity = ".*",$'
+    )
     # lines after '# Rule http_archive defined at (most recent call last):'
     stdout.pop(13)
     stdout.pop(58)
@@ -529,6 +538,8 @@ class ModCommandTest(test_base.TestBase):
             '  strip_prefix = "",',
             '  remote_file_urls = {},',
             '  remote_file_integrity = {},',
+            # pop(53) -- remote_module_file_urls=[...]
+            # pop(53) -- remote_module_file_integrity=...
             '  remote_patches = {},',
             '  remote_patch_strip = 0,',
             ')',
diff --git a/src/test/py/bazel/bzlmod/test_utils.py b/src/test/py/bazel/bzlmod/test_utils.py
index 99c8e7def1..9c2cbfb96f 100644
--- a/src/test/py/bazel/bzlmod/test_utils.py
+++ b/src/test/py/bazel/bzlmod/test_utils.py
@@ -227,8 +227,16 @@ class BazelRegistry:
     for foldername, _, filenames in os.walk(str(src_dir)):
       for filename in filenames:
         filepath = os.path.join(foldername, filename)
-        zip_obj.write(filepath,
-                      str(pathlib.Path(filepath).relative_to(src_dir)))
+        arcname = str(pathlib.Path(filepath).relative_to(src_dir))
+        if filename == 'MODULE.bazel':
+          # Verify that MODULE.bazel doesn't have to be included in the archive
+          # by writing an effectively empty one.
+          zip_obj.writestr(
+              arcname,
+              '# FAKE\nmodule(name = "%s", version = "%s")\n' % (name, version),
+          )
+        else:
+          zip_obj.write(filepath, arcname)
     zip_obj.close()
     return zip_path
 
diff --git a/src/test/shell/bazel/external_integration_test.sh b/src/test/shell/bazel/external_integration_test.sh
index f4616b6031..b9e667f8d1 100755
--- a/src/test/shell/bazel/external_integration_test.sh
+++ b/src/test/shell/bazel/external_integration_test.sh
@@ -749,14 +749,6 @@ function test_new_remote_repo_with_build_file_content() {
   do_new_remote_repo_test "build_file_content"
 }
 
-function test_new_remote_repo_with_workspace_file() {
-  do_new_remote_repo_test "workspace_file"
-}
-
-function test_new_remote_repo_with_workspace_file_content() {
-  do_new_remote_repo_test "workspace_file_content"
-}
-
 function do_new_remote_repo_test() {
   # Create a zipped-up repository HTTP response.
   local repo2=$TEST_TMPDIR/repo2
@@ -793,16 +785,6 @@ filegroup(
     build_file_attr="build_file_content=\"\"\"${build_file_content}\"\"\""
   fi
 
-  if [ "$1" = "workspace_file" ]; then
-    touch BUILD
-    cat > fox.WORKSPACE <<EOF
-workspace(name="endangered-fox")
-EOF
-    workspace_file_attr="workspace_file = '@//:fox.WORKSPACE'"
-  elif [ "$1" = "workspace_file_content" ]; then
-    workspace_file_attr="workspace_file_content = 'workspace(name=\"endangered-fox\")'"
-  fi
-
   cat > $(setup_module_dot_bazel) <<EOF
 http_archive = use_repo_rule("@bazel_tools//tools/build_defs/repo:http.bzl", "http_archive")
 http_archive(
@@ -2580,13 +2562,12 @@ function test_overwrite_existing_workspace_build() {
   do
     rm -rf ext ext.tar
     mkdir ext
-    sh -c "${bad_file}" -- ext/WORKSPACE
     sh -c "${bad_file}" -- ext/BUILD.bazel
     echo hello world > ext/data
     tar cvf ext.tar ext
 
     for BUILD_FILE in \
-      'build_file_content = '\''exports_files(["data", "WORKSPACE"])'\' \
+      'build_file_content = '\''exports_files(["data"])'\' \
       'build_file = "@//:external_build_file"'
     do
       rm -rf main
@@ -2609,7 +2590,7 @@ EOF
       echo
 
       cat > external_build_file <<'EOF'
-exports_files(["data", "WORKSPACE"])
+exports_files(["data"])
 EOF
 
       cat > BUILD <<'EOF'
@@ -2619,21 +2600,11 @@ genrule(
   srcs = ["@ext//:data"],
   outs = ["it.txt"],
 )
-
-genrule(
-  name = "ws",
-  cmd = "cp $< $@",
-  srcs = ["@ext//:WORKSPACE"],
-  outs = ["ws.txt"],
-)
 EOF
 
       bazel build //:it || fail "Expected success"
       grep 'world' `bazel info bazel-genfiles`/it.txt \
           || fail "Wrong content of data file"
-      bazel build //:ws || fail "Expected success"
-      grep 'BAD' `bazel info bazel-genfiles`/ws.txt \
-          && fail "WORKSPACE file not overwritten" || :
 
       cd ..
     done
diff --git a/src/test/tools/bzlmod/MODULE.bazel.lock b/src/test/tools/bzlmod/MODULE.bazel.lock
index e208a1d590..91a481cb78 100644
--- a/src/test/tools/bzlmod/MODULE.bazel.lock
+++ b/src/test/tools/bzlmod/MODULE.bazel.lock
@@ -135,7 +135,7 @@
   "moduleExtensions": {
     "@@pybind11_bazel+//:python_configure.bzl%extension": {
       "general": {
-        "bzlTransitiveDigest": "OMjJ8aOAn337bDg7jdyvF/juIrC2PpUcX6Dnf+nhcF0=",
+        "bzlTransitiveDigest": "Q9eHGkSOelWkhA+dPbe+Gtna/4A6ToVP+iK+P8y99JQ=",
         "usagesDigest": "fycyB39YnXIJkfWCIXLUKJMZzANcuLy9ZE73hRucjFk=",
         "recordedFileInputs": {
           "@@pybind11_bazel+//MODULE.bazel": "88af1c246226d87e65be78ed49ecd1e6f5e98648558c14ce99176da041dc378e"
@@ -169,7 +169,7 @@
     },
     "@@rules_fuzzing+//fuzzing/private:extensions.bzl%non_module_dependencies": {
       "general": {
-        "bzlTransitiveDigest": "lxvzPQyluk241QRYY81nZHOcv5Id/5U2y6dp42qibis=",
+        "bzlTransitiveDigest": "9Gtqclz3ve0le470OS8PxgZsXORheQh+6RjxC2anJPI=",
         "usagesDigest": "wy6ISK6UOcBEjj/mvJ/S3WeXoO67X+1llb9yPyFtPgc=",
         "recordedFileInputs": {},
         "recordedDirentsInputs": {},
@@ -252,7 +252,7 @@
     },
     "@@rules_kotlin+//src/main/starlark/core/repositories:bzlmod_setup.bzl%rules_kotlin_extensions": {
       "general": {
-        "bzlTransitiveDigest": "hUTp2w+RUVdL7ma5esCXZJAFnX7vLbVfLd7FwnQI6bU=",
+        "bzlTransitiveDigest": "liKqgVorbQI0m9bE0Di94bdcX8m1qT4Haz36ZH8+Y/I=",
         "usagesDigest": "QI2z8ZUR+mqtbwsf2fLqYdJAkPOHdOV+tF2yVAUgRzw=",
         "recordedFileInputs": {},
         "recordedDirentsInputs": {},
@@ -316,7 +316,7 @@
     },
     "@@rules_python+//python/extensions:pip.bzl%pip": {
       "general": {
-        "bzlTransitiveDigest": "zNe2l0ea9Z9BBXe9oPIxbzzZ/h0QnNzcTSvTbKT+kFI=",
+        "bzlTransitiveDigest": "/o7S1VcRD+OUswJCmkF53n3Gh2UQeUgKDZVkU7OC0Vo=",
         "usagesDigest": "fztm9ST3ki9E77tct2ZwJe0w38LvfMY8mRYp+YHxXQE=",
         "recordedFileInputs": {
           "@@protobuf+//python/requirements.txt": "983be60d3cec4b319dcab6d48aeb3f5b2f7c3350f26b3a9e97486c37967c73c5",
diff --git a/tools/build_defs/repo/git.bzl b/tools/build_defs/repo/git.bzl
index d3b66c24a7..f0f9bfb55b 100644
--- a/tools/build_defs/repo/git.bzl
+++ b/tools/build_defs/repo/git.bzl
@@ -23,6 +23,7 @@
 load(":git_worker.bzl", "git_repo")
 load(
     ":utils.bzl",
+    "get_auth",
     "patch",
     "update_attrs",
     "workspace_and_buildfile",
@@ -151,6 +152,14 @@ _common_attrs = {
               "applied. If this attribute is not set, patch_cmds will be executed on Windows, " +
               "which requires Bash binary to exist.",
     ),
+    "remote_module_file_urls": attr.string_list(
+        default = [],
+        doc = "For internal use only.",
+    ),
+    "remote_module_file_integrity": attr.string(
+        default = "",
+        doc = "For internal use only.",
+    ),
     "build_file": attr.label(
         allow_single_file = True,
         doc =
@@ -165,16 +174,10 @@ _common_attrs = {
             "The content for the BUILD file for this repository. ",
     ),
     "workspace_file": attr.label(
-        doc =
-            "The file to use as the `WORKSPACE` file for this repository. " +
-            "Either `workspace_file` or `workspace_file_content` can be " +
-            "specified, or neither, but not both.",
+        doc = "No-op attribute; do not use.",
     ),
     "workspace_file_content": attr.string(
-        doc =
-            "The content for the WORKSPACE file for this repository. " +
-            "Either `workspace_file` or `workspace_file_content` can be " +
-            "specified, or neither, but not both.",
+        doc = "No-op attribute; do not use.",
     ),
     "sparse_checkout_patterns": attr.string_list(
         default = [],
@@ -197,6 +200,18 @@ def _git_repository_implementation(ctx):
     update = _clone_or_update_repo(ctx)
     workspace_and_buildfile(ctx)
     patch(ctx)
+
+    # Download the module file after applying patches since modules may decide
+    # to patch their packaged module and the patch may not apply to the file
+    # checked in to the registry. This overrides the file if it exists.
+    if ctx.attr.remote_module_file_urls:
+        ctx.download(
+            ctx.attr.remote_module_file_urls,
+            "MODULE.bazel",
+            auth = get_auth(ctx, ctx.attr.remote_module_file_urls),
+            integrity = ctx.attr.remote_module_file_integrity,
+        )
+
     if ctx.attr.strip_prefix:
         ctx.delete(ctx.path(".tmp_git_root/.git"))
     else:
diff --git a/tools/build_defs/repo/http.bzl b/tools/build_defs/repo/http.bzl
index b5132fe2f0..979522bee1 100644
--- a/tools/build_defs/repo/http.bzl
+++ b/tools/build_defs/repo/http.bzl
@@ -151,6 +151,17 @@ def _http_archive_impl(ctx):
     download_remote_files(ctx)
     patch(ctx)
 
+    # Download the module file after applying patches since modules may decide
+    # to patch their packaged module and the patch may not apply to the file
+    # checked in to the registry. This overrides the file if it exists.
+    if ctx.attr.remote_module_file_urls:
+        ctx.download(
+            ctx.attr.remote_module_file_urls,
+            "MODULE.bazel",
+            auth = get_auth(ctx, ctx.attr.remote_module_file_urls),
+            integrity = ctx.attr.remote_module_file_integrity,
+        )
+
     return _update_integrity_attr(ctx, _http_archive_attrs, download_info)
 
 _HTTP_FILE_BUILD = """\
@@ -317,6 +328,14 @@ following: `"zip"`, `"jar"`, `"war"`, `"aar"`, `"tar"`, `"tar.gz"`, `"tgz"`,
             "A map of file relative paths (key) to its integrity value (value). These relative paths should map " +
             "to the files (key) in the `remote_file_urls` attribute.",
     ),
+    "remote_module_file_urls": attr.string_list(
+        default = [],
+        doc = "For internal use only.",
+    ),
+    "remote_module_file_integrity": attr.string(
+        default = "",
+        doc = "For internal use only.",
+    ),
     "remote_patches": attr.string_dict(
         default = {},
         doc =
@@ -378,16 +397,10 @@ following: `"zip"`, `"jar"`, `"war"`, `"aar"`, `"tar"`, `"tar.gz"`, `"tgz"`,
             "not both.",
     ),
     "workspace_file": attr.label(
-        doc =
-            "The file to use as the `WORKSPACE` file for this repository. " +
-            "Either `workspace_file` or `workspace_file_content` can be " +
-            "specified, or neither, but not both.",
+        doc = "No-op attribute; do not use.",
     ),
     "workspace_file_content": attr.string(
-        doc =
-            "The content for the WORKSPACE file for this repository. " +
-            "Either `workspace_file` or `workspace_file_content` can be " +
-            "specified, or neither, but not both.",
+        doc = "No-op attribute; do not use.",
     ),
 }
 
diff --git a/tools/build_defs/repo/utils.bzl b/tools/build_defs/repo/utils.bzl
index 6c7a03e1fc..a0f03b0409 100644
--- a/tools/build_defs/repo/utils.bzl
+++ b/tools/build_defs/repo/utils.bzl
@@ -38,14 +38,15 @@ load(
 # Temporary directory for downloading remote patch files.
 _REMOTE_PATCH_DIR = ".tmp_remote_patches"
 
+# Name preserved for backwards compatibility only - this function used to
+# write a WORKSPACE file if requested.
 def workspace_and_buildfile(ctx):
-    """Utility function for writing WORKSPACE and, if requested, a BUILD file.
+    """Utility function for writing a BUILD file.
 
     This rule is intended to be used in the implementation function of a
     repository rule.
-    It assumes the parameters `name`, `build_file`, `build_file_content`,
-    `workspace_file`, and `workspace_file_content` to be
-    present in `ctx.attr`; the latter four possibly with value None.
+    It assumes the parameters `name`, `build_file`, and `build_file_content` to
+    be present in `ctx.attr`; the latter two possibly with value None.
 
     Args:
       ctx: The repository context of the repository rule calling this utility
@@ -54,16 +55,6 @@ def workspace_and_buildfile(ctx):
     if ctx.attr.build_file and ctx.attr.build_file_content:
         ctx.fail("Only one of build_file and build_file_content can be provided.")
 
-    if ctx.attr.workspace_file and ctx.attr.workspace_file_content:
-        ctx.fail("Only one of workspace_file and workspace_file_content can be provided.")
-
-    if ctx.attr.workspace_file:
-        ctx.file("WORKSPACE", ctx.read(ctx.attr.workspace_file))
-    elif ctx.attr.workspace_file_content:
-        ctx.file("WORKSPACE", ctx.attr.workspace_file_content)
-    else:
-        ctx.file("WORKSPACE", "workspace(name = \"{name}\")\n".format(name = ctx.name))
-
     if ctx.attr.build_file:
         ctx.file("BUILD.bazel", ctx.read(ctx.attr.build_file))
     elif ctx.attr.build_file_content:
