diff --git a/src/main/java/com/google/devtools/build/lib/skyframe/PlatformMappingFunction.java b/src/main/java/com/google/devtools/build/lib/skyframe/PlatformMappingFunction.java
index 6cdead5dbe..59464acced 100644
--- a/src/main/java/com/google/devtools/build/lib/skyframe/PlatformMappingFunction.java
+++ b/src/main/java/com/google/devtools/build/lib/skyframe/PlatformMappingFunction.java
@@ -29,7 +29,9 @@ import com.google.devtools.build.lib.actions.FileValue;
 import com.google.devtools.build.lib.actions.MissingInputFileException;
 import com.google.devtools.build.lib.analysis.config.FragmentOptions;
 import com.google.devtools.build.lib.cmdline.Label;
+import com.google.devtools.build.lib.cmdline.Label.RepoContext;
 import com.google.devtools.build.lib.cmdline.LabelSyntaxException;
+import com.google.devtools.build.lib.cmdline.RepositoryName;
 import com.google.devtools.build.lib.cmdline.TargetParsingException;
 import com.google.devtools.build.lib.packages.NoSuchTargetException;
 import com.google.devtools.build.lib.packages.Target;
@@ -77,6 +79,14 @@ final class PlatformMappingFunction implements SkyFunction {
     PathFragment workspaceRelativeMappingPath =
         platformMappingKey.getWorkspaceRelativeMappingPath();
 
+    RepositoryMappingValue mainRepositoryMappingValue =
+        (RepositoryMappingValue) env.getValue(RepositoryMappingValue.key(RepositoryName.MAIN));
+    if (mainRepositoryMappingValue == null) {
+      return null;
+    }
+    RepoContext mainRepoContext =
+        RepoContext.of(RepositoryName.MAIN, mainRepositoryMappingValue.getRepositoryMapping());
+
     PathPackageLocator pkgLocator = PrecomputedValue.PATH_PACKAGE_LOCATOR.get(env);
     if (pkgLocator == null) {
       return null;
@@ -113,7 +123,7 @@ final class PlatformMappingFunction implements SkyFunction {
         throw new PlatformMappingException(e, SkyFunctionException.Transience.TRANSIENT);
       }
 
-      Mappings parsed = parse(env, lines);
+      Mappings parsed = parse(env, lines, mainRepoContext);
       if (parsed == null) {
         return null;
       }
@@ -123,7 +133,8 @@ final class PlatformMappingFunction implements SkyFunction {
     if (!platformMappingKey.wasExplicitlySetByUser()) {
       // If no flag was passed and the default mapping file does not exist treat this as if the
       // mapping file was empty rather than an error.
-      return new PlatformMappingValue(ImmutableMap.of(), ImmutableMap.of(), ImmutableSet.of());
+      return new PlatformMappingValue(
+          ImmutableMap.of(), ImmutableMap.of(), ImmutableSet.of(), mainRepoContext.repoMapping());
     }
     throw new PlatformMappingException(
         new MissingInputFileException(
@@ -155,7 +166,8 @@ final class PlatformMappingFunction implements SkyFunction {
   /** Parses the given lines, returns null if not all Skyframe deps are ready. */
   @VisibleForTesting
   @Nullable
-  static Mappings parse(Environment env, List<String> lines) throws PlatformMappingException {
+  static Mappings parse(Environment env, List<String> lines, RepoContext mainRepoContext)
+      throws PlatformMappingException {
     PeekingIterator<String> it =
         Iterators.peekingIterator(
             lines.stream()
@@ -164,7 +176,7 @@ final class PlatformMappingFunction implements SkyFunction {
                 .iterator());
 
     if (!it.hasNext()) {
-      return new Mappings(ImmutableMap.of(), ImmutableMap.of());
+      return new Mappings(ImmutableMap.of(), ImmutableMap.of(), mainRepoContext);
     }
 
     if (!it.peek().equalsIgnoreCase("platforms:") && !it.peek().equalsIgnoreCase("flags:")) {
@@ -178,7 +190,7 @@ final class PlatformMappingFunction implements SkyFunction {
 
     if (it.peek().equalsIgnoreCase("platforms:")) {
       it.next();
-      platformsToFlags = readPlatformsToFlags(it, env);
+      platformsToFlags = readPlatformsToFlags(it, env, mainRepoContext);
       if (platformsToFlags == null) {
         return null;
       }
@@ -189,13 +201,13 @@ final class PlatformMappingFunction implements SkyFunction {
       if (!line.equalsIgnoreCase("flags:")) {
         throw parsingException("Expected 'flags:' but got " + line);
       }
-      flagsToPlatforms = readFlagsToPlatforms(it);
+      flagsToPlatforms = readFlagsToPlatforms(it, mainRepoContext);
     }
 
     if (it.hasNext()) {
       throw parsingException("Expected end of file but got " + it.next());
     }
-    return new Mappings(platformsToFlags, flagsToPlatforms);
+    return new Mappings(platformsToFlags, flagsToPlatforms, mainRepoContext);
   }
 
   /**
@@ -204,16 +216,23 @@ final class PlatformMappingFunction implements SkyFunction {
    */
   private static class SkyframeTargetLoader implements StarlarkOptionsParser.BuildSettingLoader {
     private final Environment env;
+    private final RepoContext mainRepoContext;
 
-    public SkyframeTargetLoader(Environment env) {
+    public SkyframeTargetLoader(Environment env, RepoContext mainRepoContext) {
       this.env = env;
+      this.mainRepoContext = mainRepoContext;
     }
 
     @Nullable
     @Override
     public Target loadBuildSetting(String name)
         throws InterruptedException, TargetParsingException {
-      Label asLabel = Label.parseCanonicalUnchecked(name);
+      Label asLabel;
+      try {
+        asLabel = Label.parseWithRepoContext(name, mainRepoContext);
+      } catch (LabelSyntaxException e) {
+        throw new IllegalArgumentException(e);
+      }
       SkyKey pkgKey = asLabel.getPackageIdentifier();
       PackageValue pkg = (PackageValue) env.getValue(pkgKey);
       if (pkg == null) {
@@ -234,7 +253,8 @@ final class PlatformMappingFunction implements SkyFunction {
    */
   @Nullable
   private static NativeAndStarlarkFlags parseStarlarkFlags(
-      ImmutableSet<String> rawFlags, Environment env) throws PlatformMappingException {
+      ImmutableSet<String> rawFlags, Environment env, RepoContext mainRepoContext)
+      throws PlatformMappingException {
     ImmutableSet.Builder<String> nativeFlags = ImmutableSet.builder();
     ImmutableList.Builder<String> starlarkFlags = ImmutableList.builder();
     for (String flagSetting : rawFlags) {
@@ -249,7 +269,7 @@ final class PlatformMappingFunction implements SkyFunction {
     OptionsParser fakeNativeParser = OptionsParser.builder().build();
     StarlarkOptionsParser starlarkFlagParser =
         StarlarkOptionsParser.newStarlarkOptionsParser(
-            new SkyframeTargetLoader(env), fakeNativeParser);
+            new SkyframeTargetLoader(env, mainRepoContext), fakeNativeParser);
     try {
       if (!starlarkFlagParser.parseGivenArgs(starlarkFlags.build())) {
         return null;
@@ -266,13 +286,14 @@ final class PlatformMappingFunction implements SkyFunction {
    */
   @Nullable
   private static ImmutableMap<Label, NativeAndStarlarkFlags> readPlatformsToFlags(
-      PeekingIterator<String> it, Environment env) throws PlatformMappingException {
+      PeekingIterator<String> it, Environment env, RepoContext mainRepoContext)
+      throws PlatformMappingException {
     ImmutableMap.Builder<Label, NativeAndStarlarkFlags> platformsToFlags = ImmutableMap.builder();
     boolean needSkyframeDeps = false;
     while (it.hasNext() && !it.peek().equalsIgnoreCase("flags:")) {
-      Label platform = readPlatform(it);
+      Label platform = readPlatform(it, mainRepoContext);
       ImmutableSet<String> flags = readFlags(it);
-      NativeAndStarlarkFlags parsedFlags = parseStarlarkFlags(flags, env);
+      NativeAndStarlarkFlags parsedFlags = parseStarlarkFlags(flags, env, mainRepoContext);
       if (parsedFlags == null) {
         needSkyframeDeps = true;
       } else {
@@ -293,11 +314,11 @@ final class PlatformMappingFunction implements SkyFunction {
   }
 
   private static ImmutableMap<ImmutableSet<String>, Label> readFlagsToPlatforms(
-      PeekingIterator<String> it) throws PlatformMappingException {
+      PeekingIterator<String> it, RepoContext mainRepoContext) throws PlatformMappingException {
     ImmutableMap.Builder<ImmutableSet<String>, Label> flagsToPlatforms = ImmutableMap.builder();
     while (it.hasNext() && it.peek().startsWith("--")) {
       ImmutableSet<String> flags = readFlags(it);
-      Label platform = readPlatform(it);
+      Label platform = readPlatform(it, mainRepoContext);
       flagsToPlatforms.put(flags, platform);
     }
 
@@ -308,16 +329,15 @@ final class PlatformMappingFunction implements SkyFunction {
     }
   }
 
-  private static Label readPlatform(PeekingIterator<String> it) throws PlatformMappingException {
+  private static Label readPlatform(PeekingIterator<String> it, RepoContext mainRepoContext)
+      throws PlatformMappingException {
     if (!it.hasNext()) {
       throw parsingException("Expected platform label but got end of file");
     }
 
     String line = it.next();
     try {
-      // TODO(https://github.com/bazelbuild/bazel/issues/17127): This should be passed throw the
-      //   main repo mapping!
-      return Label.parseCanonical(line);
+      return Label.parseWithRepoContext(line, mainRepoContext);
     } catch (LabelSyntaxException e) {
       throw parsingException("Expected platform label but got " + line, e);
     }
@@ -357,17 +377,21 @@ final class PlatformMappingFunction implements SkyFunction {
   static final class Mappings {
     final ImmutableMap<Label, NativeAndStarlarkFlags> platformsToFlags;
     final ImmutableMap<ImmutableSet<String>, Label> flagsToPlatforms;
+    final RepoContext mainRepoContext;
 
     Mappings(
         ImmutableMap<Label, NativeAndStarlarkFlags> platformsToFlags,
-        ImmutableMap<ImmutableSet<String>, Label> flagsToPlatforms) {
+        ImmutableMap<ImmutableSet<String>, Label> flagsToPlatforms,
+        RepoContext mainRepoContext) {
       this.platformsToFlags = platformsToFlags;
       this.flagsToPlatforms = flagsToPlatforms;
+      this.mainRepoContext = mainRepoContext;
     }
 
     PlatformMappingValue toPlatformMappingValue(
         ImmutableSet<Class<? extends FragmentOptions>> optionsClasses) {
-      return new PlatformMappingValue(platformsToFlags, flagsToPlatforms, optionsClasses);
+      return new PlatformMappingValue(
+          platformsToFlags, flagsToPlatforms, optionsClasses, mainRepoContext.repoMapping());
     }
   }
 
diff --git a/src/main/java/com/google/devtools/build/lib/skyframe/PlatformMappingValue.java b/src/main/java/com/google/devtools/build/lib/skyframe/PlatformMappingValue.java
index 8491db9d8b..82e7a6b76a 100644
--- a/src/main/java/com/google/devtools/build/lib/skyframe/PlatformMappingValue.java
+++ b/src/main/java/com/google/devtools/build/lib/skyframe/PlatformMappingValue.java
@@ -30,6 +30,7 @@ import com.google.devtools.build.lib.analysis.PlatformOptions;
 import com.google.devtools.build.lib.analysis.config.BuildOptions;
 import com.google.devtools.build.lib.analysis.config.FragmentOptions;
 import com.google.devtools.build.lib.cmdline.Label;
+import com.google.devtools.build.lib.cmdline.RepositoryMapping;
 import com.google.devtools.build.lib.concurrent.ThreadSafety;
 import com.google.devtools.build.lib.skyframe.serialization.autocodec.AutoCodec;
 import com.google.devtools.build.lib.vfs.PathFragment;
@@ -145,6 +146,7 @@ public final class PlatformMappingValue implements SkyValue {
   private final ImmutableSet<Class<? extends FragmentOptions>> optionsClasses;
   private final LoadingCache<NativeAndStarlarkFlags, OptionsParsingResult> parserCache;
   private final LoadingCache<BuildConfigurationKey, BuildConfigurationKey> mappingCache;
+  private final RepositoryMapping mainRepositoryMapping;
 
   /**
    * Creates a new mapping value which will match on the given platforms (if a target platform is
@@ -155,18 +157,21 @@ public final class PlatformMappingValue implements SkyValue {
    * @param flagsToPlatforms mapping from a set of command line style flags to a target platform
    *     that should be set if the flags match the mapped options
    * @param optionsClasses default options classes that should be used for options parsing
+   * @param mainRepositoryMapping the main repo mapping used to parse label-valued options
    */
   PlatformMappingValue(
       ImmutableMap<Label, NativeAndStarlarkFlags> platformsToFlags,
       ImmutableMap<ImmutableSet<String>, Label> flagsToPlatforms,
-      ImmutableSet<Class<? extends FragmentOptions>> optionsClasses) {
+      ImmutableSet<Class<? extends FragmentOptions>> optionsClasses,
+      RepositoryMapping mainRepositoryMapping) {
     this.platformsToFlags = checkNotNull(platformsToFlags);
     this.flagsToPlatforms = checkNotNull(flagsToPlatforms);
     this.optionsClasses = checkNotNull(optionsClasses);
+    this.mainRepositoryMapping = checkNotNull(mainRepositoryMapping);
     this.parserCache =
         Caffeine.newBuilder()
             .initialCapacity(platformsToFlags.size() + flagsToPlatforms.size())
-            .build(this::parse);
+            .build(flags -> parse(flags, this.mainRepositoryMapping));
     this.mappingCache = Caffeine.newBuilder().weakKeys().build(this::computeMapping);
   }
 
@@ -261,12 +266,14 @@ public final class PlatformMappingValue implements SkyValue {
     }
   }
 
-  private OptionsParsingResult parse(NativeAndStarlarkFlags args) throws OptionsParsingException {
+  private OptionsParsingResult parse(NativeAndStarlarkFlags args, RepositoryMapping mainRepoMapping)
+      throws OptionsParsingException {
     OptionsParser parser =
         OptionsParser.builder()
             .optionsClasses(optionsClasses)
             // We need the ability to re-map internal options in the mappings file.
             .ignoreInternalOptions(false)
+            .withConversionContext(mainRepoMapping)
             .build();
     parser.parse(args.nativeFlags().asList());
     parser.setStarlarkOptions(args.starlarkFlags());
diff --git a/src/test/java/com/google/devtools/build/lib/analysis/RunfilesRepoMappingManifestTest.java b/src/test/java/com/google/devtools/build/lib/analysis/RunfilesRepoMappingManifestTest.java
index 685e789f70..f44efb8fec 100644
--- a/src/test/java/com/google/devtools/build/lib/analysis/RunfilesRepoMappingManifestTest.java
+++ b/src/test/java/com/google/devtools/build/lib/analysis/RunfilesRepoMappingManifestTest.java
@@ -135,7 +135,6 @@ public class RunfilesRepoMappingManifestTest extends BuildViewTestCase {
 
   @Test
   public void diamond() throws Exception {
-    rewriteWorkspace("workspace(name='aaa_ws')");
     scratch.overwriteFile(
         "MODULE.bazel",
         "module(name='aaa',version='1.0')",
@@ -180,6 +179,9 @@ public class RunfilesRepoMappingManifestTest extends BuildViewTestCase {
           entry.getValue());
     }
 
+    // Called last as it triggers package invalidation, which requires a valid MODULE.bazel setup.
+    rewriteWorkspace("workspace(name='aaa_ws')");
+
     assertThat(getRepoMappingManifestForTarget("//:aaa"))
         .containsExactly(
             ",aaa,_main",
@@ -196,7 +198,6 @@ public class RunfilesRepoMappingManifestTest extends BuildViewTestCase {
 
   @Test
   public void runfilesFromToolchain() throws Exception {
-    rewriteWorkspace("workspace(name='main')");
     scratch.overwriteFile("MODULE.bazel", "bazel_dep(name='tooled_rule',version='1.0')");
     // tooled_rule offers a tooled_binary rule, which uses a toolchain backed by a binary from
     // bare_rule. tooled_binary explicitly requests that runfiles from this binary are included in
@@ -248,6 +249,9 @@ public class RunfilesRepoMappingManifestTest extends BuildViewTestCase {
         "load('@tooled_rule//:defs.bzl', 'tooled_binary')",
         "tooled_binary(name='tooled')");
 
+    // Called last as it triggers package invalidation, which requires a valid MODULE.bazel setup.
+    rewriteWorkspace("workspace(name='main')");
+
     assertThat(getRepoMappingManifestForTarget("//:tooled"))
         .containsExactly(
             ",main,_main",
@@ -258,7 +262,7 @@ public class RunfilesRepoMappingManifestTest extends BuildViewTestCase {
 
   @Test
   public void actionRerunsOnRepoMappingChange_workspaceName() throws Exception {
-    rewriteWorkspace("workspace(name='aaa_ws')");
+    overwriteWorkspaceFile("workspace(name='aaa_ws')");
     scratch.overwriteFile(
         "MODULE.bazel",
         "module(name='aaa',version='1.0')",
@@ -268,7 +272,8 @@ public class RunfilesRepoMappingManifestTest extends BuildViewTestCase {
 
     RepoMappingManifestAction actionBeforeChange = getRepoMappingManifestActionForTarget("//:aaa");
 
-    rewriteWorkspace("workspace(name='not_aaa_ws')");
+    overwriteWorkspaceFile("workspace(name='not_aaa_ws')");
+    invalidatePackages();
 
     RepoMappingManifestAction actionAfterChange = getRepoMappingManifestActionForTarget("//:aaa");
     assertThat(computeKey(actionBeforeChange)).isNotEqualTo(computeKey(actionAfterChange));
@@ -276,7 +281,7 @@ public class RunfilesRepoMappingManifestTest extends BuildViewTestCase {
 
   @Test
   public void actionRerunsOnRepoMappingChange_repoName() throws Exception {
-    rewriteWorkspace("workspace(name='aaa_ws')");
+    overwriteWorkspaceFile("workspace(name='aaa_ws')");
     scratch.overwriteFile(
         "MODULE.bazel",
         "module(name='aaa',version='1.0')",
@@ -298,7 +303,7 @@ public class RunfilesRepoMappingManifestTest extends BuildViewTestCase {
 
   @Test
   public void actionRerunsOnRepoMappingChange_newEntry() throws Exception {
-    rewriteWorkspace("workspace(name='aaa_ws')");
+    overwriteWorkspaceFile("workspace(name='aaa_ws')");
     scratch.overwriteFile(
         "MODULE.bazel",
         "module(name='aaa',version='1.0')",
@@ -336,7 +341,7 @@ public class RunfilesRepoMappingManifestTest extends BuildViewTestCase {
 
   @Test
   public void hasMappingForSymlinks() throws Exception {
-    rewriteWorkspace("workspace(name='my_workspace')");
+    overwriteWorkspaceFile("workspace(name='my_workspace')");
     scratch.overwriteFile(
         "MODULE.bazel",
         "module(name='my_module',version='1.0')",
@@ -417,4 +422,17 @@ public class RunfilesRepoMappingManifestTest extends BuildViewTestCase {
             "symlinks~1.0,symlinks,symlinks~1.0")
         .inOrder();
   }
+
+  /**
+   * Similar to {@link BuildViewTestCase#rewriteWorkspace(String...)}, but does not call {@link
+   * BuildViewTestCase#invalidatePackages()}.
+   */
+  public void overwriteWorkspaceFile(String... lines) throws Exception {
+    scratch.overwriteFile(
+        "WORKSPACE",
+        new ImmutableList.Builder<String>()
+            .addAll(analysisMock.getWorkspaceContents(mockToolsConfig))
+            .addAll(ImmutableList.copyOf(lines))
+            .build());
+  }
 }
diff --git a/src/test/java/com/google/devtools/build/lib/skyframe/PlatformMappingFunctionParserTest.java b/src/test/java/com/google/devtools/build/lib/skyframe/PlatformMappingFunctionParserTest.java
index 6b88cf4d30..4c362cc8ab 100644
--- a/src/test/java/com/google/devtools/build/lib/skyframe/PlatformMappingFunctionParserTest.java
+++ b/src/test/java/com/google/devtools/build/lib/skyframe/PlatformMappingFunctionParserTest.java
@@ -18,9 +18,13 @@ import static com.google.common.truth.Truth.assertThat;
 import static org.junit.Assert.assertThrows;
 
 import com.google.common.collect.ImmutableList;
+import com.google.common.collect.ImmutableMap;
 import com.google.common.collect.ImmutableSet;
 import com.google.devtools.build.lib.cmdline.Label;
+import com.google.devtools.build.lib.cmdline.Label.RepoContext;
 import com.google.devtools.build.lib.cmdline.LabelSyntaxException;
+import com.google.devtools.build.lib.cmdline.RepositoryMapping;
+import com.google.devtools.build.lib.cmdline.RepositoryName;
 import org.junit.Test;
 import org.junit.runner.RunWith;
 import org.junit.runners.JUnit4;
@@ -31,6 +35,8 @@ public class PlatformMappingFunctionParserTest {
 
   private static final Label PLATFORM1 = Label.parseCanonicalUnchecked("//platforms:one");
   private static final Label PLATFORM2 = Label.parseCanonicalUnchecked("//platforms:two");
+  private static final Label EXTERNAL_PLATFORM =
+      Label.parseCanonicalUnchecked("@dep~1.0//platforms:two");
 
   @Test
   public void testParse() throws Exception {
@@ -57,6 +63,37 @@ public class PlatformMappingFunctionParserTest {
     assertThat(mappings.flagsToPlatforms.get(ImmutableSet.of("--cpu=two"))).isEqualTo(PLATFORM2);
   }
 
+  @Test
+  public void testParseWithRepoMapping() throws Exception {
+    PlatformMappingFunction.Mappings mappings =
+        parse(
+            RepositoryMapping.create(
+                ImmutableMap.of(
+                    "foo", RepositoryName.MAIN, "dep", RepositoryName.create("dep~1.0")),
+                RepositoryName.MAIN),
+            "platforms:",
+            "  @foo//platforms:one",
+            "    --cpu=one",
+            "  @dep//platforms:two",
+            "    --cpu=two",
+            "flags:",
+            "  --cpu=one",
+            "    @foo//platforms:one",
+            "  --cpu=two",
+            "    @dep//platforms:two");
+
+    assertThat(mappings.platformsToFlags.keySet()).containsExactly(PLATFORM1, EXTERNAL_PLATFORM);
+    assertThat(mappings.platformsToFlags.get(PLATFORM1).nativeFlags()).containsExactly("--cpu=one");
+    assertThat(mappings.platformsToFlags.get(EXTERNAL_PLATFORM).nativeFlags())
+        .containsExactly("--cpu=two");
+
+    assertThat(mappings.flagsToPlatforms.keySet())
+        .containsExactly(ImmutableSet.of("--cpu=one"), ImmutableSet.of("--cpu=two"));
+    assertThat(mappings.flagsToPlatforms.get(ImmutableSet.of("--cpu=one"))).isEqualTo(PLATFORM1);
+    assertThat(mappings.flagsToPlatforms.get(ImmutableSet.of("--cpu=two")))
+        .isEqualTo(EXTERNAL_PLATFORM);
+  }
+
   @Test
   public void testParseComment() throws Exception {
     PlatformMappingFunction.Mappings mappings =
@@ -393,6 +430,15 @@ public class PlatformMappingFunctionParserTest {
 
   private static PlatformMappingFunction.Mappings parse(String... lines)
       throws PlatformMappingFunction.PlatformMappingException {
-    return PlatformMappingFunction.parse(/* env= */ null, ImmutableList.copyOf(lines));
+    return parse(RepositoryMapping.ALWAYS_FALLBACK, lines);
+  }
+
+  private static PlatformMappingFunction.Mappings parse(
+      RepositoryMapping mainRepoMapping, String... lines)
+      throws PlatformMappingFunction.PlatformMappingException {
+    return PlatformMappingFunction.parse(
+        /* env= */ null,
+        ImmutableList.copyOf(lines),
+        RepoContext.of(RepositoryName.MAIN, mainRepoMapping));
   }
 }
diff --git a/src/test/java/com/google/devtools/build/lib/skyframe/PlatformMappingFunctionTest.java b/src/test/java/com/google/devtools/build/lib/skyframe/PlatformMappingFunctionTest.java
index a19d22886c..189b3160ae 100644
--- a/src/test/java/com/google/devtools/build/lib/skyframe/PlatformMappingFunctionTest.java
+++ b/src/test/java/com/google/devtools/build/lib/skyframe/PlatformMappingFunctionTest.java
@@ -127,7 +127,7 @@ public final class PlatformMappingFunctionTest extends BuildViewTestCase {
   @Test
   public void testMappingFileIsRead_fromAlternatePackagePath() throws Exception {
     scratch.setWorkingDir("/other/package/path");
-    scratch.file("WORKSPACE");
+    scratch.copyFile(rootDirectory.getRelative("WORKSPACE").getPathString(), "WORKSPACE");
     setPackageOptions("--package_path=/other/package/path");
     scratch.file(
         "my_mapping_file",
@@ -148,6 +148,12 @@ public final class PlatformMappingFunctionTest extends BuildViewTestCase {
 
   @Test
   public void handlesNoWorkspaceFile() throws Exception {
+    // --package_path is not relevant for Bazel and difficult to get to work correctly with
+    // WORKSPACE suffixes in tests.
+    if (analysisMock.isThisBazel()) {
+      return;
+    }
+
     scratch.setWorkingDir("/other/package/path");
     scratch.file(
         "my_mapping_file",
@@ -237,6 +243,7 @@ public final class PlatformMappingFunctionTest extends BuildViewTestCase {
 
   @Test
   public void starlarkFlagMapping() throws Exception {
+    rewriteWorkspace("workspace(name = 'my_workspace')");
     scratch.file(
         "test/build_setting.bzl",
         "def _impl(ctx):",
@@ -252,8 +259,8 @@ public final class PlatformMappingFunctionTest extends BuildViewTestCase {
     scratch.file(
         "my_mapping_file",
         "platforms:", // Force line break
-        "  //platforms:one", // Force line break
-        "    --//test:my_string_flag=mapped_value");
+        "  @my_workspace//platforms:one", // Force line break
+        "    --@my_workspace//test:my_string_flag=mapped_value");
 
     PlatformMappingValue platformMappingValue =
         executeFunction(PlatformMappingValue.Key.create(PathFragment.create("my_mapping_file")));
@@ -285,6 +292,7 @@ public final class PlatformMappingFunctionTest extends BuildViewTestCase {
 
   @Test
   public void platformTransitionWithStarlarkFlagMapping() throws Exception {
+    rewriteWorkspace("workspace(name = 'my_workspace')");
     // Define a Starlark flag:
     scratch.file(
         "test/flags/build_setting.bzl",
@@ -305,7 +313,7 @@ public final class PlatformMappingFunctionTest extends BuildViewTestCase {
         "my_mapping_file",
         "platforms:", // Force line break
         "  //test/platforms:my_platform", // Force line break
-        "    --//test/flags:my_string_flag=platform-mapped value");
+        "    --@my_workspace//test/flags:my_string_flag=platform-mapped value");
 
     // Define a rule that platform-transitions its deps:
     scratch.overwriteFile(
diff --git a/src/test/java/com/google/devtools/build/lib/skyframe/PlatformMappingValueTest.java b/src/test/java/com/google/devtools/build/lib/skyframe/PlatformMappingValueTest.java
index efcb064c3f..5dd3c3015c 100644
--- a/src/test/java/com/google/devtools/build/lib/skyframe/PlatformMappingValueTest.java
+++ b/src/test/java/com/google/devtools/build/lib/skyframe/PlatformMappingValueTest.java
@@ -25,6 +25,8 @@ import com.google.devtools.build.lib.analysis.config.CompilationMode;
 import com.google.devtools.build.lib.analysis.config.CoreOptions;
 import com.google.devtools.build.lib.analysis.config.FragmentOptions;
 import com.google.devtools.build.lib.cmdline.Label;
+import com.google.devtools.build.lib.cmdline.RepositoryMapping;
+import com.google.devtools.build.lib.cmdline.RepositoryName;
 import com.google.devtools.build.lib.skyframe.PlatformMappingValue.NativeAndStarlarkFlags;
 import com.google.devtools.build.lib.vfs.PathFragment;
 import com.google.devtools.common.options.OptionsParsingException;
@@ -40,7 +42,12 @@ public final class PlatformMappingValueTest {
       BUILD_CONFIG_PLATFORM_OPTIONS = ImmutableSet.of(CoreOptions.class, PlatformOptions.class);
 
   private static final Label PLATFORM1 = Label.parseCanonicalUnchecked("//platforms:one");
-  private static final Label PLATFORM2 = Label.parseCanonicalUnchecked("//platforms:two");
+  private static final Label PLATFORM2 = Label.parseCanonicalUnchecked("@dep~1.0//platforms:two");
+  private static final RepositoryMapping REPO_MAPPING =
+      RepositoryMapping.create(
+          ImmutableMap.of(
+              "", RepositoryName.MAIN, "dep", RepositoryName.createUnvalidated("dep~1.0")),
+          RepositoryName.MAIN);
 
   private static final BuildOptions DEFAULT_BUILD_CONFIG_PLATFORM_OPTIONS =
       BuildOptions.getDefaultBuildOptionsForFragments(BUILD_CONFIG_PLATFORM_OPTIONS);
@@ -49,9 +56,11 @@ public final class PlatformMappingValueTest {
 
   @Test
   public void testMapNoMappings() throws OptionsParsingException {
+    ImmutableMap<Label, NativeAndStarlarkFlags> platformsToFlags = ImmutableMap.of();
+    ImmutableMap<ImmutableSet<String>, Label> flagsToPlatforms = ImmutableMap.of();
     PlatformMappingValue mappingValue =
         new PlatformMappingValue(
-            ImmutableMap.of(), ImmutableMap.of(), BUILD_CONFIG_PLATFORM_OPTIONS);
+            platformsToFlags, flagsToPlatforms, BUILD_CONFIG_PLATFORM_OPTIONS, REPO_MAPPING);
 
     BuildConfigurationKey key =
         BuildConfigurationKey.withoutPlatformMapping(DEFAULT_BUILD_CONFIG_PLATFORM_OPTIONS);
@@ -70,9 +79,10 @@ public final class PlatformMappingValueTest {
             NativeAndStarlarkFlags.create(
                 ImmutableSet.of("--cpu=one", "--compilation_mode=dbg"), ImmutableMap.of()));
 
+    ImmutableMap<ImmutableSet<String>, Label> flagsToPlatforms = ImmutableMap.of();
     PlatformMappingValue mappingValue =
         new PlatformMappingValue(
-            platformsToFlags, ImmutableMap.of(), BUILD_CONFIG_PLATFORM_OPTIONS);
+            platformsToFlags, flagsToPlatforms, BUILD_CONFIG_PLATFORM_OPTIONS, REPO_MAPPING);
 
     BuildOptions modifiedOptions = DEFAULT_BUILD_CONFIG_PLATFORM_OPTIONS.clone();
     modifiedOptions.get(PlatformOptions.class).platforms = ImmutableList.of(PLATFORM1);
@@ -87,9 +97,10 @@ public final class PlatformMappingValueTest {
     ImmutableMap<ImmutableSet<String>, Label> flagsToPlatforms =
         ImmutableMap.of(ImmutableSet.of("--cpu=one", "--compilation_mode=dbg"), PLATFORM1);
 
+    ImmutableMap<Label, NativeAndStarlarkFlags> platformsToFlags = ImmutableMap.of();
     PlatformMappingValue mappingValue =
         new PlatformMappingValue(
-            ImmutableMap.of(), flagsToPlatforms, BUILD_CONFIG_PLATFORM_OPTIONS);
+            platformsToFlags, flagsToPlatforms, BUILD_CONFIG_PLATFORM_OPTIONS, REPO_MAPPING);
 
     BuildOptions modifiedOptions = DEFAULT_BUILD_CONFIG_PLATFORM_OPTIONS.clone();
     modifiedOptions.get(CoreOptions.class).cpu = "one";
@@ -107,9 +118,10 @@ public final class PlatformMappingValueTest {
             ImmutableSet.of("--cpu=foo", "--compilation_mode=dbg"), PLATFORM1,
             ImmutableSet.of("--cpu=foo"), PLATFORM2);
 
+    ImmutableMap<Label, NativeAndStarlarkFlags> platformsToFlags = ImmutableMap.of();
     PlatformMappingValue mappingValue =
         new PlatformMappingValue(
-            ImmutableMap.of(), flagsToPlatforms, BUILD_CONFIG_PLATFORM_OPTIONS);
+            platformsToFlags, flagsToPlatforms, BUILD_CONFIG_PLATFORM_OPTIONS, REPO_MAPPING);
 
     BuildOptions modifiedOptions = DEFAULT_BUILD_CONFIG_PLATFORM_OPTIONS.clone();
     modifiedOptions.get(CoreOptions.class).cpu = "foo";
@@ -124,9 +136,10 @@ public final class PlatformMappingValueTest {
     ImmutableMap<ImmutableSet<String>, Label> flagsToPlatforms =
         ImmutableMap.of(ImmutableSet.of("--cpu=foo", "--compilation_mode=dbg"), PLATFORM1);
 
+    ImmutableMap<Label, NativeAndStarlarkFlags> platformsToFlags = ImmutableMap.of();
     PlatformMappingValue mappingValue =
         new PlatformMappingValue(
-            ImmutableMap.of(), flagsToPlatforms, BUILD_CONFIG_PLATFORM_OPTIONS);
+            platformsToFlags, flagsToPlatforms, BUILD_CONFIG_PLATFORM_OPTIONS, REPO_MAPPING);
 
     BuildOptions modifiedOptions = DEFAULT_BUILD_CONFIG_PLATFORM_OPTIONS.clone();
     modifiedOptions.get(CoreOptions.class).cpu = "bar";
@@ -142,9 +155,10 @@ public final class PlatformMappingValueTest {
     ImmutableMap<ImmutableSet<String>, Label> flagsToPlatforms =
         ImmutableMap.of(ImmutableSet.of("--cpu=one"), PLATFORM1);
 
+    ImmutableMap<Label, NativeAndStarlarkFlags> platformsToFlags = ImmutableMap.of();
     PlatformMappingValue mappingValue =
         new PlatformMappingValue(
-            ImmutableMap.of(), flagsToPlatforms, BUILD_CONFIG_PLATFORM_OPTIONS);
+            platformsToFlags, flagsToPlatforms, BUILD_CONFIG_PLATFORM_OPTIONS, REPO_MAPPING);
 
     BuildOptions options = BuildOptions.of(ImmutableList.of());
 
@@ -166,7 +180,11 @@ public final class PlatformMappingValueTest {
     modifiedOptions.get(PlatformOptions.class).platforms = ImmutableList.of(PLATFORM2);
 
     PlatformMappingValue mappingValue =
-        new PlatformMappingValue(platformsToFlags, flagsToPlatforms, BUILD_CONFIG_PLATFORM_OPTIONS);
+        new PlatformMappingValue(
+            platformsToFlags,
+            flagsToPlatforms,
+            BUILD_CONFIG_PLATFORM_OPTIONS,
+            RepositoryMapping.ALWAYS_FALLBACK);
 
     BuildConfigurationKey mapped = mappingValue.map(keyForOptions(modifiedOptions));
 
@@ -182,9 +200,10 @@ public final class PlatformMappingValueTest {
     modifiedOptions.get(CoreOptions.class).cpu = "one";
     modifiedOptions.get(PlatformOptions.class).platforms = ImmutableList.of(PLATFORM2);
 
+    ImmutableMap<Label, NativeAndStarlarkFlags> platformsToFlags = ImmutableMap.of();
     PlatformMappingValue mappingValue =
         new PlatformMappingValue(
-            ImmutableMap.of(), flagsToPlatforms, BUILD_CONFIG_PLATFORM_OPTIONS);
+            platformsToFlags, flagsToPlatforms, BUILD_CONFIG_PLATFORM_OPTIONS, REPO_MAPPING);
 
     BuildConfigurationKey mapped = mappingValue.map(keyForOptions(modifiedOptions));
 
diff --git a/src/test/java/com/google/devtools/build/lib/skyframe/RepositoryMappingFunctionTest.java b/src/test/java/com/google/devtools/build/lib/skyframe/RepositoryMappingFunctionTest.java
index 17aa0b5ed8..5019b47148 100644
--- a/src/test/java/com/google/devtools/build/lib/skyframe/RepositoryMappingFunctionTest.java
+++ b/src/test/java/com/google/devtools/build/lib/skyframe/RepositoryMappingFunctionTest.java
@@ -466,6 +466,18 @@ public class RepositoryMappingFunctionTest extends BuildViewTestCase {
 
   @Test
   public void testMixtureOfBothSystems_workspaceRepo() throws Exception {
+    scratch.overwriteFile(
+        "MODULE.bazel",
+        "module(name='aaa',version='0.1')",
+        "bazel_dep(name='bbb',version='1.0')",
+        "bazel_dep(name='ccc',version='2.0')",
+        "ext=use_extension('@ccc//:ext.bzl', 'ext')",
+        "use_repo(ext, 'ddd')");
+    registry
+        .addModule(createModuleKey("bbb", "1.0"), "module(name='bbb', version='1.0')")
+        .addModule(createModuleKey("ccc", "2.0"), "module(name='ccc', version='2.0')");
+
+    // Called last as it triggers package invalidation, which requires a valid MODULE.bazel setup.
     rewriteWorkspace(
         "workspace(name = 'root')",
         "local_repository(",
@@ -478,16 +490,6 @@ public class RepositoryMappingFunctionTest extends BuildViewTestCase {
         "        '@eee_alias' : '@eee',",
         "    },",
         ")");
-    scratch.overwriteFile(
-        "MODULE.bazel",
-        "module(name='aaa',version='0.1')",
-        "bazel_dep(name='bbb',version='1.0')",
-        "bazel_dep(name='ccc',version='2.0')",
-        "ext=use_extension('@ccc//:ext.bzl', 'ext')",
-        "use_repo(ext, 'ddd')");
-    registry
-        .addModule(createModuleKey("bbb", "1.0"), "module(name='bbb', version='1.0')")
-        .addModule(createModuleKey("ccc", "2.0"), "module(name='ccc', version='2.0')");
 
     RepositoryName name = RepositoryName.create("ws_repo");
     SkyKey skyKey = RepositoryMappingValue.key(name);
@@ -516,12 +518,6 @@ public class RepositoryMappingFunctionTest extends BuildViewTestCase {
 
   @Test
   public void testMixtureOfBothSystems_mainRepo() throws Exception {
-    rewriteWorkspace(
-        "workspace(name = 'root')",
-        "local_repository(",
-        "    name = 'ws_repo',",
-        "    path = '/ws_repo',",
-        ")");
     scratch.overwriteFile(
         "MODULE.bazel", "module(name='aaa',version='0.1')", "bazel_dep(name='bbb',version='1.0')");
     registry
@@ -530,6 +526,14 @@ public class RepositoryMappingFunctionTest extends BuildViewTestCase {
             "module(name='bbb', version='1.0');bazel_dep(name='ccc', version='2.0')")
         .addModule(createModuleKey("ccc", "2.0"), "module(name='ccc', version='2.0')");
 
+    // Called last as it triggers package invalidation, which requires a valid MODULE.bazel setup.
+    rewriteWorkspace(
+        "workspace(name = 'root')",
+        "local_repository(",
+        "    name = 'ws_repo',",
+        "    path = '/ws_repo',",
+        ")");
+
     SkyKey skyKey = RepositoryMappingValue.key(RepositoryName.MAIN);
     assertThatEvaluationResult(eval(skyKey))
         .hasEntryThat(skyKey)
@@ -547,12 +551,6 @@ public class RepositoryMappingFunctionTest extends BuildViewTestCase {
 
   @Test
   public void testMixtureOfBothSystems_mainRepo_shouldNotSeeWorkspaceRepos() throws Exception {
-    rewriteWorkspace(
-        "workspace(name = 'root')",
-        "local_repository(",
-        "    name = 'ws_repo',",
-        "    path = '/ws_repo',",
-        ")");
     scratch.overwriteFile(
         "MODULE.bazel", "module(name='aaa',version='0.1')", "bazel_dep(name='bbb',version='1.0')");
     registry
@@ -561,6 +559,14 @@ public class RepositoryMappingFunctionTest extends BuildViewTestCase {
             "module(name='bbb', version='1.0');bazel_dep(name='ccc', version='2.0')")
         .addModule(createModuleKey("ccc", "2.0"), "module(name='ccc', version='2.0')");
 
+    // Called last as it triggers package invalidation, which requires a valid MODULE.bazel setup.
+    rewriteWorkspace(
+        "workspace(name = 'root')",
+        "local_repository(",
+        "    name = 'ws_repo',",
+        "    path = '/ws_repo',",
+        ")");
+
     SkyKey skyKey = RepositoryMappingValue.KEY_FOR_ROOT_MODULE_WITHOUT_WORKSPACE_REPOS;
     assertThatEvaluationResult(eval(skyKey))
         .hasEntryThat(skyKey)
