diff --git a/src/main/java/com/google/devtools/build/lib/analysis/producers/BUILD b/src/main/java/com/google/devtools/build/lib/analysis/producers/BUILD
index 9ad880797f..2849660de2 100644
--- a/src/main/java/com/google/devtools/build/lib/analysis/producers/BUILD
+++ b/src/main/java/com/google/devtools/build/lib/analysis/producers/BUILD
@@ -100,6 +100,17 @@ java_library(
     ],
 )
 
+java_library(
+    name = "build_configuration_key_cache",
+    srcs = ["BuildConfigurationKeyCache.java"],
+    deps = [
+        "//src/main/java/com/google/devtools/build/lib/analysis:config/build_options",
+        "//src/main/java/com/google/devtools/build/lib/skyframe/config",
+        "//third_party:caffeine",
+        "//third_party:jsr305",
+    ],
+)
+
 java_library(
     name = "build_configuration_key_map_producer",
     srcs = [
@@ -107,6 +118,7 @@ java_library(
         "BuildConfigurationKeyProducer.java",
     ],
     deps = [
+        ":build_configuration_key_cache",
         ":platform_flags_producer",
         "//src/main/java/com/google/devtools/build/lib/analysis:config/build_options",
         "//src/main/java/com/google/devtools/build/lib/analysis:platform_options",
@@ -118,7 +130,6 @@ java_library(
         "//src/main/java/com/google/devtools/build/skyframe",
         "//src/main/java/com/google/devtools/build/skyframe:skyframe-objects",
         "//src/main/java/com/google/devtools/common/options",
-        "//third_party:caffeine",
         "//third_party:guava",
         "//third_party:jsr305",
     ],
diff --git a/src/main/java/com/google/devtools/build/lib/analysis/producers/BuildConfigurationKeyCache.java b/src/main/java/com/google/devtools/build/lib/analysis/producers/BuildConfigurationKeyCache.java
new file mode 100644
index 0000000000..e6407a097e
--- /dev/null
+++ b/src/main/java/com/google/devtools/build/lib/analysis/producers/BuildConfigurationKeyCache.java
@@ -0,0 +1,42 @@
+// Copyright 2024 The Bazel Authors. All rights reserved.
+//
+// Licensed under the Apache License, Version 2.0 (the "License");
+// you may not use this file except in compliance with the License.
+// You may obtain a copy of the License at
+//
+//    http://www.apache.org/licenses/LICENSE-2.0
+//
+// Unless required by applicable law or agreed to in writing, software
+// distributed under the License is distributed on an "AS IS" BASIS,
+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+// See the License for the specific language governing permissions and
+// limitations under the License.
+package com.google.devtools.build.lib.analysis.producers;
+
+import com.github.benmanes.caffeine.cache.Cache;
+import com.github.benmanes.caffeine.cache.Caffeine;
+import com.google.devtools.build.lib.analysis.config.BuildOptions;
+import com.google.devtools.build.lib.skyframe.config.BuildConfigurationKey;
+import javax.annotation.Nullable;
+
+/**
+ * A cache of {@link BuildOptions} -> {@link BuildConfigurationKey} instances, taking platform
+ * mappings and platform based flags into account.
+ */
+public class BuildConfigurationKeyCache {
+  private final Cache<BuildOptions, BuildConfigurationKey> cache =
+      Caffeine.newBuilder().weakKeys().build();
+
+  @Nullable
+  public BuildConfigurationKey get(BuildOptions options) {
+    return cache.getIfPresent(options);
+  }
+
+  public void put(BuildOptions options, BuildConfigurationKey buildConfigurationKey) {
+    cache.put(options, buildConfigurationKey);
+  }
+
+  public void clear() {
+    cache.invalidateAll();
+  }
+}
diff --git a/src/main/java/com/google/devtools/build/lib/analysis/producers/BuildConfigurationKeyMapProducer.java b/src/main/java/com/google/devtools/build/lib/analysis/producers/BuildConfigurationKeyMapProducer.java
index d0b5ac59a0..7dac6c7be3 100644
--- a/src/main/java/com/google/devtools/build/lib/analysis/producers/BuildConfigurationKeyMapProducer.java
+++ b/src/main/java/com/google/devtools/build/lib/analysis/producers/BuildConfigurationKeyMapProducer.java
@@ -49,6 +49,7 @@ public class BuildConfigurationKeyMapProducer
   // -------------------- Input --------------------
   private final ResultSink sink;
   private final StateMachine runAfter;
+  private final BuildConfigurationKeyCache buildConfigurationKeyCache;
   private final Map<String, BuildOptions> options;
 
   // -------------------- Internal State --------------------
@@ -57,8 +58,12 @@ public class BuildConfigurationKeyMapProducer
   private final Map<String, BuildConfigurationKey> results = new HashMap<>();
 
   public BuildConfigurationKeyMapProducer(
-      ResultSink sink, StateMachine runAfter, Map<String, BuildOptions> options) {
+      ResultSink sink,
+      StateMachine runAfter,
+      BuildConfigurationKeyCache buildConfigurationKeyCache,
+      Map<String, BuildOptions> options) {
     this.sink = sink;
+    this.buildConfigurationKeyCache = buildConfigurationKeyCache;
     this.runAfter = runAfter;
     this.options = options;
   }
@@ -71,6 +76,7 @@ public class BuildConfigurationKeyMapProducer
                 new BuildConfigurationKeyProducer<>(
                     (BuildConfigurationKeyProducer.ResultSink<String>) this,
                     StateMachine.DONE,
+                    buildConfigurationKeyCache,
                     entry.getKey(),
                     entry.getValue()))
         .forEach(tasks::enqueue);
diff --git a/src/main/java/com/google/devtools/build/lib/analysis/producers/BuildConfigurationKeyProducer.java b/src/main/java/com/google/devtools/build/lib/analysis/producers/BuildConfigurationKeyProducer.java
index 7050138380..d1560741b1 100644
--- a/src/main/java/com/google/devtools/build/lib/analysis/producers/BuildConfigurationKeyProducer.java
+++ b/src/main/java/com/google/devtools/build/lib/analysis/producers/BuildConfigurationKeyProducer.java
@@ -13,8 +13,6 @@
 // limitations under the License.
 package com.google.devtools.build.lib.analysis.producers;
 
-import com.github.benmanes.caffeine.cache.Cache;
-import com.github.benmanes.caffeine.cache.Caffeine;
 import com.google.devtools.build.lib.analysis.PlatformOptions;
 import com.google.devtools.build.lib.analysis.config.BuildOptions;
 import com.google.devtools.build.lib.cmdline.Label;
@@ -46,10 +44,6 @@ public class BuildConfigurationKeyProducer<C>
         ValueOrExceptionSink<PlatformMappingException>,
         PlatformFlagsProducer.ResultSink {
 
-  // Static cache for transformed options.
-  private static final Cache<BuildOptions, BuildConfigurationKey> CACHE =
-      Caffeine.newBuilder().weakKeys().build();
-
   /** Interface for clients to accept results of this computation. */
   public interface ResultSink<C> {
 
@@ -65,6 +59,7 @@ public class BuildConfigurationKeyProducer<C>
   // -------------------- Input --------------------
   private final ResultSink<C> sink;
   private final StateMachine runAfter;
+  private final BuildConfigurationKeyCache cache;
   private final C context;
   private final BuildOptions options;
 
@@ -73,16 +68,21 @@ public class BuildConfigurationKeyProducer<C>
   private NativeAndStarlarkFlags platformFlags;
 
   public BuildConfigurationKeyProducer(
-      ResultSink<C> sink, StateMachine runAfter, C context, BuildOptions options) {
+      ResultSink<C> sink,
+      StateMachine runAfter,
+      BuildConfigurationKeyCache cache,
+      C context,
+      BuildOptions options) {
     this.sink = sink;
     this.runAfter = runAfter;
+    this.cache = cache;
     this.context = context;
     this.options = options;
   }
 
   @Override
   public StateMachine step(Tasks tasks) throws InterruptedException {
-    BuildConfigurationKey result = CACHE.getIfPresent(this.options);
+    BuildConfigurationKey result = cache.get(this.options);
     if (result != null) {
       this.sink.acceptTransitionedConfiguration(this.context, result);
       return this.runAfter;
@@ -185,7 +185,7 @@ public class BuildConfigurationKeyProducer<C>
   }
 
   private StateMachine finishConfigurationKeyProcessing(BuildConfigurationKey newConfigurationKey) {
-    CACHE.put(this.options, newConfigurationKey);
+    cache.put(this.options, newConfigurationKey);
     sink.acceptTransitionedConfiguration(this.context, newConfigurationKey);
     return this.runAfter;
   }
diff --git a/src/main/java/com/google/devtools/build/lib/analysis/producers/DependencyProducer.java b/src/main/java/com/google/devtools/build/lib/analysis/producers/DependencyProducer.java
index 7c81324808..bef6aa479f 100644
--- a/src/main/java/com/google/devtools/build/lib/analysis/producers/DependencyProducer.java
+++ b/src/main/java/com/google/devtools/build/lib/analysis/producers/DependencyProducer.java
@@ -179,6 +179,7 @@ final class DependencyProducer
         configurationKey,
         attributeTransition,
         parameters.transitionCache(),
+        parameters.buildConfigurationKeyCache(),
         (TransitionApplier.ResultSink) this,
         parameters.eventHandler(),
         /* runAfter= */ this::processTransitionResult);
diff --git a/src/main/java/com/google/devtools/build/lib/analysis/producers/PrerequisiteParameters.java b/src/main/java/com/google/devtools/build/lib/analysis/producers/PrerequisiteParameters.java
index eb79ff0227..bab5904184 100644
--- a/src/main/java/com/google/devtools/build/lib/analysis/producers/PrerequisiteParameters.java
+++ b/src/main/java/com/google/devtools/build/lib/analysis/producers/PrerequisiteParameters.java
@@ -43,6 +43,7 @@ public final class PrerequisiteParameters {
   private final ImmutableList<Aspect> aspects;
   @Nullable private final StarlarkAttributeTransitionProvider starlarkTransitionProvider;
   private final StarlarkTransitionCache transitionCache;
+  private final BuildConfigurationKeyCache buildConfigurationKeyCache;
   @Nullable private final ToolchainCollection<ToolchainContext> toolchainContexts;
 
   @Nullable private final ConfiguredAttributeMapper attributeMap;
@@ -71,6 +72,7 @@ public final class PrerequisiteParameters {
       Iterable<Aspect> aspects,
       @Nullable StarlarkAttributeTransitionProvider starlarkTransitionProvider,
       StarlarkTransitionCache transitionCache,
+      BuildConfigurationKeyCache buildConfigurationKeyCache,
       @Nullable ToolchainCollection<ToolchainContext> toolchainContexts,
       @Nullable ConfiguredAttributeMapper attributeMap,
       TransitiveDependencyState transitiveState,
@@ -83,6 +85,7 @@ public final class PrerequisiteParameters {
     this.starlarkTransitionProvider = starlarkTransitionProvider;
     this.transitionCache = transitionCache;
     this.toolchainContexts = toolchainContexts;
+    this.buildConfigurationKeyCache = buildConfigurationKeyCache;
     this.attributeMap = attributeMap;
     this.transitiveState = transitiveState;
     this.eventHandler = eventHandler;
@@ -167,4 +170,8 @@ public final class PrerequisiteParameters {
   public ExtendedEventHandler eventHandler() {
     return eventHandler;
   }
+
+  public BuildConfigurationKeyCache buildConfigurationKeyCache() {
+    return buildConfigurationKeyCache;
+  }
 }
diff --git a/src/main/java/com/google/devtools/build/lib/analysis/producers/TargetAndConfigurationProducer.java b/src/main/java/com/google/devtools/build/lib/analysis/producers/TargetAndConfigurationProducer.java
index fb6dc77093..5f16a9a517 100644
--- a/src/main/java/com/google/devtools/build/lib/analysis/producers/TargetAndConfigurationProducer.java
+++ b/src/main/java/com/google/devtools/build/lib/analysis/producers/TargetAndConfigurationProducer.java
@@ -138,6 +138,7 @@ public final class TargetAndConfigurationProducer
   @Nullable private final TransitionFactory<RuleTransitionData> trimmingTransitionFactory;
   private final PatchTransition toolchainTaggedTrimmingTransition;
   private final StarlarkTransitionCache transitionCache;
+  private final BuildConfigurationKeyCache buildConfigurationKeyCache;
 
   private final TransitiveDependencyState transitiveState;
 
@@ -153,6 +154,7 @@ public final class TargetAndConfigurationProducer
       @Nullable TransitionFactory<RuleTransitionData> trimmingTransitionFactory,
       PatchTransition toolchainTaggedTrimmingTransition,
       StarlarkTransitionCache transitionCache,
+      BuildConfigurationKeyCache buildConfigurationKeyCache,
       TransitiveDependencyState transitiveState,
       ResultSink sink,
       ExtendedEventHandler eventHandler) {
@@ -160,6 +162,7 @@ public final class TargetAndConfigurationProducer
     this.trimmingTransitionFactory = trimmingTransitionFactory;
     this.toolchainTaggedTrimmingTransition = toolchainTaggedTrimmingTransition;
     this.transitionCache = transitionCache;
+    this.buildConfigurationKeyCache = buildConfigurationKeyCache;
     this.transitiveState = transitiveState;
     this.sink = sink;
     this.eventHandler = eventHandler;
@@ -480,6 +483,7 @@ public final class TargetAndConfigurationProducer
           preRuleTransitionKey.getConfigurationKey(),
           ruleTransition,
           transitionCache,
+          buildConfigurationKeyCache,
           (TransitionApplier.ResultSink) this,
           eventHandler,
           /* runAfter= */ this::processTransitionedKey);
@@ -582,6 +586,7 @@ public final class TargetAndConfigurationProducer
             configurationKey,
             ruleTransition,
             transitionCache,
+            buildConfigurationKeyCache,
             (TransitionApplier.ResultSink) this,
             eventHandler,
             /* runAfter= */ this::checkIdempotencyAndDelegate);
diff --git a/src/main/java/com/google/devtools/build/lib/analysis/producers/TransitionApplier.java b/src/main/java/com/google/devtools/build/lib/analysis/producers/TransitionApplier.java
index fdf36c2ddc..fcd1cb6503 100644
--- a/src/main/java/com/google/devtools/build/lib/analysis/producers/TransitionApplier.java
+++ b/src/main/java/com/google/devtools/build/lib/analysis/producers/TransitionApplier.java
@@ -45,6 +45,7 @@ final class TransitionApplier
   private final BuildConfigurationKey fromConfiguration;
   private final ConfigurationTransition transition;
   private final StarlarkTransitionCache transitionCache;
+  private final BuildConfigurationKeyCache buildConfigurationKeyCache;
 
   // -------------------- Output --------------------
   private final ResultSink sink;
@@ -60,12 +61,14 @@ final class TransitionApplier
       BuildConfigurationKey fromConfiguration,
       ConfigurationTransition transition,
       StarlarkTransitionCache transitionCache,
+      BuildConfigurationKeyCache buildConfigurationKeyCache,
       ResultSink sink,
       ExtendedEventHandler eventHandler,
       StateMachine runAfter) {
     this.fromConfiguration = fromConfiguration;
     this.transition = transition;
     this.transitionCache = transitionCache;
+    this.buildConfigurationKeyCache = buildConfigurationKeyCache;
     this.sink = sink;
     this.eventHandler = eventHandler;
     this.runAfter = runAfter;
@@ -84,6 +87,7 @@ final class TransitionApplier
       return new BuildConfigurationKeyMapProducer(
           this.sink,
           this.runAfter,
+          this.buildConfigurationKeyCache,
           transition.apply(
               TransitionUtil.restrict(transition, fromConfiguration.getOptions()), eventHandler));
     }
@@ -129,6 +133,7 @@ final class TransitionApplier
       sink.acceptTransitionError(e);
       return runAfter;
     }
-    return new BuildConfigurationKeyMapProducer(this.sink, this.runAfter, transitionedOptions);
+    return new BuildConfigurationKeyMapProducer(
+        this.sink, this.runAfter, this.buildConfigurationKeyCache, transitionedOptions);
   }
 }
diff --git a/src/main/java/com/google/devtools/build/lib/query2/BUILD b/src/main/java/com/google/devtools/build/lib/query2/BUILD
index 5349a0ff42..9a92f6b1ab 100644
--- a/src/main/java/com/google/devtools/build/lib/query2/BUILD
+++ b/src/main/java/com/google/devtools/build/lib/query2/BUILD
@@ -59,6 +59,7 @@ java_library(
         "//src/main/java/com/google/devtools/build/lib/analysis/config/output:configuration_for_output",
         "//src/main/java/com/google/devtools/build/lib/analysis/config/output:fragment_for_output",
         "//src/main/java/com/google/devtools/build/lib/analysis/config/output:fragment_options_for_output",
+        "//src/main/java/com/google/devtools/build/lib/analysis/producers",
         "//src/main/java/com/google/devtools/build/lib/bugreport",
         "//src/main/java/com/google/devtools/build/lib/buildeventstream",
         "//src/main/java/com/google/devtools/build/lib/buildeventstream/proto:build_event_stream_java_proto",
diff --git a/src/main/java/com/google/devtools/build/lib/query2/cquery/CqueryTransitionResolver.java b/src/main/java/com/google/devtools/build/lib/query2/cquery/CqueryTransitionResolver.java
index 4562dd3746..1c7969f9a5 100644
--- a/src/main/java/com/google/devtools/build/lib/query2/cquery/CqueryTransitionResolver.java
+++ b/src/main/java/com/google/devtools/build/lib/query2/cquery/CqueryTransitionResolver.java
@@ -36,6 +36,7 @@ import com.google.devtools.build.lib.analysis.config.transitions.NoTransition;
 import com.google.devtools.build.lib.analysis.config.transitions.TransitionFactory;
 import com.google.devtools.build.lib.analysis.configuredtargets.RuleConfiguredTarget;
 import com.google.devtools.build.lib.analysis.constraints.IncompatibleTargetChecker.IncompatibleTargetException;
+import com.google.devtools.build.lib.analysis.producers.BuildConfigurationKeyCache;
 import com.google.devtools.build.lib.cmdline.Label;
 import com.google.devtools.build.lib.concurrent.ThreadSafety.Immutable;
 import com.google.devtools.build.lib.events.ExtendedEventHandler;
@@ -106,18 +107,21 @@ public class CqueryTransitionResolver {
   private final CqueryThreadsafeCallback cqueryThreadsafeCallback;
   private final RuleClassProvider ruleClassProvider;
   private final StarlarkTransitionCache transitionCache;
+  private final BuildConfigurationKeyCache buildConfigurationKeyCache;
 
   public CqueryTransitionResolver(
       ExtendedEventHandler eventHandler,
       ConfiguredTargetAccessor accessor,
       CqueryThreadsafeCallback cqueryThreadsafeCallback,
       RuleClassProvider ruleClassProvider,
-      StarlarkTransitionCache transitionCache) {
+      StarlarkTransitionCache transitionCache,
+      BuildConfigurationKeyCache buildConfigurationKeyCache) {
     this.eventHandler = eventHandler;
     this.accessor = accessor;
     this.cqueryThreadsafeCallback = cqueryThreadsafeCallback;
     this.ruleClassProvider = ruleClassProvider;
     this.transitionCache = transitionCache;
+    this.buildConfigurationKeyCache = buildConfigurationKeyCache;
   }
 
   /**
@@ -151,6 +155,7 @@ public class CqueryTransitionResolver {
           ConfiguredTargetKey.fromConfiguredTarget(configuredTarget),
           ruleClassProvider,
           transitionCache,
+          buildConfigurationKeyCache,
           /* semaphoreLocker= */ () -> {},
           accessor.getLookupEnvironment(),
           eventHandler)) {
diff --git a/src/main/java/com/google/devtools/build/lib/query2/cquery/TransitionsOutputFormatterCallback.java b/src/main/java/com/google/devtools/build/lib/query2/cquery/TransitionsOutputFormatterCallback.java
index 184f0a45e7..3c0075f3a7 100644
--- a/src/main/java/com/google/devtools/build/lib/query2/cquery/TransitionsOutputFormatterCallback.java
+++ b/src/main/java/com/google/devtools/build/lib/query2/cquery/TransitionsOutputFormatterCallback.java
@@ -22,6 +22,7 @@ import com.google.devtools.build.lib.analysis.config.BuildOptions;
 import com.google.devtools.build.lib.analysis.config.OptionsDiff;
 import com.google.devtools.build.lib.analysis.config.StarlarkTransitionCache;
 import com.google.devtools.build.lib.analysis.config.transitions.TransitionFactory;
+import com.google.devtools.build.lib.analysis.producers.BuildConfigurationKeyCache;
 import com.google.devtools.build.lib.cmdline.Label;
 import com.google.devtools.build.lib.events.Event;
 import com.google.devtools.build.lib.events.ExtendedEventHandler;
@@ -48,6 +49,7 @@ class TransitionsOutputFormatterCallback extends CqueryThreadsafeCallback {
   private final RuleClassProvider ruleClassProvider;
   private final LabelPrinter labelPrinter;
   private final StarlarkTransitionCache transitionCache;
+  private final BuildConfigurationKeyCache buildConfigurationKeyCache;
 
   @Override
   public String getName() {
@@ -70,6 +72,8 @@ class TransitionsOutputFormatterCallback extends CqueryThreadsafeCallback {
     this.partialResultMap = Maps.newHashMap();
     this.labelPrinter = labelPrinter;
     this.transitionCache = skyframeExecutor.getSkyframeBuildView().getStarlarkTransitionCache();
+    this.buildConfigurationKeyCache =
+        skyframeExecutor.getSkyframeBuildView().getBuildConfigurationKeyCache();
   }
 
   @Override
@@ -101,7 +105,12 @@ class TransitionsOutputFormatterCallback extends CqueryThreadsafeCallback {
         // anyway.
         dependencies =
             new CqueryTransitionResolver(
-                    eventHandler, accessor, this, ruleClassProvider, transitionCache)
+                    eventHandler,
+                    accessor,
+                    this,
+                    ruleClassProvider,
+                    transitionCache,
+                    buildConfigurationKeyCache)
                 .dependencies(keyedConfiguredTarget);
       } catch (EvaluateException e) {
         // This is an abuse of InterruptedException.
diff --git a/src/main/java/com/google/devtools/build/lib/skyframe/AspectFunction.java b/src/main/java/com/google/devtools/build/lib/skyframe/AspectFunction.java
index 786e1f9d47..18095b3f5d 100644
--- a/src/main/java/com/google/devtools/build/lib/skyframe/AspectFunction.java
+++ b/src/main/java/com/google/devtools/build/lib/skyframe/AspectFunction.java
@@ -384,6 +384,7 @@ final class AspectFunction implements SkyFunction {
               ConfiguredTargetKey.fromConfiguredTarget(associatedTarget),
               topologicalAspectPath,
               buildViewProvider.getSkyframeBuildView().getStarlarkTransitionCache(),
+              buildViewProvider.getSkyframeBuildView().getBuildConfigurationKeyCache(),
               starlarkExecTransition.orElse(null),
               env,
               env.getListener(),
diff --git a/src/main/java/com/google/devtools/build/lib/skyframe/ConfiguredTargetFunction.java b/src/main/java/com/google/devtools/build/lib/skyframe/ConfiguredTargetFunction.java
index 51c1487b80..b35213baf5 100644
--- a/src/main/java/com/google/devtools/build/lib/skyframe/ConfiguredTargetFunction.java
+++ b/src/main/java/com/google/devtools/build/lib/skyframe/ConfiguredTargetFunction.java
@@ -267,6 +267,7 @@ public final class ConfiguredTargetFunction implements SkyFunction {
           configuredTargetKey,
           ruleClassProvider,
           view.getStarlarkTransitionCache(),
+          view.getBuildConfigurationKeyCache(),
           () -> maybeAcquireSemaphoreWithLogging(key),
           env,
           env.getListener())) {
@@ -472,6 +473,7 @@ public final class ConfiguredTargetFunction implements SkyFunction {
                     ((ConfiguredRuleClassProvider) ruleClassProvider)
                         .getToolchainTaggedTrimmingTransition(),
                     buildViewProvider.getSkyframeBuildView().getStarlarkTransitionCache(),
+                    buildViewProvider.getSkyframeBuildView().getBuildConfigurationKeyCache(),
                     state.computeDependenciesState.transitiveState,
                     (TargetAndConfigurationProducer.ResultSink) state,
                     storedEvents));
diff --git a/src/main/java/com/google/devtools/build/lib/skyframe/DependencyResolver.java b/src/main/java/com/google/devtools/build/lib/skyframe/DependencyResolver.java
index 726b640764..63f8daaf99 100644
--- a/src/main/java/com/google/devtools/build/lib/skyframe/DependencyResolver.java
+++ b/src/main/java/com/google/devtools/build/lib/skyframe/DependencyResolver.java
@@ -47,6 +47,7 @@ import com.google.devtools.build.lib.analysis.config.transitions.PatchTransition
 import com.google.devtools.build.lib.analysis.config.transitions.TransitionCollector;
 import com.google.devtools.build.lib.analysis.constraints.IncompatibleTargetChecker.IncompatibleTargetException;
 import com.google.devtools.build.lib.analysis.platform.PlatformInfo;
+import com.google.devtools.build.lib.analysis.producers.BuildConfigurationKeyCache;
 import com.google.devtools.build.lib.analysis.producers.DependencyContext;
 import com.google.devtools.build.lib.analysis.producers.DependencyContextError;
 import com.google.devtools.build.lib.analysis.producers.DependencyContextProducer;
@@ -329,6 +330,7 @@ public final class DependencyResolver {
       ConfiguredTargetKey configuredTargetKey,
       RuleClassProvider ruleClassProvider,
       StarlarkTransitionCache transitionCache,
+      BuildConfigurationKeyCache buildConfigurationKeyCache,
       SemaphoreAcquirer semaphoreLocker,
       LookupEnvironment env,
       ExtendedEventHandler listener)
@@ -393,6 +395,7 @@ public final class DependencyResolver {
               configuredTargetKey,
               /* aspects= */ ImmutableList.of(),
               transitionCache,
+              buildConfigurationKeyCache,
               starlarkExecTransition.orElse(null),
               env,
               listener,
@@ -627,6 +630,7 @@ public final class DependencyResolver {
       ConfiguredTargetKey configuredTargetKey,
       ImmutableList<Aspect> aspects,
       StarlarkTransitionCache transitionCache,
+      BuildConfigurationKeyCache buildConfigurationKeyCache,
       @Nullable StarlarkAttributeTransitionProvider starlarkTransitionProvider,
       LookupEnvironment env,
       ExtendedEventHandler listener,
@@ -669,6 +673,7 @@ public final class DependencyResolver {
                         aspects,
                         starlarkTransitionProvider,
                         transitionCache,
+                        buildConfigurationKeyCache,
                         toolchainContexts,
                         dependencyLabels.attributeMap(),
                         state.transitiveState,
diff --git a/src/main/java/com/google/devtools/build/lib/skyframe/SkyframeBuildView.java b/src/main/java/com/google/devtools/build/lib/skyframe/SkyframeBuildView.java
index 3298d246fa..dfb26de706 100644
--- a/src/main/java/com/google/devtools/build/lib/skyframe/SkyframeBuildView.java
+++ b/src/main/java/com/google/devtools/build/lib/skyframe/SkyframeBuildView.java
@@ -71,6 +71,7 @@ import com.google.devtools.build.lib.analysis.config.OptionsDiff;
 import com.google.devtools.build.lib.analysis.config.StarlarkExecTransitionLoader;
 import com.google.devtools.build.lib.analysis.config.StarlarkExecTransitionLoader.StarlarkExecTransitionLoadingException;
 import com.google.devtools.build.lib.analysis.config.StarlarkTransitionCache;
+import com.google.devtools.build.lib.analysis.producers.BuildConfigurationKeyCache;
 import com.google.devtools.build.lib.analysis.starlark.StarlarkAttributeTransitionProvider;
 import com.google.devtools.build.lib.analysis.test.AnalysisFailurePropagationException;
 import com.google.devtools.build.lib.analysis.test.CoverageArtifactsKnownEvent;
@@ -168,6 +169,8 @@ public final class SkyframeBuildView {
   private boolean foundActionConflictInLatestCheck;
 
   private final StarlarkTransitionCache starlarkTransitionCache = new StarlarkTransitionCache();
+  private final BuildConfigurationKeyCache buildConfigurationKeyCache =
+      new BuildConfigurationKeyCache();
 
   public SkyframeBuildView(
       ArtifactFactory artifactFactory,
@@ -357,6 +360,7 @@ public final class SkyframeBuildView {
       skyframeExecutor.clearAnalysisCache(topLevelTargets, topLevelAspects);
     }
     starlarkTransitionCache.clear();
+    buildConfigurationKeyCache.clear();
   }
 
   /**
@@ -1370,6 +1374,7 @@ public final class SkyframeBuildView {
   void clearLegacyData() {
     artifactFactory.clear();
     starlarkTransitionCache.clear();
+    buildConfigurationKeyCache.clear();
   }
 
   /**
@@ -1393,6 +1398,7 @@ public final class SkyframeBuildView {
   /** Clear the invalidated action lookup nodes detected during loading and analysis phases. */
   public void clearInvalidatedActionLookupKeys() {
     dirtiedActionLookupKeys = Sets.newConcurrentHashSet();
+    buildConfigurationKeyCache.clear();
   }
 
   /**
@@ -1409,6 +1415,10 @@ public final class SkyframeBuildView {
     return starlarkTransitionCache;
   }
 
+  public BuildConfigurationKeyCache getBuildConfigurationKeyCache() {
+    return buildConfigurationKeyCache;
+  }
+
   private final class ActionLookupValueProgressReceiver implements EvaluationProgressReceiver {
     private final AtomicInteger configuredObjectCount = new AtomicInteger();
     private final AtomicInteger actionCount = new AtomicInteger();
diff --git a/src/main/java/com/google/devtools/build/lib/skyframe/SkyframeExecutor.java b/src/main/java/com/google/devtools/build/lib/skyframe/SkyframeExecutor.java
index c7b8bd74af..381993d60f 100644
--- a/src/main/java/com/google/devtools/build/lib/skyframe/SkyframeExecutor.java
+++ b/src/main/java/com/google/devtools/build/lib/skyframe/SkyframeExecutor.java
@@ -719,7 +719,9 @@ public abstract class SkyframeExecutor implements WalkableGraphFactory {
     map.put(
         SkyFunctions.BUILD_CONFIGURATION,
         new BuildConfigurationFunction(directories, ruleClassProvider));
-    map.put(SkyFunctions.BUILD_CONFIGURATION_KEY, new BuildConfigurationKeyFunction());
+    map.put(
+        SkyFunctions.BUILD_CONFIGURATION_KEY,
+        new BuildConfigurationKeyFunction(getSkyframeBuildView().getBuildConfigurationKeyCache()));
     map.put(
         SkyFunctions.PARSED_FLAGS,
         new ParsedFlagsFunction(ruleClassProvider.getFragmentRegistry().getOptionsClasses()));
diff --git a/src/main/java/com/google/devtools/build/lib/skyframe/config/BUILD b/src/main/java/com/google/devtools/build/lib/skyframe/config/BUILD
index 5676f1200c..8d266e9094 100644
--- a/src/main/java/com/google/devtools/build/lib/skyframe/config/BUILD
+++ b/src/main/java/com/google/devtools/build/lib/skyframe/config/BUILD
@@ -42,6 +42,7 @@ java_library(
         "//src/main/java/com/google/devtools/build/lib/analysis:config/transitions/configuration_transition",
         "//src/main/java/com/google/devtools/build/lib/analysis:config/transitions/patch_transition",
         "//src/main/java/com/google/devtools/build/lib/analysis:platform_options",
+        "//src/main/java/com/google/devtools/build/lib/analysis/producers:build_configuration_key_cache",
         "//src/main/java/com/google/devtools/build/lib/analysis/producers:build_configuration_key_map_producer",
         "//src/main/java/com/google/devtools/build/lib/cmdline",
         "//src/main/java/com/google/devtools/build/lib/events",
diff --git a/src/main/java/com/google/devtools/build/lib/skyframe/config/BuildConfigurationKeyFunction.java b/src/main/java/com/google/devtools/build/lib/skyframe/config/BuildConfigurationKeyFunction.java
index 838817c0a9..99c49ab179 100644
--- a/src/main/java/com/google/devtools/build/lib/skyframe/config/BuildConfigurationKeyFunction.java
+++ b/src/main/java/com/google/devtools/build/lib/skyframe/config/BuildConfigurationKeyFunction.java
@@ -15,6 +15,7 @@ package com.google.devtools.build.lib.skyframe.config;
 
 import com.google.common.collect.ImmutableMap;
 import com.google.devtools.build.lib.analysis.config.BuildOptions;
+import com.google.devtools.build.lib.analysis.producers.BuildConfigurationKeyCache;
 import com.google.devtools.build.lib.analysis.producers.BuildConfigurationKeyMapProducer;
 import com.google.devtools.build.lib.analysis.producers.BuildConfigurationKeyMapProducer.ResultSink;
 import com.google.devtools.build.lib.skyframe.toolchains.PlatformLookupUtil.InvalidPlatformException;
@@ -36,6 +37,12 @@ public class BuildConfigurationKeyFunction implements SkyFunction {
    */
   private static final String BUILD_OPTIONS_MAP_SINGLETON_KEY = "key";
 
+  private final BuildConfigurationKeyCache buildConfigurationKeyCache;
+
+  public BuildConfigurationKeyFunction(BuildConfigurationKeyCache buildConfigurationKeyCache) {
+    this.buildConfigurationKeyCache = buildConfigurationKeyCache;
+  }
+
   @Nullable
   @Override
   public SkyValue compute(SkyKey skyKey, Environment env)
@@ -49,6 +56,7 @@ public class BuildConfigurationKeyFunction implements SkyFunction {
             new BuildConfigurationKeyMapProducer(
                 sink,
                 /* runAfter= */ StateMachine.DONE,
+                buildConfigurationKeyCache,
                 ImmutableMap.of(BUILD_OPTIONS_MAP_SINGLETON_KEY, buildOptions)));
 
     boolean complete = driver.drive(env);
diff --git a/src/test/java/com/google/devtools/build/lib/analysis/producers/BUILD b/src/test/java/com/google/devtools/build/lib/analysis/producers/BUILD
index 9e8abd59aa..050b93cc75 100644
--- a/src/test/java/com/google/devtools/build/lib/analysis/producers/BUILD
+++ b/src/test/java/com/google/devtools/build/lib/analysis/producers/BUILD
@@ -27,6 +27,7 @@ java_test(
         "//src/main/java/com/google/devtools/build/lib/analysis:config/fragment",
         "//src/main/java/com/google/devtools/build/lib/analysis:config/fragment_options",
         "//src/main/java/com/google/devtools/build/lib/analysis/platform",
+        "//src/main/java/com/google/devtools/build/lib/analysis/producers:build_configuration_key_cache",
         "//src/main/java/com/google/devtools/build/lib/analysis/producers:build_configuration_key_map_producer",
         "//src/main/java/com/google/devtools/build/lib/analysis/producers:platform_flags_producer",
         "//src/main/java/com/google/devtools/build/lib/analysis/producers:platform_info_producer",
diff --git a/src/test/java/com/google/devtools/build/lib/analysis/producers/BuildConfigurationKeyMapProducerTest.java b/src/test/java/com/google/devtools/build/lib/analysis/producers/BuildConfigurationKeyMapProducerTest.java
index 00bb0091be..59c3bd03d0 100644
--- a/src/test/java/com/google/devtools/build/lib/analysis/producers/BuildConfigurationKeyMapProducerTest.java
+++ b/src/test/java/com/google/devtools/build/lib/analysis/producers/BuildConfigurationKeyMapProducerTest.java
@@ -344,7 +344,8 @@ public class BuildConfigurationKeyMapProducerTest extends ProducerTestCase {
           InvalidPlatformException {
     Sink sink = new Sink();
     BuildConfigurationKeyMapProducer producer =
-        new BuildConfigurationKeyMapProducer(sink, StateMachine.DONE, options);
+        new BuildConfigurationKeyMapProducer(
+            sink, StateMachine.DONE, new BuildConfigurationKeyCache(), options);
     // Ignore the return value: sink will either return a result or re-throw whatever exception it
     // received from the producer.
     var unused = executeProducer(producer);
diff --git a/src/test/java/com/google/devtools/build/lib/analysis/producers/BuildConfigurationKeyProducerTest.java b/src/test/java/com/google/devtools/build/lib/analysis/producers/BuildConfigurationKeyProducerTest.java
index d29a4d0760..5450563937 100644
--- a/src/test/java/com/google/devtools/build/lib/analysis/producers/BuildConfigurationKeyProducerTest.java
+++ b/src/test/java/com/google/devtools/build/lib/analysis/producers/BuildConfigurationKeyProducerTest.java
@@ -319,7 +319,8 @@ public class BuildConfigurationKeyProducerTest extends ProducerTestCase {
           InvalidPlatformException {
     Sink sink = new Sink();
     BuildConfigurationKeyProducer<String> producer =
-        new BuildConfigurationKeyProducer<>(sink, StateMachine.DONE, CONTEXT, options);
+        new BuildConfigurationKeyProducer<>(
+            sink, StateMachine.DONE, new BuildConfigurationKeyCache(), CONTEXT, options);
     // Ignore the return value: sink will either return a result or re-throw whatever exception it
     // received from the producer.
     var unused = executeProducer(producer);
diff --git a/src/test/java/com/google/devtools/build/lib/analysis/util/BuildViewForTesting.java b/src/test/java/com/google/devtools/build/lib/analysis/util/BuildViewForTesting.java
index fd93c43393..7f03bc0df3 100644
--- a/src/test/java/com/google/devtools/build/lib/analysis/util/BuildViewForTesting.java
+++ b/src/test/java/com/google/devtools/build/lib/analysis/util/BuildViewForTesting.java
@@ -440,6 +440,7 @@ public class BuildViewForTesting {
           ConfiguredTargetKey.fromConfiguredTarget(configuredTarget),
           ruleClassProvider,
           skyframeBuildView.getStarlarkTransitionCache(),
+          skyframeBuildView.getBuildConfigurationKeyCache(),
           /* semaphoreLocker= */ () -> {},
           new SkyFunctionEnvironmentForTesting(eventHandler, skyframeExecutor),
           eventHandler)) {
diff --git a/src/test/java/com/google/devtools/build/lib/skyframe/ConfigurationsForTargetsTest.java b/src/test/java/com/google/devtools/build/lib/skyframe/ConfigurationsForTargetsTest.java
index 17cdfd985e..f176856af3 100644
--- a/src/test/java/com/google/devtools/build/lib/skyframe/ConfigurationsForTargetsTest.java
+++ b/src/test/java/com/google/devtools/build/lib/skyframe/ConfigurationsForTargetsTest.java
@@ -171,6 +171,7 @@ public final class ConfigurationsForTargetsTest extends AnalysisTestCase {
                     .build(),
                 /* aspects= */ ImmutableList.of(),
                 stateProvider.lateBoundSkyframeBuildView().getStarlarkTransitionCache(),
+                stateProvider.lateBoundSkyframeBuildView().getBuildConfigurationKeyCache(),
                 starlarkExecTransition.orElse(null),
                 env,
                 env.getListener(),
diff --git a/src/test/shell/integration/platform_based_flags_test.sh b/src/test/shell/integration/platform_based_flags_test.sh
index 445a9477d7..252a789d56 100755
--- a/src/test/shell/integration/platform_based_flags_test.sh
+++ b/src/test/shell/integration/platform_based_flags_test.sh
@@ -411,4 +411,35 @@ EOF
   expect_log '//pbf:show: value = "via_transition"'
 }
 
+# Regression test for https://github.com/bazelbuild/bazel/issues/22995
+function test_cache_invalidation() {
+  local -r pkg="$FUNCNAME"
+  mkdir -p "$pkg"
+
+  cat > "$pkg/BUILD" <<EOF
+platform(
+    name = "pbf_demo",
+    flags = [
+        "--//pbf:flag=first",
+    ],
+)
+EOF
+
+  bazel build --platforms="//$pkg:pbf_demo" //pbf:show &> $TEST_log || fail "bazel failed"
+  expect_log '//pbf:show: value = "first"'
+
+  # Now change the platform definition.
+  cat > "$pkg/BUILD" <<EOF
+platform(
+    name = "pbf_demo",
+    flags = [
+        "--//pbf:flag=second",
+    ],
+)
+EOF
+
+  bazel build --platforms="//$pkg:pbf_demo" //pbf:show &> $TEST_log || fail "bazel failed"
+  expect_log '//pbf:show: value = "second"'
+}
+
 run_suite "Tests for platform based flags"
