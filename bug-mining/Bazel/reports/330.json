{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/26251","repository_url":"https://api.github.com/repos/bazelbuild/bazel","labels_url":"https://api.github.com/repos/bazelbuild/bazel/issues/26251/labels{/name}","comments_url":"https://api.github.com/repos/bazelbuild/bazel/issues/26251/comments","events_url":"https://api.github.com/repos/bazelbuild/bazel/issues/26251/events","html_url":"https://github.com/bazelbuild/bazel/issues/26251","id":3134582156,"node_id":"I_kwDOATz7jc661e2M","number":26251,"title":"Bazel sending duplicate work request IDs to multiplex persistent workers","user":{"login":"jadenPete","id":13180372,"node_id":"MDQ6VXNlcjEzMTgwMzcy","avatar_url":"https://avatars.githubusercontent.com/u/13180372?v=4","gravatar_id":"","url":"https://api.github.com/users/jadenPete","html_url":"https://github.com/jadenPete","followers_url":"https://api.github.com/users/jadenPete/followers","following_url":"https://api.github.com/users/jadenPete/following{/other_user}","gists_url":"https://api.github.com/users/jadenPete/gists{/gist_id}","starred_url":"https://api.github.com/users/jadenPete/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jadenPete/subscriptions","organizations_url":"https://api.github.com/users/jadenPete/orgs","repos_url":"https://api.github.com/users/jadenPete/repos","events_url":"https://api.github.com/users/jadenPete/events{/privacy}","received_events_url":"https://api.github.com/users/jadenPete/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":106503259,"node_id":"MDU6TGFiZWwxMDY1MDMyNTk=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/type:%20bug","name":"type: bug","color":"0052cc","default":false,"description":null},{"id":1020665933,"node_id":"MDU6TGFiZWwxMDIwNjY1OTMz","url":"https://api.github.com/repos/bazelbuild/bazel/labels/untriaged","name":"untriaged","color":"c34ddd","default":false,"description":""},{"id":1193207358,"node_id":"MDU6TGFiZWwxMTkzMjA3MzU4","url":"https://api.github.com/repos/bazelbuild/bazel/labels/team-Remote-Exec","name":"team-Remote-Exec","color":"f1f442","default":false,"description":"Issues and PRs for the Execution (Remote) team"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2025-06-10T19:01:43Z","updated_at":"2025-06-16T21:21:36Z","closed_at":"2025-06-12T15:47:44Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description of the bug:\n\n\nWe maintain a multiplex sandboxed persistent worker, and we’re seeing an issue wherein Bazel is reusing work request IDs without waiting for a cancellation response. This creates a race condition that looks something like this:\n1. Bazel sends a work request with ID 1 (we’ll call this request 1-1)\n2. Bazel sends a cancellation request with ID 1\n3. Bazel sends another work request with ID 1 (we’ll call this request 1-2)\n4. At this point, we’re still processing request 1-1, so one of three things happens:\n  a. We don’t receive the cancellation request for 1-1 before it completes. We send a response, but it’s not clear whether we’re responding to 1-1 or 1-2.\n  b. We receive the cancellation request for 1-1 before it completes, but not the work request for 1-2. We send an acknowledgement, but it’s not clear whether we’re responding to 1-1 or 1-2.\n  c. We receive both the cancellation request for 1-1 and the request for 1-2. We don’t send an acknowledgement for the cancellation request because we’re aware of the ambiguity.\n\nWe’ve done some digging and have been able to reproduce the issue when dynamic execution is enabled, but not when it’s disabled. We think the issue lies with [WorkerSpawnRunner#finishWorkAsync](https://github.com/bazelbuild/bazel/blob/35c36c42455ecd273ea6ced35342d88978c598f2/src/main/java/com/google/devtools/build/lib/worker/WorkerSpawnRunner.java#L619).\n\nSpecifically, we think it’s because of two things:\n1. The lifetime of the [next work request ID](https://github.com/bazelbuild/bazel/blob/35c36c42455ecd273ea6ced35342d88978c598f2/src/main/java/com/google/devtools/build/lib/worker/WorkerSpawnRunner.java#L97) is tied to the lifetime of the bazel build or bazel test command\n2. When local beats remote in the dynamic execution race or vice versa, the ongoing Bazel commands exits immediately instead of waiting for a response to the cancellation request it issues\n\nSo it’s possible that if Bazel is invoked quickly in succession after one host beats another in the race and the losing side is still working, work request IDs could be reused. Although we don’t use Java at Lucid, I think Bazel’s Java persistent worker is affected as well because, like our Scala worker, it [kills itself](https://github.com/bazelbuild/bazel/blob/master/src/main/java/com/google/devtools/build/lib/worker/WorkRequestHandler.java#L462) when incoming requests contradict its internal bookkeeping.\n\nI'm creating this issue to spark some discussion around the topic, because I’m not sure if my hypothesis is correct or what the best solution is. Bazel could wait for a cancellation response, but that could erase much of the benefit of enabling dynamic execution if the worker isn’t able to respond promptly. Another option is for the request ID to be scoped to the lifetime of the Bazel server, not the Bazel command.\n\n### Which category does this issue belong to?\n\nRemote Execution\n\n### What's the simplest, easiest way to reproduce this bug? Please provide a minimal example if possible.\n\n\nI haven’t come up with a minimum reproducibility case, but I can if needed. A simple way to consistently reproduce the issue is to write a persistent worker that purposefully takes a long time when invoked remotely, but executes swiftly when invoked locally (or vice versa). Then, promptly invoke Bazel multiple times in succession and observe the duplicate request IDs.\n\n### Which operating system are you running Bazel on?\n\n\nUbuntu 24.04.2 LTS\n\n### What is the output of `bazel info release`?\n\n\nrelease 8.2.1\n\n### If `bazel info release` returns `development version` or `(@non-git)`, tell us how you built Bazel.\n\n\n_No response_\n\n### What's the output of `git remote get-url origin; git rev-parse HEAD` ?\n\n\n```text\n\n```\n\n### If this is a regression, please try to identify the Bazel commit where the bug was introduced with bazelisk --bisect.\n\n\n_No response_\n\n### Have you found anything relevant by searching the web?\n\nNope.\n\n### Any other information, logs, or outputs that you want to share?\n\nNope.","closed_by":{"login":"copybara-service[bot]","id":56741989,"node_id":"MDM6Qm90NTY3NDE5ODk=","avatar_url":"https://avatars.githubusercontent.com/in/44061?v=4","gravatar_id":"","url":"https://api.github.com/users/copybara-service%5Bbot%5D","html_url":"https://github.com/apps/copybara-service","followers_url":"https://api.github.com/users/copybara-service%5Bbot%5D/followers","following_url":"https://api.github.com/users/copybara-service%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/copybara-service%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/copybara-service%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/copybara-service%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/copybara-service%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/copybara-service%5Bbot%5D/repos","events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/26251/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bazelbuild/bazel/issues/26251/timeline","performed_via_github_app":null,"state_reason":"completed"}