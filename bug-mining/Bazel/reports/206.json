{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/20404","repository_url":"https://api.github.com/repos/bazelbuild/bazel","labels_url":"https://api.github.com/repos/bazelbuild/bazel/issues/20404/labels{/name}","comments_url":"https://api.github.com/repos/bazelbuild/bazel/issues/20404/comments","events_url":"https://api.github.com/repos/bazelbuild/bazel/issues/20404/events","html_url":"https://github.com/bazelbuild/bazel/issues/20404","id":2020132094,"node_id":"I_kwDOATz7jc54aMT-","number":20404,"title":"\"upload output\" events missing from JSON profile with --experimental_remote_cache_async","user":{"login":"jin","id":347918,"node_id":"MDQ6VXNlcjM0NzkxOA==","avatar_url":"https://avatars.githubusercontent.com/u/347918?v=4","gravatar_id":"","url":"https://api.github.com/users/jin","html_url":"https://github.com/jin","followers_url":"https://api.github.com/users/jin/followers","following_url":"https://api.github.com/users/jin/following{/other_user}","gists_url":"https://api.github.com/users/jin/gists{/gist_id}","starred_url":"https://api.github.com/users/jin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jin/subscriptions","organizations_url":"https://api.github.com/users/jin/orgs","repos_url":"https://api.github.com/users/jin/repos","events_url":"https://api.github.com/users/jin/events{/privacy}","received_events_url":"https://api.github.com/users/jin/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":106503259,"node_id":"MDU6TGFiZWwxMDY1MDMyNTk=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/type:%20bug","name":"type: bug","color":"0052cc","default":false,"description":null},{"id":192364170,"node_id":"MDU6TGFiZWwxOTIzNjQxNzA=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/P2","name":"P2","color":"e99695","default":false,"description":"We'll consider working on this in future. (Assignee optional)"},{"id":1193207358,"node_id":"MDU6TGFiZWwxMTkzMjA3MzU4","url":"https://api.github.com/repos/bazelbuild/bazel/labels/team-Remote-Exec","name":"team-Remote-Exec","color":"f1f442","default":false,"description":"Issues and PRs for the Execution (Remote) team"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2023-12-01T05:41:13Z","updated_at":"2024-07-29T22:59:05Z","closed_at":"2024-07-24T08:05:24Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description of the bug:\n\n\nWhen enabling `--experimental_remote_cache_async`, the \"upload outputs\" events are missing from the JSON profiler. This makes the profile somewhat inaccurate, because those work is still being done, but just not as a blocking task post-action.\n\n### Which category does this issue belong to?\n\n\nRemote Execution\n\n### What's the simplest, easiest way to reproduce this bug? Please provide a minimal example if possible.\n\n\nRun a remote-cache enabled build that triggers CAS uploads with and without `--experimental_remote_cache_async`, and compare the JSON profiles.\r\n\r\n```\r\n$ cat without_flag.command.profile | jq -j '.traceEvents | .[] | select(.name == \"upload outputs\") | .dur/1000000,    \" \", .name, \"\\n\"' | sort -nr\r\n48.332118 upload outputs\r\n48.3279 upload outputs\r\n21.403152 upload outputs\r\n4.809376 upload outputs\r\n4.638287 upload outputs\r\n3.023634 upload outputs\r\n2.981836 upload outputs\r\n2.16031 upload outputs\r\n1.602159 upload outputs\r\n1.368337 upload outputs\r\n1.211588 upload outputs\r\n1.210596 upload outputs\r\n1.184084 upload outputs\r\n0.998725 upload outputs\r\n0.865894 upload outputs\r\n0.801442 upload outputs\r\n0.761732 upload outputs\r\n0.730206 upload outputs\r\n0.588362 upload outputs\r\n0.569864 upload outputs\r\n0.478627 upload outputs\r\n0.477778 upload outputs\r\n0.438619 upload outputs\r\n0.330436 upload outputs\r\n0.321471 upload outputs\r\n0.315897 upload outputs\r\n0.314685 upload outputs\r\n0.281717 upload outputs\r\n0.253382 upload outputs\r\n0.251439 upload outputs\r\njingwen@jingwen-macbookpro Downloads % cat with_flag.command.profile | jq -j '.traceEvents | .[] | select(.name == \"upload outputs\") | .dur/1000000,    \" \", .name, \"\\n\"' | sort -nr\r\n```\n\n### Which operating system are you running Bazel on?\n\n\nlinux\n\n### What is the output of `bazel info release`?\n\n\n6.2\n\n### If `bazel info release` returns `development version` or `(@non-git)`, tell us how you built Bazel.\n\n\n_No response_\n\n### What's the output of `git remote get-url origin; git rev-parse master; git rev-parse HEAD` ?\n\n\n_No response_\n\n### Is this a regression? If yes, please try to identify the Bazel commit where the bug was introduced.\n\n\nI think it's just wasn't implemented - http://google3/third_party/bazel/src/main/java/com/google/devtools/build/lib/remote/RemoteExecutionService.java;l=1382-1419;rcl=586625265 looks like the async steps aren't wrapped in a profiler call, but the synchronous ones are.\n\n### Have you found anything relevant by searching the web?\n\n_No response_\n\n### Any other information, logs, or outputs that you want to share?\n\n_No response_","closed_by":{"login":"copybara-service[bot]","id":56741989,"node_id":"MDM6Qm90NTY3NDE5ODk=","avatar_url":"https://avatars.githubusercontent.com/in/44061?v=4","gravatar_id":"","url":"https://api.github.com/users/copybara-service%5Bbot%5D","html_url":"https://github.com/apps/copybara-service","followers_url":"https://api.github.com/users/copybara-service%5Bbot%5D/followers","following_url":"https://api.github.com/users/copybara-service%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/copybara-service%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/copybara-service%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/copybara-service%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/copybara-service%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/copybara-service%5Bbot%5D/repos","events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/20404/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bazelbuild/bazel/issues/20404/timeline","performed_via_github_app":null,"state_reason":"completed"}