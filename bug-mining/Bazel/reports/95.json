{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/19945","repository_url":"https://api.github.com/repos/bazelbuild/bazel","labels_url":"https://api.github.com/repos/bazelbuild/bazel/issues/19945/labels{/name}","comments_url":"https://api.github.com/repos/bazelbuild/bazel/issues/19945/comments","events_url":"https://api.github.com/repos/bazelbuild/bazel/issues/19945/events","html_url":"https://github.com/bazelbuild/bazel/issues/19945","id":1961756221,"node_id":"I_kwDOATz7jc507gY9","number":19945,"title":"Precedence of --extra_toolchains toolchains is wrong","user":{"login":"layus","id":632767,"node_id":"MDQ6VXNlcjYzMjc2Nw==","avatar_url":"https://avatars.githubusercontent.com/u/632767?v=4","gravatar_id":"","url":"https://api.github.com/users/layus","html_url":"https://github.com/layus","followers_url":"https://api.github.com/users/layus/followers","following_url":"https://api.github.com/users/layus/following{/other_user}","gists_url":"https://api.github.com/users/layus/gists{/gist_id}","starred_url":"https://api.github.com/users/layus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/layus/subscriptions","organizations_url":"https://api.github.com/users/layus/orgs","repos_url":"https://api.github.com/users/layus/repos","events_url":"https://api.github.com/users/layus/events{/privacy}","received_events_url":"https://api.github.com/users/layus/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":106503259,"node_id":"MDU6TGFiZWwxMDY1MDMyNTk=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/type:%20bug","name":"type: bug","color":"0052cc","default":false,"description":null},{"id":192364134,"node_id":"MDU6TGFiZWwxOTIzNjQxMzQ=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/P1","name":"P1","color":"d93f0b","default":false,"description":"I'll work on this now. (Assignee required)"},{"id":1020660688,"node_id":"MDU6TGFiZWwxMDIwNjYwNjg4","url":"https://api.github.com/repos/bazelbuild/bazel/labels/team-Configurability","name":"team-Configurability","color":"f1f442","default":false,"description":"platforms, toolchains, cquery, select(), config transitions"}],"state":"closed","locked":false,"assignee":{"login":"katre","id":326527,"node_id":"MDQ6VXNlcjMyNjUyNw==","avatar_url":"https://avatars.githubusercontent.com/u/326527?v=4","gravatar_id":"","url":"https://api.github.com/users/katre","html_url":"https://github.com/katre","followers_url":"https://api.github.com/users/katre/followers","following_url":"https://api.github.com/users/katre/following{/other_user}","gists_url":"https://api.github.com/users/katre/gists{/gist_id}","starred_url":"https://api.github.com/users/katre/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/katre/subscriptions","organizations_url":"https://api.github.com/users/katre/orgs","repos_url":"https://api.github.com/users/katre/repos","events_url":"https://api.github.com/users/katre/events{/privacy}","received_events_url":"https://api.github.com/users/katre/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"katre","id":326527,"node_id":"MDQ6VXNlcjMyNjUyNw==","avatar_url":"https://avatars.githubusercontent.com/u/326527?v=4","gravatar_id":"","url":"https://api.github.com/users/katre","html_url":"https://github.com/katre","followers_url":"https://api.github.com/users/katre/followers","following_url":"https://api.github.com/users/katre/following{/other_user}","gists_url":"https://api.github.com/users/katre/gists{/gist_id}","starred_url":"https://api.github.com/users/katre/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/katre/subscriptions","organizations_url":"https://api.github.com/users/katre/orgs","repos_url":"https://api.github.com/users/katre/repos","events_url":"https://api.github.com/users/katre/events{/privacy}","received_events_url":"https://api.github.com/users/katre/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":3,"created_at":"2023-10-25T15:58:29Z","updated_at":"2023-12-01T19:19:15Z","closed_at":"2023-11-06T16:06:37Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description of the bug:\n\n\nMultiple uses of --extra_toolchains are accumulated, but due to how toolchains work, the last use does not take precendence over the first use.\r\nToolchains are examined in the order of their registration by the flags, and the first one that matches gets used. This makes it impossible to override a previously registered toolchain. In particular, it is impossible to override a toolchain defined in a .bazelrc file, because these are always evaluated first.\r\n\r\nObviously, this is also how toolchains work in WORKSPACE files, where the first one to be registered is preferred.\r\nI would argue that this is wrong too, but it causes less trouble, because the toolchains defined in the WORKSPACE are unlikely to conflict or compete for the same platforms, and the order can be altered to make it work.\r\n\r\nThe point of --extra_toolchains however is to provide hot fixes for the build, or to tune it. These use are more likely to add competing toolchains, and the one on the command line is probably a more important fix than the one in the .bazelrc file, which in turn is probably more important than toolchains defined in the WORKSPACE.\r\n\r\nThis precedence is partially implemented, as all --extra_toolchains options take precedence over the WORKSPACE file.\r\n\r\nSee also https://github.com/bazelbuild/bazel/pull/19942#issuecomment-1779378346 for the context where I discovered the issue, and the whole https://github.com/bazelbuild/bazel/pull/19942 for a fix.\n\n### Which category does this issue belong to?\n\n\n_No response_\n\n### What's the simplest, easiest way to reproduce this bug? Please provide a minimal example if possible.\n\n\nWith two compatible toolchains, add them both on the command line, and observe that the first one is preferred. There is even a test enforcing it (this is the only trace that this may be an intentional behavior):\r\n\r\nhttps://github.com/bazelbuild/bazel/blob/8630b0112f05577c5d5c07800ae88f38f0dcbb91/src/test/java/com/google/devtools/build/lib/skyframe/toolchains/RegisteredToolchainsFunctionTest.java#L144-L159\n\n### Which operating system are you running Bazel on?\n\n\nirrelevant, behavior is under test\n\n### What is the output of `bazel info release`?\n\n\nirrelevant, behavior is under test\n\n### If `bazel info release` returns `development version` or `(@non-git)`, tell us how you built Bazel.\n\n\nall recent bazel versions.\n\n### What's the output of `git remote get-url origin; git rev-parse master; git rev-parse HEAD` ?\n\n\n```text\n6c02329b1e, current master.\n```\n\n\n### Is this a regression? If yes, please try to identify the Bazel commit where the bug was introduced.\n\n\n_No response_\n\n### Have you found anything relevant by searching the web?\n\n_No response_\n\n### Any other information, logs, or outputs that you want to share?\n\n_No response_","closed_by":{"login":"copybara-service[bot]","id":56741989,"node_id":"MDM6Qm90NTY3NDE5ODk=","avatar_url":"https://avatars.githubusercontent.com/in/44061?v=4","gravatar_id":"","url":"https://api.github.com/users/copybara-service%5Bbot%5D","html_url":"https://github.com/apps/copybara-service","followers_url":"https://api.github.com/users/copybara-service%5Bbot%5D/followers","following_url":"https://api.github.com/users/copybara-service%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/copybara-service%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/copybara-service%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/copybara-service%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/copybara-service%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/copybara-service%5Bbot%5D/repos","events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/19945/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bazelbuild/bazel/issues/19945/timeline","performed_via_github_app":null,"state_reason":"completed"}