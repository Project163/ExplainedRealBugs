{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/22614","repository_url":"https://api.github.com/repos/bazelbuild/bazel","labels_url":"https://api.github.com/repos/bazelbuild/bazel/issues/22614/labels{/name}","comments_url":"https://api.github.com/repos/bazelbuild/bazel/issues/22614/comments","events_url":"https://api.github.com/repos/bazelbuild/bazel/issues/22614/events","html_url":"https://github.com/bazelbuild/bazel/issues/22614","id":2330891507,"node_id":"I_kwDOATz7jc6K7pTz","number":22614,"title":"Using --features=external_include_paths on MSVC breaks compilation in Bazel 7 due to extra newlines in .params","user":{"login":"stephen-ryan-ansys","id":24819660,"node_id":"MDQ6VXNlcjI0ODE5NjYw","avatar_url":"https://avatars.githubusercontent.com/u/24819660?v=4","gravatar_id":"","url":"https://api.github.com/users/stephen-ryan-ansys","html_url":"https://github.com/stephen-ryan-ansys","followers_url":"https://api.github.com/users/stephen-ryan-ansys/followers","following_url":"https://api.github.com/users/stephen-ryan-ansys/following{/other_user}","gists_url":"https://api.github.com/users/stephen-ryan-ansys/gists{/gist_id}","starred_url":"https://api.github.com/users/stephen-ryan-ansys/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/stephen-ryan-ansys/subscriptions","organizations_url":"https://api.github.com/users/stephen-ryan-ansys/orgs","repos_url":"https://api.github.com/users/stephen-ryan-ansys/repos","events_url":"https://api.github.com/users/stephen-ryan-ansys/events{/privacy}","received_events_url":"https://api.github.com/users/stephen-ryan-ansys/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":106503259,"node_id":"MDU6TGFiZWwxMDY1MDMyNTk=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/type:%20bug","name":"type: bug","color":"0052cc","default":false,"description":null},{"id":1020664427,"node_id":"MDU6TGFiZWwxMDIwNjY0NDI3","url":"https://api.github.com/repos/bazelbuild/bazel/labels/team-Rules-CPP","name":"team-Rules-CPP","color":"f1f442","default":false,"description":"Issues for C++ rules"},{"id":1020665933,"node_id":"MDU6TGFiZWwxMDIwNjY1OTMz","url":"https://api.github.com/repos/bazelbuild/bazel/labels/untriaged","name":"untriaged","color":"c34ddd","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2024-06-03T11:25:45Z","updated_at":"2024-06-04T07:57:10Z","closed_at":"2024-06-04T07:57:10Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description of the bug:\r\n\r\n\r\nThe `external_include_paths` feature is breaking with MSVC in Bazel >7.0.0 during compilation. When using Bazel 6.5.0, using this feature does not result in a compilation error. It seems to affect every compile operation, all giving me the same type of error:\r\n\r\n```\r\nERROR: C:/users/<name>/workspace/hello_world_test/BUILD:1:10: Compiling hello_world.cc failed: (Exit 2): cl.exe failed: error executing CppCompile command (from target //:hello-world) C:\\Program Files\\Microsoft Visual Studio\\2022\\Professional\\VC\\Tools\\MSVC\\14.39.33519\\bin\\HostX64\\x64\\cl.exe @bazel-out/x64_windows-fastbuild/bin/_objs/hello-world/hello_world.obj.params\r\ncl : Command line error D8004 : '/external:I' requires an argument\r\n```\r\n\r\nIt seems that in the .params file, there is a newline after every use of `/external:I`. This causes MSVC to not recognize that there is an argument given to it. This .params files is not being used when compiling with Bazel 6.5.0, so this was not an issue previously.\r\n\r\nRemoving the newline after `/external:I` so that the argument is on the same line in the .params file and manually running the compilation command results in a successful compilation. Compiling without using the .params file by using `--features=-compiler_param_file` also results in a successful compilation.\r\n\r\n\r\n\r\n### Which category does this issue belong to?\r\n\r\nC++ Rules\r\n\r\n### What's the simplest, easiest way to reproduce this bug? Please provide a minimal example if possible.\r\n\r\n\r\nI am using a simple Hello World example, with the following files:\r\n\r\n- `.bazelrc`\r\n\r\n```\r\ncommon --enable_platform_specific_config\r\n\r\nbuild:linux --cxxopt='-std=c++17'\r\nbuild:linux --features=external_include_paths\r\n\r\nbuild:windows --cxxopt='-std:c++17'\r\nbuild:windows --features=external_include_paths\r\nbuild:windows --cxxopt='/external:W0'\r\n```\r\n\r\n- `BUILD`\r\n```\r\ncc_binary(\r\n    name = \"hello-world\",\r\n    srcs = [\"hello_world.cc\"],\r\n)\r\n```\r\n\r\n- `hello_world.cc`\r\n```\r\n#include <iostream>\r\n\r\nint main()\r\n{\r\n    std::cout << \"Hello World!\" << std::endl;\r\n    return 0;\r\n}\r\n```\r\n\r\n- `WORKSPACE` is empty\r\n- `.bazelversion` contains either `6.5.0` or `7.1.2`\r\n\r\nThen, on Windows with MSVC, simply running `bazel build //:hello-world` will reproduce the error when `.bazelversion` is set to > 7.0.0\r\n\r\n### Which operating system are you running Bazel on?\r\n\r\n\r\nWindows 10 Enterprise 22H2\r\n\r\n### What is the output of `bazel info release`?\r\n\r\n\r\nrelease 7.1.2\r\n\r\n### If `bazel info release` returns `development version` or `(@non-git)`, tell us how you built Bazel.\r\n\r\n\r\n_No response_\r\n\r\n### What's the output of `git remote get-url origin; git rev-parse HEAD` ?\r\n\r\n\r\n_No response_\r\n\r\n### Is this a regression? If yes, please try to identify the Bazel commit where the bug was introduced.\r\n\r\n\r\n_No response_\r\n\r\n### Have you found anything relevant by searching the web?\r\n\r\n_No response_\r\n\r\n### Any other information, logs, or outputs that you want to share?\r\n\r\nThe above-mentioned error was:\r\n\r\n```\r\nERROR: C:/users/<name>/workspace/hello_world_test/BUILD:1:10: Compiling hello_world.cc failed: (Exit 2): cl.exe failed: error executing CppCompile command (from target //:hello-world) C:\\Program Files\\Microsoft Visual Studio\\2022\\Professional\\VC\\Tools\\MSVC\\14.39.33519\\bin\\HostX64\\x64\\cl.exe @bazel-out/x64_windows-fastbuild/bin/_objs/hello-world/hello_world.obj.params\r\ncl : Command line error D8004 : '/external:I' requires an argument\r\n```\r\n\r\nWith Bazel 7.1.2, The contents of the .params file are:\r\n\r\n```\r\n/nologo\r\n/DCOMPILER_MSVC\r\n/DNOMINMAX\r\n/D_WIN32_WINNT=0x0601\r\n/D_CRT_SECURE_NO_DEPRECATE\r\n/D_CRT_SECURE_NO_WARNINGS\r\n/bigobj\r\n/Zm500\r\n/EHsc\r\n/wd4351\r\n/wd4291\r\n/wd4250\r\n/wd4996\r\n/I.\r\n/Ibazel-out/x64_windows-fastbuild/bin\r\n/Iexternal/bazel_tools\r\n/Ibazel-out/x64_windows-fastbuild/bin/external/bazel_tools\r\n/external:I\r\nexternal/bazel_tools\r\n/external:I\r\nbazel-out/x64_windows-fastbuild/bin/external/bazel_tools\r\n/showIncludes\r\n/MD\r\n/Od\r\n/Z7\r\n/wd4117\r\n-D__DATE__=\\\"redacted\\\"\r\n-D__TIMESTAMP__=\\\"redacted\\\"\r\n-D__TIME__=\\\"redacted\\\"\r\n-std:c++17\r\n/external:W0\r\n/Fobazel-out/x64_windows-fastbuild/bin/_objs/hello-world/hello_world.obj\r\n/c\r\nhello_world.cc\r\n```\r\n\r\nWhen building with bazel 6.5.0, the compile command is not using a .params file. The compile command is as follows:\r\n```\r\nC:\\Program Files\\Microsoft Visual Studio\\2022\\Professional\\VC\\Tools\\MSVC\\14.39.33519\\bin\\HostX64\\x64\\cl.exe /nologo /DCOMPILER_MSVC /DNOMINMAX /D_WIN32_WINNT=0x0601 /D_CRT_SECURE_NO_DEPRECATE /D_CRT_SECURE_NO_WARNINGS /bigobj /Zm500 /EHsc /wd4351 /wd4291 /wd4250 /wd4996 /I. /Ibazel-out/x64_windows-fastbuild/bin /Iexternal/bazel_tools /Ibazel-out/x64_windows-fastbuild/bin/external/bazel_tools /external:I external/bazel_tools /external:I bazel-out/x64_windows-fastbuild/bin/external/bazel_tools /DBAZEL_CURRENT_REPOSITORY=\"\" /showIncludes /MD /Od /Z7 /wd4117 -D__DATE__=\"redacted\" -D__TIMESTAMP__=\"redacted\" -D__TIME__=\"redacted\" -std:c++17 /external:W0 /Fobazel-out/x64_windows-fastbuild/bin/_objs/hello-world/hello_world.obj /c hello_world.cc\r\n```\r\nThe options are the same, with the exception of the `/DBAZEL_CURRENT_REPOSITORY=\"\"` option being present in Bazel 6.5.0, but not Bazel 7.1.2.\r\n\r\nReturning to the output from 7.1.2, if I edit the params files to get rid of the newline between `/external:I` and its argument, e.g., `/external:Iexternal/bazel_tools`, or equivalently `/external:I external/bazel_tools` (with a space), and I try to manually run the same compile command, then it works.\r\n\r\nUsing Visual Studio 22, 17.9.7\r\nMSVC v143\r\ncl.exe version 19.39.33523 for x64\r\n\r\n","closed_by":{"login":"copybara-service[bot]","id":56741989,"node_id":"MDM6Qm90NTY3NDE5ODk=","avatar_url":"https://avatars.githubusercontent.com/in/44061?v=4","gravatar_id":"","url":"https://api.github.com/users/copybara-service%5Bbot%5D","html_url":"https://github.com/apps/copybara-service","followers_url":"https://api.github.com/users/copybara-service%5Bbot%5D/followers","following_url":"https://api.github.com/users/copybara-service%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/copybara-service%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/copybara-service%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/copybara-service%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/copybara-service%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/copybara-service%5Bbot%5D/repos","events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/22614/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bazelbuild/bazel/issues/22614/timeline","performed_via_github_app":null,"state_reason":"completed"}