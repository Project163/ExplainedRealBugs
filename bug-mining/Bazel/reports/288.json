{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/24782","repository_url":"https://api.github.com/repos/bazelbuild/bazel","labels_url":"https://api.github.com/repos/bazelbuild/bazel/issues/24782/labels{/name}","comments_url":"https://api.github.com/repos/bazelbuild/bazel/issues/24782/comments","events_url":"https://api.github.com/repos/bazelbuild/bazel/issues/24782/events","html_url":"https://github.com/bazelbuild/bazel/issues/24782","id":2752877339,"node_id":"I_kwDOATz7jc6kFZMb","number":24782,"title":"Bazel Memory Tracker shows incorrect memory consumption","user":{"login":"AlexanderGolovlev","id":22532709,"node_id":"MDQ6VXNlcjIyNTMyNzA5","avatar_url":"https://avatars.githubusercontent.com/u/22532709?v=4","gravatar_id":"","url":"https://api.github.com/users/AlexanderGolovlev","html_url":"https://github.com/AlexanderGolovlev","followers_url":"https://api.github.com/users/AlexanderGolovlev/followers","following_url":"https://api.github.com/users/AlexanderGolovlev/following{/other_user}","gists_url":"https://api.github.com/users/AlexanderGolovlev/gists{/gist_id}","starred_url":"https://api.github.com/users/AlexanderGolovlev/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AlexanderGolovlev/subscriptions","organizations_url":"https://api.github.com/users/AlexanderGolovlev/orgs","repos_url":"https://api.github.com/users/AlexanderGolovlev/repos","events_url":"https://api.github.com/users/AlexanderGolovlev/events{/privacy}","received_events_url":"https://api.github.com/users/AlexanderGolovlev/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":106503259,"node_id":"MDU6TGFiZWwxMDY1MDMyNTk=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/type:%20bug","name":"type: bug","color":"0052cc","default":false,"description":null},{"id":192364170,"node_id":"MDU6TGFiZWwxOTIzNjQxNzA=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/P2","name":"P2","color":"e99695","default":false,"description":"We'll consider working on this in future. (Assignee optional)"},{"id":1020660325,"node_id":"MDU6TGFiZWwxMDIwNjYwMzI1","url":"https://api.github.com/repos/bazelbuild/bazel/labels/team-Performance","name":"team-Performance","color":"f1f442","default":false,"description":"Issues for Performance teams"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2024-12-20T14:41:53Z","updated_at":"2025-02-04T22:45:45Z","closed_at":"2025-01-10T16:16:18Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description of the bug:\n\n\nAccording to [documentation](https://docs.bazel.build/versions/main/skylark/performance.html#enabling-memory-tracking) Bazel allows to instrument memory allocations. It seems that now this feature provides an incorrect information.\r\nAll values of memory consumption for rules are either 0 or values which are roughly multiples of 256kB. For example, the text dump for prof.gz shows:\r\n```\r\nShowing nodes accounting for 5888.52kB, 100% of 5888.52kB total\r\n      flat  flat%   sum%        cum   cum%\r\n 4352.59kB 73.92% 73.92%  4352.59kB 73.92%  repository_rule <builtin>\r\n  512.02kB  8.70% 82.61%   512.02kB  8.70%  config_setting <builtin>\r\n  256.07kB  4.35% 86.96%   256.07kB  4.35%  create_linking_context_from_compilation_outputs <builtin>\r\n  255.99kB  4.35% 91.31%   255.99kB  4.35%  cc_toolchain_features <builtin>\r\n  255.93kB  4.35% 95.65%   255.93kB  4.35%  cc_object_library <builtin>\r\n...\r\n```\r\nThe total memory consumption is also far from expected values.\r\nIt looks like the values of memory consumption are taken from shifted position in memory. It might be caused by changes in internal Java structures.\r\n\r\nI believe, the problem is in outdated version of `java-allocation-instrumenter-3.3.0.jar` used for instrumenting. According to [Release notes](https://github.com/google/allocation-instrumenter/releases) the support for Java 17 was added in 3.3.2, and support for Java 21 was added in 3.3.4.\r\nHowever, my attempts to use a newer version of instrumenter were unsuccessful. Bazel crashes with any version higher than 3.3.0. The error message is unclear:\r\n```\r\nException in thread \"main\" java.lang.reflect.InvocationTargetException\r\n\tat java.base/jdk.internal.reflect.DirectMethodHandleAccessor.invoke(Unknown Source)\r\n\tat java.base/java.lang.reflect.Method.invoke(Unknown Source)\r\n\tat java.instrument/sun.instrument.InstrumentationImpl.loadClassAndStartAgent(Unknown Source)\r\n\tat java.instrument/sun.instrument.InstrumentationImpl.loadClassAndCallPremain(Unknown Source)\r\nCaused by: java.lang.RuntimeException: java.lang.NullPointerException: Cannot invoke \"java.net.URL.openConnection()\" because \"url\" is null\r\n\tat com.google.monitoring.runtime.instrumentation.AllocationInstrumenterBootstrap.premain(AllocationInstrumenterBootstrap.java:50)\r\n\t... 4 more\r\nCaused by: java.lang.NullPointerException: Cannot invoke \"java.net.URL.openConnection()\" because \"url\" is null\r\n\tat com.google.monitoring.runtime.instrumentation.AllocationInstrumenterBootstrap.premain(AllocationInstrumenterBootstrap.java:40)\r\n\t... 4 more\r\n*** java.lang.instrument ASSERTION FAILED ***: \"!errorOutstanding\" with message Outstanding error when calling method in invokeJavaAgentMainMethod at s\\src\\java.instrument\\share\\native\\libinstrument\\JPLISAgent.c line: 627\r\n*** java.lang.instrument ASSERTION FAILED ***: \"success\" with message invokeJavaAgentMainMethod failed at s\\src\\java.instrument\\share\\native\\libinstrument\\JPLISAgent.c line: 466\r\n*** java.lang.instrument ASSERTION FAILED ***: \"result\" with message agent load/premain call failed at s\\src\\java.instrument\\share\\native\\libinstrument\\JPLISAgent.c line: 429\r\nFATAL ERROR in native method: processing of -javaagent failed, processJavaStart failed\r\n```\n\n### Which category does this issue belong to?\n\nPerformance\n\n### What's the simplest, easiest way to reproduce this bug? Please provide a minimal example if possible.\n\n\nPerform steps according to documentation:\r\n1. Pass STARTUP_FLAGS to any Bazel invocation:\r\n```\r\n  STARTUP_FLAGS=\\\r\n  --host_jvm_args=-javaagent:<path to java-allocation-instrumenter-3.3.0.jar> \\\r\n  --host_jvm_args=-DRULE_MEMORY_TRACKER=1\r\n```\r\n2. Run any `bazel build`\r\n3. Run `bazel dump --rules` or `bazel dump --skylark_memory=$HOME/prof.gz`\r\n\n\n### Which operating system are you running Bazel on?\n\n\nWindows, Linux, Mac\n\n### What is the output of `bazel info release`?\n\n\nrelease 7.4.0\n\n### If `bazel info release` returns `development version` or `(@non-git)`, tell us how you built Bazel.\n\n\n_No response_\n\n### What's the output of `git remote get-url origin; git rev-parse HEAD` ?\n\n\n_No response_\n\n### If this is a regression, please try to identify the Bazel commit where the bug was introduced with bazelisk --bisect.\n\n\n_No response_\n\n### Have you found anything relevant by searching the web?\n\n_No response_\n\n### Any other information, logs, or outputs that you want to share?\n\n_No response_","closed_by":{"login":"copybara-service[bot]","id":56741989,"node_id":"MDM6Qm90NTY3NDE5ODk=","avatar_url":"https://avatars.githubusercontent.com/in/44061?v=4","gravatar_id":"","url":"https://api.github.com/users/copybara-service%5Bbot%5D","html_url":"https://github.com/apps/copybara-service","followers_url":"https://api.github.com/users/copybara-service%5Bbot%5D/followers","following_url":"https://api.github.com/users/copybara-service%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/copybara-service%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/copybara-service%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/copybara-service%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/copybara-service%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/copybara-service%5Bbot%5D/repos","events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/24782/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bazelbuild/bazel/issues/24782/timeline","performed_via_github_app":null,"state_reason":"completed"}