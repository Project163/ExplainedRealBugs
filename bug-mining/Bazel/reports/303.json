{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/25286","repository_url":"https://api.github.com/repos/bazelbuild/bazel","labels_url":"https://api.github.com/repos/bazelbuild/bazel/issues/25286/labels{/name}","comments_url":"https://api.github.com/repos/bazelbuild/bazel/issues/25286/comments","events_url":"https://api.github.com/repos/bazelbuild/bazel/issues/25286/events","html_url":"https://github.com/bazelbuild/bazel/issues/25286","id":2854583702,"node_id":"I_kwDOATz7jc6qJX2W","number":25286,"title":"`repository_ctx.original_name` is the empty string under `WORKSPACE`","user":{"login":"mbland","id":301547,"node_id":"MDQ6VXNlcjMwMTU0Nw==","avatar_url":"https://avatars.githubusercontent.com/u/301547?v=4","gravatar_id":"","url":"https://api.github.com/users/mbland","html_url":"https://github.com/mbland","followers_url":"https://api.github.com/users/mbland/followers","following_url":"https://api.github.com/users/mbland/following{/other_user}","gists_url":"https://api.github.com/users/mbland/gists{/gist_id}","starred_url":"https://api.github.com/users/mbland/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mbland/subscriptions","organizations_url":"https://api.github.com/users/mbland/orgs","repos_url":"https://api.github.com/users/mbland/repos","events_url":"https://api.github.com/users/mbland/events{/privacy}","received_events_url":"https://api.github.com/users/mbland/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":106503259,"node_id":"MDU6TGFiZWwxMDY1MDMyNTk=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/type:%20bug","name":"type: bug","color":"0052cc","default":false,"description":null},{"id":192364134,"node_id":"MDU6TGFiZWwxOTIzNjQxMzQ=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/P1","name":"P1","color":"d93f0b","default":false,"description":"I'll work on this now. (Assignee required)"},{"id":1020663381,"node_id":"MDU6TGFiZWwxMDIwNjYzMzgx","url":"https://api.github.com/repos/bazelbuild/bazel/labels/team-ExternalDeps","name":"team-ExternalDeps","color":"f1f442","default":false,"description":"External dependency handling, remote repositiories, WORKSPACE file."}],"state":"closed","locked":false,"assignee":{"login":"fmeum","id":4312191,"node_id":"MDQ6VXNlcjQzMTIxOTE=","avatar_url":"https://avatars.githubusercontent.com/u/4312191?v=4","gravatar_id":"","url":"https://api.github.com/users/fmeum","html_url":"https://github.com/fmeum","followers_url":"https://api.github.com/users/fmeum/followers","following_url":"https://api.github.com/users/fmeum/following{/other_user}","gists_url":"https://api.github.com/users/fmeum/gists{/gist_id}","starred_url":"https://api.github.com/users/fmeum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fmeum/subscriptions","organizations_url":"https://api.github.com/users/fmeum/orgs","repos_url":"https://api.github.com/users/fmeum/repos","events_url":"https://api.github.com/users/fmeum/events{/privacy}","received_events_url":"https://api.github.com/users/fmeum/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"fmeum","id":4312191,"node_id":"MDQ6VXNlcjQzMTIxOTE=","avatar_url":"https://avatars.githubusercontent.com/u/4312191?v=4","gravatar_id":"","url":"https://api.github.com/users/fmeum","html_url":"https://github.com/fmeum","followers_url":"https://api.github.com/users/fmeum/followers","following_url":"https://api.github.com/users/fmeum/following{/other_user}","gists_url":"https://api.github.com/users/fmeum/gists{/gist_id}","starred_url":"https://api.github.com/users/fmeum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fmeum/subscriptions","organizations_url":"https://api.github.com/users/fmeum/orgs","repos_url":"https://api.github.com/users/fmeum/repos","events_url":"https://api.github.com/users/fmeum/events{/privacy}","received_events_url":"https://api.github.com/users/fmeum/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":5,"created_at":"2025-02-14T19:48:00Z","updated_at":"2025-10-28T17:10:40Z","closed_at":"2025-02-18T19:48:24Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description of the bug:\n\n\nWhen building under `WORKSPACE` with Bazel 8.1.0 (and 8.1.0rc2), `repository_ctx.original_name` will be the empty string. This produces default `BUILD` targets with empty names inside generated repos (the use case from #24467), breaking the build.\n\nCommit 8bcfb06e902c3d9b3d0839a1d9a38827f8b68672 introduced `repository_ctx.original_name` for release in 8.1.0 (first appearing in 8.1.0rc2), closing #24467 and #25121. In bazelbuild/rules_scala#1694, I introduced code like this to use it when available, which breaks when building with Bazel 8.1.0 and `--enable_workspace`:\n\n```py\n# Replace with rctx.original_name once all supported Bazels have it\n\"name\": getattr(rctx, \"original_name\", rctx.attr.default_target_name),\n```\n\nIt would be good to have this field set regardless when using `WORKSPACE`, even though it would duplicate `repository_ctx.name`, to avoid having to write code like this (which does work, but is quite clumsy):\n\n```py\n\"name\": (\n    getattr(rctx, \"original_name\", rctx.attr.default_target_name) or\n    rctx.name\n),\n```\n\nAn alternative would be to remove it from `WORKSPACE` builds altogether, but it would be great to have it work with `WORKSPACE` so people can just use `repository_ctx.original_name` directly and forget about it once Bazel 8 is the oldest supported version (i.e., so the `getattr` checks can go away sooner than later).\n\n(Sorry I didn't actually get around to testing this case when 8.1.0rc2 came out; I only used it to check #25192.)\n\n### Which category does this issue belong to?\n\nCore\n\n### What's the simplest, easiest way to reproduce this bug? Please provide a minimal example if possible.\n\n\n`WORKSPACE`:\n\n```py\nworkspace(name = \"original-name-repro\")\n    \nload(\"//:repro.bzl\", \"repro_repo\")\n    \nrepro_repo(name = \"name\", default_target_name = \"name\")\n```\n\n`MODULE.bazel`:\n\n```py\nmodule(name = \"original-name-repro\", version = \"0.0.0\")\n    \nrepro_repo = use_repo_rule(\"//:repro.bzl\", \"repro_repo\")\n    \nrepro_repo(name = \"name\", default_target_name = \"name\")\n```\n\n`BUILD`:\n\n```py\ngenrule(\n    name = \"name\",\n    srcs = [\"@name\"],\n    outs = [\"name.txt\"],\n    cmd = \"cat $(execpath @name) > \\\"$@\\\"\",\n)\n```\n\n`repro.bzl`:\n\n```py\n_build_template = \"\"\"genrule(\n    name = \"{target_name}\",\n    outs = [\"name.txt\"],\n    cmd = \"echo '{target_name}' > \\\\\"$@\\\\\"\",\n    visibility = [\"//visibility:public\"],\n)\n\"\"\"\n\ndef _repro_repo_impl(rctx):\n    target_name = getattr(rctx, \"original_name\", rctx.attr.default_target_name)\n\n    if hasattr(rctx, \"original_name\"):\n        print(\"name: '%s' original_name: '%s' target_name: '%s'\" % (\n            rctx.name, rctx.original_name, target_name)\n        )\n    else:\n        print(\"original_name not available\")\n\n    rctx.file(\"BUILD\", _build_template.format(target_name = target_name))\n\nrepro_repo = repository_rule(\n    implementation = _repro_repo_impl,\n    attrs= {\n        \"default_target_name\": attr.string(mandatory = True),\n    },\n)\n```\n\nThen running the following (edited for brevity):\n\n```txt\n$ USE_BAZEL_VERSION=7.5.0 bazel build --enable_workspace --noenable_bzlmod //:name && echo \"NAME: $(< bazel-bin/name.txt)\"\n\nDEBUG: .../repro.bzl:17:14: original_name not available\nTarget //:name up-to-date:\n  bazel-bin/name.txt\nNAME: name\n\n$ USE_BAZEL_VERSION=7.5.0 bazel build --noenable_workspace --enable_bzlmod //:name && echo \"NAME: $(< bazel-bin/name.txt)\"\n\nDEBUG: .../repro.bzl:17:14: original_name not available\nTarget //:name up-to-date:\n  bazel-bin/name.txt\nNAME: name\n\n$ USE_BAZEL_VERSION=8.1.0 bazel build --noenable_workspace --enable_bzlmod //:name && echo \"NAME: $(< bazel-bin/name.txt)\"\n\nDEBUG: .../repro.bzl:13:14: name: '+_repo_rules+name' original_name: 'name' target_name: 'name'\nTarget //:name up-to-date:\n  bazel-bin/name.txt\nNAME: name\n\n$ USE_BAZEL_VERSION=8.1.0 bazel build --enable_workspace --noenable_bzlmod //:name && echo \"NAME: $(< bazel-bin/name.txt)\"\n\nDEBUG: .../repro.bzl:13:14: name: 'name' original_name: '' target_name: ''\nERROR: Traceback (most recent call last):\n  File \".../external/name/BUILD\", line 1, column 8, in <toplevel>\n    genrule(\nError in genrule: illegal rule name: : invalid target name '': empty target name\nERROR: .../external/name/BUILD: no such target '@@name//:name':\n  target 'name' not declared in package '' defined by .../external/name/BUILD\nERROR: .../BUILD:1:8: no such target '@@name//:name':\n  target 'name' not declared in package '' defined by .../external/name/BUILD\n  and referenced by '//:name'\nERROR: Analysis of target '//:name' failed; build aborted: Analysis failed\nERROR: Build did NOT complete successfully\n\n$ cat \"$(bazel info output_base)/external/name/BUILD\"\n\ngenrule(\n    name = \"\",\n    outs = [\"name.txt\"],\n    cmd = \"echo '' > \\\"$@\\\"\",\n    visibility = [\"//visibility:public\"],\n)\n```\n\n### Which operating system are you running Bazel on?\n\n\nmacOS 15.3.1 (24D70)\n\n### What is the output of `bazel info release`?\n\n\nrelease 8.1.0\n\n### If `bazel info release` returns `development version` or `(@non-git)`, tell us how you built Bazel.\n\n\n_No response_\n\n### What's the output of `git remote get-url origin; git rev-parse HEAD` ?\n\n\n```text\n\n```\n\n### If this is a regression, please try to identify the Bazel commit where the bug was introduced with bazelisk --bisect.\n\n\n8bcfb06e902c3d9b3d0839a1d9a38827f8b68672\n\n### Have you found anything relevant by searching the web?\n\n_No response_\n\n### Any other information, logs, or outputs that you want to share?\n\nAfter encountering a build breakage due to empty default target names in generated repositories, I added debug code like the following:\n\n```py\nif hasattr(rctx, \"original_name\"):\n    print(\"name: '%s' original_name: '%s'\" % (rctx.name, rctx.original_name)\n```\n\nIt printed lines like this under Bzlmod:\n\n```txt\nDEBUG: .../rules_scala/third_party/repositories/repositories.bzl:144:14:\n  name: '+scala_deps+scala_proto_rules_scalapb_protoc_bridge'\n  original_name: 'scala_proto_rules_scalapb_protoc_bridge'\n```\n\nand lines like this under `WORKSPACE`:\n\n```txt\nDEBUG: .../rules_scala/third_party/repositories/repositories.bzl:144:14:\n  name: 'scala_proto_rules_scalapb_protoc_bridge'\n  original_name: ''\n```","closed_by":{"login":"copybara-service[bot]","id":56741989,"node_id":"MDM6Qm90NTY3NDE5ODk=","avatar_url":"https://avatars.githubusercontent.com/in/44061?v=4","gravatar_id":"","url":"https://api.github.com/users/copybara-service%5Bbot%5D","html_url":"https://github.com/apps/copybara-service","followers_url":"https://api.github.com/users/copybara-service%5Bbot%5D/followers","following_url":"https://api.github.com/users/copybara-service%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/copybara-service%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/copybara-service%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/copybara-service%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/copybara-service%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/copybara-service%5Bbot%5D/repos","events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/25286/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bazelbuild/bazel/issues/25286/timeline","performed_via_github_app":null,"state_reason":"completed"}