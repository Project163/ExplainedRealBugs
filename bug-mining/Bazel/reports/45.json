{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/18632","repository_url":"https://api.github.com/repos/bazelbuild/bazel","labels_url":"https://api.github.com/repos/bazelbuild/bazel/issues/18632/labels{/name}","comments_url":"https://api.github.com/repos/bazelbuild/bazel/issues/18632/comments","events_url":"https://api.github.com/repos/bazelbuild/bazel/issues/18632/events","html_url":"https://github.com/bazelbuild/bazel/issues/18632","id":1750576141,"node_id":"I_kwDOATz7jc5oV6wN","number":18632,"title":"In src/tools/singlejar/diag.h, non-standard macro expansion causes compile errors","user":{"login":"jayconrod","id":164791,"node_id":"MDQ6VXNlcjE2NDc5MQ==","avatar_url":"https://avatars.githubusercontent.com/u/164791?v=4","gravatar_id":"","url":"https://api.github.com/users/jayconrod","html_url":"https://github.com/jayconrod","followers_url":"https://api.github.com/users/jayconrod/followers","following_url":"https://api.github.com/users/jayconrod/following{/other_user}","gists_url":"https://api.github.com/users/jayconrod/gists{/gist_id}","starred_url":"https://api.github.com/users/jayconrod/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jayconrod/subscriptions","organizations_url":"https://api.github.com/users/jayconrod/orgs","repos_url":"https://api.github.com/users/jayconrod/repos","events_url":"https://api.github.com/users/jayconrod/events{/privacy}","received_events_url":"https://api.github.com/users/jayconrod/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":106503259,"node_id":"MDU6TGFiZWwxMDY1MDMyNTk=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/type:%20bug","name":"type: bug","color":"0052cc","default":false,"description":null},{"id":192364170,"node_id":"MDU6TGFiZWwxOTIzNjQxNzA=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/P2","name":"P2","color":"e99695","default":false,"description":"We'll consider working on this in future. (Assignee optional)"},{"id":1193207358,"node_id":"MDU6TGFiZWwxMTkzMjA3MzU4","url":"https://api.github.com/repos/bazelbuild/bazel/labels/team-Remote-Exec","name":"team-Remote-Exec","color":"f1f442","default":false,"description":"Issues and PRs for the Execution (Remote) team"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2023-06-09T22:42:58Z","updated_at":"2023-06-15T04:20:14Z","closed_at":"2023-06-15T04:20:14Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description of the bug:\n\n\nI'm attempting to run some Java and C++ actions remotely using an msys2 C/C++ toolchain. I've been able to build C/C++ libraries remotely on their own, and I've been able to build Java libraries without a remote C/C++ toolchain configured. However, I get the error below when trying to do both. It looks like this is coming from an internal Bazel file.\r\n\r\n```\r\nIn file included from bazel-out/x64_windows-opt-exec-ST-8bb3108efcd4/bin/external/remote_java_tools/_virtual_includes/token_stream/src/tools/singlejar/token_stream.h:28,                 from bazel-out/x64_windows-opt-exec-ST-8bb3108efcd4/bin/external/remote_java_tools/_virtual_includes/options/src/tools/singlejar/options.h:21,\r\n                 from external/remote_java_tools/java_tools/src/tools/singlejar/options.cc:15:\r\nexternal/remote_java_tools/java_tools/src/tools/singlejar/options.cc: In member function 'virtual void Options::PostValidateOptions()':\r\nbazel-out/x64_windows-opt-exec-ST-8bb3108efcd4/bin/external/remote_java_tools/_virtual_includes/diag/src/tools/singlejar/diag.h:41:49: error: expected primary-expression before ')' token\r\n   41 |   { fprintf(stderr, prefix msg \"\\n\", __VA_ARGS__); }\r\n      |                                                 ^\r\nbazel-out/x64_windows-opt-exec-ST-8bb3108efcd4/bin/external/remote_java_tools/_virtual_includes/diag/src/tools/singlejar/diag.h:44:5: note: in expansion of macro '_diag_msg'\r\n   44 |     _diag_msg(prefix, msg, __VA_ARGS__); \\\r\n      |     ^~~~~~~~~\r\nbazel-out/x64_windows-opt-exec-ST-8bb3108efcd4/bin/external/remote_java_tools/_virtual_includes/diag/src/tools/singlejar/diag.h:50:3: note: in expansion of macro '_diag_msgx'\r\n   50 |   _diag_msgx(exit_value, \"ERROR: \", fmt, __VA_ARGS__)\r\n      |   ^~~~~~~~~~\r\nexternal/remote_java_tools/java_tools/src/tools/singlejar/options.cc:78:5: note: in expansion of macro 'diag_errx'\r\n   78 |     diag_errx(1, \"Use --output <output_jar> to specify the output file name\");\r\n      |     ^~~~~~~~~\r\n```\r\n\r\nIt looks like this is coming from [src/tools/singlejar/diag.h](https://github.com/bazelbuild/bazel/blob/master/src/tools/singlejar/diag.h).\r\n\r\nAt [options.cc:78](https://github.com/bazelbuild/bazel/blob/master/src/tools/singlejar/options.cc#L78), the macro `diag_errx` is called:\r\n\r\n```\r\ndiag_errx(1, \"Use --output <output_jar> to specify the output file name\");\r\n```\r\n\r\nBecause `__VA_ARGS__` is empty, it expands to:\r\n\r\n```\r\n{ fprintf(stderr, prefix msg \"\\n\", ); }\r\n```\r\n\r\nThe trailing comma is a syntax error. [Wikipedia has a section](https://en.wikipedia.org/wiki/Variadic_macro_in_the_C_preprocessor#Trailing_comma) on this exact problem.\r\n\r\nThis happens on Windows because this code is conditionally compiled only on Windows. The macros use something else from `<err.h>` on other platforms.\r\n\r\nThis does not happen when using an MSVC toolchain because MSVC elides the trailing comma, not complying with standards.\n\n### What's the simplest, easiest way to reproduce this bug? Please provide a minimal example if possible.\n\n\n- Configure an msys2 C/C++ toolchain for both host and remote execution.\r\n- Build Java targets remotely from a Windows host with a Windows remote executor.\r\n\r\nIf it's useful, I can put together a sample workspace that includes my toolchain configuration. That may not be useful though unless you have a remote Windows environment.\r\n\r\nI suspect you may just be able to reproduce the error by building `//src/tools/singlejar` from inside the Bazel repo with an msys2 toolchain.\n\n### Which operating system are you running Bazel on?\n\n\nWindows\n\n### What is the output of `bazel info release`?\n\n\nrelease 7.0.0-pre.20230517.4\n\n### If `bazel info release` returns `development version` or `(@non-git)`, tell us how you built Bazel.\n\n\nn/a\n\n### What's the output of `git remote get-url origin; git rev-parse master; git rev-parse HEAD` ?\n\n\n```text\nn/a\n```\n\n\n### Is this a regression? If yes, please try to identify the Bazel commit where the bug was introduced.\n\n\nn/a\n\n### Have you found anything relevant by searching the web?\n\nhttps://en.wikipedia.org/wiki/Variadic_macro_in_the_C_preprocessor\n\n### Any other information, logs, or outputs that you want to share?\n\n_No response_","closed_by":{"login":"copybara-service[bot]","id":56741989,"node_id":"MDM6Qm90NTY3NDE5ODk=","avatar_url":"https://avatars.githubusercontent.com/in/44061?v=4","gravatar_id":"","url":"https://api.github.com/users/copybara-service%5Bbot%5D","html_url":"https://github.com/apps/copybara-service","followers_url":"https://api.github.com/users/copybara-service%5Bbot%5D/followers","following_url":"https://api.github.com/users/copybara-service%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/copybara-service%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/copybara-service%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/copybara-service%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/copybara-service%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/copybara-service%5Bbot%5D/repos","events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/18632/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bazelbuild/bazel/issues/18632/timeline","performed_via_github_app":null,"state_reason":"completed"}