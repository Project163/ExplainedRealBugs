{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/22505","repository_url":"https://api.github.com/repos/bazelbuild/bazel","labels_url":"https://api.github.com/repos/bazelbuild/bazel/issues/22505/labels{/name}","comments_url":"https://api.github.com/repos/bazelbuild/bazel/issues/22505/comments","events_url":"https://api.github.com/repos/bazelbuild/bazel/issues/22505/events","html_url":"https://github.com/bazelbuild/bazel/issues/22505","id":2311288822,"node_id":"I_kwDOATz7jc6Jw3f2","number":22505,"title":"profile_finish_ts actually describes profile start timestamp","user":{"login":"timothyg-stripe","id":140534739,"node_id":"U_kgDOCGBj0w","avatar_url":"https://avatars.githubusercontent.com/u/140534739?v=4","gravatar_id":"","url":"https://api.github.com/users/timothyg-stripe","html_url":"https://github.com/timothyg-stripe","followers_url":"https://api.github.com/users/timothyg-stripe/followers","following_url":"https://api.github.com/users/timothyg-stripe/following{/other_user}","gists_url":"https://api.github.com/users/timothyg-stripe/gists{/gist_id}","starred_url":"https://api.github.com/users/timothyg-stripe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/timothyg-stripe/subscriptions","organizations_url":"https://api.github.com/users/timothyg-stripe/orgs","repos_url":"https://api.github.com/users/timothyg-stripe/repos","events_url":"https://api.github.com/users/timothyg-stripe/events{/privacy}","received_events_url":"https://api.github.com/users/timothyg-stripe/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":106503259,"node_id":"MDU6TGFiZWwxMDY1MDMyNTk=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/type:%20bug","name":"type: bug","color":"0052cc","default":false,"description":null},{"id":192364241,"node_id":"MDU6TGFiZWwxOTIzNjQyNDE=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/P3","name":"P3","color":"fbca04","default":false,"description":"We're not considering working on this, but happy to review a PR. (No assignee)"},{"id":1020660325,"node_id":"MDU6TGFiZWwxMDIwNjYwMzI1","url":"https://api.github.com/repos/bazelbuild/bazel/labels/team-Performance","name":"team-Performance","color":"f1f442","default":false,"description":"Issues for Performance teams"},{"id":2051939153,"node_id":"MDU6TGFiZWwyMDUxOTM5MTUz","url":"https://api.github.com/repos/bazelbuild/bazel/labels/help%20wanted","name":"help wanted","color":"159818","default":true,"description":"Someone outside the Bazel team could own this"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2024-05-22T19:07:16Z","updated_at":"2024-08-08T06:35:26Z","closed_at":"2024-08-08T06:35:26Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description of the bug:\n\n\n#17636 adds a new field in Bazel profiles called `profile_finish_ts`. But the name is a misnomer: it actually describes the *starting* timestamp of the profile.\n\n### Which category does this issue belong to?\n\nPerformance\n\n### What's the simplest, easiest way to reproduce this bug? Please provide a minimal example if possible.\n\n\n```\r\n$ date; bazel build --profile=test.json.gz //literally/anything; date\r\nWed May 22 19:00:08 UTC 2024\r\nStarting local Bazel server and connecting to it...\r\n...\r\nWed May 22 19:01:43 UTC 2024\r\n\r\n$ gzip -cd test.json.gz | head -1\r\n{\"otherData\":{\"bazel_version\":\"release 7.1.2\",\"build_id\":\"a8bf67d4-41dd-48af-8edf-0104076e739f\",\"output_base\":\"/pay/cache/.cache/bazel/_bazel_timothyg/59fa07eaaf81cbcc62a646fca1339445\",\"date\":\"2024-05-22T19:00:12.208166312Z\",\"profile_finish_ts\":1716404412000},\"traceEvents\":[\r\n```\r\n\r\n\n\n### Which operating system are you running Bazel on?\n\n\nLinux\n\n### What is the output of `bazel info release`?\n\n\nrelease 7.1.2\n\n### If `bazel info release` returns `development version` or `(@non-git)`, tell us how you built Bazel.\n\n\n_No response_\n\n### What's the output of `git remote get-url origin; git rev-parse HEAD` ?\n\n\n_No response_\n\n### Is this a regression? If yes, please try to identify the Bazel commit where the bug was introduced.\n\n\n_No response_\n\n### Have you found anything relevant by searching the web?\n\n#17636 says:\r\n\r\n> The name [`date`] is misleading since users could mistook it for profile start time, while it actually means the finish/end time, when Bazel calls the writer to serialize profiling data to disk.\r\n\r\nBut this is actually just wrong, at least in the current version of Bazel. The timestamp is captured near the beginning of `JsonTraceFileWriter#run`, which is called when the `JsonTraceFileWriter` thread starts running. Tracing through the code we see:\r\n```\r\nprofiler.JsonTraceFileWriter#start (starts the JsonTraceFileWriter thread)\r\nprofiler.Profiler#start\r\nruntime.BlazeRuntime#initProfiler\r\nruntime.BlazeCommandDispatcher#execExclusively\r\n```\r\n\r\nThe [position](https://cs.opensource.google/bazel/bazel/+/master:src/main/java/com/google/devtools/build/lib/runtime/BlazeCommandDispatcher.java;l=384;drc=9d9be020833f1749f65f9299c1a4557f6dfb85eb) of the call in `runtime.BlazeCommandDispatcher#execExclusively` is clearly before anything important has started.\r\n\r\nAdditionally, `profile_finish_ts` also lacks precision compared to the `date` field it's supposed to replace, being truncated to the nearest second while `date` has microsecond precision on modern Linux.\n\n### Any other information, logs, or outputs that you want to share?\n\n_No response_","closed_by":{"login":"copybara-service[bot]","id":56741989,"node_id":"MDM6Qm90NTY3NDE5ODk=","avatar_url":"https://avatars.githubusercontent.com/in/44061?v=4","gravatar_id":"","url":"https://api.github.com/users/copybara-service%5Bbot%5D","html_url":"https://github.com/apps/copybara-service","followers_url":"https://api.github.com/users/copybara-service%5Bbot%5D/followers","following_url":"https://api.github.com/users/copybara-service%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/copybara-service%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/copybara-service%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/copybara-service%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/copybara-service%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/copybara-service%5Bbot%5D/repos","events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/22505/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bazelbuild/bazel/issues/22505/timeline","performed_via_github_app":null,"state_reason":"completed"}