{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/18249","repository_url":"https://api.github.com/repos/bazelbuild/bazel","labels_url":"https://api.github.com/repos/bazelbuild/bazel/issues/18249/labels{/name}","comments_url":"https://api.github.com/repos/bazelbuild/bazel/issues/18249/comments","events_url":"https://api.github.com/repos/bazelbuild/bazel/issues/18249/events","html_url":"https://github.com/bazelbuild/bazel/issues/18249","id":1687760902,"node_id":"I_kwDOATz7jc5kmTAG","number":18249,"title":"--remote_download_toplevel does not download symlink targets of runfiles","user":{"login":"eric-skydio","id":78561997,"node_id":"MDQ6VXNlcjc4NTYxOTk3","avatar_url":"https://avatars.githubusercontent.com/u/78561997?v=4","gravatar_id":"","url":"https://api.github.com/users/eric-skydio","html_url":"https://github.com/eric-skydio","followers_url":"https://api.github.com/users/eric-skydio/followers","following_url":"https://api.github.com/users/eric-skydio/following{/other_user}","gists_url":"https://api.github.com/users/eric-skydio/gists{/gist_id}","starred_url":"https://api.github.com/users/eric-skydio/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eric-skydio/subscriptions","organizations_url":"https://api.github.com/users/eric-skydio/orgs","repos_url":"https://api.github.com/users/eric-skydio/repos","events_url":"https://api.github.com/users/eric-skydio/events{/privacy}","received_events_url":"https://api.github.com/users/eric-skydio/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":106503259,"node_id":"MDU6TGFiZWwxMDY1MDMyNTk=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/type:%20bug","name":"type: bug","color":"0052cc","default":false,"description":null},{"id":192364134,"node_id":"MDU6TGFiZWwxOTIzNjQxMzQ=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/P1","name":"P1","color":"d93f0b","default":false,"description":"I'll work on this now. (Assignee required)"},{"id":1193207358,"node_id":"MDU6TGFiZWwxMTkzMjA3MzU4","url":"https://api.github.com/repos/bazelbuild/bazel/labels/team-Remote-Exec","name":"team-Remote-Exec","color":"f1f442","default":false,"description":"Issues and PRs for the Execution (Remote) team"}],"state":"closed","locked":false,"assignee":{"login":"coeuvre","id":5947531,"node_id":"MDQ6VXNlcjU5NDc1MzE=","avatar_url":"https://avatars.githubusercontent.com/u/5947531?v=4","gravatar_id":"","url":"https://api.github.com/users/coeuvre","html_url":"https://github.com/coeuvre","followers_url":"https://api.github.com/users/coeuvre/followers","following_url":"https://api.github.com/users/coeuvre/following{/other_user}","gists_url":"https://api.github.com/users/coeuvre/gists{/gist_id}","starred_url":"https://api.github.com/users/coeuvre/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/coeuvre/subscriptions","organizations_url":"https://api.github.com/users/coeuvre/orgs","repos_url":"https://api.github.com/users/coeuvre/repos","events_url":"https://api.github.com/users/coeuvre/events{/privacy}","received_events_url":"https://api.github.com/users/coeuvre/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"coeuvre","id":5947531,"node_id":"MDQ6VXNlcjU5NDc1MzE=","avatar_url":"https://avatars.githubusercontent.com/u/5947531?v=4","gravatar_id":"","url":"https://api.github.com/users/coeuvre","html_url":"https://github.com/coeuvre","followers_url":"https://api.github.com/users/coeuvre/followers","following_url":"https://api.github.com/users/coeuvre/following{/other_user}","gists_url":"https://api.github.com/users/coeuvre/gists{/gist_id}","starred_url":"https://api.github.com/users/coeuvre/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/coeuvre/subscriptions","organizations_url":"https://api.github.com/users/coeuvre/orgs","repos_url":"https://api.github.com/users/coeuvre/repos","events_url":"https://api.github.com/users/coeuvre/events{/privacy}","received_events_url":"https://api.github.com/users/coeuvre/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":3,"created_at":"2023-04-28T01:43:34Z","updated_at":"2023-08-09T08:26:58Z","closed_at":"2023-05-17T13:29:37Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description of the bug:\n\n\n`--remote_download_toplevel` downloads the runfiles associated with any outputs explicitly listed on the command line, and (on Linux) constructs a runfiles tree of symlinks for them.\r\nUnfortunately, if the runfiles is constructed with `symlinks=` or `root_symlinks=` that refer to File objects _not_ in the `files=` depset of the runfiles, this process fails and the target of the symlink is not downloaded, which results in a broken symlink in the resulting runfiles tree.\r\n\r\nThis is important for us because we use root_symlinks to relocate files to keep our PYTHONPATH smaller. This works file when not using --remote_download_toplevel.\n\n### What's the simplest, easiest way to reproduce this bug? Please provide a minimal example if possible.\n\n\n`rules.bzl`\r\n```starlark\r\ndef _symlink_rule_impl(ctx):\r\n    file = ctx.actions.declare_file(\"file.txt\")\r\n    executable = ctx.actions.declare_file(\"executable\")\r\n\r\n    ctx.actions.run_shell(\r\n        outputs = [file],\r\n        command = \"echo 'Hello World!' > \" + file.path,\r\n    )\r\n    ctx.actions.write(executable, \"cat symlink.txt\")\r\n    return [DefaultInfo(\r\n        runfiles = ctx.runfiles(\r\n            symlinks = {\"symlink.txt\": file},\r\n        ),\r\n        executable = executable,\r\n    )]\r\n\r\nsymlink_rule = rule(\r\n    implementation = _symlink_rule_impl,\r\n    executable = True,\r\n    attrs = {},\r\n)\r\n```\r\n\r\n\r\n`BUILD`\r\n```starlark\r\nload(\":rules.bzl\", \"symlink_rule\")\r\n\r\nsymlink_rule(name = \"symlink\")\r\n```\r\n\r\nReproduction steps:\r\n1. `bazel run //:symlink --remote_download_toplevel --disk_cache /tmp/cache`\r\n2. `bazel clean`\r\n3. `bazel run //:symlink --remote_download_toplevel --disk_cache /tmp/cache`\n\n### Which operating system are you running Bazel on?\n\n\nUbuntu 18.04\n\n### What is the output of `bazel info release`?\n\n\nrelease 6.1.2\n\n### If `bazel info release` returns `development version` or `(@non-git)`, tell us how you built Bazel.\n\n\n_No response_\n\n### What's the output of `git remote get-url origin; git rev-parse master; git rev-parse HEAD` ?\n\n\n_No response_\n\n### Have you found anything relevant by searching the web?\n\n_No response_\n\n### Any other information, logs, or outputs that you want to share?\n\nThis seems to reproduce both on Bazel 5.x and the latest 7.0.0-pre*","closed_by":{"login":"copybara-service[bot]","id":56741989,"node_id":"MDM6Qm90NTY3NDE5ODk=","avatar_url":"https://avatars.githubusercontent.com/in/44061?v=4","gravatar_id":"","url":"https://api.github.com/users/copybara-service%5Bbot%5D","html_url":"https://github.com/apps/copybara-service","followers_url":"https://api.github.com/users/copybara-service%5Bbot%5D/followers","following_url":"https://api.github.com/users/copybara-service%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/copybara-service%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/copybara-service%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/copybara-service%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/copybara-service%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/copybara-service%5Bbot%5D/repos","events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/18249/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bazelbuild/bazel/issues/18249/timeline","performed_via_github_app":null,"state_reason":"completed"}