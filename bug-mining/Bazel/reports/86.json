{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/19949","repository_url":"https://api.github.com/repos/bazelbuild/bazel","labels_url":"https://api.github.com/repos/bazelbuild/bazel/issues/19949/labels{/name}","comments_url":"https://api.github.com/repos/bazelbuild/bazel/issues/19949/comments","events_url":"https://api.github.com/repos/bazelbuild/bazel/issues/19949/events","html_url":"https://github.com/bazelbuild/bazel/issues/19949","id":1962072222,"node_id":"I_kwDOATz7jc508tie","number":19949,"title":"JUnit test XML does not include failures in non-declared test ","user":{"login":"timothyg-stripe","id":140534739,"node_id":"U_kgDOCGBj0w","avatar_url":"https://avatars.githubusercontent.com/u/140534739?v=4","gravatar_id":"","url":"https://api.github.com/users/timothyg-stripe","html_url":"https://github.com/timothyg-stripe","followers_url":"https://api.github.com/users/timothyg-stripe/followers","following_url":"https://api.github.com/users/timothyg-stripe/following{/other_user}","gists_url":"https://api.github.com/users/timothyg-stripe/gists{/gist_id}","starred_url":"https://api.github.com/users/timothyg-stripe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/timothyg-stripe/subscriptions","organizations_url":"https://api.github.com/users/timothyg-stripe/orgs","repos_url":"https://api.github.com/users/timothyg-stripe/repos","events_url":"https://api.github.com/users/timothyg-stripe/events{/privacy}","received_events_url":"https://api.github.com/users/timothyg-stripe/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":106503259,"node_id":"MDU6TGFiZWwxMDY1MDMyNTk=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/type:%20bug","name":"type: bug","color":"0052cc","default":false,"description":null},{"id":192364134,"node_id":"MDU6TGFiZWwxOTIzNjQxMzQ=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/P1","name":"P1","color":"d93f0b","default":false,"description":"I'll work on this now. (Assignee required)"},{"id":1020663976,"node_id":"MDU6TGFiZWwxMDIwNjYzOTc2","url":"https://api.github.com/repos/bazelbuild/bazel/labels/team-Rules-Java","name":"team-Rules-Java","color":"f1f442","default":false,"description":"Issues for Java rules"}],"state":"closed","locked":false,"assignee":{"login":"hvadehra","id":2486163,"node_id":"MDQ6VXNlcjI0ODYxNjM=","avatar_url":"https://avatars.githubusercontent.com/u/2486163?v=4","gravatar_id":"","url":"https://api.github.com/users/hvadehra","html_url":"https://github.com/hvadehra","followers_url":"https://api.github.com/users/hvadehra/followers","following_url":"https://api.github.com/users/hvadehra/following{/other_user}","gists_url":"https://api.github.com/users/hvadehra/gists{/gist_id}","starred_url":"https://api.github.com/users/hvadehra/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hvadehra/subscriptions","organizations_url":"https://api.github.com/users/hvadehra/orgs","repos_url":"https://api.github.com/users/hvadehra/repos","events_url":"https://api.github.com/users/hvadehra/events{/privacy}","received_events_url":"https://api.github.com/users/hvadehra/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"hvadehra","id":2486163,"node_id":"MDQ6VXNlcjI0ODYxNjM=","avatar_url":"https://avatars.githubusercontent.com/u/2486163?v=4","gravatar_id":"","url":"https://api.github.com/users/hvadehra","html_url":"https://github.com/hvadehra","followers_url":"https://api.github.com/users/hvadehra/followers","following_url":"https://api.github.com/users/hvadehra/following{/other_user}","gists_url":"https://api.github.com/users/hvadehra/gists{/gist_id}","starred_url":"https://api.github.com/users/hvadehra/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hvadehra/subscriptions","organizations_url":"https://api.github.com/users/hvadehra/orgs","repos_url":"https://api.github.com/users/hvadehra/repos","events_url":"https://api.github.com/users/hvadehra/events{/privacy}","received_events_url":"https://api.github.com/users/hvadehra/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":0,"created_at":"2023-10-25T19:20:24Z","updated_at":"2023-10-31T18:54:01Z","closed_at":"2023-10-31T18:54:01Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description of the bug:\n\n\nJUnit 4 runners like Mockito often fires test failures after a test has been done, as in [here](https://github.com/mockito/mockito/blob/a8adbf5027bfc295b002e5d87120e7c0d1229f96/src/main/java/org/mockito/internal/runners/StrictRunner.java#L47) and [here](https://github.com/mockito/mockito/blob/a8adbf5027bfc295b002e5d87120e7c0d1229f96/src/main/java/org/mockito/internal/junit/UnnecessaryStubbingsReporter.java#L36). Unfortunately, since the test description is dynamically created, in Bazel's JUnit test runner [`getTest(description)`](https://cs.opensource.google/bazel/bazel/+/master:src/java_tools/junitrunner/java/com/google/testing/junit/runner/model/TestSuiteModel.java;l=177;drc=6c02329b1e1c549e916d5b2c77b60fbdd89a5b59) would return null. So the test failure is ignored and omitted from the JUnit XML file.\r\n\r\nIdeally, Bazel's JUnit test runner should synthesize a test failure node, even for test cases that are not predeclared.\r\n\r\nAs an example, here's a sample test from our repository that uses `MockitoJUnitRunner`:\r\n\r\n```java\r\npackage com.stripe;\r\n\r\nimport org.junit.runner.RunWith;\r\nimport org.mockito.junit.MockitoJUnitRunner;\r\n\r\n@RunWith(MockitoJUnitRunner.class)\r\npublic class BlahTest { ... }\r\n```\r\n\r\nHere's the form of the generated XML file:\r\n```xml\r\n<?xml version='1.0' encoding='UTF-8'?>\r\n<testsuites>\r\n  <testsuite name='com.stripe.BlahTest' timestamp='...' hostname='localhost' tests='10' failures='0' errors='0' time='6.662' package='' id='0'>\r\n    <properties />\r\n    <testcase name='test_...' classname='com.stripe.BlahTest' time='6.12' />\r\n    ...\r\n    <system-out />\r\n    <system-err /></testsuite></testsuites>\r\n```\r\nNotice that `failures` and `errors` are both 0.\r\n\r\nHowever, the test log shows one failure:\r\n```\r\nexec ${PAGER:-/usr/bin/less} \"$0\" || exit 1\r\nExecuting tests from //src/test/java/com/stripe:BlahTest\r\n-----------------------------------------------------------------------------\r\nJUnit4 Test Runner\r\n.OpenJDK 64-Bit Server VM warning: Sharing is only supported for boot loader classes because bootstrap classpath has been appended\r\n\r\n... logs redacted ...\r\n\r\nE\r\nTime: 6.793\r\nThere was 1 failure:\r\n1) unnecessary Mockito stubbings(com.stripe.BlahTest)\r\norg.mockito.exceptions.misusing.UnnecessaryStubbingException: \r\nUnnecessary stubbings detected in test class: BlahTest\r\nClean & maintainable test code requires zero unnecessary code.\r\nFollowing stubbings are unnecessary (click to navigate to relevant line of code):\r\n  1. -> at com.stripe.BlahTest.java:81)\r\nPlease remove unnecessary stubbings or use 'lenient' strictness. More info: javadoc for UnnecessaryStubbingException class.\r\n\tat org.mockito.internal.runners.StrictRunner.run(StrictRunner.java:52)\r\n\tat org.mockito.junit.MockitoJUnitRunner.run(MockitoJUnitRunner.java:163)\r\n\tat com.google.testing.junit.runner.internal.junit4.CancellableRequestFactory$CancellableRunner.run(CancellableRequestFactory.java:108)\r\n\tat org.junit.runner.JUnitCore.run(JUnitCore.java:137)\r\n\tat org.junit.runner.JUnitCore.run(JUnitCore.java:115)\r\n\tat com.google.testing.junit.runner.junit4.JUnit4Runner.run(JUnit4Runner.java:116)\r\n\tat com.google.testing.junit.runner.BazelTestRunner.runTestsInSuite(BazelTestRunner.java:145)\r\n\tat com.google.testing.junit.runner.BazelTestRunner.main(BazelTestRunner.java:76)\r\n\r\nFAILURES!!!\r\nTests run: 10,  Failures: 1\r\n\r\n\r\nBazelTestRunner exiting with a return value of 1\r\nJVM shutdown hooks (if any) will run now.\r\nThe JVM will exit once they complete.\r\n\r\n-- JVM shutdown starting at ... --\r\n\r\n```\n\n### Which category does this issue belong to?\n\n\nJava Rules\n\n### What's the simplest, easiest way to reproduce this bug? Please provide a minimal example if possible.\n\n\nSee above for a sample test case. Unfortunately, I don't have a reproducible test case at hand.\n\n### Which operating system are you running Bazel on?\n\n\nmacOS\n\n### What is the output of `bazel info release`?\n\n\nrelease 6.3.2\n\n### If `bazel info release` returns `development version` or `(@non-git)`, tell us how you built Bazel.\n\n\n_No response_\n\n### What's the output of `git remote get-url origin; git rev-parse master; git rev-parse HEAD` ?\n\n\n_No response_\n\n### Is this a regression? If yes, please try to identify the Bazel commit where the bug was introduced.\n\n\n_No response_\n\n### Have you found anything relevant by searching the web?\n\n_No response_\n\n### Any other information, logs, or outputs that you want to share?\n\n_No response_","closed_by":{"login":"copybara-service[bot]","id":56741989,"node_id":"MDM6Qm90NTY3NDE5ODk=","avatar_url":"https://avatars.githubusercontent.com/in/44061?v=4","gravatar_id":"","url":"https://api.github.com/users/copybara-service%5Bbot%5D","html_url":"https://github.com/apps/copybara-service","followers_url":"https://api.github.com/users/copybara-service%5Bbot%5D/followers","following_url":"https://api.github.com/users/copybara-service%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/copybara-service%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/copybara-service%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/copybara-service%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/copybara-service%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/copybara-service%5Bbot%5D/repos","events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/19949/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bazelbuild/bazel/issues/19949/timeline","performed_via_github_app":null,"state_reason":"completed"}