{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/24619","repository_url":"https://api.github.com/repos/bazelbuild/bazel","labels_url":"https://api.github.com/repos/bazelbuild/bazel/issues/24619/labels{/name}","comments_url":"https://api.github.com/repos/bazelbuild/bazel/issues/24619/comments","events_url":"https://api.github.com/repos/bazelbuild/bazel/issues/24619/events","html_url":"https://github.com/bazelbuild/bazel/issues/24619","id":2730419652,"node_id":"I_kwDOATz7jc6ivuXE","number":24619,"title":"Multiple aspects running py_binary based tools errors in Bazel 8","user":{"login":"mark-thm","id":123787712,"node_id":"U_kgDOB2DZwA","avatar_url":"https://avatars.githubusercontent.com/u/123787712?v=4","gravatar_id":"","url":"https://api.github.com/users/mark-thm","html_url":"https://github.com/mark-thm","followers_url":"https://api.github.com/users/mark-thm/followers","following_url":"https://api.github.com/users/mark-thm/following{/other_user}","gists_url":"https://api.github.com/users/mark-thm/gists{/gist_id}","starred_url":"https://api.github.com/users/mark-thm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mark-thm/subscriptions","organizations_url":"https://api.github.com/users/mark-thm/orgs","repos_url":"https://api.github.com/users/mark-thm/repos","events_url":"https://api.github.com/users/mark-thm/events{/privacy}","received_events_url":"https://api.github.com/users/mark-thm/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":106503259,"node_id":"MDU6TGFiZWwxMDY1MDMyNTk=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/type:%20bug","name":"type: bug","color":"0052cc","default":false,"description":null},{"id":1193206953,"node_id":"MDU6TGFiZWwxMTkzMjA2OTUz","url":"https://api.github.com/repos/bazelbuild/bazel/labels/team-Local-Exec","name":"team-Local-Exec","color":"f1f442","default":false,"description":"Issues and PRs for the Execution (Local) team"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":14,"created_at":"2024-12-10T15:15:36Z","updated_at":"2025-01-16T07:09:19Z","closed_at":"2024-12-18T10:11:23Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description of the bug:\r\n\r\n\r\nUpon upgrading to Bazel 8.0.0, I started encountering an issue where two (or more) aspects that run a rules_python 1.0.0 py_binary as the executable are missing files. I see errors in the Python launcher script where the runfiles symlinks ultimately resolve to paths that do not, in fact, exist. The runfiles symlinks appear in the correct locations in the runfiles tree and are complete, but the locations the links point to are missing all but one of the aspect's underlying files.\r\n\r\n<details>\r\n<summary>More details/error messages:</summary>\r\n\r\nWhen running a build I see errors like this:\r\n```\r\nERROR: /private/var/tmp/_bazel_melliot/ec7f0e67bfc3fe3a9bd546beff97b5c5/external/rules_pydeps++reqs+reqs/BUILD.bazel:7:15: Action external/rules_pydeps++reqs+reqs/pip_deps_index failed: (Exit 1): index failed: error executing Action command (from target @@rules_pydeps++reqs+reqs//:pip_deps_index) bazel-out/darwin_arm64-opt-exec-ST-c6280171b4e4/bin/external/rules_pydeps+/pydeps/private/index/index ... (remaining 1 argument skipped)\r\n\r\nUse --sandbox_debug to see verbose messages from the sandbox and retain the sandbox build root for debugging\r\nTraceback (most recent call last):\r\n  File \"/private/var/tmp/_bazel_melliot/ec7f0e67bfc3fe3a9bd546beff97b5c5/sandbox/darwin-sandbox/2/execroot/_main/bazel-out/darwin_arm64-opt-exec-ST-c6280171b4e4/bin/external/rules_pydeps+/pydeps/private/index/index\", line 580, in <module>\r\n    Main()\r\n  File \"/private/var/tmp/_bazel_melliot/ec7f0e67bfc3fe3a9bd546beff97b5c5/sandbox/darwin-sandbox/2/execroot/_main/bazel-out/darwin_arm64-opt-exec-ST-c6280171b4e4/bin/external/rules_pydeps+/pydeps/private/index/index\", line 504, in Main\r\n    assert os.path.exists(main_filename), \\\r\nAssertionError: Cannot exec() '/private/var/tmp/_bazel_melliot/ec7f0e67bfc3fe3a9bd546beff97b5c5/sandbox/darwin-sandbox/2/execroot/_main/bazel-out/darwin_arm64-opt-exec-ST-c6280171b4e4/bin/external/rules_pydeps+/pydeps/private/index/index.runfiles/_main/../rules_pydeps+/pydeps/private/index/index.py': file not found.\r\n```\r\n\r\nIf I run with --sandbox_debug, and I inspect the sandbox, what I find is that the runfiles tree for index.runfiles looks like it should have the files:\r\n\r\n```\r\n❯ tree /private/var/tmp/_bazel_melliot/ec7f0e67bfc3fe3a9bd546beff97b5c5/sandbox/darwin-sandbox/6/execroot/_main/bazel-out/darwin_arm64-opt-exec-ST-c6280171b4e4/bin/external/rules_pydeps+/pydeps/private/index/index.runfiles/_main/../rules_pydeps+/pydeps/\r\n/private/var/tmp/_bazel_melliot/ec7f0e67bfc3fe3a9bd546beff97b5c5/sandbox/darwin-sandbox/6/execroot/_main/bazel-out/darwin_arm64-opt-exec-ST-c6280171b4e4/bin/external/rules_pydeps+/pydeps/private/index/index.runfiles/_main/../rules_pydeps+/pydeps/\r\n├── __init__.py\r\n└── private\r\n    ├── __init__.py\r\n    ├── index\r\n    │   ├── __init__.py -> /private/var/tmp/_bazel_melliot/ec7f0e67bfc3fe3a9bd546beff97b5c5/execroot/_main/external/rules_pydeps+/pydeps/private/index/__init__.py\r\n    │   ├── _index -> /private/var/tmp/_bazel_melliot/ec7f0e67bfc3fe3a9bd546beff97b5c5/execroot/_main/bazel-out/darwin_arm64-opt-exec-ST-c6280171b4e4/bin/external/rules_pydeps+/pydeps/private/index/_index\r\n    │   ├── index -> /private/var/tmp/_bazel_melliot/ec7f0e67bfc3fe3a9bd546beff97b5c5/execroot/_main/bazel-out/darwin_arm64-opt-exec-ST-c6280171b4e4/bin/external/rules_pydeps+/pydeps/private/index/index\r\n    │   └── index.py -> /private/var/tmp/_bazel_melliot/ec7f0e67bfc3fe3a9bd546beff97b5c5/execroot/_main/external/rules_pydeps+/pydeps/private/index/index.py\r\n    └── py\r\n        ├── __init__.py -> /private/var/tmp/_bazel_melliot/ec7f0e67bfc3fe3a9bd546beff97b5c5/execroot/_main/external/rules_pydeps+/pydeps/private/py/__init__.py\r\n        ├── python_module.py -> /private/var/tmp/_bazel_melliot/ec7f0e67bfc3fe3a9bd546beff97b5c5/execroot/_main/external/rules_pydeps+/pydeps/private/py/python_module.py\r\n        ├── python_source.py -> /private/var/tmp/_bazel_melliot/ec7f0e67bfc3fe3a9bd546beff97b5c5/execroot/_main/external/rules_pydeps+/pydeps/private/py/python_source.py\r\n        └── source_files.py -> /private/var/tmp/_bazel_melliot/ec7f0e67bfc3fe3a9bd546beff97b5c5/execroot/_main/external/rules_pydeps+/pydeps/private/py/source_files.py\r\n\r\n4 directories, 10 files\r\n```\r\n\r\nBut when I inspect the execroot directories where the symlinks point, there is no `rules_pydeps+` directory:\r\n\r\n```\r\n❯ tree -L 1 /private/var/tmp/_bazel_melliot/ec7f0e67bfc3fe3a9bd546beff97b5c5/execroot/_main/external/\r\n/private/var/tmp/_bazel_melliot/ec7f0e67bfc3fe3a9bd546beff97b5c5/execroot/_main/external/\r\n├── bazel_tools -> /private/var/tmp/_bazel_melliot/ec7f0e67bfc3fe3a9bd546beff97b5c5/external/bazel_tools\r\n├── bazel_tools+xcode_configure_extension+local_config_xcode -> /private/var/tmp/_bazel_melliot/ec7f0e67bfc3fe3a9bd546beff97b5c5/external/bazel_tools+xcode_configure_extension+local_config_xcode\r\n├── platforms -> /private/var/tmp/_bazel_melliot/ec7f0e67bfc3fe3a9bd546beff97b5c5/external/platforms\r\n├── rules_cc+ -> /private/var/tmp/_bazel_melliot/ec7f0e67bfc3fe3a9bd546beff97b5c5/external/rules_cc+\r\n├── rules_cc++cc_configure_extension+local_config_cc -> /private/var/tmp/_bazel_melliot/ec7f0e67bfc3fe3a9bd546beff97b5c5/external/rules_cc++cc_configure_extension+local_config_cc\r\n├── rules_multitool++multitool+multitool -> /private/var/tmp/_bazel_melliot/ec7f0e67bfc3fe3a9bd546beff97b5c5/external/rules_multitool++multitool+multitool\r\n├── rules_multitool++multitool+multitool.macos_arm64 -> /private/var/tmp/_bazel_melliot/ec7f0e67bfc3fe3a9bd546beff97b5c5/external/rules_multitool++multitool+multitool.macos_arm64\r\n├── rules_mypy+ -> /private/var/tmp/_bazel_melliot/ec7f0e67bfc3fe3a9bd546beff97b5c5/external/rules_mypy+\r\n├── rules_python+ -> /private/var/tmp/_bazel_melliot/ec7f0e67bfc3fe3a9bd546beff97b5c5/external/rules_python+\r\n├── rules_python++pip+pypi -> /private/var/tmp/_bazel_melliot/ec7f0e67bfc3fe3a9bd546beff97b5c5/external/rules_python++pip+pypi\r\n├── rules_python++pip+pypi_312_click_py3_none_any_ae74fb96 -> /private/var/tmp/_bazel_melliot/ec7f0e67bfc3fe3a9bd546beff97b5c5/external/rules_python++pip+pypi_312_click_py3_none_any_ae74fb96\r\n├── rules_python++pip+rules_mypy_pip -> /private/var/tmp/_bazel_melliot/ec7f0e67bfc3fe3a9bd546beff97b5c5/external/rules_python++pip+rules_mypy_pip\r\n├── rules_python++pip+rules_mypy_pip_312_mypy_cp312_cp312_macosx_11_0_arm64_39bb21c6 -> /private/var/tmp/_bazel_melliot/ec7f0e67bfc3fe3a9bd546beff97b5c5/external/rules_python++pip+rules_mypy_pip_312_mypy_cp312_cp312_macosx_11_0_arm64_39bb21c6\r\n├── rules_python++pip+rules_mypy_pip_312_mypy_extensions_py3_none_any_4392f6c0 -> /private/var/tmp/_bazel_melliot/ec7f0e67bfc3fe3a9bd546beff97b5c5/external/rules_python++pip+rules_mypy_pip_312_mypy_extensions_py3_none_any_4392f6c0\r\n├── rules_python++pip+rules_mypy_pip_312_typing_extensions_py3_none_any_04e5ca03 -> /private/var/tmp/_bazel_melliot/ec7f0e67bfc3fe3a9bd546beff97b5c5/external/rules_python++pip+rules_mypy_pip_312_typing_extensions_py3_none_any_04e5ca03\r\n├── rules_python++python+python_3_12_aarch64-apple-darwin -> /private/var/tmp/_bazel_melliot/ec7f0e67bfc3fe3a9bd546beff97b5c5/external/rules_python++python+python_3_12_aarch64-apple-darwin\r\n└── rules_uv+ -> /private/var/tmp/_bazel_melliot/ec7f0e67bfc3fe3a9bd546beff97b5c5/external/rules_uv+\r\n```\r\n\r\nIt does looks like `/private/var/tmp/_bazel_melliot/ec7f0e67bfc3fe3a9bd546beff97b5c5/external/rules_pydeps+`, so the process that constructs execroot seems to be missing a relevant link for some reason.\r\n</details>\r\n\r\n### Which category does this issue belong to?\r\n\r\nLocal Execution\r\n\r\n### What's the simplest, easiest way to reproduce this bug? Please provide a minimal example if possible.\r\n\r\n\r\nA small but perhaps not minimal repro here: https://github.com/theoremlp/bazel8_problem_repro\r\n\r\nChanging .bazelversion to 7.4.1 and running `bazel build ...` succeeds. Running `bazel build ...` at version 8.0.0 fails with symlink problems as described above.\r\n\r\n### Which operating system are you running Bazel on?\r\n\r\n\r\nMacOS, Ubuntu\r\n\r\n### What is the output of `bazel info release`?\r\n\r\n\r\nrelease 8.0.0\r\n\r\n### If `bazel info release` returns `development version` or `(@non-git)`, tell us how you built Bazel.\r\n\r\n\r\n_No response_\r\n\r\n### What's the output of `git remote get-url origin; git rev-parse HEAD` ?\r\n\r\n\r\n_No response_\r\n\r\n### If this is a regression, please try to identify the Bazel commit where the bug was introduced with bazelisk --bisect.\r\n\r\n(see comment below, the initial bisect did not correctly identify the first bad commit)\r\n\r\n### Have you found anything relevant by searching the web?\r\n\r\nUnfortunately no.\r\n\r\n### Any other information, logs, or outputs that you want to share?\r\n\r\n_No response_","closed_by":{"login":"copybara-service[bot]","id":56741989,"node_id":"MDM6Qm90NTY3NDE5ODk=","avatar_url":"https://avatars.githubusercontent.com/in/44061?v=4","gravatar_id":"","url":"https://api.github.com/users/copybara-service%5Bbot%5D","html_url":"https://github.com/apps/copybara-service","followers_url":"https://api.github.com/users/copybara-service%5Bbot%5D/followers","following_url":"https://api.github.com/users/copybara-service%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/copybara-service%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/copybara-service%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/copybara-service%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/copybara-service%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/copybara-service%5Bbot%5D/repos","events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/24619/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bazelbuild/bazel/issues/24619/timeline","performed_via_github_app":null,"state_reason":"completed"}