{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/19055","repository_url":"https://api.github.com/repos/bazelbuild/bazel","labels_url":"https://api.github.com/repos/bazelbuild/bazel/issues/19055/labels{/name}","comments_url":"https://api.github.com/repos/bazelbuild/bazel/issues/19055/comments","events_url":"https://api.github.com/repos/bazelbuild/bazel/issues/19055/events","html_url":"https://github.com/bazelbuild/bazel/issues/19055","id":1820345914,"node_id":"I_kwDOATz7jc5sgEY6","number":19055,"title":"Provide module extensions with a way to reference extension repos","user":{"login":"fmeum","id":4312191,"node_id":"MDQ6VXNlcjQzMTIxOTE=","avatar_url":"https://avatars.githubusercontent.com/u/4312191?v=4","gravatar_id":"","url":"https://api.github.com/users/fmeum","html_url":"https://github.com/fmeum","followers_url":"https://api.github.com/users/fmeum/followers","following_url":"https://api.github.com/users/fmeum/following{/other_user}","gists_url":"https://api.github.com/users/fmeum/gists{/gist_id}","starred_url":"https://api.github.com/users/fmeum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fmeum/subscriptions","organizations_url":"https://api.github.com/users/fmeum/orgs","repos_url":"https://api.github.com/users/fmeum/repos","events_url":"https://api.github.com/users/fmeum/events{/privacy}","received_events_url":"https://api.github.com/users/fmeum/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":106503261,"node_id":"MDU6TGFiZWwxMDY1MDMyNjE=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/type:%20feature%20request","name":"type: feature request","color":"0052cc","default":false,"description":null},{"id":192364134,"node_id":"MDU6TGFiZWwxOTIzNjQxMzQ=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/P1","name":"P1","color":"d93f0b","default":false,"description":"I'll work on this now. (Assignee required)"},{"id":1020663381,"node_id":"MDU6TGFiZWwxMDIwNjYzMzgx","url":"https://api.github.com/repos/bazelbuild/bazel/labels/team-ExternalDeps","name":"team-ExternalDeps","color":"f1f442","default":false,"description":"External dependency handling, remote repositiories, WORKSPACE file."},{"id":3718884690,"node_id":"LA_kwDOATz7jc7dqa1S","url":"https://api.github.com/repos/bazelbuild/bazel/labels/area-Bzlmod","name":"area-Bzlmod","color":"a4fc20","default":false,"description":"Bzlmod-specific PRs, issues, and feature requests"}],"state":"closed","locked":false,"assignee":{"login":"fmeum","id":4312191,"node_id":"MDQ6VXNlcjQzMTIxOTE=","avatar_url":"https://avatars.githubusercontent.com/u/4312191?v=4","gravatar_id":"","url":"https://api.github.com/users/fmeum","html_url":"https://github.com/fmeum","followers_url":"https://api.github.com/users/fmeum/followers","following_url":"https://api.github.com/users/fmeum/following{/other_user}","gists_url":"https://api.github.com/users/fmeum/gists{/gist_id}","starred_url":"https://api.github.com/users/fmeum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fmeum/subscriptions","organizations_url":"https://api.github.com/users/fmeum/orgs","repos_url":"https://api.github.com/users/fmeum/repos","events_url":"https://api.github.com/users/fmeum/events{/privacy}","received_events_url":"https://api.github.com/users/fmeum/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"fmeum","id":4312191,"node_id":"MDQ6VXNlcjQzMTIxOTE=","avatar_url":"https://avatars.githubusercontent.com/u/4312191?v=4","gravatar_id":"","url":"https://api.github.com/users/fmeum","html_url":"https://github.com/fmeum","followers_url":"https://api.github.com/users/fmeum/followers","following_url":"https://api.github.com/users/fmeum/following{/other_user}","gists_url":"https://api.github.com/users/fmeum/gists{/gist_id}","starred_url":"https://api.github.com/users/fmeum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fmeum/subscriptions","organizations_url":"https://api.github.com/users/fmeum/orgs","repos_url":"https://api.github.com/users/fmeum/repos","events_url":"https://api.github.com/users/fmeum/events{/privacy}","received_events_url":"https://api.github.com/users/fmeum/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":16,"created_at":"2023-07-25T13:28:16Z","updated_at":"2024-10-11T21:10:34Z","closed_at":"2024-08-23T19:56:18Z","author_association":"COLLABORATOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"\r\n### What underlying problem are you trying to solve with this feature?\r\n\r\nThe repository mapping that applies to a module extension does not include the repositories it generates. This makes it very tricky to pass a reference to some file in such a repo to another repo rule instantiated by the same extension, e.g.:\r\n\r\n```starlark\r\ndef _ext_impl(module_ctx):\r\n    my_lang_toolchain_repo(\r\n        name = \"lang_sdk\",\r\n    )\r\n    my_toolchain_repo(\r\n        name = \"lang_toolchain\",\r\n        # This does *not* work as `lang_sdk` is not in the current file's repo mapping.\r\n        sdk_root = \"@lang_sdk//:root\",\r\n    )\r\n```\r\n\r\nThis is a very common pattern, but requires major hacks to pull of without additional API: \r\n1. Observe that the canonical name of an extension repo is `<common prefix>~<apparent name>` and rely on that implementation detail to construct the canonical name of `lang_sdk` in `lang_toolchain` as `ctx.attr.name.removesuffix(\"lang_toolchain\") + \"lang_sdk\"`. \r\n2. Make use of the fact that `lang_sdk` is in the repo mapping of the repositories generated by the extension. By making `sdk_root` an `attr.string` instead of an `attr.label` and generating a `.bzl` file in some other (\"hub\") repo in the the same extension that calls `Label` on a label string, `lang_toolchain` can pass that literal through the correct repo mapping. This requires the module to `use_repo` the hub repo and is overall pretty complex.\r\n\r\n\r\n### Description of the feature request:\r\n\r\n\r\nProvide a function on `module_ctx` that converts the name of a repository generated by the extension and a repo-relative label into an instance of `Label` referencing the intended target.\r\n\r\nThis could look as follows:\r\n\r\n```starlark\r\n# In rules_foo v1.2.3, extensions.bzl\r\ndef _ext_impl(module_ctx):\r\n    repo(name = \"foo\", ...)\r\n    repo(name = \"bar\", ...)\r\n\r\n    # Returns `Label(\"@rules_foo~1.2.3~ext~foo//dir:name\")`\r\n    module_ctx.extension_repo_label(\"@foo//dir:name\")\r\n    # Returns `Label(\"@rules_foo~1.2.3~ext~bar//:name\")`\r\n    module_ctx.extension_repo_label(\"@bar//:name\")\r\n\r\n    # Fails immediately, argument has to be absolute\r\n    module_ctx.extension_repo_label(\"//:name\")\r\n    # Fails immediately, label must not be canonical\r\n    module_ctx.extension_repo_label(\"@@rules_foo~1.2.3~ext~foo//dir:name\")\r\n    # Fails immediately, repo name must be a valid \"user-specified\" name\r\n    module_ctx.extension_repo_label(\"@rules_foo~1.2.3~ext~foo//dir:name\")\r\n    # Fails after the module extension returns as `not_foo` is not generated by the extension.\r\n    module_ctx.extension_repo_label(\"@not_foo//dir:name\")\r\n```\r\n\r\nAlternative ideas for names: \r\n* `label_in_repo`\r\n\r\nAlternative signatures: \r\n* Separate arguments for apparent repository name and repo-relative label.\r\n\r\nAlternative approaches:\r\n* Hook into the repo rule creation and defer the conversion of label strings into `Label` instances until after the module extension has fully evaluated, at which point the names of all the repos it generates are known. Then use this information to convert label strings implicitly. This has the advantage that the \"obvious\" approach just works and the downside that its implementation is probably more involved.\r\n\r\n### Which operating system are you running Bazel on?\r\n\r\n\r\nN/A\r\n\r\n### What is the output of `bazel info release`?\r\n\r\n\r\n6.3.0\r\n\r\n### If `bazel info release` returns `development version` or `(@non-git)`, tell us how you built Bazel.\r\n\r\n\r\n_No response_\r\n\r\n### What's the output of `git remote get-url origin; git rev-parse master; git rev-parse HEAD` ?\r\n\r\n\r\n_No response_\r\n\r\n### Have you found anything relevant by searching the web?\r\n\r\n_No response_\r\n\r\n### Any other information, logs, or outputs that you want to share?\r\n\r\n_No response_","closed_by":{"login":"copybara-service[bot]","id":56741989,"node_id":"MDM6Qm90NTY3NDE5ODk=","avatar_url":"https://avatars.githubusercontent.com/in/44061?v=4","gravatar_id":"","url":"https://api.github.com/users/copybara-service%5Bbot%5D","html_url":"https://github.com/apps/copybara-service","followers_url":"https://api.github.com/users/copybara-service%5Bbot%5D/followers","following_url":"https://api.github.com/users/copybara-service%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/copybara-service%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/copybara-service%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/copybara-service%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/copybara-service%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/copybara-service%5Bbot%5D/repos","events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/19055/reactions","total_count":3,"+1":3,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bazelbuild/bazel/issues/19055/timeline","performed_via_github_app":null,"state_reason":"completed"}