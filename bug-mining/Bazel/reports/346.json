{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/26312","repository_url":"https://api.github.com/repos/bazelbuild/bazel","labels_url":"https://api.github.com/repos/bazelbuild/bazel/issues/26312/labels{/name}","comments_url":"https://api.github.com/repos/bazelbuild/bazel/issues/26312/comments","events_url":"https://api.github.com/repos/bazelbuild/bazel/issues/26312/events","html_url":"https://github.com/bazelbuild/bazel/issues/26312","id":3149798505,"node_id":"I_kwDOATz7jc67vhxp","number":26312,"title":"Cquery and rdeps regularly results in an NPE","user":{"login":"C0mbatwombat","id":80639856,"node_id":"MDQ6VXNlcjgwNjM5ODU2","avatar_url":"https://avatars.githubusercontent.com/u/80639856?v=4","gravatar_id":"","url":"https://api.github.com/users/C0mbatwombat","html_url":"https://github.com/C0mbatwombat","followers_url":"https://api.github.com/users/C0mbatwombat/followers","following_url":"https://api.github.com/users/C0mbatwombat/following{/other_user}","gists_url":"https://api.github.com/users/C0mbatwombat/gists{/gist_id}","starred_url":"https://api.github.com/users/C0mbatwombat/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/C0mbatwombat/subscriptions","organizations_url":"https://api.github.com/users/C0mbatwombat/orgs","repos_url":"https://api.github.com/users/C0mbatwombat/repos","events_url":"https://api.github.com/users/C0mbatwombat/events{/privacy}","received_events_url":"https://api.github.com/users/C0mbatwombat/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":106503259,"node_id":"MDU6TGFiZWwxMDY1MDMyNTk=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/type:%20bug","name":"type: bug","color":"0052cc","default":false,"description":null},{"id":192364241,"node_id":"MDU6TGFiZWwxOTIzNjQyNDE=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/P3","name":"P3","color":"fbca04","default":false,"description":"We're not considering working on this, but happy to review a PR. (No assignee)"},{"id":1020660688,"node_id":"MDU6TGFiZWwxMDIwNjYwNjg4","url":"https://api.github.com/repos/bazelbuild/bazel/labels/team-Configurability","name":"team-Configurability","color":"f1f442","default":false,"description":"platforms, toolchains, cquery, select(), config transitions"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2025-06-16T12:17:00Z","updated_at":"2025-08-21T19:34:27Z","closed_at":"2025-08-14T17:37:04Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description of the bug:\n\n\nIn version 7.6.1, cquery combined with rdeps is throwing NPE quite regularly (about 20% of the times).\n\n```\nbazel cquery --noinclude_aspects --output=label  \"kind(\"java_library\", rdeps(//modules/..., //modules/framework/deps:required_deps, 1))\" 1>/dev/null\n(14:09:27) INFO: Invocation ID: b49e15fa-6288-41b2-8d5e-b1da9f4cf0e9\n(14:09:27) INFO: Current date is 2025-06-16\n(14:09:27) Computing main repo mapping: \n(14:09:28) Loading: \n(14:09:28) Loading: 0 packages loaded\n(14:09:28) Analyzing: 3457 targets (33 packages loaded, 0 targets configured)\n(14:09:29) Analyzing: 3457 targets (1055 packages loaded, 5774 targets configured)\n(14:09:29) INFO: Analyzed 3457 targets (1075 packages loaded, 6841 targets configured).\n(14:09:30) INFO: Found 3457 targets...\n(14:09:30) FATAL: bazel crashed due to an internal error. Printing stack trace:\njava.lang.NullPointerException: Cannot invoke \"com.google.devtools.build.lib.query2.common.CqueryNode.getLookupKey()\" because \"target\" is null\n        at com.google.devtools.build.lib.query2.cquery.ConfiguredTargetQueryEnvironment.getConfiguredTargetKey(ConfiguredTargetQueryEnvironment.java:513)\n        at com.google.devtools.build.lib.query2.cquery.ConfiguredTargetQueryEnvironment.getConfiguredTargetKey(ConfiguredTargetQueryEnvironment.java:78)\n        at com.google.devtools.build.lib.query2.PostAnalysisQueryEnvironment.unwindReverseDependencyDelegationLayersIfFound(PostAnalysisQueryEnvironment.java:394)\n        at com.google.devtools.build.lib.query2.PostAnalysisQueryEnvironment.skipDelegatingAncestors(PostAnalysisQueryEnvironment.java:379)\n        at com.google.devtools.build.lib.query2.PostAnalysisQueryEnvironment.getReverseDeps(PostAnalysisQueryEnvironment.java:326)\n        at com.google.devtools.build.lib.query2.PostAnalysisQueryEnvironment.getReverseDeps(PostAnalysisQueryEnvironment.java:109)\n        at com.google.devtools.build.lib.query2.engine.AllRdepsFunction.lambda$eval$0(AllRdepsFunction.java:99)\n        at com.google.devtools.build.lib.query2.common.AbstractBlazeQueryEnvironment.lambda$eval$0(AbstractBlazeQueryEnvironment.java:268)\n        at com.google.common.util.concurrent.CombinedFuture$CallableInterruptibleTask.runInterruptibly(CombinedFuture.java:196)\n        at com.google.common.util.concurrent.InterruptibleTask.run(InterruptibleTask.java:76)\n        at com.google.common.util.concurrent.DirectExecutor.execute(DirectExecutor.java:31)\n        at com.google.common.util.concurrent.CombinedFuture$CombinedFutureInterruptibleTask.execute(CombinedFuture.java:108)\n        at com.google.common.util.concurrent.CombinedFuture.handleAllCompleted(CombinedFuture.java:65)\n        at com.google.common.util.concurrent.AggregateFuture.processCompleted(AggregateFuture.java:301)\n        at com.google.common.util.concurrent.AggregateFuture.decrementCountAndMaybeComplete(AggregateFuture.java:283)\n        at com.google.common.util.concurrent.AggregateFuture.lambda$init$0(AggregateFuture.java:157)\n        at com.google.common.util.concurrent.DirectExecutor.execute(DirectExecutor.java:31)\n        at com.google.common.util.concurrent.AbstractFuture.executeListener(AbstractFuture.java:1286)\n        at com.google.common.util.concurrent.AbstractFuture.addListener(AbstractFuture.java:760)\n        at com.google.common.util.concurrent.FluentFuture$TrustedFuture.addListener(FluentFuture.java:114)\n        at com.google.devtools.build.lib.query2.common.AbstractBlazeQueryEnvironment$QueryTaskFutureImpl.addListener(AbstractBlazeQueryEnvironment.java:678)\n        at com.google.common.util.concurrent.AggregateFuture.init(AggregateFuture.java:140)\n        at com.google.common.util.concurrent.CombinedFuture.<init>(CombinedFuture.java:55)\n        at com.google.common.util.concurrent.Futures$FutureCombiner.call(Futures.java:744)\n        at com.google.devtools.build.lib.query2.common.AbstractBlazeQueryEnvironment.whenAllSucceedCall(AbstractBlazeQueryEnvironment.java:358)\n        at com.google.devtools.build.lib.query2.common.AbstractBlazeQueryEnvironment.whenSucceedsCall(AbstractBlazeQueryEnvironment.java:346)\n        at com.google.devtools.build.lib.query2.common.AbstractBlazeQueryEnvironment.eval(AbstractBlazeQueryEnvironment.java:265)\n        at com.google.devtools.build.lib.query2.engine.AllRdepsFunction.eval(AllRdepsFunction.java:84)\n        at com.google.devtools.build.lib.query2.engine.RdepsFunction.lambda$evalWithBoundedDepth$1(RdepsFunction.java:126)\n        at com.google.devtools.build.lib.query2.common.AbstractBlazeQueryEnvironment.transformAsync(AbstractBlazeQueryEnvironment.java:386)\n        at com.google.devtools.build.lib.query2.engine.RdepsFunction.evalWithBoundedDepth(RdepsFunction.java:128)\n        at com.google.devtools.build.lib.query2.engine.RdepsFunction.eval(RdepsFunction.java:74)\n        at com.google.devtools.build.lib.query2.engine.FunctionExpression.eval(FunctionExpression.java:55)\n        at com.google.devtools.build.lib.query2.common.AbstractBlazeQueryEnvironment.eval(AbstractBlazeQueryEnvironment.java:264)\n        at com.google.devtools.build.lib.query2.engine.RegexFilterExpression.eval(RegexFilterExpression.java:72)\n        at com.google.devtools.build.lib.query2.engine.FunctionExpression.eval(FunctionExpression.java:55)\n        at com.google.devtools.build.lib.query2.common.AbstractBlazeQueryEnvironment.eval(AbstractBlazeQueryEnvironment.java:264)\n        at com.google.devtools.build.lib.query2.common.AbstractBlazeQueryEnvironment.evalTopLevelInternal(AbstractBlazeQueryEnvironment.java:141)\n        at com.google.devtools.build.lib.query2.common.AbstractBlazeQueryEnvironment.evaluateQueryInternal(AbstractBlazeQueryEnvironment.java:185)\n        at com.google.devtools.build.lib.query2.PostAnalysisQueryEnvironment.evaluateQuery(PostAnalysisQueryEnvironment.java:177)\n        at com.google.devtools.build.lib.buildtool.PostAnalysisQueryProcessor.doPostAnalysisQuery(PostAnalysisQueryProcessor.java:214)\n        at com.google.devtools.build.lib.buildtool.PostAnalysisQueryProcessor.process(PostAnalysisQueryProcessor.java:95)\n        at com.google.devtools.build.lib.buildtool.BuildTool.buildTargets(BuildTool.java:211)\n        at com.google.devtools.build.lib.buildtool.BuildTool.processRequest(BuildTool.java:510)\n        at com.google.devtools.build.lib.buildtool.BuildTool.processRequest(BuildTool.java:478)\n        at com.google.devtools.build.lib.runtime.commands.CqueryCommand.exec(CqueryCommand.java:185)\n        at com.google.devtools.build.lib.runtime.BlazeCommandDispatcher.execExclusively(BlazeCommandDispatcher.java:664)\n        at com.google.devtools.build.lib.runtime.BlazeCommandDispatcher.exec(BlazeCommandDispatcher.java:244)\n        at com.google.devtools.build.lib.server.GrpcServerImpl.executeCommand(GrpcServerImpl.java:573)\n        at com.google.devtools.build.lib.server.GrpcServerImpl.lambda$run$1(GrpcServerImpl.java:641)\n        at io.grpc.Context$1.run(Context.java:566)\n        at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(Unknown Source)\n        at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)\n        at java.base/java.lang.Thread.run(Unknown Source)\n\n```\n\n### Which category does this issue belong to?\n\nCore\n\n### What's the simplest, easiest way to reproduce this bug? Please provide a minimal example if possible.\n\n\nI think the above query structure will result in NPE's even for small codebases.\n\n### Which operating system are you running Bazel on?\n\n\nUbuntu 24.04.1 LTS\n\n### What is the output of `bazel info release`?\n\n\nrelease 7.6.1\n\n### If `bazel info release` returns `development version` or `(@non-git)`, tell us how you built Bazel.\n\n\n_No response_\n\n### What's the output of `git remote get-url origin; git rev-parse HEAD` ?\n\n\n```text\n\n```\n\n### If this is a regression, please try to identify the Bazel commit where the bug was introduced with bazelisk --bisect.\n\n\n_No response_\n\n### Have you found anything relevant by searching the web?\n\nhttps://github.com/bazelbuild/bazel/issues/24508 and https://github.com/bazelbuild/bazel/issues/16310\n\n### Any other information, logs, or outputs that you want to share?\n\n_No response_","closed_by":{"login":"copybara-service[bot]","id":56741989,"node_id":"MDM6Qm90NTY3NDE5ODk=","avatar_url":"https://avatars.githubusercontent.com/in/44061?v=4","gravatar_id":"","url":"https://api.github.com/users/copybara-service%5Bbot%5D","html_url":"https://github.com/apps/copybara-service","followers_url":"https://api.github.com/users/copybara-service%5Bbot%5D/followers","following_url":"https://api.github.com/users/copybara-service%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/copybara-service%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/copybara-service%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/copybara-service%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/copybara-service%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/copybara-service%5Bbot%5D/repos","events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/26312/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bazelbuild/bazel/issues/26312/timeline","performed_via_github_app":null,"state_reason":"completed"}