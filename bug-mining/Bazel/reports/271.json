{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/23855","repository_url":"https://api.github.com/repos/bazelbuild/bazel","labels_url":"https://api.github.com/repos/bazelbuild/bazel/issues/23855/labels{/name}","comments_url":"https://api.github.com/repos/bazelbuild/bazel/issues/23855/comments","events_url":"https://api.github.com/repos/bazelbuild/bazel/issues/23855/events","html_url":"https://github.com/bazelbuild/bazel/issues/23855","id":2563011167,"node_id":"I_kwDOATz7jc6YxHJf","number":23855,"title":"Do not munge `visibility` attribute for targets created by symbolic macros","user":{"login":"brandjon","id":1308070,"node_id":"MDQ6VXNlcjEzMDgwNzA=","avatar_url":"https://avatars.githubusercontent.com/u/1308070?v=4","gravatar_id":"","url":"https://api.github.com/users/brandjon","html_url":"https://github.com/brandjon","followers_url":"https://api.github.com/users/brandjon/followers","following_url":"https://api.github.com/users/brandjon/following{/other_user}","gists_url":"https://api.github.com/users/brandjon/gists{/gist_id}","starred_url":"https://api.github.com/users/brandjon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/brandjon/subscriptions","organizations_url":"https://api.github.com/users/brandjon/orgs","repos_url":"https://api.github.com/users/brandjon/repos","events_url":"https://api.github.com/users/brandjon/events{/privacy}","received_events_url":"https://api.github.com/users/brandjon/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":106503259,"node_id":"MDU6TGFiZWwxMDY1MDMyNTk=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/type:%20bug","name":"type: bug","color":"0052cc","default":false,"description":null},{"id":192364134,"node_id":"MDU6TGFiZWwxOTIzNjQxMzQ=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/P1","name":"P1","color":"d93f0b","default":false,"description":"I'll work on this now. (Assignee required)"},{"id":4761864827,"node_id":"LA_kwDOATz7jc8AAAABG9RKew","url":"https://api.github.com/repos/bazelbuild/bazel/labels/team-Loading-API","name":"team-Loading-API","color":"f1f442","default":false,"description":"BUILD file and macro processing: labels, package(), visibility, glob"}],"state":"closed","locked":false,"assignee":{"login":"tetromino","id":52517,"node_id":"MDQ6VXNlcjUyNTE3","avatar_url":"https://avatars.githubusercontent.com/u/52517?v=4","gravatar_id":"","url":"https://api.github.com/users/tetromino","html_url":"https://github.com/tetromino","followers_url":"https://api.github.com/users/tetromino/followers","following_url":"https://api.github.com/users/tetromino/following{/other_user}","gists_url":"https://api.github.com/users/tetromino/gists{/gist_id}","starred_url":"https://api.github.com/users/tetromino/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tetromino/subscriptions","organizations_url":"https://api.github.com/users/tetromino/orgs","repos_url":"https://api.github.com/users/tetromino/repos","events_url":"https://api.github.com/users/tetromino/events{/privacy}","received_events_url":"https://api.github.com/users/tetromino/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"tetromino","id":52517,"node_id":"MDQ6VXNlcjUyNTE3","avatar_url":"https://avatars.githubusercontent.com/u/52517?v=4","gravatar_id":"","url":"https://api.github.com/users/tetromino","html_url":"https://github.com/tetromino","followers_url":"https://api.github.com/users/tetromino/followers","following_url":"https://api.github.com/users/tetromino/following{/other_user}","gists_url":"https://api.github.com/users/tetromino/gists{/gist_id}","starred_url":"https://api.github.com/users/tetromino/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tetromino/subscriptions","organizations_url":"https://api.github.com/users/tetromino/orgs","repos_url":"https://api.github.com/users/tetromino/repos","events_url":"https://api.github.com/users/tetromino/events{/privacy}","received_events_url":"https://api.github.com/users/tetromino/received_events","type":"User","user_view_type":"public","site_admin":false},{"login":"brandjon","id":1308070,"node_id":"MDQ6VXNlcjEzMDgwNzA=","avatar_url":"https://avatars.githubusercontent.com/u/1308070?v=4","gravatar_id":"","url":"https://api.github.com/users/brandjon","html_url":"https://github.com/brandjon","followers_url":"https://api.github.com/users/brandjon/followers","following_url":"https://api.github.com/users/brandjon/following{/other_user}","gists_url":"https://api.github.com/users/brandjon/gists{/gist_id}","starred_url":"https://api.github.com/users/brandjon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/brandjon/subscriptions","organizations_url":"https://api.github.com/users/brandjon/orgs","repos_url":"https://api.github.com/users/brandjon/repos","events_url":"https://api.github.com/users/brandjon/events{/privacy}","received_events_url":"https://api.github.com/users/brandjon/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":5,"created_at":"2024-10-03T02:57:45Z","updated_at":"2024-11-22T23:17:17Z","closed_at":"2024-11-14T16:11:34Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"@bazel-io flag 8.0.0\r\n*This potentially blocks Bazel 8.0 because without fixing this, the `bazel query`-introspected `visibility` value of targets created in Symbolic Macros is misleading/inconsistent.*\r\n\r\n----\r\n\r\nCurrently, for targets created within a symbolic macro, the `visibility` attribute that gets stored on the target is munged to include the instantiating location. This contrasts with the raw `visibility` attribute that gets stored on targets not in symbolic macros, which matches whatever the `visibility = ` argument passed to the instantiation site was.\r\n\r\nWe can't munge for targets not in symbolic macros, because it would likely imply a memory regression for the overwhelming majority of the build, and it would change the introspected `visibility` value for those targets relative to what is seen today in `native.existing_rules` and `bazel query`. But at the same time, the munging for targets in symbolic macros is also problematic, both due to the inconsistency and because tooling that reads the introspected values might expect them to match the source text of a BUILD file.\r\n\r\nThe proper solution is probably to be consistent by\r\n\r\n1. not munging `visibility` for any target\r\n2. computing the VisibilityProvider at analysis time without relying on said munging, deferring the concatenation of the callsite location to that point in time\r\n3. creating a synthetic attribute, `$actual_visibility`, to hold the munged value (regardless of whether the target is inside a symbolic macro), that can be introspected in `bazel query` but not in `native.existing_rules`. This attribute should not be materialized in normal builds.\r\n\r\nSymbolic macros themselves also have a `visibility` attribute, and it must always be munged (as it currently is) so that the implementation function sees the correct value for its `visibility` parameter. But if we expose symbolic macro attributes via `bazel query` in the future, we may very well want to avoid the munging to preserve consistency with rules. Note that munging happens at every level of a chain of symbolic macro calls, and the raw visibility for one macro is the munged visibility for its caller.\r\n\r\nImplementing this probably just requires a little work in `RuleFactory` and `ConfiguredTargetFactory`, plus updating some code comments that explain the outdated invariant. I'm not completely sure what the precedent is for synthetic `query`-only attributes.","closed_by":{"login":"copybara-service[bot]","id":56741989,"node_id":"MDM6Qm90NTY3NDE5ODk=","avatar_url":"https://avatars.githubusercontent.com/in/44061?v=4","gravatar_id":"","url":"https://api.github.com/users/copybara-service%5Bbot%5D","html_url":"https://github.com/apps/copybara-service","followers_url":"https://api.github.com/users/copybara-service%5Bbot%5D/followers","following_url":"https://api.github.com/users/copybara-service%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/copybara-service%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/copybara-service%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/copybara-service%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/copybara-service%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/copybara-service%5Bbot%5D/repos","events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/23855/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bazelbuild/bazel/issues/23855/timeline","performed_via_github_app":null,"state_reason":"completed"}