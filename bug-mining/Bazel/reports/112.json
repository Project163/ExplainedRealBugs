{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/20354","repository_url":"https://api.github.com/repos/bazelbuild/bazel","labels_url":"https://api.github.com/repos/bazelbuild/bazel/issues/20354/labels{/name}","comments_url":"https://api.github.com/repos/bazelbuild/bazel/issues/20354/comments","events_url":"https://api.github.com/repos/bazelbuild/bazel/issues/20354/events","html_url":"https://github.com/bazelbuild/bazel/issues/20354","id":2016198248,"node_id":"I_kwDOATz7jc54LL5o","number":20354,"title":"Unexpected interaction between toolchain resolution and bzlmod","user":{"login":"lberki","id":3524818,"node_id":"MDQ6VXNlcjM1MjQ4MTg=","avatar_url":"https://avatars.githubusercontent.com/u/3524818?v=4","gravatar_id":"","url":"https://api.github.com/users/lberki","html_url":"https://github.com/lberki","followers_url":"https://api.github.com/users/lberki/followers","following_url":"https://api.github.com/users/lberki/following{/other_user}","gists_url":"https://api.github.com/users/lberki/gists{/gist_id}","starred_url":"https://api.github.com/users/lberki/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lberki/subscriptions","organizations_url":"https://api.github.com/users/lberki/orgs","repos_url":"https://api.github.com/users/lberki/repos","events_url":"https://api.github.com/users/lberki/events{/privacy}","received_events_url":"https://api.github.com/users/lberki/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":106503259,"node_id":"MDU6TGFiZWwxMDY1MDMyNTk=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/type:%20bug","name":"type: bug","color":"0052cc","default":false,"description":null},{"id":192364170,"node_id":"MDU6TGFiZWwxOTIzNjQxNzA=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/P2","name":"P2","color":"e99695","default":false,"description":"We'll consider working on this in future. (Assignee optional)"},{"id":1020663381,"node_id":"MDU6TGFiZWwxMDIwNjYzMzgx","url":"https://api.github.com/repos/bazelbuild/bazel/labels/team-ExternalDeps","name":"team-ExternalDeps","color":"f1f442","default":false,"description":"External dependency handling, remote repositiories, WORKSPACE file."},{"id":3718884690,"node_id":"LA_kwDOATz7jc7dqa1S","url":"https://api.github.com/repos/bazelbuild/bazel/labels/area-Bzlmod","name":"area-Bzlmod","color":"a4fc20","default":false,"description":"Bzlmod-specific PRs, issues, and feature requests"}],"state":"closed","locked":false,"assignee":{"login":"katre","id":326527,"node_id":"MDQ6VXNlcjMyNjUyNw==","avatar_url":"https://avatars.githubusercontent.com/u/326527?v=4","gravatar_id":"","url":"https://api.github.com/users/katre","html_url":"https://github.com/katre","followers_url":"https://api.github.com/users/katre/followers","following_url":"https://api.github.com/users/katre/following{/other_user}","gists_url":"https://api.github.com/users/katre/gists{/gist_id}","starred_url":"https://api.github.com/users/katre/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/katre/subscriptions","organizations_url":"https://api.github.com/users/katre/orgs","repos_url":"https://api.github.com/users/katre/repos","events_url":"https://api.github.com/users/katre/events{/privacy}","received_events_url":"https://api.github.com/users/katre/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"katre","id":326527,"node_id":"MDQ6VXNlcjMyNjUyNw==","avatar_url":"https://avatars.githubusercontent.com/u/326527?v=4","gravatar_id":"","url":"https://api.github.com/users/katre","html_url":"https://github.com/katre","followers_url":"https://api.github.com/users/katre/followers","following_url":"https://api.github.com/users/katre/following{/other_user}","gists_url":"https://api.github.com/users/katre/gists{/gist_id}","starred_url":"https://api.github.com/users/katre/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/katre/subscriptions","organizations_url":"https://api.github.com/users/katre/orgs","repos_url":"https://api.github.com/users/katre/repos","events_url":"https://api.github.com/users/katre/events{/privacy}","received_events_url":"https://api.github.com/users/katre/received_events","type":"User","user_view_type":"public","site_admin":false},{"login":"Wyverald","id":453203,"node_id":"MDQ6VXNlcjQ1MzIwMw==","avatar_url":"https://avatars.githubusercontent.com/u/453203?v=4","gravatar_id":"","url":"https://api.github.com/users/Wyverald","html_url":"https://github.com/Wyverald","followers_url":"https://api.github.com/users/Wyverald/followers","following_url":"https://api.github.com/users/Wyverald/following{/other_user}","gists_url":"https://api.github.com/users/Wyverald/gists{/gist_id}","starred_url":"https://api.github.com/users/Wyverald/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Wyverald/subscriptions","organizations_url":"https://api.github.com/users/Wyverald/orgs","repos_url":"https://api.github.com/users/Wyverald/repos","events_url":"https://api.github.com/users/Wyverald/events{/privacy}","received_events_url":"https://api.github.com/users/Wyverald/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/bazelbuild/bazel/milestones/65","html_url":"https://github.com/bazelbuild/bazel/milestone/65","labels_url":"https://api.github.com/repos/bazelbuild/bazel/milestones/65/labels","id":10407261,"node_id":"MI_kwDOATz7jc4Ans1d","number":65,"title":"Mainline issues targeted for 7.1.0 ","description":"","creator":{"login":"Wyverald","id":453203,"node_id":"MDQ6VXNlcjQ1MzIwMw==","avatar_url":"https://avatars.githubusercontent.com/u/453203?v=4","gravatar_id":"","url":"https://api.github.com/users/Wyverald","html_url":"https://github.com/Wyverald","followers_url":"https://api.github.com/users/Wyverald/followers","following_url":"https://api.github.com/users/Wyverald/following{/other_user}","gists_url":"https://api.github.com/users/Wyverald/gists{/gist_id}","starred_url":"https://api.github.com/users/Wyverald/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Wyverald/subscriptions","organizations_url":"https://api.github.com/users/Wyverald/orgs","repos_url":"https://api.github.com/users/Wyverald/repos","events_url":"https://api.github.com/users/Wyverald/events{/privacy}","received_events_url":"https://api.github.com/users/Wyverald/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":6,"state":"closed","created_at":"2024-01-11T18:35:54Z","updated_at":"2024-03-11T19:20:04Z","due_on":"2024-02-20T08:00:00Z","closed_at":"2024-03-11T19:20:04Z"},"comments":20,"created_at":"2023-11-29T09:47:07Z","updated_at":"2024-01-11T18:37:16Z","closed_at":"2023-12-04T21:39:29Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description of the bug:\r\n\r\n\r\nWhen bzlmod is enabled (as it is the case in Bazel 7.0.0), toolchain registered by default can unexpectedly shadow toolchains declared in the `WORKSPACE` file. This makes the oucome of toolchain resolution dependent on whether bzlmod is enabled, even if the `MODULE.bazel` file of the main repository is empty (as it is by default)\r\n\r\nThe root cause seems to be different from #17289 : there, AFAIU that one is caused by a subtle interaction between label mapping and toolchain resolution, here it's much more straightforward.\r\n\r\nSome debugging indicates that what happens is that `RegisteredToolchainsFunction` creates the list of registered toolchains by concatenating two lists: those from bzlmod, then those from the WORKSPACE file.  `rules_python` is by default and immutably (except if bzlmod is disabled) a bzlmod module and it  registers `@bazel_tools//tools/python:_autodetecting_py_runtime_pair` as a Python toolchain. Since that toolchain doesn't have any exec or target constraints, it seems to win toolchain selection by default, regardless of what other toolchains come after.\r\n\r\nTherefore, no matter what is written in the `WORKSPACE` file, one gets the autodetecting Python toolchain.\r\n\r\nI'm not sure if this is WAI; it could be construed as such, but it sure is surprising and a hindrance to migration to bzlmod.\r\n\r\n### Which category does this issue belong to?\r\n\r\n\r\n_No response_\r\n\r\n### What's the simplest, easiest way to reproduce this bug? Please provide a minimal example if possible.\r\n\r\n\r\n```\r\ncat > WORKSPACE <<'EOF'\r\nregister_toolchains(\"//tc:py_toolchain\")\r\nEOF\r\n\r\ncat > BUILD <<'EOF'\r\npy_binary(\r\n    name = \"py\",\r\n    srcs = [\"py.py\"],\r\n)\r\nEOF\r\n\r\ncat > py.py <<'EOF'\r\nprint(\"Hello, Python!\")\r\nEOF\r\n\r\nmkdir tc\r\n\r\ncat > tc/BUILD <<'EOF'\r\nload(\"@bazel_tools//tools/python:toolchain.bzl\", \"py_runtime_pair\")\r\n\r\npy_runtime(\r\n    name = \"python2\",\r\n    files = [\"ok.py2\"],\r\n    interpreter = \"ok.py2\",\r\n    python_version = \"PY2\",\r\n)\r\n\r\npy_runtime(\r\n    name = \"python3\",\r\n    files = [\"ok.py3\"],\r\n    interpreter = \"ok.py3\",\r\n    python_version = \"PY3\",\r\n)\r\n\r\npy_runtime_pair(\r\n    name = \"pair\",\r\n    py2_runtime = \":python2\",\r\n    py3_runtime = \":python3\",\r\n)\r\n\r\ntoolchain(\r\n    name = \"py_toolchain\",\r\n    toolchain = \":pair\",\r\n    toolchain_type = \"@bazel_tools//tools/python:toolchain_type\",\r\n)\r\nEOF\r\n\r\nbazel run --enable_bzlmod :py  # BUG: Prints \"Hello, Python!\", ignoring the toolchain\r\nbazel run --noenable_bzlmod :py  # WORKS: Fails to find the dummy interpreter defined above\r\n```\r\n\r\n### Which operating system are you running Bazel on?\r\n\r\n\r\nLinux\r\n\r\n### What is the output of `bazel info release`?\r\n\r\n\r\ndevelopment version\r\n\r\n### If `bazel info release` returns `development version` or `(@non-git)`, tell us how you built Bazel.\r\n\r\n\r\nFrom sources\r\n\r\n### What's the output of `git remote get-url origin; git rev-parse master; git rev-parse HEAD` ?\r\n\r\n\r\n```text\r\n4a29f0851d1cde0240793cdc7a2e2cab926d31b7\r\n```\r\n\r\n\r\n### Is this a regression? If yes, please try to identify the Bazel commit where the bug was introduced.\r\n\r\n\r\nPretty obviously when `--enable_bzlmod` was flipped to true.\r\n\r\n### Have you found anything relevant by searching the web?\r\n\r\nThere are a number of pertinent bugs:\r\n* https://github.com/bazelbuild/bazel/issues/17289 (but that has a different root cause, if I understand correctly)\r\n* https://github.com/bazelbuild/rules_python/issues/1313 (seems to be very similar, but I haven't seen evidence that the bzlmod folks looked at this and has less information as to why this happens)\r\n\r\n### Any other information, logs, or outputs that you want to share?\r\n\r\n_No response_","closed_by":{"login":"copybara-service[bot]","id":56741989,"node_id":"MDM6Qm90NTY3NDE5ODk=","avatar_url":"https://avatars.githubusercontent.com/in/44061?v=4","gravatar_id":"","url":"https://api.github.com/users/copybara-service%5Bbot%5D","html_url":"https://github.com/apps/copybara-service","followers_url":"https://api.github.com/users/copybara-service%5Bbot%5D/followers","following_url":"https://api.github.com/users/copybara-service%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/copybara-service%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/copybara-service%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/copybara-service%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/copybara-service%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/copybara-service%5Bbot%5D/repos","events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/20354/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bazelbuild/bazel/issues/20354/timeline","performed_via_github_app":null,"state_reason":"completed"}