{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/19126","repository_url":"https://api.github.com/repos/bazelbuild/bazel","labels_url":"https://api.github.com/repos/bazelbuild/bazel/issues/19126/labels{/name}","comments_url":"https://api.github.com/repos/bazelbuild/bazel/issues/19126/comments","events_url":"https://api.github.com/repos/bazelbuild/bazel/issues/19126/events","html_url":"https://github.com/bazelbuild/bazel/issues/19126","id":1827323119,"node_id":"I_kwDOATz7jc5s6rzv","number":19126,"title":"`config_setting` incorrectly treated as implicit dependency by `--incompatible_visibility_private_attributes_at_definition`","user":{"login":"dgp1130","id":11010321,"node_id":"MDQ6VXNlcjExMDEwMzIx","avatar_url":"https://avatars.githubusercontent.com/u/11010321?v=4","gravatar_id":"","url":"https://api.github.com/users/dgp1130","html_url":"https://github.com/dgp1130","followers_url":"https://api.github.com/users/dgp1130/followers","following_url":"https://api.github.com/users/dgp1130/following{/other_user}","gists_url":"https://api.github.com/users/dgp1130/gists{/gist_id}","starred_url":"https://api.github.com/users/dgp1130/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dgp1130/subscriptions","organizations_url":"https://api.github.com/users/dgp1130/orgs","repos_url":"https://api.github.com/users/dgp1130/repos","events_url":"https://api.github.com/users/dgp1130/events{/privacy}","received_events_url":"https://api.github.com/users/dgp1130/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":106503259,"node_id":"MDU6TGFiZWwxMDY1MDMyNTk=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/type:%20bug","name":"type: bug","color":"0052cc","default":false,"description":null},{"id":1020665933,"node_id":"MDU6TGFiZWwxMDIwNjY1OTMz","url":"https://api.github.com/repos/bazelbuild/bazel/labels/untriaged","name":"untriaged","color":"c34ddd","default":false,"description":""},{"id":4761864827,"node_id":"LA_kwDOATz7jc8AAAABG9RKew","url":"https://api.github.com/repos/bazelbuild/bazel/labels/team-Loading-API","name":"team-Loading-API","color":"f1f442","default":false,"description":"BUILD file and macro processing: labels, package(), visibility, glob"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2023-07-29T05:13:14Z","updated_at":"2023-10-14T19:08:02Z","closed_at":"2023-08-04T16:33:34Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description of the bug:\r\n\r\n\r\nWhen explicitly depending on a `config_setting` and enabling `--incompatible_visibility_private_attributes_at_definition`, the setting is incorrectly treated as an implicit dependency which must be visible to the dependent's rule definition, which doesn't make logical sense. The full set of conditions from my understanding is:\r\n\r\n1.  A target which depends on a `config_setting` from a different package through a `select` key.\r\n1.  The target is an instance of a rule from a another package which does _not_ have visibility into the `config_setting`.\r\n1.  `--incompatible_visibility_private_attributes_at_definition`.\r\n\r\n```python\r\n# BUILD.bazel\r\n\r\nload(\"//build_defs:defs.bzl\", \"my_rule\")\r\n\r\nmy_rule(\r\n    name = \"my_target\",\r\n    value = select({\r\n        \"//config_setting:my_setting\": \"foo\",\r\n        \"//conditions:default\": \"bar\",\r\n    }),\r\n)\r\n```\r\n\r\nWhen all three happen it throws an error like this:\r\n\r\n```\r\n$ bazel build //:my_target\r\nERROR: /home/doug/Source/bazel_visibility/BUILD.bazel:3:8: in my_rule rule //:my_target: target '//config_setting:my_setting' is not visible from target '//build_defs:defs.bzl'. Check the visibility declaration of the former target if you think the dependency is legitimate\r\nERROR: /home/doug/Source/bazel_visibility/BUILD.bazel:3:8: Analysis of target '//:my_target' failed\r\nERROR: Analysis of target '//:my_target' failed; build aborted: \r\nINFO: Elapsed time: 0.064s\r\nINFO: 0 processes.\r\nFAILED: Build did NOT complete successfully (2 packages loaded, 2 targets configured)\r\n```\r\n\r\nThis doesn't make sense: `target '//config_setting:my_setting' is not visible from target '//build_defs:defs.bzl'`. This should not be required, as the config setting is not an implicit dependency.\r\n\r\n### What's the simplest, easiest way to reproduce this bug? Please provide a minimal example if possible.\r\n\r\n\r\nMinimal reproduction here: https://github.com/dgp1130/bazel-config-setting-visibility-bug/\r\n\r\nIt does rely on Skylib which probably isn't necessary but I figured that wasn't too significant and I didn't want to try and figure out how to define flags manually.\r\n\r\n### Which operating system are you running Bazel on?\r\n\r\n\r\nUbuntu on WSL\r\n\r\n### What is the output of `bazel info release`?\r\n\r\n\r\nrelease 6.3.0\r\n\r\n### If `bazel info release` returns `development version` or `(@non-git)`, tell us how you built Bazel.\r\n\r\n\r\n_No response_\r\n\r\n### What's the output of `git remote get-url origin; git rev-parse master; git rev-parse HEAD` ?\r\n\r\n\r\n```text\r\n$ git remote get-url origin; git rev-parse main; git rev-parse HEAD\r\ngit@github.com:dgp1130/bazel-config-setting-visibility-bug\r\nd86833d09fb3bcb3eb0429d74eb80364db7e684a\r\nd86833d09fb3bcb3eb0429d74eb80364db7e684a\r\n```\r\n\r\n\r\n### Is this a regression? If yes, please try to identify the Bazel commit where the bug was introduced.\r\n\r\n\r\nI don't know, however I initially reproduced on version 6.0.0 before upgrading to 6.3.0 to confirm it was still present on latest. The bug is at least that old.\r\n\r\n### Have you found anything relevant by searching the web?\r\n\r\nhttps://github.com/bazelbuild/bazel/issues/12932 feels like it might be relevant, however I found that `--incompatible_enforce_config_setting_visibility` had no effect, so it could be nothing.\r\n\r\n### Any other information, logs, or outputs that you want to share?\r\n\r\n_No response_","closed_by":{"login":"copybara-service[bot]","id":56741989,"node_id":"MDM6Qm90NTY3NDE5ODk=","avatar_url":"https://avatars.githubusercontent.com/in/44061?v=4","gravatar_id":"","url":"https://api.github.com/users/copybara-service%5Bbot%5D","html_url":"https://github.com/apps/copybara-service","followers_url":"https://api.github.com/users/copybara-service%5Bbot%5D/followers","following_url":"https://api.github.com/users/copybara-service%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/copybara-service%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/copybara-service%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/copybara-service%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/copybara-service%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/copybara-service%5Bbot%5D/repos","events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/19126/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bazelbuild/bazel/issues/19126/timeline","performed_via_github_app":null,"state_reason":"completed"}