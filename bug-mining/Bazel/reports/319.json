{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/20832","repository_url":"https://api.github.com/repos/bazelbuild/bazel","labels_url":"https://api.github.com/repos/bazelbuild/bazel/issues/20832/labels{/name}","comments_url":"https://api.github.com/repos/bazelbuild/bazel/issues/20832/comments","events_url":"https://api.github.com/repos/bazelbuild/bazel/issues/20832/events","html_url":"https://github.com/bazelbuild/bazel/issues/20832","id":2073485917,"node_id":"I_kwDOATz7jc57luJd","number":20832,"title":"Invalid --experimental_downloader_config file crashes bazel without an error message","user":{"login":"wade-arista","id":149626442,"node_id":"U_kgDOCOseSg","avatar_url":"https://avatars.githubusercontent.com/u/149626442?v=4","gravatar_id":"","url":"https://api.github.com/users/wade-arista","html_url":"https://github.com/wade-arista","followers_url":"https://api.github.com/users/wade-arista/followers","following_url":"https://api.github.com/users/wade-arista/following{/other_user}","gists_url":"https://api.github.com/users/wade-arista/gists{/gist_id}","starred_url":"https://api.github.com/users/wade-arista/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wade-arista/subscriptions","organizations_url":"https://api.github.com/users/wade-arista/orgs","repos_url":"https://api.github.com/users/wade-arista/repos","events_url":"https://api.github.com/users/wade-arista/events{/privacy}","received_events_url":"https://api.github.com/users/wade-arista/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":106503259,"node_id":"MDU6TGFiZWwxMDY1MDMyNTk=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/type:%20bug","name":"type: bug","color":"0052cc","default":false,"description":null},{"id":192364170,"node_id":"MDU6TGFiZWwxOTIzNjQxNzA=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/P2","name":"P2","color":"e99695","default":false,"description":"We'll consider working on this in future. (Assignee optional)"},{"id":551803287,"node_id":"MDU6TGFiZWw1NTE4MDMyODc=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/good%20first%20issue","name":"good first issue","color":"fbca04","default":true,"description":null},{"id":1020663381,"node_id":"MDU6TGFiZWwxMDIwNjYzMzgx","url":"https://api.github.com/repos/bazelbuild/bazel/labels/team-ExternalDeps","name":"team-ExternalDeps","color":"f1f442","default":false,"description":"External dependency handling, remote repositiories, WORKSPACE file."},{"id":2051939153,"node_id":"MDU6TGFiZWwyMDUxOTM5MTUz","url":"https://api.github.com/repos/bazelbuild/bazel/labels/help%20wanted","name":"help wanted","color":"159818","default":true,"description":"Someone outside the Bazel team could own this"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2024-01-10T02:47:23Z","updated_at":"2025-04-17T05:18:18Z","closed_at":"2025-04-17T05:18:18Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description of the bug:\r\n\r\n\r\nI had an invalid regex in a `rewrite` in my downloader config, and bazel would just crash without an error message.\r\n\r\nRunning it with `--batch`, I was able to see the error message, however, e.g.:\r\n\r\n\r\n```\r\nFATAL: bazel crashed due to an internal error. Printing stack trace:\r\njava.util.regex.PatternSyntaxException: Illegal/unsupported escape sequence near index 4\r\n(.*\\maven.org/.*)\r\n    ^\r\n        at java.base/java.util.regex.Pattern.error(Unknown Source)\r\n        at java.base/java.util.regex.Pattern.escape(Unknown Source)\r\n        at java.base/java.util.regex.Pattern.atom(Unknown Source)\r\n        at java.base/java.util.regex.Pattern.sequence(Unknown Source)\r\n        at java.base/java.util.regex.Pattern.expr(Unknown Source)\r\n        at java.base/java.util.regex.Pattern.group0(Unknown Source)\r\n        at java.base/java.util.regex.Pattern.sequence(Unknown Source)\r\n        at java.base/java.util.regex.Pattern.expr(Unknown Source)\r\n        at java.base/java.util.regex.Pattern.compile(Unknown Source)\r\n        at java.base/java.util.regex.Pattern.<init>(Unknown Source)\r\n        at java.base/java.util.regex.Pattern.compile(Unknown Source)\r\n        at com.google.devtools.build.lib.bazel.repository.downloader.UrlRewriterConfig.<init>(UrlRewriterConfig.java:134)\r\n        at com.google.devtools.build.lib.bazel.repository.downloader.UrlRewriter.<init>(UrlRewriter.java:77)\r\n        at com.google.devtools.build.lib.bazel.repository.downloader.UrlRewriter.getDownloaderUrlRewriter(UrlRewriter.java:98)\r\n        at com.google.devtools.build.lib.bazel.BazelRepositoryModule.beforeCommand(BazelRepositoryModule.java:409)\r\n        at com.google.devtools.build.lib.runtime.BlazeCommandDispatcher.execExclusively(BlazeCommandDispatcher.java:412)\r\n        at com.google.devtools.build.lib.runtime.BlazeCommandDispatcher.exec(BlazeCommandDispatcher.java:244)\r\n        at com.google.devtools.build.lib.runtime.BlazeRuntime.batchMain(BlazeRuntime.java:953)\r\n        at com.google.devtools.build.lib.runtime.BlazeRuntime.main(BlazeRuntime.java:763)\r\n        at com.google.devtools.build.lib.bazel.Bazel.main(Bazel.java:95)\r\n```\r\n\r\n### Which category does this issue belong to?\r\n\r\n\r\nCore\r\n\r\n### What's the simplest, easiest way to reproduce this bug? Please provide a minimal example if possible.\r\n\r\n\r\nI just created an empty `MODULE.bazel` and a simple `downloader.cfg` file with a bad regex (invalid `\\m` escape)\r\n\r\n`downloader.cfg`:\r\n```\r\nrewrite (.*\\maven.org/.*) http://example.com/mirror/$1\r\n```\r\n\r\nAnd then:\r\n```\r\n% bazel --nosystem_rc --output_user_root=$PWD/root info --experimental_downloader_config=downloader.config\r\nStarting local Bazel server and connecting to it...\r\n% echo $?\r\n37\r\n```\r\n\r\n### Which operating system are you running Bazel on?\r\n\r\n\r\nalma linux 9\r\n\r\n### What is the output of `bazel info release`?\r\n\r\n\r\nrelease 7.0.0\r\n\r\n### If `bazel info release` returns `development version` or `(@non-git)`, tell us how you built Bazel.\r\n\r\n\r\n_No response_\r\n\r\n### What's the output of `git remote get-url origin; git rev-parse master; git rev-parse HEAD` ?\r\n\r\n\r\n_No response_\r\n\r\n### Is this a regression? If yes, please try to identify the Bazel commit where the bug was introduced.\r\n\r\n\r\nIt appears to be crashing since the config flag was introduced in 9d2946440a43c2adc6b3cdf09739a6dbf5e29abf, but in that version, there's an error message on the output.\r\n\r\n```\r\n% USE_BAZEL_VERSION=9d2946440a43c2adc6b3cdf09739a6dbf5e29abf  bazelisk  --nosystem_rc --output_user_root=$PWD/root info --experimental_downloader_config=downloader.config\r\nWARNING: The following rc files are no longer being read, please transfer their contents or import their path into one of the standard rc files:\r\n/etc/bazel.bazelrc\r\nStarting local Bazel server and connecting to it...\r\nInternal error thrown during build. Printing stack trace: java.util.regex.PatternSyntaxException: Illegal/unsupported escape sequence near index 4\r\n(.*\\maven.org/.*)\r\n    ^\r\n\tat java.base/java.util.regex.Pattern.error(Unknown Source)\r\n\tat java.base/java.util.regex.Pattern.escape(Unknown Source)\r\n\tat java.base/java.util.regex.Pattern.atom(Unknown Source)\r\n\tat java.base/java.util.regex.Pattern.sequence(Unknown Source)\r\n\tat java.base/java.util.regex.Pattern.expr(Unknown Source)\r\n\tat java.base/java.util.regex.Pattern.group0(Unknown Source)\r\n\tat java.base/java.util.regex.Pattern.sequence(Unknown Source)\r\n\tat java.base/java.util.regex.Pattern.expr(Unknown Source)\r\n\tat java.base/java.util.regex.Pattern.compile(Unknown Source)\r\n\tat java.base/java.util.regex.Pattern.<init>(Unknown Source)\r\n\tat java.base/java.util.regex.Pattern.compile(Unknown Source)\r\n\tat com.google.devtools.build.lib.bazel.repository.downloader.UrlRewriterConfig.<init>(UrlRewriterConfig.java:118)\r\n\tat com.google.devtools.build.lib.bazel.repository.downloader.UrlRewriter.<init>(UrlRewriter.java:63)\r\n\tat com.google.devtools.build.lib.bazel.repository.downloader.UrlRewriter.getDownloaderUrlRewriter(UrlRewriter.java:82)\r\n\tat com.google.devtools.build.lib.bazel.BazelRepositoryModule.beforeCommand(BazelRepositoryModule.java:286)\r\n\tat com.google.devtools.build.lib.runtime.BlazeCommandDispatcher.execExclusively(BlazeCommandDispatcher.java:388)\r\n\tat com.google.devtools.build.lib.runtime.BlazeCommandDispatcher.exec(BlazeCommandDispatcher.java:236)\r\n\tat com.google.devtools.build.lib.server.GrpcServerImpl.executeCommand(GrpcServerImpl.java:546)\r\n\tat com.google.devtools.build.lib.server.GrpcServerImpl.lambda$run$1(GrpcServerImpl.java:611)\r\n\tat io.grpc.Context$1.run(Context.java:579)\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(Unknown Source)\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)\r\n\tat java.base/java.lang.Thread.run(Unknown Source)\r\njava.util.regex.PatternSyntaxException: Illegal/unsupported escape sequence near index 4\r\n```\r\n\r\n### Have you found anything relevant by searching the web?\r\n\r\nhttps://github.com/bazelbuild/bazel/issues/19277\r\n\r\n### Any other information, logs, or outputs that you want to share?\r\n\r\nJava RPM info:\r\n```\r\nName         : java-11-openjdk-devel\r\nEpoch        : 1\r\nVersion      : 11.0.19.0.7\r\nRelease      : 4.el9.alma\r\n```","closed_by":{"login":"copybara-service[bot]","id":56741989,"node_id":"MDM6Qm90NTY3NDE5ODk=","avatar_url":"https://avatars.githubusercontent.com/in/44061?v=4","gravatar_id":"","url":"https://api.github.com/users/copybara-service%5Bbot%5D","html_url":"https://github.com/apps/copybara-service","followers_url":"https://api.github.com/users/copybara-service%5Bbot%5D/followers","following_url":"https://api.github.com/users/copybara-service%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/copybara-service%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/copybara-service%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/copybara-service%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/copybara-service%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/copybara-service%5Bbot%5D/repos","events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/20832/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bazelbuild/bazel/issues/20832/timeline","performed_via_github_app":null,"state_reason":"completed"}