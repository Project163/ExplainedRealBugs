{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/21773","repository_url":"https://api.github.com/repos/bazelbuild/bazel","labels_url":"https://api.github.com/repos/bazelbuild/bazel/issues/21773/labels{/name}","comments_url":"https://api.github.com/repos/bazelbuild/bazel/issues/21773/comments","events_url":"https://api.github.com/repos/bazelbuild/bazel/issues/21773/events","html_url":"https://github.com/bazelbuild/bazel/issues/21773","id":2202975168,"node_id":"I_kwDOATz7jc6DTrvA","number":21773,"title":"Multithreaded download_and_extract (http_archive) buggy on retry","user":{"login":"moroten","id":5401799,"node_id":"MDQ6VXNlcjU0MDE3OTk=","avatar_url":"https://avatars.githubusercontent.com/u/5401799?v=4","gravatar_id":"","url":"https://api.github.com/users/moroten","html_url":"https://github.com/moroten","followers_url":"https://api.github.com/users/moroten/followers","following_url":"https://api.github.com/users/moroten/following{/other_user}","gists_url":"https://api.github.com/users/moroten/gists{/gist_id}","starred_url":"https://api.github.com/users/moroten/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/moroten/subscriptions","organizations_url":"https://api.github.com/users/moroten/orgs","repos_url":"https://api.github.com/users/moroten/repos","events_url":"https://api.github.com/users/moroten/events{/privacy}","received_events_url":"https://api.github.com/users/moroten/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":106503259,"node_id":"MDU6TGFiZWwxMDY1MDMyNTk=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/type:%20bug","name":"type: bug","color":"0052cc","default":false,"description":null},{"id":192364170,"node_id":"MDU6TGFiZWwxOTIzNjQxNzA=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/P2","name":"P2","color":"e99695","default":false,"description":"We'll consider working on this in future. (Assignee optional)"},{"id":1020663381,"node_id":"MDU6TGFiZWwxMDIwNjYzMzgx","url":"https://api.github.com/repos/bazelbuild/bazel/labels/team-ExternalDeps","name":"team-ExternalDeps","color":"f1f442","default":false,"description":"External dependency handling, remote repositiories, WORKSPACE file."}],"state":"closed","locked":false,"assignee":{"login":"Wyverald","id":453203,"node_id":"MDQ6VXNlcjQ1MzIwMw==","avatar_url":"https://avatars.githubusercontent.com/u/453203?v=4","gravatar_id":"","url":"https://api.github.com/users/Wyverald","html_url":"https://github.com/Wyverald","followers_url":"https://api.github.com/users/Wyverald/followers","following_url":"https://api.github.com/users/Wyverald/following{/other_user}","gists_url":"https://api.github.com/users/Wyverald/gists{/gist_id}","starred_url":"https://api.github.com/users/Wyverald/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Wyverald/subscriptions","organizations_url":"https://api.github.com/users/Wyverald/orgs","repos_url":"https://api.github.com/users/Wyverald/repos","events_url":"https://api.github.com/users/Wyverald/events{/privacy}","received_events_url":"https://api.github.com/users/Wyverald/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"Wyverald","id":453203,"node_id":"MDQ6VXNlcjQ1MzIwMw==","avatar_url":"https://avatars.githubusercontent.com/u/453203?v=4","gravatar_id":"","url":"https://api.github.com/users/Wyverald","html_url":"https://github.com/Wyverald","followers_url":"https://api.github.com/users/Wyverald/followers","following_url":"https://api.github.com/users/Wyverald/following{/other_user}","gists_url":"https://api.github.com/users/Wyverald/gists{/gist_id}","starred_url":"https://api.github.com/users/Wyverald/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Wyverald/subscriptions","organizations_url":"https://api.github.com/users/Wyverald/orgs","repos_url":"https://api.github.com/users/Wyverald/repos","events_url":"https://api.github.com/users/Wyverald/events{/privacy}","received_events_url":"https://api.github.com/users/Wyverald/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":36,"created_at":"2024-03-22T17:27:59Z","updated_at":"2025-01-16T07:14:11Z","closed_at":"2024-10-15T18:25:40Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description of the bug:\n\n\nOccationally, we observe that `download_and_extract` fails with\r\n```\r\nERROR: /.../WORKSPACE:40:13: fetching http_archive rule //external:redacted: java.io.IOException: /.../external/redacted (Directory not empty)\r\n```\r\nLooking at the attached profile, shows that the download first fails and then all 16 download threads are retrying in parallel, resulting in some of them not being able to clean up properly. All processes 1691-1738 look the same, lots of retries.\r\n\r\n![download_and_extract_zoom](https://github.com/bazelbuild/bazel/assets/5401799/787c894e-b29f-4e96-b049-ec7811f1f925)\r\n![download_manager](https://github.com/bazelbuild/bazel/assets/5401799/f705e29b-fa9e-4ed5-9d51-3a71939e5970)\r\n\r\nWe have in other cases also observed temporary download directories inside a fetched external repository (`temp1234...`), sometimes one and sometimes ten directories. This results in cache miss when using a `glob` which picks up the temporary download directories.\r\n\r\n```\r\n\r\n.../external/redacted$ ls -la\r\ndrwxr-xr-x    Mar 18 10:52 .\r\ndrwxr-xr-x    Mar 18 10:55 ..\r\n-rwxr-xr-x    Mar 18 10:52 BUILD.bazel\r\ndrwxr-xr-x    Mar 18 10:52 something\r\ndrwxr-xr-x    Mar 18 10:50 temp9248233320309694695\r\n-rwxr-xr-x    Mar 18 10:52 WORKSPACE\r\n.../external/redacted$ stat temp9248233320309694695\r\n  File: temp9248233320309694695\r\n  Size: 4096            Blocks: 8          IO Block: 4096   directory\r\nDevice: fd00h/64768d    Inode: 16384054    Links: 2\r\nAccess: (0755/drwxr-xr-x)  Uid: ( )   Gid: ( )\r\nAccess: 2024-03-18 10:52:47.218611936 +0100\r\nModify: 2024-03-18 10:50:04.623888785 +0100\r\nChange: 2024-03-18 10:50:04.623888785 +0100\r\nBirth: 2024-03-18 10:50:04.623888785 +0100\r\n.../external/redacted$ stat .\r\n  File: .\r\n  Size: 4096            Blocks: 8          IO Block: 4096   directory\r\nDevice: fd00h/64768d    Inode: 16384333    Links: 4\r\nAccess: (0755/drwxr-xr-x)  Uid: ( )   Gid: ( )\r\nAccess: 2024-03-18 10:52:47.214611868 +0100\r\nModify: 2024-03-18 10:52:47.210611802 +0100\r\nChange: 2024-03-18 10:52:47.210611802 +0100\r\nBirth: 2024-03-18 10:49:38.239446336 +0100\r\n```\n\n### Which category does this issue belong to?\n\nExternal Dependency\n\n### What's the simplest, easiest way to reproduce this bug? Please provide a minimal example if possible.\n\n\nIt is a race condition, haven't been able to reproduce locally but I see in the logs that it happens daily.\n\n### Which operating system are you running Bazel on?\n\n\nLinux\n\n### What is the output of `bazel info release`?\n\n\nrelease 7.1.0rc2 (patched)\n\n### If `bazel info release` returns `development version` or `(@non-git)`, tell us how you built Bazel.\n\n\nSome internal patches unrelated to repository handling.\n\n### What's the output of `git remote get-url origin; git rev-parse HEAD` ?\n\n\n_No response_\n\n### Is this a regression? If yes, please try to identify the Bazel commit where the bug was introduced.\n\n\n_No response_\n\n### Have you found anything relevant by searching the web?\n\nNo\n\n### Any other information, logs, or outputs that you want to share?\n\n_No response_","closed_by":{"login":"copybara-service[bot]","id":56741989,"node_id":"MDM6Qm90NTY3NDE5ODk=","avatar_url":"https://avatars.githubusercontent.com/in/44061?v=4","gravatar_id":"","url":"https://api.github.com/users/copybara-service%5Bbot%5D","html_url":"https://github.com/apps/copybara-service","followers_url":"https://api.github.com/users/copybara-service%5Bbot%5D/followers","following_url":"https://api.github.com/users/copybara-service%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/copybara-service%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/copybara-service%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/copybara-service%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/copybara-service%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/copybara-service%5Bbot%5D/repos","events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/21773/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bazelbuild/bazel/issues/21773/timeline","performed_via_github_app":null,"state_reason":"completed"}