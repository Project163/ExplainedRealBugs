{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/22912","repository_url":"https://api.github.com/repos/bazelbuild/bazel","labels_url":"https://api.github.com/repos/bazelbuild/bazel/issues/22912/labels{/name}","comments_url":"https://api.github.com/repos/bazelbuild/bazel/issues/22912/comments","events_url":"https://api.github.com/repos/bazelbuild/bazel/issues/22912/events","html_url":"https://github.com/bazelbuild/bazel/issues/22912","id":2379255735,"node_id":"I_kwDOATz7jc6N0I-3","number":22912,"title":"extra_toolchains precedence not respected when duplicates occur","user":{"login":"rickeylev","id":34175098,"node_id":"MDQ6VXNlcjM0MTc1MDk4","avatar_url":"https://avatars.githubusercontent.com/u/34175098?v=4","gravatar_id":"","url":"https://api.github.com/users/rickeylev","html_url":"https://github.com/rickeylev","followers_url":"https://api.github.com/users/rickeylev/followers","following_url":"https://api.github.com/users/rickeylev/following{/other_user}","gists_url":"https://api.github.com/users/rickeylev/gists{/gist_id}","starred_url":"https://api.github.com/users/rickeylev/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rickeylev/subscriptions","organizations_url":"https://api.github.com/users/rickeylev/orgs","repos_url":"https://api.github.com/users/rickeylev/repos","events_url":"https://api.github.com/users/rickeylev/events{/privacy}","received_events_url":"https://api.github.com/users/rickeylev/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":106503259,"node_id":"MDU6TGFiZWwxMDY1MDMyNTk=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/type:%20bug","name":"type: bug","color":"0052cc","default":false,"description":null},{"id":192364170,"node_id":"MDU6TGFiZWwxOTIzNjQxNzA=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/P2","name":"P2","color":"e99695","default":false,"description":"We'll consider working on this in future. (Assignee optional)"},{"id":1020660688,"node_id":"MDU6TGFiZWwxMDIwNjYwNjg4","url":"https://api.github.com/repos/bazelbuild/bazel/labels/team-Configurability","name":"team-Configurability","color":"f1f442","default":false,"description":"platforms, toolchains, cquery, select(), config transitions"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2024-06-27T23:31:10Z","updated_at":"2024-10-11T21:06:05Z","closed_at":"2024-07-24T21:17:04Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description of the bug:\n\n\nPer https://github.com/bazelbuild/bazel/issues/19945, it was decided that elements later in the `--extra_toolchains` list should have higher precedence. This mostly works, but seems to regress when there are duplicates of a target in the list. When that happens, the _first_ position of a target takes precedence instead of the last.\r\n\r\nThis isn't too big a deal, but does makes having a `--extra_toolchains` value with consistent behavior between Bazel 6 and Bazel 7 a bit of a pain. Specifically, there isn't a single list that can get the desired behavior in both versions. For example, lets say we have two toolchain targets, `//a:all` and `//b:all`. We want to always use `b`.\r\n\r\n```\r\nextra_toolchains=[a, b]\r\nBazel 6: picks a\r\nBazel 7: picks b\r\n\r\nextra_toolchains=[b, a]\r\nBazel 6: picks b\r\nBazel 7: picks a\r\n\r\nextra_toolchains=[b, a, b]\r\nBazel 6: picks b\r\nBazel 7: picks a  <-- err wait what?\r\n\r\n# Hm, lets repeat the same value in different ways...\r\nextra_toolchains=[a, b, a]\r\nBazel 6: picks a\r\nBazel 7: picks b\r\n\r\nextra_toolchains=[a, b, a, b]\r\nBazel 6: picks a\r\nBazel 7: picks b\r\n```\r\n\r\nSo yeah, it seems like the first position in the list determines the final position when iterating. This smells very much like LinkedHashSet (first added is iteration order), or depset (first iterated upon is yielded, subsequents are ignored) doing something, somewhere.\r\n\r\nI skimmed through the RegisterToolchainsFunction.java code, but nothing in particular stuck out to me.\r\n\r\ncc @katre \n\n### Which category does this issue belong to?\n\nConfigurability\n\n### What's the simplest, easiest way to reproduce this bug? Please provide a minimal example if possible.\n\n\nPass the same toolchain twice using `--extra_toolchains`. Bazel 7 won't respect the \"last has priority\" as described in https://github.com/bazelbuild/bazel/issues/19945\r\n\r\nI can put together a repro tonight.\n\n### Which operating system are you running Bazel on?\n\n\nlinux\n\n### What is the output of `bazel info release`?\n\n\n7.2.1\n\n### If `bazel info release` returns `development version` or `(@non-git)`, tell us how you built Bazel.\n\n\n_No response_\n\n### What's the output of `git remote get-url origin; git rev-parse HEAD` ?\n\n\n_No response_\n\n### If this is a regression, please try to identify the Bazel commit where the bug was introduced with bazelisk --bisect.\n\n\nNot quite a regression, but https://github.com/bazelbuild/bazel/commit/75f8017ba3a87da4f593e37f0eb8f333b330d95c from https://github.com/bazelbuild/bazel/issues/19945 is related\n\n### Have you found anything relevant by searching the web?\n\nhttps://github.com/bazelbuild/bazel/issues/19945 \n\n### Any other information, logs, or outputs that you want to share?\n\n_No response_","closed_by":{"login":"copybara-service[bot]","id":56741989,"node_id":"MDM6Qm90NTY3NDE5ODk=","avatar_url":"https://avatars.githubusercontent.com/in/44061?v=4","gravatar_id":"","url":"https://api.github.com/users/copybara-service%5Bbot%5D","html_url":"https://github.com/apps/copybara-service","followers_url":"https://api.github.com/users/copybara-service%5Bbot%5D/followers","following_url":"https://api.github.com/users/copybara-service%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/copybara-service%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/copybara-service%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/copybara-service%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/copybara-service%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/copybara-service%5Bbot%5D/repos","events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/22912/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bazelbuild/bazel/issues/22912/timeline","performed_via_github_app":null,"state_reason":"completed"}