{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/22996","repository_url":"https://api.github.com/repos/bazelbuild/bazel","labels_url":"https://api.github.com/repos/bazelbuild/bazel/issues/22996/labels{/name}","comments_url":"https://api.github.com/repos/bazelbuild/bazel/issues/22996/comments","events_url":"https://api.github.com/repos/bazelbuild/bazel/issues/22996/events","html_url":"https://github.com/bazelbuild/bazel/issues/22996","id":2403905206,"node_id":"I_kwDOATz7jc6PSK62","number":22996,"title":"Adding a `cc_library` to the `constraint_values` of a `platform` causes a crash","user":{"login":"tpudlik","id":4148295,"node_id":"MDQ6VXNlcjQxNDgyOTU=","avatar_url":"https://avatars.githubusercontent.com/u/4148295?v=4","gravatar_id":"","url":"https://api.github.com/users/tpudlik","html_url":"https://github.com/tpudlik","followers_url":"https://api.github.com/users/tpudlik/followers","following_url":"https://api.github.com/users/tpudlik/following{/other_user}","gists_url":"https://api.github.com/users/tpudlik/gists{/gist_id}","starred_url":"https://api.github.com/users/tpudlik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tpudlik/subscriptions","organizations_url":"https://api.github.com/users/tpudlik/orgs","repos_url":"https://api.github.com/users/tpudlik/repos","events_url":"https://api.github.com/users/tpudlik/events{/privacy}","received_events_url":"https://api.github.com/users/tpudlik/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":106503259,"node_id":"MDU6TGFiZWwxMDY1MDMyNTk=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/type:%20bug","name":"type: bug","color":"0052cc","default":false,"description":null},{"id":1020660688,"node_id":"MDU6TGFiZWwxMDIwNjYwNjg4","url":"https://api.github.com/repos/bazelbuild/bazel/labels/team-Configurability","name":"team-Configurability","color":"f1f442","default":false,"description":"platforms, toolchains, cquery, select(), config transitions"},{"id":1020665933,"node_id":"MDU6TGFiZWwxMDIwNjY1OTMz","url":"https://api.github.com/repos/bazelbuild/bazel/labels/untriaged","name":"untriaged","color":"c34ddd","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"katre","id":326527,"node_id":"MDQ6VXNlcjMyNjUyNw==","avatar_url":"https://avatars.githubusercontent.com/u/326527?v=4","gravatar_id":"","url":"https://api.github.com/users/katre","html_url":"https://github.com/katre","followers_url":"https://api.github.com/users/katre/followers","following_url":"https://api.github.com/users/katre/following{/other_user}","gists_url":"https://api.github.com/users/katre/gists{/gist_id}","starred_url":"https://api.github.com/users/katre/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/katre/subscriptions","organizations_url":"https://api.github.com/users/katre/orgs","repos_url":"https://api.github.com/users/katre/repos","events_url":"https://api.github.com/users/katre/events{/privacy}","received_events_url":"https://api.github.com/users/katre/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"katre","id":326527,"node_id":"MDQ6VXNlcjMyNjUyNw==","avatar_url":"https://avatars.githubusercontent.com/u/326527?v=4","gravatar_id":"","url":"https://api.github.com/users/katre","html_url":"https://github.com/katre","followers_url":"https://api.github.com/users/katre/followers","following_url":"https://api.github.com/users/katre/following{/other_user}","gists_url":"https://api.github.com/users/katre/gists{/gist_id}","starred_url":"https://api.github.com/users/katre/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/katre/subscriptions","organizations_url":"https://api.github.com/users/katre/orgs","repos_url":"https://api.github.com/users/katre/repos","events_url":"https://api.github.com/users/katre/events{/privacy}","received_events_url":"https://api.github.com/users/katre/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":9,"created_at":"2024-07-11T19:09:24Z","updated_at":"2024-07-26T21:06:35Z","closed_at":"2024-07-26T21:06:35Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description of the bug:\n\n\nOn Bazel 8.0.0-pre.20240618.2, adding a `cc_library` to the `constraint_values` of a `platform` causes Bazel to crash with an unhelpful error message:\r\n\r\n```\r\njava.lang.IllegalStateException: java.lang.RuntimeException: Unrecoverable error while evaluating node 'ConfiguredTargetKey{label=//:library, config=BuildConfigurationKey[6f97ef646cfec4f33129d2a43267b717f71213ca1cec09d0d350528022f27781]}' (requested by nodes 'ConfiguredTargetKey{label=//:platform, config=BuildConfigurationKey[6f97ef646cfec4f33129d2a43267b717f71213ca1cec09d0d350528022f27781]}')                            \r\n        at com.google.devtools.build.lib.skyframe.SkyframeExecutor.evaluateSkyKeys(SkyframeExecutor.java:1996)                                                                                                                                                                                                                                                                                                                          \r\n        at com.google.devtools.build.lib.skyframe.SkyframeExecutor.evaluateSkyKeys(SkyframeExecutor.java:1972)                                                                                                                                                                                                                                                                                                                          \r\n        at com.google.devtools.build.lib.skyframe.SkyframeExecutor.createBuildConfigurationKey(SkyframeExecutor.java:1928)                                                                                                                                                                                                                                                                                                              \r\n        at com.google.devtools.build.lib.skyframe.SkyframeExecutor.getConfiguration(SkyframeExecutor.java:1852)                                                                                                                                                                                                                                                                                                                         \r\n        at com.google.devtools.build.lib.skyframe.SkyframeExecutor.createConfiguration(SkyframeExecutor.java:1608)                                                                                                                                                                                                                                                                                                                      \r\n        at com.google.devtools.build.lib.analysis.BuildView.update(BuildView.java:258)                                                                                                                                                                                                                                                                                                                                                  \r\n        at com.google.devtools.build.lib.buildtool.AnalysisAndExecutionPhaseRunner.runAnalysisAndExecutionPhase(AnalysisAndExecutionPhaseRunner.java:227)                                                                                                                                                                                                                                                                               \r\n        at com.google.devtools.build.lib.buildtool.AnalysisAndExecutionPhaseRunner.execute(AnalysisAndExecutionPhaseRunner.java:125)                                                                                                                                                                                                                                                                                                    \r\n        at com.google.devtools.build.lib.buildtool.BuildTool.buildTargetsWithMergedAnalysisExecution(BuildTool.java:358)                                                                                                                                                                                                                                                                                                                \r\n        at com.google.devtools.build.lib.buildtool.BuildTool.buildTargets(BuildTool.java:197)                                                                                                                                                                                                                                                                                                                                           \r\n        at com.google.devtools.build.lib.buildtool.BuildTool.processRequest(BuildTool.java:543)                                                                                                                                                                                                                                                                                                                                         \r\n        at com.google.devtools.build.lib.buildtool.BuildTool.processRequest(BuildTool.java:511)                                                                                                                                                                                                                                                                                                                                         \r\n        at com.google.devtools.build.lib.runtime.commands.BuildCommand.exec(BuildCommand.java:105)                                                                                                                                                                                                                                                                                                                                      \r\n        at com.google.devtools.build.lib.runtime.BlazeCommandDispatcher.execExclusively(BlazeCommandDispatcher.java:683)                                                                                                                                                                                                                                                                                                                \r\n        at com.google.devtools.build.lib.runtime.BlazeCommandDispatcher.exec(BlazeCommandDispatcher.java:252)                                                                                                                                                                                                                                                                                                                           \r\n        at com.google.devtools.build.lib.server.GrpcServerImpl.executeCommand(GrpcServerImpl.java:607)                                                                                                                                                                                                                                                                                                                                  \r\n        at com.google.devtools.build.lib.server.GrpcServerImpl.lambda$run$1(GrpcServerImpl.java:676)                                                                                                                                                                                                                                                                                                                                    \r\n        at io.grpc.Context$1.run(Context.java:566)                                                                                                                                                                                                                                                                                                                                                                                      \r\n        at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(Unknown Source)                                                                                                                                                                                                                                                                                                                                                  \r\n        at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)                                                                                                                                                                                                                                                                                                                                                 \r\n        at java.base/java.lang.Thread.run(Unknown Source)                                                                                                                                                                                                                                                                                                                                                                               \r\nCaused by: java.lang.RuntimeException: Unrecoverable error while evaluating node 'ConfiguredTargetKey{label=//:library, config=BuildConfigurationKey[6f97ef646cfec4f33129d2a43267b717f71213ca1cec09d0d350528022f27781]}' (requested by nodes 'ConfiguredTargetKey{label=//:platform, config=BuildConfigurationKey[6f97ef646cfec4f33129d2a43267b717f71213ca1cec09d0d350528022f27781]}')                                                  \r\n        at com.google.devtools.build.skyframe.AbstractParallelEvaluator$Evaluate.run(AbstractParallelEvaluator.java:557)                                                                                                                                                                                                                                                                                                                \r\n        at com.google.devtools.build.lib.concurrent.AbstractQueueVisitor$WrappedRunnable.run(AbstractQueueVisitor.java:426)                                                                                                                                                                                                                                                                                                             \r\n        at java.base/java.util.concurrent.ForkJoinTask$AdaptedRunnableAction.exec(Unknown Source)                                                                                                                                                                                                                                                                                                                                       \r\n        at java.base/java.util.concurrent.ForkJoinTask.doExec(Unknown Source)                                                                                                                                                                                                                                                                                                                                                           \r\n        at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(Unknown Source)                                                                                                                                                                                                                                                                                                                                           \r\n        at java.base/java.util.concurrent.ForkJoinPool.scan(Unknown Source)                                                                                                                                                                                                                                                                                                                                                             \r\n        at java.base/java.util.concurrent.ForkJoinPool.runWorker(Unknown Source)                                                                                                                                                                                                                                                                                                                                                        \r\n        at java.base/java.util.concurrent.ForkJoinWorkerThread.run(Unknown Source)                                                                                                                                                                                                                                                                                                                                                      \r\nCaused by: com.google.common.base.VerifyException: expected a Starlark exec transition definition                                                                                                                                                                                                                                                                                                                                       \r\n        at com.google.common.base.Verify.verifyNotNull(Verify.java:503)                                                                                                                                                                                                                                                                                                                                                                 \r\n        at com.google.devtools.build.lib.analysis.config.ExecutionTransitionFactory.create(ExecutionTransitionFactory.java:99)                                                                                                                                                                                                                                                                                                          \r\n        at com.google.devtools.build.lib.analysis.config.ExecutionTransitionFactory.create(ExecutionTransitionFactory.java:50)                                                                                                                                                                                                                                                                                                          \r\n        at com.google.devtools.build.lib.analysis.producers.DependencyProducer.step(DependencyProducer.java:175)                                                                                                                                                                                                                                                                                                                        \r\n        at com.google.devtools.build.skyframe.state.TaskTreeNode.run(TaskTreeNode.java:94)                                                                                                                                                                                                                                                                                                                                              \r\n        at com.google.devtools.build.skyframe.state.Driver.drive(Driver.java:87)                                                                                                                                                                                                                                                                                                                                                        \r\n        at com.google.devtools.build.lib.skyframe.DependencyResolver.computeDependencies(DependencyResolver.java:663)                                                                                                                                                                                                                                                                                                                   \r\n        at com.google.devtools.build.lib.skyframe.DependencyResolver.evaluate(DependencyResolver.java:391)                                                                                                                                                                                                                                                                                                                              \r\n        at com.google.devtools.build.lib.skyframe.ConfiguredTargetFunction.compute(ConfiguredTargetFunction.java:265)                                                                                                                                                                                                                                                                                                                   \r\n        at com.google.devtools.build.skyframe.AbstractParallelEvaluator$Evaluate.run(AbstractParallelEvaluator.java:468)\r\n```\r\n\r\n@katre \n\n### Which category does this issue belong to?\n\nConfigurability\n\n### What's the simplest, easiest way to reproduce this bug? Please provide a minimal example if possible.\n\n\nMinimal example: https://github.com/tpudlik/constraint_value_crash.\n\n### Which operating system are you running Bazel on?\n\n\nLinux\n\n### What is the output of `bazel info release`?\n\n\nrelease 8.0.0-pre.20240618.2\n\n### If `bazel info release` returns `development version` or `(@non-git)`, tell us how you built Bazel.\n\n\n_No response_\n\n### What's the output of `git remote get-url origin; git rev-parse HEAD` ?\n\n\n_No response_\n\n### If this is a regression, please try to identify the Bazel commit where the bug was introduced with bazelisk --bisect.\n\n\nKind of? On Bazel 7.2.1 I get an error instead of a crash:\r\n\r\n```\r\nERROR: /usr/local/google/home/tpudlik/.cache/bazel/_bazel_tpudlik/259e376b1fd08ce7249a45dd7f913f12/external/bazel_tools/src/conditions/BUILD:145:27: in config_setting rule @@bazel_tools//src/conditions:host_windows_arm64_constraint: all rules of type config_setting require the presence of all of [PlatformConfiguration], but these were all disabled in configuration ab8cba103302292a2b1ba4f5816adc45d4e4bc4d1f3a0e0ddbfd94da0\r\nf3bd83b                                                                                                                                                                                                                                                                                                                                                                                                                                 \r\nERROR: /usr/local/google/home/tpudlik/.cache/bazel/_bazel_tpudlik/259e376b1fd08ce7249a45dd7f913f12/external/bazel_tools/src/conditions/BUILD:145:27: Analysis of target '@@bazel_tools//src/conditions:host_windows_arm64_constraint' failed                                                                                                                                                                                            \r\nERROR: /usr/local/google/home/tpudlik/.cache/bazel/_bazel_tpudlik/259e376b1fd08ce7249a45dd7f913f12/external/bazel_tools/src/conditions/BUILD:145:27: errors encountered resolving select() keys for @@bazel_tools//src/conditions:host_windows                                                                                                                                                                                          \r\nERROR: /usr/local/google/home/tpudlik/.cache/bazel/_bazel_tpudlik/259e376b1fd08ce7249a45dd7f913f12/external/bazel_tools/tools/def_parser/BUILD:11:10: errors encountered resolving select() keys for @@bazel_tools//tools/def_parser:def_parser                                                                                                                                                                                         \r\nERROR: /usr/local/google/home/tpudlik/src/constraint_value_crash/BUILD.bazel:14:10: Target //:platform was referenced as a platform, but does not provide PlatformInfo                                                                                                                                                                                                                                                                  \r\nERROR: Analysis of target '//:binary' failed; build aborted                                                                                                                                                                                                                                                                                                                                                                             \r\nINFO: Elapsed time: 0.181s, Critical Path: 0.00s                                                                                                                                                                                                                                                                                                                                                                                        \r\nINFO: 1 process: 1 internal.                                                                                                                                                                                                                                                                                                                                                                                                            \r\nERROR: Build did NOT complete successfully \r\n```\r\n\r\nThis error is not especially informative, but at least it suggests the problem is with the `platform`, somehow.\n\n### Have you found anything relevant by searching the web?\n\n_No response_\n\n### Any other information, logs, or outputs that you want to share?\n\n_No response_","closed_by":{"login":"copybara-service[bot]","id":56741989,"node_id":"MDM6Qm90NTY3NDE5ODk=","avatar_url":"https://avatars.githubusercontent.com/in/44061?v=4","gravatar_id":"","url":"https://api.github.com/users/copybara-service%5Bbot%5D","html_url":"https://github.com/apps/copybara-service","followers_url":"https://api.github.com/users/copybara-service%5Bbot%5D/followers","following_url":"https://api.github.com/users/copybara-service%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/copybara-service%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/copybara-service%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/copybara-service%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/copybara-service%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/copybara-service%5Bbot%5D/repos","events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/22996/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bazelbuild/bazel/issues/22996/timeline","performed_via_github_app":null,"state_reason":"completed"}