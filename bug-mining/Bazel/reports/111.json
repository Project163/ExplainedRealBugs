{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/20415","repository_url":"https://api.github.com/repos/bazelbuild/bazel","labels_url":"https://api.github.com/repos/bazelbuild/bazel/issues/20415/labels{/name}","comments_url":"https://api.github.com/repos/bazelbuild/bazel/issues/20415/comments","events_url":"https://api.github.com/repos/bazelbuild/bazel/issues/20415/events","html_url":"https://github.com/bazelbuild/bazel/issues/20415","id":2022070896,"node_id":"I_kwDOATz7jc54hlpw","number":20415,"title":"\"Cannot get node id for DirectoryArtifactValue\" on tree artifact containing symlink to directory + remote cache + BES","user":{"login":"tjgq","id":4370077,"node_id":"MDQ6VXNlcjQzNzAwNzc=","avatar_url":"https://avatars.githubusercontent.com/u/4370077?v=4","gravatar_id":"","url":"https://api.github.com/users/tjgq","html_url":"https://github.com/tjgq","followers_url":"https://api.github.com/users/tjgq/followers","following_url":"https://api.github.com/users/tjgq/following{/other_user}","gists_url":"https://api.github.com/users/tjgq/gists{/gist_id}","starred_url":"https://api.github.com/users/tjgq/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tjgq/subscriptions","organizations_url":"https://api.github.com/users/tjgq/orgs","repos_url":"https://api.github.com/users/tjgq/repos","events_url":"https://api.github.com/users/tjgq/events{/privacy}","received_events_url":"https://api.github.com/users/tjgq/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":106503259,"node_id":"MDU6TGFiZWwxMDY1MDMyNTk=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/type:%20bug","name":"type: bug","color":"0052cc","default":false,"description":null},{"id":1020665933,"node_id":"MDU6TGFiZWwxMDIwNjY1OTMz","url":"https://api.github.com/repos/bazelbuild/bazel/labels/untriaged","name":"untriaged","color":"c34ddd","default":false,"description":""},{"id":1193207358,"node_id":"MDU6TGFiZWwxMTkzMjA3MzU4","url":"https://api.github.com/repos/bazelbuild/bazel/labels/team-Remote-Exec","name":"team-Remote-Exec","color":"f1f442","default":false,"description":"Issues and PRs for the Execution (Remote) team"}],"state":"closed","locked":false,"assignee":{"login":"tjgq","id":4370077,"node_id":"MDQ6VXNlcjQzNzAwNzc=","avatar_url":"https://avatars.githubusercontent.com/u/4370077?v=4","gravatar_id":"","url":"https://api.github.com/users/tjgq","html_url":"https://github.com/tjgq","followers_url":"https://api.github.com/users/tjgq/followers","following_url":"https://api.github.com/users/tjgq/following{/other_user}","gists_url":"https://api.github.com/users/tjgq/gists{/gist_id}","starred_url":"https://api.github.com/users/tjgq/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tjgq/subscriptions","organizations_url":"https://api.github.com/users/tjgq/orgs","repos_url":"https://api.github.com/users/tjgq/repos","events_url":"https://api.github.com/users/tjgq/events{/privacy}","received_events_url":"https://api.github.com/users/tjgq/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"tjgq","id":4370077,"node_id":"MDQ6VXNlcjQzNzAwNzc=","avatar_url":"https://avatars.githubusercontent.com/u/4370077?v=4","gravatar_id":"","url":"https://api.github.com/users/tjgq","html_url":"https://github.com/tjgq","followers_url":"https://api.github.com/users/tjgq/followers","following_url":"https://api.github.com/users/tjgq/following{/other_user}","gists_url":"https://api.github.com/users/tjgq/gists{/gist_id}","starred_url":"https://api.github.com/users/tjgq/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tjgq/subscriptions","organizations_url":"https://api.github.com/users/tjgq/orgs","repos_url":"https://api.github.com/users/tjgq/repos","events_url":"https://api.github.com/users/tjgq/events{/privacy}","received_events_url":"https://api.github.com/users/tjgq/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":3,"created_at":"2023-12-02T14:56:23Z","updated_at":"2023-12-05T01:31:19Z","closed_at":"2023-12-04T11:10:01Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Repro:\r\n\r\ndefs.bzl\r\n```\r\ndef _impl(ctx):\r\n    d = ctx.actions.declare_directory(ctx.label.name)\r\n    ctx.actions.run_shell(\r\n        outputs = [d],\r\n        command = \"cd $1 && mkdir dir && touch dir/file.txt && ln -s dir sym\",\r\n        arguments = [d.path],\r\n    )\r\n    return DefaultInfo(files = depset([d]))\r\n\r\nbuggy = rule(_impl)\r\n```\r\n\r\nBUILD\r\n```\r\nload(\"//:defs.bzl\", \"buggy\")\r\n\r\nbuggy(\r\n    name = \"buggy\",\r\n)\r\n```\r\n\r\n.bazelrc\r\n```\r\nbuild --remote_instance_name=projects/bazel-untrusted/instances/default_instance\r\nbuild --remote_cache=grpcs://remotebuildexecution.googleapis.com\r\nbuild --remote_download_toplevel\r\nbuild --google_default_credentials\r\nbuild --bes_backend=buildeventservice.googleapis.com\r\nbuild --bes_instance_name=bazel-untrusted\r\nbuild --bes_results_url=https://source.cloud.google.com/results/invocations\r\n```\r\n\r\nBuild once to populate the remote cache, then clean and rebuild. The following stack trace is produced:\r\n\r\n```\r\njava.lang.RuntimeException: Unexpected Exception 'Cannot get node id for DirectoryArtifactValue{mtime=1701528378671}' when closing BEP transports, this is a bug.\r\n\tat com.google.devtools.build.lib.buildeventservice.BuildEventServiceModule.waitForBuildEventTransportsToClose(BuildEventServiceModule.java:543)\r\n\tat com.google.devtools.build.lib.buildeventservice.BuildEventServiceModule.closeBepTransports(BuildEventServiceModule.java:625)\r\n\tat com.google.devtools.build.lib.buildeventservice.BuildEventServiceModule.afterCommand(BuildEventServiceModule.java:640)\r\n\tat com.google.devtools.build.lib.runtime.BlazeRuntime.afterCommand(BlazeRuntime.java:627)\r\n\tat com.google.devtools.build.lib.runtime.BlazeCommandDispatcher.execExclusively(BlazeCommandDispatcher.java:688)\r\n\tat com.google.devtools.build.lib.runtime.BlazeCommandDispatcher.exec(BlazeCommandDispatcher.java:244)\r\n\tat com.google.devtools.build.lib.server.GrpcServerImpl.executeCommand(GrpcServerImpl.java:550)\r\n\tat com.google.devtools.build.lib.server.GrpcServerImpl.lambda$run$1(GrpcServerImpl.java:621)\r\n\tat io.grpc.Context$1.run(Context.java:566)\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(Unknown Source)\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)\r\n\tat java.base/java.lang.Thread.run(Unknown Source)\r\nCaused by: java.util.concurrent.ExecutionException: java.lang.UnsupportedOperationException: Cannot get node id for DirectoryArtifactValue{mtime=1701528378671}\r\n\tat com.google.common.util.concurrent.AbstractFuture.getDoneValue(AbstractFuture.java:592)\r\n\tat com.google.common.util.concurrent.AbstractFuture.get(AbstractFuture.java:571)\r\n\tat com.google.common.util.concurrent.AbstractFuture$TrustedFuture.get(AbstractFuture.java:111)\r\n\tat com.google.common.util.concurrent.Uninterruptibles.getUninterruptibly(Uninterruptibles.java:247)\r\n\tat com.google.devtools.build.lib.buildeventservice.BuildEventServiceModule.waitForBuildEventTransportsToClose(BuildEventServiceModule.java:529)\r\n\t... 11 more\r\nCaused by: java.lang.UnsupportedOperationException: Cannot get node id for DirectoryArtifactValue{mtime=1701528378671}\r\n\tat com.google.devtools.build.lib.remote.RemoteActionFileSystem$2.getNodeId(RemoteActionFileSystem.java:665)\r\n\tat com.google.devtools.build.lib.vfs.DigestUtils$CacheKey.<init>(DigestUtils.java:67)\r\n\tat com.google.devtools.build.lib.vfs.DigestUtils.manuallyComputeDigest(DigestUtils.java:193)\r\n\tat com.google.devtools.build.lib.vfs.DigestUtils.getDigestWithManualFallback(DigestUtils.java:160)\r\n\tat com.google.devtools.build.lib.remote.util.DigestUtil.compute(DigestUtil.java:72)\r\n\tat com.google.devtools.build.lib.remote.util.DigestUtil.compute(DigestUtil.java:67)\r\n\tat com.google.devtools.build.lib.remote.ByteStreamBuildEventArtifactUploader.readPathMetadata(ByteStreamBuildEventArtifactUploader.java:239)\r\n\tat com.google.devtools.build.lib.remote.ByteStreamBuildEventArtifactUploader.lambda$doUpload$8(ByteStreamBuildEventArtifactUploader.java:413)\r\n\tat io.reactivex.rxjava3.internal.operators.flowable.FlowableMap$MapSubscriber.onNext(FlowableMap.java:64)\r\n\tat io.reactivex.rxjava3.internal.operators.flowable.FlowableFromIterable$IteratorSubscription.fastPath(FlowableFromIterable.java:185)\r\n\tat io.reactivex.rxjava3.internal.operators.flowable.FlowableFromIterable$BaseRangeSubscription.request(FlowableFromIterable.java:129)\r\n\tat io.reactivex.rxjava3.internal.subscribers.BasicFuseableSubscriber.request(BasicFuseableSubscriber.java:153)\r\n\tat io.reactivex.rxjava3.internal.jdk8.FlowableCollectWithCollectorSingle$CollectorSingleObserver.onSubscribe(FlowableCollectWithCollectorSingle.java:102)\r\n\tat io.reactivex.rxjava3.internal.subscribers.BasicFuseableSubscriber.onSubscribe(BasicFuseableSubscriber.java:67)\r\n\tat io.reactivex.rxjava3.internal.operators.flowable.FlowableFromIterable.subscribe(FlowableFromIterable.java:69)\r\n\tat io.reactivex.rxjava3.internal.operators.flowable.FlowableFromIterable.subscribeActual(FlowableFromIterable.java:47)\r\n\tat io.reactivex.rxjava3.core.Flowable.subscribe(Flowable.java:15917)\r\n\tat io.reactivex.rxjava3.internal.operators.flowable.FlowableMap.subscribeActual(FlowableMap.java:38)\r\n\tat io.reactivex.rxjava3.core.Flowable.subscribe(Flowable.java:15917)\r\n\tat io.reactivex.rxjava3.internal.jdk8.FlowableCollectWithCollectorSingle.subscribeActual(FlowableCollectWithCollectorSingle.java:71)\r\n\tat io.reactivex.rxjava3.core.Single.subscribe(Single.java:4855)\r\n\tat io.reactivex.rxjava3.internal.operators.single.SingleFlatMap.subscribeActual(SingleFlatMap.java:37)\r\n\tat io.reactivex.rxjava3.core.Single.subscribe(Single.java:4855)\r\n\tat io.reactivex.rxjava3.internal.operators.single.SingleFlatMap.subscribeActual(SingleFlatMap.java:37)\r\n\tat io.reactivex.rxjava3.core.Single.subscribe(Single.java:4855)\r\n\tat io.reactivex.rxjava3.internal.operators.single.SingleFlatMap.subscribeActual(SingleFlatMap.java:37)\r\n\tat io.reactivex.rxjava3.core.Single.subscribe(Single.java:4855)\r\n\tat io.reactivex.rxjava3.internal.operators.single.SingleUsing.subscribeActual(SingleUsing.java:83)\r\n\tat io.reactivex.rxjava3.core.Single.subscribe(Single.java:4855)\r\n\tat io.reactivex.rxjava3.internal.operators.single.SingleSubscribeOn$SubscribeOnObserver.run(SingleSubscribeOn.java:89)\r\n\tat io.reactivex.rxjava3.internal.schedulers.ScheduledDirectTask.call(ScheduledDirectTask.java:38)\r\n\tat io.reactivex.rxjava3.internal.schedulers.ScheduledDirectTask.call(ScheduledDirectTask.java:25)\r\n\tat java.base/java.util.concurrent.FutureTask.run(Unknown Source)\r\n\t... 3 more\r\n```\r\n\r\nReproducible on 7.0.0rc5. On 6.4.0 it fails due to a different error, which can be fixed with https://github.com/bazelbuild/bazel/pull/20409. See original report at https://github.com/bazelbuild/bazel/issues/20408.","closed_by":{"login":"copybara-service[bot]","id":56741989,"node_id":"MDM6Qm90NTY3NDE5ODk=","avatar_url":"https://avatars.githubusercontent.com/in/44061?v=4","gravatar_id":"","url":"https://api.github.com/users/copybara-service%5Bbot%5D","html_url":"https://github.com/apps/copybara-service","followers_url":"https://api.github.com/users/copybara-service%5Bbot%5D/followers","following_url":"https://api.github.com/users/copybara-service%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/copybara-service%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/copybara-service%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/copybara-service%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/copybara-service%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/copybara-service%5Bbot%5D/repos","events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/20415/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bazelbuild/bazel/issues/20415/timeline","performed_via_github_app":null,"state_reason":"completed"}