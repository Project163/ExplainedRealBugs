{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/21225","repository_url":"https://api.github.com/repos/bazelbuild/bazel","labels_url":"https://api.github.com/repos/bazelbuild/bazel/issues/21225/labels{/name}","comments_url":"https://api.github.com/repos/bazelbuild/bazel/issues/21225/comments","events_url":"https://api.github.com/repos/bazelbuild/bazel/issues/21225/events","html_url":"https://github.com/bazelbuild/bazel/issues/21225","id":2121683774,"node_id":"I_kwDOATz7jc5-dlM-","number":21225,"title":"Android Platforms does not work with AAR Import ","user":{"login":"ankit-agarwal-ai","id":88336334,"node_id":"MDQ6VXNlcjg4MzM2MzM0","avatar_url":"https://avatars.githubusercontent.com/u/88336334?v=4","gravatar_id":"","url":"https://api.github.com/users/ankit-agarwal-ai","html_url":"https://github.com/ankit-agarwal-ai","followers_url":"https://api.github.com/users/ankit-agarwal-ai/followers","following_url":"https://api.github.com/users/ankit-agarwal-ai/following{/other_user}","gists_url":"https://api.github.com/users/ankit-agarwal-ai/gists{/gist_id}","starred_url":"https://api.github.com/users/ankit-agarwal-ai/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ankit-agarwal-ai/subscriptions","organizations_url":"https://api.github.com/users/ankit-agarwal-ai/orgs","repos_url":"https://api.github.com/users/ankit-agarwal-ai/repos","events_url":"https://api.github.com/users/ankit-agarwal-ai/events{/privacy}","received_events_url":"https://api.github.com/users/ankit-agarwal-ai/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":106503259,"node_id":"MDU6TGFiZWwxMDY1MDMyNTk=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/type:%20bug","name":"type: bug","color":"0052cc","default":false,"description":null},{"id":192364170,"node_id":"MDU6TGFiZWwxOTIzNjQxNzA=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/P2","name":"P2","color":"e99695","default":false,"description":"We'll consider working on this in future. (Assignee optional)"},{"id":1020659120,"node_id":"MDU6TGFiZWwxMDIwNjU5MTIw","url":"https://api.github.com/repos/bazelbuild/bazel/labels/team-Android","name":"team-Android","color":"f1f442","default":false,"description":"Issues for Android team"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2024-02-06T21:19:09Z","updated_at":"2024-03-07T20:01:36Z","closed_at":"2024-02-26T23:49:20Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description of the bug:\r\n\r\n\r\n\r\nHi, all.\r\n\r\nWe recently upgraded to bazel 7.0.2 which according to this post, enabled android platforms for use: https://blog.bazel.build/2023/11/15/android-platforms.html\r\n\r\nI am cross compiling android apps with the following bazel rc flags:\r\n\r\n```\r\ncommon --incompatible_enable_android_toolchain_resolution\r\ncommon --android_platforms=//:arm64_android_ndk\r\nbuild --@io_bazel_rules_kotlin//kotlin/settings:jvm_emit_jdeps=False\r\n```\r\n\r\nI am noticing an issue with a maven dependency: \r\n\r\n```\r\n        \"com.github.gkonovalov.android-vad:webrtc:2.0.6\",\r\n```\r\n\r\nThis command below: \r\n\r\n```\r\n\r\ncd /home/ankit/.cache/bazel/_bazel_ankit/7bf1254182ebae36d2817c38fe27106c/sandbox/linux-sandbox/7401/execroot/mosaic && \\\r\n  exec env - \\\r\n    GTEST_COLOR=1 \\\r\n    INVALIDATE_BAZEL_CACHE_COUNTER=4 \\\r\n    PATH=/bin:/usr/bin:/usr/local/bin \\\r\n    TMPDIR=/tmp \\\r\n  /home/ankit/.cache/bazel/_bazel_ankit/install/14fb027596f626f2526df4873ea20b8b/linux-sandbox -t 15 -w /dev/shm -w /home/ankit/.cache/bazel/_bazel_ankit/7bf1254182ebae36d2817c38fe27106c/sandbox/linux-sandbox/7401/execroot/mosaic -w /opt/.qnx -w /tmp -e /tmp -S /home/ankit/.cache/bazel/_bazel_ankit/7bf1254182ebae36d2817c38fe27106c/sandbox/linux-sandbox/7401/stats.out -N -D /home/ankit/.cache/bazel/_bazel_ankit/7bf1254182ebae36d2817c38fe27106c/sandbox/linux-sandbox/7401/debug.out -- bazel-out/linux_x86_64_platform-opt-exec/bin/external/bazel_tools/tools/android/aar_native_libs_zip_creator --input_aar external/maven/v1/https/jitpack.io/com/github/gkonovalov/android-vad/webrtc/2.0.6/webrtc-2.0.6.aar --cpu k8 --output_zip bazel-out/arm64_android_ndk-fastbuild-android-ST-8b67b3e599b1/bin/external/maven/_aar/com_github_gkonovalov_android_vad_webrtc/native_libs.zip\r\n\r\n```\r\n\r\nfails to compile with the following error; \r\n\r\n```\r\nAAR external/maven/v1/https/jitpack.io/com/github/gkonovalov/android-vad/webrtc/2.0.6/webrtc-2.0.6.aar missing native libs for requested architecture: k8\r\n\r\n```\r\n\r\nIt looks like the offending line is the --cpu k8, and indeed when I cd'd into the bazel sandbox and ran the command with --cpu arm64-v8a it ran without error. I tracked down the offending line to:\r\n\r\nhttps://github.com/bazelbuild/bazel/blob/224d642a165c16eb0688168e2510b35c9beb5ef0/src/main/java/com/google/devtools/build/lib/rules/android/AarImport.java#L440\r\n\r\nMy code does work with the following bazelrc and platform mappings flags (e.g we have a workaround)\r\n\r\n```\r\ncommon --noincompatible_enable_android_toolchain_resolution\r\nbuild --platform_mappings=tools/build/bazel.rc.d/platform_mappings\r\nbuild --fat_apk_cpu arm64-v8a\r\n# Uncomment the below lines to build for x86\r\n# build --fat_apk_cpu x86_64\r\nbuild --android_crosstool_top=@androidndk//:toolchain\r\nbuild --@io_bazel_rules_kotlin//kotlin/settings:jvm_emit_jdeps=False\r\n```\r\n\r\nPlatform mappings \r\n```\r\nflags:\r\n    # Android\r\n    # Mostly, native code is compiled after the android_binary rule has run a transition to compile for that platform.\r\n    # We just detect the transition, which sets \"Android configuration distinguisher\", and then translate the CPU it set.\r\n    --Android configuration distinguisher=android\r\n    --cpu=arm64-v8a\r\n        //:arm64_android_ndk\r\n    --Android configuration distinguisher=android\r\n    --cpu=x86_64\r\n        //:x86_64_android_ndk\r\n```\r\n\r\nWe're hoping to get rid of this code soon, so wondering if I am missing something here. \r\n\r\nWe actually ran into this when we were on a bazel 7 pre-release and reported an issue here: https://github.com/bazelbuild/rules_android_ndk/issues/39\r\n\r\nThanks in advance! \r\n\r\n\r\n\r\n### Which category does this issue belong to?\r\n\r\nAndroid\r\n\r\n### What's the simplest, easiest way to reproduce this bug? Please provide a minimal example if possible.\r\n\r\n\r\nOn bazel 7, use android platforms, and attempt to compile the maven dependency: \r\n\r\n\r\n\r\n```\r\n        \"com.github.gkonovalov.android-vad:webrtc:2.0.6\",\r\n```\r\n\r\n\r\n### Which operating system are you running Bazel on?\r\n\r\n\r\nLinux\r\n\r\n### What is the output of `bazel info release`?\r\n\r\n\r\nrelease 7.0.2\r\n\r\n### If `bazel info release` returns `development version` or `(@non-git)`, tell us how you built Bazel.\r\n\r\n\r\n_No response_\r\n\r\n### What's the output of `git remote get-url origin; git rev-parse HEAD` ?\r\n\r\n\r\n```text\r\nNot a public repo\r\n```\r\n\r\n\r\n### Is this a regression? If yes, please try to identify the Bazel commit where the bug was introduced.\r\n\r\n\r\nI don't think this is a regression\r\n\r\n### Have you found anything relevant by searching the web?\r\n\r\nWe actually ran into this when we were on a bazel 7 pre-release and reported an issue here: https://github.com/bazelbuild/rules_android_ndk/issues/39\r\n\r\n### Any other information, logs, or outputs that you want to share?\r\n\r\n_No response_","closed_by":{"login":"copybara-service[bot]","id":56741989,"node_id":"MDM6Qm90NTY3NDE5ODk=","avatar_url":"https://avatars.githubusercontent.com/in/44061?v=4","gravatar_id":"","url":"https://api.github.com/users/copybara-service%5Bbot%5D","html_url":"https://github.com/apps/copybara-service","followers_url":"https://api.github.com/users/copybara-service%5Bbot%5D/followers","following_url":"https://api.github.com/users/copybara-service%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/copybara-service%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/copybara-service%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/copybara-service%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/copybara-service%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/copybara-service%5Bbot%5D/repos","events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/21225/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bazelbuild/bazel/issues/21225/timeline","performed_via_github_app":null,"state_reason":"completed"}