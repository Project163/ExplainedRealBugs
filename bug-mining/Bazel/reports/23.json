{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/17663","repository_url":"https://api.github.com/repos/bazelbuild/bazel","labels_url":"https://api.github.com/repos/bazelbuild/bazel/issues/17663/labels{/name}","comments_url":"https://api.github.com/repos/bazelbuild/bazel/issues/17663/comments","events_url":"https://api.github.com/repos/bazelbuild/bazel/issues/17663/events","html_url":"https://github.com/bazelbuild/bazel/issues/17663","id":1609641778,"node_id":"I_kwDOATz7jc5f8S8y","number":17663,"title":"Weird behavior with `alias` and `target_compatible_with`","user":{"login":"tgeng","id":29584386,"node_id":"MDQ6VXNlcjI5NTg0Mzg2","avatar_url":"https://avatars.githubusercontent.com/u/29584386?v=4","gravatar_id":"","url":"https://api.github.com/users/tgeng","html_url":"https://github.com/tgeng","followers_url":"https://api.github.com/users/tgeng/followers","following_url":"https://api.github.com/users/tgeng/following{/other_user}","gists_url":"https://api.github.com/users/tgeng/gists{/gist_id}","starred_url":"https://api.github.com/users/tgeng/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tgeng/subscriptions","organizations_url":"https://api.github.com/users/tgeng/orgs","repos_url":"https://api.github.com/users/tgeng/repos","events_url":"https://api.github.com/users/tgeng/events{/privacy}","received_events_url":"https://api.github.com/users/tgeng/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":106503259,"node_id":"MDU6TGFiZWwxMDY1MDMyNTk=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/type:%20bug","name":"type: bug","color":"0052cc","default":false,"description":null},{"id":192364241,"node_id":"MDU6TGFiZWwxOTIzNjQyNDE=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/P3","name":"P3","color":"fbca04","default":false,"description":"We're not considering working on this, but happy to review a PR. (No assignee)"},{"id":762705960,"node_id":"MDU6TGFiZWw3NjI3MDU5NjA=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/platform:%20apple","name":"platform: apple","color":"7cf9b3","default":false,"description":""},{"id":1020660688,"node_id":"MDU6TGFiZWwxMDIwNjYwNjg4","url":"https://api.github.com/repos/bazelbuild/bazel/labels/team-Configurability","name":"team-Configurability","color":"f1f442","default":false,"description":"platforms, toolchains, cquery, select(), config transitions"}],"state":"closed","locked":false,"assignee":{"login":"gregestren","id":5130366,"node_id":"MDQ6VXNlcjUxMzAzNjY=","avatar_url":"https://avatars.githubusercontent.com/u/5130366?v=4","gravatar_id":"","url":"https://api.github.com/users/gregestren","html_url":"https://github.com/gregestren","followers_url":"https://api.github.com/users/gregestren/followers","following_url":"https://api.github.com/users/gregestren/following{/other_user}","gists_url":"https://api.github.com/users/gregestren/gists{/gist_id}","starred_url":"https://api.github.com/users/gregestren/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gregestren/subscriptions","organizations_url":"https://api.github.com/users/gregestren/orgs","repos_url":"https://api.github.com/users/gregestren/repos","events_url":"https://api.github.com/users/gregestren/events{/privacy}","received_events_url":"https://api.github.com/users/gregestren/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"gregestren","id":5130366,"node_id":"MDQ6VXNlcjUxMzAzNjY=","avatar_url":"https://avatars.githubusercontent.com/u/5130366?v=4","gravatar_id":"","url":"https://api.github.com/users/gregestren","html_url":"https://github.com/gregestren","followers_url":"https://api.github.com/users/gregestren/followers","following_url":"https://api.github.com/users/gregestren/following{/other_user}","gists_url":"https://api.github.com/users/gregestren/gists{/gist_id}","starred_url":"https://api.github.com/users/gregestren/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gregestren/subscriptions","organizations_url":"https://api.github.com/users/gregestren/orgs","repos_url":"https://api.github.com/users/gregestren/repos","events_url":"https://api.github.com/users/gregestren/events{/privacy}","received_events_url":"https://api.github.com/users/gregestren/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":6,"created_at":"2023-03-04T06:42:16Z","updated_at":"2023-04-06T22:05:03Z","closed_at":"2023-04-06T22:05:03Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description of the bug:\n\n\nSetting `target_compatible_with`  on alias does not work as expected. See repro below.\n\n### What's the simplest, easiest way to reproduce this bug? Please provide a minimal example if possible.\n\n\nConsider the following top-level BUILD.bazel file. (full repro [bazel-alias-bug.zip](https://github.com/bazelbuild/bazel/files/10887637/bazel-alias-bug.zip))\r\n```\r\nfilegroup(\r\n  name = \"source\",\r\n  srcs = [\"foo.c\"],\r\n)\r\n\r\nalias(\r\n  name = \"source_alias\",\r\n  actual = \"source\",\r\n  target_compatible_with = [\"@platforms//cpu:x86_64\"],\r\n)\r\n\r\nalias(\r\n  name = \"source_alias2\",\r\n  actual = select({\r\n    \"@platforms//cpu:x86_64\": \"source\",\r\n    \"//conditions:default\": \"source\",\r\n  }),\r\n  target_compatible_with = [\"@platforms//cpu:x86_64\"],\r\n)\r\n\r\ncc_library(\r\n  name = \"foo\",\r\n  srcs = [\"source_alias\"],\r\n)\r\n\r\ncc_library(\r\n  name = \"foo2\",\r\n  srcs = [\"source_alias2\"],\r\n)\r\n```\r\n\r\n`foo` and `foo2` should behave the same. However, on an M1 Mac with Bazel 6.0.0, I have\r\n\r\n```\r\n ~/tmp/bazel_alias_bug  master ───────────────────────────────────────────────────────────────────── system py  22:39:33\r\n> bazel build :foo\r\nINFO: Analyzed target //:foo (0 packages loaded, 0 targets configured).\r\nINFO: Found 1 target...\r\nTarget //:foo up-to-date:\r\n  bazel-bin/libfoo.a\r\nINFO: Elapsed time: 0.081s, Critical Path: 0.00s\r\nINFO: 1 process: 1 internal.\r\nINFO: Build completed successfully, 1 total action\r\n ~/tmp/bazel_alias_bug  master ───────────────────────────────────────────────────────────────────── system py  22:39:34\r\n> bazel build :foo2\r\nERROR: Target //:foo2 is incompatible and cannot be built, but was explicitly requested.\r\nDependency chain:\r\n    //:foo2 (602a7d)\r\n    //:source_alias2 (602a7d)   <-- target platform (@local_config_platform//:host) didn't satisfy constraint @platforms//cpu:x86_64\r\nINFO: Elapsed time: 0.044s\r\nINFO: 0 processes.\r\nFAILED: Build did NOT complete successfully (0 packages loaded, 0 targets configured)\r\n```\r\n\r\nWith Bazel 5.4.0, I have\r\n\r\n```\r\n> bazel build :foo\r\nStarting local Bazel server and connecting to it...\r\nERROR: Target //:foo is incompatible and cannot be built, but was explicitly requested.\r\nDependency chain:\r\n    //:foo\r\n    //:source_alias   <-- target platform (null) didn't satisfy constraint @platforms//cpu:x86_64\r\nINFO: Elapsed time: 7.002s\r\nINFO: 0 processes.\r\nFAILED: Build did NOT complete successfully (38 packages loaded, 263 targets configured)\r\n ~/tmp/bazel_alias_bug  master !1 ────────────────────────────────────────────────────────────── 7s  system py  22:40:16\r\n> bazel build :foo2\r\nERROR: Target //:foo2 is incompatible and cannot be built, but was explicitly requested.\r\nDependency chain:\r\n    //:foo2\r\n    //:source_alias2   <-- target platform (@local_config_platform//:host) didn't satisfy constraint @platforms//cpu:x86_64\r\nINFO: Elapsed time: 0.088s\r\nINFO: 0 processes.\r\nFAILED: Build did NOT complete successfully (0 packages loaded, 2 targets configured)\r\n```\r\n\r\nBehavior of `foo2` is correct in both cases. `foo` is both incorrect in 5.4.0 and 6.0.0.\n\n### Which operating system are you running Bazel on?\n\n\nmacOS\n\n### What is the output of `bazel info release`?\n\n\nrelease 5.4.0 and release 6.0.0\n\n### If `bazel info release` returns `development version` or `(@non-git)`, tell us how you built Bazel.\n\n\n_No response_\n\n### What's the output of `git remote get-url origin; git rev-parse master; git rev-parse HEAD` ?\n\n\n_No response_\n\n### Have you found anything relevant by searching the web?\n\n_No response_\n\n### Any other information, logs, or outputs that you want to share?\n\n_No response_","closed_by":{"login":"copybara-service[bot]","id":56741989,"node_id":"MDM6Qm90NTY3NDE5ODk=","avatar_url":"https://avatars.githubusercontent.com/in/44061?v=4","gravatar_id":"","url":"https://api.github.com/users/copybara-service%5Bbot%5D","html_url":"https://github.com/apps/copybara-service","followers_url":"https://api.github.com/users/copybara-service%5Bbot%5D/followers","following_url":"https://api.github.com/users/copybara-service%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/copybara-service%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/copybara-service%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/copybara-service%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/copybara-service%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/copybara-service%5Bbot%5D/repos","events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/17663/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bazelbuild/bazel/issues/17663/timeline","performed_via_github_app":null,"state_reason":"completed"}