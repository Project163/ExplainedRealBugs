{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/20843","repository_url":"https://api.github.com/repos/bazelbuild/bazel","labels_url":"https://api.github.com/repos/bazelbuild/bazel/issues/20843/labels{/name}","comments_url":"https://api.github.com/repos/bazelbuild/bazel/issues/20843/comments","events_url":"https://api.github.com/repos/bazelbuild/bazel/issues/20843/events","html_url":"https://github.com/bazelbuild/bazel/issues/20843","id":2074773747,"node_id":"I_kwDOATz7jc57qojz","number":20843,"title":"Incremental `bazel run` + BwoB + --noexperimental_check_output_files = slow","user":{"login":"tjgq","id":4370077,"node_id":"MDQ6VXNlcjQzNzAwNzc=","avatar_url":"https://avatars.githubusercontent.com/u/4370077?v=4","gravatar_id":"","url":"https://api.github.com/users/tjgq","html_url":"https://github.com/tjgq","followers_url":"https://api.github.com/users/tjgq/followers","following_url":"https://api.github.com/users/tjgq/following{/other_user}","gists_url":"https://api.github.com/users/tjgq/gists{/gist_id}","starred_url":"https://api.github.com/users/tjgq/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tjgq/subscriptions","organizations_url":"https://api.github.com/users/tjgq/orgs","repos_url":"https://api.github.com/users/tjgq/repos","events_url":"https://api.github.com/users/tjgq/events{/privacy}","received_events_url":"https://api.github.com/users/tjgq/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":106503259,"node_id":"MDU6TGFiZWwxMDY1MDMyNTk=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/type:%20bug","name":"type: bug","color":"0052cc","default":false,"description":null},{"id":1020665933,"node_id":"MDU6TGFiZWwxMDIwNjY1OTMz","url":"https://api.github.com/repos/bazelbuild/bazel/labels/untriaged","name":"untriaged","color":"c34ddd","default":false,"description":""},{"id":1193207358,"node_id":"MDU6TGFiZWwxMTkzMjA3MzU4","url":"https://api.github.com/repos/bazelbuild/bazel/labels/team-Remote-Exec","name":"team-Remote-Exec","color":"f1f442","default":false,"description":"Issues and PRs for the Execution (Remote) team"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2024-01-10T16:50:03Z","updated_at":"2024-11-06T11:45:44Z","closed_at":"2024-11-06T11:45:44Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"This repro was gently provided by @purkhusid in #6862:\r\n\r\nhttps://github.com/purkhusid/bazel_runfiles_repro/blob/main/reproduce.sh\r\n\r\nIn short: target T1 has a dependency on T2, which has associated runfiles. First populate a disk cache with the result of building T1. Then, starting clean, first build T1 against the disk cache without the bytes (`--remote_download_minimal`), then run it. The result is that the runfiles for T2 are missing at runtime (as in, the runfile symlinks dangle). Disabling output checking (`--noexperimental_check_output_files`) is required to reproduce.\r\n\r\nThe issue is that building without the bytes works by lying to the Skyframe machinery about the existence of files on disk; instead, the files are materialized when either (1) a consuming action prefetches them, or (2) a top-level target forces its outputs to be produced. `bazel run` is not a build action, so it can't rely on prefetching; instead, it relies on the target being considered top-level even in MINIMAL mode (see RemoteOutputChecker). Disabling output checking prevents Skyframe from doing the dirtyness check on the outputs and realize they're not actually there, which would cause the target to be rebuilt.\r\n\r\nThere are two possible fixes:\r\n1. Add input prefetching to `bazel run`\r\n2. Make `--noexperimental_check_output_files` a no-op for `bazel run` commands.\r\n\r\n(1) is more correct but much trickier to implement, since all of the normal action-running machinery has already been torn down by the time the command is run; it would likely involve reimplementing `bazel run` as a special action injected into the build graph. I think the pragmatic thing to do is implement (2) until there's more evidence that (1) is worthwhile. (This will make `bazel run` slightly slower in cases where output checking is truly unnecessary, but it's not obvious that that would lead to a major regression; we're also covered by the fact that `--noexperimental_check_output_files` is, well, experimental and subject to change behavior at any time.)","closed_by":{"login":"copybara-service[bot]","id":56741989,"node_id":"MDM6Qm90NTY3NDE5ODk=","avatar_url":"https://avatars.githubusercontent.com/in/44061?v=4","gravatar_id":"","url":"https://api.github.com/users/copybara-service%5Bbot%5D","html_url":"https://github.com/apps/copybara-service","followers_url":"https://api.github.com/users/copybara-service%5Bbot%5D/followers","following_url":"https://api.github.com/users/copybara-service%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/copybara-service%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/copybara-service%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/copybara-service%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/copybara-service%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/copybara-service%5Bbot%5D/repos","events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/20843/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bazelbuild/bazel/issues/20843/timeline","performed_via_github_app":null,"state_reason":"completed"}