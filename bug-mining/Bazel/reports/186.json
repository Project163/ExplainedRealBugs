{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/21845","repository_url":"https://api.github.com/repos/bazelbuild/bazel","labels_url":"https://api.github.com/repos/bazelbuild/bazel/issues/21845/labels{/name}","comments_url":"https://api.github.com/repos/bazelbuild/bazel/issues/21845/comments","events_url":"https://api.github.com/repos/bazelbuild/bazel/issues/21845/events","html_url":"https://github.com/bazelbuild/bazel/issues/21845","id":2213590358,"node_id":"I_kwDOATz7jc6D8LVW","number":21845,"title":"Using invalid patch path with bzlmod + lockfile results in crash and bad lockfile","user":{"login":"keith","id":283886,"node_id":"MDQ6VXNlcjI4Mzg4Ng==","avatar_url":"https://avatars.githubusercontent.com/u/283886?v=4","gravatar_id":"","url":"https://api.github.com/users/keith","html_url":"https://github.com/keith","followers_url":"https://api.github.com/users/keith/followers","following_url":"https://api.github.com/users/keith/following{/other_user}","gists_url":"https://api.github.com/users/keith/gists{/gist_id}","starred_url":"https://api.github.com/users/keith/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/keith/subscriptions","organizations_url":"https://api.github.com/users/keith/orgs","repos_url":"https://api.github.com/users/keith/repos","events_url":"https://api.github.com/users/keith/events{/privacy}","received_events_url":"https://api.github.com/users/keith/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":106503259,"node_id":"MDU6TGFiZWwxMDY1MDMyNTk=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/type:%20bug","name":"type: bug","color":"0052cc","default":false,"description":null},{"id":192364134,"node_id":"MDU6TGFiZWwxOTIzNjQxMzQ=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/P1","name":"P1","color":"d93f0b","default":false,"description":"I'll work on this now. (Assignee required)"},{"id":1020663381,"node_id":"MDU6TGFiZWwxMDIwNjYzMzgx","url":"https://api.github.com/repos/bazelbuild/bazel/labels/team-ExternalDeps","name":"team-ExternalDeps","color":"f1f442","default":false,"description":"External dependency handling, remote repositiories, WORKSPACE file."},{"id":3718884690,"node_id":"LA_kwDOATz7jc7dqa1S","url":"https://api.github.com/repos/bazelbuild/bazel/labels/area-Bzlmod","name":"area-Bzlmod","color":"a4fc20","default":false,"description":"Bzlmod-specific PRs, issues, and feature requests"}],"state":"closed","locked":false,"assignee":{"login":"fmeum","id":4312191,"node_id":"MDQ6VXNlcjQzMTIxOTE=","avatar_url":"https://avatars.githubusercontent.com/u/4312191?v=4","gravatar_id":"","url":"https://api.github.com/users/fmeum","html_url":"https://github.com/fmeum","followers_url":"https://api.github.com/users/fmeum/followers","following_url":"https://api.github.com/users/fmeum/following{/other_user}","gists_url":"https://api.github.com/users/fmeum/gists{/gist_id}","starred_url":"https://api.github.com/users/fmeum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fmeum/subscriptions","organizations_url":"https://api.github.com/users/fmeum/orgs","repos_url":"https://api.github.com/users/fmeum/repos","events_url":"https://api.github.com/users/fmeum/events{/privacy}","received_events_url":"https://api.github.com/users/fmeum/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"fmeum","id":4312191,"node_id":"MDQ6VXNlcjQzMTIxOTE=","avatar_url":"https://avatars.githubusercontent.com/u/4312191?v=4","gravatar_id":"","url":"https://api.github.com/users/fmeum","html_url":"https://github.com/fmeum","followers_url":"https://api.github.com/users/fmeum/followers","following_url":"https://api.github.com/users/fmeum/following{/other_user}","gists_url":"https://api.github.com/users/fmeum/gists{/gist_id}","starred_url":"https://api.github.com/users/fmeum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fmeum/subscriptions","organizations_url":"https://api.github.com/users/fmeum/orgs","repos_url":"https://api.github.com/users/fmeum/repos","events_url":"https://api.github.com/users/fmeum/events{/privacy}","received_events_url":"https://api.github.com/users/fmeum/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":0,"created_at":"2024-03-28T16:01:13Z","updated_at":"2024-05-24T16:13:31Z","closed_at":"2024-05-24T16:13:30Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description of the bug:\n\n\nIt's invalid to specify a patch in your MODULE.bazel that is from a repo that's also being loaded in the MODULE.bazel. If you do this you end up corrupting your lockfile and it results in bazel crashes until you delete the lockfile.\r\n\r\nIt looks like the issue is the invalid patch path gets encoded in the lockfile before it's rejected:\r\n\r\n```\r\n      \"repoSpec\": {\r\n        \"bzlFile\": \"@@bazel_tools//tools/build_defs/repo:http.bzl\",\r\n        \"ruleClassName\": \"http_archive\",\r\n        \"attributes\": {\r\n          \"urls\": [\r\n            \"https://github.com/keith/buildifier-prebuilt/archive/refs/tags/6.4.0.tar.gz\"\r\n          ],\r\n          \"integrity\": \"sha256-itqdiOUev1of3/N9de1B1R9eZ3zb6vsKIt2lR0fW4H4=\",\r\n          \"strip_prefix\": \"buildifier-prebuilt-6.4.0\",\r\n          \"remote_patches\": {\r\n            \"https://bcr.bazel.build/modules/buildifier_prebuilt/6.4.0/patches/module_dot_bazel_version.patch\": \"sha256-FpUp/q4zJ2H12lwezrYaPUGLY2rr1XoWpiDRaE19udw=\"\r\n          },\r\n          \"remote_patch_strip\": 0,\r\n          \"patches\": [\r\n            \"@@[unknown repo 'buildozer' requested from @@]//:foo.patch\"\r\n          ],\r\n          \"patch_cmds\": [],\r\n```\r\n\r\nThen bazel crashes with:\r\n\r\n```\r\nCaused by: com.google.devtools.build.lib.cmdline.LabelSyntaxException: invalid repository name '[unknown repo 'buildozer' requested from @@]': repo names may contain only A-Z, a-z, 0-9, '-', '_', '.' and '~' and must not start with '~'\r\n```\n\n### Which category does this issue belong to?\n\n_No response_\n\n### What's the simplest, easiest way to reproduce this bug? Please provide a minimal example if possible.\n\n\n1. checkout this branch https://github.com/google/copybara/pull/287\r\n2. add something like this to the MODULE.bazel\r\n\r\n```\r\nsingle_version_override(\r\n    module_name = \"buildifier_prebuilt\",\r\n    patches = [\r\n        \"@buildozer//:foo.patch\",\r\n    ],\r\n)\r\n```\r\n\r\nIt has to be patching a module that is used during the build\r\n\r\n3. Build like `USE_BAZEL_VERSION=last_green bazelisk build //java/com/google/copybara:copybara_deploy.jar`\r\n4. Note the build failure for the invalid patch\r\n5. build again\n\n### Which operating system are you running Bazel on?\n\n\nmacOS\n\n### What is the output of `bazel info release`?\n\n\ne03de754ec15096fcd1f701ea0b2d4c09c4b97a1\n\n### If `bazel info release` returns `development version` or `(@non-git)`, tell us how you built Bazel.\n\n\n_No response_\n\n### What's the output of `git remote get-url origin; git rev-parse HEAD` ?\n\n\n_No response_\n\n### Is this a regression? If yes, please try to identify the Bazel commit where the bug was introduced.\n\n\n_No response_\n\n### Have you found anything relevant by searching the web?\n\n_No response_\n\n### Any other information, logs, or outputs that you want to share?\n\n_No response_","closed_by":{"login":"copybara-service[bot]","id":56741989,"node_id":"MDM6Qm90NTY3NDE5ODk=","avatar_url":"https://avatars.githubusercontent.com/in/44061?v=4","gravatar_id":"","url":"https://api.github.com/users/copybara-service%5Bbot%5D","html_url":"https://github.com/apps/copybara-service","followers_url":"https://api.github.com/users/copybara-service%5Bbot%5D/followers","following_url":"https://api.github.com/users/copybara-service%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/copybara-service%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/copybara-service%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/copybara-service%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/copybara-service%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/copybara-service%5Bbot%5D/repos","events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/21845/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bazelbuild/bazel/issues/21845/timeline","performed_via_github_app":null,"state_reason":"completed"}