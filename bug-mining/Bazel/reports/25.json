{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/18021","repository_url":"https://api.github.com/repos/bazelbuild/bazel","labels_url":"https://api.github.com/repos/bazelbuild/bazel/issues/18021/labels{/name}","comments_url":"https://api.github.com/repos/bazelbuild/bazel/issues/18021/comments","events_url":"https://api.github.com/repos/bazelbuild/bazel/issues/18021/events","html_url":"https://github.com/bazelbuild/bazel/issues/18021","id":1661302632,"node_id":"I_kwDOATz7jc5jBXdo","number":18021,"title":"Bazel crash when `target_compatible_with` doesn't have a default entry.","user":{"login":"katre","id":326527,"node_id":"MDQ6VXNlcjMyNjUyNw==","avatar_url":"https://avatars.githubusercontent.com/u/326527?v=4","gravatar_id":"","url":"https://api.github.com/users/katre","html_url":"https://github.com/katre","followers_url":"https://api.github.com/users/katre/followers","following_url":"https://api.github.com/users/katre/following{/other_user}","gists_url":"https://api.github.com/users/katre/gists{/gist_id}","starred_url":"https://api.github.com/users/katre/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/katre/subscriptions","organizations_url":"https://api.github.com/users/katre/orgs","repos_url":"https://api.github.com/users/katre/repos","events_url":"https://api.github.com/users/katre/events{/privacy}","received_events_url":"https://api.github.com/users/katre/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":106503259,"node_id":"MDU6TGFiZWwxMDY1MDMyNTk=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/type:%20bug","name":"type: bug","color":"0052cc","default":false,"description":null},{"id":1020660688,"node_id":"MDU6TGFiZWwxMDIwNjYwNjg4","url":"https://api.github.com/repos/bazelbuild/bazel/labels/team-Configurability","name":"team-Configurability","color":"f1f442","default":false,"description":"platforms, toolchains, cquery, select(), config transitions"},{"id":1020665933,"node_id":"MDU6TGFiZWwxMDIwNjY1OTMz","url":"https://api.github.com/repos/bazelbuild/bazel/labels/untriaged","name":"untriaged","color":"c34ddd","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"gregestren","id":5130366,"node_id":"MDQ6VXNlcjUxMzAzNjY=","avatar_url":"https://avatars.githubusercontent.com/u/5130366?v=4","gravatar_id":"","url":"https://api.github.com/users/gregestren","html_url":"https://github.com/gregestren","followers_url":"https://api.github.com/users/gregestren/followers","following_url":"https://api.github.com/users/gregestren/following{/other_user}","gists_url":"https://api.github.com/users/gregestren/gists{/gist_id}","starred_url":"https://api.github.com/users/gregestren/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gregestren/subscriptions","organizations_url":"https://api.github.com/users/gregestren/orgs","repos_url":"https://api.github.com/users/gregestren/repos","events_url":"https://api.github.com/users/gregestren/events{/privacy}","received_events_url":"https://api.github.com/users/gregestren/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"gregestren","id":5130366,"node_id":"MDQ6VXNlcjUxMzAzNjY=","avatar_url":"https://avatars.githubusercontent.com/u/5130366?v=4","gravatar_id":"","url":"https://api.github.com/users/gregestren","html_url":"https://github.com/gregestren","followers_url":"https://api.github.com/users/gregestren/followers","following_url":"https://api.github.com/users/gregestren/following{/other_user}","gists_url":"https://api.github.com/users/gregestren/gists{/gist_id}","starred_url":"https://api.github.com/users/gregestren/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gregestren/subscriptions","organizations_url":"https://api.github.com/users/gregestren/orgs","repos_url":"https://api.github.com/users/gregestren/repos","events_url":"https://api.github.com/users/gregestren/events{/privacy}","received_events_url":"https://api.github.com/users/gregestren/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":11,"created_at":"2023-04-10T20:15:14Z","updated_at":"2023-04-18T17:14:32Z","closed_at":"2023-04-13T12:48:01Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description of the bug:\n\n\nWhen the `target_compatible_with` attribute is a select, and the select has no match for the current configuration, bazel crashes because the [`IncompatibleTargetChecker`](https://cs.opensource.google/bazel/bazel/+/master:src/main/java/com/google/devtools/build/lib/analysis/constraints/IncompatibleTargetChecker.java?ss=bazel&q=IncompatibleTargetChecker) does not handle the [`ConfiguredAttributeMapper.ValidationException`](https://cs.opensource.google/bazel/bazel/+/master:src/main/java/com/google/devtools/build/lib/packages/ConfiguredAttributeMapper.java?q=symbol%3A%5Cbcom.google.devtools.build.lib.packages.ConfiguredAttributeMapper.ValidationException%5Cb%20case%3Ayes).\n\n### What's the simplest, easiest way to reproduce this bug? Please provide a minimal example if possible.\n\n\nSee https://github.com/katre/bazel/commit/63939e2b0ee44b533fb0de908d62dc8362fc1fa6 for a change to `target_compatible_with_test.sh` that shows the error.\r\n\r\n```\r\n$ bazel test //src/test/shell/integration:target_compatible_with_test --test_filter=test_missing_default\r\nINFO: Analyzed target //src/test/shell/integration:target_compatible_with_test (1 packages loaded, 847 targets configured).\r\nINFO: Found 1 test target...\r\nFAIL: //src/test/shell/integration:target_compatible_with_test (see /usr/local/google/home/jcater/.cache/bazel/_bazel_jcater/a85a0dacd9e20e18c47928db0f1530e0/execroot/io_bazel/bazel-out/k8-fastbuild/testlogs/src/test/shell/integration/target_compatible_with_test/test.log)\r\nINFO: From Testing //src/test/shell/integration:target_compatible_with_test:\r\n==================== Test output for //src/test/shell/integration:target_compatible_with_test:\r\nINFO[target_compatible_with_test 2023-04-10 20:14:09 (+0000)] bazel binary is at /usr/local/google/home/jcater/.cache/bazel/_bazel_jcater/a85a0dacd9e20e18c47928db0f1530e0/sandbox/linux-sandbox/1268/execroot/io_bazel/bazel-out/k8-fastbuild/bin/src/test/shell/integration/target_compatible_with_test.runfiles/io_bazel/src/test/shell/bin\r\nINFO[target_compatible_with_test 2023-04-10 20:14:09 (+0000)] setting up client in /usr/local/google/home/jcater/.cache/bazel/_bazel_jcater/a85a0dacd9e20e18c47928db0f1530e0/sandbox/linux-sandbox/1268/execroot/io_bazel/_tmp/4a28868e660c8b58f7795306ee6f829b/workspace\r\n\r\ntarget_compatible_with tests\r\n\r\nMon Apr 10 20:14:09 UTC 2023\r\n** test_missing_default ********************************************************\r\n-- Test log: -----------------------------------------------------------\r\n$TEST_TMPDIR defined: output root default is '/usr/local/google/home/jcater/.cache/bazel/_bazel_jcater/a85a0dacd9e20e18c47928db0f1530e0/sandbox/linux-sandbox/1268/execroot/io_bazel/_tmp/4a28868e660c8b58f7795306ee6f829b' and max_idle_secs default is '15'.\r\nWARNING: The following rc files are no longer being read, please transfer their contents or import their path into one of the standard rc files:\r\n/etc/bazel.bazelrc\r\nExtracting Bazel installation...\r\nStarting local Bazel server and connecting to it...\r\nLoading: \r\nLoading: \r\nLoading: 0 packages loaded\r\nAnalyzing: target //target_skipping:pass_on_foo1_or_foo2_but_not_on_foo3 (1 packages loaded, 0 targets configured)\r\nFATAL: bazel crashed due to an internal error. Printing stack trace:\r\njava.lang.RuntimeException: Unrecoverable error while evaluating node 'ConfiguredTargetKey{label=//target_skipping:pass_on_foo1_or_foo2_but_not_on_foo3, config=BuildConfigurationKey[ba87565edeaaaab5b6f8aa7ebde8e64f145d546f518b1ec653f8810f21062bd6]}' (requested by nodes )\r\n\tat com.google.devtools.build.skyframe.AbstractParallelEvaluator$Evaluate.run(AbstractParallelEvaluator.java:591)\r\n\tat com.google.devtools.build.lib.concurrent.AbstractQueueVisitor$WrappedRunnable.run(AbstractQueueVisitor.java:375)\r\n\tat java.base/java.util.concurrent.ForkJoinTask$RunnableExecuteAction.exec(Unknown Source)\r\n\tat java.base/java.util.concurrent.ForkJoinTask.doExec(Unknown Source)\r\n\tat java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(Unknown Source)\r\n\tat java.base/java.util.concurrent.ForkJoinPool.scan(Unknown Source)\r\n\tat java.base/java.util.concurrent.ForkJoinPool.runWorker(Unknown Source)\r\n\tat java.base/java.util.concurrent.ForkJoinWorkerThread.run(Unknown Source)\r\nCaused by: java.lang.IllegalStateException: lookup failed on attribute target_compatible_with: configurable attribute \"target_compatible_with\" in //target_skipping:pass_on_foo1_or_foo2_but_not_on_foo3 doesn't match this configuration. Would a default condition help?\r\n\r\nConditions checked:\r\n //target_skipping:foo1\r\n\r\nTo see a condition's definition, run: bazel query --output=build <condition label>.\r\n\r\nThis instance of //target_skipping:pass_on_foo1_or_foo2_but_not_on_foo3 has configuration identifier ba87565. To inspect its configuration, run: bazel config ba87565.\r\n\r\nFor more help, see https://bazel.build/docs/configurable-attributes#faq-select-choose-condition.\r\n\r\n\r\n\tat com.google.devtools.build.lib.packages.ConfiguredAttributeMapper.get(ConfiguredAttributeMapper.java:298)\r\n\tat com.google.devtools.build.lib.analysis.constraints.IncompatibleTargetChecker$IncompatibleTargetProducer.step(IncompatibleTargetChecker.java:152)\r\n\tat com.google.devtools.build.skyframe.state.TaskTreeNode.run(TaskTreeNode.java:95)\r\n\tat com.google.devtools.build.skyframe.state.Driver.drive(Driver.java:87)\r\n\tat com.google.devtools.build.lib.skyframe.PrerequisiteProducer.checkForIncompatibleTarget(PrerequisiteProducer.java:494)\r\n\tat com.google.devtools.build.lib.skyframe.PrerequisiteProducer.evaluate(PrerequisiteProducer.java:342)\r\n\tat com.google.devtools.build.lib.skyframe.ConfiguredTargetFunction.compute(ConfiguredTargetFunction.java:200)\r\n\tat com.google.devtools.build.skyframe.AbstractParallelEvaluator$Evaluate.run(AbstractParallelEvaluator.java:501)\r\n\t... 7 more\r\n------------------------------------------------------------------------\r\ntest_missing_default FAILED: Expected regexp ERROR: Target //target_skipping:pass_on_foo1_or_foo2_but_not_on_foo3 is incompatible and cannot be built, but was explicitly requested not found.\r\n/usr/local/google/home/jcater/.cache/bazel/_bazel_jcater/a85a0dacd9e20e18c47928db0f1530e0/sandbox/linux-sandbox/1268/execroot/io_bazel/bazel-out/k8-fastbuild/bin/src/test/shell/integration/target_compatible_with_test.runfiles/io_bazel/src/test/shell/integration/target_compatible_with_test:917: in call to test_missing_default\r\n\r\nTear down:\r\n\r\n$TEST_TMPDIR defined: output root default is '/usr/local/google/home/jcater/.cache/bazel/_bazel_jcater/a85a0dacd9e20e18c47928db0f1530e0/sandbox/linux-sandbox/1268/execroot/io_bazel/_tmp/4a28868e660c8b58f7795306ee6f829b' and max_idle_secs default is '15'.\r\nWARNING: The following rc files are no longer being read, please transfer their contents or import their path into one of the standard rc files:\r\n/etc/bazel.bazelrc\r\nINFO[target_compatible_with_test 2023-04-10 20:14:16 (+0000)] Cleaning up workspace\r\n\r\nFAILED: test_missing_default\r\n\r\n** 0 / 1 tests passed. *********************************************************\r\n** There were errors. **********************************************************\r\n$TEST_TMPDIR defined: output root default is '/usr/local/google/home/jcater/.cache/bazel/_bazel_jcater/a85a0dacd9e20e18c47928db0f1530e0/sandbox/linux-sandbox/1268/execroot/io_bazel/_tmp/4a28868e660c8b58f7795306ee6f829b' and max_idle_secs default is '15'.\r\nWARNING: The following rc files are no longer being read, please transfer their contents or import their path into one of the standard rc files:\r\n/etc/bazel.bazelrc\r\n================================================================================\r\nTarget //src/test/shell/integration:target_compatible_with_test up-to-date:\r\n  bazel-bin/src/test/shell/integration/target_compatible_with_test\r\nINFO: Elapsed time: 12.387s, Critical Path: 10.68s\r\nINFO: 2 processes: 1 internal, 1 linux-sandbox.\r\nINFO: Build completed, 1 test FAILED, 2 total actions\r\n//src/test/shell/integration:target_compatible_with_test                 FAILED in 10.3s\r\n    ERROR   .test_missing_default (9.6s)\r\nTest cases: finished with 0 passing and 1 failing out of 1 test cases\r\n\r\nExecuted 1 out of 1 test: 1 fails locally.\r\n```\n\n### Which operating system are you running Bazel on?\n\n\nLinux\n\n### What is the output of `bazel info release`?\n\n\nrelease 6.1.1\n\n### If `bazel info release` returns `development version` or `(@non-git)`, tell us how you built Bazel.\n\n\n_No response_\n\n### What's the output of `git remote get-url origin; git rev-parse master; git rev-parse HEAD` ?\n\n\n_No response_\n\n### Have you found anything relevant by searching the web?\n\n_No response_\n\n### Any other information, logs, or outputs that you want to share?\n\n_No response_","closed_by":{"login":"copybara-service[bot]","id":56741989,"node_id":"MDM6Qm90NTY3NDE5ODk=","avatar_url":"https://avatars.githubusercontent.com/in/44061?v=4","gravatar_id":"","url":"https://api.github.com/users/copybara-service%5Bbot%5D","html_url":"https://github.com/apps/copybara-service","followers_url":"https://api.github.com/users/copybara-service%5Bbot%5D/followers","following_url":"https://api.github.com/users/copybara-service%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/copybara-service%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/copybara-service%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/copybara-service%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/copybara-service%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/copybara-service%5Bbot%5D/repos","events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/18021/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bazelbuild/bazel/issues/18021/timeline","performed_via_github_app":null,"state_reason":"completed"}