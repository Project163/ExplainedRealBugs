{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/18772","repository_url":"https://api.github.com/repos/bazelbuild/bazel","labels_url":"https://api.github.com/repos/bazelbuild/bazel/issues/18772/labels{/name}","comments_url":"https://api.github.com/repos/bazelbuild/bazel/issues/18772/comments","events_url":"https://api.github.com/repos/bazelbuild/bazel/issues/18772/events","html_url":"https://github.com/bazelbuild/bazel/issues/18772","id":1774716005,"node_id":"I_kwDOATz7jc5pyARl","number":18772,"title":"Bazel symlink prefetching can crash - triggered by Builds without the Bytes","user":{"login":"alexofortune","id":130081690,"node_id":"U_kgDOB8Djmg","avatar_url":"https://avatars.githubusercontent.com/u/130081690?v=4","gravatar_id":"","url":"https://api.github.com/users/alexofortune","html_url":"https://github.com/alexofortune","followers_url":"https://api.github.com/users/alexofortune/followers","following_url":"https://api.github.com/users/alexofortune/following{/other_user}","gists_url":"https://api.github.com/users/alexofortune/gists{/gist_id}","starred_url":"https://api.github.com/users/alexofortune/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alexofortune/subscriptions","organizations_url":"https://api.github.com/users/alexofortune/orgs","repos_url":"https://api.github.com/users/alexofortune/repos","events_url":"https://api.github.com/users/alexofortune/events{/privacy}","received_events_url":"https://api.github.com/users/alexofortune/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":106503259,"node_id":"MDU6TGFiZWwxMDY1MDMyNTk=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/type:%20bug","name":"type: bug","color":"0052cc","default":false,"description":null},{"id":1193207358,"node_id":"MDU6TGFiZWwxMTkzMjA3MzU4","url":"https://api.github.com/repos/bazelbuild/bazel/labels/team-Remote-Exec","name":"team-Remote-Exec","color":"f1f442","default":false,"description":"Issues and PRs for the Execution (Remote) team"}],"state":"closed","locked":false,"assignee":{"login":"coeuvre","id":5947531,"node_id":"MDQ6VXNlcjU5NDc1MzE=","avatar_url":"https://avatars.githubusercontent.com/u/5947531?v=4","gravatar_id":"","url":"https://api.github.com/users/coeuvre","html_url":"https://github.com/coeuvre","followers_url":"https://api.github.com/users/coeuvre/followers","following_url":"https://api.github.com/users/coeuvre/following{/other_user}","gists_url":"https://api.github.com/users/coeuvre/gists{/gist_id}","starred_url":"https://api.github.com/users/coeuvre/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/coeuvre/subscriptions","organizations_url":"https://api.github.com/users/coeuvre/orgs","repos_url":"https://api.github.com/users/coeuvre/repos","events_url":"https://api.github.com/users/coeuvre/events{/privacy}","received_events_url":"https://api.github.com/users/coeuvre/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"coeuvre","id":5947531,"node_id":"MDQ6VXNlcjU5NDc1MzE=","avatar_url":"https://avatars.githubusercontent.com/u/5947531?v=4","gravatar_id":"","url":"https://api.github.com/users/coeuvre","html_url":"https://github.com/coeuvre","followers_url":"https://api.github.com/users/coeuvre/followers","following_url":"https://api.github.com/users/coeuvre/following{/other_user}","gists_url":"https://api.github.com/users/coeuvre/gists{/gist_id}","starred_url":"https://api.github.com/users/coeuvre/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/coeuvre/subscriptions","organizations_url":"https://api.github.com/users/coeuvre/orgs","repos_url":"https://api.github.com/users/coeuvre/repos","events_url":"https://api.github.com/users/coeuvre/events{/privacy}","received_events_url":"https://api.github.com/users/coeuvre/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":4,"created_at":"2023-06-26T12:55:00Z","updated_at":"2023-06-30T18:24:41Z","closed_at":"2023-06-29T12:56:11Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description of the bug:\r\n\r\n\r\nWe're trying to adopt Builds without the Bytes at our codebase, but we see build failures when we enable it related to strange symlink treatment. Here's the error and stack trace:\r\n\r\n```\r\nExec failed due to IOException: 136 errors during bulk transfer:\r\njava.io.IOException: /mnt/cache/bazel/output/652855c435821699db0f4352be3bd5fd/execroot/__main__/bazel-out/k8-fastbuild/bin/external/com_git_scm_git/git-add/git (Not a directory)\r\n\t\tat com.google.devtools.build.lib.unix.NativePosixFiles.openWrite(Native Method)\r\n\t\tat com.google.devtools.build.lib.unix.UnixFileSystem.createFileOutputStream(UnixFileSystem.java:519)\r\n\t\tat com.google.devtools.build.lib.vfs.AbstractFileSystem.getOutputStream(AbstractFileSystem.java:174)\r\n\t\tat com.google.devtools.build.lib.vfs.AbstractFileSystem.getOutputStream(AbstractFileSystem.java:188)\r\n\t\tat com.google.devtools.build.lib.vfs.Path.getOutputStream(Path.java:408)\r\n\t\tat com.google.devtools.build.lib.vfs.Path.getOutputStream(Path.java:396)\r\n\t\tat com.google.devtools.build.lib.vfs.FileSystemUtils.moveFile(FileSystemUtils.java:457)\r\n\t\tat com.google.devtools.build.lib.remote.AbstractActionInputPrefetcher.finalizeDownload(AbstractActionInputPrefetcher.java:547)\r\n\t\tat com.google.devtools.build.lib.remote.AbstractActionInputPrefetcher.lambda$downloadFileNoCheckRx$14(AbstractActionInputPrefetcher.java:475)\r\n\t\tat io.reactivex.rxjava3.internal.operators.completable.CompletablePeek$CompletableObserverImplementation.onComplete(CompletablePeek.java:107)\r\n\t\t... 85 more\r\n```\r\n\r\nUpon further investigation, we found this culprit block of code at https://github.com/bazelbuild/bazel/blob/d097b5d6cd3bc9fdb725b379b6cf3ef247126008/src/main/java/com/google/devtools/build/lib/remote/AbstractActionInputPrefetcher.java , line 437 :\r\n\r\n```\r\n    if (path.isSymbolicLink()) {\r\n      try {\r\n        path = path.getRelative(path.readSymbolicLink());\r\n      } catch (IOException e) {\r\n        return Completable.error(e);\r\n      }\r\n    }\r\n```\r\n\r\nInstrumenting this with logs yielded following results:\r\n\r\n```\r\n230626 10:35:11.852:I 556 [com.google.devtools.build.lib.remote.AbstractActionInputPrefetcher.downloadFileNoCheckRx] [2] prefetching a file - original path /mnt/cache/bazel/output/652855c435821699db0f4352be3bd5fd/execroot/__main__/bazel-out/k8-fastbuild/bin/external/com_git_scm_git/git-maintenance\r\n230626 10:35:11.852:I 556 [com.google.devtools.build.lib.remote.AbstractActionInputPrefetcher.downloadFileNoCheckRx] [2] prefetching a file - transformed path /mnt/cache/bazel/output/652855c435821699db0f4352be3bd5fd/execroot/__main__/bazel-out/k8-fastbuild/bin/external/com_git_scm_git/git-maintenance/git\r\n```\r\n\r\nTo be precise:\r\n* **git** is standard git binary\r\n* **git-maintenance** is a **symlink** to git, **generated via a bash script via genrule, and declared via `outs`**. Note that **this genrule is marked as local = True**\r\n\r\nThis results in resolving the download path to a directory that doesn't exist and IOException when Bazel tries to attempt moving.\r\n\r\nAt least three questions come to my mind:\r\n\r\n* Why bazel decides to prefetch something that is already on local filesystem? ( At the time of the crash, I can see both git binary and the symlinks )\r\n* Why does bazel try to even check if the path is a symbolic link before it attempts to pre-fetch the file?\r\n* Why does bazel think its a good idea to interpret that path as a directory and append relative path to it, resulting in this bogus path?\r\n\r\n\r\n### What's the simplest, easiest way to reproduce this bug? Please provide a minimal example if possible.\r\n\r\n\r\nSomething akin to this should work:\r\n\r\na) Create a genrule:\r\n\r\n```\r\nSYMLINKS = [\r\n   \"binary-symlink\",\r\n   \"binary-symlink2\",\r\n]\r\ngenrule(\r\n    name = \"symlinks\",\r\n    srcs = [\":binary\"],\r\n    outs = SYMLINKS,\r\n    cmd = \";\".join([\r\n               \"ln -s binary $(location %s)\" % f\r\n               for f in SYMLINKS\r\n     ]),\r\n     local = True,\r\n)\r\n```\r\nb) Add an action depending on the symlinks. Try to build it with BWOB.\r\n\r\n\r\n### Which operating system are you running Bazel on?\r\n\r\n\r\nLinux\r\n\r\n### What is the output of `bazel info release`?\r\n\r\n\r\n6.1.0\r\n\r\n### If `bazel info release` returns `development version` or `(@non-git)`, tell us how you built Bazel.\r\n\r\n\r\n_No response_\r\n\r\n### What's the output of `git remote get-url origin; git rev-parse master; git rev-parse HEAD` ?\r\n\r\n\r\n_No response_\r\n\r\n### Is this a regression? If yes, please try to identify the Bazel commit where the bug was introduced.\r\n\r\n\r\n_No response_\r\n\r\n### Have you found anything relevant by searching the web?\r\n\r\nNothing\r\n\r\n### Any other information, logs, or outputs that you want to share?\r\n\r\n_No response_","closed_by":{"login":"copybara-service[bot]","id":56741989,"node_id":"MDM6Qm90NTY3NDE5ODk=","avatar_url":"https://avatars.githubusercontent.com/in/44061?v=4","gravatar_id":"","url":"https://api.github.com/users/copybara-service%5Bbot%5D","html_url":"https://github.com/apps/copybara-service","followers_url":"https://api.github.com/users/copybara-service%5Bbot%5D/followers","following_url":"https://api.github.com/users/copybara-service%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/copybara-service%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/copybara-service%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/copybara-service%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/copybara-service%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/copybara-service%5Bbot%5D/repos","events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/18772/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bazelbuild/bazel/issues/18772/timeline","performed_via_github_app":null,"state_reason":"completed"}