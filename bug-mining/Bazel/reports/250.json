{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/23512","repository_url":"https://api.github.com/repos/bazelbuild/bazel","labels_url":"https://api.github.com/repos/bazelbuild/bazel/issues/23512/labels{/name}","comments_url":"https://api.github.com/repos/bazelbuild/bazel/issues/23512/comments","events_url":"https://api.github.com/repos/bazelbuild/bazel/issues/23512/events","html_url":"https://github.com/bazelbuild/bazel/issues/23512","id":2505846979,"node_id":"I_kwDOATz7jc6VXDDD","number":23512,"title":"Changing `mtime` to support cache trimming collides with a shared cache","user":{"login":"doak","id":2485924,"node_id":"MDQ6VXNlcjI0ODU5MjQ=","avatar_url":"https://avatars.githubusercontent.com/u/2485924?v=4","gravatar_id":"","url":"https://api.github.com/users/doak","html_url":"https://github.com/doak","followers_url":"https://api.github.com/users/doak/followers","following_url":"https://api.github.com/users/doak/following{/other_user}","gists_url":"https://api.github.com/users/doak/gists{/gist_id}","starred_url":"https://api.github.com/users/doak/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/doak/subscriptions","organizations_url":"https://api.github.com/users/doak/orgs","repos_url":"https://api.github.com/users/doak/repos","events_url":"https://api.github.com/users/doak/events{/privacy}","received_events_url":"https://api.github.com/users/doak/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":106503259,"node_id":"MDU6TGFiZWwxMDY1MDMyNTk=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/type:%20bug","name":"type: bug","color":"0052cc","default":false,"description":null},{"id":192364170,"node_id":"MDU6TGFiZWwxOTIzNjQxNzA=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/P2","name":"P2","color":"e99695","default":false,"description":"We'll consider working on this in future. (Assignee optional)"},{"id":1193207358,"node_id":"MDU6TGFiZWwxMTkzMjA3MzU4","url":"https://api.github.com/repos/bazelbuild/bazel/labels/team-Remote-Exec","name":"team-Remote-Exec","color":"f1f442","default":false,"description":"Issues and PRs for the Execution (Remote) team"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":13,"created_at":"2024-09-04T16:41:30Z","updated_at":"2025-04-01T17:47:54Z","closed_at":"2025-02-20T11:46:31Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description of the bug:\r\n\r\n\r\nSorry, this is a bit vague for now:\r\nI am using a Bazel disk and repository cache shared by multiple users. For v7.2.1 a `FilePermissionException` is thrown if the cached object had been created by another user. I assume this happens due to the change to refresh `mtime` on every cache access to be able to trim it.\r\nIt worked fine on versions prior to v7, for sure for v6.2.1.\r\n\r\nI am not sure how to approach this issue cleanly. Just a few thoughts:\r\n* Modifying `mtime` for a file owned by another user fails on my system â€“ even if the group has write access. I don't know if there are ways to accomplish that, though.\r\n* At least on a \"decent\" Linux you could rely on `atime` instead of `mtime`. I've done that to trim the cache manually in the past. Afaik the default mount options (`relatime`) are sane in this regard. From `man mount`:\r\n    > **`relatime`**\r\n    > Update inode access times relative to modify or change time. Access time is only updated if the previous access time was earlier than the current modify or change time. (Similar to `noatime`, but it doesn't break `mutt` or other applications that need to know if a file has been read since the last time it was modified.)\r\n    > Since Linux 2.6.30, **the kernel defaults to the behaviour provided by this option** (unless `noatime` was specified), and the `strictatime` option is required to obtain traditional semantics. In addition, since Linux 2.6.30, the file's last access time **is always updated if it is more than 1 day old**.\r\n\r\nAfaik using the shared cache directly, i.e. on file system level, by multiple users is a documented feature. Although I assume you could rely on a ACL configuration, such simple setup using plain Unix permissions should be imho supported as well.\r\n\r\n\r\n### Which category does this issue belong to?\r\n\r\n_No response_\r\n\r\n### What's the simplest, easiest way to reproduce this bug? Please provide a minimal example if possible.\r\n\r\n\r\nGive write access to Bazel cache folder for user 1 but own all files by another user 2. Then build something with user 1.\r\n\r\n### Which operating system are you running Bazel on?\r\n\r\n\r\nLinux\r\n\r\n### What is the output of `bazel info release`?\r\n\r\n\r\ndevelopment version\r\n\r\n### If `bazel info release` returns `development version` or `(@non-git)`, tell us how you built Bazel.\r\n\r\n\r\nIt's vanilla Bazel v7.2.1 plus a revert of 4da06426be298a350260879852db651da389c6c8, see #23405.\r\nI am building with `bazel build //src:bazel-bin`.\r\n\r\n### What's the output of `git remote get-url origin; git rev-parse HEAD` ?\r\n\r\n\r\n_No response_\r\n\r\n### If this is a regression, please try to identify the Bazel commit where the bug was introduced with bazelisk --bisect.\r\n\r\n\r\nMost likely related to 7a774ff7c5850e7bd57af840a0e097ad4ec25417. I've reverted it and resolved conflicts as best as I can. It works (for now).\r\n\r\n### Have you found anything relevant by searching the web?\r\n\r\nIt is the same use case as for #23405.\r\n\r\n### Any other information, logs, or outputs that you want to share?\r\n\r\nError messages thrown during build showing the backtrace:\r\n```\r\nWARNING: Remote Cache: /tmp/doak/bazel-try-out-cache/disk-cache/cas/d3/d3377b587d61e3b93fb8ba3cbe11d7c25c46c2c927d92f7865075a92cacd1769 (Operation not permitted)                                                  \r\ncom.google.devtools.build.lib.remote.common.BulkTransferException: /tmp/doak/bazel-try-out-cache/disk-cache/cas/d3/d3377b587d61e3b93fb8ba3cbe11d7c25c46c2c927d92f7865075a92cacd1769 (Operation not permitted)      \r\n        at com.google.devtools.build.lib.remote.util.RxUtils$BulkTransferExceptionCollector.onResult(RxUtils.java:112)                                                                                             \r\n        at io.reactivex.rxjava3.internal.operators.flowable.FlowableCollectSingle$CollectSubscriber.onNext(FlowableCollectSingle.java:94)                                                                          \r\n        at io.reactivex.rxjava3.internal.operators.flowable.FlowableFlatMapSingle$FlatMapSingleSubscriber.innerSuccess(FlowableFlatMapSingle.java:173)                                                             \r\n        at io.reactivex.rxjava3.internal.operators.flowable.FlowableFlatMapSingle$FlatMapSingleSubscriber$InnerObserver.onSuccess(FlowableFlatMapSingle.java:342)                                                  \r\n        at io.reactivex.rxjava3.internal.operators.single.SingleDoFinally$DoFinallyObserver.onSuccess(SingleDoFinally.java:73)                                                                                     \r\n        at io.reactivex.rxjava3.internal.observers.ResumeSingleObserver.onSuccess(ResumeSingleObserver.java:46)                                                                                                    \r\n        at io.reactivex.rxjava3.internal.operators.single.SingleJust.subscribeActual(SingleJust.java:30)                                                                                                           \r\n        at io.reactivex.rxjava3.core.Single.subscribe(Single.java:4855)                                                                                                                                            \r\n        at io.reactivex.rxjava3.internal.operators.single.SingleResumeNext$ResumeMainSingleObserver.onError(SingleResumeNext.java:80)                                                                              \r\n        at io.reactivex.rxjava3.internal.operators.completable.CompletableToSingle$ToSingle.onError(CompletableToSingle.java:73)                                                                                   \r\n        at io.reactivex.rxjava3.internal.operators.completable.CompletableCreate$Emitter.tryOnError(CompletableCreate.java:91)                                                                                     \r\n        at io.reactivex.rxjava3.internal.operators.completable.CompletableCreate$Emitter.onError(CompletableCreate.java:77)                                                                                        \r\n        at com.google.devtools.build.lib.remote.util.RxFutures$OnceCompletableOnSubscribe$1.onFailure(RxFutures.java:102)                                                                                          \r\n        at com.google.common.util.concurrent.Futures$CallbackListener.run(Futures.java:1119)                                                                                                                       \r\n        at com.google.common.util.concurrent.DirectExecutor.execute(DirectExecutor.java:31)                                                                                                                        \r\n        at com.google.common.util.concurrent.AbstractFuture.executeListener(AbstractFuture.java:1286)                                                                                                              \r\n        at com.google.common.util.concurrent.AbstractFuture.complete(AbstractFuture.java:1055)                                                                                                                     \r\n        at com.google.common.util.concurrent.AbstractFuture.setException(AbstractFuture.java:807)                                                                                                                  \r\n        at com.google.common.util.concurrent.SettableFuture.setException(SettableFuture.java:55)                                                                                                                   \r\n        at com.google.devtools.build.lib.remote.util.RxFutures$1.onError(RxFutures.java:221)                                                                                                                       \r\n        at io.reactivex.rxjava3.internal.operators.completable.CompletableFromSingle$CompletableFromSingleObserver.onError(CompletableFromSingle.java:41)                                                          \r\n        at io.reactivex.rxjava3.internal.operators.single.SingleCreate$Emitter.tryOnError(SingleCreate.java:95)                                                                                                    \r\n        at io.reactivex.rxjava3.internal.operators.single.SingleCreate$Emitter.onError(SingleCreate.java:81)                                                                                                       \r\n        at com.google.devtools.build.lib.remote.util.AsyncTaskCache$1.onError(AsyncTaskCache.java:339)                                                                                                             \r\n        at com.google.devtools.build.lib.remote.util.AsyncTaskCache$Execution.onError(AsyncTaskCache.java:205)                                                                                                     \r\n        at io.reactivex.rxjava3.internal.operators.completable.CompletableToSingle$ToSingle.onError(CompletableToSingle.java:73)                                                                                   \r\n        at io.reactivex.rxjava3.internal.operators.completable.CompletableCreate$Emitter.tryOnError(CompletableCreate.java:91)                                                                                     \r\n        at io.reactivex.rxjava3.internal.operators.completable.CompletableCreate$Emitter.onError(CompletableCreate.java:77)                                                                                        \r\n        at com.google.devtools.build.lib.remote.util.RxFutures$OnceCompletableOnSubscribe$1.onFailure(RxFutures.java:102)                                                                                          \r\n        at com.google.common.util.concurrent.Futures$CallbackListener.run(Futures.java:1119)                                                                                                                       \r\n        at com.google.common.util.concurrent.DirectExecutor.execute(DirectExecutor.java:31)                                                                                                                        \r\n        at com.google.common.util.concurrent.AbstractFuture.executeListener(AbstractFuture.java:1286)                                                                                                              \r\n        at com.google.common.util.concurrent.AbstractFuture.complete(AbstractFuture.java:1055)                                                                                                                     \r\n        at com.google.common.util.concurrent.AbstractFuture.setException(AbstractFuture.java:807)                                                                                                                  \r\n        at com.google.common.util.concurrent.TrustedListenableFutureTask$TrustedFutureInterruptibleTask.afterRanInterruptiblyFailure(TrustedListenableFutureTask.java:141)                                         \r\n        at com.google.common.util.concurrent.InterruptibleTask.run(InterruptibleTask.java:90)                                                                                                                      \r\n        at com.google.common.util.concurrent.TrustedListenableFutureTask.run(TrustedListenableFutureTask.java:82)                                                                                                  \r\n        at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(Unknown Source)                                                                                                                             \r\n        at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)                                                                                                                            \r\n        at java.base/java.lang.Thread.run(Unknown Source)                                                                                                                                                          \r\n        Suppressed: com.google.devtools.build.lib.unix.FilePermissionException: /tmp/doak/bazel-try-out-cache/disk-cache/cas/d3/d3377b587d61e3b93fb8ba3cbe11d7c25c46c2c927d92f7865075a92cacd1769 (Operation not per\r\nmitted)                                                                                                                                                                                                            \r\n                at com.google.devtools.build.lib.unix.NativePosixFiles.utime(Native Method)                                                                                                                        \r\n                at com.google.devtools.build.lib.unix.UnixFileSystem.setLastModifiedTime(UnixFileSystem.java:417)                                                                                                  \r\n                at com.google.devtools.build.lib.vfs.Path.setLastModifiedTime(Path.java:650)                                                                                                                       \r\n                at com.google.devtools.build.lib.remote.disk.DiskCacheClient.refresh(DiskCacheClient.java:122)                                                                                                     \r\n                at com.google.devtools.build.lib.remote.disk.DiskCacheClient.saveFile(DiskCacheClient.java:334)                                                                                                    \r\n                at com.google.devtools.build.lib.remote.disk.DiskCacheClient.lambda$uploadFile$5(DiskCacheClient.java:295)                                                                                         \r\n                at com.google.common.util.concurrent.TrustedListenableFutureTask$TrustedFutureInterruptibleTask.runInterruptibly(TrustedListenableFutureTask.java:131)                                             \r\n                at com.google.common.util.concurrent.InterruptibleTask.run(InterruptibleTask.java:75)\r\n                ... 4 more\r\n```\r\n","closed_by":{"login":"copybara-service[bot]","id":56741989,"node_id":"MDM6Qm90NTY3NDE5ODk=","avatar_url":"https://avatars.githubusercontent.com/in/44061?v=4","gravatar_id":"","url":"https://api.github.com/users/copybara-service%5Bbot%5D","html_url":"https://github.com/apps/copybara-service","followers_url":"https://api.github.com/users/copybara-service%5Bbot%5D/followers","following_url":"https://api.github.com/users/copybara-service%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/copybara-service%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/copybara-service%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/copybara-service%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/copybara-service%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/copybara-service%5Bbot%5D/repos","events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/23512/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bazelbuild/bazel/issues/23512/timeline","performed_via_github_app":null,"state_reason":"completed"}