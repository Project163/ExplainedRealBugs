{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/23429","repository_url":"https://api.github.com/repos/bazelbuild/bazel","labels_url":"https://api.github.com/repos/bazelbuild/bazel/issues/23429/labels{/name}","comments_url":"https://api.github.com/repos/bazelbuild/bazel/issues/23429/comments","events_url":"https://api.github.com/repos/bazelbuild/bazel/issues/23429/events","html_url":"https://github.com/bazelbuild/bazel/issues/23429","id":2487774186,"node_id":"I_kwDOATz7jc6USGvq","number":23429,"title":"\"expires\" field from credential helper causes re-invocation of helper too often","user":{"login":"nataliejameson","id":6351854,"node_id":"MDQ6VXNlcjYzNTE4NTQ=","avatar_url":"https://avatars.githubusercontent.com/u/6351854?v=4","gravatar_id":"","url":"https://api.github.com/users/nataliejameson","html_url":"https://github.com/nataliejameson","followers_url":"https://api.github.com/users/nataliejameson/followers","following_url":"https://api.github.com/users/nataliejameson/following{/other_user}","gists_url":"https://api.github.com/users/nataliejameson/gists{/gist_id}","starred_url":"https://api.github.com/users/nataliejameson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nataliejameson/subscriptions","organizations_url":"https://api.github.com/users/nataliejameson/orgs","repos_url":"https://api.github.com/users/nataliejameson/repos","events_url":"https://api.github.com/users/nataliejameson/events{/privacy}","received_events_url":"https://api.github.com/users/nataliejameson/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":106503259,"node_id":"MDU6TGFiZWwxMDY1MDMyNTk=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/type:%20bug","name":"type: bug","color":"0052cc","default":false,"description":null},{"id":192364170,"node_id":"MDU6TGFiZWwxOTIzNjQxNzA=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/P2","name":"P2","color":"e99695","default":false,"description":"We'll consider working on this in future. (Assignee optional)"},{"id":1193207358,"node_id":"MDU6TGFiZWwxMTkzMjA3MzU4","url":"https://api.github.com/repos/bazelbuild/bazel/labels/team-Remote-Exec","name":"team-Remote-Exec","color":"f1f442","default":false,"description":"Issues and PRs for the Execution (Remote) team"}],"state":"closed","locked":false,"assignee":{"login":"tjgq","id":4370077,"node_id":"MDQ6VXNlcjQzNzAwNzc=","avatar_url":"https://avatars.githubusercontent.com/u/4370077?v=4","gravatar_id":"","url":"https://api.github.com/users/tjgq","html_url":"https://github.com/tjgq","followers_url":"https://api.github.com/users/tjgq/followers","following_url":"https://api.github.com/users/tjgq/following{/other_user}","gists_url":"https://api.github.com/users/tjgq/gists{/gist_id}","starred_url":"https://api.github.com/users/tjgq/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tjgq/subscriptions","organizations_url":"https://api.github.com/users/tjgq/orgs","repos_url":"https://api.github.com/users/tjgq/repos","events_url":"https://api.github.com/users/tjgq/events{/privacy}","received_events_url":"https://api.github.com/users/tjgq/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"tjgq","id":4370077,"node_id":"MDQ6VXNlcjQzNzAwNzc=","avatar_url":"https://avatars.githubusercontent.com/u/4370077?v=4","gravatar_id":"","url":"https://api.github.com/users/tjgq","html_url":"https://github.com/tjgq","followers_url":"https://api.github.com/users/tjgq/followers","following_url":"https://api.github.com/users/tjgq/following{/other_user}","gists_url":"https://api.github.com/users/tjgq/gists{/gist_id}","starred_url":"https://api.github.com/users/tjgq/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tjgq/subscriptions","organizations_url":"https://api.github.com/users/tjgq/orgs","repos_url":"https://api.github.com/users/tjgq/repos","events_url":"https://api.github.com/users/tjgq/events{/privacy}","received_events_url":"https://api.github.com/users/tjgq/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":4,"created_at":"2024-08-26T20:59:20Z","updated_at":"2024-10-11T21:14:19Z","closed_at":"2024-08-28T09:17:21Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description of the bug:\n\n\nIt looks like in #21429 bazel started respecting the \"expires\" field from the json of credential_helper. We noticed after upgrading to bazel 7 that this caused our helper to be invoked hundreds to thousands of times in a build. Removing the \"expires\" field from the emitted json led to only being called a few times during a build. Looking at that PR, it looks like the ordering of `Duration.between()`'s parameters [here](https://github.com/bazelbuild/bazel/blob/7.3.1/src/main/java/com/google/devtools/build/lib/authandtls/credentialhelper/CredentialCacheExpiry.java#L44) are incorrect. Testing locally, if I reversed those parameters, there were not a ton of invocations as we were seeing before.\n\n### Which category does this issue belong to?\n\nRemote Execution\n\n### What's the simplest, easiest way to reproduce this bug? Please provide a minimal example if possible.\n\n\nAdd the following to .bazelrc\r\n```\r\n# build --credential_helper=\"%workspace%/cred_helper_no_expires.sh\"\r\n# build --credential_helper=\"%workspace%/cred_helper_expires.sh\"\r\nbuild --credential_helper_timeout=30s\r\nbuild --credential_helper_cache_duration=5m\r\n```\r\nHave `cred_helper_no_expires.sh` have something like:\r\n```\r\n#!/bin/bash\r\ndate >> /tmp/bazel_invocations\r\necho '{\"headers\": {\"Authorization\": [\"<some token here>\"]}}'\r\n```\r\nHave `cred_helper_expires.sh` have something like:\r\n```\r\n#!/bin/bash\r\ndate >> /tmp/bazel_invocations\r\necho '{\"expires\": \"2024-08-26T21:44:34+00:00\", \"headers\": {\"Authorization\": [\"<some token here>\"]}}'\r\n```\r\n\r\nRun a clean, then run a build with both the expires and the no_expires helper, removing /tmp/bazel_invocations before each call, and then after the build do wc -l on that file. The one with an expires field should have been invoked many more times.\r\n\r\nThis fix appears to fix the behavior:\r\n\r\n```diff\r\ndiff --git a/src/main/java/com/google/devtools/build/lib/authandtls/credentialhelper/CredentialCacheExpiry.java b/src/main/java/com/google/devtools/build/lib/authandtls/credentialhelper/CredentialCacheExpiry.java\r\nindex 2a8f385260..f09cdcb040 100644\r\n--- a/src/main/java/com/google/devtools/build/lib/authandtls/credentialhelper/CredentialCacheExpiry.java\r\n+++ b/src/main/java/com/google/devtools/build/lib/authandtls/credentialhelper/CredentialCacheExpiry.java\r\n@@ -41,7 +41,7 @@ final class CredentialCacheExpiry implements Expiry<URI, GetCredentialsResponse>\r\n     }\r\n\r\n     var now = Instant.now();\r\n-    return Duration.between(expires.get(), now);\r\n+    return Duration.between(now, expires.get());\r\n   }\r\n\r\n   @Override\r\n```\n\n### Which operating system are you running Bazel on?\n\n\nmacos, linux\n\n### What is the output of `bazel info release`?\n\n\nrelease 7.2.1\n\n### If `bazel info release` returns `development version` or `(@non-git)`, tell us how you built Bazel.\n\n\n_No response_\n\n### What's the output of `git remote get-url origin; git rev-parse HEAD` ?\n\n\n_No response_\n\n### If this is a regression, please try to identify the Bazel commit where the bug was introduced with bazelisk --bisect.\n\n\n_No response_\n\n### Have you found anything relevant by searching the web?\n\n_No response_\n\n### Any other information, logs, or outputs that you want to share?\n\n_No response_","closed_by":{"login":"copybara-service[bot]","id":56741989,"node_id":"MDM6Qm90NTY3NDE5ODk=","avatar_url":"https://avatars.githubusercontent.com/in/44061?v=4","gravatar_id":"","url":"https://api.github.com/users/copybara-service%5Bbot%5D","html_url":"https://github.com/apps/copybara-service","followers_url":"https://api.github.com/users/copybara-service%5Bbot%5D/followers","following_url":"https://api.github.com/users/copybara-service%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/copybara-service%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/copybara-service%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/copybara-service%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/copybara-service%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/copybara-service%5Bbot%5D/repos","events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/23429/reactions","total_count":3,"+1":3,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bazelbuild/bazel/issues/23429/timeline","performed_via_github_app":null,"state_reason":"completed"}