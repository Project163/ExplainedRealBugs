{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/17754","repository_url":"https://api.github.com/repos/bazelbuild/bazel","labels_url":"https://api.github.com/repos/bazelbuild/bazel/issues/17754/labels{/name}","comments_url":"https://api.github.com/repos/bazelbuild/bazel/issues/17754/comments","events_url":"https://api.github.com/repos/bazelbuild/bazel/issues/17754/events","html_url":"https://github.com/bazelbuild/bazel/issues/17754","id":1621718096,"node_id":"I_kwDOATz7jc5gqXRQ","number":17754,"title":"Running shell tests with `bazel run` intermittently omits outputs","user":{"login":"crydell-ericsson","id":91740096,"node_id":"U_kgDOBXfXwA","avatar_url":"https://avatars.githubusercontent.com/u/91740096?v=4","gravatar_id":"","url":"https://api.github.com/users/crydell-ericsson","html_url":"https://github.com/crydell-ericsson","followers_url":"https://api.github.com/users/crydell-ericsson/followers","following_url":"https://api.github.com/users/crydell-ericsson/following{/other_user}","gists_url":"https://api.github.com/users/crydell-ericsson/gists{/gist_id}","starred_url":"https://api.github.com/users/crydell-ericsson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/crydell-ericsson/subscriptions","organizations_url":"https://api.github.com/users/crydell-ericsson/orgs","repos_url":"https://api.github.com/users/crydell-ericsson/repos","events_url":"https://api.github.com/users/crydell-ericsson/events{/privacy}","received_events_url":"https://api.github.com/users/crydell-ericsson/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":106503259,"node_id":"MDU6TGFiZWwxMDY1MDMyNTk=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/type:%20bug","name":"type: bug","color":"0052cc","default":false,"description":null},{"id":192364170,"node_id":"MDU6TGFiZWwxOTIzNjQxNzA=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/P2","name":"P2","color":"e99695","default":false,"description":"We'll consider working on this in future. (Assignee optional)"},{"id":4761872548,"node_id":"LA_kwDOATz7jc8AAAABG9RopA","url":"https://api.github.com/repos/bazelbuild/bazel/labels/team-CLI","name":"team-CLI","color":"f1f442","default":false,"description":"Console UI"}],"state":"closed","locked":false,"assignee":{"login":"meisterT","id":418721,"node_id":"MDQ6VXNlcjQxODcyMQ==","avatar_url":"https://avatars.githubusercontent.com/u/418721?v=4","gravatar_id":"","url":"https://api.github.com/users/meisterT","html_url":"https://github.com/meisterT","followers_url":"https://api.github.com/users/meisterT/followers","following_url":"https://api.github.com/users/meisterT/following{/other_user}","gists_url":"https://api.github.com/users/meisterT/gists{/gist_id}","starred_url":"https://api.github.com/users/meisterT/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/meisterT/subscriptions","organizations_url":"https://api.github.com/users/meisterT/orgs","repos_url":"https://api.github.com/users/meisterT/repos","events_url":"https://api.github.com/users/meisterT/events{/privacy}","received_events_url":"https://api.github.com/users/meisterT/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"meisterT","id":418721,"node_id":"MDQ6VXNlcjQxODcyMQ==","avatar_url":"https://avatars.githubusercontent.com/u/418721?v=4","gravatar_id":"","url":"https://api.github.com/users/meisterT","html_url":"https://github.com/meisterT","followers_url":"https://api.github.com/users/meisterT/followers","following_url":"https://api.github.com/users/meisterT/following{/other_user}","gists_url":"https://api.github.com/users/meisterT/gists{/gist_id}","starred_url":"https://api.github.com/users/meisterT/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/meisterT/subscriptions","organizations_url":"https://api.github.com/users/meisterT/orgs","repos_url":"https://api.github.com/users/meisterT/repos","events_url":"https://api.github.com/users/meisterT/events{/privacy}","received_events_url":"https://api.github.com/users/meisterT/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":3,"created_at":"2023-03-13T15:21:49Z","updated_at":"2023-03-23T08:36:10Z","closed_at":"2023-03-23T08:36:10Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description of the bug:\r\n\r\n\r\nWe have a use case wherein we want to pipe the output of a Bazel test target implemented with a shell script to an external tool. There are certain parts of the output that are essential to pass to the external tool. In addition, we want to be able to run this target with `bazel run` in addition to `bazel test`.\r\n\r\nAssuming that the target is named `:foo` and that the external tool is named `my_tool`, we can do this with the command:\r\n\r\n```Bash\r\n$ bazel run :foo | my_tool\r\n```\r\n\r\nThis usually works, but `my_tool` will intermittently not receive the full intended output from the `:foo` run. The failures seem to be caused by a race condition that sometimes results in subprocesses being killed before they have had the opportunity to write to stdout. This problem seems to have been introduced by the commit 9051faa313f29b8ad8ded68b48b3f7af13108d77.\r\n\r\n### What's the simplest, easiest way to reproduce this bug? Please provide a minimal example if possible.\r\n\r\n\r\nCreate a new workspace with the files:\r\n\r\n```Python\r\n# File: BUILD\r\n\r\nsh_test(\r\n  name = \"foo\",\r\n  srcs = [\"foo.sh\"],\r\n)\r\n```\r\n\r\n```Bash\r\n# File: foo.sh\r\n\r\necho \"useless echo\"\r\necho \"useful echo\"\r\nexit 0\r\n```\r\n\r\nThen, try to grep \"useful echo\" from the script output repeatedly until failure. This can for example be done with:\r\n\r\n```Bash\r\n$ while bazel run :foo 2> /dev/null | grep \"useful echo\" > /dev/null ; do echo -n \".\" ; done && echo \"Failed to grep 'useful echo'\"\r\n```\r\n\r\nAlternatively, it's faster to use the `--script_path` option to create a separate script for running the test.\r\n\r\n```Bash\r\n$ bazel run :foo --script_path=foo_script.sh\r\n$ while ./foo_script.sh 2> /dev/null | grep \"useful echo\" > /dev/null ; do echo -n \".\" ; done && echo \"Failed to grep 'useful echo'\"\r\n```\r\n\r\nWe have found that this usually fails within 1000 iterations, but under heavy load from other processes on the machine it been observed to go below 50.\r\n\r\n### Which operating system are you running Bazel on?\r\n\r\n\r\nRed Hat Enterprise Linux Server 7.9\r\n\r\n### What is the output of `bazel info release`?\r\n\r\n\r\n_No response_\r\n\r\n### If `bazel info release` returns `development version` or `(@non-git)`, tell us how you built Bazel.\r\n\r\n\r\n_No response_\r\n\r\n### What's the output of `git remote get-url origin; git rev-parse master; git rev-parse HEAD` ?\r\n\r\n\r\n_No response_\r\n\r\n### Have you found anything relevant by searching the web?\r\n\r\n_No response_\r\n\r\n### Any other information, logs, or outputs that you want to share?\r\n\r\n_No response_","closed_by":{"login":"copybara-service[bot]","id":56741989,"node_id":"MDM6Qm90NTY3NDE5ODk=","avatar_url":"https://avatars.githubusercontent.com/in/44061?v=4","gravatar_id":"","url":"https://api.github.com/users/copybara-service%5Bbot%5D","html_url":"https://github.com/apps/copybara-service","followers_url":"https://api.github.com/users/copybara-service%5Bbot%5D/followers","following_url":"https://api.github.com/users/copybara-service%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/copybara-service%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/copybara-service%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/copybara-service%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/copybara-service%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/copybara-service%5Bbot%5D/repos","events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/17754/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bazelbuild/bazel/issues/17754/timeline","performed_via_github_app":null,"state_reason":"completed"}