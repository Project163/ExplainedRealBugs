{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/21268","repository_url":"https://api.github.com/repos/bazelbuild/bazel","labels_url":"https://api.github.com/repos/bazelbuild/bazel/issues/21268/labels{/name}","comments_url":"https://api.github.com/repos/bazelbuild/bazel/issues/21268/comments","events_url":"https://api.github.com/repos/bazelbuild/bazel/issues/21268/events","html_url":"https://github.com/bazelbuild/bazel/issues/21268","id":2126232464,"node_id":"I_kwDOATz7jc5-u7uQ","number":21268,"title":"[Java] Coverage not collected for some manifest jars","user":{"login":"ckilian867","id":98434879,"node_id":"U_kgDOBd3_Pw","avatar_url":"https://avatars.githubusercontent.com/u/98434879?v=4","gravatar_id":"","url":"https://api.github.com/users/ckilian867","html_url":"https://github.com/ckilian867","followers_url":"https://api.github.com/users/ckilian867/followers","following_url":"https://api.github.com/users/ckilian867/following{/other_user}","gists_url":"https://api.github.com/users/ckilian867/gists{/gist_id}","starred_url":"https://api.github.com/users/ckilian867/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ckilian867/subscriptions","organizations_url":"https://api.github.com/users/ckilian867/orgs","repos_url":"https://api.github.com/users/ckilian867/repos","events_url":"https://api.github.com/users/ckilian867/events{/privacy}","received_events_url":"https://api.github.com/users/ckilian867/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":106503259,"node_id":"MDU6TGFiZWwxMDY1MDMyNTk=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/type:%20bug","name":"type: bug","color":"0052cc","default":false,"description":null},{"id":192364134,"node_id":"MDU6TGFiZWwxOTIzNjQxMzQ=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/P1","name":"P1","color":"d93f0b","default":false,"description":"I'll work on this now. (Assignee required)"},{"id":920235609,"node_id":"MDU6TGFiZWw5MjAyMzU2MDk=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/coverage","name":"coverage","color":"FFC0CB","default":false,"description":""},{"id":1020663976,"node_id":"MDU6TGFiZWwxMDIwNjYzOTc2","url":"https://api.github.com/repos/bazelbuild/bazel/labels/team-Rules-Java","name":"team-Rules-Java","color":"f1f442","default":false,"description":"Issues for Java rules"}],"state":"closed","locked":false,"assignee":{"login":"c-mita","id":3749031,"node_id":"MDQ6VXNlcjM3NDkwMzE=","avatar_url":"https://avatars.githubusercontent.com/u/3749031?v=4","gravatar_id":"","url":"https://api.github.com/users/c-mita","html_url":"https://github.com/c-mita","followers_url":"https://api.github.com/users/c-mita/followers","following_url":"https://api.github.com/users/c-mita/following{/other_user}","gists_url":"https://api.github.com/users/c-mita/gists{/gist_id}","starred_url":"https://api.github.com/users/c-mita/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/c-mita/subscriptions","organizations_url":"https://api.github.com/users/c-mita/orgs","repos_url":"https://api.github.com/users/c-mita/repos","events_url":"https://api.github.com/users/c-mita/events{/privacy}","received_events_url":"https://api.github.com/users/c-mita/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"c-mita","id":3749031,"node_id":"MDQ6VXNlcjM3NDkwMzE=","avatar_url":"https://avatars.githubusercontent.com/u/3749031?v=4","gravatar_id":"","url":"https://api.github.com/users/c-mita","html_url":"https://github.com/c-mita","followers_url":"https://api.github.com/users/c-mita/followers","following_url":"https://api.github.com/users/c-mita/following{/other_user}","gists_url":"https://api.github.com/users/c-mita/gists{/gist_id}","starred_url":"https://api.github.com/users/c-mita/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/c-mita/subscriptions","organizations_url":"https://api.github.com/users/c-mita/orgs","repos_url":"https://api.github.com/users/c-mita/repos","events_url":"https://api.github.com/users/c-mita/events{/privacy}","received_events_url":"https://api.github.com/users/c-mita/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":5,"created_at":"2024-02-08T23:31:52Z","updated_at":"2024-02-27T03:41:25Z","closed_at":"2024-02-19T15:35:27Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description of the bug:\n\n\nWhen the classpath of a test is over the [CLASSPATH_LIMIT](https://github.com/bazelbuild/bazel/blob/master/src/main/java/com/google/devtools/build/lib/bazel/rules/java/java_stub_template.txt#L395), Bazel will create a [manifest jar](https://github.com/bazelbuild/bazel/blob/master/src/main/java/com/google/devtools/build/lib/bazel/rules/java/java_stub_template.txt#L344) that contains a manifest with an entry of the classpath.\r\n\r\nThe [JacocoCoverageRunner](https://cs.opensource.google/bazel/bazel/+/release-6.2.1:src/java_tools/junitrunner/java/com/google/testing/coverage/JacocoCoverageRunner.java;l=363) accounts for this and will undo the process to find the classpath during coverage collection. However, one of the checks [(urls.length == 1)](https://cs.opensource.google/bazel/bazel/+/release-6.2.1:src/java_tools/junitrunner/java/com/google/testing/coverage/JacocoCoverageRunner.java;l=368) assumes that the manifest jar is the only jar on the classpath.\r\n\r\nIf a test has a jar in its `data`, it can also be added to the classpath after the manifest jar. Since the length of the array is greater than 1, the logic is skipped and the coverage collection file is empty.\r\n\r\nWe were able to resolve this by adding a [patch](https://github.com/uber-common/bazel/commit/701f15ee14a8304164bc6b4cf25afa84bb1daeb7) to our fork, but the solution depends on the naming convention of the manifest jar from the stub template and also the ordering of the classpath, which may not be the most robust/futureproof solution. I wanted to raise this issue in case Bazel team had a better way to resolve it.\n\n### Which category does this issue belong to?\n\n_No response_\n\n### What's the simplest, easiest way to reproduce this bug? Please provide a minimal example if possible.\n\n\nCreated reproduction: https://github.com/ckilian867/bazel-coverage-bug \r\n\r\nSee README for details\n\n### Which operating system are you running Bazel on?\n\n\nPRETTY_NAME=\"Debian GNU/Linux 10 (buster)\"  NAME=\"Debian GNU/Linux\"  VERSION_ID=\"10\"  VERSION=\"10 (buster)\"  VERSION_CODENAME=buster  ID=debian  HOME_URL=\"https://www.debian.org/\"  SUPPORT_URL=\"https://www.debian.org/support\"  BUG_REPORT_URL=\"https://bugs.debian.org/\"\n\n### What is the output of `bazel info release`?\n\n\n$ bazel info release release 7.0.0\n\n### If `bazel info release` returns `development version` or `(@non-git)`, tell us how you built Bazel.\n\n\n_No response_\n\n### What's the output of `git remote get-url origin; git rev-parse HEAD` ?\n\n\n```text\n$ git remote get-url origin; git rev-parse HEAD\r\nhttps://github.com/ckilian867/bazel-coverage-bug.git\r\na1570f38065822f548cd279eb7e3bf75257d8a59\r\n```\n```\n\n\n### Is this a regression? If yes, please try to identify the Bazel commit where the bug was introduced.\n\n\n_No response_\n\n### Have you found anything relevant by searching the web?\n\nhttps://github.com/bazelbuild/bazel/issues/11847\n\n### Any other information, logs, or outputs that you want to share?\n\n_No response_","closed_by":{"login":"copybara-service[bot]","id":56741989,"node_id":"MDM6Qm90NTY3NDE5ODk=","avatar_url":"https://avatars.githubusercontent.com/in/44061?v=4","gravatar_id":"","url":"https://api.github.com/users/copybara-service%5Bbot%5D","html_url":"https://github.com/apps/copybara-service","followers_url":"https://api.github.com/users/copybara-service%5Bbot%5D/followers","following_url":"https://api.github.com/users/copybara-service%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/copybara-service%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/copybara-service%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/copybara-service%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/copybara-service%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/copybara-service%5Bbot%5D/repos","events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/21268/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bazelbuild/bazel/issues/21268/timeline","performed_via_github_app":null,"state_reason":"completed"}