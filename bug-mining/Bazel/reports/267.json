{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/24199","repository_url":"https://api.github.com/repos/bazelbuild/bazel","labels_url":"https://api.github.com/repos/bazelbuild/bazel/issues/24199/labels{/name}","comments_url":"https://api.github.com/repos/bazelbuild/bazel/issues/24199/comments","events_url":"https://api.github.com/repos/bazelbuild/bazel/issues/24199/events","html_url":"https://github.com/bazelbuild/bazel/issues/24199","id":2634388406,"node_id":"I_kwDOATz7jc6dBZO2","number":24199,"title":"`git_repository()` is sensitive to `GIT_DIR`","user":{"login":"rpwoodbu","id":1192829,"node_id":"MDQ6VXNlcjExOTI4Mjk=","avatar_url":"https://avatars.githubusercontent.com/u/1192829?v=4","gravatar_id":"","url":"https://api.github.com/users/rpwoodbu","html_url":"https://github.com/rpwoodbu","followers_url":"https://api.github.com/users/rpwoodbu/followers","following_url":"https://api.github.com/users/rpwoodbu/following{/other_user}","gists_url":"https://api.github.com/users/rpwoodbu/gists{/gist_id}","starred_url":"https://api.github.com/users/rpwoodbu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rpwoodbu/subscriptions","organizations_url":"https://api.github.com/users/rpwoodbu/orgs","repos_url":"https://api.github.com/users/rpwoodbu/repos","events_url":"https://api.github.com/users/rpwoodbu/events{/privacy}","received_events_url":"https://api.github.com/users/rpwoodbu/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":106503259,"node_id":"MDU6TGFiZWwxMDY1MDMyNTk=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/type:%20bug","name":"type: bug","color":"0052cc","default":false,"description":null},{"id":192364170,"node_id":"MDU6TGFiZWwxOTIzNjQxNzA=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/P2","name":"P2","color":"e99695","default":false,"description":"We'll consider working on this in future. (Assignee optional)"},{"id":1020663381,"node_id":"MDU6TGFiZWwxMDIwNjYzMzgx","url":"https://api.github.com/repos/bazelbuild/bazel/labels/team-ExternalDeps","name":"team-ExternalDeps","color":"f1f442","default":false,"description":"External dependency handling, remote repositiories, WORKSPACE file."}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2024-11-05T04:35:18Z","updated_at":"2024-11-22T23:26:11Z","closed_at":"2024-11-12T09:47:51Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description of the bug:\n\n\nIf `GIT_DIR` happens to be set, `git_repository()` may operate on the wrong clone. It is never useful for `git_repository()` to be influenced by these `GIT_` variables.\r\n\r\nIt is notable that Git sets `GIT_DIR` and others [when calling hooks](https://git-scm.com/docs/githooks#:~:text=Environment%20variables%2C%20such%20as%20GIT_DIR%2C%20GIT_WORK_TREE%2C%20etc.%2C%20are%20exported%20so%20that%20Git%20commands%20run%20by%20the%20hook%20can%20correctly%20locate%20the%20repository.). This complicates calling Bazel from within a hook (e.g., `bazel test`). In particular, when using Git worktrees, this can lead to `core.bare = true` being set, breaking the user's clone.\n\n### Which category does this issue belong to?\n\n_No response_\n\n### What's the simplest, easiest way to reproduce this bug? Please provide a minimal example if possible.\n\n\n```starlark\r\n# MODULE.bazel\r\ngit_repository = use_repo_rule(\"@bazel_tools//tools/build_defs/repo:git.bzl\", \"git_repository\")\r\ngit_repository(\r\n    name = \"foo\",\r\n    commit = \"1bbb388780f6016b6981a2f075fb457e999bc3bd\",\r\n    remote = \"https://github.com/bazelbuild/bazel-skylib.git\",\r\n)\r\n```\r\n\r\n```shell\r\n# In your terminal:\r\nexport GIT_DIR=\"\"\r\nbazel clean --expunge\r\nbazel query @foo//:all\r\n```\r\n\r\nProduces the following error:\r\n```\r\nRepository rule git_repository defined at:\r\n  /var/tmp/rpwoodbu/.cache/bazel/bc5487f033a0af65dff1ff0bd4000d75/external/bazel_tools/tools/build_defs/repo/git.bzl:189:33: in <toplevel>\r\nERROR: /var/tmp/rpwoodbu/.cache/bazel/bc5487f033a0af65dff1ff0bd4000d75/external/bazel_tools/tools/build_defs/repo/git_worker.bzl:210:9: An error occurred during the fetch of repository '_main~_repo_rules~foo':\r\n   Traceback (most recent call last):\r\n        File \"/var/tmp/rpwoodbu/.cache/bazel/bc5487f033a0af65dff1ff0bd4000d75/external/bazel_tools/tools/build_defs/repo/git.bzl\", line 180, column 35, in _git_repository_implementation\r\n                update = _clone_or_update_repo(ctx)\r\n        File \"/var/tmp/rpwoodbu/.cache/bazel/bc5487f033a0af65dff1ff0bd4000d75/external/bazel_tools/tools/build_defs/repo/git.bzl\", line 43, column 20, in _clone_or_update_repo\r\n                git_ = git_repo(ctx, directory)\r\n        File \"/var/tmp/rpwoodbu/.cache/bazel/bc5487f033a0af65dff1ff0bd4000d75/external/bazel_tools/tools/build_defs/repo/git_worker.bzl\", line 98, column 12, in git_repo\r\n                _update(ctx, git_repo)\r\n        File \"/var/tmp/rpwoodbu/.cache/bazel/bc5487f033a0af65dff1ff0bd4000d75/external/bazel_tools/tools/build_defs/repo/git_worker.bzl\", line 114, column 9, in _update\r\n                init(ctx, git_repo)\r\n        File \"/var/tmp/rpwoodbu/.cache/bazel/bc5487f033a0af65dff1ff0bd4000d75/external/bazel_tools/tools/build_defs/repo/git_worker.bzl\", line 131, column 15, in init\r\n                _error(ctx.name, cl, st.stderr)\r\n        File \"/var/tmp/rpwoodbu/.cache/bazel/bc5487f033a0af65dff1ff0bd4000d75/external/bazel_tools/tools/build_defs/repo/git_worker.bzl\", line 210, column 9, in _error\r\n                fail(\"error running '%s' while working with @%s:\\n%s\" % (command_text, name, stderr))\r\nError in fail: error running 'git init /var/tmp/rpwoodbu/.cache/bazel/bc5487f033a0af65dff1ff0bd4000d75/external/_main~_repo_rules~foo' while working with @_main~_repo_rules~foo:\r\nfatal: The empty string is not a valid path\r\n```\r\n\n\n### Which operating system are you running Bazel on?\n\n\nDebian Linux\n\n### What is the output of `bazel info release`?\n\n\nrelease 7.4.0\n\n### If `bazel info release` returns `development version` or `(@non-git)`, tell us how you built Bazel.\n\n\n_No response_\n\n### What's the output of `git remote get-url origin; git rev-parse HEAD` ?\n\n\n_No response_\n\n### If this is a regression, please try to identify the Bazel commit where the bug was introduced with bazelisk --bisect.\n\n\n_No response_\n\n### Have you found anything relevant by searching the web?\n\n_No response_\n\n### Any other information, logs, or outputs that you want to share?\n\n_No response_","closed_by":{"login":"copybara-service[bot]","id":56741989,"node_id":"MDM6Qm90NTY3NDE5ODk=","avatar_url":"https://avatars.githubusercontent.com/in/44061?v=4","gravatar_id":"","url":"https://api.github.com/users/copybara-service%5Bbot%5D","html_url":"https://github.com/apps/copybara-service","followers_url":"https://api.github.com/users/copybara-service%5Bbot%5D/followers","following_url":"https://api.github.com/users/copybara-service%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/copybara-service%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/copybara-service%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/copybara-service%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/copybara-service%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/copybara-service%5Bbot%5D/repos","events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/24199/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bazelbuild/bazel/issues/24199/timeline","performed_via_github_app":null,"state_reason":"completed"}