{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/20038","repository_url":"https://api.github.com/repos/bazelbuild/bazel","labels_url":"https://api.github.com/repos/bazelbuild/bazel/issues/20038/labels{/name}","comments_url":"https://api.github.com/repos/bazelbuild/bazel/issues/20038/comments","events_url":"https://api.github.com/repos/bazelbuild/bazel/issues/20038/events","html_url":"https://github.com/bazelbuild/bazel/issues/20038","id":1975257934,"node_id":"I_kwDOATz7jc51vAtO","number":20038,"title":"ctx.expand_location() on py_binary expands to multiple files","user":{"login":"jacky8hyf","id":5271176,"node_id":"MDQ6VXNlcjUyNzExNzY=","avatar_url":"https://avatars.githubusercontent.com/u/5271176?v=4","gravatar_id":"","url":"https://api.github.com/users/jacky8hyf","html_url":"https://github.com/jacky8hyf","followers_url":"https://api.github.com/users/jacky8hyf/followers","following_url":"https://api.github.com/users/jacky8hyf/following{/other_user}","gists_url":"https://api.github.com/users/jacky8hyf/gists{/gist_id}","starred_url":"https://api.github.com/users/jacky8hyf/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jacky8hyf/subscriptions","organizations_url":"https://api.github.com/users/jacky8hyf/orgs","repos_url":"https://api.github.com/users/jacky8hyf/repos","events_url":"https://api.github.com/users/jacky8hyf/events{/privacy}","received_events_url":"https://api.github.com/users/jacky8hyf/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":106503259,"node_id":"MDU6TGFiZWwxMDY1MDMyNTk=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/type:%20bug","name":"type: bug","color":"0052cc","default":false,"description":null},{"id":192364241,"node_id":"MDU6TGFiZWwxOTIzNjQyNDE=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/P3","name":"P3","color":"fbca04","default":false,"description":"We're not considering working on this, but happy to review a PR. (No assignee)"},{"id":4761858692,"node_id":"LA_kwDOATz7jc8AAAABG9QyhA","url":"https://api.github.com/repos/bazelbuild/bazel/labels/team-Rules-API","name":"team-Rules-API","color":"f1f442","default":false,"description":"API for writing rules/aspects: providers, runfiles, actions, artifacts"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2023-11-03T00:42:15Z","updated_at":"2025-01-09T00:26:35Z","closed_at":"2025-01-09T00:26:35Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description of the bug:\r\n\r\n\r\nWhen one runs `ctx.expand_location()` on the expression `$(locations <a py_binary>)` for a custom rule, multiple files are returned.\r\n\r\nHowever, this is not the case for genrule's.\r\n\r\n### Which category does this issue belong to?\r\n\r\n\r\n_No response_\r\n\r\n### What's the simplest, easiest way to reproduce this bug? Please provide a minimal example if possible.\r\n\r\n\r\nBUILD\r\n```\r\nload(\":myrule.bzl\", \"myrule\")\r\n\r\npy_binary(\r\n    name = \"a\",\r\n    srcs = [\"a.py\"],\r\n)\r\n\r\ngenrule(\r\n    name = \"gen\",\r\n    tools = [\":a\"],\r\n    outs = [\"gen.txt\"],\r\n    cmd = \"echo $(locations :a); : > $@\",\r\n)\r\n\r\nmyrule(\r\n    name = \"mytarget\",\r\n    deps = [\r\n        \":a\",\r\n    ],\r\n    value = \"$(locations :a)\",\r\n)\r\n```\r\n\r\nmyrule.bzl\r\n```\r\ndef _impl(ctx):\r\n    print(ctx.expand_location(ctx.attr.value, ctx.attr.deps))\r\n\r\nmyrule = rule(\r\n    implementation = _impl,\r\n    attrs = {\r\n        \"deps\": attr.label_list(),\r\n        \"value\": attr.string(),\r\n    },\r\n)\r\n```\r\n\r\nAnd create an empty `WORKSPACE` and `a.py` file.\r\n\r\nWith the above setup:\r\n\r\n- If you run `bazel build :gen`, it will print `bazel-out/k8-opt-exec-2B5CBBC6/bin/a`, indicating that `$(locations :a)` correctly resolved to the generated binary.\r\n- If you run `bazel build :mytarget`, it will print `./a.py bazel-out/k8-fastbuild/bin/a`, indicating that `$(locations :a)` resolves to multiple files.\r\n\r\nI tried turning `tools` into `deps` for my `:gen` target. Then, `bazel build :gen` also prints two paths.\r\n\r\nI tried adding `cfg = \"exec\"` to `deps`'s `attr.label_list`, but the result is the same.\r\n\r\nThis makes me unable to resolve to the correct binary to execute without some hacky code (e.g. [CL](https://r.android.com/c/kernel/build/+/2816459/6/kleaf/artifact_tests/py_test_hack.bzl))\r\n\r\nHow do I call ctx.expand_location so it produces the same output like genrule.tools does?\r\n\r\n### Which operating system are you running Bazel on?\r\n\r\n\r\nLinux\r\n\r\n### What is the output of `bazel info release`?\r\n\r\n\r\nrelease 6.4.0\r\n\r\n### If `bazel info release` returns `development version` or `(@non-git)`, tell us how you built Bazel.\r\n\r\n\r\n_No response_\r\n\r\n### What's the output of `git remote get-url origin; git rev-parse master; git rev-parse HEAD` ?\r\n\r\n\r\n_No response_\r\n\r\n### Is this a regression? If yes, please try to identify the Bazel commit where the bug was introduced.\r\n\r\n\r\nI don't think so.\r\n\r\n### Have you found anything relevant by searching the web?\r\n\r\nhttps://stackoverflow.com/questions/57497270/bazel-how-to-run-py-binary-to-produce-input-files-before-testing\r\n\r\n### Any other information, logs, or outputs that you want to share?\r\n\r\n_No response_","closed_by":{"login":"copybara-service[bot]","id":56741989,"node_id":"MDM6Qm90NTY3NDE5ODk=","avatar_url":"https://avatars.githubusercontent.com/in/44061?v=4","gravatar_id":"","url":"https://api.github.com/users/copybara-service%5Bbot%5D","html_url":"https://github.com/apps/copybara-service","followers_url":"https://api.github.com/users/copybara-service%5Bbot%5D/followers","following_url":"https://api.github.com/users/copybara-service%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/copybara-service%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/copybara-service%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/copybara-service%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/copybara-service%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/copybara-service%5Bbot%5D/repos","events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/20038/reactions","total_count":3,"+1":3,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bazelbuild/bazel/issues/20038/timeline","performed_via_github_app":null,"state_reason":"completed"}