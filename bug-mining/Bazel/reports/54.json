{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/18977","repository_url":"https://api.github.com/repos/bazelbuild/bazel","labels_url":"https://api.github.com/repos/bazelbuild/bazel/issues/18977/labels{/name}","comments_url":"https://api.github.com/repos/bazelbuild/bazel/issues/18977/comments","events_url":"https://api.github.com/repos/bazelbuild/bazel/issues/18977/events","html_url":"https://github.com/bazelbuild/bazel/issues/18977","id":1810523802,"node_id":"I_kwDOATz7jc5r6maa","number":18977,"title":"Bazel crashes when using cquery + build_options() + setting starlark string_list flags in platform_mappings","user":{"login":"Colecf","id":350553,"node_id":"MDQ6VXNlcjM1MDU1Mw==","avatar_url":"https://avatars.githubusercontent.com/u/350553?v=4","gravatar_id":"","url":"https://api.github.com/users/Colecf","html_url":"https://github.com/Colecf","followers_url":"https://api.github.com/users/Colecf/followers","following_url":"https://api.github.com/users/Colecf/following{/other_user}","gists_url":"https://api.github.com/users/Colecf/gists{/gist_id}","starred_url":"https://api.github.com/users/Colecf/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Colecf/subscriptions","organizations_url":"https://api.github.com/users/Colecf/orgs","repos_url":"https://api.github.com/users/Colecf/repos","events_url":"https://api.github.com/users/Colecf/events{/privacy}","received_events_url":"https://api.github.com/users/Colecf/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":106503259,"node_id":"MDU6TGFiZWwxMDY1MDMyNTk=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/type:%20bug","name":"type: bug","color":"0052cc","default":false,"description":null},{"id":192364134,"node_id":"MDU6TGFiZWwxOTIzNjQxMzQ=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/P1","name":"P1","color":"d93f0b","default":false,"description":"I'll work on this now. (Assignee required)"},{"id":1020660688,"node_id":"MDU6TGFiZWwxMDIwNjYwNjg4","url":"https://api.github.com/repos/bazelbuild/bazel/labels/team-Configurability","name":"team-Configurability","color":"f1f442","default":false,"description":"platforms, toolchains, cquery, select(), config transitions"}],"state":"closed","locked":false,"assignee":{"login":"fmeum","id":4312191,"node_id":"MDQ6VXNlcjQzMTIxOTE=","avatar_url":"https://avatars.githubusercontent.com/u/4312191?v=4","gravatar_id":"","url":"https://api.github.com/users/fmeum","html_url":"https://github.com/fmeum","followers_url":"https://api.github.com/users/fmeum/followers","following_url":"https://api.github.com/users/fmeum/following{/other_user}","gists_url":"https://api.github.com/users/fmeum/gists{/gist_id}","starred_url":"https://api.github.com/users/fmeum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fmeum/subscriptions","organizations_url":"https://api.github.com/users/fmeum/orgs","repos_url":"https://api.github.com/users/fmeum/repos","events_url":"https://api.github.com/users/fmeum/events{/privacy}","received_events_url":"https://api.github.com/users/fmeum/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"fmeum","id":4312191,"node_id":"MDQ6VXNlcjQzMTIxOTE=","avatar_url":"https://avatars.githubusercontent.com/u/4312191?v=4","gravatar_id":"","url":"https://api.github.com/users/fmeum","html_url":"https://github.com/fmeum","followers_url":"https://api.github.com/users/fmeum/followers","following_url":"https://api.github.com/users/fmeum/following{/other_user}","gists_url":"https://api.github.com/users/fmeum/gists{/gist_id}","starred_url":"https://api.github.com/users/fmeum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fmeum/subscriptions","organizations_url":"https://api.github.com/users/fmeum/orgs","repos_url":"https://api.github.com/users/fmeum/repos","events_url":"https://api.github.com/users/fmeum/events{/privacy}","received_events_url":"https://api.github.com/users/fmeum/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":1,"created_at":"2023-07-18T18:58:36Z","updated_at":"2023-07-20T14:47:28Z","closed_at":"2023-07-20T14:47:27Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description of the bug:\n\n\nWhen setting starlark a starlark string_list build flag in platform_mappings files (a feature recently added in https://github.com/bazelbuild/bazel/issues/18199)  and then cquerying for a target's `build_options()`, we see this stack trace:\r\n\r\n```\r\nFATAL: bazel crashed due to an internal error. Printing stack trace:\r\nnet.starlark.java.eval.Starlark$UncheckedEvalException: InvalidStarlarkValueException thrown during Starlark evaluation\r\n\tat <starlark>.build_options(<builtin>:0)\r\n\tat <starlark>.format(--starlark:expr:1)\r\nCaused by: net.starlark.java.eval.Starlark$InvalidStarlarkValueException: invalid Starlark value: class com.google.common.collect.RegularImmutableList\r\n\tat net.starlark.java.eval.Starlark.checkValid(Starlark.java:131)\r\n\tat net.starlark.java.eval.Dict.lambda$copyOf$2(Dict.java:472)\r\n\tat com.google.common.collect.RegularImmutableMap.forEach(RegularImmutableMap.java:292)\r\n\tat net.starlark.java.eval.Dict.copyOf(Dict.java:472)\r\n\tat net.starlark.java.eval.Starlark.fromJava(Starlark.java:212)\r\n\tat net.starlark.java.eval.MethodDescriptor.call(MethodDescriptor.java:216)\r\n\tat net.starlark.java.eval.BuiltinFunction.fastcall(BuiltinFunction.java:78)\r\n\tat net.starlark.java.eval.Starlark.fastcall(Starlark.java:695)\r\n\tat net.starlark.java.eval.Eval.evalCall(Eval.java:682)\r\n\tat net.starlark.java.eval.Eval.eval(Eval.java:497)\r\n\tat net.starlark.java.eval.Eval.execReturn(Eval.java:249)\r\n\tat net.starlark.java.eval.Eval.exec(Eval.java:288)\r\n\tat net.starlark.java.eval.Eval.execStatements(Eval.java:82)\r\n\tat net.starlark.java.eval.Eval.execFunctionBody(Eval.java:66)\r\n\tat net.starlark.java.eval.StarlarkFunction.fastcall(StarlarkFunction.java:175)\r\n\tat net.starlark.java.eval.Starlark.fastcall(Starlark.java:695)\r\n\tat com.google.devtools.build.lib.query2.cquery.StarlarkOutputFormatterCallback.processOutput(StarlarkOutputFormatterCallback.java:235)\r\n\tat com.google.devtools.build.lib.query2.engine.OutputFormatterCallback.process(OutputFormatterCallback.java:54)\r\n\tat com.google.devtools.build.lib.buildtool.PostAnalysisQueryProcessor.doPostAnalysisQuery(PostAnalysisQueryProcessor.java:197)\r\n\tat com.google.devtools.build.lib.buildtool.PostAnalysisQueryProcessor.process(PostAnalysisQueryProcessor.java:87)\r\n\tat com.google.devtools.build.lib.buildtool.BuildTool.buildTargets(BuildTool.java:211)\r\n\tat com.google.devtools.build.lib.buildtool.BuildTool.processRequest(BuildTool.java:506)\r\n\tat com.google.devtools.build.lib.buildtool.BuildTool.processRequest(BuildTool.java:474)\r\n\tat com.google.devtools.build.lib.runtime.commands.CqueryCommand.exec(CqueryCommand.java:185)\r\n\tat com.google.devtools.build.lib.runtime.BlazeCommandDispatcher.execExclusively(BlazeCommandDispatcher.java:650)\r\n\tat com.google.devtools.build.lib.runtime.BlazeCommandDispatcher.exec(BlazeCommandDispatcher.java:245)\r\n\tat com.google.devtools.build.lib.server.GrpcServerImpl.executeCommand(GrpcServerImpl.java:550)\r\n\tat com.google.devtools.build.lib.server.GrpcServerImpl.lambda$run$1(GrpcServerImpl.java:614)\r\n\tat io.grpc.Context$1.run(Context.java:566)\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(Unknown Source)\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)\r\n\tat java.base/java.lang.Thread.run(Unknown Source)\r\n```\r\n\r\nThis is not an issue with other types of build settings like strings, but I haven't tested them all.\n\n### What's the simplest, easiest way to reproduce this bug? Please provide a minimal example if possible.\n\n\nCreate a bazel workspace with the following files:\r\n\r\nBUILD:\r\n```\r\nload(\":rules.bzl\", \"string_list_flag\", \"write_string_list_build_setting\")\r\n\r\nstring_list_flag(\r\n    name = \"my_flag\",\r\n    build_setting_default = [],\r\n)\r\n\r\nwrite_string_list_build_setting(\r\n    name = \"my_flag_written\",\r\n    build_setting = \":my_flag\",\r\n)\r\n\r\nplatform(\r\n    name = \"my_platform\",\r\n)\r\n```\r\n\r\nrules.bzl:\r\n```\r\nBuildSettingInfo = provider(\r\n    doc = \"A singleton provider that contains the raw value of a build setting\",\r\n    fields = {\r\n        \"value\": \"The value of the build setting in the current configuration. \" +\r\n                 \"This value may come from the command line or an upstream transition, \" +\r\n                 \"or else it will be the build setting's default.\",\r\n    },\r\n)\r\n\r\ndef _impl(ctx):\r\n    return BuildSettingInfo(value = ctx.build_setting_value)\r\n\r\nstring_list_flag = rule(\r\n    implementation = _impl,\r\n    build_setting = config.string_list(flag = True),\r\n)\r\n\r\ndef _write_string_list_build_setting_impl(ctx):\r\n    out = ctx.actions.declare_file(ctx.attr.name)\r\n    ctx.actions.write(out, \",\".join(ctx.attr.build_setting[BuildSettingInfo].value))\r\n    return DefaultInfo(files = depset([out]))\r\n\r\nwrite_string_list_build_setting = rule(\r\n    implementation = _write_string_list_build_setting_impl,\r\n    attrs = {\r\n        \"build_setting\": attr.label(),\r\n    },\r\n)\r\n```\r\n\r\nplatform_mappings:\r\n```\r\nplatforms:\r\n  @//:my_platform\r\n    --//:my_flag=foo,bar\r\n```\r\n\r\nThen run:\r\n\r\n`USE_BAZEL_VERSION=\"ade32e68dc7aa23b5038cd44a4b86cb491818139\" bazelisk cquery //:my_flag_written --platforms=//:my_platform --output=starlark --starlark:expr='build_options(target)'`\n\n### Which operating system are you running Bazel on?\n\n\nLinux\n\n### What is the output of `bazel info release`?\n\n\nI'm testing on commit ade32e68dc7aa23b5038cd44a4b86cb491818139, but in theory anything after commit 8a7f5e2f488609085f62f933cdfbf87e97cbf0fd is affected\n\n### If `bazel info release` returns `development version` or `(@non-git)`, tell us how you built Bazel.\n\n\n_No response_\n\n### What's the output of `git remote get-url origin; git rev-parse master; git rev-parse HEAD` ?\n\n\n_No response_\n\n### Is this a regression? If yes, please try to identify the Bazel commit where the bug was introduced.\n\n\n_No response_\n\n### Have you found anything relevant by searching the web?\n\n_No response_\n\n### Any other information, logs, or outputs that you want to share?\n\n_No response_","closed_by":{"login":"copybara-service[bot]","id":56741989,"node_id":"MDM6Qm90NTY3NDE5ODk=","avatar_url":"https://avatars.githubusercontent.com/in/44061?v=4","gravatar_id":"","url":"https://api.github.com/users/copybara-service%5Bbot%5D","html_url":"https://github.com/apps/copybara-service","followers_url":"https://api.github.com/users/copybara-service%5Bbot%5D/followers","following_url":"https://api.github.com/users/copybara-service%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/copybara-service%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/copybara-service%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/copybara-service%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/copybara-service%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/copybara-service%5Bbot%5D/repos","events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/18977/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bazelbuild/bazel/issues/18977/timeline","performed_via_github_app":null,"state_reason":"completed"}