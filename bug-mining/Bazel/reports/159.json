{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/21777","repository_url":"https://api.github.com/repos/bazelbuild/bazel","labels_url":"https://api.github.com/repos/bazelbuild/bazel/issues/21777/labels{/name}","comments_url":"https://api.github.com/repos/bazelbuild/bazel/issues/21777/comments","events_url":"https://api.github.com/repos/bazelbuild/bazel/issues/21777/events","html_url":"https://github.com/bazelbuild/bazel/issues/21777","id":2203328266,"node_id":"I_kwDOATz7jc6DVB8K","number":21777,"title":"Cache eviction hangs action evaluation with remote execution","user":{"login":"hoj-stripe","id":106406964,"node_id":"U_kgDOBlekNA","avatar_url":"https://avatars.githubusercontent.com/u/106406964?v=4","gravatar_id":"","url":"https://api.github.com/users/hoj-stripe","html_url":"https://github.com/hoj-stripe","followers_url":"https://api.github.com/users/hoj-stripe/followers","following_url":"https://api.github.com/users/hoj-stripe/following{/other_user}","gists_url":"https://api.github.com/users/hoj-stripe/gists{/gist_id}","starred_url":"https://api.github.com/users/hoj-stripe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hoj-stripe/subscriptions","organizations_url":"https://api.github.com/users/hoj-stripe/orgs","repos_url":"https://api.github.com/users/hoj-stripe/repos","events_url":"https://api.github.com/users/hoj-stripe/events{/privacy}","received_events_url":"https://api.github.com/users/hoj-stripe/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":106503259,"node_id":"MDU6TGFiZWwxMDY1MDMyNTk=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/type:%20bug","name":"type: bug","color":"0052cc","default":false,"description":null},{"id":192364134,"node_id":"MDU6TGFiZWwxOTIzNjQxMzQ=","url":"https://api.github.com/repos/bazelbuild/bazel/labels/P1","name":"P1","color":"d93f0b","default":false,"description":"I'll work on this now. (Assignee required)"},{"id":1193207358,"node_id":"MDU6TGFiZWwxMTkzMjA3MzU4","url":"https://api.github.com/repos/bazelbuild/bazel/labels/team-Remote-Exec","name":"team-Remote-Exec","color":"f1f442","default":false,"description":"Issues and PRs for the Execution (Remote) team"}],"state":"closed","locked":false,"assignee":{"login":"coeuvre","id":5947531,"node_id":"MDQ6VXNlcjU5NDc1MzE=","avatar_url":"https://avatars.githubusercontent.com/u/5947531?v=4","gravatar_id":"","url":"https://api.github.com/users/coeuvre","html_url":"https://github.com/coeuvre","followers_url":"https://api.github.com/users/coeuvre/followers","following_url":"https://api.github.com/users/coeuvre/following{/other_user}","gists_url":"https://api.github.com/users/coeuvre/gists{/gist_id}","starred_url":"https://api.github.com/users/coeuvre/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/coeuvre/subscriptions","organizations_url":"https://api.github.com/users/coeuvre/orgs","repos_url":"https://api.github.com/users/coeuvre/repos","events_url":"https://api.github.com/users/coeuvre/events{/privacy}","received_events_url":"https://api.github.com/users/coeuvre/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"coeuvre","id":5947531,"node_id":"MDQ6VXNlcjU5NDc1MzE=","avatar_url":"https://avatars.githubusercontent.com/u/5947531?v=4","gravatar_id":"","url":"https://api.github.com/users/coeuvre","html_url":"https://github.com/coeuvre","followers_url":"https://api.github.com/users/coeuvre/followers","following_url":"https://api.github.com/users/coeuvre/following{/other_user}","gists_url":"https://api.github.com/users/coeuvre/gists{/gist_id}","starred_url":"https://api.github.com/users/coeuvre/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/coeuvre/subscriptions","organizations_url":"https://api.github.com/users/coeuvre/orgs","repos_url":"https://api.github.com/users/coeuvre/repos","events_url":"https://api.github.com/users/coeuvre/events{/privacy}","received_events_url":"https://api.github.com/users/coeuvre/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":2,"created_at":"2024-03-22T21:04:06Z","updated_at":"2024-05-06T21:40:40Z","closed_at":"2024-03-28T11:22:47Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description of the bug:\n\n\n**Setup:**\r\n- Ten targets with one output file each (“prerequisite targets”).\r\n- One target that takes each of the ten prerequisite targets as input (“final target”).\r\n- Remote cache, and some value for --remote_executor flag.\r\n\r\n**Reproduction:**\r\n1. Build the prerequisite targets in output base A.\r\n2. Delete all CAS entries from the remote cache.\r\na. Do not delete any AC entries. These AC entries are now invalid.\r\nb. At this point, FindMissingBlobs will return all CAS entries as missing.\r\n3. Build the final target in output base B.\r\n\r\n  In this scenario, we made all the AC entries invalid before the GetActionResult RPC returned them as found. However, in practice, the entry could become invalid immediately after the GetActionResult RPC returns. That’s just difficult to actually simulate.\r\n\r\n**Expected behavior:**\r\n\r\n  Bazel crashes with exit code 39 since the AC entries for the prerequisite targets are invalid.\r\nExpected logs, as shown when less than 8 input files were missing:\r\n```\r\nStarting local Bazel server and connecting to it...\r\nINFO: Invocation ID: f64ad5ff-8ce6-4530-a346-3d034b8e3185\r\nINFO: Analyzed target //:less_than_eight_files (5 packages loaded, 19 targets configured).\r\n[1 / 1] checking cached actions\r\nERROR: /pay/src/cache-eviction-hang/BUILD:11:8: Executing genrule //:less_than_eight_files failed: (Exit 34): 6 errors during bulk transfer:\r\ncom.google.devtools.build.lib.remote.common.CacheNotFoundException: Missing digest: 1121cfccd5913f0a63fec40a6ffd44ea64f9dc135c66634ba001d10bcf4302a2/2 for bazel-out/k8-opt/bin/file_3\r\ncom.google.devtools.build.lib.remote.common.CacheNotFoundException: Missing digest: 7de1555df0c2700329e815b93b32c571c3ea54dc967b89e81ab73b9972b72d1d/2 for bazel-out/k8-opt/bin/file_4\r\ncom.google.devtools.build.lib.remote.common.CacheNotFoundException: Missing digest: 53c234e5e8472b6ac51c1ae1cab3fe06fad053beb8ebfd8977b010655bfdd3c3/2 for bazel-out/k8-opt/bin/file_2\r\ncom.google.devtools.build.lib.remote.common.CacheNotFoundException: Missing digest: f0b5c2c2211c8d67ed15e75e656c7862d086e9245420892a7de62cd9ec582a06/2 for bazel-out/k8-opt/bin/file_5\r\ncom.google.devtools.build.lib.remote.common.CacheNotFoundException: Missing digest: 9a271f2a916b0b6ee6cecb2426f0b3206ef074578be55d9bc94f6f3fe3ab86aa/2 for bazel-out/k8-opt/bin/file_0\r\ncom.google.devtools.build.lib.remote.common.CacheNotFoundException: Missing digest: 4355a46b19d348dc2f57c046f8ef63d4538ebb936000f3c9ee954a27460dd865/2 for bazel-out/k8-opt/bin/file_1\r\nTarget //:less_than_eight_files failed to build\r\nUse --verbose_failures to see the command lines of failed build steps.\r\nINFO: Elapsed time: 3.388s, Critical Path: 0.30s\r\nINFO: 8 processes: 6 remote cache hit, 2 internal.\r\nERROR: Build did NOT complete successfully\r\nBazel exited with 39\r\n```\r\n\r\n**Actual behavior:**\r\n\r\n  Logs from step 3 indicate both hang, one on download which times out, another afterwards:\r\n\r\n```\r\nStarting local Bazel server and connecting to it...\r\nINFO: Invocation ID: d1c93586-627e-48ed-a7d8-a20e46b5de11\r\nINFO: Analyzed target //:all_files (5 packages loaded, 27 targets configured).\r\n[1 / 1] checking cached actions\r\n[11 / 12] Executing genrule //:all_files; Downloading file_5; 59s remote\r\nERROR: /pay/src/cache-eviction-hang/BUILD:3:8: Executing genrule //:all_files failed: (Exit 34): Timed out when waiting for uploads\r\nTarget //:all_files failed to build\r\nUse --verbose_failures to see the command lines of failed build steps.\r\nINFO: Elapsed time: 63.271s, Critical Path: 60.10s\r\nINFO: 12 processes: 10 remote cache hit, 2 internal.\r\nERROR: Build did NOT complete successfully\r\n\r\n<hangs indefinitely>\r\n```\r\n\r\n**Investigation:**\r\n\r\n  The second hang after the build failure looks very similar to https://github.com/bazelbuild/bazel/issues/21626, and we were able to prevent the hang by disabling `AsyncTaskCache`. However, when Bazel exits with timeout we don’t get the exit code 39, and we also don’t think Bazel should be timing out on input uploads.\r\n\r\n  The download happens [when uploadBlob() tries to set its input](https://cs.opensource.google/bazel/bazel/+/master:src/main/java/com/google/devtools/build/lib/remote/GrpcCacheClient.java;l=511?q=uploadBlobAsync&ss=bazel%2Fbazel) from a remote file. That contains [a ByteStream/Read operation](https://cs.opensource.google/bazel/bazel/+/master:src/main/java/com/google/devtools/build/lib/remote/GrpcCacheClient.java;l=408-409?q=uploadBlobAsync&ss=bazel%2Fbazel), in this case to a nonexistent blob, which eventually gets executed [when the uploader tries to read from the Chunker](https://cs.opensource.google/bazel/bazel/+/master:src/main/java/com/google/devtools/build/lib/remote/ByteStreamUploader.java;l=420?q=upload&ss=bazel%2Fbazel). When `ByteStream/Read` returns an RPC error, Bazel doesn’t properly subscribe to that while trying to upload and it [never gets the CacheNotFoundException](https://cs.opensource.google/bazel/bazel/+/master:src/main/java/com/google/devtools/build/lib/remote/GrpcCacheClient.java;l=452-453?q=NOT_FOUND%20path:grpc&ss=bazel%2Fbazel) because `OnError()` is never called.\r\n\r\n  We were able to get the `CacheNotFoundException` wrapped in `ExecutionException` when we forcefully executed the [upload() call here](https://cs.opensource.google/bazel/bazel/+/master:src/main/java/com/google/devtools/build/lib/remote/ByteStreamUploader.java;l=365?q=upload&ss=bazel%2Fbazel) by calling `upload(committedSize).get()`, but we could not yet find a place to properly subscribe to the Exception while maintaining parallelism.\r\n\r\n  We think this may not be just limited to BwoB issues. We suspect any multiple RPC failures from this path could hang the uploads, even if it’s not about missing cache entries, but we haven't yet tried reproducing it in other ways.\n\n### Which category does this issue belong to?\n\nRemote Execution\n\n### What's the simplest, easiest way to reproduce this bug? Please provide a minimal example if possible.\n\n\nCheck out https://github.com/hoj-stripe/cache-eviction-hang, run `./repro_hanging.sh`.\n\n### Which operating system are you running Bazel on?\n\n\nUbuntu 20.04.6 LTS\n\n### What is the output of `bazel info release`?\n\n\nrelease 7.1.0\n\n### If `bazel info release` returns `development version` or `(@non-git)`, tell us how you built Bazel.\n\n\n_No response_\n\n### What's the output of `git remote get-url origin; git rev-parse HEAD` ?\n\n\n_No response_\n\n### Is this a regression? If yes, please try to identify the Bazel commit where the bug was introduced.\n\n\nIt was introduced in https://github.com/bazelbuild/bazel/commit/aafe1235c55f6cdcfc577a40736aaeb9ebaca23b (for 6.1.0)\r\n\r\nBut haven't yet bisected the last time it was fixed, since it used to hang before as well.\r\n5.4.0 doesn’t hang and\r\n5.3.2 hangs on `//:less_than_eight_files`.\n\n### Have you found anything relevant by searching the web?\n\n_No response_\n\n### Any other information, logs, or outputs that you want to share?\n\ncc @clintharrison @sushain97 @coeuvre ","closed_by":{"login":"copybara-service[bot]","id":56741989,"node_id":"MDM6Qm90NTY3NDE5ODk=","avatar_url":"https://avatars.githubusercontent.com/in/44061?v=4","gravatar_id":"","url":"https://api.github.com/users/copybara-service%5Bbot%5D","html_url":"https://github.com/apps/copybara-service","followers_url":"https://api.github.com/users/copybara-service%5Bbot%5D/followers","following_url":"https://api.github.com/users/copybara-service%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/copybara-service%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/copybara-service%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/copybara-service%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/copybara-service%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/copybara-service%5Bbot%5D/repos","events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bazelbuild/bazel/issues/21777/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bazelbuild/bazel/issues/21777/timeline","performed_via_github_app":null,"state_reason":"completed"}