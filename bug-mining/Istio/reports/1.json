{"url":"https://api.github.com/repos/istio/istio/issues/48990","repository_url":"https://api.github.com/repos/istio/istio","labels_url":"https://api.github.com/repos/istio/istio/issues/48990/labels{/name}","comments_url":"https://api.github.com/repos/istio/istio/issues/48990/comments","events_url":"https://api.github.com/repos/istio/istio/issues/48990/events","html_url":"https://github.com/istio/istio/issues/48990","id":2100336367,"node_id":"I_kwDOBGvVPc59MJbv","number":48990,"title":"Race in Makefile `depend`/`init` target","user":{"login":"jtagcat","id":38327267,"node_id":"MDQ6VXNlcjM4MzI3MjY3","avatar_url":"https://avatars.githubusercontent.com/u/38327267?v=4","gravatar_id":"","url":"https://api.github.com/users/jtagcat","html_url":"https://github.com/jtagcat","followers_url":"https://api.github.com/users/jtagcat/followers","following_url":"https://api.github.com/users/jtagcat/following{/other_user}","gists_url":"https://api.github.com/users/jtagcat/gists{/gist_id}","starred_url":"https://api.github.com/users/jtagcat/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jtagcat/subscriptions","organizations_url":"https://api.github.com/users/jtagcat/orgs","repos_url":"https://api.github.com/users/jtagcat/repos","events_url":"https://api.github.com/users/jtagcat/events{/privacy}","received_events_url":"https://api.github.com/users/jtagcat/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2024-01-25T12:54:18Z","updated_at":"2024-01-25T19:11:33Z","closed_at":"2024-01-25T19:11:33Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I found a ~90% reproducible race when building without Docker.\r\n\r\nWhat I was trying to do: Update [Arch istio](https://gitlab.archlinux.org/archlinux/packaging/packages/istio/) package (should be better named `istioctl`). `istioctl` doesn't actually need the dependencies as defined in Makefiles (depend/init) for building nor running it. Please correct me if I'm wrong, will create a new ticket for that later.\r\n\r\n```\r\n  export BUILD_WITH_CONTAINER=0\r\n```\r\n\r\nMakefile.core.mk:\r\n```\r\n# Downloads envoy, based on the SHA defined in the base pilot Dockerfile\r\ninit: $(TARGET_OUT)/istio_is_init init-ztunnel-rs\r\n\t@mkdir -p ${TARGET_OUT}/logs\r\n\t@mkdir -p ${TARGET_OUT}/release\r\n```\r\n\r\n`init` has two dependants, which are run **parallel**: `$(TARGET_OUT)/istio_is_init` (envoy) and `init-ztunnel-rs` (ztunnel).\r\n\r\nbin/init.sh downloads envoy:\r\n```\r\n    # Download and extract the binary to the output directory.\r\n    echo \"Downloading ${SIDECAR}: $1 to $2\"\r\n    time ${DOWNLOAD_COMMAND} --header \"${AUTH_HEADER:-}\" \"$1\" | tar xz\r\n# jtagcat ^^^^^^^^^^^^^^^^^^^^ This is curl\r\n```\r\n\r\nTar errors the build:\r\n```\r\ntar: usr/local/bin: Cannot utime: No such file or directory\r\ntar: usr/local: Cannot utime: No such file or directory\r\ntar: usr: Cannot utime: No such file or directory\r\ntar: Exiting with failure status due to previous errors\r\n```\r\n\r\nWhen you change the code to first write to a file, and then `cat file | tar xz`, everything works fine. The download takes ~5s and leaves a gap where tar constructs the directory structure, and while the binary part of the tar archive is downloaded.\r\n\r\nMeanwhile in build_ztunnel.sh:\r\n```\r\n  time ${DOWNLOAD_COMMAND} --header \"${AUTH_HEADER:-}\" \"$1\" > \"${BASE_NAME}\"\r\n# jtagcat ^^^^^^^^^^^^^^^^^^^ This is curl\r\n  chmod +x \"${BASE_NAME}\"\r\n\r\n  # Copy the extracted binary to the output location\r\n  cp \"${BASE_NAME}\" \"$2\"\r\n# jtagcat: no extraction took place!\r\n\r\n  # Remove the extracted binary.\r\n  rm -rf usr\r\n# jtagcat: nor was usr created, the `--force` flag in rm does not cause `set -o errexit` to propagate errors. Even in envoy's case, the flag isn't needed.\r\n```\r\n\r\nThe ztunnel routine completes faster, nuking `usr/`. Interestingly, it doesn't extract or create the directory, its download is not an archive, but a binary.\r\n\r\nThe script structure and comments indicate that the second script is a copy of the first with minor modifications. Mistakes happen. I guess I'll be submitting a patch.","closed_by":{"login":"istio-testing","id":25311884,"node_id":"MDQ6VXNlcjI1MzExODg0","avatar_url":"https://avatars.githubusercontent.com/u/25311884?v=4","gravatar_id":"","url":"https://api.github.com/users/istio-testing","html_url":"https://github.com/istio-testing","followers_url":"https://api.github.com/users/istio-testing/followers","following_url":"https://api.github.com/users/istio-testing/following{/other_user}","gists_url":"https://api.github.com/users/istio-testing/gists{/gist_id}","starred_url":"https://api.github.com/users/istio-testing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/istio-testing/subscriptions","organizations_url":"https://api.github.com/users/istio-testing/orgs","repos_url":"https://api.github.com/users/istio-testing/repos","events_url":"https://api.github.com/users/istio-testing/events{/privacy}","received_events_url":"https://api.github.com/users/istio-testing/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/istio/istio/issues/48990/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/istio/istio/issues/48990/timeline","performed_via_github_app":null,"state_reason":"completed"}