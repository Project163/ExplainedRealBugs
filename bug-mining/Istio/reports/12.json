{"url":"https://api.github.com/repos/istio/istio/issues/56352","repository_url":"https://api.github.com/repos/istio/istio","labels_url":"https://api.github.com/repos/istio/istio/issues/56352/labels{/name}","comments_url":"https://api.github.com/repos/istio/istio/issues/56352/comments","events_url":"https://api.github.com/repos/istio/istio/issues/56352/events","html_url":"https://github.com/istio/istio/issues/56352","id":3072792635,"node_id":"I_kwDOBGvVPc63Jxg7","number":56352,"title":"mTLS gets disabled unexpectedly when PILOT_ENABLE_TELEMETRY_LABEL or PILOT_ENDPOINT_TELEMETRY_LABEL is set to false","user":{"login":"yunazuno","id":364147,"node_id":"MDQ6VXNlcjM2NDE0Nw==","avatar_url":"https://avatars.githubusercontent.com/u/364147?v=4","gravatar_id":"","url":"https://api.github.com/users/yunazuno","html_url":"https://github.com/yunazuno","followers_url":"https://api.github.com/users/yunazuno/followers","following_url":"https://api.github.com/users/yunazuno/following{/other_user}","gists_url":"https://api.github.com/users/yunazuno/gists{/gist_id}","starred_url":"https://api.github.com/users/yunazuno/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yunazuno/subscriptions","organizations_url":"https://api.github.com/users/yunazuno/orgs","repos_url":"https://api.github.com/users/yunazuno/repos","events_url":"https://api.github.com/users/yunazuno/events{/privacy}","received_events_url":"https://api.github.com/users/yunazuno/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":735781806,"node_id":"MDU6TGFiZWw3MzU3ODE4MDY=","url":"https://api.github.com/repos/istio/istio/labels/area/networking","name":"area/networking","color":"0e8a16","default":false,"description":null},{"id":813133538,"node_id":"MDU6TGFiZWw4MTMxMzM1Mzg=","url":"https://api.github.com/repos/istio/istio/labels/area/extensions%20and%20telemetry","name":"area/extensions and telemetry","color":"0e8a16","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2025-05-19T07:19:33Z","updated_at":"2025-05-27T20:33:35Z","closed_at":"2025-05-27T20:33:35Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Is this the right place to submit this?\n\n- [x] This is not a security vulnerability or a crashing bug\n- [x] This is not a question about how to use Istio\n\n### Bug Description\n\nWhen `PILOT_ENABLE_TELEMETRY_LABEL` or `PILOT_ENDPOINT_TELEMETRY_LABEL` is set to `false`, a destination endpoint's `filter_metadata` field becomes missing. The field is supposed to hold the label `tlsMode` with its value `istio` ([ref](https://github.com/istio/istio/wiki/Troubleshooting-Istio#mutual-tls-troubleshooting)).\n\nIt forces a client to attempt sending plain text traffic to the destination, which ends up causing two issues:\n- The traffic downgrades to plain text regardless of the auto mTLS\n- The traffic fails if a destination's mTLS mode is set to STRICT\n\nReproduction steps:\n\n1. Install Istio while specifying the problematic environment variable(s)\n2. Deploy the bookinfo application\n3. Set the mTLS mode to STRICT\n4. Make a request from an arbitrary pod to the productpage service\n\n```\n$ istioctl install --set values.pilot.env.PILOT_ENABLE_TELEMETRY_LABEL=false --set values.pilot.env.PILOT_ENDPOINT_TELEMETRY_LABEL=false\n$ kubectl label namespace default istio-injection=enabled\n$ kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml\n$ kubectl apply -f - <<EOF\napiVersion: security.istio.io/v1\nkind: PeerAuthentication\nmetadata:\n  name: default\nspec:\n  mtls:\n    mode: STRICT\nEOF\n$ kubectl exec \"$(kubectl get pod -l app=ratings -o jsonpath='{.items[0].metadata.name}')\" -c ratings -- curl -sv productpage:9080/productpage\n```\n\n\nExpected behavior:\n\nThe client pod gets a response from the productpage service.\n\nActual behavior:\n\nThe client pod gets an error with status code 503.\n\n```\n$ kubectl exec \"$(kubectl get pod -l app=ratings -o jsonpath='{.items[0].metadata.name}')\" -c ratings -- curl -sv productpage:9080/productpage\n*   Trying 34.118.238.108:9080...\n* Connected to productpage (34.118.238.108) port 9080 (#0)\n> GET /productpage HTTP/1.1\n> Host: productpage:9080\n> User-Agent: curl/7.88.1\n> Accept: */*\n>\n<upstream connect error or disconnect/reset before headers. reset reason: connection termination HTTP/1.1 503 Service Unavailable\n< content-length: 95\n< content-type: text/plain\n< date: Mon, 19 May 2025 06:44:25 GMT\n< server: envoy\n<\n{ [95 bytes data]\n* Connection #0 to host productpage left intact\n```\n\nIf I check the EDS response received by the client pod, I see the productpage pod endpoint doesn't have the tlsMode label.\n\n```\n$ IP=$(kubectl get pod -l app=productpage -o jsonpath=\"{.items[0].status.podIP}\")\n$ kubectl exec -it $(kubectl get pod -l app=ratings -o jsonpath='{.items[0].metadata.name}') -c istio-proxy -- curl 'localhost:15000/config_dump?include_eds=true' | grep ${IP} -A15 -B5\n        \"lb_endpoints\": [\n         {\n          \"endpoint\": {\n           \"address\": {\n            \"socket_address\": {\n             \"address\": \"10.64.5.16\",\n             \"port_value\": 9080\n            }\n           },\n           \"health_check_config\": {}\n          },\n          \"health_status\": \"HEALTHY\",\n          \"metadata\": {},\n          \"load_balancing_weight\": 1\n         }\n        ],\n        \"load_balancing_weight\": 1\n       }\n      ],\n      \"policy\": {\n       \"overprovisioning_factor\": 140\n```\n\n\n\n\n### Version\n\n```Text\n$ istioctl version\nclient version: 1.26.0\ncontrol plane version: 1.26.0\ndata plane version: 1.26.0 (7 proxies)\n$ kubectl version\nClient Version: v1.32.5\nKustomize Version: v5.5.0\nServer Version: v1.32.3-gke.1785003\n```\n\n### Additional Information\n\n_No response_","closed_by":{"login":"istio-testing","id":25311884,"node_id":"MDQ6VXNlcjI1MzExODg0","avatar_url":"https://avatars.githubusercontent.com/u/25311884?v=4","gravatar_id":"","url":"https://api.github.com/users/istio-testing","html_url":"https://github.com/istio-testing","followers_url":"https://api.github.com/users/istio-testing/followers","following_url":"https://api.github.com/users/istio-testing/following{/other_user}","gists_url":"https://api.github.com/users/istio-testing/gists{/gist_id}","starred_url":"https://api.github.com/users/istio-testing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/istio-testing/subscriptions","organizations_url":"https://api.github.com/users/istio-testing/orgs","repos_url":"https://api.github.com/users/istio-testing/repos","events_url":"https://api.github.com/users/istio-testing/events{/privacy}","received_events_url":"https://api.github.com/users/istio-testing/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/istio/istio/issues/56352/reactions","total_count":6,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":6,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/istio/istio/issues/56352/timeline","performed_via_github_app":null,"state_reason":"completed"}