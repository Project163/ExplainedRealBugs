<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:54:34 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[EXEC-34] Race condition prevent watchdog working using ExecuteStreamHandler</title>
                <link>https://issues.apache.org/jira/browse/EXEC-34</link>
                <project id="12310814" key="EXEC">Commons Exec</project>
                    <description>&lt;p&gt;Consider this test case (in &lt;em&gt;DefaultExecutorTest&lt;/em&gt; class):&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    /**
     * Start a async process using a stream handler and terminate it manually
     * before the watchdog timeout occurs
     */
    public void testExecuteAsyncWithStreamHandlerAndUserTermination() throws Exception {
        CommandLine cl = new CommandLine(foreverTestScript);
        ExecuteWatchdog watchdog = new ExecuteWatchdog(Integer.MAX_VALUE);
        PumpStreamHandler streamHanlder = new PumpStreamHandler(System.out, System.err);
        exec.setStreamHandler(streamHanlder);
        MockExecuteResultHandler handler = new MockExecuteResultHandler();
        exec.execute(cl, handler);
        // DON&apos;T wait for script to run
        //Thread.sleep(2000);
        // teminate it
        watchdog.destroyProcess();
        assertTrue(&quot;Watchdog should have killed the process&quot;,watchdog.killedProcess());
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It fails (at least in my environment) because when &lt;em&gt;watchdog.destroyProcess()&lt;/em&gt; is invoked the external process is not bound to the watchdog yet.&lt;/p&gt;

&lt;p&gt;Although there are possible several workarounds, but all of them seem to me very intrusive in the code. So, I prefer some discussion before preparing and submitting a patch.&lt;br/&gt;
IMHO, the watchdog should handle a reference to the thread running the process, not to the process itself. In this way, interrupting signals can be transport using default &lt;em&gt;interrupt()&lt;/em&gt; method of class &lt;em&gt;Thread&lt;/em&gt;.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Windows Vista 64bit, dual core CPU&lt;/p&gt;</environment>
        <key id="12411695">EXEC-34</key>
            <summary>Race condition prevent watchdog working using ExecuteStreamHandler</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="simone.tripodi">Simone Tripodi</assignee>
                                    <reporter username="mferrante">Marco Ferrante</reporter>
                        <labels>
                    </labels>
                <created>Mon, 5 Jan 2009 16:20:41 +0000</created>
                <updated>Sat, 28 Dec 2013 18:21:15 +0000</updated>
                            <resolved>Wed, 30 Nov 2011 07:59:29 +0000</resolved>
                                                    <fixVersion>1.2</fixVersion>
                                        <due></due>
                            <votes>3</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="12662929" author="sgoeschl" created="Mon, 12 Jan 2009 10:39:08 +0000"  >&lt;p&gt;To be honest I was aware of the issue therefore the &quot;Thread.sleep&quot; statements in the regression tests. Having said that I think this is an artificial use case since I have to wait for some time for any external process to start and finish before I consider the process &quot;hanging&quot;. &lt;/p&gt;</comment>
                            <comment id="12769177" author="kwin" created="Fri, 23 Oct 2009 11:03:10 +0000"  >&lt;p&gt;The same applies to e.g. isWatching(). I first tried to wait for an asynchronous process to finish, with the help of ExecuteWatchdog.isWatching(), apparently with no success, due to this bug. You should at least document this flaw.&lt;/p&gt;</comment>
                            <comment id="12897876" author="sgoeschl" created="Thu, 12 Aug 2010 18:20:07 +0000"  >&lt;p&gt;Changing priority to minor since this is an artificial problem not happening in production - nobody would start a subprocess and immediately kill it.&lt;/p&gt;</comment>
                            <comment id="12898631" author="sgoeschl" created="Sat, 14 Aug 2010 19:33:24 +0000"  >&lt;p&gt;Well, actually the sample is buggy since the following line is missing&lt;/p&gt;

&lt;p&gt;exec.setWatchdog(watchdog)&lt;/p&gt;

&lt;p&gt;which injects the newly created &apos;Process&apos; instance into the watchdog and without *Process&apos; instance &apos;watchdog.destroy()&apos; has no effect&lt;/p&gt;</comment>
                            <comment id="13152758" author="krosenvold" created="Fri, 18 Nov 2011 09:59:17 +0000"  >&lt;p&gt;Atatched is a patch that fixes &lt;a href=&quot;https://issues.apache.org/jira/browse/EXEC-34&quot; title=&quot;Race condition prevent watchdog working using ExecuteStreamHandler&quot; class=&quot;issue-link&quot; data-issue-key=&quot;EXEC-34&quot;&gt;&lt;del&gt;EXEC-34&lt;/del&gt;&lt;/a&gt;. The patch enables the failing tests that were already in the codebase.&lt;/p&gt;

&lt;p&gt;We have just ported the selenium project to commons-exec, and I think all sorts of TESTS are the valid use cases for this patch; for instance: A test starts a process, and wants to verify that the process is running. That implies calling watching.isWatching as one option. We had /lots/ of problems with this race condition when porting selenium and we worked around the problem by subclassing the watchdog.&lt;/p&gt;

&lt;p&gt;I will also be porting apache-maven to use commons-exec sometime soon, and I expect to be running into the same problems with tests there.&lt;/p&gt;</comment>
                            <comment id="13155214" author="simone.tripodi" created="Tue, 22 Nov 2011 15:51:21 +0000"  >&lt;p&gt;Hi Kristian,&lt;br/&gt;
I&apos;m trying to apply your patch and just noticed you created it using git - can you provide me infos about how to apply it to svn? Sorry but that&apos;s a lack of my knowledge.&lt;br/&gt;
Many thanks in advance!&lt;br/&gt;
Simo&lt;/p&gt;</comment>
                            <comment id="13157172" author="olamy" created="Fri, 25 Nov 2011 14:36:14 +0000"  >&lt;p&gt;@simone should work with:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;patch -p1 &amp;lt; patchfile
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13157264" author="sebb@apache.org" created="Fri, 25 Nov 2011 17:43:43 +0000"  >&lt;p&gt;Or just change the patch headers. Instead of&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;diff --git a/src/main/java/org/apache/commons/exec/DefaultExecutor.java b/src/main/java/org/apache/commons/exec/DefaultExecutor.java&lt;br/&gt;
index 2182d85..2110e02 100644&lt;br/&gt;
&amp;#8212; a/src/main/java/org/apache/commons/exec/DefaultExecutor.java&lt;br/&gt;
+++ b/src/main/java/org/apache/commons/exec/DefaultExecutor.java&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;change it to be&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;&amp;#8212; src/main/java/org/apache/commons/exec/DefaultExecutor.java&lt;br/&gt;
+++ src/main/java/org/apache/commons/exec/DefaultExecutor.java&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;and it should work.&lt;/p&gt;

&lt;p&gt;Yes, it&apos;s a bit tedious. &lt;br/&gt;
I find I often have to do a similar trick with Eclipse-generated patches which default to being relative to the workspace. This is not portable, unless both workspaces use exactly the same project names.&lt;/p&gt;</comment>
                            <comment id="13159560" author="olamy" created="Tue, 29 Nov 2011 21:35:26 +0000"  >&lt;p&gt;+1: nice patch!&lt;/p&gt;</comment>
                            <comment id="13159890" author="simone.tripodi" created="Wed, 30 Nov 2011 07:59:32 +0000"  >&lt;p&gt;Patch has been successfully applied, see &lt;a href=&quot;https://svn.apache.org/viewvc?view=revision&amp;amp;revision=1208315&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;r1208315&lt;/a&gt; thanks Kristian for submitting the patch!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                            <outwardlinks description="breaks">
                                        <issuelink>
            <issuekey id="12623058">EXEC-71</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12504192" name="EXEC34.patch" size="3995" author="krosenvold" created="Fri, 18 Nov 2011 09:59:17 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>117738</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 51 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i13suv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>230305</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>