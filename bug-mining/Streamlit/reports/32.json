{"url":"https://api.github.com/repos/streamlit/streamlit/issues/6066","repository_url":"https://api.github.com/repos/streamlit/streamlit","labels_url":"https://api.github.com/repos/streamlit/streamlit/issues/6066/labels{/name}","comments_url":"https://api.github.com/repos/streamlit/streamlit/issues/6066/comments","events_url":"https://api.github.com/repos/streamlit/streamlit/issues/6066/events","html_url":"https://github.com/streamlit/streamlit/issues/6066","id":1571983885,"node_id":"I_kwDODCoeTs5dspIN","number":6066,"title":"Streamlit startup time could be reduced from 1s to 400ms","user":{"login":"sfc-gh-tteixeira","id":103002884,"node_id":"U_kgDOBiOzBA","avatar_url":"https://avatars.githubusercontent.com/u/103002884?v=4","gravatar_id":"","url":"https://api.github.com/users/sfc-gh-tteixeira","html_url":"https://github.com/sfc-gh-tteixeira","followers_url":"https://api.github.com/users/sfc-gh-tteixeira/followers","following_url":"https://api.github.com/users/sfc-gh-tteixeira/following{/other_user}","gists_url":"https://api.github.com/users/sfc-gh-tteixeira/gists{/gist_id}","starred_url":"https://api.github.com/users/sfc-gh-tteixeira/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sfc-gh-tteixeira/subscriptions","organizations_url":"https://api.github.com/users/sfc-gh-tteixeira/orgs","repos_url":"https://api.github.com/users/sfc-gh-tteixeira/repos","events_url":"https://api.github.com/users/sfc-gh-tteixeira/events{/privacy}","received_events_url":"https://api.github.com/users/sfc-gh-tteixeira/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1516285327,"node_id":"MDU6TGFiZWwxNTE2Mjg1MzI3","url":"https://api.github.com/repos/streamlit/streamlit/labels/type:enhancement","name":"type:enhancement","color":"0E8A16","default":false,"description":"Requests for feature enhancements or new features"},{"id":1848260284,"node_id":"MDU6TGFiZWwxODQ4MjYwMjg0","url":"https://api.github.com/repos/streamlit/streamlit/labels/area:performance","name":"area:performance","color":"C2E0C6","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2023-02-06T06:15:36Z","updated_at":"2024-02-13T23:11:12Z","closed_at":"2024-02-13T23:11:12Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Problem\r\n\r\nThe time between `streamlit run foo.py` and having a blank app load in the browser feels a bit slow nowadays! \r\n\r\nBased on a quick analysis, a simple way to cut startup time by 60% would be to lazy-load certain imports.\r\n\r\n\r\n### Methodology\r\n\r\n1. On a new environment, install Streamlit\r\n2. Call `python -X importtime -c 'import streamlit' 2> latency.log`\r\n3. Look at latency.log by hand or with [Tuna](https://github.com/nschloe/tuna).\r\n\r\nInterestingly, even if you run this multiple times, there's no real change in the numbers.\r\n\r\nMachine: M2 Macbook Pro\r\n\r\n\r\n### Results\r\n\r\nThe result of step 2 above is attached as [latency.log](https://github.com/streamlit/streamlit/files/10660238/latency.log).\r\n\r\nAlso, here's a pretty chart:\r\n<img width=\"2105\" alt=\"Screenshot 2023-02-05 at 22 01 09\" src=\"https://user-images.githubusercontent.com/103002884/216897272-6af739cd-b24d-4ebb-aadd-c2719a6760b8.png\">\r\n\r\n\r\n\r\n### Findings\r\n\r\nStreamlit takes 1s to initialize:\r\n  ```\r\n  import time:       641 |    1011102 | streamlit\r\n  ```\r\n\r\nMajor culprits:\r\n\r\n- [x] Importing pandas inside type_util: 240ms\r\n  ```\r\n  import time:      2062 |     240916 |                           pandas\r\n  import time:       927 |     281330 |                         streamlit.type_util\r\n  import time:      2104 |     440877 |                       streamlit.runtime.state.session_state\r\n  import time:       320 |     441196 |                     streamlit.runtime.state.safe_session_state\r\n  import time:       175 |     442065 |                   streamlit.runtime.state\r\n  import time:        11 |     442076 |                 streamlit.runtime.state.session_state\r\n  import time:       444 |     465120 |             streamlit.runtime.app_session\r\n  import time:       785 |     506798 |           streamlit.runtime.runtime\r\n  import time:       146 |     506944 |         streamlit.runtime\r\n  import time:        11 |     506954 |       streamlit.runtime.scriptrunner\r\n  import time:       193 |     507147 |     streamlit.cursor\r\n  ```\r\n\r\n- [x] Importing pandas.style in st.arrow: 209ms\r\n  ```\r\n  import time:       957 |     209657 |       pandas.io.formats.style\r\n  import time:       278 |     209934 |     streamlit.elements.arrow\r\n  ```\r\n\r\n- [ ] Setting up the plotly theme: 49ms\r\n  ```\r\n  import time:     46609 |      49771 |       streamlit.elements.lib.streamlit_plotly_theme\r\n  import time:      2810 |      54590 |     streamlit.elements.plotly_chart\r\n  ```\r\n\r\n- [x] Importing altair inside of arrow_altair (mostly to set up theme): 48ms\r\n  ```\r\n  import time:       345 |      48145 |       altair\r\n  import time:       124 |        124 |           streamlit.elements.lib\r\n  import time:       264 |        388 |         streamlit.elements.lib.dicttools\r\n  import time:       293 |        680 |       streamlit.elements.arrow_vega_lite\r\n  import time:       300 |        300 |         streamlit.elements.form\r\n  import time:       197 |        497 |       streamlit.elements.utils\r\n  import time:       462 |      49782 |     streamlit.elements.arrow_altair\r\n  ```\r\n\r\n- [x] Loading the validators library: 40ms\r\n  ```\r\n  import time:       309 |      40592 |       validators\r\n  import time:       413 |      41005 |     streamlit.elements.media\r\n  ```\r\n\r\n- [x] Importing requests inside streamlit.version: 52ms\r\n  ```\r\n  import time:       364 |      51844 |     requests\r\n  import time:      1632 |      59739 |   streamlit.version\r\n  ```\r\n\r\n- [x] String util is slow to import probably due to emoji computation: 27ms\r\n  ```\r\n  import time:     26409 |      27205 |       streamlit.string_util\r\n  import time:       168 |      27587 |     streamlit.file_util\r\n  import time:       729 |      58916 |   streamlit.config\r\n  ```\r\n\r\n### Proposal\r\n\r\n1. For some of the culprits above, we can just move the offending `import` out of the file's root scope and into the actual scope where it's used.\r\n2. For the files where we import modules to set up Altair and Plotly theming, stop setting up the themes globally at import time and, instead, change the Altair and Plotly figures to use our theme before marshalling them.\r\n3. For the emoji computation: move `EMOJI_EXTRACTION_REGEX` into a `functools.cache`'d function.\r\n4. Consider no longer checking the Streamlit version upstream to prompt people to upgrade. We do this with 10% probability on every run, and requires `requests` (52ms) -- but it's unclear whether this actually causes a nontrivial number of people to actually upgrade.\r\n \r\n---\r\n\r\nCommunity voting on feature requests enables the Streamlit team to understand which features are most important to our users.\r\n\r\n**If you'd like the Streamlit team to prioritize this feature request, please use the üëç (thumbs up emoji) reaction in response to the initial post.**\r\n","closed_by":{"login":"lukasmasuch","id":2852129,"node_id":"MDQ6VXNlcjI4NTIxMjk=","avatar_url":"https://avatars.githubusercontent.com/u/2852129?v=4","gravatar_id":"","url":"https://api.github.com/users/lukasmasuch","html_url":"https://github.com/lukasmasuch","followers_url":"https://api.github.com/users/lukasmasuch/followers","following_url":"https://api.github.com/users/lukasmasuch/following{/other_user}","gists_url":"https://api.github.com/users/lukasmasuch/gists{/gist_id}","starred_url":"https://api.github.com/users/lukasmasuch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lukasmasuch/subscriptions","organizations_url":"https://api.github.com/users/lukasmasuch/orgs","repos_url":"https://api.github.com/users/lukasmasuch/repos","events_url":"https://api.github.com/users/lukasmasuch/events{/privacy}","received_events_url":"https://api.github.com/users/lukasmasuch/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/streamlit/streamlit/issues/6066/reactions","total_count":29,"+1":23,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":6,"eyes":0},"timeline_url":"https://api.github.com/repos/streamlit/streamlit/issues/6066/timeline","performed_via_github_app":null,"state_reason":"completed"}