{"url":"https://api.github.com/repos/streamlit/streamlit/issues/9284","repository_url":"https://api.github.com/repos/streamlit/streamlit","labels_url":"https://api.github.com/repos/streamlit/streamlit/issues/9284/labels{/name}","comments_url":"https://api.github.com/repos/streamlit/streamlit/issues/9284/comments","events_url":"https://api.github.com/repos/streamlit/streamlit/issues/9284/events","html_url":"https://github.com/streamlit/streamlit/issues/9284","id":2468491655,"node_id":"I_kwDODCoeTs6TIjGH","number":9284,"title":"st.file_uploader AxiosError caused by _streamlit_xsrf cookie deletion when popup windows are closed","user":{"login":"connortann","id":71127464,"node_id":"MDQ6VXNlcjcxMTI3NDY0","avatar_url":"https://avatars.githubusercontent.com/u/71127464?v=4","gravatar_id":"","url":"https://api.github.com/users/connortann","html_url":"https://github.com/connortann","followers_url":"https://api.github.com/users/connortann/followers","following_url":"https://api.github.com/users/connortann/following{/other_user}","gists_url":"https://api.github.com/users/connortann/gists{/gist_id}","starred_url":"https://api.github.com/users/connortann/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/connortann/subscriptions","organizations_url":"https://api.github.com/users/connortann/orgs","repos_url":"https://api.github.com/users/connortann/repos","events_url":"https://api.github.com/users/connortann/events{/privacy}","received_events_url":"https://api.github.com/users/connortann/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1516285324,"node_id":"MDU6TGFiZWwxNTE2Mjg1MzI0","url":"https://api.github.com/repos/streamlit/streamlit/labels/type:bug","name":"type:bug","color":"D93F0B","default":false,"description":"Something isn't working"},{"id":1848183387,"node_id":"MDU6TGFiZWwxODQ4MTgzMzg3","url":"https://api.github.com/repos/streamlit/streamlit/labels/feature:st.file_uploader","name":"feature:st.file_uploader","color":"C5DEF5","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2024-08-15T17:00:18Z","updated_at":"2025-05-05T16:15:43Z","closed_at":"2024-08-26T15:38:06Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Checklist\r\n\r\n- [X] I have searched the [existing issues](https://github.com/streamlit/streamlit/issues) for similar issues.\r\n- [X] I added a very descriptive title to this issue.\r\n- [X] I have provided sufficient information below to help reproduce this issue.\r\n\r\n### Summary\r\n\r\nIn certain conditions, after a popup window is opened and closed, the FileUploader widget displays and AxiosError:\r\n\r\n```\r\nAxiosError: Request failed with status code 413\r\n```\r\n\r\nAn example of a \"popup window\" that causes this bug is the [msal_streamlit_authentication](https://github.com/mstaal/msal_streamlit_authentication) component, but this bug can also be triggered without that component as described below.\r\n\r\n### Reproducible Code Example\r\n\r\n```Python\r\n# Example using the msal_streamlit_authentication component, which reliably reproduces the issue\r\n# (but requires an Azure account to test)\r\n\r\n# Bug can also be reproduced without this component as explained below\r\n\r\nimport streamlit as st\r\nfrom msal_streamlit_authentication import msal_authentication\r\n\r\nvalue = msal_authentication(auth={clientId\": \"\", authority\": \"...\", redirectUri\": \"...\",})\r\nfiles = st.file_uploader(\"Upload your file\")\r\n```\r\n\r\n### Steps To Reproduce\r\n\r\n1. Run the app and open dev tools; observe that the `_streamlit_xsrf` is present.\r\n2. Click \"login\", and follow prompts in the popup until it closes.\r\n3. Open dev tools; observe that the `_streamlit_xsrf` is absent.\r\n4. Try uploading a file, and see an `AxiosError`.\r\n\r\n### Expected Behavior\r\n\r\nThe file uploader should work\r\n\r\n### Current Behavior\r\n\r\nThe file uploader displays an `AxiosError`.\r\n\r\n### Is this a regression?\r\n\r\n- [ ] Yes, this used to work in a previous version.\r\n\r\n### Debug info\r\n\r\n- Streamlit version: 1.37.1\r\n- Python version: 3.11\r\n- Operating System: Linux\r\n- Browser: Edge (also tested on Chrome). Cannot reproduce issue in Firefox.\r\n\r\n### Additional Information\r\n\r\nAfter some debugging, we think the cause is in Streamlit's handling of the `_streamlit_xsrf` cookie which is required by the cross-site scripting protection. Specifically, after certain popup interactions, the `_streamlit_xsrf` cookie is deleted and does not reappear.\r\n\r\nThe root cause seems to be this part of the frontend code which handles a changed connection state, and triggers the deletion of the cookie:\r\n\r\nhttps://github.com/streamlit/streamlit/blob/1e107ad84be5b30be6aa25bab127f1edbf0d823b/frontend/app/src/App.tsx#L657\r\n\r\nWhen a new client connects to streamlit from a browser with an active session, it loads and executes `app.js` and ends up executing `handleConnectionStateChanged` logic. When executing it, it begins in a state that is not connected. The logic results in a deletion of the cookie. The normal flow seems to be that the cookie is recreated if the connection is successful; however, if the two cases that we describe below, the window is killed after the cookie deletion but before it can create a successful connection.\r\n\r\nSo what circumstances causes this deletion? We have found two ways to reproduce this issue:\r\n\r\n### Method 1: login popup\r\n\r\nThe bug can be reliably reproduced using an \"Azure login\" component, although this requires an Azure account to login to.\r\n\r\nThe [msal_streamlit_authentication](https://github.com/mstaal/msal_streamlit_authentication) component allows one to authenticate with Azure via a popup window. After the login flow is completed, the popup window URL is briefly redirected to the streamlit app (e.g. `localhost:8501/spa`) but then the popup window it is quickly closed and the user returns to the main browser window. However, the `_streamlit_xsrf` cookie has been deleted and the file uploader does not work.\r\n\r\nThe issue can subsequently be fixed by a user refreshing the page.\r\n\r\nI don't think the bug lies with that component. It is specifically the `_streamlit_xsrf` cookie and no other cookies which get deleted.\r\n\r\n### Method 2: separate tab \r\n\r\nThe bug can also be triggered by opening a new browser tab and navigating to localhost with a path to a non-existent page, like `localhost:8501/foobarbaz`, and then closing the tab quickly just as it starts to load.\r\n\r\nThis takes several attempts as it seems to depend on the timing of when the new tab is closed. This method reproduces the issue about 10% of the time, \r\n\r\nPossibly related (which was never solved): #7199\r\n\r\n### Other observations\r\n\r\n- If one creates a new cookie using devtools with a random name, that cookie is _not_ deleted by the login flow. It is only the `_streamlit_xsrf` cookie that is deleted.\r\n- The issue seems to only occur on Chrome and Edge, but not on Firefox. This might be due to differences in how closed connections are handled, or perhaps differences in timings.","closed_by":{"login":"kajarenc","id":6664805,"node_id":"MDQ6VXNlcjY2NjQ4MDU=","avatar_url":"https://avatars.githubusercontent.com/u/6664805?v=4","gravatar_id":"","url":"https://api.github.com/users/kajarenc","html_url":"https://github.com/kajarenc","followers_url":"https://api.github.com/users/kajarenc/followers","following_url":"https://api.github.com/users/kajarenc/following{/other_user}","gists_url":"https://api.github.com/users/kajarenc/gists{/gist_id}","starred_url":"https://api.github.com/users/kajarenc/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kajarenc/subscriptions","organizations_url":"https://api.github.com/users/kajarenc/orgs","repos_url":"https://api.github.com/users/kajarenc/repos","events_url":"https://api.github.com/users/kajarenc/events{/privacy}","received_events_url":"https://api.github.com/users/kajarenc/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/streamlit/streamlit/issues/9284/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/streamlit/streamlit/issues/9284/timeline","performed_via_github_app":null,"state_reason":"completed"}