{"url":"https://api.github.com/repos/streamlit/streamlit/issues/9767","repository_url":"https://api.github.com/repos/streamlit/streamlit","labels_url":"https://api.github.com/repos/streamlit/streamlit/issues/9767/labels{/name}","comments_url":"https://api.github.com/repos/streamlit/streamlit/issues/9767/comments","events_url":"https://api.github.com/repos/streamlit/streamlit/issues/9767/events","html_url":"https://github.com/streamlit/streamlit/issues/9767","id":2629715404,"node_id":"I_kwDODCoeTs6cvkXM","number":9767,"title":"Bad message format: Tried to use SessionInfo before it was initialized","user":{"login":"bfbachmann","id":9647946,"node_id":"MDQ6VXNlcjk2NDc5NDY=","avatar_url":"https://avatars.githubusercontent.com/u/9647946?v=4","gravatar_id":"","url":"https://api.github.com/users/bfbachmann","html_url":"https://github.com/bfbachmann","followers_url":"https://api.github.com/users/bfbachmann/followers","following_url":"https://api.github.com/users/bfbachmann/following{/other_user}","gists_url":"https://api.github.com/users/bfbachmann/gists{/gist_id}","starred_url":"https://api.github.com/users/bfbachmann/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bfbachmann/subscriptions","organizations_url":"https://api.github.com/users/bfbachmann/orgs","repos_url":"https://api.github.com/users/bfbachmann/repos","events_url":"https://api.github.com/users/bfbachmann/events{/privacy}","received_events_url":"https://api.github.com/users/bfbachmann/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1516285324,"node_id":"MDU6TGFiZWwxNTE2Mjg1MzI0","url":"https://api.github.com/repos/streamlit/streamlit/labels/type:bug","name":"type:bug","color":"D93F0B","default":false,"description":"Something isn't working"},{"id":3022365121,"node_id":"MDU6TGFiZWwzMDIyMzY1MTIx","url":"https://api.github.com/repos/streamlit/streamlit/labels/status:confirmed","name":"status:confirmed","color":"FEF2C0","default":false,"description":"Bug has been confirmed by the Streamlit team"},{"id":3230107623,"node_id":"MDU6TGFiZWwzMjMwMTA3NjIz","url":"https://api.github.com/repos/streamlit/streamlit/labels/priority:P3","name":"priority:P3","color":"ff4b4b","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"sfc-gh-lwilby","id":103002751,"node_id":"U_kgDOBiOyfw","avatar_url":"https://avatars.githubusercontent.com/u/103002751?v=4","gravatar_id":"","url":"https://api.github.com/users/sfc-gh-lwilby","html_url":"https://github.com/sfc-gh-lwilby","followers_url":"https://api.github.com/users/sfc-gh-lwilby/followers","following_url":"https://api.github.com/users/sfc-gh-lwilby/following{/other_user}","gists_url":"https://api.github.com/users/sfc-gh-lwilby/gists{/gist_id}","starred_url":"https://api.github.com/users/sfc-gh-lwilby/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sfc-gh-lwilby/subscriptions","organizations_url":"https://api.github.com/users/sfc-gh-lwilby/orgs","repos_url":"https://api.github.com/users/sfc-gh-lwilby/repos","events_url":"https://api.github.com/users/sfc-gh-lwilby/events{/privacy}","received_events_url":"https://api.github.com/users/sfc-gh-lwilby/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"sfc-gh-lwilby","id":103002751,"node_id":"U_kgDOBiOyfw","avatar_url":"https://avatars.githubusercontent.com/u/103002751?v=4","gravatar_id":"","url":"https://api.github.com/users/sfc-gh-lwilby","html_url":"https://github.com/sfc-gh-lwilby","followers_url":"https://api.github.com/users/sfc-gh-lwilby/followers","following_url":"https://api.github.com/users/sfc-gh-lwilby/following{/other_user}","gists_url":"https://api.github.com/users/sfc-gh-lwilby/gists{/gist_id}","starred_url":"https://api.github.com/users/sfc-gh-lwilby/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sfc-gh-lwilby/subscriptions","organizations_url":"https://api.github.com/users/sfc-gh-lwilby/orgs","repos_url":"https://api.github.com/users/sfc-gh-lwilby/repos","events_url":"https://api.github.com/users/sfc-gh-lwilby/events{/privacy}","received_events_url":"https://api.github.com/users/sfc-gh-lwilby/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":10,"created_at":"2024-11-01T19:18:48Z","updated_at":"2025-03-26T19:38:39Z","closed_at":"2025-03-26T19:38:39Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Checklist\r\n\r\n- [X] I have searched the [existing issues](https://github.com/streamlit/streamlit/issues) for similar issues.\r\n- [X] I added a very descriptive title to this issue.\r\n- [X] I have provided sufficient information below to help reproduce this issue.\r\n\r\n### Summary\r\n\r\nI keep running into this error pop-up that says `Bad message format: Tried to use SessionInfo before it was initialized`.\r\n\r\n![image](https://github.com/user-attachments/assets/aa1e7af6-39be-47a3-b0c7-513c5f36471b)\r\n\r\nI've seen many other reports of this issue going back all the way to 2019. They've all been closed with various explanations, most of them being roughly \"it's fixed in a newer Streamlit version\", but I'm fairly confident that this issue has never actually been debugged and fixed properly, if at all.\r\n\r\nI'm not a Streamlit expert, but from reading through the frontend code, it seems to happen because the frontend occasionally receives messages from the server in an order that it doesn't expect. I've observed this in cases where the LLM inference server it's talking to dies while serving a response. Specifically, the following happens:\r\n\r\n1. The client code runs and does it's normal initialization, receiving messages from the server and initializing the session info via `handleOneTimeInitialization` called from `handleNewSession`. After this, the session info is ready for use.\r\n2. The connection is somehow broken, so `handleConnectionStateChanged` is called with some `newState` that is not `ConnectionState.CONNECTED`, which triggers a subsequent call to `this.sessionInfo.clearCurrent()` inside `handleConnectionStateChanged`. After this, the session info is undefined.\r\n3. The client receives a `pageProfile` message from the server, so it calls `handlePageProfileMsg`, which tries to access the session info via `this.sessionInfo.current.appId`. This is where the `Tried to use SessionInfo before it was initialized` error gets thrown.\r\n\r\nHere's a stack trace:\r\n```\r\nError: Tried to use SessionInfo before it was initialized\r\n    at get current (main.33ba0d1c.js:10:4270471)\r\n    at ad.handlePageProfileMsg (main.33ba0d1c.js:28:13529)\r\n    at Object.pageProfile (main.33ba0d1c.js:28:11414)\r\n    at main.33ba0d1c.js:28:10863\r\n    at Object.handleMessage [as onMessage] (main.33ba0d1c.js:28:10917)\r\n    at vp.handleMessage (main.33ba0d1c.js:19:44308)\r\n```\r\n\r\nI'm sure there is more to it than that. I'm just trying to point out the fact that the error is being thrown because the session info is set and unset based on messages received from the server, and it they are received in the wrong order for some reason, the error will occur.\r\n\r\nI'd suggest the following:\r\n1. Try to write a test that simulates the exact sequence of events that trigger this (described above).\r\n2. Come up with a fix that can handle these cases where messages are received in weird orders by simply initializing the session info lazily if it's not already initialized. Either that, or just remove the call to `sessionInfo.clearCurrent` entirely - I don't see why it's necessary if we overwrite it with `sessionInfo.setCurrent` anyway.\r\n\r\n### Reproducible Code Example\r\n\r\n```Python\r\n# It's reproducable with the example chatbot code from your website.\r\n\r\nimport streamlit as st\r\nfrom openai import OpenAI\r\n\r\nwith st.sidebar:\r\n    openai_api_key = st.text_input(\"OpenAI API Key\", key=\"chatbot_api_key\", type=\"password\")\r\n    \"[Get an OpenAI API key](https://platform.openai.com/account/api-keys)\"\r\n    \"[View the source code](https://github.com/streamlit/llm-examples/blob/main/Chatbot.py)\"\r\n    \"[![Open in GitHub Codespaces](https://github.com/codespaces/badge.svg)](https://codespaces.new/streamlit/llm-examples?quickstart=1)\"\r\n\r\nst.title(\"ðŸ’¬ Chatbot\")\r\n\r\nif \"messages\" not in st.session_state:\r\n    st.session_state[\"messages\"] = [{\"role\": \"assistant\", \"content\": \"How can I help you?\"}]\r\n\r\nfor msg in st.session_state.messages:\r\n    st.chat_message(msg[\"role\"]).write(msg[\"content\"])\r\n\r\nif prompt := st.chat_input():\r\n    if not openai_api_key:\r\n        st.info(\"Please add your OpenAI API key to continue.\")\r\n        st.stop()\r\n\r\n    client = OpenAI(api_key=openai_api_key)\r\n    st.session_state.messages.append({\"role\": \"user\", \"content\": prompt})\r\n    st.chat_message(\"user\").write(prompt)\r\n    response = client.chat.completions.create(model=\"gpt-3.5-turbo\", messages=st.session_state.messages)\r\n    msg = response.choices[0].message.content\r\n    st.session_state.messages.append({\"role\": \"assistant\", \"content\": msg})\r\n    st.chat_message(\"assistant\").write(msg)\r\n```\r\n\r\n\r\n### Steps To Reproduce\r\n\r\n1. Have the server send its regular initialization messages in their regular order to the client.\r\n2. Have the server drop the connection, triggering a connection state change in the client.\r\n3. Have the server re-establish the connection, but just send a `pageProfile` message immediately.\r\n\r\n### Expected Behavior\r\n\r\nThe session info should be re-initialized if it's not already set whenever it's needed. In other words, receiving messages in the \"wrong order\" from the server should not break your client-side state machine.\r\n\r\n### Current Behavior\r\n\r\nError message: ```Tried to use SessionInfo before it was initialized```\r\n\r\n### Is this a regression?\r\n\r\n- [ ] Yes, this used to work in a previous version.\r\n\r\n### Debug info\r\n\r\n- Streamlit version: 1.39.0\r\n- Python version: 3.12.4\r\n- Operating System: Linux\r\n- Browser: Chrome\r\n\r\n\r\n### Additional Information\r\n\r\n_No response_","closed_by":{"login":"kmcgrady","id":69432,"node_id":"MDQ6VXNlcjY5NDMy","avatar_url":"https://avatars.githubusercontent.com/u/69432?v=4","gravatar_id":"","url":"https://api.github.com/users/kmcgrady","html_url":"https://github.com/kmcgrady","followers_url":"https://api.github.com/users/kmcgrady/followers","following_url":"https://api.github.com/users/kmcgrady/following{/other_user}","gists_url":"https://api.github.com/users/kmcgrady/gists{/gist_id}","starred_url":"https://api.github.com/users/kmcgrady/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kmcgrady/subscriptions","organizations_url":"https://api.github.com/users/kmcgrady/orgs","repos_url":"https://api.github.com/users/kmcgrady/repos","events_url":"https://api.github.com/users/kmcgrady/events{/privacy}","received_events_url":"https://api.github.com/users/kmcgrady/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/streamlit/streamlit/issues/9767/reactions","total_count":33,"+1":33,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/streamlit/streamlit/issues/9767/timeline","performed_via_github_app":null,"state_reason":"completed"}