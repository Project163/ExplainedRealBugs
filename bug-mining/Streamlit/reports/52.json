{"url":"https://api.github.com/repos/streamlit/streamlit/issues/8360","repository_url":"https://api.github.com/repos/streamlit/streamlit","labels_url":"https://api.github.com/repos/streamlit/streamlit/issues/8360/labels{/name}","comments_url":"https://api.github.com/repos/streamlit/streamlit/issues/8360/comments","events_url":"https://api.github.com/repos/streamlit/streamlit/issues/8360/events","html_url":"https://github.com/streamlit/streamlit/issues/8360","id":2201456241,"node_id":"I_kwDODCoeTs6DN45x","number":8360,"title":"Stale widgets fill screen after script reruns","user":{"login":"ricmatsui","id":5288285,"node_id":"MDQ6VXNlcjUyODgyODU=","avatar_url":"https://avatars.githubusercontent.com/u/5288285?v=4","gravatar_id":"","url":"https://api.github.com/users/ricmatsui","html_url":"https://github.com/ricmatsui","followers_url":"https://api.github.com/users/ricmatsui/followers","following_url":"https://api.github.com/users/ricmatsui/following{/other_user}","gists_url":"https://api.github.com/users/ricmatsui/gists{/gist_id}","starred_url":"https://api.github.com/users/ricmatsui/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ricmatsui/subscriptions","organizations_url":"https://api.github.com/users/ricmatsui/orgs","repos_url":"https://api.github.com/users/ricmatsui/repos","events_url":"https://api.github.com/users/ricmatsui/events{/privacy}","received_events_url":"https://api.github.com/users/ricmatsui/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1516285324,"node_id":"MDU6TGFiZWwxNTE2Mjg1MzI0","url":"https://api.github.com/repos/streamlit/streamlit/labels/type:bug","name":"type:bug","color":"D93F0B","default":false,"description":"Something isn't working"},{"id":3022365121,"node_id":"MDU6TGFiZWwzMDIyMzY1MTIx","url":"https://api.github.com/repos/streamlit/streamlit/labels/status:confirmed","name":"status:confirmed","color":"FEF2C0","default":false,"description":"Bug has been confirmed by the Streamlit team"},{"id":3230105890,"node_id":"MDU6TGFiZWwzMjMwMTA1ODkw","url":"https://api.github.com/repos/streamlit/streamlit/labels/priority:P2","name":"priority:P2","color":"ff4b4b","default":false,"description":""},{"id":4369205014,"node_id":"LA_kwDODCoeTs8AAAABBGzHFg","url":"https://api.github.com/repos/streamlit/streamlit/labels/feature:st.rerun","name":"feature:st.rerun","color":"C5DEF5","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"vdonato","id":3144420,"node_id":"MDQ6VXNlcjMxNDQ0MjA=","avatar_url":"https://avatars.githubusercontent.com/u/3144420?v=4","gravatar_id":"","url":"https://api.github.com/users/vdonato","html_url":"https://github.com/vdonato","followers_url":"https://api.github.com/users/vdonato/followers","following_url":"https://api.github.com/users/vdonato/following{/other_user}","gists_url":"https://api.github.com/users/vdonato/gists{/gist_id}","starred_url":"https://api.github.com/users/vdonato/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vdonato/subscriptions","organizations_url":"https://api.github.com/users/vdonato/orgs","repos_url":"https://api.github.com/users/vdonato/repos","events_url":"https://api.github.com/users/vdonato/events{/privacy}","received_events_url":"https://api.github.com/users/vdonato/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"vdonato","id":3144420,"node_id":"MDQ6VXNlcjMxNDQ0MjA=","avatar_url":"https://avatars.githubusercontent.com/u/3144420?v=4","gravatar_id":"","url":"https://api.github.com/users/vdonato","html_url":"https://github.com/vdonato","followers_url":"https://api.github.com/users/vdonato/followers","following_url":"https://api.github.com/users/vdonato/following{/other_user}","gists_url":"https://api.github.com/users/vdonato/gists{/gist_id}","starred_url":"https://api.github.com/users/vdonato/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vdonato/subscriptions","organizations_url":"https://api.github.com/users/vdonato/orgs","repos_url":"https://api.github.com/users/vdonato/repos","events_url":"https://api.github.com/users/vdonato/events{/privacy}","received_events_url":"https://api.github.com/users/vdonato/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":3,"created_at":"2024-03-22T00:35:38Z","updated_at":"2024-05-07T00:04:22Z","closed_at":"2024-05-07T00:04:21Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Checklist\r\n\r\n- [X] I have searched the [existing issues](https://github.com/streamlit/streamlit/issues) for similar issues.\r\n- [X] I added a very descriptive title to this issue.\r\n- [X] I have provided sufficient information below to help reproduce this issue.\r\n\r\n### Summary\r\n\r\nIf a script produces fewer elements than a previous time it was run, stale widgets begin to fill the screen and do not disappear. This is because the delta message to the frontend will add an element with the same widget ID as another element in the same `BlockNode`, causing a React \"Encountered two children with the same key\" error in the frontend.\r\n\r\n### Reproducible Code Example\r\n\r\n[![Open in Streamlit Cloud](https://static.streamlit.io/badges/streamlit_badge_black_white.svg)](https://issues.streamlitapp.com/?issue=gh-8360)\r\n\r\n```Python\r\nimport streamlit as st\r\nimport time\r\n\r\nif 'foo' not in st.session_state:\r\n    st.write('Setting state')\r\n    st.session_state['foo'] = 'bar'\r\n\r\nif st.button('Run'):\r\n    # Allow for forward message queue to flush button element\r\n    time.sleep(1)\r\n\r\n    del st.session_state['foo']\r\n    st.rerun()\r\n```\r\n\r\n\r\n### Steps To Reproduce\r\n\r\n1. Click on the \"Run\" button\r\n\r\n### Expected Behavior\r\n\r\nOnly a single Run button is shown on the screen after clicking it.\r\n\r\n### Current Behavior\r\n\r\nA new stale Run button appears each time the button is clicked, filling the screen with buttons.\r\n\r\nhttps://github.com/streamlit/streamlit/assets/5288285/73163485-69e6-496a-95ad-00b649753b18\r\n\r\n```\r\nreact_devtools_backend_compact.js:13024 Warning: Encountered two children with the same key,\r\n`$$WIDGET_ID-64a6367f129c80d7584b057250e50a31-None`. Keys should be unique so that\r\ncomponents maintain their identity across updates. Non-unique keys may cause children to be\r\nduplicated and/or omitted â€” the behavior is unsupported and could change in a future version.\r\n    at ChildRenderer (http://localhost:3000/static/js/bundle.js:15819:56)\r\n    at div\r\n    at http://localhost:3000/static/js/bundle.js:99124:66\r\n    at div\r\n    at http://localhost:3000/static/js/bundle.js:99124:66\r\n    at div\r\n    at http://localhost:3000/static/js/bundle.js:99124:66\r\n    at VerticalBlock (http://localhost:3000/static/js/bundle.js:15906:71)\r\n    at div\r\n    at http://localhost:3000/static/js/bundle.js:99124:66\r\n    at section\r\n    at http://localhost:3000/static/js/bundle.js:99124:66\r\n    at div\r\n    at http://localhost:3000/static/js/bundle.js:99124:66\r\n    at AppView (http://localhost:3000/static/js/bundle.js:2392:5)\r\n    at div\r\n    at http://localhost:3000/static/js/bundle.js:99124:66\r\n    at div\r\n    at FocusTrap (http://localhost:3000/static/js/bundle.js:209011:5)\r\n    at HotKeys (http://localhost:3000/static/js/bundle.js:209259:5)\r\n    at App (http://localhost:3000/static/js/bundle.js:293:5)\r\n    at div\r\n    at ComponentWithScreencast (http://localhost:3000/static/js/bundle.js:12790:7)\r\n    at ThemeProvider (http://localhost:3000/static/js/bundle.js:99154:64)\r\n    at ThemeProvider (http://localhost:3000/static/js/bundle.js:113703:21)\r\n    at UIDReset (http://localhost:3000/static/js/bundle.js:218317:21)\r\n    at div\r\n    at http://localhost:3000/static/js/bundle.js:266981:58\r\n    at Styled(div)\r\n    at LayersManager (http://localhost:3000/static/js/bundle.js:104644:5)\r\n    at BaseProvider (http://localhost:3000/static/js/bundle.js:102642:24)\r\n    at RootStyleProvider (http://localhost:3000/static/js/bundle.js:14657:5)\r\n    at ThemedApp (http://localhost:3000/static/js/bundle.js:2178:107)\r\n    at DevProvider (http://localhost:3000/static/js/bundle.js:266709:5)\r\n```\r\n\r\n### Is this a regression?\r\n\r\n- [ ] Yes, this used to work in a previous version.\r\n\r\n### Debug info\r\n\r\n- Streamlit version: 1.32.2\r\n- Python version: 3.11.5\r\n- Operating System: macOS 13.5.2\r\n- Browser: Chrome\r\n\r\n\r\n### Additional Information\r\n\r\nThe first time the script runs there are two deltas sent:\r\n```\r\n{\"deltaPath\":[0,0]},\"delta\":{\"newElement\":{\"markdown\":{\"body\":\"Setting state\",\"elementType\":\"NATIVE\"}}}}\r\n{\"deltaPath\":[0,1]},\"delta\":{\"newElement\":{\"button\":{\"id\":\"$$WIDGET_ID-64a6367f129c80d7584b057250e50a31-None\",\"label\":\"Run\",\"type\":\"secondary\"}}}}\r\n```\r\nso the main block node contains elements with keys:\r\n```\r\n[\r\n    0,\r\n    '$$WIDGET_ID-64a6367f129c80d7584b057250e50a31-None',\r\n]\r\n```\r\n\r\nAfter clicking the Run button, only one delta is sent:\r\n```\r\n{\"deltaPath\":[0,0]},\"delta\":{\"newElement\":{\"button\":{\"id\":\"$$WIDGET_ID-64a6367f129c80d7584b057250e50a31-None\",\"label\":\"Run\",\"type\":\"secondary\"}}}}\r\n```\r\nso the main block node temporarily contains elements with keys\r\n```\r\n[\r\n    '$$WIDGET_ID-64a6367f129c80d7584b057250e50a31-None',\r\n    '$$WIDGET_ID-64a6367f129c80d7584b057250e50a31-None',\r\n]\r\n```\r\nwhich is not allowed, triggering \"Encountered two children with the same key\" error and causing the stale widget to remain on the screen.\r\n\r\nSee:\r\nhttps://github.com/streamlit/streamlit/blob/4dbc82b90b51173d292bcbc7f93df38da39ac8ec/frontend/lib/src/components/core/Block/Block.tsx#L201-L202\r\n\r\nRemoving the use of the widget ID seems to fix the issue but is slower:\r\n```diff\r\n- const key = getElementWidgetID(node.element) || index \r\n+ const key = index \r\n```\r\n\r\nPossibly related issue: https://github.com/streamlit/streamlit/issues/2820\r\n\r\n","closed_by":{"login":"vdonato","id":3144420,"node_id":"MDQ6VXNlcjMxNDQ0MjA=","avatar_url":"https://avatars.githubusercontent.com/u/3144420?v=4","gravatar_id":"","url":"https://api.github.com/users/vdonato","html_url":"https://github.com/vdonato","followers_url":"https://api.github.com/users/vdonato/followers","following_url":"https://api.github.com/users/vdonato/following{/other_user}","gists_url":"https://api.github.com/users/vdonato/gists{/gist_id}","starred_url":"https://api.github.com/users/vdonato/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vdonato/subscriptions","organizations_url":"https://api.github.com/users/vdonato/orgs","repos_url":"https://api.github.com/users/vdonato/repos","events_url":"https://api.github.com/users/vdonato/events{/privacy}","received_events_url":"https://api.github.com/users/vdonato/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/streamlit/streamlit/issues/8360/reactions","total_count":5,"+1":5,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/streamlit/streamlit/issues/8360/timeline","performed_via_github_app":null,"state_reason":"completed"}