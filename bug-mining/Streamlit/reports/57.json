{"url":"https://api.github.com/repos/streamlit/streamlit/issues/8738","repository_url":"https://api.github.com/repos/streamlit/streamlit","labels_url":"https://api.github.com/repos/streamlit/streamlit/issues/8738/labels{/name}","comments_url":"https://api.github.com/repos/streamlit/streamlit/issues/8738/comments","events_url":"https://api.github.com/repos/streamlit/streamlit/issues/8738/events","html_url":"https://github.com/streamlit/streamlit/issues/8738","id":2311083963,"node_id":"I_kwDODCoeTs6JwFe7","number":8738,"title":"Streamlit unnecessarily runs the file watcher against every path in imported modules, even when watching is disabled","user":{"login":"nikhil-marathe-skydio","id":84412986,"node_id":"MDQ6VXNlcjg0NDEyOTg2","avatar_url":"https://avatars.githubusercontent.com/u/84412986?v=4","gravatar_id":"","url":"https://api.github.com/users/nikhil-marathe-skydio","html_url":"https://github.com/nikhil-marathe-skydio","followers_url":"https://api.github.com/users/nikhil-marathe-skydio/followers","following_url":"https://api.github.com/users/nikhil-marathe-skydio/following{/other_user}","gists_url":"https://api.github.com/users/nikhil-marathe-skydio/gists{/gist_id}","starred_url":"https://api.github.com/users/nikhil-marathe-skydio/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nikhil-marathe-skydio/subscriptions","organizations_url":"https://api.github.com/users/nikhil-marathe-skydio/orgs","repos_url":"https://api.github.com/users/nikhil-marathe-skydio/repos","events_url":"https://api.github.com/users/nikhil-marathe-skydio/events{/privacy}","received_events_url":"https://api.github.com/users/nikhil-marathe-skydio/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1516285324,"node_id":"MDU6TGFiZWwxNTE2Mjg1MzI0","url":"https://api.github.com/repos/streamlit/streamlit/labels/type:bug","name":"type:bug","color":"D93F0B","default":false,"description":"Something isn't working"},{"id":3022365121,"node_id":"MDU6TGFiZWwzMDIyMzY1MTIx","url":"https://api.github.com/repos/streamlit/streamlit/labels/status:confirmed","name":"status:confirmed","color":"FEF2C0","default":false,"description":"Bug has been confirmed by the Streamlit team"},{"id":5802179295,"node_id":"LA_kwDODCoeTs8AAAABWdY63w","url":"https://api.github.com/repos/streamlit/streamlit/labels/feature:cli","name":"feature:cli","color":"C5DEF5","default":false,"description":"Related to the command line interface"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2024-05-22T17:13:47Z","updated_at":"2024-05-23T22:49:26Z","closed_at":"2024-05-23T22:45:32Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Checklist\n\n- [X] I have searched the [existing issues](https://github.com/streamlit/streamlit/issues) for similar issues.\n- [X] I added a very descriptive title to this issue.\n- [X] I have provided sufficient information below to help reproduce this issue.\n\n### Summary\n\nWe are running an application that has a bunch of module dependencies.\r\nRecording some profiles, we often see stack traces like this\r\n\r\n![image](https://github.com/streamlit/streamlit/assets/84412986/108c2645-f57f-4d0c-ac48-8c5e0729a6eb)\r\n\r\nhttps://github.com/streamlit/streamlit/blob/ad3dc4e19d261fc66560a25bab92a7a560068338/lib/streamlit/runtime/app_session.py#L604\r\n\r\nThis happens despite the file watcher type being set to `none`, because the local watcher does not gate on that setting. It is only when the per-file watch request addition happens that the setting is checked and it determines that no watch is required. This is incredibly wasteful as it incurs a `isfile` check (along with an fnmatch) for ~40000 files in our case. If I understand the code correctly, this happens at the end of every successful page load.\r\n\r\nThis seems like it could easily be avoided if the app session also consulted the setting.\r\n\r\nDoes this make sense and would you accept the relevant fix?\n\n### Reproducible Code Example\n\n_No response_\n\n### Steps To Reproduce\n\n_No response_\n\n### Expected Behavior\n\nDon't iterate over a bunch of files when file watching is disabled.\n\n### Current Behavior\n\nLot of compute and disk I/O wasted on \"watching\" files.\n\n### Is this a regression?\n\n- [ ] Yes, this used to work in a previous version.\n\n### Debug info\n\n- Streamlit version: We are running 1.33, but the same code exists in the latest code\r\n- Python version: 3.8\r\n- Operating System: Linux\r\n- Browser: Any\r\n\n\n### Additional Information\n\n_No response_","closed_by":{"login":"vdonato","id":3144420,"node_id":"MDQ6VXNlcjMxNDQ0MjA=","avatar_url":"https://avatars.githubusercontent.com/u/3144420?v=4","gravatar_id":"","url":"https://api.github.com/users/vdonato","html_url":"https://github.com/vdonato","followers_url":"https://api.github.com/users/vdonato/followers","following_url":"https://api.github.com/users/vdonato/following{/other_user}","gists_url":"https://api.github.com/users/vdonato/gists{/gist_id}","starred_url":"https://api.github.com/users/vdonato/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vdonato/subscriptions","organizations_url":"https://api.github.com/users/vdonato/orgs","repos_url":"https://api.github.com/users/vdonato/repos","events_url":"https://api.github.com/users/vdonato/events{/privacy}","received_events_url":"https://api.github.com/users/vdonato/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/streamlit/streamlit/issues/8738/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/streamlit/streamlit/issues/8738/timeline","performed_via_github_app":null,"state_reason":"completed"}