<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:44:21 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HADOOP-10085] CompositeService should allow adding services while being inited</title>
                <link>https://issues.apache.org/jira/browse/HADOOP-10085</link>
                <project id="12310240" key="HADOOP">Hadoop Common</project>
                    <description>&lt;p&gt;We can add services to a CompositeService. However, if we do that while initing the CompositeService, it leads to a ConcurrentModificationException.&lt;/p&gt;

&lt;p&gt;It would be nice to allow adding services even during the init of CompositeService.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12677804">HADOOP-10085</key>
            <summary>CompositeService should allow adding services while being inited</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stevel@apache.org">Steve Loughran</assignee>
                                    <reporter username="kasha">Karthik Kambatla</reporter>
                        <labels>
                    </labels>
                <created>Wed, 6 Nov 2013 16:36:40 +0000</created>
                <updated>Mon, 3 Nov 2014 18:33:35 +0000</updated>
                            <resolved>Sun, 2 Feb 2014 20:44:03 +0000</resolved>
                                    <version>2.2.0</version>
                                    <fixVersion>2.4.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="13815013" author="kkambatl" created="Wed, 6 Nov 2013 16:39:17 +0000"  >&lt;p&gt;There is some discussion on &lt;a href=&quot;https://issues.apache.org/jira/browse/YARN-1374&quot; title=&quot;Resource Manager fails to start due to ConcurrentModificationException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;YARN-1374&quot;&gt;&lt;del&gt;YARN-1374&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;While it may be useful to allow adding services during init, we should do it in a way we don&apos;t introduce any races or non-determinism. It might make more sense to have a method different from the typical addService() to add a service during init.&lt;/p&gt;</comment>
                            <comment id="13815034" author="bikassaha" created="Wed, 6 Nov 2013 17:03:06 +0000"  >&lt;p&gt;Need to handle race conditions. How to guarantee that such services will be properly inited?&lt;/p&gt;</comment>
                            <comment id="13815189" author="stevel@apache.org" created="Wed, 6 Nov 2013 19:32:48 +0000"  >&lt;p&gt;I would propose&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;clone the list before doing the iteration -that way, changes in the list do not affect the ongoing interation.&lt;/li&gt;
	&lt;li&gt;simply add a check to addService() that the service must be in the same role as the service is itself.&lt;/li&gt;
&lt;/ol&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void addService(Service service) {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (service.getServiceState() != getServiceState()) {
     &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RuntimeException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Cannot add ... &quot;&lt;/span&gt;)
   }
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (LOG.isDebugEnabled()) {
      LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Adding service &quot;&lt;/span&gt; + service.getName());
    }
    &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (serviceList) {
      serviceList.add(service);
    }
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We could be more generous and allow you to add services later on in the lifecycle, making the check &lt;tt&gt;service.getServiceState() != getServiceState()&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;I actually think this may be an-unnoticed bug in the code today: I could add a service in state UNINITED during my own code&apos;s init, &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void serviceInit() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.serviceInit();
    addService(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CompositeService());  
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;call start() on my service, it will try to start the service, which is in the wrong state.&lt;/p&gt;</comment>
                            <comment id="13816254" author="stevel@apache.org" created="Thu, 7 Nov 2013 18:53:36 +0000"  >&lt;p&gt;I&apos;m just doing the tests for this and the fixes. Stopping the concurrency condition is trivial (indeed, the javadocs imply I thought creating an UnmodifiableList() around a service list did this. Moving to a clone is the solution.&lt;/p&gt;

&lt;p&gt;With that fix, you do get a stack trace after you add a service that is behind the state of parent, in the specific case that the parent is in inited or uninited&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;testAddUninitedSiblingInInit(org.apache.hadoop.service.TestCompositeService)  Time elapsed: 0.035 sec  &amp;lt;&amp;lt;&amp;lt; ERROR!
org.apache.hadoop.service.ServiceStateException: BreakableService cannot enter state STARTED from state NOTINITED
	at org.apache.hadoop.service.ServiceStateModel.checkStateTransition(ServiceStateModel.java:129)
	at org.apache.hadoop.service.ServiceStateModel.enterState(ServiceStateModel.java:111)
	at org.apache.hadoop.service.AbstractService.start(AbstractService.java:190)
	at org.apache.hadoop.service.CompositeService.serviceStart(CompositeService.java:126)
	at org.apache.hadoop.service.AbstractService.start(AbstractService.java:193)
	at org.apache.hadoop.service.TestCompositeService.testAddUninitedSiblingInInit(TestCompositeService.java:358)

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;You get a similar stack trace if any service adds a child to a composite that is not in the current state -or in the one next (because it is not an error to call start() from the started state -it&apos;s just a no-op.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Running org.apache.hadoop.service.TestCompositeService
Tests run: 1, Failures: 0, Errors: 1, Skipped: 0, Time elapsed: 0.184 sec &amp;lt;&amp;lt;&amp;lt; FAILURE! - in org.apache.hadoop.service.TestCompositeService
testAddStartedChildBeforeInit(org.apache.hadoop.service.TestCompositeService)  Time elapsed: 0.037 sec  &amp;lt;&amp;lt;&amp;lt; ERROR!
org.apache.hadoop.service.ServiceStateException: BreakableService cannot enter state INITED from state STARTED
	at org.apache.hadoop.service.ServiceStateModel.checkStateTransition(ServiceStateModel.java:129)
	at org.apache.hadoop.service.ServiceStateModel.enterState(ServiceStateModel.java:111)
	at org.apache.hadoop.service.AbstractService.enterState(AbstractService.java:449)
	at org.apache.hadoop.service.AbstractService.init(AbstractService.java:160)
	at org.apache.hadoop.service.CompositeService.serviceInit(CompositeService.java:113)
	at org.apache.hadoop.service.AbstractService.init(AbstractService.java:163)
	at org.apache.hadoop.service.TestCompositeService.testAddStartedChildBeforeInit(TestCompositeService.java:371)

testAddStoppedChildBeforeInit(org.apache.hadoop.service.TestCompositeService)  Time elapsed: 0.036 sec  &amp;lt;&amp;lt;&amp;lt; ERROR!
org.apache.hadoop.service.ServiceStateException: BreakableService cannot enter state INITED from state STOPPED
	at org.apache.hadoop.service.ServiceStateModel.checkStateTransition(ServiceStateModel.java:129)
	at org.apache.hadoop.service.ServiceStateModel.enterState(ServiceStateModel.java:111)
	at org.apache.hadoop.service.AbstractService.enterState(AbstractService.java:449)
	at org.apache.hadoop.service.AbstractService.init(AbstractService.java:160)
	at org.apache.hadoop.service.CompositeService.serviceInit(CompositeService.java:113)
	at org.apache.hadoop.service.AbstractService.init(AbstractService.java:163)
	at org.apache.hadoop.service.TestCompositeService.testAddStoppedChildBeforeInit(TestCompositeService.java:384)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;While we could have this inconsistent child problem picked up in the &lt;tt&gt;addService()&lt;/tt&gt; call -though there is a risk that someone may be adding started services during the init phase -which is legitimate and harmless today, but an error if a strict child state == parent state check was added.&lt;/p&gt;

</comment>
                            <comment id="13816286" author="stevel@apache.org" created="Thu, 7 Nov 2013 19:09:20 +0000"  >&lt;p&gt;This patch adds more tests and fixes the concurrency modification exception that is the core problem -but the code to test and reject additions in the wrong service state is disabled.&lt;/p&gt;

&lt;p&gt;As a result, 3 tests fail, showing cases when a child was added in the wrong state -and the following transition fails. &lt;/p&gt;

&lt;p&gt;Two fix strategies&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;very strict: only allow current state in a service add.&lt;/li&gt;
	&lt;li&gt;current or future: you can add INITED, STARTED and STOPPED to a composite in INITED; STARTED and STOPPED to a STARTED service. I&apos;d argue against adding an INITED before service, because the child wouldn&apos;t share a Configuration instance with all the others&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="13816338" author="sandyr" created="Thu, 7 Nov 2013 19:43:57 +0000"  >&lt;p&gt;Do we have places in the code that could benefit from this?&lt;/p&gt;</comment>
                            <comment id="13816346" author="kkambatl" created="Thu, 7 Nov 2013 19:48:40 +0000"  >&lt;p&gt;Assigning it to Steve as he is actively working on it.&lt;/p&gt;</comment>
                            <comment id="13817150" author="stevel@apache.org" created="Fri, 8 Nov 2013 09:33:53 +0000"  >&lt;ol&gt;
	&lt;li&gt;the Concurrency modification is a bug in the composite service -one that showed up first in the HA RM, but something fairly basic.&lt;/li&gt;
	&lt;li&gt;the stricter state of additions goes one further and ensures that the next state transition of the composite will not fail due to an illegal state transition attempt of a child.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Lots of child services are added by containers, and I&apos;ve got some that actually make the &lt;tt&gt;addService&lt;/tt&gt; method public for better service composition. The check locks down what state the children can be in and stops people making mistakes -at the time of insertion, not state transition.&lt;/p&gt;</comment>
                            <comment id="13817200" author="kkambatl" created="Fri, 8 Nov 2013 11:20:51 +0000"  >&lt;p&gt;I like the very strict model better. Unless there is a usecase for the latter, the stricter model is, well, stricter and easy to reason about.&lt;/p&gt;</comment>
                            <comment id="13821442" author="stevel@apache.org" created="Wed, 13 Nov 2013 15:48:55 +0000"  >&lt;p&gt;I&apos;ve been through all the hadoop-trunk code &amp;amp; looked at when &lt;tt&gt;addService()} is called. Mostly its called in {{serviceInit()&lt;/tt&gt; before a call to &lt;tt&gt;super.serviceInit()&lt;/tt&gt; -adding UNINITED services which get inited during the loop through the children. &lt;tt&gt;ResourceManager&lt;/tt&gt; is the busiest class here.&lt;/p&gt;

&lt;p&gt;{{ContainerManagerImpl }}adds a service in its constructor which is mildly hazardous as if that method were overridden in a test subclass then the subclass would be in use before it had fully constructed. That doesn&apos;t impact service states though.&lt;/p&gt;

&lt;p&gt;now, some fun arises in calling &lt;tt&gt;addService()&lt;/tt&gt; in your &lt;tt&gt;serviceInit()&lt;/tt&gt; operation, because although the run through to init the child services hasn&apos;t started yet (i.e. the operations to move the children from UNINITED -&amp;gt; INITED, the parent is already in the INITED state. A check to validate that you can add an UNINITED service fails, because the parent is actually mid-init.&lt;/p&gt;

&lt;p&gt;There&apos;s no easy solution here, so I propose&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;don&apos;t implement any checks on service state when adding a child.&lt;/li&gt;
	&lt;li&gt;if you do a state transition that isn&apos;t legal, you&apos;ll find out at the time.&lt;/li&gt;
	&lt;li&gt;we make the new tests verify today&apos;s operation: you can insert children in any state, but when the parent tries to enter any state other than stopped, if there is a mismatch in versions a &lt;tt&gt;ServiceStateException&lt;/tt&gt; gets thrown.&lt;/li&gt;
&lt;/ol&gt;

</comment>
                            <comment id="13821462" author="stevel@apache.org" created="Wed, 13 Nov 2013 16:03:30 +0000"  >&lt;p&gt;Patch with the concurrency condition fixed (tests included) and with tests to verify that there is no validation on state of services added as children -but the next state change will raise an exception.&lt;/p&gt;</comment>
                            <comment id="13821463" author="stevel@apache.org" created="Wed, 13 Nov 2013 16:04:48 +0000"  >&lt;p&gt;patch. Note this moves &lt;tt&gt;TestCompositeService&lt;/tt&gt; from yarn to -common so it is closer to the code&lt;/p&gt;</comment>
                            <comment id="13821512" author="hadoopqa" created="Wed, 13 Nov 2013 16:46:40 +0000"  >&lt;p&gt;&lt;font color=&quot;green&quot;&gt;+1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12613633/HADOOP-10085-003.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12613633/HADOOP-10085-003.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 tests included&lt;/font&gt;.  The patch appears to include 1 new or modified test files.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javadoc&lt;/font&gt;.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 eclipse:eclipse&lt;/font&gt;.  The patch built with eclipse:eclipse.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 findbugs&lt;/font&gt;.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 release audit&lt;/font&gt;.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 core tests&lt;/font&gt;.  The patch passed unit tests in hadoop-common-project/hadoop-common hadoop-yarn-project/hadoop-yarn/hadoop-yarn-common.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 contrib tests&lt;/font&gt;.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/3282//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/3282//testReport/&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/3282//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/3282//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13885862" author="kkambatl" created="Wed, 29 Jan 2014 21:52:05 +0000"  >&lt;p&gt;Sorry for the delay in getting around to this. Looks like the patch doesn&apos;t apply anymore - was hard to see the changes to tests themselves, mind refreshing the patch? I ll try to review before it goes stale this time. &lt;/p&gt;

&lt;p&gt;Let me make sure I understand the fix here. Without the fix, adding a child service to a CompositeService while the CompositeService is initing all its child services leads to ConcurrentModificationException. The patch allows adding these services even during this time, but the newly added child service will never be inited if it not already. So, the patch allows adding services but places the onus on the caller to make sure it is in the correct state; otherwise, bad things can happen. &lt;/p&gt;

&lt;p&gt;I am not sure if it is better to have deterministic behavior where we force users to add all the services before CompositeService#serviceInit is called or to allow adding services but leave the onus on the users. &lt;/p&gt;

&lt;p&gt;It would have been nicer to have a check for the child being in at least the parent&apos;s state. Would it make sense to have the parent service enter INIT only after all its child services have been INITed? That way, if the parent is already in INIT, we can disallow adding a service in UNINITED state. Also, the current usage pattern of adding services followed by a call to super.serviceInit() will remain valid? &lt;/p&gt;</comment>
                            <comment id="13886743" author="stevel@apache.org" created="Thu, 30 Jan 2014 16:26:22 +0000"  >&lt;p&gt;patch rebased to trunk&lt;/p&gt;</comment>
                            <comment id="13886789" author="hadoopqa" created="Thu, 30 Jan 2014 17:07:10 +0000"  >&lt;p&gt;&lt;font color=&quot;green&quot;&gt;+1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12626120/HADOOP-10085-004.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12626120/HADOOP-10085-004.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 tests included&lt;/font&gt;.  The patch appears to include 1 new or modified test files.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javadoc&lt;/font&gt;.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 eclipse:eclipse&lt;/font&gt;.  The patch built with eclipse:eclipse.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 findbugs&lt;/font&gt;.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 release audit&lt;/font&gt;.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 core tests&lt;/font&gt;.  The patch passed unit tests in hadoop-common-project/hadoop-common hadoop-yarn-project/hadoop-yarn/hadoop-yarn-common.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 contrib tests&lt;/font&gt;.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/3506//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/3506//testReport/&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/3506//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/3506//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13887592" author="stevel@apache.org" created="Fri, 31 Jan 2014 09:40:37 +0000"  >&lt;p&gt;I&apos;ll rebuild it.&lt;/p&gt;

&lt;p&gt;I looked at adding stricter checks but it broke things -some services were adding services in an incomplete state. Which is fine, because it will show up later&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;It would have been nicer to have a check for the child being in at least the parent&apos;s state.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;As start() on a STARTED service is a no-op, it&apos;s legal to add a started service to a service still in the inited state. Add an inited child while started -you&apos;ll need to start it yourself. It won&apos;t break anything though, as it&apos;s only transition is stop(), which must be valid from INITED anyway.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Would it make sense to have the parent service enter INIT only after all its child services have been INITed? That way, if the parent is already in INIT, we can disallow adding a service in UNINITED state.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;root service model MUST check for the valid transition before calling its execution operations -the whole &lt;a href=&quot;https://issues.apache.org/jira/browse/YARN-117&quot; title=&quot;Enhance YARN service model&quot; class=&quot;issue-link&quot; data-issue-key=&quot;YARN-117&quot;&gt;&lt;del&gt;YARN-117&lt;/del&gt;&lt;/a&gt; work was to fix the situation where a lot of services were doing their init logic before super.init(), so could be called repeatedly before checking state, and weren&apos;t doing thread-safe operations either. &lt;/p&gt;

&lt;p&gt;the only way could address this is to rework the service model with extra transitional states (initing, starting, stopping), the way some service lifecycles do (such as &lt;a href=&quot;https://code.google.com/p/guava-libraries/wiki/ServiceExplained&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Guava&lt;/a&gt;. That gets to break everything as it is a major change in the service model.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;the current usage pattern of adding services followed by a call to super.serviceInit() will remain valid?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;yes, and I went through the entire source tree looking at every single place the calls were being made to see what was going on. &lt;/p&gt;

&lt;p&gt;This is the lowest risk patch: it doesn&apos;t change any of the semantics of adding a service, merely guarantees there are  no re-entrancy problems. Anything more sophisticated breaks things.&lt;/p&gt;</comment>
                            <comment id="13887886" author="kkambatl" created="Fri, 31 Jan 2014 16:40:11 +0000"  >&lt;p&gt;Reading through the issues addressed by &lt;a href=&quot;https://issues.apache.org/jira/browse/YARN-117&quot; title=&quot;Enhance YARN service model&quot; class=&quot;issue-link&quot; data-issue-key=&quot;YARN-117&quot;&gt;&lt;del&gt;YARN-117&lt;/del&gt;&lt;/a&gt; and the related discussions, I now see the reason behind the current approach of parent service entering a state before child services. Agree we ll probably have to add transient states like INITING, STARTING etc. to address to go the other way, and that it is too large a change to just bring in.&lt;/p&gt;

&lt;p&gt;I think there is merit to getting this patch in. Let me take a closer look at the tests.&lt;/p&gt;</comment>
                            <comment id="13887911" author="kkambatl" created="Fri, 31 Jan 2014 17:18:14 +0000"  >&lt;p&gt;Really like the use of AddBlockingService.&lt;/p&gt;

&lt;p&gt;Comments:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Is there a need for the static method AddBlockingService#addChildService()? Why not just call parent.addService?&lt;/li&gt;
	&lt;li&gt;Nit: Would be nice to have the tests in an order - adding (Uninited, Inited, Started, Stopped) children to Uninited parent, Inited parent etc. - 16 tests in all. Then, the test serves as a rubric for someone to understand the behavior.&lt;/li&gt;
	&lt;li&gt;Nit: Rename testAddSiblingInStart to testAddStartedSiblingInStart&lt;/li&gt;
	&lt;li&gt;Nit: Rename testAddSiblingInStop to testAddStartedSiblingInStop&lt;/li&gt;
	&lt;li&gt;Nit: Rename testAddSiblingInInit to testAddInitedSiblingInInit&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="13887951" author="kkambatl" created="Fri, 31 Jan 2014 18:06:50 +0000"  >&lt;blockquote&gt;&lt;p&gt;Nit: Would be nice to have the tests in an order - adding (Uninited, Inited, Started, Stopped) children to Uninited parent, Inited parent etc. - 16 tests in all. Then, the test serves as a rubric for someone to understand the behavior.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Given we have already spent enough time on this, we can may be do this in a follow up JIRA - filed &lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-10321&quot; title=&quot;TestCompositeService should cover all enumerations of adding a service to a parent service&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-10321&quot;&gt;&lt;del&gt;HADOOP-10321&lt;/del&gt;&lt;/a&gt; for the same.&lt;/p&gt;</comment>
                            <comment id="13888568" author="stevel@apache.org" created="Sat, 1 Feb 2014 13:02:48 +0000"  >&lt;p&gt;-I don&apos;t agree with adding new states as (a) it adds a lot more complexity and is generally irrelevant. (b) breaks compabitility of an API that is already in use in external applications. You are free to file a JIRA on the topic, but I won&apos;t support it. &lt;/p&gt;</comment>
                            <comment id="13888572" author="stevel@apache.org" created="Sat, 1 Feb 2014 13:27:59 +0000"  >&lt;p&gt;updated with tests renamed&lt;/p&gt;</comment>
                            <comment id="13888573" author="stevel@apache.org" created="Sat, 1 Feb 2014 13:28:09 +0000"  >&lt;blockquote&gt;&lt;p&gt;Is there a need for the static method AddBlockingService#addChildService()? Why not just call parent.addService?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, as &lt;tt&gt;parent.addService()&lt;/tt&gt; is protected. &lt;/p&gt;


</comment>
                            <comment id="13888605" author="hadoopqa" created="Sat, 1 Feb 2014 14:07:05 +0000"  >&lt;p&gt;&lt;font color=&quot;green&quot;&gt;+1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12626476/HADOOP-10085-005.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12626476/HADOOP-10085-005.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 tests included&lt;/font&gt;.  The patch appears to include 1 new or modified test files.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javadoc&lt;/font&gt;.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 eclipse:eclipse&lt;/font&gt;.  The patch built with eclipse:eclipse.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 findbugs&lt;/font&gt;.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 release audit&lt;/font&gt;.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 core tests&lt;/font&gt;.  The patch passed unit tests in hadoop-common-project/hadoop-common hadoop-yarn-project/hadoop-yarn/hadoop-yarn-common.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 contrib tests&lt;/font&gt;.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/3521//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/3521//testReport/&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/3521//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/3521//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13889006" author="kkambatl" created="Sun, 2 Feb 2014 18:25:11 +0000"  >&lt;blockquote&gt;&lt;p&gt;I don&apos;t agree with adding new states as (a) it adds a lot more complexity and is generally irrelevant. (b) breaks compabitility of an API that is already in use in external applications. You are free to file a JIRA on the topic, but I won&apos;t support it.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;As I already said in my previous comment, I agree with your assessment here completely. So, yeah, I was/am not planning to file a JIRA. The JIRA I was filing was to add more tests - adding a child in every state to a parent in every state. &lt;/p&gt;

&lt;p&gt;The latest patch looks good to me. +1. Committing this.&lt;/p&gt;</comment>
                            <comment id="13889042" author="hudson" created="Sun, 2 Feb 2014 20:07:16 +0000"  >&lt;p&gt;SUCCESS: Integrated in Hadoop-trunk-Commit #5093 (See &lt;a href=&quot;https://builds.apache.org/job/Hadoop-trunk-Commit/5093/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Hadoop-trunk-Commit/5093/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-10085&quot; title=&quot;CompositeService should allow adding services while being inited&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-10085&quot;&gt;&lt;del&gt;HADOOP-10085&lt;/del&gt;&lt;/a&gt;. CompositeService should allow adding services while being inited. (Steve Loughran via kasha) (kasha: &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1563694&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1563694&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hadoop/common/trunk/hadoop-common-project/hadoop-common/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/hadoop/common/trunk/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/service/CompositeService.java&lt;/li&gt;
	&lt;li&gt;/hadoop/common/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/service/TestCompositeService.java&lt;/li&gt;
	&lt;li&gt;/hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-common/src/test/java/org/apache/hadoop/yarn/util/TestCompositeService.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13889047" author="kkambatl" created="Sun, 2 Feb 2014 20:44:03 +0000"  >&lt;p&gt;Thanks Steve for the extensive investigation of various options and the fix. &lt;/p&gt;

&lt;p&gt;Just committed this to trunk and branch-2. &lt;/p&gt;</comment>
                            <comment id="13889048" author="kkambatl" created="Sun, 2 Feb 2014 20:45:30 +0000"  >&lt;p&gt;I don&apos;t necessarily see this as a blocker for 2.3. If you think it is, please feel free to commit this to branch-2.3 or let me know and I can. &lt;/p&gt;</comment>
                            <comment id="13889389" author="hudson" created="Mon, 3 Feb 2014 11:13:52 +0000"  >&lt;p&gt;SUCCESS: Integrated in Hadoop-Yarn-trunk #470 (See &lt;a href=&quot;https://builds.apache.org/job/Hadoop-Yarn-trunk/470/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Hadoop-Yarn-trunk/470/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-10085&quot; title=&quot;CompositeService should allow adding services while being inited&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-10085&quot;&gt;&lt;del&gt;HADOOP-10085&lt;/del&gt;&lt;/a&gt;. CompositeService should allow adding services while being inited. (Steve Loughran via kasha) (kasha: &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1563694&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1563694&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hadoop/common/trunk/hadoop-common-project/hadoop-common/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/hadoop/common/trunk/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/service/CompositeService.java&lt;/li&gt;
	&lt;li&gt;/hadoop/common/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/service/TestCompositeService.java&lt;/li&gt;
	&lt;li&gt;/hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-common/src/test/java/org/apache/hadoop/yarn/util/TestCompositeService.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13889468" author="hudson" created="Mon, 3 Feb 2014 13:30:04 +0000"  >&lt;p&gt;FAILURE: Integrated in Hadoop-Mapreduce-trunk #1687 (See &lt;a href=&quot;https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1687/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1687/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-10085&quot; title=&quot;CompositeService should allow adding services while being inited&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-10085&quot;&gt;&lt;del&gt;HADOOP-10085&lt;/del&gt;&lt;/a&gt;. CompositeService should allow adding services while being inited. (Steve Loughran via kasha) (kasha: &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1563694&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1563694&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hadoop/common/trunk/hadoop-common-project/hadoop-common/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/hadoop/common/trunk/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/service/CompositeService.java&lt;/li&gt;
	&lt;li&gt;/hadoop/common/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/service/TestCompositeService.java&lt;/li&gt;
	&lt;li&gt;/hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-common/src/test/java/org/apache/hadoop/yarn/util/TestCompositeService.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13889477" author="hudson" created="Mon, 3 Feb 2014 13:39:27 +0000"  >&lt;p&gt;SUCCESS: Integrated in Hadoop-Hdfs-trunk #1662 (See &lt;a href=&quot;https://builds.apache.org/job/Hadoop-Hdfs-trunk/1662/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Hadoop-Hdfs-trunk/1662/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-10085&quot; title=&quot;CompositeService should allow adding services while being inited&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-10085&quot;&gt;&lt;del&gt;HADOOP-10085&lt;/del&gt;&lt;/a&gt;. CompositeService should allow adding services while being inited. (Steve Loughran via kasha) (kasha: &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1563694&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1563694&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hadoop/common/trunk/hadoop-common-project/hadoop-common/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/hadoop/common/trunk/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/service/CompositeService.java&lt;/li&gt;
	&lt;li&gt;/hadoop/common/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/service/TestCompositeService.java&lt;/li&gt;
	&lt;li&gt;/hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-common/src/test/java/org/apache/hadoop/yarn/util/TestCompositeService.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12612669" name="HADOOP-10085-002.patch" size="36623" author="stevel@apache.org" created="Thu, 7 Nov 2013 19:09:20 +0000"/>
                            <attachment id="12613633" name="HADOOP-10085-003.patch" size="36450" author="stevel@apache.org" created="Wed, 13 Nov 2013 16:03:30 +0000"/>
                            <attachment id="12626120" name="HADOOP-10085-004.patch" size="38099" author="stevel@apache.org" created="Thu, 30 Jan 2014 16:26:22 +0000"/>
                            <attachment id="12626476" name="HADOOP-10085-005.patch" size="38119" author="stevel@apache.org" created="Sat, 1 Feb 2014 13:27:59 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>357179</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 42 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1pkov:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>357469</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>