<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:55:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HADOOP-16199] KMSLoadBlanceClientProvider does not select token correctly</title>
                <link>https://issues.apache.org/jira/browse/HADOOP-16199</link>
                <project id="12310240" key="HADOOP">Hadoop Common</project>
                    <description>&lt;p&gt;After &lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-14445&quot; title=&quot;Use DelegationTokenIssuer to create KMS delegation tokens that can authenticate to all KMS instances&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-14445&quot;&gt;&lt;del&gt;HADOOP-14445&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-15997&quot; title=&quot;KMS client uses wrong UGI after HADOOP-14445&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-15997&quot;&gt;&lt;del&gt;HADOOP-15997&lt;/del&gt;&lt;/a&gt;, there are still cases where&#160;KMSLoadBlanceClientProvider does not select token correctly.&#160;&lt;/p&gt;

&lt;p&gt;Here is the use case:&lt;/p&gt;

&lt;p&gt;The new configuration key hadoop.security.kms.client.token.use.uri.format=true is set cross all the cluster, including both Submitter and Yarn RM(renewer), which is not covered in the test matrix in this &lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-14445?focusedCommentId=16505761&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-16505761&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;HADOOP-14445 comment&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I will post the debug log and the proposed fix shortly, cc: &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xiaochen&quot; class=&quot;user-hover&quot; rel=&quot;xiaochen&quot;&gt;xiaochen&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jojochuang&quot; class=&quot;user-hover&quot; rel=&quot;jojochuang&quot;&gt;jojochuang&lt;/a&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13222389">HADOOP-16199</key>
            <summary>KMSLoadBlanceClientProvider does not select token correctly</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="xyao">Xiaoyu Yao</assignee>
                                    <reporter username="xyao">Xiaoyu Yao</reporter>
                        <labels>
                            <label>kms</label>
                    </labels>
                <created>Mon, 18 Mar 2019 18:23:10 +0000</created>
                <updated>Wed, 2 Oct 2019 17:15:28 +0000</updated>
                            <resolved>Fri, 29 Mar 2019 05:00:49 +0000</resolved>
                                    <version>3.0.2</version>
                                    <fixVersion>3.3.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="16795315" author="xyao" created="Mon, 18 Mar 2019 19:03:55 +0000"  >&lt;p&gt;As can be seen below, a kms-dt with service field &lt;b&gt;Service: kms://&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;mailto:http@c316-node3.raghav.com&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http@c316-node3.raghav.com&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/mail_small.gif&quot; height=&quot;12&quot; width=&quot;13&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;;[c316-node4.raghav.com:9292/kms|http://c316-node4.raghav.com:9292/kms]&lt;/b&gt; can&apos;t be selected for&#160;LoadBalancingKMSClientProvider because it does not match its &lt;b&gt;canonical service: 172.25.36.130:9292&lt;/b&gt;. Subsequent matching with individual KMSClientProvider also failed in this case.&#160;&#160;&lt;/p&gt;

&lt;p&gt;The comments on reason of hard code canonical service of&#160;LoadBalancingKMSClientProvider to the ip:port of the first KMSClientProvider instance can be improved.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The proposed fix it to allow LoadBalancingKMSClientProvider#selectDelegationToken to match not only the canonical service but also the&#160;delegation token service, which is similar to what we have done in KMSClientProvider#selectDelegationToken.&lt;/p&gt;


&lt;p&gt;Below is detailed failure log for reference:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2019-03-13 18:51:33,056 DEBUG [ContainerLocalizer Downloader] org.apache.hadoop.ipc.ProtobufRpcEngine: Call: getServerDefaults took 5ms
2019-03-13 18:51:33,086 DEBUG [ContainerLocalizer Downloader] org.apache.hadoop.crypto.key.kms.KMSClientProvider: KMSClientProvider created &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; KMS url: [http:&lt;span class=&quot;code-comment&quot;&gt;//c316-node3.raghav.com:9292/kms/v1/] delegation token service: [kms://http@c316-node3].[raghav.com:9292/kms|http://raghav.com:9292/kms]canonical service: 172.25.36.130:9292.
&lt;/span&gt;2019-03-13 18:51:33,087 DEBUG [ContainerLocalizer Downloader] org.apache.hadoop.crypto.key.kms.KMSClientProvider: KMSClientProvider created &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; KMS url: [http:&lt;span class=&quot;code-comment&quot;&gt;//c316-node4.raghav.com:9292/kms/v1/] delegation token service: [kms://http@c316-node4].[raghav.com:9292/kms|http://raghav.com:9292/kms]canonical service: 172.25.38.4:9292.
&lt;/span&gt;2019-03-13 18:51:33,089 DEBUG [ContainerLocalizer Downloader] org.apache.hadoop.crypto.key.kms.LoadBalancingKMSClientProvider: Created LoadBalancingKMSClientProvider &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; KMS url: kms:&lt;span class=&quot;code-comment&quot;&gt;//[http@c316-node3.raghav.com|mailto:http@c316-node3.raghav.com];[c316-node4.raghav.com:9292/kms|http://c316-node4.raghav.com:9292/kms] with 2 providers. delegation token service: kms://[http@c316-node3.raghav.com|mailto:http@c316-node3.raghav.com];[c316-node4.raghav.com:9292/kms|http://c316-node4.raghav.com:9292/kms], canonical service: 172.25.36.130:9292
&lt;/span&gt;...
2019-03-13 18:51:33,112 DEBUG [ContainerLocalizer Downloader] org.apache.hadoop.crypto.key.kms.KMSClientProvider: Current UGI: hr1 (auth:SIMPLE)
2019-03-13 18:51:33,141 DEBUG [ContainerLocalizer Downloader] org.apache.hadoop.crypto.key.kms.KMSClientProvider: +token:Kind: Localizer, Service: , Ident: (org.apache.hadoop.yarn.server.nodemanager.containermanager.localizer.security.LocalizerTokenIdentifier@54604a95)
*2019-03-13 18:51:33,141 DEBUG [ContainerLocalizer Downloader] org.apache.hadoop.crypto.key.kms.KMSClientProvider: +token:Kind: kms-dt, Service: kms:&lt;span class=&quot;code-comment&quot;&gt;//[http@c316-node3.raghav.com|mailto:http@c316-node3.raghav.com];[c316-node4.raghav.com:9292/kms|http://c316-node4.raghav.com:9292/kms], Ident: (kms-dt owner=hr1, renewer=yarn, realUser=oozie, issueDate=1552503090542, maxDate=1553107890542, sequenceNumber=27, masterKeyId=30)*
&lt;/span&gt;2019-03-13 18:51:33,142 DEBUG [ContainerLocalizer Downloader] org.apache.hadoop.crypto.key.kms.KMSClientProvider: +token:Kind: HDFS_DELEGATION_TOKEN, Service: 172.25.35.133:8020, Ident: (token &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; hr1: HDFS_DELEGATION_TOKEN owner=hr1, renewer=yarn, realUser=oozie/c316-node1.[raghav.com@RAGHAV.COM|mailto:raghav.com@RAGHAV.COM], issueDate=1552503090263, maxDate=1553107890263, sequenceNumber=443, masterKeyId=93)
2019-03-13 18:51:33,142 DEBUG [ContainerLocalizer Downloader] org.apache.hadoop.security.token.Token: Cannot find &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; token kind HIVE_DELEGATION_TOKEN
2019-03-13 18:51:33,142 DEBUG [ContainerLocalizer Downloader] org.apache.hadoop.crypto.key.kms.KMSClientProvider: +token:Kind: HIVE_DELEGATION_TOKEN, Service: hiveserver2ClientToken, Ident: 00 03 68 72 31 04 68 69 76 65 05 6f 6f 7a 69 65 8a 01 69 78 65 2b a8 8a 01 69 9c 71 af a8 03 8f 84
2019-03-13 18:51:33,143 DEBUG [ContainerLocalizer Downloader] org.apache.hadoop.crypto.key.kms.KMSClientProvider: +token:Kind: RM_DELEGATION_TOKEN, Service: 172.25.35.133:8050, Ident: (RM_DELEGATION_TOKEN owner=hr1, renewer=yarn, realUser=oozie/c316-node1.[raghav.com@RAGHAV.COM|mailto:raghav.com@RAGHAV.COM], issueDate=1552503090238, maxDate=1553107890238, sequenceNumber=21, masterKeyId=139)
2019-03-13 18:51:33,143 DEBUG [ContainerLocalizer Downloader] org.apache.hadoop.crypto.key.kms.KMSClientProvider: +token:Kind: MR_DELEGATION_TOKEN, Service: 172.25.35.133:10020, Ident: (MR_DELEGATION_TOKEN owner=hr1, renewer=yarn, realUser=oozie/c316-node1.[raghav.com@RAGHAV.COM|mailto:raghav.com@RAGHAV.COM], issueDate=1552503090488, maxDate=1553107890488, sequenceNumber=5, masterKeyId=107)
2019-03-13 18:51:33,144 DEBUG [ContainerLocalizer Downloader] org.apache.hadoop.crypto.key.kms.KMSClientProvider: Login UGI: hr1 (auth:SIMPLE)
2019-03-13 18:51:33,144 DEBUG [ContainerLocalizer Downloader] org.apache.hadoop.crypto.key.kms.KMSClientProvider: Searching &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; KMS delegation token in user hr1 (auth:SIMPLE)&apos;s credentials
2019-03-13 18:51:33,144 DEBUG [ContainerLocalizer Downloader] org.apache.hadoop.crypto.key.kms.KMSClientProvider: selected by alias=172.25.36.130:9292 token=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
2019-03-13 18:51:33,144 DEBUG [ContainerLocalizer Downloader] org.apache.hadoop.crypto.key.kms.KMSClientProvider: selected by service=172.25.36.130:9292 token=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
2019-03-13 18:51:33,144 DEBUG [ContainerLocalizer Downloader] org.apache.hadoop.crypto.key.kms.KMSClientProvider: selected by alias=[kms:&lt;span class=&quot;code-comment&quot;&gt;//http@c316-node4].[raghav.com:9292/kms|http://raghav.com:9292/kms]token=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
&lt;/span&gt;2019-03-13 18:51:33,145 DEBUG [ContainerLocalizer Downloader] org.apache.hadoop.crypto.key.kms.KMSClientProvider: selected by service=[kms:&lt;span class=&quot;code-comment&quot;&gt;//http@c316-node4].[raghav.com:9292/kms|http://raghav.com:9292/kms]token=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
&lt;/span&gt;2019-03-13 18:51:33,145 DEBUG [ContainerLocalizer Downloader] org.apache.hadoop.crypto.key.kms.KMSClientProvider: selected by alias=172.25.38.4:9292 token=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
2019-03-13 18:51:33,145 DEBUG [ContainerLocalizer Downloader] org.apache.hadoop.crypto.key.kms.KMSClientProvider: selected by service=172.25.38.4:9292 token=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
2019-03-13 18:51:33,145 DEBUG [ContainerLocalizer Downloader] org.apache.hadoop.crypto.key.kms.KMSClientProvider: selected by alias=[kms:&lt;span class=&quot;code-comment&quot;&gt;//http@c316-node3].[raghav.com:9292/kms|http://raghav.com:9292/kms]token=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
&lt;/span&gt;2019-03-13 18:51:33,145 DEBUG [ContainerLocalizer Downloader] org.apache.hadoop.crypto.key.kms.KMSClientProvider: selected by service=[kms:&lt;span class=&quot;code-comment&quot;&gt;//http@c316-node3].[raghav.com:9292/kms|http://raghav.com:9292/kms]token=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
&lt;/span&gt;2019-03-13 18:51:33,145 DEBUG [ContainerLocalizer Downloader] org.apache.hadoop.crypto.key.kms.KMSClientProvider: selected by alias=172.25.36.130:9292 token=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
2019-03-13 18:51:33,145 DEBUG [ContainerLocalizer Downloader] org.apache.hadoop.crypto.key.kms.KMSClientProvider: selected by service=172.25.36.130:9292 token=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
2019-03-13 18:51:33,145 DEBUG [ContainerLocalizer Downloader] org.apache.hadoop.crypto.key.kms.KMSClientProvider: Using loginUser when Kerberos is enabled but the actual user does not have either KMS Delegation Token or Kerberos Credentials
2019-03-13 18:51:33,146 DEBUG [ContainerLocalizer Downloader] org.apache.hadoop.security.UserGroupInformation: PrivilegedAction as:hr1 (auth:SIMPLE) from:org.apache.hadoop.crypto.key.kms.KMSClientProvider.createConnection(KMSClientProvider.java:506)
2019-03-13 18:51:33,150 DEBUG [ContainerLocalizer Downloader] org.apache.hadoop.security.token.delegation.web.DelegationTokenAuthenticatedURL: Connecting to url [http:&lt;span class=&quot;code-comment&quot;&gt;//c316-node4.raghav.com:9292/kms/v1/keyversion/hive_key%400/_eek?eek_op=decrypt]with token&#160; as &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
&lt;/span&gt;2019-03-13 18:51:33,150 DEBUG [ContainerLocalizer Downloader] org.apache.hadoop.security.token.delegation.web.DelegationTokenAuthenticatedURL: Token not set, looking &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; delegation token. Creds:[], size:0
2019-03-13 18:51:33,150 DEBUG [ContainerLocalizer Downloader] org.apache.hadoop.security.token.delegation.web.DelegationTokenAuthenticator: No delegation token found &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; url=[http:&lt;span class=&quot;code-comment&quot;&gt;//c316-node4|http://c316-node4/].[raghav.com:9292/kms/v1/keyversion/hive_key%400/_eek?eek_op=decrypt|http://raghav.com:9292/kms/v1/keyversion/hive_key%400/_eek?eek_op=decrypt], token=, authenticating with &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.hadoop.security.token.delegation.web.KerberosDelegationTokenAuthenticator$1
&lt;/span&gt;2019-03-13 18:51:33,178 DEBUG [ContainerLocalizer Downloader] org.apache.hadoop.security.authentication.client.KerberosAuthenticator: Performing our own SPNEGO sequence.
2019-03-13 18:51:33,179 DEBUG [ContainerLocalizer Downloader] org.apache.hadoop.security.authentication.client.KerberosAuthenticator: No subject in context, logging in
2019-03-13 18:51:33,179 DEBUG [ContainerLocalizer Downloader] org.apache.hadoop.security.authentication.client.KerberosAuthenticator: Using subject: Subject:
&#160;&#160;&#160;&#160;&#160;&#160;&#160; Principal: UnixPrincipal: hr1
&#160;&#160;&#160;&#160;&#160;&#160;&#160; Principal: UnixNumericUserPrincipal: 1016
&#160;&#160;&#160;&#160;&#160;&#160;&#160; Principal: UnixNumericGroupPrincipal [Primary Group]: 1016
&#160;
2019-03-13 18:51:33,182 DEBUG [ContainerLocalizer Downloader] org.apache.hadoop.security.UserGroupInformation: PrivilegedActionException as:hr1 (auth:SIMPLE) cause:org.apache.hadoop.security.authentication.client.AuthenticationException: Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; authenticating with endpoint: [http:&lt;span class=&quot;code-comment&quot;&gt;//c316-node4.raghav.com:9292/kms/v1/keyversion/hive_key%400/_eek?eek_op=decrypt]
&lt;/span&gt;2019-03-13 18:51:33,182 WARN [ContainerLocalizer Downloader] org.apache.hadoop.crypto.key.kms.LoadBalancingKMSClientProvider: KMS provider at [[http:&lt;span class=&quot;code-comment&quot;&gt;//c316-node4.raghav.com:9292/kms/v1/]] threw an IOException:
&lt;/span&gt;java.io.IOException: org.apache.hadoop.security.authentication.client.AuthenticationException: Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; authenticating with endpoint: [http:&lt;span class=&quot;code-comment&quot;&gt;//c316-node4.raghav.com:9292/kms/v1/keyversion/hive_key%400/_eek?eek_op=decrypt]&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16801291" author="xyao" created="Tue, 26 Mar 2019 01:12:37 +0000"  >&lt;p&gt;Submit a patch that repros the issue along with the fix and verification.&lt;/p&gt;</comment>
                            <comment id="16801825" author="jojochuang" created="Tue, 26 Mar 2019 15:01:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=daryn&quot; class=&quot;user-hover&quot; rel=&quot;daryn&quot;&gt;daryn&lt;/a&gt; any chance you can offer some comments? I&apos;m reviewing this patch but thought you should be aware of this one.&lt;/p&gt;</comment>
                            <comment id="16802189" author="jojochuang" created="Tue, 26 Mar 2019 21:20:15 +0000"  >&lt;p&gt;The added test is&#160;almost the same as&#160;testTokenServiceCreationWithUriFormat, added in &lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-15997&quot; title=&quot;KMS client uses wrong UGI after HADOOP-14445&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-15997&quot;&gt;&lt;del&gt;HADOOP-15997&lt;/del&gt;&lt;/a&gt;, except that it configured key provider explicitly.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; providerUriString = &lt;span class=&quot;code-quote&quot;&gt;&quot;kms:&lt;span class=&quot;code-comment&quot;&gt;//http@host1;host2;host3:9600/kms/foo&quot;&lt;/span&gt;;
&lt;/span&gt;conf.set(CommonConfigurationKeysPublic.HADOOP_SECURITY_KEY_PROVIDER_PATH,
			providerUriString);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;After &lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-14445&quot; title=&quot;Use DelegationTokenIssuer to create KMS delegation tokens that can authenticate to all KMS instances&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-14445&quot;&gt;&lt;del&gt;HADOOP-14445&lt;/del&gt;&lt;/a&gt;, if configuring KMS provide path explicitly for client, the expected behavior is: the client gets a kms dt whose credential alias is one of (randomly selected) KMS URI.&lt;/p&gt;

&lt;p&gt;After &lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-14445&quot; title=&quot;Use DelegationTokenIssuer to create KMS delegation tokens that can authenticate to all KMS instances&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-14445&quot;&gt;&lt;del&gt;HADOOP-14445&lt;/del&gt;&lt;/a&gt;, and if&#160;client gets KMS URI&#160;in FsServerDefaults from NameNode, it gets a delegation token&#160;whose credential alias is the concatenated string of KMS URIs.&lt;/p&gt;

&lt;p&gt;Looking at the application log, my question is: why does the client have a KMS dt in the newer form rather than the old form (&quot;host1:9600&quot;)? Is it expected?&lt;/p&gt;</comment>
                            <comment id="16803459" author="xyao" created="Wed, 27 Mar 2019 23:27:49 +0000"  >&lt;blockquote&gt;&lt;p&gt;The added test is&#160;almost the same as&#160;testTokenServiceCreationWithUriFormat, added in&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-15997&quot; title=&quot;KMS client uses wrong UGI after HADOOP-14445&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-15997&quot;&gt;&lt;del&gt;HADOOP-15997&lt;/del&gt;&lt;/a&gt;, except that it configured key provider explicitly.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yes. That&apos;s a valid client configuration where client just downloaded the configuration from the same configuration used by Ambari/CM managed cluster, where&#160;hadoop.security.key.provider.path=kms://http@kms1;kms2:9600/kms&lt;/p&gt;
&lt;blockquote&gt;&lt;blockquote&gt;&lt;p&gt;&#160;After&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-14445&quot; title=&quot;Use DelegationTokenIssuer to create KMS delegation tokens that can authenticate to all KMS instances&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-14445&quot;&gt;&lt;del&gt;HADOOP-14445&lt;/del&gt;&lt;/a&gt;, if configuring KMS provide path explicitly for client, the expected behavior is: the client gets a kms dt whose credential alias is one of (randomly selected) KMS URI.&lt;/p&gt;&lt;/blockquote&gt;&lt;/blockquote&gt;
&lt;p&gt;The following code in LoadBalanceKMSCLientProvider#getDelegationToken was added by &lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-14445&quot; title=&quot;Use DelegationTokenIssuer to create KMS delegation tokens that can authenticate to all KMS instances&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-14445&quot;&gt;&lt;del&gt;HADOOP-14445&lt;/del&gt;&lt;/a&gt;&#160;to set the token service field to the the KMS URI so that it can be used across all instances. Check the KMSUtil#createKeyProvider and HdfsKMSUtil.createKeyProvider the uri&#160;configured above will be the one set into the token service field by&#160;LoadBalanceKMSCLientProvider.&#160;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Token&amp;lt;?&amp;gt; getDelegationToken(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; renewer) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
&#160; &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; doOp(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ProviderCallable&amp;lt;Token&amp;lt;?&amp;gt;&amp;gt;() {
&#160; &#160; @Override
&#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Token&amp;lt;?&amp;gt; call(KMSClientProvider provider) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
&#160; &#160; &#160;Token&amp;lt;?&amp;gt; token = provider.getDelegationToken(renewer);
&#160; &#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// override sub-providers service with our own so it can be used
&lt;/span&gt;&#160; &#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// across all providers.
&lt;/span&gt;&#160; &#160; &#160; token.setService(dtService);&#160;
&#160; &#160; &#160; LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;New token service set. Token: ({})&quot;&lt;/span&gt;, token);
&#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; token;
&#160; }

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16803975" author="jojochuang" created="Thu, 28 Mar 2019 14:20:10 +0000"  >&lt;p&gt;Ok. LGTM As long as it breaks existing applications when the application is well-behaved, I think the fix makes sense. We&apos;ve also seen the similar error in Cloudera BDR when &lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-14445&quot; title=&quot;Use DelegationTokenIssuer to create KMS delegation tokens that can authenticate to all KMS instances&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-14445&quot;&gt;&lt;del&gt;HADOOP-14445&lt;/del&gt;&lt;/a&gt; is backported, so I&apos;d be curious to see if it fixes the issue for BDR.&lt;/p&gt;</comment>
                            <comment id="16804088" author="jojochuang" created="Thu, 28 Mar 2019 16:30:10 +0000"  >&lt;p&gt;+1 will commit it shortly.&lt;/p&gt;</comment>
                            <comment id="16804587" author="xyao" created="Fri, 29 Mar 2019 05:00:49 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=weichiu&quot; class=&quot;user-hover&quot; rel=&quot;weichiu&quot;&gt;weichiu&lt;/a&gt; for the review. I just commit the patch to trunk. Will backport to 3.2, 3.1, 3.0 where &lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-14445&quot; title=&quot;Use DelegationTokenIssuer to create KMS delegation tokens that can authenticate to all KMS instances&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-14445&quot;&gt;&lt;del&gt;HADOOP-14445&lt;/del&gt;&lt;/a&gt; is included.&#160;&#160;&lt;/p&gt;</comment>
                            <comment id="16804630" author="hudson" created="Fri, 29 Mar 2019 06:34:42 +0000"  >&lt;p&gt;FAILURE: Integrated in Jenkins build Hadoop-trunk-Commit #16302 (See &lt;a href=&quot;https://builds.apache.org/job/Hadoop-trunk-Commit/16302/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Hadoop-trunk-Commit/16302/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-16199&quot; title=&quot;KMSLoadBlanceClientProvider does not select token correctly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-16199&quot;&gt;&lt;del&gt;HADOOP-16199&lt;/del&gt;&lt;/a&gt;. KMSLoadBlanceClientProvider does not select token (github: rev f41f938b2e498161da96bfad77410871a3a85728)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/crypto/key/kms/LoadBalancingKMSClientProvider.java&lt;/li&gt;
	&lt;li&gt;(edit) hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/crypto/key/kms/TestLoadBalancingKMSClientProvider.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                                                <inwardlinks description="is broken by">
                                        <issuelink>
            <issuekey id="13073925">HADOOP-14445</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 33 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z00tw0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>