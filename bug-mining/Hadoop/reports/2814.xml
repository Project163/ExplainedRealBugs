<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:57:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HADOOP-17975] Fallback to simple auth does not work for a secondary DistributedFileSystem instance</title>
                <link>https://issues.apache.org/jira/browse/HADOOP-17975</link>
                <project id="12310240" key="HADOOP">Hadoop Common</project>
                    <description>&lt;p&gt;The following code snippet demonstrates what is necessary to cause a failure in connection to a non secure cluster with fallback to SIMPLE auth allowed from a secure cluster.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#160; &#160; Configuration conf = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Configuration();

&#160; &#160; conf.setBoolean(&lt;span class=&quot;code-quote&quot;&gt;&quot;ipc.client.fallback-to-simple-auth-allowed&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
&#160; &#160; URI fsUri = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; URI(&lt;span class=&quot;code-quote&quot;&gt;&quot;hdfs:&lt;span class=&quot;code-comment&quot;&gt;//&amp;lt;nn_uri&amp;gt;&quot;&lt;/span&gt;);
&lt;/span&gt;
&#160; &#160; conf.setBoolean(&lt;span class=&quot;code-quote&quot;&gt;&quot;fs.hdfs.impl.disable.cache&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
&#160; &#160; FileSystem fs = FileSystem.get(fsUri, conf);
&#160; &#160; FSDataInputStream src = fs.open(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Path(&lt;span class=&quot;code-quote&quot;&gt;&quot;/path/to/a/file&quot;&lt;/span&gt;));
&#160; &#160; FileOutputStream dst = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FileOutputStream(File.createTempFile(&lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;bar&quot;&lt;/span&gt;));
&#160; &#160; IOUtils.copyBytes(src, dst, 1024);

    &lt;span class=&quot;code-comment&quot;&gt;// The issue happens even &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; we re-enable cache at &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; point
&lt;/span&gt;&#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;//conf.setBoolean(&lt;span class=&quot;code-quote&quot;&gt;&quot;fs.hdfs.impl.disable.cache&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// The issue does not happen when we close the first FileSystem object
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// before creating the second.
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;//fs.close();
&lt;/span&gt;&#160; &#160; FileSystem fs2 = FileSystem.get(fsUri, conf);
&#160; &#160; FSDataInputStream src2 = fs2.open(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Path(&lt;span class=&quot;code-quote&quot;&gt;&quot;/path/to/a/file&quot;&lt;/span&gt;));
&#160; &#160; FileOutputStream dst2 = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FileOutputStream(File.createTempFile(&lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;bar&quot;&lt;/span&gt;));
&#160; &#160; IOUtils.copyBytes(src2, dst2, 1024);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;The problem is that when the DfsClient is created it creates an instance of AtomicBoolean, which is propagated down into the IPC layer, where the Client.Connection instance in setupIOStreams sets its value. This connection object is cached and re-used to multiplex requests against the same DataNode.&lt;/p&gt;

&lt;p&gt;In case of creating a second DfsClient, the AtomicBoolean reference in the client is a new AtomicBoolean, but the Client.Connection instance is the same, and as it has a socket already open to the DataNode, it returns immediatelly from setupIOStreams, leaving the fallbackToSimpleAuth AtomicBoolean false as it is created in the DfsClient.&lt;br/&gt;
This AtomicBoolean on the other hand controls how the SaslDataTransferClient handles the connection in the above level, and with this value left on the default false, the SaslDataTransferClient of the second DfsClient will not fall back to SIMPLE authentication but will try to send a SASL handshake when connecting to the DataNode.&lt;br/&gt;
&#160;&lt;br/&gt;
The access to the FileSystem via the second DfsClient fails with exceptions like the following one, then fails the read with a BlockMissingException like below:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
WARN hdfs.DFSClient: Failed to connect to /&amp;lt;dn_ip&amp;gt;:&amp;lt;dn_port&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; file &amp;lt;file&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; block BP-531773307-&amp;lt;nn_ip&amp;gt;-1634685133591:blk_1073741826_1002, add to deadNodes and &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;. 
java.io.EOFException: Unexpected EOF &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; trying to read response from server
	at org.apache.hadoop.hdfs.protocolPB.PBHelperClient.vintPrefixed(PBHelperClient.java:552)
	at org.apache.hadoop.hdfs.protocol.datatransfer.sasl.DataTransferSaslUtil.readSaslMessage(DataTransferSaslUtil.java:215)
	at org.apache.hadoop.hdfs.protocol.datatransfer.sasl.SaslDataTransferClient.doSaslHandshake(SaslDataTransferClient.java:455)
	at org.apache.hadoop.hdfs.protocol.datatransfer.sasl.SaslDataTransferClient.getSaslStreams(SaslDataTransferClient.java:393)
	at org.apache.hadoop.hdfs.protocol.datatransfer.sasl.SaslDataTransferClient.send(SaslDataTransferClient.java:267)
	at org.apache.hadoop.hdfs.protocol.datatransfer.sasl.SaslDataTransferClient.checkTrustAndSend(SaslDataTransferClient.java:215)
	at org.apache.hadoop.hdfs.protocol.datatransfer.sasl.SaslDataTransferClient.peerSend(SaslDataTransferClient.java:160)
	at org.apache.hadoop.hdfs.DFSUtilClient.peerFromSocketAndKey(DFSUtilClient.java:648)
	at org.apache.hadoop.hdfs.DFSClient.newConnectedPeer(DFSClient.java:2980)
	at org.apache.hadoop.hdfs.client.impl.BlockReaderFactory.nextTcpPeer(BlockReaderFactory.java:822)
	at org.apache.hadoop.hdfs.client.impl.BlockReaderFactory.getRemoteBlockReaderFromTcp(BlockReaderFactory.java:747)
	at org.apache.hadoop.hdfs.client.impl.BlockReaderFactory.build(BlockReaderFactory.java:380)
	at org.apache.hadoop.hdfs.DFSInputStream.getBlockReader(DFSInputStream.java:658)
	at org.apache.hadoop.hdfs.DFSInputStream.blockSeekTo(DFSInputStream.java:589)
	at org.apache.hadoop.hdfs.DFSInputStream.readWithStrategy(DFSInputStream.java:771)
	at org.apache.hadoop.hdfs.DFSInputStream.read(DFSInputStream.java:840)
	at java.io.DataInputStream.read(DataInputStream.java:100)
	at org.apache.hadoop.io.IOUtils.copyBytes(IOUtils.java:94)
	at DfsClientTest3.main(DfsClientTest3.java:30)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
org.apache.hadoop.hdfs.BlockMissingException: Could not obtain block: BP-813026743-&amp;lt;nn_ip&amp;gt;-1495248833293:blk_1139767762_66027405 file=/path/to/file
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;br/&gt;
The DataNode in the meantime logs the following:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ERROR org.apache.hadoop.hdfs.server.datanode.DataNode: &amp;lt;dn_host&amp;gt;:&amp;lt;dn_port&amp;gt;:DataXceiver error processing unknown operation  src: /&amp;lt;client_ip&amp;gt;:&amp;lt;client_port&amp;gt; dst: /&amp;lt;dn_ip&amp;gt;:&amp;lt;dn_port&amp;gt;
java.io.IOException: Version Mismatch (Expected: 28, Received: -8531 )
        at org.apache.hadoop.hdfs.protocol.datatransfer.Receiver.readOp(Receiver.java:70)
        at org.apache.hadoop.hdfs.server.datanode.DataXceiver.run(DataXceiver.java:222)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This happens only if the second client is connecting to the same DataNode as the first one did, so might seem intermittent in case the clients are reading different files, but happens always if the two client reads the same file with replication factor 1.&lt;/p&gt;

&lt;p&gt;We ran into this issue during running HBase ExportSnapshot tool to move a snapshot from a non-secure to a secure cluster, the issue is loosely related to &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-12819&quot; title=&quot;ExportSnapshot doesn&amp;#39;t close FileSystem instances&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-12819&quot;&gt;&lt;del&gt;HBASE-12819&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/HBASE-20433&quot; title=&quot;HBase Export Snapshot utility does not close FileSystem instances&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HBASE-20433&quot;&gt;&lt;del&gt;HBASE-20433&lt;/del&gt;&lt;/a&gt; and similar problems, I am linking these so that HBase team will see how this is relevant for them.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13407954">HADOOP-17975</key>
            <summary>Fallback to simple auth does not work for a secondary DistributedFileSystem instance</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pifta">Istv&#225;n Fajth</assignee>
                                    <reporter username="pifta">Istv&#225;n Fajth</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 22 Oct 2021 12:35:51 +0000</created>
                <updated>Mon, 14 Feb 2022 18:03:51 +0000</updated>
                            <resolved>Wed, 24 Nov 2021 11:33:12 +0000</resolved>
                                                    <fixVersion>3.4.0</fixVersion>
                    <fixVersion>3.3.2</fixVersion>
                    <fixVersion>3.2.4</fixVersion>
                                    <component>ipc</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="36600">10h 10m</timespent>
                                    <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13152956">HBASE-20433</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12765479">HBASE-12819</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 3 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0w31c:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>