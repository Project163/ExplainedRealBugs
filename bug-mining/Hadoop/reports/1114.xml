<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:44:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HADOOP-10301] AuthenticationFilter should return Forbidden for failed authentication</title>
                <link>https://issues.apache.org/jira/browse/HADOOP-10301</link>
                <project id="12310240" key="HADOOP">Hadoop Common</project>
                    <description>&lt;p&gt;The hadoop-auth AuthenticationFilter returns a 401 Unauthorized without a WWW-Authenticate headers.  The is illegal per the HTTP RPC and causes a NPE in the HttpUrlConnection.&lt;/p&gt;

&lt;p&gt;This is half of a fix that affects webhdfs.  See &lt;a href=&quot;https://issues.apache.org/jira/browse/HDFS-4564&quot; title=&quot;Webhdfs returns incorrect http response codes for denied operations&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HDFS-4564&quot;&gt;&lt;del&gt;HDFS-4564&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12691838">HADOOP-10301</key>
            <summary>AuthenticationFilter should return Forbidden for failed authentication</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="daryn">Daryn Sharp</assignee>
                                    <reporter username="daryn">Daryn Sharp</reporter>
                        <labels>
                    </labels>
                <created>Tue, 28 Jan 2014 21:28:02 +0000</created>
                <updated>Thu, 12 May 2016 18:22:26 +0000</updated>
                            <resolved>Fri, 28 Mar 2014 21:32:35 +0000</resolved>
                                    <version>0.23.0</version>
                    <version>2.0.0-alpha</version>
                    <version>3.0.0-alpha1</version>
                                    <fixVersion>2.4.0</fixVersion>
                                    <component>security</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>13</watches>
                                                                                                                <comments>
                            <comment id="13884740" author="hadoopqa" created="Tue, 28 Jan 2014 21:51:21 +0000"  >&lt;p&gt;&lt;font color=&quot;green&quot;&gt;+1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12625672/HADOOP-10301.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12625672/HADOOP-10301.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 tests included&lt;/font&gt;.  The patch appears to include 2 new or modified test files.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javadoc&lt;/font&gt;.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 eclipse:eclipse&lt;/font&gt;.  The patch built with eclipse:eclipse.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 findbugs&lt;/font&gt;.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 release audit&lt;/font&gt;.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 core tests&lt;/font&gt;.  The patch passed unit tests in hadoop-common-project/hadoop-auth.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 contrib tests&lt;/font&gt;.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/3489//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/3489//testReport/&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/3489//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/3489//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13888166" author="daryn" created="Fri, 31 Jan 2014 21:06:06 +0000"  >&lt;p&gt;The 0.23 patch causes problems for oozie&apos;s use of auth cookies.  Oozie caches the cookies on the local fs until they are invalid and expects fallback to spnego to occur.&lt;/p&gt;

&lt;p&gt;Currently, an uncaught AuthenticationException in a servlet sends the client an illegal 401 with no WWW-Authenticate header.  The existing behavior:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;2.x catches and ignores AuthenticationException while validating auth cookies - expired, wrong secret, wrong type, etc.  A valid 401 + negotiate header is sent to trigger spnego.  No problem here.&lt;/li&gt;
	&lt;li&gt;0.23 does &lt;b&gt;not&lt;/b&gt; catch AuthenticationException while validating auth cookies.  Servlet returns an illegal 401 with no auth header causing a client NPE.&lt;/li&gt;
	&lt;li&gt;Neither 2.x nor 0.23 catch AuthenticationExceptions if spnego fails or proxy authorization fails.  Servlet returns an illegal 401.  Client NPE.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;These patches fix all these issues by converting uncaught AuthenticationExceptions from 401 to 403 Forbidden which is entirely appropriate for #3.  However, for 0.23 (#2), the client does not revert to spnego for invalid auth cookies.  I&apos;m studying AuthenticatedURL to see how the invalid 401 ever could have worked for oozie.  There&apos;s a tangle of issues with how webhdfs vs. oozie expects this to work that I&apos;m investigating.&lt;/p&gt;</comment>
                            <comment id="13890003" author="daryn" created="Mon, 3 Feb 2014 22:23:31 +0000"  >&lt;p&gt;Modified patches to always return 401 when auth cookie validation fails.   The response message of the 401 is the reason.&lt;/p&gt;</comment>
                            <comment id="13890051" author="hadoopqa" created="Mon, 3 Feb 2014 22:52:37 +0000"  >&lt;p&gt;&lt;font color=&quot;green&quot;&gt;+1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12626749/HADOOP-10301.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12626749/HADOOP-10301.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 tests included&lt;/font&gt;.  The patch appears to include 2 new or modified test files.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javadoc&lt;/font&gt;.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 eclipse:eclipse&lt;/font&gt;.  The patch built with eclipse:eclipse.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 findbugs&lt;/font&gt;.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 release audit&lt;/font&gt;.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 core tests&lt;/font&gt;.  The patch passed unit tests in hadoop-common-project/hadoop-auth.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 contrib tests&lt;/font&gt;.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/3524//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/3524//testReport/&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/3524//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/3524//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13891226" author="daryn" created="Tue, 4 Feb 2014 21:21:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tucu00&quot; class=&quot;user-hover&quot; rel=&quot;tucu00&quot;&gt;tucu00&lt;/a&gt;, can you take a look?  This is a 2.3 blocker.&lt;/p&gt;</comment>
                            <comment id="13892599" author="tucu00" created="Wed, 5 Feb 2014 21:38:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=daryn&quot; class=&quot;user-hover&quot; rel=&quot;daryn&quot;&gt;daryn&lt;/a&gt;, I may be missing something but it seems that we can still return a 401 without the WWW-Authenticate header right?&lt;/p&gt;

&lt;p&gt;Shouldn&apos;t we define instead?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; errCode = HttpServletResponse.SC_NOT_ACCEPTABLE
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13893462" author="daryn" created="Thu, 6 Feb 2014 15:51:57 +0000"  >&lt;p&gt;Under what condition(s) do you think the 401 sans header can occur?  The unit tests should cover the various scenarios, but I&apos;m double checking all the code paths again.&lt;/p&gt;</comment>
                            <comment id="13893544" author="daryn" created="Thu, 6 Feb 2014 17:08:31 +0000"  >&lt;p&gt;It&apos;s proving very tedious to trace and logically document all the code paths.  In the spirit of keep it simple, how about in the block where &lt;tt&gt;httpResponse.sendError&lt;/tt&gt; is invoked:  if the response is going to be 401 but the auth handler didn&apos;t set the expected WWW-Authenticate header that I convert it to a 403?  If nothing else, it&apos;s a failsafe for future bugs in auth handlers.  I&apos;ll post a patch shortly.&lt;/p&gt;</comment>
                            <comment id="13893545" author="tucu00" created="Thu, 6 Feb 2014 17:10:50 +0000"  >&lt;p&gt;I was about to suggest something like that, the filter itself should never return a 401, that is up to the authhandler (and it must be accompanied of a WWW-Authenticate: header), makes sense.&lt;/p&gt;</comment>
                            <comment id="13893657" author="daryn" created="Thu, 6 Feb 2014 18:55:18 +0000"  >&lt;p&gt;Sigh.  Nothing is ever as easy as it seems.&lt;/p&gt;

&lt;p&gt;I first was going to specifically check if response.status=401 and !response.containsHeader(WWW-Authenticate).  HttpResponse appears to let you set the status, but not query it...  So I fell back to checking errCode=401 and !response.containsHeader(WWW-Authenticate).  Now all the mocked unit tests fail because they don&apos;t persist any state from the response.setHeader, so containsHeader always returns false. :|&lt;/p&gt;

&lt;p&gt;So, I can:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Try to change the unit tests and hope other projects&apos; tests don&apos;t break.&lt;/li&gt;
	&lt;li&gt;Call it a day and unblock 2.3 because I can&apos;t find an existing code path that will cause an illegal 401.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;If you agree with #2, we really should file another jira to cleanup the filter + handler interactions.  Among other things, the auth cookie should exclusively be a feature of the auth filter.  Auth handlers shouldn&apos;t know anything about cookies.  That should make the logic much simpler and easier to enforce proper auth handler behavior, but it&apos;s too much for me to do right now.&lt;/p&gt;</comment>
                            <comment id="13893789" author="tucu00" created="Thu, 6 Feb 2014 20:50:08 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13896932" author="vinodkv" created="Mon, 10 Feb 2014 19:58:46 +0000"  >&lt;p&gt;From what I understand, this is an existing issue with 2.2 and is NOT a regression. This can patch can go in if need be, but I am moving it to 2.4. Please revert back if you disagree. Thanks!&lt;/p&gt;</comment>
                            <comment id="13932004" author="acmurthy" created="Wed, 12 Mar 2014 17:04:52 +0000"  >&lt;p&gt;Is this ready to go? Or, should it be blocking 2.4? Thanks.&lt;/p&gt;</comment>
                            <comment id="13939583" author="daryn" created="Tue, 18 Mar 2014 18:22:07 +0000"  >&lt;p&gt;I had to merge up the patch and fix up some tests.  Relevant code is the same.&lt;/p&gt;</comment>
                            <comment id="13939673" author="hadoopqa" created="Tue, 18 Mar 2014 19:18:49 +0000"  >&lt;p&gt;&lt;font color=&quot;green&quot;&gt;+1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12635358/HADOOP-10301.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12635358/HADOOP-10301.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 tests included&lt;/font&gt;.  The patch appears to include 2 new or modified test files.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javadoc&lt;/font&gt;.  There were no new javadoc warning messages.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 eclipse:eclipse&lt;/font&gt;.  The patch built with eclipse:eclipse.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 findbugs&lt;/font&gt;.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 release audit&lt;/font&gt;.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 core tests&lt;/font&gt;.  The patch passed unit tests in hadoop-common-project/hadoop-auth.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 contrib tests&lt;/font&gt;.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/3678//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/3678//testReport/&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/3678//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/3678//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13944327" author="wheat9" created="Sun, 23 Mar 2014 04:35:07 +0000"  >&lt;p&gt;The patch generally looks good to me.&lt;/p&gt;

&lt;p&gt;My concern is on the testing side. The change is going to affect all downstream projects in secure set ups. Given the fact that 2.4 is coming up pretty soon, I wonder, is it a good idea to put it in at the last minute? It seems to me that there is insufficient time to test it in the 2.4 timeframe, which might break downstream projects like Oozie unexpectedly.&lt;/p&gt;

&lt;p&gt;Since we have move it as a blocker from 2.3 to 2.4, is it okay to move it to 2.5? More precisely, we can continue to make progress on this patch, but commit it only to branch-2 for now. That way this change will be extensively tested in the 2.5 timeframe, and leave the downstream projects enough time to fix any bugs if they occur.&lt;/p&gt;</comment>
                            <comment id="13945571" author="szetszwo" created="Mon, 24 Mar 2014 19:22:55 +0000"  >&lt;p&gt;I agree that it is not a good idea to have this and &lt;a href=&quot;https://issues.apache.org/jira/browse/HDFS-4564&quot; title=&quot;Webhdfs returns incorrect http response codes for denied operations&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HDFS-4564&quot;&gt;&lt;del&gt;HDFS-4564&lt;/del&gt;&lt;/a&gt; as the last minutes changes to 2.4.  How about moving them to 2.5?&lt;/p&gt;</comment>
                            <comment id="13948603" author="jingzhao" created="Wed, 26 Mar 2014 23:01:49 +0000"  >&lt;p&gt;I move this to 2.5. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=daryn&quot; class=&quot;user-hover&quot; rel=&quot;daryn&quot;&gt;daryn&lt;/a&gt;, please revert it back if you think it&apos;s necessary for 2.4.&lt;/p&gt;</comment>
                            <comment id="13949371" author="daryn" created="Thu, 27 Mar 2014 14:14:46 +0000"  >&lt;p&gt;Yes, this must be in 2.4 to prevent client-side NPEs.  We&apos;ve been running the patch internally for 2 months.  It&apos;s been tested with oozie and other internal tools.&lt;/p&gt;</comment>
                            <comment id="13949844" author="szetszwo" created="Thu, 27 Mar 2014 19:40:26 +0000"  >&lt;p&gt;For client-side NPEs, do you mean &lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-9363&quot; title=&quot;AuthenticatedURL will NPE if server closes connection&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-9363&quot;&gt;HADOOP-9363&lt;/a&gt;?  Then, do we also need &lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-9363&quot; title=&quot;AuthenticatedURL will NPE if server closes connection&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-9363&quot;&gt;HADOOP-9363&lt;/a&gt;?  There is no patch in &lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-9363&quot; title=&quot;AuthenticatedURL will NPE if server closes connection&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-9363&quot;&gt;HADOOP-9363&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13949905" author="jingzhao" created="Thu, 27 Mar 2014 20:42:26 +0000"  >&lt;p&gt;The patch for trunk and branch 2.x looks good to me. +1 for the patch.&lt;/p&gt;</comment>
                            <comment id="13951286" author="daryn" created="Fri, 28 Mar 2014 19:39:29 +0000"  >&lt;p&gt;This jira and &lt;a href=&quot;https://issues.apache.org/jira/browse/HDFS-4564&quot; title=&quot;Webhdfs returns incorrect http response codes for denied operations&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HDFS-4564&quot;&gt;&lt;del&gt;HDFS-4564&lt;/del&gt;&lt;/a&gt; are sufficient to fix webhdfs.  &lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-9363&quot; title=&quot;AuthenticatedURL will NPE if server closes connection&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-9363&quot;&gt;HADOOP-9363&lt;/a&gt; should remain open to fix the authenticated url issues. The hdfs jira doesn&apos;t pass true to the url factory so it bypasses the use of authenticated url which avoids another raft of problems.  The use of the auth cookie is completely unnecessary with webhdfs because it obtains a token and then uses it for all subsequent operations.&lt;/p&gt;</comment>
                            <comment id="13951430" author="hudson" created="Fri, 28 Mar 2014 21:29:12 +0000"  >&lt;p&gt;SUCCESS: Integrated in Hadoop-trunk-Commit #5426 (See &lt;a href=&quot;https://builds.apache.org/job/Hadoop-trunk-Commit/5426/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Hadoop-trunk-Commit/5426/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-10301&quot; title=&quot;AuthenticationFilter should return Forbidden for failed authentication&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-10301&quot;&gt;&lt;del&gt;HADOOP-10301&lt;/del&gt;&lt;/a&gt;. AuthenticationFilter should return Forbidden for failed authentication. Contributed by Daryn Sharp. (jing9: &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1582883&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1582883&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hadoop/common/trunk/hadoop-common-project/hadoop-auth/src/main/java/org/apache/hadoop/security/authentication/server/AuthenticationFilter.java&lt;/li&gt;
	&lt;li&gt;/hadoop/common/trunk/hadoop-common-project/hadoop-auth/src/test/java/org/apache/hadoop/security/authentication/client/TestPseudoAuthenticator.java&lt;/li&gt;
	&lt;li&gt;/hadoop/common/trunk/hadoop-common-project/hadoop-auth/src/test/java/org/apache/hadoop/security/authentication/server/TestAuthenticationFilter.java&lt;/li&gt;
	&lt;li&gt;/hadoop/common/trunk/hadoop-common-project/hadoop-common/CHANGES.txt&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13951434" author="jingzhao" created="Fri, 28 Mar 2014 21:32:35 +0000"  >&lt;p&gt;I&apos;ve committed the patch to trunk, branch-2, and branch-2.4. I have not committed it to branch-0.23. Please feel free to commit it if you think it&apos;s ok &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=daryn&quot; class=&quot;user-hover&quot; rel=&quot;daryn&quot;&gt;daryn&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13954252" author="hudson" created="Sat, 29 Mar 2014 13:32:33 +0000"  >&lt;p&gt;FAILURE: Integrated in Hadoop-Mapreduce-trunk #1741 (See &lt;a href=&quot;https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1741/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1741/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-10301&quot; title=&quot;AuthenticationFilter should return Forbidden for failed authentication&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-10301&quot;&gt;&lt;del&gt;HADOOP-10301&lt;/del&gt;&lt;/a&gt;. AuthenticationFilter should return Forbidden for failed authentication. Contributed by Daryn Sharp. (jing9: &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1582883&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1582883&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hadoop/common/trunk/hadoop-common-project/hadoop-auth/src/main/java/org/apache/hadoop/security/authentication/server/AuthenticationFilter.java&lt;/li&gt;
	&lt;li&gt;/hadoop/common/trunk/hadoop-common-project/hadoop-auth/src/test/java/org/apache/hadoop/security/authentication/client/TestPseudoAuthenticator.java&lt;/li&gt;
	&lt;li&gt;/hadoop/common/trunk/hadoop-common-project/hadoop-auth/src/test/java/org/apache/hadoop/security/authentication/server/TestAuthenticationFilter.java&lt;/li&gt;
	&lt;li&gt;/hadoop/common/trunk/hadoop-common-project/hadoop-common/CHANGES.txt&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13954648" author="hudson" created="Sun, 30 Mar 2014 11:21:41 +0000"  >&lt;p&gt;SUCCESS: Integrated in Hadoop-Yarn-trunk #524 (See &lt;a href=&quot;https://builds.apache.org/job/Hadoop-Yarn-trunk/524/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Hadoop-Yarn-trunk/524/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-10301&quot; title=&quot;AuthenticationFilter should return Forbidden for failed authentication&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-10301&quot;&gt;&lt;del&gt;HADOOP-10301&lt;/del&gt;&lt;/a&gt;. AuthenticationFilter should return Forbidden for failed authentication. Contributed by Daryn Sharp. (jing9: &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1582883&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1582883&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hadoop/common/trunk/hadoop-common-project/hadoop-auth/src/main/java/org/apache/hadoop/security/authentication/server/AuthenticationFilter.java&lt;/li&gt;
	&lt;li&gt;/hadoop/common/trunk/hadoop-common-project/hadoop-auth/src/test/java/org/apache/hadoop/security/authentication/client/TestPseudoAuthenticator.java&lt;/li&gt;
	&lt;li&gt;/hadoop/common/trunk/hadoop-common-project/hadoop-auth/src/test/java/org/apache/hadoop/security/authentication/server/TestAuthenticationFilter.java&lt;/li&gt;
	&lt;li&gt;/hadoop/common/trunk/hadoop-common-project/hadoop-common/CHANGES.txt&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13954681" author="hudson" created="Sun, 30 Mar 2014 14:07:28 +0000"  >&lt;p&gt;FAILURE: Integrated in Hadoop-Hdfs-trunk #1716 (See &lt;a href=&quot;https://builds.apache.org/job/Hadoop-Hdfs-trunk/1716/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Hadoop-Hdfs-trunk/1716/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-10301&quot; title=&quot;AuthenticationFilter should return Forbidden for failed authentication&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-10301&quot;&gt;&lt;del&gt;HADOOP-10301&lt;/del&gt;&lt;/a&gt;. AuthenticationFilter should return Forbidden for failed authentication. Contributed by Daryn Sharp. (jing9: &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1582883&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1582883&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/hadoop/common/trunk/hadoop-common-project/hadoop-auth/src/main/java/org/apache/hadoop/security/authentication/server/AuthenticationFilter.java&lt;/li&gt;
	&lt;li&gt;/hadoop/common/trunk/hadoop-common-project/hadoop-auth/src/test/java/org/apache/hadoop/security/authentication/client/TestPseudoAuthenticator.java&lt;/li&gt;
	&lt;li&gt;/hadoop/common/trunk/hadoop-common-project/hadoop-auth/src/test/java/org/apache/hadoop/security/authentication/server/TestAuthenticationFilter.java&lt;/li&gt;
	&lt;li&gt;/hadoop/common/trunk/hadoop-common-project/hadoop-common/CHANGES.txt&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15188097" author="rkanter" created="Wed, 9 Mar 2016 21:42:07 +0000"  >&lt;p&gt;This breaks how the Oozie Client was checking for expired auth tokens (&lt;a href=&quot;https://issues.apache.org/jira/browse/OOZIE-2485&quot; title=&quot;Oozie client keeps trying to use expired auth token&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OOZIE-2485&quot;&gt;&lt;del&gt;OOZIE-2485&lt;/del&gt;&lt;/a&gt;).  I was looking into something related, and saw that when using Kerberos and an expired auth token, Oozie Client wasn&apos;t getting a new token.  &lt;/p&gt;

&lt;p&gt;I didn&apos;t notice this problem until I really dug into the code because the Oozie client commands would still succeed, it would always just log a warning in the Oozie Server from hadoop-auth about the token, and use Kerberos.&lt;/p&gt;

&lt;p&gt;After a lot of debugging, I figured out the cause.  Currently, Oozie does this in &lt;tt&gt;AuthOozieClient&lt;/tt&gt; to determine if a token has expired:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (currentToken.isSet()) {
            HttpURLConnection conn = (HttpURLConnection) url.openConnection();
            conn.setRequestMethod(&lt;span class=&quot;code-quote&quot;&gt;&quot;OPTIONS&quot;&lt;/span&gt;);
            AuthenticatedURL.injectToken(conn, currentToken);
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (conn.getResponseCode() == HttpURLConnection.HTTP_UNAUTHORIZED) {
                AUTH_TOKEN_CACHE_FILE.delete();
                currentToken = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; AuthenticatedURL.Token();
            }
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Previously, the response code would be 401 when the token expired.  Oozie Client would clear out &lt;tt&gt;currentToken&lt;/tt&gt; and some later code would get a new one after using the &lt;tt&gt;KerberosAuthenticator&lt;/tt&gt;.  However, it&apos;s now 200 here and returns a new token (in the header) after successfully doing SPNEGO without (Oozie explicitly) calling the &lt;tt&gt;KerberosAuthenticator&lt;/tt&gt; at all.  To fix this, Oozie has to modify the above to do this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (currentToken.isSet()) {
            HttpURLConnection conn = (HttpURLConnection) url.openConnection();
            conn.setRequestMethod(&lt;span class=&quot;code-quote&quot;&gt;&quot;OPTIONS&quot;&lt;/span&gt;);
            AuthenticatedURL.injectToken(conn, currentToken);
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (conn.getResponseCode() == HttpURLConnection.HTTP_UNAUTHORIZED) {
                AUTH_TOKEN_CACHE_FILE.delete();
                currentToken = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; AuthenticatedURL.Token();
            } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
                &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                    AuthenticatedURL.extractToken(conn, currentToken);
                } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (AuthenticationException ex) {
                    AUTH_TOKEN_CACHE_FILE.delete();
                    currentToken = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; AuthenticatedURL.Token();
                }
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Here it will try to extract the new token if one was given using &lt;tt&gt;AuthenticatedURL.extractToken&lt;/tt&gt;, which will update &lt;tt&gt;currentToken&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="15188101" author="rkanter" created="Wed, 9 Mar 2016 21:43:08 +0000"  >&lt;p&gt;Given that the previous behavior wasn&apos;t following the spec, I guess we have to keep this though, and update Oozie to handle this.  &lt;/p&gt;</comment>
                            <comment id="15188400" author="rkanter" created="Thu, 10 Mar 2016 00:44:40 +0000"  >&lt;p&gt;Pseudo Auth also behaves a little differently than it used to.  It gives a 403 instead of a 401 in the above code.  &lt;tt&gt;extractToken&lt;/tt&gt; throws an &lt;tt&gt;AuthenticationException&lt;/tt&gt; if it doesn&apos;t see a 20X, so the updated code will also handle this case.  In any case, the behavior has changed and its also different than Kerberos Auth, in that it does not give a new token here and gives 403 instead of 200.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="12632603">HADOOP-9311</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                            <outwardlinks description="breaks">
                                        <issuelink>
            <issuekey id="12948546">OOZIE-2485</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310040">
                    <name>Required</name>
                                                                <inwardlinks description="is required by">
                                        <issuelink>
            <issuekey id="12635802">HDFS-4564</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12626748" name="HADOOP-10301.branch-23.patch" size="12735" author="daryn" created="Mon, 3 Feb 2014 22:23:31 +0000"/>
                            <attachment id="12625671" name="HADOOP-10301.branch-23.patch" size="6910" author="daryn" created="Tue, 28 Jan 2014 21:30:09 +0000"/>
                            <attachment id="12635358" name="HADOOP-10301.patch" size="12902" author="daryn" created="Tue, 18 Mar 2014 18:22:07 +0000"/>
                            <attachment id="12626749" name="HADOOP-10301.patch" size="10701" author="daryn" created="Mon, 3 Feb 2014 22:23:31 +0000"/>
                            <attachment id="12625672" name="HADOOP-10301.patch" size="7787" author="daryn" created="Tue, 28 Jan 2014 21:30:09 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>370485</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 36 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1ruqv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>370795</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12326144">2.4.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>