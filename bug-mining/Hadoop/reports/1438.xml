<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:47:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HADOOP-11446] S3AOutputStream should use shared thread pool to avoid OutOfMemoryError</title>
                <link>https://issues.apache.org/jira/browse/HADOOP-11446</link>
                <project id="12310240" key="HADOOP">Hadoop Common</project>
                    <description>&lt;p&gt;When working with Terry Padgett who used s3a for hbase snapshot, the following issue was uncovered.&lt;br/&gt;
Here is part of the output including the OOME when hbase snapshot is exported to s3a (nofile ulimit was increased to 102400):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2014-12-19 13:15:03,895 INFO  [main] s3a.S3AFileSystem: OutputStream &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; key &lt;span class=&quot;code-quote&quot;&gt;&apos;FastQueryPOC/2014-12-11/EVENT1-IDX-snapshot/.hbase-snapshot/.tmp/EVENT1_IDX_snapshot_2012_12_11/    650a5678810fbdaa91809668d11ccf09/.regioninfo&apos;&lt;/span&gt; closed. Now beginning upload
2014-12-19 13:15:03,895 INFO  [main] s3a.S3AFileSystem: Minimum upload part size: 16777216 threshold2147483647
Exception in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt; java.lang.OutOfMemoryError: unable to create &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt; thread
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.start0(Native Method)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.start(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:713)
        at java.util.concurrent.ThreadPoolExecutor.addWorker(ThreadPoolExecutor.java:949)
        at java.util.concurrent.ThreadPoolExecutor.execute(ThreadPoolExecutor.java:1360)
        at java.util.concurrent.AbstractExecutorService.submit(AbstractExecutorService.java:132)
        at com.amazonaws.services.s3.transfer.internal.UploadMonitor.&amp;lt;init&amp;gt;(UploadMonitor.java:129)
        at com.amazonaws.services.s3.transfer.TransferManager.upload(TransferManager.java:449)
        at com.amazonaws.services.s3.transfer.TransferManager.upload(TransferManager.java:382)
        at org.apache.hadoop.fs.s3a.S3AOutputStream.close(S3AOutputStream.java:127)
        at org.apache.hadoop.fs.FSDataOutputStream$PositionCache.close(FSDataOutputStream.java:72)
        at org.apache.hadoop.fs.FSDataOutputStream.close(FSDataOutputStream.java:106)
        at org.apache.hadoop.io.IOUtils.copyBytes(IOUtils.java:54)
        at org.apache.hadoop.io.IOUtils.copyBytes(IOUtils.java:112)
        at org.apache.hadoop.fs.FileUtil.copy(FileUtil.java:366)
        at org.apache.hadoop.fs.FileUtil.copy(FileUtil.java:356)
        at org.apache.hadoop.fs.FileUtil.copy(FileUtil.java:356)
        at org.apache.hadoop.fs.FileUtil.copy(FileUtil.java:338)
        at org.apache.hadoop.hbase.snapshot.ExportSnapshot.run(ExportSnapshot.java:791)
        at org.apache.hadoop.util.ToolRunner.run(ToolRunner.java:70)
        at org.apache.hadoop.hbase.snapshot.ExportSnapshot.innerMain(ExportSnapshot.java:882)
        at org.apache.hadoop.hbase.snapshot.ExportSnapshot.main(ExportSnapshot.java:886)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In S3AOutputStream#close():&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;      TransferManager transfers = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TransferManager(client);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This results in each TransferManager creating its own thread pool, leading to the OOME.&lt;br/&gt;
One solution is to pass shared thread pool to TransferManager.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12763568">HADOOP-11446</key>
            <summary>S3AOutputStream should use shared thread pool to avoid OutOfMemoryError</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yuzhihong@gmail.com">Ted Yu</assignee>
                                    <reporter username="yuzhihong@gmail.com">Ted Yu</reporter>
                        <labels>
                    </labels>
                <created>Tue, 23 Dec 2014 22:15:23 +0000</created>
                <updated>Fri, 10 Apr 2015 20:04:47 +0000</updated>
                            <resolved>Mon, 5 Jan 2015 13:00:25 +0000</resolved>
                                    <version>2.6.0</version>
                                    <fixVersion>2.7.0</fixVersion>
                                    <component>fs/s3</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="14258240" author="thodemoor" created="Wed, 24 Dec 2014 13:27:08 +0000"  >&lt;p&gt;Maybe we can take it even further and share a single TransferManager (as advised by AWS) with a custom threadpool of tunable size (default is FixedThreadPool(10), which is probably too low). Thus, construct a final TransferManager in S3AFileSystem.initialize() and pass it around (to S3AOutputStream)?&lt;/p&gt;</comment>
                            <comment id="14258579" author="yuzhihong@gmail.com" created="Wed, 24 Dec 2014 22:54:29 +0000"  >&lt;p&gt;Thanks for the comment, Thomas.&lt;br/&gt;
AmazonS3Client is used to construct TransferManager. I replaced it with TransferManager in S3AOutputStream ctor.&lt;/p&gt;

&lt;p&gt;Introduced the following parameters which control threadpool used by TransferManager:&lt;br/&gt;
fs.s3a.threads.max&lt;br/&gt;
fs.s3a.threads.core&lt;br/&gt;
fs.s3a.max.total.tasks&lt;br/&gt;
fs.s3a.threads.keepalivetime&lt;/p&gt;</comment>
                            <comment id="14258590" author="hadoopqa" created="Wed, 24 Dec 2014 23:32:34 +0000"  >&lt;p&gt;&lt;font color=&quot;red&quot;&gt;-1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12689078/hadoop-11446-001.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12689078/hadoop-11446-001.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 4f18018.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 tests included&lt;/font&gt;.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javadoc&lt;/font&gt;.  There were no new javadoc warning messages.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 eclipse:eclipse&lt;/font&gt;.  The patch built with eclipse:eclipse.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 findbugs&lt;/font&gt;.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 release audit&lt;/font&gt;.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 core tests&lt;/font&gt;.  The patch passed unit tests in hadoop-tools/hadoop-aws.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/5341//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/5341//testReport/&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/5341//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/5341//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14259682" author="thodemoor" created="Sun, 28 Dec 2014 17:40:30 +0000"  >&lt;p&gt;Hi Ted,&lt;br/&gt;
Looks good to me. Some minor remarks:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The parameters should be defined (and documented) in Constants.java. Your default of fs.s3a.threads.core=256 means up to 256 parallel (part)Uploads. That should fill up your network pipe &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/tongue.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. However, the number of concurrent http connections opened by the underlying AmazonS3Client (fs.s3a.max.connections) is set to a much lower value by default (too low?). Could you elaborate on the default values? I think we should tweak these a bit to give a good &quot;out of the box&quot; experience and/or document some tuning guidelines for different network conditions (use cases).&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Also use the shiny new single TransferManager for purging at the end of initialize() in S3AFileSystem, replacing the following code path
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (purgeExistingMultipart) {
      TransferManager transferManager = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TransferManager(s3);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;I like that you went for a low-level implementation for the Executor instead of using Executors.newFixedThreadPool. The ability to block submitting threads by setting fs.s3a.max.total.tasks  is nice tool for limiting memory consumption. Out of curiosiity: can you envision use cases where setting different values for core.threads and max.threads would be important?&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14259740" author="yuzhihong@gmail.com" created="Sun, 28 Dec 2014 22:45:43 +0000"  >&lt;p&gt;w.r.t. comment #1 above:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    awsConf.setMaxConnections(conf.getInt(MAXIMUM_CONNECTIONS, 
      DEFAULT_MAXIMUM_CONNECTIONS));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The default value is from current setting.&lt;br/&gt;
Do you think setting max connections as value for fs.s3a.threads.core makes sense ?&lt;/p&gt;

&lt;p&gt;w.r.t. last comment, having different values for core.threads and max.threads would get the full potential out of ThreadPoolExecutor.&lt;/p&gt;

&lt;p&gt;Next patch would address remaining comments.&lt;/p&gt;</comment>
                            <comment id="14259757" author="hadoopqa" created="Sun, 28 Dec 2014 23:32:17 +0000"  >&lt;p&gt;&lt;font color=&quot;red&quot;&gt;-1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12689269/hadoop-11446-002.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12689269/hadoop-11446-002.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1454efe.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 tests included&lt;/font&gt;.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javadoc&lt;/font&gt;.  There were no new javadoc warning messages.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 eclipse:eclipse&lt;/font&gt;.  The patch built with eclipse:eclipse.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 findbugs&lt;/font&gt;.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 release audit&lt;/font&gt;.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 core tests&lt;/font&gt;.  The patch passed unit tests in hadoop-tools/hadoop-aws.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/5351//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/5351//testReport/&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/5351//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/5351//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14261298" author="stevel@apache.org" created="Tue, 30 Dec 2014 17:49:49 +0000"  >&lt;p&gt;Ted, could you pull &quot;fs.s3a.max.total.tasks&quot; &amp;amp; its default value into the constants class.&lt;/p&gt;

&lt;p&gt;I think we&apos;ll need the doc updated with the config options too.&lt;/p&gt;

&lt;p&gt;test-wise, I can&apos;t see an easy way to test that this works, except by you repeating your experiment&lt;/p&gt;</comment>
                            <comment id="14261311" author="yuzhihong@gmail.com" created="Tue, 30 Dec 2014 18:04:14 +0000"  >&lt;p&gt;Patch v3 addresses Steve&apos;s comment.&lt;/p&gt;

&lt;p&gt;Once the set of new parameters has been agreed upon, I will update release note.&lt;/p&gt;</comment>
                            <comment id="14261344" author="hadoopqa" created="Tue, 30 Dec 2014 18:42:38 +0000"  >&lt;p&gt;&lt;font color=&quot;red&quot;&gt;-1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12689537/hadoop-11446-003.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12689537/hadoop-11446-003.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 6621c35.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 tests included&lt;/font&gt;.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javadoc&lt;/font&gt;.  There were no new javadoc warning messages.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 eclipse:eclipse&lt;/font&gt;.  The patch built with eclipse:eclipse.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 findbugs&lt;/font&gt;.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 release audit&lt;/font&gt;.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 core tests&lt;/font&gt;.  The patch passed unit tests in hadoop-tools/hadoop-aws.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/5352//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/5352//testReport/&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/5352//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/5352//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14263511" author="stevel@apache.org" created="Sat, 3 Jan 2015 11:58:02 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="14264572" author="hudson" created="Mon, 5 Jan 2015 13:12:34 +0000"  >&lt;p&gt;FAILURE: Integrated in Hadoop-trunk-Commit #6805 (See &lt;a href=&quot;https://builds.apache.org/job/Hadoop-trunk-Commit/6805/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Hadoop-trunk-Commit/6805/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-11446&quot; title=&quot;S3AOutputStream should use shared thread pool to avoid OutOfMemoryError&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-11446&quot;&gt;&lt;del&gt;HADOOP-11446&lt;/del&gt;&lt;/a&gt; S3AOutputStream should use shared thread pool to avoid OutOfMemoryError (stevel: rev 27d8395867f665fea1360087325cda5ed70efd0c)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/Constants.java&lt;/li&gt;
	&lt;li&gt;hadoop-common-project/hadoop-common/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AOutputStream.java&lt;/li&gt;
	&lt;li&gt;hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AFileSystem.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14264582" author="thodemoor" created="Mon, 5 Jan 2015 13:23:01 +0000"  >&lt;p&gt;Some remarks: &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;I guess that at the end of &quot;purging&quot; the TransferManager should not be shut down?&lt;/li&gt;
	&lt;li&gt;Which got me thinking: Should we override FileSystem.close() in S3AFileSystem to call TransferManager.shutDownNow(true)? This will shut down the thread pool and AmazonS3Client. Otherwise, these resources may still leak?&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Regarding my previous comments: I see no harm in giving users full control, although probably a linear relation between fs.s3a.max.connections and fs.s3a.threads.core (etc.) is suitable (at least that&apos;s what I derive from the aws-sdk source code, I haven&apos;t tested this yet). However, we should at least document their interplay as f.i. increasing threads while keeping connections fixed will likely not yield the (linear) performance improvement users might expect. &lt;/p&gt;
</comment>
                            <comment id="14264649" author="yuzhihong@gmail.com" created="Mon, 5 Jan 2015 15:04:02 +0000"  >&lt;p&gt;Thomas:&lt;br/&gt;
Addendum addresses your comment.&lt;/p&gt;</comment>
                            <comment id="14265694" author="yuzhihong@gmail.com" created="Tue, 6 Jan 2015 04:57:58 +0000"  >&lt;p&gt;Relying on FileSystem.close() to be called would not always work - ExportSnapshot from hbase doesn&apos;t call close().&lt;/p&gt;

&lt;p&gt;FYI&lt;/p&gt;</comment>
                            <comment id="14265945" author="stevel@apache.org" created="Tue, 6 Jan 2015 10:35:53 +0000"  >&lt;p&gt;is this addendum something you want to get in? If so, it&apos;s going to have to be another patch I&apos;m afraid&lt;/p&gt;</comment>
                            <comment id="14265975" author="hudson" created="Tue, 6 Jan 2015 11:33:55 +0000"  >&lt;p&gt;FAILURE: Integrated in Hadoop-Yarn-trunk #799 (See &lt;a href=&quot;https://builds.apache.org/job/Hadoop-Yarn-trunk/799/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Hadoop-Yarn-trunk/799/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-11446&quot; title=&quot;S3AOutputStream should use shared thread pool to avoid OutOfMemoryError&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-11446&quot;&gt;&lt;del&gt;HADOOP-11446&lt;/del&gt;&lt;/a&gt; S3AOutputStream should use shared thread pool to avoid OutOfMemoryError (stevel: rev 27d8395867f665fea1360087325cda5ed70efd0c)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AOutputStream.java&lt;/li&gt;
	&lt;li&gt;hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AFileSystem.java&lt;/li&gt;
	&lt;li&gt;hadoop-common-project/hadoop-common/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/Constants.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14265990" author="hudson" created="Tue, 6 Jan 2015 11:42:17 +0000"  >&lt;p&gt;FAILURE: Integrated in Hadoop-Yarn-trunk-Java8 #65 (See &lt;a href=&quot;https://builds.apache.org/job/Hadoop-Yarn-trunk-Java8/65/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Hadoop-Yarn-trunk-Java8/65/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-11446&quot; title=&quot;S3AOutputStream should use shared thread pool to avoid OutOfMemoryError&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-11446&quot;&gt;&lt;del&gt;HADOOP-11446&lt;/del&gt;&lt;/a&gt; S3AOutputStream should use shared thread pool to avoid OutOfMemoryError (stevel: rev 27d8395867f665fea1360087325cda5ed70efd0c)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/Constants.java&lt;/li&gt;
	&lt;li&gt;hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AOutputStream.java&lt;/li&gt;
	&lt;li&gt;hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AFileSystem.java&lt;/li&gt;
	&lt;li&gt;hadoop-common-project/hadoop-common/CHANGES.txt&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14266025" author="thodemoor" created="Tue, 6 Jan 2015 12:10:13 +0000"  >&lt;p&gt;@ &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tedyu&quot; class=&quot;user-hover&quot; rel=&quot;tedyu&quot;&gt;tedyu&lt;/a&gt;: &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;I fear we have overlooked this: copyFile and copyLocalFile still use a method-local TransferManager transfers object (instead of the class member object aka this.transfers). The addendum removes the shutDown() calls to the local transfermanager there but we should entirely abolish the local objects and only use this.transfers.&lt;/li&gt;
	&lt;li&gt;concerning close():  I guess calling close is left to the end user. However, I think we do not leak memory as long as fs.s3a.threads.keepalivetime &amp;gt; 0. Because you set tpe.allowCoreThreadTimeOut(true), the TransferManager will be garbage collected after it goes out of scope AND all (core) threads have timed out. Correct?&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;@&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stevel%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;stevel@apache.org&quot;&gt;stevel@apache.org&lt;/a&gt;: I fear we should. Without the addendum: if the purge code is hit, the next fs command will throw an error as the TransferManager has been shut down. Furthermore,  my first remark above hints at an addendum-002 &lt;/p&gt;</comment>
                            <comment id="14266141" author="hudson" created="Tue, 6 Jan 2015 14:20:45 +0000"  >&lt;p&gt;FAILURE: Integrated in Hadoop-Hdfs-trunk #1997 (See &lt;a href=&quot;https://builds.apache.org/job/Hadoop-Hdfs-trunk/1997/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Hadoop-Hdfs-trunk/1997/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-11446&quot; title=&quot;S3AOutputStream should use shared thread pool to avoid OutOfMemoryError&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-11446&quot;&gt;&lt;del&gt;HADOOP-11446&lt;/del&gt;&lt;/a&gt; S3AOutputStream should use shared thread pool to avoid OutOfMemoryError (stevel: rev 27d8395867f665fea1360087325cda5ed70efd0c)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AFileSystem.java&lt;/li&gt;
	&lt;li&gt;hadoop-common-project/hadoop-common/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/Constants.java&lt;/li&gt;
	&lt;li&gt;hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AOutputStream.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14266164" author="hudson" created="Tue, 6 Jan 2015 14:38:29 +0000"  >&lt;p&gt;SUCCESS: Integrated in Hadoop-Hdfs-trunk-Java8 #62 (See &lt;a href=&quot;https://builds.apache.org/job/Hadoop-Hdfs-trunk-Java8/62/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Hadoop-Hdfs-trunk-Java8/62/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-11446&quot; title=&quot;S3AOutputStream should use shared thread pool to avoid OutOfMemoryError&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-11446&quot;&gt;&lt;del&gt;HADOOP-11446&lt;/del&gt;&lt;/a&gt; S3AOutputStream should use shared thread pool to avoid OutOfMemoryError (stevel: rev 27d8395867f665fea1360087325cda5ed70efd0c)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hadoop-common-project/hadoop-common/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AFileSystem.java&lt;/li&gt;
	&lt;li&gt;hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AOutputStream.java&lt;/li&gt;
	&lt;li&gt;hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/Constants.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14266205" author="hudson" created="Tue, 6 Jan 2015 15:02:15 +0000"  >&lt;p&gt;FAILURE: Integrated in Hadoop-Mapreduce-trunk-Java8 #66 (See &lt;a href=&quot;https://builds.apache.org/job/Hadoop-Mapreduce-trunk-Java8/66/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Hadoop-Mapreduce-trunk-Java8/66/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-11446&quot; title=&quot;S3AOutputStream should use shared thread pool to avoid OutOfMemoryError&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-11446&quot;&gt;&lt;del&gt;HADOOP-11446&lt;/del&gt;&lt;/a&gt; S3AOutputStream should use shared thread pool to avoid OutOfMemoryError (stevel: rev 27d8395867f665fea1360087325cda5ed70efd0c)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AFileSystem.java&lt;/li&gt;
	&lt;li&gt;hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/Constants.java&lt;/li&gt;
	&lt;li&gt;hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AOutputStream.java&lt;/li&gt;
	&lt;li&gt;hadoop-common-project/hadoop-common/CHANGES.txt&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14266248" author="hudson" created="Tue, 6 Jan 2015 15:20:39 +0000"  >&lt;p&gt;FAILURE: Integrated in Hadoop-Mapreduce-trunk #2016 (See &lt;a href=&quot;https://builds.apache.org/job/Hadoop-Mapreduce-trunk/2016/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Hadoop-Mapreduce-trunk/2016/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-11446&quot; title=&quot;S3AOutputStream should use shared thread pool to avoid OutOfMemoryError&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-11446&quot;&gt;&lt;del&gt;HADOOP-11446&lt;/del&gt;&lt;/a&gt; S3AOutputStream should use shared thread pool to avoid OutOfMemoryError (stevel: rev 27d8395867f665fea1360087325cda5ed70efd0c)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/Constants.java&lt;/li&gt;
	&lt;li&gt;hadoop-common-project/hadoop-common/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AFileSystem.java&lt;/li&gt;
	&lt;li&gt;hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AOutputStream.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                                                <inwardlinks description="is depended upon by">
                                        <issuelink>
            <issuekey id="12773738">HADOOP-11571</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12689078" name="hadoop-11446-001.patch" size="7489" author="yuzhihong@gmail.com" created="Wed, 24 Dec 2014 22:49:57 +0000"/>
                            <attachment id="12689269" name="hadoop-11446-002.patch" size="9585" author="yuzhihong@gmail.com" created="Sun, 28 Dec 2014 22:58:06 +0000"/>
                            <attachment id="12689537" name="hadoop-11446-003.patch" size="9802" author="yuzhihong@gmail.com" created="Tue, 30 Dec 2014 18:04:14 +0000"/>
                            <attachment id="12690088" name="hadoop-11446.addendum" size="1656" author="yuzhihong@gmail.com" created="Mon, 5 Jan 2015 15:04:02 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 46 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i23qrb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310192" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Release Note</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>The following parameters are introduced in this JIRA:&lt;br/&gt;
fs.s3a.threads.max:    the maximum number of threads to allow in the pool used by TransferManager&lt;br/&gt;
fs.s3a.threads.core:    the number of threads to keep in the pool used by TransferManager&lt;br/&gt;
fs.s3a.threads.keepalivetime:  when the number of threads is greater than the core, this is the maximum time that excess idle threads will wait for new tasks before terminating&lt;br/&gt;
fs.s3a.max.total.tasks:    the maximum number of tasks that the LinkedBlockingQueue can hold</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12327583">2.7.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>