<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:45:25 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HADOOP-10919] Copy command should preserve raw.* namespace extended attributes</title>
                <link>https://issues.apache.org/jira/browse/HADOOP-10919</link>
                <project id="12310240" key="HADOOP">Hadoop Common</project>
                    <description>&lt;p&gt;Refer to the doc attached to &lt;a href=&quot;https://issues.apache.org/jira/browse/HDFS-6509&quot; title=&quot;Create a special /.reserved/raw directory for raw access to encrypted data&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HDFS-6509&quot;&gt;&lt;del&gt;HDFS-6509&lt;/del&gt;&lt;/a&gt; for background.&lt;/p&gt;

&lt;p&gt;Like distcp -p (see &lt;a href=&quot;https://issues.apache.org/jira/browse/MAPREDUCE-6007&quot; title=&quot;Add support to distcp to preserve raw.* namespace extended attributes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;MAPREDUCE-6007&quot;&gt;&lt;del&gt;MAPREDUCE-6007&lt;/del&gt;&lt;/a&gt;), the copy command also needs to preserve extended attributes in the raw.* namespace by default whenever the src and target are in /.reserved/raw. To not preserve raw xattrs, don&apos;t specify /.reserved/raw in either the src or target. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12731195">HADOOP-10919</key>
            <summary>Copy command should preserve raw.* namespace extended attributes</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="clamb">Charles Lamb</assignee>
                                    <reporter username="clamb">Charles Lamb</reporter>
                        <labels>
                    </labels>
                <created>Thu, 31 Jul 2014 22:22:38 +0000</created>
                <updated>Thu, 12 May 2016 18:24:35 +0000</updated>
                            <resolved>Fri, 8 Aug 2014 17:59:12 +0000</resolved>
                                    <version>3.0.0-alpha1</version>
                                    <fixVersion>fs-encryption (HADOOP-10150 and HDFS-6134)</fixVersion>
                                    <component>fs</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14088294" author="clamb" created="Wed, 6 Aug 2014 21:29:28 +0000"  >&lt;p&gt;Here&apos;s a patch to implement the -pd option for cp, similar to distcp -pd.&lt;/p&gt;</comment>
                            <comment id="14089858" author="clamb" created="Thu, 7 Aug 2014 21:10:13 +0000"  >&lt;p&gt;This patch more closely matches the proposed behavior of distcp wrt raw xattrs:&lt;/p&gt;

&lt;p&gt;. There is no -pd option.&lt;br/&gt;
. Determination of whether or not to preserve raw.* xattrs is based only on whether all of the source and target pathnames are in the /.reserved/raw hierarchy.&lt;br/&gt;
. If any of the sources or target paths are different wrt polarity of /.r/r then an exception is thrown.&lt;/p&gt;</comment>
                            <comment id="14090104" author="andrew.wang" created="Fri, 8 Aug 2014 00:41:57 +0000"  >&lt;p&gt;This looks basically right, just a few review comments:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Would be nice to quote paths in exception messages for clarity&lt;/li&gt;
	&lt;li&gt;Could mention that checkPathsForReservedRaw expects fully-qualified paths (i.e. not relative)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Test:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;testCopyCommandsWithRawXAttrs, setting the xattrs looks like it could be turned into two loops. We also copy pasted the same xattr names and values in checkXAttrs, seems like we could dedupe this. There&apos;s also a double semi-colon.&lt;/li&gt;
	&lt;li&gt;Not a huge fan of the per-parameter in-line comments, not something I&apos;ve seen in Hadoop before. IDEs help you figure this out without a comment.&lt;/li&gt;
	&lt;li&gt;checkXAttrs, would be better to do assertEquals than assertTrue for the size. Should have error messages in all the asserts too.&lt;/li&gt;
	&lt;li&gt;I would feel a bit better if we tested a relative destination with a &quot;..&quot; as well, though I&apos;m fairly sure that it works.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Thanks Charles!&lt;/p&gt;</comment>
                            <comment id="14090249" author="clamb" created="Fri, 8 Aug 2014 03:16:56 +0000"  >&lt;p&gt;Thanks for the review &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=andrew.wang&quot; class=&quot;user-hover&quot; rel=&quot;andrew.wang&quot;&gt;andrew.wang&lt;/a&gt;. I believe the .002 patch addresses your comments above.&lt;/p&gt;</comment>
                            <comment id="14091013" author="andrew.wang" created="Fri, 8 Aug 2014 17:44:22 +0000"  >&lt;p&gt;+1 LGTM thanks charles&lt;/p&gt;</comment>
                            <comment id="14091049" author="clamb" created="Fri, 8 Aug 2014 17:59:12 +0000"  >&lt;p&gt;Thanks for the review &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=andrew.wang&quot; class=&quot;user-hover&quot; rel=&quot;andrew.wang&quot;&gt;andrew.wang&lt;/a&gt;. I&apos;ve committed this to the fs-encryption branch.&lt;/p&gt;</comment>
                            <comment id="14093548" author="sanjay.radia" created="Tue, 12 Aug 2014 00:26:29 +0000"  >&lt;p&gt;Charles, you list  disadvantage for the .raw scheme where the target of a distcp is not an encrypted zone. Would it make sense for distcp to check for that and to fail the distcp? &lt;/p&gt;</comment>
                            <comment id="14093550" author="sanjay.radia" created="Tue, 12 Aug 2014 00:27:55 +0000"  >&lt;p&gt;Charles, the work you did for distcp needs to be also applied to har. I suspect .raw would also work.&lt;/p&gt;</comment>
                            <comment id="14093557" author="clamb" created="Tue, 12 Aug 2014 00:31:23 +0000"  >&lt;blockquote&gt;&lt;p&gt;Charles, you list disadvantage for the .raw scheme where the target of a distcp is not an encrypted zone. Would it make sense for distcp to check for that and to fail the distcp?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Hi Sanjay,&lt;/p&gt;

&lt;p&gt;Presently distcp requires both src and target to be either both in /.reserved/raw or neither in /.reserved/raw.&lt;/p&gt;

&lt;p&gt;I&apos;ll update the &lt;a href=&quot;https://issues.apache.org/jira/browse/HDFS-6509&quot; title=&quot;Create a special /.reserved/raw directory for raw access to encrypted data&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HDFS-6509&quot;&gt;&lt;del&gt;HDFS-6509&lt;/del&gt;&lt;/a&gt; document and comments.&lt;/p&gt;

&lt;p&gt;Thanks for catching that.&lt;/p&gt;</comment>
                            <comment id="14093565" author="clamb" created="Tue, 12 Aug 2014 00:38:20 +0000"  >&lt;p&gt;Sanjay,&lt;/p&gt;

&lt;p&gt;I just re-read your comment and I realized that I mis-spoke.&lt;/p&gt;

&lt;p&gt;Yes, I think it would make sense. I&apos;ll open a jira for that.&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="14093594" author="sanjay.radia" created="Tue, 12 Aug 2014 01:07:23 +0000"  >&lt;p&gt;charles, what is the usage model for distcp of encrypted files:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;distcp path1 path2   - where distcp will insert /.reserved/.raw to the pathnames if in encrypted zone.&lt;/li&gt;
	&lt;li&gt;OR distcp /.reserved/.raw/path1  /.reserved/.raw/path2&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;BTW is the proposal is that both src and dest MUST be encryptedZones or neither ? (Because of your &quot;misspoke&quot; comment I am a little confused.)&lt;/p&gt;</comment>
                            <comment id="14093611" author="clamb" created="Tue, 12 Aug 2014 01:25:39 +0000"  >&lt;p&gt;Sanjay,&lt;/p&gt;

&lt;p&gt;There are three scenarios. &lt;/p&gt;

&lt;p&gt;(1) An administrator who does not have access to the keys in the KMS would use the /.reserved/raw prefix on src and dest:&lt;/p&gt;

&lt;p&gt;distcp /.reserved/raw/src /.reserved/raw/dest&lt;/p&gt;

&lt;p&gt;The /.reserved/raw is the only interface that exposes the raw.* xattrs holding the encryption metadata. This allows the raw.* xattrs to be preserved on the dest as well as to copy the files without decrypting them. This scenario assumes that an ez has been set up on dest. As you suggested, it would be a good idea to check that the dest is actually an ez.&lt;/p&gt;

&lt;p&gt;(2) A non-admin user who has access to some subset of files in an ez could use the non-/.reserved/raw prefix and copy a hierarchy from one ez to another. In that case, the raw.* xattrs from the src ez would not be preserved. This scenario assumes that the dest ez is already set up. Of course the dest files will have new keys associated with them since they&apos;ll be new copies. &lt;/p&gt;

&lt;p&gt;(3) Neither src or dst has /.reserved/raw and one or the other of src/dest is not an ez. It is not necessary to have the target also be an ez. The use case would be that the user wants to copy a subset of the ez into/out-of a non-encrypted file system. distcp without the /.reserved/raw prefix could be used for this.&lt;/p&gt;

&lt;p&gt;Does this all make sense?&lt;/p&gt;

</comment>
                            <comment id="14093620" author="clamb" created="Tue, 12 Aug 2014 01:33:06 +0000"  >&lt;p&gt;I should clarify case (1). If you are distcp&apos;ing from the ez root or higher, then you don&apos;t need to pre-create the EZ because all of the raw.* xattrs will be preserved.&lt;/p&gt;

&lt;p&gt;Given that, I&apos;m wondering what would the purpose be for checking that the target is an EZ? &lt;/p&gt;</comment>
                            <comment id="14094447" author="sanjay.radia" created="Tue, 12 Aug 2014 18:26:26 +0000"  >&lt;blockquote&gt;&lt;p&gt;Given that, I&apos;m wondering what would the purpose be for checking that the target is an EZ? &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;You mentioned that in your doc and hence I raised it here.&lt;/p&gt;

&lt;p&gt;Given that your document mentioned that the target and src must match wrt to EZ I thought that you had made distcp  transparent: ie distcp will check if  any dir in the subtree is EZ and will prefix by /.reserved/.raw. And I think that is a good idea since it will mean that all existing distcp scripts will continue to work if you set the EZ on the src and target correctly.&lt;/p&gt;</comment>
                            <comment id="14094500" author="andrew.wang" created="Tue, 12 Aug 2014 18:53:46 +0000"  >&lt;p&gt;Hi Sanjay,&lt;/p&gt;

&lt;p&gt;Could we define the requirements for &quot;transparent&quot;? Right now it&apos;s transparent in that distcp will decrypt when it reads from the normal path. This is what all existing distcp scripts will be doing, copying to and from normal paths. It&apos;s less efficient since it involves decryption, and results in different bytes-on-disk on the destination (either because it&apos;s unencrypted, or it&apos;s given a different EDEK), but it&apos;s a reasonable and sometimes desirable behavior. Using the /.reserved/raw paths is a way of doing a direct byte-to-byte identical copy, which is also a sometimes desirable behavior.&lt;/p&gt;

&lt;p&gt;It sounds like you want the direct byte-to-byte copy to be the default, but remember that it&apos;s an API with sharp edges, many of which are laid out in the doc. /.r/r is also superuser only, since it lets you muck directly with the raw xattrs. This means we can&apos;t transparently add the /.r/r prefix if the distcp runs as a normal user. Because of all this, we decided to implement the current, safer behavior.&lt;/p&gt;

&lt;p&gt;Does this sound reasonable?&lt;/p&gt;</comment>
                            <comment id="14094640" author="sanjay.radia" created="Tue, 12 Aug 2014 20:48:07 +0000"  >&lt;blockquote&gt;&lt;p&gt;Right now it&apos;s transparent in that distcp will decrypt when it reads from the normal path. This is what all existing distcp scripts will be doing, copying to and from normal paths. ... but it&apos;s a reasonable and sometimes desirable behavior.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;At the meeting and in the jira we  concluded that the above behavior is not desirable: the user running the distcp may not have permission to decrypt (e.g. an Admin at NSA). Second, the data is being transmitted in the clear. Third the efficiency argument. You are saying &quot;but it&apos;s a reasonable and sometimes desirable behavior.&quot; - I thought we have established it is not and hence we are doing the /.r/.r and that distcp will take advantage of it. I hope you still want to do /.r/.r? Maybe you are asserting that /.r/.r was unnecessary but you are willing to do it to please a few in the community. That okay - we can agree to disagree here.&lt;/p&gt;

&lt;p&gt;I would have thought that if distcp prefixes all paths by /.r/.r then it would just work. Your comments says that &quot;/.r/r is also superuser only&quot; &amp;#8211; not sure what you mean - only superuer can access /.r/.r? Surely that is not the case? Is this mentioned in the distcp doc and I missed it?&lt;/p&gt;</comment>
                            <comment id="14094661" author="clamb" created="Tue, 12 Aug 2014 20:56:13 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sanjay.radia&quot; class=&quot;user-hover&quot; rel=&quot;sanjay.radia&quot;&gt;sanjay.radia&lt;/a&gt;,&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Is this mentioned in the distcp doc and I missed it?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, third para of the second page:  &quot;Only HDFS admins have access to the raw hierarchy as this will prevent regular users from trashing files in an EZ.&quot;&lt;/p&gt;</comment>
                            <comment id="14095122" author="sanjay.radia" created="Wed, 13 Aug 2014 04:19:14 +0000"  >&lt;p&gt;Charles can you expand on what trashing you are worried about? One only needs read access on the src side.&lt;/p&gt;</comment>
                            <comment id="14095149" author="sanjay.radia" created="Wed, 13 Aug 2014 04:56:42 +0000"  >&lt;p&gt;Charles lets enumerate the distcp use cases - Here is my first draft. Below for some of the use cases I propose possible desirable outcomes but these outcomes can be debated separately from the use cases,&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;src subtree and dst subtree do not have EZ - easy, same as today&lt;/li&gt;
	&lt;li&gt;src subtree has no EZ but dest does have EZ in a portion of its subtree. Possible outcomes
	&lt;ol&gt;
		&lt;li&gt;- if user performing operation has permissions in dest EZ then the files within the dest EZ subtree are encrypted&lt;/li&gt;
		&lt;li&gt;if user does not (say Admin) what do we expect to happen?&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
	&lt;li&gt;src subtree has EZ but dest does not. Possible outcomes
	&lt;ol&gt;
		&lt;li&gt;files copied as encrypted but cannot be decryptied at the dest since it does not have an  EZ zone- useful as a backup&lt;/li&gt;
		&lt;li&gt;files copied as encrypted and a matching EZ is created automatically. Can an admin do this operation since he does not have access to the keys?&lt;/li&gt;
		&lt;li&gt;throw an error which can be overidden by a flag in which case the files are decryoted and copied to in dest are left  decrypted . This only works if the user has permissions for decryption; admin cannot do this.&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
	&lt;li&gt;both src and dest have  EZ at exactly the same part of the subtree. Possible outcomes
	&lt;ol&gt;
		&lt;li&gt;If user has permission to decrypt and encrypt, then the data is copied and encryption is redone with new keys,&lt;/li&gt;
		&lt;li&gt;If user does not have permission then ?? Fail or copy as raw?&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
	&lt;li&gt;both src and dest have  EZ at different  parts of the subtree. This should reduce to 2 or 3.&lt;/li&gt;
&lt;/ol&gt;



&lt;p&gt;For each of the above one can have distcp do the right thing automatically  or we can force the user to explicitly  submit /r/r/path as appropriate, Lets explore both approaches and see which one works better.&lt;/p&gt;
</comment>
                            <comment id="14095158" author="clamb" created="Wed, 13 Aug 2014 05:11:08 +0000"  >&lt;p&gt;Hi Sanjay,&lt;/p&gt;

&lt;p&gt;The trashing would be due to non-admin users having access to the raw.* xattrs via /.r/r. If they were able to corrupt the xattrs, then that would effectively trash the file. It&apos;s assumed that an hdfs admin would not (intentionally) do that.&lt;/p&gt;</comment>
                            <comment id="14095744" author="sanjay.radia" created="Wed, 13 Aug 2014 17:21:46 +0000"  >&lt;blockquote&gt;&lt;p&gt;trashing ....  It&apos;s assumed that an hdfs admin would not (intentionally) do that.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Okay, please add that your doc when you next update it. We could allow just read access to /r/r/ to all.&lt;/p&gt;

&lt;p&gt;Use cases: charles can we please work together to get the distcp use cases  nailed. We can work offline to go faster and then summarize for the community.&lt;/p&gt;</comment>
                            <comment id="14096037" author="clamb" created="Wed, 13 Aug 2014 20:11:11 +0000"  >&lt;p&gt;I&apos;ll update the &lt;a href=&quot;https://issues.apache.org/jira/browse/HDFS-6509&quot; title=&quot;Create a special /.reserved/raw directory for raw access to encrypted data&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HDFS-6509&quot;&gt;&lt;del&gt;HDFS-6509&lt;/del&gt;&lt;/a&gt; doc to reflect the bit about trashing.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt; 1.    src subtree and dst subtree do not have EZ - easy, same as today&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Agreed.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;2.    src subtree has no EZ but dest does have EZ in a portion of its subtree. Possible outcomes&lt;br/&gt;
      1. if user performing operation has permissions in dest EZ then the files within the dest EZ subtree are encrypted&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Agreed.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;2.    src subtree has no EZ but dest does have EZ in a portion of its subtree. Possible outcomes&lt;br/&gt;
...&lt;br/&gt;
      2. if user does not (say Admin) what do we expect to happen?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The behavior should be the same as what happens today: user (the admin) gets a permission violation because the admin does not have access to the target.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;3.    src subtree has EZ but dest does not. Possible outcomes&lt;br/&gt;
      1. files copied as encrypted but cannot be decryptied at the dest since it does not have an EZ zone- useful as a backup&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;/.r/r: raw files are copied to dest so dest contains encrypted (and unreadable) files&lt;br/&gt;
!/.r/r: files are decrypted by distcp and copied to dst (decrypted). Files are readable because they have been decrypted during the copy.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;3.    src subtree has EZ but dest does not. Possible outcomes&lt;br/&gt;
...&lt;br/&gt;
      2. files copied as encrypted and a matching EZ is created automatically. Can an admin do this operation since he does not have access to the keys?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I don&apos;t think that distcp can, or should, create a matching EZ automatically. It is too hard for it to know what the intent of the copy is. Should the new ez have the same ez-key as the src ez or a different one? Sure, we could have an option to let the user specify that, but for the first crack I wanted to keep it fairly simple. So, the theory is that the admin creates the empty EZ before performing the distcp. The admin can either set up the EZ with the same ez-key as the src ez (call this &quot;(a)&quot; below, or the dest can have a different ez-key than the src (call this &quot;(b)&quot; below. After the ez is created, then distcp will try to maintain the files as encrypted. In either of those scenarios, there are a couple of cases:&lt;/p&gt;

&lt;p&gt;distcp with /.r/r: (a) works ok because the EDEKs for each file are copied from src to dst. (b) does not work because when the files are opened in the dest hierarchy, the EDEKs will be decrypted with the new ez-key(dst) and that won&apos;t work. This could be made to work by having the KMS decrypt the EDEKs and re-encrypt them with the new ez-key(dst), but it would assume that the distcp invoker had proper credentials with the KMS for the keys. So in general this scenario is only useful when the src-ez and the dst-ez have been setup with the same ez-key. There are other issues with this that are discussed under &lt;a href=&quot;https://issues.apache.org/jira/browse/HDFS-6134&quot; title=&quot;Transparent data at rest encryption&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HDFS-6134&quot;&gt;&lt;del&gt;HDFS-6134&lt;/del&gt;&lt;/a&gt;, such as different key lengths, etc.&lt;/p&gt;

&lt;p&gt;distcp with no /.r/r: Both of (a) and (b) work ok as long as the invoker has access to the files that are being copied. distcp decrypts the files on read and they get re-encrypted on write. This is pretty much the same as today.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;3.    src subtree has EZ but dest does not. Possible outcomes&lt;br/&gt;
...&lt;br/&gt;
      3. throw an error which can be overidden by a flag in which case the files are decryoted and copied to in dest are left decrypted . This only works if the user has permissions for decryption; admin cannot do this.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;/.r/r: The files aren&apos;t decrypted so this scenario is perfectly acceptable.&lt;/p&gt;

&lt;p&gt;!/.r/r: As you say, the admin can&apos;t do this because they presumably don&apos;t have access to the files on the src (and probably not on the target either). So this scenario is about some random user doing a distcp of some subset of the tree on their own. I think that what you&apos;re suggesting is a way of trying to keep the user from shooting themselves in the foot by ensuring that they don&apos;t leave unencrypted data hanging around in the dest. I can see this both ways. On the one hand, someone has given the user access to the files and keys. They are expected to &quot;do the right thing&quot; with the decrypted file contents, including not putting it somewhere &quot;unsafe&quot;. It is &quot;transparent encryption&quot; after all. And they might actually want to leave it hanging around in unencrypted form because (e.g.) maybe dst is on a cluster inside a SCIF and it&apos;s ok to leave the files unencrypted.&lt;/p&gt;

&lt;p&gt;But I think I like your suggestion that we throw an exception in this case (user not using /.r/r, any of the source paths are in an ez, dest is not in an ez) unless a flag is set.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;4.    both src and dest have EZ at exactly the same part of the subtree. Possible outcomes&lt;br/&gt;
      1. If user has permission to decrypt and encrypt, then the data is copied and encryption is redone with new keys,&lt;br/&gt;
      2. If user does not have permission then ?? Fail or copy as raw?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think we should just treat this the same as current behavior. We just attempt it and if it works great, and if not, we throw the exception. So I don&apos;t think there&apos;s anything unusual here.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;5.    both src and dest have EZ at different parts of the subtree. This should reduce to 2 or 3.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Agreed.&lt;/p&gt;</comment>
                            <comment id="14096353" author="sanjay.radia" created="Thu, 14 Aug 2014 00:36:47 +0000"  >&lt;p&gt;Q. when you say &quot;distcp  /r/r/src  /r/r/dest&quot; are the  keys  read from src and preserved in the dest? Does the act of copying the keys  from a  /r/r/src into a /r/r/dest  automatically set up a matching EZ  in the destination?&lt;/p&gt;</comment>
                            <comment id="14096358" author="clamb" created="Thu, 14 Aug 2014 00:45:01 +0000"  >&lt;blockquote&gt;&lt;p&gt;Q. when you say &quot;distcp /r/r/src /r/r/dest&quot; are the keys read from src and preserved in the dest? Does the act of copying the keys from a /r/r/src into a /r/r/dest automatically set up a matching EZ in the destination?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes to the first question and no to the second. Copying the keys occurs and that is almost good enough to set up a matching EZ. However, what doesn&apos;t happen is a call to createEncryptionZone  so there is not an actual EZ in place on the dst. The admin is expected to have done that before the distcp. If the admin wants a parallel EZ (i.e. with the same keys, ez-key, etc.) &amp;#8211; and presumably they do because they&apos;re copying from /.r/r to /.r/r and preserving the keys along the way (this is my case &quot;(a)&quot; above) &amp;#8211; then it is also expected that if the dest NN is not the same as the src (likely) that the NN and the clients accessing that NN will have equal access to the KMS (presumably the same KMS is shared across src and dst).&lt;/p&gt;

&lt;p&gt;Does this make sense?&lt;/p&gt;</comment>
                            <comment id="14096420" author="andrew.wang" created="Thu, 14 Aug 2014 01:45:56 +0000"  >&lt;p&gt;Note that if you copy from at or above the EZ root, it&apos;ll preserve the EZ root&apos;s raw xattrs and thus create the EZ. We have a special hook in FSDirectory#unprotectedSetXAttrs that watches for the special EZ xattr being set. If you&apos;re copying from below the EZ root, then only that subtree is preserved. We don&apos;t automatically create an EZ above the distcp dst (which would be kind of weird behavior).&lt;/p&gt;</comment>
                            <comment id="14096607" author="sanjay.radia" created="Thu, 14 Aug 2014 05:52:53 +0000"  >&lt;p&gt;I have attached a table that shows the distcp/cp use cases and the desirable outcomes. I think this implementable in a transparent fashion within distcp or cp using /r/r mechanism.&lt;/p&gt;</comment>
                            <comment id="14097748" author="sanjay.radia" created="Thu, 14 Aug 2014 21:54:14 +0000"  >&lt;p&gt;I misunderstood the EZKey. Matching does not matter for distcp/cp. I have updated the use cases table.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12720339">HDFS-6509</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12733321">HDFS-6839</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12702810">HDFS-6134</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12729752">MAPREDUCE-6007</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12660465" name="HADOOP-10919.001.patch" size="15368" author="clamb" created="Thu, 7 Aug 2014 21:10:13 +0000"/>
                            <attachment id="12660541" name="HADOOP-10919.002.patch" size="19012" author="clamb" created="Fri, 8 Aug 2014 03:16:56 +0000"/>
                            <attachment id="12661657" name="HDFS-6134-Distcp-cp-UseCasesTable.pdf" size="50964" author="sanjay.radia" created="Thu, 14 Aug 2014 05:52:53 +0000"/>
                            <attachment id="12661899" name="HDFS-6134-Distcp-cp-UseCasesTable2.pdf" size="52958" author="sanjay.radia" created="Thu, 14 Aug 2014 21:54:14 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>409267</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 14 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1yf2f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>409263</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12326860">fs-encryption (HADOOP-10150 and HDFS-6134)</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>