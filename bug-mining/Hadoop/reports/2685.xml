<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:56:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HADOOP-17308] WASB : PageBlobOutputStream succeeding hflush even when underlying flush to storage failed </title>
                <link>https://issues.apache.org/jira/browse/HADOOP-17308</link>
                <project id="12310240" key="HADOOP">Hadoop Common</project>
                    <description>&lt;p&gt;In PageBlobOutputStream, write()  APIs will fill the buffer and hflush/hsync/flush call will flush the buffer to underlying storage. Here the Azure calls are handled in another thread &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; void flushIOBuffers()  {
    ...
    lastQueuedTask = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; WriteRequest(outBuffer.toByteArray());
    ioThreadPool.execute(lastQueuedTask);
  ....
 }
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;WriteRequest &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Runnable&lt;/span&gt; {
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] dataPayload;
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; CountDownLatch doneSignal = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CountDownLatch(1);

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; WriteRequest(&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] dataPayload) {
      &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.dataPayload = dataPayload;
    }

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void waitTillDone() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; InterruptedException {
      doneSignal.await();
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void run() {
      &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;before runInternal()&quot;&lt;/span&gt;);
        runInternal();
        LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;after runInternal()&quot;&lt;/span&gt;);
      } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
        doneSignal.countDown();
      }
    }

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void runInternal() {
      ......
      writePayloadToServer(rawPayload);
      ...........
    }

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void writePayloadToServer(&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] rawPayload) {
      ......
      &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        blob.uploadPages(wrapperStream, currentBlobOffset, rawPayload.length,
            withMD5Checking(), PageBlobOutputStream.&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.opContext);
      } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException ex) {
        lastError = ex;
      } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (StorageException ex) {
        lastError = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IOException(ex);
      }
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (lastError != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
        LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Caught error in PageBlobOutputStream#writePayloadToServer()&quot;&lt;/span&gt;);
      }
    }
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The flushing thread will wait for the other thread to complete the Runnable WriteRequest. Thats fine. But when some exception happened while blob.uploadPages, we just set that to lastError state variable.  This variable is been checked for all subsequent ops like write, flush etc.  But what about the current flush call? that is silently being succeeded.!!  &lt;br/&gt;
In standard Azure backed HBase clusters WAL is on page blob. This issue causes a serious issue in HBase and causes data loss! HBase think a WAL write was hflushed and make row write successful. In fact the row was never gone to storage.&lt;/p&gt;

&lt;p&gt;Checking the lastError variable at the end of flush op will solve the issue. Then we will throw IOE from this flush() itself.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13335750">HADOOP-17308</key>
            <summary>WASB : PageBlobOutputStream succeeding hflush even when underlying flush to storage failed </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="anoop.hbase">Anoop Sam John</assignee>
                                    <reporter username="anoop.hbase">Anoop Sam John</reporter>
                        <labels>
                            <label>HBASE</label>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 16 Oct 2020 10:33:54 +0000</created>
                <updated>Mon, 26 Oct 2020 13:33:38 +0000</updated>
                            <resolved>Mon, 26 Oct 2020 13:32:32 +0000</resolved>
                                    <version>2.7.0</version>
                                    <fixVersion>3.3.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="7800">2h 10m</timespent>
                                        <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 4 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0jr80:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>