<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:33:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HADOOP-6834] TFile.append compares initial key against null lastKey  </title>
                <link>https://issues.apache.org/jira/browse/HADOOP-6834</link>
                <project id="12310240" key="HADOOP">Hadoop Common</project>
                    <description>&lt;p&gt;The following code in TFile.KeyReigster.close: &lt;/p&gt;


&lt;p&gt;            byte[] lastKey = lastKeyBufferOS.getBuffer();&lt;br/&gt;
            int lastLen = lastKeyBufferOS.size();&lt;br/&gt;
            if (tfileMeta.getComparator().compare(key, 0, len, lastKey, 0,&lt;br/&gt;
                lastLen) &amp;lt; 0) &lt;/p&gt;
{
              throw new IOException(&quot;Keys are not added in sorted order&quot;);
            }

&lt;p&gt;compares the initial  key (passed in via  TFile.Writer.append) against a technically NULL lastKey. lastKey is not initialized until after the first call to TFile.Writer.append. The underlying RawComparator interface used for comparisons does not stipulate the proper behavior when either length 1  or length 2 is zero. In the case of LongWritable, its WritableComparator implementation does an unsafe read on the passed in byte arrays b1 and b2. Since TFile pre-allocates the buffer used for storing lastKey, this passes a valid buffer with zero count to LongWritable&apos;s comparator, which ignores length and thus produces incorrect results. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12467542">HADOOP-6834</key>
            <summary>TFile.append compares initial key against null lastKey  </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hong.tang">Hong Tang</assignee>
                                    <reporter username="ahadr">Ahad Rana</reporter>
                        <labels>
                    </labels>
                <created>Tue, 22 Jun 2010 07:23:01 +0000</created>
                <updated>Mon, 12 Dec 2011 06:18:36 +0000</updated>
                            <resolved>Fri, 16 Jul 2010 18:38:47 +0000</resolved>
                                    <version>0.20.1</version>
                    <version>0.20.2</version>
                                    <fixVersion>0.22.0</fixVersion>
                                    <component>io</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="12881352" author="hong.tang" created="Tue, 22 Jun 2010 20:48:23 +0000"  >&lt;p&gt;In the first append, lastLen is 0, lastKey refers to a valid byte array whose bytes are all zero. So the behavior is determined. However, I do agree that it is possible for a customary comparator, an zero-length byte array may not be a legal key type. So it would be nice to do a first-key check.&lt;/p&gt;

&lt;p&gt;Ahad, would you be interested in providing a patch, or perhaps share with us a sample program with customized comparator that fails TFile.Writer.append?&lt;/p&gt;</comment>
                            <comment id="12881362" author="ahadr" created="Tue, 22 Jun 2010 21:10:42 +0000"  >&lt;p&gt;Hi Hong,&lt;/p&gt;

&lt;p&gt;Yes I would be happy to provide a patch. As far as triggering the failure, if you append a LongWritable with a negative value as the first key value and use the LongWritable&apos;s default Comparator, this will trigger the bug. I would be happy to provide a code snippet if required. In the case of LongWritable&apos;s comparator, it interprets the uninitialized zero bytes of the lastKey as a zero (since it does not check length), and thus this causes the out-of-order insertion exception. Either LongWritable&apos;s comparator is implemented improperly, or the contract implied by RawComparator is not clear on what happens in the case where you compare a non-zero byte array to a zero byte array. Probably both LongWritable&apos;s RawComparator should be fixed, but either way, passing in a uninitialized lastKey is going to cause problems for someone else down the road, so probably best to fix this as well ?     &lt;/p&gt;

</comment>
                            <comment id="12881366" author="hong.tang" created="Tue, 22 Jun 2010 21:26:15 +0000"  >&lt;p&gt;Yes, I guess LongWritable could be more defensive by throwing an exception indicating illegal format. Either way, TFile needs to be fixed.&lt;/p&gt;

&lt;p&gt;I&apos;d be happy to shepherd you with the patch process.&lt;/p&gt;</comment>
                            <comment id="12881372" author="ahadr" created="Tue, 22 Jun 2010 21:40:32 +0000"  >&lt;p&gt;Hi Hong,&lt;/p&gt;

&lt;p&gt;Sure, that would be great. What are the requirements these days ? Which version of hadoop should the patch target ? &lt;/p&gt;

&lt;p&gt;Ahad.&lt;/p&gt;</comment>
                            <comment id="12881404" author="hong.tang" created="Tue, 22 Jun 2010 22:17:42 +0000"  >&lt;p&gt;You should always submit the patch for trunk. If you are using older releases, you may also backport the patch (attach here) and request it to be committed to older branches too.&lt;/p&gt;</comment>
                            <comment id="12888934" author="hong.tang" created="Thu, 15 Jul 2010 21:36:31 +0000"  >&lt;p&gt;Straightforward patch with a new unit test.&lt;/p&gt;</comment>
                            <comment id="12888939" author="hadoopqa" created="Thu, 15 Jul 2010 21:59:00 +0000"  >&lt;p&gt;-1 overall.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12449597/hadoop-6834-20100715.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12449597/hadoop-6834-20100715.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 964134.&lt;/p&gt;

&lt;p&gt;    +1 @author.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    +1 tests included.  The patch appears to include 2 new or modified tests.&lt;/p&gt;

&lt;p&gt;    -1 javadoc.  The javadoc tool appears to have generated 1 warning messages.&lt;/p&gt;

&lt;p&gt;    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    +1 findbugs.  The patch does not introduce any new Findbugs warnings.&lt;/p&gt;

&lt;p&gt;    +1 release audit.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    +1 core tests.  The patch passed core unit tests.&lt;/p&gt;

&lt;p&gt;    +1 contrib tests.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Hadoop-Patch-h4.grid.sp2.yahoo.net/617/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://hudson.zones.apache.org/hudson/job/Hadoop-Patch-h4.grid.sp2.yahoo.net/617/testReport/&lt;/a&gt;&lt;br/&gt;
Findbugs warnings: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Hadoop-Patch-h4.grid.sp2.yahoo.net/617/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://hudson.zones.apache.org/hudson/job/Hadoop-Patch-h4.grid.sp2.yahoo.net/617/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html&lt;/a&gt;&lt;br/&gt;
Checkstyle results: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Hadoop-Patch-h4.grid.sp2.yahoo.net/617/artifact/trunk/build/test/checkstyle-errors.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://hudson.zones.apache.org/hudson/job/Hadoop-Patch-h4.grid.sp2.yahoo.net/617/artifact/trunk/build/test/checkstyle-errors.html&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Hadoop-Patch-h4.grid.sp2.yahoo.net/617/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://hudson.zones.apache.org/hudson/job/Hadoop-Patch-h4.grid.sp2.yahoo.net/617/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="12888949" author="ahadr" created="Thu, 15 Jul 2010 23:20:37 +0000"  >&lt;p&gt;I apologize Hong,  this was on my todo list, but obviously I did not get to it in time. Your patch and test case look good. One question: Is a NULL key allowed in the TFile API ? It seems that KeyRegister&apos;s close does accepts a zero length key.&lt;/p&gt;

&lt;p&gt;Ahad&lt;/p&gt;</comment>
                            <comment id="12888963" author="hong.tang" created="Fri, 16 Jul 2010 00:07:07 +0000"  >&lt;p&gt;The javadoc warning reported by test-patch seems to be false positive. (Log: &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Hadoop-Patch-h4.grid.sp2.yahoo.net/617/artifact/trunk/patchprocess/patchJavadocWarnings.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://hudson.zones.apache.org/hudson/job/Hadoop-Patch-h4.grid.sp2.yahoo.net/617/artifact/trunk/patchprocess/patchJavadocWarnings.txt&lt;/a&gt;).&lt;/p&gt;</comment>
                            <comment id="12888964" author="hong.tang" created="Fri, 16 Jul 2010 00:08:32 +0000"  >&lt;p&gt;@ahad, by &quot;NULL&quot; key, are you referring to zero-length key? It is certainly allowed by TFile (and you can even have multiple of them). &lt;/p&gt;</comment>
                            <comment id="12889261" author="mahadev" created="Fri, 16 Jul 2010 18:30:46 +0000"  >&lt;p&gt;+1 the patch looks good.&lt;/p&gt;</comment>
                            <comment id="12889268" author="hudson" created="Fri, 16 Jul 2010 18:54:51 +0000"  >&lt;p&gt;Integrated in Hadoop-Common-trunk-Commit #327 (See &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Hadoop-Common-trunk-Commit/327/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://hudson.zones.apache.org/hudson/job/Hadoop-Common-trunk-Commit/327/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-6834&quot; title=&quot;TFile.append compares initial key against null lastKey  &quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-6834&quot;&gt;&lt;del&gt;HADOOP-6834&lt;/del&gt;&lt;/a&gt;. TFile.append compares initial key against null lastKey (hong tang via mahadev)&lt;/p&gt;</comment>
                            <comment id="12889494" author="hudson" created="Sat, 17 Jul 2010 11:12:55 +0000"  >&lt;p&gt;Integrated in Hadoop-Common-trunk #395 (See &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Hadoop-Common-trunk/395/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://hudson.zones.apache.org/hudson/job/Hadoop-Common-trunk/395/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-6834&quot; title=&quot;TFile.append compares initial key against null lastKey  &quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-6834&quot;&gt;&lt;del&gt;HADOOP-6834&lt;/del&gt;&lt;/a&gt;. TFile.append compares initial key against null lastKey (hong tang via mahadev)&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12449597" name="hadoop-6834-20100715.patch" size="4561" author="hong.tang" created="Thu, 15 Jul 2010 21:36:31 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>19063</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 19 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0hz2f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>102943</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>