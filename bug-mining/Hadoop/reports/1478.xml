<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:47:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HADOOP-10062] race condition in MetricsSystemImpl#publishMetricsNow that causes incorrect results</title>
                <link>https://issues.apache.org/jira/browse/HADOOP-10062</link>
                <project id="12310240" key="HADOOP">Hadoop Common</project>
                    <description>&lt;p&gt;TestMetricsSystemInpl#testMultiThreadedPublish failed with &quot;Metrics not collected&quot;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Running org.apache.hadoop.metrics2.impl.TestMetricsSystemImpl
Tests run: 6, Failures: 1, Errors: 0, Skipped: 0, Time elapsed: 1.688 sec &amp;lt;&amp;lt;&amp;lt; FAILURE! - in org.apache.hadoop.metrics2.impl.TestMetricsSystemImpl
testMultiThreadedPublish(org.apache.hadoop.metrics2.impl.TestMetricsSystemImpl)  Time elapsed: 0.056 sec  &amp;lt;&amp;lt;&amp;lt; FAILURE!
java.lang.AssertionError: Metric not collected!
Metric not collected!
Metric not collected!
Metric not collected!
Metric not collected!
Metric not collected!
Metric not collected!
Metric not collected!
Metric not collected!
Passed
        at org.junit.Assert.fail(Assert.java:93)
        at org.junit.Assert.assertTrue(Assert.java:43)
        at org.apache.hadoop.metrics2.impl.TestMetricsSystemImpl.testMultiThreadedPublish(TestMetricsSystemImpl.java:232)


Results :

Failed tests:
  TestMetricsSystemImpl.testMultiThreadedPublish:232 Metric not collected!
Metric not collected!
Metric not collected!
Metric not collected!
Metric not collected!
Metric not collected!
Metric not collected!
Metric not collected!
Metric not collected!
Passed

Tests run: 6, Failures: 1, Errors: 0, Skipped: 0

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;CentOS 6.4, Oracle JDK 1.6.0_31, JDK1.7.0_45&lt;/p&gt;</environment>
        <key id="12674863">HADOOP-10062</key>
            <summary>race condition in MetricsSystemImpl#publishMetricsNow that causes incorrect results</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sjlee0">Sangjin Lee</assignee>
                                    <reporter username="sinchii">Shinichi Yamashita</reporter>
                        <labels>
                    </labels>
                <created>Mon, 21 Oct 2013 18:39:02 +0000</created>
                <updated>Fri, 25 Oct 2019 20:26:19 +0000</updated>
                            <resolved>Thu, 5 Feb 2015 03:01:35 +0000</resolved>
                                    <version>3.0.0-alpha1</version>
                                    <fixVersion>2.7.0</fixVersion>
                                    <component>metrics</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                                                                                <comments>
                            <comment id="13804023" author="vicaya" created="Thu, 24 Oct 2013 09:45:37 +0000"  >&lt;p&gt;Platform, JDK version?&lt;/p&gt;</comment>
                            <comment id="13804520" author="sinchii" created="Thu, 24 Oct 2013 18:40:11 +0000"  >&lt;p&gt;I use CentOS 6.4 and JDK 1.6.0_31.&lt;/p&gt;</comment>
                            <comment id="13817166" author="sinchii" created="Fri, 8 Nov 2013 10:25:36 +0000"  >&lt;p&gt;I confirmed the change of the value in the test.&lt;br/&gt;
And I confirmed that there was the case which a order of the handling of MetricsSystemImpl#publishMetrics reversed.&lt;br/&gt;
This problem can be solved by synchronizing MetricsSystemImpl#publishMetricsNow.&lt;/p&gt;

&lt;p&gt;I attach a patch file.&lt;/p&gt;</comment>
                            <comment id="13817177" author="hadoopqa" created="Fri, 8 Nov 2013 11:02:53 +0000"  >&lt;p&gt;&lt;font color=&quot;green&quot;&gt;+1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12612808/HADOOP-10062.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12612808/HADOOP-10062.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 tests included&lt;/font&gt;.  The patch appears to include 1 new or modified test files.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javadoc&lt;/font&gt;.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 eclipse:eclipse&lt;/font&gt;.  The patch built with eclipse:eclipse.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 findbugs&lt;/font&gt;.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 release audit&lt;/font&gt;.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 core tests&lt;/font&gt;.  The patch passed unit tests in hadoop-common-project/hadoop-common.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 contrib tests&lt;/font&gt;.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/3269//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/3269//testReport/&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/3269//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/3269//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13817920" author="vicaya" created="Sat, 9 Nov 2013 01:16:38 +0000"  >&lt;p&gt;Since publishMetrics is already synchronized, I don&apos;t see how the additional lock help. The barrier fix in the test looks more promising. Can you verify that the barrier only fix works?&lt;/p&gt;</comment>
                            <comment id="13817981" author="sinchii" created="Sat, 9 Nov 2013 03:21:02 +0000"  >&lt;p&gt;I tested the patch only for fixing of the barrier. But, the failure of the test sometimes occurred.&lt;br/&gt;
I dumped the values of metrics in MetricsSystemImpl#publishMetrics method.  And timestamp in the record seems to reverse at the time of the failure (&lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-10062&quot; title=&quot;race condition in MetricsSystemImpl#publishMetricsNow that causes incorrect results&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-10062&quot;&gt;&lt;del&gt;HADOOP-10062&lt;/del&gt;&lt;/a&gt;-failed.txt).&lt;br/&gt;
In other words a order to call MetricsSystemImpl#publishMetrics seems to have a problem.&lt;/p&gt;</comment>
                            <comment id="13818638" author="vicaya" created="Mon, 11 Nov 2013 00:33:23 +0000"  >&lt;p&gt;I think the following has more to do with the failure than anything else:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;WARN  impl.MetricsSinkAdapter (MetricsSinkAdapter.java:putMetricsImmediate(112)) - hanging couldn&apos;t fulfill an immediate putMetrics request in time. Abandoning.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Is your environment physical or virtual?&lt;/p&gt;</comment>
                            <comment id="13818757" author="sinchii" created="Mon, 11 Nov 2013 07:48:57 +0000"  >&lt;blockquote&gt;&lt;p&gt;Is your environment physical or virtual?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I confirmed it in both physical and virtual. &lt;br/&gt;
And, the following message was output in TestMetricsSystemImpl#testHangingSink and it was output both success and fail.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;WARN  impl.MetricsSinkAdapter (MetricsSinkAdapter.java:putMetricsImmediate(112)) - hanging couldn&apos;t fulfill an immediate putMetrics request in time. Abandoning.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13828637" author="sinchii" created="Thu, 21 Nov 2013 09:29:54 +0000"  >&lt;p&gt;I attach a patch which has only barrier fix.&lt;/p&gt;</comment>
                            <comment id="13828674" author="hadoopqa" created="Thu, 21 Nov 2013 10:10:19 +0000"  >&lt;p&gt;&lt;font color=&quot;green&quot;&gt;+1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12615090/HADOOP-10062.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12615090/HADOOP-10062.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 tests included&lt;/font&gt;.  The patch appears to include 1 new or modified test files.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javadoc&lt;/font&gt;.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 eclipse:eclipse&lt;/font&gt;.  The patch built with eclipse:eclipse.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 findbugs&lt;/font&gt;.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 release audit&lt;/font&gt;.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 core tests&lt;/font&gt;.  The patch passed unit tests in hadoop-common-project/hadoop-common.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 contrib tests&lt;/font&gt;.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/3306//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/3306//testReport/&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/3306//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/3306//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14277204" author="sjlee0" created="Wed, 14 Jan 2015 16:46:26 +0000"  >&lt;p&gt;I&apos;d like to revive interest in this. We see this test fail with some regularity in our CI environment (CentOS 6 w/ JDK 7).&lt;/p&gt;

&lt;p&gt;Clearly we need the fix in the current patch as the test waits on the wrong barrier.&lt;/p&gt;

&lt;p&gt;In addition, MetricsSystemImpl.publicMetricsNow() is not quite correct in synchronization because sinks.size() &amp;gt; 0 are checked unsynchronized (sinks is not a thread-safe data structure). So that needs to be fixed. However, I don&apos;t believe that is causing this test to fail (I don&apos;t think sinks are mutated while test threads run).&lt;/p&gt;

&lt;p&gt;Is the failure reproduced with the barrier fix? If so, could it be some kind of missed signals between the sink thread and the main thread, or something along that line? These are guesses at the moment.&lt;/p&gt;</comment>
                            <comment id="14277303" author="hadoopqa" created="Wed, 14 Jan 2015 17:46:15 +0000"  >&lt;p&gt;&lt;font color=&quot;green&quot;&gt;+1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12615090/HADOOP-10062.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12615090/HADOOP-10062.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision d336d13.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 tests included&lt;/font&gt;.  The patch appears to include 1 new or modified test files.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javadoc&lt;/font&gt;.  There were no new javadoc warning messages.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 eclipse:eclipse&lt;/font&gt;.  The patch built with eclipse:eclipse.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 findbugs&lt;/font&gt;.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 release audit&lt;/font&gt;.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 core tests&lt;/font&gt;.  The patch passed unit tests in hadoop-common-project/hadoop-common.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/5402//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/5402//testReport/&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/5402//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/5402//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14278135" author="sjlee0" created="Thu, 15 Jan 2015 02:29:01 +0000"  >&lt;p&gt;OK, after looking into it a little more I believe &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sinchii&quot; class=&quot;user-hover&quot; rel=&quot;sinchii&quot;&gt;sinchii&lt;/a&gt;&apos;s original patch is essentially right. The barrier usage is obviously wrong, but what might be more relevant is the following line of code in MetricsSystemImpl.publishMetricsNow():&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;publishMetrics(sampleMetrics(), &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Although sampleMetrics() and publishMetrics() are individually synchronized, the line as a whole is invoked without synchronization. Thus it is racy, and the publishing order of the samples can be inverted.&lt;/p&gt;

&lt;p&gt;Somewhat apart from this, the publishMetricsNow() method should be synchronized to be thread safe (as sinks is not a thread-safe data structure). I&apos;ll post that patch shortly.&lt;/p&gt;</comment>
                            <comment id="14278202" author="hadoopqa" created="Thu, 15 Jan 2015 03:32:34 +0000"  >&lt;p&gt;&lt;font color=&quot;green&quot;&gt;+1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12692418/HADOOP-10062.003.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12692418/HADOOP-10062.003.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 5805dc0.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 tests included&lt;/font&gt;.  The patch appears to include 1 new or modified test files.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javadoc&lt;/font&gt;.  There were no new javadoc warning messages.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 eclipse:eclipse&lt;/font&gt;.  The patch built with eclipse:eclipse.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 findbugs&lt;/font&gt;.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 release audit&lt;/font&gt;.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 core tests&lt;/font&gt;.  The patch passed unit tests in hadoop-common-project/hadoop-common.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/5406//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/5406//testReport/&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/5406//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/5406//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14278267" author="sjlee0" created="Thu, 15 Jan 2015 05:05:37 +0000"  >&lt;p&gt;I&apos;d appreciate a review of the patch. Thanks!&lt;/p&gt;</comment>
                            <comment id="14278835" author="vicaya" created="Thu, 15 Jan 2015 15:48:39 +0000"  >&lt;p&gt;This would fix the test, but the test will probably fail again if one set the regular metrics publish interval to be small. A cleaner fix would change the system to use ScheduledExecutorService (instead of the timer) with a thread pool of one thread and have publishMetricsNow do an out of band service.execute(...).&lt;/p&gt;</comment>
                            <comment id="14279052" author="sjlee0" created="Thu, 15 Jan 2015 18:19:57 +0000"  >&lt;p&gt;Thanks for your feedback &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vicaya&quot; class=&quot;user-hover&quot; rel=&quot;vicaya&quot;&gt;vicaya&lt;/a&gt;!&lt;/p&gt;

&lt;p&gt;I did look at the timer-driven regular publishing route, but it seems to me that by synchronizing publishMetricsNow() an inversion cannot happen even with regular publishing (inversion meaning earlier sampling pushed to the sinks later). In both code paths (onTimerEvent() and publishMetricsNow()), sample --&amp;gt; publish --&amp;gt; sinkadapter enqueue() would happen atomically while holding the lock. Assuming SinkQueue is a FIFO queue, this would certainly guarantee no inversion.&lt;/p&gt;

&lt;p&gt;Could you kindly point out under what conditions a failure would occur? Thanks!&lt;/p&gt;

&lt;p&gt;Having said that, I do like the idea of using ScheduledExecutorService over the Timer, as in general it is more robust in case of unexpected exceptions. I could make that change if needed.&lt;/p&gt;</comment>
                            <comment id="14279158" author="vicaya" created="Thu, 15 Jan 2015 19:23:17 +0000"  >&lt;p&gt;You&apos;re right. Your current fix is good enough for correctness and low risk. +1 for the patch. Using ScheduledExecutorService is just a little cleaner, which can be deferred.&lt;/p&gt;</comment>
                            <comment id="14279307" author="sjlee0" created="Thu, 15 Jan 2015 21:27:21 +0000"  >&lt;p&gt;Thanks Luke. I&apos;d greatly appreciate if you could merge it at some point (both to trunk and branch-2).&lt;/p&gt;

&lt;p&gt;I&apos;ll also update the title to reflect the fact that there was really an issue with the non-test metrics code (after all the multi-threaded test did flush out the issue so it did its job &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;).&lt;/p&gt;</comment>
                            <comment id="14296466" author="sjlee0" created="Thu, 29 Jan 2015 06:46:02 +0000"  >&lt;p&gt;Ping?&lt;/p&gt;</comment>
                            <comment id="14306430" author="djp" created="Thu, 5 Feb 2015 01:46:43 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sjlee0&quot; class=&quot;user-hover&quot; rel=&quot;sjlee0&quot;&gt;sjlee0&lt;/a&gt;, the patch LGTM. Kick off Jenkins again now. &lt;br/&gt;
+1 pending on Jenkins result.&lt;/p&gt;</comment>
                            <comment id="14306493" author="sjlee0" created="Thu, 5 Feb 2015 02:08:23 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=junping_du&quot; class=&quot;user-hover&quot; rel=&quot;junping_du&quot;&gt;junping_du&lt;/a&gt;!&lt;/p&gt;</comment>
                            <comment id="14306533" author="hadoopqa" created="Thu, 5 Feb 2015 02:44:23 +0000"  >&lt;p&gt;&lt;font color=&quot;green&quot;&gt;+1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12692418/HADOOP-10062.003.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12692418/HADOOP-10062.003.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision cc6bbfc.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 tests included&lt;/font&gt;.  The patch appears to include 1 new or modified test files.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javadoc&lt;/font&gt;.  There were no new javadoc warning messages.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 eclipse:eclipse&lt;/font&gt;.  The patch built with eclipse:eclipse.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 findbugs&lt;/font&gt;.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 release audit&lt;/font&gt;.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 core tests&lt;/font&gt;.  The patch passed unit tests in hadoop-common-project/hadoop-common.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/5591//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/5591//testReport/&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/5591//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/5591//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14306551" author="djp" created="Thu, 5 Feb 2015 03:01:35 +0000"  >&lt;p&gt;I have commit 003.patch to trunk and branch-2. Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sjlee0&quot; class=&quot;user-hover&quot; rel=&quot;sjlee0&quot;&gt;sjlee0&lt;/a&gt; for contributing a patch and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vicaya&quot; class=&quot;user-hover&quot; rel=&quot;vicaya&quot;&gt;vicaya&lt;/a&gt; for review!&lt;/p&gt;</comment>
                            <comment id="14306554" author="hudson" created="Thu, 5 Feb 2015 03:03:11 +0000"  >&lt;p&gt;FAILURE: Integrated in Hadoop-trunk-Commit #7016 (See &lt;a href=&quot;https://builds.apache.org/job/Hadoop-trunk-Commit/7016/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Hadoop-trunk-Commit/7016/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-10062&quot; title=&quot;race condition in MetricsSystemImpl#publishMetricsNow that causes incorrect results&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-10062&quot;&gt;&lt;del&gt;HADOOP-10062&lt;/del&gt;&lt;/a&gt;. race condition in MetricsSystemImpl#publishMetricsNow that causes incorrect results.  (Contributed by Sangjin Lee) (junping_du: rev 0b567f424673b5cea1c3bc23b2bd268ef6b7625f)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/metrics2/impl/TestMetricsSystemImpl.java&lt;/li&gt;
	&lt;li&gt;hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/metrics2/impl/MetricsSystemImpl.java&lt;/li&gt;
	&lt;li&gt;hadoop-common-project/hadoop-common/CHANGES.txt&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14306986" author="hudson" created="Thu, 5 Feb 2015 10:41:16 +0000"  >&lt;p&gt;FAILURE: Integrated in Hadoop-Yarn-trunk-Java8 #95 (See &lt;a href=&quot;https://builds.apache.org/job/Hadoop-Yarn-trunk-Java8/95/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Hadoop-Yarn-trunk-Java8/95/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-10062&quot; title=&quot;race condition in MetricsSystemImpl#publishMetricsNow that causes incorrect results&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-10062&quot;&gt;&lt;del&gt;HADOOP-10062&lt;/del&gt;&lt;/a&gt;. race condition in MetricsSystemImpl#publishMetricsNow that causes incorrect results.  (Contributed by Sangjin Lee) (junping_du: rev 0b567f424673b5cea1c3bc23b2bd268ef6b7625f)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/metrics2/impl/MetricsSystemImpl.java&lt;/li&gt;
	&lt;li&gt;hadoop-common-project/hadoop-common/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/metrics2/impl/TestMetricsSystemImpl.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14307013" author="hudson" created="Thu, 5 Feb 2015 10:44:12 +0000"  >&lt;p&gt;FAILURE: Integrated in Hadoop-Yarn-trunk #829 (See &lt;a href=&quot;https://builds.apache.org/job/Hadoop-Yarn-trunk/829/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Hadoop-Yarn-trunk/829/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-10062&quot; title=&quot;race condition in MetricsSystemImpl#publishMetricsNow that causes incorrect results&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-10062&quot;&gt;&lt;del&gt;HADOOP-10062&lt;/del&gt;&lt;/a&gt;. race condition in MetricsSystemImpl#publishMetricsNow that causes incorrect results.  (Contributed by Sangjin Lee) (junping_du: rev 0b567f424673b5cea1c3bc23b2bd268ef6b7625f)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hadoop-common-project/hadoop-common/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/metrics2/impl/MetricsSystemImpl.java&lt;/li&gt;
	&lt;li&gt;hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/metrics2/impl/TestMetricsSystemImpl.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14307263" author="hudson" created="Thu, 5 Feb 2015 14:33:24 +0000"  >&lt;p&gt;SUCCESS: Integrated in Hadoop-Hdfs-trunk #2027 (See &lt;a href=&quot;https://builds.apache.org/job/Hadoop-Hdfs-trunk/2027/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Hadoop-Hdfs-trunk/2027/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-10062&quot; title=&quot;race condition in MetricsSystemImpl#publishMetricsNow that causes incorrect results&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-10062&quot;&gt;&lt;del&gt;HADOOP-10062&lt;/del&gt;&lt;/a&gt;. race condition in MetricsSystemImpl#publishMetricsNow that causes incorrect results.  (Contributed by Sangjin Lee) (junping_du: rev 0b567f424673b5cea1c3bc23b2bd268ef6b7625f)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/metrics2/impl/TestMetricsSystemImpl.java&lt;/li&gt;
	&lt;li&gt;hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/metrics2/impl/MetricsSystemImpl.java&lt;/li&gt;
	&lt;li&gt;hadoop-common-project/hadoop-common/CHANGES.txt&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14307294" author="hudson" created="Thu, 5 Feb 2015 14:42:46 +0000"  >&lt;p&gt;SUCCESS: Integrated in Hadoop-Hdfs-trunk-Java8 #92 (See &lt;a href=&quot;https://builds.apache.org/job/Hadoop-Hdfs-trunk-Java8/92/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Hadoop-Hdfs-trunk-Java8/92/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-10062&quot; title=&quot;race condition in MetricsSystemImpl#publishMetricsNow that causes incorrect results&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-10062&quot;&gt;&lt;del&gt;HADOOP-10062&lt;/del&gt;&lt;/a&gt;. race condition in MetricsSystemImpl#publishMetricsNow that causes incorrect results.  (Contributed by Sangjin Lee) (junping_du: rev 0b567f424673b5cea1c3bc23b2bd268ef6b7625f)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/metrics2/impl/MetricsSystemImpl.java&lt;/li&gt;
	&lt;li&gt;hadoop-common-project/hadoop-common/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/metrics2/impl/TestMetricsSystemImpl.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14307341" author="hudson" created="Thu, 5 Feb 2015 15:04:35 +0000"  >&lt;p&gt;FAILURE: Integrated in Hadoop-Mapreduce-trunk-Java8 #96 (See &lt;a href=&quot;https://builds.apache.org/job/Hadoop-Mapreduce-trunk-Java8/96/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Hadoop-Mapreduce-trunk-Java8/96/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-10062&quot; title=&quot;race condition in MetricsSystemImpl#publishMetricsNow that causes incorrect results&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-10062&quot;&gt;&lt;del&gt;HADOOP-10062&lt;/del&gt;&lt;/a&gt;. race condition in MetricsSystemImpl#publishMetricsNow that causes incorrect results.  (Contributed by Sangjin Lee) (junping_du: rev 0b567f424673b5cea1c3bc23b2bd268ef6b7625f)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/metrics2/impl/MetricsSystemImpl.java&lt;/li&gt;
	&lt;li&gt;hadoop-common-project/hadoop-common/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/metrics2/impl/TestMetricsSystemImpl.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14307382" author="hudson" created="Thu, 5 Feb 2015 15:24:55 +0000"  >&lt;p&gt;FAILURE: Integrated in Hadoop-Mapreduce-trunk #2046 (See &lt;a href=&quot;https://builds.apache.org/job/Hadoop-Mapreduce-trunk/2046/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Hadoop-Mapreduce-trunk/2046/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-10062&quot; title=&quot;race condition in MetricsSystemImpl#publishMetricsNow that causes incorrect results&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-10062&quot;&gt;&lt;del&gt;HADOOP-10062&lt;/del&gt;&lt;/a&gt;. race condition in MetricsSystemImpl#publishMetricsNow that causes incorrect results.  (Contributed by Sangjin Lee) (junping_du: rev 0b567f424673b5cea1c3bc23b2bd268ef6b7625f)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/metrics2/impl/TestMetricsSystemImpl.java&lt;/li&gt;
	&lt;li&gt;hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/metrics2/impl/MetricsSystemImpl.java&lt;/li&gt;
	&lt;li&gt;hadoop-common-project/hadoop-common/CHANGES.txt&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="12669797">HADOOP-9990</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12684813">HADOOP-10165</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12674417">HADOOP-10058</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12612965" name="HADOOP-10062-failed.txt" size="31012" author="sinchii" created="Sat, 9 Nov 2013 02:59:24 +0000"/>
                            <attachment id="12612964" name="HADOOP-10062-success.txt" size="31363" author="sinchii" created="Sat, 9 Nov 2013 02:59:24 +0000"/>
                            <attachment id="12692418" name="HADOOP-10062.003.patch" size="1671" author="sjlee0" created="Thu, 15 Jan 2015 02:30:24 +0000"/>
                            <attachment id="12615090" name="HADOOP-10062.patch" size="864" author="sinchii" created="Thu, 21 Nov 2013 09:28:21 +0000"/>
                            <attachment id="12612808" name="HADOOP-10062.patch" size="1632" author="sinchii" created="Fri, 8 Nov 2013 10:25:36 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>354485</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 41 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1p43j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>354775</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12327583">2.7.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>