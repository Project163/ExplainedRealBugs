<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:52:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HADOOP-14428] s3a: mkdir appears to be broken</title>
                <link>https://issues.apache.org/jira/browse/HADOOP-14428</link>
                <project id="12310240" key="HADOOP">Hadoop Common</project>
                    <description>&lt;p&gt;Reproduction is:&lt;/p&gt;

&lt;p&gt;hadoop fs -mkdir s3a://my-bucket/dir/&lt;br/&gt;
hadoop fs -ls s3a://my-bucket/dir/&lt;/p&gt;

&lt;p&gt;ls: `s3a://my-bucket/dir/&apos;: No such file or directory&lt;/p&gt;

&lt;p&gt;I believe this is a regression from &lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-14255&quot; title=&quot;S3A to delete unnecessary fake directory objects in mkdirs()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-14255&quot;&gt;&lt;del&gt;HADOOP-14255&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13072649">HADOOP-14428</key>
            <summary>s3a: mkdir appears to be broken</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="liuml07">Mingliang Liu</assignee>
                                    <reporter username="fabbri">Aaron Fabbri</reporter>
                        <labels>
                    </labels>
                <created>Wed, 17 May 2017 01:18:30 +0000</created>
                <updated>Tue, 24 Apr 2018 20:52:09 +0000</updated>
                            <resolved>Mon, 5 Jun 2017 18:32:30 +0000</resolved>
                                    <version>3.0.0-alpha2</version>
                    <version>HADOOP-13345</version>
                                    <fixVersion>2.9.0</fixVersion>
                    <fixVersion>3.0.0-alpha4</fixVersion>
                                    <component>fs/s3</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="16013356" author="fabbri" created="Wed, 17 May 2017 01:29:06 +0000"  >&lt;p&gt;Just confirming after:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;git revert b053fdc547ddbb6322674142a14010683006d123
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I no longer get the &quot;No such file or directory&quot;&lt;/p&gt;</comment>
                            <comment id="16013357" author="fabbri" created="Wed, 17 May 2017 01:30:00 +0000"  >&lt;p&gt;FYI &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stevel%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;stevel@apache.org&quot;&gt;stevel@apache.org&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=liuml07&quot; class=&quot;user-hover&quot; rel=&quot;liuml07&quot;&gt;liuml07&lt;/a&gt;. Let me know if you guys can reproduce it easily.&lt;/p&gt;</comment>
                            <comment id="16013557" author="liuml07" created="Wed, 17 May 2017 05:32:09 +0000"  >&lt;p&gt;I&apos;ll test this tomorrow. I&apos;ve no idea how the unit tests fools me. This is a blocker for sure. Thanks,&lt;/p&gt;</comment>
                            <comment id="16014055" author="stevel@apache.org" created="Wed, 17 May 2017 13:40:29 +0000"  >&lt;p&gt;maybe its the special case of a trailing &quot;/&quot; at the end? we may just have missed that as a test case. In which case, it&apos;s something that should go up to the contract tests against all filesystems&lt;/p&gt;</comment>
                            <comment id="16016048" author="fabbri" created="Thu, 18 May 2017 16:42:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stevel%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;stevel@apache.org&quot;&gt;stevel@apache.org&lt;/a&gt; I saw the same behavior without the trailing &apos;/&apos;&lt;/p&gt;</comment>
                            <comment id="16016642" author="liuml07" created="Thu, 18 May 2017 23:20:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fabbri&quot; class=&quot;user-hover&quot; rel=&quot;fabbri&quot;&gt;fabbri&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;I can confirm that the problem happens w/ the trailing &apos;/&apos; when mkdir. But if I mkdir w/o trailing &apos;/&apos;, the problem is gone. I&apos;ll debug for a while why this happens.&lt;/p&gt;</comment>
                            <comment id="16016646" author="fabbri" created="Thu, 18 May 2017 23:24:46 +0000"  >&lt;p&gt;Ah, ok. I tested the &lt;b&gt;ls&lt;/b&gt; with/without trailing slash, but not sure I tested the mkdir with/without it.&lt;/p&gt;</comment>
                            <comment id="16016725" author="liuml07" created="Fri, 19 May 2017 00:31:07 +0000"  >&lt;p&gt;Yes, reverting the b053fdc547ddbb6322674142a14010683006d123 did solve the problem (that is, mkdir w/ trailing &apos;/&apos; will not make following ls get FNFE any more).&lt;/p&gt;</comment>
                            <comment id="16016762" author="liuml07" created="Fri, 19 May 2017 01:16:19 +0000"  >&lt;p&gt;The idea in &lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-14255&quot; title=&quot;S3A to delete unnecessary fake directory objects in mkdirs()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-14255&quot;&gt;&lt;del&gt;HADOOP-14255&lt;/del&gt;&lt;/a&gt; is to delete the unnecessary fake object for all its ancestors. The idea makes sense if we start deleting unnecessary fake objects from current empty directory&apos;s parent.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;deleteUnnecessaryFakeDirectories(f.getParent());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;However, with trailing slash, the &lt;tt&gt;Path::getParent()&lt;/tt&gt; is not behaviouring what we expected: &lt;tt&gt;s3a://my-bucket/dir/&lt;/tt&gt;&apos;s parent is &lt;tt&gt;s3a://my-bucket/dir&lt;/tt&gt; instead of &lt;tt&gt;s3a://my-bucket&lt;/tt&gt;. The original patch got passing unit tests because we didn&apos;t add trailing &apos;/&apos; in the test path.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;Path::getParent()&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  /**
   * Returns the parent of a path or &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; at root.
   * @&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; the parent of a path or &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; at root
   */
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Path getParent() {
    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; path = uri.getPath();
    &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; lastSlash = path.lastIndexOf(&lt;span class=&quot;code-quote&quot;&gt;&apos;/&apos;&lt;/span&gt;);
    &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; start = startPositionWithoutWindowsDrive(path);
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ((path.length() == start) ||               &lt;span class=&quot;code-comment&quot;&gt;// empty path
&lt;/span&gt;        (lastSlash == start &amp;amp;&amp;amp; path.length() == start+1)) { &lt;span class=&quot;code-comment&quot;&gt;// at root
&lt;/span&gt;      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
    }
    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; parent;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (lastSlash==-1) {
      parent = CUR_DIR;
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
      parent = path.substring(0, lastSlash==start?start+1:lastSlash);
    }
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Path(uri.getScheme(), uri.getAuthority(), parent);
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So we simply trusted &lt;tt&gt;Path::getParent()&lt;/tt&gt; but it betrays us here. We may normalize (remove the trailing &apos;/&apos;) before we calls &lt;tt&gt;getParent&lt;/tt&gt;, or we figure out the parent by ourselves.&lt;/p&gt;</comment>
                            <comment id="16022837" author="stevel@apache.org" created="Wed, 24 May 2017 12:51:11 +0000"  >&lt;p&gt;This is showing up a bad assumption in all our test code: we&apos;ve been constructing paths &quot;properly&quot;, when sometimes we should be building them from bad strings and handing them in. I&apos;d like a patch here to do something in the Mkdir contract tests too in case its a broader problem elsewhere&lt;/p&gt;</comment>
                            <comment id="16023773" author="liuml07" created="Wed, 24 May 2017 21:58:29 +0000"  >&lt;p&gt;The &lt;tt&gt;Path::getParent()&lt;/tt&gt; behavior has been known for years but we accepted it, e.g.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;Mkdir.java::processNonexistentPath()&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  @Override
  &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void processNonexistentPath(PathData item) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
    &lt;span class=&quot;code-comment&quot;&gt;// check &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; parent exists. &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; is complicated because getParent(a/b/c/) returns a/b/c, but
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// we want a/b
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!createParents &amp;amp;&amp;amp;
        !item.fs.exists(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Path(item.path.toString()).getParent())) {
      &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PathNotFoundException(item.toString());
    }
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!item.fs.mkdirs(item.path)) {
      &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PathIOException(item.toString());
    }
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Here I&apos;d suggest not to change the existing behavior of &lt;tt&gt;Path::getParent()&lt;/tt&gt; which returns &lt;tt&gt;s3a://my-bucket/dir&lt;/tt&gt; for &lt;tt&gt;s3a://my-bucket/dir/&lt;/tt&gt;. Instead we bypass this by creating a new Path object which removes the trailing &quot;/&quot;.&lt;/p&gt;

&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stevel%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;stevel@apache.org&quot;&gt;stevel@apache.org&lt;/a&gt; for the suggestion for adding unit tests. The newly added tests can not pass w/o this patch, and pass w/ this patch.&lt;/p&gt;</comment>
                            <comment id="16024184" author="hadoopqa" created="Thu, 25 May 2017 04:45:57 +0000"  >&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/error.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;b&gt;&lt;font color=&quot;red&quot;&gt;-1 overall&lt;/font&gt;&lt;/b&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;

&lt;p&gt;&lt;br class=&quot;atl-forced-newline&quot; /&gt;
&lt;br class=&quot;atl-forced-newline&quot; /&gt;&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Vote &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Subsystem &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Runtime &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Comment &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;blue&quot;&gt;0&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;blue&quot;&gt; reexec &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;blue&quot;&gt;  0m 16s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;blue&quot;&gt; Docker mode activated. &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; @author &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  0m  0s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; The patch does not contain any @author tags. &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; test4tests &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  0m  0s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; The patch appears to include 1 new or modified test files. &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;blue&quot;&gt;0&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;blue&quot;&gt; mvndep &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;blue&quot;&gt;  0m 17s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;blue&quot;&gt; Maven dependency ordering for branch &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; mvninstall &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; 12m 42s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; trunk passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; compile &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; 12m 53s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; trunk passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; checkstyle &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  1m 40s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; trunk passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; mvnsite &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  1m 26s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; trunk passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; mvneclipse &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  0m 48s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; trunk passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;red&quot;&gt;-1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;red&quot;&gt; findbugs &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;red&quot;&gt;  1m 24s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;red&quot;&gt; hadoop-common-project/hadoop-common in trunk has 19 extant Findbugs warnings. &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; javadoc &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  1m  0s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; trunk passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;blue&quot;&gt;0&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;blue&quot;&gt; mvndep &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;blue&quot;&gt;  0m 16s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;blue&quot;&gt; Maven dependency ordering for patch &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; mvninstall &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  0m 58s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; compile &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; 13m  7s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; javac &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; 13m  7s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; checkstyle &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  1m 46s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; mvnsite &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  1m 32s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; mvneclipse &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  0m 42s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; whitespace &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  0m  0s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; The patch has no whitespace issues. &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; findbugs &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  2m 19s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; javadoc &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  1m 13s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; the patch passed &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; unit &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  7m 59s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; hadoop-common in the patch passed. &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; unit &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  0m 28s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; hadoop-aws in the patch passed. &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;+1&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; asflicense &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt;  0m 32s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;green&quot;&gt; The patch does not generate ASF License warnings. &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;black&quot;&gt;&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;black&quot;&gt; &lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;black&quot;&gt; 87m 41s&lt;/font&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;font color=&quot;black&quot;&gt; &lt;/font&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;

&lt;p&gt;&lt;br class=&quot;atl-forced-newline&quot; /&gt;
&lt;br class=&quot;atl-forced-newline&quot; /&gt;&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Subsystem &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Report/Notes &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Docker &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;  Image:yetus/hadoop:14b5c93 &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; JIRA Issue &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-14428&quot; title=&quot;s3a: mkdir appears to be broken&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-14428&quot;&gt;&lt;del&gt;HADOOP-14428&lt;/del&gt;&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; JIRA Patch URL &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12869734/HADOOP-14428.001.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12869734/HADOOP-14428.001.patch&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Optional Tests &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;  asflicense  compile  javac  javadoc  mvninstall  mvnsite  unit  findbugs  checkstyle  &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; uname &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Linux 05029a38e378 4.4.0-43-generic #63-Ubuntu SMP Wed Oct 12 13:48:03 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Build tool &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; maven &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Personality &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; /testptch/hadoop/patchprocess/precommit/personality/provided.sh &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; git revision &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; trunk / d049bd2 &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Default Java &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; 1.8.0_131 &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; findbugs &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; v3.1.0-RC1 &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; findbugs &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/12389/artifact/patchprocess/branch-findbugs-hadoop-common-project_hadoop-common-warnings.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/12389/artifact/patchprocess/branch-findbugs-hadoop-common-project_hadoop-common-warnings.html&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;  Test Results &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/12389/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/12389/testReport/&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; modules &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; C: hadoop-common-project/hadoop-common hadoop-tools/hadoop-aws U: . &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Console output &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/12389/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/12389/console&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Powered by &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Apache Yetus 0.5.0-SNAPSHOT   &lt;a href=&quot;http://yetus.apache.org&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://yetus.apache.org&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;



&lt;p&gt;This message was automatically generated.&lt;/p&gt;
</comment>
                            <comment id="16024967" author="stevel@apache.org" created="Thu, 25 May 2017 16:27:30 +0000"  >&lt;p&gt;which filesystems have you tested against?&lt;/p&gt;</comment>
                            <comment id="16025418" author="liuml07" created="Thu, 25 May 2017 21:20:37 +0000"  >&lt;p&gt;I tested the following ones: &lt;tt&gt;ITestS3AContractMkdir&lt;/tt&gt; for S3, &lt;tt&gt;TestHDFSContractMkdir&lt;/tt&gt; for HDFS, &lt;tt&gt;TestRawlocalContractMkdir&lt;/tt&gt; and &lt;tt&gt;TestLocalFSContractMkdir&lt;/tt&gt; for local FS, &lt;tt&gt;TestAzureNativeContractMkdir&lt;/tt&gt; for WASB, and &lt;tt&gt;TestAdlContractMkdirLive&lt;/tt&gt; for ADLS.&lt;/p&gt;

&lt;p&gt;I also have run all S3 integration tests successfully against us-west-1 region, as the change is in &lt;tt&gt;S3AFileSystem&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;I built the jar file and operated the fs shell commands &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fabbri&quot; class=&quot;user-hover&quot; rel=&quot;fabbri&quot;&gt;fabbri&lt;/a&gt; reported in the description, and it shows the directory instead of complaining FNFE. Can you verify this from your side?&lt;/p&gt;</comment>
                            <comment id="16033756" author="liuml07" created="Thu, 1 Jun 2017 21:43:10 +0000"  >&lt;p&gt;As this is a blocker, can you help review/verify here? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fabbri&quot; class=&quot;user-hover&quot; rel=&quot;fabbri&quot;&gt;fabbri&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stevel%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;stevel@apache.org&quot;&gt;stevel@apache.org&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16033775" author="fabbri" created="Thu, 1 Jun 2017 21:54:55 +0000"  >&lt;p&gt;Will do.  Looking at it now &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=liuml07&quot; class=&quot;user-hover&quot; rel=&quot;liuml07&quot;&gt;liuml07&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16033870" author="fabbri" created="Thu, 1 Jun 2017 22:57:08 +0000"  >&lt;p&gt;Ok &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=liuml07&quot; class=&quot;user-hover&quot; rel=&quot;liuml07&quot;&gt;liuml07&lt;/a&gt;, I confirmed that your patch fixes the reproduction I mentioned (mkdir with trailing slash).&lt;/p&gt;

&lt;p&gt;One question on your patch:  I&apos;m wondering why the existing test code did not catch this bug?  It looks like you added new test cases that also use unqualified paths.  I would guess that the trailing slash gets removed in S3AFileSystem in qualify(), but only when it is not absolute?  So the existing test did not catch it?&lt;/p&gt;

&lt;p&gt;My reproduction uses an absolute path though, so I&apos;m confused.&lt;/p&gt;

&lt;p&gt;Anyways, just curious.  I am still +1 on the patch assuming you get a clean Yetus run.&lt;/p&gt;</comment>
                            <comment id="16033986" author="liuml07" created="Fri, 2 Jun 2017 00:54:39 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fabbri&quot; class=&quot;user-hover&quot; rel=&quot;fabbri&quot;&gt;fabbri&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stevel%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;stevel@apache.org&quot;&gt;stevel@apache.org&lt;/a&gt; for review. This is tricky; I know. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;The reason that existing test code did not catch this bug is because, as you said, the trailing slash was removed before it&apos;s passed to S3AFileSystem. There are several places that will remove trailing slashes, mostly &lt;tt&gt;URI::normalize()&lt;/tt&gt; and &lt;tt&gt;Path::normalizePath()&lt;/tt&gt;. All Path constructors will call &lt;tt&gt;URI::normalize()&lt;/tt&gt; implicitly after which there will be &lt;em&gt;at most&lt;/em&gt; one trailing slash. Meanwhile, some Path constructors call &lt;tt&gt;normalizePath()&lt;/tt&gt; as well. Last, &lt;tt&gt;Path::makeQualified()&lt;/tt&gt; method &lt;em&gt;sometimes&lt;/em&gt; removes the trailing slash. In our existing code, the &lt;tt&gt;Path::makeQualified()&lt;/tt&gt; is called via &lt;tt&gt;path()&lt;/tt&gt; helper method and it does remove trailing slashes if any. So overall, the existing test code will not get a chance to carry trailing slashes before passing to S3AFileSystem.&lt;/p&gt;

&lt;p&gt;You can add as many trailing slashes, and it should pass always.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;AbstractContractMkdirTest::testMkdirSlashHandling()&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-comment&quot;&gt;// With trailing slash
&lt;/span&gt;    assertTrue(fs.mkdirs(path(&lt;span class=&quot;code-quote&quot;&gt;&quot;testmkdir/b&lt;span class=&quot;code-comment&quot;&gt;////////////&quot;&lt;/span&gt;)));
&lt;/span&gt;    assertPathExists(&lt;span class=&quot;code-quote&quot;&gt;&quot;mkdir with trailing slash failed&quot;&lt;/span&gt;, path(&lt;span class=&quot;code-quote&quot;&gt;&quot;testmkdir/b/&quot;&lt;/span&gt;));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Comes back to our case,&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;note that we say &lt;em&gt;some Path constructors&lt;/em&gt; call &lt;tt&gt;normalizePath()&lt;/tt&gt; and constructor &lt;tt&gt;Path(URI)&lt;/tt&gt; does not.
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Path(URI aUri) {
    uri = aUri.normalize();
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;So the uri is allowed to have one trailing slash. Unfortunately, fs.shell package is using &lt;tt&gt;PathData&lt;/tt&gt; class which creates a Path object from command line arguments via &lt;tt&gt;Path(URI)&lt;/tt&gt; constructor. In our case the trailing slash is preserved in constructor.&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;Actually &lt;tt&gt;PathData&lt;/tt&gt; will also call &lt;tt&gt;Path::makeQualified()&lt;/tt&gt; method after constructing a Path. However,  &lt;tt&gt;Path::makeQualified()&lt;/tt&gt; &lt;em&gt;sometimes removes the trailing slash&lt;/em&gt; by calling &lt;tt&gt;Path::normalizePath()&lt;/tt&gt;, and sometimes === not fully qualified.
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  /*  ...
   * @&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; path &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; it contains a scheme and authority and is absolute, or
   * a &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; path that includes a path and authority and is fully qualified
   */
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Path makeQualified(URI defaultUri, Path workingDir ) {
  ...
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Here in the command line of this JIRA, we provide a fully qualified path string. As a result, the trailing slash is preserved again. Eventually the trailing slash gets passed to S3AFileSystem, where we got fooled to believe &lt;tt&gt;/a/b/c/&lt;/tt&gt; getParent returns &lt;tt&gt;/a/b&lt;/tt&gt; while it actually returns &lt;tt&gt;/a/b/c&lt;/tt&gt;.&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;As to the new test case in this patch, the &lt;tt&gt;new Path(getContract().getTestPath() + &quot;/testMkdirSlashHandling/e///&quot;)&lt;/tt&gt; will fail w/o this fix because:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;We have triple trailing slashes, while &lt;tt&gt;Path::normalizePath()&lt;/tt&gt; is only able to remove two of them (refer to its source code)&lt;/li&gt;
	&lt;li&gt;After &lt;tt&gt;Path::normalizePath()&lt;/tt&gt;, &lt;tt&gt;URI::normalize()&lt;/tt&gt; allows one trailing slash.&lt;br/&gt;
So in S3AFileSystem, the Path to mkdir has the trailing slash and we have to remove before calling &lt;tt&gt;getParent&lt;/tt&gt;.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;If only you find this amusing. Part of my understanding maybe wrong; correct me.&lt;/p&gt;

&lt;p&gt;The findbugs warnings are unrelated, and the patch still apply cleanly. I&apos;ll hold on commit by tomorrow. Thanks,&lt;/p&gt;</comment>
                            <comment id="16037181" author="stevel@apache.org" created="Mon, 5 Jun 2017 16:36:17 +0000"  >&lt;p&gt;good trackdown of the underlying problem. It may come back again somewhere, but at least now we have a test for all the filesystems.&lt;/p&gt;

&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="16037259" author="fabbri" created="Mon, 5 Jun 2017 17:38:41 +0000"  >&lt;p&gt;Yes, thank you for the detailed description &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=liuml07&quot; class=&quot;user-hover&quot; rel=&quot;liuml07&quot;&gt;liuml07&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16037337" author="liuml07" created="Mon, 5 Jun 2017 18:32:30 +0000"  >&lt;p&gt;Committed to &lt;tt&gt;branch-2&lt;/tt&gt; and &lt;tt&gt;trunk&lt;/tt&gt; branches. Thanks for your report and review &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ajfabbri&quot; class=&quot;user-hover&quot; rel=&quot;ajfabbri&quot;&gt;ajfabbri&lt;/a&gt;. Thanks for your review and discussion, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stevel%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;stevel@apache.org&quot;&gt;stevel@apache.org&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16037388" author="hudson" created="Mon, 5 Jun 2017 18:53:32 +0000"  >&lt;p&gt;SUCCESS: Integrated in Jenkins build Hadoop-trunk-Commit #11823 (See &lt;a href=&quot;https://builds.apache.org/job/Hadoop-trunk-Commit/11823/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Hadoop-trunk-Commit/11823/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-14428&quot; title=&quot;s3a: mkdir appears to be broken&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-14428&quot;&gt;&lt;del&gt;HADOOP-14428&lt;/del&gt;&lt;/a&gt;. s3a: mkdir appears to be broken. Contributed by Mingliang (liuml07: rev 6aeda55bb8f741d9dafd41f6dfbf1a88acdd4003)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AFileSystem.java&lt;/li&gt;
	&lt;li&gt;(edit) hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/fs/contract/AbstractContractMkdirTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16450831" author="hudson" created="Tue, 24 Apr 2018 20:52:09 +0000"  >&lt;p&gt;SUCCESS: Integrated in Jenkins build Hadoop-trunk-Commit #14057 (See &lt;a href=&quot;https://builds.apache.org/job/Hadoop-trunk-Commit/14057/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Hadoop-trunk-Commit/14057/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-14428&quot; title=&quot;s3a: mkdir appears to be broken&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-14428&quot;&gt;&lt;del&gt;HADOOP-14428&lt;/del&gt;&lt;/a&gt;. s3a: mkdir appears to be broken. Contributed by Mingliang (xyao: rev ce634881ced7ff14118a7789cb70ff6428710e00)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/fs/contract/AbstractContractMkdirTest.java&lt;/li&gt;
	&lt;li&gt;(edit) hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AFileSystem.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                                                <inwardlinks description="is broken by">
                                        <issuelink>
            <issuekey id="13060181">HADOOP-14255</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12869733" name="HADOOP-14428.000.patch" size="4010" author="liuml07" created="Wed, 24 May 2017 21:58:29 +0000"/>
                            <attachment id="12869734" name="HADOOP-14428.001.patch" size="3737" author="liuml07" created="Wed, 24 May 2017 22:00:05 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 30 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3f37b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>