<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:43:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HADOOP-9507] LocalFileSystem rename() is broken in some cases when destination exists</title>
                <link>https://issues.apache.org/jira/browse/HADOOP-9507</link>
                <project id="12310240" key="HADOOP">Hadoop Common</project>
                    <description>&lt;p&gt;The rename() method in RawLocalFileSystem uses FileUtil.copy() without realizing that FileUtil.copy() has a special behavior that if you&apos;re copying /foo to /bar and /bar exists and is a directory, it&apos;ll copy /foo inside /bar instead of overwriting it, which is not what rename() wants. So you end up with weird behaviors like in this repro:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;c:
cd \
md Foo
md Bar
md Foo\X
md Bar\X
hadoop fs -mv file:&lt;span class=&quot;code-comment&quot;&gt;///c:/Foo file:///c:/Bar&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;At the end of this, you would expect to find only Bar\X, but you instead find Bar\X\X.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12644736">HADOOP-9507</key>
            <summary>LocalFileSystem rename() is broken in some cases when destination exists</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cnauroth">Chris Nauroth</assignee>
                                    <reporter username="mostafae">Mostafa Elhemali</reporter>
                        <labels>
                    </labels>
                <created>Thu, 25 Apr 2013 21:53:31 +0000</created>
                <updated>Thu, 12 May 2016 18:22:04 +0000</updated>
                            <resolved>Fri, 26 Jul 2013 21:17:42 +0000</resolved>
                                    <version>1-win</version>
                    <version>2.1.0-beta</version>
                    <version>1.3.0</version>
                    <version>3.0.0-alpha1</version>
                                    <fixVersion>1-win</fixVersion>
                    <fixVersion>2.1.0-beta</fixVersion>
                    <fixVersion>1.3.0</fixVersion>
                                    <component>fs</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="13642297" author="mostafae" created="Thu, 25 Apr 2013 22:16:23 +0000"  >&lt;p&gt;Patch based on branch-1-win is attached. I believe this bug exists in branch-1 and trunk as well, but I haven&apos;t tested that.&lt;/p&gt;</comment>
                            <comment id="13642894" author="daryn" created="Fri, 26 Apr 2013 14:32:51 +0000"  >&lt;p&gt;It is correct behavior for moving /foo to /bar to produce /foo/bar.  Mv mimics the unix shell.&lt;/p&gt;</comment>
                            <comment id="13643020" author="mostafae" created="Fri, 26 Apr 2013 16:48:38 +0000"  >&lt;p&gt;Daryn: please read the repro and result more carefully. mv /foo /bar doesn&apos;t produce /foo/bar, it produces /bar with wrong contents in there (/X/X instead of /X); at least on Windows in branch-1-win (again, haven&apos;t tried in other branches).&lt;/p&gt;</comment>
                            <comment id="13718809" author="cnauroth" created="Wed, 24 Jul 2013 20:51:45 +0000"  >&lt;p&gt;I&apos;m about to post some patches that resolve this and also some other cases.  I&apos;m pasting a comment I originally entered on &lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-9767&quot; title=&quot;RawLocalFileSystem#rename does not correctly enforce replacement of empty destination directory on all platforms&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-9767&quot;&gt;&lt;del&gt;HADOOP-9767&lt;/del&gt;&lt;/a&gt; that explains the root cause:&lt;/p&gt;

&lt;p&gt;POSIX rename semantics state that renaming a source directory to an existing destination directory that is empty will act as a full replacement of that existing destination. RawLocalFileSystem#rename calls Java&apos;s File#renameTo, which provides these semantics on most platforms. On some platforms (notably Windows), File#renameTo does not provide this behavior. This causes problems for MapReduce and other downstream components like Hive, HCatalog, and Sqoop that depend on the replacement behavior.&lt;/p&gt;</comment>
                            <comment id="13718811" author="cnauroth" created="Wed, 24 Jul 2013 20:56:58 +0000"  >&lt;p&gt;I&apos;ve attached patches for trunk, branch-1, and branch-1-win.  The branch-1-win patch is slightly different, because there had been a prior attempt to fix this issue on that branch, but it wasn&apos;t quite correct.&lt;/p&gt;

&lt;p&gt;I&apos;ve successfully tested these patches on Mac, Linux, and Windows.&lt;/p&gt;</comment>
                            <comment id="13718822" author="chuanliu" created="Wed, 24 Jul 2013 21:03:43 +0000"  >&lt;p&gt;+1&lt;/p&gt;

&lt;p&gt;Thanks for the detailed analysis, Chris!&lt;br/&gt;
I don&apos;t remember the subtle differences of File#renameTo() on Windows and Linux.&lt;br/&gt;
I verified the differences in renaming behavior, and agree with your fix.&lt;/p&gt;</comment>
                            <comment id="13718852" author="hadoopqa" created="Wed, 24 Jul 2013 21:29:35 +0000"  >&lt;p&gt;&lt;font color=&quot;red&quot;&gt;-1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12594027/HADOOP-9507-trunk.1.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12594027/HADOOP-9507-trunk.1.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 tests included&lt;/font&gt;.  The patch appears to include 1 new or modified test files.&lt;/p&gt;

&lt;p&gt;      &lt;font color=&quot;red&quot;&gt;-1 javac&lt;/font&gt;.  The applied patch generated 1152 javac compiler warnings (more than the trunk&apos;s current 1151 warnings).&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javadoc&lt;/font&gt;.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 eclipse:eclipse&lt;/font&gt;.  The patch built with eclipse:eclipse.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 findbugs&lt;/font&gt;.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 release audit&lt;/font&gt;.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 core tests&lt;/font&gt;.  The patch passed unit tests in hadoop-common-project/hadoop-common.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 contrib tests&lt;/font&gt;.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/2838//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/2838//testReport/&lt;/a&gt;&lt;br/&gt;
Javac warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/2838//artifact/trunk/patchprocess/diffJavacWarnings.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/2838//artifact/trunk/patchprocess/diffJavacWarnings.txt&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/2838//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/2838//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13718965" author="mostafae" created="Wed, 24 Jul 2013 22:51:58 +0000"  >&lt;p&gt;Thanks Chris - +1.&lt;/p&gt;</comment>
                            <comment id="13719070" author="cnauroth" created="Thu, 25 Jul 2013 00:11:59 +0000"  >&lt;p&gt;I&apos;m uploading version 2 of the trunk patch to fix the javac deprecation warning.  Here is the incremental diff:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;diff --git hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/fs/RawLocalFileSystem.java hadoop-common-projec
index 2ee6c70..6b45fe3 100644
--- hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/fs/RawLocalFileSystem.java
+++ hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/fs/RawLocalFileSystem.java
@@ -332,7 +332,7 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; rename(Path src, Path dst) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
     &lt;span class=&quot;code-comment&quot;&gt;// fails.  Copy source content to destination and delete source.
&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.exists(dst)) {
       FileStatus sdst = &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.getFileStatus(dst);
-      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (sdst.isDir() &amp;amp;&amp;amp; dstFile.list().length == 0) {
+      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (sdst.isDirectory() &amp;amp;&amp;amp; dstFile.list().length == 0) {
         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (LOG.isDebugEnabled()) {
           LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Copying contents of &quot;&lt;/span&gt; + src + &lt;span class=&quot;code-quote&quot;&gt;&quot; to &quot;&lt;/span&gt; + dst);
         }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;On branch-1, we don&apos;t have &lt;tt&gt;FileStatus#isDirectory&lt;/tt&gt;, and &lt;tt&gt;FileStatus#isDir&lt;/tt&gt; is not deprecated.  Therefore, we don&apos;t need to update the branch-1 and branch-1-win patches.&lt;/p&gt;</comment>
                            <comment id="13719116" author="hadoopqa" created="Thu, 25 Jul 2013 00:50:13 +0000"  >&lt;p&gt;&lt;font color=&quot;green&quot;&gt;+1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12594069/HADOOP-9507-trunk.2.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12594069/HADOOP-9507-trunk.2.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 tests included&lt;/font&gt;.  The patch appears to include 1 new or modified test files.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javadoc&lt;/font&gt;.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 eclipse:eclipse&lt;/font&gt;.  The patch built with eclipse:eclipse.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 findbugs&lt;/font&gt;.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 release audit&lt;/font&gt;.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 core tests&lt;/font&gt;.  The patch passed unit tests in hadoop-common-project/hadoop-common.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 contrib tests&lt;/font&gt;.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/2841//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/2841//testReport/&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/2841//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/2841//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13719326" author="szetszwo" created="Thu, 25 Jul 2013 07:26:07 +0000"  >&lt;p&gt;If we use copy, it may unnecessarily copy a large amount of data.  Why not first delete the empty dst directory and then rename the src directory?  Or moving the children from src to dst.  Not sure if these two methods would work in windows.&lt;/p&gt;</comment>
                            <comment id="13719790" author="cnauroth" created="Thu, 25 Jul 2013 17:18:32 +0000"  >&lt;p&gt;Thanks, Nicholas.  I&apos;m uploading version 3 of the patch for all branches to delete destination and then reattempt renaming source to destination.  This implementation still passes all of my tests, including on Windows.  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chuanliu&quot; class=&quot;user-hover&quot; rel=&quot;chuanliu&quot;&gt;chuanliu&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mostafae&quot; class=&quot;user-hover&quot; rel=&quot;mostafae&quot;&gt;mostafae&lt;/a&gt;, do you think this technique looks OK for Windows?&lt;/p&gt;</comment>
                            <comment id="13719839" author="hadoopqa" created="Thu, 25 Jul 2013 17:57:54 +0000"  >&lt;p&gt;&lt;font color=&quot;red&quot;&gt;-1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12594210/HADOOP-9507-trunk.3.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12594210/HADOOP-9507-trunk.3.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 tests included&lt;/font&gt;.  The patch appears to include 1 new or modified test files.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javadoc&lt;/font&gt;.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 eclipse:eclipse&lt;/font&gt;.  The patch built with eclipse:eclipse.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 findbugs&lt;/font&gt;.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 release audit&lt;/font&gt;.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 core tests&lt;/font&gt;.  The patch failed these unit tests in hadoop-common-project/hadoop-common:&lt;/p&gt;

&lt;p&gt;                  org.apache.hadoop.util.TestLightWeightCache&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 contrib tests&lt;/font&gt;.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/2846//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/2846//testReport/&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/2846//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/2846//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13719852" author="cnauroth" created="Thu, 25 Jul 2013 18:06:05 +0000"  >&lt;blockquote&gt;
&lt;p&gt;-1 core tests. The patch failed these unit tests in hadoop-common-project/hadoop-common:&lt;br/&gt;
org.apache.hadoop.util.TestLightWeightCache&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This test doesn&apos;t perform any file access, so the failure must be unrelated to this patch.&lt;/p&gt;</comment>
                            <comment id="13719972" author="chuanliu" created="Thu, 25 Jul 2013 19:46:31 +0000"  >&lt;p&gt;+1&lt;/p&gt;

&lt;p&gt;The new changes look good to me!&lt;/p&gt;</comment>
                            <comment id="13719978" author="mostafae" created="Thu, 25 Jul 2013 19:49:36 +0000"  >&lt;p&gt;I don&apos;t know if this new approach would work if the destination is on a separate drive - can you check?&lt;/p&gt;</comment>
                            <comment id="13719993" author="cnauroth" created="Thu, 25 Jul 2013 20:10:15 +0000"  >&lt;blockquote&gt;
&lt;p&gt;I don&apos;t know if this new approach would work if the destination is on a separate drive - can you check?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Thanks for catching this, Mostafa.  That&apos;s a good point.  No, &lt;tt&gt;java.io.File#renameTo&lt;/tt&gt; fails when attempting to rename from one drive to another.  Likewise on Linux, you can&apos;t cross different file systems.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=szetszwo&quot; class=&quot;user-hover&quot; rel=&quot;szetszwo&quot;&gt;szetszwo&lt;/a&gt;, I think we need to go with the prior version of the patch that does copying.  Does that sound OK to commit?&lt;/p&gt;

&lt;p&gt;After we fully migrate to Java 7, we can come back and do an optimization to check if source and destination are on the same file system, and then use delete/rename.  This can only be done with the new Java 7 file APIs, so we can&apos;t do it right now while we&apos;re still supporting Java 6.&lt;/p&gt;</comment>
                            <comment id="13720075" author="cnauroth" created="Thu, 25 Jul 2013 21:18:53 +0000"  >&lt;p&gt;Also, just so this is clear, the patch will not cause copying when run on Linux, because on Linux, the first &lt;tt&gt;java.io.File#renameTo&lt;/tt&gt; succeeds, and the method exits early.  This patch just provides fallback behavior for platforms where &lt;tt&gt;java.io.File#renameTo&lt;/tt&gt; doesn&apos;t exactly match POSIX semantics.&lt;/p&gt;</comment>
                            <comment id="13720153" author="arpitagarwal" created="Thu, 25 Jul 2013 22:33:40 +0000"  >&lt;p&gt;Chris and I discussed this offline. v3 of the patch is the better alternative. It is closest to the existing behavior on non-Windows platforms while avoiding the extra copy on Windows except for cross-volume renames.&lt;/p&gt;

&lt;p&gt;Regarding the v3 trunk patch (9507-trunk.3.patch):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;+        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.delete(dst, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) &amp;amp;&amp;amp; srcFile.renameTo(dstFile)) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The recurse flag to delete should be false since we only want to remove an empty directory.&lt;/p&gt;

&lt;p&gt;I verified that the new tests pass with this patch. +1 with the above change.&lt;/p&gt;</comment>
                            <comment id="13720155" author="szetszwo" created="Thu, 25 Jul 2013 22:35:49 +0000"  >&lt;p&gt;&amp;gt; ... I think we need to go with the prior version of the patch that does copying. ...&lt;/p&gt;

&lt;p&gt;Does &lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-9507&quot; title=&quot;LocalFileSystem rename() is broken in some cases when destination exists&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-9507&quot;&gt;&lt;del&gt;HADOOP-9507&lt;/del&gt;&lt;/a&gt;-trunk.3.patch work of separated drives?  The approach in it seems the best.  It first tries (1) rename, then (2) delete &amp;amp; rename for copying src dir to empty dst dir, and finally (3) copy.  If yes, +1 on the patch.  If it does not work for separated drives, I am fine to commit the prior version, +1 on that patch too.  Thanks for checking it.&lt;/p&gt;

&lt;p&gt;I will take a look at TestLightWeightCache.  It definitely is not related to this.&lt;/p&gt;</comment>
                            <comment id="13720163" author="cnauroth" created="Thu, 25 Jul 2013 22:42:32 +0000"  >&lt;blockquote&gt;
&lt;p&gt;It is closest to the existing behavior on non-Windows platforms&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Just to elaborate on this a bit, talking with Arpit made me realize that version 2 of the patch (copy-delete) would have accidentally introduced new behavior on Linux.  Currently on Linux, a rename crossing file systems would fail in &lt;tt&gt;File#renameTo&lt;/tt&gt; and then fall through to &lt;tt&gt;FileUtil#copy&lt;/tt&gt;.  In version 2, we would instead trigger the copy-delete logic, which would have a different result.&lt;/p&gt;

&lt;p&gt;The goal of this issue was to provide a match to this method&apos;s existing behavior on platforms where &lt;tt&gt;File#renameTo&lt;/tt&gt; behaves differently, like Windows.  Therefore, I&apos;m now in favor of version 3 of the patch (delete-rename), not only for performance but also for correctness.&lt;/p&gt;

&lt;p&gt;I&apos;ll provide new patches shortly to address Arpit&apos;s final comment.&lt;/p&gt;</comment>
                            <comment id="13720208" author="cnauroth" created="Thu, 25 Jul 2013 23:12:18 +0000"  >&lt;p&gt;I&apos;m uploading version 4 of the patch for all branches.  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=szetszwo&quot; class=&quot;user-hover&quot; rel=&quot;szetszwo&quot;&gt;szetszwo&lt;/a&gt;, are you still +1 after this small change suggested by Arpit?&lt;/p&gt;</comment>
                            <comment id="13720265" author="hadoopqa" created="Thu, 25 Jul 2013 23:58:47 +0000"  >&lt;p&gt;&lt;font color=&quot;red&quot;&gt;-1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12594289/HADOOP-9507-trunk.4.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12594289/HADOOP-9507-trunk.4.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 tests included&lt;/font&gt;.  The patch appears to include 1 new or modified test files.&lt;/p&gt;

&lt;p&gt;      &lt;font color=&quot;red&quot;&gt;-1 javac&lt;/font&gt;.  The applied patch generated 1152 javac compiler warnings (more than the trunk&apos;s current 1151 warnings).&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javadoc&lt;/font&gt;.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 eclipse:eclipse&lt;/font&gt;.  The patch built with eclipse:eclipse.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 findbugs&lt;/font&gt;.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 release audit&lt;/font&gt;.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 core tests&lt;/font&gt;.  The patch passed unit tests in hadoop-common-project/hadoop-common.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 contrib tests&lt;/font&gt;.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/2849//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/2849//testReport/&lt;/a&gt;&lt;br/&gt;
Javac warnings: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/2849//artifact/trunk/patchprocess/diffJavacWarnings.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/2849//artifact/trunk/patchprocess/diffJavacWarnings.txt&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/2849//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/2849//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13720275" author="cnauroth" created="Fri, 26 Jul 2013 00:08:38 +0000"  >&lt;p&gt;Actually, version 5 is the correct patch for all branches.  I corrected a mistake in my call to non-recursive delete.&lt;/p&gt;</comment>
                            <comment id="13720294" author="arpitagarwal" created="Fri, 26 Jul 2013 00:31:33 +0000"  >&lt;p&gt;Thanks for fixing the recursive delete!&lt;/p&gt;

&lt;p&gt;+1 for v5 versions of trunk, branch-1 and branch-1-win patches. I verified all three patches on Windows and OSX, as applicable.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;version 2 of the patch (copy-delete) would have accidentally introduced new behavior on Linux. Currently on Linux, a rename crossing file systems would fail in File#renameTo and then fall through to FileUtil#copy. In version 2, we would instead trigger the copy-delete logic, which would have a different result.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Good point, another reason for going with the delete+rename approach for the empty target directory.&lt;/p&gt;</comment>
                            <comment id="13720303" author="hadoopqa" created="Fri, 26 Jul 2013 00:47:43 +0000"  >&lt;p&gt;&lt;font color=&quot;green&quot;&gt;+1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12594299/HADOOP-9507-trunk.5.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12594299/HADOOP-9507-trunk.5.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision .&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 tests included&lt;/font&gt;.  The patch appears to include 1 new or modified test files.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javadoc&lt;/font&gt;.  The javadoc tool did not generate any warning messages.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 eclipse:eclipse&lt;/font&gt;.  The patch built with eclipse:eclipse.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 findbugs&lt;/font&gt;.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 release audit&lt;/font&gt;.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 core tests&lt;/font&gt;.  The patch passed unit tests in hadoop-common-project/hadoop-common.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 contrib tests&lt;/font&gt;.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/2850//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/2850//testReport/&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/2850//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/2850//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="13720955" author="cnauroth" created="Fri, 26 Jul 2013 16:58:06 +0000"  >&lt;p&gt;Thank you, everyone, for the great code reviews on this patch.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=szetszwo&quot; class=&quot;user-hover&quot; rel=&quot;szetszwo&quot;&gt;szetszwo&lt;/a&gt;, are you still +1 for the patch with the change suggested by Arpit to use non-recursive delete?  If so, then I&apos;d like to commit today.  It&apos;s a one-line change since last time (see incremental diff below).  Thanks!&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;diff --git hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/fs/RawLocalFileSystem.java hadoop-common-projec
index 2553880..dbe29a2 100644
--- hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/fs/RawLocalFileSystem.java
+++ hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/fs/RawLocalFileSystem.java
@@ -338,7 +338,7 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; rename(Path src, Path dst) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
           LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Deleting empty destination and renaming &quot;&lt;/span&gt; + src + &lt;span class=&quot;code-quote&quot;&gt;&quot; to &quot;&lt;/span&gt; +
             dst);
         }
-        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.delete(dst, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) &amp;amp;&amp;amp; srcFile.renameTo(dstFile)) {
+        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.delete(dst, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;) &amp;amp;&amp;amp; srcFile.renameTo(dstFile)) {
           &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
         }
       }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13720980" author="mostafae" created="Fri, 26 Jul 2013 17:37:55 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cnauroth&quot; class=&quot;user-hover&quot; rel=&quot;cnauroth&quot;&gt;cnauroth&lt;/a&gt;, +1 from my side.&lt;/p&gt;</comment>
                            <comment id="13721165" author="szetszwo" created="Fri, 26 Jul 2013 20:16:57 +0000"  >&lt;p&gt;+1 the latest patch looks good.  Thanks.&lt;/p&gt;</comment>
                            <comment id="13721219" author="cnauroth" created="Fri, 26 Jul 2013 21:17:42 +0000"  >&lt;p&gt;I&apos;ve committed this to trunk, branch-2, branch-2.1-beta, branch-1, and branch-1-win.  Thank you to Chuan, Mostafa, Arpit, and Nicholas for the excellent code review feedback!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12659650">HADOOP-9767</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                                                <inwardlinks description="is part of">
                                        <issuelink>
            <issuekey id="12601303">HADOOP-8645</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12660943">HADOOP-9805</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12594025" name="HADOOP-9507-branch-1-win.1.patch" size="6688" author="cnauroth" created="Wed, 24 Jul 2013 20:53:35 +0000"/>
                            <attachment id="12594208" name="HADOOP-9507-branch-1-win.3.patch" size="6833" author="cnauroth" created="Thu, 25 Jul 2013 17:16:18 +0000"/>
                            <attachment id="12594287" name="HADOOP-9507-branch-1-win.4.patch" size="6797" author="cnauroth" created="Thu, 25 Jul 2013 23:11:16 +0000"/>
                            <attachment id="12594297" name="HADOOP-9507-branch-1-win.5.patch" size="6834" author="cnauroth" created="Fri, 26 Jul 2013 00:07:44 +0000"/>
                            <attachment id="12594026" name="HADOOP-9507-branch-1.1.patch" size="6358" author="cnauroth" created="Wed, 24 Jul 2013 20:53:49 +0000"/>
                            <attachment id="12594209" name="HADOOP-9507-branch-1.3.patch" size="6203" author="cnauroth" created="Thu, 25 Jul 2013 17:16:18 +0000"/>
                            <attachment id="12594288" name="HADOOP-9507-branch-1.4.patch" size="6147" author="cnauroth" created="Thu, 25 Jul 2013 23:11:16 +0000"/>
                            <attachment id="12594298" name="HADOOP-9507-branch-1.5.patch" size="6204" author="cnauroth" created="Fri, 26 Jul 2013 00:07:44 +0000"/>
                            <attachment id="12594027" name="HADOOP-9507-trunk.1.patch" size="5285" author="cnauroth" created="Wed, 24 Jul 2013 20:56:58 +0000"/>
                            <attachment id="12594069" name="HADOOP-9507-trunk.2.patch" size="5291" author="cnauroth" created="Thu, 25 Jul 2013 00:11:59 +0000"/>
                            <attachment id="12594210" name="HADOOP-9507-trunk.3.patch" size="5136" author="cnauroth" created="Thu, 25 Jul 2013 17:18:32 +0000"/>
                            <attachment id="12594289" name="HADOOP-9507-trunk.4.patch" size="5079" author="cnauroth" created="Thu, 25 Jul 2013 23:12:18 +0000"/>
                            <attachment id="12594299" name="HADOOP-9507-trunk.5.patch" size="5137" author="cnauroth" created="Fri, 26 Jul 2013 00:08:38 +0000"/>
                            <attachment id="12580604" name="HADOOP-9507.branch-1-win.patch" size="7399" author="mostafae" created="Thu, 25 Apr 2013 22:17:11 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>14.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>325099</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 17 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1k367:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>325444</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12320361">1-win</customfieldvalue>
    <customfieldvalue id="12324030">2.1.0-beta</customfieldvalue>
    <customfieldvalue id="12324327">1.3.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>