<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:55:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HADOOP-15819] S3A integration test failures: FileSystem is closed! - without parallel test run</title>
                <link>https://issues.apache.org/jira/browse/HADOOP-15819</link>
                <project id="12310240" key="HADOOP">Hadoop Common</project>
                    <description>&lt;p&gt;Running the integration tests for hadoop-aws &lt;tt&gt;mvn -Dscale verify&lt;/tt&gt; against Amazon AWS S3 (eu-west-1, us-west-1, with no s3guard) we see a lot of these failures:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[ERROR] Tests run: 1, Failures: 0, Errors: 1, Skipped: 0, Time elapsed: 4.408 s &amp;lt;&amp;lt;&amp;lt; FAILURE! - in org.apache.hadoop.fs.s3a.commit.staging.integration.ITDirectoryCommitMRJob
[ERROR] testMRJob(org.apache.hadoop.fs.s3a.commit.staging.integration.ITDirectoryCommitMRJob)  Time elapsed: 0.027 s  &amp;lt;&amp;lt;&amp;lt; ERROR!
java.io.IOException: s3a://cloudera-dev-gabor-ireland: FileSystem is closed!

[ERROR] Tests run: 2, Failures: 0, Errors: 2, Skipped: 0, Time elapsed: 4.345 s &amp;lt;&amp;lt;&amp;lt; FAILURE! - in org.apache.hadoop.fs.s3a.commit.staging.integration.ITStagingCommitMRJob
[ERROR] testStagingDirectory(org.apache.hadoop.fs.s3a.commit.staging.integration.ITStagingCommitMRJob)  Time elapsed: 0.021 s  &amp;lt;&amp;lt;&amp;lt; ERROR!
java.io.IOException: s3a://cloudera-dev-gabor-ireland: FileSystem is closed!

[ERROR] testMRJob(org.apache.hadoop.fs.s3a.commit.staging.integration.ITStagingCommitMRJob)  Time elapsed: 0.022 s  &amp;lt;&amp;lt;&amp;lt; ERROR!
java.io.IOException: s3a://cloudera-dev-gabor-ireland: FileSystem is closed!

[ERROR] Tests run: 1, Failures: 0, Errors: 1, Skipped: 0, Time elapsed: 4.489 s &amp;lt;&amp;lt;&amp;lt; FAILURE! - in org.apache.hadoop.fs.s3a.commit.staging.integration.ITStagingCommitMRJobBadDest
[ERROR] testMRJob(org.apache.hadoop.fs.s3a.commit.staging.integration.ITStagingCommitMRJobBadDest)  Time elapsed: 0.023 s  &amp;lt;&amp;lt;&amp;lt; ERROR!
java.io.IOException: s3a://cloudera-dev-gabor-ireland: FileSystem is closed!

[ERROR] Tests run: 1, Failures: 0, Errors: 1, Skipped: 0, Time elapsed: 4.695 s &amp;lt;&amp;lt;&amp;lt; FAILURE! - in org.apache.hadoop.fs.s3a.commit.magic.ITMagicCommitMRJob
[ERROR] testMRJob(org.apache.hadoop.fs.s3a.commit.magic.ITMagicCommitMRJob)  Time elapsed: 0.039 s  &amp;lt;&amp;lt;&amp;lt; ERROR!
java.io.IOException: s3a://cloudera-dev-gabor-ireland: FileSystem is closed!

[ERROR] Tests run: 1, Failures: 0, Errors: 1, Skipped: 0, Time elapsed: 0.015 s &amp;lt;&amp;lt;&amp;lt; FAILURE! - in org.apache.hadoop.fs.s3a.commit.ITestS3ACommitterFactory
[ERROR] testEverything(org.apache.hadoop.fs.s3a.commit.ITestS3ACommitterFactory)  Time elapsed: 0.014 s  &amp;lt;&amp;lt;&amp;lt; ERROR!
java.io.IOException: s3a://cloudera-dev-gabor-ireland: FileSystem is closed!
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The big issue is that the tests are running in a serial manner - no test is running on top of the other - so we should not see that the tests are failing like this. The issue could be in how we handle org.apache.hadoop.fs.FileSystem#CACHE - the tests should use the same S3AFileSystem so if A test uses a FileSystem and closes it in teardown then B test will get the same FileSystem object from the cache and try to use it, but it is closed.&lt;/p&gt;

&lt;p&gt;We see this a lot in our downstream testing too. It&apos;s not possible to tell that the failed regression test result is an implementation issue in the runtime code or a test implementation problem. &lt;br/&gt;
I&apos;ve checked when and what closes the S3AFileSystem with a sightly modified version of S3AFileSystem which logs the closers of the fs if an error should occur. I&apos;ll attach this modified java file for reference. See the next example of the result when it&apos;s running:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2018-10-04 00:52:25,596 [Thread-4201] ERROR s3a.S3ACloseEnforcedFileSystem (S3ACloseEnforcedFileSystem.java:checkIfClosed(74)) - Use after close(): 
java.lang.RuntimeException: Using closed FS!.
	at org.apache.hadoop.fs.s3a.S3ACloseEnforcedFileSystem.checkIfClosed(S3ACloseEnforcedFileSystem.java:73)
	at org.apache.hadoop.fs.s3a.S3ACloseEnforcedFileSystem.mkdirs(S3ACloseEnforcedFileSystem.java:474)
	at org.apache.hadoop.fs.contract.AbstractFSContractTestBase.mkdirs(AbstractFSContractTestBase.java:338)
	at org.apache.hadoop.fs.contract.AbstractFSContractTestBase.setup(AbstractFSContractTestBase.java:193)
	at org.apache.hadoop.fs.s3a.ITestS3AClosedFS.setup(ITestS3AClosedFS.java:40)
	at sun.reflect.GeneratedMethodAccessor22.invoke(Unknown Source)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:498)
	at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:47)
	at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)
	at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:44)
	at org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:24)
	at org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:27)
	at org.junit.rules.TestWatcher$1.evaluate(TestWatcher.java:55)
	at org.junit.internal.runners.statements.FailOnTimeout$StatementThread.run(FailOnTimeout.java:74)
2018-10-04 00:52:25,596 [Thread-4201] WARN  s3a.S3ACloseEnforcedFileSystem (S3ACloseEnforcedFileSystem.java:logClosers(61)) - FS was closed 6 times by:
2018-10-04 00:52:25,596 [Thread-4201] WARN  s3a.S3ACloseEnforcedFileSystem (S3ACloseEnforcedFileSystem.java:logClosers(64)) - ----------------- close() #1 ---------------
2018-10-04 00:52:25,596 [Thread-4201] WARN  s3a.S3ACloseEnforcedFileSystem (S3ACloseEnforcedFileSystem.java:logClosers(65)) - java.lang.RuntimeException: close() called here
	at org.apache.hadoop.fs.s3a.S3ACloseEnforcedFileSystem.close(S3ACloseEnforcedFileSystem.java:83)
	at org.apache.hadoop.io.IOUtils.cleanupWithLogger(IOUtils.java:280)
	at org.apache.hadoop.io.IOUtils.closeStream(IOUtils.java:298)
	at org.apache.hadoop.fs.s3a.AbstractS3ATestBase.teardown(AbstractS3ATestBase.java:55)
	at org.apache.hadoop.fs.s3a.commit.AbstractCommitITest.teardown(AbstractCommitITest.java:206)
	at org.apache.hadoop.fs.s3a.auth.ITestAssumedRoleCommitOperations.teardown(ITestAssumedRoleCommitOperations.java:90)
	at sun.reflect.GeneratedMethodAccessor23.invoke(Unknown Source)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:498)
	at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:47)
	at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)
	at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:44)
	at org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:33)
	at org.junit.rules.TestWatcher$1.evaluate(TestWatcher.java:55)
	at org.junit.internal.runners.statements.FailOnTimeout$StatementThread.run(FailOnTimeout.java:74)

2018-10-04 00:52:25,596 [Thread-4201] WARN  s3a.S3ACloseEnforcedFileSystem (S3ACloseEnforcedFileSystem.java:logClosers(64)) - ----------------- close() #2 ---------------
2018-10-04 00:52:25,596 [Thread-4201] WARN  s3a.S3ACloseEnforcedFileSystem (S3ACloseEnforcedFileSystem.java:logClosers(65)) - java.lang.RuntimeException: close() called here
	at org.apache.hadoop.fs.s3a.S3ACloseEnforcedFileSystem.close(S3ACloseEnforcedFileSystem.java:83)
	at org.apache.hadoop.io.IOUtils.cleanupWithLogger(IOUtils.java:280)
	at org.apache.hadoop.io.IOUtils.closeStream(IOUtils.java:298)
	at org.apache.hadoop.fs.s3a.AbstractS3ATestBase.teardown(AbstractS3ATestBase.java:55)
	at sun.reflect.GeneratedMethodAccessor23.invoke(Unknown Source)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:498)
	at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:47)
	at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)
	at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:44)
	at org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:33)
	at org.junit.rules.TestWatcher$1.evaluate(TestWatcher.java:55)
	at org.junit.internal.runners.statements.FailOnTimeout$StatementThread.run(FailOnTimeout.java:74)

2018-10-04 00:52:25,597 [Thread-4201] WARN  s3a.S3ACloseEnforcedFileSystem (S3ACloseEnforcedFileSystem.java:logClosers(64)) - ----------------- close() #3 ---------------
2018-10-04 00:52:25,598 [Thread-4201] WARN  s3a.S3ACloseEnforcedFileSystem (S3ACloseEnforcedFileSystem.java:logClosers(65)) - java.lang.RuntimeException: close() called here
	at org.apache.hadoop.fs.s3a.S3ACloseEnforcedFileSystem.close(S3ACloseEnforcedFileSystem.java:83)
	at org.apache.hadoop.io.IOUtils.cleanupWithLogger(IOUtils.java:280)
	at org.apache.hadoop.io.IOUtils.closeStream(IOUtils.java:298)
	at org.apache.hadoop.fs.s3a.AbstractS3ATestBase.teardown(AbstractS3ATestBase.java:55)
	at sun.reflect.GeneratedMethodAccessor23.invoke(Unknown Source)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:498)
	at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:47)
	at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)
	at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:44)
	at org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:33)
	at org.junit.rules.TestWatcher$1.evaluate(TestWatcher.java:55)
	at org.junit.internal.runners.statements.FailOnTimeout$StatementThread.run(FailOnTimeout.java:74)
(...)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;From the logs it seems that the closers are the teardown methods of the abstract test classes, so the same FileSystem object gets reused between tests.&lt;/p&gt;


&lt;p&gt;To run a test with the modified fs the following should be in the config:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&amp;lt;property&amp;gt;
  &amp;lt;name&amp;gt;fs.s3a.impl&amp;lt;/name&amp;gt;
  &amp;lt;value&amp;gt;org.apache.hadoop.fs.s3a.S3ACloseEnforcedFileSystem&amp;lt;/value&amp;gt;
  &amp;lt;description&amp;gt;The implementation class of the S3A Filesystem&amp;lt;/description&amp;gt;
&amp;lt;/property&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I file this jira to solve this issue, and start a conversation if needed.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13189417">HADOOP-15819</key>
            <summary>S3A integration test failures: FileSystem is closed! - without parallel test run</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="adam.antal">Adam Antal</assignee>
                                    <reporter username="gabor.bota">Gabor Bota</reporter>
                        <labels>
                    </labels>
                <created>Thu, 4 Oct 2018 12:38:55 +0000</created>
                <updated>Fri, 4 Jan 2019 13:45:19 +0000</updated>
                            <resolved>Thu, 27 Dec 2018 15:54:08 +0000</resolved>
                                    <version>3.1.1</version>
                                                    <component>fs/s3</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="16638286" author="stevel@apache.org" created="Thu, 4 Oct 2018 14:26:27 +0000"  >&lt;p&gt;I see. &lt;br/&gt;
we could find those FS.close() calls and only invoke them if the FS is known to be not-shared? e.g fs.getConf().get(&quot;whatever-that-shraed-property-is&quot;) to guard the call&lt;/p&gt;</comment>
                            <comment id="16638306" author="gabor.bota" created="Thu, 4 Oct 2018 14:39:32 +0000"  >&lt;p&gt;From that perspective, every test could use the same instance one after another - the only way to tell that the fs is not shared is when fs caching is forced off with &lt;tt&gt;S3ATestUtils.disableFilesystemCaching(configuration);&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16638351" author="gabor.bota" created="Thu, 4 Oct 2018 15:04:19 +0000"  >&lt;p&gt;So that&apos;s &lt;tt&gt;fs.s3a.impl.disable.cache&lt;/tt&gt; (S3ATestConstants#FS_S3A_IMPL_DISABLE_CACHE) set to false, and that&apos;s when we want to close the fs. Otherwise just keep it open?&lt;/p&gt;</comment>
                            <comment id="16643742" author="gabor.bota" created="Tue, 9 Oct 2018 17:05:29 +0000"  >&lt;p&gt;If I remove &lt;tt&gt;IOUtils.closeStream(getFileSystem());&lt;/tt&gt; from org/apache/hadoop/fs/s3a/AbstractS3ATestBase.java:55, it fixes the issue.&lt;br/&gt;
So the teardown would be &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  @Override
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void teardown() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.teardown();
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;instead of &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  @Override
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void teardown() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.teardown();
    describe(&lt;span class=&quot;code-quote&quot;&gt;&quot;closing file system&quot;&lt;/span&gt;);
    IOUtils.closeStream(getFileSystem());
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;so even we could skip the override. We could even do something like &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  @Override
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void teardown() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.teardown();
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(getConfiguration().getBoolean(FS_S3A_IMPL_DISABLE_CACHE, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)){
      describe(&lt;span class=&quot;code-quote&quot;&gt;&quot;closing file system&quot;&lt;/span&gt;);
      IOUtils.closeStream(getFileSystem());
    }
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;but I was still getting some &lt;tt&gt;FileSystem is closed!&lt;/tt&gt; when I used that method for closing the fs.&lt;/p&gt;

&lt;p&gt;I wanted to get to the bottom of this, so checked how fs caching works in general. We have a static fs cache in org.apache.hadoop.fs.FileSystem, that we use for cache fs instances. If we don&apos;t have an fs instance for the schema provided (e.g s3a://) we create a new instance and store it in the static cache - &quot;If this is the first entry in the map and the JVM is not shutting down this registers a shutdown hook to close filesystems, and adds this FS to the toAutoClose if &apos;&lt;tt&gt;fs.automatic.close&lt;/tt&gt;&apos; is set in the configuration (default: true).&quot;, so I don&apos;t see why do we have to close it manually between each an every test.&lt;br/&gt;
What&apos;s your opinion on this &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stevel%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;stevel@apache.org&quot;&gt;stevel@apache.org&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="16643749" author="gabor.bota" created="Tue, 9 Oct 2018 17:09:13 +0000"  >&lt;p&gt;Also note: I was getting interesting errors when I removed the line, maybe related that we haven&apos;t closed the fs:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR] Tests run: 9, Failures: 0, Errors: 9, Skipped: 0, Time elapsed: 0.778 s &amp;lt;&amp;lt;&amp;lt; FAILURE! - in org.apache.hadoop
.fs.contract.s3a.ITestS3AContractRootDir
[ERROR] testRecursiveRootListing(org.apache.hadoop.fs.contract.s3a.ITestS3AContractRootDir)  Time elapsed: 0.085 s
 &amp;lt;&amp;lt;&amp;lt; ERROR!
java.lang.IllegalArgumentException: Can not create a Path from an empty string

[ERROR] testRmEmptyRootDirNonRecursive(org.apache.hadoop.fs.contract.s3a.ITestS3AContractRootDir)  Time elapsed: 0.
082 s  &amp;lt;&amp;lt;&amp;lt; ERROR!
java.lang.IllegalArgumentException: Can not create a Path from an empty string

[ERROR] testRmRootRecursive(org.apache.hadoop.fs.contract.s3a.ITestS3AContractRootDir)  Time elapsed: 0.08 s  &amp;lt;&amp;lt;&amp;lt; E
RROR!
java.lang.IllegalArgumentException: Can not create a Path from an empty string

[ERROR] testListEmptyRootDirectory(org.apache.hadoop.fs.contract.s3a.ITestS3AContractRootDir)  Time elapsed: 0.084
s  &amp;lt;&amp;lt;&amp;lt; ERROR!
java.lang.IllegalArgumentException: Can not create a Path from an empty string
        at org.apache.hadoop.fs.contract.s3a.ITestS3AContractRootDir.testListEmptyRootDirectory(ITestS3AContractRoo
tDir.java:63)

[ERROR] testCreateFileOverRoot(org.apache.hadoop.fs.contract.s3a.ITestS3AContractRootDir)  Time elapsed: 0.078 s  &amp;lt;
&amp;lt;&amp;lt; ERROR!
java.lang.IllegalArgumentException: Can not create a Path from an empty string

[ERROR] testSimpleRootListing(org.apache.hadoop.fs.contract.s3a.ITestS3AContractRootDir)  Time elapsed: 0.079 s  &amp;lt;&amp;lt;
&amp;lt; ERROR!
java.lang.IllegalArgumentException: Can not create a Path from an empty string

[ERROR] testMkDirDepth1(org.apache.hadoop.fs.contract.s3a.ITestS3AContractRootDir)  Time elapsed: 0.108 s  &amp;lt;&amp;lt;&amp;lt; ERRO
R!
java.lang.IllegalArgumentException: Can not create a Path from an empty string

[ERROR] testRmEmptyRootDirRecursive(org.apache.hadoop.fs.contract.s3a.ITestS3AContractRootDir)  Time elapsed: 0.083
 s  &amp;lt;&amp;lt;&amp;lt; ERROR!
java.lang.IllegalArgumentException: Can not create a Path from an empty string
(......)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;So there should be another solution to this that won&apos;t break the tests but also won&apos;t cause the &lt;tt&gt;FileSystem is closed!&lt;/tt&gt; issue. Running this test class separately all 9 tests are passing.&lt;br/&gt;
Could we disable the caching just for these test and have them run on a new FS instance?&lt;/p&gt;

&lt;p&gt;(I get other issues as well when running the tests without closing the fs. I think there were many reasons the closing the fs, but I missed the history.)&lt;/p&gt;</comment>
                            <comment id="16643906" author="mackrorysd" created="Tue, 9 Oct 2018 18:23:15 +0000"  >&lt;p&gt;So I think it was mentioned in the other JIRA that each test should be in their own JVM, but if we&apos;re seeing FS&apos;s in one test that were already closed, and we get a stack trace that points to another test, then something isn&apos;t right. Not closing the fs in tests seems like a possible solution, but (a) we need to rule out the possibility that this is a bug in the actual product, and (b) closing the FS does multiple important things and duplicating that everywhere isn&apos;t just a Band-Aid, it&apos;s kind of a messy one.&lt;/p&gt;

&lt;p&gt;The FS cache really feels inherently broken in the parallel tests case, which is why I initially liked the idea of disabling caching for the tests. If you rely on the FileSystem class to either give you an existing instance or create one for you, then we need to rely on it to decide when to close it. Otherwise people either break what other threads are doing or they don&apos;t close their FS instances. Both of those are horrible. Some kind of ref-counting, maybe? But modifying the design of the FS cache scares me, because it&apos;s been that way for a long time and is kind of important. Which raises the question: if I&apos;m seeing this all the time recently but none of us saw it before a little while ago - what broke it? Because I don&apos;t think it was the FS caching. I wonder if git-bisect might be a useful way to get a lead here.&lt;/p&gt;</comment>
                            <comment id="16644730" author="gabor.bota" created="Wed, 10 Oct 2018 09:43:27 +0000"  >&lt;p&gt;I think we should focus on solving this case first, so it would be better not to talk about parallel test cases.&lt;br/&gt;
The FS cache itself could be broken when running parallel tests, but I think it was never prepared to for parallel test run, and that change should be addressed in another issue since it&apos;s an entirely different topic. If we don&apos;t run parallel tests we still have this problem.&lt;/p&gt;

&lt;p&gt;The issue I see right now is that we close the filesystem after each test and I was not able to find another class that does this. I think it&apos;s very specific to AbstractS3ATestBase (so S3A) and it&apos;s 33 implementations. &lt;tt&gt;org.apache.hadoop.fs.s3a.AbstractS3ATestBase#teardown&lt;/tt&gt; is called after each test, because the superclass annotation is &lt;tt&gt;@After&lt;/tt&gt; on the teardown.&lt;/p&gt;

&lt;p&gt;With the current FS cache implementation, another test can get the same FS instance that the previous test closed. It can even happen if the tests running are from the &lt;b&gt;same class&lt;/b&gt;.&lt;/p&gt;</comment>
                            <comment id="16644940" author="stevel@apache.org" created="Wed, 10 Oct 2018 13:11:04 +0000"  >&lt;blockquote&gt;&lt;p&gt;The FS cache really feels inherently broken in the parallel tests case, which is why I initially liked the idea of disabling caching for the tests.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;parallel tests run in their own JVMs,  the main issue there is that you need to be confident that tests aren&apos;t writing to the same local/remote paths.&lt;/p&gt;

&lt;p&gt;At the same time, I&apos;ve seen old test instances get recycled, which makes me thing that the parallel runner fields work out to instantiated test runners as they complete individual test cases. So reuse does happen, it just happens a lot more in sequential runs.&lt;/p&gt;

&lt;p&gt;Tests which want special configs of the FS can&apos;t handle recycled classes, hence the need for  nee filesystems &amp;amp; close after, but I don&apos;t see why other tests should be closing much.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-13131&quot; title=&quot;Add tests to verify that S3A supports SSE-S3 encryption&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-13131&quot;&gt;&lt;del&gt;HADOOP-13131&lt;/del&gt;&lt;/a&gt; added the close, along with &lt;tt&gt;S3ATestUtils.createTestFilesystem()&lt;/tt&gt;, which does create filesystems that need to be closed.&lt;/li&gt;
	&lt;li&gt;But I don&apos;t see that creation happening much, especially given &lt;tt&gt;S3AContract&lt;/tt&gt;&apos;s FS is just from a get().&lt;/li&gt;
	&lt;li&gt;Many tests call &lt;tt&gt;S3ATestUtils.disableFilesystemCaching(conf)&lt;/tt&gt; before FileSystem.get, which guarantees unique instances&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Which makes me think: yes, closing the FS in teardown is overkill except in the special case of &quot;creates a new filesystem() either explicilty or implicitly.&lt;/p&gt;

&lt;p&gt;As &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mackrorysd&quot; class=&quot;user-hover&quot; rel=&quot;mackrorysd&quot;&gt;mackrorysd&lt;/a&gt; says: surprising this hasn&apos;t surfaced before. But to fix it means that it should be done properly.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;IF tests were always closed and new ones created (i.e. no caching), test cases run way, way faster.&lt;/li&gt;
	&lt;li&gt;those tests which do need their own FS instance can close it in teardown, and set it up.&lt;/li&gt;
	&lt;li&gt;And those tests which absolutely must have FS.get() Return their specific filesystem must: (a) enable caching and (b) remove their FS from the cache in teardown (e.g. FileSystem.closeAll)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This is probably going to force a review of all the tests, maybe have some method in AbstractS3ATestBase&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; uniqueFilesystemInstance() { &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;; }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;then &lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;if true, in createConfiguration() call &lt;tt&gt;disableFilesystemCaching&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;if true in teardown: close the FS.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Next:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;go through all uses of the &lt;tt&gt;disableFilesystemCaching&lt;/tt&gt;, and in those tests have &lt;tt&gt;uniqueFilesystemInstance&lt;/tt&gt; return true.&lt;/li&gt;
	&lt;li&gt;Look at uses of  &lt;tt&gt;S3ATestUtils.createTestFilesystem()&lt;/tt&gt; &amp;amp; make sure they are closing this after&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This is going to span all the tests. Joy&lt;/p&gt;


</comment>
                            <comment id="16644973" author="gabor.bota" created="Wed, 10 Oct 2018 13:47:12 +0000"  >&lt;p&gt;I have some bad news: I get these issues for tests where &lt;tt&gt;FS_S3A_IMPL_DISABLE_CACHE&lt;/tt&gt; set to true, so the caching &lt;em&gt;should be&lt;/em&gt; disabled.&lt;/p&gt;

&lt;p&gt;What I did is I modified the &lt;tt&gt;org.apache.hadoop.fs.s3a.AbstractS3ATestBase#teardown&lt;/tt&gt; to&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  @Override
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void teardown() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.teardown();
    &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; fsCacheDisabled = getConfiguration()
        .getBoolean(FS_S3A_IMPL_DISABLE_CACHE, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(fsCacheDisabled){
      describe(&lt;span class=&quot;code-quote&quot;&gt;&quot;closing file system&quot;&lt;/span&gt;);
      LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Closing fs. FS_S3A_IMPL_DISABLE_CACHE: &quot;&lt;/span&gt; + fsCacheDisabled);
      IOUtils.closeStream(getFileSystem());
    }
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And there were still issues after this.&lt;/p&gt;</comment>
                            <comment id="16645064" author="stevel@apache.org" created="Wed, 10 Oct 2018 14:42:17 +0000"  >&lt;p&gt;maybe ask the fs itself, e,g&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (fs!=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
fs.getCacheDisabled = fs.getConfiguration.getBoolean()

|
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Anyway, I think the &quot;allow tests to explicitly declare when they want closing&quot; is better&lt;/p&gt;</comment>
                            <comment id="16700370" author="gabor.bota" created="Tue, 27 Nov 2018 12:48:47 +0000"  >&lt;p&gt;fyi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adam.antal&quot; class=&quot;user-hover&quot; rel=&quot;adam.antal&quot;&gt;adam.antal&lt;/a&gt; I&apos;ve created an issue for the problems when file caching is disabled: &lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-15796&quot; title=&quot;ClassCastException: S3AFileSystem cannot be cast to MockS3AFileSystem when fs caching is disabled&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-15796&quot;&gt;&lt;del&gt;HADOOP-15796&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16700823" author="adam.antal" created="Tue, 27 Nov 2018 18:17:19 +0000"  >&lt;p&gt;I looked through the affected tests, and maybe this comprehensive list can help to escalate this.&lt;br/&gt;
 I used &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gabor.bota&quot; class=&quot;user-hover&quot; rel=&quot;gabor.bota&quot;&gt;gabor.bota&lt;/a&gt;&apos;s patch and the S3ACloseEnforcedFileSystem in it.&lt;br/&gt;
 Only the AbstractS3ATestBase&apos;s subtests are affected, and can be grouped by the following (also grouped further by common superclass):&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Failing tests due to &quot;Using closed FS!&quot; with enabled cache
	&lt;ul&gt;
		&lt;li&gt;ITestS3AInconsistency&lt;/li&gt;
		&lt;li&gt;ITestS3AMiscOperations&lt;/li&gt;
		&lt;li&gt;ITestS3AMiniYarnCluster&lt;/li&gt;
		&lt;li&gt;ITestS3AEmptyDirectory&lt;/li&gt;
		&lt;li&gt;ITestS3GuardEmptyDirs&lt;/li&gt;
		&lt;li&gt;ITestS3ADelayedFNF&lt;/li&gt;
		&lt;li&gt;ITestS3ACopyFromLocalFile&lt;/li&gt;
		&lt;li&gt;ITestS3GuardListConsistency&lt;/li&gt;
		&lt;li&gt;ITestS3AMetrics&lt;/li&gt;
		&lt;li&gt;S3AScaleTestBase
		&lt;ul&gt;
			&lt;li&gt;AbstractITestS3AMetadataStoreScale
			&lt;ul&gt;
				&lt;li&gt;ITestLocalMetadataStoreScale&lt;/li&gt;
				&lt;li&gt;ITestDynamoDBMetadataStoreScale&lt;/li&gt;
			&lt;/ul&gt;
			&lt;/li&gt;
			&lt;li&gt;ITestS3ADeleteManyFiles
			&lt;ul&gt;
				&lt;li&gt;ITestS3ADeleteFilesOneByOne&lt;/li&gt;
			&lt;/ul&gt;
			&lt;/li&gt;
			&lt;li&gt;ITestS3AInputStreamPerformance&lt;/li&gt;
			&lt;li&gt;ITestS3AConcurrentOps&lt;/li&gt;
			&lt;li&gt;ITestS3ADirectoryPerformance&lt;/li&gt;
			&lt;li&gt;ITestS3ACreatePerformance&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
		&lt;li&gt;ITestS3GuardCreate&lt;/li&gt;
		&lt;li&gt;ITestS3GuardWriteBack&lt;/li&gt;
		&lt;li&gt;AbstractS3GuardToolTestBase
		&lt;ul&gt;
			&lt;li&gt;ITestS3GuardToolDynamoDB&lt;/li&gt;
			&lt;li&gt;ITestS3GuardToolLocal&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
		&lt;li&gt;ITestAssumeRole&lt;/li&gt;
		&lt;li&gt;ITestS3GuardConcurrentOps&lt;/li&gt;
		&lt;li&gt;ITestS3AFileOperationCost&lt;/li&gt;
		&lt;li&gt;ITestS3ABlocksize&lt;/li&gt;
		&lt;li&gt;ITestS3AClosedFS&lt;/li&gt;
		&lt;li&gt;AbstractCommitITest
		&lt;ul&gt;
			&lt;li&gt;ITestS3ACommitterFactory&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;Tests not failing and having explicitly disabled cache
	&lt;ul&gt;
		&lt;li&gt;ITestS3AMultipartUtils&lt;/li&gt;
		&lt;li&gt;ITestS3GuardTtl&lt;/li&gt;
		&lt;li&gt;ITestS3AFailureHandling&lt;/li&gt;
		&lt;li&gt;AbstractSTestS3AHugeFiles
		&lt;ul&gt;
			&lt;li&gt;ITestS3AHugeFilesDiskBlocks
			&lt;ul&gt;
				&lt;li&gt;ITestS3AHugeFilesSSECDiskBlocks&lt;/li&gt;
			&lt;/ul&gt;
			&lt;/li&gt;
			&lt;li&gt;ITestS3AHugeMagicCommits&lt;/li&gt;
			&lt;li&gt;ITestS3AHugeFilesArrayBlocks&lt;/li&gt;
			&lt;li&gt;ITestS3AHugeFilesByteBufferBlocks&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
		&lt;li&gt;ITestS3ABlockOutputArray
		&lt;ul&gt;
			&lt;li&gt;ITestS3ABlockOutputByteBuffer&lt;/li&gt;
			&lt;li&gt;ITestS3ABlockOutputDisk&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
		&lt;li&gt;AbstractCommitITest
		&lt;ul&gt;
			&lt;li&gt;AbstractITCommitProtocol
			&lt;ul&gt;
				&lt;li&gt;ITestStagingCommitProtocol
				&lt;ul&gt;
					&lt;li&gt;ITestDirectoryCommitProtocol&lt;/li&gt;
					&lt;li&gt;ITestPartitionedCommitProtocol&lt;/li&gt;
				&lt;/ul&gt;
				&lt;/li&gt;
				&lt;li&gt;ITestMagicCommitProtocol&lt;/li&gt;
			&lt;/ul&gt;
			&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;Already ignored tests in the testsuite
	&lt;ul&gt;
		&lt;li&gt;ITestS3AEncryptionAlgorithmValidation&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;Ignored tests by me due to another stuff
	&lt;ul&gt;
		&lt;li&gt;ITestS3ATemporaryCredentials: Bug in test&lt;/li&gt;
		&lt;li&gt;AbstractCommitITest: Bug: BouncyCastle not found exception
		&lt;ul&gt;
			&lt;li&gt;AbstractITCommitMRJob
			&lt;ul&gt;
				&lt;li&gt;ITStagingCommitMRJobBadDest&lt;/li&gt;
				&lt;li&gt;ITMagicCommitMRJob&lt;/li&gt;
				&lt;li&gt;ITDirectoryCommitMRJob&lt;/li&gt;
				&lt;li&gt;ITStagingCommitMRJob&lt;/li&gt;
				&lt;li&gt;ITPartitionCommitMRJob&lt;/li&gt;
			&lt;/ul&gt;
			&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
		&lt;li&gt;AbstractTestS3AEncryption: Auth tests were not set up&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Apart from the ignored tests either by me or by default, the strange thing is that &lt;b&gt;tests have either failed or had explicitly disabled cache but not both&lt;/b&gt;. In the list above you can see the list of tests, where the first category is where tests have failed but in the configuration the disabling cache option was not added (checked every level in the class hierarchy), and the second category where cache is explicitly disabled, but those tests have never failed during my examination.&lt;/p&gt;

&lt;p&gt;It has taken some time looking through them, but I checked every one of the tests (still I might have made a mistake) and every config having (indirect) superclass AbstractS3ATestBase.&lt;/p&gt;

&lt;p&gt;What&apos;s more interesting is that&#160;if I manually add a plus&#160;&lt;tt&gt;S3ATestUtils.disableFilesystemCaching&lt;/tt&gt; call to the &lt;tt&gt;createConfiguration&lt;/tt&gt; method of AbstractS3ATestBase (so not to the xml) I get only a single exception instead of the dozens above: only in &lt;tt&gt;ITestS3ACommitterFactory&lt;/tt&gt;.&lt;br/&gt;
I also add the output of the single failed test in that case:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2018-11-27 18:55:08,036 [JUnit-testEverything] ERROR s3a.S3ACloseEnforcedFileSystem (S3ACloseEnforcedFileSystem.java:checkIfClosed(74)) - Use after close(): 
java.lang.RuntimeException: Using closed FS!.
	at org.apache.hadoop.fs.s3a.S3ACloseEnforcedFileSystem.checkIfClosed(S3ACloseEnforcedFileSystem.java:73)
	at org.apache.hadoop.fs.s3a.S3ACloseEnforcedFileSystem.makeQualified(S3ACloseEnforcedFileSystem.java:115)
	at org.apache.hadoop.fs.s3a.commit.AbstractS3ACommitter.initOutput(AbstractS3ACommitter.java:149)
	at org.apache.hadoop.fs.s3a.commit.AbstractS3ACommitter.&amp;lt;init&amp;gt;(AbstractS3ACommitter.java:129)
	at org.apache.hadoop.fs.s3a.commit.magic.MagicS3GuardCommitter.&amp;lt;init&amp;gt;(MagicS3GuardCommitter.java:73)
	at org.apache.hadoop.fs.s3a.commit.magic.MagicS3GuardCommitterFactory.createTaskCommitter(MagicS3GuardCommitterFactory.java:44)
	at org.apache.hadoop.fs.s3a.commit.S3ACommitterFactory.createTaskCommitter(S3ACommitterFactory.java:81)
	at org.apache.hadoop.fs.s3a.commit.AbstractS3ACommitterFactory.createOutputCommitter(AbstractS3ACommitterFactory.java:48)
	at org.apache.hadoop.fs.s3a.commit.ITestS3ACommitterFactory.createCommitter(ITestS3ACommitterFactory.java:198)
	at org.apache.hadoop.fs.s3a.commit.ITestS3ACommitterFactory.assertFactoryCreatesExpectedCommitter(ITestS3ACommitterFactory.java:189)
	at org.apache.hadoop.fs.s3a.commit.ITestS3ACommitterFactory.testImplicitFileBinding(ITestS3ACommitterFactory.java:127)
	at org.apache.hadoop.fs.s3a.commit.ITestS3ACommitterFactory.testEverything(ITestS3ACommitterFactory.java:112)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:498)
	at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:50)
	at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)
	at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:47)
	at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)
	at org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:26)
	at org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:27)
	at org.junit.rules.TestWatcher$1.evaluate(TestWatcher.java:55)
	at org.junit.internal.runners.statements.FailOnTimeout$CallableStatement.call(FailOnTimeout.java:298)
	at org.junit.internal.runners.statements.FailOnTimeout$CallableStatement.call(FailOnTimeout.java:292)
	at java.util.concurrent.FutureTask.run(FutureTask.java:266)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
2018-11-27 18:55:08,036 [JUnit-testEverything] WARN  s3a.S3ACloseEnforcedFileSystem (S3ACloseEnforcedFileSystem.java:logClosers(61)) - FS was closed 1 times by:
2018-11-27 18:55:08,036 [JUnit-testEverything] WARN  s3a.S3ACloseEnforcedFileSystem (S3ACloseEnforcedFileSystem.java:logClosers(64)) - ----------------- close() #1 ---------------
2018-11-27 18:55:08,036 [JUnit-testEverything] WARN  s3a.S3ACloseEnforcedFileSystem (S3ACloseEnforcedFileSystem.java:logClosers(65)) - java.lang.RuntimeException: close() called here
	at org.apache.hadoop.fs.s3a.S3ACloseEnforcedFileSystem.close(S3ACloseEnforcedFileSystem.java:83)
	at org.apache.hadoop.io.IOUtils.cleanupWithLogger(IOUtils.java:280)
	at org.apache.hadoop.io.IOUtils.closeStream(IOUtils.java:298)
	at org.apache.hadoop.fs.s3a.AbstractS3ATestBase.teardown(AbstractS3ATestBase.java:55)
	at org.apache.hadoop.fs.s3a.commit.AbstractCommitITest.teardown(AbstractCommitITest.java:208)
	at org.apache.hadoop.fs.s3a.commit.AbstractITCommitProtocol.teardown(AbstractITCommitProtocol.java:180)
	at org.apache.hadoop.fs.s3a.commit.magic.ITestMagicCommitProtocol.teardown(ITestMagicCommitProtocol.java:213)
	at sun.reflect.GeneratedMethodAccessor23.invoke(Unknown Source)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:498)
	at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:50)
	at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)
	at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:47)
	at org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:33)
	at org.junit.rules.TestWatcher$1.evaluate(TestWatcher.java:55)
	at org.junit.internal.runners.statements.FailOnTimeout$CallableStatement.call(FailOnTimeout.java:298)
	at org.junit.internal.runners.statements.FailOnTimeout$CallableStatement.call(FailOnTimeout.java:292)
	at java.util.concurrent.FutureTask.run(FutureTask.java:266)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Please also note that I didn&apos;t encounter the error messages similar to &lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-15796&quot; title=&quot;ClassCastException: S3AFileSystem cannot be cast to MockS3AFileSystem when fs caching is disabled&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-15796&quot;&gt;&lt;del&gt;HADOOP-15796&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16700891" author="adam.antal" created="Tue, 27 Nov 2018 19:18:20 +0000"  >&lt;p&gt;Also tests were run in eu-ireland (eu-west-1).&lt;/p&gt;</comment>
                            <comment id="16703567" author="adam.antal" created="Thu, 29 Nov 2018 17:54:06 +0000"  >&lt;p&gt;I investigated a bit further, and when the caching is disabled in &lt;tt&gt;AbstractS3ATestBase:createConfiguration()&lt;/tt&gt; and &lt;tt&gt;ITestS3ACommitterFactory:setup()&lt;/tt&gt; methods, the &quot;Using closed FS!&quot; exception does not appear. &lt;br/&gt;
Note that the committer uses another config object, so it needs to be added there too.&lt;br/&gt;
Strictly speaking there&apos;s one failing test, which is &lt;tt&gt;ITestS3AClosedFS&lt;/tt&gt;, but this is due to the addition of the &lt;tt&gt;S3ACloseEnforcedFileSystem&lt;/tt&gt;, which raises an exception after closing the fs, but that is exactly what we investigate, so that exception is irrelevant.&lt;br/&gt;
If we decide later to explicitly disable the cache, I upload a patch which fixes the bug.&lt;/p&gt;</comment>
                            <comment id="16703616" author="adam.antal" created="Thu, 29 Nov 2018 18:20:26 +0000"  >&lt;p&gt;Also some minor remark on &lt;tt&gt;S3ACloseEnforcedFileSystem&lt;/tt&gt;: the method &lt;tt&gt;processDeleteOnExit()&lt;/tt&gt; should not call the &lt;tt&gt;checkIfClosed()&lt;/tt&gt; method in &lt;tt&gt;S3ACloseEnforcedFileSystem&lt;/tt&gt;, because the former is only called after the &lt;tt&gt;close()&lt;/tt&gt; (the order of the calls is &lt;tt&gt;S3ACloseEnforcedFileSystem:close() -&amp;gt; S3AFileSystem:close() -&amp;gt; FileSystem:close() -&amp;gt; S3ACloseEnforcedFileSystem:processDeleteOnExit()&lt;/tt&gt;) thus creating misleading errors during the normal close of the filesystem.&lt;br/&gt;
I uploaded that for reference.&lt;/p&gt;</comment>
                            <comment id="16703729" author="adam.antal" created="Thu, 29 Nov 2018 20:05:59 +0000"  >&lt;p&gt;Strangely I rerun the tests in trunk with no modification, and got only one error in &lt;tt&gt;ITestS3ACommitterFactory&lt;/tt&gt; (same as above). &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[ERROR] Tests run: 1, Failures: 0, Errors: 1, Skipped: 0, Time elapsed: 0.017 s &amp;lt;&amp;lt;&amp;lt; FAILURE! - in org.apache.hadoop.fs.s3a.commit.ITestS3ACommitterFactory
[ERROR] testEverything(org.apache.hadoop.fs.s3a.commit.ITestS3ACommitterFactory)  Time elapsed: 0.016 s  &amp;lt;&amp;lt;&amp;lt; ERROR!
java.io.IOException: s3a://adamantal-hdfs-s3-dev: FileSystem is closed!
	at org.apache.hadoop.fs.s3a.commit.ITestS3ACommitterFactory.setup(ITestS3ACommitterFactory.java:94)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Probably this is due to the fixes in &lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-15947&quot; title=&quot;Fix ITestDynamoDBMetadataStore test error issues&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-15947&quot;&gt;&lt;del&gt;HADOOP-15947&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-15798&quot; title=&quot;LocalMetadataStore put() does not retain isDeleted in parent listing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-15798&quot;&gt;&lt;del&gt;HADOOP-15798&lt;/del&gt;&lt;/a&gt; or &lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-15370&quot; title=&quot;S3A log message on rm s3a://bucket/ not intuitive&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-15370&quot;&gt;&lt;del&gt;HADOOP-15370&lt;/del&gt;&lt;/a&gt;. Still there is one more error, but it can be resolved with either disabling caching, or by investigating why the closed S3AFS is returned from &lt;tt&gt;FileSystem.get()&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16711783" author="adam.antal" created="Thu, 6 Dec 2018 17:49:01 +0000"  >&lt;p&gt;Hi everyone!&lt;/p&gt;

&lt;p&gt;I uploaded patch v1 with the fix.&lt;br/&gt;
 Remarks/explanation:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;After thorough investigation of the cache I came to the conclusion that it is work as expected - I did not find any abnormal behaviour. The closed S3AFS must got into the cache somehow, so I tried further logging, and it showed that it was through the &lt;tt&gt;FileSystem&lt;/tt&gt;&apos;s following function:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@VisibleForTesting
   &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void addFileSystemForTesting(URI uri, Configuration conf,
       FileSystem fs) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
       CACHE.map.put(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Cache.Key(uri, conf), fs);
   }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;It turned out that among the hadoop-aws integration tests there&apos;s only one usage of this function, and the stack trace is the following:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
CACHE.map.put(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Cache.Key(uri, conf), fs) -&amp;gt;
  FileSystem.addFileSystemForTesting(uri, conf, fs) -&amp;gt;
    FileSystemTestHelper.addFileSystemForTesting(uri, conf, wrapperFS) -&amp;gt;
      AbstractITCommitProtocol.bindFileSystem(FileSystem fs, Path path, Configuration conf) -&amp;gt;
        AbstractITCommitProtocol.setup()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;(Note that there are other usage in the test suite, but for integration tests this is the only one).&lt;/li&gt;
	&lt;li&gt;This function directly injects the FS into the FSCache (which can be in the cache already, but with another key), but as I wrote it in my previous comment, the caching is explicitly disabled in &lt;tt&gt;AbstractITCommitProtocol&lt;/tt&gt;&#160;since in &lt;tt&gt;AbstractITCommitProtocol.createConfiguration()&lt;/tt&gt; we call &lt;tt&gt;disableFilesystemCaching(conf)&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;So this FS is in the cache, but it is never returned by &lt;tt&gt;FileSystem.get()&lt;/tt&gt;&#160;since the cache is disabled. Instead a new S3AFileSystem object is returned in each call.&lt;/li&gt;
	&lt;li&gt;During teardown the FS is closed, and it&apos;s got removed from the cache &lt;b&gt;but the only removed key-value pair is the injected one.&lt;/b&gt;&#160;If there was other&#160;key-value&#160;pair that has the same FS as value, it is kept in the cache. So after this action one key with one closed FS value as pair&#160;could remain in the FSCache.&lt;/li&gt;
	&lt;li&gt;The tests are running in the JVM so the next test case which tries to access a FS with &lt;tt&gt;s3a&lt;/tt&gt; scheme without disabled cache gets this closed FS, and runs into the known error.&lt;/li&gt;
	&lt;li&gt;Since the cache is disabled there&apos;s no need to explicitly use that&#160;&lt;tt&gt;bindFileSystem&lt;/tt&gt; method. My easy fix is to remove it.&lt;/li&gt;
	&lt;li&gt;This function is rarely used in tests, that may explain why we got this error and why no one has ever encountered errors like this. To sum it up, the cache is working as intended, but the misuse was the root of the issue. Maybe we should consider deleting it since it cause unforeseen effects like this (note that this function has only one usage except hadoop-aws).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Please&#160;verify my observations and please also check that the fix is working indeed.&lt;br/&gt;
 I also note that &lt;tt&gt;ITestS3ACommitterFactory&lt;/tt&gt; is still failing, there was another error which got hidden by the &quot;closed fs&quot; error.&lt;/p&gt;

&lt;p&gt;Regards,&lt;br/&gt;
 Adam&lt;/p&gt;</comment>
                            <comment id="16711917" author="adam.antal" created="Thu, 6 Dec 2018 19:30:11 +0000"  >&lt;p&gt;I&apos;d also like to add that it worked for my disabled-cache version of trunk (so I disabled cache for &lt;tt&gt;AbstractITCommitProtocol&lt;/tt&gt; previously) - it was added to the patch as well. It actually works without disabling cache (so only removing the bindFileSystem call).&lt;/p&gt;</comment>
                            <comment id="16711957" author="gabor.bota" created="Thu, 6 Dec 2018 19:58:09 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adam.antal&quot; class=&quot;user-hover&quot; rel=&quot;adam.antal&quot;&gt;adam.antal&lt;/a&gt;, I&apos;ll test it tomorrow up and downstream.&lt;/p&gt;</comment>
                            <comment id="16711966" author="adam.antal" created="Thu, 6 Dec 2018 20:04:54 +0000"  >&lt;p&gt;I&apos;m sorry, uploaded bad patch (reuploaded the right one &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12950884/12950884_HADOOP-15819.001.patch&quot; title=&quot;HADOOP-15819.001.patch attached to HADOOP-15819&quot;&gt;HADOOP-15819.001.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; ).&lt;/p&gt;</comment>
                            <comment id="16712683" author="gabor.bota" created="Fri, 7 Dec 2018 11:15:34 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adam.antal&quot; class=&quot;user-hover&quot; rel=&quot;adam.antal&quot;&gt;adam.antal&lt;/a&gt;, could you remove the bad one?&lt;/p&gt;</comment>
                            <comment id="16713791" author="adam.antal" created="Sat, 8 Dec 2018 22:02:28 +0000"  >&lt;p&gt;I removed it.&lt;/p&gt;</comment>
                            <comment id="16721551" author="gabor.bota" created="Fri, 14 Dec 2018 15:54:14 +0000"  >&lt;p&gt;Thanks for the patch &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adam.antal&quot; class=&quot;user-hover&quot; rel=&quot;adam.antal&quot;&gt;adam.antal&lt;/a&gt;.&lt;br/&gt;
Not just the call, but the whole method could be removed: org.apache.hadoop.fs.s3a.commit.AbstractITCommitProtocol#bindFileSystem, because there are no other call for that method.&lt;/p&gt;

&lt;p&gt;I think adding the fs to the cache with &lt;tt&gt;FileSystemTestHelper.addFileSystemForTesting&lt;/tt&gt; from &lt;tt&gt;AbstractITCommitProtocol#bindFileSystem&lt;/tt&gt; is not needed, because we will use the same FileSystem object throughout the tests from &lt;tt&gt;getFileSystem().&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mackrorysd&quot; class=&quot;user-hover&quot; rel=&quot;mackrorysd&quot;&gt;mackrorysd&lt;/a&gt; do could you add some thoughts if removing the bindFileSystem is a good fix for this issue?&lt;/p&gt;</comment>
                            <comment id="16723105" author="adam.antal" created="Mon, 17 Dec 2018 15:56:43 +0000"  >&lt;p&gt;Thanks, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gabor.bota&quot; class=&quot;user-hover&quot; rel=&quot;gabor.bota&quot;&gt;gabor.bota&lt;/a&gt;. I uploaded patch&#160;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12952049/12952049_HADOOP-15819.002.patch&quot; title=&quot;HADOOP-15819.002.patch attached to HADOOP-15819&quot;&gt;HADOOP-15819.002.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; (removed the unused method).&lt;/p&gt;</comment>
                            <comment id="16724301" author="mackrorysd" created="Tue, 18 Dec 2018 17:53:11 +0000"  >&lt;p&gt;The only failure I see with this patch is the bouncycastle one. I don&apos;t have an objection to removing this - it&apos;s only for a slight perf improvement on tests. I&apos;m curious to know why this is resulting an a distinct cache entry. Is the URL slightly different at this point than it is in FS.newInstance() or something?&lt;/p&gt;</comment>
                            <comment id="16725168" author="adam.antal" created="Wed, 19 Dec 2018 16:40:11 +0000"  >&lt;p&gt;Not exactly, to be more clear though I enumerate the events when calling any subtest of &lt;tt&gt;AbstractITCommitProtocol&lt;/tt&gt;:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;During the very first moment of the startup &lt;tt&gt;setup()&lt;/tt&gt; and &lt;tt&gt;init()&lt;/tt&gt; functions are called. Concretely &lt;tt&gt;AbstractBondedFSContract&lt;/tt&gt;  creates and stores a new &lt;tt&gt;FileSystem&lt;/tt&gt; instance of the proper type.
	&lt;ul&gt;
		&lt;li&gt;Later, each time the getFileSystem() is called, it returns this &quot;cached&quot; instance (This is NOT the FSCache! just a private data member of &lt;tt&gt;AbstractBondedFSContract&lt;/tt&gt;).&lt;/li&gt;
		&lt;li&gt;Note: since &lt;tt&gt;AbstractITCommitProtocol.createConfiguration()&lt;/tt&gt; contains &lt;tt&gt;disableFilesystemCaching(conf)&lt;/tt&gt;, the cache is disabled. Each time this Configuration object is used anywhere in the test, it returns a newly created instance by the static &lt;tt&gt;FileSystem.get()&lt;/tt&gt; method.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;During this startup in &lt;tt&gt;AbstractITCommitProtocol.setup()&lt;/tt&gt; the line &lt;tt&gt;bindFileSystem(fileSystem, outDir, fileSystem.getConf());&lt;/tt&gt; is executed as well. We call the internal &lt;tt&gt;getFileSystem()&lt;/tt&gt;, which returns the already created and stored instance, and inject it directly into the FSCache.&lt;/li&gt;
	&lt;li&gt;The test runs using the stored instance and the non-cached instances of FileSystem.&lt;/li&gt;
	&lt;li&gt;During teardown we close the stored FileSystem object as usual, BUT since we didn&apos;t put this instance into the FSCache the regular way it got stuck in the cache. Although the &lt;tt&gt;close()&lt;/tt&gt; contains this call: &lt;tt&gt;CACHE.remove(this.key, this);&lt;/tt&gt;, the &lt;tt&gt;this.key&lt;/tt&gt; (so the FileSystem&apos;s FileSystem.Cache private member) is not set. It would have been set, if it had been put to the cache in the regular way, but not by injection. More concretely &lt;tt&gt;Cache.getInternal&lt;/tt&gt; sets this.key of the FileSystem object, which is surpassed when the FS instance is manually injected.&lt;/li&gt;
	&lt;li&gt;Later, in the same JVM another test is setting up using the &lt;tt&gt;s3a://&lt;/tt&gt; scheme, this object gets retrieved from the cache (since it&apos;s not removed), but now it&apos;s closed, and boom.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;d rather not mess with manual injection, that&apos;s why I proposed to delete the binding.&lt;/p&gt;

&lt;p&gt;I wasn&apos;t 100% right with my previous comment (you can practically ignore that), but I think this is correct way how things work. Still I can make mistakes, so please review my thoughts on this.&lt;/p&gt;</comment>
                            <comment id="16725544" author="mackrorysd" created="Thu, 20 Dec 2018 03:05:06 +0000"  >&lt;p&gt;Ah - FS.key not being set is the piece I was missing. I suppose the truly correct solution here would be to make sure FS.key is set properly, but I don&apos;t know that the benefit to that is worth a whole lot of your time. I&apos;ll hold off for a day in case &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stevel%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;stevel@apache.org&quot;&gt;stevel@apache.org&lt;/a&gt; who wrote this in the first place disagrees. Otherwise +1 and I&apos;ll commit soon.&lt;/p&gt;

&lt;p&gt;As a side note, I noticed StagingTestBase has a call to the same function, but obviously isn&apos;t causing the same issue.&lt;/p&gt;</comment>
                            <comment id="16725843" author="adam.antal" created="Thu, 20 Dec 2018 13:41:54 +0000"  >&lt;p&gt;Indeed. &lt;br/&gt;
I also saw that it is used elsewhere, so I would not recommend modifying the function by manually setting the FS.key there. In my opinion if we manually inject the FS into the cache maybe we should manually remove it (for e.g. in the teardown of the test). Although I still don&apos;t see why injecting is necessary.&lt;/p&gt;</comment>
                            <comment id="16726305" author="fabbri" created="Thu, 20 Dec 2018 23:15:58 +0000"  >&lt;p&gt;Just catching up on this as I hit the bug again. Sounds like a great find &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adam.antal&quot; class=&quot;user-hover&quot; rel=&quot;adam.antal&quot;&gt;adam.antal&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16729682" author="mackrorysd" created="Thu, 27 Dec 2018 15:53:57 +0000"  >&lt;p&gt;Committed. Thank you for the excellent work here &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adam.antal&quot; class=&quot;user-hover&quot; rel=&quot;adam.antal&quot;&gt;adam.antal&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16729695" author="hudson" created="Thu, 27 Dec 2018 16:10:16 +0000"  >&lt;p&gt;SUCCESS: Integrated in Jenkins build Hadoop-trunk-Commit #15665 (See &lt;a href=&quot;https://builds.apache.org/job/Hadoop-trunk-Commit/15665/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Hadoop-trunk-Commit/15665/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-15819&quot; title=&quot;S3A integration test failures: FileSystem is closed! - without parallel test run&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-15819&quot;&gt;&lt;del&gt;HADOOP-15819&lt;/del&gt;&lt;/a&gt;. FileSystem cache misused in S3A integration tests. (mackrorysd: rev d8f670ff28c1a9f49ef908a23850bcfddd4f46dc)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) hadoop-tools/hadoop-aws/src/test/java/org/apache/hadoop/fs/s3a/commit/AbstractITCommitProtocol.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16729701" author="adam.antal" created="Thu, 27 Dec 2018 16:17:32 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mackrorysd&quot; class=&quot;user-hover&quot; rel=&quot;mackrorysd&quot;&gt;mackrorysd&lt;/a&gt; for the commit. The credit goes to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gabor.bota&quot; class=&quot;user-hover&quot; rel=&quot;gabor.bota&quot;&gt;gabor.bota&lt;/a&gt; who started the investigation, and also to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stevel%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;stevel@apache.org&quot;&gt;stevel@apache.org&lt;/a&gt; for the useful comments.&lt;/p&gt;</comment>
                            <comment id="16731950" author="stevel@apache.org" created="Wed, 2 Jan 2019 11:12:25 +0000"  >&lt;p&gt;quick follow up here: do we need to add anything to the testing s3a doc for anyone writing new tests?&lt;/p&gt;</comment>
                            <comment id="16732172" author="mackrorysd" created="Wed, 2 Jan 2019 15:54:07 +0000"  >&lt;p&gt;I wouldn&apos;t have thought so as I think you have to go our of your way to do something you don&apos;t usually do to hit this, but then I don&apos;t fully understand why this was added in the first place. I think the patch originally came from you - do you happen to remember why we started adding the FS instance to the cache here? And if so, is that something that might occur to a future test writer as well?&lt;/p&gt;</comment>
                            <comment id="16733167" author="gabor.bota" created="Thu, 3 Jan 2019 15:51:45 +0000"  >&lt;p&gt;We could extend the docs with something like &quot;Do not add FileSystem instances (with e.g org.apache.hadoop.fs.FileSystem#addFileSystemForTesting) to the cache that will be modified during the test runs. This can cause other tests to fail when using the same modified or closed FS instance. For more details see &lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-15819&quot; title=&quot;S3A integration test failures: FileSystem is closed! - without parallel test run&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-15819&quot;&gt;&lt;del&gt;HADOOP-15819&lt;/del&gt;&lt;/a&gt;.&quot;&lt;/p&gt;

&lt;p&gt;Should I create a new jira for this and upload a patch?&lt;/p&gt;</comment>
                            <comment id="16733557" author="stevel@apache.org" created="Thu, 3 Jan 2019 21:54:50 +0000"  >&lt;p&gt;I think we should write something down about &quot;effective use of FS instances&quot;, so yes, a new JIRA please&lt;/p&gt;

&lt;p&gt;I wonder what we should say&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;tests are fastest if they can recycle the existing FS instance from the same JVM&lt;/li&gt;
	&lt;li&gt;if you do that, you MUST NOT close them.&lt;/li&gt;
	&lt;li&gt;if you want a guarantee of 100% isolation, or an instance with unique config, create a new instance&lt;/li&gt;
	&lt;li&gt;which you MUST close in teardown to avoid leakage of thread pools &amp;amp;c.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;+ what you&apos;ve proposed &quot;do not add...&quot;, with the other point being &quot;only do this if you are trying to get unmodified code to pick up your custom instance, such as when playing with mocks&quot;&lt;/p&gt;
</comment>
                            <comment id="16734141" author="gabor.bota" created="Fri, 4 Jan 2019 13:45:19 +0000"  >&lt;p&gt;Created &lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-16027&quot; title=&quot;[DOC] Effective use of FS instances during S3A integration tests&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-16027&quot;&gt;&lt;del&gt;HADOOP-16027&lt;/del&gt;&lt;/a&gt; to add this to docs.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12950054" name="HADOOP-15819.000.patch" size="2429" author="adam.antal" created="Thu, 29 Nov 2018 18:33:59 +0000"/>
                            <attachment id="12950884" name="HADOOP-15819.001.patch" size="1187" author="adam.antal" created="Thu, 6 Dec 2018 20:04:37 +0000"/>
                            <attachment id="12952049" name="HADOOP-15819.002.patch" size="1779" author="adam.antal" created="Mon, 17 Dec 2018 15:56:39 +0000"/>
                            <attachment id="12950052" name="S3ACloseEnforcedFileSystem.java" size="22360" author="adam.antal" created="Thu, 29 Nov 2018 18:26:10 +0000"/>
                            <attachment id="12942380" name="S3ACloseEnforcedFileSystem.java" size="22270" author="gabor.bota" created="Thu, 4 Oct 2018 12:40:10 +0000"/>
                            <attachment id="12942381" name="closed_fs_closers_example_5klines.log.zip" size="26306" author="gabor.bota" created="Thu, 4 Oct 2018 12:43:00 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 45 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ytuv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>