<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:57:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HADOOP-18321] Fix when to read an additional record from a BZip2 text file split</title>
                <link>https://issues.apache.org/jira/browse/HADOOP-18321</link>
                <project id="12310240" key="HADOOP">Hadoop Common</project>
                    <description>&lt;p&gt;Fix data correctness issue with TextInputFormat that can occur when reading BZip2 compressed text files. When triggered this bug would cause a split to return the first record of the succeeding split that reads the next BZip2 block, thereby duplicating that record.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;When the bug is triggered?&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;The condition for the bug to occur requires that the flag &quot;needAdditionalRecord&quot; in CompressedSplitLineReader to be set to true by #fillBuffer at an inappropriate time: when we haven&apos;t read the remaining bytes of split. This can happen when the inDelimiter parameter is true while #fillBuffer is invoked while reading the next line. The inDelimiter parameter is true when either 1) the last byte of the buffer is a CR character (&apos;\r&apos;) if using the default delimiters, or 2) the last bytes of the buffer are a common prefix of the delimiter if using a custom delimiter.&lt;/p&gt;

&lt;p&gt;This can occur in various edge cases, illustrated by five unit tests added in this change &amp;#8211; specifically the five that would fail without the fix are as listed below:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;BaseTestLineRecordReaderBZip2.customDelimiter_lastRecordDelimiterStartsAtNextBlockStart&lt;/li&gt;
	&lt;li&gt;BaseTestLineRecordReaderBZip2.firstBlockEndsWithLF_secondBlockStartsWithCR&lt;/li&gt;
	&lt;li&gt;BaseTestLineRecordReaderBZip2.delimitedByCRSpanningThreeBlocks&lt;/li&gt;
	&lt;li&gt;BaseTestLineRecordReaderBZip2.usingCRDelimiterWithSmallestBufferSize&lt;/li&gt;
	&lt;li&gt;BaseTestLineRecordReaderBZip2.customDelimiter_lastThreeBytesInBlockAreDelimiter&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;For background, the purpose of &quot;needAdditionalRecord&quot; field in CompressedSplitLineReader is to indicate to LineRecordReader via the #needAdditionalRecordAfterSplit method that an extra record lying beyond the split range should be included in the split. This complication arises due to a problem when splitting text files. When a split starts at a position greater than zero, we do not know whether the first line belongs to the last record in the prior split or is a new record. The solution done in Hadoop is to make splits that start at position greater than zero to always discard the first line and then have the prior split decide whether it should include the first line of the next split or not (as part of the last record or as a new record). This works well even in the case of a single line spanning multiple splits.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;What is the fix?&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;The fix is to prevent ever setting &quot;needAdditionalRecord&quot; if the bytes filled to the buffer are not the bytes immediately outside the range of the split.&lt;/p&gt;

&lt;p&gt;When reading compressed data, CompressedSplitLineReader requires/assumes that the stream&apos;s #read method never returns bytes from more than one compression block at a time. This ensures that #fillBuffer gets invoked to read the first byte of the next block. This next block may or may not be part of the split we are reading. If we detect that the last bytes of the prior block maybe part of a delimiter, then we may decide that we should read an additional record, but we should only do that when this next block is not part of our split &lt;b&gt;and&lt;/b&gt; we aren&apos;t filling the buffer again beyond our split range. This is because we are only concerned whether the we need to read the very first line of the next split as a separate record. If it going to be part of the last record, then we don&apos;t need to read an extra record, or in the special case of CR + LF (i.e. &quot;\r\n&quot;), if the LF is the first byte of the next split, it will be treated as an empty line, thus we don&apos;t need to include an extra record into the mix.&lt;/p&gt;

&lt;p&gt;Thus, to emphasize. It is when we read the first bytes outside our split range that matters. But the current logic doesn&apos;t take that into account in CompressedSplitLineReader. This is in contrast to UncompressedSplitLineReader which does.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13469492">HADOOP-18321</key>
            <summary>Fix when to read an additional record from a BZip2 text file split</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="groot">Ashutosh Gupta</assignee>
                                    <reporter username="groot">Ashutosh Gupta</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 30 Jun 2022 15:41:13 +0000</created>
                <updated>Sun, 28 Jan 2024 00:28:17 +0000</updated>
                            <resolved>Wed, 6 Jul 2022 04:30:59 +0000</resolved>
                                    <version>3.3.3</version>
                                    <fixVersion>3.4.0</fixVersion>
                    <fixVersion>3.3.5</fixVersion>
                                    <component>io</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="10800">3h</timespent>
                                <comments>
                            <comment id="17576329" author="ajisakaa" created="Sun, 7 Aug 2022 07:12:29 +0000"  >&lt;p&gt;Backported to branch-3.3.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13474952">HADOOP-18390</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13476265">HADOOP-18400</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 14 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z16iag:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12350632">3.3.5</customfieldvalue>
    <customfieldvalue id="12351867">3.3.4</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>