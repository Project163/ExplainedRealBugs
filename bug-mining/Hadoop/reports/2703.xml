<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:56:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HADOOP-17346] Fair call queue is defeated by abusive service principals</title>
                <link>https://issues.apache.org/jira/browse/HADOOP-17346</link>
                <project id="12310240" key="HADOOP">Hadoop Common</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=daryn&quot; class=&quot;user-hover&quot; rel=&quot;daryn&quot;&gt;daryn&lt;/a&gt; reported  that the FCQ prioritizes based on the full kerberos principal (ie. &quot;user/host@realm&quot;) rather than short name (ie. &quot;user&quot;) to prevent service principals like the DNs and NMs being de-prioritized since service principals are expected to be well behaved.  Notably the DNs contribute a significant but important load so the intent is not to de-prioritize all DNs because their sum total load is high relative to users.&lt;/p&gt;

&lt;p&gt;This has the unfortunate side effect of allowing misbehaving &amp;amp; non-critical service principals to abuse the FCQ. The gstorm/* principals are a prime example.   Each server is spamming opens as fast as possible which ensures that none of the gstorm servers can be de-prioritized because each principal is a fraction of the total load from all principals.&lt;/p&gt;

&lt;p&gt;The secondary and more devasting problem is other abusive non-service principals cannot be effectively de-prioritized.  The sum total of all gstorm load prevents other principals from surpassing the priority thresholds.  Principals stay in the highest priority queues which allows the abusive principals to overflow the entire call queue for extended periods of time.  Notably it prevents the FCQ from moderating the heavy create loads from p_gup @ DB which cause significant performance degradation.&lt;/p&gt;

&lt;p&gt;Prioritization should be based on short name with configurable exemptions for services like the DN/NM.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=daryn&quot; class=&quot;user-hover&quot; rel=&quot;daryn&quot;&gt;daryn&lt;/a&gt; suggested a solution that we applied on our clusters.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13338741">HADOOP-17346</key>
            <summary>Fair call queue is defeated by abusive service principals</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ahussein">Ahmed Hussein</assignee>
                                    <reporter username="ahussein">Ahmed Hussein</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 3 Nov 2020 23:16:38 +0000</created>
                <updated>Wed, 18 Aug 2021 08:27:05 +0000</updated>
                            <resolved>Mon, 23 Nov 2020 23:22:08 +0000</resolved>
                                                    <fixVersion>3.2.2</fixVersion>
                    <fixVersion>3.3.1</fixVersion>
                    <fixVersion>3.4.0</fixVersion>
                    <fixVersion>3.2.3</fixVersion>
                                    <component>common</component>
                    <component>ipc</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="3000">50m</timespent>
                                <comments>
                            <comment id="17226884" author="ahussein" created="Thu, 5 Nov 2020 17:39:03 +0000"  >&lt;p&gt;We have deployed that change on our internal cluster and it is working great.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=epayne&quot; class=&quot;user-hover&quot; rel=&quot;epayne&quot;&gt;epayne&lt;/a&gt;&#160;can you please take a look at the&#160;&lt;a href=&quot;https://github.com/apache/hadoop/pull/2431&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;GitHub Pull Request #2431&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17228760" author="eepayne" created="Mon, 9 Nov 2020 18:42:13 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ahussein&quot; class=&quot;user-hover&quot; rel=&quot;ahussein&quot;&gt;ahussein&lt;/a&gt;, for raising the issue and providing the patch.&lt;br/&gt;
 I am looking at the PR.&lt;/p&gt;</comment>
                            <comment id="17230191" author="eepayne" created="Wed, 11 Nov 2020 20:04:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ahussein&quot; class=&quot;user-hover&quot; rel=&quot;ahussein&quot;&gt;ahussein&lt;/a&gt;, I have verified that these changes are consistent with what we have been running internally.&lt;/p&gt;

&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="17230881" author="eepayne" created="Thu, 12 Nov 2020 19:29:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ahussein&quot; class=&quot;user-hover&quot; rel=&quot;ahussein&quot;&gt;ahussein&lt;/a&gt;, I merged the PR to trunk. However, it does not backport quite cleanly to earlier 3.x branches. I think we want this in 3.3, 3.2, and 3.1. Please provide patches for those if we want this pulled back.&lt;/p&gt;</comment>
                            <comment id="17236433" author="eepayne" created="Fri, 20 Nov 2020 21:03:22 +0000"  >&lt;p&gt;The patch for branch-3.3 changes the signature for &lt;tt&gt;DecayRpcScheduler#computePriorityLevel&lt;/tt&gt; to add an identity object:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
-  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; computePriorityLevel(&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; cost) {
+  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; computePriorityLevel(&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; cost, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; identity) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This signature change was done in trunk as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-17165&quot; title=&quot;Implement service-user feature in DecayRPCScheduler&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-17165&quot;&gt;&lt;del&gt;HADOOP-17165&lt;/del&gt;&lt;/a&gt;. Since this fix needs that same signature change, we are faced with the following choices:&lt;br/&gt;
1) Backport &lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-17165&quot; title=&quot;Implement service-user feature in DecayRPCScheduler&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-17165&quot;&gt;&lt;del&gt;HADOOP-17165&lt;/del&gt;&lt;/a&gt; to branch-3.3&lt;br/&gt;
2) Make the same change in this patch.&lt;br/&gt;
I don&apos;t like to implement solution 2 because it makes changes hard to track. However, I don&apos;t know if we want the feature from &lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-17165&quot; title=&quot;Implement service-user feature in DecayRPCScheduler&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-17165&quot;&gt;&lt;del&gt;HADOOP-17165&lt;/del&gt;&lt;/a&gt; backported to branch-3.3.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tasanuma&quot; class=&quot;user-hover&quot; rel=&quot;tasanuma&quot;&gt;tasanuma&lt;/a&gt;, is the service-user feature something we want backported to earlier branches? We would probably want it pulled back into at least branch-3.2. It backports cleanly to branch-3.3, but not quite cleanly to 3.2.&lt;/p&gt;</comment>
                            <comment id="17236616" author="tasanuma0829" created="Sat, 21 Nov 2020 09:06:47 +0000"  >&lt;p&gt;According to&#160;&lt;a href=&quot;https://hadoop.apache.org/docs/current/hadoop-project-dist/hadoop-common/DownstreamDev.html#Hadoop_Releases&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Hadoop Releases&lt;/a&gt;, we should not include any new feature for a maintenance release.&lt;/p&gt;

&lt;p&gt;I think &lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-17165&quot; title=&quot;Implement service-user feature in DecayRPCScheduler&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-17165&quot;&gt;&lt;del&gt;HADOOP-17165&lt;/del&gt;&lt;/a&gt; is a new feature and its specification still changes. (e.g.&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-17280&quot; title=&quot;Service-user cost shouldn&amp;#39;t be accumulated to totalDecayedCallCost and totalRawCallCost.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-17280&quot;&gt;&lt;del&gt;HADOOP-17280&lt;/del&gt;&lt;/a&gt;) So I propose solution 2.&lt;/p&gt;</comment>
                            <comment id="17237703" author="eepayne" created="Mon, 23 Nov 2020 21:26:24 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ahussein&quot; class=&quot;user-hover&quot; rel=&quot;ahussein&quot;&gt;ahussein&lt;/a&gt; for the good work on this JIRA. I have committed to trunk, branch-3.3, and branch-3.2.&lt;/p&gt;

&lt;p&gt;I have a question about the branch-3.1 patch. It seems that in branch 3.1, the arguments for &lt;tt&gt;DecayRpcScheduler#computePriorityLevel&lt;/tt&gt; are reversed:&lt;/p&gt;
&lt;div class=&quot;panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;branch3.1&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;panelContent&quot;&gt;
&lt;p&gt;+  private int computePriorityLevel(Object identity, long cost) {&lt;/p&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;branch3.2&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;panelContent&quot;&gt;
&lt;p&gt;+  private int computePriorityLevel(long cost, Object identity) {&lt;/p&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;If there wasn&apos;t a specific reason for doing this, I would suggest we reverse them in branch-3.1 to match the other releases.&lt;/p&gt;</comment>
                            <comment id="17237704" author="eepayne" created="Mon, 23 Nov 2020 21:28:47 +0000"  >&lt;blockquote&gt;&lt;p&gt;If there wasn&apos;t a specific reason for doing this, I would suggest we reverse them in branch-3.1 to match the other releases.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;BTW, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ahussein&quot; class=&quot;user-hover&quot; rel=&quot;ahussein&quot;&gt;ahussein&lt;/a&gt;, you don&apos;t need to put up another patch. I&apos;ll do this as part of the commit.&lt;/p&gt;</comment>
                            <comment id="17237745" author="ahussein" created="Mon, 23 Nov 2020 23:13:21 +0000"  >&lt;p&gt;that looks good to me .&lt;br/&gt;
Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=epayne&quot; class=&quot;user-hover&quot; rel=&quot;epayne&quot;&gt;epayne&lt;/a&gt;!&lt;/p&gt;</comment>
                            <comment id="17237746" author="eepayne" created="Mon, 23 Nov 2020 23:22:08 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ahussein&quot; class=&quot;user-hover&quot; rel=&quot;ahussein&quot;&gt;ahussein&lt;/a&gt;. I committed to branch-3.1, branch-3.2, branch-3.3, and trunk.&lt;/p&gt;</comment>
                            <comment id="17237847" author="tasanuma0829" created="Tue, 24 Nov 2020 04:14:56 +0000"  >&lt;p&gt;Thanks for your good work, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ahussein&quot; class=&quot;user-hover&quot; rel=&quot;ahussein&quot;&gt;ahussein&lt;/a&gt;&#160;and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=epayne&quot; class=&quot;user-hover&quot; rel=&quot;epayne&quot;&gt;epayne&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17239968" author="hexiaoqiao" created="Sat, 28 Nov 2020 13:17:50 +0000"  >&lt;p&gt;bulk update: backport to branch-3.2.2.&lt;/p&gt;</comment>
                            <comment id="17400892" author="tasanuma0829" created="Wed, 18 Aug 2021 08:27:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ahussein&quot; class=&quot;user-hover&quot; rel=&quot;ahussein&quot;&gt;ahussein&lt;/a&gt; After &lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-17346&quot; title=&quot;Fair call queue is defeated by abusive service principals&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-17346&quot;&gt;&lt;del&gt;HADOOP-17346&lt;/del&gt;&lt;/a&gt;, what settings do we need to make to exempt dn/nm from prioritization?&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13015580" name="HADOOP-17346-branch-3.1.001.patch" size="17034" author="ahussein" created="Wed, 18 Nov 2020 21:59:25 +0000"/>
                            <attachment id="13015578" name="HADOOP-17346.branch-3.2.001.patch" size="16849" author="ahussein" created="Wed, 18 Nov 2020 20:37:45 +0000"/>
                            <attachment id="13015576" name="HADOOP-17346.branch-3.3.001.patch" size="17227" author="ahussein" created="Wed, 18 Nov 2020 20:01:35 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 12 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0k9nc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>