<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:36:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HADOOP-8245] Fix flakiness in TestZKFailoverController</title>
                <link>https://issues.apache.org/jira/browse/HADOOP-8245</link>
                <project id="12310240" key="HADOOP">Hadoop Common</project>
                    <description>&lt;p&gt;When I loop TestZKFailoverController, I occasionally see two types of failures:&lt;br/&gt;
1) the ZK JMXEnv issue (&lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1438&quot; title=&quot;JMX MBeans for client connections can be orphaned&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1438&quot;&gt;ZOOKEEPER-1438&lt;/a&gt;)&lt;br/&gt;
2) TestZKFailoverController.testZooKeeperFailure fails with a timeout&lt;/p&gt;

&lt;p&gt;This JIRA is for fixes for these issues.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12549440">HADOOP-8245</key>
            <summary>Fix flakiness in TestZKFailoverController</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tlipcon">Todd Lipcon</assignee>
                                    <reporter username="tlipcon">Todd Lipcon</reporter>
                        <labels>
                    </labels>
                <created>Wed, 4 Apr 2012 03:04:16 +0000</created>
                <updated>Wed, 4 Apr 2012 19:21:28 +0000</updated>
                            <resolved>Wed, 4 Apr 2012 19:21:28 +0000</resolved>
                                    <version>Auto Failover (HDFS-3042)</version>
                                    <fixVersion>Auto Failover (HDFS-3042)</fixVersion>
                                    <component>auto-failover</component>
                    <component>ha</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13245991" author="tlipcon" created="Wed, 4 Apr 2012 03:18:26 +0000"  >&lt;p&gt;For problem #1, the solution is the same as is already done in some other test cases. We just need to add a workaround to clear the ZK MBeans before running the tearDown method. It&apos;s a hack, but in the absense of a fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/ZOOKEEPER-1438&quot; title=&quot;JMX MBeans for client connections can be orphaned&quot; class=&quot;issue-link&quot; data-issue-key=&quot;ZOOKEEPER-1438&quot;&gt;ZOOKEEPER-1438&lt;/a&gt;, it&apos;s about all we can do.&lt;/p&gt;

&lt;p&gt;I spent some time investigating problem #2. The bug is as follows:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;these test cases create a new ActiveStandbyElector, and call &lt;tt&gt;ActiveStandbyElector.ensureBaseNode()&lt;/tt&gt; on it before running the main body of the tests. Although they don&apos;t call &lt;tt&gt;joinElection()&lt;/tt&gt;, the creation of the elector does create a &lt;tt&gt;zkClient&lt;/tt&gt; object with an associated Watcher.&lt;/li&gt;
	&lt;li&gt;in the &lt;tt&gt;testZookeeperFailure&lt;/tt&gt; test case, we shut down and restart ZK. This causes the above Watcher instance to fire its Disconnected and then Connected events. There was a bug in the handling of the Connected event that would cause it to re-monitor the lock znode regardless of whether it was previously in the election.&lt;/li&gt;
	&lt;li&gt;So, when ZK comes back up, there was not two but &lt;b&gt;three&lt;/b&gt; electors racing for the lock. However, two of the electors actually corresponded to the same dummy service. In some cases this race would be resolved in such a way that the test timed out.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I don&apos;t think this is a problem in practice, since the &quot;formatZK&quot; call runs in its own JVM in the current code. However, it&apos;s worth fixing to get the tests to not be flaky, and to have a more reasonable behavior. There are several fixes to be done:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Add extra asserts for &lt;tt&gt;wantToBeInElection&lt;/tt&gt; to catch cases where we might accidentally re-join the election when we weren&apos;t supposed to be in it.&lt;/li&gt;
	&lt;li&gt;Fix the handling of the &quot;Connected&quot; event to only re-join if the elector wants to be in the election&lt;/li&gt;
	&lt;li&gt;Cause exceptions thrown by watcher callbacks to be propagated back as fatal errors&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Will post a patch momentarily.&lt;/p&gt;</comment>
                            <comment id="13246013" author="tlipcon" created="Wed, 4 Apr 2012 04:27:08 +0000"  >&lt;p&gt;Attached patch fixes the flaky behavior for me. I looped TestZKFailoverController for 30+ minutes and didn&apos;t see failures after applying this.&lt;/p&gt;</comment>
                            <comment id="13246073" author="atm" created="Wed, 4 Apr 2012 06:47:52 +0000"  >&lt;p&gt;+1, the patch looks good to me. Good finds/fixes, Todd.&lt;/p&gt;</comment>
                            <comment id="13246618" author="tlipcon" created="Wed, 4 Apr 2012 19:21:28 +0000"  >&lt;p&gt;Committed to branch, thanks for reviewing. I verified all the HA tests passed on branch before committing.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12521277" name="hadoop-8245.txt" size="21100" author="tlipcon" created="Wed, 4 Apr 2012 04:27:07 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>234431</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 33 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i018yv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5222</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12320350">Auto Failover (HDFS-3042)</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>