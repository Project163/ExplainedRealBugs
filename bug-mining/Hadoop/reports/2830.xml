<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:57:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HADOOP-18096] Distcp: Sync moves filtered file to home directory rather than deleting</title>
                <link>https://issues.apache.org/jira/browse/HADOOP-18096</link>
                <project id="12310240" key="HADOOP">Hadoop Common</project>
                    <description>&lt;p&gt;Distcp sync with snapshot, if the file being copied is renamed to a path which is in the exclusion filter, tries to delete the file.&lt;/p&gt;

&lt;p&gt;But instead of deleting, it moves the file to home directory&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13425237">HADOOP-18096</key>
            <summary>Distcp: Sync moves filtered file to home directory rather than deleting</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ayushtkn">Ayush Saxena</assignee>
                                    <reporter username="ayushtkn">Ayush Saxena</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 27 Jan 2022 18:21:23 +0000</created>
                <updated>Sun, 11 Feb 2024 23:32:45 +0000</updated>
                            <resolved>Thu, 10 Feb 2022 20:59:51 +0000</resolved>
                                    <version>3.4.0</version>
                    <version>3.3.2</version>
                                    <fixVersion>3.4.0</fixVersion>
                    <fixVersion>3.3.2</fixVersion>
                                    <component>tools/distcp</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="10200">2h 50m</timespent>
                                <comments>
                            <comment id="17486210" author="ayushtkn" created="Thu, 3 Feb 2022 04:25:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=csun&quot; class=&quot;user-hover&quot; rel=&quot;csun&quot;&gt;csun&lt;/a&gt;] In case the RC is not done yet. Please hold it for sometime to include this one as well&lt;/p&gt;</comment>
                            <comment id="17486633" author="csun" created="Thu, 3 Feb 2022 18:00:36 +0000"  >&lt;p&gt;Got it &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ayushtkn&quot; class=&quot;user-hover&quot; rel=&quot;ayushtkn&quot;&gt;ayushtkn&lt;/a&gt;. Any rough estimate when this will be resolved?&lt;/p&gt;</comment>
                            <comment id="17486641" author="ayushtkn" created="Thu, 3 Feb 2022 18:29:21 +0000"  >&lt;p&gt;Thanx &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=csun&quot; class=&quot;user-hover&quot; rel=&quot;csun&quot;&gt;csun&lt;/a&gt;&lt;br/&gt;
Should be done at max by next week. I have sorted the review comments&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stevel%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;stevel@apache.org&quot;&gt;stevel@apache.org&lt;/a&gt; is helping with the review, so once he gets a chance to re-check, we should be done.&lt;/p&gt;</comment>
                            <comment id="17490514" author="ayushtkn" created="Thu, 10 Feb 2022 20:56:56 +0000"  >&lt;p&gt;Just copying the comment from the PR for posterity:&lt;/p&gt;

&lt;p&gt;The path is actually relative:&lt;br/&gt;
hadoop/hadoop-hdfs-project/hadoop-hdfs-client/src/main/java/org/apache/hadoop/hdfs/protocol/SnapshotDiffReport.java&lt;/p&gt;

&lt;p&gt;Lines 85 to 90 in efdec92&lt;/p&gt;

&lt;p&gt;/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;The relative path (related to the snapshot root) of 1) the file/directory&lt;/li&gt;
	&lt;li&gt;where changes have happened, or 2) the source file/dir of a rename op.&lt;br/&gt;
*/ &lt;br/&gt;
private final byte[] sourcePath; &lt;br/&gt;
private final byte[] targetPath; &lt;br/&gt;
For rename entries it is made absolute here:&lt;br/&gt;
hadoop/hadoop-tools/hadoop-distcp/src/main/java/org/apache/hadoop/tools/DistCpSync.java&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Lines 471 to 474 in efdec92&lt;/p&gt;

&lt;p&gt;for (DiffInfo diff : diffMap.get(SnapshotDiffReport.DiffType.RENAME)) { &lt;br/&gt;
Path source = new Path(targetDir, diff.getSource()); &lt;br/&gt;
Path target = new Path(targetDir, diff.getTarget()); &lt;br/&gt;
renameAndDeleteDiff.add(new DiffInfo(source, target, diff.getType())); &lt;br/&gt;
For normal delete there won&apos;t be any target, it would be always null, so it is added just like that in normal cases.&lt;br/&gt;
hadoop/hadoop-tools/hadoop-distcp/src/main/java/org/apache/hadoop/tools/DistCpSync.java&lt;/p&gt;

&lt;p&gt;Lines 465 to 468 in efdec92&lt;/p&gt;

&lt;p&gt;for (DiffInfo diff : diffMap.get(SnapshotDiffReport.DiffType.DELETE))&lt;/p&gt;

{ Path source = new Path(targetDir, diff.getSource()); renameAndDeleteDiff.add(new DiffInfo(source, diff.getTarget(), diff.getType())); In this particular case when using filters. The actual entry is a RENAME entry which has target. Rename has to have a target. So, it takes this else block hadoop/hadoop-tools/hadoop-distcp/src/main/java/org/apache/hadoop/tools/DistCpSync.java Line 254 in efdec92 }

&lt;p&gt;else if (dt == SnapshotDiffReport.DiffType.RENAME) { &lt;br/&gt;
And when converting it to a DELETE entry, it even adds the target.&lt;br/&gt;
hadoop/hadoop-tools/hadoop-distcp/src/main/java/org/apache/hadoop/tools/DistCpSync.java&lt;/p&gt;

&lt;p&gt;Lines 262 to 265 in efdec92&lt;/p&gt;

&lt;p&gt;list = diffMap.get(SnapshotDiffReport.DiffType.DELETE); &lt;br/&gt;
DiffInfo info = new DiffInfo(source, target, &lt;br/&gt;
SnapshotDiffReport.DiffType.DELETE); &lt;br/&gt;
list.add(info); &lt;br/&gt;
But since it is a delete entry the path isn&apos;t made absolute wrt target. So it stays like a relative path. like filterDir1 and since it doesn&apos;t start with / and the normal logic by default it gets resolved to home directory.&lt;/p&gt;

&lt;p&gt;Then the code that you shared does the magic, it moves it...&lt;/p&gt;

&lt;p&gt;One example of target being set to null :&lt;br/&gt;
hadoop/hadoop-tools/hadoop-distcp/src/main/java/org/apache/hadoop/tools/DistCpSync.java&lt;/p&gt;

&lt;p&gt;Lines 446 to 447 in efdec92&lt;/p&gt;

&lt;p&gt;renameAndDeleteDiff.add(new DiffInfo(source, null, &lt;br/&gt;
SnapshotDiffReport.DiffType.DELETE)); &lt;br/&gt;
May be there could be sanity check in delete diff for target, but not very confident about that part, will explore sometime if there is any use case possible where it can be not-null &amp;amp; compat stuff.&lt;/p&gt;

&lt;p&gt;Further general optimisations as well are possible, like don&apos;t rename to tmp and then delete, directly delete(There is a reason why it is like that), that is something in my TODO list, will chase in future&lt;/p&gt;

&lt;p&gt;General Info: Filters are like quite used in DR setups, some time we don&apos;t want to copy some data to replica clusters. One example could be Trash data, many other use cases as well.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;It looks better at: &lt;a href=&quot;https://github.com/apache/hadoop/pull/3940#issuecomment-1035009857&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/hadoop/pull/3940#issuecomment-1035009857&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17490516" author="ayushtkn" created="Thu, 10 Feb 2022 20:59:34 +0000"  >&lt;p&gt;Committed to trunk, branch-3.3 &amp;amp; 3.3.2&lt;/p&gt;

&lt;p&gt;Thanx &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stack&quot; class=&quot;user-hover&quot; rel=&quot;stack&quot;&gt;stack&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stevel%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;stevel@apache.org&quot;&gt;stevel@apache.org&lt;/a&gt; for the reviews!!!&lt;/p&gt;

&lt;p&gt;Thanx &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=csun&quot; class=&quot;user-hover&quot; rel=&quot;csun&quot;&gt;csun&lt;/a&gt; for holding the release.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                                                <inwardlinks description="is broken by">
                                        <issuelink>
            <issuekey id="13258463">HDFS-14869</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 39 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0z0x4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12346894">3.4.0</customfieldvalue>
    <customfieldvalue id="12350181">3.3.2</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>