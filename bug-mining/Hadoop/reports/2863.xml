<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:57:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HADOOP-18217] shutdownhookmanager should not be multithreaded (deadlock possible)</title>
                <link>https://issues.apache.org/jira/browse/HADOOP-18217</link>
                <project id="12310240" key="HADOOP">Hadoop Common</project>
                    <description>&lt;p&gt;the ShutdownHookManager class uses an executor to run hooks to have a &quot;timeout&quot; notion around them. It does this using a single threaded executor. It can leads to deadlock leaving a never-shutting-down JVM with this execution flow:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;JVM need to exit (only daemon threads remaining or someone called System.exit)&lt;/li&gt;
	&lt;li&gt;ShutdowHookManager kicks in&lt;/li&gt;
	&lt;li&gt;SHMngr executor start running some hooks&lt;/li&gt;
	&lt;li&gt;SHMngr executor thread kicks in and, as a side effect, run some code from one of the hook that calls System.exit (as a side effect from an external lib for example)&lt;/li&gt;
	&lt;li&gt;the executor thread is waiting for a lock because another thread already entered System.exit and has its internal lock, so the executor never returns.&lt;/li&gt;
	&lt;li&gt;SHMngr never returns&lt;/li&gt;
	&lt;li&gt;1st call to System.exit never returns&lt;/li&gt;
	&lt;li&gt;JVM stuck&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;using an executor with a single thread does &quot;fake&quot; timeouts (the task keeps running, you can interrupt it but until it stumble upon some piece of code that is interruptible (like an IO) it will keep running) especially since the executor is a single threaded one. So it has this bug for example :&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;caller submit 1st hook (bad one that would need 1 hour of runtime and that cannot be interrupted)&lt;/li&gt;
	&lt;li&gt;executor start 1st hook&lt;/li&gt;
	&lt;li&gt;caller of the future 1st hook result timeout&lt;/li&gt;
	&lt;li&gt;caller submit 2nd hook&lt;/li&gt;
	&lt;li&gt;bug : 1 hook still running, 2nd hook triggers a timeout but never got the chance to run anyway, so 1st faulty hook makes it impossible for any other hook to have a chance to run, so running hooks in a single separate thread does not allow to run other hooks in parallel to long ones.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;If we really really want to timeout the JVM shutdown, even accepting maybe dirty shutdown, it should rather handle the hooks inside the initial thread (not spawning new one(s) so not triggering the deadlock described on the 1st place) and if a timeout was configured, only spawn a single parallel daemon thread that sleeps the timeout delay, and then use Runtime.halt (which bypass the hook system so should not trigger the deadlock). If the normal System.exit ends before the timeout delay everything is fine. If the System.exit took to much time, the JVM is killed and so the reason why this multithreaded shutdown hook implementation was created is satisfied (avoding having hanging JVMs)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Had the bug with both oracle and open jdk builds, all in 1.8 major version. hadoop 2.6 and 2.7 did not have the issue because they do not run hooks in another thread&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Another solution is of course to configure the timeout AND to have as many threads as needed to run the hooks so to have at least some gain to offset the pain of the dealock scenario&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;EDIT: added some logs and reproduced the problem. in fact it is located after triggering all the hook entries and before shutting down the executor. Current code, after running the hooks, creates a new Configuration object and reads the configured timeout from it, applies this timeout to shutdown the executor. I sometimes run with a classloader doing remote classloading, Configuration loads its content using this classloader, so when shutting down the JVM and some network error occurs the classloader fails to load the ressources needed by Configuration. So the code crash before shutting down the executor and ends up inside the thread&apos;s default uncaught throwable handler, which was calling System.exit, so got stuck, so shutting down the executor never returned, so does the JVM.&lt;/p&gt;

&lt;p&gt;So, forget about the halt stuff (even if it is a last ressort very robust safety net). Still I&apos;ll do a small adjustement to the final executor shutdown code to be slightly more robust to even the strangest exceptions/errors it encounters.&lt;/p&gt;</description>
                <environment>&lt;p&gt;linux, windows, any version&lt;/p&gt;</environment>
        <key id="13441186">HADOOP-18217</key>
            <summary>shutdownhookmanager should not be multithreaded (deadlock possible)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ogrom">Catherinot Remi</assignee>
                                    <reporter username="ogrom">Catherinot Remi</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 22 Apr 2022 15:34:28 +0000</created>
                <updated>Sun, 28 Jan 2024 08:25:40 +0000</updated>
                            <resolved>Wed, 13 Jul 2022 11:44:32 +0000</resolved>
                                    <version>2.10.1</version>
                                    <fixVersion>3.4.0</fixVersion>
                    <fixVersion>3.3.5</fixVersion>
                                    <component>util</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="16800">4h 40m</timespent>
                                <comments>
                            <comment id="17526555" author="stevel@apache.org" created="Fri, 22 Apr 2022 16:43:19 +0000"  >&lt;p&gt;hmm.&lt;/p&gt;

&lt;p&gt;i&apos;d thought that code would fail fast if the hook was called while active, but it looks like System.exit() has its own lock so doesn&apos;t get that far.&lt;/p&gt;

&lt;p&gt;we cannot have a thread pool for shutdown because during shutdown there&apos;s no guarantee that threads can be created. hence we have that single executor created in advance.&lt;/p&gt;

&lt;p&gt;i like the idea about having the parallel thread to sleep then halt(); it guarantees that thread won&apos;t be calling anything which could itself call system.exit(). fancy submitting a patch}&lt;/p&gt;

&lt;p&gt;note, it wouldn&apos;t quite do what we do now, which is to continue to shut down the other hooks if one times out. historically it&apos;s been network/service outage problems which caused some hook to fail.&lt;/p&gt;</comment>
                            <comment id="17526693" author="JIRAUSER288476" created="Fri, 22 Apr 2022 21:48:00 +0000"  >&lt;p&gt;added wtf.java to show what i have in mind before proposing a patch (patch would also slightly rework try/catch/finally blocks to ensure the executor is shutdown). If puts in place 2 differents safety nets : the delayed Runtime.halt one + an uncaught throwable one. From the command line you can run 4 scenarios : normal ending, System.exit ending, uncaugh Throwable ending, bad hook ending.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Still i would rather remove the executor stuff since being monothread only makes timeout visible and logged, but does not makes all hooks to run. In wtf.java for exemple, the 1st hook runs, timeout and cancel is called, but even with that, calling cancel on the 2nd future just keep interrupting the 1st (because future.cancel interrupt the only running thread, currently running f1&apos;s code).&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The uncaught handler safety net in the code is one I use to exit from JVM that get OOM errors. Error not being Exception are often not catched/handled (to trigger cleanup code and rethrow them) and often break asynchronous jobs (the oom raised often make the synchronized/notify block of code to be skipped, never unlocking the caller stuck inside the synchronized/wait block counter-part). I can be dangerous though when used with fraemworks that just spawn threads and let them die by crashing. Hopefully this is not a very common pattern &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;For the patch, to minimize the changes and to be as safe as possible, I would only keep the delayed halt safety net + slight try/catch/finally rework around the exectutor shutdown calls.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The uncaught throwable safety net is just a proposal.&lt;/p&gt;

&lt;p&gt;Removing the executor is just a proposal too, or change the future.cancel call to keep calling it on a future until it is effectively cancelled (calling cancel once is not enough has wtf.java demonstrate)&lt;/p&gt;</comment>
                            <comment id="17526816" author="stevel@apache.org" created="Sat, 23 Apr 2022 10:25:50 +0000"  >&lt;p&gt;bit reluctant to add another scheduled thread...if there isn&apos;t one then maybe we should add a single executor for timed/intervaled operations, locate other uses and share it.&lt;/p&gt;

&lt;p&gt;also, all hadoop code should be using ExitUtil for exiting. if we need to improve that for reentrancy, it is safer&lt;/p&gt;</comment>
                            <comment id="17526863" author="JIRAUSER288476" created="Sat, 23 Apr 2022 13:56:11 +0000"  >&lt;p&gt;The Thread delaying the Runtime.halt call being a last resort safety net, I think its thread should really be outiside anything else hadoop or any running framework (mapreduce, yarn, tez, spark, etc.) does, so it should not be a thread from a pool someone else may use (and starve, preventing the halt to be called, or interrupt making the halt to be triggered to early). It can still use the Thread ShutdownHookManager register as a system hook as its launcher though, this would reduce the number of needed extra threads to 1.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;About calling ExitUtil.halt ok, but ExitUtil needs a fix too then. It catches Exception in case of OOM, but unfortunately OOM are Errors, not Exceptions. Currently there are scenarios where it would not call Runtime.halt while it should have. The call, when not disbaled, should be done in a finally block to be called whatever happened. Same goes for the ExitUtil wrapper around System.exit call: it needs a try/finally whene enabled.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;So that would go that way :&lt;/p&gt;

&lt;p&gt;ShutdownHookManager being responsible of the all the hadoop like hooks will also be responsible to preallocated and start the delayed halt thread. Starting the delayed halt will be its 1st thing to do when hooked, not even logging, not reading confs, etc. It will continue what it is coded for after that the way it currently does.&lt;/p&gt;

&lt;p&gt;ShutdowHookManager own hook thread will have a name (was hard to understand what was this &quot;Thread-10&quot; blocking my JVMs, it had no hadoop stacks in it even if it was coming from it). The delayed halt thread will have a name too.&lt;/p&gt;

&lt;p&gt;ShutdownHookManager is already shared and handles its singleton, so that would avoid (hadoop util being in the bootstarp classloader) having it installed more than once with different delays&lt;/p&gt;

&lt;p&gt;Delayed halt thread will sleep and then use ExitUtil to do call its halt wrapper, so may have no effect if ExitUtil&apos;s halt is disabled&lt;/p&gt;

&lt;p&gt;ExitUtil exit/halt wrappers will be patched to be more robust to all Throwable, so even Error, not just Exception&lt;/p&gt;

&lt;p&gt;ShutdownHookManager delayed halt thread and the HaltException will be pre-allocated, including loading the configuration to parse the timeout delay from it. Any Throwable raised during this initialization phase would end up setting up defaults and being logged. Throwable won&apos;t forbid the ShutdownHookManager to install itself as a hook.&lt;/p&gt;

&lt;p&gt;delayed halt thread will be a daemon so it does not block the JVM from dying of normal death if all hooks ends before the configured delay&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;question : what halt code to use ? &quot;configurable with a default&quot; or &quot;hardcoded but documented&quot; ?&lt;/p&gt;</comment>
                            <comment id="17527406" author="JIRAUSER288476" created="Mon, 25 Apr 2022 10:25:23 +0000"  >&lt;p&gt;Maybe this bug is more a java one has, in the simpliest way, the JVM got stuck because of this kind of flow :&lt;/p&gt;

&lt;p&gt;public class Stuck {&lt;br/&gt;
   public static void main(String...args) {&lt;br/&gt;
      Runtime.getRuntime().addShutdownHook(&lt;br/&gt;
         new Thread(&quot;hook&quot;) {public void run() {System.exit(1);}}&lt;br/&gt;
      );&lt;br/&gt;
&#160;&#160; }&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;I&apos;m currently working on a JDK patch to test a fix in java.lang.Shutdown.exit(...) method. Whatever my results about it, I&apos;ll get in touch with the OpenJDk community on that exit issue.&lt;/p&gt;

&lt;p&gt;About ExitUtil, it has 2 bugs:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;since System.exit can get stuck, its call should not be done inside a synchronized block, synchronizing on the same thing that also synchronize ExitUtil wrapper around Runtime.halt (thus ExitUtil cannot be used to halt when you used it to exit and get the stuck-bug),&lt;/li&gt;
	&lt;li&gt;use try/finally to make it more robust and ensure System.exit and Runtime.halt really get called if not disabled&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;So maybe it is better if :&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;close this bug,&lt;/li&gt;
	&lt;li&gt;have the delayed halt be a proposal for ShutdownHookManager (would use 9 has the exit code, since only SIGKILL is the only way to close the JVM and its a 9)&lt;/li&gt;
	&lt;li&gt;have a bug to trace ExitUtil patch&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17527474" author="stevel@apache.org" created="Mon, 25 Apr 2022 12:56:36 +0000"  >&lt;p&gt;fixes to exit util would be great&lt;/p&gt;</comment>
                            <comment id="17530644" author="JIRAUSER288476" created="Mon, 2 May 2022 08:41:34 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;I&apos;ve added a pull request for the ExitUtil part. I&apos;ve kept this JIRA&apos;s ID for that.&lt;/p&gt;

&lt;p&gt;Regards&lt;/p&gt;</comment>
                            <comment id="17566276" author="stevel@apache.org" created="Wed, 13 Jul 2022 11:44:32 +0000"  >&lt;p&gt;committed to branch-3.3 and above&lt;/p&gt;</comment>
                            <comment id="17566277" author="stevel@apache.org" created="Wed, 13 Jul 2022 11:44:57 +0000"  >&lt;p&gt;given this is a deadlock issue, should we target branch-3.2 and 2.10.x?&lt;/p&gt;</comment>
                            <comment id="17566292" author="JIRAUSER288476" created="Wed, 13 Jul 2022 12:07:45 +0000"  >&lt;p&gt;This patch is more on the robustness than on the deadlock itself. The real deadlock issue would be fixed by a delayed ExitUtil.halt call. The delayed halt will benefit from this increase of robustness as well as anyone using ExitUtil terminate and halt calls. Now that the pull request is closed I&apos;ll start another JIRA for the delayed halt proposal, and work on it if voted has being an acceptable solution.&lt;/p&gt;

&lt;p&gt;If 3.2 and 2.10.x branches are not in a &quot;end of support&quot; state, I would say targeting them can be good. For example, as a &quot;customer&quot;, I myself still use version 2 line of hadoop release in production. So a 2.10.x fix would be good for &quot;me the customer&quot;.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13042815" name="wtf.java" size="6131" author="ogrom" created="Fri, 22 Apr 2022 21:27:05 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12314421" key="com.atlassian.jira.plugin.system.customfieldtypes:labels">
                        <customfieldname>Language</customfieldname>
                        <customfieldvalues>
                                        <label>java</label>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 17 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z11pzk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12346894">3.4.0</customfieldvalue>
    <customfieldvalue id="12350632">3.3.5</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>