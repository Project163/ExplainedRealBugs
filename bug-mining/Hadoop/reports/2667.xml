<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:56:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HADOOP-17158] Test timeout for ITestAbfsInputStreamStatistics#testReadAheadCounters</title>
                <link>https://issues.apache.org/jira/browse/HADOOP-17158</link>
                <project id="12310240" key="HADOOP">Hadoop Common</project>
                    <description>&lt;p&gt;Intermittent test timeout for ITestAbfsInputStreamStatistics#testReadAheadCounters happening due to race conditions in readAhead threads.&lt;/p&gt;

&lt;p&gt;Test error:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[ERROR] testReadAheadCounters(org.apache.hadoop.fs.azurebfs.ITestAbfsInputStreamStatistics)&#160; Time elapsed: 30.723 s&#160; &amp;lt;&amp;lt;&amp;lt; ERROR!org.junit.runners.model.TestTimedOutException: test timed out after 30000 milliseconds&#160;&#160;&#160;&#160;&#160;&#160;&#160; at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(Native Method)&#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.apache.hadoop.fs.azurebfs.ITestAbfsInputStreamStatistics.testReadAheadCounters(ITestAbfsInputStreamStatistics.java:346)&#160;&#160;&#160;&#160;&#160;&#160;&#160; at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&#160;&#160;&#160;&#160;&#160;&#160;&#160; at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)&#160;&#160;&#160;&#160;&#160;&#160;&#160; at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)&#160;&#160;&#160;&#160;&#160;&#160;&#160; at java.lang.reflect.Method.invoke(Method.java:498)&#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:50)&#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)&#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:47)&#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)&#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.junit.internal.runners.statements.FailOnTimeout$CallableStatement.call(FailOnTimeout.java:298)&#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.junit.internal.runners.statements.FailOnTimeout$CallableStatement.call(FailOnTimeout.java:292)&#160;&#160;&#160;&#160;&#160;&#160;&#160; at java.util.concurrent.FutureTask.run(FutureTask.java:266)&#160;&#160;&#160;&#160;&#160;&#160;&#160; at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)&#160;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Possible Reasoning:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;ReadAhead queue doesn&apos;t get completed and hence the counter values are not satisfied in 30 seconds time for some systems.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The condition that readAheadBytesRead and remoteBytesRead counter values need to be greater than or equal to 4KB and 32KB respectively doesn&apos;t occur in some machines due to the fact that sometimes instead of reading for readAhead Buffer, remote reads are performed due to Threads still being in the readAhead queue to fill that buffer. Thus resulting in either of the 2 counter values to be not satisfying the condition and getting in an infinite loop and hence timing out the test eventually.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Possible Fixes:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Write better test(That would pass under all conditions).&lt;/li&gt;
	&lt;li&gt;Maybe UT instead of IT?&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Possible fix to better the test would be preferable and UT as the last resort.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13319553">HADOOP-17158</key>
            <summary>Test timeout for ITestAbfsInputStreamStatistics#testReadAheadCounters</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mehakmeetSingh">Mehakmeet Singh</assignee>
                                    <reporter username="mehakmeetSingh">Mehakmeet Singh</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 27 Jul 2020 13:42:46 +0000</created>
                <updated>Mon, 17 May 2021 03:09:16 +0000</updated>
                            <resolved>Tue, 8 Sep 2020 09:12:21 +0000</resolved>
                                    <version>3.3.0</version>
                                    <fixVersion>3.3.1</fixVersion>
                    <fixVersion>3.4.0</fixVersion>
                                    <component>fs/azure</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="3600">1h</timespent>
                                <comments>
                            <comment id="17166392" author="stevel@apache.org" created="Tue, 28 Jul 2020 12:27:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bilahari.th&quot; class=&quot;user-hover&quot; rel=&quot;bilahari.th&quot;&gt;bilahari.th&lt;/a&gt; is seeing this consistently, so he may be in a good position to help debug the problem.&lt;/p&gt;

&lt;p&gt;Bilihari -what&apos;s your test setup? Are you doing the parallel runs? And is your test system close to the store network-wise?&lt;/p&gt;

&lt;p&gt;Mehakmeet - does the test timeout more in parallel runs?&lt;/p&gt;

&lt;p&gt;Imagine we had a gauge of queue size which could be accessed from the FS instance...would that help in the tests?&lt;/p&gt;

</comment>
                            <comment id="17167149" author="mehakmeetsingh" created="Wed, 29 Jul 2020 11:34:48 +0000"  >&lt;p&gt;For me, It&apos;s not timing out actually. I am running on East US bucket.&lt;/p&gt;</comment>
                            <comment id="17167940" author="mehakmeetsingh" created="Thu, 30 Jul 2020 13:54:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bilahari.th&quot; class=&quot;user-hover&quot; rel=&quot;bilahari.th&quot;&gt;bilahari.th&lt;/a&gt;, Can you tell which bucket were you using for testing, and was it only parallel runs or all runs that were timing out?&lt;/p&gt;

&lt;p&gt;Also, can you remove the timeout limit and the thread sleep() condition from the test and run it a few times and post the trace here, so I could know what are the counter values that are coming in your setup?&lt;/p&gt;</comment>
                            <comment id="17180508" author="bilahari.th" created="Wed, 19 Aug 2020 12:40:22 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mehakmeetSingh&quot; class=&quot;user-hover&quot; rel=&quot;mehakmeetSingh&quot;&gt;mehakmeetSingh&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stevel%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;stevel@apache.org&quot;&gt;stevel@apache.org&lt;/a&gt;, I am still seeing this one.&lt;br/&gt;
I am testing against cental india region.&lt;br/&gt;
Regarding my test setup, I tested with both sharedkey as well as OAuth. And the same is observed in both the scenarios.&lt;br/&gt;
I tried running the test individually from my IDE after removing the timeout and sleep. PFB the stacktrace.&lt;/p&gt;

&lt;p&gt;org.junit.runners.model.TestTimedOutException: test timed out after 900000 milliseconds&lt;/p&gt;

&lt;p&gt;	at app//org.apache.hadoop.fs.azurebfs.ITestAbfsInputStreamStatistics.testReadAheadCounters(ITestAbfsInputStreamStatistics.java:344)&lt;br/&gt;
	at java.base@11.0.8/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
	at java.base@11.0.8/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)&lt;br/&gt;
	at java.base@11.0.8/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)&lt;br/&gt;
	at java.base@11.0.8/java.lang.reflect.Method.invoke(Method.java:566)&lt;br/&gt;
	at app//org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:50)&lt;br/&gt;
	at app//org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)&lt;br/&gt;
	at app//org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:47)&lt;br/&gt;
	at app//org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)&lt;br/&gt;
	at app//org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:26)&lt;br/&gt;
	at app//org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:27)&lt;br/&gt;
	at app//org.junit.rules.TestWatcher$1.evaluate(TestWatcher.java:55)&lt;br/&gt;
	at app//org.junit.internal.runners.statements.FailOnTimeout$CallableStatement.call(FailOnTimeout.java:298)&lt;br/&gt;
	at app//org.junit.internal.runners.statements.FailOnTimeout$CallableStatement.call(FailOnTimeout.java:292)&lt;br/&gt;
	at java.base@11.0.8/java.util.concurrent.FutureTask.run(FutureTask.java:264)&lt;br/&gt;
	at java.base@11.0.8/java.lang.Thread.run(Thread.java:834)&lt;/p&gt;
</comment>
                            <comment id="17182912" author="mehakmeetsingh" created="Mon, 24 Aug 2020 02:58:29 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bilahari.th&quot; class=&quot;user-hover&quot; rel=&quot;bilahari.th&quot;&gt;bilahari.th&lt;/a&gt;, Thanks for the info. &lt;br/&gt;
I expected to see test failures with expected values compared to the actual values rather than timeout error. I hope you have removed the whole &quot;while&quot; condition block rather than just the sleep() method. If not, Can you please, try with removing the whole &quot;while&quot; condition block from the test and the test timeout limit, and then send the trace.&lt;/p&gt;</comment>
                            <comment id="17183550" author="bilahari.th" created="Mon, 24 Aug 2020 19:07:38 +0000"  >&lt;p&gt;I will try that. But shouldn&apos;t we expect an outcome in 15 minutes(900000 milliseconds)?&lt;/p&gt;</comment>
                            <comment id="17183556" author="mehakmeetsingh" created="Mon, 24 Aug 2020 19:26:15 +0000"  >&lt;p&gt;Thanks for checking, since it never fails for me, I could only rely on your traces.&lt;br/&gt;
Yes, we should. But the reason why it is timing out is that the condition of while loop isn&apos;t being fulfilled till the end, hence it becomes an infinite loop. The reasoning for this is that the counter value of either of the counter is never reaching the expected value.&lt;br/&gt;
So, we are checking 2 counters readAheadBytesRead and remoteBytesRead, most probably what is happening is that the readAhead buffer which fills in the background threads is never filled when data is to be read in your case which could result in remote reads instead of readAhead reads and hence never reaching the counter values.&#160;&lt;br/&gt;
I just need to confirm the actual counter values in your setup(Which I suspect readAheadBytesRead could be 0). I was expecting the value to be greater than or equal to the block size(I set it to 4KB).&lt;br/&gt;
But, nevertheless, I would write a better test as the values could be quite arbitrary(Race conditions involved) without sleeping.&lt;/p&gt;</comment>
                            <comment id="17192061" author="stevel@apache.org" created="Tue, 8 Sep 2020 09:12:21 +0000"  >&lt;p&gt;fixed in trunk; happy to cherrypick to -3.3 if you are&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13319673">HADOOP-17160</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 10 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0h8fc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>