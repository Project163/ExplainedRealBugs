<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:46:56 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HADOOP-11157] ZKDelegationTokenSecretManager never shuts down listenerThreadPool</title>
                <link>https://issues.apache.org/jira/browse/HADOOP-11157</link>
                <project id="12310240" key="HADOOP">Hadoop Common</project>
                    <description>&lt;p&gt;I&apos;m trying to integrate Solr with the DelegationTokenAuthenticationFilter and running into this issue.  The solr unit tests look for leaked threads and when I started using the ZKDelegationTokenSecretManager it started reporting leaks.  Shuting down the listenerThreadPool after the objects that use it resolves the leak threads errors.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12745115">HADOOP-11157</key>
            <summary>ZKDelegationTokenSecretManager never shuts down listenerThreadPool</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="asuresh">Arun Suresh</assignee>
                                    <reporter username="gchanan">Gregory Chanan</reporter>
                        <labels>
                    </labels>
                <created>Tue, 30 Sep 2014 23:51:41 +0000</created>
                <updated>Fri, 24 Apr 2015 22:49:06 +0000</updated>
                            <resolved>Mon, 17 Nov 2014 21:08:41 +0000</resolved>
                                    <version>2.6.0</version>
                                    <fixVersion>2.7.0</fixVersion>
                                    <component>security</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14154048" author="gchanan" created="Tue, 30 Sep 2014 23:55:55 +0000"  >&lt;p&gt;Here&apos;s a patch that addresses the issue.  I moved the listenerThreadPool to follow the same lifetime as the keyCache/tokenCache.  I&apos;m not sure how to add a testcase because it is a thread leak; are there any existing tests that look for thread leaks?&lt;/p&gt;</comment>
                            <comment id="14154204" author="hadoopqa" created="Wed, 1 Oct 2014 01:41:43 +0000"  >&lt;p&gt;&lt;font color=&quot;red&quot;&gt;-1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12672199/HADOOP-11157.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12672199/HADOOP-11157.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision a469833.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 tests included&lt;/font&gt;.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javadoc&lt;/font&gt;.  There were no new javadoc warning messages.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 eclipse:eclipse&lt;/font&gt;.  The patch built with eclipse:eclipse.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 findbugs&lt;/font&gt;.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 release audit&lt;/font&gt;.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 core tests&lt;/font&gt;.  The patch failed these unit tests in hadoop-common-project/hadoop-common:&lt;/p&gt;

&lt;p&gt;                  org.apache.hadoop.crypto.random.TestOsSecureRandom&lt;br/&gt;
                  org.apache.hadoop.metrics2.impl.TestMetricsSystemImpl&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 contrib tests&lt;/font&gt;.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/4841//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/4841//testReport/&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/4841//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/4841//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14182284" author="gchanan" created="Fri, 24 Oct 2014 01:22:22 +0000"  >&lt;p&gt;Kicking off the job again.&lt;/p&gt;</comment>
                            <comment id="14182326" author="hadoopqa" created="Fri, 24 Oct 2014 02:22:09 +0000"  >&lt;p&gt;&lt;font color=&quot;red&quot;&gt;-1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12676805/HADOOP-11157.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12676805/HADOOP-11157.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision db45f04.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 tests included&lt;/font&gt;.  The patch doesn&apos;t appear to include any new or modified tests.&lt;br/&gt;
                        Please justify why no new tests are needed for this patch.&lt;br/&gt;
                        Also please list what manual steps were performed to verify this patch.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javadoc&lt;/font&gt;.  There were no new javadoc warning messages.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 eclipse:eclipse&lt;/font&gt;.  The patch built with eclipse:eclipse.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 findbugs&lt;/font&gt;.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 release audit&lt;/font&gt;.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 core tests&lt;/font&gt;.  The patch failed these unit tests in hadoop-common-project/hadoop-common:&lt;/p&gt;

&lt;p&gt;                  org.apache.hadoop.security.token.delegation.web.TestWebDelegationToken&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 contrib tests&lt;/font&gt;.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/4944//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/4944//testReport/&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/4944//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/4944//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14185623" author="gchanan" created="Mon, 27 Oct 2014 19:03:22 +0000"  >&lt;p&gt;Test failure looks unrelated, passes locally for me.&lt;/p&gt;</comment>
                            <comment id="14185805" author="kkambatl" created="Mon, 27 Oct 2014 21:01:07 +0000"  >&lt;p&gt;Thanks for working on this, Greg. &lt;/p&gt;

&lt;p&gt;Couple of minor comments: Can we wait for a timeout after shutdown? Also, it would be nice to have a unit test. &lt;/p&gt;</comment>
                            <comment id="14187567" author="gchanan" created="Tue, 28 Oct 2014 22:07:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kkambatl&quot; class=&quot;user-hover&quot; rel=&quot;kkambatl&quot;&gt;kkambatl&lt;/a&gt; while writing up a test as you requested, I found a number of other issues.  This will be kind of scatter-brained, sorry:&lt;/p&gt;

&lt;p&gt;1) related to shutdown&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;a) the ExpiredToken is shut down after the ZKDelegationTokenSecretManager&apos;s curator, which causes an exception to be thrown and the process to exit.  This can be addressed by shutting down the ExpiredToken thread before the curator.&lt;/li&gt;
	&lt;li&gt;b) even with a), the ExpiredTokenThread is interrupted by AbstractDelegationTokenSecretManager.closeThreads...if the ExpiredTokenThread is currently rolling the master key or expiring tokens in ZK, the interruption will cause the process to exit.  It seems like this can be addressed by holding the noInterruptsLock while the ExpiredTokenThread is not sleeping (should be waiting), but I&apos;m not sure if we want to go that route.  Perhaps alternatively we could deal with the interruption by checking if its expected (i.e. if running is false).  One issue is that approach is that the ZKDelegationTokenSecretManager functions called from the ExpiredTokenThread don&apos;t throw or keep the interrupt flag, they just catch the exceptions and possibly throw them as a runtime exception.  I&apos;m not sure if we can just swallow the InterruptedException &amp;#8211; presumably we need the ZK state to be in some reasonable state in case the process restarts?  Of course we have no tests of that...&lt;br/&gt;
2) not related to shutdown&lt;/li&gt;
	&lt;li&gt;a) if you run TestZKDelegationTokenSecretManager#testCancelTokenSingleManager in a loop it will fail eventually.  It looks like the issue is how we deal with asynchronous ZK updates.&lt;br/&gt;
Consider the following code:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;token = createToken
cancelToken(token)
verifyToken(token)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;cancelToken will delete it from the local cache and delete the znode.  But the curator client will get the create child message (in the listener thread) and add the token back.  If that happens after cancelToken, the token will be added back until the listener thread gets the cancel message again.  (It also just occurred to me that this is happening in two different threads but some of the structures, like the currentToken, aren&apos;t thread safe).  The usual way to prevent this is to assign versions to the znodes so you can track whether you are getting an update for an old version.  I don&apos;t know how to deal with it in this case where deletes are a possibility and there doesn&apos;t appear to be a master that is responsible for writing (i.e. what is preventing some other SecretManager from recreating the token just after delete &amp;#8211; how would versions help with that?).  This may affect the keyCache as well as the tokenCache.&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14187594" author="gchanan" created="Tue, 28 Oct 2014 22:20:21 +0000"  >&lt;p&gt;Here&apos;s another issue I think could happen, but have no test for:&lt;br/&gt;
1) set up two SecretManagers sharing zk&lt;br/&gt;
2) get a delegation token from one&lt;br/&gt;
3) use on both&lt;br/&gt;
4) renew on one around token expiration time&lt;/p&gt;

&lt;p&gt;Then, both SecretManagers will run the token expiration code and possibly expire the newly renewed token.&lt;/p&gt;</comment>
                            <comment id="14189205" author="asuresh" created="Wed, 29 Oct 2014 22:58:20 +0000"  >&lt;p&gt;Uploading new patch.&lt;/p&gt;

&lt;p&gt;Summary of changes :&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Changed the listener threadpool to a SingleThreadedExecutor so that ZK watch updates are always processed in the order it is received.&lt;/li&gt;
	&lt;li&gt;add/update/delete of a token used to updated the localCache first and then make changes in ZK. Changed this to ensure that localCache is always updated as a result of a ZK notification.&lt;/li&gt;
	&lt;li&gt;Fixed up the stopThreads to call super first&lt;/li&gt;
	&lt;li&gt;During shutdown of AbstractDTSM, there can be calls to increment Delegation token seqnum or KeyId.. which is a ZK operation now.. this used to result in an InterruptedException which used to be thrown as a RuntimeException. This is now caught and ignored (There is no possibility of an inconsistent state in ZK..)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I ran the test around 10 - 20 times in a loop.. Havnt seen an issue yet..&lt;/p&gt;</comment>
                            <comment id="14189301" author="hadoopqa" created="Wed, 29 Oct 2014 23:42:01 +0000"  >&lt;p&gt;&lt;font color=&quot;green&quot;&gt;+1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12678049/HADOOP-11157.2.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12678049/HADOOP-11157.2.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 3ae84e1.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 tests included&lt;/font&gt;.  The patch appears to include 1 new or modified test files.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javadoc&lt;/font&gt;.  There were no new javadoc warning messages.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 eclipse:eclipse&lt;/font&gt;.  The patch built with eclipse:eclipse.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 findbugs&lt;/font&gt;.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 release audit&lt;/font&gt;.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 core tests&lt;/font&gt;.  The patch passed unit tests in hadoop-yarn-project/hadoop-yarn/hadoop-yarn-applications/hadoop-yarn-applications-distributedshell.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 contrib tests&lt;/font&gt;.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/4984//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/4984//testReport/&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/4984//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/4984//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14191152" author="gchanan" created="Fri, 31 Oct 2014 01:13:50 +0000"  >&lt;p&gt;Some notes:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void processTokenAddOrUpdate(ChildData data) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
    Stat stat = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
      stat = zkClient.checkExists().forPath(data.getPath());
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
      LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Could not get path &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; Token Add/Update notification.. going to update !!&quot;&lt;/span&gt;, e);
      stat = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I don&apos;t think setting stat to null is necessary and I don&apos;t understand the warning &amp;#8211; aren&apos;t you not going to do anything in the rest of the function because stat is null anyway?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;+      stat = zkClient.checkExists().forPath(data.getPath());
+    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
+      LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Could not get path &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; Token Delete notification.. going to delete from localcache !!&quot;&lt;/span&gt;, e);
+      stat = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
+    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Again, setting stat to null doesn&apos;t seem necessary.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;+    &lt;span class=&quot;code-comment&quot;&gt;// Check &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; Token has already been cancelled..
&lt;/span&gt;+    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (stat == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Here, and in the opposite case where stat == null on the add/remove, don&apos;t we want to handle those cases?  We aren&apos;t guaranteed to see every notification (&lt;a href=&quot;http://zookeeper.apache.org/doc/trunk/zookeeperProgrammers.html#ch_zkWatches&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://zookeeper.apache.org/doc/trunk/zookeeperProgrammers.html#ch_zkWatches&lt;/a&gt;).  Should we just have one handle function where you run the logic based on the current state?&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;It would be nice if there were a test for starting a secret manager after a delegation token on another secret manager has already been created, and verifying it works.  Also, the same case but shutting down and restarting a secret manager and verifying the tokens (for itself or for others still works).&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14191185" author="asuresh" created="Fri, 31 Oct 2014 01:48:20 +0000"  >&lt;blockquote&gt;&lt;p&gt;Here, and in the opposite case where stat == null on the add/remove, don&apos;t we want to handle those case&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;No, in the event the node receives an Add / Update event, it checks ZK.. it stores in local cache ONLY if (stat != null).. it (stat == null) it should not do anything, since the node might have been removed by another ZKDTSM. As per the Log message.. I agree i can change it.. I am also considering throwing the &lt;tt&gt;IOException&lt;/tt&gt; and bailing out if it can&apos;t reach ZK.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;We aren&apos;t guaranteed to see every notification (&lt;a href=&quot;http://zookeeper.apache.org/doc/trunk/zookeeperProgrammers.html#ch_zkWatches&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://zookeeper.apache.org/doc/trunk/zookeeperProgrammers.html#ch_zkWatches&lt;/a&gt;)&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I am using Curator PathCache.. which as per the documentation and some discussion sez it receives all events eventually : &lt;a href=&quot;https://groups.google.com/forum/#!msg/curator-users/mGkG8w6PG9w/zv8jkiEEE78J&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://groups.google.com/forum/#!msg/curator-users/mGkG8w6PG9w/zv8jkiEEE78J&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;It would be nice if there were a test for starting a secret manager after a delegation token on another secret manager has already been &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;sure.. will add some more tests..&lt;/p&gt;
</comment>
                            <comment id="14191212" author="asuresh" created="Fri, 31 Oct 2014 02:33:00 +0000"  >&lt;p&gt;Uploading new patch..&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;I removed the Stat checks from the add/remove and delete method. I was thinking this should be required.. If we agree that Each node will receive all node state changes (The Curator framework gurantees that.. you can check the Path Cache code.. looks like on reregistering with ZK after a watch.. it checks to see state change)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;I added another test case.. that test node shutdown and startup after sometime etc..&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I also ran the test multiple times in a loop.. i dont see any errors..&lt;/p&gt;</comment>
                            <comment id="14191275" author="hadoopqa" created="Fri, 31 Oct 2014 03:33:06 +0000"  >&lt;p&gt;&lt;font color=&quot;green&quot;&gt;+1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12678383/HADOOP-11157.3.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12678383/HADOOP-11157.3.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision e1f7d65.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 tests included&lt;/font&gt;.  The patch appears to include 1 new or modified test files.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javadoc&lt;/font&gt;.  There were no new javadoc warning messages.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 eclipse:eclipse&lt;/font&gt;.  The patch built with eclipse:eclipse.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 findbugs&lt;/font&gt;.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 release audit&lt;/font&gt;.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 core tests&lt;/font&gt;.  The patch passed unit tests in hadoop-common-project/hadoop-common.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 contrib tests&lt;/font&gt;.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/4992//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/4992//testReport/&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/4992//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/4992//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14192859" author="gchanan" created="Sat, 1 Nov 2014 01:11:48 +0000"  >&lt;p&gt;Thanks for the patch, Arun.&lt;/p&gt;

&lt;p&gt;Some notes:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;I haven&apos;t looked at the renew logic in depth and will probably skip it as outside the scope of this JIRA.&lt;/li&gt;
	&lt;li&gt;I haven&apos;t looked at the new cancel logic in depth, but I will soon.&lt;/li&gt;
	&lt;li&gt;The new tests look good&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Other things:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; NUM_ZK_RETRIES = 3;
+  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; ZK_RETRY_WAIT_MS = 200;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;These don&apos;t seem to be used.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;+        +        ZK_DTSM_ZK_SHUTDOWN_TIMEOUT_DEFAULT);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;extra plus?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    allKeys.put(key.getKeyId(), key);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;does this need to be synchronized?  Why does the currentToken stuff need to be, but this not?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;      LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; interrupted &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; performing token counter increment&quot;&lt;/span&gt;, e);
      LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; interrupted &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; performing keyId increment&quot;&lt;/span&gt;, e);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Set the interrupt flag in both these cases?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; ExecutorService getListenerThreadPool() {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;@VisibleForTesting?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(5000);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Maybe make a constant (it&apos;s used a couple times) and reduce the time?  Seems like a second should be sufficient&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-comment&quot;&gt;// Create a &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; token on ne ZKDTSM&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;ne?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void verifyDestroy(DelegationTokenManager tm, Configuration conf)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;rename to destroyAndVerify?&lt;/p&gt;

&lt;p&gt;Some idents seem to be 2 spaces, some 4.&lt;/p&gt;</comment>
                            <comment id="14193749" author="asuresh" created="Sun, 2 Nov 2014 07:34:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gchanan&quot; class=&quot;user-hover&quot; rel=&quot;gchanan&quot;&gt;gchanan&lt;/a&gt;, Uploaded patch addressing some of your comments&lt;/p&gt;

&lt;p&gt;wrt. if &lt;tt&gt;allKeys&lt;/tt&gt; need to be synchronized like &lt;tt&gt;currentTokens&lt;/tt&gt; :&lt;br/&gt;
It doesn&apos;t.. Unlike &lt;tt&gt;currentTokens&lt;/tt&gt;, an update to the &lt;tt&gt;allKeys&lt;/tt&gt; maps happens only during a &lt;tt&gt;rollMasterKeys()&lt;/tt&gt; operation and each ZKDTSM always rolls over a different set of keys.&lt;/p&gt;</comment>
                            <comment id="14193755" author="hadoopqa" created="Sun, 2 Nov 2014 08:32:05 +0000"  >&lt;p&gt;&lt;font color=&quot;green&quot;&gt;+1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12678774/HADOOP-11157.4.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12678774/HADOOP-11157.4.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 5c0381c.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 tests included&lt;/font&gt;.  The patch appears to include 1 new or modified test files.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javadoc&lt;/font&gt;.  There were no new javadoc warning messages.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 eclipse:eclipse&lt;/font&gt;.  The patch built with eclipse:eclipse.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 findbugs&lt;/font&gt;.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 release audit&lt;/font&gt;.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 core tests&lt;/font&gt;.  The patch passed unit tests in hadoop-common-project/hadoop-common.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 contrib tests&lt;/font&gt;.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/5003//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/5003//testReport/&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/5003//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/5003//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14195946" author="gchanan" created="Tue, 4 Nov 2014 09:26:47 +0000"  >&lt;p&gt;Hmm, I put all the test methods in a loop that ran 100 times and testMultiNodeOperations failed (others might as well, but that one failed first).&lt;/p&gt;</comment>
                            <comment id="14195954" author="asuresh" created="Tue, 4 Nov 2014 09:37:31 +0000"  >&lt;p&gt;Can you point me to where it failed exactly ?&lt;/p&gt;</comment>
                            <comment id="14196508" author="gchanan" created="Tue, 4 Nov 2014 18:19:23 +0000"  >&lt;p&gt;Looks like it&apos;s only the one test (I increased the timeout so all the tests would run):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Tests run: 5, Failures: 1, Errors: 0, Skipped: 0, Time elapsed: 2,628.821 sec &amp;lt;&amp;lt;&amp;lt; FAILURE! - in org.apache.hadoop.security.token.delegation.TestZKDelegationTokenSecretManager
testMultiNodeOperations(org.apache.hadoop.security.token.delegation.TestZKDelegationTokenSecretManager)  Time elapsed: 7.557 sec  &amp;lt;&amp;lt;&amp;lt; FAILURE!
java.lang.AssertionError: Expected InvalidToken
	at org.junit.Assert.fail(Assert.java:88)
	at org.apache.hadoop.security.token.delegation.TestZKDelegationTokenSecretManager.testMultiNodeOperations(TestZKDelegationTokenSecretManager.java:97)


Results :

Failed tests: 
  TestZKDelegationTokenSecretManager.testMultiNodeOperations:97 Expected InvalidToken

Tests run: 5, Failures: 1, Errors: 0, Skipped: 0
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Note, the line number is off because I modified the test to run in loops.  It&apos;s this line:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/hadoop/blob/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/security/token/delegation/TestZKDelegationTokenSecretManager.java#L90&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/hadoop/blob/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/security/token/delegation/TestZKDelegationTokenSecretManager.java#L90&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14196509" author="gchanan" created="Tue, 4 Nov 2014 18:19:55 +0000"  >&lt;p&gt;Sorry, permanent link: &lt;a href=&quot;https://github.com/apache/hadoop/blob/2bb327eb939f57626d3dac10f7016ed634375d94/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/security/token/delegation/TestZKDelegationTokenSecretManager.java#L90&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/hadoop/blob/2bb327eb939f57626d3dac10f7016ed634375d94/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/security/token/delegation/TestZKDelegationTokenSecretManager.java#L90&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14196630" author="asuresh" created="Tue, 4 Nov 2014 19:15:49 +0000"  >&lt;p&gt;Uploading test case fix..&lt;/p&gt;

&lt;p&gt;The reason for your error : Since it is possible that there can be a delay for the cancel token message initiated by one node to reach another node.. The second node can ofcourse verify with ZK directly if the token that needs verification has been cancelled or not before verification but.. that would mean having to make an RPC call for every verification request.&lt;br/&gt;
Thus, the eventual consistency tradef-off should be acceptable here...&lt;/p&gt;

&lt;p&gt;In this patch, I have&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Updated testcases to handle this (If failure is expected on verification, it retires couple of times till it fails)&lt;/li&gt;
	&lt;li&gt;All test cases run 10 times (please modify the TEST_RETRIES constant locally for anything more.. I verified locally with 100 retries)&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14196736" author="hadoopqa" created="Tue, 4 Nov 2014 20:14:16 +0000"  >&lt;p&gt;&lt;font color=&quot;green&quot;&gt;+1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12679282/HADOOP-11157.5.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12679282/HADOOP-11157.5.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 1eed102.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 tests included&lt;/font&gt;.  The patch appears to include 1 new or modified test files.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javadoc&lt;/font&gt;.  There were no new javadoc warning messages.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 eclipse:eclipse&lt;/font&gt;.  The patch built with eclipse:eclipse.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 findbugs&lt;/font&gt;.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 release audit&lt;/font&gt;.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 core tests&lt;/font&gt;.  The patch passed unit tests in hadoop-common-project/hadoop-common.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 contrib tests&lt;/font&gt;.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/5016//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/5016//testReport/&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/5016//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/5016//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14197387" author="asuresh" created="Wed, 5 Nov 2014 02:27:30 +0000"  >&lt;p&gt;Uploading new patch... added synchronization for &lt;tt&gt;allKeys&lt;/tt&gt; and reusing &lt;tt&gt;getTokenInfo()&lt;/tt&gt; in &lt;tt&gt;ZKDTSM.cancelToken()&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="14197430" author="hadoopqa" created="Wed, 5 Nov 2014 03:15:12 +0000"  >&lt;p&gt;&lt;font color=&quot;red&quot;&gt;-1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12679457/HADOOP-11157.6.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12679457/HADOOP-11157.6.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision 0762b4a.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 tests included&lt;/font&gt;.  The patch appears to include 1 new or modified test files.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javadoc&lt;/font&gt;.  There were no new javadoc warning messages.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 eclipse:eclipse&lt;/font&gt;.  The patch built with eclipse:eclipse.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 findbugs&lt;/font&gt;.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 release audit&lt;/font&gt;.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;red&quot;&gt;-1 core tests&lt;/font&gt;.  The following test timeouts occurred in hadoop-common-project/hadoop-common:&lt;/p&gt;

&lt;p&gt;org.apache.hadoop.security.token.delegation.TestZKDelegationTokenSecretManager&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 contrib tests&lt;/font&gt;.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/5024//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/5024//testReport/&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/5024//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/5024//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14201174" author="gchanan" created="Thu, 6 Nov 2014 23:18:12 +0000"  >&lt;p&gt;patch lgtm.  One note, not really related to this JIRA, is it doesn&apos;t look like the tokenCache and keyCache actually need to have cacheData=true.  Looks like they are just being used for notification.&lt;/p&gt;</comment>
                            <comment id="14209257" author="atm" created="Thu, 13 Nov 2014 04:36:19 +0000"  >&lt;p&gt;Latest patch looks pretty good to me. A few comments:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Looks like we still have an inadvertent extra &quot;&lt;ins&gt;&quot; here: &quot;&lt;/ins&gt;        +        ZK_DTSM_ZK_SHUTDOWN_TIMEOUT_DEFAULT);&quot;&lt;/li&gt;
	&lt;li&gt;In &lt;tt&gt;stopThreads(...)&lt;/tt&gt;, do we really need to nest all of those try/finally blocks? Given that content of most of the &quot;&lt;tt&gt;catch&lt;/tt&gt;&quot; blocks is just to log and ignore, seems like they don&apos;t need to be nested, and instead we can do away with the finally blocks and just list the &lt;tt&gt;try/catch&lt;/tt&gt; blocks linearly.&lt;/li&gt;
	&lt;li&gt;In the case that shutting down the thread pool times out, recommend logging an error before forcefully shutting down the thread pool.&lt;/li&gt;
	&lt;li&gt;Given that the new tests time out when run on our Jenkins infrastructure, seems like we should lower the default number of &lt;tt&gt;TEST_RETRIES&lt;/tt&gt; to 1 or 2.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I&apos;ll be +1 once the above are addressed and Jenkins comes back clean.&lt;/p&gt;</comment>
                            <comment id="14209298" author="asuresh" created="Thu, 13 Nov 2014 05:22:04 +0000"  >&lt;p&gt;Updating patch... thanks for the review &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=atm&quot; class=&quot;user-hover&quot; rel=&quot;atm&quot;&gt;atm&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14209352" author="hadoopqa" created="Thu, 13 Nov 2014 06:22:24 +0000"  >&lt;p&gt;&lt;font color=&quot;green&quot;&gt;+1 overall&lt;/font&gt;.  Here are the results of testing the latest attachment &lt;br/&gt;
  &lt;a href=&quot;http://issues.apache.org/jira/secure/attachment/12681257/HADOOP-11157.7.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/secure/attachment/12681257/HADOOP-11157.7.patch&lt;/a&gt;&lt;br/&gt;
  against trunk revision e073b61.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 @author&lt;/font&gt;.  The patch does not contain any @author tags.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 tests included&lt;/font&gt;.  The patch appears to include 1 new or modified test files.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javac&lt;/font&gt;.  The applied patch does not increase the total number of javac compiler warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 javadoc&lt;/font&gt;.  There were no new javadoc warning messages.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 eclipse:eclipse&lt;/font&gt;.  The patch built with eclipse:eclipse.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 findbugs&lt;/font&gt;.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 release audit&lt;/font&gt;.  The applied patch does not increase the total number of release audit warnings.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 core tests&lt;/font&gt;.  The patch passed unit tests in hadoop-common-project/hadoop-common.&lt;/p&gt;

&lt;p&gt;    &lt;font color=&quot;green&quot;&gt;+1 contrib tests&lt;/font&gt;.  The patch passed contrib unit tests.&lt;/p&gt;

&lt;p&gt;Test results: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/5076//testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/5076//testReport/&lt;/a&gt;&lt;br/&gt;
Console output: &lt;a href=&quot;https://builds.apache.org/job/PreCommit-HADOOP-Build/5076//console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/PreCommit-HADOOP-Build/5076//console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This message is automatically generated.&lt;/p&gt;</comment>
                            <comment id="14215152" author="atm" created="Mon, 17 Nov 2014 20:53:50 +0000"  >&lt;p&gt;+1, the latest patch looks good to me. I&apos;m going to commit this momentarily.&lt;/p&gt;</comment>
                            <comment id="14215178" author="atm" created="Mon, 17 Nov 2014 21:08:41 +0000"  >&lt;p&gt;I&apos;ve just committed this to trunk and branch-2.&lt;/p&gt;

&lt;p&gt;Thanks a lot for the contribution, Arun and thanks also to Greg and Karthik for the great reviews.&lt;/p&gt;</comment>
                            <comment id="14215186" author="hudson" created="Mon, 17 Nov 2014 21:13:22 +0000"  >&lt;p&gt;SUCCESS: Integrated in Hadoop-trunk-Commit #6558 (See &lt;a href=&quot;https://builds.apache.org/job/Hadoop-trunk-Commit/6558/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Hadoop-trunk-Commit/6558/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-11157&quot; title=&quot;ZKDelegationTokenSecretManager never shuts down listenerThreadPool&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-11157&quot;&gt;&lt;del&gt;HADOOP-11157&lt;/del&gt;&lt;/a&gt;. ZKDelegationTokenSecretManager never shuts down listenerThreadPool. Contributed by Arun Suresh. (atm: rev bd8196e85e49d44de57237a59bcd7ceae4332c2e)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/security/token/delegation/TestZKDelegationTokenSecretManager.java&lt;/li&gt;
	&lt;li&gt;hadoop-common-project/hadoop-common/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/security/token/delegation/ZKDelegationTokenSecretManager.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14216089" author="hudson" created="Tue, 18 Nov 2014 11:43:12 +0000"  >&lt;p&gt;FAILURE: Integrated in Hadoop-Yarn-trunk-Java8 #9 (See &lt;a href=&quot;https://builds.apache.org/job/Hadoop-Yarn-trunk-Java8/9/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Hadoop-Yarn-trunk-Java8/9/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-11157&quot; title=&quot;ZKDelegationTokenSecretManager never shuts down listenerThreadPool&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-11157&quot;&gt;&lt;del&gt;HADOOP-11157&lt;/del&gt;&lt;/a&gt;. ZKDelegationTokenSecretManager never shuts down listenerThreadPool. Contributed by Arun Suresh. (atm: rev bd8196e85e49d44de57237a59bcd7ceae4332c2e)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/security/token/delegation/ZKDelegationTokenSecretManager.java&lt;/li&gt;
	&lt;li&gt;hadoop-common-project/hadoop-common/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/security/token/delegation/TestZKDelegationTokenSecretManager.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14216102" author="hudson" created="Tue, 18 Nov 2014 11:52:16 +0000"  >&lt;p&gt;SUCCESS: Integrated in Hadoop-Yarn-trunk #747 (See &lt;a href=&quot;https://builds.apache.org/job/Hadoop-Yarn-trunk/747/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Hadoop-Yarn-trunk/747/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-11157&quot; title=&quot;ZKDelegationTokenSecretManager never shuts down listenerThreadPool&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-11157&quot;&gt;&lt;del&gt;HADOOP-11157&lt;/del&gt;&lt;/a&gt;. ZKDelegationTokenSecretManager never shuts down listenerThreadPool. Contributed by Arun Suresh. (atm: rev bd8196e85e49d44de57237a59bcd7ceae4332c2e)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/security/token/delegation/ZKDelegationTokenSecretManager.java&lt;/li&gt;
	&lt;li&gt;hadoop-common-project/hadoop-common/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/security/token/delegation/TestZKDelegationTokenSecretManager.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14216201" author="hudson" created="Tue, 18 Nov 2014 14:14:34 +0000"  >&lt;p&gt;FAILURE: Integrated in Hadoop-Hdfs-trunk #1937 (See &lt;a href=&quot;https://builds.apache.org/job/Hadoop-Hdfs-trunk/1937/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Hadoop-Hdfs-trunk/1937/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-11157&quot; title=&quot;ZKDelegationTokenSecretManager never shuts down listenerThreadPool&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-11157&quot;&gt;&lt;del&gt;HADOOP-11157&lt;/del&gt;&lt;/a&gt;. ZKDelegationTokenSecretManager never shuts down listenerThreadPool. Contributed by Arun Suresh. (atm: rev bd8196e85e49d44de57237a59bcd7ceae4332c2e)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/security/token/delegation/TestZKDelegationTokenSecretManager.java&lt;/li&gt;
	&lt;li&gt;hadoop-common-project/hadoop-common/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/security/token/delegation/ZKDelegationTokenSecretManager.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14216215" author="hudson" created="Tue, 18 Nov 2014 14:17:28 +0000"  >&lt;p&gt;FAILURE: Integrated in Hadoop-Hdfs-trunk-Java8 #9 (See &lt;a href=&quot;https://builds.apache.org/job/Hadoop-Hdfs-trunk-Java8/9/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Hadoop-Hdfs-trunk-Java8/9/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-11157&quot; title=&quot;ZKDelegationTokenSecretManager never shuts down listenerThreadPool&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-11157&quot;&gt;&lt;del&gt;HADOOP-11157&lt;/del&gt;&lt;/a&gt;. ZKDelegationTokenSecretManager never shuts down listenerThreadPool. Contributed by Arun Suresh. (atm: rev bd8196e85e49d44de57237a59bcd7ceae4332c2e)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/security/token/delegation/TestZKDelegationTokenSecretManager.java&lt;/li&gt;
	&lt;li&gt;hadoop-common-project/hadoop-common/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/security/token/delegation/ZKDelegationTokenSecretManager.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14216275" author="hudson" created="Tue, 18 Nov 2014 15:16:58 +0000"  >&lt;p&gt;FAILURE: Integrated in Hadoop-Mapreduce-trunk #1961 (See &lt;a href=&quot;https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1961/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1961/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-11157&quot; title=&quot;ZKDelegationTokenSecretManager never shuts down listenerThreadPool&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-11157&quot;&gt;&lt;del&gt;HADOOP-11157&lt;/del&gt;&lt;/a&gt;. ZKDelegationTokenSecretManager never shuts down listenerThreadPool. Contributed by Arun Suresh. (atm: rev bd8196e85e49d44de57237a59bcd7ceae4332c2e)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hadoop-common-project/hadoop-common/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/security/token/delegation/ZKDelegationTokenSecretManager.java&lt;/li&gt;
	&lt;li&gt;hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/security/token/delegation/TestZKDelegationTokenSecretManager.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14216296" author="hudson" created="Tue, 18 Nov 2014 15:29:55 +0000"  >&lt;p&gt;SUCCESS: Integrated in Hadoop-Mapreduce-trunk-Java8 #9 (See &lt;a href=&quot;https://builds.apache.org/job/Hadoop-Mapreduce-trunk-Java8/9/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Hadoop-Mapreduce-trunk-Java8/9/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-11157&quot; title=&quot;ZKDelegationTokenSecretManager never shuts down listenerThreadPool&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-11157&quot;&gt;&lt;del&gt;HADOOP-11157&lt;/del&gt;&lt;/a&gt;. ZKDelegationTokenSecretManager never shuts down listenerThreadPool. Contributed by Arun Suresh. (atm: rev bd8196e85e49d44de57237a59bcd7ceae4332c2e)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/security/token/delegation/TestZKDelegationTokenSecretManager.java&lt;/li&gt;
	&lt;li&gt;hadoop-common-project/hadoop-common/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/security/token/delegation/ZKDelegationTokenSecretManager.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12678049" name="HADOOP-11157.2.patch" size="18677" author="asuresh" created="Wed, 29 Oct 2014 22:58:20 +0000"/>
                            <attachment id="12678383" name="HADOOP-11157.3.patch" size="20852" author="asuresh" created="Fri, 31 Oct 2014 02:33:00 +0000"/>
                            <attachment id="12678774" name="HADOOP-11157.4.patch" size="20676" author="asuresh" created="Sun, 2 Nov 2014 07:34:52 +0000"/>
                            <attachment id="12679282" name="HADOOP-11157.5.patch" size="26711" author="asuresh" created="Tue, 4 Nov 2014 19:15:49 +0000"/>
                            <attachment id="12679457" name="HADOOP-11157.6.patch" size="26830" author="asuresh" created="Wed, 5 Nov 2014 02:27:30 +0000"/>
                            <attachment id="12681257" name="HADOOP-11157.7.patch" size="25958" author="asuresh" created="Thu, 13 Nov 2014 05:22:04 +0000"/>
                            <attachment id="12676805" name="HADOOP-11157.patch" size="1522" author="gchanan" created="Fri, 24 Oct 2014 01:22:22 +0000"/>
                            <attachment id="12672199" name="HADOOP-11157.patch" size="1522" author="gchanan" created="Tue, 30 Sep 2014 23:55:55 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 1 week ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i20nv3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>