<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:54:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HADOOP-15708] Reading values from Configuration before adding deprecations make it impossible to read value with deprecated key</title>
                <link>https://issues.apache.org/jira/browse/HADOOP-15708</link>
                <project id="12310240" key="HADOOP">Hadoop Common</project>
                    <description>&lt;p&gt;Hadoop Common contains a widely used Configuration class.&lt;br/&gt;
 This class can handle deprecations of properties, e.g. if property &apos;A&apos; gets deprecated with an alternative property key &apos;B&apos;, users can access property values with keys &apos;A&apos; and &apos;B&apos;.&lt;br/&gt;
 Unfortunately, this does not work in one case.&lt;br/&gt;
 When a config file is specified (for instance, XML) and a property is read with the config.get() method, the config is loaded from the file at this time. &lt;br/&gt;
 If the deprecation mapping is not yet specified by the time any config value is retrieved and the XML config refers to a deprecated key, then the deprecation mapping specified, the config value cannot be retrieved neither with the deprecated nor with the new key.&lt;br/&gt;
 The attached patch contains a testcase that reproduces this wrong behavior.&lt;/p&gt;

&lt;p&gt;Here are the steps outlined what the testcase does:&lt;br/&gt;
 1. Creates an XML config file with a deprecated property&lt;br/&gt;
 2. Adds the config to the Configuration object&lt;br/&gt;
 3. Retrieves the config with its deprecated key (it does not really matter which property the user gets, could be any)&lt;br/&gt;
 4. Specifies the deprecation rules including the one defined in the config&lt;br/&gt;
 5. Prints and asserts the property retrieved from the config with both the deprecated and the new property keys.&lt;/p&gt;

&lt;p&gt;For reference, here is the log of one execution that actually shows what the issue is:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Loaded items: 1
Looked up property value with name hadoop.zk.address: null
Looked up property value with name yarn.resourcemanager.zk-address: dummyZkAddress
Contents of config file: [&amp;lt;?xml version=&quot;1.0&quot;?&amp;gt;, &amp;lt;configuration&amp;gt;, &amp;lt;property&amp;gt;&amp;lt;name&amp;gt;yarn.resourcemanager.zk-address&amp;lt;/name&amp;gt;&amp;lt;value&amp;gt;dummyZkAddress&amp;lt;/value&amp;gt;&amp;lt;/property&amp;gt;, &amp;lt;/configuration&amp;gt;]
Looked up property value with name hadoop.zk.address: null
2018-08-31 10:10:06,484 INFO  Configuration.deprecation (Configuration.java:logDeprecation(1397)) - yarn.resourcemanager.zk-address is deprecated. Instead, use hadoop.zk.address
Looked up property value with name hadoop.zk.address: null
Looked up property value with name hadoop.zk.address: null

java.lang.AssertionError: 
Expected :dummyZkAddress
Actual   :null
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;b&gt;As it&apos;s visible from the output and the code, the issue is really that if the config is retrieved either with the deprecated or the new value, Configuration both wants to serve the value with the new key.&lt;/b&gt;&lt;br/&gt;
 &lt;b&gt;If the mapping is not specified before any retrieval happened, the value is only stored under the deprecated key but not the new key.&lt;/b&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13182310">HADOOP-15708</key>
            <summary>Reading values from Configuration before adding deprecations make it impossible to read value with deprecated key</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="zsiegl">Zoltan Siegl</assignee>
                                    <reporter username="snemeth">Szilard Nemeth</reporter>
                        <labels>
                    </labels>
                <created>Fri, 31 Aug 2018 08:40:37 +0000</created>
                <updated>Wed, 26 May 2021 22:49:31 +0000</updated>
                            <resolved>Thu, 11 Oct 2018 01:52:13 +0000</resolved>
                                    <version>3.2.0</version>
                                    <fixVersion>3.3.0</fixVersion>
                                    <component>conf</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="16598483" author="stevel@apache.org" created="Fri, 31 Aug 2018 09:35:10 +0000"  >&lt;p&gt;The problem here is that the deprecation registration declares that mapping from old to new. We cannot expect a property registered with the deprecated key to be retrievable with the new key until then. &lt;/p&gt;

&lt;p&gt;It should still be retrievable with the old key, just like any other key.&lt;/p&gt;

&lt;p&gt;Are you seeing something different?&lt;/p&gt;

&lt;p&gt;Or is the issue here that the act of registration of a deprecated key changing what/whether you can get stuff back?&lt;/p&gt;


&lt;p&gt;patch wise: nice to see a test, especially with the assertEquals() parameters in the right order. But...SLF4J must be the log API, not stdout. thanks.&lt;/p&gt;</comment>
                            <comment id="16598544" author="snemeth" created="Fri, 31 Aug 2018 10:20:50 +0000"  >&lt;blockquote&gt;&lt;p&gt; We cannot expect a property registered with the deprecated key to be retrievable with the new key until then. &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yes, I understand this. What I tried to describe is not this case.&lt;br/&gt;
The problem here is if you get some value from the conf then register the deprecation mappings, you are unable to read the conf value with the old key, which is not a desired behavior.&lt;br/&gt;
If you check the code + logs, I try to get the values with the old and new keys, but the output says:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Looked up property value with name hadoop.zk.address: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
Looked up property value with name hadoop.zk.address: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So even if you use the old key, it tries to fetch values with the new key and it&apos;s null.&lt;/p&gt;

&lt;p&gt;I just meant this patch to be a proof of concept, so please disregard the stdouts, as the final patch will be more production ready.&lt;br/&gt;
Thanks!&lt;/p&gt;</comment>
                            <comment id="16598551" author="zsiegl" created="Fri, 31 Aug 2018 10:26:41 +0000"  >&lt;p&gt;&lt;tt&gt;So to reproduce the problem:&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;Works:&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;1. load properties from xml&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;2. add deprecation mapping&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;3. read either new or old key &lt;font color=&quot;#8eb021&quot;&gt;works&lt;/font&gt;&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;Does now work:&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;1. load properties from xml&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&lt;font color=&quot;#59afe1&quot;&gt;1,5. Get any completely not related property&lt;/font&gt;&#160;&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;2. add deprecation mapping&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;3. read either new or old key &lt;font color=&quot;#d04437&quot;&gt;fails&lt;/font&gt;&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="16598560" author="snemeth" created="Fri, 31 Aug 2018 10:37:09 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zsiegl&quot; class=&quot;user-hover&quot; rel=&quot;zsiegl&quot;&gt;zsiegl&lt;/a&gt;!&lt;br/&gt;
Thanks for your patch!&lt;br/&gt;
LGTM in overall, I would just rename the &lt;tt&gt;names&lt;/tt&gt; array to &lt;tt&gt;newKeys&lt;/tt&gt; and the corresponding loop variable &lt;tt&gt;n&lt;/tt&gt; to &lt;tt&gt;newKey&lt;/tt&gt;.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;private void updatePropertiesWIthDeprecatedKeys(
      DeprecationContext deprecations, String[] names) {
    for (String n : names) {
      String deprecatedKey = deprecations.getReverseDeprecatedKeyMap().get(n);
      if (deprecatedKey != null &amp;amp;&amp;amp; !getProps().containsKey(n)) {
        String deprecatedValue = getProps().getProperty(deprecatedKey);
        if (deprecatedValue != null) {
          getProps().setProperty(n, deprecatedValue);
        }
      }
    }
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="16598616" author="zsiegl" created="Fri, 31 Aug 2018 11:41:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=snemeth&quot; class=&quot;user-hover&quot; rel=&quot;snemeth&quot;&gt;snemeth&lt;/a&gt; thanks for the review, items fixed.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stevel%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;stevel@apache.org&quot;&gt;stevel@apache.org&lt;/a&gt; could you review the current patch? Please let me know if you would need any further help understanding the context of the issue.&lt;/p&gt;</comment>
                            <comment id="16598674" author="snemeth" created="Fri, 31 Aug 2018 12:27:48 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zsiegl&quot; class=&quot;user-hover&quot; rel=&quot;zsiegl&quot;&gt;zsiegl&lt;/a&gt; for the updated patch!&lt;br/&gt;
LGTM, +1 (non-binding)&lt;/p&gt;</comment>
                            <comment id="16599029" author="stevel@apache.org" created="Fri, 31 Aug 2018 17:13:32 +0000"  >&lt;p&gt;I&apos;m going to wait to see what others say, which given its a long weekend in the US, unlikely until next week&lt;/p&gt;

&lt;p&gt;Configuration is such as ubiquitous class that its on the list of things to be very careful about changing, even when the changes seem low risk, which is why we need that extra oversight&lt;/p&gt;

&lt;p&gt;looking @ code; &lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;I&apos;d like to see a patch which doesn&apos;t add IDE-helped changes, as that complicates merging and cherry-picking, so fixes to unused imports, line endings, spacing need to be left out. Sorry.&lt;/li&gt;
	&lt;li&gt;in TestConfigurationDeprecation, use try-with-resources for writing the file.&lt;/li&gt;
&lt;/ul&gt;

</comment>
                            <comment id="16599188" author="zsiegl" created="Fri, 31 Aug 2018 19:29:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stevel%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;stevel@apache.org&quot;&gt;stevel@apache.org&lt;/a&gt; Thank you for the review. Changes done, new patch on the way. Try-with-resources in the test would require a larger refactor of the test case, I suggest a different commit for that.&lt;/p&gt;</comment>
                            <comment id="16609433" author="zsiegl" created="Mon, 10 Sep 2018 15:58:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stevel%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;stevel@apache.org&quot;&gt;stevel@apache.org&lt;/a&gt; do you know of anyone who would be interested in this issue?&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xiaochen&quot; class=&quot;user-hover&quot; rel=&quot;xiaochen&quot;&gt;xiaochen&lt;/a&gt; Would you be interested to have a look at this problem?&#160;&lt;/p&gt;

&lt;p&gt;Thanks &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16626331" author="zsiegl" created="Mon, 24 Sep 2018 19:48:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jlowe&quot; class=&quot;user-hover&quot; rel=&quot;jlowe&quot;&gt;jlowe&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=daryn&quot; class=&quot;user-hover&quot; rel=&quot;daryn&quot;&gt;daryn&lt;/a&gt; could someone have a look at this issue please?&lt;/p&gt;</comment>
                            <comment id="16636272" author="rkanter" created="Wed, 3 Oct 2018 00:26:08 +0000"  >&lt;p&gt;There&apos;s definitely something wrong here.&#160; I was playing with the &lt;tt&gt;Configuration&lt;/tt&gt; class like this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// OLD_KEY is set to &lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt; in the XML
&lt;/span&gt;conf.get(OLD_KEY);  &lt;span class=&quot;code-comment&quot;&gt;// returns &lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt;
&lt;/span&gt;Configuration.addDeprecations(OLD_KEY, NEW_KEY);
conf.get(OLD_KEY);  &lt;span class=&quot;code-comment&quot;&gt;// returns &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;That doesn&apos;t seem right.  Adding a deprecation looks like it breaks getting the value of the deprecated key.  On top of that, if you ommit the 2nd line, it works correctly:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// OLD_KEY is set to &lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt; in the XML
&lt;/span&gt;Configuration.addDeprecations(OLD_KEY, NEW_KEY);
conf.get(OLD_KEY);  &lt;span class=&quot;code-comment&quot;&gt;// returns &lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This means that getting the &lt;tt&gt;OLD_KEY&lt;/tt&gt; and then deprecating it changes the value, which isn&apos;t the right behavior.  &lt;/p&gt;

&lt;p&gt;As for the right way to fix this, and make sure we&apos;re not breaking anything depending on this odd behavior, I&apos;m not sure.  It would be good to get some more opinions.&lt;/p&gt;</comment>
                            <comment id="16636328" author="zsiegl" created="Wed, 3 Oct 2018 01:29:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rkanter&quot; class=&quot;user-hover&quot; rel=&quot;rkanter&quot;&gt;rkanter&lt;/a&gt; did you experience this behaviour before or after applying the patch?&lt;br/&gt;
This is what the patch should fix. Also before the patch: &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// OLD_KEY is set to &lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt; in the XML
&lt;/span&gt;Configuration.addDeprecations(OLD_KEY, NEW_KEY);
conf.get(OLD_KEY);  &lt;span class=&quot;code-comment&quot;&gt;// returns &lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;While:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// OLD_KEY is set to &lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt; in the XML
&lt;/span&gt;conf.get(SOMETHING_ELSE);
Configuration.addDeprecations(OLD_KEY, NEW_KEY);
conf.get(OLD_KEY);  &lt;span class=&quot;code-comment&quot;&gt;// returns &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</comment>
                            <comment id="16637659" author="rkanter" created="Thu, 4 Oct 2018 00:47:12 +0000"  >&lt;p&gt;Sorry, yeah; that was before the patch.&#160; I was just investigating what the current behavior is.&#160; As &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stevel%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;stevel@apache.org&quot;&gt;stevel@apache.org&lt;/a&gt; said, we have to be very careful about changing this class.&#160; The code seems okay to me though, but let&apos;s see if anyone else has thoughts about the consequences of changing this behavior.&lt;/p&gt;</comment>
                            <comment id="16638707" author="zsiegl" created="Thu, 4 Oct 2018 19:06:22 +0000"  >&lt;p&gt;So to make things a bit clear about the change:&lt;br/&gt;
Before the patch:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] handleDeprecation(DeprecationContext deprecations,
                                     &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name) {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; != name) {
      name = name.trim();
    }
    &lt;span class=&quot;code-comment&quot;&gt;// Initialize the &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; value with requested name
&lt;/span&gt;    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] names = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[]{name};
    &lt;span class=&quot;code-comment&quot;&gt;// Deprecated keys are logged once and an updated names are returned
&lt;/span&gt;    DeprecatedKeyInfo keyInfo = deprecations.getDeprecatedKeyMap().get(name);
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (keyInfo != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!keyInfo.getAndSetAccessed()) {
        logDeprecation(keyInfo.getWarningMessage(name));
      }
      &lt;span class=&quot;code-comment&quot;&gt;// Override &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; value &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; deprecated keys
&lt;/span&gt;      names = keyInfo.newKeys;
    }

    &lt;span class=&quot;code-comment&quot;&gt;// **** WE RETURN EARLY HERE IF THERE ARE NO OVERLAYS ***
&lt;/span&gt;
    &lt;span class=&quot;code-comment&quot;&gt;// If there are no overlay values we can &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; early
&lt;/span&gt;    Properties overlayProperties = getOverlay();
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (overlayProperties.isEmpty()) {
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; names;
    }
    &lt;span class=&quot;code-comment&quot;&gt;// Update properties and overlays with reverse lookup values
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; n : names) {
      &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; deprecatedKey = deprecations.getReverseDeprecatedKeyMap().get(n);
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (deprecatedKey != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; !overlayProperties.containsKey(n)) {
        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; deprecatedValue = overlayProperties.getProperty(deprecatedKey);
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (deprecatedValue != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
          &lt;span class=&quot;code-comment&quot;&gt;// **** STILL AT THIS LINE WE ARE UPDATING PROPS *NOT* OVERLAY ***
&lt;/span&gt;          getProps().setProperty(n, deprecatedValue);
          overlayProperties.setProperty(n, deprecatedValue);
        }
      }
    }
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; names;
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So I have extracted the latter loop to run for all props not just overlays as it should work.&lt;/p&gt;

&lt;p&gt;To address concerns of &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jlowe&quot; class=&quot;user-hover&quot; rel=&quot;jlowe&quot;&gt;jlowe&lt;/a&gt; as we talked offline:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;You said that if you set deprecated and new keys as well, this patch would change the return value. To address this fear I have created a test case for this:&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Test
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testBothPropertiesAreSet() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    &lt;span class=&quot;code-comment&quot;&gt;// SETUP
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; oldZkAddressKey = &lt;span class=&quot;code-quote&quot;&gt;&quot;yarn.resourcemanager.zk-address&quot;&lt;/span&gt;;
    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; newZkAddressKey = CommonConfigurationKeys.ZK_ADDRESS;
    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; oldZkAddressValue = &lt;span class=&quot;code-quote&quot;&gt;&quot;oldZkAddress&quot;&lt;/span&gt;;
    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; newZkAddressValue = &lt;span class=&quot;code-quote&quot;&gt;&quot;newZkAddress&quot;&lt;/span&gt;;

    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;{
      out = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BufferedWriter(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FileWriter(CONFIG4));
      startConfig();
      appendProperty(oldZkAddressKey, oldZkAddressValue);
      appendProperty(newZkAddressKey, newZkAddressValue);
      endConfig();

      Path fileResource = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Path(CONFIG4);
      conf.addResource(fileResource);
    } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
      out.close();
    }

    &lt;span class=&quot;code-comment&quot;&gt;// ACT
&lt;/span&gt;    conf.get(oldZkAddressKey);
    Configuration.addDeprecations(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Configuration.DeprecationDelta[] {
        &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Configuration.DeprecationDelta(oldZkAddressKey, newZkAddressKey)});

    &lt;span class=&quot;code-comment&quot;&gt;// ASSERT
&lt;/span&gt;    assertEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;New property should overwrite deprecated one&quot;&lt;/span&gt;,
        newZkAddressValue, conf.get(oldZkAddressKey));
    assertEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;Property should be accessible through &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; key&quot;&lt;/span&gt;,
        newZkAddressValue, conf.get(newZkAddressKey));
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This tests setting both properties and returning the same values before and after the patch as well.&lt;br/&gt;
I did not add this to the patch, as this has been already covered in the previous test cases, it is juts a bit more readable this way, as a separate test. &lt;/p&gt;

&lt;p&gt;To address fears of &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rkanter&quot; class=&quot;user-hover&quot; rel=&quot;rkanter&quot;&gt;rkanter&lt;/a&gt;:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;You said that some may depend on the bugous functionality. That is normally a good idea to stay backward compatible, however why would you depend on getting NULL instead of the config value you needed? This is a bug. Don&apos;d depend on bugs.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Is there anything else I can do for this to be accepted? I&apos;d be happy to.&lt;/p&gt;</comment>
                            <comment id="16638983" author="rkanter" created="Thu, 4 Oct 2018 22:36:56 +0000"  >&lt;blockquote&gt;&lt;p&gt;Don&apos;t depend on bugs.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I agree, though we&apos;ve had issues in the past.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Anyway, I think we we should move forward on this. It seems pretty clear to me that the current behavior doesn&apos;t make sense and we should fix it. I&apos;ll wait about a week to give anyone else a chance to speak up about this, and then I&apos;ll commit the patch. Otherwise, I think we&apos;ll be waiting forever while everyone hopes someone else will do the commit.&lt;/p&gt;

&lt;p&gt;One nitpick with the patch: &lt;tt&gt;updatePropertiesWIthDeprecatedKeys&lt;/tt&gt; has an extra capitalization in &lt;tt&gt;WIth&lt;/tt&gt;. It should be &lt;tt&gt;updatePropertiesWithDeprecatedKeys&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16638991" author="zsiegl" created="Thu, 4 Oct 2018 22:45:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rkanter&quot; class=&quot;user-hover&quot; rel=&quot;rkanter&quot;&gt;rkanter&lt;/a&gt; thanks for the review, and all the care about this. Fixed the typo. New patch uploaded.&lt;/p&gt;</comment>
                            <comment id="16645844" author="rkanter" created="Thu, 11 Oct 2018 01:52:13 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zsiegl&quot; class=&quot;user-hover&quot; rel=&quot;zsiegl&quot;&gt;zsiegl&lt;/a&gt; and everyone else for reviews.&#160; Committed to trunk!&lt;/p&gt;</comment>
                            <comment id="16645849" author="hudson" created="Thu, 11 Oct 2018 01:59:09 +0000"  >&lt;p&gt;FAILURE: Integrated in Jenkins build Hadoop-trunk-Commit #15175 (See &lt;a href=&quot;https://builds.apache.org/job/Hadoop-trunk-Commit/15175/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Hadoop-trunk-Commit/15175/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-15708&quot; title=&quot;Reading values from Configuration before adding deprecations make it impossible to read value with deprecated key&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-15708&quot;&gt;&lt;del&gt;HADOOP-15708&lt;/del&gt;&lt;/a&gt;. Reading values from Configuration before adding (rkanter: rev f261c319375c5a8c298338752ee77214c22f4e29)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/conf/TestConfigurationDeprecation.java&lt;/li&gt;
	&lt;li&gt;(edit) hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/conf/Configuration.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16650688" author="rkanter" created="Mon, 15 Oct 2018 19:52:35 +0000"  >&lt;p&gt;Looks like we missed a trivial problem where one of the updated tests leaves behind a file, which causes test runs to complain about a wrong license.&#160; I&apos;ve filed&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-15853&quot; title=&quot;TestConfigurationDeprecation leaves behind a temp file, resulting in a license issue&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-15853&quot;&gt;&lt;del&gt;HADOOP-15853&lt;/del&gt;&lt;/a&gt; to fix that.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                            <outwardlinks description="breaks">
                                        <issuelink>
            <issuekey id="13191699">HADOOP-15853</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13380638">HBASE-25928</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12937877" name="HADOOP-15708-testcase.patch" size="3782" author="snemeth" created="Fri, 31 Aug 2018 08:43:03 +0000"/>
                            <attachment id="12937897" name="HADOOP-15708.001.patch" size="9242" author="zsiegl" created="Fri, 31 Aug 2018 10:21:51 +0000"/>
                            <attachment id="12937909" name="HADOOP-15708.002.patch" size="10116" author="zsiegl" created="Fri, 31 Aug 2018 11:38:50 +0000"/>
                            <attachment id="12937948" name="HADOOP-15708.003.patch" size="7954" author="zsiegl" created="Fri, 31 Aug 2018 19:28:14 +0000"/>
                            <attachment id="12942470" name="HADOOP-15708.004.patch" size="7954" author="zsiegl" created="Thu, 4 Oct 2018 22:44:22 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 5 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3xmdr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>