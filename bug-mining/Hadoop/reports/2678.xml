<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:56:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HADOOP-17258] MagicS3GuardCommitter fails with `pendingset` already exists</title>
                <link>https://issues.apache.org/jira/browse/HADOOP-17258</link>
                <project id="12310240" key="HADOOP">Hadoop Common</project>
                    <description>&lt;p&gt;In `trunk/branch-3.3/branch-3.2`, `MagicS3GuardCommitter.innerCommitTask` has `false` at `pendingSet.save`.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
      pendingSet.save(getDestFS(), taskOutcomePath, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
      LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Failed to save task commit data to {} &quot;&lt;/span&gt;,
          taskOutcomePath, e);
      abortPendingUploads(context, pendingSet.getCommits(), &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
      &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; e;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And, it can cause a job failure like the following.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
WARN TaskSetManager: Lost task 1562.1 in stage 1.0 (TID 1788, 100.92.11.63, executor 26): org.apache.spark.SparkException: Task failed &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; writing rows.
    at org.apache.spark.sql.execution.datasources.FileFormatWriter$.org$apache$spark$sql$execution$datasources$FileFormatWriter$$executeTask(FileFormatWriter.scala:257)
    at org.apache.spark.sql.execution.datasources.FileFormatWriter$$anonfun$write$1.apply(FileFormatWriter.scala:170)
    at org.apache.spark.sql.execution.datasources.FileFormatWriter$$anonfun$write$1.apply(FileFormatWriter.scala:169)
    at org.apache.spark.scheduler.ResultTask.runTask(ResultTask.scala:90)
    at org.apache.spark.scheduler.Task.run(Task.scala:123)
    at org.apache.spark.executor.Executor$TaskRunner$$anonfun$10.apply(Executor.scala:408)
    at org.apache.spark.util.Utils$.tryWithSafeFinally(Utils.scala:1360)
    at org.apache.spark.executor.Executor$TaskRunner.run(Executor.scala:414)
    at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(Unknown Source)
    at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)
    at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(Unknown Source)
Caused by: org.apache.hadoop.fs.FileAlreadyExistsException: s3a:&lt;span class=&quot;code-comment&quot;&gt;//xxx/__magic/app-attempt-0000/task_20200911063607_0001_m_001562.pendingset already exists
&lt;/span&gt;    at org.apache.hadoop.fs.s3a.S3AFileSystem.create(S3AFileSystem.java:761)
    at org.apache.hadoop.fs.FileSystem.create(FileSystem.java:1118)
    at org.apache.hadoop.fs.FileSystem.create(FileSystem.java:1098)
    at org.apache.hadoop.fs.FileSystem.create(FileSystem.java:987)
    at org.apache.hadoop.util.JsonSerialization.save(JsonSerialization.java:269)
    at org.apache.hadoop.fs.s3a.commit.files.PendingSet.save(PendingSet.java:170)
    at org.apache.hadoop.fs.s3a.commit.magic.MagicS3GuardCommitter.innerCommitTask(MagicS3GuardCommitter.java:220)
    at org.apache.hadoop.fs.s3a.commit.magic.MagicS3GuardCommitter.commitTask(MagicS3GuardCommitter.java:165)
    at org.apache.spark.mapred.SparkHadoopMapRedUtil$.performCommit$1(SparkHadoopMapRedUtil.scala:50)
    at org.apache.spark.mapred.SparkHadoopMapRedUtil$.commitTask(SparkHadoopMapRedUtil.scala:77)
    at org.apache.spark.internal.io.HadoopMapReduceCommitProtocol.commitTask(HadoopMapReduceCommitProtocol.scala:244)
    at org.apache.spark.sql.execution.datasources.FileFormatDataWriter.commit(FileFormatDataWriter.scala:78)
    at org.apache.spark.sql.execution.datasources.FileFormatWriter$$anonfun$org$apache$spark$sql$execution$datasources$FileFormatWriter$$executeTask$3.apply(FileFormatWriter.scala:247)
    at org.apache.spark.sql.execution.datasources.FileFormatWriter$$anonfun$org$apache$spark$sql$execution$datasources$FileFormatWriter$$executeTask$3.apply(FileFormatWriter.scala:242)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
20/09/11 07:44:38 ERROR TaskSetManager: Task 957.1 in stage 1.0 (TID 1412) can not write to output file: org.apache.hadoop.fs.FileAlreadyExistsException: s3a:&lt;span class=&quot;code-comment&quot;&gt;//xxx/t/__magic/app-attempt-0000/task_20200911073922_0001_m_000957.pendingset already exists; not retrying&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The above happens in EKS with S3 environment and the job failure happens when some executor containers are killed by K8s&lt;/p&gt;</description>
                <environment></environment>
        <key id="13327018">HADOOP-17258</key>
            <summary>MagicS3GuardCommitter fails with `pendingset` already exists</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dongjoon">Dongjoon Hyun</assignee>
                                    <reporter username="dongjoon">Dongjoon Hyun</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 11 Sep 2020 07:05:00 +0000</created>
                <updated>Tue, 26 Jan 2021 13:35:09 +0000</updated>
                            <resolved>Tue, 26 Jan 2021 13:35:09 +0000</resolved>
                                    <version>3.2.0</version>
                                    <fixVersion>3.3.1</fixVersion>
                                    <component>fs/s3</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="17400">4h 50m</timespent>
                                <comments>
                            <comment id="17194052" author="dongjoon" created="Fri, 11 Sep 2020 07:07:17 +0000"  >&lt;p&gt;This happens frequently in a situation where some Spark executors die.&lt;/p&gt;</comment>
                            <comment id="17195429" author="stevel@apache.org" created="Mon, 14 Sep 2020 12:17:41 +0000"  >
&lt;p&gt;That failure implies that attempt 1 succeeded &amp;amp; created the file, so TA 2 couldn&apos;t. Maybe the thing to do here is on that second write, say &quot;the file is there, so let&apos;s gracefully abort our commit, relying on attempt #1 to be correct. Then it should abort its uploads and return success&lt;/p&gt;

&lt;p&gt;Makes sense?&lt;/p&gt;

&lt;p&gt;What happens to the whole job? Does it fail?&lt;/p&gt;

&lt;p&gt;(FWIW, failures during task commit is something the s3a committers MUST be resilient to. Spark expects commits to be atomic and exactly one attempt to succeed, but it doesn&apos;t care which (more specifically: your code mustn&apos;t care)&lt;/p&gt;</comment>
                            <comment id="17195850" author="dongjoon" created="Tue, 15 Sep 2020 03:51:58 +0000"  >&lt;p&gt;Thank you for commenting, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stevel%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;stevel@apache.org&quot;&gt;stevel@apache.org&lt;/a&gt;. Yes, it makes sense. Currently, this causes the job failure at the almost end of execution. I used DynamoDB and S3Guard and S3Magic committer and have been monitoring the target directory.&lt;/p&gt;</comment>
                            <comment id="17195853" author="dongjoon" created="Tue, 15 Sep 2020 03:56:33 +0000"  >&lt;p&gt;Also, cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chaosun&quot; class=&quot;user-hover&quot; rel=&quot;chaosun&quot;&gt;chaosun&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17196271" author="stevel@apache.org" created="Tue, 15 Sep 2020 16:16:37 +0000"  >&lt;p&gt;OK. So we&apos;re failing in createFile right now. What do you think should be done?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;This causes the job failure at the almost end of execution. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;well, technically it&apos;s always the end of the execution &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;/p&gt;

&lt;p&gt;Looking at the stack trace, here&apos;s the code:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
      pendingSet.save(getDestFS(), taskOutcomePath, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
      LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Failed to save task commit data to {} &quot;&lt;/span&gt;,
          taskOutcomePath, e);
      abortPendingUploads(context, pendingSet.getCommits(), &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
      &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; e;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;change: &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  
  
} &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (FileAlreadyExistsException e) {  
  log.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Another attempt has already succeeded&quot;&lt;/span&gt;)
      abortPendingUploads(context, pendingSet.getCommits(), &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
} &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) { &lt;span class=&quot;code-comment&quot;&gt;/* as before */&lt;/span&gt; }
  
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;  

&lt;p&gt;I&apos;d wondered if we could be clever, load the previous pendingset and abort those, but that would be a disaster if the second attempt crashed during that rollback. &lt;/p&gt;

&lt;p&gt;But by overwriting the file, the pending commits from it will be lost; we will rely on the final list and abort of all uploads to clean up and so avoid bills for incomplete uploads. People should always have their buckets set up to delete pending uploads after a few days anyway.&lt;/p&gt;
</comment>
                            <comment id="17196275" author="stevel@apache.org" created="Tue, 15 Sep 2020 16:17:32 +0000"  >&lt;p&gt;Fancy submitting a patch? Easier to get reviews if you code/test and I review/commit&lt;/p&gt;</comment>
                            <comment id="17196540" author="dongjoon" created="Tue, 15 Sep 2020 20:26:56 +0000"  >&lt;p&gt;The return value is `PendingSet` instead of `boolean`, isn&apos;t it?&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/hadoop/blob/trunk/hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/commit/magic/MagicS3GuardCommitter.java#L192&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/hadoop/blob/trunk/hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/commit/magic/MagicS3GuardCommitter.java#L192&lt;/a&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; PendingSet innerCommitTask(...)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17212341" author="stevel@apache.org" created="Mon, 12 Oct 2020 12:44:28 +0000"  >&lt;p&gt;merged to branch 3.3 &amp;amp; trunk -thanks!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 5 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0iic0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>