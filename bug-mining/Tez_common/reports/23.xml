<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:54:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[TEZ-1151] Vertex should stay in initializing state until custom vertex manager sets the parallelism</title>
                <link>https://issues.apache.org/jira/browse/TEZ-1151</link>
                <project id="12314426" key="TEZ">Apache Tez</project>
                    <description>&lt;p&gt;In &lt;a href=&quot;https://issues.apache.org/jira/browse/TEZ-1145&quot; title=&quot;Vertices should not start if they have uninitialized custom edges&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TEZ-1145&quot;&gt;&lt;del&gt;TEZ-1145&lt;/del&gt;&lt;/a&gt;, application is allowed to set -1 parallelism on a non 1-1 input vertex, and expect VertexManager to set the actual parallelism dynamically. However, when I does that, I hit the following exception:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;org.apache.tez.dag.api.TezUncheckedException: vertex_1400869346120_0005_1_04 has -1 tasks but neither input initializers nor 1-1 uninited sources
        at org.apache.tez.dag.app.dag.impl.VertexImpl$InitTransition.handleInitEvent(VertexImpl.java:2485)
        at org.apache.tez.dag.app.dag.impl.VertexImpl$InitTransition.transition(VertexImpl.java:2431)
        at org.apache.tez.dag.app.dag.impl.VertexImpl$InitTransition.transition(VertexImpl.java:2412)
        at org.apache.hadoop.yarn.state.StateMachineFactory$MultipleInternalArc.doTransition(StateMachineFactory.java:385)
        at org.apache.hadoop.yarn.state.StateMachineFactory.doTransition(StateMachineFactory.java:302)
        at org.apache.hadoop.yarn.state.StateMachineFactory.access$300(StateMachineFactory.java:46)
        at org.apache.hadoop.yarn.state.StateMachineFactory$InternalStateMachine.doTransition(StateMachineFactory.java:448)
        at org.apache.tez.dag.app.dag.impl.VertexImpl.handle(VertexImpl.java:1267)
        at org.apache.tez.dag.app.dag.impl.VertexImpl.handle(VertexImpl.java:158)
        at org.apache.tez.dag.app.DAGAppMaster$VertexEventDispatcher.handle(DAGAppMaster.java:1716)
        at org.apache.tez.dag.app.DAGAppMaster$VertexEventDispatcher.handle(DAGAppMaster.java:1702)
        at org.apache.hadoop.yarn.event.AsyncDispatcher.dispatch(AsyncDispatcher.java:134)
        at org.apache.hadoop.yarn.event.AsyncDispatcher$1.run(AsyncDispatcher.java:81)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:695)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12716457">TEZ-1151</key>
            <summary>Vertex should stay in initializing state until custom vertex manager sets the parallelism</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bikassaha">Bikas Saha</assignee>
                                    <reporter username="daijy">Daniel Dai</reporter>
                        <labels>
                    </labels>
                <created>Fri, 23 May 2014 22:13:15 +0000</created>
                <updated>Sat, 6 Sep 2014 01:35:44 +0000</updated>
                            <resolved>Fri, 30 May 2014 23:24:36 +0000</resolved>
                                                    <fixVersion>0.5.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14007785" author="bikassaha" created="Fri, 23 May 2014 22:22:17 +0000"  >&lt;p&gt;Daniel can you please try this quick fix patch.&lt;/p&gt;</comment>
                            <comment id="14010870" author="bikassaha" created="Wed, 28 May 2014 07:17:08 +0000"  >&lt;p&gt;Cleaner patch that handles this better and shares code across similar logic. Tests pass. New tests coming. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sseth&quot; class=&quot;user-hover&quot; rel=&quot;sseth&quot;&gt;sseth&lt;/a&gt; Please review.&lt;/p&gt;</comment>
                            <comment id="14011361" author="bikassaha" created="Wed, 28 May 2014 17:40:56 +0000"  >&lt;p&gt;Tests added.&lt;/p&gt;</comment>
                            <comment id="14012563" author="sseth" created="Thu, 29 May 2014 17:22:52 +0000"  >&lt;p&gt;What&apos;s the main difference between the two &quot;&lt;a href=&quot;https://issues.apache.org/jira/browse/TEZ-1151&quot; title=&quot;Vertex should stay in initializing state until custom vertex manager sets the parallelism&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TEZ-1151&quot;&gt;&lt;del&gt;TEZ-1151&lt;/del&gt;&lt;/a&gt;.2.patch&quot; files ? I had the older one downloaded yesterday. Please avoid uploading and overwriting the same file - can get fairly confusing for reviewers.&lt;/p&gt;</comment>
                            <comment id="14012643" author="bikassaha" created="Thu, 29 May 2014 18:10:03 +0000"  >&lt;p&gt;Sorry about that. Didnt see any activity. So update the patch to help reviewers see the latest patch &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/tongue.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
Left a comment saying that the patch adds tests. Also removed a couple of lines of unused imports and comments.&lt;/p&gt;</comment>
                            <comment id="14012673" author="bikassaha" created="Thu, 29 May 2014 18:34:43 +0000"  >&lt;p&gt;So if you look at the first patch. Its a simple 3 line fix. But I did not like that it was making the state machine inconsistent by moving out of the initializing state. &lt;/p&gt;</comment>
                            <comment id="14012686" author="bikassaha" created="Thu, 29 May 2014 18:40:26 +0000"  >&lt;p&gt;Rebased patch. Please pull latest and apply.&lt;/p&gt;</comment>
                            <comment id="14012708" author="bikassaha" created="Thu, 29 May 2014 18:49:53 +0000"  >&lt;p&gt;Attaching new v3 patch with latest code pulled and rebased. Please pull latest code and apply.&lt;/p&gt;</comment>
                            <comment id="14012903" author="sseth" created="Thu, 29 May 2014 21:06:41 +0000"  >&lt;p&gt;I&apos;m in favour of the first patch, which is much simpler - and fixes the main problem of &quot;-1&quot; parallelism only being allowed in case of 1-1 edges / root inputs.&lt;/p&gt;

&lt;p&gt;On the latest patch itself,&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; .addTransition(VertexState.INITIALIZING,
              EnumSet.of(VertexState.INITED, VertexState.FAILED),
              VertexEventType.V_PARALLELISM_INITIALIZED,
              &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; VertexParallelismInitializedTransition())
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Need to handle the case where RootinputInitializers are pending (and hence the Vertex is in an INITIALIZING state); meanwhile the vertex manager sets parallelism (likely based on one of the RootInputs completing). Should remain in INITIALIZING state in this case, and not start routing of pending events.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; &lt;span class=&quot;code-comment&quot;&gt;// no input initializers. At &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; moment, only other &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; is 1-1 edge
&lt;/span&gt;          &lt;span class=&quot;code-comment&quot;&gt;// with uninitialized sources&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Comment no longer valid.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;+        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (getState() != VertexState.INITIALIZING) {
+          LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Vertex state is not Initializing. Value: &quot;&lt;/span&gt; + getState()
+              + &lt;span class=&quot;code-quote&quot;&gt;&quot; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; vertex: &quot;&lt;/span&gt; + logIdentifier);
+          &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
+        }
+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Fail instead of returning false ?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (vertex.vertexPlan.hasVertexManagerPlugin()) {
            LOG.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Vertex will initialize via user vertex manager. &quot;&lt;/span&gt; + vertex.logIdentifier);
            vertex.sendEventWhenParallelismInitialized = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; VertexState.INITIALIZING;
          }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Even if there are Input initializers, this is a valid log statement - since the InputInitializer itself doesn&apos;t set parallelism; and it&apos;s instead set either by the RootInputVertexManager or by a CustomVertexManager. Similar log statement would be useful there as well.&lt;/p&gt;</comment>
                            <comment id="14013062" author="bikassaha" created="Thu, 29 May 2014 22:55:34 +0000"  >&lt;p&gt;The first patch is smaller but it seemed inconsistent with the state machine and would be susceptible to errors down the road. So I changed the approach even though it was more work &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. The patch would have been cleaner if the root input initializer always got invoked with -1 tasks but the distributor option prevents better unification of code paths because setParallelism() is not called at that time. The bulk of this patch is to unify the initialization -&amp;gt; init logic in one place and use it for all 3 case 1) root input 2) 1-1 split and 3) custom vertex only split.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Need to handle the case where RootinputInitializers are pending&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;In the patch, V_PARALLELISM_INITIALIZED is sent only for case 3 - custom vertex manager only. Thus if there are root input initializers then this event is not sent. Existing input initialization tests in TestVertexImpl cover this case. Ideally I would have liked to unify this but root input init can be with or without -1 tasks and that makes it hard.&lt;/p&gt;

&lt;p&gt;Next patch will address the review comments.&lt;/p&gt;</comment>
                            <comment id="14013095" author="bikassaha" created="Thu, 29 May 2014 23:21:59 +0000"  >&lt;p&gt;Updated patch with comments addressed.&lt;/p&gt;</comment>
                            <comment id="14013193" author="sseth" created="Fri, 30 May 2014 01:35:21 +0000"  >&lt;blockquote&gt;&lt;p&gt;In the patch, V_PARALLELISM_INITIALIZED is sent only for case 3 - custom vertex manager only. Thus if there are root input initializers then this event is not sent. Existing input initialization tests in TestVertexImpl cover this case. Ideally I would have liked to unify this but root input init can be with or without -1 tasks and that makes it hard.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Root Inputs end up setting parallelism via VertexManagers as well (RootInputVertexManager by default). The RootInputInitialized event doesn&apos;t really have anything to do with parallelism itself - instead, relying on Vertex Managers to process the initialization and set parallelism. A custom VertexManager can choose to set parallelism either when one of it&apos;s Inputs is initialized, or after all of them are initialized - so it is possible for the V_PARALLELISM_INITIALIZED event to be generated before all RootInputs are initialized.&lt;/p&gt;

&lt;p&gt;Other than this, the changes looks good to me.&lt;/p&gt;</comment>
                            <comment id="14013300" author="sseth" created="Fri, 30 May 2014 04:59:05 +0000"  >&lt;p&gt;I don&apos;t think there&apos;s a reason to wait in the INITIALIZING state for all Root Inputs to initialize. If INITIALIZING is re-purposed as a state which is only meant for Edge initialization, and setting parallelism (if -1), that would simplify the state machine and logic quite a bit. Will file a follow up jira.&lt;/p&gt;</comment>
                            <comment id="14014242" author="bikassaha" created="Fri, 30 May 2014 21:33:07 +0000"  >&lt;blockquote&gt;&lt;p&gt;so it is possible for the V_PARALLELISM_INITIALIZED event to be generated before all RootInputs are initialized.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I can double check but I dont think this will happen. setParallelism() method sends a V_PARALLELISM_INITIALIZED event only when the sendEventWhenParallelismInitialized flag is set. That flag is not set when root initializers are present. Root input init continues to happen as it does today. The follow up jira on root initialization may simplify the state machine such all initialization code paths go through the same transition such that this flag can be removed. I will add some comments about that flag in the code.&lt;/p&gt;</comment>
                            <comment id="14014244" author="bikassaha" created="Fri, 30 May 2014 21:35:17 +0000"  >&lt;p&gt;Thanks for the review.&lt;/p&gt;</comment>
                            <comment id="14014312" author="sseth" created="Fri, 30 May 2014 22:36:57 +0000"  >&lt;p&gt;Yep, it won&apos;t - if parallelism is set to -1. I think a follow up to clean things out is pretty important - this is far more complicated than it should be.&lt;/p&gt;</comment>
                            <comment id="14014354" author="bikassaha" created="Fri, 30 May 2014 23:24:36 +0000"  >&lt;p&gt;commit 249f7482cdeff968b70db028eb18729d892ff2f5&lt;br/&gt;
Author: Bikas Saha &amp;lt;bikas@apache.org&amp;gt;&lt;br/&gt;
Date:   Fri May 30 15:25:08 2014 -0700&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/TEZ-1151&quot; title=&quot;Vertex should stay in initializing state until custom vertex manager sets the parallelism&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TEZ-1151&quot;&gt;&lt;del&gt;TEZ-1151&lt;/del&gt;&lt;/a&gt;. Vertex should stay in initializing state until custom vertex manager sets the parallelism (bikas)&lt;/p&gt;</comment>
                            <comment id="14124117" author="bikassaha" created="Sat, 6 Sep 2014 01:35:44 +0000"  >&lt;p&gt;Bulk close for jiras fixed in 0.5.0.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12704129">PIG-3846</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12646621" name="TEZ-1151.1.patch" size="2494" author="bikassaha" created="Fri, 23 May 2014 22:22:17 +0000"/>
                            <attachment id="12647237" name="TEZ-1151.2.patch" size="18705" author="bikassaha" created="Wed, 28 May 2014 22:41:32 +0000"/>
                            <attachment id="12647417" name="TEZ-1151.3.patch" size="18098" author="bikassaha" created="Thu, 29 May 2014 18:49:53 +0000"/>
                            <attachment id="12647483" name="TEZ-1151.4.patch" size="19260" author="bikassaha" created="Thu, 29 May 2014 23:21:59 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>394665</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310191" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Hadoop Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10343"><![CDATA[Reviewed]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 11 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1vyav:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>394803</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>