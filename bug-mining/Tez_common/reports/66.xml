<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:54:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[TEZ-4039] Tez should inject dag id, query id into MDC</title>
                <link>https://issues.apache.org/jira/browse/TEZ-4039</link>
                <project id="12314426" key="TEZ">Apache Tez</project>
                    <description>&lt;p&gt;Tez currently uses CallableWithNdc to store thread specific&#160;context. It should also inject the context into MDC so that pattern layout can dump the contexts from MDC (with NDC it is not possible to read the context in pattern lyaout).&lt;/p&gt;

&lt;p&gt;Hive for example, sets queryId in the MDC and pattern layout prints the queryId&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
%d{ISO8601} %-5p [%t (%X{queryId})] %c{2}: %m%n
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Llap sets dagId, fragmentId and queryId into MDC which is used for queryId based routing of logging.&lt;/p&gt;

&lt;p&gt;Similarly, Tez AM should set dagId&#160;and queryId (if available) into MDC.&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13215139">TEZ-4039</key>
            <summary>Tez should inject dag id, query id into MDC</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="abstractdog">L&#225;szl&#243; Bodor</assignee>
                                    <reporter username="prasanth_j">Prasanth Jayachandran</reporter>
                        <labels>
                    </labels>
                <created>Tue, 12 Feb 2019 02:54:39 +0000</created>
                <updated>Mon, 8 Jan 2024 11:09:05 +0000</updated>
                            <resolved>Wed, 26 Oct 2022 04:28:54 +0000</resolved>
                                                    <fixVersion>0.10.3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="16200">4.5h</timespent>
                                <comments>
                            <comment id="16765619" author="prasanth_j" created="Tue, 12 Feb 2019 02:55:13 +0000"  >&lt;p&gt;cc/ &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gopalv&quot; class=&quot;user-hover&quot; rel=&quot;gopalv&quot;&gt;gopalv&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ewohlstadter&quot; class=&quot;user-hover&quot; rel=&quot;ewohlstadter&quot;&gt;ewohlstadter&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16784618" author="jeagles" created="Tue, 5 Mar 2019 16:23:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=prasanth_j&quot; class=&quot;user-hover&quot; rel=&quot;prasanth_j&quot;&gt;prasanth_j&lt;/a&gt;, I can quickly see how usefully this will be. Directly, I see how dagId is relevant, but queryId has no meaning in tez. What does that represent and does that have to be done explicitly, or is setting MDC based on NDC enough (hive sets NDC and then Tez copied NDC to MDC)? Also, is log4j2 required for this functionality?&lt;/p&gt;</comment>
                            <comment id="16784727" author="prasanth_j" created="Tue, 5 Mar 2019 18:06:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jeagles&quot; class=&quot;user-hover&quot; rel=&quot;jeagles&quot;&gt;jeagles&lt;/a&gt; queryId is hive construct which could span one or more dag (union all queries). Currently, hive uses CallableWithNdc provided by tez where it sets up 3 Ids from coarser to finer granularity queryId, dagId, fragmentId&#160;(tez attempt id). The problem with NDC is that it can only be used with log lines, if we want to use id based log routing there is no key associated with NDC so routing based on the keys is not possible.&#160;IIRC tez does something via log4j APIs to route&#160;logs per dag in the AM which could be simplified&#160;if we move to MDC (it then becomes configurable from log4j properties).&lt;/p&gt;

&lt;p&gt;I think copying of NDC to MDC will also be not possible as at the time of copying we do not know what key in MDC to associate the value from NDC. Example: There could be 3 values in NDC like 10 -&amp;gt; 200 -&amp;gt; 300 and when we copy them to MDC we don&apos;t know the keys and how to associate the values to the keys.&lt;/p&gt;

&lt;p&gt;One possible solution is that Tez could provide&#160;CallableWithMdc which hive will use to copy the IDs along with its key.&#160;&lt;/p&gt;

&lt;p&gt;queryId -&amp;gt; 10&lt;/p&gt;

&lt;p&gt;dagId -&amp;gt; 200&lt;/p&gt;

&lt;p&gt;fragmentId -&amp;gt; 300&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Alternate option is to specify custom MDC KVs via config. We could add a tez config to&#160;add custom keys to MDC the value of which can be obtained from conf object as well.&#160;&lt;/p&gt;

&lt;p&gt;A rough example of this could be,&#160;&lt;/p&gt;

&lt;p&gt;tez.mdc.custom.keys=queryId&lt;/p&gt;

&lt;p&gt;tez.mdc.custom.keys.values.from=hive.query.id&lt;/p&gt;

&lt;p&gt;This says add MDC &apos;queryId&apos; with value by reading &apos;hive.query.id&apos; configuration value which will be passed to AM by hive.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This has to be done for task side logs and AM logs.&lt;/p&gt;

&lt;p&gt;Log4j2 is not required for this functionality.&#160;We could use MDC from slf4j.&lt;/p&gt;

&lt;p&gt;Since tez mostly uses slf4j everywhere, with classpath tricks we could make tez work with log4j2 (we just need to put the log4j2 and log4j2 api&#160;bridge jar at the top of classpath and slf4j automatically will bind to log4j2). If tez uses log4j1.x non-standard APIs then this bridge might not work.&#160;&lt;/p&gt;</comment>
                            <comment id="17043386" author="abstractdog" created="Mon, 24 Feb 2020 10:42:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=prasanth_j&quot; class=&quot;user-hover&quot; rel=&quot;prasanth_j&quot;&gt;prasanth_j&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jeagles&quot; class=&quot;user-hover&quot; rel=&quot;jeagles&quot;&gt;jeagles&lt;/a&gt;: could you please take a quick look at   &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12994323/12994323_TEZ-4039.03.patch&quot; title=&quot;TEZ-4039.03.patch attached to TEZ-4039&quot;&gt;TEZ-4039.03.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; ?&lt;br/&gt;
this patch is basically about the following:&lt;br/&gt;
1. Introduce CallableWithMdc, analogous to CallableWithNdc&lt;br/&gt;
2. sets up MDC values in both DAGAppMaster and tasks&lt;br/&gt;
3. automatically handles values which have meaning in tez: dagId, taskAttemptId&lt;br/&gt;
4. according to configuration idea above, lets upstream components inject new MDC keys/values via configuration&lt;/p&gt;

&lt;p&gt;+TODO: &lt;br/&gt;
1. unit tests for basic the util method&lt;br/&gt;
2. container mode cluster testing (I&apos;m going to provide output logs when I&apos;m done)&lt;/p&gt;</comment>
                            <comment id="17192271" author="abstractdog" created="Tue, 8 Sep 2020 15:17:30 +0000"  >&lt;p&gt;there is a working version in:  &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13011227/13011227_TEZ-4039.05.patch&quot; title=&quot;TEZ-4039.05.patch attached to TEZ-4039&quot;&gt;TEZ-4039.05.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; &lt;/p&gt;

&lt;p&gt;testing:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
git clone https:&lt;span class=&quot;code-comment&quot;&gt;//github.com/abstractdog/tez --branch TEZ-4039 --single-branch
&lt;/span&gt;cd tez
mvn clean install -Dtest=TestTezJobs#testHashJoinExampleWithLogPattern

cd tez-tests/target/tmp/org.apache.tez.test.TestTezJobs
# check syslog_dag* and syslog_attempt* files under yarn-*/org.apache.tez.test.TestTezJobs-logDir-nm-0_0
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jeagles&quot; class=&quot;user-hover&quot; rel=&quot;jeagles&quot;&gt;jeagles&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=prasanth_j&quot; class=&quot;user-hover&quot; rel=&quot;prasanth_j&quot;&gt;prasanth_j&lt;/a&gt;: could you please take a look?&lt;br/&gt;
 &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13011227/13011227_TEZ-4039.05.patch&quot; title=&quot;TEZ-4039.05.patch attached to TEZ-4039&quot;&gt;TEZ-4039.05.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;  is a working version, I&apos;ve included manual testing steps&lt;/p&gt;

&lt;p&gt;the change includes all features discussed above + a configurable layout pattern (which turned out to be a very convenient way, that can replace/eliminate painful enviroment-dependent steps, etc. deploying log4j configuration files), which is turned off by default&lt;/p&gt;</comment>
                            <comment id="17276062" author="abstractdog" created="Mon, 1 Feb 2021 05:34:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=prasanth_j&quot; class=&quot;user-hover&quot; rel=&quot;prasanth_j&quot;&gt;prasanth_j&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jeagles&quot; class=&quot;user-hover&quot; rel=&quot;jeagles&quot;&gt;jeagles&lt;/a&gt;: is there a chance that we can refresh this one? I remember I left this here in a fully working state&lt;br/&gt;
now I created a PR on top of master: &lt;a href=&quot;https://github.com/apache/tez/pull/98/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/tez/pull/98/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;testing steps are above, but instead of 05.patch, it&apos;s recommended to use the latest revision from the &lt;a href=&quot;https://github.com/abstractdog/tez/tree/TEZ-4039&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;tree&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17624175" author="abstractdog" created="Wed, 26 Oct 2022 04:28:30 +0000"  >&lt;p&gt;merged to master, thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rbalamohan&quot; class=&quot;user-hover&quot; rel=&quot;rbalamohan&quot;&gt;rbalamohan&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=prasanth_j&quot; class=&quot;user-hover&quot; rel=&quot;prasanth_j&quot;&gt;prasanth_j&lt;/a&gt; for the reviews!&lt;/p&gt;</comment>
                            <comment id="17800336" author="ayushtkn" created="Mon, 25 Dec 2023 17:44:50 +0000"  >&lt;p&gt;For me this doesn&apos;t work with hive master &amp;amp; puts up a warn log for every query&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2023-12-23T03:13:08,920  WARN [DAGAppMaster Thread] util.LoggingUtils: Cannot set log4j global MDC, mdcContext won&apos;t be applied to log4j&apos;s MDC class
java.lang.NoSuchFieldException: tlm
        at java.lang.Class.getDeclaredField(Class.java:2070) ~[?:1.8.0_342]
        at org.apache.tez.util.LoggingUtils.setupLog4j(LoggingUtils.java:113) ~[tez-common-0.10.3-SNAPSHOT.jar:0.10.3-SNAPSHOT]
        at org.apache.tez.dag.app.DAGAppMaster.&amp;lt;init&amp;gt;(DAGAppMaster.java:353) ~[tez-dag-0.10.3-SNAPSHOT.jar:0.10.3-SNAPSHOT]
        at org.apache.tez.client.LocalClient.createDAGAppMaster(LocalClient.java:403) ~[tez-dag-0.10.3-SNAPSHOT.jar:0.10.3-SNAPSHOT]
        at org.apache.tez.client.LocalClient$1.run(LocalClient.java:357) ~[tez-dag-0.10.3-SNAPSHOT.jar:0.10.3-SNAPSHOT]
        at java.lang.Thread.run(Thread.java:750) ~[?:1.8.0_342]
2023-12-23T03:13:08,921  INFO [DAGAppMaster Thread] app.DAGAppMaster: Created DAGAppMaster for application appattempt_1703281387528_0001_000000, versionInfo=[ component=tez-dag, version=0.10.3-SNAPSHOT, revision=0c5cf688690bacc662a015b1bff0ecb556314b90, SCM-URL=scm:git:https://gitbox.apache.org/repos/asf/tez.git, buildTime=2023-12-22T19:59:29Z, buildUser=ayushsaxena, buildJavaVersion=1.8.0_342 ]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We should remove the trace I believe &amp;amp; change it to info I believe, else it will be logging this unnecessarily, mostly it is due to log4j version of hive which doesn&apos;t have this &lt;tt&gt;tlm&lt;/tt&gt; field &lt;br/&gt;
&#160;&lt;/p&gt;</comment>
                            <comment id="17804235" author="abstractdog" created="Mon, 8 Jan 2024 11:09:05 +0000"  >&lt;p&gt;addendum merged to master before releasing 0.10.3&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/tez/commit/174d0d13f7809e881986364511fe129861165a61&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/tez/commit/174d0d13f7809e881986364511fe129861165a61&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ayushtkn&quot; class=&quot;user-hover&quot; rel=&quot;ayushtkn&quot;&gt;ayushtkn&lt;/a&gt; for taking care of this!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13524230">TEZ-4473</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12785001">TEZ-2222</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12994304" name="TEZ-4039.01.patch" size="11989" author="abstractdog" created="Mon, 24 Feb 2020 10:36:39 +0000"/>
                            <attachment id="12994314" name="TEZ-4039.02.patch" size="13508" author="abstractdog" created="Mon, 24 Feb 2020 12:11:06 +0000"/>
                            <attachment id="12994323" name="TEZ-4039.03.patch" size="15713" author="abstractdog" created="Mon, 24 Feb 2020 13:39:16 +0000"/>
                            <attachment id="13011207" name="TEZ-4039.04.patch" size="24414" author="abstractdog" created="Tue, 8 Sep 2020 08:44:50 +0000"/>
                            <attachment id="13011227" name="TEZ-4039.05.patch" size="25276" author="abstractdog" created="Tue, 8 Sep 2020 13:39:01 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 43 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|yi0vow:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>