{"url":"https://api.github.com/repos/pandas-dev/pandas/issues/60107","repository_url":"https://api.github.com/repos/pandas-dev/pandas","labels_url":"https://api.github.com/repos/pandas-dev/pandas/issues/60107/labels{/name}","comments_url":"https://api.github.com/repos/pandas-dev/pandas/issues/60107/comments","events_url":"https://api.github.com/repos/pandas-dev/pandas/issues/60107/events","html_url":"https://github.com/pandas-dev/pandas/issues/60107","id":2615050176,"node_id":"I_kwDOAA0YD86b3n_A","number":60107,"title":"BUG: Stata value label limits incorrect","user":{"login":"jmcoglianese","id":25874554,"node_id":"MDQ6VXNlcjI1ODc0NTU0","avatar_url":"https://avatars.githubusercontent.com/u/25874554?v=4","gravatar_id":"","url":"https://api.github.com/users/jmcoglianese","html_url":"https://github.com/jmcoglianese","followers_url":"https://api.github.com/users/jmcoglianese/followers","following_url":"https://api.github.com/users/jmcoglianese/following{/other_user}","gists_url":"https://api.github.com/users/jmcoglianese/gists{/gist_id}","starred_url":"https://api.github.com/users/jmcoglianese/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jmcoglianese/subscriptions","organizations_url":"https://api.github.com/users/jmcoglianese/orgs","repos_url":"https://api.github.com/users/jmcoglianese/repos","events_url":"https://api.github.com/users/jmcoglianese/events{/privacy}","received_events_url":"https://api.github.com/users/jmcoglianese/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":76811,"node_id":"MDU6TGFiZWw3NjgxMQ==","url":"https://api.github.com/repos/pandas-dev/pandas/labels/Bug","name":"Bug","color":"e10c02","default":false,"description":null},{"id":104865385,"node_id":"MDU6TGFiZWwxMDQ4NjUzODU=","url":"https://api.github.com/repos/pandas-dev/pandas/labels/IO%20Stata","name":"IO Stata","color":"5319e7","default":false,"description":"read_stata, to_stata"},{"id":1954720290,"node_id":"MDU6TGFiZWwxOTU0NzIwMjkw","url":"https://api.github.com/repos/pandas-dev/pandas/labels/Needs%20Triage","name":"Needs Triage","color":"0052cc","default":false,"description":"Issue that has not been reviewed by a pandas team member"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2024-10-25T20:31:09Z","updated_at":"2024-10-31T15:56:56Z","closed_at":"2024-10-31T15:56:56Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Pandas version checks\n\n- [X] I have checked that this issue has not already been reported.\n\n- [X] I have confirmed this bug exists on the [latest version](https://pandas.pydata.org/docs/whatsnew/index.html) of pandas.\n\n- [ ] I have confirmed this bug exists on the [main branch](https://pandas.pydata.org/docs/dev/getting_started/install.html#installing-the-development-version-of-pandas) of pandas.\n\n\n### Reproducible Example\n\n```python\nHere's an example writing a Stata file with value labels that raises an error: \r\n\r\nimport string\r\nimport random\r\nimport pandas as pd\r\ndf = pd.DataFrame(range(65534), columns = [\"col\"])\r\nvalue_labels = {\"col\": {i: ''.join(random.choices(string.ascii_letters, k=21)) for i in range(65534)}}\r\ndf.to_stata(\"label_test.dta\", value_labels=value_labels)\r\n\r\n```python-traceback\r\n>>> df.to_stata(\"label_test.dta\", value_labels=value_labels)\r\nTraceback (most recent call last):\r\n  File \"<stdin>\", line 1, in <module>\r\n  File \".venv/lib/python3.12/site-packages/pandas/core/frame.py\", line 2893, in to_stata\r\n    writer = statawriter(\r\n             ^^^^^^^^^^^^\r\n  File \".venv/lib/python3.12/site-packages/pandas/io/stata.py\", line 2365, in __init__\r\n    self._prepare_pandas(data)\r\n  File \".venv/lib/python3.12/site-packages/pandas/io/stata.py\", line 2616, in _prepare_pandas\r\n    non_cat_value_labels = self._prepare_non_cat_value_labels(data)\r\n                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \".venv/lib/python3.12/site-packages/pandas/io/stata.py\", line 2415, in _prepare_non_cat_value_labels\r\n    svl = StataNonCatValueLabel(colname, labels, self._encoding)\r\n          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \".venv/lib/python3.12/site-packages/pandas/io/stata.py\", line 820, in __init__\r\n    self._prepare_value_labels()\r\n  File \".venv/lib/python3.12/site-packages/pandas/io/stata.py\", line 727, in _prepare_value_labels\r\n    raise ValueError(\r\nValueError: Stata value labels for a single variable must have a combined length less than 32,000 characters.\r\n```\r\n\r\nHere's an example in Stata that constructs the same value label (65,534 entries with 21 characters each) but does not produce an error:\r\n```stata\r\nclear all\r\nset obs 65534\r\ngen x = _n\r\n\r\n* Set up label\r\nlabel define test_lbl 0 \"\"\r\n\r\n* Loop over rows and create unique label for each value\r\nforvalues i = 1/`=_N' {\r\n\t* Add a unique length-21 string label\r\n\tlabel define test_lbl `i' \"`: di %20.19f runiform()'\", add\r\n}\r\n\r\nlabel values x test_lbl\r\n\r\nsave \"label_test.dta\", replace\r\n\r\nclear all\r\n\r\nuse \"label_test.dta\", clear\r\nforvalues i = 1/65534 {\r\n\tassert strlen(\"`: label test_lbl `i', strict'\") == 21\r\n}\r\n```\n```\n\n\n### Issue Description\n\npandas requires that the _combined_ length of the value label not exceed 32,000 characters, but the limit in Stata is actually that _each_ value label can be up to 32,000 characters, and you can have up to 65,536 value labels (see the \"label\" section on this page: https://www.stata.com/products/detailed-size-limits/#label). \n\n### Expected Behavior\n\nThe expected behavior is for pandas to only raise an error if an individual label exceeds 32,000 characters, or if there are more than 65,536 labels. If neither of these limits are exceeded, then pandas should write out the value label, even if the combined length is more than 32,000 characters. \n\n### Installed Versions\n\n```\r\nINSTALLED VERSIONS\r\n------------------\r\ncommit                : d9cdd2ee5a58015ef6f4d15c7226110c9aab8140\r\npython                : 3.12.0.final.0\r\npython-bits           : 64\r\nOS                    : Darwin\r\nOS-release            : 21.6.0\r\nVersion               : Darwin Kernel Version 21.6.0: Wed Apr 24 06:02:02 PDT 2024; root:xnu-8020.240.18.708.4~1/RELEASE_X86_64\r\nmachine               : x86_64\r\nprocessor             : i386\r\nbyteorder             : little\r\nLC_ALL                : None\r\nLANG                  : en_US.UTF-8\r\nLOCALE                : en_US.UTF-8\r\n\r\npandas                : 2.2.2\r\nnumpy                 : 1.26.4\r\npytz                  : 2024.1\r\ndateutil              : 2.9.0.post0\r\nsetuptools            : 75.1.0\r\npip                   : 24.2\r\nCython                : None\r\npytest                : None\r\nhypothesis            : None\r\nsphinx                : None\r\nblosc                 : None\r\nfeather               : None\r\nxlsxwriter            : None\r\nlxml.etree            : 5.2.2\r\nhtml5lib              : None\r\npymysql               : None\r\npsycopg2              : None\r\njinja2                : None\r\nIPython               : 8.26.0\r\npandas_datareader     : None\r\nadbc-driver-postgresql: None\r\nadbc-driver-sqlite    : None\r\nbs4                   : 4.12.3\r\nbottleneck            : 1.3.7\r\ndataframe-api-compat  : None\r\nfastparquet           : None\r\nfsspec                : None\r\ngcsfs                 : None\r\nmatplotlib            : None\r\nnumba                 : None\r\nnumexpr               : 2.8.7\r\nodfpy                 : None\r\nopenpyxl              : None\r\npandas_gbq            : None\r\npyarrow               : None\r\npyreadstat            : None\r\npython-calamine       : None\r\npyxlsb                : None\r\ns3fs                  : None\r\nscipy                 : None\r\nsqlalchemy            : 2.0.32\r\ntables                : None\r\ntabulate              : None\r\nxarray                : None\r\nxlrd                  : None\r\nzstandard             : None\r\ntzdata                : 2023.3\r\nqtpy                  : None\r\npyqt5                 : None\r\n```","closed_by":{"login":"mroeschke","id":10647082,"node_id":"MDQ6VXNlcjEwNjQ3MDgy","avatar_url":"https://avatars.githubusercontent.com/u/10647082?v=4","gravatar_id":"","url":"https://api.github.com/users/mroeschke","html_url":"https://github.com/mroeschke","followers_url":"https://api.github.com/users/mroeschke/followers","following_url":"https://api.github.com/users/mroeschke/following{/other_user}","gists_url":"https://api.github.com/users/mroeschke/gists{/gist_id}","starred_url":"https://api.github.com/users/mroeschke/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mroeschke/subscriptions","organizations_url":"https://api.github.com/users/mroeschke/orgs","repos_url":"https://api.github.com/users/mroeschke/repos","events_url":"https://api.github.com/users/mroeschke/events{/privacy}","received_events_url":"https://api.github.com/users/mroeschke/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pandas-dev/pandas/issues/60107/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pandas-dev/pandas/issues/60107/timeline","performed_via_github_app":null,"state_reason":"completed"}