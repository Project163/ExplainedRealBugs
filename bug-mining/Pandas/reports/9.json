{"url":"https://api.github.com/repos/pandas-dev/pandas/issues/54654","repository_url":"https://api.github.com/repos/pandas-dev/pandas","labels_url":"https://api.github.com/repos/pandas-dev/pandas/issues/54654/labels{/name}","comments_url":"https://api.github.com/repos/pandas-dev/pandas/issues/54654/comments","events_url":"https://api.github.com/repos/pandas-dev/pandas/issues/54654/events","html_url":"https://github.com/pandas-dev/pandas/issues/54654","id":1858285780,"node_id":"I_kwDOAA0YD85uwzDU","number":54654,"title":"BUG: ensure_string_array may change the array inplace","user":{"login":"Itayazolay","id":14018345,"node_id":"MDQ6VXNlcjE0MDE4MzQ1","avatar_url":"https://avatars.githubusercontent.com/u/14018345?v=4","gravatar_id":"","url":"https://api.github.com/users/Itayazolay","html_url":"https://github.com/Itayazolay","followers_url":"https://api.github.com/users/Itayazolay/followers","following_url":"https://api.github.com/users/Itayazolay/following{/other_user}","gists_url":"https://api.github.com/users/Itayazolay/gists{/gist_id}","starred_url":"https://api.github.com/users/Itayazolay/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Itayazolay/subscriptions","organizations_url":"https://api.github.com/users/Itayazolay/orgs","repos_url":"https://api.github.com/users/Itayazolay/repos","events_url":"https://api.github.com/users/Itayazolay/events{/privacy}","received_events_url":"https://api.github.com/users/Itayazolay/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":76811,"node_id":"MDU6TGFiZWw3NjgxMQ==","url":"https://api.github.com/repos/pandas-dev/pandas/labels/Bug","name":"Bug","color":"e10c02","default":false,"description":null},{"id":31404521,"node_id":"MDU6TGFiZWwzMTQwNDUyMQ==","url":"https://api.github.com/repos/pandas-dev/pandas/labels/Dtype%20Conversions","name":"Dtype Conversions","color":"e102d8","default":false,"description":"Unexpected or buggy dtype conversions"},{"id":57522093,"node_id":"MDU6TGFiZWw1NzUyMjA5Mw==","url":"https://api.github.com/repos/pandas-dev/pandas/labels/Strings","name":"Strings","color":"5319e7","default":false,"description":"String extension data type and string data"}],"state":"closed","locked":false,"assignee":{"login":"Itayazolay","id":14018345,"node_id":"MDQ6VXNlcjE0MDE4MzQ1","avatar_url":"https://avatars.githubusercontent.com/u/14018345?v=4","gravatar_id":"","url":"https://api.github.com/users/Itayazolay","html_url":"https://github.com/Itayazolay","followers_url":"https://api.github.com/users/Itayazolay/followers","following_url":"https://api.github.com/users/Itayazolay/following{/other_user}","gists_url":"https://api.github.com/users/Itayazolay/gists{/gist_id}","starred_url":"https://api.github.com/users/Itayazolay/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Itayazolay/subscriptions","organizations_url":"https://api.github.com/users/Itayazolay/orgs","repos_url":"https://api.github.com/users/Itayazolay/repos","events_url":"https://api.github.com/users/Itayazolay/events{/privacy}","received_events_url":"https://api.github.com/users/Itayazolay/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"Itayazolay","id":14018345,"node_id":"MDQ6VXNlcjE0MDE4MzQ1","avatar_url":"https://avatars.githubusercontent.com/u/14018345?v=4","gravatar_id":"","url":"https://api.github.com/users/Itayazolay","html_url":"https://github.com/Itayazolay","followers_url":"https://api.github.com/users/Itayazolay/followers","following_url":"https://api.github.com/users/Itayazolay/following{/other_user}","gists_url":"https://api.github.com/users/Itayazolay/gists{/gist_id}","starred_url":"https://api.github.com/users/Itayazolay/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Itayazolay/subscriptions","organizations_url":"https://api.github.com/users/Itayazolay/orgs","repos_url":"https://api.github.com/users/Itayazolay/repos","events_url":"https://api.github.com/users/Itayazolay/events{/privacy}","received_events_url":"https://api.github.com/users/Itayazolay/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":5,"created_at":"2023-08-20T22:11:11Z","updated_at":"2023-10-29T17:22:58Z","closed_at":"2023-10-29T17:22:57Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Pandas version checks\n\n- [X] I have checked that this issue has not already been reported.\n\n- [X] I have confirmed this bug exists on the [latest version](https://pandas.pydata.org/docs/whatsnew/index.html) of pandas.\n\n- [X] I have confirmed this bug exists on the [main branch](https://pandas.pydata.org/docs/dev/getting_started/install.html#installing-the-development-version-of-pandas) of pandas.\n\n\n### Reproducible Example\n\n```python\nimport numpy as np\r\nimport pickle\r\nfrom pandas._libs.lib import ensure_string_array\r\nt = np.array([None, None, {'a': 1.235}])\r\ntp = pickle.loads(pickle.dumps(t))\r\ng = np.asarray(tp, dtype='object')\r\n\r\nassert g is not tp\r\nassert np.shares_memory(g, tp)\r\n\r\nprint(tp) # Expected [None, None, {'a': 1.235}]\r\nprint(ensure_string_array(tp)) # got [nan, nan, \"{'a': 1.235}\"]\r\nprint(tp) # Expected [None, None, {'a': 1.235}], got [nan, nan, \"{'a': 1.235}\"]\n```\n\n\n### Issue Description\n\nI've had an issue where `df.astype(str)` actually changed `df` in-place instead of only making a copy.  \r\nI've looked into where the values mutate and I found out that it originates in the cython implementation of `ensure_string_array`.  \r\n \r\n* the validation on result is only using `arr is not result` to determine whether to copy the data\r\n* while this condition may be false for `result = np.asarray(arr, dtype='object')` - it may still share memory\r\n    verified with `np.shares_memory(arr, result)`\r\n* I suggest to add/alter the condition with `np.shares_memory`.\r\n\r\nI tried to make a code that replicates the issue with the `astype()` example, but I didn't manage to do it easily.  \r\nI can also make a PR if the solution sounds good to you.\r\n\r\nBTW, I'm not sure why the pickle loads/dumps change the behaviour here, but the example doesn't work without it\n\n### Expected Behavior\n\n`astype()` should return a copy, if not specified otherwise\r\n`ensure_string_array()` should return a copy, if not specified otherwise\n\n### Installed Versions\n\n<details>\r\n\r\nINSTALLED VERSIONS\r\n------------------\r\ncommit           : 37ea63d540fd27274cad6585082c91b1283f963d\r\npython           : 3.10.11.final.0\r\npython-bits      : 64\r\nOS               : Linux\r\nOS-release       : 6.2.0-26-generic\r\nVersion          : #26~22.04.1-Ubuntu SMP PREEMPT_DYNAMIC Thu Jul 13 16:27:29 UTC 2\r\nmachine          : x86_64\r\nprocessor        : x86_64\r\nbyteorder        : little\r\nLC_ALL           : None\r\nLANG             : en_US.UTF-8\r\nLOCALE           : en_US.UTF-8\r\npandas           : 2.0.1\r\nnumpy            : 1.24.3\r\npytz             : 2023.3\r\ndateutil         : 2.8.2\r\nsetuptools       : 57.5.0\r\npip              : 22.3.1\r\nCython           : 0.29.36\r\npytest           : 7.3.1\r\nhypothesis       : None\r\nsphinx           : None\r\nblosc            : None\r\nfeather          : None\r\nxlsxwriter       : 3.1.2\r\nlxml.etree       : 4.9.3\r\nhtml5lib         : None\r\npymysql          : None\r\npsycopg2         : None\r\njinja2           : 3.1.2\r\nIPython          : 8.13.2\r\npandas_datareader: None\r\nbs4              : 4.12.2\r\nbottleneck       : 1.3.7\r\nbrotli           : \r\nfastparquet      : None\r\nfsspec           : 2023.6.0\r\ngcsfs            : 2023.6.0\r\nmatplotlib       : 3.7.2\r\nnumba            : 0.57.1\r\nnumexpr          : 2.8.4\r\nodfpy            : None\r\nopenpyxl         : 3.1.2\r\npandas_gbq       : 0.17.9\r\npyarrow          : 9.0.0\r\npyreadstat       : None\r\npyxlsb           : 1.0.10\r\ns3fs             : None\r\nscipy            : 1.10.1\r\nsnappy           : \r\nsqlalchemy       : None\r\ntables           : 3.8.0\r\ntabulate         : None\r\nxarray           : 2023.6.0\r\nxlrd             : 2.0.1\r\nzstandard        : 0.21.0\r\ntzdata           : 2023.3\r\nqtpy             : None\r\npyqt5            : None\r\n</details>\r\n","closed_by":{"login":"mroeschke","id":10647082,"node_id":"MDQ6VXNlcjEwNjQ3MDgy","avatar_url":"https://avatars.githubusercontent.com/u/10647082?v=4","gravatar_id":"","url":"https://api.github.com/users/mroeschke","html_url":"https://github.com/mroeschke","followers_url":"https://api.github.com/users/mroeschke/followers","following_url":"https://api.github.com/users/mroeschke/following{/other_user}","gists_url":"https://api.github.com/users/mroeschke/gists{/gist_id}","starred_url":"https://api.github.com/users/mroeschke/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mroeschke/subscriptions","organizations_url":"https://api.github.com/users/mroeschke/orgs","repos_url":"https://api.github.com/users/mroeschke/repos","events_url":"https://api.github.com/users/mroeschke/events{/privacy}","received_events_url":"https://api.github.com/users/mroeschke/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pandas-dev/pandas/issues/54654/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pandas-dev/pandas/issues/54654/timeline","performed_via_github_app":null,"state_reason":"completed"}