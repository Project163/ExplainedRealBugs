{"url":"https://api.github.com/repos/pandas-dev/pandas/issues/53533","repository_url":"https://api.github.com/repos/pandas-dev/pandas","labels_url":"https://api.github.com/repos/pandas-dev/pandas/issues/53533/labels{/name}","comments_url":"https://api.github.com/repos/pandas-dev/pandas/issues/53533/comments","events_url":"https://api.github.com/repos/pandas-dev/pandas/issues/53533/events","html_url":"https://github.com/pandas-dev/pandas/issues/53533","id":1743528225,"node_id":"I_kwDOAA0YD85n7CEh","number":53533,"title":"BUG: iloc-indexing with callable has inconsistent semantics if the return type is a tuple","user":{"login":"wence-","id":1126981,"node_id":"MDQ6VXNlcjExMjY5ODE=","avatar_url":"https://avatars.githubusercontent.com/u/1126981?v=4","gravatar_id":"","url":"https://api.github.com/users/wence-","html_url":"https://github.com/wence-","followers_url":"https://api.github.com/users/wence-/followers","following_url":"https://api.github.com/users/wence-/following{/other_user}","gists_url":"https://api.github.com/users/wence-/gists{/gist_id}","starred_url":"https://api.github.com/users/wence-/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wence-/subscriptions","organizations_url":"https://api.github.com/users/wence-/orgs","repos_url":"https://api.github.com/users/wence-/repos","events_url":"https://api.github.com/users/wence-/events{/privacy}","received_events_url":"https://api.github.com/users/wence-/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":76811,"node_id":"MDU6TGFiZWw3NjgxMQ==","url":"https://api.github.com/repos/pandas-dev/pandas/labels/Bug","name":"Bug","color":"e10c02","default":false,"description":null},{"id":2822098,"node_id":"MDU6TGFiZWwyODIyMDk4","url":"https://api.github.com/repos/pandas-dev/pandas/labels/Indexing","name":"Indexing","color":"0b02e1","default":false,"description":"Related to indexing on series/frames, not to indexes themselves"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2023-06-06T10:05:25Z","updated_at":"2023-11-07T17:29:39Z","closed_at":"2023-11-07T17:29:39Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Pandas version checks\n\n- [X] I have checked that this issue has not already been reported.\n\n- [X] I have confirmed this bug exists on the [latest version](https://pandas.pydata.org/docs/whatsnew/index.html) of pandas.\n\n- [ ] I have confirmed this bug exists on the [main branch](https://pandas.pydata.org/docs/dev/getting_started/install.html#installing-the-development-version-of-pandas) of pandas.\n\n\n### Reproducible Example\n\n```python\nimport pandas as pd\r\ndf = pd.DataFrame({\"a\": [1, 2, 3, 4], \"b\": [1, 2, 3, 4]})\r\n\r\nscalar_value = df.iloc[(1, 0)] # a single scalar\r\nsome_rows = df.iloc[lambda df: (1, 0)] # rows 1 and 0\r\ndf.iloc[(1, 0), 0] # indexerror (as expected)\r\ndf.iloc[(lambda df: (1, 0)), 0] # indexerror (as expected)\r\ndf.iloc[lambda df: ((1, 0), 0)] # ValueError setting an array element with a sequence\n```\n\n\n### Issue Description\n\nThe documentation for `iloc` says one possible argument for indexing can be:\r\n\r\n> A callable function with one argument (the calling Series or DataFrame) and that returns valid output for indexing (one of the above). This is useful in method chains, when you donâ€™t have a reference to the calling object, but would like to base your selection on some value.\r\n\r\nNow, recently, in #47989, the documentation was updated to add a _final_ bullet point (below the just quoted text) to say:\r\n\r\n> A tuple of row and column indexes. The tuple elements consist of one of the above inputs, e.g. (0, 1).\r\n\r\nA strict reading of this says that the `callable` is not allowed to return a `tuple` (since a `tuple` is not \"one of the above\").\r\n\r\nOTOH, if we accept that callables are allowed in either slot for rows or columns, then the first two examples above should probably behave identically.\r\n\r\nWhat are the intended semantics here?\n\n### Expected Behavior\n\ncallables should either in all cases not be allowed to return tuples for indexing, or else should have consistent semantics.\r\n\r\nFor consistent semantics, one possible mechanism to do this is to have a fixed point normalisation rule:\r\n\r\n```\r\ndef normalize(key, frame):\r\n    if callable(key):\r\n        return normalize(key(frame), frame)\r\n    if isinstance(tuple, key):\r\n        row, col = key\r\n        return normalize(row, frame), normalize(col, frame)\r\n    return key\r\n```\n\n### Installed Versions\n\n<details>\r\n\r\nINSTALLED VERSIONS\r\n------------------\r\ncommit           : 37ea63d540fd27274cad6585082c91b1283f963d\r\npython           : 3.11.3.final.0\r\npython-bits      : 64\r\nOS               : Linux\r\nOS-release       : 5.19.0-43-generic\r\nVersion          : #44~22.04.1-Ubuntu SMP PREEMPT_DYNAMIC Mon May 22 13:39:36 UTC 2\r\nmachine          : x86_64\r\nprocessor        : x86_64\r\nbyteorder        : little\r\nLC_ALL           : None\r\nLANG             : en_GB.UTF-8\r\nLOCALE           : en_GB.UTF-8\r\n\r\npandas           : 2.0.1\r\nnumpy            : 1.24.3\r\npytz             : 2023.3\r\ndateutil         : 2.8.2\r\nsetuptools       : 67.7.2\r\npip              : 23.1.2\r\nCython           : None\r\npytest           : None\r\nhypothesis       : None\r\nsphinx           : None\r\nblosc            : None\r\nfeather          : None\r\nxlsxwriter       : None\r\nlxml.etree       : None\r\nhtml5lib         : None\r\npymysql          : None\r\npsycopg2         : None\r\njinja2           : None\r\nIPython          : 8.13.2\r\npandas_datareader: None\r\nbs4              : None\r\nbottleneck       : None\r\nbrotli           : None\r\nfastparquet      : None\r\nfsspec           : None\r\ngcsfs            : None\r\nmatplotlib       : None\r\nnumba            : None\r\nnumexpr          : None\r\nodfpy            : None\r\nopenpyxl         : None\r\npandas_gbq       : None\r\npyarrow          : None\r\npyreadstat       : None\r\npyxlsb           : None\r\ns3fs             : None\r\nscipy            : None\r\nsnappy           : None\r\nsqlalchemy       : None\r\ntables           : None\r\ntabulate         : None\r\nxarray           : None\r\nxlrd             : None\r\nzstandard        : None\r\ntzdata           : 2023.3\r\nqtpy             : None\r\npyqt5            : None\r\n\r\n\r\n</details>\r\n","closed_by":{"login":"mroeschke","id":10647082,"node_id":"MDQ6VXNlcjEwNjQ3MDgy","avatar_url":"https://avatars.githubusercontent.com/u/10647082?v=4","gravatar_id":"","url":"https://api.github.com/users/mroeschke","html_url":"https://github.com/mroeschke","followers_url":"https://api.github.com/users/mroeschke/followers","following_url":"https://api.github.com/users/mroeschke/following{/other_user}","gists_url":"https://api.github.com/users/mroeschke/gists{/gist_id}","starred_url":"https://api.github.com/users/mroeschke/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mroeschke/subscriptions","organizations_url":"https://api.github.com/users/mroeschke/orgs","repos_url":"https://api.github.com/users/mroeschke/repos","events_url":"https://api.github.com/users/mroeschke/events{/privacy}","received_events_url":"https://api.github.com/users/mroeschke/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pandas-dev/pandas/issues/53533/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pandas-dev/pandas/issues/53533/timeline","performed_via_github_app":null,"state_reason":"completed"}