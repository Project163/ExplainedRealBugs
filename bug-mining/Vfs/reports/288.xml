<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 22:15:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[VFS-683] Thread safety issue in VFSClassLoader - NullPointerException thrown</title>
                <link>https://issues.apache.org/jira/browse/VFS-683</link>
                <project id="12310495" key="VFS">Commons VFS</project>
                    <description>&lt;p&gt;In my application, I&#160;have two instances of the &lt;tt&gt;VFSClassLoader&lt;/tt&gt;, each of which&#160;is being used in a distinct thread. Both &lt;tt&gt;VFSClassLoader&lt;/tt&gt;&#160;instances refer to the same&#160;compressed file resource described by a &lt;tt&gt;FileObject&lt;/tt&gt; that is passed to the class loader&apos;s constructor.&#160;Intermittently, the application throws an exception with the stack trace shown below. So, there seems to be either a race condition in the code or an undocumented assumption here. If it is unsupported for two &lt;tt&gt;VFSClassLoader&lt;/tt&gt;&#160;instances to refer to the same resource (file), then that assumption should be documented. But if that is not the case, then there is a race condition bug in the implementation.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;43789 WARN  {} c.a.e.u.PreferredPathClassLoader - While loading class org.apache.hive.jdbc.HiveDatabaseMetaData, rethrowing unexpected java.lang.NullPointerException: Inflater has been closed
java.lang.NullPointerException: Inflater has been closed
	at java.util.zip.Inflater.ensureOpen(Inflater.java:389)
	at java.util.zip.Inflater.inflate(Inflater.java:257)
	at java.util.zip.InflaterInputStream.read(InflaterInputStream.java:152)
	at java.io.BufferedInputStream.read1(BufferedInputStream.java:284)
	at java.io.BufferedInputStream.read(BufferedInputStream.java:345)
	at org.apache.commons.vfs2.util.MonitorInputStream.read(MonitorInputStream.java:91)
	at org.apache.commons.vfs2.FileUtil.getContent(FileUtil.java:47)
	at org.apache.commons.vfs2.impl.Resource.getBytes(Resource.java:102)
	at org.apache.commons.vfs2.impl.VFSClassLoader.defineClass(VFSClassLoader.java:179)
	at org.apache.commons.vfs2.impl.VFSClassLoader.findClass(VFSClassLoader.java:150)
        at com.atscale.engine.utils.PreferredPathClassLoader.findClass(PreferredPathClassLoader.scala:54)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13199700">VFS-683</key>
            <summary>Thread safety issue in VFSClassLoader - NullPointerException thrown</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ggregory">Gary D. Gregory</assignee>
                                    <reporter username="daryl.odnert">Daryl Odnert</reporter>
                        <labels>
                    </labels>
                <created>Tue, 20 Nov 2018 21:50:08 +0000</created>
                <updated>Thu, 19 Jan 2023 18:50:15 +0000</updated>
                            <resolved>Wed, 18 Jan 2023 17:06:38 +0000</resolved>
                                    <version>2.2</version>
                                    <fixVersion>2.10.0</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>8</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="7200">2h</timespent>
                                <comments>
                            <comment id="16693974" author="ottobackwards" created="Wed, 21 Nov 2018 01:08:39 +0000"  >&lt;p&gt;any kind of small sample project that can reproduce the issue would be helpful.&lt;/p&gt;

&lt;p&gt;what the provider is, what the file is etc.&lt;/p&gt;</comment>
                            <comment id="16693981" author="ottobackwards" created="Wed, 21 Nov 2018 01:23:00 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
/**
 * Returns an input stream &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; reading the file&apos;s content.
 * &amp;lt;p&amp;gt;
 * There may only be a single input or output stream open &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the file at any time.
 *
 * @&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; An input stream to read the file&apos;s content from. The input stream is buffered, so there is no need to
 *         wrap it in a {@code BufferedInputStream}.
 * @&lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; FileSystemException If the file does not exist, or is being read, or is being written, or on error
 *             opening the stream.
 */
InputStream getInputStream() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; FileSystemException;

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Just from looking through things, It doesn&apos;t seem correct to have two threads going through here.&lt;/p&gt;

&lt;p&gt;The Resource.getBytes() call explicitly CLOSES the stream. &#160; So, it isn&apos;t thread safe for two readers if there is only ever one stream from the same object&lt;/p&gt;</comment>
                            <comment id="16694097" author="daryl.odnert" created="Wed, 21 Nov 2018 01:53:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ottobackwards&quot; class=&quot;user-hover&quot; rel=&quot;ottobackwards&quot;&gt;ottobackwards&lt;/a&gt; - In general, are &lt;tt&gt;FileObject&lt;/tt&gt; instances supposed to be thread-safe? The documentation is unclear about this.&lt;/p&gt;

&lt;p&gt;My colleague and I&#160;are suspicious of the caching that&apos;s happening in &lt;tt&gt;org.apache.commons.vfs2.provider.AbstractFileSystem.resolveFile&lt;/tt&gt;. &lt;a href=&quot;https://svn.apache.org/viewvc/commons/proper/vfs/tags/commons-vfs2-project-2.2/commons-vfs2/src/main/java/org/apache/commons/vfs2/provider/AbstractFileSystem.java?revision=1811361&amp;amp;view=markup#l303&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Source code is here&lt;/a&gt;. With caching&#160;happening here,&#160;the same &lt;tt&gt;FileObject&lt;/tt&gt; instance could be returned to multiple threads, which&#160;would lead to a problem if&#160;more than one of those threads try to read the contents simultaneously.&lt;/p&gt;</comment>
                            <comment id="16694189" author="ottobackwards" created="Wed, 21 Nov 2018 03:57:13 +0000"  >&lt;p&gt;I can&apos;t speak to the intent, I&apos;m not one of the original authors, and have only worked with the library myself as you probably have in a couple of projects, as well as trying to fix a couple of bugs. &#160;And I am wrong a lot &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Further investigation:&lt;/p&gt;

&lt;p&gt;If you look at DefaultFileContent, it looks like we create multiple input streams and store them per thread in thread local. &#160;And then they are closed as such. &#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;BUT: &#160; If this is a ZipFileObject: &#160; The java util zip library says:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
/**
 * Returns an input stream &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; reading the contents of the specified
 * zip file entry.
 *
 * &amp;lt;p&amp;gt; Closing &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; ZIP file will, in turn, close all input
 * streams that have been returned by invocations of &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; method.
 *
 * @param entry the zip file entry
 * @&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; the input stream &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; reading the contents of the specified
 * zip file entry.
 * @&lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; ZipException &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; a ZIP format error has occurred
 * @&lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; an I/O error has occurred
 * @&lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IllegalStateException &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the zip file has been closed
 */
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; InputStream getInputStream(ZipEntry entry) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Which doesn&apos;t seem good.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Still would need to reproduce....&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16694200" author="ottobackwards" created="Wed, 21 Nov 2018 04:12:12 +0000"  >&lt;p&gt;As to in general... &#160;The interface for FileObject is pretty clear that there should be only one input stream opened for any one file at any one time, at least that is my take. &#160; It would be nice if it where more explicit from a higher level.&lt;/p&gt;

&lt;p&gt;You may want to send something to the commons list with a &lt;span class=&quot;error&quot;&gt;&amp;#91;VFS&amp;#93;&lt;/span&gt; subject.&lt;/p&gt;</comment>
                            <comment id="16695032" author="daryl.odnert" created="Wed, 21 Nov 2018 17:51:09 +0000"  >&lt;p&gt;All of your comments are consistent with my concern that the caching mechanism in &lt;tt&gt;AbstractFileSystem.resolveFile&lt;/tt&gt;&#160;is returning the same &lt;tt&gt;FileObject&lt;/tt&gt; instance to two different threads, which is apparently a dangerous thing to do. I&apos;ll try to put together a small sample application that reproduces the problem soon.&lt;/p&gt;</comment>
                            <comment id="16695202" author="b.eckenfels" created="Wed, 21 Nov 2018 19:55:32 +0000"  >&lt;p&gt;Just FYI, I had similiar problems. In my case I made sure that the overlay filesystem I was using had a different filesystem instance, so it was not closing for other threads. But there are definitly a few concurrency problems (and if there are not concurrency problems then there are cleanup/excessive-clone problems). Let me see if I can find the details of my research in that area.&lt;/p&gt;</comment>
                            <comment id="16695425" author="daryl.odnert" created="Thu, 22 Nov 2018 00:37:39 +0000"  >&lt;p&gt;Here is a Java program that demonstrates a problem where if you have more than one thread attempting to read the contents of the children of the same archive file, you will get exceptions thrown. The exceptions this applications receives from VFS are not identical to the &lt;tt&gt;NullPointerException&lt;/tt&gt; that&#160;is listed in&#160;the original problem description, but I think this does demonstrate that there is either a thread-safety issue that needs to be fixed, or some documentation that needs to be clarified.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12949128/12949128_Main.java&quot; title=&quot;Main.java attached to VFS-683&quot;&gt;Main.java&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="16696134" author="ottobackwards" created="Thu, 22 Nov 2018 17:15:26 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=daryl.odnert&quot; class=&quot;user-hover&quot; rel=&quot;daryl.odnert&quot;&gt;daryl.odnert&lt;/a&gt;, I&apos;ll take a peek and see if there is anything obvious, that is non-usage, that can be done.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16696177" author="ottobackwards" created="Thu, 22 Nov 2018 18:20:11 +0000"  >&lt;p&gt;Ok,&lt;/p&gt;

&lt;p&gt;So, with your example the issue is that each time you get the tar archive input stream, it needs to create a new stream, closing the old, so they are taking each other out, which is because as you state the sample File object is resolving.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;In the end, the file object content and streams are not going to be thread safe. &#160;The issue, as you thought is the cache.&lt;/p&gt;

&lt;p&gt;Let me see what I can come up with.&lt;/p&gt;</comment>
                            <comment id="16696181" author="ottobackwards" created="Thu, 22 Nov 2018 18:22:11 +0000"  >&lt;p&gt;I wonder if using the static vfs default manager can be an approach. &#160;So instead of using the static, create your own per thread.&lt;/p&gt;</comment>
                            <comment id="16696193" author="ottobackwards" created="Thu, 22 Nov 2018 18:41:56 +0000"  >&lt;p&gt;For example -&amp;gt; your code works, with the following modifications:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt; org.apache.ottobackwards;

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.commons.vfs2.FileObject;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.commons.vfs2.FileSystemManager;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.commons.vfs2.FileType;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.commons.vfs2.FileUtil;
&lt;span class=&quot;code-comment&quot;&gt;//&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.commons.vfs2.VFS;
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.commons.vfs2.impl.DefaultFileSystemManager;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.commons.vfs2.impl.StandardFileSystemManager;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.commons.vfs2.provider.tar.TarFileProvider;

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Main {

  /**
   * The first parameter (args[0]) should be an directory within an archive file. For example:
   * tgz:file:&lt;span class=&quot;code-comment&quot;&gt;//Users/daryl/zookeeper-3.4.13.tgz!zookeeper-3.4.13/docs
&lt;/span&gt;   */
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) {
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
      &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;File selected is &quot;&lt;/span&gt; + args[0]);
      &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[] threads = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[2];
      &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; threads.length; i++) {
        threads[i] = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FileObjectReadingThread(args[0]), &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.format(&lt;span class=&quot;code-quote&quot;&gt;&quot;THREAD--(%d)--&amp;gt;&quot;&lt;/span&gt;,i));
        threads[i].start();
      }
      &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; threads.length; i++) {
        threads[i].join(0);
      }
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception ex) {
      &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;Main caught &quot;&lt;/span&gt; + ex.getClass().getName() + &lt;span class=&quot;code-quote&quot;&gt;&quot;: &quot;&lt;/span&gt; + ex.getMessage());
      ex.printStackTrace(&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out);
    }
  }

  &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;FileObjectReadingThread &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Runnable&lt;/span&gt; {

    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; filePath;

    FileObjectReadingThread(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; pathname) {
      filePath = pathname;
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void run() {
      &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        FileSystemManager fileSystemManager = createFileSystemManager();
        FileObject fileObject = fileSystemManager.resolveFile(filePath);
        &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; &quot;&lt;/span&gt; + &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().getName() + &lt;span class=&quot;code-quote&quot;&gt;&quot; &quot;&lt;/span&gt; + &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; + &lt;span class=&quot;code-quote&quot;&gt;&quot; running with FileObject &quot;&lt;/span&gt; + &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.identityHashCode(fileObject));
        FileObject[] children = fileObject.getChildren();
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (FileObject child : children) {
          &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (child.getType() == FileType.FILE &amp;amp;&amp;amp; child.isReadable()) {
            &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; &quot;&lt;/span&gt; + &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().getName() + &lt;span class=&quot;code-quote&quot;&gt;&quot; &quot;&lt;/span&gt; + &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; + &lt;span class=&quot;code-quote&quot;&gt;&quot; is reading &quot;&lt;/span&gt; + child);
            FileUtil.getContent(child);
          }
          &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(1); &lt;span class=&quot;code-comment&quot;&gt;// force a yield to other threads
&lt;/span&gt;        }
      } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception ex) {
        &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; &quot;&lt;/span&gt; + &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().getName() + &lt;span class=&quot;code-quote&quot;&gt;&quot; &quot;&lt;/span&gt; + &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; + &lt;span class=&quot;code-quote&quot;&gt;&quot; caught &quot;&lt;/span&gt; + ex.getClass().getName() + &lt;span class=&quot;code-quote&quot;&gt;&quot;: &quot;&lt;/span&gt; + ex.getMessage());
        ex.printStackTrace(&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out);
      }
    }

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; FileSystemManager createFileSystemManager() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
      DefaultFileSystemManager fileSystemManager = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StandardFileSystemManager();
      fileSystemManager.init();
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; fileSystemManager;
    }
  }


}

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16696194" author="ottobackwards" created="Thu, 22 Nov 2018 18:44:49 +0000"  >&lt;p&gt;The things you are dealing with here:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Static FileSystemManager&lt;/li&gt;
	&lt;li&gt;Threads&lt;/li&gt;
	&lt;li&gt;Non-Thread Safe Content&lt;/li&gt;
	&lt;li&gt;Cache&lt;/li&gt;
	&lt;li&gt;Using the FileSystem abstractly ( not having to &quot;know&quot; the fs type )&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;There a number of different approaches, all with trade-offs, I&apos;m sure you all have thought of some as well.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16699478" author="daryl.odnert" created="Mon, 26 Nov 2018 19:43:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ottobackwards&quot; class=&quot;user-hover&quot; rel=&quot;ottobackwards&quot;&gt;ottobackwards&lt;/a&gt; - Yes, I know there are a number of different approaches to work around the problem. I logged this bug report as a request to either fix the software (if there is agreement that there is a defect) or fix the documentation if my multi-threaded application is using VFS&#160;incorrectly.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16699541" author="ottobackwards" created="Mon, 26 Nov 2018 20:27:39 +0000"  >&lt;p&gt;From what I can see in past issues, this is not a defect. &#160;That is why they are not documented as thread safe or immutable. &#160;You can look at &lt;a href=&quot;https://issues.apache.org/jira/browse/VFS-253&quot; title=&quot;AbstractFileObject: wrong synchronization of content-related code&quot; class=&quot;issue-link&quot; data-issue-key=&quot;VFS-253&quot;&gt;VFS-253&lt;/a&gt; as well, which I just found.&lt;/p&gt;

&lt;p&gt;I would suggest creating a Jira to explicitly state in documentation what is and is not thread safe.&lt;/p&gt;

&lt;p&gt;You may also want to start a &lt;span class=&quot;error&quot;&gt;&amp;#91;DISCUSS&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;VFS&amp;#93;&lt;/span&gt; thread on the commons dev mailing list about the issue.&lt;/p&gt;

&lt;p&gt;I am sorry if I have frustrated you, basically working through the issue to get back to where you started.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16699602" author="daryl.odnert" created="Mon, 26 Nov 2018 21:31:57 +0000"  >&lt;p&gt;I have logged&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/VFS-684&quot; title=&quot;Missing thread-safety information in API documentation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;VFS-684&quot;&gt;VFS-684&lt;/a&gt; requesting that the documentation should be fixed. I&apos;m reluctant to start a discussion on the mailing list about the issue as I&apos;m not currently a subscriber and don&apos;t want to subscribe just for the purpose of raising this issue. If you think it&apos;s the right thing to do, we can close this issue as a duplicate of &lt;a href=&quot;https://issues.apache.org/jira/browse/VFS-684&quot; title=&quot;Missing thread-safety information in API documentation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;VFS-684&quot;&gt;VFS-684&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17575316" author="JIRAUSER293862" created="Thu, 4 Aug 2022 15:29:41 +0000"  >&lt;p&gt;Is there any consensus on what to do about the concurrency problem with &lt;tt&gt;org.apache.commons.vfs2.impl.VFSClassLoader&lt;/tt&gt;?&lt;/p&gt;

&lt;p&gt;Removing implementations of ZipFileObject#doAttach and ZipFileObject#doDetach prevents the error indicated in the issue description, but I&apos;m not sure that is a reasonable long-term fix.&lt;/p&gt;</comment>
                            <comment id="17575401" author="garydgregory" created="Thu, 4 Aug 2022 18:45:11 +0000"  >&lt;p&gt;The best thing to do IMO is to document the behavior as not thread safe.&lt;/p&gt;</comment>
                            <comment id="17577602" author="JIRAUSER293862" created="Tue, 9 Aug 2022 19:33:58 +0000"  >&lt;p&gt;I created a &lt;a href=&quot;https://github.com/davem62210/commons-vfs/compare/threads-and-classloading&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt; with a new test case to show the failure.&lt;/p&gt;

&lt;p&gt;Are you saying this case is expected to fail? If so that is surprising.&lt;/p&gt;</comment>
                            <comment id="17600074" author="garydgregory" created="Sun, 4 Sep 2022 15:37:45 +0000"  >&lt;p&gt;I don&apos;t think there is an expectation of failure, but I do not think multi-threading was baked in the design and coding initially. While we have changed the code in an ad-hoc manner here and there over the years to avoid multi-threading issues, it is still the case unless something is actually documented as thread-safe and/or immutable, you should not assume it is safe to use in a multi-threading context.&lt;/p&gt;</comment>
                            <comment id="17676766" author="ibella" created="Fri, 13 Jan 2023 20:57:43 +0000"  >&lt;p&gt;I just submitted a PR that fixes this issue.&#160; Using the VFSClassLoader is not the only way to demonstrate this particular issue.&#160; I think my solution is relatively simple and will alleviate a good set of thread safety issues.&lt;/p&gt;</comment>
                            <comment id="17676792" author="garydgregory" created="Sat, 14 Jan 2023 00:01:43 +0000"  >&lt;p&gt;Except that there are failures in builds that seem random but must be related.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12424815">VFS-253</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310051">
                    <name>Supercedes</name>
                                                                <inwardlinks description="is superceded by">
                                        <issuelink>
            <issuekey id="13200682">VFS-684</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12949128" name="Main.java" size="2043" author="daryl.odnert" created="Thu, 22 Nov 2018 00:33:48 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 43 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|s00ps0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>