<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 22:14:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[VFS-698] SFTP file attributes are fetched multiple times leading to very slow directory listing</title>
                <link>https://issues.apache.org/jira/browse/VFS-698</link>
                <project id="12310495" key="VFS">Commons VFS</project>
                    <description>&lt;p&gt;getChildren()&#160;applied on&#160;SftpFileObject is very slow compared to JSCH implementation. This is because, the&#160;SftpATTRS which is readily available for the children after an &quot;ls&quot; call is again fetched for each child file since they are independently resolved. So if a directory contains 10 files, it results in 1 (ls) + 10 (stat) calls to server.&lt;/p&gt;

&lt;p&gt;For a folder with 100 files (AWS), it took about 35 secs&#160;instead of 1.5 secs to&#160; getChildren().&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;doListChildrenResolved:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;final FileObject fo = getFileSystem().resolveFile(getFileSystem().getFileSystemManager()&lt;/tt&gt;&lt;br/&gt;
 {{ .resolveName(getName(), UriParser.encode(name), NameScope.CHILD));}}&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;&lt;font color=&quot;#ff0000&quot;&gt;((SftpFileObject) FileObjectUtils.getAbstractFileObject(fo)).setStat(stat.getAttrs());&lt;/font&gt;&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The resolveFile call, creates a SftpFileObject and calls its resolve method, which results in getting the (stats) SftpATTRS for each child file. This stat is already available as part of the &apos;ls&apos; call we made. The setStat call above (highlighted is red) is redundant, since stat for each child file is already fetched one at a time.&lt;/p&gt;

&lt;p&gt;The solution would be to avoid getting the stat for each child file after an &apos;ls&apos; call. May be, the framework makes it difficult to do this easily.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13226854">VFS-698</key>
            <summary>SFTP file attributes are fetched multiple times leading to very slow directory listing</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="krishnanmms">krishnan</reporter>
                        <labels>
                    </labels>
                <created>Tue, 9 Apr 2019 06:06:26 +0000</created>
                <updated>Thu, 14 May 2020 16:52:10 +0000</updated>
                            <resolved>Sun, 16 Jun 2019 23:43:40 +0000</resolved>
                                    <version>2.3</version>
                                    <fixVersion>2.4</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16814514" author="garydgregory" created="Wed, 10 Apr 2019 14:51:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krishnanmms&quot; class=&quot;user-hover&quot; rel=&quot;krishnanmms&quot;&gt;krishnanmms&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;It would be best if you could provide this as a PR on GitHub, which would then allow Travis to run a build on your branch/PR.&lt;/p&gt;

&lt;p&gt;Gary&lt;/p&gt;</comment>
                            <comment id="16865060" author="davidseptimus" created="Sun, 16 Jun 2019 15:45:00 +0000"  >&lt;p&gt;I just ran into this issue myself trying to list a directory of ~200,000 files. The call to getChildren() ran for over an hour before I killed it whereas the underlying call to Channel.ls(...) ran for ~30 seconds for the same directory.&lt;/p&gt;

&lt;p&gt;Due to time constraints, I went with a workaround &#8211; extending the FileObject interface with a streamChildren() method that returns a Stream&amp;lt;FileObject&amp;gt; and&#160; an SftpFileObject implementation of that method to lazily convert LsEntry instances to SftpFileObject as needed.&lt;/p&gt;</comment>
                            <comment id="16865089" author="davidseptimus" created="Sun, 16 Jun 2019 17:25:03 +0000"  >&lt;p&gt;As far as I can tell, this is only an issue when your &lt;tt&gt;FileSystem&lt;/tt&gt;&#160;is using &lt;tt&gt;CacheStrategy.ON_RESOLVE&lt;/tt&gt;.&#160;This forces the &lt;tt&gt;FileSystem&lt;/tt&gt; to call &lt;tt&gt;refresh()&lt;/tt&gt; on the newly created &lt;tt&gt;SftpFileObject&lt;/tt&gt; (see: &lt;tt&gt;AbstractFileSystem.resolveFile(...)&lt;/tt&gt;)&#160; and because &lt;tt&gt;attrs&lt;/tt&gt; is null at the the time of resolution, a call is made to the server in order to determine the file&apos;s &lt;tt&gt;FileType&lt;/tt&gt; (see: &lt;tt&gt;SftpFileObject.refresh()&lt;/tt&gt; and&#160;&lt;tt&gt;SftpFileObject.doGetType()&lt;/tt&gt;).&lt;/p&gt;</comment>
                            <comment id="16865112" author="davidseptimus" created="Sun, 16 Jun 2019 18:43:44 +0000"  >&lt;p&gt;This issue is cause by a call to &lt;tt&gt;getType()&lt;/tt&gt; inside from &lt;tt&gt;SftpFileObject&lt;/tt&gt;&apos;s implementation of &lt;tt&gt;FileObject.refresh()&lt;/tt&gt;. This forces a &lt;tt&gt;stat&lt;/tt&gt; call to the SFTP server to refresh the instance&apos;s &lt;tt&gt;FileType&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Based on my understanding of the refresh process, the primary purpose of &lt;tt&gt;refresh()&lt;/tt&gt; is to clear the internal state of the &lt;tt&gt;FileObject&lt;/tt&gt; instance, so the next operation called on the instance is forced to refresh its state from the underlying file sytstem. &lt;tt&gt;SftpFileObject.refresh()&lt;/tt&gt; is the only implementation that&#160; actually makes a file system call.&lt;/p&gt;</comment>
                            <comment id="16865152" author="davidseptimus" created="Sun, 16 Jun 2019 20:24:57 +0000"  >&lt;p&gt;PR raised:&#160;&lt;a href=&quot;https://github.com/apache/commons-vfs/pull/65&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/commons-vfs/pull/65&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17107079" author="remi.ville" created="Thu, 14 May 2020 08:34:02 +0000"  >&lt;p&gt;Hello,&lt;/p&gt;

&lt;p&gt;There&apos;s a similar issue if you call&#160;sftpFile.findFiles(selector) before localFile.copyFrom(sftpFile, selector) because the second call reset file stats in the cache (in .AbstractFileSystem#resolveFile() =&amp;gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (getFileSystemManager().getCacheStrategy().equals(CacheStrategy.ON_RESOLVE)) {
 file.refresh();
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;)&lt;br/&gt;
Then the stats are retrieved one by one.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="12375681">VFS-172</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13304878">VFS-771</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 26 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z01l0g:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>