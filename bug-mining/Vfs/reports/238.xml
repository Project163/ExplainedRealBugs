<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 22:15:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[VFS-299] Listeners on DefaultFileMonitor not deregistered on stop()</title>
                <link>https://issues.apache.org/jira/browse/VFS-299</link>
                <project id="12310495" key="VFS">Commons VFS</project>
                    <description>&lt;p&gt;If I &lt;br/&gt;
1. register a File to a DefaultFileMonitor&lt;br/&gt;
2. stop() that DefaultFileMonitor&lt;br/&gt;
3. create a new DefaultFileMonitor and&lt;br/&gt;
4. register the same File to it&lt;br/&gt;
5. write to the File&lt;/p&gt;

&lt;p&gt;I get the &lt;tt&gt;FileChangeEvent&lt;/tt&gt; on both listeners, on the one registered to the new DefaultFileMonitor (as expected) but also on the one registered to the stopped DefaultFileMonitor. I tracked it down to the &lt;tt&gt;LocalFileSystem.listenerMap&lt;/tt&gt; containing both listeners for the File. In my project I fixed this behaviour as follows:&lt;/p&gt;

&lt;p&gt;Extended the &lt;tt&gt;stop()&lt;/tt&gt; method on &lt;tt&gt;DefaultFileMonitor&lt;/tt&gt;:&lt;/p&gt;

&lt;p&gt;public void stop() {&lt;br/&gt;
    this.shouldRun = false;&lt;br/&gt;
	// Inserted this bit&lt;br/&gt;
	for (FileMonitorAgent agent : (Collection&amp;lt;FileMonitorAgent&amp;gt;)monitorMap.values()) &lt;/p&gt;
{
		agent.removeListeners();
	}
&lt;p&gt;}&lt;/p&gt;

&lt;p&gt;And adding the method to the &lt;tt&gt;DefaultFileMonitor$FileMonitorAgent&lt;/tt&gt;:&lt;/p&gt;

&lt;p&gt;public void removeListeners() {&lt;br/&gt;
	file.getFileSystem().removeListener(file, fm.getFileListener());&lt;br/&gt;
}&lt;/p&gt;</description>
                <environment>&lt;p&gt;windows xp&lt;/p&gt;</environment>
        <key id="12456048">VFS-299</key>
            <summary>Listeners on DefaultFileMonitor not deregistered on stop()</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="josua.troesch">Josua Troesch</reporter>
                        <labels>
                    </labels>
                <created>Thu, 11 Feb 2010 18:07:28 +0000</created>
                <updated>Wed, 9 Oct 2019 13:36:39 +0000</updated>
                                            <version>1.0</version>
                                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="12832610" author="josua.troesch" created="Thu, 11 Feb 2010 18:12:58 +0000"  >&lt;p&gt;&lt;em&gt;Here some example Code to clarify:&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;import org.apache.commons.io.FileUtils;&lt;br/&gt;
import org.apache.commons.vfs.FileChangeEvent;&lt;br/&gt;
import org.apache.commons.vfs.FileListener;&lt;br/&gt;
import org.apache.commons.vfs.FileObject;&lt;br/&gt;
import org.apache.commons.vfs.VFS;&lt;br/&gt;
import org.apache.commons.vfs.impl.DefaultFileMonitor;&lt;/p&gt;

&lt;p&gt;import java.io.File;&lt;br/&gt;
import java.io.IOException;&lt;/p&gt;

&lt;p&gt;public class MinimalFileMonitorBug {&lt;br/&gt;
    private static final String path = &quot;dummy.txt&quot;;&lt;/p&gt;

&lt;p&gt;    public static void main(String[] args) throws IOException, InterruptedException &lt;/p&gt;
{
        MyFileListener listener1 = new MyFileListener();
        DefaultFileMonitor fileMonitor = new DefaultFileMonitor(listener1);
        fileMonitor.addFile(getFileObject());
        fileMonitor.start();
        // Normal operation ...
        fileMonitor.stop();
        // Deliberately writing on file without getting notified.
        MyFileListener listener2 = new MyFileListener();
        fileMonitor = new DefaultFileMonitor(listener2);
        fileMonitor.addFile(getFileObject());
        fileMonitor.start();
        Thread.sleep(1500);
        FileUtils.writeStringToFile(getFile(), &quot;new content&quot;);
        Thread.sleep(1500);
    }

&lt;p&gt;    private static FileObject getFileObject() throws IOException &lt;/p&gt;
{
        return VFS.getManager().resolveFile(getFile().getAbsolutePath());
    }

&lt;p&gt;    private static File getFile() throws IOException {&lt;br/&gt;
        File file = new File(path);&lt;br/&gt;
        if (!file.exists()) &lt;/p&gt;
{
            file.createNewFile();
        }
&lt;p&gt;        return file;&lt;br/&gt;
    }&lt;/p&gt;

&lt;p&gt;    static class MyFileListener implements FileListener {&lt;br/&gt;
        @Override&lt;br/&gt;
        public void fileCreated(FileChangeEvent fileChangeEvent) throws Exception {&lt;br/&gt;
        }&lt;/p&gt;

&lt;p&gt;        @Override&lt;br/&gt;
        public void fileDeleted(FileChangeEvent fileChangeEvent) throws Exception {&lt;br/&gt;
        }&lt;/p&gt;

&lt;p&gt;        @Override&lt;br/&gt;
        public void fileChanged(FileChangeEvent fileChangeEvent) throws Exception &lt;/p&gt;
{
            System.out.println(String.format(&quot;File [%s] changed event from [%s]&quot;, fileChangeEvent.getFile().getName(), this));
        }
&lt;p&gt;    }&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Output:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;File &lt;a href=&quot;file:///E:/test/dummy.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;file:///E:/test/dummy.txt&lt;/a&gt; changed event from &lt;span class=&quot;error&quot;&gt;&amp;#91;MinimalFileMonitorBug$MyFileListener@14b7453&amp;#93;&lt;/span&gt;&lt;br/&gt;
File &lt;a href=&quot;file:///E:/test/dummy.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;file:///E:/test/dummy.txt&lt;/a&gt; changed event from &lt;span class=&quot;error&quot;&gt;&amp;#91;MinimalFileMonitorBug$MyFileListener@c21495&amp;#93;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="16944384" author="falcod" created="Fri, 4 Oct 2019 10:27:38 +0000"  >&lt;p&gt;Despite being more than nine years old, I believe this issue still relevant. I took the liberty to archive above example code in a runnable example project: &lt;a href=&quot;https://github.com/f4lco/vfs-repro/blob/master/src/test/java/vfs/MinimalFileMonitorBug.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/f4lco/vfs-repro/blob/master/src/test/java/vfs/MinimalFileMonitorBug.java&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To my opinion, I do not know if &lt;tt&gt;stop&lt;/tt&gt; should remove the listeners. This would remove the functionality to pause listening for file events using &lt;tt&gt;stop&lt;/tt&gt;, and to resume listening for the same files with &lt;tt&gt;start&lt;/tt&gt; (without re-registration of said files).&lt;/p&gt;

&lt;p&gt;If a method removed filesystem listeners, it should be &lt;tt&gt;removeFile&lt;/tt&gt;. This appears logical to me, since &lt;tt&gt;addFile&lt;/tt&gt; registered the filesystem listener.&lt;br/&gt;
In fact, adding, removing, and re-adding file registrations to the file monitor triggers doubles the change events as demonstrated in &lt;a href=&quot;https://github.com/f4lco/vfs-repro/blob/master/src/test/java/vfs/FileMonitorAddRemoveTest.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/f4lco/vfs-repro/blob/master/src/test/java/vfs/FileMonitorAddRemoveTest.java&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Suggestions:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Let &lt;tt&gt;DefaultFileMonitor#removeFile&lt;/tt&gt; remove the file system listener.&lt;/li&gt;
	&lt;li&gt;Decide what happens on &lt;tt&gt;DefaultFileMonitor#stop&lt;/tt&gt;:
	&lt;ul&gt;
		&lt;li&gt;Keep the current state: it&apos;s duty of the client code to remove all file registrations after calling &lt;tt&gt;stop&lt;/tt&gt; &lt;b&gt;or&lt;/b&gt;&lt;/li&gt;
		&lt;li&gt;Alter behavior and make &lt;tt&gt;stop&lt;/tt&gt; remove all registrations of watched files using (fixed) &lt;tt&gt;removeFile&lt;/tt&gt; (with implications described above)&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;

</comment>
                            <comment id="16945198" author="garydgregory" created="Sun, 6 Oct 2019 00:45:13 +0000"  >&lt;p&gt;Hi&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=josua.troesch&quot; class=&quot;user-hover&quot; rel=&quot;josua.troesch&quot;&gt;josua.troesch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;May you please provide a failing unit test as a PR on GitHub so we can really see what you found...&lt;/p&gt;

&lt;p&gt;Gary&lt;/p&gt;</comment>
                            <comment id="16945611" author="falcod" created="Mon, 7 Oct 2019 06:12:21 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ggregory&quot; class=&quot;user-hover&quot; rel=&quot;ggregory&quot;&gt;ggregory&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;I have doubts &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=josua.troesch&quot; class=&quot;user-hover&quot; rel=&quot;josua.troesch&quot;&gt;josua.troesch&lt;/a&gt;&#160;is still listening in after years of inactivity. I commented on this issue because I believe it&apos;s still relevant and my problem has a common root cause: not removing filesystem listeners.&lt;/p&gt;

&lt;p&gt;I&apos;m unsure what to do about your request. In the previous comment, I linked a GitHub repository of mine whose sole purpose is to provide a minimal, executable examples for this issue. You&apos;ll find &lt;a href=&quot;https://github.com/f4lco/vfs-repro/blob/master/src/test/java/vfs/MinimalFileMonitorBug.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Josua&apos;s original example program&lt;/a&gt;&#160;as well as my &lt;a href=&quot;https://github.com/f4lco/vfs-repro/blob/master/src/test/java/vfs/FileMonitorAddRemoveTest.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;simplified version&lt;/a&gt;&#160;exposing the same issue, which in fact is a unit test. If you experience any troubles reproducing, let me know.&lt;/p&gt;</comment>
                            <comment id="16945990" author="garydgregory" created="Mon, 7 Oct 2019 16:12:27 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=josua.troesch&quot; class=&quot;user-hover&quot; rel=&quot;josua.troesch&quot;&gt;josua.troesch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The reason for asking for a PR instead of pointing to a URL with some code is for you to provide a test that we can use now as opposed to cherry-picking it from a larger set and rewriting the code to provide a working test. For example, the code at the URL &lt;a href=&quot;https://github.com/f4lco/vfs-repro/blob/master/src/test/java/vfs/FileMonitorAddRemoveTest.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/f4lco/vfs-repro/blob/master/src/test/java/vfs/FileMonitorAddRemoveTest.java&lt;/a&gt;&#160;does not compile since it uses &quot;var&quot;, a Java 10 feature, while Commons VFS is on Java 8.&lt;/p&gt;

&lt;p&gt;Providing a PR minimise the friction and time wasting for bringing new test code into this component and allows maintainers like me to focus on analysis and bug fixing instead of the mechanics of importing and fixing code which includes the risk of changing that code in subtle ways that do not reflect the intent of the original post. We maintain a lot of code in Apache Commons &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Thank you for your understanding,&lt;br/&gt;
Gary&#160;&lt;/p&gt;</comment>
                            <comment id="16947403" author="falcod" created="Wed, 9 Oct 2019 07:09:03 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ggregory&quot; class=&quot;user-hover&quot; rel=&quot;ggregory&quot;&gt;ggregory&lt;/a&gt;, I understand. Please see the two test cases contained in&#160;&lt;a href=&quot;https://github.com/apache/commons-vfs/pull/72&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/commons-vfs/pull/72&lt;/a&gt;. Thank you for your commitment to VFS&#160;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>200343</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 5 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1g8on:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>303000</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>