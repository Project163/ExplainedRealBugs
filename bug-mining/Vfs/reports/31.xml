<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 22:13:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[VFS-98] VFS causes deadlocks or is not thread-safe</title>
                <link>https://issues.apache.org/jira/browse/VFS-98</link>
                <project id="12310495" key="VFS">Commons VFS</project>
                    <description>&lt;p&gt;Newer versions of VFS seems to be unusable in multithreading environments, causing a deadlock of some kind. This causes my Java  web server application to completely hang when there is many concurrent connections. My application uses a single FileSystemManager instance, and makes quite heavy use of VFS; opening many files from many threads simultaneously.&lt;/p&gt;

&lt;p&gt;I have tried, without success different workarounds based on some mailing list threads:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Using both NullReferenceFilesCache and the default SoftReferenceFilesCache. (SoftReferenceFilesCache seemed to sometimes cause some additional thread-related exceptions under heavy load, but propably unrelated to this issue)&lt;/li&gt;
	&lt;li&gt;Using the new SynchorizedFileObjectDecorator also did not help. On the contrary, it seemed to trigger the deadlock more easily.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The version I have problems with is a nightly build: commons-vfs-20060831&lt;/p&gt;

&lt;p&gt;The older version commons-vfs-20060115 works beautifully, but I would like to use newer version because I want to be able to use FileObject.refresh() to reset the internal state of files (specially, to get a fresh list of children).&lt;/p&gt;

&lt;p&gt;I hope the threading issues are going to be resolved in near future, and I am willing to help in any way. I do not have very deep experience about multithreading applications, so I wasn&apos;t able to get more close to the roots of the issue. Feel free to ask for more information.&lt;/p&gt;</description>
                <environment>&lt;p&gt;jdk1.5.0_07 / Linux&lt;/p&gt;</environment>
        <key id="12354371">VFS-98</key>
            <summary>VFS causes deadlocks or is not thread-safe</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="imario">Mario Ivankovits</assignee>
                                    <reporter username="yaku">Juha-Matti Toppinen</reporter>
                        <labels>
                    </labels>
                <created>Tue, 31 Oct 2006 14:55:52 +0000</created>
                <updated>Tue, 25 Mar 2008 07:52:18 +0000</updated>
                            <resolved>Wed, 8 Nov 2006 07:15:32 +0000</resolved>
                                    <version>Nightly Builds</version>
                                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="12445918" author="imario" created="Tue, 31 Oct 2006 15:19:57 +0000"  >&lt;p&gt;I dont know why, but everytime when I&apos;ll go on vacation there is something happening around vfs &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;First, please stick with the SoftReferenceFilesCache, its your only option in reality.&lt;br/&gt;
Then, please try one of the very latest builds, as far as I remember I fixed something in this area, but can&apos;t remember when it was, though, I am pretty sure it will help here.&lt;/p&gt;

&lt;p&gt;When your application hangs anyway, please create a &quot;full thread dump&quot; &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; and post it here. This should allow us to debug your problem.&lt;/p&gt;

&lt;p&gt;As a workaround you can create a FileSystemManager per thread by&lt;br/&gt;
1) create the StandardFileSystem manager manually (do not user VFS.getManager())&lt;br/&gt;
2) store the reference in an java.lang.ThreadLocal&lt;/p&gt;

&lt;p&gt;Hope this helps for now.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;http://java.sun.com/developer/technicalArticles/Programming/Stacktrace/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://java.sun.com/developer/technicalArticles/Programming/Stacktrace/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12446226" author="yaku" created="Wed, 1 Nov 2006 12:30:34 +0000"  >&lt;p&gt;Thank you for the quick response.&lt;/p&gt;

&lt;p&gt;Creating a per-thread FileSystemManager is not very comfortable, because I have many, many classes that are shared between threads, and they all have a private main FileObject it uses to store information etc. They also are maintained using Multiton -like pattern, so that only one shared instance is created per FileObject, using FileObject.toString() as object pool key. Redesigning all these classes to use per-thread FileSystemManagers as well as per-thread FileObjects would be quite a lot of work.&lt;/p&gt;

&lt;p&gt;I checked out and built VFS from SVN (nightly builds directory was empty) to get the latest version, and still had the same problem.&lt;/p&gt;

&lt;p&gt;I attach both a thread dump (thanks for the helpful link) as well as a report generated by jstack.&lt;/p&gt;

&lt;p&gt;I tried both with the default VFS.getManager() and creating a custom DefaultFileSystemManager that uses SynchronizedFileObject decorator. Only difference was that with SynchronizedFileObject decorator the deadlock situation occurred more quickly. &lt;/p&gt;
</comment>
                            <comment id="12447180" author="yaku" created="Sat, 4 Nov 2006 20:03:13 +0000"  >&lt;p&gt;Hi again.&lt;/p&gt;

&lt;p&gt;I had some progress on this issue. The problem seems to occur only when a single FileObject is accessed from multiple threads. It works happily when using a single FileSystem, but accessing different files in it simultaneously.&lt;/p&gt;

&lt;p&gt;For me the possible one-time errors caused by the lack of proper synchronization do not matter so much. But a deadlock on the FileSystem is really bad, causing may server to completely stop responding. So I played around trying to fix the problem by just commenting out syncronization stuff based on threaddump information. Not a the most professional method of working around a bug, but I desperately needed a workaround &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Eventually I got it working, and I&apos;ll just list the not-so-well-thought modifications I made, so you can maybe take a look at them and possibly use them as a basis for a proper fix...&lt;/p&gt;

&lt;p&gt;AbstractFileProvider:&lt;br/&gt;
-------------------------------------------------------------------&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;replaced  private final Map fileSystems = new TreeMap(); with: private final Map fileSystems = java.util.Collections.synchronizedMap(new TreeMap()); in order to keep some thread-safety.&lt;/li&gt;
	&lt;li&gt;commented out synchronization stuff from close(), addFileSystem(), findFileSystem() and freeUnusedResources()&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;These did not help yet, so I also made these modifications:&lt;/p&gt;

&lt;p&gt;AbstractFileObject:&lt;br/&gt;
-------------------------------------------------------------------&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;commented out synchronization stuff from detach()&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;AbstractFileSystem:&lt;br/&gt;
-------------------------------------------------------------------&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;removed synchronized keywords from resolveFile(final FileName name) and resolveFile(final FileName name, final boolean useCache)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;And no deadlocks anymore. Hope this helps!&lt;/p&gt;</comment>
                            <comment id="12447937" author="imario" created="Tue, 7 Nov 2006 22:01:39 +0000"  >&lt;p&gt;Hi!&lt;/p&gt;

&lt;p&gt;I committed a fix for this .... hopefully.&lt;/p&gt;

&lt;p&gt;Could you please try it again. In case it hangs again please attach the stacktrace again, but not the jstack one, it doesn&apos;t contain enough informations.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;br/&gt;
Ciao,&lt;br/&gt;
Mario&lt;/p&gt;</comment>
                            <comment id="12448056" author="yaku" created="Wed, 8 Nov 2006 06:57:13 +0000"  >&lt;p&gt;Your fix indeed does seem to fix the problem. This issue, as well as the solution was also quite educational experience for me. Thank you very much!&lt;/p&gt;</comment>
                            <comment id="12448060" author="imario" created="Wed, 8 Nov 2006 07:15:32 +0000"  >&lt;p&gt;You are welcome &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12498825" author="cbeams" created="Thu, 24 May 2007 20:47:17 +0000"  >&lt;p&gt;I assume that because this issue was resolved before the release date of Commons VFS 1.0, that this fix is included in 1.0.  However, the Fix Version is not explicit about this, so I&apos;m writing to make sure my assumption is correct.  I&apos;m running into thread-related issues as well, and though I haven&apos;t pinpointed them, they sound similar to those Juha-Matti was experiencing.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="12498957" author="imario" created="Fri, 25 May 2007 06:48:18 +0000"  >&lt;p&gt;Yes, we fixed it.&lt;/p&gt;

&lt;p&gt;If you experience some deadlocks try generating a &quot;full thread dump&quot;. Its output should help greatly &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Ciao,&lt;br/&gt;
Mario&lt;/p&gt;</comment>
                            <comment id="12499905" author="gorecki" created="Tue, 29 May 2007 19:57:57 +0000"  >&lt;p&gt;Hi Mario,&lt;/p&gt;

&lt;p&gt;     Attached is an example of the deadlock Chris mentioned.  To give you some background info all threads/FileObject operations in this thread dump used the same VFS.getManager() instance.  We&apos;ve been able to get around this for the time being by synchronizing all manager/fileobject operations in a separate singleton class.&lt;/p&gt;

&lt;p&gt;Thanks - Larry&lt;/p&gt;</comment>
                            <comment id="12501017" author="cbeams" created="Sun, 3 Jun 2007 15:27:10 +0000"  >&lt;p&gt;Mario,&lt;/p&gt;

&lt;p&gt;Any other thoughts on this topic?  As Larry mentioned, we do have a workaround in place, but it creates a severe performance penalty.  We&apos;ve synchronized all access to the VFS FileSystemManager, so all actions are serialized.  We&apos;re in a large-volume multithreaded environment, so this quick fix isn&apos;t going to hold up for long.&lt;/p&gt;

&lt;p&gt;VFS is so valuable to us that, if neccessary, we may go down the road of implementing a proper fix ourselves.  Not knowing the codebase, however, this could take quite a bit of guesswork and time.  Any help you can provide would be most appreciated.&lt;/p&gt;

&lt;p&gt;Thanks - Chris &lt;/p&gt;</comment>
                            <comment id="12505882" author="cbeams" created="Mon, 18 Jun 2007 16:55:44 +0000"  >&lt;p&gt;Mario, all,&lt;/p&gt;

&lt;p&gt;We are running into these threading issues (deadlocks) right and left, and trying to work around them by synchronizing on the default shared VFS FileSystemManager instance pretty much everywhere.  Even this is not working, however, and we&apos;re at a crossroads with what seems to be three options:  1) Get help from the VFS team  2) Attempt to fix the issues ourselves  3) ditch VFS and use lower-level libraries directly.&lt;/p&gt;

&lt;p&gt;We&apos;d like to avoid (3) if at all possible; VFS rocks in terms of functionality, and saves us a great deal of coding.  We&apos;re willing to look into option (2), but we&apos;d like to have some design-level conversations with you first.  If there are just &apos;holes&apos; in VFS&apos;s thread-safety that can be patched up, we can work with that; if there are fundamental design problems that preclude thread-safety, it&apos;s probably going to be beyond reasonable scope for us to work on.&lt;/p&gt;

&lt;p&gt;We can also attempt to work up some simple examples that have high likelihood of exhibiting the deadlocks we&apos;re seeing.&lt;/p&gt;

&lt;p&gt;At any rate, we&apos;d really appreciate some feedback on this issue so we can quickly choose one of the three options above.&lt;/p&gt;

&lt;p&gt;Thanks again!&lt;/p&gt;</comment>
                            <comment id="12506089" author="imario" created="Tue, 19 Jun 2007 07:58:35 +0000"  >&lt;p&gt;First: Sorry for my long delay!&lt;/p&gt;

&lt;p&gt;I think I managed to fix this locking issue, could you please give VFS HEAD a try.&lt;br/&gt;
Thanks!&lt;/p&gt;</comment>
                            <comment id="12506958" author="cbeams" created="Thu, 21 Jun 2007 16:56:12 +0000"  >&lt;p&gt;Mario,&lt;/p&gt;

&lt;p&gt;Thanks so much for this (simple!) fix... We have been testing it very heavily these past two days, and have not encountered a single deadlock.&lt;/p&gt;</comment>
                            <comment id="12506967" author="imario" created="Thu, 21 Jun 2007 17:37:54 +0000"  >&lt;p&gt;Hehe - sometimes something looks complicated - its great if there is a simple fix for such a case &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12344088" name="vfs.dead.jstack.txt" size="44830" author="yaku" created="Wed, 1 Nov 2006 12:26:17 +0000"/>
                            <attachment id="12344086" name="vfs.dead.threaddump.synchronizedfileobject.txt" size="11922" author="yaku" created="Wed, 1 Nov 2006 12:23:23 +0000"/>
                            <attachment id="12344087" name="vfs.dead.threaddump.txt" size="53593" author="yaku" created="Wed, 1 Nov 2006 12:24:22 +0000"/>
                            <attachment id="12358469" name="vfs_deadlock.txt" size="26927" author="gorecki" created="Tue, 29 May 2007 19:57:57 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>200157</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            18 years, 23 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i05jnj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>30281</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>