<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 22:14:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[VFS-589] SFTP moveTo operation hangs if the server does not support SSH channelExec.</title>
                <link>https://issues.apache.org/jira/browse/VFS-589</link>
                <project id="12310495" key="VFS">Commons VFS</project>
                    <description>&lt;p&gt;In our case the server was explicitly configured to disable SSH channelExec.&lt;br/&gt;
Our code was hanging trying to execute moveTo(). Stacktrace:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: TIMED_WAITING (on object monitor)
    at java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(Native Method)
    at java.io.PipedInputStream.read(PipedInputStream.java:326)
    - locked &amp;lt;0x00000006a7a184d0&amp;gt; (a com.jcraft.jsch.Channel$MyPipedInputStream)
    at java.io.PipedInputStream.read(PipedInputStream.java:377)
    - locked &amp;lt;0x00000006a7a184d0&amp;gt; (a com.jcraft.jsch.Channel$MyPipedInputStream)
    at sun.nio.cs.StreamDecoder.readBytes(StreamDecoder.java:284)
    at sun.nio.cs.StreamDecoder.implRead(StreamDecoder.java:326)
    at sun.nio.cs.StreamDecoder.read(StreamDecoder.java:178)
    - locked &amp;lt;0x00000006a7a184b8&amp;gt; (a java.io.InputStreamReader)
    at java.io.InputStreamReader.read(InputStreamReader.java:184)
    at org.apache.commons.vfs2.provider.sftp.SftpFileSystem.executeCommand(SftpFileSystem.java:328)
    at org.apache.commons.vfs2.provider.sftp.SftpFileSystem.getGroupsIds(SftpFileSystem.java:260)
    at org.apache.commons.vfs2.provider.sftp.SftpFileObject.getPermissions(SftpFileObject.java:317)
    at org.apache.commons.vfs2.provider.sftp.SftpFileObject.doIsWriteable(SftpFileObject.java:357)
    at org.apache.commons.vfs2.provider.AbstractFileObject.isWriteable(AbstractFileObject.java:1791)
    at org.apache.commons.vfs2.impl.DecoratedFileObject.isWriteable(DecoratedFileObject.java:229)
    at org.apache.commons.vfs2.cache.OnCallRefreshFileObject.isWriteable(OnCallRefreshFileObject.java:156)
    at org.apache.commons.vfs2.provider.AbstractFileObject.moveTo(AbstractFileObject.java:1857)
    at org.apache.commons.vfs2.impl.DecoratedFileObject.moveTo(DecoratedFileObject.java:241)
    at org.apache.commons.vfs2.cache.OnCallRefreshFileObject.moveTo(OnCallRefreshFileObject.java:184)
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Technically the connection was alive because the session had a configured timeout and the jcraft code kept sending keepalive SSH_MSG_GLOBAL_REQUEST messages, but the thread performing FileObject.moveTo() did not return from moveTo().&lt;br/&gt;
I have changed SftpProviderTestCase to reproduce the problem: testRenameFile() hangs.&lt;br/&gt;
The patch (patch_sftp_tests_hang_no_exec.diff) is attached.&lt;/p&gt;


&lt;p&gt;I traced the problem to the fact that VFS invokes method com.jcraft.jsch.Channel.connect(). This method uses timeout value 0, in which case class com.jcraft.jsch.ChannelExec creates an instance of class com.jcraft.jsch.RequestExec that sends an SSH packet SSH_MSG_CHANNEL_REQUEST with &quot;want reply&quot; set to 0.&lt;br/&gt;
Correspondingly, if the server supports SSH channelExec, it executes the specified command and returns some data.&lt;br/&gt;
But if the server &lt;b&gt;does not&lt;/b&gt; support SSH channelExec it sends nothing back while jcraft code tries to read something. This is the hang I am observing.&lt;/p&gt;


&lt;p&gt;The fix would be to invoke com.jcraft.jsch.Channel.connect(int connectTimeout).&lt;br/&gt;
As a result jcraft sends an SSH packet SSH_MSG_CHANNEL_REQUEST with &quot;want reply&quot; set to 1 &lt;b&gt;and&lt;/b&gt; it waits for an answer &lt;b&gt;and&lt;/b&gt; it reacts to the answer.&lt;/p&gt;

&lt;p&gt;Correspondingly, if the server supports SSH channelExec, it sends an SSH packet SSH_MSG_CHANNEL_SUCCESS and the executes the specified command and returns some data.&lt;br/&gt;
If the server &lt;b&gt;does not&lt;/b&gt; support SSH channelExec it sends an SSH packet SSH_MSG_CHANNEL_FAILURE.&lt;br/&gt;
jcraft reacts on either of this messages because if waits for one of them. If it receives SSH_MSG_CHANNEL_SUCCESS it goes further and reads the response of the executed command.&lt;br/&gt;
If it receives SSH_MSG_CHANNEL_FAILURE it immediately reports this by throwing JSchException with message &quot;failed to send channel request&quot;.&lt;br/&gt;
There is no hang whatsoever. Instead all tests from ProviderRenameTests fail with errors like&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Could not determine &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; file &lt;span class=&quot;code-quote&quot;&gt;&quot;sftp:&lt;span class=&quot;code-comment&quot;&gt;//testtest@localhost:50036/write-tests&quot;&lt;/span&gt; is writeable.&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;The test suite actually hangs at the end, but this is caused by &lt;a href=&quot;https://issues.apache.org/jira/browse/VFS-588&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/VFS-588&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;I have patched VFS classes to always open jcraft&apos;s channels with timeouts. In addition the patch always sets some default timeout value on jcraft&apos;s session if none was configured via SftpFileSystemConfigBuilder.&lt;br/&gt;
Patch is also attached:  patch_sftp_timeouts.diff&lt;/p&gt;</description>
                <environment></environment>
        <key id="12916925">VFS-589</key>
            <summary>SFTP moveTo operation hangs if the server does not support SSH channelExec.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="klv_m72">L</reporter>
                        <labels>
                    </labels>
                <created>Mon, 30 Nov 2015 10:35:30 +0000</created>
                <updated>Tue, 31 Oct 2017 07:44:49 +0000</updated>
                            <resolved>Thu, 26 Oct 2017 15:58:16 +0000</resolved>
                                    <version>Nightly Builds</version>
                                    <fixVersion>2.3</fixVersion>
                                        <due></due>
                            <votes>2</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15031632" author="klv_m72" created="Mon, 30 Nov 2015 10:36:35 +0000"  >&lt;p&gt;Patch to the test (SftpProviderTestCase) to reproduce the issue&lt;/p&gt;</comment>
                            <comment id="15031633" author="klv_m72" created="Mon, 30 Nov 2015 10:37:05 +0000"  >&lt;p&gt;Patch with the proposed fix.&lt;/p&gt;</comment>
                            <comment id="16216006" author="sod" created="Mon, 23 Oct 2017 23:00:46 +0000"  >&lt;p&gt;When will the fix be included in the latest version of vfs? vfs is now 2.2&lt;/p&gt;</comment>
                            <comment id="16218911" author="garydgregory" created="Wed, 25 Oct 2017 15:37:20 +0000"  >&lt;p&gt;Hi All,&lt;/p&gt;

&lt;p&gt;I am not sure I like the complexity of this patch and the way it decides that an arbitrary timeout should be used when none is specified. &lt;/p&gt;

&lt;p&gt;Without the patches you propose:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does you current call site set a timeout? If not, why not?&lt;/li&gt;
	&lt;li&gt;What happens if you set a timeout as a user of VFS?&lt;/li&gt;
	&lt;li&gt;Would it not be simpler to let the SftpFileSystemConfigBuilder have a default timeout value (like 30 or 60 seconds) instead of null? That would likely be a one-line change.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16218961" author="klv_m72" created="Wed, 25 Oct 2017 16:08:01 +0000"  >&lt;p&gt;Sorry, what &quot;complexity&quot;? diff file of 64 lines patching two java files?&lt;/p&gt;

&lt;p&gt;Letting SftpFileSystemConfigBuilder have a default timeout would solve one thing only: the proposed patch to SftpClientFactory.java.&lt;/p&gt;

&lt;p&gt;It does not solve the &lt;b&gt;main&lt;/b&gt; problem: SftpFileSystem.java invoking channel.connect();  instead of channel.connect(some_timeout);&lt;/p&gt;
</comment>
                            <comment id="16219495" author="garydgregory" created="Wed, 25 Oct 2017 20:51:29 +0000"  >&lt;p&gt;Let me see what I can do...&lt;/p&gt;</comment>
                            <comment id="16220674" author="garydgregory" created="Thu, 26 Oct 2017 15:58:16 +0000"  >&lt;p&gt;Here is what&apos;s new in &lt;tt&gt;SftpFileSystemConfigBuilder&lt;/tt&gt;:&lt;/p&gt;

&lt;p&gt;I added:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;tt&gt;setConnectTimeoutMillis(FileSystemOptions, Integer)&lt;/tt&gt; and a getter.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;setSessionTimeoutMillis(FileSystemOptions, Integer)&lt;/tt&gt; and a getter.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I deprecated &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;tt&gt;setTimeout(FileSystemOptions, Integer)&lt;/tt&gt; and the getter in favor of &lt;tt&gt;setSessionTimeoutMillis(FileSystemOptions, Integer)&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The default behavior has NOT changed.&lt;/p&gt;

&lt;p&gt;This let&apos;s you get set a connection timeout AND/OR a session timeout.&lt;/p&gt;

&lt;p&gt;Please verify and close or comment.&lt;/p&gt;

&lt;p&gt;Thank you.&lt;/p&gt;</comment>
                            <comment id="16226410" author="klv_m72" created="Tue, 31 Oct 2017 07:44:49 +0000"  >&lt;p&gt;The fix looks OK.  As for verifying it: I have proposed a test to verify the fix, see patch_sftp_tests_hang_no_exec.diff.&lt;/p&gt;

&lt;p&gt;I think it is a good idea to add this test case to the set of SFTP tests. This way you get the automatic verification.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12774802" name="patch_sftp_tests_hang_no_exec.diff" size="2906" author="klv_m72" created="Mon, 30 Nov 2015 10:36:35 +0000"/>
                            <attachment id="12774803" name="patch_sftp_timeouts.diff" size="2739" author="klv_m72" created="Mon, 30 Nov 2015 10:37:05 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 2 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2p26n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>