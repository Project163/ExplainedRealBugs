<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 22:14:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[VFS-558] java.lang.UnsupportedOperationException in FtpFileObject</title>
                <link>https://issues.apache.org/jira/browse/VFS-558</link>
                <project id="12310495" key="VFS">Commons VFS</project>
                    <description>&lt;p&gt;I am getting the following exception in my code:&lt;/p&gt;

&lt;p&gt;java.lang.UnsupportedOperationException&lt;br/&gt;
	at java.util.Collections$UnmodifiableMap.remove(Collections.java:1345)&lt;br/&gt;
	at org.apache.commons.vfs2.provider.ftp.FtpFileObject.onChildrenChanged(FtpFileObject.java:271)&lt;br/&gt;
	at org.apache.commons.vfs2.provider.AbstractFileObject.childrenChanged(AbstractFileObject.java:240)&lt;br/&gt;
	at org.apache.commons.vfs2.provider.AbstractFileObject.notifyParent(AbstractFileObject.java:1931)&lt;br/&gt;
	at org.apache.commons.vfs2.provider.AbstractFileObject.handleCreate(AbstractFileObject.java:1577)&lt;br/&gt;
	at org.apache.commons.vfs2.provider.AbstractFileObject.moveTo(AbstractFileObject.java:1866)&lt;br/&gt;
	at org.apache.commons.vfs2.impl.DecoratedFileObject.moveTo(DecoratedFileObject.java:241)&lt;br/&gt;
	at org.apache.commons.vfs2.cache.OnCallRefreshFileObject.moveTo(OnCallRefreshFileObject.java:184)&lt;br/&gt;
...&lt;/p&gt;

&lt;p&gt;I guess it is caused by the fact that children field is set to EMPTY_FTP_FILE_MAP at the moment onChildrenChanged() is invoked.&lt;/p&gt;

&lt;p&gt;I also do not like line 1866 in AbstractFileObject.java. To me it looks like it might be the real cause of the problem:&lt;/p&gt;

&lt;p&gt;FileObjectUtils.getAbstractFileObject(destFile).handleCreate(getType());&lt;/p&gt;

&lt;p&gt;Must it not be destFile.getType()?&lt;/p&gt;

&lt;p&gt;But even if I am right about AbstractFileObject.java:1866, FtpFileObject.onChildrenChanged() must be corrected as well.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12768312">VFS-558</key>
            <summary>java.lang.UnsupportedOperationException in FtpFileObject</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="b.eckenfels">Bernd Eckenfels</assignee>
                                    <reporter username="klv_m72">L</reporter>
                        <labels>
                    </labels>
                <created>Sun, 18 Jan 2015 16:12:29 +0000</created>
                <updated>Thu, 19 May 2016 18:26:09 +0000</updated>
                            <resolved>Sun, 18 Jan 2015 23:21:08 +0000</resolved>
                                    <version>2.0</version>
                                    <fixVersion>2.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14281876" author="b.eckenfels" created="Sun, 18 Jan 2015 17:36:40 +0000"  >&lt;p&gt;Thanks for the report, I agree with your analysis, we need to check that.&lt;/p&gt;

&lt;p&gt;BTW: I also think that the case of moving a file into an empty folder must be in the provider test suite. If you have some time, it would be best when you can start with exactly that reproducer.&lt;br/&gt;
BTW2: do you use OnCallRefresher on purpose, I can imagine that makes FTP quite slow.&lt;/p&gt;</comment>
                            <comment id="14281942" author="klv_m72" created="Sun, 18 Jan 2015 20:17:56 +0000"  >&lt;p&gt;Re: BTW2: do you use OnCallRefresher on purpose, I can imagine that makes FTP quite slow.&lt;/p&gt;

&lt;p&gt;Well, I do use CacheStrategy.ON_CALL, so yes, it is OnCallRefreshFileObject.&lt;br/&gt;
My code has some checks before performing moveTo to verify the destination file is not there so I am not overwriting it.&lt;br/&gt;
My tests gave me quite a lot of spurious warnings saying the file IS there before the rename while I quite sure it was not there.&lt;br/&gt;
Adding the CacheStrategy.ON_CALL helped a lot but sometimes I still get false positives.&lt;/p&gt;</comment>
                            <comment id="14281954" author="b.eckenfels" created="Sun, 18 Jan 2015 20:42:39 +0000"  >&lt;p&gt;Hm, what version of VFS you are using? 2.0 has only 1855 lines in AbstractFileObject and 2.1 (trunk) does not align with the line numbers. Do you maybe have an older trunk version? Can you try a newer trunk version?&lt;/p&gt;</comment>
                            <comment id="14281955" author="b.eckenfels" created="Sun, 18 Jan 2015 20:43:57 +0000"  >&lt;p&gt;I would use ON_RESOLVE or even MANUAL and then use refresh() in those particular places where you want to have an up-to-date view of the children. Because with ON_CALL you cannot control which of the methods actually need the refresh and which not. But: this should not be related to your bug report, I just noticed it.&lt;/p&gt;</comment>
                            <comment id="14282007" author="b.eckenfels" created="Sun, 18 Jan 2015 23:21:08 +0000"  >&lt;p&gt;I just added a test case, but it does only produce the problem when ON_CALL is used. Because otherwise the getType() on the source will not re-check the renamed file and uses the correct type.&lt;/p&gt;

&lt;p&gt;BTW: a lot of the test cases fail with ON_CALL (mostly because they use assertSame() to verify exepcted results. We will have to change that and then think about running the provider tests with all strategies. Maybe even with a NullFilesCache.)&lt;/p&gt;

&lt;p&gt;Anyway, I fixed the rename in trunk, can you try? (and really consider not using ON_CALL &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://svn.apache.org/r1652870&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1652870&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14282815" author="klv_m72" created="Mon, 19 Jan 2015 18:24:50 +0000"  >&lt;p&gt;Re: Anyway, I fixed the rename in trunk, can you try?&lt;/p&gt;

&lt;p&gt;Yes, it is fixed, thanks.&lt;/p&gt;

&lt;p&gt;Re: I would use ON_RESOLVE or even MANUAL and then use refresh() in those particular places where you want to have an up-to-date view of the children. Because with ON_CALL you cannot control which of the methods actually need the refresh and which not. But: this should not be related to your bug report, I just noticed it.&lt;/p&gt;

&lt;p&gt;Since I was getting problems even with ON_CALL, I have added refresh() before checking if a file exists, and it looks like it has solved spurious warnings. I cannot be 100% sure because the warnings did not always occur when I have run my tests without refresh().&lt;/p&gt;

&lt;p&gt;Re: BTW2: do you use OnCallRefresher on purpose, I can imagine that makes FTP quite slow.&lt;br/&gt;
Re: and really consider not using ON_CALL&lt;/p&gt;

&lt;p&gt;This sounds intuitively as a correct piece of advice.&lt;/p&gt;

&lt;p&gt;The thing is: my tests show different results:&lt;br/&gt;
I have a code that initializes an instance of  StandardFileSystemManager with a setCacheStrategy(CacheStrategy.ON_CALL) before .init().&lt;/p&gt;

&lt;p&gt;My tests accessing a local FS with setCacheStrategy(CacheStrategy.ON_CALL) commented out are about 40% faster than with setCacheStrategy(CacheStrategy.ON_CALL) performed. As expected.&lt;/p&gt;

&lt;p&gt;But FTP tests with ON_CALL are about the same 40% faster than with setCacheStrategy(CacheStrategy.ON_CALL) commented out. Dare to explain?&lt;/p&gt;
</comment>
                            <comment id="14282877" author="b.eckenfels" created="Mon, 19 Jan 2015 19:11:00 +0000"  >&lt;p&gt;Thanks for testing! I really hope to release soon (so you better not find new bugs &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;)&lt;/p&gt;

&lt;p&gt;Would you mind moving the discussion to users@common.apache.org mailing list? It would be interesting if you can summarize your tests.&lt;/p&gt;

&lt;p&gt;If ON_CALL is faster than ON_RESOLVE (which is the default I hope &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; I would expect there are some strange timeout issues. If you can have a look at the FTP server command logfile it would be interesting to compare the number and types of commands used in both cases. (and just a reminder the CacheStrategy is only dealing with directory content and file metadata, so if you mostly transfer file content it is not much of a change).&lt;/p&gt;</comment>
                            <comment id="14283917" author="klv_m72" created="Tue, 20 Jan 2015 15:22:55 +0000"  >&lt;p&gt;Re: Thanks for testing! I really hope to release soon (so you better not find new bugs )&lt;/p&gt;

&lt;p&gt;Sorry: &lt;a href=&quot;https://issues.apache.org/jira/browse/VFS-559&quot; title=&quot;FTPClientWrapper is not robust against some failures&quot; class=&quot;issue-link&quot; data-issue-key=&quot;VFS-559&quot;&gt;&lt;del&gt;VFS-559&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15291811" author="b.eckenfels" created="Thu, 19 May 2016 18:26:09 +0000"  >&lt;p&gt;Apache Commons VFS 2.1 has been released. It includes this (total 171) resolved issues.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 26 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i24i3j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>