<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 22:14:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[VFS-309] ThreadLocal memory leak in DefaultFileContent</title>
                <link>https://issues.apache.org/jira/browse/VFS-309</link>
                <project id="12310495" key="VFS">Commons VFS</project>
                    <description>&lt;p&gt;When using commons vfs in a servlet container the ThreadLocal values stored will not be released once the request finishes.&lt;/p&gt;

&lt;p&gt;There needs to be a method to clear these values otherwise the data will leak into the next request.&lt;/p&gt;

&lt;p&gt;This was detected with tomcat 6.0.26. Upon undeploying an app that uses commons vfs tomcat detects the leaks with a huge amount of the following messages:&lt;/p&gt;

&lt;p&gt;A web application created a ThreadLocal with key of type &lt;span class=&quot;error&quot;&gt;&amp;#91;java.lang.ThreadLocal&amp;#93;&lt;/span&gt; (value &lt;span class=&quot;error&quot;&gt;&amp;#91;java.lang.ThreadLocal@52fb241d&amp;#93;&lt;/span&gt;) and a value of type &lt;span class=&quot;error&quot;&gt;&amp;#91;org.apache.commons.vfs.provider.FileContentThreadData&amp;#93;&lt;/span&gt; (value &lt;span class=&quot;error&quot;&gt;&amp;#91;org.apache.commons.vfs.provider.FileContentThreadData@6600167a&amp;#93;&lt;/span&gt;) but failed to remove it when the web application was stopped. To prevent a memory leak, the ThreadLocal has been forcibly removed.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Tomcat servlet container&lt;/p&gt;</environment>
        <key id="12465113">VFS-309</key>
            <summary>ThreadLocal memory leak in DefaultFileContent</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="b.eckenfels">Bernd Eckenfels</assignee>
                                    <reporter username="jontro">jontro</reporter>
                        <labels>
                    </labels>
                <created>Fri, 21 May 2010 12:08:49 +0000</created>
                <updated>Thu, 19 May 2016 18:25:59 +0000</updated>
                            <resolved>Thu, 11 Dec 2014 15:44:05 +0000</resolved>
                                    <version>2.0</version>
                                    <fixVersion>2.1</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="12927427" author="ralph.goers@dslextreme.com" created="Tue, 2 Nov 2010 14:19:44 +0000"  >&lt;p&gt;DefaultFileContent.close() will remove the ThreadData, however a subsequent call to isOpen() would proceed to add a new Object to the ThreadLocal since getThreadData() unconditionally adds one. &lt;/p&gt;</comment>
                            <comment id="12927454" author="jontro" created="Tue, 2 Nov 2010 15:05:06 +0000"  >&lt;p&gt;I was not aware of being required to call that method. Is it possible to do this when closing the input/outputstream aswell?&lt;/p&gt;</comment>
                            <comment id="12989095" author="godot" created="Tue, 1 Feb 2011 08:35:29 +0000"  >&lt;p&gt;In the case of getting a zip file the workaround with DefaultFileContent.close() does not work as for all files within the zip file the ThreadLocal object is still valid and will not deleted by gc.&lt;/p&gt;</comment>
                            <comment id="13149797" author="jontro" created="Mon, 14 Nov 2011 18:16:32 +0000"  >&lt;p&gt;This is still an issue. Why even store it in a ThreadLocal at all, it could be implemented with a custom class for storing it like described in this article:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://blog.maxant.co.uk/pebble/2008/09/23/1222200780000.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://blog.maxant.co.uk/pebble/2008/09/23/1222200780000.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;It also would be nice to be able to clear this per thread after a request has been made in a request filter.&lt;/p&gt;</comment>
                            <comment id="13976849" author="golion" created="Tue, 22 Apr 2014 14:43:14 +0000"  >&lt;p&gt;I tracked down a problem we were having that appears to be this bug.  Turns out the ThreadLocal class can put more than one value it it&apos;s map if the same object in the same thread adds a value more than once.  &lt;/p&gt;

&lt;p&gt;What should fix this is in the close() method instead of calling:&lt;br/&gt;
threadData.set(null);&lt;/p&gt;

&lt;p&gt;the line should instead look like this:&lt;br/&gt;
threadData.remove();&lt;/p&gt;

&lt;p&gt;The set(null) method will either set the &quot;exact&quot; key matching value to null, or add a new entry, leaving all other map entries for the owning Object instance in the Thread until the thread ends.  The remove() method attempts to remove all the entries for the instance, not just the exact match, though I admit I don&apos;t (atm) entirely understand how it does that.&lt;/p&gt;</comment>
                            <comment id="14215214" author="golion" created="Mon, 17 Nov 2014 21:33:12 +0000"  >&lt;p&gt;Attaching same patch as I just attached to the related issue.&lt;/p&gt;</comment>
                            <comment id="14215696" author="b.eckenfels" created="Tue, 18 Nov 2014 04:34:09 +0000"  >&lt;p&gt;As commented in &lt;a href=&quot;https://issues.apache.org/jira/browse/VFS-142&quot; title=&quot;Clear ThreadData after all streams are closed, fixes a memory leak&quot; class=&quot;issue-link&quot; data-issue-key=&quot;VFS-142&quot;&gt;&lt;del&gt;VFS-142&lt;/del&gt;&lt;/a&gt; there are two problems. One is leaking when you close the file content, this is fixed by the (attached and commited) patch. However the other problem is, that even when all streams are closed, the FileContentThreadData is not removed (there has been a patch but it seems to be not fully commited to VFS2).&lt;/p&gt;

&lt;p&gt;I suggest closing &lt;a href=&quot;https://issues.apache.org/jira/browse/VFS-142&quot; title=&quot;Clear ThreadData after all streams are closed, fixes a memory leak&quot; class=&quot;issue-link&quot; data-issue-key=&quot;VFS-142&quot;&gt;&lt;del&gt;VFS-142&lt;/del&gt;&lt;/a&gt; to document the setNull()-&amp;gt;remove() fix and keep this bug about the need (and impossibility in some cases) for closing FileContent.&lt;/p&gt;</comment>
                            <comment id="14231761" author="b.eckenfels" created="Tue, 2 Dec 2014 17:16:36 +0000"  >&lt;p&gt;This close-on-close.patch does deal wit removing ThreadLocalState when only (all) streams are closed but not Filecontent.close(). It also reduces generation of new threadlocals a bit and synchronizes state changes. It also makes sure the FileContent.close() always tries to close all streams before reporting an error. What do you think?&lt;/p&gt;</comment>
                            <comment id="14232713" author="b.eckenfels" created="Wed, 3 Dec 2014 07:29:31 +0000"  >&lt;p&gt;Ah, need to provide a new version. This uses synchronized on the threadlocal creation for no good reason, it cannot be concurrent by definition.&lt;/p&gt;</comment>
                            <comment id="14233020" author="b.eckenfels" created="Wed, 3 Dec 2014 14:11:59 +0000"  >&lt;p&gt;So, this (close-on-close_v02.patch) is the patch I plan to commit. Any comments?&lt;/p&gt;</comment>
                            <comment id="14242703" author="b.eckenfels" created="Thu, 11 Dec 2014 15:44:05 +0000"  >&lt;p&gt;Commited Fix with &lt;a href=&quot;http://svn.apache.org/r1644682&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1644682&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15022182" author="carl krick" created="Mon, 23 Nov 2015 14:45:11 +0000"  >&lt;p&gt;Hello,&lt;br/&gt;
Do we know when this is going to be released?&lt;/p&gt;

&lt;p&gt;Regards&lt;/p&gt;</comment>
                            <comment id="15291783" author="b.eckenfels" created="Thu, 19 May 2016 18:25:58 +0000"  >&lt;p&gt;Apache Commons VFS 2.1 has been released. It includes this (total 171) resolved issues.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12369265">VFS-142</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12684900" name="close-on-close_v02.patch" size="10641" author="b.eckenfels" created="Wed, 3 Dec 2014 14:11:59 +0000"/>
                            <attachment id="12681997" name="threadlocal_setNull_vs_remove_bug.patch" size="493" author="Golion" created="Mon, 17 Nov 2014 21:33:12 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>200351</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 26 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i14pw7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>235660</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>