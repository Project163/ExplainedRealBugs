<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 22:14:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[VFS-298] FTP: Exception is thrown when renaming a file</title>
                <link>https://issues.apache.org/jira/browse/VFS-298</link>
                <project id="12310495" key="VFS">Commons VFS</project>
                    <description>&lt;p&gt;java.lang.UnsupportedOperationException&lt;br/&gt;
	at java.util.Collections$UnmodifiableMap.remove(Collections.java:1289)&lt;br/&gt;
	at org.apache.commons.vfs.provider.ftp.FtpFileObject.onChildrenChanged(FtpFileObject.java:288)&lt;br/&gt;
	at org.apache.commons.vfs.provider.AbstractFileObject.childrenChanged(AbstractFileObject.java:1612)&lt;br/&gt;
	at org.apache.commons.vfs.provider.AbstractFileObject.notifyParent(AbstractFileObject.java:1633)&lt;br/&gt;
	at org.apache.commons.vfs.provider.AbstractFileObject.handleDelete(AbstractFileObject.java:1558)&lt;br/&gt;
	at org.apache.commons.vfs.provider.AbstractFileObject.moveTo(AbstractFileObject.java:1078)&lt;/p&gt;

&lt;p&gt;FtpFileObject.children may be an EMPTY_FTP_FILE_MAP if the last ls() returned empty collection. This is the case for the move untitled36/src/com/test/Base.as -&amp;gt; untitled36/src/Base.as:&lt;/p&gt;

&lt;p&gt;&amp;gt; CWD /opt/lampp/htdocs/ftp_root&lt;br/&gt;
250 Directory successfully changed.&lt;br/&gt;
&amp;gt; RNFR untitled36/src/com/test/Base.as&lt;br/&gt;
350 Ready for RNTO.&lt;br/&gt;
&amp;gt; RNTO untitled36/src/Base.as&lt;br/&gt;
250 Rename successful.&lt;br/&gt;
&amp;gt; PWD&lt;br/&gt;
257 &quot;/opt/lampp/htdocs/ftp_root&quot;&lt;br/&gt;
&amp;gt; CWD untitled36/src/com/test&lt;br/&gt;
250 Directory successfully changed.&lt;br/&gt;
&amp;gt; PORT 192,168,0,112,51,217&lt;br/&gt;
200 PORT command successful. Consider using PASV.&lt;br/&gt;
&amp;gt; LIST&lt;br/&gt;
150 Here comes the directory listing.&lt;br/&gt;
226 Directory send OK.&lt;/p&gt;

&lt;p&gt;(LIST returned no children)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12455187">VFS-298</key>
            <summary>FTP: Exception is thrown when renaming a file</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="ksafonov">Kirill Safonov</reporter>
                        <labels>
                            <label>PatchAvailable</label>
                    </labels>
                <created>Wed, 3 Feb 2010 16:42:00 +0000</created>
                <updated>Sat, 31 Oct 2020 20:08:53 +0000</updated>
                                            <version>Nightly Builds</version>
                                                        <due></due>
                            <votes>1</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13276952" author="garydgregory" created="Wed, 16 May 2012 18:09:42 +0000"  >&lt;p&gt;Can you still reproduce this with the trunk version? See also org.apache.commons.vfs2.test.ProviderRenameTests.testRenameFileAndLeaveFolderEmpty()&lt;/p&gt;</comment>
                            <comment id="13990251" author="woon_san" created="Tue, 6 May 2014 03:47:13 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=garydgregory&quot; class=&quot;user-hover&quot; rel=&quot;garydgregory&quot;&gt;garydgregory&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;I have reproducible code from my application unit test:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testFtpUnsupportedOperationException() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        &lt;span class=&quot;code-comment&quot;&gt;// testRoot is a FileObject resolved @Before from something like ftp://username:password@localhost/pub/testRoot.
&lt;/span&gt;        FileObject file1 = fileSystemManager.resolveFile(testRoot, &lt;span class=&quot;code-quote&quot;&gt;&quot;sub1/sub2/file1.dat&quot;&lt;/span&gt;);
        file1.createFile();
        FileObject file2 = fileSystemManager.resolveFile(testRoot, &lt;span class=&quot;code-quote&quot;&gt;&quot;sub3/sub4/file2.dat&quot;&lt;/span&gt;);
        file2.getParent().createFolder();
        &lt;span class=&quot;code-comment&quot;&gt;// NOTE: file1 should be re-resolved to reproduce &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; problem.
&lt;/span&gt;        file1 = fileSystemManager.resolveFile(testRoot, &lt;span class=&quot;code-quote&quot;&gt;&quot;sub1/sub2/file1.dat&quot;&lt;/span&gt;);
        file1.moveTo(file2);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then I see the following exception:&lt;/p&gt;

&lt;p&gt;java.lang.UnsupportedOperationException&lt;br/&gt;
	at java.util.Collections$UnmodifiableMap.remove(Collections.java:1286)&lt;br/&gt;
	at org.apache.commons.vfs2.provider.ftp.FtpFileObject.onChildrenChanged(FtpFileObject.java:271)&lt;br/&gt;
	at org.apache.commons.vfs2.provider.AbstractFileObject.childrenChanged(AbstractFileObject.java:240)&lt;br/&gt;
	at org.apache.commons.vfs2.provider.AbstractFileObject.notifyParent(AbstractFileObject.java:1931)&lt;br/&gt;
	at org.apache.commons.vfs2.provider.AbstractFileObject.handleCreate(AbstractFileObject.java:1577)&lt;br/&gt;
	at org.apache.commons.vfs2.provider.AbstractFileObject.moveTo(AbstractFileObject.java:1866)&lt;br/&gt;
...&lt;/p&gt;

&lt;p&gt;When re-resolved, the parent folder such as sub1 and sub2 seem to be imaginary files and so its children member seems unmodifiable. So, removing from unmodifiable children after notification seems to fail.&lt;/p&gt;

&lt;p&gt;Could you take look into it?&lt;/p&gt;

&lt;p&gt;Thanks in advance,&lt;/p&gt;

&lt;p&gt;Woonsan&lt;/p&gt;</comment>
                            <comment id="13990622" author="garydgregory" created="Tue, 6 May 2014 13:17:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=woon_san&quot; class=&quot;user-hover&quot; rel=&quot;woon_san&quot;&gt;woon_san&lt;/a&gt; Thank you for your test case. I cannot take a look ATM, sorry. &lt;/p&gt;

&lt;p&gt;Note that we have a couple other contributors gearing up for a 2.1 release, so providing a patch would help tremendously insuring this gets looked at for 2.1&lt;/p&gt;

&lt;p&gt;Gary&lt;/p&gt;</comment>
                            <comment id="13992329" author="woon_san" created="Wed, 7 May 2014 22:59:01 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;I&apos;m attaching a patch (reproducible test and fix). Please find &lt;a href=&quot;https://issues.apache.org/jira/browse/VFS-298&quot; title=&quot;FTP: Exception is thrown when renaming a file&quot; class=&quot;issue-link&quot; data-issue-key=&quot;VFS-298&quot;&gt;VFS-298&lt;/a&gt;-patch.txt and take reviews.&lt;/p&gt;

&lt;p&gt;Here&apos;s a summary of the problem:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;FtpFileObject maintains a children cache which is initially null, but retrieved from FTP server only when needed.&lt;/li&gt;
	&lt;li&gt;So, let&apos;s suppose you have a FtpFileObject as folder (e.g, /folder1) and a FtpFileObject as a child file (e.g, /folder1/file1.dat). In this case, if you move the file (the latter FtpFileObject) to somewhere else without changing the parent/child object relationship (e.g, without resolving the folder and file object again from the paths), then because the folder object already has a non-zero-sized children cache, there&apos;s no problem when removing the child file from the folder&apos;s children cache.&lt;/li&gt;
	&lt;li&gt;But, if you resolve the source file again from the path, then the parent folder(s) are also resolved again, but in this case, there&apos;s no children cache in the newly resolved folder object. So, when needed (e.g, #getType() invocation), the children will be retrieved again from the FTP server to fill the children cache.&lt;/li&gt;
	&lt;li&gt;The problem is that, as shown in the stack trace below, FtpFileObject could have an event handler implementation (e.g, #onChildrenChanged()) which wants to make it sure the child file cache removed. But, at this point, the parent folder doesn&apos;t have children cache, but it tries to retrieve children again from the server, resulting an unmodifiable/empty children cache map, which happens just after removing the file in that folder!&lt;br/&gt;
Therefore, it can throw UnsupportedOperationException on unmodifiable empty children cache map.&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;$ mvn -Pftp clean test -Dtest=FtpProviderTestCase
...

testRenameFileAndLeaveFolderEmpty(org.apache.commons.vfs2.test.ProviderRenameTests)  Time elapsed: 0.042 sec  &amp;lt;&amp;lt;&amp;lt; ERROR!
java.lang.UnsupportedOperationException: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
	at java.util.Collections$UnmodifiableMap.remove(Collections.java:1286)
	at org.apache.commons.vfs2.provider.ftp.FtpFileObject.onChildrenChanged(FtpFileObject.java:272)
	at org.apache.commons.vfs2.provider.AbstractFileObject.childrenChanged(AbstractFileObject.java:240)
	at org.apache.commons.vfs2.provider.AbstractFileObject.notifyParent(AbstractFileObject.java:1931)
	at org.apache.commons.vfs2.provider.AbstractFileObject.handleCreate(AbstractFileObject.java:1577)
	at org.apache.commons.vfs2.provider.AbstractFileObject.moveTo(AbstractFileObject.java:1866)
	at org.apache.commons.vfs2.test.ProviderRenameTests.testRenameFileAndLeaveFolderEmpty(ProviderRenameTests.java:146)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So, solution is simple. Because it&apos;s just a children cache, you can simply ignore removing a child object if the children cache is just empty.&lt;/p&gt;

&lt;p&gt;Please review the patch.&lt;/p&gt;

&lt;p&gt;Cheers,&lt;/p&gt;

&lt;p&gt;Woonsan&lt;/p&gt;</comment>
                            <comment id="14494061" author="fiveo" created="Tue, 14 Apr 2015 12:51:30 +0000"  >&lt;p&gt;Patch and Testcase is provided. Please commit this to the trunk and resolve the issue.&lt;/p&gt;</comment>
                            <comment id="14876416" author="simon04" created="Fri, 18 Sep 2015 21:08:45 +0000"  >&lt;p&gt;+1. This patch fixes this one bug and does not change behaviour. Should be easy+safe to apply.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12643870" name="VFS-298-patch.txt" size="3617" author="woon_san" created="Wed, 7 May 2014 22:59:01 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>200342</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 9 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1g8mf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>302990</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>