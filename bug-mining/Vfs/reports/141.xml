<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 22:14:29 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[VFS-142] Clear ThreadData after all streams are closed, fixes a memory leak</title>
                <link>https://issues.apache.org/jira/browse/VFS-142</link>
                <project id="12310495" key="VFS">Commons VFS</project>
                    <description>&lt;p&gt;After all streams are closed in FileContentThreadData, clear the ThreadLocal.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12369265">VFS-142</key>
            <summary>Clear ThreadData after all streams are closed, fixes a memory leak</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="b.eckenfels">Bernd Eckenfels</assignee>
                                    <reporter username="doogie">Adam Heath</reporter>
                        <labels>
                    </labels>
                <created>Mon, 14 May 2007 14:00:11 +0000</created>
                <updated>Wed, 27 Jul 2016 21:04:41 +0000</updated>
                            <resolved>Tue, 18 Nov 2014 04:35:16 +0000</resolved>
                                    <version>1.0</version>
                                    <fixVersion>2.1</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="12495603" author="doogie" created="Mon, 14 May 2007 14:01:11 +0000"  >&lt;p&gt;Against svn 501759.&lt;/p&gt;</comment>
                            <comment id="12495613" author="imario" created="Mon, 14 May 2007 14:13:43 +0000"  >&lt;p&gt;Is it really worth the hassle?&lt;/p&gt;

&lt;p&gt;Having the FileContentThreadData around in an ThreadLocal might not necessarily introduce a memory leak and the object itself is not that big, two array lists and one reference.&lt;/p&gt;</comment>
                            <comment id="12495724" author="doogie" created="Mon, 14 May 2007 18:44:25 +0000"  >&lt;p&gt;It&apos;s not just the object itself, but everything it references.  It references DefaultFileContent, which references AbstractFileObject, which references AbstractFileSystem.  Then, if you have layered file systems, DelegateFileObject comes into play, which has it&apos;s own references.&lt;/p&gt;

&lt;p&gt;I&apos;ve got several layered file system implementations(one, that stores attributes as foo@/attr-name, and another, that implements COW(copy-on-write); yet another that does &lt;b&gt;proper&lt;/b&gt; virtual mounts, meaning nested).&lt;/p&gt;

&lt;p&gt;When the top-level file is a DelegateFileObject, from VirtualFileSystem, the whole chain of references underneath it gets very large.&lt;/p&gt;

&lt;p&gt;I spent a great deal of time just a week ago chasing down memory usage.  This was a fairly large segment of memory freed up by this.  Most of the memory issues I ended up fixing were in commons-vfs; most were looped references being held in static fields(ThreadLocal is a global static field, so always maintains it&apos;s references).&lt;/p&gt;</comment>
                            <comment id="13977315" author="golion" created="Tue, 22 Apr 2014 20:07:20 +0000"  >&lt;p&gt;ThreadLocal actually stores it&apos;s data in the Thread itself, I don&apos;t think your patch covers the whole problem.  Even when the ThreadLocal content is set to null it may not remove the reference in the Thread.&lt;/p&gt;</comment>
                            <comment id="13993082" author="golion" created="Thu, 8 May 2014 20:40:05 +0000"  >&lt;p&gt;Just to add to what Adam is saying; over here in my group&apos;s environment we are currently using vfs in dropwizard app (uses thread pool for connections so the threads stick around basically forever) to access a filesystem which (for various technical reasons) is several levels deep and has potentially thousands of subdirs and/or files under each dir in the tree, so every leaked filesystem in our case leaves well over 100MB of unrecoverable memory linked to nothing but the thread.&lt;/p&gt;

&lt;p&gt;With potentially each filesystem leaked multiple times in every pooled thread what this means, in practice (ie. our production environment), is this leak eats up about 4GB of server memory at least twice a week, which is very annoying.&lt;/p&gt;

&lt;p&gt;We&apos;re currently working around the problem by threading all our file operations, but this is very undesirable and we don&apos;t want to keep this workaround in production for long.&lt;/p&gt;</comment>
                            <comment id="13998149" author="doogie" created="Wed, 14 May 2014 22:25:19 +0000"  >&lt;p&gt;Our current deployment application does not make use of commons-vfs anymore; we now use more off-the-shelf(but still opensource) tools, and don&apos;t maintain as much internal forks of software as we used to.&lt;/p&gt;

&lt;p&gt;After this original bug was filed, I kept finding more and more issues running commons-vfs in a long-running server environment; from memory, including, but not limited to:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;long running thread pools(as you mention)&lt;/li&gt;
	&lt;li&gt;when nearly out of memory, the app server calls into vfs to read a file, the vfs extensions we wrote then need to parse xml, this then attempts to load a class(which was loaded previously, but was thrown away due to the OOM that will happen shortly), which then calls into a classloader, which is also backed by the very same top-level vfs instance; deadlock ensues.  This is really more of a bug in java.lang.Classloader.loadClass, because it is synchronized.&lt;/li&gt;
	&lt;li&gt;much use of synchronized in the code base&lt;/li&gt;
	&lt;li&gt;not a bug per se, but an ugliness; at the time, there was no generics in the api.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Due to these, and other issues, I basically ended up just using the vfs interfaces, and none of the base support classes.  All were rewritten, including the Manager.  Final result was generics, no synchronized(uses java.util.concurrent(aka non-blocking), no dead locks, and no mem-leaks.&lt;/p&gt;

&lt;p&gt;Btw, the primary filesystem implementation we had was an &apos;overlay&apos;, which is similar to linux union; directories could overlay other directories, getChildren() would be merge, it had support for whiteouts.  There was also support for mount-points at any level.  The metadata for whiteouts was stored as xml as .cowstate.xml(the original name was COWFileSystem, for copy-on-write).  We used this to have a large, shared BASE, with multiple overlayed CHILDREN.  If a child modified a file, the base was up-copied.&lt;/p&gt;

&lt;p&gt;There was also a &apos;FlatAttribute&apos; file system; getAttribute(name) was mapped to &apos;file/path@/name&apos;; this made storing metadata for vfs files easy, and integrated well with svn and git revision control. &lt;/p&gt;</comment>
                            <comment id="13998429" author="doogie" created="Thu, 15 May 2014 04:14:37 +0000"  >&lt;p&gt;Our current deployment application does not make use of commons-vfs &lt;br/&gt;
anymore; we now use more off-the-shelf(but still opensource) tools, and &lt;br/&gt;
don&apos;t maintain as much internal forks of software as we used to.&lt;/p&gt;

&lt;p&gt;After this original bug was filed, I kept finding more and more issues &lt;br/&gt;
running commons-vfs in a long-running server environment; from memory, &lt;br/&gt;
including, but not limited to:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;long running thread pools(as you mention)&lt;/li&gt;
	&lt;li&gt;when nearly out of memory, the app server calls into vfs to read a&lt;br/&gt;
file, the vfs extensions we wrote then need to parse xml, this then &lt;br/&gt;
attempts to load a class(which was loaded previously, but was thrown &lt;br/&gt;
away due to the OOM that will happen shortly), which then calls into a &lt;br/&gt;
classloader, which is also backed by the very same top-level vfs &lt;br/&gt;
instance; deadlock ensues.  This is really more of a bug in &lt;br/&gt;
java.lang.Classloader.loadClass, because it is synchronized.&lt;/li&gt;
	&lt;li&gt;much use of synchronized in the code base&lt;/li&gt;
	&lt;li&gt;not a bug per se, but an ugliness; at the time, there was no generics&lt;br/&gt;
in the api.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Due to these, and other issues, I basically ended up just using the vfs &lt;br/&gt;
interfaces, and none of the base support classes.  All were rewritten, &lt;br/&gt;
including the Manager.  Final result was generics, no synchronized(uses &lt;br/&gt;
java.util.concurrent(aka non-blocking), no dead locks, and no mem-leaks.&lt;/p&gt;

&lt;p&gt;Btw, the primary filesystem implementation we had was an &apos;overlay&apos;, &lt;br/&gt;
which is similar to linux union; directories could overlay other &lt;br/&gt;
directories, getChildren() would be merge, it had support for &lt;br/&gt;
whiteouts.  There was also support for mount-points at any level.  The &lt;br/&gt;
metadata for whiteouts was stored as xml as .cowstate.xml(the original &lt;br/&gt;
name was COWFileSystem, for copy-on-write).  We used this to have a &lt;br/&gt;
large, shared BASE, with multiple overlayed CHILDREN.  If a child &lt;br/&gt;
modified a file, the base was up-copied.&lt;/p&gt;

&lt;p&gt;There was also a &apos;FlatAttribute&apos; file system; getAttribute(name) was &lt;br/&gt;
mapped to &apos;file/path@/name&apos;; this made storing metadata for vfs files &lt;br/&gt;
easy, and integrated well with svn and git revision control.&lt;/p&gt;

</comment>
                            <comment id="13998741" author="garydgregory" created="Thu, 15 May 2014 13:01:00 +0000"  >&lt;p&gt;This is all quite alarming. &lt;/p&gt;

&lt;p&gt;Which behavior can be attributed to the 2.0 and trunk version of the code?&lt;/p&gt;</comment>
                            <comment id="14215211" author="golion" created="Mon, 17 Nov 2014 21:30:33 +0000"  >&lt;p&gt;Here&apos;s a patch against a fresh checkout for what I was talking about.&lt;/p&gt;</comment>
                            <comment id="14215249" author="b.eckenfels" created="Mon, 17 Nov 2014 21:51:15 +0000"  >&lt;p&gt;Hm, I don&apos;t see really a difference. Both methods will clean the value and keep the key (ThreadLocal instance) (weakly references). The Key does not contain references to VFS objects. In fact remove() seems to be a bit more efficient as it would not create the ma or insert the key if not present (anymore).&lt;/p&gt;</comment>
                            <comment id="14215263" author="b.eckenfels" created="Mon, 17 Nov 2014 21:56:41 +0000"  >&lt;p&gt;Ah stupid me... I reverse-read the patch. Yes remove is better than set &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; (But I don&apos;t think it explains a leak).&lt;/p&gt;

&lt;p&gt;Will commit it. But I need to check if this actually fixes the bug - especially when FileContent.close() is not directly called.&lt;/p&gt;</comment>
                            <comment id="14215295" author="b.eckenfels" created="Mon, 17 Nov 2014 22:20:58 +0000"  >&lt;p&gt;Commited &lt;a href=&quot;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=r1640242&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?view=revision&amp;amp;revision=r1640242&lt;/a&gt;&lt;br/&gt;
But I keep the bug open till I had a look at heapdumps.&lt;/p&gt;</comment>
                            <comment id="14215698" author="b.eckenfels" created="Tue, 18 Nov 2014 04:35:16 +0000"  >&lt;p&gt;Ok tested it: with remove() there is a leak of FileContentThreadData objects avoided (when fo.close() or fc.close() is used). However there is still a leak if one uses any of the streams and closes them all, but does not close fileObject or fileContent. Since i commited this change with this ID I will close it as fixed and keep &lt;a href=&quot;https://issues.apache.org/jira/browse/VFS-309&quot; title=&quot;ThreadLocal memory leak in DefaultFileContent&quot; class=&quot;issue-link&quot; data-issue-key=&quot;VFS-309&quot;&gt;&lt;del&gt;VFS-309&lt;/del&gt;&lt;/a&gt; open.&lt;/p&gt;</comment>
                            <comment id="14216796" author="golion" created="Tue, 18 Nov 2014 21:14:46 +0000"  >&lt;p&gt;I see, in our case we are explicitly closing all the FileContent instances so this fix should work for us, thanks!&lt;/p&gt;</comment>
                            <comment id="15291865" author="b.eckenfels" created="Thu, 19 May 2016 18:26:27 +0000"  >&lt;p&gt;Apache Commons VFS 2.1 has been released. It includes this (total 171) resolved issues.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12465113">VFS-309</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12357264" name="fix_ThreadData-clear.patch" size="2465" author="doogie" created="Mon, 14 May 2007 14:01:05 +0000"/>
                            <attachment id="12681995" name="threadlocal_setNull_vs_remove_bug.patch" size="493" author="Golion" created="Mon, 17 Nov 2014 21:30:33 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>200201</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 26 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i14qkn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>235770</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>