{"url":"https://api.github.com/repos/tokio-rs/axum/issues/859","repository_url":"https://api.github.com/repos/tokio-rs/axum","labels_url":"https://api.github.com/repos/tokio-rs/axum/issues/859/labels{/name}","comments_url":"https://api.github.com/repos/tokio-rs/axum/issues/859/comments","events_url":"https://api.github.com/repos/tokio-rs/axum/issues/859/events","html_url":"https://github.com/tokio-rs/axum/issues/859","id":1168792875,"node_id":"I_kwDOFi7l3s5Fql0r","number":859,"title":"`Router::into_make_service_with_connect_info()` has unnecessary `Target` parameter that can fail to be inferred","user":{"login":"lilyball","id":714,"node_id":"MDQ6VXNlcjcxNA==","avatar_url":"https://avatars.githubusercontent.com/u/714?v=4","gravatar_id":"","url":"https://api.github.com/users/lilyball","html_url":"https://github.com/lilyball","followers_url":"https://api.github.com/users/lilyball/followers","following_url":"https://api.github.com/users/lilyball/following{/other_user}","gists_url":"https://api.github.com/users/lilyball/gists{/gist_id}","starred_url":"https://api.github.com/users/lilyball/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lilyball/subscriptions","organizations_url":"https://api.github.com/users/lilyball/orgs","repos_url":"https://api.github.com/users/lilyball/repos","events_url":"https://api.github.com/users/lilyball/events{/privacy}","received_events_url":"https://api.github.com/users/lilyball/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":3217112765,"node_id":"MDU6TGFiZWwzMjE3MTEyNzY1","url":"https://api.github.com/repos/tokio-rs/axum/labels/S-waiting-on-author","name":"S-waiting-on-author","color":"d3dddd","default":false,"description":"Status: awaiting some action (such as code changes) from the PR or issue author."},{"id":3548183885,"node_id":"LA_kwDOFi7l3s7TfP1N","url":"https://api.github.com/repos/tokio-rs/axum/labels/A-axum","name":"A-axum","color":"ffdc1c","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/tokio-rs/axum/milestones/4","html_url":"https://github.com/tokio-rs/axum/milestone/4","labels_url":"https://api.github.com/repos/tokio-rs/axum/milestones/4/labels","id":7491929,"node_id":"MI_kwDOFi7l3s4AclFZ","number":4,"title":"0.5","description":"Next breaking release. ","creator":{"login":"davidpdrsn","id":718941,"node_id":"MDQ6VXNlcjcxODk0MQ==","avatar_url":"https://avatars.githubusercontent.com/u/718941?v=4","gravatar_id":"","url":"https://api.github.com/users/davidpdrsn","html_url":"https://github.com/davidpdrsn","followers_url":"https://api.github.com/users/davidpdrsn/followers","following_url":"https://api.github.com/users/davidpdrsn/following{/other_user}","gists_url":"https://api.github.com/users/davidpdrsn/gists{/gist_id}","starred_url":"https://api.github.com/users/davidpdrsn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davidpdrsn/subscriptions","organizations_url":"https://api.github.com/users/davidpdrsn/orgs","repos_url":"https://api.github.com/users/davidpdrsn/repos","events_url":"https://api.github.com/users/davidpdrsn/events{/privacy}","received_events_url":"https://api.github.com/users/davidpdrsn/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":22,"state":"closed","created_at":"2021-12-15T20:24:31Z","updated_at":"2022-03-31T19:35:14Z","due_on":null,"closed_at":"2022-03-31T19:35:14Z"},"comments":3,"created_at":"2022-03-14T19:08:40Z","updated_at":"2022-04-11T22:46:55Z","closed_at":"2022-03-31T16:49:49Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Bug Report\r\n\r\n### Version\r\n\r\naxum 0.4.8\r\n\r\n### Crates\r\n\r\naxum\r\n\r\n### Description\r\n\r\n[`Router::into_make_service_with_connect_info()`](https://docs.rs/axum/0.4.8/axum/struct.Router.html#method.into_make_service_with_connect_info)[^1] has a method signature\r\n\r\n[^1]: Also [`Handler::into_make_service_with_connect_info()`](https://docs.rs/axum/0.4.8/axum/handler/trait.Handler.html#method.into_make_service_with_connect_info). I will only focus on `Router` here though.\r\n\r\n```rust\r\npub fn into_make_service_with_connect_info<C, Target>(\r\n    self\r\n) -> IntoMakeServiceWithConnectInfo<Self, C>\r\nwhere\r\n    C: Connected<Target>\r\n```\r\n\r\nThe `Target` parameter here only serves to ensure that `C` implements some `Connected<Target>`. From the sample in that docs, expected usage looks like\r\n\r\n```rust\r\napp.into_make_service_with_connect_info::<SocketAddr, _>()\r\n```\r\n\r\nThe problem is, the second parameter can only be omitted if the `C` type only implements `Connected` for one single connection type. As soon as you have one `C` that implements `Connected` for multiple targets, that parameter needs to be specified explicitly. This is very annoying.\r\n\r\nIt's also unnecessary. [`IntoMakeServiceWithConnectInfo`](https://docs.rs/axum/0.4.8/axum/extract/connect_info/struct.IntoMakeServiceWithConnectInfo.html#) already only implements `Service<T> where C: Connected<T>`. Which means the bound on `into_make_service_with_connect_info()` isn't necessary for correctness. It probably does produce a better error message when the wrong type is used, but having to write out the connection type is frustrating, especially since I can write the wrong connection type on that method and it will still compile as long as my `C` type still implements `Connected` for the correct connection (i.e. I can write `app.into_make_service_with_connect_info::<SocketAddr, &'_ AddrStream>()` even though I'm using a different custom stream type for my actual server as long as `SocketAddr: Connected<&'_ MyCustomStream>`).\r\n\r\nI'm not really sure why this bound exists here. axum generally defers bounds until the point at which they're absolutely necessary, it's usually possible to construct a type with the wrong parameters only to have it fail to implement the right trait as a result, so it's surprising to me that `into_make_service_with_connect_info()` bothers with this bound.\r\n\r\n#### Proposed solution\r\n\r\nRemove the `C: Connected<Target>` bound on `into_make_service_with_connect_info()`. The resulting type will still enforce this bound on its `Service` impl. The type parameter has to go as well. Unfortunately it looks like Rust doesn't allow defaulted type parameters on methods (?!?) so we can't just leave it unused with a default, which does mean this is backwards-incompatible.\r\n\r\n#### Alternative solution\r\n\r\nAdd the `Target` parameter as an actual parameter of `IntoMakeServiceWithConnectInfo` and only implement `Service` in terms of that instead of making it generic. This way the call to `Server::serve(app)` will infer that type parameter if it's otherwise ambiguous. The downside is now the same `IntoMakeServiceWithConnectInfo` can no longer be used with different connection types. It's also backwards-incompatible so I don't think there's any benefit to this approach.","closed_by":{"login":"davidpdrsn","id":718941,"node_id":"MDQ6VXNlcjcxODk0MQ==","avatar_url":"https://avatars.githubusercontent.com/u/718941?v=4","gravatar_id":"","url":"https://api.github.com/users/davidpdrsn","html_url":"https://github.com/davidpdrsn","followers_url":"https://api.github.com/users/davidpdrsn/followers","following_url":"https://api.github.com/users/davidpdrsn/following{/other_user}","gists_url":"https://api.github.com/users/davidpdrsn/gists{/gist_id}","starred_url":"https://api.github.com/users/davidpdrsn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davidpdrsn/subscriptions","organizations_url":"https://api.github.com/users/davidpdrsn/orgs","repos_url":"https://api.github.com/users/davidpdrsn/repos","events_url":"https://api.github.com/users/davidpdrsn/events{/privacy}","received_events_url":"https://api.github.com/users/davidpdrsn/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/tokio-rs/axum/issues/859/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/tokio-rs/axum/issues/859/timeline","performed_via_github_app":null,"state_reason":"completed"}