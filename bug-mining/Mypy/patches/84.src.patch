diff --git a/mypy/plugins/dataclasses.py b/mypy/plugins/dataclasses.py
index 6d78bc17e..e3daec589 100644
--- a/mypy/plugins/dataclasses.py
+++ b/mypy/plugins/dataclasses.py
@@ -221,9 +221,12 @@ class DataclassTransformer:
                 self._ctx.reason,
             )
             return
-        if info.slots is not None or info.names.get('__slots__'):
+
+        generated_slots = {attr.name for attr in attributes}
+        if ((info.slots is not None and info.slots != generated_slots)
+                or info.names.get('__slots__')):
             # This means we have a slots conflict.
-            # Class explicitly specifies `__slots__` field.
+            # Class explicitly specifies a different `__slots__` field.
             # And `@dataclass(slots=True)` is used.
             # In runtime this raises a type error.
             self._ctx.api.fail(
@@ -234,7 +237,7 @@ class DataclassTransformer:
             )
             return
 
-        info.slots = {attr.name for attr in attributes}
+        info.slots = generated_slots
 
     def reset_init_only_vars(self, info: TypeInfo, attributes: List[DataclassAttribute]) -> None:
         """Remove init-only vars from the class and reset init var declarations."""
diff --git a/test-data/unit/check-dataclasses.test b/test-data/unit/check-dataclasses.test
index 73476a646..80e5f81e1 100644
--- a/test-data/unit/check-dataclasses.test
+++ b/test-data/unit/check-dataclasses.test
@@ -1456,3 +1456,69 @@ class Other:
     __slots__ = ('x',)
     x: int
 [builtins fixtures/dataclasses.pyi]
+
+
+[case testSlotsDefinitionWithTwoPasses1]
+# flags: --python-version 3.10
+# https://github.com/python/mypy/issues/11821
+from typing import TypeVar, Protocol, Generic
+from dataclasses import dataclass
+
+C = TypeVar("C", bound="Comparable")
+
+class Comparable(Protocol):
+    pass
+
+V = TypeVar("V", bound=Comparable)
+
+@dataclass(slots=True)
+class Node(Generic[V]):  # Error was here
+    data: V
+[builtins fixtures/dataclasses.pyi]
+
+[case testSlotsDefinitionWithTwoPasses2]
+# flags: --python-version 3.10
+from typing import TypeVar, Protocol, Generic
+from dataclasses import dataclass
+
+C = TypeVar("C", bound="Comparable")
+
+class Comparable(Protocol):
+    pass
+
+V = TypeVar("V", bound=Comparable)
+
+@dataclass(slots=True)  # Explicit slots are still not ok:
+class Node(Generic[V]):  # E: "Node" both defines "__slots__" and is used with "slots=True"
+    __slots__ = ('data',)
+    data: V
+[builtins fixtures/dataclasses.pyi]
+
+[case testSlotsDefinitionWithTwoPasses3]
+# flags: --python-version 3.10
+from typing import TypeVar, Protocol, Generic
+from dataclasses import dataclass
+
+C = TypeVar("C", bound="Comparable")
+
+class Comparable(Protocol):
+    pass
+
+V = TypeVar("V", bound=Comparable)
+
+@dataclass(slots=True)  # Explicit slots are still not ok, even empty ones:
+class Node(Generic[V]):  # E: "Node" both defines "__slots__" and is used with "slots=True"
+    __slots__ = ()
+    data: V
+[builtins fixtures/dataclasses.pyi]
+
+[case testSlotsDefinitionWithTwoPasses4]
+# flags: --python-version 3.10
+import dataclasses as dtc
+
+PublishedMessagesVar = dict[int, 'PublishedMessages']
+
+@dtc.dataclass(frozen=True, slots=True)
+class PublishedMessages:
+    left: int
+[builtins fixtures/dataclasses.pyi]
