{"url":"https://api.github.com/repos/python/mypy/issues/14250","repository_url":"https://api.github.com/repos/python/mypy","labels_url":"https://api.github.com/repos/python/mypy/issues/14250/labels{/name}","comments_url":"https://api.github.com/repos/python/mypy/issues/14250/comments","events_url":"https://api.github.com/repos/python/mypy/issues/14250/events","html_url":"https://github.com/python/mypy/issues/14250","id":1474889095,"node_id":"I_kwDOAGuhRc5X6QWH","number":14250,"title":"Crash on nested unpacking of next() call","user":{"login":"hamdanal","id":93259987,"node_id":"U_kgDOBY8I0w","avatar_url":"https://avatars.githubusercontent.com/u/93259987?v=4","gravatar_id":"","url":"https://api.github.com/users/hamdanal","html_url":"https://github.com/hamdanal","followers_url":"https://api.github.com/users/hamdanal/followers","following_url":"https://api.github.com/users/hamdanal/following{/other_user}","gists_url":"https://api.github.com/users/hamdanal/gists{/gist_id}","starred_url":"https://api.github.com/users/hamdanal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hamdanal/subscriptions","organizations_url":"https://api.github.com/users/hamdanal/orgs","repos_url":"https://api.github.com/users/hamdanal/repos","events_url":"https://api.github.com/users/hamdanal/events{/privacy}","received_events_url":"https://api.github.com/users/hamdanal/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":379446833,"node_id":"MDU6TGFiZWwzNzk0NDY4MzM=","url":"https://api.github.com/repos/python/mypy/labels/crash","name":"crash","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-12-04T14:53:59Z","updated_at":"2023-02-08T01:11:35Z","closed_at":"2023-02-08T01:11:35Z","author_association":"COLLABORATOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"<!--\r\n  Use this form only if mypy reports an \"INTERNAL ERROR\" and/or gives a traceback.\r\n  Please include the traceback and all other messages below (use `mypy --show-traceback`).\r\n-->\r\n\r\n**Crash Report**\r\n\r\nMypy crashes with the following traceback. Small reproducer below. Tested with version 0.991 (compiled) and mypy master (not compiled).\r\n\r\n**Traceback**\r\n\r\n```\r\n$ mypy --show-traceback t.py\r\nt.py:3: error: INTERNAL ERROR -- Please try using mypy master on GitHub:\r\nhttps://mypy.readthedocs.io/en/stable/common_issues.html#using-a-development-mypy-build\r\nPlease report a bug at https://github.com/python/mypy/issues\r\nversion: 1.0.0+dev.b8c03ab6809aab56928f3cd865edb44944a600a2\r\nTraceback (most recent call last):\r\n  File \"/tmp/venv/bin/mypy\", line 8, in <module>\r\n    sys.exit(console_entry())\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/__main__.py\", line 15, in console_entry\r\n    main()\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/main.py\", line 95, in main\r\n    res, messages, blockers = run_build(sources, options, fscache, t0, stdout, stderr)\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/main.py\", line 174, in run_build\r\n    res = build.build(sources, options, None, flush_errors, fscache, stdout, stderr)\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/build.py\", line 194, in build\r\n    result = _build(\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/build.py\", line 277, in _build\r\n    graph = dispatch(sources, manager, stdout)\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/build.py\", line 2914, in dispatch\r\n    process_graph(graph, manager)\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/build.py\", line 3311, in process_graph\r\n    process_stale_scc(graph, scc, manager)\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/build.py\", line 3412, in process_stale_scc\r\n    graph[id].type_check_first_pass()\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/build.py\", line 2317, in type_check_first_pass\r\n    self.type_checker().check_first_pass()\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/checker.py\", line 471, in check_first_pass\r\n    self.accept(d)\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/checker.py\", line 579, in accept\r\n    stmt.accept(self)\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/nodes.py\", line 790, in accept\r\n    return visitor.visit_func_def(self)\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/checker.py\", line 956, in visit_func_def\r\n    self._visit_func_def(defn)\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/checker.py\", line 960, in _visit_func_def\r\n    self.check_func_item(defn, name=defn.name)\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/checker.py\", line 1032, in check_func_item\r\n    self.check_func_def(defn, typ, name, allow_empty)\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/checker.py\", line 1212, in check_func_def\r\n    self.accept(item.body)\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/checker.py\", line 579, in accept\r\n    stmt.accept(self)\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/nodes.py\", line 1202, in accept\r\n    return visitor.visit_block(self)\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/checker.py\", line 2592, in visit_block\r\n    self.accept(s)\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/checker.py\", line 579, in accept\r\n    stmt.accept(self)\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/nodes.py\", line 1289, in accept\r\n    return visitor.visit_assignment_stmt(self)\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/checker.py\", line 2640, in visit_assignment_stmt\r\n    self.check_assignment(s.lvalues[-1], s.rvalue, s.type is None, s.new_syntax)\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/checker.py\", line 2695, in check_assignment\r\n    self.check_assignment_to_multiple_lvalues(\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/checker.py\", line 3349, in check_assignment_to_multiple_lvalues    self.check_multi_assignment(lvalues, rvalue, context, infer_lvalue_type)\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/checker.py\", line 3396, in check_multi_assignment\r\n    self.check_multi_assignment_from_tuple(\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/checker.py\", line 3511, in check_multi_assignment_from_tuple\r\n    self.expr_checker.accept(rvalue, lvalue_type)\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/checkexpr.py\", line 4768, in accept\r\n    typ = node.accept(self)\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/nodes.py\", line 1871, in accept\r\n    return visitor.visit_call_expr(self)\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/checkexpr.py\", line 424, in visit_call_expr\r\n    return self.visit_call_expr_inner(e, allow_none_return=allow_none_return)\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/checkexpr.py\", line 544, in visit_call_expr_inner\r\n    ret_type = self.check_call_expr_with_callee_type(\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/checkexpr.py\", line 1195, in check_call_expr_with_callee_type\r\n    ret_type, callee_type = self.check_call(\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/checkexpr.py\", line 1289, in check_call\r\n    return self.check_overload_call(\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/checkexpr.py\", line 2211, in check_overload_call\r\n    inferred_result = self.infer_overload_return_type(\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/checkexpr.py\", line 2365, in infer_overload_return_type\r\n    ret_type, infer_type = self.check_call(\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/checkexpr.py\", line 1278, in check_call\r\n    return self.check_callable_call(\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/checkexpr.py\", line 1419, in check_callable_call\r\n    callee = self.infer_function_type_arguments_using_context(callee, context)\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/checkexpr.py\", line 1648, in infer_function_type_arguments_using_context\r\n    erased_ctx = replace_meta_vars(ctx, ErasedType())\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/erasetype.py\", line 153, in replace_meta_vars\r\n    return t.accept(TypeVarEraser(lambda id: id.is_meta_var(), target_type))\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/types.py\", line 2205, in accept\r\n    return visitor.visit_tuple_type(self)\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/type_visitor.py\", line 249, in visit_tuple_type\r\n    self.translate_types(t.items),\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/type_visitor.py\", line 276, in translate_types\r\n    return [t.accept(self) for t in types]\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/type_visitor.py\", line 276, in <listcomp>\r\n    return [t.accept(self) for t in types]\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/types.py\", line 2205, in accept\r\n    return visitor.visit_tuple_type(self)\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/type_visitor.py\", line 249, in visit_tuple_type\r\n    self.translate_types(t.items),\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/type_visitor.py\", line 276, in translate_types\r\n    return [t.accept(self) for t in types]\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/type_visitor.py\", line 276, in <listcomp>\r\n    return [t.accept(self) for t in types]\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/types.py\", line 2566, in accept\r\n    assert isinstance(visitor, SyntheticTypeVisitor)\r\nAssertionError:\r\nt.py:3: : note: use --pdb to drop into pdb\r\n```\r\n\r\n**To Reproduce**\r\n\r\n```console\r\n$ cat t.py\r\ndef mypy_crash() -> None:\r\n    d: dict[int, tuple[str, int, str]] = {}\r\n    k, (v1, *_) = next(iter(d.items()))  # <-- mypy crashes here\r\n```\r\n\r\n**Your Environment**\r\n\r\n<!-- Include as many relevant details about the environment you experienced the bug in -->\r\n\r\n- Mypy version used: `mypy 1.0.0+dev.b8c03ab6809aab56928f3cd865edb44944a600a2 (compiled: no)` (installed with `pip install git+https://github.com/python/mypy#master`)\r\n- Mypy command-line flags: `mypy t.py`\r\n- Mypy configuration options from `mypy.ini` (and other config files): None\r\n- Python version used: `Python 3.10.6 (main, Nov  2 2022, 18:53:38) [GCC 11.3.0]`\r\n- Operating system and version:\r\n  - OS: `Ubuntu 22.04.1 LTS on Windows 10 x86_64`\r\n  - Kernel: `5.15.74.2-microsoft-standard-WSL2`\r\n  - Also crashes on Debian Bullseye native (non WSL)\r\n\r\n<!--\r\nYou can freely edit this text, please remove all the lines\r\nyou believe are unnecessary.\r\n-->\r\n","closed_by":{"login":"hauntsaninja","id":12621235,"node_id":"MDQ6VXNlcjEyNjIxMjM1","avatar_url":"https://avatars.githubusercontent.com/u/12621235?v=4","gravatar_id":"","url":"https://api.github.com/users/hauntsaninja","html_url":"https://github.com/hauntsaninja","followers_url":"https://api.github.com/users/hauntsaninja/followers","following_url":"https://api.github.com/users/hauntsaninja/following{/other_user}","gists_url":"https://api.github.com/users/hauntsaninja/gists{/gist_id}","starred_url":"https://api.github.com/users/hauntsaninja/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hauntsaninja/subscriptions","organizations_url":"https://api.github.com/users/hauntsaninja/orgs","repos_url":"https://api.github.com/users/hauntsaninja/repos","events_url":"https://api.github.com/users/hauntsaninja/events{/privacy}","received_events_url":"https://api.github.com/users/hauntsaninja/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/python/mypy/issues/14250/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/python/mypy/issues/14250/timeline","performed_via_github_app":null,"state_reason":"completed"}