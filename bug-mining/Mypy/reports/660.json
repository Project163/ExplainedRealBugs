{"url":"https://api.github.com/repos/python/mypy/issues/20135","repository_url":"https://api.github.com/repos/python/mypy","labels_url":"https://api.github.com/repos/python/mypy/issues/20135/labels{/name}","comments_url":"https://api.github.com/repos/python/mypy/issues/20135/comments","events_url":"https://api.github.com/repos/python/mypy/issues/20135/events","html_url":"https://github.com/python/mypy/issues/20135","id":3561548320,"node_id":"I_kwDOAGuhRc7USOog","number":20135,"title":"Crash on jsonesque recursive type alias (regression 1.17.1 ⟹ 1.18.1)","user":{"login":"randolf-scholz","id":39696536,"node_id":"MDQ6VXNlcjM5Njk2NTM2","avatar_url":"https://avatars.githubusercontent.com/u/39696536?v=4","gravatar_id":"","url":"https://api.github.com/users/randolf-scholz","html_url":"https://github.com/randolf-scholz","followers_url":"https://api.github.com/users/randolf-scholz/followers","following_url":"https://api.github.com/users/randolf-scholz/following{/other_user}","gists_url":"https://api.github.com/users/randolf-scholz/gists{/gist_id}","starred_url":"https://api.github.com/users/randolf-scholz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/randolf-scholz/subscriptions","organizations_url":"https://api.github.com/users/randolf-scholz/orgs","repos_url":"https://api.github.com/users/randolf-scholz/repos","events_url":"https://api.github.com/users/randolf-scholz/events{/privacy}","received_events_url":"https://api.github.com/users/randolf-scholz/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":379446833,"node_id":"MDU6TGFiZWwzNzk0NDY4MzM=","url":"https://api.github.com/repos/python/mypy/labels/crash","name":"crash","color":"b60205","default":false,"description":null},{"id":427181007,"node_id":"MDU6TGFiZWw0MjcxODEwMDc=","url":"https://api.github.com/repos/python/mypy/labels/topic-type-variables","name":"topic-type-variables","color":"0052cc","default":false,"description":null},{"id":3945135234,"node_id":"LA_kwDOAGuhRc7rJfyC","url":"https://api.github.com/repos/python/mypy/labels/topic-type-alias","name":"topic-type-alias","color":"51FABE","default":false,"description":"TypeAlias and other type alias issues"},{"id":7057647935,"node_id":"LA_kwDOAGuhRc8AAAABpKspPw","url":"https://api.github.com/repos/python/mypy/labels/topic-pep-695","name":"topic-pep-695","color":"5BB174","default":false,"description":"Issues related to PEP 695 syntax"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2025-10-28T13:21:17Z","updated_at":"2025-11-05T16:44:55Z","closed_at":"2025-11-05T16:44:55Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"The following example passes on `1.17.1`, but crashes on `1.18.1`, `1.18.2` and `main` (`1.19.0+dev.841db1f7e537b1ac15c8866bec574c04ce125554`) with message `AssertionError: Must not defer during final iteration`\n\n```python\ntype JSON_SCALAR = None | bool | int | float | str\ntype JSON_ARRAY[T: JSON] = list[T]\ntype JSON = JSON_SCALAR | JSON_ARRAY[JSON]\n```\n\n- <https://mypy-play.net/?mypy=1.17.1&python=3.12&gist=baf174591dd1638b5576874281c1ee00>: no issues\n- <https://mypy-play.net/?mypy=1.18.1&python=3.12&gist=fa3ddab26e924915f24c57c190d6a677>: Crash\n- <https://mypy-play.net/?mypy=master&python=3.12&gist=0cac137d39b634f395a3c2c451d80241>: Crash\n\nI tested with python 3.12–3.14.\n\n<details> <summary> Traceback </summary>\n\n```\nTraceback (most recent call last):\n  File \"<frozen runpy>\", line 198, in _run_module_as_main\n  File \"<frozen runpy>\", line 88, in _run_code\n  File \"/layers/google.python.pip/pip/lib/python3.12/site-packages/mypy/__main__.py\", line 37, in <module>\n    console_entry()\n  File \"/layers/google.python.pip/pip/lib/python3.12/site-packages/mypy/__main__.py\", line 15, in console_entry\n    main()\n  File \"/layers/google.python.pip/pip/lib/python3.12/site-packages/mypy/main.py\", line 127, in main\n    res, messages, blockers = run_build(sources, options, fscache, t0, stdout, stderr)\n  File \"/layers/google.python.pip/pip/lib/python3.12/site-packages/mypy/main.py\", line 211, in run_build\n    res = build.build(sources, options, None, flush_errors, fscache, stdout, stderr)\n  File \"/layers/google.python.pip/pip/lib/python3.12/site-packages/mypy/build.py\", line 213, in build\n    result = _build(\n  File \"/layers/google.python.pip/pip/lib/python3.12/site-packages/mypy/build.py\", line 292, in _build\n    graph = dispatch(sources, manager, stdout)\n  File \"/layers/google.python.pip/pip/lib/python3.12/site-packages/mypy/build.py\", line 2931, in dispatch\n    process_graph(graph, manager)\n  File \"/layers/google.python.pip/pip/lib/python3.12/site-packages/mypy/build.py\", line 3322, in process_graph\n    done, still_working = manager.wait_for_done(graph)\n  File \"/layers/google.python.pip/pip/lib/python3.12/site-packages/mypy/build.py\", line 915, in wait_for_done\n    process_stale_scc(graph, next_scc, self)\n  File \"/layers/google.python.pip/pip/lib/python3.12/site-packages/mypy/build.py\", line 3454, in process_stale_scc\n    mypy.semanal_main.semantic_analysis_for_scc(graph, scc, manager.errors)\n  File \"/layers/google.python.pip/pip/lib/python3.12/site-packages/mypy/semanal_main.py\", line 95, in semantic_analysis_for_scc\n    process_top_levels(graph, scc, patches)\n  File \"/layers/google.python.pip/pip/lib/python3.12/site-packages/mypy/semanal_main.py\", line 222, in process_top_levels\n    deferred, incomplete, progress = semantic_analyze_target(\n  File \"/layers/google.python.pip/pip/lib/python3.12/site-packages/mypy/semanal_main.py\", line 399, in semantic_analyze_target\n    analyzer.refresh_partial(\n  File \"/layers/google.python.pip/pip/lib/python3.12/site-packages/mypy/semanal.py\", line 658, in refresh_partial\n    self.refresh_top_level(node)\n  File \"/layers/google.python.pip/pip/lib/python3.12/site-packages/mypy/semanal.py\", line 676, in refresh_top_level\n    self.accept(d)\n  File \"/layers/google.python.pip/pip/lib/python3.12/site-packages/mypy/semanal.py\", line 7392, in accept\n    node.accept(self)\n  File \"/layers/google.python.pip/pip/lib/python3.12/site-packages/mypy/nodes.py\", line 1951, in accept\n    return visitor.visit_type_alias_stmt(self)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/layers/google.python.pip/pip/lib/python3.12/site-packages/mypy/semanal.py\", line 5598, in visit_type_alias_stmt\n    self.mark_incomplete(s.name.name, s.value, becomes_typeinfo=True)\n  File \"/layers/google.python.pip/pip/lib/python3.12/site-packages/mypy/semanal.py\", line 7084, in mark_incomplete\n    self.defer(node)\n  File \"/layers/google.python.pip/pip/lib/python3.12/site-packages/mypy/semanal.py\", line 7038, in defer\n    assert not self.final_iteration, \"Must not defer during final iteration\"\n           ^^^^^^^^^^^^^^^^^^^^^^^^\nAssertionError: Must not defer during final iteration\nmain.py:2: error: INTERNAL ERROR -- Please try using mypy master on GitHub:\nhttps://mypy.readthedocs.io/en/stable/common_issues.html#using-a-development-mypy-build\nPlease report a bug at https://github.com/python/mypy/issues\nversion: 1.19.0+dev.fb16e938d12f6b24b5edf8023d4adf8e0e36abb4\nmain.py:2: : note: use --pdb to drop into pdb\n```\n\n\n\n\n</details>","closed_by":{"login":"JukkaL","id":1107911,"node_id":"MDQ6VXNlcjExMDc5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/1107911?v=4","gravatar_id":"","url":"https://api.github.com/users/JukkaL","html_url":"https://github.com/JukkaL","followers_url":"https://api.github.com/users/JukkaL/followers","following_url":"https://api.github.com/users/JukkaL/following{/other_user}","gists_url":"https://api.github.com/users/JukkaL/gists{/gist_id}","starred_url":"https://api.github.com/users/JukkaL/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JukkaL/subscriptions","organizations_url":"https://api.github.com/users/JukkaL/orgs","repos_url":"https://api.github.com/users/JukkaL/repos","events_url":"https://api.github.com/users/JukkaL/events{/privacy}","received_events_url":"https://api.github.com/users/JukkaL/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/python/mypy/issues/20135/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/python/mypy/issues/20135/timeline","performed_via_github_app":null,"state_reason":"completed"}