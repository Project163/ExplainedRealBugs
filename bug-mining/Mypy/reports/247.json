{"url":"https://api.github.com/repos/python/mypy/issues/14223","repository_url":"https://api.github.com/repos/python/mypy","labels_url":"https://api.github.com/repos/python/mypy/issues/14223/labels{/name}","comments_url":"https://api.github.com/repos/python/mypy/issues/14223/comments","events_url":"https://api.github.com/repos/python/mypy/issues/14223/events","html_url":"https://github.com/python/mypy/issues/14223","id":1468672322,"node_id":"I_kwDOAGuhRc5XiilC","number":14223,"title":"@overload on async callables accepting and returning union types leads to type erasure","user":{"login":"mishok13","id":548482,"node_id":"MDQ6VXNlcjU0ODQ4Mg==","avatar_url":"https://avatars.githubusercontent.com/u/548482?v=4","gravatar_id":"","url":"https://api.github.com/users/mishok13","html_url":"https://github.com/mishok13","followers_url":"https://api.github.com/users/mishok13/followers","following_url":"https://api.github.com/users/mishok13/following{/other_user}","gists_url":"https://api.github.com/users/mishok13/gists{/gist_id}","starred_url":"https://api.github.com/users/mishok13/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mishok13/subscriptions","organizations_url":"https://api.github.com/users/mishok13/orgs","repos_url":"https://api.github.com/users/mishok13/repos","events_url":"https://api.github.com/users/mishok13/events{/privacy}","received_events_url":"https://api.github.com/users/mishok13/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":21488356,"node_id":"MDU6TGFiZWwyMTQ4ODM1Ng==","url":"https://api.github.com/repos/python/mypy/labels/bug","name":"bug","color":"f9d0c4","default":true,"description":"mypy got something wrong"},{"id":938696461,"node_id":"MDU6TGFiZWw5Mzg2OTY0NjE=","url":"https://api.github.com/repos/python/mypy/labels/topic-overloads","name":"topic-overloads","color":"dd9752","default":false,"description":""},{"id":3987482721,"node_id":"LA_kwDOAGuhRc7trChh","url":"https://api.github.com/repos/python/mypy/labels/topic-async","name":"topic-async","color":"267011","default":false,"description":"async, await, asyncio"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-11-29T20:42:35Z","updated_at":"2022-12-01T10:14:29Z","closed_at":"2022-12-01T10:14:29Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Bug Report**\r\n\r\n Async callable which accepts a parameter with a union type, returns a union type and has `@overload` on said parameter has its return type erased when awaited. I'm hoping this sentence makes any sense, but in any case (pun not intended) the code snippet should demonstrate the issue.\r\n\r\n**To Reproduce**\r\n\r\nHere's the absolute minimum reproduction I could muster:\r\n\r\n```python\r\nfrom typing import overload\r\n\r\nclass A: pass\r\nclass B: pass\r\n\r\n@overload\r\nasync def foo(x: A) -> B: ...\r\n\r\n@overload\r\nasync def foo(x: B) -> A: ...\r\n\r\nasync def foo(x: A | B) -> A | B:\r\n    return A() if isinstance(x, B) else B()\r\n\r\nasync def breaks(x: A | B) -> None:\r\n    y = await foo(x)\r\n    reveal_type(y) # Reveals Any, should reveal A | B\r\n```\r\n\r\nThe following includes non async version of this code which actually works.\r\n\r\nGist URL: https://gist.github.com/2f8288673587ff27f6fca5024ddd0543\r\nPlayground URL: https://mypy-play.net/?mypy=master&python=3.11&gist=2f8288673587ff27f6fca5024ddd0543&flags=strict\r\n\r\n**Expected Behavior**\r\n\r\n`await foo(x)` in the above example should have type `A | B`.\r\n\r\n**Actual Behavior**\r\n\r\n`note: Revealed type is \"Any\"` is the actual result.\r\n\r\n**Your Environment**\r\n\r\nOriginal bug was found on Python 3.10 and mypy 0.991, with `--strict` and a number of per-file settings. I can include relevant excerpt of our `pyproject.toml`, although it seems that this issue is not configuration-specific.\r\n\r\nOn the playground the following was tried:\r\n- Mypy version used: 0.991 (also tried with latest `master` as well as a random sampling of versions between `0.670` and `0.990`\r\n- Mypy command-line flags: none and `--strict`, in fact none of the flag combinations lead to correct result\r\n- Python version used: 3.10, 3.11\r\n\r\n","closed_by":{"login":"hauntsaninja","id":12621235,"node_id":"MDQ6VXNlcjEyNjIxMjM1","avatar_url":"https://avatars.githubusercontent.com/u/12621235?v=4","gravatar_id":"","url":"https://api.github.com/users/hauntsaninja","html_url":"https://github.com/hauntsaninja","followers_url":"https://api.github.com/users/hauntsaninja/followers","following_url":"https://api.github.com/users/hauntsaninja/following{/other_user}","gists_url":"https://api.github.com/users/hauntsaninja/gists{/gist_id}","starred_url":"https://api.github.com/users/hauntsaninja/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hauntsaninja/subscriptions","organizations_url":"https://api.github.com/users/hauntsaninja/orgs","repos_url":"https://api.github.com/users/hauntsaninja/repos","events_url":"https://api.github.com/users/hauntsaninja/events{/privacy}","received_events_url":"https://api.github.com/users/hauntsaninja/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/python/mypy/issues/14223/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/python/mypy/issues/14223/timeline","performed_via_github_app":null,"state_reason":"completed"}