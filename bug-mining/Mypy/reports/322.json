{"url":"https://api.github.com/repos/python/mypy/issues/15004","repository_url":"https://api.github.com/repos/python/mypy","labels_url":"https://api.github.com/repos/python/mypy/issues/15004/labels{/name}","comments_url":"https://api.github.com/repos/python/mypy/issues/15004/comments","events_url":"https://api.github.com/repos/python/mypy/issues/15004/events","html_url":"https://github.com/python/mypy/issues/15004","id":1652865061,"node_id":"I_kwDOAGuhRc5ihLgl","number":15004,"title":"AssertionError: Internal error: too many class plugin hook passes","user":{"login":"mementum","id":5713511,"node_id":"MDQ6VXNlcjU3MTM1MTE=","avatar_url":"https://avatars.githubusercontent.com/u/5713511?v=4","gravatar_id":"","url":"https://api.github.com/users/mementum","html_url":"https://github.com/mementum","followers_url":"https://api.github.com/users/mementum/followers","following_url":"https://api.github.com/users/mementum/following{/other_user}","gists_url":"https://api.github.com/users/mementum/gists{/gist_id}","starred_url":"https://api.github.com/users/mementum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mementum/subscriptions","organizations_url":"https://api.github.com/users/mementum/orgs","repos_url":"https://api.github.com/users/mementum/repos","events_url":"https://api.github.com/users/mementum/events{/privacy}","received_events_url":"https://api.github.com/users/mementum/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":379446833,"node_id":"MDU6TGFiZWwzNzk0NDY4MzM=","url":"https://api.github.com/repos/python/mypy/labels/crash","name":"crash","color":"b60205","default":false,"description":null},{"id":681535222,"node_id":"MDU6TGFiZWw2ODE1MzUyMjI=","url":"https://api.github.com/repos/python/mypy/labels/topic-protocols","name":"topic-protocols","color":"0052cc","default":false,"description":null},{"id":3945206226,"node_id":"LA_kwDOAGuhRc7rJxHS","url":"https://api.github.com/repos/python/mypy/labels/topic-dataclasses","name":"topic-dataclasses","color":"8E9730","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2023-04-03T22:34:49Z","updated_at":"2023-05-02T13:42:29Z","closed_at":"2023-05-02T13:42:29Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Crash Report**\r\n\r\nSee the traceback.\r\n\r\n**Traceback**\r\n\r\n```\r\nTraceback (most recent call last):\r\n  File \"D:\\dro\\bin\\WPy64-31090\\python-3.10.9.amd64\\lib\\runpy.py\", line 196, in _run_module_as_main\r\n    return _run_code(code, main_globals, None,\r\n  File \"D:\\dro\\bin\\WPy64-31090\\python-3.10.9.amd64\\lib\\runpy.py\", line 86, in _run_code\r\n    exec(code, run_globals)\r\n  File \"D:\\dro\\bin\\WPy64-31090\\python-3.10.9.amd64\\scripts\\mypy.exe\\__main__.py\", line 7, in <module>\r\n  File \"D:\\dro\\bin\\WPy64-31090\\python-3.10.9.amd64\\lib\\site-packages\\mypy\\__main__.py\", line 15, in console_entry\r\n    main()\r\n  File \"mypy\\main.py\", line 95, in main\r\n  File \"mypy\\main.py\", line 174, in run_build\r\n  File \"mypy\\build.py\", line 194, in build\r\n  File \"mypy\\build.py\", line 277, in _build\r\n  File \"mypy\\build.py\", line 2923, in dispatch\r\n  File \"mypy\\build.py\", line 3320, in process_graph\r\n  File \"mypy\\build.py\", line 3415, in process_stale_scc\r\n  File \"mypy\\semanal_main.py\", line 99, in semantic_analysis_for_scc\r\n  File \"mypy\\semanal_main.py\", line 429, in apply_class_plugin_hooks\r\nAssertionError: Internal error: too many class plugin hook passes\r\n```\r\n\r\n**To Reproduce**\r\n\r\n```python\r\n#!/usr/bin/env python\r\n# -*- coding: utf-8; py-indent-offset:4 -*-\r\n###############################################################################\r\nfrom __future__ import annotations\r\nfrom dataclasses import asdict, dataclass, field\r\nfrom decimal import Context, Decimal, Inexact\r\nfrom typing import ClassVar, Protocol\r\n\r\n\r\nDecimalPlus = Decimal | str | int | float\r\n\r\n\r\n@dataclass\r\nclass TargetSettings(Protocol):\r\n    max: DecimalPlus\r\n    min: DecimalPlus\r\n    inc: DecimalPlus\r\n    precision: int\r\n\r\n    PLACES: Decimal = field(init=False, repr=False)\r\n    INEXACT: ClassVar[Context] = Context(traps=[Inexact])\r\n\r\n    def __post_init__(self) -> None:\r\n        self.PLACES = PLACES = Decimal(10) ** -self.precision\r\n\r\n        self.min = Decimal(self.min).quantize(PLACES)\r\n        self.max = Decimal(self.max).quantize(PLACES)\r\n        self.inc = Decimal(self.inc).quantize(PLACES)\r\n\r\n    def is_valid(self, val: DecimalPlus) -> bool:\r\n        try:\r\n            val = Decimal(val).quantize(self.PLACES, context=self.INEXACT)\r\n        except Inexact:\r\n            return False  # more decimal places than allowed\r\n\r\n        # mypy does not know attributes are Decimals at this stage\r\n        if not (self.min <= val <= self.max):  # type: ignore\r\n            return False\r\n\r\n        return True  # all checks passed\r\n\r\n```\r\n\r\n**Your Environment**\r\n\r\n- Mypy version used: 1.1.1\r\n- Mypy command-line flags: `None`\r\n- Mypy configuration options from `mypy.ini` (and other config files): `None`\r\n- Python version used: `3.10.9`\r\n- Operating system and version: `Windows 11 22621.1413`\r\n\r\n**Additional Comment**\r\n\r\nLet me say that I do believe that the concept of static type checking of `Union` is broken (again: *the concept*). In my very humble opinion as user, if I do declare something as a `Union` (either with the keyword or the `|` operator), `mypy` must believe that when the time comes, the variable/attribute declared as a Union, will contain one of the types.\r\n\r\nReporting errors like \r\n```\r\nerror: Unsupported operand types for <= (\"Decimal\" and \"str\")  [operator]\r\n```\r\n\r\nwhen the `Union` contains `Union[Decimal, str, int, float]` is in my very humble opinion: **wrong**. Such an error can be reported during *runtime*, but not during static analysis, because `mypy` has no way of knowing what the type at that stage contains. Reporting a \"warning\" would be ok. Reporting an \"error\" is an error itself.\r\n\r\nNo, as a user I am not in the mood of adding `cast` here and there and here-there to pollute the code, hence the need to add a `# type: ignore` to silence `mypy`.","closed_by":{"login":"JukkaL","id":1107911,"node_id":"MDQ6VXNlcjExMDc5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/1107911?v=4","gravatar_id":"","url":"https://api.github.com/users/JukkaL","html_url":"https://github.com/JukkaL","followers_url":"https://api.github.com/users/JukkaL/followers","following_url":"https://api.github.com/users/JukkaL/following{/other_user}","gists_url":"https://api.github.com/users/JukkaL/gists{/gist_id}","starred_url":"https://api.github.com/users/JukkaL/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JukkaL/subscriptions","organizations_url":"https://api.github.com/users/JukkaL/orgs","repos_url":"https://api.github.com/users/JukkaL/repos","events_url":"https://api.github.com/users/JukkaL/events{/privacy}","received_events_url":"https://api.github.com/users/JukkaL/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/python/mypy/issues/15004/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/python/mypy/issues/15004/timeline","performed_via_github_app":null,"state_reason":"completed"}