{"url":"https://api.github.com/repos/python/mypy/issues/18493","repository_url":"https://api.github.com/repos/python/mypy","labels_url":"https://api.github.com/repos/python/mypy/issues/18493/labels{/name}","comments_url":"https://api.github.com/repos/python/mypy/issues/18493/comments","events_url":"https://api.github.com/repos/python/mypy/issues/18493/events","html_url":"https://github.com/python/mypy/issues/18493","id":2799806522,"node_id":"I_kwDOAGuhRc6m4ag6","number":18493,"title":"Misleading error message when using ParamSpec with higher-order decorators and async functions","user":{"login":"wesleywright","id":4690880,"node_id":"MDQ6VXNlcjQ2OTA4ODA=","avatar_url":"https://avatars.githubusercontent.com/u/4690880?v=4","gravatar_id":"","url":"https://api.github.com/users/wesleywright","html_url":"https://github.com/wesleywright","followers_url":"https://api.github.com/users/wesleywright/followers","following_url":"https://api.github.com/users/wesleywright/following{/other_user}","gists_url":"https://api.github.com/users/wesleywright/gists{/gist_id}","starred_url":"https://api.github.com/users/wesleywright/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wesleywright/subscriptions","organizations_url":"https://api.github.com/users/wesleywright/orgs","repos_url":"https://api.github.com/users/wesleywright/repos","events_url":"https://api.github.com/users/wesleywright/events{/privacy}","received_events_url":"https://api.github.com/users/wesleywright/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":21488356,"node_id":"MDU6TGFiZWwyMTQ4ODM1Ng==","url":"https://api.github.com/repos/python/mypy/labels/bug","name":"bug","color":"f9d0c4","default":true,"description":"mypy got something wrong"},{"id":3945146290,"node_id":"LA_kwDOAGuhRc7rJiey","url":"https://api.github.com/repos/python/mypy/labels/topic-error-reporting","name":"topic-error-reporting","color":"A8F9AF","default":false,"description":"How we report errors"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2025-01-20T16:31:04Z","updated_at":"2025-01-23T17:36:14Z","closed_at":"2025-01-22T20:02:50Z","author_association":"COLLABORATOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Bug Report**\n\n<!--\nIf you're reporting a problem with a specific library function, the typeshed tracker is better suited for this report: https://github.com/python/typeshed/issues\n\nIf the project you encountered the issue in is open source, please provide a link to the project.\n-->\n\nThere seems to be a niche edge case where mypy detects a mismatch between parameter names for a `ParamSpec` but doesn't actually _report_ the difference in parameter names. In my reproducible example, it actually prints a confusing error about the _return types_, even though the return types actually unify just fine. I've only been able to reproduce it with an async function, but I'm not sure if it's limited to async functions.\n\nThis is probably a relatively rare issue for users to hit because it involves a higher-order function that returns a decorator, `ParamSpec`, and async â€” all of which are somewhat niche on their own. However, the error output still seems very misleading to me.\n\n**To Reproduce**\n\nhttps://mypy-play.net/?mypy=latest&python=3.12&gist=12a1a49ced24294d0d1395f9317afcc1\n\n```python\nfrom typing import Any, Awaitable, Callable, ParamSpec, TypeVar, Iterator\n\nP = ParamSpec(\"P\")\nR = TypeVar(\"R\")\n\n\ndef decorator2(f: Callable[P, None]) -> Callable[\n    [Callable[P, Awaitable[None]]],\n    Callable[P, Awaitable[None]],\n]:\n    return lambda f: f\n\n\ndef key2(x: int) -> None:\n    ...\n\n\n@decorator2(key2)\nasync def foo2(y: int) -> None:\n    ...\n```\n\n**Expected Behavior**\n\nMypy should print an error pointing out that `key2` takes a parameter named `x` while `foo2` takes a parameter named `y`. For example, if you rewrote this example so that the `foo2` is non-async and the decorator doesn't use `Awaitable`, you would get this error message:\n\n```\nerror: Argument 1 has incompatible type \"Callable[[Arg(int, 'y')], None]\"; expected \"Callable[[Arg(int, 'x')], None]\"  [arg-type]\n```\n\n**Actual Behavior**\n\nMypy gives an error that does _not_ describe the difference in argument names, but which _does_ describe a difference in return types (even though these return types actually unify just fine!):\n\n```\nerror: Argument 1 has incompatible type \"Callable[[int], Coroutine[Any, Any, None]]\"; expected \"Callable[[int], Awaitable[None]]\"  [arg-type]\n```\n\n**Your Environment**\n\nDiscovered while testing latest master to prepare the 1.15 release, but this behavior seems to be longstanding; I see the same error message when using the code from mypy v1.0.0. It seems to reproduce out of the box in Mypy, as demonstrated by the vanilla mypy playground link above.","closed_by":{"login":"hauntsaninja","id":12621235,"node_id":"MDQ6VXNlcjEyNjIxMjM1","avatar_url":"https://avatars.githubusercontent.com/u/12621235?v=4","gravatar_id":"","url":"https://api.github.com/users/hauntsaninja","html_url":"https://github.com/hauntsaninja","followers_url":"https://api.github.com/users/hauntsaninja/followers","following_url":"https://api.github.com/users/hauntsaninja/following{/other_user}","gists_url":"https://api.github.com/users/hauntsaninja/gists{/gist_id}","starred_url":"https://api.github.com/users/hauntsaninja/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hauntsaninja/subscriptions","organizations_url":"https://api.github.com/users/hauntsaninja/orgs","repos_url":"https://api.github.com/users/hauntsaninja/repos","events_url":"https://api.github.com/users/hauntsaninja/events{/privacy}","received_events_url":"https://api.github.com/users/hauntsaninja/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/python/mypy/issues/18493/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/python/mypy/issues/18493/timeline","performed_via_github_app":null,"state_reason":"completed"}