{"url":"https://api.github.com/repos/python/mypy/issues/11507","repository_url":"https://api.github.com/repos/python/mypy","labels_url":"https://api.github.com/repos/python/mypy/issues/11507/labels{/name}","comments_url":"https://api.github.com/repos/python/mypy/issues/11507/comments","events_url":"https://api.github.com/repos/python/mypy/issues/11507/events","html_url":"https://github.com/python/mypy/issues/11507","id":1049108726,"node_id":"I_kwDOAGuhRc4-iCD2","number":11507,"title":"Increase in memory requirements for compiling mypy with MYPY_USE_MYPYC=1","user":{"login":"nehaljwani","id":1779189,"node_id":"MDQ6VXNlcjE3NzkxODk=","avatar_url":"https://avatars.githubusercontent.com/u/1779189?v=4","gravatar_id":"","url":"https://api.github.com/users/nehaljwani","html_url":"https://github.com/nehaljwani","followers_url":"https://api.github.com/users/nehaljwani/followers","following_url":"https://api.github.com/users/nehaljwani/following{/other_user}","gists_url":"https://api.github.com/users/nehaljwani/gists{/gist_id}","starred_url":"https://api.github.com/users/nehaljwani/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nehaljwani/subscriptions","organizations_url":"https://api.github.com/users/nehaljwani/orgs","repos_url":"https://api.github.com/users/nehaljwani/repos","events_url":"https://api.github.com/users/nehaljwani/events{/privacy}","received_events_url":"https://api.github.com/users/nehaljwani/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":21488356,"node_id":"MDU6TGFiZWwyMTQ4ODM1Ng==","url":"https://api.github.com/repos/python/mypy/labels/bug","name":"bug","color":"f9d0c4","default":true,"description":"mypy got something wrong"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2021-11-09T20:48:52Z","updated_at":"2021-11-22T07:20:37Z","closed_at":"2021-11-22T07:20:36Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"This is technically not a bug/crash reported or a feature request. This is more of an FYI for package maintainers and an invitation to discuss the potential issue.\r\n\r\nTo give you some context, I'm one of the maintainers of the [mypy feedstock](https://github.com/conda-forge/mypy-feedstock) at conda-forge. During the `py310` build migration for `mypy`, our CI build container kept getting killed/OOMed on `linux-aarch64`. On investigation, I found that the memory requirements to build the `__native_<>.c module` has increased (significantly?) for `py310`.\r\n\r\n```bash\r\n/usr/bin/time -v gcc -pthread -B $CONDA_PREFIX/compiler_compat -Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O2 -Wall -fPIC -O2 -isystem $CONDA_PREFIX/include -fPIC -O2 -isystem $CONDA_PREFIX/include -fPIC -I/path/to/mypy/mypyc/lib-rt -Ibuild -I$CONDA_PREFIX/include/python3.10 -c build/__native_a64f60bb4641b67cb20c.c -o build/temp.linux-x86_64-3.10/build/__native_a64f60bb4641b67cb20c.o -O3 -Werror -Wno-unused-function -Wno-unused-label -Wno-unreachable-code -Wno-unused-variable -Wno-unused-command-line-argument -Wno-unknown-warning-option -Wno-unused-but-set-variable\r\nbuild/__native_a64f60bb4641b67cb20c.c: In function ‘CPyDef_fixup___TypeFixer___visit_instance’:\r\nbuild/__native_a64f60bb4641b67cb20c.c:570654: note: ‘-Wmisleading-indentation’ is disabled from this point onwards, since column-tracking was disabled due to the size of the code/headers\r\n570654 | CPyL13: ;\r\n       | \r\n\tCommand being timed: \"gcc -pthread -B $CONDA_PREFIX/compiler_compat -Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O2 -Wall -fPIC -O2 -isystem $CONDA_PREFIX/include -fPIC -O2 -isystem $CONDA_PREFIX/include -fPIC -I/path/to/mypy/mypyc/lib-rt -Ibuild -I$CONDA_PREFIX/include/python3.10 -c build/__native_a64f60bb4641b67cb20c.c -o build/temp.linux-x86_64-3.10/build/__native_a64f60bb4641b67cb20c.o -O3 -Werror -Wno-unused-function -Wno-unused-label -Wno-unreachable-code -Wno-unused-variable -Wno-unused-command-line-argument -Wno-unknown-warning-option -Wno-unused-but-set-variable\"\r\n\tUser time (seconds): 624.63\r\n\tSystem time (seconds): 5.31\r\n\tPercent of CPU this job got: 99%\r\n\tElapsed (wall clock) time (h:mm:ss or m:ss): 10:30.21\r\n\tAverage shared text size (kbytes): 0\r\n\tAverage unshared data size (kbytes): 0\r\n\tAverage stack size (kbytes): 0\r\n\tAverage total size (kbytes): 0\r\n\tMaximum resident set size (kbytes): **5037436** <--- !!!!\r\n\tAverage resident set size (kbytes): 0\r\n\tMajor (requiring I/O) page faults: 20\r\n\tMinor (reclaiming a frame) page faults: 2640454\r\n\tVoluntary context switches: 191\r\n\tInvoluntary context switches: 1676\r\n\tSwaps: 0\r\n\tFile system inputs: 2792\r\n\tFile system outputs: 1818944\r\n\tSocket messages sent: 0\r\n\tSocket messages received: 0\r\n\tSignals delivered: 0\r\n\tPage size (bytes): 4096\r\n\tExit status: 0\r\n```\r\n\r\nTo compare, with `py38`, the requirements were:\r\n```bash\r\n/usr/bin/time -v gcc -pthread -Wsign-compare -DNDEBUG -g -fwrapv -O3 -Wall -Wstrict-prototypes -fPIC -I/path/to/mypy/mypyc/lib-rt -Ibuild -I$CONDA_PREFIX/include/python3.8 -c build/__native_a64f60bb4641b67cb20c.c -o build/temp.linux-x86_64-3.8/build/__native_a64f60bb4641b67cb20c.o -O3 -Werror -Wno-unused-function -Wno-unused-label -Wno-unreachable-code -Wno-unused-variable -Wno-unused-command-line-argument -Wno-unknown-warning-option -Wno-unused-but-set-variable\r\nbuild/__native_a64f60bb4641b67cb20c.c: In function ‘CPyDef_fixup___TypeFixer___visit_none_type__TypeVisitor_glue’:\r\nbuild/__native_a64f60bb4641b67cb20c.c:570413: note: ‘-Wmisleading-indentation’ is disabled from this point onwards, since column-tracking was disabled due to the size of the code/headers\r\n570413 | CPyL1: ;\r\n       | \r\n\tCommand being timed: \"gcc -pthread -Wsign-compare -DNDEBUG -g -fwrapv -O3 -Wall -Wstrict-prototypes -fPIC -I/path/to/mypy/mypyc/lib-rt -Ibuild -I$CONDA_PREFIX/include/python3.8 -c build/__native_a64f60bb4641b67cb20c.c -o build/temp.linux-x86_64-3.8/build/__native_a64f60bb4641b67cb20c.o -O3 -Werror -Wno-unused-function -Wno-unused-label -Wno-unreachable-code -Wno-unused-variable -Wno-unused-command-line-argument -Wno-unknown-warning-option -Wno-unused-but-set-variable\"\r\n\tUser time (seconds): 595.81\r\n\tSystem time (seconds): 5.07\r\n\tPercent of CPU this job got: 99%\r\n\tElapsed (wall clock) time (h:mm:ss or m:ss): 10:01.20\r\n\tAverage shared text size (kbytes): 0\r\n\tAverage unshared data size (kbytes): 0\r\n\tAverage stack size (kbytes): 0\r\n\tAverage total size (kbytes): 0\r\n\tMaximum resident set size (kbytes): **4817776** <--- !!!!\r\n\tAverage resident set size (kbytes): 0\r\n\tMajor (requiring I/O) page faults: 0\r\n\tMinor (reclaiming a frame) page faults: 2593657\r\n\tVoluntary context switches: 153\r\n\tInvoluntary context switches: 3692\r\n\tSwaps: 0\r\n\tFile system inputs: 24\r\n\tFile system outputs: 1723584\r\n\tSocket messages sent: 0\r\n\tSocket messages received: 0\r\n\tSignals delivered: 0\r\n\tPage size (bytes): 4096\r\n\tExit status: 0\r\n```\r\nBy [decreasing](https://github.com/conda-forge/mypy-feedstock/blob/master/recipe/patches/0001-Reduce-amount-of-debug-info-injected-in-extension-mo.patch) the amount of debug info being injected using `-g1`, I was able reduce the amount of maximum `RSS` by `~1GB` for `py310` and `~700MB` for `py38` and then CI was happy. Particularly for release builds, one may wish to simply use `-g0` as well.\r\n\r\nIt might be interesting to see why we see these increases with cpython version bumps. I would :heart: to get some insight by the mypy devs :slightly_smiling_face:","closed_by":{"login":"97littleleaf11","id":11172084,"node_id":"MDQ6VXNlcjExMTcyMDg0","avatar_url":"https://avatars.githubusercontent.com/u/11172084?v=4","gravatar_id":"","url":"https://api.github.com/users/97littleleaf11","html_url":"https://github.com/97littleleaf11","followers_url":"https://api.github.com/users/97littleleaf11/followers","following_url":"https://api.github.com/users/97littleleaf11/following{/other_user}","gists_url":"https://api.github.com/users/97littleleaf11/gists{/gist_id}","starred_url":"https://api.github.com/users/97littleleaf11/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/97littleleaf11/subscriptions","organizations_url":"https://api.github.com/users/97littleleaf11/orgs","repos_url":"https://api.github.com/users/97littleleaf11/repos","events_url":"https://api.github.com/users/97littleleaf11/events{/privacy}","received_events_url":"https://api.github.com/users/97littleleaf11/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/python/mypy/issues/11507/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/python/mypy/issues/11507/timeline","performed_via_github_app":null,"state_reason":"completed"}