{"url":"https://api.github.com/repos/python/mypy/issues/14565","repository_url":"https://api.github.com/repos/python/mypy","labels_url":"https://api.github.com/repos/python/mypy/issues/14565/labels{/name}","comments_url":"https://api.github.com/repos/python/mypy/issues/14565/comments","events_url":"https://api.github.com/repos/python/mypy/issues/14565/events","html_url":"https://github.com/python/mypy/issues/14565","id":1563791928,"node_id":"I_kwDOAGuhRc5dNZI4","number":14565,"title":"New \"Must not defer during final iteration\" crash","user":{"login":"hauntsaninja","id":12621235,"node_id":"MDQ6VXNlcjEyNjIxMjM1","avatar_url":"https://avatars.githubusercontent.com/u/12621235?v=4","gravatar_id":"","url":"https://api.github.com/users/hauntsaninja","html_url":"https://github.com/hauntsaninja","followers_url":"https://api.github.com/users/hauntsaninja/followers","following_url":"https://api.github.com/users/hauntsaninja/following{/other_user}","gists_url":"https://api.github.com/users/hauntsaninja/gists{/gist_id}","starred_url":"https://api.github.com/users/hauntsaninja/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hauntsaninja/subscriptions","organizations_url":"https://api.github.com/users/hauntsaninja/orgs","repos_url":"https://api.github.com/users/hauntsaninja/repos","events_url":"https://api.github.com/users/hauntsaninja/events{/privacy}","received_events_url":"https://api.github.com/users/hauntsaninja/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":379446833,"node_id":"MDU6TGFiZWwzNzk0NDY4MzM=","url":"https://api.github.com/repos/python/mypy/labels/crash","name":"crash","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2023-01-31T07:20:17Z","updated_at":"2023-02-01T09:56:14Z","closed_at":"2023-02-01T09:56:14Z","author_association":"COLLABORATOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Crash Report**\r\n\r\nIt looks like mypy has started crashing on one of the mypy_primer projects, https://github.com/FasterSpeeding/Tanjun (after the latest commit to that project). I noticed this in https://github.com/python/mypy/pull/14238#issuecomment-1409828838\r\n\r\nmypy 0.991 does not crash on the project. I've bisected the crash to #14159 cc @ilevkivskyi \r\n\r\nThe crash is caused by the latest commit to the project: https://github.com/FasterSpeeding/Tanjun/commit/942b8b47106dddee9129ec4a6be312fe3e5eeac9\r\n\r\n**Traceback**\r\n\r\n```\r\n...\r\n\t  File \"/private/tmp/mypy_primer/bisect_mypy/mypy/mypy/build.py\", line 3403, in process_stale_scc\r\n\t    mypy.semanal_main.semantic_analysis_for_scc(graph, scc, manager.errors)\r\n\t  File \"/private/tmp/mypy_primer/bisect_mypy/mypy/mypy/semanal_main.py\", line 85, in semantic_analysis_for_scc\r\n\t    process_functions(graph, scc, patches)\r\n\t  File \"/private/tmp/mypy_primer/bisect_mypy/mypy/mypy/semanal_main.py\", line 243, in process_functions\r\n\t    process_top_level_function(\r\n\t  File \"/private/tmp/mypy_primer/bisect_mypy/mypy/mypy/semanal_main.py\", line 282, in process_top_level_function\r\n\t    deferred, incomplete, progress = semantic_analyze_target(\r\n\t  File \"/private/tmp/mypy_primer/bisect_mypy/mypy/mypy/semanal_main.py\", line 339, in semantic_analyze_target\r\n\t    analyzer.refresh_partial(\r\n\t  File \"/private/tmp/mypy_primer/bisect_mypy/mypy/mypy/semanal.py\", line 602, in refresh_partial\r\n\t    self.accept(node)\r\n\t  File \"/private/tmp/mypy_primer/bisect_mypy/mypy/mypy/semanal.py\", line 6175, in accept\r\n\t    node.accept(self)\r\n\t  File \"/private/tmp/mypy_primer/bisect_mypy/mypy/mypy/nodes.py\", line 790, in accept\r\n\t    return visitor.visit_func_def(self)\r\n\t  File \"/private/tmp/mypy_primer/bisect_mypy/mypy/mypy/semanal.py\", line 829, in visit_func_def\r\n\t    self.analyze_func_def(defn)\r\n\t  File \"/private/tmp/mypy_primer/bisect_mypy/mypy/mypy/semanal.py\", line 864, in analyze_func_def\r\n\t    self.defer(defn)\r\n\t  File \"/private/tmp/mypy_primer/bisect_mypy/mypy/mypy/semanal.py\", line 5852, in defer\r\n\t    assert not self.final_iteration, \"Must not defer during final iteration\"\r\n\tAssertionError: Must not defer during final iteration\r\n```\r\n\r\n**To Reproduce**\r\n\r\n```\r\ngit clone https://github.com/FasterSpeeding/Tanjun\r\ncd Tanjun\r\npython -m venv env\r\nenv/bin/python -m pip install hikari alluka\r\n\r\nmypy tanjun --show-traceback --python-executable=env/bin/python\r\n```","closed_by":{"login":"JukkaL","id":1107911,"node_id":"MDQ6VXNlcjExMDc5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/1107911?v=4","gravatar_id":"","url":"https://api.github.com/users/JukkaL","html_url":"https://github.com/JukkaL","followers_url":"https://api.github.com/users/JukkaL/followers","following_url":"https://api.github.com/users/JukkaL/following{/other_user}","gists_url":"https://api.github.com/users/JukkaL/gists{/gist_id}","starred_url":"https://api.github.com/users/JukkaL/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JukkaL/subscriptions","organizations_url":"https://api.github.com/users/JukkaL/orgs","repos_url":"https://api.github.com/users/JukkaL/repos","events_url":"https://api.github.com/users/JukkaL/events{/privacy}","received_events_url":"https://api.github.com/users/JukkaL/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/python/mypy/issues/14565/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/python/mypy/issues/14565/timeline","performed_via_github_app":null,"state_reason":"completed"}