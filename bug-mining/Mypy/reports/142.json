{"url":"https://api.github.com/repos/python/mypy/issues/12717","repository_url":"https://api.github.com/repos/python/mypy","labels_url":"https://api.github.com/repos/python/mypy/issues/12717/labels{/name}","comments_url":"https://api.github.com/repos/python/mypy/issues/12717/comments","events_url":"https://api.github.com/repos/python/mypy/issues/12717/events","html_url":"https://github.com/python/mypy/issues/12717","id":1222842465,"node_id":"I_kwDOAGuhRc5I4xhh","number":12717,"title":"Regression: Stub generator no longer generates `__members__` for enum class","user":{"login":"bluenote10","id":3620703,"node_id":"MDQ6VXNlcjM2MjA3MDM=","avatar_url":"https://avatars.githubusercontent.com/u/3620703?v=4","gravatar_id":"","url":"https://api.github.com/users/bluenote10","html_url":"https://github.com/bluenote10","followers_url":"https://api.github.com/users/bluenote10/followers","following_url":"https://api.github.com/users/bluenote10/following{/other_user}","gists_url":"https://api.github.com/users/bluenote10/gists{/gist_id}","starred_url":"https://api.github.com/users/bluenote10/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bluenote10/subscriptions","organizations_url":"https://api.github.com/users/bluenote10/orgs","repos_url":"https://api.github.com/users/bluenote10/repos","events_url":"https://api.github.com/users/bluenote10/events{/privacy}","received_events_url":"https://api.github.com/users/bluenote10/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":21488356,"node_id":"MDU6TGFiZWwyMTQ4ODM1Ng==","url":"https://api.github.com/repos/python/mypy/labels/bug","name":"bug","color":"f9d0c4","default":true,"description":"mypy got something wrong"},{"id":3201597398,"node_id":"MDU6TGFiZWwzMjAxNTk3Mzk4","url":"https://api.github.com/repos/python/mypy/labels/topic-stubgen","name":"topic-stubgen","color":"bfd4f2","default":false,"description":""},{"id":3542345285,"node_id":"LA_kwDOAGuhRc7TI-ZF","url":"https://api.github.com/repos/python/mypy/labels/topic-enum","name":"topic-enum","color":"47988D","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-05-02T12:44:23Z","updated_at":"2022-05-21T14:00:40Z","closed_at":"2022-05-21T14:00:40Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"<!--\r\n  If you're new to mypy and you're not sure whether what you're experiencing is a mypy bug, please see the \"Question and Help\" form\r\n  instead.\r\n  Please also consider:\r\n\r\n  - checking our common issues page: https://mypy.readthedocs.io/en/stable/common_issues.html\r\n  - searching our issue tracker: https://github.com/python/mypy/issues to see if\r\n    it's already been reported\r\n  - asking on gitter chat: https://gitter.im/python/typing\r\n-->\r\n\r\n**Bug Report**\r\n\r\nIn mypy version 0.942, the stub generator used to create `__members__` fields like:\r\n\r\n```python\r\nclass MyEnum:\r\n    __members__: ClassVar[dict] = ...  # read-only\r\n```\r\n\r\nIn our case, `MyEnum` is a C++ `enum class` exposed to Python via pybind11. The type annotation seemed to be correct, because at runtime, `__members__` does exist.\r\n\r\nIn mypy version 0.950 the `__members__` field is no longer annotated, which means that existing value code no longer type checks properly.\r\n\r\n**To Reproduce**\r\n\r\n- Create a temporary venv:\r\n\r\n```sh\r\n$ mkdir some_temporary_folder\r\n$ cd some_temporary_folder\r\n$ virtualenv ./tmp_venv -p /usr/bin/python3.8\r\n$ . ./tmp_venv/bin/activate\r\n$ pip install -U pip setuptools\r\n$ pip install mypy==0.950 pybind11==2.9.0\r\n```\r\n\r\n- Create a file **`native_enum_test.cpp`** with content:\r\n\r\n```c++\r\n#include <cstddef>\r\n#include <memory>\r\n#include <pybind11/pybind11.h>\r\n\r\nnamespace py = pybind11;\r\n\r\nenum class MyEnum { FOO, BAR };\r\n\r\nPYBIND11_MODULE(native_enum_test, module) {\r\n  pybind11::enum_<MyEnum>(module, \"MyEnum\", pybind11::arithmetic())\r\n      .value(\"FOO\", MyEnum::FOO)\r\n      .value(\"BAR\", MyEnum::BAR);\r\n}\r\n```\r\n\r\n- Compile via:\r\n\r\n```sh\r\n$ c++ -O3 -Wall -shared -std=c++17 -fPIC $(python3 -m pybind11 --includes) native_enum_test.cpp -o native_enum_test.so\r\n```\r\n\r\n- Run the stub generator:\r\n\r\n```sh\r\n$ stubgen -p native_enum_test\r\n```\r\n\r\n**Expected Behavior**\r\n\r\nAs far as I can see, `__members__` should be generated by the stub generator.\r\n\r\nCheck against the previous mypy version: `pip install mypy==0.942` and re-running the stub generator produces:\r\n\r\n<details>\r\n<summary>Generator output mypy 0.942</summary>\r\n\r\n```python\r\nfrom typing import ClassVar\r\n\r\nclass MyEnum:\r\n    __doc__: ClassVar[str] = ...  # read-only\r\n    __members__: ClassVar[dict] = ...  # read-only\r\n    BAR: ClassVar[MyEnum] = ...\r\n    FOO: ClassVar[MyEnum] = ...\r\n    __entries: ClassVar[dict] = ...\r\n    def __init__(self, value: int) -> None: ...\r\n    def __eq__(self, other: object) -> bool: ...\r\n    def __ge__(self, other: object) -> bool: ...\r\n    def __getstate__(self) -> int: ...\r\n    def __gt__(self, other: object) -> bool: ...\r\n    def __hash__(self) -> int: ...\r\n    def __index__(self) -> int: ...\r\n    def __int__(self) -> int: ...\r\n    def __le__(self, other: object) -> bool: ...\r\n    def __lt__(self, other: object) -> bool: ...\r\n    def __ne__(self, other: object) -> bool: ...\r\n    def __setstate__(self, state: int) -> None: ...\r\n    @property\r\n    def name(self) -> str: ...\r\n    @property\r\n    def value(self) -> int: ...\r\n```\r\n\r\n</details>\r\n\r\n**Actual Behavior**\r\n\r\n`__members__` is missing in the stub generator output.\r\n\r\n<details>\r\n<summary>Generator output mypy 0.950</summary>\r\n\r\n```python\r\nfrom typing import ClassVar\r\n\r\nclass MyEnum:\r\n    BAR: ClassVar[MyEnum] = ...\r\n    FOO: ClassVar[MyEnum] = ...\r\n    __entries: ClassVar[dict] = ...\r\n    def __init__(self, value: int) -> None: ...\r\n    def __eq__(self, other: object) -> bool: ...\r\n    def __ge__(self, other: object) -> bool: ...\r\n    def __getstate__(self) -> int: ...\r\n    def __gt__(self, other: object) -> bool: ...\r\n    def __hash__(self) -> int: ...\r\n    def __index__(self) -> int: ...\r\n    def __int__(self) -> int: ...\r\n    def __le__(self, other: object) -> bool: ...\r\n    def __lt__(self, other: object) -> bool: ...\r\n    def __ne__(self, other: object) -> bool: ...\r\n    def __setstate__(self, state: int) -> None: ...\r\n    @property\r\n    def name(self) -> str: ...\r\n    @property\r\n    def value(self) -> int: ...\r\n```\r\n\r\n</details>\r\n\r\n**Your Environment**\r\n\r\n<!-- Include as many relevant details about the environment you experienced the bug in -->\r\n\r\n- Mypy version used: 0.950\r\n- Mypy command-line flags: not relevant, this is about the stub generator\r\n- Mypy configuration options from `mypy.ini` (and other config files): not relevant, this is about the stub generator\r\n- Python version used: 3.8.10\r\n- Operating system and version: Ubuntu 20.04\r\n\r\n","closed_by":{"login":"JelleZijlstra","id":906600,"node_id":"MDQ6VXNlcjkwNjYwMA==","avatar_url":"https://avatars.githubusercontent.com/u/906600?v=4","gravatar_id":"","url":"https://api.github.com/users/JelleZijlstra","html_url":"https://github.com/JelleZijlstra","followers_url":"https://api.github.com/users/JelleZijlstra/followers","following_url":"https://api.github.com/users/JelleZijlstra/following{/other_user}","gists_url":"https://api.github.com/users/JelleZijlstra/gists{/gist_id}","starred_url":"https://api.github.com/users/JelleZijlstra/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JelleZijlstra/subscriptions","organizations_url":"https://api.github.com/users/JelleZijlstra/orgs","repos_url":"https://api.github.com/users/JelleZijlstra/repos","events_url":"https://api.github.com/users/JelleZijlstra/events{/privacy}","received_events_url":"https://api.github.com/users/JelleZijlstra/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/python/mypy/issues/12717/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/python/mypy/issues/12717/timeline","performed_via_github_app":null,"state_reason":"completed"}