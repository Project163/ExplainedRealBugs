{"url":"https://api.github.com/repos/python/mypy/issues/15024","repository_url":"https://api.github.com/repos/python/mypy","labels_url":"https://api.github.com/repos/python/mypy/issues/15024/labels{/name}","comments_url":"https://api.github.com/repos/python/mypy/issues/15024/comments","events_url":"https://api.github.com/repos/python/mypy/issues/15024/events","html_url":"https://github.com/python/mypy/issues/15024","id":1659807147,"node_id":"I_kwDOAGuhRc5i7qWr","number":15024,"title":"Callables and `__init__` methods","user":{"login":"Viicos","id":65306057,"node_id":"MDQ6VXNlcjY1MzA2MDU3","avatar_url":"https://avatars.githubusercontent.com/u/65306057?v=4","gravatar_id":"","url":"https://api.github.com/users/Viicos","html_url":"https://github.com/Viicos","followers_url":"https://api.github.com/users/Viicos/followers","following_url":"https://api.github.com/users/Viicos/following{/other_user}","gists_url":"https://api.github.com/users/Viicos/gists{/gist_id}","starred_url":"https://api.github.com/users/Viicos/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Viicos/subscriptions","organizations_url":"https://api.github.com/users/Viicos/orgs","repos_url":"https://api.github.com/users/Viicos/repos","events_url":"https://api.github.com/users/Viicos/events{/privacy}","received_events_url":"https://api.github.com/users/Viicos/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":21488356,"node_id":"MDU6TGFiZWwyMTQ4ODM1Ng==","url":"https://api.github.com/repos/python/mypy/labels/bug","name":"bug","color":"f9d0c4","default":true,"description":"mypy got something wrong"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2023-04-09T09:07:50Z","updated_at":"2023-04-14T14:39:08Z","closed_at":"2023-04-14T14:39:08Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"<!--\r\nIf you're not sure whether what you're experiencing is a mypy bug, please see the \"Question and Help\" form instead.\r\nPlease consider:\r\n\r\n- checking our common issues page: https://mypy.readthedocs.io/en/stable/common_issues.html\r\n- searching our issue tracker: https://github.com/python/mypy/issues to see if it's already been reported\r\n- asking on gitter chat: https://gitter.im/python/typing\r\n-->\r\n\r\n**Bug Report**\r\n\r\nI am currently working on https://github.com/encode/starlette/pull/1987 where I'm defining a type hint for an [argument](https://github.com/encode/starlette/blob/54cc128f924dbca7916dad9afd5243a0d58f8ab4/starlette/middleware/__init__.py#L7) that can take either a type of a class having a `__call__` method, or a callable returning another callable. That is, both definitions work:\r\n\r\n```python\r\nclass ASGIMiddleware:\r\n    def __init__(app: ASGIApp, p0: str, p1: int) -> None:\r\n        ...\r\n    async def __call__(self, scope, receive, send) -> None:\r\n        ...\r\n# or\r\ndef asgi_middleware(app, p0: str, p1: int) -> ASGIApp:\r\n    async def _asgi(scope, receive, send) -> None:\r\n        ...\r\n    return _asgi\r\n```\r\n\r\nI was told that the following protocol would support both:\r\n\r\n```python\r\nclass MiddlewareType(Protocol):\r\n    def __call__(self, app: ASGIApp, **options: Any) -> ASGIApp:\r\n        ...\r\n```\r\nWith the class definition, the `__init__` method is checked against the `__call__` method of `MiddlewareType`, and with the callable definition, well it is checked against the `__call__` method naturally. I was surprised to see that mypy supported the first case, as it was unclear to me what was the correct definition of a `callable` (in fact, definitions differ in docs):\r\n\r\n- https://docs.python.org/3/library/functions.html#callable\r\n> Return [True](https://docs.python.org/3/library/constants.html#True) if the object argument appears callable, [False](https://docs.python.org/3/library/constants.html#False) if not. If this returns `True`, it is still possible that a call fails, but if it is `False`, calling _object_ will never succeed. Note that classes are callable (calling a class returns a new instance); instances are callable if their class has a `__call__()` method.\r\n\r\n- https://docs.python.org/3/library/typing.html#typing.Callable\r\n> Callable type; `Callable[[int], str]` is a function of (int) -> str.\r\n\r\n- https://docs.python.org/3/library/collections.abc.html#collections.abc.Callable\r\n> ABC for classes that provide the `__call__()` method.\r\n\r\nNow if this behaviour is supported by `mypy`, maybe this could be clarified in [this part](https://mypy.readthedocs.io/en/stable/protocols.html#callback-protocols) of the docs?\r\n\r\nI've made this issue a bug report as I'm still struggling to have the `MiddlewareType` type working, as `**options: typing.Any` doesn't seem to catch the args/kwargs following `app: ASGIApp`.\r\n\r\nSee this mypy-play example:\r\n\r\nhttps://mypy-play.net/?mypy=0.991&python=3.11&gist=49f042e0c90bdaf202e519bd1467ce3a (works on `0.991`)\r\nhttps://mypy-play.net/?mypy=1.1.1&python=3.11&gist=6c7629c60546af1490ba092821564d63 (doesn't work since `1.0.0`)\r\n\r\nThe last example is also returning a misleading error message:\r\n\r\n```sh\r\nmain.py:24: note: Following member(s) of \"ExampleMiddleware\" have conflicts:\r\nmain.py:24: note:     Expected:\r\nmain.py:24: note:         def __call__(app: int, **options: Any) -> Callable[[str], None]\r\nmain.py:24: note:     Got:\r\nmain.py:24: note:         def __call__(self: ExampleMiddleware, el: str) -> None  # should be: def __init__(self, app: int, other_arg: Any) -> None:\r\n```\r\n\r\n**Your Environment**\r\n\r\n<!-- Include as many relevant details about the environment you experienced the bug in -->\r\n\r\n- Mypy version used: 0.991 / > 1.0.0\r\n- Mypy command-line flags: None\r\n- Mypy configuration options from `mypy.ini` (and other config files):\r\n- Python version used: 3.9 / 3.10 / 3.11\r\n\r\n<!-- You can freely edit this text, please remove all the lines you believe are unnecessary. -->\r\n","closed_by":{"login":"JukkaL","id":1107911,"node_id":"MDQ6VXNlcjExMDc5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/1107911?v=4","gravatar_id":"","url":"https://api.github.com/users/JukkaL","html_url":"https://github.com/JukkaL","followers_url":"https://api.github.com/users/JukkaL/followers","following_url":"https://api.github.com/users/JukkaL/following{/other_user}","gists_url":"https://api.github.com/users/JukkaL/gists{/gist_id}","starred_url":"https://api.github.com/users/JukkaL/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JukkaL/subscriptions","organizations_url":"https://api.github.com/users/JukkaL/orgs","repos_url":"https://api.github.com/users/JukkaL/repos","events_url":"https://api.github.com/users/JukkaL/events{/privacy}","received_events_url":"https://api.github.com/users/JukkaL/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/python/mypy/issues/15024/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/python/mypy/issues/15024/timeline","performed_via_github_app":null,"state_reason":"completed"}