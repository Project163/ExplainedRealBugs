{"url":"https://api.github.com/repos/python/mypy/issues/13536","repository_url":"https://api.github.com/repos/python/mypy","labels_url":"https://api.github.com/repos/python/mypy/issues/13536/labels{/name}","comments_url":"https://api.github.com/repos/python/mypy/issues/13536/comments","events_url":"https://api.github.com/repos/python/mypy/issues/13536/events","html_url":"https://github.com/python/mypy/issues/13536","id":1353174070,"node_id":"I_kwDOAGuhRc5Qp8w2","number":13536,"title":"Crash with nested partial type","user":{"login":"cdce8p","id":30130371,"node_id":"MDQ6VXNlcjMwMTMwMzcx","avatar_url":"https://avatars.githubusercontent.com/u/30130371?v=4","gravatar_id":"","url":"https://api.github.com/users/cdce8p","html_url":"https://github.com/cdce8p","followers_url":"https://api.github.com/users/cdce8p/followers","following_url":"https://api.github.com/users/cdce8p/following{/other_user}","gists_url":"https://api.github.com/users/cdce8p/gists{/gist_id}","starred_url":"https://api.github.com/users/cdce8p/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cdce8p/subscriptions","organizations_url":"https://api.github.com/users/cdce8p/orgs","repos_url":"https://api.github.com/users/cdce8p/repos","events_url":"https://api.github.com/users/cdce8p/events{/privacy}","received_events_url":"https://api.github.com/users/cdce8p/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":379446833,"node_id":"MDU6TGFiZWwzNzk0NDY4MzM=","url":"https://api.github.com/repos/python/mypy/labels/crash","name":"crash","color":"b60205","default":false,"description":null},{"id":513232516,"node_id":"MDU6TGFiZWw1MTMyMzI1MTY=","url":"https://api.github.com/repos/python/mypy/labels/priority-0-high","name":"priority-0-high","color":"fbca04","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-08-27T21:48:54Z","updated_at":"2022-08-28T07:27:01Z","closed_at":"2022-08-28T00:58:09Z","author_association":"COLLABORATOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Crash Report**\r\n\r\nStumbled across this one while testing the latest master commit on Home Assistant (with dependencies).\r\nA dependency (https://github.com/caronc/apprise) uses the pattern below which results in a crash.\r\n\r\nI bisected the issue to the changes in #13494.\r\n\r\nDirect link to the line which causes the crash:\r\nhttps://github.com/caronc/apprise/blob/v1.0.0/apprise/decorators/CustomNotifyPlugin.py#L148\r\n\r\n**Traceback**\r\n\r\n```\r\n(venv-39) $ mypy --show-traceback --no-incremental test.py\r\ntest.py:9: error: INTERNAL ERROR -- Please try using mypy master on GitHub:\r\nhttps://mypy.readthedocs.io/en/stable/common_issues.html#using-a-development-mypy-build\r\nPlease report a bug at https://github.com/python/mypy/issues\r\nversion: 0.980+dev.be495c72f551fe94748edafacc747eb07b252f5c\r\nTraceback (most recent call last):\r\n  ...\r\n  File \".../mypy/mypy/subtypes.py\", line 888, in visit_partial_type\r\n    raise RuntimeError(f'Partial type \"{left}\" cannot be checked with \"issubtype()\"')\r\nRuntimeError: Partial type \"<partial dict[?, ?]>\" cannot be checked with \"issubtype()\"\r\ntest.py:9: : note: use --pdb to drop into pdb\r\n```\r\n\r\n<details>\r\n<summary>Full traceback</summary>\r\n\r\n```\r\n(venv-39) $ mypy --show-traceback --no-incremental test.py\r\ntest.py:9: error: INTERNAL ERROR -- Please try using mypy master on GitHub:\r\nhttps://mypy.readthedocs.io/en/stable/common_issues.html#using-a-development-mypy-build\r\nPlease report a bug at https://github.com/python/mypy/issues\r\nversion: 0.980+dev.be495c72f551fe94748edafacc747eb07b252f5c\r\nTraceback (most recent call last):\r\n  File \".../venv-39/bin/mypy\", line 8, in <module>\r\n    sys.exit(console_entry())\r\n  File \".../mypy/mypy/__main__.py\", line 15, in console_entry\r\n    main()\r\n  File \".../mypy/mypy/main.py\", line 95, in main\r\n    res, messages, blockers = run_build(sources, options, fscache, t0, stdout, stderr)\r\n  File \".../mypy/mypy/main.py\", line 174, in run_build\r\n    res = build.build(sources, options, None, flush_errors, fscache, stdout, stderr)\r\n  File \".../mypy/mypy/build.py\", line 186, in build\r\n    result = _build(\r\n  File \".../mypy/mypy/build.py\", line 269, in _build\r\n    graph = dispatch(sources, manager, stdout)\r\n  File \".../mypy/mypy/build.py\", line 2875, in dispatch\r\n    process_graph(graph, manager)\r\n  File \".../mypy/mypy/build.py\", line 3259, in process_graph\r\n    process_stale_scc(graph, scc, manager)\r\n  File \".../mypy/mypy/build.py\", line 3360, in process_stale_scc\r\n    graph[id].type_check_first_pass()\r\n  File \".../mypy/mypy/build.py\", line 2302, in type_check_first_pass\r\n    self.type_checker().check_first_pass()\r\n  File \".../mypy/mypy/checker.py\", line 461, in check_first_pass\r\n    self.accept(d)\r\n  File \".../mypy/mypy/checker.py\", line 569, in accept\r\n    stmt.accept(self)\r\n  File \".../mypy/mypy/nodes.py\", line 1131, in accept\r\n    return visitor.visit_class_def(self)\r\n  File \".../mypy/mypy/checker.py\", line 2035, in visit_class_def\r\n    self.accept(defn.defs)\r\n  File \".../mypy/mypy/checker.py\", line 569, in accept\r\n    stmt.accept(self)\r\n  File \".../mypy/mypy/nodes.py\", line 1206, in accept\r\n    return visitor.visit_block(self)\r\n  File \".../mypy/mypy/checker.py\", line 2415, in visit_block\r\n    self.accept(s)\r\n  File \".../mypy/mypy/checker.py\", line 569, in accept\r\n    stmt.accept(self)\r\n  File \".../mypy/mypy/nodes.py\", line 908, in accept\r\n    return visitor.visit_decorator(self)\r\n  File \".../mypy/mypy/checker.py\", line 4333, in visit_decorator\r\n    self.check_func_item(e.func, name=e.func.name)\r\n  File \".../mypy/mypy/checker.py\", line 1000, in check_func_item\r\n    self.check_func_def(defn, typ, name)\r\n  File \".../mypy/mypy/checker.py\", line 1186, in check_func_def\r\n    self.accept(item.body)\r\n  File \".../mypy/mypy/checker.py\", line 569, in accept\r\n    stmt.accept(self)\r\n  File \".../mypy/mypy/nodes.py\", line 1206, in accept\r\n    return visitor.visit_block(self)\r\n  File \".../mypy/mypy/checker.py\", line 2415, in visit_block\r\n    self.accept(s)\r\n  File \".../mypy/mypy/checker.py\", line 569, in accept\r\n    stmt.accept(self)\r\n  File \".../mypy/mypy/nodes.py\", line 1131, in accept\r\n    return visitor.visit_class_def(self)\r\n  File \".../mypy/mypy/checker.py\", line 2035, in visit_class_def\r\n    self.accept(defn.defs)\r\n  File \".../mypy/mypy/checker.py\", line 569, in accept\r\n    stmt.accept(self)\r\n  File \".../mypy/mypy/nodes.py\", line 1206, in accept\r\n    return visitor.visit_block(self)\r\n  File \".../mypy/mypy/checker.py\", line 2415, in visit_block\r\n    self.accept(s)\r\n  File \".../mypy/mypy/checker.py\", line 569, in accept\r\n    stmt.accept(self)\r\n  File \".../mypy/mypy/nodes.py\", line 1289, in accept\r\n    return visitor.visit_assignment_stmt(self)\r\n  File \".../mypy/mypy/checker.py\", line 2462, in visit_assignment_stmt\r\n    self.check_assignment(s.lvalues[-1], s.rvalue, s.type is None, s.new_syntax)\r\n  File \".../mypy/mypy/checker.py\", line 2683, in check_assignment\r\n    type_context = self.get_variable_type_context(inferred)\r\n  File \".../mypy/mypy/checker.py\", line 2712, in get_variable_type_context\r\n    elif not is_subtype(candidate, other):\r\n  File \".../mypy/mypy/subtypes.py\", line 178, in is_subtype\r\n    return _is_subtype(left, right, subtype_context, proper_subtype=False)\r\n  File \".../mypy/mypy/subtypes.py\", line 328, in _is_subtype\r\n    return left.accept(SubtypeVisitor(orig_right, subtype_context, proper_subtype))\r\n  File \".../mypy/mypy/types.py\", line 2618, in accept\r\n    return visitor.visit_partial_type(self)\r\n  File \".../mypy/mypy/subtypes.py\", line 888, in visit_partial_type\r\n    raise RuntimeError(f'Partial type \"{left}\" cannot be checked with \"issubtype()\"')\r\nRuntimeError: Partial type \"<partial dict[?, ?]>\" cannot be checked with \"issubtype()\"\r\ntest.py:9: : note: use --pdb to drop into pdb\r\n```\r\n</details>\r\n\r\n**To Reproduce**\r\n\r\n```py\r\nclass A:\r\n    args = {}\r\n\r\n    @staticmethod\r\n    def f():\r\n        value = {1: \"Hello\"}\r\n\r\n        class B(A):\r\n            args = value  # <-- crash\r\n```\r\n\r\n**Expected**\r\n```\r\ntest.py:2: error: Need type annotation for \"args\" (hint: \"args: Dict[<type>, <type>] = ...\")\r\n```\r\n\r\n**Your Environment**\r\n\r\n<!-- Include as many relevant details about the environment you experienced the bug in -->\r\n\r\n- Mypy version used: `mypy 0.980+dev.09b8b550abe3982726047cc0ed68a9b6fa91745c (compiled: no)` (latest master)\r\n- Python version used: `3.9`","closed_by":{"login":"ilevkivskyi","id":12005495,"node_id":"MDQ6VXNlcjEyMDA1NDk1","avatar_url":"https://avatars.githubusercontent.com/u/12005495?v=4","gravatar_id":"","url":"https://api.github.com/users/ilevkivskyi","html_url":"https://github.com/ilevkivskyi","followers_url":"https://api.github.com/users/ilevkivskyi/followers","following_url":"https://api.github.com/users/ilevkivskyi/following{/other_user}","gists_url":"https://api.github.com/users/ilevkivskyi/gists{/gist_id}","starred_url":"https://api.github.com/users/ilevkivskyi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ilevkivskyi/subscriptions","organizations_url":"https://api.github.com/users/ilevkivskyi/orgs","repos_url":"https://api.github.com/users/ilevkivskyi/repos","events_url":"https://api.github.com/users/ilevkivskyi/events{/privacy}","received_events_url":"https://api.github.com/users/ilevkivskyi/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/python/mypy/issues/13536/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/python/mypy/issues/13536/timeline","performed_via_github_app":null,"state_reason":"completed"}