{"url":"https://api.github.com/repos/python/mypy/issues/18216","repository_url":"https://api.github.com/repos/python/mypy","labels_url":"https://api.github.com/repos/python/mypy/issues/18216/labels{/name}","comments_url":"https://api.github.com/repos/python/mypy/issues/18216/comments","events_url":"https://api.github.com/repos/python/mypy/issues/18216/events","html_url":"https://github.com/python/mypy/issues/18216","id":2707658406,"node_id":"I_kwDOAGuhRc6hY5am","number":18216,"title":"Dataclasses, `__replace__` and LSP violations","user":{"login":"Viicos","id":65306057,"node_id":"MDQ6VXNlcjY1MzA2MDU3","avatar_url":"https://avatars.githubusercontent.com/u/65306057?v=4","gravatar_id":"","url":"https://api.github.com/users/Viicos","html_url":"https://github.com/Viicos","followers_url":"https://api.github.com/users/Viicos/followers","following_url":"https://api.github.com/users/Viicos/following{/other_user}","gists_url":"https://api.github.com/users/Viicos/gists{/gist_id}","starred_url":"https://api.github.com/users/Viicos/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Viicos/subscriptions","organizations_url":"https://api.github.com/users/Viicos/orgs","repos_url":"https://api.github.com/users/Viicos/repos","events_url":"https://api.github.com/users/Viicos/events{/privacy}","received_events_url":"https://api.github.com/users/Viicos/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":21488358,"node_id":"MDU6TGFiZWwyMTQ4ODM1OA==","url":"https://api.github.com/repos/python/mypy/labels/feature","name":"feature","color":"84b6eb","default":false,"description":null},{"id":46131301,"node_id":"MDU6TGFiZWw0NjEzMTMwMQ==","url":"https://api.github.com/repos/python/mypy/labels/needs%20discussion","name":"needs discussion","color":"bfdadc","default":false,"description":null},{"id":3945206226,"node_id":"LA_kwDOAGuhRc7rJxHS","url":"https://api.github.com/repos/python/mypy/labels/topic-dataclasses","name":"topic-dataclasses","color":"8E9730","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2024-11-30T16:57:44Z","updated_at":"2025-06-20T08:20:59Z","closed_at":"2025-01-14T22:38:48Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"In 3.13, the [`__replace__()`](https://docs.python.org/3/library/copy.html#object.__replace__) protocol was added in Python, allowing arbitrary classes to define the method so that [`copy.replace()`](https://docs.python.org/3/library/copy.html#copy.replace) can call it to perform the copy. Along with this feature, dataclasses (and as such, [applies to](https://typing.readthedocs.io/en/latest/spec/dataclasses.html#dataclass-semantics) `@dataclass_transform()` as well) have the `__replace__` method created.\n\nType checkers (at least mypy and pyright) synthesize a `__replace__()` method (like they do for `__init__()`) depending on the defined fields. A common pattern when using dataclasses is to override a field with a more precise type:\n\n```python\nfrom typing import Literal\n\nfrom dataclasses import dataclass, field\n\n@dataclass\nclass Base:\n    foo: str\n    \n\n@dataclass\nclass Sub(Base):\n    foo: Literal[\"test\"]\n```\n\nWhile this code is technically unsafe, mypy does not raise any error unless you enable the [`mutable-override`](https://mypy.readthedocs.io/en/stable/error_code_list2.html#check-that-overrides-of-mutable-attributes-are-safe-mutable-override) error code. Note that this error code isn't even enabled in strict mode.\n\nHowever, mypy (if the configured Python version is 3.13 or greater) will emit an error regarding the LSP violation for the synthesized `__replace__()` method ([playground](https://mypy-play.net/?mypy=latest&python=3.13&gist=c046257e3556c4c13a9e982a2b5cf528)). \n\nI believe this is confusing/annoying for users, because:\n- I expect the vast majority of users to not know about the LSP principle, nor the `__replace__()` protocol. It is also confusing to see an error poping about this method when it is not defined by the end user.\n- Users might not care about the replace protocol at all.\n- There's no way to ignore the error (or maybe there is but I don't know any way to do so), as no line number is provided in the error (because the `__replace__()` method is synthesized).\n\nIn contrast, while pyright emits an error for the incompatible field override [^1] (essentially doing the same thing as mypy if [`mutable-override`](https://mypy.readthedocs.io/en/stable/error_code_list2.html#check-that-overrides-of-mutable-attributes-are-safe-mutable-override) were to be enabled), it doesn't raise anything related to the `__replace__()` LSP violation.\n\nIn Pydantic, we got a [first report](https://github.com/pydantic/pydantic/issues/10699) about this issue on Oct 24, about two weeks after the final 3.13 release. We also got a [similar report](https://github.com/pydantic/pydantic/issues/11009) today, this time when using aliases. I've raised this [discussion](https://discuss.python.org/t/dataclass-transform-and-replace/69067) a while ago, and commented on the fact that from a practical perspective, this isn't ideal.\n\nHere are a couple ideas to go forward:\n- mypy does not emit any violation regarding the synthesized `__replace__()` method.\n- mypy only emits a violation regarding the synthesized `__replace__()` method if the [`mutable-override`](https://mypy.readthedocs.io/en/stable/error_code_list2.html#check-that-overrides-of-mutable-attributes-are-safe-mutable-override) error code is enabled.\n\nI would personally go with option one, especially because while synthesizing a `__replace__()` method makes sense, it does not provide any benefit. Users should not call this method directly, and instead use `copy.replace`, which isn't special cased by any type checker as of today (i.e. you don't get any errors if you don't provide the correct arguments to the `copy.replace()` function).\n\n\n[^1]: This was debated at length [here](https://github.com/microsoft/pyright/issues/5933).","closed_by":{"login":"ilevkivskyi","id":12005495,"node_id":"MDQ6VXNlcjEyMDA1NDk1","avatar_url":"https://avatars.githubusercontent.com/u/12005495?v=4","gravatar_id":"","url":"https://api.github.com/users/ilevkivskyi","html_url":"https://github.com/ilevkivskyi","followers_url":"https://api.github.com/users/ilevkivskyi/followers","following_url":"https://api.github.com/users/ilevkivskyi/following{/other_user}","gists_url":"https://api.github.com/users/ilevkivskyi/gists{/gist_id}","starred_url":"https://api.github.com/users/ilevkivskyi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ilevkivskyi/subscriptions","organizations_url":"https://api.github.com/users/ilevkivskyi/orgs","repos_url":"https://api.github.com/users/ilevkivskyi/repos","events_url":"https://api.github.com/users/ilevkivskyi/events{/privacy}","received_events_url":"https://api.github.com/users/ilevkivskyi/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/python/mypy/issues/18216/reactions","total_count":4,"+1":3,"-1":1,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/python/mypy/issues/18216/timeline","performed_via_github_app":null,"state_reason":"completed"}