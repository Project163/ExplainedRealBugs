{"url":"https://api.github.com/repos/python/mypy/issues/14638","repository_url":"https://api.github.com/repos/python/mypy","labels_url":"https://api.github.com/repos/python/mypy/issues/14638/labels{/name}","comments_url":"https://api.github.com/repos/python/mypy/issues/14638/comments","events_url":"https://api.github.com/repos/python/mypy/issues/14638/events","html_url":"https://github.com/python/mypy/issues/14638","id":1574829374,"node_id":"I_kwDOAGuhRc5d3f0-","number":14638,"title":"Generic typeddict may corrupt the cache","user":{"login":"Synss","id":540976,"node_id":"MDQ6VXNlcjU0MDk3Ng==","avatar_url":"https://avatars.githubusercontent.com/u/540976?v=4","gravatar_id":"","url":"https://api.github.com/users/Synss","html_url":"https://github.com/Synss","followers_url":"https://api.github.com/users/Synss/followers","following_url":"https://api.github.com/users/Synss/following{/other_user}","gists_url":"https://api.github.com/users/Synss/gists{/gist_id}","starred_url":"https://api.github.com/users/Synss/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Synss/subscriptions","organizations_url":"https://api.github.com/users/Synss/orgs","repos_url":"https://api.github.com/users/Synss/repos","events_url":"https://api.github.com/users/Synss/events{/privacy}","received_events_url":"https://api.github.com/users/Synss/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":21488356,"node_id":"MDU6TGFiZWwyMTQ4ODM1Ng==","url":"https://api.github.com/repos/python/mypy/labels/bug","name":"bug","color":"f9d0c4","default":true,"description":"mypy got something wrong"},{"id":354997184,"node_id":"MDU6TGFiZWwzNTQ5OTcxODQ=","url":"https://api.github.com/repos/python/mypy/labels/topic-incremental","name":"topic-incremental","color":"006b75","default":false,"description":null},{"id":488169816,"node_id":"MDU6TGFiZWw0ODgxNjk4MTY=","url":"https://api.github.com/repos/python/mypy/labels/topic-typed-dict","name":"topic-typed-dict","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2023-02-07T18:25:03Z","updated_at":"2023-02-14T13:49:28Z","closed_at":"2023-02-14T13:49:28Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"<!--\r\nIf you're not sure whether what you're experiencing is a mypy bug, please see the \"Question and Help\" form instead.\r\nPlease consider:\r\n\r\n- checking our common issues page: https://mypy.readthedocs.io/en/stable/common_issues.html\r\n- searching our issue tracker: https://github.com/python/mypy/issues to see if it's already been reported\r\n- asking on gitter chat: https://gitter.im/python/typing\r\n-->\r\n\r\n**Bug Report**\r\n\r\n<!--\r\nIf you're reporting a problem with a specific library function, the typeshed tracker is better suited for this report: https://github.com/python/typeshed/issues\r\n\r\nIf the project you encountered the issue in is open source, please provide a link to the project.\r\n-->\r\n\r\nUsing a generic `TypedDict` in another module may corrupt the cache. The cache doesn't recover and must be deleted.\r\n\r\n**To Reproduce**\r\n\r\nIn module `a`, define a generic `TypedDict`,\r\n\r\n```python\r\n# a.py\r\nfrom typing import TypedDict, Generic, TypeVar\r\n\r\nTValue = TypeVar(\"TValue\")\r\n\r\n\r\nclass Dict(TypedDict, Generic[TValue]):\r\n    value: TValue\r\n\r\n```\r\n\r\nin another module (say `b`) use this definition.  The easiest way to trigger the bug is to have at least one typing error in the file (here `g()`).\r\n\r\n```python\r\n# b.py\r\nfrom a import Dict, TValue\r\n\r\ndef f(d: Dict[TValue]) -> TValue:\r\n    return d[\"value\"]\r\n\r\n\r\ndef g(d: Dict[TValue]) -> TValue:\r\n    return d[\"x\"]  # error\r\n```\r\n\r\nNow, type check `b`\r\n\r\n```\r\n$ mypy b.py\r\nb.py:8: error: TypedDict \"a.Dict[TValue]\" has no key \"x\"  [typeddict-item]\r\nFound 1 error in 1 file (checked 1 source file)\r\n```\r\n\r\nas expected.\r\n\r\nHowever, running `mypy b.py` **a second time** reports an extra `[type-arg]` and a few more related errors as well,\r\n\r\n```\r\n$ mypy b.py\r\nb.py:3: error: \"Dict\" expects no type arguments, but 1 given  [type-arg]\r\nb.py:3: error: A function returning TypeVar should receive at least one argument containing the same TypeVar  [type-var]\r\nb.py:4: error: Incompatible return value type (got \"TValue\", expected \"TValue\")  [return-value]\r\nb.py:7: error: \"Dict\" expects no type arguments, but 1 given  [type-arg]\r\nb.py:7: error: A function returning TypeVar should receive at least one argument containing the same TypeVar  [type-var]\r\nb.py:8: error: TypedDict \"a.Dict[TValue]\" has no key \"x\"  [typeddict-item]\r\nFound 6 errors in 1 file (checked 1 source file)\r\n```\r\n\r\nfrom then on, the only way to get rid of the `[type-arg]` error is to run with `--no-increment` or delete the cache. Here, I removed `g()`, leaving\r\n\r\n```python\r\n# b.py [edited: deleted definition of g()]\r\nfrom a import Dict, TValue\r\n\r\ndef f(d: Dict[TValue]) -> TValue:\r\n    return d[\"value\"]\r\n```\r\n\r\nand\r\n```\r\n$ mypy b.py\r\nb.py:3: error: \"Dict\" expects no type arguments, but 1 given  [type-arg]\r\nb.py:3: error: A function returning TypeVar should receive at least one argument containing the same TypeVar  [type-var]\r\nb.py:4: error: Incompatible return value type (got \"TValue\", expected \"TValue\")  [return-value]\r\nFound 3 errors in 1 file (checked 1 source file)\r\n```\r\n\r\nbut\r\n\r\n```\r\n$ mypy --no-increment b.py\r\nSuccess: no issues found in 1 source file\r\n```\r\n\r\n**Expected Behavior**\r\n\r\n<!--\r\nHow did you expect mypy to behave? It’s fine if you’re not sure your understanding is correct.\r\nWrite down what you thought would happen. If you expected no errors, delete this section.\r\n-->\r\n\r\nNo difference between `mypy`, `mypy --no-increment` and the generic `TypedDict` do not corrupt the cache.\r\n\r\n**Actual Behavior**\r\n\r\n<!-- What went wrong? Paste mypy's output. -->\r\n\r\nmypy reports false positives\r\n```\r\nb.py:3: error: \"Dict\" expects no type arguments, but 1 given  [type-arg]\r\nb.py:3: error: A function returning TypeVar should receive at least one argument containing the same TypeVar  [type-var]\r\nb.py:4: error: Incompatible return value type (got \"TValue\", expected \"TValue\")  [return-value]\r\n```\r\n\r\n**Your Environment**\r\n\r\n<!-- Include as many relevant details about the environment you experienced the bug in -->\r\n\r\n- Mypy version used: 0.991, 1.0.0, master\r\n- Mypy command-line flags: `mypy` vs. `mypy --no-increment`\r\n- Mypy configuration options from `mypy.ini` (and other config files): none\r\n- Python version used: 3.11 or importing `TypedDict` from `mypy_extensions` on Python 3.10.\r\n\r\nI could also reproduce that under Linux (Ubuntu 22.04) and MacOS (M1---Python installed via MacPorts).","closed_by":{"login":"JukkaL","id":1107911,"node_id":"MDQ6VXNlcjExMDc5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/1107911?v=4","gravatar_id":"","url":"https://api.github.com/users/JukkaL","html_url":"https://github.com/JukkaL","followers_url":"https://api.github.com/users/JukkaL/followers","following_url":"https://api.github.com/users/JukkaL/following{/other_user}","gists_url":"https://api.github.com/users/JukkaL/gists{/gist_id}","starred_url":"https://api.github.com/users/JukkaL/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JukkaL/subscriptions","organizations_url":"https://api.github.com/users/JukkaL/orgs","repos_url":"https://api.github.com/users/JukkaL/repos","events_url":"https://api.github.com/users/JukkaL/events{/privacy}","received_events_url":"https://api.github.com/users/JukkaL/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/python/mypy/issues/14638/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/python/mypy/issues/14638/timeline","performed_via_github_app":null,"state_reason":"completed"}