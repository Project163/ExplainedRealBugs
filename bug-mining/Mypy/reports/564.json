{"url":"https://api.github.com/repos/python/mypy/issues/19037","repository_url":"https://api.github.com/repos/python/mypy","labels_url":"https://api.github.com/repos/python/mypy/issues/19037/labels{/name}","comments_url":"https://api.github.com/repos/python/mypy/issues/19037/comments","events_url":"https://api.github.com/repos/python/mypy/issues/19037/events","html_url":"https://github.com/python/mypy/issues/19037","id":3040331878,"node_id":"I_kwDOAGuhRc61N8hm","number":19037,"title":"Empty vs filled cache inconsistency for google-cloud-logging & google-cloud-pubsub together with `type: ignore` comments","user":{"login":"sh-at-cs","id":112704226,"node_id":"U_kgDOBre64g","avatar_url":"https://avatars.githubusercontent.com/u/112704226?v=4","gravatar_id":"","url":"https://api.github.com/users/sh-at-cs","html_url":"https://github.com/sh-at-cs","followers_url":"https://api.github.com/users/sh-at-cs/followers","following_url":"https://api.github.com/users/sh-at-cs/following{/other_user}","gists_url":"https://api.github.com/users/sh-at-cs/gists{/gist_id}","starred_url":"https://api.github.com/users/sh-at-cs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sh-at-cs/subscriptions","organizations_url":"https://api.github.com/users/sh-at-cs/orgs","repos_url":"https://api.github.com/users/sh-at-cs/repos","events_url":"https://api.github.com/users/sh-at-cs/events{/privacy}","received_events_url":"https://api.github.com/users/sh-at-cs/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":21488356,"node_id":"MDU6TGFiZWwyMTQ4ODM1Ng==","url":"https://api.github.com/repos/python/mypy/labels/bug","name":"bug","color":"f9d0c4","default":true,"description":"mypy got something wrong"},{"id":354997184,"node_id":"MDU6TGFiZWwzNTQ5OTcxODQ=","url":"https://api.github.com/repos/python/mypy/labels/topic-incremental","name":"topic-incremental","color":"006b75","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2025-05-05T17:32:01Z","updated_at":"2025-05-07T15:59:52Z","closed_at":"2025-05-07T15:59:52Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"\n<!--\nIf you're not sure whether what you're experiencing is a mypy bug, please see the \"Question and Help\" form instead.\nPlease consider:\n\n- checking our common issues page: https://mypy.readthedocs.io/en/stable/common_issues.html\n- searching our issue tracker: https://github.com/python/mypy/issues to see if it's already been reported\n- asking on gitter chat: https://gitter.im/python/typing\n-->\n\n**Bug Report**\n\nRunning Mypy on a certain set of files (see below) that import things from both the `google-cloud-logging` and `google-cloud-pubsub` packages with some `# type: ignore` comments applied results in different type checking outcomes (failure vs success) depending on whether the cache has been populated or not.\n\n<!--\nIf you're reporting a problem with a specific library function, the typeshed tracker is better suited for this report: https://github.com/python/typeshed/issues\n\nIf the project you encountered the issue in is open source, please provide a link to the project.\n-->\n\n**To Reproduce**\n\n‚ùó **Note:** There is a **bash script at the end of this section** to make reproducing this more convenient!\n\n1) Create a package `bug` with an `__init__.py` and these two files:\n\n`foo.py`:\n```python\nimport google.cloud.logging\n\nclient = google.cloud.logging.Client()  # type: ignore[no-untyped-call]\n```\n\n`bar.py`:\n```python\nfrom google.cloud.pubsub_v1 import PublisherClient  # type: ignore[import-untyped]\n\npublisher: PublisherClient = PublisherClient()\n```\n\n2) Create a venv with `mypy`, `google-cloud-logging`, and `google-cloud-pubsub` installed.\n\n3) Ensure there is no `.mypy_cache` dir present.\n\n3) Run `mypy --strict bug/` twice.\n\n<details>\n<summary><b>‚ùó Script to perform all these steps automatically</b></summary>\n\nNeeds `uv` to be installed.\n\n```bash\n#!/bin/bash\n\n# Prepare directory:\n\nrm -rf bug/ .mypy_cache/\n\nmkdir bug\ntouch bug/__init__.py\n\ncat > bug/foo.py <<HEREDOC\nimport google.cloud.logging\n\nclient = google.cloud.logging.Client()  # type: ignore[no-untyped-call]\nHEREDOC\n\ncat > bug/bar.py <<HEREDOC\nfrom google.cloud.pubsub_v1 import PublisherClient  # type: ignore[import-untyped]\n\npublisher: PublisherClient = PublisherClient()\nHEREDOC\n\n# Run Mypy:\n\nMYPY=\"uv run --with google-cloud-logging,google-cloud-pubsub,mypy mypy\"\n\necho \"***** Version info: *****\"\n$MYPY --version\n\necho \"***** First invocation: *****\"\n$MYPY --strict bug/\n\necho \"***** Second invocation: *****\"\n$MYPY --strict bug/\n```\n\n</details>\n\n**Expected Behavior**\n\nBoth `mypy` invocations result in the same outcome.\n\n<!--\nHow did you expect mypy to behave? It‚Äôs fine if you‚Äôre not sure your understanding is correct.\nWrite down what you thought would happen. If you expected no errors, delete this section.\n-->\n\n**Actual Behavior**\n\nThe **first** invocation reports some errors:\n\n```console\n$ mypy --strict bug/\nbug/foo.py:1: error: Skipping analyzing \"google.cloud\": module is installed, but missing library stubs or py.typed marker  [import-untyped]\nbug/foo.py:1: note: See https://mypy.readthedocs.io/en/stable/running_mypy.html#missing-imports\nbug/foo.py:1: error: Skipping analyzing \"google\": module is installed, but missing library stubs or py.typed marker  [import-untyped]\nbug/foo.py:3: error: Unused \"type: ignore\" comment  [unused-ignore]\nFound 3 errors in 1 file (checked 3 source files)\n```\n\nWhile the **second** invocation reports success:\n\n```console\n$ mypy --strict bug/\nSuccess: no issues found in 3 source files\n```\n\n<!-- What went wrong? Paste mypy's output. -->\n\n**Your Environment**\n\n<!-- Include as many relevant details about the environment you experienced the bug in -->\n\n- Mypy version used: 1.15.0, but I also tried with the current `master` and it's the same\n- Mypy command-line flags: `--strict` to get 1 more error that differs between invocations, but the basic issue also appears without it\n- Mypy configuration options from `mypy.ini` (and other config files): none\n- Python version used: 3.13.2\n\n<!-- You can freely edit this text, please remove all the lines you believe are unnecessary. -->\n\n**Additional Context**\n\n~~I'm actually trying to create a minimal reproducible example for a slightly different, more severe issue involving these two packages, in which there is no possible configuration of `type: ignore` comments (or lack thereof) that satisfies Mypy, but this is proving much more difficult to boil down (only seems to happen in our production repo). My hope is that this issue here is \"related enough\" to it that fixing one will fix both ü§û~~ Never mind, putting `# type: ignore` on all of the imports but none of the usages did satisfy Mypy. But this issue here still made it needlessly difficult to arrive at that solution by trial and error, and it hints at perhaps more general caching bugs, so it should still be fixed IMHO.\n\n**Related Issues**\n\n- https://github.com/python/mypy/issues/10360\n  - Also involves `google-cloud-logging` weirdness.","closed_by":{"login":"JukkaL","id":1107911,"node_id":"MDQ6VXNlcjExMDc5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/1107911?v=4","gravatar_id":"","url":"https://api.github.com/users/JukkaL","html_url":"https://github.com/JukkaL","followers_url":"https://api.github.com/users/JukkaL/followers","following_url":"https://api.github.com/users/JukkaL/following{/other_user}","gists_url":"https://api.github.com/users/JukkaL/gists{/gist_id}","starred_url":"https://api.github.com/users/JukkaL/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JukkaL/subscriptions","organizations_url":"https://api.github.com/users/JukkaL/orgs","repos_url":"https://api.github.com/users/JukkaL/repos","events_url":"https://api.github.com/users/JukkaL/events{/privacy}","received_events_url":"https://api.github.com/users/JukkaL/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/python/mypy/issues/19037/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/python/mypy/issues/19037/timeline","performed_via_github_app":null,"state_reason":"completed"}