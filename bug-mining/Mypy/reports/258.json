{"url":"https://api.github.com/repos/python/mypy/issues/14254","repository_url":"https://api.github.com/repos/python/mypy","labels_url":"https://api.github.com/repos/python/mypy/issues/14254/labels{/name}","comments_url":"https://api.github.com/repos/python/mypy/issues/14254/comments","events_url":"https://api.github.com/repos/python/mypy/issues/14254/events","html_url":"https://github.com/python/mypy/issues/14254","id":1475073289,"node_id":"I_kwDOAGuhRc5X69UJ","number":14254,"title":"AssertionError: Should never get here in normal mode","user":{"login":"hamdanal","id":93259987,"node_id":"U_kgDOBY8I0w","avatar_url":"https://avatars.githubusercontent.com/u/93259987?v=4","gravatar_id":"","url":"https://api.github.com/users/hamdanal","html_url":"https://github.com/hamdanal","followers_url":"https://api.github.com/users/hamdanal/followers","following_url":"https://api.github.com/users/hamdanal/following{/other_user}","gists_url":"https://api.github.com/users/hamdanal/gists{/gist_id}","starred_url":"https://api.github.com/users/hamdanal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hamdanal/subscriptions","organizations_url":"https://api.github.com/users/hamdanal/orgs","repos_url":"https://api.github.com/users/hamdanal/repos","events_url":"https://api.github.com/users/hamdanal/events{/privacy}","received_events_url":"https://api.github.com/users/hamdanal/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":354997184,"node_id":"MDU6TGFiZWwzNTQ5OTcxODQ=","url":"https://api.github.com/repos/python/mypy/labels/topic-incremental","name":"topic-incremental","color":"006b75","default":false,"description":null},{"id":379446833,"node_id":"MDU6TGFiZWwzNzk0NDY4MzM=","url":"https://api.github.com/repos/python/mypy/labels/crash","name":"crash","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-12-04T18:39:44Z","updated_at":"2023-01-22T11:18:06Z","closed_at":"2023-01-22T11:18:06Z","author_association":"COLLABORATOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"<!--\r\n  Use this form only if mypy reports an \"INTERNAL ERROR\" and/or gives a traceback.\r\n  Please include the traceback and all other messages below (use `mypy --show-traceback`).\r\n-->\r\n\r\n**Crash Report**\r\n\r\nThe first run of mypy reports an error normally. The second run crashes with `AssertionError: Should never get here in normal mode`. Clearing the cache with `rm -rf .mypy_cache` prevents the crash in the next run but keeps crashing in the runs after.\r\n\r\nFull reproducer below.\r\n\r\n**Traceback**\r\n\r\n```\r\n$ mypy --ignore-missing-imports t/\r\nTraceback (most recent call last):\r\n  File \"/tmp/venv/bin/mypy\", line 8, in <module>\r\n    sys.exit(console_entry())\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/__main__.py\", line 15, in console_entry\r\n    main()\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/main.py\", line 95, in main\r\n    res, messages, blockers = run_build(sources, options, fscache, t0, stdout, stderr)\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/main.py\", line 174, in run_build\r\n    res = build.build(sources, options, None, flush_errors, fscache, stdout, stderr)\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/build.py\", line 194, in build\r\n    result = _build(\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/build.py\", line 277, in _build\r\n    graph = dispatch(sources, manager, stdout)\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/build.py\", line 2914, in dispatch\r\n    process_graph(graph, manager)\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/build.py\", line 3304, in process_graph\r\n    process_fresh_modules(graph, prev_scc, manager)\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/build.py\", line 3385, in process_fresh_modules\r\n    graph[id].fix_cross_refs()\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/build.py\", line 2120, in fix_cross_refs\r\n    fixup_module(self.tree, self.manager.modules, self.options.use_fine_grained_cache)\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/fixup.py\", line 53, in fixup_module\r\n    node_fixer.visit_symbol_table(tree.names, tree.fullname)\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/fixup.py\", line 125, in visit_symbol_table\r\n    self.visit_type_info(value.node)\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/fixup.py\", line 87, in visit_type_info\r\n    info.declared_metaclass.accept(self.type_fixer)\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/types.py\", line 1316, in accept\r\n    return visitor.visit_instance(self)\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/fixup.py\", line 198, in visit_instance\r\n    inst.type = lookup_fully_qualified_typeinfo(\r\n  File \"/tmp/venv/lib/python3.10/site-packages/mypy/fixup.py\", line 339, in lookup_fully_qualified_typeinfo\r\n    assert (\r\nAssertionError: Should never get here in normal mode, got Var:t.types.Meta instead of TypeInfo\r\n```\r\n\r\n**To Reproduce**\r\n\r\nCreate the following project structure:\r\n```console\r\n$ tree t/\r\nt/\r\n├── file_with_any_type_error.py\r\n├── __init__.py\r\n└── types.py\r\n\r\n0 directories, 3 files\r\n\r\n$ cat t/__init__.py\r\n\r\n$ cat t/types.py\r\nfrom missing_module import Meta\r\n\r\nclass Foo(metaclass=Meta): ...\r\n\r\n$ cat t/file_with_any_type_error.py\r\nx: str\r\nx = 1\r\n```\r\n\r\nRun `mypy --ignore-missing-imports t/` more than one time without deleting the `.mypy_cache` folder.\r\n\r\n**Your Environment**\r\n\r\n<!-- Include as many relevant details about the environment you experienced the bug in -->\r\n\r\n- Mypy version used: $ `mypy 1.0.0+dev.734a0b96b79f20b3290ca5fee97c749ccb2e308f (compiled: no)`\r\n- Mypy command-line flags: `--ignore-missing-imports`\r\n- Mypy configuration options from `mypy.ini` (and other config files): None\r\n- Python version used: `Python 3.10.6 (main, Nov  2 2022, 18:53:38) [GCC 11.3.0]`\r\n- Operating system and version:\r\n  -  OS: `Ubuntu 22.04.1 LTS on Windows 10 x86_64`\r\n  - Kernel: `5.15.74.2-microsoft-standard-WSL2`\r\n\r\n<!--\r\nYou can freely edit this text, please remove all the lines\r\nyou believe are unnecessary.\r\n-->\r\n","closed_by":{"login":"JukkaL","id":1107911,"node_id":"MDQ6VXNlcjExMDc5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/1107911?v=4","gravatar_id":"","url":"https://api.github.com/users/JukkaL","html_url":"https://github.com/JukkaL","followers_url":"https://api.github.com/users/JukkaL/followers","following_url":"https://api.github.com/users/JukkaL/following{/other_user}","gists_url":"https://api.github.com/users/JukkaL/gists{/gist_id}","starred_url":"https://api.github.com/users/JukkaL/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JukkaL/subscriptions","organizations_url":"https://api.github.com/users/JukkaL/orgs","repos_url":"https://api.github.com/users/JukkaL/repos","events_url":"https://api.github.com/users/JukkaL/events{/privacy}","received_events_url":"https://api.github.com/users/JukkaL/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/python/mypy/issues/14254/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/python/mypy/issues/14254/timeline","performed_via_github_app":null,"state_reason":"completed"}