{"url":"https://api.github.com/repos/python/mypy/issues/19346","repository_url":"https://api.github.com/repos/python/mypy","labels_url":"https://api.github.com/repos/python/mypy/issues/19346/labels{/name}","comments_url":"https://api.github.com/repos/python/mypy/issues/19346/comments","events_url":"https://api.github.com/repos/python/mypy/issues/19346/events","html_url":"https://github.com/python/mypy/issues/19346","id":3180230903,"node_id":"I_kwDOAGuhRc69jnj3","number":19346,"title":"mypy tries to follow imports in files with top-level sys.platform asserts on non-matching platforms","user":{"login":"petamasS3D","id":216527618,"node_id":"U_kgDODOfzAg","avatar_url":"https://avatars.githubusercontent.com/u/216527618?v=4","gravatar_id":"","url":"https://api.github.com/users/petamasS3D","html_url":"https://github.com/petamasS3D","followers_url":"https://api.github.com/users/petamasS3D/followers","following_url":"https://api.github.com/users/petamasS3D/following{/other_user}","gists_url":"https://api.github.com/users/petamasS3D/gists{/gist_id}","starred_url":"https://api.github.com/users/petamasS3D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/petamasS3D/subscriptions","organizations_url":"https://api.github.com/users/petamasS3D/orgs","repos_url":"https://api.github.com/users/petamasS3D/repos","events_url":"https://api.github.com/users/petamasS3D/events{/privacy}","received_events_url":"https://api.github.com/users/petamasS3D/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":21488356,"node_id":"MDU6TGFiZWwyMTQ4ODM1Ng==","url":"https://api.github.com/repos/python/mypy/labels/bug","name":"bug","color":"f9d0c4","default":true,"description":"mypy got something wrong"},{"id":3945119299,"node_id":"LA_kwDOAGuhRc7rJb5D","url":"https://api.github.com/repos/python/mypy/labels/topic-reachability","name":"topic-reachability","color":"2EC6A6","default":false,"description":"Detecting unreachable code"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2025-06-26T19:54:08Z","updated_at":"2025-08-30T09:23:26Z","closed_at":"2025-08-30T09:23:26Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Bug Report**\n\nI have a platform-specific script that uses libraries only available on one platform. For the sake of the bug report, I'll use this script:\n\n```\nimport mslex\nimport winreg\nfrom ctypes import WinError\n\nwindir = winreg.ExpandEnvironmentStrings(\"%windir%\")\nprint(mslex.quote(windir))\nraise WinError()\n```\n\nWith the following `requirements.txt`:\n```\nmslex==1.3.0 ; sys_platform==\"win32\"\nmypy==1.16.1\n```\n\nThe script needs three different kinds of Windows-specific functionality:\n- A Windows-specific function from a cross-platform builtin module (`ctypes.WinError`)\n- A Windows-specific builtin module (`winreg`)\n- A thirdparty module from PyPI, that I'm only installing on Windows (`mslex`)\n\nI'm currently working on macOS. If I run mypy on the script, the result is, as expected, an error:\n\n```\nmypy_repro % uv run --with-requirements requirements.txt mypy win.py \nwin.py:1: error: Cannot find implementation or library stub for module named \"mslex\"  [import-not-found]\nwin.py:1: note: See https://mypy.readthedocs.io/en/stable/running_mypy.html#missing-imports\nwin.py:3: error: Module \"ctypes\" has no attribute \"WinError\"  [attr-defined]\nwin.py:5: error: Module has no attribute \"ExpandEnvironmentStrings\"  [attr-defined]\nFound 3 errors in 1 file (checked 1 source file)\n```\n\nInterestingly, there's no error about the missing `winreg` module.\n\nIf I wrap the script in a platform check, there are no errors:\n\n```\nimport sys\n\nif sys.platform==\"win32\":\n    import mslex\n    import winreg\n    from ctypes import WinError\n\n    windir = winreg.ExpandEnvironmentStrings(\"%windir%\")\n    print(mslex.quote(windir))\n    raise WinError()\n```\n\n```\nmypy_repro % uv run --with-requirements requirements.txt mypy win_if.py      \nSuccess: no issues found in 1 source file\n```\n\nHowever, indenting the whole script is not really elegant. Luckily, [mypy's docs offer a solution](https://mypy.readthedocs.io/en/stable/common_issues.html#python-version-and-system-platform-checks):\n\n> As a special case, you can also use one of these checks in a top-level (unindented) assert; this makes mypy skip the rest of the file.\n\nHowever, when I try it, it still produces an error, although only for the thirdparty `mslex` module:\n\n```\nimport sys\nassert sys.platform==\"win32\"\n\nimport mslex\nimport winreg\nfrom ctypes import WinError\n\nwindir = winreg.ExpandEnvironmentStrings(\"%windir%\")\nprint(mslex.quote(windir))\nraise WinError()\n```\n\n```\nmypy_repro % uv run --with-requirements requirements.txt mypy win_assert.py\nwin_assert.py:4: error: Cannot find implementation or library stub for module named \"mslex\"  [import-not-found]\nwin_assert.py:4: note: See https://mypy.readthedocs.io/en/stable/running_mypy.html#missing-imports\nFound 1 error in 1 file (checked 1 source file)\n```\n\nIt seems like even though the rest of the file after the `assert` is skipped during type checking, the imports are still processed and error out if unavailable. This is not what I expected; I expected it to pass.\n\nWhat's even more curious is that if I wrap the imports in an `if` after the `assert`, the error persists. It's as if the assert makes mypy skip the rest of the file, including the conditionals around the import statements, but not including the import statements themselves:\n\n```\nimport sys\nassert sys.platform==\"win32\"\n\nif sys.platform==\"win32\":\n    import mslex\n    import winreg\n    from ctypes import WinError\n\nwindir = winreg.ExpandEnvironmentStrings(\"%windir%\")\nprint(mslex.quote(windir))\nraise WinError()\n```\n\n```\nmypy_repro % uv run --with-requirements requirements.txt mypy win_assert_then_if.py \nwin_assert_then_if.py:5: error: Cannot find implementation or library stub for module named \"mslex\"  [import-not-found]\nwin_assert_then_if.py:5: note: See https://mypy.readthedocs.io/en/stable/running_mypy.html#missing-imports\nFound 1 error in 1 file (checked 1 source file)\n```\n\nThe only workaround I found is to add a platform check around the Windows-specific imports, and put an assert AFTER the imports:\n\n```\nimport sys\n\nif sys.platform==\"win32\":\n    import mslex\n    import winreg\n    from ctypes import WinError\n\nassert sys.platform==\"win32\"\n\nwindir = winreg.ExpandEnvironmentStrings(\"%windir%\")\nprint(mslex.quote(windir))\nraise WinError()\n```\n\n```\nmypy_repro % uv run --with-requirements requirements.txt mypy win_if_then_assert.py\nSuccess: no issues found in 1 source file\n```\n\nTo summarize the results:\n\n| Testcase | Expected behaviour | Actual behaviour | OK/NOK |\n| -------- | ------------------ | ---------------- | ------ |\n|No platform check|Error for all 3 imports|Error for `ctypes` and `mslex` imports, but not the `winreg` import. Also, an error for calling a function  from winreg.| OK (kinda) |\n|Platform `if` around entire script|No errors|No errors|OK|\n|Top-level platform `assert`|No errors|Error on `mslex` import|NOK|\n|Top-level platform `assert`, then platform `if` around imports|No errors (`if` should be redundant)|Error on `mslex` import|NOK|\n|Platform `if` around imports, then top-level platform `assert`|No errors|No errors|OK|\n\nAm I missing something? Or is there a bug in mypy's handling of the top-level platform asserts?\n\n** Environment**\n\n- Mypy version used: 1.16.1\n- Mypy command-line flags: none\n- Mypy configuration options from `mypy.ini` (and other config files): none\n- Python version used: 3.12.4\n- OS version: macOS 15.5 Sequoia\n\nThe issue is not specific to type-checking Windows-specific script on macOS, the same results can be reproduced on Windows for a macOS-specific script. I haven't checked whether conditions using the python interpreter version misbehave the same way as platform checks.\n","closed_by":{"login":"ilevkivskyi","id":12005495,"node_id":"MDQ6VXNlcjEyMDA1NDk1","avatar_url":"https://avatars.githubusercontent.com/u/12005495?v=4","gravatar_id":"","url":"https://api.github.com/users/ilevkivskyi","html_url":"https://github.com/ilevkivskyi","followers_url":"https://api.github.com/users/ilevkivskyi/followers","following_url":"https://api.github.com/users/ilevkivskyi/following{/other_user}","gists_url":"https://api.github.com/users/ilevkivskyi/gists{/gist_id}","starred_url":"https://api.github.com/users/ilevkivskyi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ilevkivskyi/subscriptions","organizations_url":"https://api.github.com/users/ilevkivskyi/orgs","repos_url":"https://api.github.com/users/ilevkivskyi/repos","events_url":"https://api.github.com/users/ilevkivskyi/events{/privacy}","received_events_url":"https://api.github.com/users/ilevkivskyi/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/python/mypy/issues/19346/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/python/mypy/issues/19346/timeline","performed_via_github_app":null,"state_reason":"completed"}