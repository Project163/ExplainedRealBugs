{"url":"https://api.github.com/repos/python/mypy/issues/13360","repository_url":"https://api.github.com/repos/python/mypy","labels_url":"https://api.github.com/repos/python/mypy/issues/13360/labels{/name}","comments_url":"https://api.github.com/repos/python/mypy/issues/13360/comments","events_url":"https://api.github.com/repos/python/mypy/issues/13360/events","html_url":"https://github.com/python/mypy/issues/13360","id":1332254933,"node_id":"I_kwDOAGuhRc5PaJjV","number":13360,"title":"No type narrowing for `in` on dict.keys()","user":{"login":"matthewhughes934","id":34972397,"node_id":"MDQ6VXNlcjM0OTcyMzk3","avatar_url":"https://avatars.githubusercontent.com/u/34972397?v=4","gravatar_id":"","url":"https://api.github.com/users/matthewhughes934","html_url":"https://github.com/matthewhughes934","followers_url":"https://api.github.com/users/matthewhughes934/followers","following_url":"https://api.github.com/users/matthewhughes934/following{/other_user}","gists_url":"https://api.github.com/users/matthewhughes934/gists{/gist_id}","starred_url":"https://api.github.com/users/matthewhughes934/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/matthewhughes934/subscriptions","organizations_url":"https://api.github.com/users/matthewhughes934/orgs","repos_url":"https://api.github.com/users/matthewhughes934/repos","events_url":"https://api.github.com/users/matthewhughes934/events{/privacy}","received_events_url":"https://api.github.com/users/matthewhughes934/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":21488358,"node_id":"MDU6TGFiZWwyMTQ4ODM1OA==","url":"https://api.github.com/repos/python/mypy/labels/feature","name":"feature","color":"84b6eb","default":false,"description":null},{"id":3945155924,"node_id":"LA_kwDOAGuhRc7rJk1U","url":"https://api.github.com/repos/python/mypy/labels/topic-type-narrowing","name":"topic-type-narrowing","color":"9F31C3","default":false,"description":"Conditional type narrowing / binder"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-08-08T18:47:35Z","updated_at":"2022-10-27T18:25:36Z","closed_at":"2022-10-27T18:25:36Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Bug Report**\r\n\r\nA an `if` statement like `if x in some_dict.keys()` doesn't narrow the type of `x` to the type of the key of `some_dict`.\r\nThis is in contrast with `if x in some_dict` which does correctly narrow.\r\n\r\n(I had a search and didn't find a similar existing discussion, apologies if this isn't the case)\r\n\r\n**To Reproduce**\r\n\r\nRun `mypy` over the following:\r\n\r\n```python\r\nfrom collections.abc import KeysView\r\n\r\n\r\ndef get_via_keys(key: str | None, data: dict[str, str]) -> str:\r\n    if key in data.keys():\r\n        # error: Incompatible return value type (got \"Optional[str]\", expected \"str\")\r\n        return key\r\n    return \"value\"\r\n\r\n\r\ndef get_via_keys_explicit_typing(key: str | None, data: dict[str, str]) -> str:\r\n    keys: KeysView[str] = data.keys()\r\n    if key in keys:\r\n        # error: Incompatible return value type (got \"Optional[str]\", expected \"str\")\r\n        return key\r\n    return \"value\"\r\n\r\n\r\ndef get_check_dict_membership(key: str | None, data: dict[str, str]) -> str:\r\n    if key in data:\r\n        # OK\r\n        return key\r\n    return \"value\"\r\n```\r\n\r\n**Expected Behavior**\r\n\r\n`mypy` correctly narrows the type in each of the `if` statements and the script passes.\r\n\r\n**Actual Behavior**\r\n\r\n`mypy` reports failures as:\r\n\r\n```\r\nscript.py:7: error: Incompatible return value type (got \"Optional[str]\", expected \"str\")\r\nscript.py:15: error: Incompatible return value type (got \"Optional[str]\", expected \"str\")\r\nFound 2 errors in 1 file (checked 1 source file)\r\n```\r\n\r\n**Your Environment**\r\n\r\n<!-- Include as many relevant details about the environment you experienced the bug in -->\r\n\r\n- Mypy version used: `0.971` and `mypy 0.980+dev.e69bd9a7270daac8db409e8d08400d9d32367c32 (compiled: no)` (current  `master`)\r\n- Mypy command-line flags: `mypy <name-of-file-above>`\r\n- Mypy configuration options from `mypy.ini` (and other config files): the above was run from the root of this project (so whatever's configured there)\r\n- Python version used: `Python 3.10.5`\r\n- Operating system and version: Arch Linux (kernel 5.18.15)\r\n\r\nThe following allows `get_via_keys` above to pass under `mypy`\r\n\r\n```patch\r\ndiff --git a/mypy/checker.py b/mypy/checker.py\r\nindex e64cea7b4..852fe8fab 100644\r\n--- a/mypy/checker.py\r\n+++ b/mypy/checker.py\r\n@@ -6285,6 +6285,7 @@ def builtin_item_type(tp: Type) -> Optional[Type]:\r\n             \"builtins.dict\",\r\n             \"builtins.set\",\r\n             \"builtins.frozenset\",\r\n+            \"_collections_abc.dict_keys\",\r\n         ]:\r\n             if not tp.args:\r\n                 # TODO: fix tuple in lib-stub/builtins.pyi (it should be generic).\r\n```\r\n\r\nThough I'm not sure how appropriate it would be given the note in the docs for that function:\r\n\r\n```\r\nNote: this is only OK for built-in containers, where we know the behavior of __contains__.\r\n```\r\n\r\nAlso, `dict_keys` is undocumented and a quick `git grep --word-regexp 'dict_keys'` didn't show much usage for it outside of `typeshed`.","closed_by":{"login":"hauntsaninja","id":12621235,"node_id":"MDQ6VXNlcjEyNjIxMjM1","avatar_url":"https://avatars.githubusercontent.com/u/12621235?v=4","gravatar_id":"","url":"https://api.github.com/users/hauntsaninja","html_url":"https://github.com/hauntsaninja","followers_url":"https://api.github.com/users/hauntsaninja/followers","following_url":"https://api.github.com/users/hauntsaninja/following{/other_user}","gists_url":"https://api.github.com/users/hauntsaninja/gists{/gist_id}","starred_url":"https://api.github.com/users/hauntsaninja/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hauntsaninja/subscriptions","organizations_url":"https://api.github.com/users/hauntsaninja/orgs","repos_url":"https://api.github.com/users/hauntsaninja/repos","events_url":"https://api.github.com/users/hauntsaninja/events{/privacy}","received_events_url":"https://api.github.com/users/hauntsaninja/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/python/mypy/issues/13360/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/python/mypy/issues/13360/timeline","performed_via_github_app":null,"state_reason":"completed"}