{"url":"https://api.github.com/repos/python/mypy/issues/13243","repository_url":"https://api.github.com/repos/python/mypy","labels_url":"https://api.github.com/repos/python/mypy/issues/13243/labels{/name}","comments_url":"https://api.github.com/repos/python/mypy/issues/13243/comments","events_url":"https://api.github.com/repos/python/mypy/issues/13243/events","html_url":"https://github.com/python/mypy/issues/13243","id":1318851370,"node_id":"I_kwDOAGuhRc5OnBMq","number":13243,"title":"Add `__match_args__` to Node types","user":{"login":"dosisod","id":39638017,"node_id":"MDQ6VXNlcjM5NjM4MDE3","avatar_url":"https://avatars.githubusercontent.com/u/39638017?v=4","gravatar_id":"","url":"https://api.github.com/users/dosisod","html_url":"https://github.com/dosisod","followers_url":"https://api.github.com/users/dosisod/followers","following_url":"https://api.github.com/users/dosisod/following{/other_user}","gists_url":"https://api.github.com/users/dosisod/gists{/gist_id}","starred_url":"https://api.github.com/users/dosisod/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dosisod/subscriptions","organizations_url":"https://api.github.com/users/dosisod/orgs","repos_url":"https://api.github.com/users/dosisod/repos","events_url":"https://api.github.com/users/dosisod/events{/privacy}","received_events_url":"https://api.github.com/users/dosisod/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":21488358,"node_id":"MDU6TGFiZWwyMTQ4ODM1OA==","url":"https://api.github.com/repos/python/mypy/labels/feature","name":"feature","color":"84b6eb","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-07-26T23:31:53Z","updated_at":"2022-11-03T23:35:02Z","closed_at":"2022-11-03T23:35:02Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I am working on a project which makes heavy use of Mypy AST trees/nodes. and it would be nice if there was less boilerplate when doing pattern matching against nodes (especially for more complex scenarios).\r\n\r\nFor example, parsing the following expression:\r\n\r\n```python\r\n1 + 2\r\n```\r\n\r\nResults in an `OpExpr` expression node (ignoring setup, see below), which I can then pattern match like so:\r\n\r\n```python\r\nmatch o:\r\n    case OpExpr(\r\n        op=\"+\",\r\n        left=IntExpr(value=1),\r\n        right=IntExpr(value=2),\r\n    ):\r\n        print(\"found\")\r\n\r\n    case _:\r\n        print(\"not found\")\r\n```\r\n\r\nThis works, but what would be really nice is being able to do this:\r\n\r\n```python\r\nmatch o:\r\n    case OpExpr(\"+\", IntExpr(1), IntExpr(2)):\r\n        print(\"found\")\r\n\r\n    case _:\r\n        print(\"not found\")\r\n```\r\n\r\nBut doing so causes the following exception:\r\n\r\n```\r\nTraceback (most recent call last):\r\n  File \"[redacted]/main.py\", line 39, in <module>\r\n    tree.accept(Visitor())\r\n  File \"mypy/nodes.py\", line 347, in accept\r\n  File \"mypy/traverser.py\", line 42, in visit_mypy_file\r\n  File \"mypy/nodes.py\", line 1128, in accept\r\n  File \"mypy/traverser.py\", line 89, in visit_expression_stmt\r\n  File \"mypy/nodes.py\", line 1888, in accept\r\n  File \"[redacted]/main.py\", line 30, in visit_op_expr\r\n    case OpExpr(IntExpr(1), \"+\", IntExpr(2)):\r\nTypeError: OpExpr() accepts 0 positional sub-patterns (3 given)\r\n```\r\n\r\nAll that would need to done to fix this (I think) is the following:\r\n\r\n```diff\r\n class OpExpr(Expression):\r\n     \"\"\"Binary operation (other than . or [] or comparison operators,\r\n     which have specific nodes).\"\"\"\r\n \r\n     __slots__ = ('op', 'left', 'right',\r\n                  'method_type', 'right_always', 'right_unreachable')\r\n+\r\n+    __match_args__ ('op', 'left', 'right')\r\n```\r\n\r\nAnd then do that for every node we would (feasibly) pattern match against. I am willing to make a PR for this, assuming all that needs to be done is add a `__match_args__` line to a few classes.\r\n\r\n<details>\r\n<summary>Full code example</summary>\r\n\r\n```python\r\nfrom mypy.build import build\r\nfrom mypy.main import process_options\r\nfrom mypy.nodes import IntExpr, OpExpr\r\nfrom mypy.traverser import TraverserVisitor\r\n\r\nfiles, opt = process_options([\"-c\", \"1 + 2\"])\r\nopt.fine_grained_incremental = True\r\n\r\nresult = build(files, options=opt)\r\n\r\n\r\nclass Visitor(TraverserVisitor):\r\n    def visit_op_expr(self, o: OpExpr) -> None:\r\n        super().visit_op_expr(o)\r\n\r\n        match o:\r\n            case OpExpr(\r\n                left=IntExpr(value=1),\r\n                op=\"+\",\r\n                right=IntExpr(value=2),\r\n            ):\r\n                print(\"found\")\r\n\r\n            case _:\r\n                print(\"not found\")\r\n\r\n\r\ntree = result.graph['__main__'].tree\r\n\r\nif tree:\r\n    tree.accept(Visitor())\r\n```\r\n</details>","closed_by":{"login":"ilevkivskyi","id":12005495,"node_id":"MDQ6VXNlcjEyMDA1NDk1","avatar_url":"https://avatars.githubusercontent.com/u/12005495?v=4","gravatar_id":"","url":"https://api.github.com/users/ilevkivskyi","html_url":"https://github.com/ilevkivskyi","followers_url":"https://api.github.com/users/ilevkivskyi/followers","following_url":"https://api.github.com/users/ilevkivskyi/following{/other_user}","gists_url":"https://api.github.com/users/ilevkivskyi/gists{/gist_id}","starred_url":"https://api.github.com/users/ilevkivskyi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ilevkivskyi/subscriptions","organizations_url":"https://api.github.com/users/ilevkivskyi/orgs","repos_url":"https://api.github.com/users/ilevkivskyi/repos","events_url":"https://api.github.com/users/ilevkivskyi/events{/privacy}","received_events_url":"https://api.github.com/users/ilevkivskyi/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/python/mypy/issues/13243/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/python/mypy/issues/13243/timeline","performed_via_github_app":null,"state_reason":"completed"}