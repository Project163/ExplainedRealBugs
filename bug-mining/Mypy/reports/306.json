{"url":"https://api.github.com/repos/python/mypy/issues/14868","repository_url":"https://api.github.com/repos/python/mypy","labels_url":"https://api.github.com/repos/python/mypy/issues/14868/labels{/name}","comments_url":"https://api.github.com/repos/python/mypy/issues/14868/comments","events_url":"https://api.github.com/repos/python/mypy/issues/14868/events","html_url":"https://github.com/python/mypy/issues/14868","id":1619493168,"node_id":"I_kwDOAGuhRc5gh4Ew","number":14868,"title":"mypy has implemented pep-681 incorrectly and does not intepret descriptors correctly","user":{"login":"zzzeek","id":128223,"node_id":"MDQ6VXNlcjEyODIyMw==","avatar_url":"https://avatars.githubusercontent.com/u/128223?v=4","gravatar_id":"","url":"https://api.github.com/users/zzzeek","html_url":"https://github.com/zzzeek","followers_url":"https://api.github.com/users/zzzeek/followers","following_url":"https://api.github.com/users/zzzeek/following{/other_user}","gists_url":"https://api.github.com/users/zzzeek/gists{/gist_id}","starred_url":"https://api.github.com/users/zzzeek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zzzeek/subscriptions","organizations_url":"https://api.github.com/users/zzzeek/orgs","repos_url":"https://api.github.com/users/zzzeek/repos","events_url":"https://api.github.com/users/zzzeek/events{/privacy}","received_events_url":"https://api.github.com/users/zzzeek/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":21488356,"node_id":"MDU6TGFiZWwyMTQ4ODM1Ng==","url":"https://api.github.com/repos/python/mypy/labels/bug","name":"bug","color":"f9d0c4","default":true,"description":"mypy got something wrong"},{"id":3945364284,"node_id":"LA_kwDOAGuhRc7rKXs8","url":"https://api.github.com/repos/python/mypy/labels/topic-descriptors","name":"topic-descriptors","color":"bfd4f2","default":false,"description":"Properties, class vs. instance attributes"},{"id":5126611103,"node_id":"LA_kwDOAGuhRc8AAAABMZHgnw","url":"https://api.github.com/repos/python/mypy/labels/topic-dataclass-transform","name":"topic-dataclass-transform","color":"90C33B","default":false,"description":"PEP 681"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2023-03-10T19:12:56Z","updated_at":"2023-04-05T10:04:23Z","closed_at":"2023-04-05T10:04:23Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Hi -\r\n\r\nNow that mypy has pep-681 support, they are making a mistake that we spent a lot of time with the pyright people working out.\r\n\r\nThis SQLAlchemy mapping and usage is valid:\r\n\r\n```py\r\nfrom __future__ import annotations\r\n\r\nfrom sqlalchemy.orm import DeclarativeBase\r\nfrom sqlalchemy.orm import Mapped\r\nfrom sqlalchemy.orm import mapped_column\r\nfrom sqlalchemy.orm import MappedAsDataclass\r\n\r\n\r\nclass Base(MappedAsDataclass, DeclarativeBase):\r\n    pass\r\n\r\n\r\nclass A(Base):\r\n    __tablename__ = \"a\"\r\n\r\n    id: Mapped[int] = mapped_column(primary_key=True, init=False)\r\n    data: Mapped[str]\r\n\r\n\r\na1 = A(data='some data')\r\n```\r\n\r\nhowever Mypy reports:\r\n\r\n```\r\ntest3.py:20: error: Argument \"data\" to \"A\" has incompatible type \"str\"; expected \"Mapped[str]\"  [arg-type]\r\nFound 1 error in 1 file (checked 1 source file)\r\n```\r\n\r\nthis is not correct.  `Mapped[]` is a descriptor, so the appropriate value that should be set is a string, not a descriptor object.\r\n\r\nHere's a complete example using only typing as an import\r\n\r\n```py\r\nfrom __future__ import annotations\r\n\r\nfrom typing import Any\r\nfrom typing import Generic\r\nfrom typing import Optional\r\nfrom typing import overload\r\nfrom typing import TYPE_CHECKING\r\nfrom typing import TypeVar\r\nfrom typing import Union\r\n\r\nfrom typing_extensions import dataclass_transform\r\n\r\n_T = TypeVar(\"_T\")\r\n\r\n\r\ndef model_field(\r\n    *,\r\n    default: Optional[Any] = None,\r\n    init: bool = True,\r\n) -> Any:\r\n    raise NotImplementedError()\r\n\r\n\r\n@dataclass_transform(\r\n    eq_default=True, order_default=True, field_specifiers=(model_field,)\r\n)\r\nclass ModelBase:\r\n    def __init_subclass__(\r\n        cls,\r\n        *,\r\n        init: bool = True,\r\n        frozen: bool = False,\r\n        eq: bool = True,\r\n        order: bool = True,\r\n    ):\r\n        ...\r\n\r\n\r\nclass Mapped(Generic[_T]):\r\n    if TYPE_CHECKING:\r\n\r\n        @overload\r\n        def __get__(self, instance: None, owner: Any) -> Mapped[_T]:\r\n            ...\r\n\r\n        @overload\r\n        def __get__(self, instance: object, owner: Any) -> _T:\r\n            ...\r\n\r\n        def __get__(\r\n            self, instance: Optional[object], owner: Any\r\n        ) -> Union[Mapped[_T], _T]:\r\n            ...\r\n\r\n        def __set__(self, instance: Any, value: _T) -> None:\r\n            ...\r\n\r\n        def __delete__(self, instance: Any) -> None:\r\n            ...\r\n\r\n\r\nclass Customer(ModelBase):\r\n    a: int\r\n\r\n\r\nc1 = Customer(a=5)\r\n\r\n\r\nclass AlsoCustomer(ModelBase):\r\n    a: Mapped[int]\r\n\r\n\r\n# this is correct under pyright\r\nc2 = AlsoCustomer(a=5)\r\n\r\n\r\n# this is an error under pyright\r\nc3 = AlsoCustomer(a=\"some string\")\r\n```\r\n\r\nWe had very involved discussions about this here:  https://github.com/microsoft/pyright/discussions/2958  where the authors of pep-681 decided only to add a note about this here: https://peps.python.org/pep-0681/#descriptor-typed-field-support\r\n\r\nWhile I was disappointed they would not add this language to the spec explicitly, they state it in that paragraph:\r\n\r\n> When enabled, the type of each parameter on the synthesized __init__ method corresponding to a descriptor-typed field would be the type of the value parameter to the descriptorâ€™s __set__ method rather than the descriptor type itself. Similarly, when setting the field, the __set__ value type would be expected. And when getting the value of the field, its type would be expected to match the return type of __get__.\r\n\r\n> This idea was based on the belief that dataclass did not properly support descriptor-typed fields. In fact it does, but type checkers (at least mypy and pyright) did not reflect **the runtime behavior** which led to our misunderstanding. For more details, see the [Pyright bug](https://github.com/microsoft/pyright/issues/3245).\r\n\r\nThat is, Python dataclasses when a descriptor is used as the left hand type, **the type of the actual attribute passed to __init__ must be the contained datatype, not the descriptor type**.\r\n\r\nWe at SQLAlchemy spent weeks back and forth with the pep-681 authors on this and I am a little bit terrified that because this language wasn't included, Mypy did it exactly the wrong way.    \r\n\r\nI am very hopeful that the Mypy authors can correct this behavior else we will have to get our users to disable pep-681 support for mypy.\r\n\r\n\r\n\r\n","closed_by":{"login":"JukkaL","id":1107911,"node_id":"MDQ6VXNlcjExMDc5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/1107911?v=4","gravatar_id":"","url":"https://api.github.com/users/JukkaL","html_url":"https://github.com/JukkaL","followers_url":"https://api.github.com/users/JukkaL/followers","following_url":"https://api.github.com/users/JukkaL/following{/other_user}","gists_url":"https://api.github.com/users/JukkaL/gists{/gist_id}","starred_url":"https://api.github.com/users/JukkaL/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JukkaL/subscriptions","organizations_url":"https://api.github.com/users/JukkaL/orgs","repos_url":"https://api.github.com/users/JukkaL/repos","events_url":"https://api.github.com/users/JukkaL/events{/privacy}","received_events_url":"https://api.github.com/users/JukkaL/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/python/mypy/issues/14868/reactions","total_count":4,"+1":4,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/python/mypy/issues/14868/timeline","performed_via_github_app":null,"state_reason":"completed"}