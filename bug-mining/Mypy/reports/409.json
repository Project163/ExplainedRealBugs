{"url":"https://api.github.com/repos/python/mypy/issues/16945","repository_url":"https://api.github.com/repos/python/mypy","labels_url":"https://api.github.com/repos/python/mypy/issues/16945/labels{/name}","comments_url":"https://api.github.com/repos/python/mypy/issues/16945/comments","events_url":"https://api.github.com/repos/python/mypy/issues/16945/events","html_url":"https://github.com/python/mypy/issues/16945","id":2152262386,"node_id":"I_kwDOAGuhRc6ASOry","number":16945,"title":"Mypy fails to typecheck itself following the recent black upgrade","user":{"login":"AlexWaygood","id":66076021,"node_id":"MDQ6VXNlcjY2MDc2MDIx","avatar_url":"https://avatars.githubusercontent.com/u/66076021?v=4","gravatar_id":"","url":"https://api.github.com/users/AlexWaygood","html_url":"https://github.com/AlexWaygood","followers_url":"https://api.github.com/users/AlexWaygood/followers","following_url":"https://api.github.com/users/AlexWaygood/following{/other_user}","gists_url":"https://api.github.com/users/AlexWaygood/gists{/gist_id}","starred_url":"https://api.github.com/users/AlexWaygood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AlexWaygood/subscriptions","organizations_url":"https://api.github.com/users/AlexWaygood/orgs","repos_url":"https://api.github.com/users/AlexWaygood/repos","events_url":"https://api.github.com/users/AlexWaygood/events{/privacy}","received_events_url":"https://api.github.com/users/AlexWaygood/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":21488356,"node_id":"MDU6TGFiZWwyMTQ4ODM1Ng==","url":"https://api.github.com/repos/python/mypy/labels/bug","name":"bug","color":"f9d0c4","default":true,"description":"mypy got something wrong"},{"id":610718653,"node_id":"MDU6TGFiZWw2MTA3MTg2NTM=","url":"https://api.github.com/repos/python/mypy/labels/topic-developer","name":"topic-developer","color":"d4c5f9","default":false,"description":"Issues relevant to mypy developers"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2024-02-24T11:09:41Z","updated_at":"2024-02-25T22:44:50Z","closed_at":"2024-02-25T22:44:50Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"_Note: make sure you run mypy with a cold cache each time if you're trying to repro this bug locally. It seems to not always reproduce if you have a warm cache._\r\n\r\n**Bug Report**\r\n\r\nFollowing https://github.com/python/mypy/commit/8107e53158d83d30bb04d290ac10d8d3ccd344f8 (bumping the version of black we use in CI to 24.1.1), mypy fails to typecheck its own codebase if you're using Python 3.10.6 or newer. This is a result of a CPython bug where the `ast` stdlib module on newer versions of Python thinks certain syntax around context managers is illegal on Python 3.8, even though that syntax works fine if you're actually _using_ Python 3.8: https://github.com/python/cpython/issues/115881.\r\n\r\nHopefully the CPython bug will be fixed, but it won't be backported to Python 3.10, since Python 3.10 is old enough that it now only accepts patches if they relate to security issues (and this bug isn't a security issue). If we want mypy to be able to typecheck itself using Python 3.10, we'll need to find a workaround.\r\n\r\n**To Reproduce**\r\n\r\nInside a local clone of mypy, using Python 3.10.6 or newer, with all test requirements installed (including an editable install of mypy):\r\n\r\n```\r\n% rm -rf .mypy_cache\r\n% python runtests.py self\r\nrun self: ['/Users/alexw/dev/mypy/310-6-venv/bin/python3', '-m', 'mypy', '--config-file', 'mypy_self_check.ini', '-p', 'mypy', '-p', 'mypyc']\r\nmypy/checker.py:540: error: Parenthesized context managers are only supported in Python 3.9 and greater  [syntax]\r\n                return True\r\n                ^\r\nmypy/checker.py:540: note: See https://mypy.rtfd.io/en/stable/_refs.html#code-syntax for more info\r\nFound 1 error in 1 file (errors prevented further checking)\r\n\r\nFAILED: self\r\n```\r\n\r\n**Expected Behavior**\r\n\r\nMypy should be able to type-check its own codebase on all versions of Python\r\n\r\n**Actual Behavior**\r\n\r\nMypy cannot typecheck its own codebase on newer versions of Python\r\n\r\n**Your Environment**\r\n\r\n<!-- Include as many relevant details about the environment you experienced the bug in -->\r\n\r\n- Mypy version used: the mypy master branch\r\n- Python version used: I tested using Python 3.8, 3.9, 3.10.5, 3.10.6, 3.11.0 and 3.12.0\r\n","closed_by":{"login":"hauntsaninja","id":12621235,"node_id":"MDQ6VXNlcjEyNjIxMjM1","avatar_url":"https://avatars.githubusercontent.com/u/12621235?v=4","gravatar_id":"","url":"https://api.github.com/users/hauntsaninja","html_url":"https://github.com/hauntsaninja","followers_url":"https://api.github.com/users/hauntsaninja/followers","following_url":"https://api.github.com/users/hauntsaninja/following{/other_user}","gists_url":"https://api.github.com/users/hauntsaninja/gists{/gist_id}","starred_url":"https://api.github.com/users/hauntsaninja/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hauntsaninja/subscriptions","organizations_url":"https://api.github.com/users/hauntsaninja/orgs","repos_url":"https://api.github.com/users/hauntsaninja/repos","events_url":"https://api.github.com/users/hauntsaninja/events{/privacy}","received_events_url":"https://api.github.com/users/hauntsaninja/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/python/mypy/issues/16945/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/python/mypy/issues/16945/timeline","performed_via_github_app":null,"state_reason":"completed"}