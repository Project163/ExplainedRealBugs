{"url":"https://api.github.com/repos/python/mypy/issues/14950","repository_url":"https://api.github.com/repos/python/mypy","labels_url":"https://api.github.com/repos/python/mypy/issues/14950/labels{/name}","comments_url":"https://api.github.com/repos/python/mypy/issues/14950/comments","events_url":"https://api.github.com/repos/python/mypy/issues/14950/events","html_url":"https://github.com/python/mypy/issues/14950","id":1638469061,"node_id":"I_kwDOAGuhRc5hqQ3F","number":14950,"title":"Stubtest crashes on a stub with an overloaded method where the first overload is decorated with `@final`","user":{"login":"AlexWaygood","id":66076021,"node_id":"MDQ6VXNlcjY2MDc2MDIx","avatar_url":"https://avatars.githubusercontent.com/u/66076021?v=4","gravatar_id":"","url":"https://api.github.com/users/AlexWaygood","html_url":"https://github.com/AlexWaygood","followers_url":"https://api.github.com/users/AlexWaygood/followers","following_url":"https://api.github.com/users/AlexWaygood/following{/other_user}","gists_url":"https://api.github.com/users/AlexWaygood/gists{/gist_id}","starred_url":"https://api.github.com/users/AlexWaygood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AlexWaygood/subscriptions","organizations_url":"https://api.github.com/users/AlexWaygood/orgs","repos_url":"https://api.github.com/users/AlexWaygood/repos","events_url":"https://api.github.com/users/AlexWaygood/events{/privacy}","received_events_url":"https://api.github.com/users/AlexWaygood/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":379446833,"node_id":"MDU6TGFiZWwzNzk0NDY4MzM=","url":"https://api.github.com/repos/python/mypy/labels/crash","name":"crash","color":"b60205","default":false,"description":null},{"id":3201597780,"node_id":"MDU6TGFiZWwzMjAxNTk3Nzgw","url":"https://api.github.com/repos/python/mypy/labels/topic-stubtest","name":"topic-stubtest","color":"A13BA2","default":false,"description":""},{"id":3945190306,"node_id":"LA_kwDOAGuhRc7rJtOi","url":"https://api.github.com/repos/python/mypy/labels/topic-final","name":"topic-final","color":"BB8611","default":false,"description":"PEP 591"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2023-03-23T23:13:36Z","updated_at":"2023-11-11T20:08:00Z","closed_at":"2023-11-11T20:08:00Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Crash Report**\r\n\r\nIf you run stubtest on a stub with a method like this, stubtest will crash:\r\n\r\n```python\r\nfrom typing import final, overload\r\n\r\nclass C:\r\n    @overload\r\n    @final\r\n    def foo(self, obj: str) -> int: ...\r\n    @overload\r\n    def foo(self, obj: int) -> str: ...\r\n```\r\n\r\nThe crash occurs regardless of the order in which you stack the `@final` and `@overload` decorator on the first overload. (PEP 591 specifies that for overloaded definitions in stubs, the `@final` decorator should be placed on the first overload, but doesn't specify which order they should be stacked in.)\r\n\r\n**Traceback**\r\n\r\n```pytb\r\nTraceback (most recent call last):\r\n  File \"<frozen runpy>\", line 198, in _run_module_as_main\r\n  File \"<frozen runpy>\", line 88, in _run_code\r\n  File \"C:\\Users\\alexw\\AppData\\Local\\Temp\\tmp_p_nrkoa\\Lib\\site-packages\\mypy\\stubtest.py\", line 1823, in <module>\r\n    sys.exit(main())\r\n             ^^^^^^\r\n  File \"C:\\Users\\alexw\\AppData\\Local\\Temp\\tmp_p_nrkoa\\Lib\\site-packages\\mypy\\stubtest.py\", line 1819, in main\r\n    return test_stubs(parse_options(sys.argv[1:]))\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"C:\\Users\\alexw\\AppData\\Local\\Temp\\tmp_p_nrkoa\\Lib\\site-packages\\mypy\\stubtest.py\", line 1692, in test_stubs\r\n    for error in test_module(module):\r\n  File \"C:\\Users\\alexw\\AppData\\Local\\Temp\\tmp_p_nrkoa\\Lib\\site-packages\\mypy\\stubtest.py\", line 218, in test_module\r\n    yield from verify(stub, runtime, [module_name])\r\n  File \"C:\\Users\\alexw\\AppData\\Local\\Temp\\tmp_p_nrkoa\\Lib\\site-packages\\mypy\\stubtest.py\", line 396, in verify_mypyfile\r\n    yield from verify(stub_entry, runtime_entry, object_path + [entry])\r\n  File \"C:\\Users\\alexw\\AppData\\Local\\Temp\\tmp_p_nrkoa\\Lib\\site-packages\\mypy\\stubtest.py\", line 517, in verify_typeinfo\r\n    yield from verify(stub_to_verify, runtime_attr, object_path + [entry])\r\n  File \"C:\\Users\\alexw\\AppData\\Local\\Temp\\tmp_p_nrkoa\\Lib\\site-packages\\mypy\\stubtest.py\", line 1050, in verify_overloadedfuncdef\r\n    stub_sig = Signature.from_overloadedfuncdef(stub)\r\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"C:\\Users\\alexw\\AppData\\Local\\Temp\\tmp_p_nrkoa\\Lib\\site-packages\\mypy\\stubtest.py\", line 756, in from_overloadedfuncdef\r\n    assert func is not None\r\n           ^^^^^^^^^^^^^^^^\r\nAssertionError\r\n```\r\n\r\n**To Reproduce**\r\n\r\nTwo ways to reproduce:\r\n\r\n**(1) Apply this diff, and then run `pytest mypy/test/teststubtest.py`:**\r\n\r\n```diff\r\ndiff --git a/mypy/test/teststubtest.py b/mypy/test/teststubtest.py\r\nindex d39812b5f..b7f114b5e 100644\r\n--- a/mypy/test/teststubtest.py\r\n+++ b/mypy/test/teststubtest.py\r\n@@ -1177,6 +1177,24 @@ class StubtestUnit(unittest.TestCase):\r\n             \"\"\",\r\n             error=\"C\",\r\n         )\r\n+        yield Case(\r\n+            stub=\"\"\"\r\n+            from typing import overload\r\n+            from typing_extensions import final\r\n+            class D:\r\n+                @overload\r\n+                @final\r\n+                def foo(self, obj: int) -> str: ...\r\n+                @overload\r\n+                def foo(self, obj: str) -> int: ...\r\n+            \"\"\",\r\n+            runtime=\"\"\"\r\n+            class D:\r\n+                def foo(self, obj):\r\n+                    return 42 if isinstance(obj, str) else \"foo\"\r\n+            \"\"\",\r\n+            error=None\r\n+        )\r\n```\r\n\r\n**(2) With a typeshed clone checked out, apply this diff, then run `python tests/stubtest_stdlib.py`:**\r\n\r\n```diff\r\ndiff --git a/stdlib/builtins.pyi b/stdlib/builtins.pyi\r\nindex 2c21cd95d..8cdcd3b6a 100644\r\n--- a/stdlib/builtins.pyi\r\n+++ b/stdlib/builtins.pyi\r\n@@ -189,6 +189,7 @@ class type:\r\n\r\n class super:\r\n     @overload\r\n+    @final\r\n     def __init__(self, __t: Any, __obj: Any) -> None: ...\r\n     @overload\r\n     def __init__(self, __t: Any) -> None: ...\r\n```\r\n\r\n**Your Environment**\r\n\r\nReproduced with mypy 1.1.1 and mypy @ bfa9eacedb0554e1a6fe9245dbd5ccdbbc555fae\r\n","closed_by":{"login":"ilevkivskyi","id":12005495,"node_id":"MDQ6VXNlcjEyMDA1NDk1","avatar_url":"https://avatars.githubusercontent.com/u/12005495?v=4","gravatar_id":"","url":"https://api.github.com/users/ilevkivskyi","html_url":"https://github.com/ilevkivskyi","followers_url":"https://api.github.com/users/ilevkivskyi/followers","following_url":"https://api.github.com/users/ilevkivskyi/following{/other_user}","gists_url":"https://api.github.com/users/ilevkivskyi/gists{/gist_id}","starred_url":"https://api.github.com/users/ilevkivskyi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ilevkivskyi/subscriptions","organizations_url":"https://api.github.com/users/ilevkivskyi/orgs","repos_url":"https://api.github.com/users/ilevkivskyi/repos","events_url":"https://api.github.com/users/ilevkivskyi/events{/privacy}","received_events_url":"https://api.github.com/users/ilevkivskyi/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/python/mypy/issues/14950/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/python/mypy/issues/14950/timeline","performed_via_github_app":null,"state_reason":"completed"}