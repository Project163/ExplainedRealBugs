{"url":"https://api.github.com/repos/python/mypy/issues/11045","repository_url":"https://api.github.com/repos/python/mypy","labels_url":"https://api.github.com/repos/python/mypy/issues/11045/labels{/name}","comments_url":"https://api.github.com/repos/python/mypy/issues/11045/comments","events_url":"https://api.github.com/repos/python/mypy/issues/11045/events","html_url":"https://github.com/python/mypy/issues/11045","id":986517666,"node_id":"MDU6SXNzdWU5ODY1MTc2NjY=","number":11045,"title":"Crash when typechecking transformers 4.10.0","user":{"login":"davidhewitt","id":1939362,"node_id":"MDQ6VXNlcjE5MzkzNjI=","avatar_url":"https://avatars.githubusercontent.com/u/1939362?v=4","gravatar_id":"","url":"https://api.github.com/users/davidhewitt","html_url":"https://github.com/davidhewitt","followers_url":"https://api.github.com/users/davidhewitt/followers","following_url":"https://api.github.com/users/davidhewitt/following{/other_user}","gists_url":"https://api.github.com/users/davidhewitt/gists{/gist_id}","starred_url":"https://api.github.com/users/davidhewitt/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davidhewitt/subscriptions","organizations_url":"https://api.github.com/users/davidhewitt/orgs","repos_url":"https://api.github.com/users/davidhewitt/repos","events_url":"https://api.github.com/users/davidhewitt/events{/privacy}","received_events_url":"https://api.github.com/users/davidhewitt/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":379446833,"node_id":"MDU6TGFiZWwzNzk0NDY4MzM=","url":"https://api.github.com/repos/python/mypy/labels/crash","name":"crash","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2021-09-02T10:29:48Z","updated_at":"2022-02-17T03:11:18Z","closed_at":"2022-02-17T03:11:18Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Crash Report**\r\n\r\nI am typechecking a codebase which imports `transformers` 4.10.0 and hitting a mypy internal error. Also reported in the transformers repo as https://github.com/huggingface/transformers/issues/13390\r\n\r\n**Traceback**\r\n\r\nThis traceback is generated using the current mypy master (`pip install git+https://github.com/python/mypy`).\r\n\r\n```\r\nsrc/transformers/trainer.py:1435: error: INTERNAL ERROR -- Please try using mypy master on Github:\r\nhttps://mypy.readthedocs.io/en/stable/common_issues.html#using-a-development-mypy-build\r\nPlease report a bug at https://github.com/python/mypy/issues\r\nversion: 0.920+dev.5e73cd7b0dc9b871716acf0086b2ca0376fcff39\r\nTraceback (most recent call last):\r\n  File \"/home/david/dev/transformers/.env/bin/mypy\", line 8, in <module>\r\n    sys.exit(console_entry())\r\n  File \"/home/david/dev/transformers/.env/lib/python3.9/site-packages/mypy/__main__.py\", line 11, in console_entry\r\n    main(None, sys.stdout, sys.stderr)\r\n  File \"/home/david/dev/transformers/.env/lib/python3.9/site-packages/mypy/main.py\", line 87, in main\r\n    res, messages, blockers = run_build(sources, options, fscache, t0, stdout, stderr)\r\n  File \"/home/david/dev/transformers/.env/lib/python3.9/site-packages/mypy/main.py\", line 165, in run_build\r\n    res = build.build(sources, options, None, flush_errors, fscache, stdout, stderr)\r\n  File \"/home/david/dev/transformers/.env/lib/python3.9/site-packages/mypy/build.py\", line 179, in build\r\n    result = _build(\r\n  File \"/home/david/dev/transformers/.env/lib/python3.9/site-packages/mypy/build.py\", line 254, in _build\r\n    graph = dispatch(sources, manager, stdout)\r\n  File \"/home/david/dev/transformers/.env/lib/python3.9/site-packages/mypy/build.py\", line 2707, in dispatch\r\n    process_graph(graph, manager)\r\n  File \"/home/david/dev/transformers/.env/lib/python3.9/site-packages/mypy/build.py\", line 3031, in process_graph\r\n    process_stale_scc(graph, scc, manager)\r\n  File \"/home/david/dev/transformers/.env/lib/python3.9/site-packages/mypy/build.py\", line 3138, in process_stale_scc\r\n    if not graph[id].type_check_second_pass():\r\n  File \"/home/david/dev/transformers/.env/lib/python3.9/site-packages/mypy/build.py\", line 2192, in type_check_second_pass\r\n    return self.type_checker().check_second_pass()\r\n  File \"/home/david/dev/transformers/.env/lib/python3.9/site-packages/mypy/checker.py\", line 354, in check_second_pass\r\n    self.check_partial(node)\r\n  File \"/home/david/dev/transformers/.env/lib/python3.9/site-packages/mypy/checker.py\", line 366, in check_partial\r\n    self.accept(node)\r\n  File \"/home/david/dev/transformers/.env/lib/python3.9/site-packages/mypy/checker.py\", line 411, in accept\r\n    stmt.accept(self)\r\n  File \"/home/david/dev/transformers/.env/lib/python3.9/site-packages/mypy/nodes.py\", line 696, in accept\r\n    return visitor.visit_func_def(self)\r\n  File \"/home/david/dev/transformers/.env/lib/python3.9/site-packages/mypy/checker.py\", line 743, in visit_func_def\r\n    self._visit_func_def(defn)\r\n  File \"/home/david/dev/transformers/.env/lib/python3.9/site-packages/mypy/checker.py\", line 747, in _visit_func_def\r\n    self.check_func_item(defn, name=defn.name)\r\n  File \"/home/david/dev/transformers/.env/lib/python3.9/site-packages/mypy/checker.py\", line 809, in check_func_item\r\n    self.check_func_def(defn, typ, name)\r\n  File \"/home/david/dev/transformers/.env/lib/python3.9/site-packages/mypy/checker.py\", line 992, in check_func_def\r\n    self.accept(item.body)\r\n  File \"/home/david/dev/transformers/.env/lib/python3.9/site-packages/mypy/checker.py\", line 411, in accept\r\n    stmt.accept(self)\r\n  File \"/home/david/dev/transformers/.env/lib/python3.9/site-packages/mypy/nodes.py\", line 1024, in accept\r\n    return visitor.visit_block(self)\r\n  File \"/home/david/dev/transformers/.env/lib/python3.9/site-packages/mypy/checker.py\", line 2005, in visit_block\r\n    self.accept(s)\r\n  File \"/home/david/dev/transformers/.env/lib/python3.9/site-packages/mypy/checker.py\", line 411, in accept\r\n    stmt.accept(self)\r\n  File \"/home/david/dev/transformers/.env/lib/python3.9/site-packages/mypy/nodes.py\", line 1216, in accept\r\n    return visitor.visit_if_stmt(self)\r\n  File \"/home/david/dev/transformers/.env/lib/python3.9/site-packages/mypy/checker.py\", line 3350, in visit_if_stmt\r\n    self.accept(b)\r\n  File \"/home/david/dev/transformers/.env/lib/python3.9/site-packages/mypy/checker.py\", line 411, in accept\r\n    stmt.accept(self)\r\n  File \"/home/david/dev/transformers/.env/lib/python3.9/site-packages/mypy/nodes.py\", line 1024, in accept\r\n    return visitor.visit_block(self)\r\n  File \"/home/david/dev/transformers/.env/lib/python3.9/site-packages/mypy/checker.py\", line 2005, in visit_block\r\n    self.accept(s)\r\n  File \"/home/david/dev/transformers/.env/lib/python3.9/site-packages/mypy/checker.py\", line 411, in accept\r\n    stmt.accept(self)\r\n  File \"/home/david/dev/transformers/.env/lib/python3.9/site-packages/mypy/nodes.py\", line 1083, in accept\r\n    return visitor.visit_assignment_stmt(self)\r\n  File \"/home/david/dev/transformers/.env/lib/python3.9/site-packages/mypy/checker.py\", line 2047, in visit_assignment_stmt\r\n    self.check_assignment(s.lvalues[-1], s.rvalue, s.type is None, s.new_syntax)\r\n  File \"/home/david/dev/transformers/.env/lib/python3.9/site-packages/mypy/checker.py\", line 2226, in check_assignment\r\n    self.check_indexed_assignment(index_lvalue, rvalue, lvalue)\r\n  File \"/home/david/dev/transformers/.env/lib/python3.9/site-packages/mypy/checker.py\", line 3208, in check_indexed_assignment\r\n    self.expr_checker.check_method_call(\r\n  File \"/home/david/dev/transformers/.env/lib/python3.9/site-packages/mypy/checkexpr.py\", line 2457, in check_method_call\r\n    return self.check_call(method_type, args, arg_kinds,\r\n  File \"/home/david/dev/transformers/.env/lib/python3.9/site-packages/mypy/checkexpr.py\", line 933, in check_call\r\n    return self.check_callable_call(callee, args, arg_kinds, context, arg_names,\r\n  File \"/home/david/dev/transformers/.env/lib/python3.9/site-packages/mypy/checkexpr.py\", line 1024, in check_callable_call\r\n    arg_types = self.infer_arg_types_in_context(\r\n  File \"/home/david/dev/transformers/.env/lib/python3.9/site-packages/mypy/checkexpr.py\", line 1123, in infer_arg_types_in_context\r\n    res[ai] = self.accept(args[ai], callee.arg_types[i])\r\n  File \"/home/david/dev/transformers/.env/lib/python3.9/site-packages/mypy/checkexpr.py\", line 3912, in accept\r\n    typ = node.accept(self)\r\n  File \"/home/david/dev/transformers/.env/lib/python3.9/site-packages/mypy/nodes.py\", line 1600, in accept\r\n    return visitor.visit_call_expr(self)\r\n  File \"/home/david/dev/transformers/.env/lib/python3.9/site-packages/mypy/checkexpr.py\", line 277, in visit_call_expr\r\n    return self.visit_call_expr_inner(e, allow_none_return=allow_none_return)\r\n  File \"/home/david/dev/transformers/.env/lib/python3.9/site-packages/mypy/checkexpr.py\", line 326, in visit_call_expr_inner\r\n    callee_type = get_proper_type(self.accept(e.callee, type_context, always_allow_any=True))\r\n  File \"/home/david/dev/transformers/.env/lib/python3.9/site-packages/mypy/checkexpr.py\", line 3912, in accept\r\n    typ = node.accept(self)\r\n  File \"/home/david/dev/transformers/.env/lib/python3.9/site-packages/mypy/nodes.py\", line 1520, in accept\r\n    return visitor.visit_member_expr(self)\r\n  File \"/home/david/dev/transformers/.env/lib/python3.9/site-packages/mypy/checkexpr.py\", line 2047, in visit_member_expr\r\n    result = self.analyze_ordinary_member_access(e, is_lvalue)\r\n  File \"/home/david/dev/transformers/.env/lib/python3.9/site-packages/mypy/checkexpr.py\", line 2065, in analyze_ordinary_member_access\r\n    member_type = analyze_member_access(\r\n  File \"/home/david/dev/transformers/.env/lib/python3.9/site-packages/mypy/checkmember.py\", line 126, in analyze_member_access\r\n    result = _analyze_member_access(name, typ, mx, override_info)\r\n  File \"/home/david/dev/transformers/.env/lib/python3.9/site-packages/mypy/checkmember.py\", line 143, in _analyze_member_access\r\n    return analyze_instance_member_access(name, typ, mx, override_info)\r\n  File \"/home/david/dev/transformers/.env/lib/python3.9/site-packages/mypy/checkmember.py\", line 219, in analyze_instance_member_access\r\n    typ = map_instance_to_supertype(typ, method.info)\r\n  File \"/home/david/dev/transformers/.env/lib/python3.9/site-packages/mypy/maptype.py\", line 20, in map_instance_to_supertype\r\n    if not superclass.type_vars:\r\n  File \"/home/david/dev/transformers/.env/lib/python3.9/site-packages/mypy/nodes.py\", line 2656, in __getattribute__\r\n    raise AssertionError(object.__getattribute__(self, 'msg'))\r\nAssertionError: FuncBase for non-methods lack info\r\n```\r\n\r\n**To Reproduce**\r\n\r\nI can reproduce this locally in the following way:\r\n  1. Clone the transformers repo, checkout the `v4.10.0` tag\r\n  2. Create a blank virtualenv and install mypy 0.910 (or mypy master)\r\n  3. Add the following `mypy.ini` file:\r\n     ```\r\n     [mypy]\r\n     check_untyped_defs=True\r\n     ```\r\n  4. Run `mypy src/transformers/trainer.py`\r\n\r\nI'm afraid I tried to reduce to a minimal repro with no success.\r\n\r\n**Your Environment**\r\n\r\n- Mypy version used: 0.910 and master\r\n- Mypy command-line flags: None other than `--show-traceback`\r\n- Mypy configuration options from `mypy.ini` (and other config files): See repo above (just `check_untyped_defs=True`)\r\n- Python version used: tested on 3.8.11 and 3.9.5\r\n- Operating system and version: Ubuntu, tested on 20.04 and 21.04\r\n","closed_by":{"login":"JelleZijlstra","id":906600,"node_id":"MDQ6VXNlcjkwNjYwMA==","avatar_url":"https://avatars.githubusercontent.com/u/906600?v=4","gravatar_id":"","url":"https://api.github.com/users/JelleZijlstra","html_url":"https://github.com/JelleZijlstra","followers_url":"https://api.github.com/users/JelleZijlstra/followers","following_url":"https://api.github.com/users/JelleZijlstra/following{/other_user}","gists_url":"https://api.github.com/users/JelleZijlstra/gists{/gist_id}","starred_url":"https://api.github.com/users/JelleZijlstra/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JelleZijlstra/subscriptions","organizations_url":"https://api.github.com/users/JelleZijlstra/orgs","repos_url":"https://api.github.com/users/JelleZijlstra/repos","events_url":"https://api.github.com/users/JelleZijlstra/events{/privacy}","received_events_url":"https://api.github.com/users/JelleZijlstra/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/python/mypy/issues/11045/reactions","total_count":8,"+1":8,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/python/mypy/issues/11045/timeline","performed_via_github_app":null,"state_reason":"completed"}