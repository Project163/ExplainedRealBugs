{"url":"https://api.github.com/repos/python/mypy/issues/14137","repository_url":"https://api.github.com/repos/python/mypy","labels_url":"https://api.github.com/repos/python/mypy/issues/14137/labels{/name}","comments_url":"https://api.github.com/repos/python/mypy/issues/14137/comments","events_url":"https://api.github.com/repos/python/mypy/issues/14137/events","html_url":"https://github.com/python/mypy/issues/14137","id":1456119458,"node_id":"I_kwDOAGuhRc5Wyp6i","number":14137,"title":"`AssertionError` with nested TypeVar","user":{"login":"cdce8p","id":30130371,"node_id":"MDQ6VXNlcjMwMTMwMzcx","avatar_url":"https://avatars.githubusercontent.com/u/30130371?v=4","gravatar_id":"","url":"https://api.github.com/users/cdce8p","html_url":"https://github.com/cdce8p","followers_url":"https://api.github.com/users/cdce8p/followers","following_url":"https://api.github.com/users/cdce8p/following{/other_user}","gists_url":"https://api.github.com/users/cdce8p/gists{/gist_id}","starred_url":"https://api.github.com/users/cdce8p/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cdce8p/subscriptions","organizations_url":"https://api.github.com/users/cdce8p/orgs","repos_url":"https://api.github.com/users/cdce8p/repos","events_url":"https://api.github.com/users/cdce8p/events{/privacy}","received_events_url":"https://api.github.com/users/cdce8p/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":379446833,"node_id":"MDU6TGFiZWwzNzk0NDY4MzM=","url":"https://api.github.com/repos/python/mypy/labels/crash","name":"crash","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-11-19T02:09:09Z","updated_at":"2022-11-20T00:19:17Z","closed_at":"2022-11-19T15:07:25Z","author_association":"COLLABORATOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Crash Report**\r\n\r\nEncountered this issue while testing the current master branch with Home Assistant (with all requirements installed).\r\nBisected it to #14095.\r\n\r\n/CC: @ilevkivskyi\r\n\r\n**Traceback**\r\n\r\n```\r\n  File \"/home/runner/work/ha-core/ha-core/venv/lib/python3.9/site-packages/mypy/types.py\", line 553, in serialize\r\n    assert not self.id.is_meta_var()\r\nAssertionError\r\n```\r\n\r\n<details>\r\n<summary>Full traceback</summary>\r\n\r\n```\r\n  File \"/home/runner/work/ha-core/ha-core/venv/bin/mypy\", line 8, in <module>\r\n    sys.exit(console_entry())\r\n  File \"/home/runner/work/ha-core/ha-core/venv/lib/python3.9/site-packages/mypy/__main__.py\", line 15, in console_entry\r\n    main()\r\n  File \"/home/runner/work/ha-core/ha-core/venv/lib/python3.9/site-packages/mypy/main.py\", line 95, in main\r\n    res, messages, blockers = run_build(sources, options, fscache, t0, stdout, stderr)\r\n  File \"/home/runner/work/ha-core/ha-core/venv/lib/python3.9/site-packages/mypy/main.py\", line 174, in run_build\r\n    res = build.build(sources, options, None, flush_errors, fscache, stdout, stderr)\r\n  File \"/home/runner/work/ha-core/ha-core/venv/lib/python3.9/site-packages/mypy/build.py\", line 193, in build\r\n    result = _build(\r\n  File \"/home/runner/work/ha-core/ha-core/venv/lib/python3.9/site-packages/mypy/build.py\", line 276, in _build\r\n    graph = dispatch(sources, manager, stdout)\r\n  File \"/home/runner/work/ha-core/ha-core/venv/lib/python3.9/site-packages/mypy/build.py\", line 2900, in dispatch\r\n    process_graph(graph, manager)\r\n  File \"/home/runner/work/ha-core/ha-core/venv/lib/python3.9/site-packages/mypy/build.py\", line 3288, in process_graph\r\n    process_stale_scc(graph, scc, manager)\r\n  File \"/home/runner/work/ha-core/ha-core/venv/lib/python3.9/site-packages/mypy/build.py\", line 3411, in process_stale_scc\r\n    graph[id].write_cache()\r\n  File \"/home/runner/work/ha-core/ha-core/venv/lib/python3.9/site-packages/mypy/build.py\", line 2481, in write_cache\r\n    new_interface_hash, self.meta = write_cache(\r\n  File \"/home/runner/work/ha-core/ha-core/venv/lib/python3.9/site-packages/mypy/build.py\", line 1571, in write_cache\r\n    data = tree.serialize()\r\n  File \"/home/runner/work/ha-core/ha-core/venv/lib/python3.9/site-packages/mypy/nodes.py\", line 379, in serialize\r\n    \"names\": self.names.serialize(self._fullname),\r\n  File \"/home/runner/work/ha-core/ha-core/venv/lib/python3.9/site-packages/mypy/nodes.py\", line 3779, in serialize\r\n    data[key] = value.serialize(fullname, key)\r\n  File \"/home/runner/work/ha-core/ha-core/venv/lib/python3.9/site-packages/mypy/nodes.py\", line 3716, in serialize\r\n    data[\"node\"] = self.node.serialize()\r\n  File \"/home/runner/work/ha-core/ha-core/venv/lib/python3.9/site-packages/mypy/nodes.py\", line 1034, in serialize\r\n    \"type\": None if self.type is None else self.type.serialize(),\r\n  File \"/home/runner/work/ha-core/ha-core/venv/lib/python3.9/site-packages/mypy/types.py\", line 1322, in serialize\r\n    data[\"args\"] = [arg.serialize() for arg in self.args]\r\n  File \"/home/runner/work/ha-core/ha-core/venv/lib/python3.9/site-packages/mypy/types.py\", line 1322, in <listcomp>\r\n    data[\"args\"] = [arg.serialize() for arg in self.args]\r\n  File \"/home/runner/work/ha-core/ha-core/venv/lib/python3.9/site-packages/mypy/types.py\", line 2016, in serialize\r\n    \"arg_types\": [t.serialize() for t in self.arg_types],\r\n  File \"/home/runner/work/ha-core/ha-core/venv/lib/python3.9/site-packages/mypy/types.py\", line 2016, in <listcomp>\r\n    \"arg_types\": [t.serialize() for t in self.arg_types],\r\n  File \"/home/runner/work/ha-core/ha-core/venv/lib/python3.9/site-packages/mypy/types.py\", line 553, in serialize\r\n    assert not self.id.is_meta_var()\r\nAssertionError\r\n```\r\n</details>\r\n\r\nI did add some debugging calls before the `AssertionError`. The serialization for this object failed\r\n```py\r\n{\r\n  '.class': 'TypeVarType', 'name': '_ZhaEntityT',\r\n  'fullname': 'homeassistant.components.zha.core.registries._ZhaEntityT',\r\n  'id': 13429, 'namespace': '', 'values': [], 'upper_bound': {\r\n    '.class': 'TypeType', 'item': 'homeassistant.components.zha.entity.ZhaEntity'\r\n  }, 'variance': 0\r\n}\r\n```\r\n\r\n**To Reproduce**\r\n\r\nUnfortunately I wasn't yet able to narrow it further to a short code sample.\r\n\r\nHowever, it is easily reproducible with Home Assistant\r\n* Check out [Home Assistant](https://github.com/home-assistant/core)\r\n* Install `attrs==21.2.0` or `types-attrs==19.1.0` (only dependency required to reproduce the error it\r\n* Run `mypy homeassistant/components/zha/core`\r\n\r\n**Your Environment**\r\n\r\n<!-- Include as many relevant details about the environment you experienced the bug in -->\r\n\r\n- Mypy version used: `mypy 1.0.0+dev.a2477ff0d0cb751f27a2b38d27ce6572ead03451 `\r\n- Mypy configuration options from `mypy.ini` (and other config files): see Home Assistant repo\r\n- Python version used: `3.9`\r\n- Operating system and version: `Github actions -> Ubuntu-20.04`","closed_by":{"login":"ilevkivskyi","id":12005495,"node_id":"MDQ6VXNlcjEyMDA1NDk1","avatar_url":"https://avatars.githubusercontent.com/u/12005495?v=4","gravatar_id":"","url":"https://api.github.com/users/ilevkivskyi","html_url":"https://github.com/ilevkivskyi","followers_url":"https://api.github.com/users/ilevkivskyi/followers","following_url":"https://api.github.com/users/ilevkivskyi/following{/other_user}","gists_url":"https://api.github.com/users/ilevkivskyi/gists{/gist_id}","starred_url":"https://api.github.com/users/ilevkivskyi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ilevkivskyi/subscriptions","organizations_url":"https://api.github.com/users/ilevkivskyi/orgs","repos_url":"https://api.github.com/users/ilevkivskyi/repos","events_url":"https://api.github.com/users/ilevkivskyi/events{/privacy}","received_events_url":"https://api.github.com/users/ilevkivskyi/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/python/mypy/issues/14137/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/python/mypy/issues/14137/timeline","performed_via_github_app":null,"state_reason":"completed"}