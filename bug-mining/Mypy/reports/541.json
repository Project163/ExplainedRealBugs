{"url":"https://api.github.com/repos/python/mypy/issues/16286","repository_url":"https://api.github.com/repos/python/mypy","labels_url":"https://api.github.com/repos/python/mypy/issues/16286/labels{/name}","comments_url":"https://api.github.com/repos/python/mypy/issues/16286/comments","events_url":"https://api.github.com/repos/python/mypy/issues/16286/events","html_url":"https://github.com/python/mypy/issues/16286","id":1950150457,"node_id":"I_kwDOAGuhRc50PO85","number":16286,"title":"Narrowing with \"tags\" on unions (of TypedDicts or normal classes) doesn't work with the match statement","user":{"login":"tmke8","id":7741417,"node_id":"MDQ6VXNlcjc3NDE0MTc=","avatar_url":"https://avatars.githubusercontent.com/u/7741417?v=4","gravatar_id":"","url":"https://api.github.com/users/tmke8","html_url":"https://github.com/tmke8","followers_url":"https://api.github.com/users/tmke8/followers","following_url":"https://api.github.com/users/tmke8/following{/other_user}","gists_url":"https://api.github.com/users/tmke8/gists{/gist_id}","starred_url":"https://api.github.com/users/tmke8/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tmke8/subscriptions","organizations_url":"https://api.github.com/users/tmke8/orgs","repos_url":"https://api.github.com/users/tmke8/repos","events_url":"https://api.github.com/users/tmke8/events{/privacy}","received_events_url":"https://api.github.com/users/tmke8/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":21488356,"node_id":"MDU6TGFiZWwyMTQ4ODM1Ng==","url":"https://api.github.com/repos/python/mypy/labels/bug","name":"bug","color":"f9d0c4","default":true,"description":"mypy got something wrong"},{"id":488169816,"node_id":"MDU6TGFiZWw0ODgxNjk4MTY=","url":"https://api.github.com/repos/python/mypy/labels/topic-typed-dict","name":"topic-typed-dict","color":"d4c5f9","default":false,"description":null},{"id":3395837837,"node_id":"LA_kwDOAGuhRc7KaF-N","url":"https://api.github.com/repos/python/mypy/labels/good-second-issue","name":"good-second-issue","color":"329F8C","default":false,"description":""},{"id":3741739123,"node_id":"LA_kwDOAGuhRc7fBmhz","url":"https://api.github.com/repos/python/mypy/labels/topic-match-statement","name":"topic-match-statement","color":"70246D","default":false,"description":"Python 3.10's match statement"},{"id":3945155924,"node_id":"LA_kwDOAGuhRc7rJk1U","url":"https://api.github.com/repos/python/mypy/labels/topic-type-narrowing","name":"topic-type-narrowing","color":"9F31C3","default":false,"description":"Conditional type narrowing / binder"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2023-10-18T16:20:16Z","updated_at":"2025-03-14T01:30:21Z","closed_at":"2025-03-14T01:30:21Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"<!--\r\nIf you're not sure whether what you're experiencing is a mypy bug, please see the \"Question and Help\" form instead.\r\nPlease consider:\r\n\r\n- checking our common issues page: https://mypy.readthedocs.io/en/stable/common_issues.html\r\n- searching our issue tracker: https://github.com/python/mypy/issues to see if it's already been reported\r\n- asking on gitter chat: https://gitter.im/python/typing\r\n-->\r\n\r\n**Bug Report**\r\n\r\n<!--\r\nIf you're reporting a problem with a specific library function, the typeshed tracker is better suited for this report: https://github.com/python/typeshed/issues\r\n\r\nIf the project you encountered the issue in is open source, please provide a link to the project.\r\n-->\r\n\r\nMypy has a feature where a union of TypedDicts can be narrowed down based on the value of entries: https://mypy.readthedocs.io/en/stable/literal_types.html#tagged-unions\r\n\r\nBut this doesn't seem to work with pattern matching.\r\n\r\n**To Reproduce**\r\n\r\n```python\r\nfrom typing import Literal, TypedDict\r\n\r\nclass A(TypedDict):\r\n    tag: Literal[\"a\"]\r\n    name: str\r\n    \r\nclass B(TypedDict):\r\n    tag: Literal[\"b\"]\r\n    num: int\r\n    \r\ndef f(d: A | B) -> None:\r\n    if d[\"tag\"] == \"a\":\r\n        print(d[\"name\"])\r\n    elif d[\"tag\"] == \"b\":\r\n        print(d[\"num\"])\r\n\r\ndef g(d: A | B) -> None:\r\n    match d[\"tag\"]:\r\n        case \"a\":\r\n            print(d[\"name\"])  # E: TypedDict \"B\" has no key \"name\"\r\n        case \"b\":\r\n            print(d[\"num\"])  # E: TypedDict \"A\" has no key \"num\"\r\n```\r\n\r\nhttps://mypy-play.net/?mypy=latest&python=3.11&gist=22cd1c2a185a5182b98e12c1e5dd33e2\r\n\r\n**Expected Behavior**\r\n\r\n<!--\r\nHow did you expect mypy to behave? It’s fine if you’re not sure your understanding is correct.\r\nWrite down what you thought would happen. If you expected no errors, delete this section.\r\n-->\r\nThe narrowing in function `g` should work the same as in function `f`.\r\n\r\n**Actual Behavior**\r\n\r\n<!-- What went wrong? Paste mypy's output. -->\r\n```\r\nmain.py:20: error: TypedDict \"B\" has no key \"name\"  [typeddict-item]\r\nmain.py:22: error: TypedDict \"A\" has no key \"num\"  [typeddict-item]\r\nFound 2 errors in 1 file (checked 1 source file)\r\n```\r\nThe dictionaries are not correctly narrowed in the match branches.\r\n\r\n**Your Environment**\r\n\r\n<!-- Include as many relevant details about the environment you experienced the bug in -->\r\n\r\nSee mypy-play link above.\r\n<!-- You can freely edit this text, please remove all the lines you believe are unnecessary. -->\r\n","closed_by":{"login":"hauntsaninja","id":12621235,"node_id":"MDQ6VXNlcjEyNjIxMjM1","avatar_url":"https://avatars.githubusercontent.com/u/12621235?v=4","gravatar_id":"","url":"https://api.github.com/users/hauntsaninja","html_url":"https://github.com/hauntsaninja","followers_url":"https://api.github.com/users/hauntsaninja/followers","following_url":"https://api.github.com/users/hauntsaninja/following{/other_user}","gists_url":"https://api.github.com/users/hauntsaninja/gists{/gist_id}","starred_url":"https://api.github.com/users/hauntsaninja/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hauntsaninja/subscriptions","organizations_url":"https://api.github.com/users/hauntsaninja/orgs","repos_url":"https://api.github.com/users/hauntsaninja/repos","events_url":"https://api.github.com/users/hauntsaninja/events{/privacy}","received_events_url":"https://api.github.com/users/hauntsaninja/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/python/mypy/issues/16286/reactions","total_count":4,"+1":4,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/python/mypy/issues/16286/timeline","performed_via_github_app":null,"state_reason":"completed"}