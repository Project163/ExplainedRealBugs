{"url":"https://api.github.com/repos/python/mypy/issues/17765","repository_url":"https://api.github.com/repos/python/mypy","labels_url":"https://api.github.com/repos/python/mypy/issues/17765/labels{/name}","comments_url":"https://api.github.com/repos/python/mypy/issues/17765/comments","events_url":"https://api.github.com/repos/python/mypy/issues/17765/events","html_url":"https://github.com/python/mypy/issues/17765","id":2523495159,"node_id":"I_kwDOAGuhRc6WaXr3","number":17765,"title":"Crash when passing too many type arguments to generic base class accepting single ParamSpec","user":{"login":"brianschubert","id":25313350,"node_id":"MDQ6VXNlcjI1MzEzMzUw","avatar_url":"https://avatars.githubusercontent.com/u/25313350?v=4","gravatar_id":"","url":"https://api.github.com/users/brianschubert","html_url":"https://github.com/brianschubert","followers_url":"https://api.github.com/users/brianschubert/followers","following_url":"https://api.github.com/users/brianschubert/following{/other_user}","gists_url":"https://api.github.com/users/brianschubert/gists{/gist_id}","starred_url":"https://api.github.com/users/brianschubert/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/brianschubert/subscriptions","organizations_url":"https://api.github.com/users/brianschubert/orgs","repos_url":"https://api.github.com/users/brianschubert/repos","events_url":"https://api.github.com/users/brianschubert/events{/privacy}","received_events_url":"https://api.github.com/users/brianschubert/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":379446833,"node_id":"MDU6TGFiZWwzNzk0NDY4MzM=","url":"https://api.github.com/repos/python/mypy/labels/crash","name":"crash","color":"b60205","default":false,"description":null},{"id":3853123536,"node_id":"LA_kwDOAGuhRc7lqf_Q","url":"https://api.github.com/repos/python/mypy/labels/topic-paramspec","name":"topic-paramspec","color":"CA9FD9","default":false,"description":"PEP 612, ParamSpec, Concatenate"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2024-09-12T22:55:05Z","updated_at":"2024-09-21T23:45:26Z","closed_at":"2024-09-21T23:45:26Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"<!--\r\n  Use this form only if mypy reports an \"INTERNAL ERROR\" and/or gives a traceback.\r\n  Please include the traceback and all other messages below (use `mypy --show-traceback`).\r\n-->\r\n\r\n**Crash Report**\r\n\r\nA crash occurs when inheriting from a generic type that expects a single `ParamSpec` if too many type arguments are passed. The crash appears to only occur in an inheritance context (passing too many arguments in other contexts does not produce a crash) and when the parent type expects only a single `ParamSpec` (using additional type variables do not produce a crash). \r\n\r\n**Traceback**\r\n\r\n<details><summary>v1.11.2 Traceback</summary>\r\n\r\n```\r\nerror: INTERNAL ERROR -- Please try using mypy master on GitHub:\r\nhttps://mypy.readthedocs.io/en/stable/common_issues.html#using-a-development-mypy-build\r\nPlease report a bug at https://github.com/python/mypy/issues\r\nversion: 1.11.2\r\nTraceback (most recent call last):\r\n  File \"mypy/semanal.py\", line 7087, in accept\r\n  File \"mypy/nodes.py\", line 1183, in accept\r\n  File \"mypy/semanal.py\", line 1700, in visit_class_def\r\n  File \"mypy/semanal.py\", line 1818, in analyze_class\r\n  File \"mypy/semanal.py\", line 2112, in clean_up_bases_and_infer_type_variables\r\n  File \"mypy/semanal.py\", line 7141, in analyze_type_expr\r\n  File \"mypy/nodes.py\", line 2028, in accept\r\n  File \"mypy/semanal.py\", line 5802, in visit_index_expr\r\n  File \"mypy/semanal.py\", line 5808, in analyze_type_application\r\n  File \"mypy/semanal.py\", line 5910, in analyze_type_application_args\r\n  File \"mypy/types.py\", line 1634, in __init__\r\nAssertionError: \r\n```\r\n</details>\r\n\r\n<details><summary>master (1.12.0+dev.0c10367) Traceback</summary>\r\n\r\n```\r\nTraceback (most recent call last):\r\n  File \"<frozen runpy>\", line 198, in _run_module_as_main\r\n  File \"<frozen runpy>\", line 88, in _run_code\r\n  File \"/layers/google.python.pip/pip/lib/python3.12/site-packages/mypy/__main__.py\", line 37, in <module>\r\n    console_entry()\r\n  File \"/layers/google.python.pip/pip/lib/python3.12/site-packages/mypy/__main__.py\", line 15, in console_entry\r\n    main()\r\n  File \"/layers/google.python.pip/pip/lib/python3.12/site-packages/mypy/main.py\", line 102, in main\r\n    res, messages, blockers = run_build(sources, options, fscache, t0, stdout, stderr)\r\n  File \"/layers/google.python.pip/pip/lib/python3.12/site-packages/mypy/main.py\", line 186, in run_build\r\n    res = build.build(sources, options, None, flush_errors, fscache, stdout, stderr)\r\n  File \"/layers/google.python.pip/pip/lib/python3.12/site-packages/mypy/build.py\", line 193, in build\r\n    result = _build(\r\n  File \"/layers/google.python.pip/pip/lib/python3.12/site-packages/mypy/build.py\", line 268, in _build\r\n    graph = dispatch(sources, manager, stdout)\r\n  File \"/layers/google.python.pip/pip/lib/python3.12/site-packages/mypy/build.py\", line 2950, in dispatch\r\n    process_graph(graph, manager)\r\n  File \"/layers/google.python.pip/pip/lib/python3.12/site-packages/mypy/build.py\", line 3348, in process_graph\r\n    process_stale_scc(graph, scc, manager)\r\n  File \"/layers/google.python.pip/pip/lib/python3.12/site-packages/mypy/build.py\", line 3443, in process_stale_scc\r\n    mypy.semanal_main.semantic_analysis_for_scc(graph, scc, manager.errors)\r\n  File \"/layers/google.python.pip/pip/lib/python3.12/site-packages/mypy/semanal_main.py\", line 93, in semantic_analysis_for_scc\r\n    process_top_levels(graph, scc, patches)\r\n  File \"/layers/google.python.pip/pip/lib/python3.12/site-packages/mypy/semanal_main.py\", line 220, in process_top_levels\r\n    deferred, incomplete, progress = semantic_analyze_target(\r\n  File \"/layers/google.python.pip/pip/lib/python3.12/site-packages/mypy/semanal_main.py\", line 351, in semantic_analyze_target\r\n    analyzer.refresh_partial(\r\n  File \"/layers/google.python.pip/pip/lib/python3.12/site-packages/mypy/semanal.py\", line 619, in refresh_partial\r\n    self.refresh_top_level(node)\r\n  File \"/layers/google.python.pip/pip/lib/python3.12/site-packages/mypy/semanal.py\", line 630, in refresh_top_level\r\n    self.accept(d)\r\n  File \"/layers/google.python.pip/pip/lib/python3.12/site-packages/mypy/semanal.py\", line 7087, in accept\r\n    node.accept(self)\r\n  File \"/layers/google.python.pip/pip/lib/python3.12/site-packages/mypy/nodes.py\", line 1183, in accept\r\n    return visitor.visit_class_def(self)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/layers/google.python.pip/pip/lib/python3.12/site-packages/mypy/semanal.py\", line 1700, in visit_class_def\r\n    self.analyze_class(defn)\r\n  File \"/layers/google.python.pip/pip/lib/python3.12/site-packages/mypy/semanal.py\", line 1818, in analyze_class\r\n    bases, tvar_defs, is_protocol = self.clean_up_bases_and_infer_type_variables(\r\n                                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/layers/google.python.pip/pip/lib/python3.12/site-packages/mypy/semanal.py\", line 2112, in clean_up_bases_and_infer_type_variables\r\n    self.analyze_type_expr(base_expr)\r\n  File \"/layers/google.python.pip/pip/lib/python3.12/site-packages/mypy/semanal.py\", line 7141, in analyze_type_expr\r\n    expr.accept(self)\r\n  File \"/layers/google.python.pip/pip/lib/python3.12/site-packages/mypy/nodes.py\", line 2028, in accept\r\n    return visitor.visit_index_expr(self)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/layers/google.python.pip/pip/lib/python3.12/site-packages/mypy/semanal.py\", line 5802, in visit_index_expr\r\n    self.analyze_type_application(expr)\r\n  File \"/layers/google.python.pip/pip/lib/python3.12/site-packages/mypy/semanal.py\", line 5808, in analyze_type_application\r\n    types = self.analyze_type_application_args(expr)\r\n            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/layers/google.python.pip/pip/lib/python3.12/site-packages/mypy/semanal.py\", line 5910, in analyze_type_application_args\r\n    types = [Parameters(types, [ARG_POS] * len(types), [None] * len(types))]\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/layers/google.python.pip/pip/lib/python3.12/site-packages/mypy/types.py\", line 1634, in __init__\r\n    assert not any(isinstance(t, Parameters) for t in arg_types)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nAssertionError: \r\n\r\nmain.py:13: error: INTERNAL ERROR -- Please try using mypy master on GitHub:\r\nhttps://mypy.readthedocs.io/en/stable/common_issues.html#using-a-development-mypy-build\r\nPlease report a bug at https://github.com/python/mypy/issues\r\nversion: 1.12.0+dev.0c1036717578b00e35625cc353a538e4eb63bc37\r\nmain.py:13: : note: use --pdb to drop into pdb\r\n```\r\n</details>\r\n\r\n**To Reproduce**\r\n\r\nReproducers in mypy playground: [v1.11.2](https://mypy-play.net/?mypy=1.11.2&python=3.12&flags=show-traceback&gist=aac50b2494dc65d4de5d49a40c86de5a), [`master`](https://mypy-play.net/?mypy=master&python=3.12&flags=show-traceback&gist=ea025820cc068c0e873db075702785af)\r\n\r\n```python\r\nfrom typing import ParamSpec, Generic\r\n\r\nP = ParamSpec(\"P\")\r\n\r\n\r\nclass FooP(Generic[P]):\r\n    pass\r\n\r\n\r\n# CRASH - extraneous type parameter\r\nclass Bar1(FooP[[int, int], str]):\r\n    pass\r\n\r\n\r\n# CRASH - extraneous parameter spec\r\nclass Bar2(FooP[[int, int], [int, int]]):\r\n    pass\r\n````\r\nAdditionally, the following similar setups fail to reproduce the crash:\r\n\r\n<details><summary>Non-reproducers</summary>\r\n\r\n```python\r\nfrom typing import TypeVar, ParamSpec, Generic\r\n\r\nT = TypeVar(\"T\")\r\nP = ParamSpec(\"P\")\r\nQ = ParamSpec(\"Q\")\r\n\r\n\r\nclass FooP(Generic[P]):\r\n    pass\r\n\r\n\r\nclass FooTP(Generic[T, P]):\r\n    pass\r\n\r\n\r\nclass FooPQ(Generic[P, Q]):\r\n    pass\r\n\r\n\r\nx1: FooP[int, int]  # ok\r\nx2: FooP[[int, int]]  # ok\r\n\r\n# Crash when inheriting, but valid type error here.\r\n# error: Nested parameter specifications are not allowed\r\nx3: FooP[[int, int], str]\r\n\r\n\r\n# ok\r\nclass BarP1(FooP[int, int]):\r\n    pass\r\n\r\n\r\n# ok\r\nclass BarP2(FooP[[int, int]]):\r\n    pass\r\n\r\n\r\n# CRASH case from reproducer above\r\n# class BarP3(FooP[[int, int], str]):\r\n#     pass\r\n\r\n\r\n# ok\r\nclass BarTP1(FooTP[int, [int, int]]):\r\n    pass\r\n\r\n\r\n# \"FooTP\" expects 2 type arguments, but 3 given\r\nclass BarTP2(FooTP[int, [int, int], str]):\r\n    pass\r\n\r\n\r\n# ok\r\nclass BarPQ1(FooPQ[[int, int], [int, int]]):\r\n    pass\r\n\r\n\r\n# \"FooPQ\" expects 2 type arguments, but 3 given\r\nclass BarPQ2(FooPQ[[int, int], [int, int], str]):\r\n    pass\r\n```\r\n</details>\r\n\r\n**Your Environment**\r\n\r\n<!-- Include as many relevant details about the environment you experienced the bug in -->\r\n\r\n- Mypy version used: 1.11.2, 1.12.0+dev.0c10367\r\n- Mypy command-line flags: `--show-traceback`\r\n- Mypy configuration options from `mypy.ini` (and other config files): Defaults (confirmed by `mypy --verbose`)\r\n- Python version used: 3.10.12\r\n- Operating system and version: Mint 21.3\r\n\r\n<!--\r\nYou can freely edit this text, please remove all the lines\r\nyou believe are unnecessary.\r\n-->\r\n","closed_by":{"login":"hauntsaninja","id":12621235,"node_id":"MDQ6VXNlcjEyNjIxMjM1","avatar_url":"https://avatars.githubusercontent.com/u/12621235?v=4","gravatar_id":"","url":"https://api.github.com/users/hauntsaninja","html_url":"https://github.com/hauntsaninja","followers_url":"https://api.github.com/users/hauntsaninja/followers","following_url":"https://api.github.com/users/hauntsaninja/following{/other_user}","gists_url":"https://api.github.com/users/hauntsaninja/gists{/gist_id}","starred_url":"https://api.github.com/users/hauntsaninja/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hauntsaninja/subscriptions","organizations_url":"https://api.github.com/users/hauntsaninja/orgs","repos_url":"https://api.github.com/users/hauntsaninja/repos","events_url":"https://api.github.com/users/hauntsaninja/events{/privacy}","received_events_url":"https://api.github.com/users/hauntsaninja/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/python/mypy/issues/17765/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/python/mypy/issues/17765/timeline","performed_via_github_app":null,"state_reason":"completed"}