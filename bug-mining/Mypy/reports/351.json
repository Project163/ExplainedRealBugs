{"url":"https://api.github.com/repos/python/mypy/issues/15618","repository_url":"https://api.github.com/repos/python/mypy","labels_url":"https://api.github.com/repos/python/mypy/issues/15618/labels{/name}","comments_url":"https://api.github.com/repos/python/mypy/issues/15618/comments","events_url":"https://api.github.com/repos/python/mypy/issues/15618/events","html_url":"https://github.com/python/mypy/issues/15618","id":1793065458,"node_id":"I_kwDOAGuhRc5q4AHy","number":15618,"title":"Crash when iterating a Tuple list of @dataclass Protocol","user":{"login":"Kevin-Lovato","id":51749178,"node_id":"MDQ6VXNlcjUxNzQ5MTc4","avatar_url":"https://avatars.githubusercontent.com/u/51749178?v=4","gravatar_id":"","url":"https://api.github.com/users/Kevin-Lovato","html_url":"https://github.com/Kevin-Lovato","followers_url":"https://api.github.com/users/Kevin-Lovato/followers","following_url":"https://api.github.com/users/Kevin-Lovato/following{/other_user}","gists_url":"https://api.github.com/users/Kevin-Lovato/gists{/gist_id}","starred_url":"https://api.github.com/users/Kevin-Lovato/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Kevin-Lovato/subscriptions","organizations_url":"https://api.github.com/users/Kevin-Lovato/orgs","repos_url":"https://api.github.com/users/Kevin-Lovato/repos","events_url":"https://api.github.com/users/Kevin-Lovato/events{/privacy}","received_events_url":"https://api.github.com/users/Kevin-Lovato/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":379446833,"node_id":"MDU6TGFiZWwzNzk0NDY4MzM=","url":"https://api.github.com/repos/python/mypy/labels/crash","name":"crash","color":"b60205","default":false,"description":null},{"id":681535222,"node_id":"MDU6TGFiZWw2ODE1MzUyMjI=","url":"https://api.github.com/repos/python/mypy/labels/topic-protocols","name":"topic-protocols","color":"0052cc","default":false,"description":null},{"id":3945206226,"node_id":"LA_kwDOAGuhRc7rJxHS","url":"https://api.github.com/repos/python/mypy/labels/topic-dataclasses","name":"topic-dataclasses","color":"8E9730","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2023-07-07T08:33:26Z","updated_at":"2023-07-14T09:58:25Z","closed_at":"2023-07-14T09:58:25Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"<!--\r\n  Use this form only if mypy reports an \"INTERNAL ERROR\" and/or gives a traceback.\r\n  Please include the traceback and all other messages below (use `mypy --show-traceback`).\r\n-->\r\n\r\n**Crash Report**\r\n\r\nMyPy crashes when trying to validate a code bit enumerating a `List[Tuple[MyType, MyType]]` where `MyType` is a `@dataclass` decorated `Protocol` (see example code below).\r\n\r\n**Traceback**\r\n\r\n(Paths redacted)\r\n```\r\nkevin.lovato@laptop folder % mypy --show-traceback mypy_test.py\r\nmypy_test.py: error: INTERNAL ERROR -- Please try using mypy master on GitHub:\r\nhttps://mypy.readthedocs.io/en/stable/common_issues.html#using-a-development-mypy-build\r\nPlease report a bug at https://github.com/python/mypy/issues\r\nversion: 1.5.0+dev.e0b159e0bb6bd414d2999bfcecbb5432541ec3fd\r\nTraceback (most recent call last):\r\n  File \".../.venv/bin/mypy\", line 8, in <module>\r\n    sys.exit(console_entry())\r\n  File \".../lib/python3.10/site-packages/mypy/__main__.py\", line 15, in console_entry\r\n    main()\r\n  File \".../lib/python3.10/site-packages/mypy/main.py\", line 94, in main\r\n    res, messages, blockers = run_build(sources, options, fscache, t0, stdout, stderr)\r\n  File \".../lib/python3.10/site-packages/mypy/main.py\", line 173, in run_build\r\n    res = build.build(sources, options, None, flush_errors, fscache, stdout, stderr)\r\n  File \".../lib/python3.10/site-packages/mypy/build.py\", line 195, in build\r\n    result = _build(\r\n  File \".../lib/python3.10/site-packages/mypy/build.py\", line 268, in _build\r\n    graph = dispatch(sources, manager, stdout)\r\n  File \".../lib/python3.10/site-packages/mypy/build.py\", line 2927, in dispatch\r\n    process_graph(graph, manager)\r\n  File \".../lib/python3.10/site-packages/mypy/build.py\", line 3325, in process_graph\r\n    process_stale_scc(graph, scc, manager)\r\n  File \".../lib/python3.10/site-packages/mypy/build.py\", line 3420, in process_stale_scc\r\n    mypy.semanal_main.semantic_analysis_for_scc(graph, scc, manager.errors)\r\n  File \".../lib/python3.10/site-packages/mypy/semanal_main.py\", line 101, in semantic_analysis_for_scc\r\n    check_type_arguments(graph, scc, errors)\r\n  File \".../lib/python3.10/site-packages/mypy/semanal_main.py\", line 385, in check_type_arguments\r\n    with state.wrap_context():\r\n  File \".../.pyenv/versions/3.10.6/lib/python3.10/contextlib.py\", line 153, in __exit__\r\n    self.gen.throw(typ, value, traceback)\r\n  File \".../lib/python3.10/site-packages/mypy/build.py\", line 2069, in wrap_context\r\n    yield\r\n  File \".../lib/python3.10/site-packages/mypy/semanal_main.py\", line 387, in check_type_arguments\r\n    state.tree.accept(analyzer)\r\n  File \".../lib/python3.10/site-packages/mypy/nodes.py\", line 377, in accept\r\n    return visitor.visit_mypy_file(self)\r\n  File \".../lib/python3.10/site-packages/mypy/semanal_typeargs.py\", line 59, in visit_mypy_file\r\n    super().visit_mypy_file(o)\r\n  File \".../lib/python3.10/site-packages/mypy/traverser.py\", line 114, in visit_mypy_file\r\n    d.accept(self)\r\n  File \".../lib/python3.10/site-packages/mypy/nodes.py\", line 788, in accept\r\n    return visitor.visit_func_def(self)\r\n  File \".../lib/python3.10/site-packages/mypy/traverser.py\", line 133, in visit_func_def\r\n    self.visit_func(o)\r\n  File \".../lib/python3.10/site-packages/mypy/semanal_typeargs.py\", line 65, in visit_func\r\n    super().visit_func(defn)\r\n  File \".../lib/python3.10/site-packages/mypy/mixedtraverser.py\", line 37, in visit_func\r\n    super().visit_func(o)\r\n  File \".../lib/python3.10/site-packages/mypy/traverser.py\", line 128, in visit_func\r\n    self.visit_var(arg.variable)\r\n  File \".../lib/python3.10/site-packages/mypy/mixedtraverser.py\", line 34, in visit_var\r\n    self.visit_optional_type(var.type)\r\n  File \".../lib/python3.10/site-packages/mypy/mixedtraverser.py\", line 112, in visit_optional_type\r\n    t.accept(self)\r\n  File \".../lib/python3.10/site-packages/mypy/types.py\", line 1413, in accept\r\n    return visitor.visit_instance(self)\r\n  File \".../lib/python3.10/site-packages/mypy/semanal_typeargs.py\", line 125, in visit_instance\r\n    self.validate_args(info.name, t.args, info.defn.type_vars, t)\r\n  File \".../lib/python3.10/site-packages/mypy/semanal_typeargs.py\", line 174, in validate_args\r\n    if not is_subtype(arg, tvar.upper_bound):\r\n  File \".../lib/python3.10/site-packages/mypy/subtypes.py\", line 177, in is_subtype\r\n    return _is_subtype(left, right, subtype_context, proper_subtype=False)\r\n  File \".../lib/python3.10/site-packages/mypy/subtypes.py\", line 332, in _is_subtype\r\n    return left.accept(SubtypeVisitor(orig_right, subtype_context, proper_subtype))\r\n  File \".../lib/python3.10/site-packages/mypy/types.py\", line 2299, in accept\r\n    return visitor.visit_tuple_type(self)\r\n  File \".../lib/python3.10/site-packages/mypy/subtypes.py\", line 757, in visit_tuple_type\r\n    mypy.typeops.tuple_fallback(left), right\r\n  File \".../lib/python3.10/site-packages/mypy/typeops.py\", line 121, in tuple_fallback\r\n    return Instance(info, [join_type_list(items)], extra_attrs=typ.partial_fallback.extra_attrs)\r\n  File \".../lib/python3.10/site-packages/mypy/join.py\", line 674, in join_type_list\r\n    joined = join_types(joined, t)\r\n  File \".../lib/python3.10/site-packages/mypy/join.py\", line 252, in join_types\r\n    return t.accept(TypeJoinVisitor(s, instance_joiner))\r\n  File \".../lib/python3.10/site-packages/mypy/types.py\", line 1413, in accept\r\n    return visitor.visit_instance(self)\r\n  File \".../lib/python3.10/site-packages/mypy/join.py\", line 329, in visit_instance\r\n    if t.type.is_protocol and is_protocol_implementation(self.s, t):\r\n  File \".../lib/python3.10/site-packages/mypy/subtypes.py\", line 1049, in is_protocol_implementation\r\n    supertype = get_proper_type(find_member(member, right, left))\r\n  File \".../lib/python3.10/site-packages/mypy/subtypes.py\", line 1137, in find_member\r\n    return find_node_type(method, itype, subtype, class_obj=class_obj)\r\n  File \".../lib/python3.10/site-packages/mypy/subtypes.py\", line 1271, in find_node_type\r\n    itype = map_instance_to_supertype(itype, node.info)\r\n  File \".../lib/python3.10/site-packages/mypy/maptype.py\", line 19, in map_instance_to_supertype\r\n    if superclass.fullname == \"builtins.tuple\" and instance.type.tuple_type:\r\n  File \".../lib/python3.10/site-packages/mypy/nodes.py\", line 3409, in __getattribute__\r\n    raise AssertionError(object.__getattribute__(self, \"msg\"))\r\nAssertionError: FuncBase for non-methods lack info\r\nmypy_test.py: : note: use --pdb to drop into pdb\r\n```\r\n\r\n**To Reproduce**\r\n\r\nI used the trunk version of MyPy and ran `mypy --show-traceback mypy_test.py` using the following code snippet:\r\n\r\n``` python\r\nfrom dataclasses import dataclass\r\nfrom datetime import date\r\nfrom typing import Protocol, List, Tuple\r\n\r\n\r\nclass ValidityPeriod:\r\n    start_date: date\r\n    end_date: date | None\r\n\r\n\r\n@dataclass\r\nclass WithValidityPeriod(Protocol):\r\n    validity_period: ValidityPeriod\r\n\r\n    def do_overlap(self, other: \"WithValidityPeriod\") -> bool: ...\r\n\r\n\r\ndef do_periods_overlap(periods: List[Tuple[\"WithValidityPeriod\", \"WithValidityPeriod\"]]) -> bool:\r\n    for period_1, period_2 in periods:\r\n        if period_1.do_overlap(period_2):\r\n            return True\r\n    return False\r\n\r\n\r\n```\r\n\r\n**Your Environment**\r\n\r\n<!-- Include as many relevant details about the environment you experienced the bug in -->\r\n\r\n- Mypy version used: 1.5.0+dev.e0b159e0bb6bd414d2999bfcecbb5432541ec3fd\r\n- Mypy command-line flags: none\r\n- Mypy configuration options from `mypy.ini` (and other config files): none\r\n- Python version used: 3.10.6\r\n- Operating system and version: MacOS Ventura 13.4\r\n\r\n","closed_by":{"login":"JukkaL","id":1107911,"node_id":"MDQ6VXNlcjExMDc5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/1107911?v=4","gravatar_id":"","url":"https://api.github.com/users/JukkaL","html_url":"https://github.com/JukkaL","followers_url":"https://api.github.com/users/JukkaL/followers","following_url":"https://api.github.com/users/JukkaL/following{/other_user}","gists_url":"https://api.github.com/users/JukkaL/gists{/gist_id}","starred_url":"https://api.github.com/users/JukkaL/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JukkaL/subscriptions","organizations_url":"https://api.github.com/users/JukkaL/orgs","repos_url":"https://api.github.com/users/JukkaL/repos","events_url":"https://api.github.com/users/JukkaL/events{/privacy}","received_events_url":"https://api.github.com/users/JukkaL/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/python/mypy/issues/15618/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/python/mypy/issues/15618/timeline","performed_via_github_app":null,"state_reason":"completed"}