{"url":"https://api.github.com/repos/python/mypy/issues/15851","repository_url":"https://api.github.com/repos/python/mypy","labels_url":"https://api.github.com/repos/python/mypy/issues/15851/labels{/name}","comments_url":"https://api.github.com/repos/python/mypy/issues/15851/comments","events_url":"https://api.github.com/repos/python/mypy/issues/15851/events","html_url":"https://github.com/python/mypy/issues/15851","id":1846862578,"node_id":"I_kwDOAGuhRc5uFOLy","number":15851,"title":"false positive: `functools.lru_cache()` breaks `assert_type(..., SomeEnum)`","user":{"login":"finite-state-machine","id":38001514,"node_id":"MDQ6VXNlcjM4MDAxNTE0","avatar_url":"https://avatars.githubusercontent.com/u/38001514?v=4","gravatar_id":"","url":"https://api.github.com/users/finite-state-machine","html_url":"https://github.com/finite-state-machine","followers_url":"https://api.github.com/users/finite-state-machine/followers","following_url":"https://api.github.com/users/finite-state-machine/following{/other_user}","gists_url":"https://api.github.com/users/finite-state-machine/gists{/gist_id}","starred_url":"https://api.github.com/users/finite-state-machine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/finite-state-machine/subscriptions","organizations_url":"https://api.github.com/users/finite-state-machine/orgs","repos_url":"https://api.github.com/users/finite-state-machine/repos","events_url":"https://api.github.com/users/finite-state-machine/events{/privacy}","received_events_url":"https://api.github.com/users/finite-state-machine/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":4073669769,"node_id":"LA_kwDOAGuhRc7yz0SJ","url":"https://api.github.com/repos/python/mypy/labels/assert-type","name":"assert-type","color":"AE2BC4","default":false,"description":"assert_type()"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2023-08-11T12:29:50Z","updated_at":"2023-08-30T19:53:35Z","closed_at":"2023-08-21T12:32:37Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Bug Report**\r\n\r\nInteractions between `@functools.lru_cache` and `Enum`s confuse `assert_type()`, resulting in a false positives.\r\n\r\nReturn values from functions which are decorated by `functools.lru_cache()` and have return type `SomeEnum` are treated as `Any` by `assert_type()`, while return values from undecorated functions work correctly.\r\n\r\nIn all cases, `reveal_type()` reports the expected values, even as `assert_type()` insists the values are of type `Any`.\r\n\r\n**Steps to reproduce**\r\n\r\nIn the following code, `method1()` exhibits the issue while the nearly-identical `method2()` does not.\r\n\r\nThis code is also available on [mypy-play.net](https://mypy-play.net/?mypy=latest&python=3.11&gist=e9d9c7c6848bc5ef0b62ae97bc007d17).\r\n```python\r\nfrom __future__ import annotations\r\n\r\nimport functools\r\nimport random\r\nfrom enum import (\r\n        auto,\r\n        Enum,\r\n        )\r\nfrom typing import (\r\n        Literal,\r\n        )\r\n\r\nfrom typing_extensions import (\r\n        assert_type,\r\n        reveal_type,\r\n        )\r\n\r\nclass SomeEnum(Enum):\r\n    A = auto()\r\n    B = auto()\r\n\r\ndef method1() -> None:\r\n    '''this method demonstrates the issue\r\n    '''\r\n    some_enum: SomeEnum = _inner_method1()\r\n    reveal_type(some_enum)  # 'SomeEnum'\r\n    assert_type(some_enum, SomeEnum)\r\n            # error: Expression is of type \"Any\", not \"SomeEnum\"\r\n            #        [assert-type]\r\n    reveal_type(some_enum)  # 'SomeEnum'\r\n\r\n    # the type can even be manipulated as expected (according to\r\n    # 'reveal_type()') but continues to misbehave with 'assert_type()':\r\n\r\n    if some_enum is SomeEnum.A:\r\n        return\r\n    reveal_type(some_enum)  # 'Literal[SomeEnum.B]'\r\n    assert_type(some_enum, Literal[SomeEnum.B])\r\n            # error: Expression is of type \"Any\", not \"Literal[SomeEnum.B]\"\r\n            #        [assert-type]\r\n    reveal_type(some_enum)  # 'Literal[SomeEnum.B]'\r\n\r\n@functools.lru_cache()\r\ndef _inner_method1() -> SomeEnum:\r\n    '''identical to '_inner_method2()', except that it IS decorated\r\n       with '@functools.lru_cache'\r\n    '''\r\n    if random.random() < 0.50:\r\n        return SomeEnum.A\r\n    return SomeEnum.B\r\n\r\ndef method2() -> None:  # no issues\r\n    '''identical to 'method1()' except that it calls '_inner_method2()'\r\n       instead of '_inner_method1()'\r\n    '''\r\n    some_enum: SomeEnum = _inner_method2()\r\n    reveal_type(some_enum)  # 'SomeEnum'\r\n    assert_type(some_enum, SomeEnum)\r\n            # no error\r\n    reveal_type(some_enum)  # 'SomeEnum'\r\n\r\n    if some_enum is SomeEnum.A:\r\n        return\r\n    reveal_type(some_enum)  # 'Literal[SomeEnum.B]'\r\n    assert_type(some_enum, Literal[SomeEnum.B])\r\n            # no error\r\n    reveal_type(some_enum)  # 'Literal[SomeEnum.B]'\r\n\r\ndef _inner_method2() -> SomeEnum:\r\n    '''identical to '_inner_method1()' except that it's NOT decorated\r\n       with '@functools.lru_cache'\r\n    '''\r\n    if random.random() < 0.50:\r\n        return SomeEnum.A\r\n    return SomeEnum.B\r\n```\r\n\r\n***diff***\r\n\r\nA side-by-side diff of the `method1()` and `method2()` sections:\r\n![diff_of_1s_and_2s](https://github.com/python/mypy/assets/38001514/e1ed2ec4-52ea-4d68-9cfd-7ff0deb6f845)\r\n\r\n<details>\r\n<summary>\r\nAccessible format of diff\r\n</summary>\r\n\r\n```diff\r\n--- one\t2023-08-11 08:06:53\r\n+++ two\t2023-08-11 08:06:57\r\n@@ -1,30 +1,24 @@\r\n-def method1() -> None:\r\n-    '''this method demonstrates the issue\r\n+def method2() -> None:  # no issues\r\n+    '''identical to 'method1()' except that it calls '_inner_method2()'\r\n+       instead of '_inner_method1()'\r\n     '''\r\n-    some_enum: SomeEnum = _inner_method1()\r\n+    some_enum: SomeEnum = _inner_method2()\r\n     reveal_type(some_enum)  # 'SomeEnum'\r\n     assert_type(some_enum, SomeEnum)\r\n-            # error: Expression is of type \"Any\", not \"SomeEnum\"\r\n-            #        [assert-type]\r\n+            # no error\r\n     reveal_type(some_enum)  # 'SomeEnum'\r\n \r\n-    # the type can even be manipulated as expected (according to\r\n-    # 'reveal_type()') but continues to misbehave with 'assert_type()':\r\n-\r\n     if some_enum is SomeEnum.A:\r\n         return\r\n     reveal_type(some_enum)  # 'Literal[SomeEnum.B]'\r\n     assert_type(some_enum, Literal[SomeEnum.B])\r\n-            # error: Expression is of type \"Any\", not \"Literal[SomeEnum.B]\"\r\n-            #        [assert-type]\r\n+            # no error\r\n     reveal_type(some_enum)  # 'Literal[SomeEnum.B]'\r\n \r\n-@functools.lru_cache()\r\n-def _inner_method1() -> SomeEnum:\r\n-    '''identical to '_inner_method2()', except that it IS decorated\r\n+def _inner_method2() -> SomeEnum:\r\n+    '''identical to '_inner_method1()' except that it's NOT decorated\r\n        with '@functools.lru_cache'\r\n     '''\r\n     if random.random() < 0.50:\r\n         return SomeEnum.A\r\n     return SomeEnum.B\r\n```\r\n</details>\r\n\r\n**Expected Behavior**\r\n\r\nAside from notes arising from use of `reveal_type()`, there should be no mypy output.\r\n\r\n**Actual Behavior**\r\n\r\nDecorating `_inner_method1()` with `functools.lru_cache()` causes this issue to manifest. Removing the decoration result in the expected behaviour.\r\n\r\nAfter removing notes arising from `reveal_type()`, the output is (mypy 1.4.1, Python 3.11):\r\n```\r\n# method1:\r\nmain.py:27: error: Expression is of type \"Any\", not \"SomeEnum\"  [assert-type]\r\nmain.py:38: error: Expression is of type \"Any\", not \"Literal[SomeEnum.B]\"  [assert-type]\r\n# method2:\r\n# (silent, as expected)\r\n```\r\n\r\n**Your Environment**\r\n\r\n- Mypy version used: 1.5.0, trunk (2023-08-11)\r\n  - the issue exists at least as far back as mypy 0.950; earlier versions lack `assert_type()`\r\n- Mypy command-line flags: _(none)_\r\n- Mypy configuration options from `mypy.ini` (and other config files): _(none)_\r\n- Python version used: 3.8, 3.11\r\n","closed_by":{"login":"sobolevn","id":4660275,"node_id":"MDQ6VXNlcjQ2NjAyNzU=","avatar_url":"https://avatars.githubusercontent.com/u/4660275?v=4","gravatar_id":"","url":"https://api.github.com/users/sobolevn","html_url":"https://github.com/sobolevn","followers_url":"https://api.github.com/users/sobolevn/followers","following_url":"https://api.github.com/users/sobolevn/following{/other_user}","gists_url":"https://api.github.com/users/sobolevn/gists{/gist_id}","starred_url":"https://api.github.com/users/sobolevn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sobolevn/subscriptions","organizations_url":"https://api.github.com/users/sobolevn/orgs","repos_url":"https://api.github.com/users/sobolevn/repos","events_url":"https://api.github.com/users/sobolevn/events{/privacy}","received_events_url":"https://api.github.com/users/sobolevn/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/python/mypy/issues/15851/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/python/mypy/issues/15851/timeline","performed_via_github_app":null,"state_reason":"completed"}