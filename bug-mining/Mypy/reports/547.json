{"url":"https://api.github.com/repos/python/mypy/issues/18736","repository_url":"https://api.github.com/repos/python/mypy","labels_url":"https://api.github.com/repos/python/mypy/issues/18736/labels{/name}","comments_url":"https://api.github.com/repos/python/mypy/issues/18736/comments","events_url":"https://api.github.com/repos/python/mypy/issues/18736/events","html_url":"https://github.com/python/mypy/issues/18736","id":2878825945,"node_id":"I_kwDOAGuhRc6rl2XZ","number":18736,"title":"Bug when type checking dynamic enum creation in a metaclass","user":{"login":"ahernot","id":70817470,"node_id":"MDQ6VXNlcjcwODE3NDcw","avatar_url":"https://avatars.githubusercontent.com/u/70817470?v=4","gravatar_id":"","url":"https://api.github.com/users/ahernot","html_url":"https://github.com/ahernot","followers_url":"https://api.github.com/users/ahernot/followers","following_url":"https://api.github.com/users/ahernot/following{/other_user}","gists_url":"https://api.github.com/users/ahernot/gists{/gist_id}","starred_url":"https://api.github.com/users/ahernot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ahernot/subscriptions","organizations_url":"https://api.github.com/users/ahernot/orgs","repos_url":"https://api.github.com/users/ahernot/repos","events_url":"https://api.github.com/users/ahernot/events{/privacy}","received_events_url":"https://api.github.com/users/ahernot/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":379446833,"node_id":"MDU6TGFiZWwzNzk0NDY4MzM=","url":"https://api.github.com/repos/python/mypy/labels/crash","name":"crash","color":"b60205","default":false,"description":null},{"id":3542345285,"node_id":"LA_kwDOAGuhRc7TI-ZF","url":"https://api.github.com/repos/python/mypy/labels/topic-enum","name":"topic-enum","color":"47988D","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2025-02-25T15:47:25Z","updated_at":"2025-04-01T17:05:02Z","closed_at":"2025-04-01T17:05:02Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Ran into this bug while type-checking a meta class which dynamically creates and stores an enum of all the target class' properties which are also decorated with a custom `@ocr_series`:\n\n```python\nfrom pydantic import BaseModel\nfrom pydantic._internal._model_construction import ModelMetaclass\nfrom enum import Enum\n\nclass OCRContentMeta(ModelMetaclass):\n    def __new__(mcs, name, bases, namespace):\n        cls = super().__new__(mcs, name, bases, namespace)\n\n        # Collect all ocr_series cached_properties\n        series_names = [\n            name\n            for name, value in namespace.items()\n            if isinstance(value, cached_property)\n            and hasattr(value.func, \"is_ocr_series\")\n        ]\n\n        # Create enum dynamically\n        cls.OCRValidationKind = Enum(\"OCRValidationKind\", {name: name for name in series_names})  #! THIS IS src/my_project/core/document.py:94\n\n        return cls\n```\n```python\nfrom functools import cached_property\n\nclass OCRSeries[T]:\n    ...\n\nclass OCRContent(BaseModel, metaclass=OCRContentMeta):\n    text: str\n\n    @ocr_series  # type: ignore[prop-decorator]\n    @cached_property\n    def numbers_float(self) -> OCRSeries[float]:\n        return OCRSeries[float]([float(x) for x in self.numbers.list])\n\n    ...\n```\n\n\n\n\nMyPy traceback:\n\n`~ uv run mypy --config-file pyproject.toml src/my_project --show-traceback`\n\n```zsh\nsrc/my_project/core/document.py:94: error: Enum type as attribute is not supported  [misc]\nsrc/my_project/core/document.py:94: error: Second argument of Enum() must be string, tuple, list or dict literal for mypy to determine Enum members  [misc]\nsrc/my_project/core/document.py:97: error: Type cannot be declared in assignment to non-self attribute  [misc]\nsrc/my_project/core/document.py:94: error: INTERNAL ERROR -- Please try using mypy master on GitHub:\nhttps://mypy.readthedocs.io/en/stable/common_issues.html#using-a-development-mypy-build\nPlease report a bug at https://github.com/python/mypy/issues\nversion: 1.13.0\nTraceback (most recent call last):\n  File \"mypy/semanal.py\", line 7113, in accept\n  File \"mypy/nodes.py\", line 1351, in accept\n  File \"mypy/semanal.py\", line 3141, in visit_assignment_stmt\n  File \"mypy/semanal.py\", line 3372, in record_special_form_lvalue\nAssertionError: \nsrc/my_project/core/document.py:94: : note: use --pdb to drop into pdb\n```","closed_by":{"login":"JukkaL","id":1107911,"node_id":"MDQ6VXNlcjExMDc5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/1107911?v=4","gravatar_id":"","url":"https://api.github.com/users/JukkaL","html_url":"https://github.com/JukkaL","followers_url":"https://api.github.com/users/JukkaL/followers","following_url":"https://api.github.com/users/JukkaL/following{/other_user}","gists_url":"https://api.github.com/users/JukkaL/gists{/gist_id}","starred_url":"https://api.github.com/users/JukkaL/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JukkaL/subscriptions","organizations_url":"https://api.github.com/users/JukkaL/orgs","repos_url":"https://api.github.com/users/JukkaL/repos","events_url":"https://api.github.com/users/JukkaL/events{/privacy}","received_events_url":"https://api.github.com/users/JukkaL/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/python/mypy/issues/18736/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/python/mypy/issues/18736/timeline","performed_via_github_app":null,"state_reason":"completed"}