{"url":"https://api.github.com/repos/python/mypy/issues/11007","repository_url":"https://api.github.com/repos/python/mypy","labels_url":"https://api.github.com/repos/python/mypy/issues/11007/labels{/name}","comments_url":"https://api.github.com/repos/python/mypy/issues/11007/comments","events_url":"https://api.github.com/repos/python/mypy/issues/11007/events","html_url":"https://github.com/python/mypy/issues/11007","id":976230025,"node_id":"MDU6SXNzdWU5NzYyMzAwMjU=","number":11007,"title":"Internal error checking xarray with `--check-untyped-defs`","user":{"login":"tlambert03","id":1609449,"node_id":"MDQ6VXNlcjE2MDk0NDk=","avatar_url":"https://avatars.githubusercontent.com/u/1609449?v=4","gravatar_id":"","url":"https://api.github.com/users/tlambert03","html_url":"https://github.com/tlambert03","followers_url":"https://api.github.com/users/tlambert03/followers","following_url":"https://api.github.com/users/tlambert03/following{/other_user}","gists_url":"https://api.github.com/users/tlambert03/gists{/gist_id}","starred_url":"https://api.github.com/users/tlambert03/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tlambert03/subscriptions","organizations_url":"https://api.github.com/users/tlambert03/orgs","repos_url":"https://api.github.com/users/tlambert03/repos","events_url":"https://api.github.com/users/tlambert03/events{/privacy}","received_events_url":"https://api.github.com/users/tlambert03/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":379446833,"node_id":"MDU6TGFiZWwzNzk0NDY4MzM=","url":"https://api.github.com/repos/python/mypy/labels/crash","name":"crash","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2021-08-21T21:57:53Z","updated_at":"2021-09-14T06:42:06Z","closed_at":"2021-09-14T06:42:06Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Crash Report**\r\n\r\nNot sure whether this is a mypy issue, or an xarray issue... but I'm getting `RuntimeError: TypeGuard should not appear here` when running mypy on a file that imports [xarray](https://github.com/pydata/xarray) when using the `--check-untyped-defs` flag.  Minimal env on mypy master:\r\n\r\n**To Reproduce**\r\n\r\n```\r\nconda create -n test -c conda-forge python\r\nconda activate test\r\npip install xarray\r\npip install git+https://github.com/python/mypy.git\r\necho \"import xarray\" > m.py\r\nmypy --check-untyped-defs --show-traceback m.py\r\n``` \r\n\r\n**Traceback**\r\n\r\n```\r\n❯ mypy --check-untyped-defs --show-traceback m.py\r\n/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/xarray/core/common.py:1659: error: INTERNAL ERROR -- Please try using mypy master on Github:\r\nhttps://mypy.readthedocs.io/en/stable/common_issues.html#using-a-development-mypy-build\r\nPlease report a bug at https://github.com/python/mypy/issues\r\nversion: 0.920+dev.7576f659d42ee271c78e69d7481b9d49517a49f6\r\nTraceback (most recent call last):\r\n  File \"/Users/talley/miniconda3/envs/test/bin/mypy\", line 8, in <module>\r\n    sys.exit(console_entry())\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/__main__.py\", line 11, in console_entry\r\n    main(None, sys.stdout, sys.stderr)\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/main.py\", line 87, in main\r\n    res, messages, blockers = run_build(sources, options, fscache, t0, stdout, stderr)\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/main.py\", line 165, in run_build\r\n    res = build.build(sources, options, None, flush_errors, fscache, stdout, stderr)\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/build.py\", line 179, in build\r\n    result = _build(\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/build.py\", line 254, in _build\r\n    graph = dispatch(sources, manager, stdout)\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/build.py\", line 2707, in dispatch\r\n    process_graph(graph, manager)\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/build.py\", line 3031, in process_graph\r\n    process_stale_scc(graph, scc, manager)\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/build.py\", line 3129, in process_stale_scc\r\n    graph[id].type_check_first_pass()\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/build.py\", line 2175, in type_check_first_pass\r\n    self.type_checker().check_first_pass()\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/checker.py\", line 295, in check_first_pass\r\n    self.accept(d)\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/checker.py\", line 402, in accept\r\n    stmt.accept(self)\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/nodes.py\", line 530, in accept\r\n    return visitor.visit_overloaded_func_def(self)\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/checker.py\", line 435, in visit_overloaded_func_def\r\n    self._visit_overloaded_func_def(defn)\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/checker.py\", line 457, in _visit_overloaded_func_def\r\n    defn.impl.accept(self)\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/nodes.py\", line 696, in accept\r\n    return visitor.visit_func_def(self)\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/checker.py\", line 734, in visit_func_def\r\n    self._visit_func_def(defn)\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/checker.py\", line 738, in _visit_func_def\r\n    self.check_func_item(defn, name=defn.name)\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/checker.py\", line 800, in check_func_item\r\n    self.check_func_def(defn, typ, name)\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/checker.py\", line 983, in check_func_def\r\n    self.accept(item.body)\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/checker.py\", line 402, in accept\r\n    stmt.accept(self)\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/nodes.py\", line 1024, in accept\r\n    return visitor.visit_block(self)\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/checker.py\", line 1996, in visit_block\r\n    self.accept(s)\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/checker.py\", line 402, in accept\r\n    stmt.accept(self)\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/nodes.py\", line 1216, in accept\r\n    return visitor.visit_if_stmt(self)\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/checker.py\", line 3313, in visit_if_stmt\r\n    self.accept(b)\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/checker.py\", line 402, in accept\r\n    stmt.accept(self)\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/nodes.py\", line 1024, in accept\r\n    return visitor.visit_block(self)\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/checker.py\", line 1996, in visit_block\r\n    self.accept(s)\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/checker.py\", line 402, in accept\r\n    stmt.accept(self)\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/nodes.py\", line 1216, in accept\r\n    return visitor.visit_if_stmt(self)\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/checker.py\", line 3303, in visit_if_stmt\r\n    t = get_proper_type(self.expr_checker.accept(e))\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/checkexpr.py\", line 3910, in accept\r\n    typ = node.accept(self)\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/nodes.py\", line 1663, in accept\r\n    return visitor.visit_unary_expr(self)\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/checkexpr.py\", line 2873, in visit_unary_expr\r\n    operand_type = self.accept(e.expr)\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/checkexpr.py\", line 3910, in accept\r\n    typ = node.accept(self)\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/nodes.py\", line 1600, in accept\r\n    return visitor.visit_call_expr(self)\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/checkexpr.py\", line 277, in visit_call_expr\r\n    return self.visit_call_expr_inner(e, allow_none_return=allow_none_return)\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/checkexpr.py\", line 366, in visit_call_expr_inner\r\n    ret_type = self.check_call_expr_with_callee_type(callee_type, e, fullname,\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/checkexpr.py\", line 873, in check_call_expr_with_callee_type\r\n    return self.check_call(callee_type, e.args, e.arg_kinds, e,\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/checkexpr.py\", line 933, in check_call\r\n    return self.check_callable_call(callee, args, arg_kinds, context, arg_names,\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/checkexpr.py\", line 1030, in check_callable_call\r\n    self.check_argument_types(arg_types, arg_kinds, args, callee, formal_to_actual, context,\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/checkexpr.py\", line 1493, in check_argument_types\r\n    check_arg(expanded_actual, actual_type, arg_kinds[actual],\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/checkexpr.py\", line 1523, in check_arg\r\n    elif not is_subtype(caller_type, callee_type):\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/subtypes.py\", line 93, in is_subtype\r\n    return _is_subtype(left, right,\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/subtypes.py\", line 147, in _is_subtype\r\n    return left.accept(SubtypeVisitor(orig_right,\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/types.py\", line 1747, in accept\r\n    return visitor.visit_union_type(self)\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/subtypes.py\", line 476, in visit_union_type\r\n    return all(self._is_subtype(item, self.orig_right) for item in left.items)\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/subtypes.py\", line 476, in <genexpr>\r\n    return all(self._is_subtype(item, self.orig_right) for item in left.items)\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/subtypes.py\", line 205, in _is_subtype\r\n    return is_subtype(left, right,\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/subtypes.py\", line 93, in is_subtype\r\n    return _is_subtype(left, right,\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/subtypes.py\", line 147, in _is_subtype\r\n    return left.accept(SubtypeVisitor(orig_right,\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/types.py\", line 296, in accept\r\n    return visitor.visit_type_guard_type(self)\r\n  File \"/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/mypy/subtypes.py\", line 479, in visit_type_guard_type\r\n    raise RuntimeError(\"TypeGuard should not appear here\")\r\nRuntimeError: TypeGuard should not appear here\r\n/Users/talley/miniconda3/envs/test/lib/python3.9/site-packages/xarray/core/common.py:1659: : note: use --pdb to drop into pdb\r\n```\r\n\r\n\r\n\r\n**Your Environment**\r\n\r\n- Mypy version used: 0.920+dev.7576f659d42ee271c78e69d7481b9d49517a49f6\r\n- Mypy command-line flags: `--check-untyped-defs`\r\n- Mypy configuration options from `mypy.ini` (and other config files):  no config files\r\n- Python version used: 3.9.6\r\n- Operating system and version: macos 10.15.7\r\n\r\n```\r\n❯ pip list\r\nPackage           Version\r\n----------------- --------------------------------------------------\r\nmypy              0.920+dev.7576f659d42ee271c78e69d7481b9d49517a49f6\r\nmypy-extensions   0.4.3\r\nnumpy             1.21.2\r\npandas            1.3.2\r\npip               21.2.4\r\npython-dateutil   2.8.2\r\npytz              2021.1\r\nsetuptools        57.4.0\r\nsix               1.16.0\r\ntomli             1.1.0\r\ntyping-extensions 3.10.0.0\r\nwheel             0.37.0\r\nxarray            0.19.0\r\n```\r\n","closed_by":{"login":"hauntsaninja","id":12621235,"node_id":"MDQ6VXNlcjEyNjIxMjM1","avatar_url":"https://avatars.githubusercontent.com/u/12621235?v=4","gravatar_id":"","url":"https://api.github.com/users/hauntsaninja","html_url":"https://github.com/hauntsaninja","followers_url":"https://api.github.com/users/hauntsaninja/followers","following_url":"https://api.github.com/users/hauntsaninja/following{/other_user}","gists_url":"https://api.github.com/users/hauntsaninja/gists{/gist_id}","starred_url":"https://api.github.com/users/hauntsaninja/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hauntsaninja/subscriptions","organizations_url":"https://api.github.com/users/hauntsaninja/orgs","repos_url":"https://api.github.com/users/hauntsaninja/repos","events_url":"https://api.github.com/users/hauntsaninja/events{/privacy}","received_events_url":"https://api.github.com/users/hauntsaninja/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/python/mypy/issues/11007/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/python/mypy/issues/11007/timeline","performed_via_github_app":null,"state_reason":"completed"}