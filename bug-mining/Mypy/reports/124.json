{"url":"https://api.github.com/repos/python/mypy/issues/12542","repository_url":"https://api.github.com/repos/python/mypy","labels_url":"https://api.github.com/repos/python/mypy/issues/12542/labels{/name}","comments_url":"https://api.github.com/repos/python/mypy/issues/12542/comments","events_url":"https://api.github.com/repos/python/mypy/issues/12542/events","html_url":"https://github.com/python/mypy/issues/12542","id":1196305298,"node_id":"I_kwDOAGuhRc5HTiuS","number":12542,"title":"\"Parameters cannot be constrained\" with generic ParamSpec","user":{"login":"cdce8p","id":30130371,"node_id":"MDQ6VXNlcjMwMTMwMzcx","avatar_url":"https://avatars.githubusercontent.com/u/30130371?v=4","gravatar_id":"","url":"https://api.github.com/users/cdce8p","html_url":"https://github.com/cdce8p","followers_url":"https://api.github.com/users/cdce8p/followers","following_url":"https://api.github.com/users/cdce8p/following{/other_user}","gists_url":"https://api.github.com/users/cdce8p/gists{/gist_id}","starred_url":"https://api.github.com/users/cdce8p/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cdce8p/subscriptions","organizations_url":"https://api.github.com/users/cdce8p/orgs","repos_url":"https://api.github.com/users/cdce8p/repos","events_url":"https://api.github.com/users/cdce8p/events{/privacy}","received_events_url":"https://api.github.com/users/cdce8p/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":379446833,"node_id":"MDU6TGFiZWwzNzk0NDY4MzM=","url":"https://api.github.com/repos/python/mypy/labels/crash","name":"crash","color":"b60205","default":false,"description":null},{"id":3853123536,"node_id":"LA_kwDOAGuhRc7lqf_Q","url":"https://api.github.com/repos/python/mypy/labels/topic-paramspec","name":"topic-paramspec","color":"CA9FD9","default":false,"description":"PEP 612, ParamSpec, Concatenate"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-04-07T16:38:49Z","updated_at":"2022-04-14T08:49:51Z","closed_at":"2022-04-14T08:49:51Z","author_association":"COLLABORATOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Crash Report**\r\n\r\nRan into this one while implementing generic ParamSpec after #11847 was merged this morning.\r\n/CC: @A5rocks\r\n\r\n**Traceback**\r\n\r\n```\r\nversion: 0.950+dev.e7e1db6a5ad3d07a7a4d46cf280e972f2342a90f\r\nTraceback (most recent call last):\r\n  ...\r\n  File \"/.../mypy/mypy/subtypes.py\", line 927, in is_callable_compatible\r\n    unified = unify_generic_callable(left, right, ignore_return=ignore_return)\r\n  File \"/.../mypy/mypy/subtypes.py\", line 1176, in unify_generic_callable\r\n    c = mypy.constraints.infer_constraints(\r\n  File \"/.../mypy/mypy/constraints.py\", line 108, in infer_constraints\r\n    return _infer_constraints(template, actual, direction)\r\n  File \"/.../mypy/mypy/constraints.py\", line 181, in _infer_constraints\r\n    return template.accept(ConstraintBuilderVisitor(actual, direction))\r\n  File \"/.../mypy/mypy/types.py\", line 1111, in accept\r\n    return visitor.visit_instance(self)\r\n  File \"/.../mypy/mypy/constraints.py\", line 551, in visit_instance\r\n    return self.infer_against_any(template.args, actual)\r\n  File \"/.../mypy/mypy/constraints.py\", line 731, in infer_against_any\r\n    res.extend(infer_constraints(t, any_type, self.direction))\r\n  File \"/.../mypy/mypy/constraints.py\", line 108, in infer_constraints\r\n    return _infer_constraints(template, actual, direction)\r\n  File \"/.../mypy/mypy/constraints.py\", line 181, in _infer_constraints\r\n    return template.accept(ConstraintBuilderVisitor(actual, direction))\r\n  File \"/.../mypy/mypy/types.py\", line 1347, in accept\r\n    return visitor.visit_parameters(self)\r\n  File \"/.../mypy/mypy/constraints.py\", line 410, in visit_parameters\r\n    raise RuntimeError(\"Parameters cannot be constrained to\")\r\nRuntimeError: Parameters cannot be constrained to\r\n```\r\n\r\n**To Reproduce**\r\n\r\n```py\r\nfrom __future__ import annotations\r\n\r\nfrom typing import Any, Callable, Generic, TypeVar\r\nfrom typing_extensions import ParamSpec\r\n\r\n_R = TypeVar(\"_R\")\r\n_P = ParamSpec(\"_P\")\r\n_CallableT = TypeVar(\"_CallableT\", bound=Callable[..., Any])\r\n\r\n\r\ndef callback(func: _CallableT) -> _CallableT:\r\n    # do something\r\n    return func\r\n\r\nclass Job(Generic[_P, _R]):\r\n    def __init__(self, target: Callable[_P, _R]) -> None:\r\n        self.target = target\r\n\r\n\r\n@callback\r\ndef run_job(job: Job[..., _R], *args: Any) -> _R:\r\n    return job.target(*args)\r\n```\r\n\r\nAFAICT the issues is caused by `is_callable_compatible` when two TypeVar / ParamSpec variables are used for a Generic class. In combination with the bound TypeVar `_CallableT`.\r\nhttps://github.com/python/mypy/blob/ab1b48808897d73d6f269c51fc29e5c8078fd303/mypy/subtypes.py#L925-L927\r\nhttps://github.com/python/mypy/blob/75e907d95f99da5b21e83caa94b5734459ce8916/mypy/constraints.py#L409-L410\r\n\r\nModifying `run_job` to either one of these two options resolves the error.\r\n```py\r\n# Don't use TypeVar '_R' inside 'Job' -> only useful for debugging\r\n@callback\r\ndef run_job(job: Job[..., None], *args: Any) -> None:\r\n    return job.target(*args)\r\n```\r\n```py\r\n# A full workaround -> use '_P' directly, even if not used anywhere else.\r\n# It seems to be allowed and acts as '...' / 'Any' in this case anyway.\r\n@callback\r\ndef run_job(job: Job[_P, _R], *args: Any) -> _R:\r\n    return job.target(*args)\r\n```\r\n\r\n**Your Environment**\r\n\r\n- Mypy version used: 0.950+dev.e7e1db6a5ad3d07a7a4d46cf280e972f2342a90f  - 2022-04-07\r\n- Python version used: 3.10.4\r\n","closed_by":{"login":"JukkaL","id":1107911,"node_id":"MDQ6VXNlcjExMDc5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/1107911?v=4","gravatar_id":"","url":"https://api.github.com/users/JukkaL","html_url":"https://github.com/JukkaL","followers_url":"https://api.github.com/users/JukkaL/followers","following_url":"https://api.github.com/users/JukkaL/following{/other_user}","gists_url":"https://api.github.com/users/JukkaL/gists{/gist_id}","starred_url":"https://api.github.com/users/JukkaL/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JukkaL/subscriptions","organizations_url":"https://api.github.com/users/JukkaL/orgs","repos_url":"https://api.github.com/users/JukkaL/repos","events_url":"https://api.github.com/users/JukkaL/events{/privacy}","received_events_url":"https://api.github.com/users/JukkaL/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/python/mypy/issues/12542/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/python/mypy/issues/12542/timeline","performed_via_github_app":null,"state_reason":"completed"}