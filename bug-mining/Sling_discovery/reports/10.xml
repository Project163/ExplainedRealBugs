<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:37:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SLING-10353] ClusterSyncServiceChain can leak a background thread</title>
                <link>https://issues.apache.org/jira/browse/SLING-10353</link>
                <project id="12310710" key="SLING">Sling</project>
                    <description>&lt;p&gt;Invoking a &lt;tt&gt;ClusterSyncService.sync()&lt;/tt&gt; should ensure that if a background thread is running, it gets terminated. In the case of a chain of sync services implemented by &lt;tt&gt;ClusterSyncServiceChain&lt;/tt&gt; there is a race-condition which can leak a background thread running unintentionally.&lt;/p&gt;

&lt;p&gt;The order of events is eg:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;setup: ClusterSyncServiceChain is configured with a chain of a OakBacklogClusterSyncService followed by a SyncTokenService&lt;/li&gt;
	&lt;li&gt;ViewStateManagerImpl.handleNewViewNonDelayed can be called consecutively, as it is protected by a lock. Let&apos;s assume on first invocation it starts a sync process by invoking the ClusterSyncServiceChain.sync()&lt;/li&gt;
	&lt;li&gt;the ClusterSyncServiceChain.sync() will first invoke the OakBacklogClusterSyncService.sync()&lt;/li&gt;
	&lt;li&gt;let&apos;s assume there is a backlog (ie a recovery hasn&apos;t finished yet) with a particular instance in the cluster - so OakBacklogClusterSyncService.sync() will spawn a background thread that checks for that backlog every 2 seconds (handled by AbstractServiceWithBackgroundCheck.BackgroundCheckRunnable.run()).&lt;/li&gt;
	&lt;li&gt;the OakBacklogClusterSyncService background check determines that the backlog is gone and that it can proceed. It will do so by continuing in the ClusterSyncServiceChain - ie it will invoke the SyncTokenService.sync() - that in turn invokes syncToken() - which invokes startBackgroundThread. At this point, let&apos;s assume, the check() returns false - ie there are sync tokens it needs to wait for. Hence it will start a new background Thread for the SyncTokenService.&lt;/li&gt;
	&lt;li&gt;let&apos;s now assume, at some later point ViewStateManagerImpl.handleNewViewNonDelayed is again invoked. So it will again call ClusterSyncServiceChain.sync(). Now it is the responsibility of ClusterSyncServiceChain.sync() to cancel any currently running background thread - but  the first element in the chain (the OakBacklogClusterSyncService) doesn&apos;t actually have any background thread anymore - it has already &quot;handed over&quot; to the SyncTokenService - so the OakBacklogClusterSyncService.cancelPreviousBackgroundCheck() will not have anything to cancel. Hence it goes ahead and follows the sync() chain process - which is first checking for backlog (that has cleared now, as we assumed), and then the sync token (which is not complete, as we assumed). So it will now create a &lt;b&gt;second&lt;/b&gt; background thread.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The above resulting in 2 SyncTokenService background threads.&lt;/p&gt;

&lt;p&gt;This can have a few consequences:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;a behaviour was noticed, whereby &lt;tt&gt;SyncTokenService.storeMySyncToken&lt;/tt&gt; keeps being invoked with toggling values, eg first it stores &lt;tt&gt;627&lt;/tt&gt;, then &lt;tt&gt;628&lt;/tt&gt;, then again &lt;tt&gt;627&lt;/tt&gt;, then &lt;tt&gt;628&lt;/tt&gt; etc. The following is an example of the generated data in DocumentNodeStore as a result ( excerpt from the &lt;tt&gt;&quot;_id&quot; : &quot;4:/var/discovery/oak/syncTokens&quot;&lt;/tt&gt; document ) :
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;	&quot;&amp;lt;slingId&amp;gt;&quot; : {
		&quot;r179378d10da-0-4&quot; : &quot;\&quot;627\&quot;&quot;,
		&quot;r179378d14ce-0-4&quot; : &quot;\&quot;628\&quot;&quot;,
		&quot;r179378d18bc-0-4&quot; : &quot;\&quot;627\&quot;&quot;,
		&quot;r179378d1ca1-0-4&quot; : &quot;\&quot;628\&quot;&quot;,
		&quot;r179378d209c-0-4&quot; : &quot;\&quot;627\&quot;&quot;,
		&quot;r179378d2477-0-4&quot; : &quot;\&quot;628\&quot;&quot;,
		&quot;r179378d287f-0-4&quot; : &quot;\&quot;627\&quot;&quot;,
		&quot;r179378d2c4b-0-4&quot; : &quot;\&quot;628\&quot;&quot;,
		&quot;r179378d3068-0-4&quot; : &quot;\&quot;627\&quot;&quot;,
		&quot;r179378d3421-0-4&quot; : &quot;\&quot;628\&quot;&quot;
	},
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This eventually should clear out - but it can lead to &lt;/p&gt;
	&lt;ul&gt;
		&lt;li&gt;unnecessary lengthening the sync procedure as other cluster nodes will potentially have to wait longer&lt;/li&gt;
		&lt;li&gt;confusion when reading such log files&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;it can also result in conflict exceptions if the two threads want to update simultaneously:
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;04.05.2021 13:22:27.741 *ERROR* [Discovery-AsyncEventSender] org.apache.sling.discovery.commons.providers.spi.base.SyncTokenService storeMySyncToken: got PersistenceException while storing my syncToken:
 org.apache.sling.api.resource.PersistenceException: Unable to commit changes to session.
org.apache.sling.api.resource.PersistenceException: Unable to commit changes to session.
        at org.apache.sling.jcr.resource.internal.helper.jcr.JcrResourceProvider.commit(JcrResourceProvider.java:516) [org.apache.sling.jcr.resource:3.0.22]
        at org.apache.sling.resourceresolver.impl.providers.stateful.AuthenticatedResourceProvider.commit(AuthenticatedResourceProvider.java:215) [org.apache.sling.resourceresolver:1.7.2]
        at org.apache.sling.resourceresolver.impl.helper.ResourceResolverControl.commit(ResourceResolverControl.java:424) [org.apache.sling.resourceresolver:1.7.2]
        at org.apache.sling.resourceresolver.impl.ResourceResolverImpl.commit(ResourceResolverImpl.java:1000) [org.apache.sling.resourceresolver:1.7.2]
        at org.apache.sling.discovery.commons.providers.spi.base.SyncTokenService.storeMySyncToken(SyncTokenService.java:174) [org.apache.sling.discovery.commons:1.0.20]
        at org.apache.sling.discovery.commons.providers.spi.base.SyncTokenService.access$000(SyncTokenService.java:53) [org.apache.sling.discovery.commons:1.0.20]
        at org.apache.sling.discovery.commons.providers.spi.base.SyncTokenService$1.check(SyncTokenService.java:137) [org.apache.sling.discovery.commons:1.0.20]
        at org.apache.sling.discovery.commons.providers.spi.base.AbstractServiceWithBackgroundCheck.startBackgroundCheck(AbstractServiceWithBackgroundCheck.java:199) [org.apache.sling.discovery.commons:
1.0.20]
        at org.apache.sling.discovery.commons.providers.spi.base.SyncTokenService.syncToken(SyncTokenService.java:131) [org.apache.sling.discovery.commons:1.0.20]
        at org.apache.sling.discovery.commons.providers.spi.base.SyncTokenService.sync(SyncTokenService.java:124) [org.apache.sling.discovery.commons:1.0.20]
        at org.apache.sling.discovery.commons.providers.spi.base.ClusterSyncServiceChain.chainedSync(ClusterSyncServiceChain.java:65) [org.apache.sling.discovery.commons:1.0.20]
        at org.apache.sling.discovery.commons.providers.spi.base.ClusterSyncServiceChain.access$000(ClusterSyncServiceChain.java:34) [org.apache.sling.discovery.commons:1.0.20]
        at org.apache.sling.discovery.commons.providers.spi.base.ClusterSyncServiceChain$1.run(ClusterSyncServiceChain.java:69) [org.apache.sling.discovery.commons:1.0.20]
        at org.apache.sling.discovery.commons.providers.spi.base.AbstractServiceWithBackgroundCheck.startBackgroundCheck(AbstractServiceWithBackgroundCheck.java:204) [org.apache.sling.discovery.commons:
1.0.20]
        at org.apache.sling.discovery.commons.providers.spi.base.OakBacklogClusterSyncService.waitWhileBacklog(OakBacklogClusterSyncService.java:142) [org.apache.sling.discovery.commons:1.0.20]
        at org.apache.sling.discovery.commons.providers.spi.base.OakBacklogClusterSyncService.sync(OakBacklogClusterSyncService.java:136) [org.apache.sling.discovery.commons:1.0.20]
        at org.apache.sling.discovery.commons.providers.spi.base.ClusterSyncServiceChain.chainedSync(ClusterSyncServiceChain.java:65) [org.apache.sling.discovery.commons:1.0.20]
        at org.apache.sling.discovery.commons.providers.spi.base.ClusterSyncServiceChain.sync(ClusterSyncServiceChain.java:54) [org.apache.sling.discovery.commons:1.0.20]
        at org.apache.sling.discovery.commons.providers.base.ViewStateManagerImpl$1.trigger(ViewStateManagerImpl.java:548) [org.apache.sling.discovery.commons:1.0.20]
        at org.apache.sling.discovery.commons.providers.base.AsyncEventSender.run(AsyncEventSender.java:118) [org.apache.sling.discovery.commons:1.0.20]
        at java.base/java.lang.Thread.run(Thread.java:834)
Caused by: javax.jcr.InvalidItemStateException: OakState0001: Unresolved conflicts in /var/discovery/oak/syncTokens
        at org.apache.jackrabbit.oak.api.CommitFailedException.asRepositoryException(CommitFailedException.java:238)
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;the 2 threads can also be seen in a thread-dump of course:
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&quot;SyncTokenService&quot; #504 daemon prio=5 os_prio=0 cpu=258.15ms elapsed=47.01s tid=0x000000000f315800 nid=0x449c in Object.wait()  [0x00007f74fd56c000]
   java.lang.Thread.State: TIMED_WAITING (on object monitor)
        at java.lang.Object.wait(java.base@11.0.6/Native Method)
        - waiting on &amp;lt;no object reference available&amp;gt;
        at org.apache.sling.discovery.commons.providers.spi.base.AbstractServiceWithBackgroundCheck$BackgroundCheckRunnable.run(AbstractServiceWithBackgroundCheck.java:98)
        - waiting to re-lock in wait() &amp;lt;0x00000007a8516420&amp;gt; (a java.lang.Object)
        at java.lang.Thread.run(java.base@11.0.6/Thread.java:834)

&quot;SyncTokenService&quot; #530 daemon prio=5 os_prio=0 cpu=0.78ms elapsed=0.96s tid=0x000000000a638800 nid=0x4870 in Object.wait()  [0x00007f74f0bdf000]
   java.lang.Thread.State: TIMED_WAITING (on object monitor)
        at java.lang.Object.wait(java.base@11.0.6/Native Method)
        - waiting on &amp;lt;no object reference available&amp;gt;
        at org.apache.sling.discovery.commons.providers.spi.base.AbstractServiceWithBackgroundCheck$BackgroundCheckRunnable.run(AbstractServiceWithBackgroundCheck.java:98)
        - waiting to re-lock in wait() &amp;lt;0x00000007bfe29640&amp;gt; (a java.lang.Object)
        at java.lang.Thread.run(java.base@11.0.6/Thread.java:834)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="13376850">SLING-10353</key>
            <summary>ClusterSyncServiceChain can leak a background thread</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stefanegli">Stefan Egli</assignee>
                                    <reporter username="stefanegli">Stefan Egli</reporter>
                        <labels>
                    </labels>
                <created>Wed, 5 May 2021 18:33:00 +0000</created>
                <updated>Mon, 7 Jun 2021 13:43:34 +0000</updated>
                            <resolved>Wed, 2 Jun 2021 14:13:27 +0000</resolved>
                                    <version>Discovery Commons 1.0.20</version>
                                    <fixVersion>Discovery Commons 1.0.24</fixVersion>
                                    <component>Discovery</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="17355760" author="egli" created="Wed, 2 Jun 2021 14:13:27 +0000"  >&lt;ul&gt;
	&lt;li&gt;fixed in [this PR|https://github.com/apache/sling-org-apache-sling-discovery-commons/pull/1&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 23 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0qrc0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>