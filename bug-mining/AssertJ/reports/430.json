{"url":"https://api.github.com/repos/assertj/assertj/issues/2279","repository_url":"https://api.github.com/repos/assertj/assertj","labels_url":"https://api.github.com/repos/assertj/assertj/issues/2279/labels{/name}","comments_url":"https://api.github.com/repos/assertj/assertj/issues/2279/comments","events_url":"https://api.github.com/repos/assertj/assertj/issues/2279/events","html_url":"https://github.com/assertj/assertj/issues/2279","id":938061935,"node_id":"MDU6SXNzdWU5MzgwNjE5MzU=","number":2279,"title":"Bug with recursive comparison of objects with String containing %","user":{"login":"abryantsev","id":15727733,"node_id":"MDQ6VXNlcjE1NzI3NzMz","avatar_url":"https://avatars.githubusercontent.com/u/15727733?v=4","gravatar_id":"","url":"https://api.github.com/users/abryantsev","html_url":"https://github.com/abryantsev","followers_url":"https://api.github.com/users/abryantsev/followers","following_url":"https://api.github.com/users/abryantsev/following{/other_user}","gists_url":"https://api.github.com/users/abryantsev/gists{/gist_id}","starred_url":"https://api.github.com/users/abryantsev/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abryantsev/subscriptions","organizations_url":"https://api.github.com/users/abryantsev/orgs","repos_url":"https://api.github.com/users/abryantsev/repos","events_url":"https://api.github.com/users/abryantsev/events{/privacy}","received_events_url":"https://api.github.com/users/abryantsev/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"joel-costigliola","id":382613,"node_id":"MDQ6VXNlcjM4MjYxMw==","avatar_url":"https://avatars.githubusercontent.com/u/382613?v=4","gravatar_id":"","url":"https://api.github.com/users/joel-costigliola","html_url":"https://github.com/joel-costigliola","followers_url":"https://api.github.com/users/joel-costigliola/followers","following_url":"https://api.github.com/users/joel-costigliola/following{/other_user}","gists_url":"https://api.github.com/users/joel-costigliola/gists{/gist_id}","starred_url":"https://api.github.com/users/joel-costigliola/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/joel-costigliola/subscriptions","organizations_url":"https://api.github.com/users/joel-costigliola/orgs","repos_url":"https://api.github.com/users/joel-costigliola/repos","events_url":"https://api.github.com/users/joel-costigliola/events{/privacy}","received_events_url":"https://api.github.com/users/joel-costigliola/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"joel-costigliola","id":382613,"node_id":"MDQ6VXNlcjM4MjYxMw==","avatar_url":"https://avatars.githubusercontent.com/u/382613?v=4","gravatar_id":"","url":"https://api.github.com/users/joel-costigliola","html_url":"https://github.com/joel-costigliola","followers_url":"https://api.github.com/users/joel-costigliola/followers","following_url":"https://api.github.com/users/joel-costigliola/following{/other_user}","gists_url":"https://api.github.com/users/joel-costigliola/gists{/gist_id}","starred_url":"https://api.github.com/users/joel-costigliola/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/joel-costigliola/subscriptions","organizations_url":"https://api.github.com/users/joel-costigliola/orgs","repos_url":"https://api.github.com/users/joel-costigliola/repos","events_url":"https://api.github.com/users/joel-costigliola/events{/privacy}","received_events_url":"https://api.github.com/users/joel-costigliola/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/assertj/assertj/milestones/59","html_url":"https://github.com/assertj/assertj/milestone/59","labels_url":"https://api.github.com/repos/assertj/assertj/milestones/59/labels","id":6658829,"node_id":"MDk6TWlsZXN0b25lNjY1ODgyOQ==","number":59,"title":"3.21.0","description":"","creator":{"login":"joel-costigliola","id":382613,"node_id":"MDQ6VXNlcjM4MjYxMw==","avatar_url":"https://avatars.githubusercontent.com/u/382613?v=4","gravatar_id":"","url":"https://api.github.com/users/joel-costigliola","html_url":"https://github.com/joel-costigliola","followers_url":"https://api.github.com/users/joel-costigliola/followers","following_url":"https://api.github.com/users/joel-costigliola/following{/other_user}","gists_url":"https://api.github.com/users/joel-costigliola/gists{/gist_id}","starred_url":"https://api.github.com/users/joel-costigliola/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/joel-costigliola/subscriptions","organizations_url":"https://api.github.com/users/joel-costigliola/orgs","repos_url":"https://api.github.com/users/joel-costigliola/repos","events_url":"https://api.github.com/users/joel-costigliola/events{/privacy}","received_events_url":"https://api.github.com/users/joel-costigliola/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":31,"state":"closed","created_at":"2021-04-14T05:27:15Z","updated_at":"2021-09-20T08:06:50Z","due_on":null,"closed_at":"2021-09-20T08:06:50Z"},"comments":1,"created_at":"2021-07-06T16:19:25Z","updated_at":"2021-07-08T10:51:59Z","closed_at":"2021-07-08T10:51:59Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"#### Summary\r\nDuring migration from the usage of the `unitils` recursive comparison to the `AssertJ (3.19.0)` we trapped into the issue with flaky tests using `.usingRecursiveComparison()` feature. Unfortunately the summary of the broken test doesn't give too much explanation about the differences because of the not overridden `toString()` method and just looks like (very close example):\r\n```\r\njava.lang.AssertionError: \r\n      Expecting:\r\n        [com.models.response.A@311aa36e]\r\n      to be equal to:\r\n        [com.models.response.A@1432b204]\r\n      when recursively comparing field by field, but found the following difference:\r\n  \r\n      Top level actual and expected objects differ:\r\n      - actual value   : [com.models.response.A@311aa36e]\r\n      - expected value : [com.models.response.A@1432b204]\r\n      The following actual elements were not matched in the expected SingletonSet:\r\n        [com.models.response.A@311aa36e]\r\n  \r\n      The recursive comparison was performed with this configuration:\r\n      - no overridden equals methods were used in the comparison (except for java types)\r\n      - collection order was ignored in all fields in the comparison\r\n      - these types were compared with the following comparators:\r\n        - java.lang.Double -> DoubleComparator[precision=1.0E-15]\r\n        - java.lang.Float -> FloatComparator[precision=1.0E-6]\r\n        - java.math.BigDecimal -> org.assertj.core.util.BigDecimalComparator\r\n      - actual and expected objects and their fields were compared field by field recursively even if they were not of the same type, this allows for example to compare a Person to a PersonDto (call strictTypeChecking(true) to change that behavior).\r\n```\r\n\r\nTrying to get more insights into the root of the differences I have overridden `toString()` method in all models in the hierarchy of the comparing objects and trapped into even more problems catching a bug with String formatting having **% character**. \r\n\r\nThe following snippet shows a part of the stack trace (JDK 15):\r\n```\r\njava.util.UnknownFormatConversionException: Conversion = 'F'\r\n\tat java.base/java.util.Formatter$FormatSpecifier.conversion(Formatter.java:2839)\r\n\tat java.base/java.util.Formatter$FormatSpecifier.<init>(Formatter.java:2865)\r\n\tat java.base/java.util.Formatter.parse(Formatter.java:2713)\r\n\tat java.base/java.util.Formatter.format(Formatter.java:2655)\r\n\tat java.base/java.util.Formatter.format(Formatter.java:2609)\r\n\tat java.base/java.lang.String.format(String.java:3292)\r\n\tat org.assertj.core.api.recursive.comparison.RecursiveComparisonDifferenceCalculator$ComparisonState.addDifference(RecursiveComparisonDifferenceCalculator.java:86)\r\n\tat org.assertj.core.api.recursive.comparison.RecursiveComparisonDifferenceCalculator.compareUnorderedIterables(RecursiveComparisonDifferenceCalculator.java:439)\r\n\tat org.assertj.core.api.recursive.comparison.RecursiveComparisonDifferenceCalculator.determineDifferences(RecursiveComparisonDifferenceCalculator.java:237)\r\n\tat org.assertj.core.api.recursive.comparison.RecursiveComparisonDifferenceCalculator.compareUnorderedIterables(RecursiveComparisonDifferenceCalculator.java:422)\r\n\tat org.assertj.core.api.recursive.comparison.RecursiveComparisonDifferenceCalculator.determineDifferences(RecursiveComparisonDifferenceCalculator.java:237)\r\n\tat org.assertj.core.api.recursive.comparison.RecursiveComparisonDifferenceCalculator.determineDifferences(RecursiveComparisonDifferenceCalculator.java:185)\r\n\tat org.assertj.core.api.RecursiveComparisonAssert.determineDifferencesWith(RecursiveComparisonAssert.java:1201)\r\n\tat org.assertj.core.api.RecursiveComparisonAssert.isEqualTo(RecursiveComparisonAssert.java:160)\r\n```\r\n\r\n#### Example\r\nTo reproduce the bug the following code could be used. Without overridden `toString()` method the comparison fails but the summary is printed.\r\n\r\n```java\r\n    private static class Tuple {\r\n\r\n        private final String a;\r\n        private final String b;\r\n\r\n        public Tuple(String a, String b) {\r\n            this.a = a;\r\n            this.b = b;\r\n        }\r\n\r\n        @Override\r\n        public String toString() {\r\n\r\n            return \"Tuple [a=\" + a + \", b=\" + b + \"]\";\r\n        }\r\n    }\r\n\r\n    private static class TestObj {\r\n\r\n        private final Iterable<Tuple> tuples;\r\n\r\n        public TestObj(Iterable<Tuple> tuples) {\r\n            this.tuples = tuples;\r\n        }\r\n\r\n        @Override\r\n        public String toString() {\r\n\r\n            return \"TestObj [strings=\" + tuples + \"]\";\r\n        }\r\n    }\r\n\r\n    @Test\r\n    void testComparison() {\r\n\r\n        final TestObj first = new TestObj(Set.of(\r\n            new Tuple(\"VtQh0ZAo%2FKCnQcirWL\", \"foo %\"),\r\n            new Tuple(\"%F\", \"VtQh0ZAo%2FKCnQcirWL\")));\r\n        final TestObj second = new TestObj(List.of(\r\n            new Tuple(\"%F\", \"VtQh0ZAo%2FKCnQcirWL\"),\r\n            new Tuple(\"VtQh0ZAo%2FKCnQcirWL\", \"bar %\")));\r\n\r\n        assertThat(first)\r\n            .usingRecursiveComparison()\r\n            .ignoringCollectionOrder()\r\n            .isEqualTo(second);\r\n    }\r\n```\r\n\r\nIs it is a known bug or something new? Could you please advise a workaround if it is available? I couldn't find any looking into the source code. It looks like executing this code\r\n```java\r\n    if (!unmatchedActualElements.isEmpty()) {\r\n      String unmatched = format(\"The following actual elements were not matched in the expected %s:%n  %s\",\r\n                                expected.getClass().getSimpleName(), unmatchedActualElements);\r\n      comparisonState.addDifference(dualValue, unmatched);\r\n    }\r\n```\r\nit implicitly calls formatting of the string that represents summary of the unmatched elements that in turn can have special characters thus bug is imminent.\r\n```java\r\ndifferences.add(new ComparisonDifference(dualValue, format(description, args)))\r\n```\r\n\r\nThank you,\r\nAndrii","closed_by":{"login":"joel-costigliola","id":382613,"node_id":"MDQ6VXNlcjM4MjYxMw==","avatar_url":"https://avatars.githubusercontent.com/u/382613?v=4","gravatar_id":"","url":"https://api.github.com/users/joel-costigliola","html_url":"https://github.com/joel-costigliola","followers_url":"https://api.github.com/users/joel-costigliola/followers","following_url":"https://api.github.com/users/joel-costigliola/following{/other_user}","gists_url":"https://api.github.com/users/joel-costigliola/gists{/gist_id}","starred_url":"https://api.github.com/users/joel-costigliola/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/joel-costigliola/subscriptions","organizations_url":"https://api.github.com/users/joel-costigliola/orgs","repos_url":"https://api.github.com/users/joel-costigliola/repos","events_url":"https://api.github.com/users/joel-costigliola/events{/privacy}","received_events_url":"https://api.github.com/users/joel-costigliola/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/assertj/assertj/issues/2279/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/assertj/assertj/issues/2279/timeline","performed_via_github_app":null,"state_reason":"completed"}