{"url":"https://api.github.com/repos/assertj/assertj/issues/3744","repository_url":"https://api.github.com/repos/assertj/assertj","labels_url":"https://api.github.com/repos/assertj/assertj/issues/3744/labels{/name}","comments_url":"https://api.github.com/repos/assertj/assertj/issues/3744/comments","events_url":"https://api.github.com/repos/assertj/assertj/issues/3744/events","html_url":"https://github.com/assertj/assertj/issues/3744","id":2791033544,"node_id":"I_kwDOAIX3Vs6mW8rI","number":3744,"title":"Performance issue when asserting Map keys presence/absence due to precomputed error messages","user":{"login":"jkronegg","id":2843894,"node_id":"MDQ6VXNlcjI4NDM4OTQ=","avatar_url":"https://avatars.githubusercontent.com/u/2843894?v=4","gravatar_id":"","url":"https://api.github.com/users/jkronegg","html_url":"https://github.com/jkronegg","followers_url":"https://api.github.com/users/jkronegg/followers","following_url":"https://api.github.com/users/jkronegg/following{/other_user}","gists_url":"https://api.github.com/users/jkronegg/gists{/gist_id}","starred_url":"https://api.github.com/users/jkronegg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jkronegg/subscriptions","organizations_url":"https://api.github.com/users/jkronegg/orgs","repos_url":"https://api.github.com/users/jkronegg/repos","events_url":"https://api.github.com/users/jkronegg/events{/privacy}","received_events_url":"https://api.github.com/users/jkronegg/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/assertj/assertj/milestones/80","html_url":"https://github.com/assertj/assertj/milestone/80","labels_url":"https://api.github.com/repos/assertj/assertj/milestones/80/labels","id":12237857,"node_id":"MI_kwDOAIX3Vs4Aurwh","number":80,"title":"4.0.0-M2","description":"","creator":{"login":"scordio","id":26772046,"node_id":"MDQ6VXNlcjI2NzcyMDQ2","avatar_url":"https://avatars.githubusercontent.com/u/26772046?v=4","gravatar_id":"","url":"https://api.github.com/users/scordio","html_url":"https://github.com/scordio","followers_url":"https://api.github.com/users/scordio/followers","following_url":"https://api.github.com/users/scordio/following{/other_user}","gists_url":"https://api.github.com/users/scordio/gists{/gist_id}","starred_url":"https://api.github.com/users/scordio/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/scordio/subscriptions","organizations_url":"https://api.github.com/users/scordio/orgs","repos_url":"https://api.github.com/users/scordio/repos","events_url":"https://api.github.com/users/scordio/events{/privacy}","received_events_url":"https://api.github.com/users/scordio/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":46,"closed_issues":71,"state":"open","created_at":"2025-01-29T20:38:56Z","updated_at":"2025-11-09T20:35:29Z","due_on":null,"closed_at":null},"comments":2,"created_at":"2025-01-15T22:02:16Z","updated_at":"2025-04-27T12:42:17Z","closed_at":"2025-04-26T16:39:17Z","author_association":"CONTRIBUTOR","type":{"id":2594686,"node_id":"IT_kwDOASBds84AJ5d-","name":"⚡Improvement","description":" A general improvement ","color":"blue","created_at":"2024-01-25T19:41:59Z","updated_at":"2025-05-30T17:34:28Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Describe the bug**\nWhile profiling some of my project that use AssertJ, I found out that some classes of Assertj pops in the IntelliJ flame graph (about 2.5% of the total duration).\nBy looking at the [AssertJ Maps](https://github.com/assertj/assertj/blob/main/assertj-core/src/main/java/org/assertj/core/internal/Maps.java#L328) class, it appears that some error messages are precomputed, e.g. :\n\n    Objects.requireNonNull(keys, keysToLookForIsNull(\"array of keys\"));\n\nThe `ErrorMessages.keyToLookForIsNull(String)` precomputes the string:\n\n    public static String keysToLookForIsNull(String placeholder) {\n      return String.format(\"The %s to look for should not be null\", placeholder);\n    }\n\nThis construction should be avoided because most of the time, the assertions will pass.\n\nUsing simple code modifications such as `Supplier<String>`, I'm confident that performance can be improved.\n\nAs a proof of concept, I made a micro-benchmark for `Maps.assertContainsKeys` and a modified version based on `Supplier<String>`.\nThe method under test has 4 possible outputs\n- passing test\n- exception because of not found keys\n- exception because of empty keys\n- exception because of null keys\n\nThe micro-benchmark results are (the \"2\" suffix refers to the modified version):\n\n    Benchmark                                       Mode  Cnt          Score          Error  Units\n    MapsBenchmark.assertContainsKeys_Passing       thrpt   25    4160142.372 ±   305614.171  ops/s\n    MapsBenchmark.assertContainsKeys_Passing2      thrpt   25  278806220.272 ± 14836798.226  ops/s\n    MapsBenchmark.assertContainsKeys_NotFoundKey   thrpt   25     339497.545 ±    23599.317  ops/s\n    MapsBenchmark.assertContainsKeys_NotFoundKey2  thrpt   25     426426.943 ±    25257.273  ops/s\n    MapsBenchmark.assertContainsKeys_EmptyKeys     thrpt   25     538020.561 ±    16384.178  ops/s\n    MapsBenchmark.assertContainsKeys_EmptyKeys2    thrpt   25     727978.039 ±    55555.290  ops/s\n    MapsBenchmark.assertContainsKeys_NullKeys      thrpt   25     713600.907 ±    36963.521  ops/s\n    MapsBenchmark.assertContainsKeys_NullKeys2     thrpt   25     692166.443 ±    43117.817  ops/s\n\nWith the new method, there is a significant improvement:\n- 67x faster for passing test (most common situation)\n- 1.3x faster for not found key\n- 1.4x faster for empty keys\n- 0.97x faster for null keys (i.e. a little bit slower, but that's the least common situation)\n\nTest conditions are:\n\n* assertj core version: 3.27.2\n* java version: OpenJDK 21.0.1.0.101\n* test framework version: jmh micro-benchmark 1.36\n\nI would be happy to propose a PR to replace all similar calls by `Supplier<String>` methods.\n\n**Test case reproducing the bug**\n\nThe micro-benchmark:\n\n```java\nimport org.openjdk.jmh.annotations.Benchmark;\n\npublic class MapsBenchmark {\n\n  @Benchmark\n  public void assertContainsKeys_Passing2(MyClassPlan plan) {\n    plan.maps.assertContainsKeys2(plan.assertioninfo, plan.map, plan.keys);\n  }\n\n  @Benchmark\n  public void assertContainsKeys_Passing(MyClassPlan plan) {\n    plan.maps.assertContainsKeys(plan.assertioninfo, plan.map, plan.keys);\n  }\n\n  @Benchmark\n  public void assertContainsKeys_NotFoundKey2(MyClassPlan plan) {\n    try {\n      plan.maps.assertContainsKeys2(plan.assertioninfo, plan.otherMap, plan.keys);\n    } catch (AssertionError e) {\n    }\n  }\n\n  @Benchmark\n  public void assertContainsKeys_NotFoundKey(MyClassPlan plan) {\n    try {\n      plan.maps.assertContainsKeys(plan.assertioninfo, plan.otherMap, plan.keys);\n    } catch (AssertionError e) {\n    }\n  }\n\n  @Benchmark\n  public void assertContainsKeys_NullKeys2(MyClassPlan plan) {\n    try {\n      plan.maps.assertContainsKeys2(plan.assertioninfo, plan.map, null);\n    } catch (NullPointerException e) {\n    }\n  }\n\n  @Benchmark\n  public void assertContainsKeys_NullKeys(MyClassPlan plan) {\n    try {\n      plan.maps.assertContainsKeys(plan.assertioninfo, plan.map, null);\n    } catch (NullPointerException e) {\n    }\n  }\n\n  @Benchmark\n  public void assertContainsKeys_EmptyKeys2(MyClassPlan plan) {\n    try {\n      plan.maps.assertContainsKeys2(plan.assertioninfo, plan.map, plan.emptyKeys);\n    } catch (IllegalArgumentException e) {\n    }\n  }\n\n  @Benchmark\n  public void assertContainsKeys_EmptyKeys(MyClassPlan plan) {\n    try {\n      plan.maps.assertContainsKeys(plan.assertioninfo, plan.map, plan.emptyKeys);\n    } catch (IllegalArgumentException e) {\n    }\n  }\n\n}\n```\n\nThe support `MyClassPlan`:\n\n```java\nimport org.assertj.core.internal.Maps;\nimport org.openjdk.jmh.annotations.Scope;\nimport org.openjdk.jmh.annotations.State;\nimport org.assertj.core.api.WritableAssertionInfo;\nimport org.assertj.core.api.AssertionInfo;\n\nimport java.util.Map;\n\n@State(Scope.Benchmark)\npublic class MyClassPlan {\n  Maps maps = Maps.instance();\n  AssertionInfo assertioninfo = new WritableAssertionInfo();\n  Map<String,Integer> map = Map.of(\"k1\",10);\n  Map<String,Integer> otherMap = Map.of(\"k2\",11);\n  String[] keys = new String[]{\"k1\"};\n  String[] emptyKeys = new String[]{};\n}\n```\n\nThe modified `Maps` method (only the new code is shown):\n\n```java\npublic class Maps {\n  public <K, V> void assertContainsKeys2(AssertionInfo info, Map<K, V> actual, K[] keys) {\n    assertNotNull(info, actual);\n    requireNonNull(keys, () -> keysToLookForIsNull(\"array of keys\"));\n    if (actual.isEmpty() && keys.length == 0) return;\n    failIfEmpty(keys, () -> keysToLookForIsEmpty(\"array of keys\"));\n\n    Set<K> notFound = getNotFoundKeys(actual, keys);\n    if (!notFound.isEmpty()) throw failures.failure(info, shouldContainKeys(actual, notFound));\n  }\n\n  private static <K> void failIfEmpty(K[] keys, Supplier<String> errorMessageSupplier) {\n    checkArgument(keys.length > 0, errorMessageSupplier);\n  }\n\n}\n```","closed_by":{"login":"joel-costigliola","id":382613,"node_id":"MDQ6VXNlcjM4MjYxMw==","avatar_url":"https://avatars.githubusercontent.com/u/382613?v=4","gravatar_id":"","url":"https://api.github.com/users/joel-costigliola","html_url":"https://github.com/joel-costigliola","followers_url":"https://api.github.com/users/joel-costigliola/followers","following_url":"https://api.github.com/users/joel-costigliola/following{/other_user}","gists_url":"https://api.github.com/users/joel-costigliola/gists{/gist_id}","starred_url":"https://api.github.com/users/joel-costigliola/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/joel-costigliola/subscriptions","organizations_url":"https://api.github.com/users/joel-costigliola/orgs","repos_url":"https://api.github.com/users/joel-costigliola/repos","events_url":"https://api.github.com/users/joel-costigliola/events{/privacy}","received_events_url":"https://api.github.com/users/joel-costigliola/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/assertj/assertj/issues/3744/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/assertj/assertj/issues/3744/timeline","performed_via_github_app":null,"state_reason":"completed"}