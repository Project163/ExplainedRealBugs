{"url":"https://api.github.com/repos/assertj/assertj/issues/3123","repository_url":"https://api.github.com/repos/assertj/assertj","labels_url":"https://api.github.com/repos/assertj/assertj/issues/3123/labels{/name}","comments_url":"https://api.github.com/repos/assertj/assertj/issues/3123/comments","events_url":"https://api.github.com/repos/assertj/assertj/issues/3123/events","html_url":"https://github.com/assertj/assertj/issues/3123","id":1820619715,"node_id":"I_kwDOAIX3Vs5shHPD","number":3123,"title":"Converting large collections and streams to strings can be more efficient","user":{"login":"etellman","id":4540294,"node_id":"MDQ6VXNlcjQ1NDAyOTQ=","avatar_url":"https://avatars.githubusercontent.com/u/4540294?v=4","gravatar_id":"","url":"https://api.github.com/users/etellman","html_url":"https://github.com/etellman","followers_url":"https://api.github.com/users/etellman/followers","following_url":"https://api.github.com/users/etellman/following{/other_user}","gists_url":"https://api.github.com/users/etellman/gists{/gist_id}","starred_url":"https://api.github.com/users/etellman/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/etellman/subscriptions","organizations_url":"https://api.github.com/users/etellman/orgs","repos_url":"https://api.github.com/users/etellman/repos","events_url":"https://api.github.com/users/etellman/events{/privacy}","received_events_url":"https://api.github.com/users/etellman/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2023-07-25T15:40:41Z","updated_at":"2023-08-19T16:51:42Z","closed_at":"2023-08-19T16:51:42Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Describe the bug**\r\nConverting a large collection with a time-consuming string conversion for each element takes longer than it needs to because AssertJ converts all the elements in the collection to strings but only uses the first and last 500 strings.\r\n\r\nThis is related to https://github.com/assertj/assertj/issues/3065, but for Streams and Iterables instead of arrays.\r\n\r\n* assertj core version: 3.25.0-SNAPSHOT\r\n* java version: openjdk 17.0.7\r\n* test framework version: JUnit5 \r\n* os (if relevant): OSX, but probably not relevant\r\n\r\n**Test case reproducing the bug**\r\n\r\nConverting this collection a string takes 27 minutes on my MacBook:\r\n```\r\n    int elementsPerArray = 1000;\r\n    List<int[]> numbers = new ArrayList<>();\r\n    for (int i = 0; i < 1 << 20; i++) {\r\n      numbers.add(new int[elementsPerArray]);\r\n    }\r\n```\r\n\r\nIt's also possible to get OOM error with more elements in the list and smaller arrays in each element.\r\n\r\nA possible fix would be to narrow the stream down to the elements are actually needed and then just convert those to strings. I think this can be done by changing `StandardRepresentation.representElements()` to:\r\n\r\n```\r\n  private List<String> representElements(Stream<?> elements, String start, String end, String elementSeparator,\r\n                                         String indentation, Object root) {\r\n    // new\r\n   final PrintingAccumulator accumulator = new PrintingAccumulator(maxElementsForPrinting);\r\n   elements.forEach(accumulator::add);\r\n\r\n   // same, but uses narrowed down list of elements from the accumulator instead of the original stream\r\n   return accumulator.toList().stream().map(element -> safeStringOf(element, start, end, elementSeparator, indentation, root))\r\n                  .collect(toList());\r\n  }\r\n```\r\n`PrintingAccumulator` only retains the elements that will be used in the final string conversion and discards everything in the middle of the collection.\r\n\r\nI gave this a quick try and it produced the correct string in around 2 seconds. I can clean this up a bit and attach a PR with the proposed solution.\r\n","closed_by":{"login":"joel-costigliola","id":382613,"node_id":"MDQ6VXNlcjM4MjYxMw==","avatar_url":"https://avatars.githubusercontent.com/u/382613?v=4","gravatar_id":"","url":"https://api.github.com/users/joel-costigliola","html_url":"https://github.com/joel-costigliola","followers_url":"https://api.github.com/users/joel-costigliola/followers","following_url":"https://api.github.com/users/joel-costigliola/following{/other_user}","gists_url":"https://api.github.com/users/joel-costigliola/gists{/gist_id}","starred_url":"https://api.github.com/users/joel-costigliola/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/joel-costigliola/subscriptions","organizations_url":"https://api.github.com/users/joel-costigliola/orgs","repos_url":"https://api.github.com/users/joel-costigliola/repos","events_url":"https://api.github.com/users/joel-costigliola/events{/privacy}","received_events_url":"https://api.github.com/users/joel-costigliola/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/assertj/assertj/issues/3123/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/assertj/assertj/issues/3123/timeline","performed_via_github_app":null,"state_reason":"completed"}