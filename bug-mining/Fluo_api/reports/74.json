{"url":"https://api.github.com/repos/apache/accumulo-fluo/issues/591","repository_url":"https://api.github.com/repos/apache/accumulo-fluo","labels_url":"https://api.github.com/repos/apache/accumulo-fluo/issues/591/labels{/name}","comments_url":"https://api.github.com/repos/apache/accumulo-fluo/issues/591/comments","events_url":"https://api.github.com/repos/apache/accumulo-fluo/issues/591/events","html_url":"https://github.com/apache/accumulo-fluo/issues/591","id":123063506,"node_id":"MDU6SXNzdWUxMjMwNjM1MDY=","number":591,"title":"Shared batch writer increases transaction latency.","user":{"login":"keith-turner","id":1268739,"node_id":"MDQ6VXNlcjEyNjg3Mzk=","avatar_url":"https://avatars.githubusercontent.com/u/1268739?v=4","gravatar_id":"","url":"https://api.github.com/users/keith-turner","html_url":"https://github.com/keith-turner","followers_url":"https://api.github.com/users/keith-turner/followers","following_url":"https://api.github.com/users/keith-turner/following{/other_user}","gists_url":"https://api.github.com/users/keith-turner/gists{/gist_id}","starred_url":"https://api.github.com/users/keith-turner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/keith-turner/subscriptions","organizations_url":"https://api.github.com/users/keith-turner/orgs","repos_url":"https://api.github.com/users/keith-turner/repos","events_url":"https://api.github.com/users/keith-turner/events{/privacy}","received_events_url":"https://api.github.com/users/keith-turner/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":108100609,"node_id":"MDU6TGFiZWwxMDgxMDA2MDk=","url":"https://api.github.com/repos/apache/accumulo-fluo/labels/improvement","name":"improvement","color":"207de5","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/apache/accumulo-fluo/milestones/4","html_url":"https://github.com/apache/accumulo-fluo/milestone/4","labels_url":"https://api.github.com/repos/apache/accumulo-fluo/milestones/4/labels","id":1160967,"node_id":"MDk6TWlsZXN0b25lMTE2MDk2Nw==","number":4,"title":"1.0.0-beta-2","description":"","creator":{"login":"mikewalch","id":730698,"node_id":"MDQ6VXNlcjczMDY5OA==","avatar_url":"https://avatars.githubusercontent.com/u/730698?v=4","gravatar_id":"","url":"https://api.github.com/users/mikewalch","html_url":"https://github.com/mikewalch","followers_url":"https://api.github.com/users/mikewalch/followers","following_url":"https://api.github.com/users/mikewalch/following{/other_user}","gists_url":"https://api.github.com/users/mikewalch/gists{/gist_id}","starred_url":"https://api.github.com/users/mikewalch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikewalch/subscriptions","organizations_url":"https://api.github.com/users/mikewalch/orgs","repos_url":"https://api.github.com/users/mikewalch/repos","events_url":"https://api.github.com/users/mikewalch/events{/privacy}","received_events_url":"https://api.github.com/users/mikewalch/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":48,"state":"closed","created_at":"2015-06-11T20:14:10Z","updated_at":"2016-01-19T19:50:00Z","due_on":null,"closed_at":"2016-01-19T19:50:00Z"},"comments":3,"created_at":"2015-12-19T05:25:30Z","updated_at":"2016-06-16T17:12:34Z","closed_at":"2015-12-21T15:27:29Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I have been running webindex on a 22 node EC2 cluster with 18 workers nodes.  If I run 1 loader per worker, Fluo can keep up indexing about 1K web pages per second.   If I run 2 loaders per node, Fluo falls behind as the incoming rate of web pages goes up.\n\nResearching what going I discovered one problem is the shared batch writer used at the end of a transactions.   When the primary cell is successfully committed, the rest of the cells modified by the transaction are written using a batch writer.   However the transaction needs to wait for this write inorder to write the final TX_DONE mutation and delete notifications after the transaction is complete.\n\nHowever a transaction waiting on a batch writer is bad, because when flush is called on the batch writer it flushes all mutations to all tablet servers.  This causes transactions to wait on writes to tablet servers that the transaction may not have written to, but other transactions did.    This increases the latency of all transactions.\n\nBelow are some screenshots from grafana showing the page observer falling behind the page loader and notifications building up.  This continues until the spark task complete.\n\n![behind-tps](https://cloud.githubusercontent.com/assets/1268739/11911524/6c8b48ce-a5e6-11e5-8bda-ebc5428146c4.png)\n![behind-q](https://cloud.githubusercontent.com/assets/1268739/11911526/716acc0c-a5e6-11e5-8453-d943f5970a48.png)\n![behing-avg](https://cloud.githubusercontent.com/assets/1268739/11911525/70d4691a-a5e6-11e5-938a-fb661759068d.png)\n","closed_by":{"login":"keith-turner","id":1268739,"node_id":"MDQ6VXNlcjEyNjg3Mzk=","avatar_url":"https://avatars.githubusercontent.com/u/1268739?v=4","gravatar_id":"","url":"https://api.github.com/users/keith-turner","html_url":"https://github.com/keith-turner","followers_url":"https://api.github.com/users/keith-turner/followers","following_url":"https://api.github.com/users/keith-turner/following{/other_user}","gists_url":"https://api.github.com/users/keith-turner/gists{/gist_id}","starred_url":"https://api.github.com/users/keith-turner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/keith-turner/subscriptions","organizations_url":"https://api.github.com/users/keith-turner/orgs","repos_url":"https://api.github.com/users/keith-turner/repos","events_url":"https://api.github.com/users/keith-turner/events{/privacy}","received_events_url":"https://api.github.com/users/keith-turner/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/apache/accumulo-fluo/issues/591/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/apache/accumulo-fluo/issues/591/timeline","performed_via_github_app":null,"state_reason":"completed"}