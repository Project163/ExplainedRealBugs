{"url":"https://api.github.com/repos/rclone/rclone/issues/7744","repository_url":"https://api.github.com/repos/rclone/rclone","labels_url":"https://api.github.com/repos/rclone/rclone/issues/7744/labels{/name}","comments_url":"https://api.github.com/repos/rclone/rclone/issues/7744/comments","events_url":"https://api.github.com/repos/rclone/rclone/issues/7744/events","html_url":"https://github.com/rclone/rclone/issues/7744","id":2231754354,"node_id":"I_kwDOAQ-n5M6FBd5y","number":7744,"title":"B2 remote doesn't set custom headers on large files","user":{"login":"metadaddy","id":723517,"node_id":"MDQ6VXNlcjcyMzUxNw==","avatar_url":"https://avatars.githubusercontent.com/u/723517?v=4","gravatar_id":"","url":"https://api.github.com/users/metadaddy","html_url":"https://github.com/metadaddy","followers_url":"https://api.github.com/users/metadaddy/followers","following_url":"https://api.github.com/users/metadaddy/following{/other_user}","gists_url":"https://api.github.com/users/metadaddy/gists{/gist_id}","starred_url":"https://api.github.com/users/metadaddy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/metadaddy/subscriptions","organizations_url":"https://api.github.com/users/metadaddy/orgs","repos_url":"https://api.github.com/users/metadaddy/repos","events_url":"https://api.github.com/users/metadaddy/events{/privacy}","received_events_url":"https://api.github.com/users/metadaddy/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":86399005,"node_id":"MDU6TGFiZWw4NjM5OTAwNQ==","url":"https://api.github.com/repos/rclone/rclone/labels/bug","name":"bug","color":"fc2929","default":true,"description":null},{"id":306063207,"node_id":"MDU6TGFiZWwzMDYwNjMyMDc=","url":"https://api.github.com/repos/rclone/rclone/labels/Remote:%20Backblaze%20B2","name":"Remote: Backblaze B2","color":"fbca04","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/rclone/rclone/milestones/56","html_url":"https://github.com/rclone/rclone/milestone/56","labels_url":"https://api.github.com/repos/rclone/rclone/milestones/56/labels","id":10662391,"node_id":"MI_kwDOAQ-n5M4AorH3","number":56,"title":"v1.68","description":"","creator":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":13,"state":"closed","created_at":"2024-03-10T12:33:56Z","updated_at":"2024-09-11T21:18:36Z","due_on":"2024-09-08T07:00:00Z","closed_at":"2024-09-11T21:18:36Z"},"comments":1,"created_at":"2024-04-08T17:37:55Z","updated_at":"2024-07-15T10:51:39Z","closed_at":"2024-07-15T10:51:38Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"<!--\r\n\r\nWe understand you are having a problem with rclone; we want to help you with that!\r\n\r\n**STOP and READ**\r\n**YOUR POST WILL BE REMOVED IF IT IS LOW QUALITY**:\r\nPlease show the effort you've put into solving the problem and please be specific.\r\nPeople are volunteering their time to help! Low effort posts are not likely to get good answers!\r\n\r\nIf you think you might have found a bug, try to replicate it with the latest beta (or stable).\r\nThe update instructions are available at https://rclone.org/commands/rclone_selfupdate/\r\n\r\nIf you can still replicate it or just got a question then please use the rclone forum:\r\n\r\n    https://forum.rclone.org/\r\n\r\nfor a quick response instead of filing an issue on this repo.\r\n\r\nIf nothing else helps, then please fill in the info below which helps us help you.\r\n\r\n**DO NOT REDACT** any information except passwords/keys/personal info.\r\n\r\nYou should use 3 backticks to begin and end your paste to make it readable.\r\n\r\nMake sure to include a log obtained with '-vv'.\r\n\r\nYou can also use '-vv --log-file bug.log' and a service such as https://pastebin.com or https://gist.github.com/\r\n\r\nThank you\r\n\r\nThe Rclone Developers\r\n\r\n-->\r\n\r\n#### The associated forum post URL from `https://forum.rclone.org`\r\n\r\nNot from the Rclone forum, but https://stackoverflow.com/questions/78232585/cant-upload-custom-header-for-large-file-to-backblaze describes the issue.\r\n\r\n#### What is the problem you are having with rclone?\r\n\r\nWhen using `rclone copy` with a custom header such as `--header-upload \"X-Bz-Info-Uncompressed-Size: 10000000000\"` on the Backblaze B2 remote to copy a large (multipart) file, the header is not sent when the file is created. The header is sent as expected for regular files.\r\n\r\n#### What is your rclone version (output from `rclone version`)\r\n\r\n```\r\nrclone v1.65.2\r\n- os/version: darwin 14.2.1 (64 bit)\r\n- os/kernel: 23.2.0 (x86_64)\r\n- os/type: darwin\r\n- os/arch: amd64\r\n- go/version: go1.21.6\r\n- go/linking: dynamic\r\n- go/tags: cmount\r\n```\r\n\r\n#### Which OS you are using and how many bits (e.g. Windows 7, 64 bit)\r\n\r\nmacOS 14.2.1\r\n\r\n#### Which cloud storage system are you using? (e.g. Google Drive)\r\n\r\nBackblaze B2\r\n\r\n#### The command you were trying to run (e.g. `rclone copy /tmp remote:tmp`)\r\n\r\n```\r\nrclone --header-upload \"X-Bz-Info-Uncompressed-Size: 10000000000\" --b2-upload-cutoff 6Mi --b2-chunk-size 6Mi copy 10megabyte-test-file b2:my-bucket\r\n```\r\n\r\n#### A log from the command with the `-vv` flag (e.g. output from `rclone -vv copy /tmp remote:tmp`)\r\n\r\nUploading a file to a public bucket, using `--b2-upload-cutoff` and `--b2-chunk-size` so I don't have to wait all day...\r\n\r\n```\r\n% rclone -vv --header-upload \"X-Bz-Info-Uncompressed-Size: 10000000000\" --b2-upload-cutoff 6Mi --b2-chunk-size 6Mi copy 10megabyte-test-file b2:my-bucket               \r\n2024/04/08 09:21:35 DEBUG : rclone: Version \"v1.65.2\" starting with parameters [\"rclone\" \"-vv\" \"--header-upload\" \"X-Bz-Info-Uncompressed-Size: 10000000000\" \"--b2-upload-cutoff\" \"6Mi\" \"--b2-chunk-size\" \"6Mi\" \"copy\" \"10megabyte-test-file\" \"b2:my-bucket\"]\r\n2024/04/08 09:21:35 DEBUG : Creating backend with remote \"10megabyte-test-file\"\r\n2024/04/08 09:21:35 DEBUG : Using config file from \"/Users/ppatterson/.config/rclone/rclone.conf\"\r\n2024/04/08 09:21:35 DEBUG : fs cache: adding new entry for parent of \"10megabyte-test-file\", \"/Users/ppatterson/Documents/Test Files\"\r\n2024/04/08 09:21:35 DEBUG : Creating backend with remote \"b2:my-bucket\"\r\n2024/04/08 09:21:35 DEBUG : b2: detected overridden config - adding \"{NaqQ9}\" suffix to name\r\n2024/04/08 09:21:35 DEBUG : fs cache: renaming cache item \"b2:my-bucket\" to be canonical \"b2{NaqQ9}:my-bucket\"\r\n2024/04/08 09:21:35 DEBUG : 10megabyte-test-file: Need to transfer - File not found at Destination\r\n2024/04/08 09:21:36 DEBUG : 10megabyte-test-file: multipart upload: starting chunk 0 size 6Mi offset 0/10Mi\r\n2024/04/08 09:21:36 DEBUG : 10megabyte-test-file: Sending chunk 0 length 6291456\r\n2024/04/08 09:21:36 DEBUG : 10megabyte-test-file: multipart upload: starting chunk 1 size 4Mi offset 6Mi/10Mi\r\n2024/04/08 09:21:36 DEBUG : 10megabyte-test-file: Sending chunk 1 length 4194304\r\n2024/04/08 09:21:42 DEBUG : 10megabyte-test-file: Done sending chunk 0\r\n2024/04/08 09:21:43 DEBUG : 10megabyte-test-file: Done sending chunk 1\r\n2024/04/08 09:21:43 DEBUG : 10megabyte-test-file: Finishing large file upload with 2 parts\r\n2024/04/08 09:21:43 DEBUG : 10megabyte-test-file: sha1 = 8c206a1a87599f532ce68675536f0b1546900d7a OK\r\n2024/04/08 09:21:43 INFO  : 10megabyte-test-file: Copied (new)\r\n2024/04/08 09:21:43 INFO  : \r\nTransferred:   \t       10 MiB / 10 MiB, 100%, 1.427 MiB/s, ETA 0s\r\nTransferred:            1 / 1, 100%\r\nElapsed time:         8.5s\r\n\r\n2024/04/08 09:21:43 DEBUG : 14 go routines active\r\n```\r\n\r\nAccessing the uploaded file with `curl`, we can see that the custom header is not present:\r\n\r\n```\r\ncurl --head -i https://my-bucket.s3.us-west-004.backblazeb2.com/10megabyte-test-file\r\nHTTP/1.1 200 \r\nServer: nginx\r\nDate: Mon, 08 Apr 2024 16:45:37 GMT\r\nContent-Type: application/octet-stream\r\nContent-Length: 10485760\r\nConnection: keep-alive\r\nAccept-Ranges: bytes\r\nLast-Modified: Mon, 08 Apr 2024 16:21:36 GMT\r\nETag: \"f2832fc8d9a3dde79ad11c6adae0a85b-2\"\r\nCache-Control: public\r\nx-amz-meta-large_file_sha1: 8c206a1a87599f532ce68675536f0b1546900d7a\r\nx-amz-meta-src_last_modified_millis: 1653439279724\r\nx-amz-request-id: 5c5051e83a963cf4\r\nx-amz-id-2: aMTo1vGaWOTwz/zVRY9lmMTRLZF1jBmLP\r\nx-amz-version-id: 4_zf1f51fb913357c4f74ed0c1b_f243fbde6384d2a59_d20240408_m162136_c004_v0402024_t0008_u01712593296211\r\nStrict-Transport-Security: max-age=63072000\r\n```\r\n\r\nIn contrast, here are the same logs for a regular file, showing that the custom header is set as expected:\r\n\r\n```\r\n% rclone -vv --header-upload \"X-Bz-Info-Uncompressed-Size: 10000000000\" copy one-byte b2:my-bucket\r\n2024/04/08 09:25:33 DEBUG : rclone: Version \"v1.65.2\" starting with parameters [\"rclone\" \"-vv\" \"--header-upload\" \"X-Bz-Info-Uncompressed-Size: 10000000000\" \"copy\" \"one-byte\" \"b2:my-bucket\"]\r\n2024/04/08 09:25:33 DEBUG : Creating backend with remote \"one-byte\"\r\n2024/04/08 09:25:33 DEBUG : Using config file from \"/Users/ppatterson/.config/rclone/rclone.conf\"\r\n2024/04/08 09:25:33 DEBUG : fs cache: adding new entry for parent of \"one-byte\", \"/Users/ppatterson/Documents/Test Files\"\r\n2024/04/08 09:25:33 DEBUG : Creating backend with remote \"b2:my-bucket\"\r\n2024/04/08 09:25:34 DEBUG : one-byte: Need to transfer - File not found at Destination\r\n2024/04/08 09:25:34 DEBUG : one-byte: sha1 = 356a192b7913b04c54574d18c28d46e6395428ab OK\r\n2024/04/08 09:25:34 INFO  : one-byte: Copied (new)\r\n2024/04/08 09:25:34 INFO  : \r\nTransferred:   \t          1 B / 1 B, 100%, 0 B/s, ETA -\r\nTransferred:            1 / 1, 100%\r\nElapsed time:         1.1s\r\n\r\n2024/04/08 09:25:34 DEBUG : 14 go routines active\r\n```\r\n\r\n```\r\n% curl --head -i https://my-bucket.s3.us-west-004.backblazeb2.com/one-byte            \r\nHTTP/1.1 200 \r\nServer: nginx\r\nDate: Mon, 08 Apr 2024 17:07:29 GMT\r\nContent-Type: application/octet-stream\r\nContent-Length: 1\r\nConnection: keep-alive\r\nAccept-Ranges: bytes\r\nLast-Modified: Mon, 08 Apr 2024 16:25:34 GMT\r\nETag: \"c4ca4238a0b923820dcc509a6f75849b\"\r\nCache-Control: public\r\nx-amz-meta-src_last_modified_millis: 1703264839036\r\nx-amz-meta-uncompressed-size: 10000000000\r\nx-amz-request-id: 9e579f918ccf4353\r\nx-amz-id-2: aMTg1JGaOOQQzJjW9Y7Rm0TQuZPFj42KA\r\nx-amz-version-id: 4_zf1f51fb913357c4f74ed0c1b_f100869ea8a62913f_d20240408_m162534_c004_v0402024_t0039_u01712593534626\r\nStrict-Transport-Security: max-age=63072000\r\n```\r\n\r\n#### Notes\r\n\r\nThe issue is in `newLargeUpload()` at https://github.com/rclone/rclone/blob/master/backend/b2/upload.go#L108 - in contrast with `Update()` (https://github.com/rclone/rclone/blob/master/backend/b2/b2.go#L2066), `Options` is not set in the `Opts` structure. `newLargeUpload()` needs an `options` argument and its callers need to set it appropriately.\r\n\r\nI'll take a swing at a PR üëçüèª\r\n\r\n<!--- Please keep the note below for others who read your bug report. -->\r\n\r\n#### How to use GitHub\r\n\r\n* Please use the üëç [reaction](https://blog.github.com/2016-03-10-add-reactions-to-pull-requests-issues-and-comments/) to show that you are affected by the same issue.\r\n* Please don't comment if you have no relevant information to add. It's just extra noise for everyone subscribed to this issue.\r\n* Subscribe to receive notifications on status change and new comments.\r\n","closed_by":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/7744/reactions","total_count":4,"+1":1,"-1":0,"laugh":0,"hooray":1,"confused":0,"heart":2,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rclone/rclone/issues/7744/timeline","performed_via_github_app":null,"state_reason":"completed"}