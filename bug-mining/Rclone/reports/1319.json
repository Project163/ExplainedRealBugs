{"url":"https://api.github.com/repos/rclone/rclone/issues/8220","repository_url":"https://api.github.com/repos/rclone/rclone","labels_url":"https://api.github.com/repos/rclone/rclone/issues/8220/labels{/name}","comments_url":"https://api.github.com/repos/rclone/rclone/issues/8220/comments","events_url":"https://api.github.com/repos/rclone/rclone/issues/8220/events","html_url":"https://github.com/rclone/rclone/issues/8220","id":2712079195,"node_id":"I_kwDOAQ-n5M6hpwtb","number":8220,"title":"with --vfs-used-is-size value is calculated and then thrown away","user":{"login":"iscilyas","id":47330372,"node_id":"MDQ6VXNlcjQ3MzMwMzcy","avatar_url":"https://avatars.githubusercontent.com/u/47330372?v=4","gravatar_id":"","url":"https://api.github.com/users/iscilyas","html_url":"https://github.com/iscilyas","followers_url":"https://api.github.com/users/iscilyas/followers","following_url":"https://api.github.com/users/iscilyas/following{/other_user}","gists_url":"https://api.github.com/users/iscilyas/gists{/gist_id}","starred_url":"https://api.github.com/users/iscilyas/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/iscilyas/subscriptions","organizations_url":"https://api.github.com/users/iscilyas/orgs","repos_url":"https://api.github.com/users/iscilyas/repos","events_url":"https://api.github.com/users/iscilyas/events{/privacy}","received_events_url":"https://api.github.com/users/iscilyas/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2024-12-02T14:15:21Z","updated_at":"2024-12-05T09:57:34Z","closed_at":"2024-12-04T22:57:42Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I have ssh access to a 500gb quota'd filesystem that I'm mounting using rclone. `df` on the server reports information about the entire disk. I've been trying to use `--vfs-used-is-size` in combination with `--vfs-disk-space-total-size=XXX` but that's giving me garbage values:\r\n\r\n```\r\n$ rclone  mount 500gb:/home/ilias/tmp /home/ilias/foo --log-level=DEBUG --vfs-used-is-size\r\n --vfs-disk-space-total-size=500G\r\n$ du -h /home/ilias/foo\r\n1.5K\t/home/ilias/foo\r\n$ df -h /home/ilias/foo\r\nFilesystem             Size  Used Avail Use% Mounted on\r\n500gb:/home/ilias/tmp  500G -224T  224T    - /home/ilias/foo\r\n```\r\nRelevant debug output:\r\n```\r\n2024/12/02 15:02:33 DEBUG : : >Statfs: stat={Blocks:131072000 Bfree:60049752808 Bavail:60049752808 Files:1000000000 Ffree:1000000000 Bsize:4096 Namelen:255 Frsize:4096}, err=<nil>\r\n```\r\n\r\nI did some digging around, and the problem seems to be that in `vfs/vfs.go:Statfs()` we make an About() call, then properly overwrite `used` and `size` based on the command-line arguments, but keep the `free` value returned by the server. The call to `vfs/vfs.go:fillInMissingSizes()` doesn't change `free` (since it's been populated). Later on `used` (which we just spent so much time calculating) is thrown away and `statvfs(3)` returns the `size` (from `vfs-disk-space-total-size`) and the `free` (which we got from the `About()` call), and `used` is calculated (in userland) based on those.\r\n\r\nEssentialy, `vfs-used-is-size` is a very very expensive no-op. Note that the problem always exists, and is independent of the backend and not only when used in combination with `vfs-disk-space-total-size`.\r\n\r\nThe fix is to ignore the `free` value returned by the server in the About() call, and calculate it based on `size` and `used`.\r\n\r\n```\r\ndiff --git a/vfs/vfs.go b/vfs/vfs.go\r\nindex 9f0fc1f14..5fcfe9c4c 100644\r\n--- a/vfs/vfs.go\r\n+++ b/vfs/vfs.go\r\n@@ -650,6 +650,11 @@ func (vfs *VFS) Statfs() (total, used, free int64) {\r\n                total = int64(vfs.Opt.DiskSpaceTotalSize)\r\n        }\r\n \r\n+       // if we've calculated the \"used\", then we should calculate the \"free\"\r\n+       if vfs.Opt.UsedIsSize {\r\n+               free = -1\r\n+       }\r\n+\r\n        total, used, free = fillInMissingSizes(total, used, free, unknownFreeBytes)\r\n        return\r\n }\r\n```\r\n\r\nwhich results in:\r\n\r\n```\r\n$ du -h /home/ilias/foo\r\n1.5K\t/home/ilias/foo\r\n$ df -h /home/ilias/foo\r\nFilesystem             Size  Used Avail Use% Mounted on\r\n500gb:/home/ilias/tmp  500G  4.0K  500G   1% /home/ilias/foo\r\n```\r\n\r\nWith the debug output:\r\n\r\n```\r\n2024/12/02 15:06:08 DEBUG : : >Statfs: stat={Blocks:131072000 Bfree:131071999 Bavail:131071999 Files:1000000000 Ffree:1000000000 Bsize:4096 Namelen:255 Frsize:4096}, err=<nil>\r\n```\r\n<!--- Please keep the note below for others who read your bug report. -->\r\n\r\n#### How to use GitHub\r\n\r\n* Please use the üëç [reaction](https://blog.github.com/2016-03-10-add-reactions-to-pull-requests-issues-and-comments/) to show that you are affected by the same issue.\r\n* Please don't comment if you have no relevant information to add. It's just extra noise for everyone subscribed to this issue.\r\n* Subscribe to receive notifications on status change and new comments.\r\n","closed_by":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/8220/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rclone/rclone/issues/8220/timeline","performed_via_github_app":null,"state_reason":"completed"}