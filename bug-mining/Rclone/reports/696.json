{"url":"https://api.github.com/repos/rclone/rclone/issues/3381","repository_url":"https://api.github.com/repos/rclone/rclone","labels_url":"https://api.github.com/repos/rclone/rclone/issues/3381/labels{/name}","comments_url":"https://api.github.com/repos/rclone/rclone/issues/3381/comments","events_url":"https://api.github.com/repos/rclone/rclone/issues/3381/events","html_url":"https://github.com/rclone/rclone/issues/3381","id":473766830,"node_id":"MDU6SXNzdWU0NzM3NjY4MzA=","number":3381,"title":"Rclone mount VFS cache doesn't appear to handle dup() calls gracefully","user":{"login":"bdutro","id":5447668,"node_id":"MDQ6VXNlcjU0NDc2Njg=","avatar_url":"https://avatars.githubusercontent.com/u/5447668?v=4","gravatar_id":"","url":"https://api.github.com/users/bdutro","html_url":"https://github.com/bdutro","followers_url":"https://api.github.com/users/bdutro/followers","following_url":"https://api.github.com/users/bdutro/following{/other_user}","gists_url":"https://api.github.com/users/bdutro/gists{/gist_id}","starred_url":"https://api.github.com/users/bdutro/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bdutro/subscriptions","organizations_url":"https://api.github.com/users/bdutro/orgs","repos_url":"https://api.github.com/users/bdutro/repos","events_url":"https://api.github.com/users/bdutro/events{/privacy}","received_events_url":"https://api.github.com/users/bdutro/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":86399005,"node_id":"MDU6TGFiZWw4NjM5OTAwNQ==","url":"https://api.github.com/repos/rclone/rclone/labels/bug","name":"bug","color":"fc2929","default":true,"description":null},{"id":430778096,"node_id":"MDU6TGFiZWw0MzA3NzgwOTY=","url":"https://api.github.com/repos/rclone/rclone/labels/VFS%20/%20mount","name":"VFS / mount","color":"0e8a16","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/rclone/rclone/milestones/37","html_url":"https://github.com/rclone/rclone/milestone/37","labels_url":"https://api.github.com/repos/rclone/rclone/milestones/37/labels","id":4423541,"node_id":"MDk6TWlsZXN0b25lNDQyMzU0MQ==","number":37,"title":"v1.50","description":"","creator":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":53,"state":"closed","created_at":"2019-06-19T08:40:02Z","updated_at":"2023-06-23T16:59:46Z","due_on":"2019-10-12T07:00:00Z","closed_at":"2019-11-14T16:50:09Z"},"comments":2,"created_at":"2019-07-28T17:25:45Z","updated_at":"2019-10-09T09:07:31Z","closed_at":"2019-10-09T09:07:31Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"#### What is the problem you are having with rclone?\r\nI'm trying to use bup to backup to a mounted rclone crypt backend.\r\n\r\nWhen it tries to write midx or bloom files, I get the following error:\r\n\r\n    Traceback (most recent call last):    \r\n      File \"/usr/lib/bup/cmd/bup-midx\", line 272, in <module>\r\n        do_midx_dir(path, opt.output)\r\n      File \"/usr/lib/bup/cmd/bup-midx\", line 213, in do_midx_dir\r\n        all = list(do_midx_group(path, outfilename, part1)) + part2\r\n      File \"/usr/lib/bup/cmd/bup-midx\", line 230, in do_midx_group\r\n        rv = _do_midx(outdir, outfilename, sublist, gprefix)\r\n      File \"/usr/lib/bup/cmd/bup-midx\", line 135, in _do_midx\r\n        f.write('\\0'.join(allfilenames))\r\n      File \"/usr/lib/python2.7/contextlib.py\", line 24, in __exit__\r\n        self.gen.next()\r\n      File \"/usr/lib/bup/bup/helpers.py\", line 723, in atomically_replaced_file\r\n        f.close()\r\n    IOError: [Errno 9] Bad file descriptor\r\n\r\nI think the source of this error is that bup opens up the midx file for writing, getting file handle 3 (see strace log below). It then mmap's that file, which ends up doing a dup() syscall under the hood, giving us a second file handle 17. When it's finished with the mmap'ed file handle, it calls close() on it. Rclone sees the close() call for 17, but doesn't account for the fact that file handle 3 is still open. It uploads the file and deletes the local copy, invalidating the file handle 3 without bup knowing what has happened.\r\n\r\n#### What is your rclone version (output from `rclone version`)\r\n1.48.0\r\n\r\n#### Which OS you are using and how many bits (eg Windows 7, 64 bit)\r\nArch Linux 64 bit\r\n\r\n####  Which cloud storage system are you using? (eg Google Drive)\r\nBox\r\n\r\n\r\n#### The command you were trying to run (eg `rclone copy /tmp remote:tmp`)\r\n\r\n    rclone mount box_crypt: /mnt/box_enc --config /etc/box-webdav/rclone.conf \\\r\n    --use-mmap --transfers 256 --checkers 512 --checksum --fast-list --rc \\\r\n    --vfs-cache-mode full --cache-dir /var/cache/rclone --vfs-cache-max-size 64G \\\r\n    --log-file /var/log/rclone.log --log-level DEBUG\r\n\r\n#### A log from the command with the `-vv` flag (eg output from `rclone -vv copy /tmp remote:tmp`)\r\n\r\n    2019/07/27 18:36:20 DEBUG : objects/pack/: Lookup: name=\"tmpagv5oD\"\r\n    2019/07/27 18:36:20 DEBUG : objects/pack/: Create: name=\"tmpagv5oD\"\r\n    2019/07/27 18:36:20 DEBUG : objects/pack/tmpagv5oD: Open: flags=O_RDWR|O_CREATE|O_EXCL|0x20000\r\n    2019/07/27 18:36:20 DEBUG : objects/pack/tmpagv5oD(0xc0039e11a0): Opening cached copy with flags=O_RDWR|O_CREATE|O_EXCL|0x20000\r\n    2019/07/27 18:36:20 DEBUG : objects/pack/tmpagv5oD: >Open: fd=objects/pack/tmpagv5oD (rw), err=<nil>\r\n    2019/07/27 18:36:20 DEBUG : objects/pack/: >Create: node=objects/pack/tmpagv5oD, handle=&{objects/pack/tmpagv5oD (rw)}, err=<nil>\r\n    2019/07/27 18:36:20 DEBUG : objects/pack/tmpagv5oD: Attr:\r\n    2019/07/27 18:36:20 DEBUG : objects/pack/tmpagv5oD: >Attr: a=valid=1s ino=0 size=0 mode=-rw-r--r--, err=<nil>\r\n    2019/07/27 18:36:20 DEBUG : &{objects/pack/tmpagv5oD (rw)}: Write: len=12, offset=0\r\n    2019/07/27 18:36:20 DEBUG : &{objects/pack/tmpagv5oD (rw)}: >Write: written=12, err=<nil>\r\n    2019/07/27 18:36:20 DEBUG : objects/pack/tmpagv5oD: Setattr: a=Setattr [ID=0x607c2 Node=0xa5 Uid=0 Gid=0 Pid=15572] size=39516740 handle=0x5 lockowner\r\n    2019/07/27 18:36:20 DEBUG : objects/pack/tmpagv5oD: >Setattr: err=<nil>\r\n    2019/07/27 18:36:20 DEBUG : objects/pack/tmpagv5oD: Attr:\r\n    2019/07/27 18:36:20 DEBUG : objects/pack/tmpagv5oD: >Attr: a=valid=1s ino=0 size=39516740 mode=-rw-r--r--, err=<nil>\r\n    2019/07/27 18:36:20 DEBUG : objects/pack/tmpagv5oD: Fsync:\r\n    2019/07/27 18:36:20 DEBUG : objects/pack/tmpagv5oD: >Fsync: err=<nil>\r\n    2019/07/27 18:36:20 DEBUG : &{objects/pack/tmpagv5oD (rw)}: Read: len=131072, offset=0\r\n    2019/07/27 18:36:20 DEBUG : &{objects/pack/tmpagv5oD (rw)}: >Read: read=131072, err=<nil>\r\n    ...snip...\r\n    2019/07/27 18:36:21 DEBUG : &{objects/pack/tmpagv5oD (rw)}: Write: len=131072, offset=0\r\n    2019/07/27 18:36:21 DEBUG : &{objects/pack/tmpagv5oD (rw)}: >Write: written=131072, err=<nil>\r\n    ...snip...\r\n    2019/07/27 18:36:21 DEBUG : &{objects/pack/tmpagv5oD (rw)}: Flush:\r\n    2019/07/27 18:36:21 DEBUG : objects/pack/tmpagv5oD(0xc0039e11a0): close:\r\n    2019/07/27 18:36:21 DEBUG : objects/pack/tmpagv5oD: Couldn't find file - need to transfer\r\n    2019/07/27 18:36:23 DEBUG : objects/pack/tmpagv5oD: updateTime: setting atime to 2019-07-27 18:36:22.991529142 -0500 CDT\r\n    2019/07/27 18:36:25 INFO  : objects/pack/tmpagv5oD: Copied (new)\r\n    2019/07/27 18:36:25 DEBUG : objects/pack/tmpagv5oD: transferred to remote\r\n    2019/07/27 18:36:25 DEBUG : objects/pack/tmpagv5oD(0xc0039e11a0): >close: err=<nil>\r\n    2019/07/27 18:36:25 DEBUG : &{objects/pack/tmpagv5oD (rw)}: >Flush: err=<nil>\r\n    2019/07/27 18:36:25 DEBUG : objects/pack/tmpagv5oD: Fsync:\r\n    2019/07/27 18:36:25 DEBUG : objects/pack/tmpagv5oD: >Fsync: err=<nil>\r\n    2019/07/27 18:36:25 DEBUG : objects/pack/tmpagv5oD: Attr:\r\n    2019/07/27 18:36:25 DEBUG : objects/pack/tmpagv5oD: >Attr: a=valid=1s ino=0 size=39516740 mode=-rw-r--r--, err=<nil>\r\n    2019/07/27 18:36:25 DEBUG : &{objects/pack/tmpagv5oD (rw)}: Write: len=549, offset=39516740\r\n    2019/07/27 18:36:25 DEBUG : &{objects/pack/tmpagv5oD (rw)}: >Write: written=0, err=bad file descriptor\r\n    2019/07/27 18:36:25 DEBUG : &{objects/pack/tmpagv5oD (rw)}: Flush:\r\n    2019/07/27 18:36:25 DEBUG : objects/pack/tmpagv5oD(0xc0039e11a0): RWFileHandle.Flush nothing to do\r\n    2019/07/27 18:36:25 DEBUG : &{objects/pack/tmpagv5oD (rw)}: >Flush: err=<nil>\r\n    2019/07/27 18:36:25 DEBUG : &{objects/pack/tmpagv5oD (rw)}: Release:\r\n    2019/07/27 18:36:25 DEBUG : objects/pack/tmpagv5oD(0xc0039e11a0): RWFileHandle.Release nothing to do\r\n    2019/07/27 18:36:25 DEBUG : &{objects/pack/tmpagv5oD (rw)}: >Release: err=<nil>\r\n    2019/07/27 18:36:25 DEBUG : objects/pack/: Lookup: name=\"tmpagv5oD\"\r\n    2019/07/27 18:36:25 DEBUG : objects/pack/: >Lookup: node=objects/pack/tmpagv5oD, err=<nil>\r\n    2019/07/27 18:36:25 DEBUG : objects/pack/tmpagv5oD: Attr:\r\n    2019/07/27 18:36:25 DEBUG : objects/pack/tmpagv5oD: >Attr: a=valid=1s ino=0 size=39516740 mode=-rw-r--r--, err=<nil>\r\n    2019/07/27 18:36:25 DEBUG : objects/pack/: Remove: name=\"tmpagv5oD\"\r\n    2019/07/27 18:36:26 INFO  : objects/pack/tmpagv5oD: Removed from cache\r\n\r\n### strace log\r\n\r\n    openat(AT_FDCWD, \"/mnt/box_enc/objects/pack/tmpagv5oD\", O_RDWR|O_CREAT|O_EXCL|O_NOFOLLOW, 0600) = 3\r\n    fcntl(3, F_GETFD)                       = 0\r\n    fcntl(3, F_SETFD, FD_CLOEXEC)           = 0\r\n    fstat(3, {st_mode=S_IFREG|0644, st_size=0, ...}) = 0\r\n    fcntl(3, F_GETFL)                       = 0x28002 (flags O_RDWR|O_LARGEFILE|O_NOFOLLOW)\r\n    fstat(3, {st_mode=S_IFREG|0644, st_size=0, ...}) = 0\r\n    lseek(3, 0, SEEK_CUR)                   = 0\r\n    lseek(3, 0, SEEK_CUR)                   = 0\r\n    write(3, \"MIDX\\0\\0\\0\\4\\0\\0\\0\\r\", 12)    = 12\r\n    ftruncate(3, 39516740)                  = 0\r\n    lseek(3, 12, SEEK_SET)                  = 12\r\n    fdatasync(3)                            = 0\r\n    fstat(3, {st_mode=S_IFREG|0644, st_size=39516740, ...}) = 0\r\n    fstat(3, {st_mode=S_IFREG|0644, st_size=39516740, ...}) = 0\r\n    dup(3)                                  = 17\r\n    mmap(NULL, 39516740, PROT_READ|PROT_WRITE, MAP_SHARED, 3, 0) = 0x7fc0dda36000\r\n    write(2, \"midx: writing 0.00% (0/1645165)\\r\", 32) = 32\r\n    ...snip...\r\n    write(2, \"midx: writing 99.61% (1638784/16\"..., 39) = 39\r\n    close(17)                               = 0\r\n    msync(0x7fc0dda36000, 39516740, MS_SYNC) = 0\r\n    munmap(0x7fc0dda36000, 39516740)        = 0\r\n    fstat(3, {st_mode=S_IFREG|0644, st_size=39516740, ...}) = 0\r\n    lseek(3, 39516740, SEEK_SET)            = 39516740\r\n    write(3, \"pack-54b98568f664f25c55f780c7daa\"..., 549) = -1 EBADF (Bad file descriptor)\r\n    close(3)                                = 0\r\n    unlink(\"/mnt/box_enc/objects/pack/tmpagv5oD\") = 0","closed_by":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/3381/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rclone/rclone/issues/3381/timeline","performed_via_github_app":null,"state_reason":"completed"}