{"url":"https://api.github.com/repos/rclone/rclone/issues/7974","repository_url":"https://api.github.com/repos/rclone/rclone","labels_url":"https://api.github.com/repos/rclone/rclone/issues/7974/labels{/name}","comments_url":"https://api.github.com/repos/rclone/rclone/issues/7974/comments","events_url":"https://api.github.com/repos/rclone/rclone/issues/7974/events","html_url":"https://github.com/rclone/rclone/issues/7974","id":2429392802,"node_id":"I_kwDOAQ-n5M6QzZei","number":7974,"title":"Excess memory use when syncing millions of files in one directory","user":{"login":"zackees","id":6856673,"node_id":"MDQ6VXNlcjY4NTY2NzM=","avatar_url":"https://avatars.githubusercontent.com/u/6856673?v=4","gravatar_id":"","url":"https://api.github.com/users/zackees","html_url":"https://github.com/zackees","followers_url":"https://api.github.com/users/zackees/followers","following_url":"https://api.github.com/users/zackees/following{/other_user}","gists_url":"https://api.github.com/users/zackees/gists{/gist_id}","starred_url":"https://api.github.com/users/zackees/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zackees/subscriptions","organizations_url":"https://api.github.com/users/zackees/orgs","repos_url":"https://api.github.com/users/zackees/repos","events_url":"https://api.github.com/users/zackees/events{/privacy}","received_events_url":"https://api.github.com/users/zackees/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":86399005,"node_id":"MDU6TGFiZWw4NjM5OTAwNQ==","url":"https://api.github.com/repos/rclone/rclone/labels/bug","name":"bug","color":"fc2929","default":true,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/rclone/rclone/milestones/58","html_url":"https://github.com/rclone/rclone/milestone/58","labels_url":"https://api.github.com/repos/rclone/rclone/milestones/58/labels","id":11570782,"node_id":"MI_kwDOAQ-n5M4AsI5e","number":58,"title":"v1.70","description":"","creator":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":30,"state":"closed","created_at":"2024-09-11T21:18:44Z","updated_at":"2025-06-23T15:40:38Z","due_on":"2025-06-17T07:00:00Z","closed_at":"2025-06-19T17:12:14Z"},"comments":28,"created_at":"2024-07-25T08:44:35Z","updated_at":"2025-06-25T21:14:19Z","closed_at":"2025-04-08T19:28:52Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Background - Amazon S3 rclone problems\r\n\r\nI'm trying to backup a datalake with 100 million files at the root. They are mostly small files < 1mb.\r\n\r\nrclone was simply not designed for this use case and will eat up all available memory and then crash. There was no machine instance that I could throw at it that would fix this issue. Even running locally in a docker instance would eat up all available memory and then crash.\r\n\r\nAll advice in the forums did nothing to help the situation. And a lot of people seem to be running into this. Therefore I wanted to post this here so that anyone searching for this problem can try our solution.\r\n\r\n## Solution in a nutshell: PUT YOUR FILES INTO FOLDERS!!!!\r\n\r\nWhat's interesting is the behavior: rclone would never start transferring files, it would always sit there saying 0 files transferred, 0 bytes transferred, eat up all available memory before crashing with an OOM.\r\n\r\nI tried all the suggestions in the forums, reducing the buffering memory, reducing the number of checkers and transfers. Nothing worked.\r\n\r\n## Cause & Fix\r\n\r\nWithout looking at the code or doing any profiling, my hypothesis was that rclone scans an all files in a\"directory\" into RAM before executing on it. This seems true whether not `--fast-scan` is used or not.\r\n\r\nObviously, having 100 million files at the root was causing our org a whole bunch of problems anyway and it's been something that I've wanted to fix for a while, so this problem gave me enough reason to go ahead and re-organize our entire datalakes.\r\n\r\nSince each file is referenced in our database with a datestamp, I was able to write python scripts that would move these files from the root into folders by the service and year-month (for example name.html -> service/2023-04/name.html)\r\n\r\nThis worked extremely well and I was able to now run rclone and have it at least start transferring some files. However, there were still folders with 5+ million files, and eventually ran into the same out-of-memory error.\r\n\r\nSo again, I further re-organized the files in our datalake into service/yrmo/day. And now that seems to have done the trick. rclone now consistently runs under 2GB memory and I've been able to increase the number of transfers and checkers up to 100 each and have 3mb of buffer per transfer.\r\n\r\n## Dead ends\r\n\r\nAll the advice about adjust memory buffers and number of transfers is mostly wrong. They will only cut your minimum memory usage by a constant factor, but will do very little to prevent the absolute unbounded memory that rclone uses for extremely large \"directories\".\r\n\r\nIf you have this same problem, no amount of setting tweaking will work... you MUST re-organize your data into folders or rclone will just run out of memory every single time. If you have too many files at the root, rclone will simply never start transferring anything and just crash. If one of your subdirectories is too big, you'll get a memory pattern that looks like this:\r\n\r\n![image](https://github.com/user-attachments/assets/cad7926e-48b7-46f7-be81-543edc896460)\r\n\r\n## Recommendations to the Devs of rclone\r\n\r\nPlease serialize your directory scans to disk if you start exceeding a certain threshold of memory or files in the current directory. You can probably just get away with just always doing that since the disk is so much faster than network anyway. I'm currently doing an inventory scan of our datalakes and 50 million files entries is only taking up 12 gb of disk without any fancy compression. I know you are storing a lot more file information, like metadata, so it could easily be double or triple that.\r\n\r\nBut it is simply so much easier and cheaper to allocate disk space to a docker instance than it is to get a machine with much more ram.\r\n\r\nAn additional pain point about an out of memory issue crash is that when the rclone process gets a kill signal, it will **exit 0** making it look like it succeeded. According to this thread https://github.com/rclone/rclone/issues/7966 this is a feature of linux and you must get the exit code from the operating system instead of the return value of the exited rclone process.\r\n\r\nThis is super scary if you are relying on rclone to backup your datalake but in reality, it starts failing because one of your directories has millions of files in it. I know on Digital Ocean it's easy to see that a docker instance has failed, on Render.com however you'll get a \"Run Succeeded\" and it's not until you look at the run history that you'll see that in fact your instance ran out of memory. I'm not sure about the other hosting providers.\r\n\r\nAnyway, I'm glad this huge task is finally over with, and we have started syncing up our data for redundancy and backup purposes. So far so good!\r\n\r\n![image](https://github.com/user-attachments/assets/5c2b7096-ade2-45d7-993e-4fd0b0f52196)\r\n","closed_by":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/7974/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rclone/rclone/issues/7974/timeline","performed_via_github_app":null,"state_reason":"completed"}