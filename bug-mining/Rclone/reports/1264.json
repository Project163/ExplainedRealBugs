{"url":"https://api.github.com/repos/rclone/rclone/issues/7637","repository_url":"https://api.github.com/repos/rclone/rclone","labels_url":"https://api.github.com/repos/rclone/rclone/issues/7637/labels{/name}","comments_url":"https://api.github.com/repos/rclone/rclone/issues/7637/comments","events_url":"https://api.github.com/repos/rclone/rclone/issues/7637/events","html_url":"https://github.com/rclone/rclone/issues/7637","id":2141215377,"node_id":"I_kwDOAQ-n5M5_oFqR","number":7637,"title":"rclone copy with http remote fails with HTTP Error: 404 Not Found when URL contains question mark","user":{"login":"whoschek","id":919871,"node_id":"MDQ6VXNlcjkxOTg3MQ==","avatar_url":"https://avatars.githubusercontent.com/u/919871?v=4","gravatar_id":"","url":"https://api.github.com/users/whoschek","html_url":"https://github.com/whoschek","followers_url":"https://api.github.com/users/whoschek/followers","following_url":"https://api.github.com/users/whoschek/following{/other_user}","gists_url":"https://api.github.com/users/whoschek/gists{/gist_id}","starred_url":"https://api.github.com/users/whoschek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/whoschek/subscriptions","organizations_url":"https://api.github.com/users/whoschek/orgs","repos_url":"https://api.github.com/users/whoschek/repos","events_url":"https://api.github.com/users/whoschek/events{/privacy}","received_events_url":"https://api.github.com/users/whoschek/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":10,"created_at":"2024-02-18T22:30:00Z","updated_at":"2024-07-22T20:29:52Z","closed_at":"2024-04-22T16:59:15Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"<!--\r\n\r\nWe understand you are having a problem with rclone; we want to help you with that!\r\n\r\n**STOP and READ**\r\n**YOUR POST WILL BE REMOVED IF IT IS LOW QUALITY**:\r\nPlease show the effort you've put into solving the problem and please be specific.\r\nPeople are volunteering their time to help! Low effort posts are not likely to get good answers!\r\n\r\nIf you think you might have found a bug, try to replicate it with the latest beta (or stable).\r\nThe update instructions are available at https://rclone.org/commands/rclone_selfupdate/\r\n\r\nIf you can still replicate it or just got a question then please use the rclone forum:\r\n\r\n    https://forum.rclone.org/\r\n\r\nfor a quick response instead of filing an issue on this repo.\r\n\r\nIf nothing else helps, then please fill in the info below which helps us help you.\r\n\r\n**DO NOT REDACT** any information except passwords/keys/personal info.\r\n\r\nYou should use 3 backticks to begin and end your paste to make it readable.\r\n\r\nMake sure to include a log obtained with '-vv'.\r\n\r\nYou can also use '-vv --log-file bug.log' and a service such as https://pastebin.com or https://gist.github.com/\r\n\r\nThank you\r\n\r\nThe Rclone Developers\r\n\r\n-->\r\n\r\n#### The associated forum post URL from `https://forum.rclone.org`\r\nn/a\r\n\r\n\r\n#### What is the problem you are having with rclone?\r\n`rclone copy`, when downloading from a http remote, fails with HTTP Error: 404 Not Found when the HTTP URL contains a question mark. Example:\r\n\r\n`% rclone copy --dump bodies --http-no-head -vv --http-url 'https://www.google.com' ':http:search?q=rclone' /tmp\r\n`\r\n\r\nAs can be seen in the debug error log below, rclone copy (with http remote) URL-encodes the question mark (which correctly separates the URL path from the URL query per the spec) into a '%3F' code and sends that '%3F' to the HTTP server, which violates the semantics of the URL spec - it effectively directs the HTTP server to treat the URL query portion not as a query portion but rather as part of the URL path - hence 404 Not Found. In other words rclone sends this incorrect HTTP GET (and similar HEAD) request, per the debug log below:\r\n\r\n`GET /search%3Fq=rclone HTTP/1.1`\r\n\r\nInstead, the correct GET request to issue here would be:\r\n\r\n`GET /search?q=rclone HTTP/1.1`\r\n\r\nFor reference, curl and wget complete the same request correctly. For example, this 'curl' command completes correctly as expected:\r\n\r\n`% curl 'https://www.google.com/search?q=rclone'`\r\n\r\nAs another reference, 'rclone copyurl' works correctly, as expected:\r\n\r\n`rclone copyurl --http-no-head -vv 'https://www.google.com/search?q=rclone' /tmp/foo\r\n`\r\n\r\nAlso, 'rclone copy' (with http remote) works correctly with URLs that do not contain a question mark (i.e. that contain no query portion). The problem revolves around URL encoding the question mark. I believe, 'rclone copy' (with http remote) should not send URL encoded URL to the HTTP server. Rather, 'rclone copy' (with http remote) should pass the user-provided URL (including the question mark) as-is into the HTTP GET and HEAD requests.\r\n\r\nFYI, I know that in this particular simple 'google search' example one might work around the problem by switching from 'rclone copy' to the 'rclone copyurl' command, but 'copyurl' doesn't implement the --files-from feature as well as parallel downloads and it also doesn't seem to implement atomic file renames from .partial to final file on success, etc. \r\n\r\nIn real life, my use case requires continuously and efficiently downloading from vanilla HTTP servers via lists of millions of URLs, using multiple threads, which makes the use  of 'rclone copy --files-from' mandatory. (And no, a bash download script using copyurl with Unix 'parallel' command  wouldn't meet the requirements - for example it would fork many processes per URL and thus be inefficient)\r\n\r\nFYI, the --local-encoding flag does not seem to provide a work-around - The question mark '?' is always sent as a %3F code to the HTTP server, no matter what.\r\n\r\nTLDR: The proposed fix is for 'rclone copy' (with http remote) to pass user-provided URL (including the question mark) as-is into the HTTP GET and HEAD requests, including for URLs passed in via --files-from feature.\r\n\r\n#### What is your rclone version (output from `rclone version`)\r\n```\r\n%rclone --version\r\nrclone v1.65.2\r\n- os/version: darwin 13.6.4 (64 bit)\r\n- os/kernel: 22.6.0 (arm64)\r\n- os/type: darwin\r\n- os/arch: arm64 (ARMv8 compatible)\r\n- go/version: go1.21.6\r\n- go/linking: dynamic\r\n- go/tags: none\r\n```\r\n\r\n\r\n\r\n#### Which OS you are using and how many bits (e.g. Windows 7, 64 bit)\r\nOSX\r\n\r\n\r\n#### Which cloud storage system are you using? (e.g. Google Drive)\r\nhttp remote to vanilla HTTP server\r\n\r\n\r\n\r\n#### The command you were trying to run (e.g. `rclone copy /tmp remote:tmp`)\r\n`rclone copy --dump bodies --http-no-head -vv --http-url 'https://www.google.com' ':http:search?q=rclone' /tmp`\r\n\r\n\r\n\r\n#### A log from the command with the `-vv` flag (e.g. output from `rclone -vv copy /tmp remote:tmp`)\r\n\r\n```\r\n2024/02/18 22:39:37 DEBUG : rclone: Version \"v1.65.2\" starting with parameters [\"rclone\" \"copy\" \"--dump\" \"bodies\" \"--http-no-head\" \"-vv\" \"--http-url\" \"https://www.google.com\" \":http:search?q=rclone\" \"/tmp/rclone/\"]\r\n2024/02/18 22:39:37 DEBUG : Creating backend with remote \":http:search?q=rclone\"\r\n2024/02/18 22:39:37 DEBUG : Using config file from \"/Users/<xxxxx>/.config/rclone/rclone.conf\"\r\n2024/02/18 22:39:37 DEBUG : :http: detected overridden config - adding \"{s0EIw}\" suffix to name\r\n2024/02/18 22:39:37 DEBUG : You have specified to dump information. Please be noted that the Accept-Encoding as shown may not be correct in the request and the response may not show Content-Encoding if the go standard libraries auto gzip encoding was in effect. In this case the body of the request will be gunzipped before showing it.\r\n2024/02/18 22:39:37 DEBUG : Assuming path is a file as --http-no-head is set\r\n2024/02/18 22:39:37 DEBUG : If path is a directory you must add a trailing '/'\r\n2024/02/18 22:39:37 DEBUG : Root: https://www.google.com/\r\n2024/02/18 22:39:37 DEBUG : fs cache: adding new entry for parent of \":http:search?q=rclone\", \":http{s0EIw}:search?q=rclone\"\r\n2024/02/18 22:39:37 DEBUG : Creating backend with remote \"/tmp/rclone/\"\r\n2024/02/18 22:39:37 DEBUG : fs cache: renaming cache item \"/tmp/rclone/\" to be canonical \"/tmp/rclone\"\r\n2024/02/18 22:39:37 DEBUG : search?q=rclone: Need to transfer - File not found at Destination\r\n2024/02/18 22:39:37 DEBUG : >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>\r\n2024/02/18 22:39:37 DEBUG : HTTP REQUEST (req 0x140007aa600)\r\n2024/02/18 22:39:37 DEBUG : GET /search%3Fq=rclone HTTP/1.1\r\nHost: www.google.com\r\nUser-Agent: rclone/v1.65.2\r\nAccept-Encoding: gzip\r\n\r\n2024/02/18 22:39:37 DEBUG : >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>\r\n2024/02/18 22:39:37 DEBUG : <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<\r\n2024/02/18 22:39:37 DEBUG : HTTP RESPONSE (req 0x140007aa600)\r\n2024/02/18 22:39:37 DEBUG : HTTP/2.0 404 Not Found\r\nContent-Length: 1578\r\nAlt-Svc: h3=\":443\"; ma=2592000,h3-29=\":443\"; ma=2592000\r\nContent-Type: text/html; charset=UTF-8\r\nDate: Sun, 18 Feb 2024 21:39:37 GMT\r\nReferrer-Policy: no-referrer\r\n\r\n<!DOCTYPE html>\r\n<html lang=en>\r\n  <meta charset=utf-8>\r\n  <meta name=viewport content=\"initial-scale=1, minimum-scale=1, width=device-width\">\r\n  <title>Error 404 (Not Found)!!1</title>\r\n  <style>\r\n    *{margin:0;padding:0}html,code{font:15px/22px arial,sans-serif}html{background:#fff;color:#222;padding:15px}body{margin:7% auto 0;max-width:390px;min-height:180px;padding:30px 0 15px}* > body{background:url(//www.google.com/images/errors/robot.png) 100% 5px no-repeat;padding-right:205px}p{margin:11px 0 22px;overflow:hidden}ins{color:#777;text-decoration:none}a img{border:0}@media screen and (max-width:772px){body{background:none;margin-top:0;max-width:none;padding-right:0}}#logo{background:url(//www.google.com/images/branding/googlelogo/1x/googlelogo_color_150x54dp.png) no-repeat;margin-left:-5px}@media only screen and (min-resolution:192dpi){#logo{background:url(//www.google.com/images/branding/googlelogo/2x/googlelogo_color_150x54dp.png) no-repeat 0% 0%/100% 100%;-moz-border-image:url(//www.google.com/images/branding/googlelogo/2x/googlelogo_color_150x54dp.png) 0}}@media only screen and (-webkit-min-device-pixel-ratio:2){#logo{background:url(//www.google.com/images/branding/googlelogo/2x/googlelogo_color_150x54dp.png) no-repeat;-webkit-background-size:100% 100%}}#logo{display:inline-block;height:54px;width:150px}\r\n  </style>\r\n  <a href=//www.google.com/><span id=logo aria-label=Google></span></a>\r\n  <p><b>404.</b> <ins>That‚Äôs an error.</ins>\r\n  <p>The requested URL <code>/search%3Fq=rclone</code> was not found on this server.  <ins>That‚Äôs all we know.</ins>\r\n2024/02/18 22:39:37 DEBUG : <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<\r\n2024/02/18 22:39:37 ERROR : search?q=rclone: Failed to copy: failed to open source object: Open failed: HTTP Error: 404 Not Found\r\n2024/02/18 22:39:37 ERROR : Attempt 1/3 failed with 1 errors and: failed to open source object: Open failed: HTTP Error: 404 Not Found\r\n2024/02/18 22:39:37 DEBUG : search?q=rclone: Need to transfer - File not found at Destination\r\n...\r\n2024/02/18 22:39:37 DEBUG : <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<\r\n2024/02/18 22:39:37 ERROR : search?q=rclone: Failed to copy: failed to open source object: Open failed: HTTP Error: 404 Not Found\r\n2024/02/18 22:39:37 ERROR : Attempt 3/3 failed with 1 errors and: failed to open source object: Open failed: HTTP Error: 404 Not Found\r\n2024/02/18 22:39:37 INFO  : \r\nTransferred:   \t          0 B / 0 B, -, 0 B/s, ETA -\r\nErrors:                 1 (retrying may help)\r\nElapsed time:         0.5s\r\n\r\n2024/02/18 22:39:37 DEBUG : 8 go routines active\r\n2024/02/18 22:39:37 Failed to copy: failed to open source object: Open failed: HTTP Error: 404 Not Found\r\n\r\n```\r\n\r\n\r\n<!--- Please keep the note below for others who read your bug report. -->\r\n\r\n#### How to use GitHub\r\n\r\n* Please use the üëç [reaction](https://blog.github.com/2016-03-10-add-reactions-to-pull-requests-issues-and-comments/) to show that you are affected by the same issue.\r\n* Please don't comment if you have no relevant information to add. It's just extra noise for everyone subscribed to this issue.\r\n* Subscribe to receive notifications on status change and new comments.\r\n","closed_by":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/7637/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rclone/rclone/issues/7637/timeline","performed_via_github_app":null,"state_reason":"completed"}