{"url":"https://api.github.com/repos/rclone/rclone/issues/6857","repository_url":"https://api.github.com/repos/rclone/rclone","labels_url":"https://api.github.com/repos/rclone/rclone/issues/6857/labels{/name}","comments_url":"https://api.github.com/repos/rclone/rclone/issues/6857/comments","events_url":"https://api.github.com/repos/rclone/rclone/issues/6857/events","html_url":"https://github.com/rclone/rclone/issues/6857","id":1627860052,"node_id":"I_kwDOAQ-n5M5hByxU","number":6857,"title":"Jottacloud: vfs writeback stuck in a failed upload loop with file versioning disabled","user":{"login":"cycneuramus","id":56681631,"node_id":"MDQ6VXNlcjU2NjgxNjMx","avatar_url":"https://avatars.githubusercontent.com/u/56681631?v=4","gravatar_id":"","url":"https://api.github.com/users/cycneuramus","html_url":"https://github.com/cycneuramus","followers_url":"https://api.github.com/users/cycneuramus/followers","following_url":"https://api.github.com/users/cycneuramus/following{/other_user}","gists_url":"https://api.github.com/users/cycneuramus/gists{/gist_id}","starred_url":"https://api.github.com/users/cycneuramus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cycneuramus/subscriptions","organizations_url":"https://api.github.com/users/cycneuramus/orgs","repos_url":"https://api.github.com/users/cycneuramus/repos","events_url":"https://api.github.com/users/cycneuramus/events{/privacy}","received_events_url":"https://api.github.com/users/cycneuramus/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1045816570,"node_id":"MDU6TGFiZWwxMDQ1ODE2NTcw","url":"https://api.github.com/repos/rclone/rclone/labels/Remote:%20Jottacloud","name":"Remote: Jottacloud","color":"fbca04","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2023-03-16T16:29:58Z","updated_at":"2023-03-17T11:54:46Z","closed_at":"2023-03-17T11:54:46Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"#### What is the problem you are having with rclone?\r\n\r\nVFS writeback on a mounted Jottacloud remote, with file versioning _disabled_, gets stuck in a failed upload loop if there is a problem copying the file to the remote.\r\n\r\n#### What is your rclone version (output from `rclone version`)\r\n\r\n```\r\nrclone v1.62.2\r\n- os/version: arch (64 bit)\r\n- os/kernel: 6.2.6-arch1-1 (x86_64)\r\n- os/type: linux\r\n- os/arch: amd64\r\n- go/version: go1.20.2\r\n- go/linking: static\r\n- go/tags: none\r\n```\r\n\r\n#### Which OS you are using and how many bits (e.g. Windows 7, 64 bit)\r\n\r\nArch Linux\r\n\r\n#### Which cloud storage system are you using? (e.g. Google Drive)\r\n\r\nJottacloud\r\n\r\n#### The command you were trying to run (e.g. `rclone copy /tmp remote:tmp`)\r\n\r\nMount command:\r\n\r\n```\r\nrclone mount \\\r\n\t--allow-other \\\r\n\t--gid 1000 \\\r\n\t--uid 1000 \\\r\n\t--cache-dir $HOME/.cache/rclone/jotta \\\r\n\t--config $HOME/rclone.conf \\\r\n\t--log-file $HOME/rclone.log \\\r\n\t--vfs-cache-mode full \\\r\n\t--vfs-cache-max-size 5G \\\r\n\t--ignore-checksum \\\r\n\t--ignore-size \\\r\n\t-vv \\\r\n\tjotta: $HOME/.local/mnt/jotta\r\n```\r\n\r\n#### A log from the command with the `-vv` flag (e.g. output from `rclone -vv copy /tmp remote:tmp`)\r\n\r\n`echo \"test\" > .local/mnt/jotta/test.txt`\r\n\r\nSucceeds:\r\n\r\n```\r\n2023/03/16 16:39:06 DEBUG : /: Lookup: name=\"test.txt\"\r\n2023/03/16 16:39:06 DEBUG : /: >Lookup: node=<nil>, err=no such file or directory\r\n2023/03/16 16:39:06 DEBUG : /: Create: name=\"test.txt\"\r\n2023/03/16 16:39:06 DEBUG : test.txt: Open: flags=O_WRONLY|O_CREATE|O_TRUNC\r\n2023/03/16 16:39:06 DEBUG : test.txt: newRWFileHandle:\r\n2023/03/16 16:39:06 DEBUG : test.txt(0xc00103a840): openPending:\r\n2023/03/16 16:39:06 DEBUG : test.txt: vfs cache: truncate to size=0 (not needed as size correct)\r\n2023/03/16 16:39:06 DEBUG : : Added virtual directory entry vAddFile: \"test.txt\"\r\n2023/03/16 16:39:06 DEBUG : test.txt(0xc00103a840): >openPending: err=<nil>\r\n2023/03/16 16:39:06 DEBUG : test.txt: >newRWFileHandle: err=<nil>\r\n2023/03/16 16:39:06 DEBUG : : Added virtual directory entry vAddFile: \"test.txt\"\r\n2023/03/16 16:39:06 DEBUG : test.txt: >Open: fd=test.txt (rw), err=<nil>\r\n2023/03/16 16:39:06 DEBUG : /: >Create: node=test.txt, handle=&{test.txt (rw)}, err=<nil>\r\n2023/03/16 16:39:06 DEBUG : test.txt: Attr:\r\n2023/03/16 16:39:06 DEBUG : test.txt: >Attr: a=valid=1s ino=0 size=0 mode=-rw-r--r--, err=<nil>\r\n2023/03/16 16:39:06 DEBUG : &{test.txt (rw)}: Flush:\r\n2023/03/16 16:39:06 DEBUG : test.txt(0xc00103a840): RWFileHandle.Flush\r\n2023/03/16 16:39:06 DEBUG : &{test.txt (rw)}: >Flush: err=<nil>\r\n2023/03/16 16:39:06 DEBUG : &{test.txt (rw)}: Write: len=5, offset=0\r\n2023/03/16 16:39:06 DEBUG : test.txt(0xc00103a840): _writeAt: size=5, off=0\r\n2023/03/16 16:39:06 DEBUG : test.txt(0xc00103a840): >_writeAt: n=5, err=<nil>\r\n2023/03/16 16:39:06 DEBUG : &{test.txt (rw)}: >Write: written=5, err=<nil>\r\n2023/03/16 16:39:06 DEBUG : &{test.txt (rw)}: Flush:\r\n2023/03/16 16:39:06 DEBUG : test.txt(0xc00103a840): RWFileHandle.Flush\r\n2023/03/16 16:39:06 DEBUG : &{test.txt (rw)}: >Flush: err=<nil>\r\n2023/03/16 16:39:06 DEBUG : &{test.txt (rw)}: Release:\r\n2023/03/16 16:39:06 DEBUG : test.txt(0xc00103a840): RWFileHandle.Release\r\n2023/03/16 16:39:06 DEBUG : test.txt(0xc00103a840): close:\r\n2023/03/16 16:39:06 DEBUG : test.txt: vfs cache: setting modification time to 2023-03-16 16:39:06.918542185 +0100 CET m=+64.622169854\r\n2023/03/16 16:39:06 INFO  : test.txt: vfs cache: queuing for upload in 5s\r\n2023/03/16 16:39:06 DEBUG : test.txt(0xc00103a840): >close: err=<nil>\r\n2023/03/16 16:39:06 DEBUG : &{test.txt (rw)}: >Release: err=<nil>\r\n2023/03/16 16:39:11 DEBUG : test.txt: vfs cache: starting upload\r\n2023/03/16 16:39:12 INFO  : test.txt: Copied (new)\r\n2023/03/16 16:39:12 DEBUG : test.txt: vfs cache: fingerprint now \"5,2023-03-16 15:39:06 +0000 UTC,d8e8fca2dc0f896fd7cb4cb0031ba249\"\r\n2023/03/16 16:39:12 DEBUG : test.txt: vfs cache: writeback object to VFS layer\r\n2023/03/16 16:39:12 DEBUG : : Added virtual directory entry vAddFile: \"test.txt\"\r\n2023/03/16 16:39:12 INFO  : test.txt: vfs cache: upload succeeded try #1\r\n```\r\n\r\nThis, however, fails:\r\n\r\n`echo \"test\" > $HOME/test.txt`\r\n`echo \"test2\" >> $HOME/test.txt`\r\n`rclone copy $HOME/test.txt .local/mnt/jotta/test.txt`\r\n\r\n```\r\n2023/03/16 16:40:41 DEBUG : /: Lookup: name=\"test.txt\"\r\n2023/03/16 16:40:41 DEBUG : /: >Lookup: node=test.txt, err=<nil>\r\n2023/03/16 16:40:41 DEBUG : test.txt: Attr:\r\n2023/03/16 16:40:41 DEBUG : test.txt: >Attr: a=valid=1s ino=0 size=5 mode=-rw-r--r--, err=<nil>\r\n2023/03/16 16:40:41 DEBUG : test.txt: Open: flags=OpenWriteOnly\r\n2023/03/16 16:40:41 DEBUG : test.txt: Open: flags=O_WRONLY\r\n2023/03/16 16:40:41 DEBUG : test.txt: newRWFileHandle:\r\n2023/03/16 16:40:41 DEBUG : test.txt: >newRWFileHandle: err=<nil>\r\n2023/03/16 16:40:41 DEBUG : test.txt: >Open: fd=test.txt (rw), err=<nil>\r\n2023/03/16 16:40:41 DEBUG : test.txt: >Open: fh=&{test.txt (rw)}, err=<nil>\r\n2023/03/16 16:40:41 DEBUG : test.txt: Setattr: a=Setattr [ID=0x5c Node=0x4 Uid=1000 Gid=1000 Pid=37405] size=0 handle=INVALID-0x0 lockowner\r\n2023/03/16 16:40:41 DEBUG : test.txt: Truncating 1 file handles\r\n2023/03/16 16:40:41 DEBUG : test.txt(0xc00103a080): openPending:\r\n2023/03/16 16:40:41 DEBUG : test.txt: vfs cache: checking remote fingerprint \"5,2023-03-16 15:39:06 +0000 UTC,d8e8fca2dc0f896fd7cb4cb0031ba249\" against cached fingerprint \"5,2023-03-16 15:39:06 +0000 UTC,d8e8fca2dc0f896fd7cb4cb0031ba249\"\r\n2023/03/16 16:40:41 DEBUG : test.txt: vfs cache: truncate to size=6 (not needed as size correct)\r\n2023/03/16 16:40:41 DEBUG : : Added virtual directory entry vAddFile: \"test.txt\"\r\n2023/03/16 16:40:41 DEBUG : test.txt(0xc00103a080): >openPending: err=<nil>\r\n2023/03/16 16:40:41 DEBUG : test.txt: vfs cache: truncate to size=0\r\n2023/03/16 16:40:41 DEBUG : test.txt: >Setattr: err=<nil>\r\n2023/03/16 16:40:41 DEBUG : test.txt: Attr:\r\n2023/03/16 16:40:41 DEBUG : test.txt: >Attr: a=valid=1s ino=0 size=0 mode=-rw-r--r--, err=<nil>\r\n2023/03/16 16:40:41 DEBUG : &{test.txt (rw)}: Write: len=11, offset=0\r\n2023/03/16 16:40:41 DEBUG : test.txt(0xc00103a080): _writeAt: size=11, off=0\r\n2023/03/16 16:40:41 DEBUG : test.txt(0xc00103a080): >_writeAt: n=11, err=<nil>\r\n2023/03/16 16:40:41 DEBUG : &{test.txt (rw)}: >Write: written=11, err=<nil>\r\n2023/03/16 16:40:41 DEBUG : &{test.txt (rw)}: Flush:\r\n2023/03/16 16:40:41 DEBUG : test.txt(0xc00103a080): RWFileHandle.Flush\r\n2023/03/16 16:40:41 DEBUG : &{test.txt (rw)}: >Flush: err=<nil>\r\n2023/03/16 16:40:41 DEBUG : &{test.txt (rw)}: Release:\r\n2023/03/16 16:40:41 DEBUG : test.txt(0xc00103a080): RWFileHandle.Release\r\n2023/03/16 16:40:41 DEBUG : test.txt(0xc00103a080): close:\r\n2023/03/16 16:40:41 DEBUG : vfs cache: looking for range={Pos:0 Size:11} in [{Pos:0 Size:11}] - present true\r\n2023/03/16 16:40:41 DEBUG : test.txt: Setattr: a=Setattr [ID=0x6a Node=0x4 Uid=1000 Gid=1000 Pid=37405] atime=2023-03-16 16:40:29.612801105 +0100 CET mtime=2023-03-16 16:40:29.612801105 +0100 CET handle=INVALID-0x0\r\n2023/03/16 16:40:41 DEBUG : test.txt: vfs cache: setting modification time to 2023-03-16 16:40:41.956703164 +0100 CET m=+159.660330823\r\n2023/03/16 16:40:41 INFO  : test.txt: vfs cache: queuing for upload in 5s\r\n2023/03/16 16:40:41 DEBUG : test.txt: vfs cache: setting modification time to 2023-03-16 16:40:29.612801105 +0100 CET\r\n2023/03/16 16:40:41 DEBUG : test.txt: >Setattr: err=<nil>\r\n2023/03/16 16:40:41 DEBUG : test.txt(0xc00103a080): >close: err=<nil>\r\n2023/03/16 16:40:41 DEBUG : test.txt: Attr:\r\n2023/03/16 16:40:41 DEBUG : test.txt: >Attr: a=valid=1s ino=0 size=11 mode=-rw-r--r--, err=<nil>\r\n2023/03/16 16:40:41 DEBUG : &{test.txt (rw)}: >Release: err=<nil>\r\n2023/03/16 16:40:46 DEBUG : test.txt: vfs cache: starting upload\r\n2023/03/16 16:40:47 ERROR : test.txt: Failed to copy: failed to remove old object: error 404: no.jotta.backup.errors.NoSuchFileException: File /luikuwq6rr0yojo8kc6biqgk/Jotta/Archive/test.txt does not exist (Not Found)\r\n2023/03/16 16:40:47 ERROR : test.txt: vfs cache: failed to upload try #1, will retry in 10s: vfs cache: failed to transfer file from cache to remote: failed to remove old object: error 404: no.jotta.backup.errors.NoSuchFileException: File /luikuwq6rr0yojo8kc6biqgk/Jotta/Archive/test.txt does not exist (Not Found)\r\n2023/03/16 16:40:57 DEBUG : test.txt: vfs cache: starting upload\r\n2023/03/16 16:40:57 ERROR : test.txt: Failed to copy: failed to remove old object: error 404: no.jotta.backup.errors.NoSuchFileException: File /luikuwq6rr0yojo8kc6biqgk/Jotta/Archive/test.txt does not exist (Not Found)\r\n2023/03/16 16:40:57 ERROR : test.txt: vfs cache: failed to upload try #2, will retry in 20s: vfs cache: failed to transfer file from cache to remote: failed to remove old object: error 404: no.jotta.backup.errors.NoSuchFileException: File /luikuwq6rr0yojo8kc6biqgk/Jotta/Archive/test.txt does not exist (Not Found)\r\n2023/03/16 16:41:02 DEBUG : vfs cache RemoveNotInUse (maxAge=3600000000000, emptyOnly=false): item test.txt not removed, freed 0 bytes\r\n2023/03/16 16:41:02 INFO  : vfs cache: cleaned: objects 1 (was 1) in use 1, to upload 1, uploading 0, total size 11 (was 11)\r\n2023/03/16 16:41:17 DEBUG : test.txt: vfs cache: starting upload\r\n2023/03/16 16:41:17 ERROR : test.txt: Failed to copy: failed to remove old object: error 404: no.jotta.backup.errors.NoSuchFileException: File /luikuwq6rr0yojo8kc6biqgk/Jotta/Archive/test.txt does not exist (Not Found)\r\n2023/03/16 16:41:17 ERROR : test.txt: vfs cache: failed to upload try #3, will retry in 40s: vfs cache: failed to transfer file from cache to remote: failed to remove old object: error 404: no.jotta.backup.errors.NoSuchFileException: File /luikuwq6rr0yojo8kc6biqgk/Jotta/Archive/test.txt does not exist (Not Found)\r\n```\r\n\r\nAnd on it goes, stuck in a loop.\r\n\r\nNow, if I change the Jottacloud remote config to enable file versioning (`no_versions = false`) and re-mount, the upload succeeds:\r\n\r\n```\r\n2023/03/16 16:48:54 DEBUG : test.txt: vfs cache: setting modification time to 2023-03-16 16:40:29.612801105 +0100 CET\r\n2023/03/16 16:48:54 INFO  : test.txt: vfs cache: queuing for upload in 5s\r\n2023/03/16 16:48:54 DEBUG : : Added virtual directory entry vAddFile: \"test.txt\"\r\n2023/03/16 16:48:54 DEBUG : vfs cache RemoveNotInUse (maxAge=3600000000000, emptyOnly=false): item test.txt not removed, freed 0 bytes\r\n2023/03/16 16:48:54 INFO  : vfs cache: cleaned: objects 1 (was 1) in use 1, to upload 1, uploading 0, total size 11 (was 11)\r\n2023/03/16 16:48:54 DEBUG : jottacloud root '': Mounting on \"/home/antsva/.local/mnt/jotta\"\r\n2023/03/16 16:48:54 DEBUG : : Root:\r\n2023/03/16 16:48:54 DEBUG : : >Root: node=/, err=<nil>\r\n2023/03/16 16:48:59 DEBUG : test.txt: vfs cache: starting upload\r\n2023/03/16 16:48:59 INFO  : test.txt: Copied (new)\r\n2023/03/16 16:48:59 DEBUG : test.txt: vfs cache: fingerprint now \"11,2023-03-16 15:40:29 +0000 UTC,4221027b3a3f072ba2464439361db5c6\"\r\n2023/03/16 16:48:59 INFO  : test.txt: vfs cache: upload succeeded try #1\r\n```\r\n\r\nAnd, following the same procedure as described above‚Äîi.e. creating a test file in the remote mount and copying an updated version of the file into it‚Äîthe problem can no longer be reproduced.\r\n\r\n---\r\n\r\nI have come across this same kind of problem a couple of times in production, where the behavior I've noticed probably goes something like this:\r\n\r\n1. VFS cache tries writing a file back to the remote and fails, say, because of hash mismatch (`corrupted on transfer`)\r\n2. Failed copy is removed ([operations.go:498](https://github.com/rclone/rclone/blob/master/fs/operations/operations.go#L498))\r\n3. Jottacloud backend tries to remove an already removed object ([jottacloud.go:1840‚Äì1843](https://github.com/rclone/rclone/blob/master/backend/jottacloud/jottacloud.go#L1840-L1843)) and fails\r\n4. VFS cache starts retrying the upload indefinitely, causing a never-ending loop\r\n\r\nIn this situation, manually transfering the file using a `copy` command (local->remote) initially throws the same hash mismatch error (not sure what causes this to begin with), but will then immediately succeed on the second attempt. The VFS writeback operation probably never gets to that second attempt because of the failure loop.\r\n\r\nNow, in my tests here, it's not clear from the logs what's actually causing the upload issue, but the failure loop and its connection to file versioning is probably related to [this](https://github.com/rclone/rclone/blob/master/backend/jottacloud/jottacloud.go#L1836-L1849) part of the `Update` function in `jottacloud.go`:\r\n\r\n```go\r\n\tif o.fs.opt.NoVersions {\r\n\t\terr := o.readMetaData(ctx, false)\r\n\t\tif err == nil {\r\n\t\t\t// if the object exists delete it\r\n\t\t\terr = o.remove(ctx, true)\r\n\t\t\tif err != nil {\r\n\t\t\t\treturn fmt.Errorf(\"failed to remove old object: %w\", err)\r\n\t\t\t}\r\n\t\t}\r\n\t\t// if the object does not exist we can just continue but if the error is something different we should report that\r\n\t\tif err != fs.ErrorObjectNotFound {\r\n\t\t\treturn err\r\n\t\t}\r\n\t}\r\n```\r\n\r\n\r\n\r\n<!--- Please keep the note below for others who read your bug report. -->\r\n\r\n#### How to use GitHub\r\n\r\n* Please use the üëç [reaction](https://blog.github.com/2016-03-10-add-reactions-to-pull-requests-issues-and-comments/) to show that you are affected by the same issue.\r\n* Please don't comment if you have no relevant information to add. It's just extra noise for everyone subscribed to this issue.\r\n* Subscribe to receive notifications on status change and new comments.","closed_by":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/6857/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rclone/rclone/issues/6857/timeline","performed_via_github_app":null,"state_reason":"completed"}