{"url":"https://api.github.com/repos/rclone/rclone/issues/7424","repository_url":"https://api.github.com/repos/rclone/rclone","labels_url":"https://api.github.com/repos/rclone/rclone/issues/7424/labels{/name}","comments_url":"https://api.github.com/repos/rclone/rclone/issues/7424/comments","events_url":"https://api.github.com/repos/rclone/rclone/issues/7424/events","html_url":"https://github.com/rclone/rclone/issues/7424","id":1995653842,"node_id":"I_kwDOAQ-n5M5280LS","number":7424,"title":"Metadata (UID/GID) not set properly for multipart downloads from S3 to Unix file system","user":{"login":"ppapadopoulos","id":3385677,"node_id":"MDQ6VXNlcjMzODU2Nzc=","avatar_url":"https://avatars.githubusercontent.com/u/3385677?v=4","gravatar_id":"","url":"https://api.github.com/users/ppapadopoulos","html_url":"https://github.com/ppapadopoulos","followers_url":"https://api.github.com/users/ppapadopoulos/followers","following_url":"https://api.github.com/users/ppapadopoulos/following{/other_user}","gists_url":"https://api.github.com/users/ppapadopoulos/gists{/gist_id}","starred_url":"https://api.github.com/users/ppapadopoulos/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ppapadopoulos/subscriptions","organizations_url":"https://api.github.com/users/ppapadopoulos/orgs","repos_url":"https://api.github.com/users/ppapadopoulos/repos","events_url":"https://api.github.com/users/ppapadopoulos/events{/privacy}","received_events_url":"https://api.github.com/users/ppapadopoulos/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":86399005,"node_id":"MDU6TGFiZWw4NjM5OTAwNQ==","url":"https://api.github.com/repos/rclone/rclone/labels/bug","name":"bug","color":"fc2929","default":true,"description":null},{"id":306063362,"node_id":"MDU6TGFiZWwzMDYwNjMzNjI=","url":"https://api.github.com/repos/rclone/rclone/labels/Remote:%20Local%20FS","name":"Remote: Local FS","color":"fbca04","default":false,"description":""},{"id":6919867104,"node_id":"LA_kwDOAQ-n5M8AAAABnHTK4A","url":"https://api.github.com/repos/rclone/rclone/labels/Support%20Contract","name":"Support Contract","color":"D93F0B","default":false,"description":"Issues made for customers with support contracts"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/rclone/rclone/milestones/55","html_url":"https://github.com/rclone/rclone/milestone/55","labels_url":"https://api.github.com/repos/rclone/rclone/milestones/55/labels","id":10370070,"node_id":"MI_kwDOAQ-n5M4AnjwW","number":55,"title":"v1.67","description":"","creator":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":27,"state":"closed","created_at":"2024-01-03T12:08:00Z","updated_at":"2024-10-17T09:00:34Z","due_on":"2024-04-21T07:00:00Z","closed_at":"2024-07-01T16:37:48Z"},"comments":7,"created_at":"2023-11-15T22:09:19Z","updated_at":"2024-05-14T11:53:35Z","closed_at":"2024-05-14T11:52:06Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"<!--\r\n\r\nWe understand you are having a problem with rclone; we want to help you with that!\r\n\r\n**STOP and READ**\r\n**YOUR POST WILL BE REMOVED IF IT IS LOW QUALITY**:\r\nPlease show the effort you've put into solving the problem and please be specific.\r\nPeople are volunteering their time to help! Low effort posts are not likely to get good answers!\r\n\r\nIf you think you might have found a bug, try to replicate it with the latest beta (or stable).\r\nThe update instructions are available at https://rclone.org/commands/rclone_selfupdate/\r\n\r\nIf you can still replicate it or just got a question then please use the rclone forum:\r\n\r\n    https://forum.rclone.org/\r\n\r\nfor a quick response instead of filing an issue on this repo.\r\n\r\nIf nothing else helps, then please fill in the info below which helps us help you.\r\n\r\n**DO NOT REDACT** any information except passwords/keys/personal info.\r\n\r\nYou should use 3 backticks to begin and end your paste to make it readable.\r\n\r\nMake sure to include a log obtained with '-vv'.\r\n\r\nYou can also use '-vv --log-file bug.log' and a service such as https://pastebin.com or https://gist.github.com/\r\n\r\nThank you\r\n\r\nThe Rclone Developers\r\n\r\n-->\r\n\r\n#### The associated forum post URL from `https://forum.rclone.org`\r\nhttps://forum.rclone.org/t/uid-gid-not-restored-for-objects-stored-in-glacier/42885/3\r\n\r\n\r\n#### What is the problem you are having with rclone?\r\nWhen downloading large files (larger than --multi-thread-cutoff), date,permissions are set properly, but UID/GID is NOT set properly.\r\nSetting the --multi-thread-cutoff to be larger than the file size (forcing single thread), results in proper metadata\r\n\r\n\r\n\r\n#### What is your rclone version (output from `rclone version`)\r\n```\r\nrclone v1.64.2-DEV\r\n- os/version: rocky 8.8 (64 bit)\r\n- os/kernel: 4.18.0-477.15.1.el8_8.x86_64 (x86_64)\r\n- os/type: linux\r\n- os/arch: amd64\r\n- go/version: go1.20.4\r\n- go/linking: dynamic\r\n- go/tags: none\r\n```\r\n\r\n\r\n#### Which OS you are using and how many bits (e.g. Windows 7, 64 bit)\r\n\r\nRocky Linux 8.8\r\n\r\n#### Which cloud storage system are you using? (e.g. Google Drive)\r\nAmazon S3 \r\n\r\n\r\n#### The command you were trying to run (e.g. `rclone copy /tmp remote:tmp`)\r\n\r\nrclone copy\r\n```\r\n# rclone --metadata --links --transfers 2 --checkers 32  --include pero.scaff.fa.pac  copy s3-backup:testing /tmp/ppapadop\r\n```\r\n\r\n#### A log from the command with the `-vv` flag (e.g. output from `rclone -vv copy /tmp remote:tmp`)\r\n```\r\n# $rclone --include pero.scaff.fa.pac -vv  copy s3-backup:testing /tmp/ppapadop\r\n2023/11/15 13:27:59 DEBUG : rclone: Version \"v1.64.2-DEV\" starting with parameters [\"rclone\" \"--config\" \"/root/rcs3/POC/config/rclone.conf\" \"--s3-shared-credentials-file\" \"/root/rcs3/POC/config/credentials\" \"--metadata\" \"--links\" \"--transfers\" \"2\" \"--checkers\" \"32\" \"--include\" \"pero.scaff.fa.pac\" \"-vv\" \"copy\" \"s3-backup:testing\" \"/tmp/ppapadop\"]\r\n2023/11/15 13:27:59 DEBUG : Creating backend with remote \"s3-backup:testing\"\r\n2023/11/15 13:27:59 DEBUG : Using config file from \"/root/rcs3/POC/config/rclone.conf\"\r\n2023/11/15 13:27:59 DEBUG : Creating backend with remote \"s3-native:ppapadop-tmpstore1-uci-bkup-bucket/testing\"\r\n2023/11/15 13:27:59 DEBUG : s3-native: detected overridden config - adding \"{DSqVk}\" suffix to name\r\n2023/11/15 13:27:59 DEBUG : fs cache: renaming cache item \"s3-native:ppapadop-tmpstore1-uci-bkup-bucket/testing\" to be canonical \"s3-native{DSqVk}:ppapadop-tmpstore1-uci-bkup-bucket/testing\"\r\n2023/11/15 13:27:59 DEBUG : fs cache: renaming cache item \"s3-backup:testing\" to be canonical \"s3-native{DSqVk}:ppapadop-tmpstore1-uci-bkup-bucket/testing\"\r\n2023/11/15 13:27:59 DEBUG : Creating backend with remote \"/tmp/ppapadop\"\r\n2023/11/15 13:27:59 DEBUG : local: detected overridden config - adding \"{b6816}\" suffix to name\r\n2023/11/15 13:27:59 DEBUG : fs cache: renaming cache item \"/tmp/ppapadop\" to be canonical \"local{b6816}:/tmp/ppapadop\"\r\n2023/11/15 13:27:59 DEBUG : pero.scaff.fa.pac: Need to transfer - File not found at Destination\r\n2023/11/15 13:27:59 DEBUG : Local file system at /tmp/ppapadop: Waiting for checks to finish\r\n2023/11/15 13:27:59 DEBUG : Local file system at /tmp/ppapadop: Waiting for transfers to finish\r\n2023/11/15 13:27:59 DEBUG : pero.scaff.fa.pac: multi-thread copy: write buffer set to 131072\r\n2023/11/15 13:27:59 DEBUG : pero.scaff.fa.pac: multi-thread copy: using backend concurrency of 4 instead of --multi-thread-streams 4\r\n2023/11/15 13:27:59 DEBUG : pero.scaff.fa.pac: Starting multi-thread copy with 10 chunks of size 64Mi with 4 parallel streams\r\n2023/11/15 13:27:59 DEBUG : pero.scaff.fa.pac: multi-thread copy: chunk 4/10 (201326592-268435456) size 64Mi starting\r\n2023/11/15 13:27:59 DEBUG : pero.scaff.fa.pac: multi-thread copy: chunk 1/10 (0-67108864) size 64Mi starting\r\n2023/11/15 13:27:59 DEBUG : pero.scaff.fa.pac: multi-thread copy: chunk 2/10 (67108864-134217728) size 64Mi starting\r\n2023/11/15 13:27:59 DEBUG : pero.scaff.fa.pac: multi-thread copy: chunk 3/10 (134217728-201326592) size 64Mi starting\r\n2023/11/15 13:27:59 DEBUG : pero.scaff.fa.pac.yinalon3.partial: writing chunk 3\r\n2023/11/15 13:27:59 DEBUG : pero.scaff.fa.pac.yinalon3.partial: writing chunk 0\r\n2023/11/15 13:27:59 DEBUG : pero.scaff.fa.pac.yinalon3.partial: writing chunk 2\r\n2023/11/15 13:27:59 DEBUG : pero.scaff.fa.pac.yinalon3.partial: writing chunk 1\r\n2023/11/15 13:28:03 DEBUG : pero.scaff.fa.pac: multi-thread copy: chunk 1/10 (0-67108864) size 64Mi finished\r\n2023/11/15 13:28:03 DEBUG : pero.scaff.fa.pac: multi-thread copy: chunk 5/10 (268435456-335544320) size 64Mi starting\r\n2023/11/15 13:28:03 DEBUG : pero.scaff.fa.pac: multi-thread copy: chunk 4/10 (201326592-268435456) size 64Mi finished\r\n2023/11/15 13:28:03 DEBUG : pero.scaff.fa.pac: multi-thread copy: chunk 6/10 (335544320-402653184) size 64Mi starting\r\n2023/11/15 13:28:03 DEBUG : pero.scaff.fa.pac.yinalon3.partial: writing chunk 4\r\n2023/11/15 13:28:03 DEBUG : pero.scaff.fa.pac.yinalon3.partial: writing chunk 5\r\n2023/11/15 13:28:03 DEBUG : pero.scaff.fa.pac: multi-thread copy: chunk 3/10 (134217728-201326592) size 64Mi finished\r\n2023/11/15 13:28:03 DEBUG : pero.scaff.fa.pac: multi-thread copy: chunk 7/10 (402653184-469762048) size 64Mi starting\r\n2023/11/15 13:28:03 DEBUG : pero.scaff.fa.pac: multi-thread copy: chunk 2/10 (67108864-134217728) size 64Mi finished\r\n2023/11/15 13:28:03 DEBUG : pero.scaff.fa.pac: multi-thread copy: chunk 8/10 (469762048-536870912) size 64Mi starting\r\n2023/11/15 13:28:03 DEBUG : pero.scaff.fa.pac.yinalon3.partial: writing chunk 6\r\n2023/11/15 13:28:03 DEBUG : pero.scaff.fa.pac.yinalon3.partial: writing chunk 7\r\n2023/11/15 13:28:07 DEBUG : pero.scaff.fa.pac: multi-thread copy: chunk 6/10 (335544320-402653184) size 64Mi finished\r\n2023/11/15 13:28:07 DEBUG : pero.scaff.fa.pac: multi-thread copy: chunk 9/10 (536870912-603979776) size 64Mi starting\r\n2023/11/15 13:28:08 DEBUG : pero.scaff.fa.pac: multi-thread copy: chunk 5/10 (268435456-335544320) size 64Mi finished\r\n2023/11/15 13:28:08 DEBUG : pero.scaff.fa.pac: multi-thread copy: chunk 10/10 (603979776-618791129) size 14.125Mi starting\r\n2023/11/15 13:28:08 DEBUG : pero.scaff.fa.pac.yinalon3.partial: writing chunk 8\r\n2023/11/15 13:28:08 DEBUG : pero.scaff.fa.pac: multi-thread copy: chunk 8/10 (469762048-536870912) size 64Mi finished\r\n2023/11/15 13:28:08 DEBUG : pero.scaff.fa.pac: multi-thread copy: chunk 7/10 (402653184-469762048) size 64Mi finished\r\n2023/11/15 13:28:08 DEBUG : pero.scaff.fa.pac.yinalon3.partial: writing chunk 9\r\n2023/11/15 13:28:09 DEBUG : pero.scaff.fa.pac: multi-thread copy: chunk 10/10 (603979776-618791129) size 14.125Mi finished\r\n2023/11/15 13:28:12 DEBUG : pero.scaff.fa.pac: multi-thread copy: chunk 9/10 (536870912-603979776) size 64Mi finished\r\n2023/11/15 13:28:12 DEBUG : pero.scaff.fa.pac: Finished multi-thread copy with 10 parts of size 64Mi\r\n2023/11/15 13:28:14 DEBUG : pero.scaff.fa.pac: md5 = b436224037c28753190c0628a7269eb0 OK\r\n2023/11/15 13:28:14 DEBUG : pero.scaff.fa.pac.yinalon3.partial: renamed to: pero.scaff.fa.pac\r\n2023/11/15 13:28:14 INFO  : pero.scaff.fa.pac: Multi-thread Copied (new)\r\n2023/11/15 13:28:14 INFO  : \r\nTransferred:   \t  590.125 MiB / 590.125 MiB, 100%, 39.337 MiB/s, ETA 0s\r\nTransferred:            1 / 1, 100%\r\nElapsed time:        15.8s\r\n\r\n2023/11/15 13:28:14 DEBUG : 11 go routines active\r\n```\r\n\r\n\r\n\r\n### Steps Reproduce\r\n1.  Upload a file to S3 that is larger than the --multi-thread-cutoff limit (make sure to include --metadata)\r\n2.  Check metadata on S3 to verify upload and metadata\r\n3.  Download the file back from s3 to a different location\r\n4. Verify that UID/GID is incorrect\r\n5. Erase local copy of downloaded data\r\n6. Re-download the file back from S3, but set --multi-thread-cutoff to a size larger than the file itself\r\n7.  Verify that UID/GID is correct\r\n\r\nDetails:\r\n1.  Upload file greater than limit of 256Mi\r\n```\r\nrclone --metadata --links --include pero.scaff.fa.pac copy /pub/ppapadop/testdir s3-backup:testing\r\n```\r\n2. Verify metadata in S3\r\n```\r\n# rclone  --metadata --links  lsf --format \"ptTM\" s3-backup:testing\r\npero.scaff.fa.pac;2019-04-05 12:37:55;STANDARD;{\"atime\":\"2023-06-09T11:34:03-07:00\",\"btime\":\"2023-11-15T16:34:30Z\",\"content-type\":\"application/octet-stream\",\"gid\":\"1698224\",\"mode\":\"100644\",\"mtime\":\"2019-04-05T12:37:55-07:00\",\"tier\":\"STANDARD\",\"uid\":\"1698224\"}\r\n```\r\n3. Download data to a temporary location\r\n```\r\n# rclone  --metadata --links  --include pero.scaff.fa.pac  copy s3-backup:testing /tmp/ppapadop\r\n```\r\n4. Verify UID/GID incorrect (owned by root, not by uid=1698224 as it should be)\r\n```\r\n# ls -l /tmp/ppapadop\r\ntotal 604292\r\n-rw-r--r-- 1 root root 618791129 Apr  5  2019 pero.scaff.fa.pac\r\n```\r\n5. erase local file\r\n```\r\n/bin/rm /tmp/ppapadop/pero.scaff.fa.pac\r\n```\r\n6.  Re-download data with --multi-thread-cutoff > size of file\r\n```\r\n# rclone --metadata --multi-thread-cutoff 1024Mi --include pero.scaff.fa.pac copy s3-backup:testing /tmp/ppapadop\r\n```\r\n7. Verify that UID/GID is now set correctly (owned by user/group 1698224 (ppapadop) \r\n```\r\n# ls -l /tmp/ppapadop\r\ntotal 604292\r\n-rw-r--r-- 1 ppapadop ppapadop 618791129 Apr  5  2019 pero.scaff.fa.pac\r\n # id -u ppapadop\r\n1698224\r\n```\r\n<!--- Please keep the note below for others who read your bug report. -->\r\n\r\n#### How to use GitHub\r\n\r\n* Please use the üëç [reaction](https://blog.github.com/2016-03-10-add-reactions-to-pull-requests-issues-and-comments/) to show that you are affected by the same issue.\r\n* Please don't comment if you have no relevant information to add. It's just extra noise for everyone subscribed to this issue.\r\n* Subscribe to receive notifications on status change and new comments.\r\n*\r\n\r\n\r\n\r\n","closed_by":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/7424/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rclone/rclone/issues/7424/timeline","performed_via_github_app":null,"state_reason":"completed"}