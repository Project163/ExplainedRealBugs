{"url":"https://api.github.com/repos/rclone/rclone/issues/4370","repository_url":"https://api.github.com/repos/rclone/rclone","labels_url":"https://api.github.com/repos/rclone/rclone/issues/4370/labels{/name}","comments_url":"https://api.github.com/repos/rclone/rclone/issues/4370/comments","events_url":"https://api.github.com/repos/rclone/rclone/issues/4370/events","html_url":"https://github.com/rclone/rclone/issues/4370","id":641417160,"node_id":"MDU6SXNzdWU2NDE0MTcxNjA=","number":4370,"title":"tardigrade integration tests failing - range requests not working properly","user":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":86399005,"node_id":"MDU6TGFiZWw4NjM5OTAwNQ==","url":"https://api.github.com/repos/rclone/rclone/labels/bug","name":"bug","color":"fc2929","default":true,"description":null},{"id":2146084235,"node_id":"MDU6TGFiZWwyMTQ2MDg0MjM1","url":"https://api.github.com/repos/rclone/rclone/labels/Remote:%20Storj","name":"Remote: Storj","color":"fbca04","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/rclone/rclone/milestones/40","html_url":"https://github.com/rclone/rclone/milestone/40","labels_url":"https://api.github.com/repos/rclone/rclone/milestones/40/labels","id":5062622,"node_id":"MDk6TWlsZXN0b25lNTA2MjYyMg==","number":40,"title":"v1.53","description":"","creator":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":43,"state":"closed","created_at":"2020-02-01T14:11:00Z","updated_at":"2020-09-05T13:46:47Z","due_on":"2020-08-31T07:00:00Z","closed_at":"2020-09-05T13:46:47Z"},"comments":3,"created_at":"2020-06-18T17:21:55Z","updated_at":"2020-06-20T15:44:32Z","closed_at":"2020-06-20T15:44:31Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"The integration tests for [tardigrade are failing](https://pub.rclone.org/integration-tests/2020-06-18-050025/index.html) like this\r\n\r\n![image](https://user-images.githubusercontent.com/536803/85050684-5ce1dd80-b18e-11ea-81cc-89b159467790.png)\r\n\r\nThe failures all look related and to do with Range requests failing.\r\n\r\nThe first one is easy to demonstrate\r\n\r\n```\r\n$ cd backend/tardigrade\r\n$ go test -v -run TestIntegration/FsMkdir/FsPutFiles/ObjectOpenRange\r\n=== RUN   TestIntegration\r\n    TestIntegration: fstests.go:356: Using remote \"TestTardigrade:\"\r\n=== RUN   TestIntegration/FsMkdir\r\n=== RUN   TestIntegration/FsMkdir/FsPutFiles\r\n=== RUN   TestIntegration/FsMkdir/FsPutFiles/ObjectOpenRange\r\n    TestIntegration/FsMkdir/FsPutFiles/ObjectOpenRange: fstests.go:238: \r\n        \tError Trace:\tfstests.go:238\r\n        \t            \t\t\t\tfstests.go:1284\r\n        \tError:      \tReceived unexpected error:\r\n        \t            \tranger error: buffer runoff\r\n        \t            \t\tstorj.io/common/ranger.ByteRanger.Range:39\r\n        \t            \t\tstorj.io/uplink/private/stream.(*Download).resetReader:111\r\n        \t            \t\tstorj.io/uplink/private/stream.(*Download).Read:62\r\n        \t            \t\tstorj.io/uplink.(*Download).Read:70\r\n        \t            \t\tbytes.(*Buffer).ReadFrom:204\r\n        \t            \t\tio/ioutil.readAll:36\r\n        \t            \t\tio/ioutil.ReadAll:45\r\n        \t            \t\tgithub.com/rclone/rclone/fstest/fstests.readObject:237\r\n        \t            \t\tgithub.com/rclone/rclone/fstest/fstests.Run.func13.13.30:1284\r\n        \t            \t\ttesting.tRunner:991\r\n        \tTest:       \tTestIntegration/FsMkdir/FsPutFiles/ObjectOpenRange\r\n        \tMessages:   \treadObject(\"file name.txt\") limit=-1, options=[RangeOption(81,100000)]\r\n2020/06/18 18:06:51 ERROR : FS sj://rclone-test-gohizob2padoboj8qadecun4: Failed to list \"\": directory not found\r\n2020/06/18 18:06:51 ERROR : : Failed to rmdir: directory not found\r\n--- FAIL: TestIntegration (2.58s)\r\n    --- FAIL: TestIntegration/FsMkdir (2.18s)\r\n        --- FAIL: TestIntegration/FsMkdir/FsPutFiles (1.47s)\r\n            --- FAIL: TestIntegration/FsMkdir/FsPutFiles/ObjectOpenRange (0.18s)\r\nFAIL\r\nexit status 1\r\nFAIL\tgithub.com/rclone/rclone/backend/tardigrade\t2.588s\r\n```\r\n\r\nThe ultimate cause here seems to be the `ranger error: buffer runoff` from the tardigrade libraries\r\n\r\nHere is the test in question\r\n\r\nhttps://github.com/rclone/rclone/blob/85bcacac905be0fb08696a5035dc1ce0dc89f377/fstest/fstests/fstests.go#L1274-L1288\r\n\r\nIt is this test which fails `{fs.RangeOption{Start: 81, End: 100000}, 81, 100}` so it looks like the backend needs to clip the range at the size of the file.\r\n\r\nHere is the code in question\r\n\r\nhttps://github.com/rclone/rclone/blob/85bcacac905be0fb08696a5035dc1ce0dc89f377/backend/tardigrade/object.go#L140-L158\r\n\r\nIt looks like we need to read the size of the object for the `s && e` case too.\r\n\r\n@calebcase I remember you didn't want to read the size of the object if you didn't have to. Do you think it is acceptable to read it here?\r\n\r\nThis will likely mean that all range requests read the size of the object, so maybe we should use the built in fs.FixRangeOption ?\r\n\r\nOr is this something best fixed in the tardigrade libraries?","closed_by":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/4370/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rclone/rclone/issues/4370/timeline","performed_via_github_app":null,"state_reason":"completed"}