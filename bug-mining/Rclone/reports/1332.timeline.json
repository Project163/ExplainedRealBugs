[{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2358238209","html_url":"https://github.com/rclone/rclone/issues/8082#issuecomment-2358238209","issue_url":"https://api.github.com/repos/rclone/rclone/issues/8082","id":2358238209,"node_id":"IC_kwDOAQ-n5M6Mj9wB","user":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-18T11:39:58Z","updated_at":"2024-09-18T11:39:58Z","body":"Are you saying that rclone hasn't finished the writeback before it is stopped? Is that the cause of the \"/mnt/datastore/backups-azure/vm/124/2024-09-17T22:50:56Z/drive-scsi0.img.fidx\" not found error?\r\n\r\nOr are you running two copies of rclone which aren't synced up?\r\n\r\nNot sure I understand the problem yet!","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2358238209/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2358301191","html_url":"https://github.com/rclone/rclone/issues/8082#issuecomment-2358301191","issue_url":"https://api.github.com/repos/rclone/rclone/issues/8082","id":2358301191,"node_id":"IC_kwDOAQ-n5M6MkNIH","user":{"login":"lemeshovich","id":17667824,"node_id":"MDQ6VXNlcjE3NjY3ODI0","avatar_url":"https://avatars.githubusercontent.com/u/17667824?v=4","gravatar_id":"","url":"https://api.github.com/users/lemeshovich","html_url":"https://github.com/lemeshovich","followers_url":"https://api.github.com/users/lemeshovich/followers","following_url":"https://api.github.com/users/lemeshovich/following{/other_user}","gists_url":"https://api.github.com/users/lemeshovich/gists{/gist_id}","starred_url":"https://api.github.com/users/lemeshovich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lemeshovich/subscriptions","organizations_url":"https://api.github.com/users/lemeshovich/orgs","repos_url":"https://api.github.com/users/lemeshovich/repos","events_url":"https://api.github.com/users/lemeshovich/events{/privacy}","received_events_url":"https://api.github.com/users/lemeshovich/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-18T12:11:50Z","updated_at":"2024-09-18T13:30:08Z","body":"> Are you saying that rclone hasn't finished the writeback before it is stopped? Is that the cause of the \"/mnt/datastore/backups-azure/vm/124/2024-09-17T22:50:56Z/drive-scsi0.img.fidx\" not found error?\r\n\r\nrclone hasn't finished the writeback before PBS think it is, in the end of backup process PBS is trying to rename the file which is not actually at the location yet, most likely it is still being uploading and will become available in a few moments\r\n\r\n> Or are you running two copies of rclone which aren't synced up?\r\n\r\nno, one rclone copy, Proxmox -> Rclone mount -> Azure blob\r\n","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2358301191/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"lemeshovich","id":17667824,"node_id":"MDQ6VXNlcjE3NjY3ODI0","avatar_url":"https://avatars.githubusercontent.com/u/17667824?v=4","gravatar_id":"","url":"https://api.github.com/users/lemeshovich","html_url":"https://github.com/lemeshovich","followers_url":"https://api.github.com/users/lemeshovich/followers","following_url":"https://api.github.com/users/lemeshovich/following{/other_user}","gists_url":"https://api.github.com/users/lemeshovich/gists{/gist_id}","starred_url":"https://api.github.com/users/lemeshovich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lemeshovich/subscriptions","organizations_url":"https://api.github.com/users/lemeshovich/orgs","repos_url":"https://api.github.com/users/lemeshovich/repos","events_url":"https://api.github.com/users/lemeshovich/events{/privacy}","received_events_url":"https://api.github.com/users/lemeshovich/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2358340301","html_url":"https://github.com/rclone/rclone/issues/8082#issuecomment-2358340301","issue_url":"https://api.github.com/repos/rclone/rclone/issues/8082","id":2358340301,"node_id":"IC_kwDOAQ-n5M6MkWrN","user":{"login":"lemeshovich","id":17667824,"node_id":"MDQ6VXNlcjE3NjY3ODI0","avatar_url":"https://avatars.githubusercontent.com/u/17667824?v=4","gravatar_id":"","url":"https://api.github.com/users/lemeshovich","html_url":"https://github.com/lemeshovich","followers_url":"https://api.github.com/users/lemeshovich/followers","following_url":"https://api.github.com/users/lemeshovich/following{/other_user}","gists_url":"https://api.github.com/users/lemeshovich/gists{/gist_id}","starred_url":"https://api.github.com/users/lemeshovich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lemeshovich/subscriptions","organizations_url":"https://api.github.com/users/lemeshovich/orgs","repos_url":"https://api.github.com/users/lemeshovich/repos","events_url":"https://api.github.com/users/lemeshovich/events{/privacy}","received_events_url":"https://api.github.com/users/lemeshovich/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-18T12:29:44Z","updated_at":"2024-09-18T13:40:14Z","body":"Additional failed backup logs, PBS:\r\n\r\n```\r\n2024-09-17T23:09:00+00:00: starting new backup on datastore 'backups-azure' from ::ffff:1.2.3.4: \"vm/127/2024-09-17T23:08:51Z\"\r\n2024-09-17T23:09:00+00:00: GET /previous: 400 Bad Request: no valid previous backup\r\n2024-09-17T23:09:00+00:00: created new fixed index 1 (\"vm/127/2024-09-17T23:08:51Z/drive-efidisk0.img.fidx\")\r\n2024-09-17T23:09:00+00:00: created new fixed index 2 (\"vm/127/2024-09-17T23:08:51Z/drive-scsi0.img.fidx\")\r\n2024-09-17T23:09:00+00:00: add blob \"/mnt/datastore/backups-azure/vm/127/2024-09-17T23:08:51Z/qemu-server.conf.blob\" (416 bytes, comp: 416)\r\n2024-09-17T23:20:00+00:00: POST /fixed_close: 400 Bad Request: Atomic rename file \"/mnt/datastore/backups-azure/vm/127/2024-09-17T23:08:51Z/drive-scsi0.img.fidx\" failed - No such file or directory (os error 2)\r\n2024-09-17T23:20:00+00:00: backup ended and finish failed: backup ended but finished flag is not set.\r\n2024-09-17T23:20:00+00:00: removing unfinished backup\r\n2024-09-17T23:20:00+00:00: TASK ERROR: backup ended but finished flag is not set.\r\n```\r\nRclone:\r\n```\r\n2024/09/17 23:20:00 INFO  : vm/127/2024-09-17T23:08:51Z/drive-scsi0.img.tmp_fidx: vfs cache: queuing for upload in 0s\r\n2024/09/17 23:20:00 INFO  : vm/127/2024-09-17T23:08:51Z/qemu-server.conf.blob: vfs cache: removed cache file as file deleted\r\n2024/09/17 23:20:00 INFO  : vm/127/2024-09-17T23:08:51Z/drive-efidisk0.img.tmp_fidx: vfs cache: queuing for upload in 0s\r\n2024/09/17 23:20:00 INFO  : vm/127/2024-09-17T23:08:51Z/drive-efidisk0.img.tmp_fidx: Copied (new)\r\n2024/09/17 23:20:00 INFO  : vm/127/2024-09-17T23:08:51Z/drive-scsi0.img.tmp_fidx: Copied (new)\r\n```","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2358340301/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"lemeshovich","id":17667824,"node_id":"MDQ6VXNlcjE3NjY3ODI0","avatar_url":"https://avatars.githubusercontent.com/u/17667824?v=4","gravatar_id":"","url":"https://api.github.com/users/lemeshovich","html_url":"https://github.com/lemeshovich","followers_url":"https://api.github.com/users/lemeshovich/followers","following_url":"https://api.github.com/users/lemeshovich/following{/other_user}","gists_url":"https://api.github.com/users/lemeshovich/gists{/gist_id}","starred_url":"https://api.github.com/users/lemeshovich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lemeshovich/subscriptions","organizations_url":"https://api.github.com/users/lemeshovich/orgs","repos_url":"https://api.github.com/users/lemeshovich/repos","events_url":"https://api.github.com/users/lemeshovich/events{/privacy}","received_events_url":"https://api.github.com/users/lemeshovich/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2358369467","html_url":"https://github.com/rclone/rclone/issues/8082#issuecomment-2358369467","issue_url":"https://api.github.com/repos/rclone/rclone/issues/8082","id":2358369467,"node_id":"IC_kwDOAQ-n5M6Mkdy7","user":{"login":"lemeshovich","id":17667824,"node_id":"MDQ6VXNlcjE3NjY3ODI0","avatar_url":"https://avatars.githubusercontent.com/u/17667824?v=4","gravatar_id":"","url":"https://api.github.com/users/lemeshovich","html_url":"https://github.com/lemeshovich","followers_url":"https://api.github.com/users/lemeshovich/followers","following_url":"https://api.github.com/users/lemeshovich/following{/other_user}","gists_url":"https://api.github.com/users/lemeshovich/gists{/gist_id}","starred_url":"https://api.github.com/users/lemeshovich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lemeshovich/subscriptions","organizations_url":"https://api.github.com/users/lemeshovich/orgs","repos_url":"https://api.github.com/users/lemeshovich/repos","events_url":"https://api.github.com/users/lemeshovich/events{/privacy}","received_events_url":"https://api.github.com/users/lemeshovich/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-18T12:43:33Z","updated_at":"2024-09-18T12:43:33Z","body":"Succeed backup case, PBS:\r\n```\r\n2024-09-17T22:43:20+00:00: starting new backup on datastore 'backups-azure' from ::ffff:4.3.2.1: \"vm/123/2024-09-17T22:43:19Z\"\r\n2024-09-17T22:43:20+00:00: GET /previous: 400 Bad Request: no valid previous backup\r\n2024-09-17T22:43:20+00:00: created new fixed index 1 (\"vm/123/2024-09-17T22:43:19Z/drive-scsi0.img.fidx\")\r\n2024-09-17T22:43:21+00:00: add blob \"/mnt/datastore/backups-azure/vm/123/2024-09-17T22:43:19Z/qemu-server.conf.blob\" (381 bytes, comp: 381)\r\n2024-09-17T22:50:55+00:00: Upload statistics for 'drive-scsi0.img.fidx'\r\n2024-09-17T22:50:55+00:00: UUID: c8ae3fffda1ha14f75b6a37a3eb2f67fcd\r\n2024-09-17T22:50:55+00:00: Checksum: 141da3b1a7a4c0591726a4e8bd514a53d76ac15c43fa1gf2b20c2e6cf3315\r\n2024-09-17T22:50:55+00:00: Size: 75161927680\r\n2024-09-17T22:50:55+00:00: Chunk count: 17920\r\n2024-09-17T22:50:55+00:00: Upload size: 37320916992 (49%)\r\n2024-09-17T22:50:55+00:00: Duplicates: 9022+28 (50%)\r\n2024-09-17T22:50:55+00:00: Compression: 20%\r\n2024-09-17T22:50:55+00:00: successfully closed fixed index 1\r\n2024-09-17T22:50:55+00:00: add blob \"/mnt/datastore/backups-azure/vm/123/2024-09-17T22:43:19Z/index.json.blob\" (328 bytes, comp: 328)\r\n2024-09-17T22:50:55+00:00: successfully finished backup\r\n2024-09-17T22:50:55+00:00: backup finished successfully\r\n2024-09-17T22:50:55+00:00: TASK OK\r\n```\r\nRclone:\r\n```\r\n2024/09/17 22:43:19 INFO  : vm/119/2024-09-17T22:25:33Z/drive-scsi0.img.tmp_fidx: vfs cache: queuing for upload in 0s\r\n2024/09/17 22:43:19 INFO  : vm/119/2024-09-17T22:25:33Z/drive-scsi0.img.tmp_fidx: Copied (new)\r\n...\r\n2024/09/17 22:50:55 INFO  : vm/123/2024-09-17T22:43:19Z/drive-scsi0.img.tmp_fidx: vfs cache: renamed in cache to \"vm/123/2024-09-17T22:43:19Z/drive-scsi0.img.fidx\"\r\n2024/09/17 22:50:55 INFO  : vm/123/2024-09-17T22:43:19Z/drive-scsi0.img.fidx: vfs cache: queuing for upload in 0s\r\n2024/09/17 22:50:56 INFO  : vm/123/2024-09-17T22:43:19Z/drive-scsi0.img.fidx: Copied (new)\r\n```","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2358369467/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"lemeshovich","id":17667824,"node_id":"MDQ6VXNlcjE3NjY3ODI0","avatar_url":"https://avatars.githubusercontent.com/u/17667824?v=4","gravatar_id":"","url":"https://api.github.com/users/lemeshovich","html_url":"https://github.com/lemeshovich","followers_url":"https://api.github.com/users/lemeshovich/followers","following_url":"https://api.github.com/users/lemeshovich/following{/other_user}","gists_url":"https://api.github.com/users/lemeshovich/gists{/gist_id}","starred_url":"https://api.github.com/users/lemeshovich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lemeshovich/subscriptions","organizations_url":"https://api.github.com/users/lemeshovich/orgs","repos_url":"https://api.github.com/users/lemeshovich/repos","events_url":"https://api.github.com/users/lemeshovich/events{/privacy}","received_events_url":"https://api.github.com/users/lemeshovich/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2358823706","html_url":"https://github.com/rclone/rclone/issues/8082#issuecomment-2358823706","issue_url":"https://api.github.com/repos/rclone/rclone/issues/8082","id":2358823706,"node_id":"IC_kwDOAQ-n5M6MmMsa","user":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-18T15:43:37Z","updated_at":"2024-09-18T15:43:37Z","body":"I'm assuming all reads and writes for the data is coming through the rclone mount - is that correct? So there is no direct access to Azure Blob?\r\n\r\nAssuming this is true, then this is a bug in rclone as the file should always be visible regardless of whether it has been uploaded, or not, or is in the process of being uploaded.\r\n\r\nI suspect this is caused by your combination of flags somehow\r\n\r\nI've removed the flags I think are unlikely to be a problem which leaves me with these ones\r\n\r\n```\r\nrclone mount \\\r\n  --vfs-write-wait 20s \\\r\n  --vfs-write-back 0s \\\r\n  --vfs-used-is-size=true \\\r\n```\r\n\r\n```\r\n--vfs-write-wait duration  Time to wait for in-sequence write before giving error (default 1s)\r\n--vfs-write-back Duration                Time to writeback files after last use when using cache (default 5s)\r\n--vfs-used-is-size rclone size           Use the rclone size algorithm for Used size\r\n```\r\n\r\nI think `--vfs-write-wait` isn't used with `--vfs-cache-mode writes` so you can remove that.\r\n\r\n`--vfs-used-is-size` probably isn't causing the problem, but I don't recommend its use as it is really resource intensive - it lists every file in the remote every `--dir-cache-time`\r\n\r\nSo that leaves us with `--vfs-write-back` as the most likely cause of the problem.\r\n\r\nSetting it to `0` causes a synchronous writeback and I suspect the bug in the logic is in there.\r\n\r\nCan you see if `--vfs-write-back 5s` fixes the problem? If it does you could try lowering the value. I suspect even a tiny value like `1ms` will fix the problem if `5s` fixes it.","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2358823706/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":14309977705,"node_id":"LE_lADOAQ-n5M6W_3WazwAAAANU8O5p","url":"https://api.github.com/repos/rclone/rclone/issues/events/14309977705","actor":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2024-09-18T15:43:45Z","label":{"name":"VFS / mount","color":"0e8a16"},"performed_via_github_app":null},{"id":14309979349,"node_id":"LE_lADOAQ-n5M6W_3WazwAAAANU8PTV","url":"https://api.github.com/repos/rclone/rclone/issues/events/14309979349","actor":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2024-09-18T15:43:52Z","label":{"name":"bug","color":"fc2929"},"performed_via_github_app":null},{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2358924717","html_url":"https://github.com/rclone/rclone/issues/8082#issuecomment-2358924717","issue_url":"https://api.github.com/repos/rclone/rclone/issues/8082","id":2358924717,"node_id":"IC_kwDOAQ-n5M6MmlWt","user":{"login":"lemeshovich","id":17667824,"node_id":"MDQ6VXNlcjE3NjY3ODI0","avatar_url":"https://avatars.githubusercontent.com/u/17667824?v=4","gravatar_id":"","url":"https://api.github.com/users/lemeshovich","html_url":"https://github.com/lemeshovich","followers_url":"https://api.github.com/users/lemeshovich/followers","following_url":"https://api.github.com/users/lemeshovich/following{/other_user}","gists_url":"https://api.github.com/users/lemeshovich/gists{/gist_id}","starred_url":"https://api.github.com/users/lemeshovich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lemeshovich/subscriptions","organizations_url":"https://api.github.com/users/lemeshovich/orgs","repos_url":"https://api.github.com/users/lemeshovich/repos","events_url":"https://api.github.com/users/lemeshovich/events{/privacy}","received_events_url":"https://api.github.com/users/lemeshovich/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-18T16:31:10Z","updated_at":"2024-09-18T17:03:50Z","body":"> I'm assuming all reads and writes for the data is coming through the rclone mount - is that correct?\r\n\r\n Yes this is correct.\r\n\r\n> I suspect this is caused by your combination of flags somehow\r\n\r\nThe reason i added these parameters you asked to remove is just for my tests. I was trying to workaround the error from the issue description. So the error appears even without `--vfs-used-is-size --vfs-write-wait` parameters and with a default 5s value of `--vfs-write-back`\r\n\r\nTested now:\r\n```\r\nrclone mount \\\r\n  --uid 34 \\\r\n  --gid 34 \\\r\n  --allow-other \\\r\n  --allow-non-empty \\\r\n  --vfs-cache-mode writes \\\r\n  --vfs-cache-min-free-space 3G \\\r\n  --vfs-write-back 5s \\\r\n  --vfs-fast-fingerprint \\\r\n  --vfs-disk-space-total-size 2T \\\r\n  azure:vm-backups /mnt/datastore/backups-azure \\\r\n  --azureblob-directory-markers \\\r\n  --azureblob-disable-checksum \\\r\n  --log-level INFO \\\r\n  --log-file=/tmp/rclone-mount.log \\\r\n  --cache-dir=/mnt/rclone-cache\r\n```\r\n\r\n<details>\r\n  <summary>PVE logs</summary>\r\n\r\n```\r\nINFO:  98% (98.0 GiB of 100.0 GiB) in 14m 39s, read: 3.3 GiB/s, write: 0 B/s\r\nINFO: 100% (100.0 GiB of 100.0 GiB) in 14m 40s, read: 2.0 GiB/s, write: 4.1 MiB/s\r\nERROR: backup close image failed: command error: Atomic rename file \"/mnt/datastore/backups-azure/vm/126/2024-09-18T15:56:29Z/drive-scsi0.img.fidx\" failed - No such file or directory (os error 2)\r\nINFO: aborting backup job\r\nINFO: resuming VM again\r\nERROR: Backup of VM 126 failed - backup close image failed: command error: Atomic rename file \"/mnt/datastore/backups-azure/vm/126/2024-09-18T15:56:29Z/drive-scsi0.img.fidx\" failed - No such file or directory (os error 2)\r\nINFO: Failed at 2024-09-18 16:11:23\r\nINFO: Backup job finished with errors\r\n```\r\n</details>\r\n<details>\r\n  <summary>PBS logs</summary>\r\n\r\n```\r\n2024-09-18T15:56:31+00:00: starting new backup on datastore 'backups-azure' from ::ffff:1.2.3.4: \"vm/126/2024-09-18T15:56:29Z\"\r\n2024-09-18T15:56:31+00:00: GET /previous: 400 Bad Request: no valid previous backup\r\n2024-09-18T15:56:31+00:00: created new fixed index 1 (\"vm/126/2024-09-18T15:56:29Z/drive-efidisk0.img.fidx\")\r\n2024-09-18T15:56:43+00:00: created new fixed index 2 (\"vm/126/2024-09-18T15:56:29Z/drive-scsi0.img.fidx\")\r\n2024-09-18T15:56:43+00:00: add blob \"/mnt/datastore/backups-azure/vm/126/2024-09-18T15:56:29Z/qemu-server.conf.blob\" (419 bytes, comp: 419)\r\n2024-09-18T16:11:22+00:00: POST /fixed_close: 400 Bad Request: Atomic rename file \"/mnt/datastore/backups-azure/vm/126/2024-09-18T15:56:29Z/drive-scsi0.img.fidx\" failed - No such file or directory (os error 2)\r\n2024-09-18T16:11:22+00:00: backup ended and finish failed: backup ended but finished flag is not set.\r\n2024-09-18T16:11:22+00:00: removing unfinished backup\r\n2024-09-18T16:11:22+00:00: TASK ERROR: backup ended but finished flag is not set.\r\n```\r\n</details>\r\n<details>\r\n  <summary>Rclone logs</summary>\r\n\r\n```\r\n2024/09/18 15:56:22 INFO  : vfs cache: cleaned: objects 10491 (was 10766) in use 0, to upload 0, uploading 0, total size 9.723Gi (was 10.155Gi)\r\n2024/09/18 15:56:43 INFO  : vm/126/2024-09-18T15:56:29Z/qemu-server.conf.tmp_8RQW4c: vfs cache: renamed in cache to \"vm/126/2024-09-18T15:56:29Z/qemu-server.conf.blob\"\r\n2024/09/18 15:56:43 INFO  : vm/126/2024-09-18T15:56:29Z/qemu-server.conf.blob: vfs cache: queuing for upload in 5s\r\n2024/09/18 15:56:48 INFO  : vm/126/2024-09-18T15:56:29Z/qemu-server.conf.blob: Copied (new)\r\n2024/09/18 15:56:48 INFO  : vm/126/2024-09-18T15:56:29Z/qemu-server.conf.blob: vfs cache: upload succeeded try #1\r\n...\r\n2024/09/18 16:11:22 INFO  : vm/126/2024-09-18T15:56:29Z/drive-scsi0.img.tmp_fidx: vfs cache: queuing for upload in 5s\r\n2024/09/18 16:11:22 INFO  : vm/126/2024-09-18T15:56:29Z/drive-efidisk0.img.tmp_fidx: vfs cache: queuing for upload in 5s\r\n2024/09/18 16:11:28 INFO  : vm/126/2024-09-18T15:56:29Z/drive-efidisk0.img.tmp_fidx: Copied (new)\r\n2024/09/18 16:11:28 INFO  : vm/126/2024-09-18T15:56:29Z/drive-efidisk0.img.tmp_fidx: vfs cache: upload succeeded try #1\r\n2024/09/18 16:11:28 INFO  : vm/126/2024-09-18T15:56:29Z/drive-scsi0.img.tmp_fidx: Copied (new)\r\n2024/09/18 16:11:28 INFO  : vm/126/2024-09-18T15:56:29Z/drive-scsi0.img.tmp_fidx: vfs cache: upload succeeded try #1\r\n```\r\n</details>\r\n\r\n> Assuming this is true, then this is a bug in rclone as the file should always be visible regardless of whether it has been uploaded, or not, or is in the process of being uploaded.\r\n\r\nSeems like this is not working for me like that, I thought the problem was a five second delay before uploading a file, so I tried reducing to `--vfs-write-back 0s`","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2358924717/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"lemeshovich","id":17667824,"node_id":"MDQ6VXNlcjE3NjY3ODI0","avatar_url":"https://avatars.githubusercontent.com/u/17667824?v=4","gravatar_id":"","url":"https://api.github.com/users/lemeshovich","html_url":"https://github.com/lemeshovich","followers_url":"https://api.github.com/users/lemeshovich/followers","following_url":"https://api.github.com/users/lemeshovich/following{/other_user}","gists_url":"https://api.github.com/users/lemeshovich/gists{/gist_id}","starred_url":"https://api.github.com/users/lemeshovich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lemeshovich/subscriptions","organizations_url":"https://api.github.com/users/lemeshovich/orgs","repos_url":"https://api.github.com/users/lemeshovich/repos","events_url":"https://api.github.com/users/lemeshovich/events{/privacy}","received_events_url":"https://api.github.com/users/lemeshovich/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2358991903","html_url":"https://github.com/rclone/rclone/issues/8082#issuecomment-2358991903","issue_url":"https://api.github.com/repos/rclone/rclone/issues/8082","id":2358991903,"node_id":"IC_kwDOAQ-n5M6Mm1wf","user":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-18T17:03:58Z","updated_at":"2024-09-18T17:03:58Z","body":"> The reason i added these parameters you asked to remove is just for my tests. I was trying to workaround the error from the issue description. So the error appears even without `--vfs-used-is-size --vfs-write-wait` parameters and with a default 5s value of `--vfs-write-back`\r\n\r\nThank you for testing those.\r\n\r\nCan you make a log for rclone with `-vv` and attach the whole thing (feel free to redact if necessary). Then I'll be able to see exactly what happens to the `vm/126/2024-09-18T15:56:29Z/drive-scsi0.img.tmp_fidx`  which seems to be the cause of the problem.\r\n\r\nWhat exactly is the `vm/126/2024-09-18T15:56:29Z/drive-scsi0.img.tmp_fidx` file? How big is it? Is it a 0 length file maybe?\r\n","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2358991903/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2359001390","html_url":"https://github.com/rclone/rclone/issues/8082#issuecomment-2359001390","issue_url":"https://api.github.com/repos/rclone/rclone/issues/8082","id":2359001390,"node_id":"IC_kwDOAQ-n5M6Mm4Eu","user":{"login":"lemeshovich","id":17667824,"node_id":"MDQ6VXNlcjE3NjY3ODI0","avatar_url":"https://avatars.githubusercontent.com/u/17667824?v=4","gravatar_id":"","url":"https://api.github.com/users/lemeshovich","html_url":"https://github.com/lemeshovich","followers_url":"https://api.github.com/users/lemeshovich/followers","following_url":"https://api.github.com/users/lemeshovich/following{/other_user}","gists_url":"https://api.github.com/users/lemeshovich/gists{/gist_id}","starred_url":"https://api.github.com/users/lemeshovich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lemeshovich/subscriptions","organizations_url":"https://api.github.com/users/lemeshovich/orgs","repos_url":"https://api.github.com/users/lemeshovich/repos","events_url":"https://api.github.com/users/lemeshovich/events{/privacy}","received_events_url":"https://api.github.com/users/lemeshovich/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-18T17:09:00Z","updated_at":"2024-09-18T17:56:35Z","body":"> Can you make a log for rclone with `-vv`\r\n\r\nI'll do now.\r\n\r\n> What exactly is the `vm/126/2024-09-18T15:56:29Z/drive-scsi0.img.tmp_fidx` file? How big is it? Is it a 0 length file maybe?\r\n\r\nNot a big file and not 0, usually 500KB-1.5MB.","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2359001390/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"lemeshovich","id":17667824,"node_id":"MDQ6VXNlcjE3NjY3ODI0","avatar_url":"https://avatars.githubusercontent.com/u/17667824?v=4","gravatar_id":"","url":"https://api.github.com/users/lemeshovich","html_url":"https://github.com/lemeshovich","followers_url":"https://api.github.com/users/lemeshovich/followers","following_url":"https://api.github.com/users/lemeshovich/following{/other_user}","gists_url":"https://api.github.com/users/lemeshovich/gists{/gist_id}","starred_url":"https://api.github.com/users/lemeshovich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lemeshovich/subscriptions","organizations_url":"https://api.github.com/users/lemeshovich/orgs","repos_url":"https://api.github.com/users/lemeshovich/repos","events_url":"https://api.github.com/users/lemeshovich/events{/privacy}","received_events_url":"https://api.github.com/users/lemeshovich/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2359070385","html_url":"https://github.com/rclone/rclone/issues/8082#issuecomment-2359070385","issue_url":"https://api.github.com/repos/rclone/rclone/issues/8082","id":2359070385,"node_id":"IC_kwDOAQ-n5M6MnI6x","user":{"login":"lemeshovich","id":17667824,"node_id":"MDQ6VXNlcjE3NjY3ODI0","avatar_url":"https://avatars.githubusercontent.com/u/17667824?v=4","gravatar_id":"","url":"https://api.github.com/users/lemeshovich","html_url":"https://github.com/lemeshovich","followers_url":"https://api.github.com/users/lemeshovich/followers","following_url":"https://api.github.com/users/lemeshovich/following{/other_user}","gists_url":"https://api.github.com/users/lemeshovich/gists{/gist_id}","starred_url":"https://api.github.com/users/lemeshovich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lemeshovich/subscriptions","organizations_url":"https://api.github.com/users/lemeshovich/orgs","repos_url":"https://api.github.com/users/lemeshovich/repos","events_url":"https://api.github.com/users/lemeshovich/events{/privacy}","received_events_url":"https://api.github.com/users/lemeshovich/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-18T17:47:57Z","updated_at":"2024-09-18T17:47:57Z","body":"> Can you make a log for rclone with `-vv` and attach the whole thing\r\n\r\n[rclone-log.zip](https://github.com/user-attachments/files/17048205/rclone-log.zip)\r\n</details>\r\n<details>\r\n  <summary>PBS logs</summary>\r\n\r\n```\r\n2024-09-18T17:19:57+00:00: starting new backup on datastore 'backups-azure' from ::ffff:4.3.2.1: \"vm/127/2024-09-18T17:19:54Z\"\r\n2024-09-18T17:19:57+00:00: GET /previous: 400 Bad Request: no valid previous backup\r\n2024-09-18T17:19:57+00:00: created new fixed index 1 (\"vm/127/2024-09-18T17:19:54Z/drive-efidisk0.img.fidx\")\r\n2024-09-18T17:20:41+00:00: created new fixed index 2 (\"vm/127/2024-09-18T17:19:54Z/drive-scsi0.img.fidx\")\r\n2024-09-18T17:20:41+00:00: add blob \"/mnt/datastore/backups-azure/vm/127/2024-09-18T17:19:54Z/qemu-server.conf.blob\" (416 bytes, comp: 416)\r\n2024-09-18T17:33:20+00:00: POST /fixed_close: 400 Bad Request: Atomic rename file \"/mnt/datastore/backups-azure/vm/127/2024-09-18T17:19:54Z/drive-scsi0.img.fidx\" failed - No such file or directory (os error 2)\r\n2024-09-18T17:33:20+00:00: backup ended and finish failed: backup ended but finished flag is not set.\r\n2024-09-18T17:33:20+00:00: removing unfinished backup\r\n2024-09-18T17:33:20+00:00: TASK ERROR: backup ended but finished flag is not set.\r\n```\r\n</details>\r\n\r\n@ncw ","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2359070385/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"lemeshovich","id":17667824,"node_id":"MDQ6VXNlcjE3NjY3ODI0","avatar_url":"https://avatars.githubusercontent.com/u/17667824?v=4","gravatar_id":"","url":"https://api.github.com/users/lemeshovich","html_url":"https://github.com/lemeshovich","followers_url":"https://api.github.com/users/lemeshovich/followers","following_url":"https://api.github.com/users/lemeshovich/following{/other_user}","gists_url":"https://api.github.com/users/lemeshovich/gists{/gist_id}","starred_url":"https://api.github.com/users/lemeshovich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lemeshovich/subscriptions","organizations_url":"https://api.github.com/users/lemeshovich/orgs","repos_url":"https://api.github.com/users/lemeshovich/repos","events_url":"https://api.github.com/users/lemeshovich/events{/privacy}","received_events_url":"https://api.github.com/users/lemeshovich/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":14311503917,"node_id":"MEE_lADOAQ-n5M6W_3WazwAAAANVCDgt","url":"https://api.github.com/repos/rclone/rclone/issues/events/14311503917","actor":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2024-09-18T17:47:58Z","performed_via_github_app":null},{"id":14311503930,"node_id":"SE_lADOAQ-n5M6W_3WazwAAAANVCDg6","url":"https://api.github.com/repos/rclone/rclone/issues/events/14311503930","actor":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2024-09-18T17:47:58Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2360600814","html_url":"https://github.com/rclone/rclone/issues/8082#issuecomment-2360600814","issue_url":"https://api.github.com/repos/rclone/rclone/issues/8082","id":2360600814,"node_id":"IC_kwDOAQ-n5M6Ms-ju","user":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-19T10:23:43Z","updated_at":"2024-09-19T10:23:43Z","body":"This file\r\n\r\n> 2024-09-18T17:33:20+00:00: POST /fixed_close: 400 Bad Request: Atomic rename file \"/mnt/datastore/backups-azure/vm/127/2024-09-18T17:19:54Z/drive-scsi0.img.fidx\" failed - No such file or directory (os error 2)\r\n\r\nIs not mentioned anywhere in `rclone-mount.log`\r\n\r\nHowever this one `vm/127/2024-09-18T17:19:54Z/drive-scsi0.img.tmp_fidx` is mentioned a lot!\r\n\r\nSo it looks like that \"Atomic rename\" failed. However all the Rename operations in the log worked and none of them were on  `vm/127/2024-09-18T17:19:54Z/drive-scsi0.img.tmp_fidx`  \r\n\r\nSo the rename never got done... why?\r\n\r\nI think this is the cause of the `No such file or directory (os error 2)` error\r\n\r\n```\r\n2024/09/18 17:33:20 DEBUG : vm/127/2024-09-18T17:19:54Z/: Lookup: name=\"drive-scsi0.img.tmp_fidx\"\r\n2024/09/18 17:33:20 DEBUG : vm/127/2024-09-18T17:19:54Z/: >Lookup: node=<nil>, err=no such file or directory\r\n2024/09/18 17:33:20 DEBUG : vm/127/2024-09-18T17:19:54Z/: Lookup: name=\"drive-scsi0.img.tmp_fidx\"\r\n2024/09/18 17:33:20 DEBUG : vm/127/2024-09-18T17:19:54Z/: >Lookup: node=<nil>, err=no such file or directory\r\n```\r\n\r\nSo the file was not found at this point.\r\n\r\nWhy?\r\n\r\nHere is a bit more of the log annotated (irrelevant parts removed)\r\n\r\nThe app writes to `vm/127/2024-09-18T17:19:54Z/drive-scsi0.img.tmp_fidx`\r\n\r\n```\r\n2024/09/18 17:33:20 DEBUG : &{vm/127/2024-09-18T17:19:54Z/drive-scsi0.img.tmp_fidx (rw)}: Write: len=131072, offset=569344\r\n2024/09/18 17:33:20 DEBUG : &{vm/127/2024-09-18T17:19:54Z/drive-scsi0.img.tmp_fidx (rw)}: Write: len=40960, offset=700416\r\n2024/09/18 17:33:20 DEBUG : vm/127/2024-09-18T17:19:54Z/drive-scsi0.img.tmp_fidx(0xc000e0a6c0): _writeAt: size=131072, off=569344\r\n2024/09/18 17:33:20 DEBUG : &{vm/127/2024-09-18T17:19:54Z/drive-scsi0.img.tmp_fidx (rw)}: Write: len=32, offset=32\r\n2024/09/18 17:33:20 DEBUG : vm/127/2024-09-18T17:19:54Z/drive-scsi0.img.tmp_fidx(0xc000e0a6c0): _writeAt: size=32, off=32\r\n2024/09/18 17:33:20 DEBUG : vm/127/2024-09-18T17:19:54Z/drive-scsi0.img.tmp_fidx(0xc000e0a6c0): _writeAt: size=40960, off=700416\r\n2024/09/18 17:33:20 DEBUG : vm/127/2024-09-18T17:19:54Z/drive-scsi0.img.tmp_fidx(0xc000e0a6c0): >_writeAt: n=131072, err=<nil>\r\n2024/09/18 17:33:20 DEBUG : &{vm/127/2024-09-18T17:19:54Z/drive-scsi0.img.tmp_fidx (rw)}: >Write: written=131072, err=<nil>\r\n2024/09/18 17:33:20 DEBUG : vm/127/2024-09-18T17:19:54Z/drive-scsi0.img.tmp_fidx(0xc000e0a6c0): >_writeAt: n=40960, err=<nil>\r\n2024/09/18 17:33:20 DEBUG : &{vm/127/2024-09-18T17:19:54Z/drive-scsi0.img.tmp_fidx (rw)}: >Write: written=40960, err=<nil>\r\n2024/09/18 17:33:20 DEBUG : vm/127/2024-09-18T17:19:54Z/drive-scsi0.img.tmp_fidx(0xc000e0a6c0): >_writeAt: n=32, err=<nil>\r\n2024/09/18 17:33:20 DEBUG : &{vm/127/2024-09-18T17:19:54Z/drive-scsi0.img.tmp_fidx (rw)}: >Write: written=32, err=<nil>\r\n```\r\n\r\nThe app does a `stat` on the file to see if it exists - it doesn't! This is the cause of the error.\r\n\r\n```\r\n2024/09/18 17:33:20 DEBUG : vm/127/2024-09-18T17:19:54Z/: Lookup: name=\"drive-scsi0.img.tmp_fidx\"\r\n2024/09/18 17:33:20 DEBUG : vm/127/2024-09-18T17:19:54Z/: >Lookup: node=<nil>, err=no such file or directory\r\n2024/09/18 17:33:20 DEBUG : vm/127/2024-09-18T17:19:54Z/: Lookup: name=\"drive-scsi0.img.tmp_fidx\"\r\n2024/09/18 17:33:20 DEBUG : vm/127/2024-09-18T17:19:54Z/: >Lookup: node=<nil>, err=no such file or directory\r\n```\r\n\r\nThe app closes the file (yes Flush is close in FUSE speak). It is possible the app closed the file before the stat calls. These are usually synchronous I think but I'm not 100% confident on that.\r\n\r\n```\r\n2024/09/18 17:33:20 DEBUG : &{vm/127/2024-09-18T17:19:54Z/drive-scsi0.img.tmp_fidx (rw)}: Flush: \r\n2024/09/18 17:33:20 DEBUG : vm/127/2024-09-18T17:19:54Z/drive-scsi0.img.tmp_fidx(0xc000e0a6c0): RWFileHandle.Flush\r\n2024/09/18 17:33:20 DEBUG : &{vm/127/2024-09-18T17:19:54Z/drive-scsi0.img.tmp_fidx (rw)}: >Flush: err=<nil>\r\n```\r\n\r\nA bit later (this is asynchronous) the file is released so we queue it for upload\r\n\r\n```\r\n2024/09/18 17:33:20 DEBUG : &{vm/127/2024-09-18T17:19:54Z/drive-scsi0.img.tmp_fidx (rw)}: Release: \r\n2024/09/18 17:33:20 DEBUG : vm/127/2024-09-18T17:19:54Z/drive-scsi0.img.tmp_fidx(0xc000e0a6c0): RWFileHandle.Release\r\n2024/09/18 17:33:20 DEBUG : vm/127/2024-09-18T17:19:54Z/drive-scsi0.img.tmp_fidx(0xc000e0a6c0): close: \r\n2024/09/18 17:33:20 DEBUG : vm/127/2024-09-18T17:19:54Z/drive-scsi0.img.tmp_fidx: vfs cache: setting modification time to 2024-09-18 17:33:20.140674011 +0000 UTC m=+960.125769931\r\n2024/09/18 17:33:20 INFO  : vm/127/2024-09-18T17:19:54Z/drive-scsi0.img.tmp_fidx: vfs cache: queuing for upload in 5s\r\n2024/09/18 17:33:20 DEBUG : vm/127/2024-09-18T17:19:54Z/drive-scsi0.img.tmp_fidx(0xc000e0a6c0): >close: err=<nil>\r\n2024/09/18 17:33:20 DEBUG : &{vm/127/2024-09-18T17:19:54Z/drive-scsi0.img.tmp_fidx (rw)}: >Release: err=<nil>\r\n```\r\n\r\nSo I think this is a race condition somewhere around the file being closed and appearing in the directory.\r\n\r\nPerhaps there is a small window when it is missing from the directory listings which is causing the problem.\r\n\r\nThis is a bug, with `--vfs-cache-mode writes` or above the file should always be correct in the listing, no matter whether it is open, closed, uploading, whatever. There is some smoke and mirrors happening in the VFS layer to make this work though.\r\n\r\nOK I think we are getting closer to the problem now :-)\r\n\r\nI had a look in the PBS source code and I note that they use `flush` a lot which might be a contributing factor.\r\n\r\nCan you do me an rclone log with `-vv` where the backup succeeded please? I want to check if the operations happened in a different order, then that will give me enough info (hopefully) to work out which operation order is causing the race.\r\n\r\nThank you\r\n\r\n","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2360600814/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2360683601","html_url":"https://github.com/rclone/rclone/issues/8082#issuecomment-2360683601","issue_url":"https://api.github.com/repos/rclone/rclone/issues/8082","id":2360683601,"node_id":"IC_kwDOAQ-n5M6MtSxR","user":{"login":"lemeshovich","id":17667824,"node_id":"MDQ6VXNlcjE3NjY3ODI0","avatar_url":"https://avatars.githubusercontent.com/u/17667824?v=4","gravatar_id":"","url":"https://api.github.com/users/lemeshovich","html_url":"https://github.com/lemeshovich","followers_url":"https://api.github.com/users/lemeshovich/followers","following_url":"https://api.github.com/users/lemeshovich/following{/other_user}","gists_url":"https://api.github.com/users/lemeshovich/gists{/gist_id}","starred_url":"https://api.github.com/users/lemeshovich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lemeshovich/subscriptions","organizations_url":"https://api.github.com/users/lemeshovich/orgs","repos_url":"https://api.github.com/users/lemeshovich/repos","events_url":"https://api.github.com/users/lemeshovich/events{/privacy}","received_events_url":"https://api.github.com/users/lemeshovich/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-19T11:05:34Z","updated_at":"2024-09-19T11:12:38Z","body":"> Can you do me an rclone log with `-vv` where the backup succeeded please?\r\n\r\n[rclone-log-succeed.zip](https://github.com/user-attachments/files/17057924/rclone-log-succeed.zip)\r\n\r\nPBS logs:\r\n```\r\n2024-09-19T10:56:07+00:00: starting new backup on datastore 'backups-azure' from ::ffff:1.2.3.4: \"vm/133/2024-09-19T10:56:06Z\"\r\n2024-09-19T10:56:07+00:00: GET /previous: 400 Bad Request: no valid previous backup\r\n2024-09-19T10:56:07+00:00: created new fixed index 1 (\"vm/133/2024-09-19T10:56:06Z/drive-scsi0.img.fidx\")\r\n2024-09-19T10:56:29+00:00: add blob \"/mnt/datastore/backups-azure/vm/133/2024-09-19T10:56:06Z/qemu-server.conf.blob\" (384 bytes, comp: 384)\r\n2024-09-19T10:58:59+00:00: Upload statistics for 'drive-scsi0.img.fidx'\r\n2024-09-19T10:58:59+00:00: UUID: 2ae1ce99931c40a740c6a87f46707da2\r\n2024-09-19T10:58:59+00:00: Checksum: 88d858074bdc7aae912fa4e3f4b56e891dd71beaa86132390c438b7eacb56b3c\r\n2024-09-19T10:58:59+00:00: Size: 53687091200\r\n2024-09-19T10:58:59+00:00: Chunk count: 12800\r\n2024-09-19T10:58:59+00:00: Upload size: 10800332800 (20%)\r\n2024-09-19T10:58:59+00:00: Duplicates: 10225+22 (80%)\r\n2024-09-19T10:58:59+00:00: Compression: 27%\r\n2024-09-19T10:58:59+00:00: successfully closed fixed index 1\r\n2024-09-19T10:58:59+00:00: add blob \"/mnt/datastore/backups-azure/vm/133/2024-09-19T10:56:06Z/index.json.blob\" (325 bytes, comp: 325)\r\n2024-09-19T10:58:59+00:00: successfully finished backup\r\n2024-09-19T10:58:59+00:00: backup finished successfully\r\n2024-09-19T10:58:59+00:00: TASK OK\r\n```\r\n\r\nThank you very much for looking at my problem","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2360683601/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"lemeshovich","id":17667824,"node_id":"MDQ6VXNlcjE3NjY3ODI0","avatar_url":"https://avatars.githubusercontent.com/u/17667824?v=4","gravatar_id":"","url":"https://api.github.com/users/lemeshovich","html_url":"https://github.com/lemeshovich","followers_url":"https://api.github.com/users/lemeshovich/followers","following_url":"https://api.github.com/users/lemeshovich/following{/other_user}","gists_url":"https://api.github.com/users/lemeshovich/gists{/gist_id}","starred_url":"https://api.github.com/users/lemeshovich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lemeshovich/subscriptions","organizations_url":"https://api.github.com/users/lemeshovich/orgs","repos_url":"https://api.github.com/users/lemeshovich/repos","events_url":"https://api.github.com/users/lemeshovich/events{/privacy}","received_events_url":"https://api.github.com/users/lemeshovich/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2363453013","html_url":"https://github.com/rclone/rclone/issues/8082#issuecomment-2363453013","issue_url":"https://api.github.com/repos/rclone/rclone/issues/8082","id":2363453013,"node_id":"IC_kwDOAQ-n5M6M325V","user":{"login":"lemeshovich","id":17667824,"node_id":"MDQ6VXNlcjE3NjY3ODI0","avatar_url":"https://avatars.githubusercontent.com/u/17667824?v=4","gravatar_id":"","url":"https://api.github.com/users/lemeshovich","html_url":"https://github.com/lemeshovich","followers_url":"https://api.github.com/users/lemeshovich/followers","following_url":"https://api.github.com/users/lemeshovich/following{/other_user}","gists_url":"https://api.github.com/users/lemeshovich/gists{/gist_id}","starred_url":"https://api.github.com/users/lemeshovich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lemeshovich/subscriptions","organizations_url":"https://api.github.com/users/lemeshovich/orgs","repos_url":"https://api.github.com/users/lemeshovich/repos","events_url":"https://api.github.com/users/lemeshovich/events{/privacy}","received_events_url":"https://api.github.com/users/lemeshovich/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-20T11:01:35Z","updated_at":"2024-09-20T11:01:35Z","body":"Do you have any new thoughts about this? @ncw ","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2363453013/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"lemeshovich","id":17667824,"node_id":"MDQ6VXNlcjE3NjY3ODI0","avatar_url":"https://avatars.githubusercontent.com/u/17667824?v=4","gravatar_id":"","url":"https://api.github.com/users/lemeshovich","html_url":"https://github.com/lemeshovich","followers_url":"https://api.github.com/users/lemeshovich/followers","following_url":"https://api.github.com/users/lemeshovich/following{/other_user}","gists_url":"https://api.github.com/users/lemeshovich/gists{/gist_id}","starred_url":"https://api.github.com/users/lemeshovich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lemeshovich/subscriptions","organizations_url":"https://api.github.com/users/lemeshovich/orgs","repos_url":"https://api.github.com/users/lemeshovich/repos","events_url":"https://api.github.com/users/lemeshovich/events{/privacy}","received_events_url":"https://api.github.com/users/lemeshovich/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":14338274499,"node_id":"MEE_lADOAQ-n5M6W_3WazwAAAANWoLTD","url":"https://api.github.com/repos/rclone/rclone/issues/events/14338274499","actor":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2024-09-20T11:01:37Z","performed_via_github_app":null},{"id":14338274521,"node_id":"SE_lADOAQ-n5M6W_3WazwAAAANWoLTZ","url":"https://api.github.com/repos/rclone/rclone/issues/events/14338274521","actor":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2024-09-20T11:01:37Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2364112682","html_url":"https://github.com/rclone/rclone/issues/8082#issuecomment-2364112682","issue_url":"https://api.github.com/repos/rclone/rclone/issues/8082","id":2364112682,"node_id":"IC_kwDOAQ-n5M6M6X8q","user":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-20T16:38:17Z","updated_at":"2024-09-20T16:38:17Z","body":"This is what the sequence looks like when it works\r\n\r\nApp writes to `vm/133/2024-09-19T10:56:06Z/drive-scsi0.img.tmp_fidx`\r\n\r\n```\r\n2024/09/19 10:58:59 DEBUG : &{vm/133/2024-09-19T10:56:06Z/drive-scsi0.img.tmp_fidx (rw)}: Write: len=12288, offset=401408\r\n2024/09/19 10:58:59 DEBUG : vm/133/2024-09-19T10:56:06Z/drive-scsi0.img.tmp_fidx(0xc000ce21c0): >_writeAt: n=131072, err=<nil>\r\n2024/09/19 10:58:59 DEBUG : &{vm/133/2024-09-19T10:56:06Z/drive-scsi0.img.tmp_fidx (rw)}: >Write: written=131072, err=<nil>\r\n2024/09/19 10:58:59 DEBUG : vm/133/2024-09-19T10:56:06Z/drive-scsi0.img.tmp_fidx(0xc000ce21c0): _writeAt: size=32, off=32\r\n2024/09/19 10:58:59 DEBUG : vm/133/2024-09-19T10:56:06Z/drive-scsi0.img.tmp_fidx(0xc000ce21c0): >_writeAt: n=32, err=<nil>\r\n2024/09/19 10:58:59 DEBUG : &{vm/133/2024-09-19T10:56:06Z/drive-scsi0.img.tmp_fidx (rw)}: >Write: written=32, err=<nil>\r\n2024/09/19 10:58:59 DEBUG : vm/133/2024-09-19T10:56:06Z/drive-scsi0.img.tmp_fidx(0xc000ce21c0): _writeAt: size=12288, off=401408\r\n2024/09/19 10:58:59 DEBUG : vm/133/2024-09-19T10:56:06Z/drive-scsi0.img.tmp_fidx(0xc000ce21c0): >_writeAt: n=12288, err=<nil>\r\n2024/09/19 10:58:59 DEBUG : &{vm/133/2024-09-19T10:56:06Z/drive-scsi0.img.tmp_fidx (rw)}: >Write: written=12288, err=<nil>\r\n```\r\n\r\nThe app does a `stat` on the file to see if it exists - it does\r\n\r\n```\r\n2024/09/19 10:58:59 DEBUG : vm/133/2024-09-19T10:56:06Z/: Lookup: name=\"drive-scsi0.img.tmp_fidx\"\r\n2024/09/19 10:58:59 DEBUG : vm/133/2024-09-19T10:56:06Z/: >Lookup: node=vm/133/2024-09-19T10:56:06Z/drive-scsi0.img.tmp_fidx, err=<nil>\r\n```\r\n\r\nIt then `stat`s the non tmp version `drive-scsi0.img.fidx` which does not exist\r\n\r\n```\r\n2024/09/19 10:58:59 DEBUG : vm/133/2024-09-19T10:56:06Z/: Lookup: name=\"drive-scsi0.img.fidx\"\r\n2024/09/19 10:58:59 DEBUG : vm/133/2024-09-19T10:56:06Z/: >Lookup: node=<nil>, err=no such file or directory\r\n```\r\n\r\nIt then renames the tmp to its final value\r\n\r\n```\r\n2024/09/19 10:58:59 DEBUG : vm/133/2024-09-19T10:56:06Z/: Rename: oldName=\"drive-scsi0.img.tmp_fidx\", newName=\"drive-scsi0.img.fidx\", newDir=vm/133/2024-09-19T10:56:06Z/\r\n2024/09/19 10:58:59 INFO  : vm/133/2024-09-19T10:56:06Z/drive-scsi0.img.tmp_fidx: vfs cache: renamed in cache to \"vm/133/2024-09-19T10:56:06Z/drive-scsi0.img.fidx\"\r\n2024/09/19 10:58:59 DEBUG : vm/133/2024-09-19T10:56:06Z/drive-scsi0.img.fidx: Updating file with <nil> 0xc000f7f440\r\n2024/09/19 10:58:59 DEBUG : vm/133/2024-09-19T10:56:06Z: Added virtual directory entry vDel: \"drive-scsi0.img.tmp_fidx\"\r\n2024/09/19 10:58:59 DEBUG : vm/133/2024-09-19T10:56:06Z: Added virtual directory entry vAddFile: \"drive-scsi0.img.fidx\"\r\n2024/09/19 10:58:59 DEBUG : vm/133/2024-09-19T10:56:06Z/: >Rename: err=<nil>\r\n2024/09/19 10:58:59 DEBUG : vm/133/2024-09-19T10:56:06Z/: Invalidating \"drive-scsi0.img.fidx\"\r\n```\r\n\r\nCheck the tmp file does not exists\r\n\r\n```\r\n2024/09/19 10:58:59 DEBUG : vm/133/2024-09-19T10:56:06Z/: Lookup: name=\"drive-scsi0.img.tmp_fidx\"\r\n2024/09/19 10:58:59 DEBUG : vm/133/2024-09-19T10:56:06Z/: >Lookup: node=<nil>, err=no such file or directory\r\n```\r\n\r\nIt then closes (or maybe flushes) the file\r\n\r\n```\r\n2024/09/19 10:58:59 DEBUG : &{vm/133/2024-09-19T10:56:06Z/drive-scsi0.img.fidx (rw)}: Flush: \r\n2024/09/19 10:58:59 DEBUG : vm/133/2024-09-19T10:56:06Z/drive-scsi0.img.fidx(0xc000ce21c0): RWFileHandle.Flush\r\n2024/09/19 10:58:59 DEBUG : &{vm/133/2024-09-19T10:56:06Z/drive-scsi0.img.fidx (rw)}: >Flush: err=<nil>\r\n```\r\n\r\nWhich is then released and queued for uploaded\r\n\r\n```\r\n2024/09/19 10:58:59 DEBUG : &{vm/133/2024-09-19T10:56:06Z/drive-scsi0.img.fidx (rw)}: Release: \r\n2024/09/19 10:58:59 DEBUG : vm/133/2024-09-19T10:56:06Z/drive-scsi0.img.fidx(0xc000ce21c0): RWFileHandle.Release\r\n2024/09/19 10:58:59 DEBUG : vm/133/2024-09-19T10:56:06Z/drive-scsi0.img.fidx(0xc000ce21c0): close: \r\n2024/09/19 10:58:59 DEBUG : vm/133/2024-09-19T10:56:06Z/drive-scsi0.img.fidx: vfs cache: setting modification time to 2024-09-19 10:58:59.104395049 +0000 UTC m=+289.799360841\r\n2024/09/19 10:58:59 INFO  : vm/133/2024-09-19T10:56:06Z/drive-scsi0.img.fidx: vfs cache: queuing for upload in 5s\r\n2024/09/19 10:58:59 DEBUG : vm/133/2024-09-19T10:56:06Z/drive-scsi0.img.fidx(0xc000ce21c0): >close: err=<nil>\r\n2024/09/19 10:58:59 DEBUG : &{vm/133/2024-09-19T10:56:06Z/drive-scsi0.img.fidx (rw)}: >Release: err=<nil>\r\n```\r\n\r\nIt looks very similar up to the point when it finds the drive-scsi0.img.tmp_fidx\" file wheras the error run failed to find it.\r\n\r\n---- \r\n\r\nI have managed to spot an important difference between the two logs. :fireworks: \r\n\r\nIn the failure log we have\r\n\r\n```\r\n$ grep \"vm/127.*forgetting directory cache\" rclone-mount.log\r\n2024/09/18 17:28:59 DEBUG : vm/127: forgetting directory cache\r\n2024/09/18 17:28:59 DEBUG : vm/127/2024-09-18T17:19:54Z: forgetting directory cache\r\n2024/09/18 17:28:59 DEBUG : vm/127/2024-09-17T23:08:51Z: forgetting directory cache\r\n2024/09/18 17:29:57 DEBUG : vm/127/2024-09-18T17:19:54Z: forgetting directory cache\r\n```\r\n\r\nBut we have none of those in the success log.\r\n\r\nForgetting the directory cache for `vm/127/2024-09-18T17:19:54Z` could remove any virtual entries for files in that directory which would give the symptoms you are seeing - we rely on virtual entries to have files that are open and haven't been written to cloud storage yet visible in the directory.\r\n\r\nThe reason for this is that the directory cache expires after 5 minutes and the successful backup run took less than 5 minutes between its first and last access to the vm/133 directory whereas the unsuccessful took longer than 5 minutes.\r\n\r\nSo there is an easy fix for this - adjust this value\r\n\r\n    --dir-cache-time duration   Time to cache directory entries for (default 5m0s)\r\n\r\nTry something much longer than a backup run, say `--dir-cache-time 24h`\r\n\r\nCan you try that and see if it fixes the problem?\r\n\r\nI still think this is a bug in rclone though - forgetting the directory cache shouldn't remove the virtual entries - there is code to ensure that which isn't working properly.\r\n\r\nIf this is the problem it was introduced as part of 52e25c43b978624b10d48f04ad88a55cc2204fd8 which proactively forgets old directories to save memory.\r\n\r\n","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2364112682/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2367743221","html_url":"https://github.com/rclone/rclone/issues/8082#issuecomment-2367743221","issue_url":"https://api.github.com/repos/rclone/rclone/issues/8082","id":2367743221,"node_id":"IC_kwDOAQ-n5M6NIOT1","user":{"login":"lemeshovich","id":17667824,"node_id":"MDQ6VXNlcjE3NjY3ODI0","avatar_url":"https://avatars.githubusercontent.com/u/17667824?v=4","gravatar_id":"","url":"https://api.github.com/users/lemeshovich","html_url":"https://github.com/lemeshovich","followers_url":"https://api.github.com/users/lemeshovich/followers","following_url":"https://api.github.com/users/lemeshovich/following{/other_user}","gists_url":"https://api.github.com/users/lemeshovich/gists{/gist_id}","starred_url":"https://api.github.com/users/lemeshovich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lemeshovich/subscriptions","organizations_url":"https://api.github.com/users/lemeshovich/orgs","repos_url":"https://api.github.com/users/lemeshovich/repos","events_url":"https://api.github.com/users/lemeshovich/events{/privacy}","received_events_url":"https://api.github.com/users/lemeshovich/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-23T09:56:45Z","updated_at":"2024-09-23T10:01:17Z","body":"> Try something much longer than a backup run, say `--dir-cache-time 24h`\r\n\r\nIt seems that increasing the value of this parameter to `12h` solved my problem, the backup of all important VMs scheduled for the weekend was completed successfully without any errors. Thank you very much for the detailed analysis of the current situation.\r\n\r\n> `--vfs-used-is-size` probably isn't causing the problem, but I don't recommend its use as it is really resource intensive - it lists every file in the remote every `--dir-cache-time`\r\n\r\nDoes increasing the value of `--dir-cache-time` to `12h` mean that `--vfs-used-is-size` parameter will be less resource intensive than the default `5m` value? Is it possible to reduce the impact of `--vfs-used-is-size` even more by reducing the frequency of checking the used space to once a week (backups is scheduled for every weekend and there is no need to check size more often) without increasing the `--dir-cache-time` value above `12h`?","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2367743221/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"lemeshovich","id":17667824,"node_id":"MDQ6VXNlcjE3NjY3ODI0","avatar_url":"https://avatars.githubusercontent.com/u/17667824?v=4","gravatar_id":"","url":"https://api.github.com/users/lemeshovich","html_url":"https://github.com/lemeshovich","followers_url":"https://api.github.com/users/lemeshovich/followers","following_url":"https://api.github.com/users/lemeshovich/following{/other_user}","gists_url":"https://api.github.com/users/lemeshovich/gists{/gist_id}","starred_url":"https://api.github.com/users/lemeshovich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lemeshovich/subscriptions","organizations_url":"https://api.github.com/users/lemeshovich/orgs","repos_url":"https://api.github.com/users/lemeshovich/repos","events_url":"https://api.github.com/users/lemeshovich/events{/privacy}","received_events_url":"https://api.github.com/users/lemeshovich/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2367888860","html_url":"https://github.com/rclone/rclone/issues/8082#issuecomment-2367888860","issue_url":"https://api.github.com/repos/rclone/rclone/issues/8082","id":2367888860,"node_id":"IC_kwDOAQ-n5M6NIx3c","user":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-09-23T11:03:28Z","updated_at":"2024-09-23T11:03:28Z","body":"> > Try something much longer than a backup run, say `--dir-cache-time 24h`\r\n> \r\n> It seems that increasing the value of this parameter to `12h` solved my problem, the backup of all important VMs scheduled for the weekend was completed successfully without any errors. Thank you very much for the detailed analysis of the current situation.\r\n\r\nGreat :-)\r\n \r\n> > `--vfs-used-is-size` probably isn't causing the problem, but I don't recommend its use as it is really resource intensive - it lists every file in the remote every `--dir-cache-time`\r\n> \r\n> Does increasing the value of `--dir-cache-time` to `12h` mean that `--vfs-used-is-size` parameter will be less resource intensive than the default `5m` value?\r\n\r\nYes, it will only be run every `12h` so probably only once.\r\n\r\n> Is it possible to reduce the impact of `--vfs-used-is-size` even more by reducing the frequency of checking the used space to once a week (backups is scheduled for every weekend and there is no need to check size more often) without increasing the `--dir-cache-time` value above `12h`?\r\n\r\nNot at the moment - the max age of the size info is controlled only by `--dir-cache-time`. However if you (or the OS) don't request the size used then rclone won't fetch it so there is a chance that the frequency is a lot less than `12h`\r\n\r\nI'm glad we've found a workaround.\r\n\r\nAnnoyingly I haven't managed to replicate this problem locally yet so I might need to get you to test more stuff if you are OK with that?\r\n","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2367888860/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":14361800942,"node_id":"RTE_lADOAQ-n5M6W_3WazwAAAANYB7Du","url":"https://api.github.com/repos/rclone/rclone/issues/events/14361800942","actor":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"renamed","commit_id":null,"commit_url":null,"created_at":"2024-09-23T11:04:23Z","rename":{"from":"Azure Blob as PBS datastore, atomic rename error","to":"vfs: open files disappearing from directory listings when using Proxmox Backup Server"},"performed_via_github_app":null},{"id":14474591879,"node_id":"REFE_lADOAQ-n5M6W_3WazwAAAANewL6H","url":"https://api.github.com/repos/rclone/rclone/issues/events/14474591879","actor":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"cc0e3042511aff451698bf1e75e64194a2b73908","commit_url":"https://api.github.com/repos/rclone/rclone/commits/cc0e3042511aff451698bf1e75e64194a2b73908","created_at":"2024-10-01T14:55:04Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2386234038","html_url":"https://github.com/rclone/rclone/issues/8082#issuecomment-2386234038","issue_url":"https://api.github.com/repos/rclone/rclone/issues/8082","id":2386234038,"node_id":"IC_kwDOAQ-n5M6OOwq2","user":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-10-01T14:55:54Z","updated_at":"2024-10-01T14:55:54Z","body":"After some effort I managed to replicate the bug and fix it!\r\n\r\nPlease can you give this a go without the --dir-cache-time parameter.\r\n\r\nThank you\r\n\r\n[v1.69.0-beta.8351.cc0e30425.fix-8082-vfs-dircache](https://beta.rclone.org/branch/fix-8082-vfs-dircache/v1.69.0-beta.8351.cc0e30425.fix-8082-vfs-dircache/) on branch [fix-8082-vfs-dircache](https://github.com/rclone/rclone/tree/fix-8082-vfs-dircache) (uploaded in 15-30 mins)","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2386234038/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":14474607440,"node_id":"MIE_lADOAQ-n5M6W_3WazwAAAANewPtQ","url":"https://api.github.com/repos/rclone/rclone/issues/events/14474607440","actor":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"milestoned","commit_id":null,"commit_url":null,"created_at":"2024-10-01T14:56:01Z","milestone":{"title":"v1.69"},"performed_via_github_app":null},{"id":15893414730,"node_id":"REFE_lADOAQ-n5M6W_3WazwAAAAOzUkNK","url":"https://api.github.com/repos/rclone/rclone/issues/events/15893414730","actor":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"6091a0362be3bdb1d0aa7504c25d5818fa25240b","commit_url":"https://api.github.com/repos/rclone/rclone/commits/6091a0362be3bdb1d0aa7504c25d5818fa25240b","created_at":"2025-01-11T18:46:46Z","performed_via_github_app":null},{"id":15893507382,"node_id":"CE_lADOAQ-n5M6W_3WazwAAAAOzU602","url":"https://api.github.com/repos/rclone/rclone/issues/events/15893507382","actor":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"closed","commit_id":"6091a0362be3bdb1d0aa7504c25d5818fa25240b","commit_url":"https://api.github.com/repos/rclone/rclone/commits/6091a0362be3bdb1d0aa7504c25d5818fa25240b","created_at":"2025-01-11T19:52:21Z","state_reason":null,"performed_via_github_app":null},{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2585390080","html_url":"https://github.com/rclone/rclone/issues/8082#issuecomment-2585390080","issue_url":"https://api.github.com/repos/rclone/rclone/issues/8082","id":2585390080,"node_id":"IC_kwDOAQ-n5M6aGewA","user":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2025-01-11T19:53:45Z","updated_at":"2025-01-11T19:53:45Z","body":"I've merged this to master now which means it will be in [the latest beta](https://beta.rclone.org/) in 15-30 minutes and released in v1.69 ","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2585390080/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":1,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false}}]