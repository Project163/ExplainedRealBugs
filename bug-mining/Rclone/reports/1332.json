{"url":"https://api.github.com/repos/rclone/rclone/issues/8082","repository_url":"https://api.github.com/repos/rclone/rclone","labels_url":"https://api.github.com/repos/rclone/rclone/issues/8082/labels{/name}","comments_url":"https://api.github.com/repos/rclone/rclone/issues/8082/comments","events_url":"https://api.github.com/repos/rclone/rclone/issues/8082/events","html_url":"https://github.com/rclone/rclone/issues/8082","id":2533324186,"node_id":"I_kwDOAQ-n5M6W_3Wa","number":8082,"title":"vfs: open files disappearing from directory listings when using Proxmox Backup Server","user":{"login":"lemeshovich","id":17667824,"node_id":"MDQ6VXNlcjE3NjY3ODI0","avatar_url":"https://avatars.githubusercontent.com/u/17667824?v=4","gravatar_id":"","url":"https://api.github.com/users/lemeshovich","html_url":"https://github.com/lemeshovich","followers_url":"https://api.github.com/users/lemeshovich/followers","following_url":"https://api.github.com/users/lemeshovich/following{/other_user}","gists_url":"https://api.github.com/users/lemeshovich/gists{/gist_id}","starred_url":"https://api.github.com/users/lemeshovich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lemeshovich/subscriptions","organizations_url":"https://api.github.com/users/lemeshovich/orgs","repos_url":"https://api.github.com/users/lemeshovich/repos","events_url":"https://api.github.com/users/lemeshovich/events{/privacy}","received_events_url":"https://api.github.com/users/lemeshovich/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":86399005,"node_id":"MDU6TGFiZWw4NjM5OTAwNQ==","url":"https://api.github.com/repos/rclone/rclone/labels/bug","name":"bug","color":"fc2929","default":true,"description":null},{"id":430778096,"node_id":"MDU6TGFiZWw0MzA3NzgwOTY=","url":"https://api.github.com/repos/rclone/rclone/labels/VFS%20/%20mount","name":"VFS / mount","color":"0e8a16","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/rclone/rclone/milestones/57","html_url":"https://github.com/rclone/rclone/milestone/57","labels_url":"https://api.github.com/repos/rclone/rclone/milestones/57/labels","id":11258698,"node_id":"MI_kwDOAQ-n5M4Aq8tK","number":57,"title":"v1.69","description":"","creator":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":1,"closed_issues":23,"state":"closed","created_at":"2024-07-01T16:37:57Z","updated_at":"2025-05-27T14:40:10Z","due_on":"2025-01-12T08:00:00Z","closed_at":"2025-01-13T10:54:46Z"},"comments":17,"created_at":"2024-09-18T10:17:24Z","updated_at":"2025-01-11T19:53:46Z","closed_at":"2025-01-11T19:52:21Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"#### What is your current rclone version (output from `rclone version`)?\r\n\r\nrclone v1.67.0\r\n- os/version: debian 12.5 (64 bit)\r\n- os/kernel: 6.5.11-6-pve (x86_64)\r\n- os/type: linux\r\n- os/arch: amd64\r\n- go/version: go1.22.4\r\n- go/linking: static\r\n- go/tags: none\r\n\r\n#### What problem are you trying to solve?\r\n\r\nI'm using rclone with Azure Blob to mount it as an external datastore for Proxmox Backup Server. PBS created a datastore, next im running a backup job in PVE for several of my VMs. And the problem is that about half of my VM backup tasks are failing with error:\r\n\r\n```\r\nINFO:  96% (96.1 GiB of 100.0 GiB) in 17m 13s, read: 88.7 MiB/s, write: 88.7 MiB/s\r\nINFO:  97% (97.2 GiB of 100.0 GiB) in 17m 25s, read: 95.7 MiB/s, write: 85.3 MiB/s\r\nINFO:  98% (98.0 GiB of 100.0 GiB) in 17m 35s, read: 89.2 MiB/s, write: 53.6 MiB/s\r\nINFO:  99% (99.6 GiB of 100.0 GiB) in 17m 38s, read: 525.3 MiB/s, write: 184.0 MiB/s\r\nINFO: 100% (100.0 GiB of 100.0 GiB) in 17m 49s, read: 38.9 MiB/s, write: 38.9 MiB/s\r\nERROR: backup close image failed: command error: Atomic rename file \"/mnt/datastore/backups-azure/vm/124/2024-09-17T22:50:56Z/drive-scsi0.img.fidx\" failed - No such file or directory (os error 2)\r\nINFO: aborting backup job\r\nINFO: resuming VM again\r\nERROR: Backup of VM 124 failed - backup close image failed: command error: Atomic rename file \"/mnt/datastore/backups-azure/vm/124/2024-09-17T22:50:56Z/drive-scsi0.img.fidx\" failed - No such file or directory (os error 2)\r\nINFO: Failed at 2024-09-17 23:08:51\r\n```\r\nI noticed that at the time when the PVE backup job prints an error, rclone can still actively upload PBS VM chunks to azure. During that error, the file Proxmox wants to rename, may not be here yet. As far as I understand, when backing up different VMs, this file `drive-scsi0.img.fidx` may be written earlier or later, and in cases where this file is sent for upload at the very end of the backup process, this error occurs. As far as I see, something similar was discussed [here](https://forum.rclone.org/t/is-there-a-way-to-disable-writeback/27998).\r\nIt seems like this method of 'cloud PBS datastore via rclone' deserves to exist, since the process of VMs backup and restoration to/from Azure blob is quite fast. For now, the only problem is what I described above. Perhaps you have ideas on how to match rclone and PBS in time, using `--vfs-cache-mode writes`\r\n\r\n#### How do you think rclone should be changed to solve that?\r\nAt the mounting point, to create a symlink pointing to the file in the rclone cache for files that are being uploading. Then remove a symlink when the file is uploaded. Or to tell the vfs to wait some time when trying to rename yet non-existent file before giving an error (isnt `--vfs-write-wait` should do this?). My thoughts are something like that, maybe there is a much simpler solution, please help. \r\n#### The command you were trying to run (e.g. rclone copy /tmp remote:tmp)\r\n\r\n```\r\nrclone mount \\\r\n  --uid 34 \\\r\n  --gid 34 \\\r\n  --allow-other \\\r\n  --allow-non-empty \\\r\n  --vfs-cache-mode writes \\\r\n  --vfs-cache-min-free-space 4G \\\r\n  --vfs-write-wait 20s \\\r\n  --vfs-write-back 0s \\\r\n  --vfs-fast-fingerprint \\\r\n  --vfs-disk-space-total-size 2T \\\r\n  --vfs-used-is-size=true \\\r\n  azure:vm-backups /mnt/datastore/backups-azure \\\r\n  --azureblob-directory-markers \\\r\n  --azureblob-disable-checksum \\\r\n  --log-level INFO \\\r\n  --log-file=/tmp/rclone-mount.log \\\r\n  --cache-dir=/mnt/rclone-cache\r\n```\r\nalso tried with ```--write-back-cache --transfers 8 --buffer-size 32M --use-mmap```","closed_by":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/8082/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rclone/rclone/issues/8082/timeline","performed_via_github_app":null,"state_reason":"completed"}