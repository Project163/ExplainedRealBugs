{"url":"https://api.github.com/repos/rclone/rclone/issues/8656","repository_url":"https://api.github.com/repos/rclone/rclone","labels_url":"https://api.github.com/repos/rclone/rclone/issues/8656/labels{/name}","comments_url":"https://api.github.com/repos/rclone/rclone/issues/8656/comments","events_url":"https://api.github.com/repos/rclone/rclone/issues/8656/events","html_url":"https://github.com/rclone/rclone/issues/8656","id":3195224703,"node_id":"I_kwDOAQ-n5M6-c0J_","number":8656,"title":"deadlock in --no-traverse when all transfers skipped","user":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":86399005,"node_id":"MDU6TGFiZWw4NjM5OTAwNQ==","url":"https://api.github.com/repos/rclone/rclone/labels/bug","name":"bug","color":"fc2929","default":true,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2025-07-02T09:23:21Z","updated_at":"2025-07-04T13:53:40Z","closed_at":"2025-07-04T13:52:48Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Issue made from https://github.com/rclone/rclone/pull/8647 by @jeremy \n\n#### What is the problem you are having with rclone?\n\nWhen every source object already exists at the destination and `--no-traverse` is set, march stalled/deadlocked after 100 entries because dstChan lagged srcChan. Introduced in v1.70.0 with callback-based syncing.\n\nI couldn't get a test case working reliably, but here's a script to reproduce:\n```bash\n#!/usr/bin/env bash\n# Reproduces rclone v1.70+ deadlock with --no-traverse when all files exist\n# Usage: ./repro.sh [rclone-binary-path]\n\n# Use provided rclone binary or default to system rclone\nRCLONE=\"${1:-rclone}\"\n\necho \"Using rclone: $RCLONE\"\necho \"Version: $($RCLONE version | head -1)\"\necho\n\n# Create test directories\nsrc=$(mktemp -d)\ndst=$(mktemp -d)\n\n# Create 200 test files (enough to trigger the ~100 file deadlock)\necho \"Creating 200 test files...\"\nfor i in {1..200}; do\n    echo \"content$i\" > \"$src/file$i.txt\"\ndone\n\n# Initial copy to establish destination\necho \"Initial copy to destination...\"\n$RCLONE copy \"$src/\" \"$dst/\" --quiet\n\n# Create file list\nfilelist=$(mktemp)\nls \"$src\" > \"$filelist\"\n\n# This command deadlocks in v1.70+ when all files exist at destination\necho \"Testing --no-traverse with all files existing (10s timeout)...\"\ntimeout 10s $RCLONE copy \"$src/\" \"$dst/\" \\\n    --no-traverse \\\n    --files-from \"$filelist\" \\\n    --ignore-existing \\\n    --progress\n\nif [ $? -eq 124 ]; then\n    echo -e \"\\n‚ùå FAIL: Command timed out (deadlock detected)\"\n    exit 1\nelse\n    echo -e \"\\n‚úÖ PASS: Command completed successfully\"\nfi\n\n# Cleanup\nrm -rf \"$src\" \"$dst\" \"$filelist\"\n```\n\nResults on 1.69.3, 1.70.2, and with this patch:\n```bash\nUsing rclone: rclone\nVersion: rclone v1.69.3\n\nCreating 200 test files...\nInitial copy to destination...\nTesting --no-traverse with all files existing (10s timeout)...\nTransferred:   \t          0 B / 0 B, -, 0 B/s, ETA -\nChecks:               200 / 200, 100%\nElapsed time:         0.0s\n\n‚úÖ PASS: Command completed successfully\n```\n```bash\nUsing rclone: rclone\nVersion: rclone v1.70.2\n\nCreating 200 test files...\nInitial copy to destination...\nTesting --no-traverse with all files existing (10s timeout)...\nTransferred:   \t          0 B / 0 B, -, 0 B/s, ETA -\nChecks:                 0 / 0, -, Listed 200\nElapsed time:         9.5s\n‚ùå FAIL: Command timed out (deadlock detected)\n```\n```bash\nUsing rclone: ./rclone\nVersion: rclone v1.71.0-DEV\n\nCreating 200 test files...\nInitial copy to destination...\nTesting --no-traverse with all files existing (10s timeout)...\nTransferred:   \t          0 B / 0 B, -, 0 B/s, ETA -\nChecks:               200 / 200, 100%, Listed 200\nElapsed time:         0.0s\n\n‚úÖ PASS: Command completed successfully\n```\n\n#### What is your rclone version (output from `rclone version`)\n\nv1.70.2\n\n#### The associated forum post URL from `https://forum.rclone.org`\n\n* https://forum.rclone.org/t/1-70-1-appears-to-hang-when-using-files-from-rclone-ls-no-traverse-and-ignore-existing/51720\n* https://forum.rclone.org/t/deadlock-when-using-no-traverse-max-duration-and-files-from-with-many-files-100/51650\n\n\n<!--- Please keep the note below for others who read your bug report. -->\n\n#### How to use GitHub\n\n* Please use the üëç [reaction](https://blog.github.com/2016-03-10-add-reactions-to-pull-requests-issues-and-comments/) to show that you are affected by the same issue.\n* Please don't comment if you have no relevant information to add. It's just extra noise for everyone subscribed to this issue.\n* Subscribe to receive notifications on status change and new comments.\n","closed_by":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/8656/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rclone/rclone/issues/8656/timeline","performed_via_github_app":null,"state_reason":"completed"}