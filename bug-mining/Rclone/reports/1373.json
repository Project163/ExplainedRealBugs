{"url":"https://api.github.com/repos/rclone/rclone/issues/8464","repository_url":"https://api.github.com/repos/rclone/rclone","labels_url":"https://api.github.com/repos/rclone/rclone/issues/8464/labels{/name}","comments_url":"https://api.github.com/repos/rclone/rclone/issues/8464/comments","events_url":"https://api.github.com/repos/rclone/rclone/issues/8464/events","html_url":"https://github.com/rclone/rclone/issues/8464","id":2937763174,"node_id":"I_kwDOAQ-n5M6vGrVm","number":8464,"title":"serve s3: ListObjectsV2 should return CommonPrefixes (directories) with a trailing /","user":{"login":"networkhell","id":35071549,"node_id":"MDQ6VXNlcjM1MDcxNTQ5","avatar_url":"https://avatars.githubusercontent.com/u/35071549?v=4","gravatar_id":"","url":"https://api.github.com/users/networkhell","html_url":"https://github.com/networkhell","followers_url":"https://api.github.com/users/networkhell/followers","following_url":"https://api.github.com/users/networkhell/following{/other_user}","gists_url":"https://api.github.com/users/networkhell/gists{/gist_id}","starred_url":"https://api.github.com/users/networkhell/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/networkhell/subscriptions","organizations_url":"https://api.github.com/users/networkhell/orgs","repos_url":"https://api.github.com/users/networkhell/repos","events_url":"https://api.github.com/users/networkhell/events{/privacy}","received_events_url":"https://api.github.com/users/networkhell/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2025-03-21T09:09:06Z","updated_at":"2025-05-22T21:27:39Z","closed_at":"2025-05-22T21:27:39Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"#### What is the problem you are having with rclone?\nI am using rclone serve s3 as an encrypting proxy in front of a Ceph/RGW S3 storage. According to the AWS docs \nthe ListObjectsV2 API call shoud return CommonPrefixes (directories) with a trailing forward slash. \nBut the s3 implementation of rclone serve s3 does not add trailing slashes to directories returned as CommonPrefixes in the ListObjectsV2 call. \n\nReference: [API_ListObjectsV2_ResponseSyntax](https://docs.aws.amazon.com/AmazonS3/latest/API/API_ListObjectsV2.html#API_ListObjectsV2_ResponseSyntax)\n\nImplications: some tools (e.g. pgbarman) rely on that to find backups stored in s3 and e.g. filter out all returned prefixes not containing a trailing /, assuming these are not directories.\n\nReference: [pgbarman-code](https://github.com/EnterpriseDB/barman/blob/d68a70eb6d5473fe29bc6895dee94a723ab128cb/barman/cloud.py#L2130)\n\n#### What is your rclone version (output from `rclone version`)\n1.69.1\n\n\n#### Which OS you are using and how many bits (e.g. Windows 7, 64 bit)\nLinux amd64\n\n\n#### Which cloud storage system are you using? (e.g. Google Drive)\nCeph S3\n\nSetup: client (mostly backup tools like pgbarman, velero ...) --> rclone serve s3 crypt_backend: --> Ceph/RGW S3\n\n#### The command you were trying to run (e.g. `rclone copy /tmp remote:tmp`)\nHTTP Request from pgbarman:\n```\n2025-03-20 09:19:46,920 [11] DEBUG: Sending http request: <AWSPreparedRequest stream_output=False, method=GET, url=https://host.docker.internal:4443/cnpg-backups?list-type=2&prefix=cnpg-cluster-zitadel%2Fbase%2F&delimiter=%2F&encoding-type=url, headers={'User-Agent': b'Boto3/1.34.46 md/Botocore#1.34.46 ua/2.0 os/linux#6.10.14-linuxkit md/arch#aarch64 lang/python#3.12.3 md/pyimpl#CPython cfg/retry-mode#legacy Botocore/1.34.46 Resource', 'X-Amz-Date': b'20250320T091946Z', 'X-Amz-Content-SHA256': b'e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855', 'Authorization': b'AWS4-HMAC-SHA256 Credential=****/20250320/us-east-1/s3/aws4_request, SignedHeaders=host;x-amz-content-sha256;x-amz-date, Signature=***', 'amz-sdk-invocation-id': b'd82e2ad5-4bb6-4695-9337-050bd405aede', 'amz-sdk-request': b'attempt=1'}>\n``` \n\n\n#### A log from the command with the `-vv` flag (e.g. output from `rclone -vv copy /tmp remote:tmp`)\nResponse logged from pgbarman:\n```\n2025-03-20 09:19:47,185 botocore.parsers [DEBUG] Response body:\nb'<?xml version=\"1.0\" encoding=\"UTF-8\"?>\\n<ListBucketResult xmlns=\"http://s3.amazonaws.com/doc/2006-03-01/\">\\n <Name>cnpg-backups</Name>\\n <IsTruncated>false</IsTruncated>\\n <Delimiter>/</Delimiter>\\n <Prefix>cnpg-cluster-zitadel/base/</Prefix>\\n <MaxKeys>1000</MaxKeys>\\n <CommonPrefixes>\\n <Prefix>cnpg-cluster-zitadel/base/20250319T152145</Prefix>\\n </CommonPrefixes>\\n <CommonPrefixes>\\n <Prefix>cnpg-cluster-zitadel/base/20250319T154154</Prefix>\\n </CommonPrefixes>\\n <CommonPrefixes>\\n <Prefix>cnpg-cluster-zitadel/base/20250319T155715</Prefix>\\n </CommonPrefixes>\\n <EncodingType>url</EncodingType>\\n <KeyCount>3</KeyCount>\\n</ListBucketResult>'\n...\n025-03-20 09:19:47,188 [11] DEBUG: Event after-call.s3.ListObjectsV2: calling handler <function decode_list_object_v2 at 0xffffb875cb80>\n2025-03-20 09:19:47,188 botocore.hooks [DEBUG] Event after-call.s3.ListObjectsV2: calling handler <function decode_list_object_v2 at 0xffffb875cb80>\n2025-03-20 09:19:47,188 [11] ERROR: Barman cloud backup show exception: Unknown backup 'backup-20250319155714' for server 'cnpg-cluster-zitadel'\n2025-03-20 09:19:47,188 root [ERROR] Barman cloud backup show exception: Unknown backup 'backup-20250319155714' for server 'cnpg-cluster-zitadel'\n\n```\nAs you can see the directory names are returned without a trailing / and thus filtered out by pgbarman and in consequence no backups are found and an error is returned. \n\n#### Suggested fix\nI think this should be fixed in the rclone s3 implementation rather than in the client making this (maybe not so smart assumption) because AWS/Ceph S3 (and I guess all others) behave this way. \nI already fixed and tested this locally:\n\n```diff\ndiff --git a/cmd/serve/s3/list.go b/cmd/serve/s3/list.go\nindex 9b0a2e11e..93000907a 100644\n--- a/cmd/serve/s3/list.go\n+++ b/cmd/serve/s3/list.go\n@@ -28,7 +28,8 @@ func (b *s3Backend) entryListR(_vfs *vfs.VFS, bucket, fdPath, name string, addPr\n\n                if entry.IsDir() {\n                        if addPrefix {\n-                               response.AddPrefix(objectPath)\n+                               prefixWithTrailingSlash := objectPath + \"/\"\n+                               response.AddPrefix(prefixWithTrailingSlash)\n                                continue\n                        }\n                        err := b.entryListR(_vfs, bucket, path.Join(fdPath, object), \"\", false, response)\n```\nbut I am not really confident that this fix won't break other things. So I filed an issue rather than a PR to discuss this with somebody that is more in the serve s3 implementation. \n\n<!--- Please keep the note below for others who read your bug report. -->\n\n#### How to use GitHub\n\n* Please use the üëç [reaction](https://blog.github.com/2016-03-10-add-reactions-to-pull-requests-issues-and-comments/) to show that you are affected by the same issue.\n* Please don't comment if you have no relevant information to add. It's just extra noise for everyone subscribed to this issue.\n* Subscribe to receive notifications on status change and new comments.\n","closed_by":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/8464/reactions","total_count":6,"+1":6,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rclone/rclone/issues/8464/timeline","performed_via_github_app":null,"state_reason":"completed"}