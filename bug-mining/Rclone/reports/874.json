{"url":"https://api.github.com/repos/rclone/rclone/issues/1824","repository_url":"https://api.github.com/repos/rclone/rclone","labels_url":"https://api.github.com/repos/rclone/rclone/issues/1824/labels{/name}","comments_url":"https://api.github.com/repos/rclone/rclone/issues/1824/comments","events_url":"https://api.github.com/repos/rclone/rclone/issues/1824/events","html_url":"https://github.com/rclone/rclone/issues/1824","id":273950301,"node_id":"MDU6SXNzdWUyNzM5NTAzMDE=","number":1824,"title":"rclone fails to move small files to s3 buckets with default encryption enabled","user":{"login":"ccoakley","id":5649305,"node_id":"MDQ6VXNlcjU2NDkzMDU=","avatar_url":"https://avatars.githubusercontent.com/u/5649305?v=4","gravatar_id":"","url":"https://api.github.com/users/ccoakley","html_url":"https://github.com/ccoakley","followers_url":"https://api.github.com/users/ccoakley/followers","following_url":"https://api.github.com/users/ccoakley/following{/other_user}","gists_url":"https://api.github.com/users/ccoakley/gists{/gist_id}","starred_url":"https://api.github.com/users/ccoakley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ccoakley/subscriptions","organizations_url":"https://api.github.com/users/ccoakley/orgs","repos_url":"https://api.github.com/users/ccoakley/repos","events_url":"https://api.github.com/users/ccoakley/events{/privacy}","received_events_url":"https://api.github.com/users/ccoakley/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":86399005,"node_id":"MDU6TGFiZWw4NjM5OTAwNQ==","url":"https://api.github.com/repos/rclone/rclone/labels/bug","name":"bug","color":"fc2929","default":true,"description":null},{"id":314138213,"node_id":"MDU6TGFiZWwzMTQxMzgyMTM=","url":"https://api.github.com/repos/rclone/rclone/labels/Remote:%20S3","name":"Remote: S3","color":"fbca04","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/rclone/rclone/milestones/18","html_url":"https://github.com/rclone/rclone/milestone/18","labels_url":"https://api.github.com/repos/rclone/rclone/milestones/18/labels","id":1832726,"node_id":"MDk6TWlsZXN0b25lMTgzMjcyNg==","number":18,"title":"Known Problem","description":"This milestone contains issues which are known problems which are proving difficult to fix, or are awaiting an external fix or we haven't got round to yet.","creator":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":70,"closed_issues":148,"state":"open","created_at":"2016-06-16T16:59:54Z","updated_at":"2025-08-25T17:05:37Z","due_on":null,"closed_at":null},"comments":22,"created_at":"2017-11-14T21:32:06Z","updated_at":"2024-01-03T10:03:16Z","closed_at":"2020-11-25T12:28:47Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Scripts to reproduce this bug can be found here:\r\nhttps://github.com/ccoakley/rclone-kms-s3-test\r\n\r\nWe wanted to make sure it wasn't tied to our particular environment, so the above scripts can be run on a fresh aws account from an admin IAM user (or just follow along and do the steps manually). Note that a _very_ current botocore is required to run the scripts, as this is a rather new feature.\r\n\r\nWe noticed that once we enabled default encryption on s3 buckets, small files failed to move with rclone. Once a file is large enough to transfer via multipart uploads, the problem goes away. Note that the etag for uploaded files is not stable (this can be seen in the debug output for the 3 retries). Tested with current beta.\r\n\r\n**To reproduce**, create an s3 bucket and a kms key. Enable default encryption on the bucket using the new key. Use rclone to move a small (less than 5MB) file to the s3 bucket.\r\n\r\n> What is your rclone version (eg output from `rclone -V`)\r\n\r\nrclone v1.38-095-g413faa99β\r\n- go version: go1.9.2\r\n\r\n> Which OS you are using and how many bits (eg Windows 7, 64 bit)\r\n- os/arch: darwin/amd64\r\n\r\n> Which cloud storage system are you using? (eg Google Drive)\r\n\r\ns3\r\n\r\n> The command you were trying to run (eg `rclone copy /tmp remote:tmp`)\r\n\r\nrclone move\r\n\r\n> A log from the command with the `-vv` flag (eg output from `rclone -vv copy /tmp remote:tmp`)\r\n\r\n```\r\n2017/11/14 13:22:55 DEBUG : Using config file from \"/Users/ccoakley/development/rclone_bug/rclone.conf\"\r\n2017/11/14 13:22:55 DEBUG : rclone: Version \"v1.38-095-g413faa99β\" starting with parameters [\"rclone\" \"-vv\" \"--config\" \"./rclone.conf\" \"move\" \"copy_small.txt\" \"s3:bucket_ec041f5862e945e8a41126f7c6f9256f\"]\r\n2017/11/14 13:22:55 INFO  : S3 bucket bucket_ec041f5862e945e8a41126f7c6f9256f: Modify window is 1s\r\n2017/11/14 13:22:55 DEBUG : .git: Excluded from sync (and deletion)\r\n2017/11/14 13:22:55 DEBUG : .gitignore: Excluded from sync (and deletion)\r\n2017/11/14 13:22:55 DEBUG : cleanup.sh: Excluded from sync (and deletion)\r\n2017/11/14 13:22:55 DEBUG : exercise_bug.sh: Excluded from sync (and deletion)\r\n2017/11/14 13:22:55 DEBUG : finish_setup.py: Excluded from sync (and deletion)\r\n2017/11/14 13:22:55 DEBUG : rclone.conf: Excluded from sync (and deletion)\r\n2017/11/14 13:22:55 DEBUG : README.md: Excluded from sync (and deletion)\r\n2017/11/14 13:22:55 DEBUG : requirements.txt: Excluded from sync (and deletion)\r\n2017/11/14 13:22:55 DEBUG : settings.sh: Excluded from sync (and deletion)\r\n2017/11/14 13:22:55 DEBUG : setup.sh: Excluded from sync (and deletion)\r\n2017/11/14 13:22:55 DEBUG : venv: Excluded from sync (and deletion)\r\n2017/11/14 13:22:55 INFO  : S3 bucket bucket_ec041f5862e945e8a41126f7c6f9256f: Waiting for checks to finish\r\n2017/11/14 13:22:55 INFO  : S3 bucket bucket_ec041f5862e945e8a41126f7c6f9256f: Waiting for transfers to finish\r\n2017/11/14 13:22:55 ERROR : copy_small.txt: corrupted on transfer: MD5 hash differ \"d1a661a9218bd8c35ced78e3cc31db77\" vs \"9bfb495fdac16b31bde2a790d7d98326\"\r\n2017/11/14 13:22:55 INFO  : copy_small.txt: Removing failed copy\r\n2017/11/14 13:22:56 ERROR : copy_small.txt: Not deleting source as copy failed: corrupted on transfer: MD5 hash differ \"d1a661a9218bd8c35ced78e3cc31db77\" vs \"9bfb495fdac16b31bde2a790d7d98326\"\r\n2017/11/14 13:22:56 DEBUG : Local file system at /Users/ccoakley/development/rclone_bug: Removing directory\r\n2017/11/14 13:22:56 DEBUG : Local file system at /Users/ccoakley/development/rclone_bug: Failed to Rmdir: remove /Users/ccoakley/development/rclone_bug: directory not empty\r\n2017/11/14 13:22:56 ERROR : Attempt 1/3 failed with 1 errors and: corrupted on transfer: MD5 hash differ \"d1a661a9218bd8c35ced78e3cc31db77\" vs \"9bfb495fdac16b31bde2a790d7d98326\"\r\n2017/11/14 13:22:56 DEBUG : .git: Excluded from sync (and deletion)\r\n2017/11/14 13:22:56 DEBUG : .gitignore: Excluded from sync (and deletion)\r\n2017/11/14 13:22:56 DEBUG : cleanup.sh: Excluded from sync (and deletion)\r\n2017/11/14 13:22:56 DEBUG : exercise_bug.sh: Excluded from sync (and deletion)\r\n2017/11/14 13:22:56 DEBUG : finish_setup.py: Excluded from sync (and deletion)\r\n2017/11/14 13:22:56 DEBUG : rclone.conf: Excluded from sync (and deletion)\r\n2017/11/14 13:22:56 DEBUG : README.md: Excluded from sync (and deletion)\r\n2017/11/14 13:22:56 DEBUG : requirements.txt: Excluded from sync (and deletion)\r\n2017/11/14 13:22:56 DEBUG : settings.sh: Excluded from sync (and deletion)\r\n2017/11/14 13:22:56 DEBUG : setup.sh: Excluded from sync (and deletion)\r\n2017/11/14 13:22:56 DEBUG : venv: Excluded from sync (and deletion)\r\n2017/11/14 13:22:56 INFO  : S3 bucket bucket_ec041f5862e945e8a41126f7c6f9256f: Waiting for checks to finish\r\n2017/11/14 13:22:56 INFO  : S3 bucket bucket_ec041f5862e945e8a41126f7c6f9256f: Waiting for transfers to finish\r\n2017/11/14 13:22:56 ERROR : copy_small.txt: corrupted on transfer: MD5 hash differ \"d1a661a9218bd8c35ced78e3cc31db77\" vs \"0721aafabcc75dfd2e8477d00bf556e2\"\r\n2017/11/14 13:22:56 INFO  : copy_small.txt: Removing failed copy\r\n2017/11/14 13:22:56 ERROR : copy_small.txt: Not deleting source as copy failed: corrupted on transfer: MD5 hash differ \"d1a661a9218bd8c35ced78e3cc31db77\" vs \"0721aafabcc75dfd2e8477d00bf556e2\"\r\n2017/11/14 13:22:56 DEBUG : Local file system at /Users/ccoakley/development/rclone_bug: Removing directory\r\n2017/11/14 13:22:56 DEBUG : Local file system at /Users/ccoakley/development/rclone_bug: Failed to Rmdir: remove /Users/ccoakley/development/rclone_bug: directory not empty\r\n2017/11/14 13:22:56 ERROR : Attempt 2/3 failed with 1 errors and: corrupted on transfer: MD5 hash differ \"d1a661a9218bd8c35ced78e3cc31db77\" vs \"0721aafabcc75dfd2e8477d00bf556e2\"\r\n2017/11/14 13:22:56 DEBUG : .git: Excluded from sync (and deletion)\r\n2017/11/14 13:22:56 DEBUG : .gitignore: Excluded from sync (and deletion)\r\n2017/11/14 13:22:56 DEBUG : cleanup.sh: Excluded from sync (and deletion)\r\n2017/11/14 13:22:56 DEBUG : exercise_bug.sh: Excluded from sync (and deletion)\r\n2017/11/14 13:22:56 DEBUG : finish_setup.py: Excluded from sync (and deletion)\r\n2017/11/14 13:22:56 DEBUG : rclone.conf: Excluded from sync (and deletion)\r\n2017/11/14 13:22:56 DEBUG : README.md: Excluded from sync (and deletion)\r\n2017/11/14 13:22:56 DEBUG : requirements.txt: Excluded from sync (and deletion)\r\n2017/11/14 13:22:56 DEBUG : settings.sh: Excluded from sync (and deletion)\r\n2017/11/14 13:22:56 DEBUG : setup.sh: Excluded from sync (and deletion)\r\n2017/11/14 13:22:56 DEBUG : venv: Excluded from sync (and deletion)\r\n2017/11/14 13:22:56 INFO  : S3 bucket bucket_ec041f5862e945e8a41126f7c6f9256f: Waiting for checks to finish\r\n2017/11/14 13:22:56 INFO  : S3 bucket bucket_ec041f5862e945e8a41126f7c6f9256f: Waiting for transfers to finish\r\n2017/11/14 13:22:56 ERROR : copy_small.txt: corrupted on transfer: MD5 hash differ \"d1a661a9218bd8c35ced78e3cc31db77\" vs \"05c0d3de94e16831b9922aba416018f4\"\r\n2017/11/14 13:22:56 INFO  : copy_small.txt: Removing failed copy\r\n2017/11/14 13:22:57 ERROR : copy_small.txt: Not deleting source as copy failed: corrupted on transfer: MD5 hash differ \"d1a661a9218bd8c35ced78e3cc31db77\" vs \"05c0d3de94e16831b9922aba416018f4\"\r\n2017/11/14 13:22:57 DEBUG : Local file system at /Users/ccoakley/development/rclone_bug: Removing directory\r\n2017/11/14 13:22:57 DEBUG : Local file system at /Users/ccoakley/development/rclone_bug: Failed to Rmdir: remove /Users/ccoakley/development/rclone_bug: directory not empty\r\n2017/11/14 13:22:57 ERROR : Attempt 3/3 failed with 1 errors and: corrupted on transfer: MD5 hash differ \"d1a661a9218bd8c35ced78e3cc31db77\" vs \"05c0d3de94e16831b9922aba416018f4\"\r\n2017/11/14 13:22:57 Failed to move: corrupted on transfer: MD5 hash differ \"d1a661a9218bd8c35ced78e3cc31db77\" vs \"05c0d3de94e16831b9922aba416018f4\"\r\n```\r\n","closed_by":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/1824/reactions","total_count":4,"+1":3,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":1,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rclone/rclone/issues/1824/timeline","performed_via_github_app":null,"state_reason":"completed"}