{"url":"https://api.github.com/repos/rclone/rclone/issues/6190","repository_url":"https://api.github.com/repos/rclone/rclone","labels_url":"https://api.github.com/repos/rclone/rclone/issues/6190/labels{/name}","comments_url":"https://api.github.com/repos/rclone/rclone/issues/6190/comments","events_url":"https://api.github.com/repos/rclone/rclone/issues/6190/events","html_url":"https://github.com/rclone/rclone/issues/6190","id":1244338022,"node_id":"I_kwDOAQ-n5M5KKxdm","number":6190,"title":"fatal error: sync: unlock of unlocked mutex on mounted encrypted union of Google Drives","user":{"login":"inquam","id":1265038,"node_id":"MDQ6VXNlcjEyNjUwMzg=","avatar_url":"https://avatars.githubusercontent.com/u/1265038?v=4","gravatar_id":"","url":"https://api.github.com/users/inquam","html_url":"https://github.com/inquam","followers_url":"https://api.github.com/users/inquam/followers","following_url":"https://api.github.com/users/inquam/following{/other_user}","gists_url":"https://api.github.com/users/inquam/gists{/gist_id}","starred_url":"https://api.github.com/users/inquam/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/inquam/subscriptions","organizations_url":"https://api.github.com/users/inquam/orgs","repos_url":"https://api.github.com/users/inquam/repos","events_url":"https://api.github.com/users/inquam/events{/privacy}","received_events_url":"https://api.github.com/users/inquam/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":86399005,"node_id":"MDU6TGFiZWw4NjM5OTAwNQ==","url":"https://api.github.com/repos/rclone/rclone/labels/bug","name":"bug","color":"fc2929","default":true,"description":null},{"id":430778096,"node_id":"MDU6TGFiZWw0MzA3NzgwOTY=","url":"https://api.github.com/repos/rclone/rclone/labels/VFS%20/%20mount","name":"VFS / mount","color":"0e8a16","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":10,"created_at":"2022-05-22T18:54:50Z","updated_at":"2022-06-21T16:13:08Z","closed_at":"2022-06-21T13:30:01Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"#### What is the problem you are having with rclone?\r\n\r\nI have rclone mouting an encrypted union of Google Drives. A main account with shared team drives that other accounts has been given access to and used to balance writes to stretch the upload quota limit. This has worked fine for a long time but recently it started failing after a while.\r\n\r\nThe mount is mounted using\r\n\r\n```\r\n/usr/bin/rclone mount \\\r\n--allow-other \\\r\n--file-perms 0777 \\\r\n--dir-perms 0777 \\\r\n--drive-server-side-across-configs \\\r\n# Google Drive is a polling remote so this value can be set very high and any changes are detected via polling.\r\n--dir-cache-time 1000h \\\r\n--attr-timeout 1000h \\\r\n--vfs-read-chunk-size 128M \\\r\n--vfs-read-chunk-size-limit off \\\r\n--drive-skip-gdocs \\\r\n--timeout 1h \\\r\n--tpslimit 10 \\\r\n--tpslimit-burst 10 \\\r\n--transfers 24 \\\r\n--drive-chunk-size=\"128M\" \\\r\n# Reduce the poll interval down to 15 seconds as this makes changes appear faster\r\n--poll-interval 15s \\\r\n# This sets up the remote control daemon so you can issue rc commands locally\r\n--rc \\\r\n# This is the default port it runs on\r\n--rc-addr :5576 \\\r\n# no-auth is used as no one else uses my server and it is not a shared seedbox\r\n--rc-no-auth \\\r\n# The local disk used for caching\r\n--cache-dir=/dev/shm/gdrive-shared-union-encrypted/vfs \\\r\n# This is used for caching files to local disk for streaming\r\n--vfs-cache-mode full \\\r\n# This limits the cache size to the value below\r\n--vfs-cache-max-size 15G \\\r\n# This limits the age in the cache if the size is reached and it removes the oldest files first\r\n--vfs-cache-max-age 1h \\\r\n\"my-gdrive-shared-union-encrypted:\" \\\r\n\"/mnt/gdrive\"\r\n```\r\n\r\nConfig of the remotes are\r\n\r\n```\r\n[my-gdrive-shared-union]\r\ntype = union\r\nscope = drive\r\nroot_folder_id =\r\nupstreams = my-gdrive:/encrypted my-gdrive-shared: my-gdrive-shared-c1: my-gdrive-shared-c2: my-gdrive-shared-c3:\r\nsearch_policy = ff\r\ncreate_policy = rand\r\naction_policy = rand\r\n\r\n[my-gdrive]\r\ntype = drive\r\nclient_id = *redacted*\r\nclient_secret = *redacted*\r\nscope = drive\r\ntoken = *redacted*\r\nroot_folder_id = *redacted*\r\nserver_side_across_configs = true\r\n\r\n[my-gdrive-encrypted]\r\ntype = crypt\r\nremote = my-gdrive:/encrypted\r\nfilename_encryption = standard\r\ndirectory_name_encryption = true\r\npassword = *redacted*\r\npassword2 = *redacted*\r\nserver_side_across_configs = true\r\n\r\n[my-gdrive-shared-union-encrypted]\r\ntype = crypt\r\nremote = my-gdrive-shared-union:\r\nfilename_encryption = standard\r\ndirectory_name_encryption = true\r\npassword = *redacted*\r\npassword2 = *redacted*\r\n\r\n[my-gdrive-shared]\r\ntype = drive\r\nclient_id = *redacted*\r\nclient_secret = *redacted*\r\nscope = drive\r\ntoken = *redacted*\r\nteam_drive = *redacted*\r\nroot_folder_id =\r\nserver_side_across_configs = true\r\n\r\n[my-gdrive-shared-c1]\r\ntype = drive\r\nclient_id = *redacted*\r\nclient_secret = *redacted*\r\nscope = drive\r\ntoken = *redacted*\r\nteam_drive = *redacted*\r\nroot_folder_id =\r\nserver_side_across_configs = true\r\n\r\n[my-gdrive-shared-c2]\r\ntype = drive\r\nclient_id = *redacted*\r\nclient_secret = *redacted*\r\nscope = drive\r\ntoken = *redacted*\r\nteam_drive = *redacted*\r\nroot_folder_id =\r\nserver_side_across_configs = true\r\n\r\n[my-gdrive-shared-c3]\r\ntype = drive\r\nclient_id = *redacted*\r\nclient_secret = *redacted*\r\nscope = drive\r\ntoken = *redacted*\r\nteam_drive = *redacted*\r\nroot_folder_id =\r\nserver_side_across_configs = true\r\n```\r\n\r\nThe log file contains what looks like a call trace with references to go functions.\r\n\r\n```\r\nfatal error: sync: unlock of unlocked mutex\r\n\r\ngoroutine 22668129 [running]:\r\nruntime.throw({0x1b378c8, 0x20})\r\n        runtime/panic.go:1198 +0x71 fp=0xc00146f438 sp=0xc00146f408 pc=0x4358b1\r\nsync.throw({0x1b378c8, 0x20})\r\n        runtime/panic.go:1184 +0x1e fp=0xc00146f458 sp=0xc00146f438 pc=0x463f7e\r\nsync.(*Mutex).unlockSlow(0xc0242ec460, 0xffffffff)\r\n        sync/mutex.go:196 +0x3c fp=0xc00146f480 sp=0xc00146f458 pc=0x47341c\r\nsync.(*Mutex).Unlock(0xc00146f4c8)\r\n        sync/mutex.go:190 +0x29 fp=0xc00146f4a0 sp=0xc00146f480 pc=0x4733a9\r\ngithub.com/rclone/rclone/vfs.(*RWFileHandle).ReadAt¬∑dwrap¬∑55()\r\n        github.com/rclone/rclone/vfs/read_write.go:277 +0x26 fp=0xc00146f4b8 sp=0xc00146f4a0 pc=0x1503486\r\nruntime.deferCallSave(0xc00146f5c0, 0xc00146f998)\r\n        runtime/panic.go:950 +0x82 fp=0xc00146f4c8 sp=0xc00146f4b8 pc=0x435042\r\nruntime.runOpenDeferFrame(0xc00146f850, 0xc017928640)\r\n        runtime/panic.go:889 +0x27b fp=0xc00146f548 sp=0xc00146f4c8 pc=0x4349db\r\npanic({0x173cfc0, 0x1eb7480})\r\n        runtime/panic.go:1038 +0x215 fp=0xc00146f608 sp=0xc00146f548 pc=0x4352b5\r\ngithub.com/rclone/rclone/vfs/vfscache/downloaders.New({0x1f077f8, 0xc0302cad20}, 0xc0006781f8, {0xc00bca7900, 0x80}, {0x0, 0x0})\r\n        github.com/rclone/rclone/vfs/vfscache/downloaders/downloaders.go:106 +0x22a fp=0xc00146f650 sp=0xc00146f608 pc=0x14ddcaa\r\ngithub.com/rclone/rclone/vfs/vfscache.(*Item)._ensure(0xc0302cad20, 0x3d4d0000, 0xc032808740)\r\n        github.com/rclone/rclone/vfs/vfscache/item.go:1134 +0x299 fp=0xc00146f718 sp=0xc00146f650 pc=0x14ecff9\r\ngithub.com/rclone/rclone/vfs/vfscache.(*Item).readAt(0xc0302cad20, {0xc05a53a000, 0x20000, 0x20000}, 0x3d4d0000)\r\n        github.com/rclone/rclone/vfs/vfscache/item.go:1247 +0x137 fp=0xc00146f790 sp=0xc00146f718 pc=0x14edc97\r\ngithub.com/rclone/rclone/vfs/vfscache.(*Item).ReadAt(0xc0302cad20, {0xc05a53a000, 0x20000, 0x20000}, 0xc0328088c0)\r\n        github.com/rclone/rclone/vfs/vfscache/item.go:1212 +0x105 fp=0xc00146f810 sp=0xc00146f790 pc=0x14ed8c5\r\ngithub.com/rclone/rclone/vfs.(*RWFileHandle)._readAt(0xc0242ec440, {0xc05a53a000, 0x7f3719964418, 0x20000}, 0x3d4d0000, 0x1)\r\n        github.com/rclone/rclone/vfs/read_write.go:266 +0x415 fp=0xc00146f930 sp=0xc00146f810 pc=0x1503035\r\ngithub.com/rclone/rclone/vfs.(*RWFileHandle).ReadAt(0x1a84520, {0xc05a53a000, 0x1b118d5, 0x11}, 0xc032808a70)\r\n        github.com/rclone/rclone/vfs/read_write.go:278 +0xf3 fp=0xc00146f9c0 sp=0xc00146f930 pc=0x15033b3\r\ngithub.com/rclone/rclone/cmd/mount.(*FileHandle).Read(0xc02620cdb0, {0x1a84520, 0xc02620cdb0}, 0xc011db42a0, 0xc019e10528)\r\n        github.com/rclone/rclone/cmd/mount/handle.go:29 +0x234 fp=0xc00146fae0 sp=0xc00146f9c0 pc=0x1518594\r\n\t\tbazil.org/fuse/fs.(*Server).handleRequest(0xc00037e0e0, {0x1f203b0, 0xc02edd1940}, {0x1ee3cc0, 0xc02681eee0}, 0xc035bf1b00, {0x1f01f48, 0xc011db42a0}, 0xc00146ff08)\r\n        bazil.org/fuse@v0.0.0-20200524192727-fb710f7dfd05/fs/serve.go:1418 +0xdb7 fp=0xc00146fde0 sp=0xc00146fae0 pc=0x14d3397\r\nbazil.org/fuse/fs.(*Server).serve(0xc00037e0e0, {0x1f01f48, 0xc011db42a0})\r\n        bazil.org/fuse@v0.0.0-20200524192727-fb710f7dfd05/fs/serve.go:1015 +0x62c fp=0xc00146ff98 sp=0xc00146fde0 pc=0x14d1e8c\r\nbazil.org/fuse/fs.(*Server).Serve.func1()\r\n        bazil.org/fuse@v0.0.0-20200524192727-fb710f7dfd05/fs/serve.go:512 +0x69 fp=0xc00146ffe0 sp=0xc00146ff98 pc=0x14cf1a9\r\nruntime.goexit()\r\n        runtime/asm_amd64.s:1581 +0x1 fp=0xc00146ffe8 sp=0xc00146ffe0 pc=0x469281\r\ncreated by bazil.org/fuse/fs.(*Server).Serve\r\n        bazil.org/fuse@v0.0.0-20200524192727-fb710f7dfd05/fs/serve.go:510 +0x3c5\r\n\r\ngoroutine 1 [select, 103 minutes]:\r\ngithub.com/rclone/rclone/cmd/mountlib.(*MountPoint).Wait(0xc0005ddc80)\r\n        github.com/rclone/rclone/cmd/mountlib/mount.go:298 +0x285\r\ngithub.com/rclone/rclone/cmd/mountlib.NewMountCommand.func1(0xc000422000, {0xc000022c00, 0x2e, 0x30})\r\n        github.com/rclone/rclone/cmd/mountlib/mount.go:187 +0x2b8\r\ngithub.com/spf13/cobra.(*Command).execute(0xc000422000, {0xc000022900, 0x2e, 0x30})\r\n        github.com/spf13/cobra@v1.2.1/command.go:860 +0x5f8\r\ngithub.com/spf13/cobra.(*Command).ExecuteC(0x2ceae40)\r\n        github.com/spf13/cobra@v1.2.1/command.go:974 +0x3bc\r\ngithub.com/spf13/cobra.(*Command).Execute(...)\r\n        github.com/spf13/cobra@v1.2.1/command.go:902\r\ngithub.com/rclone/rclone/cmd.Main()\r\n        github.com/rclone/rclone/cmd/cmd.go:553 +0x76\r\nmain.main()\r\n        github.com/rclone/rclone/rclone.go:14 +0x17\r\n\r\ngoroutine 6 [select, 1 minutes]:\r\ngo.opencensus.io/stats/view.(*worker).start(0xc0001b9880)\r\n        go.opencensus.io@v0.23.0/stats/view/worker.go:276 +0xb9\r\ncreated by go.opencensus.io/stats/view.init.0\r\n        go.opencensus.io@v0.23.0/stats/view/worker.go:34 +0x92\r\nbazil.org/fuse/fs.(*Server).handleRequest(0xc00037e0e0, {0x1f203b0, 0xc02edd1940}, {0x1ee3cc0, 0xc02681eee0}, 0xc035bf1b00, {0x1f01f48, 0xc011db42a0}, 0xc00146ff08)\r\n        bazil.org/fuse@v0.0.0-20200524192727-fb710f7dfd05/fs/serve.go:1418 +0xdb7 fp=0xc00146fde0 sp=0xc00146fae0 pc=0x14d3397\r\nbazil.org/fuse/fs.(*Server).serve(0xc00037e0e0, {0x1f01f48, 0xc011db42a0})\r\n        bazil.org/fuse@v0.0.0-20200524192727-fb710f7dfd05/fs/serve.go:1015 +0x62c fp=0xc00146ff98 sp=0xc00146fde0 pc=0x14d1e8c\r\nbazil.org/fuse/fs.(*Server).Serve.func1()\r\n        bazil.org/fuse@v0.0.0-20200524192727-fb710f7dfd05/fs/serve.go:512 +0x69 fp=0xc00146ffe0 sp=0xc00146ff98 pc=0x14cf1a9\r\nruntime.goexit()\r\n        runtime/asm_amd64.s:1581 +0x1 fp=0xc00146ffe8 sp=0xc00146ffe0 pc=0x469281\r\ncreated by bazil.org/fuse/fs.(*Server).Serve\r\n        bazil.org/fuse@v0.0.0-20200524192727-fb710f7dfd05/fs/serve.go:510 +0x3c5\r\n\r\n... (goes on and on and on for many, many lines... Seems to be repeating though)\r\n```\r\n\r\n#### What is your rclone version (output from `rclone version`)\r\n\r\nrclone v1.58.1\r\n- os/version: ubuntu 20.04 (64 bit)\r\n- os/kernel: 5.4.0-110-generic (x86_64)\r\n- os/type: linux\r\n- os/arch: amd64\r\n- go/version: go1.17.9\r\n- go/linking: static\r\n- go/tags: none\r\n\r\n\r\n#### Which OS you are using and how many bits (e.g. Windows 7, 64 bit)\r\n\r\nLinux daserver 5.4.0-110-generic #124-Ubuntu SMP Thu Apr 14 19:46:19 UTC 2022 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n#### Which cloud storage system are you using? (e.g. Google Drive)\r\n\r\nGoogle Drive through an rclone union\r\n\r\n#### The command you were trying to run (e.g. `rclone copy /tmp remote:tmp`)\r\n\r\nMounted rclone union fails after a while and directory can't be listed, uploaded to etc. Sais the endpoint isn't connected anymore.\r\n\r\n#### A log from the command with the `-vv` flag (e.g. output from `rclone -vv copy /tmp remote:tmp`)\r\n\r\n```\r\nrclone -vv copy TESTFILE my-gdrive-shared-union-encrypted:\r\n2022/05/22 20:47:26 DEBUG : rclone: Version \"v1.58.1\" starting with parameters [\"rclone\" \"-vv\" \"copy\" \"TESTFILE\" \"my-gdrive-shared-union-encrypted:\"]\r\n2022/05/22 20:47:26 DEBUG : Creating backend with remote \"TESTFILE\"\r\n2022/05/22 20:47:26 DEBUG : Using config file from \"/root/.config/rclone/rclone.conf\"\r\n2022/05/22 20:47:26 DEBUG : fs cache: adding new entry for parent of \"TESTFILE\", \"/home/foo\"\r\n2022/05/22 20:47:26 DEBUG : Creating backend with remote \"my-gdrive-shared-union-encrypted:\"\r\n2022/05/22 20:47:26 DEBUG : Creating backend with remote \"my-gdrive-shared-union:\"\r\n2022/05/22 20:47:26 DEBUG : Creating backend with remote \"my-gdrive-shared-c3:\"\r\n2022/05/22 20:47:26 DEBUG : Creating backend with remote \"my-gdrive-shared:\"\r\n2022/05/22 20:47:26 DEBUG : Creating backend with remote \"my-gdrive:/encrypted\"\r\n2022/05/22 20:47:26 DEBUG : Creating backend with remote \"my-gdrive-shared-c1:\"\r\n2022/05/22 20:47:26 DEBUG : Creating backend with remote \"my-gdrive-shared-c2:\"\r\n2022/05/22 20:47:27 DEBUG : fs cache: renaming cache item \"my-gdrive:/encrypted\" to be canonical \"my-gdrive:encrypted\"\r\n2022/05/22 20:47:27 DEBUG : fs cache: switching user supplied name \"my-gdrive:/encrypted\" for canonical name \"my-gdrive:encrypted\"\r\n2022/05/22 20:47:27 DEBUG : union root '': actionPolicy = *policy.Rand, createPolicy = *policy.Rand, searchPolicy = *policy.FF\r\n2022/05/22 20:47:27 DEBUG : TESTFILE: Need to transfer - File not found at Destination\r\n2022/05/22 20:47:28 DEBUG : pacer: low level retry 1/1 (error googleapi: Error 403: User rate limit exceeded., userRateLimitExceeded)\r\n2022/05/22 20:47:28 DEBUG : pacer: Rate limited, increasing sleep to 1.535163973s\r\n2022/05/22 20:47:28 DEBUG : TESTFILE: Received error: googleapi: Error 403: User rate limit exceeded., userRateLimitExceeded - low level retry 1/10\r\n2022/05/22 20:47:28 DEBUG : pacer: Reducing sleep to 0s\r\n2022/05/22 20:47:30 DEBUG : TESTFILE: md5 = 0c936ad6113b83828330b873e1200182 OK\r\n2022/05/22 20:47:30 INFO  : TESTFILE: Copied (new)\r\n2022/05/22 20:47:30 INFO  :\r\nTransferred:             64 B / 64 B, 100%, 31 B/s, ETA 0s\r\nTransferred:            1 / 1, 100%\r\nElapsed time:         3.5s\r\n\r\n2022/05/22 20:47:30 DEBUG : 13 go routines active\r\n```\r\n\r\n\r\n\r\n...\r\n\r\n\r\n#### How to use GitHub\r\n\r\n* Please use the üëç [reaction](https://blog.github.com/2016-03-10-add-reactions-to-pull-requests-issues-and-comments/) to show that you are affected by the same issue.\r\n* Please don't comment if you have no relevant information to add. It's just extra noise for everyone subscribed to this issue.\r\n* Subscribe to receive notifications on status change and new comments.\r\n","closed_by":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/6190/reactions","total_count":3,"+1":3,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rclone/rclone/issues/6190/timeline","performed_via_github_app":null,"state_reason":"completed"}