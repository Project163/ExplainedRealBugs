{"url":"https://api.github.com/repos/rclone/rclone/issues/5765","repository_url":"https://api.github.com/repos/rclone/rclone","labels_url":"https://api.github.com/repos/rclone/rclone/issues/5765/labels{/name}","comments_url":"https://api.github.com/repos/rclone/rclone/issues/5765/comments","events_url":"https://api.github.com/repos/rclone/rclone/issues/5765/events","html_url":"https://github.com/rclone/rclone/issues/5765","id":1038650289,"node_id":"I_kwDOAQ-n5M496Iux","number":5765,"title":"GCP with composite objects to S3 with object-lock enabled doesn't work","user":{"login":"paulopontesm","id":3610528,"node_id":"MDQ6VXNlcjM2MTA1Mjg=","avatar_url":"https://avatars.githubusercontent.com/u/3610528?v=4","gravatar_id":"","url":"https://api.github.com/users/paulopontesm","html_url":"https://github.com/paulopontesm","followers_url":"https://api.github.com/users/paulopontesm/followers","following_url":"https://api.github.com/users/paulopontesm/following{/other_user}","gists_url":"https://api.github.com/users/paulopontesm/gists{/gist_id}","starred_url":"https://api.github.com/users/paulopontesm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/paulopontesm/subscriptions","organizations_url":"https://api.github.com/users/paulopontesm/orgs","repos_url":"https://api.github.com/users/paulopontesm/repos","events_url":"https://api.github.com/users/paulopontesm/events{/privacy}","received_events_url":"https://api.github.com/users/paulopontesm/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":173668299,"node_id":"MDU6TGFiZWwxNzM2NjgyOTk=","url":"https://api.github.com/repos/rclone/rclone/labels/doc%20fix","name":"doc fix","color":"f0b040","default":false,"description":""},{"id":306063008,"node_id":"MDU6TGFiZWwzMDYwNjMwMDg=","url":"https://api.github.com/repos/rclone/rclone/labels/Remote:%20Google%20Cloud%20Storage","name":"Remote: Google Cloud Storage","color":"fbca04","default":false,"description":null},{"id":314138213,"node_id":"MDU6TGFiZWwzMTQxMzgyMTM=","url":"https://api.github.com/repos/rclone/rclone/labels/Remote:%20S3","name":"Remote: S3","color":"fbca04","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2021-10-28T15:24:52Z","updated_at":"2022-01-25T16:10:58Z","closed_at":"2022-01-25T16:10:58Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"#### What is the problem you are having with rclone?\r\n\r\nIt might be a bit of an edge case, but I am trying to copy composite objects from GCP to an S3 bucket with object-lock enabled.\r\n\r\nThis is where I got so far:\r\n\r\n* Looking at google's [documentation for composite objects](https://cloud.google.com/storage/docs/composite-objects), I can see this:\r\n\r\n    > Composite objects do not have an MD5 hash metadata field.\r\n\r\n* According to AWS's docs \r\n\r\n   >  The Content-MD5 header is required for any request to upload an object with a retention period configured using Amazon S3 Object Lock. For more information about Amazon S3 Object Lock, see Amazon S3 Object Lock Overview in the Amazon S3 User Guide.\r\n\r\nI've tracked down the problem to this line so far:\r\n\r\nhttps://github.com/rclone/rclone/blob/master/backend/googlecloudstorage/googlecloudstorage.go#L914\r\n\r\nFor composite objects, that returns an empty hash, and it is propagated all the way up to the S3 put.\r\n\r\n#### What is your rclone version (output from `rclone version`)\r\n\r\n```bash\r\n‚úó rclone --version\r\nrclone v1.56.2\r\n- os/version: darwin 12.0.1 (64 bit)\r\n- os/kernel: 21.1.0 (x86_64)\r\n- os/type: darwin\r\n- os/arch: amd64\r\n- go/version: go1.17.2\r\n- go/linking: dynamic\r\n- go/tags: none\r\n```\r\n\r\n#### Which OS you are using and how many bits (e.g. Windows 7, 64 bit)\r\n\r\nMacOS\r\n\r\n#### Which cloud storage system are you using? (e.g. Google Drive)\r\n\r\nGCP to S3\r\n\r\n#### The command you were trying to run (e.g. `rclone copy /tmp remote:tmp`)\r\n\r\n```\r\nrclone --s3-server-side-encryption \"aws:kms\" --s3-sse-kms-key-id \"{arn_kms_key}\" --config rclone.conf copy gcs:{source_bucket}/{composite_object_name} s3://{target_s3_bucket_with_object_lock}\r\n\r\n2021-10-28 15:24:18 ERROR : {composite_object_name}: Failed to copy: s3 upload: 400 Bad Request: <?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n<Error><Code>InvalidRequest</Code><Message>Content-MD5 HTTP header is required for Put Object requests with Object Lock parameters</Message><RequestId>xxxx</RequestId><HostId>xxxx</HostId></Error>\r\n```\r\n\r\n```\r\n# rclone.conf\r\n[gcs]\r\ntype = google cloud storage\r\nproject_number = {project_number}\r\n\r\n[s3]\r\ntype = s3\r\nprovider = AWS\r\nenv_auth = true\r\n```\r\n\r\n<!--- Please keep the note below for others who read your bug report. -->\r\n\r\n#### How to use GitHub\r\n\r\n* Please use the üëç [reaction](https://blog.github.com/2016-03-10-add-reactions-to-pull-requests-issues-and-comments/) to show that you are affected by the same issue.\r\n* Please don't comment if you have no relevant information to add. It's just extra noise for everyone subscribed to this issue.\r\n* Subscribe to receive notifications on status change and new comments.","closed_by":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/5765/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rclone/rclone/issues/5765/timeline","performed_via_github_app":null,"state_reason":"completed"}