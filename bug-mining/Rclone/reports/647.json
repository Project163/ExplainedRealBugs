{"url":"https://api.github.com/repos/rclone/rclone/issues/3307","repository_url":"https://api.github.com/repos/rclone/rclone","labels_url":"https://api.github.com/repos/rclone/rclone/issues/3307/labels{/name}","comments_url":"https://api.github.com/repos/rclone/rclone/issues/3307/comments","events_url":"https://api.github.com/repos/rclone/rclone/issues/3307/events","html_url":"https://github.com/rclone/rclone/issues/3307","id":462050130,"node_id":"MDU6SXNzdWU0NjIwNTAxMzA=","number":3307,"title":"Azure blob integration tests broken by context propagation","user":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":86399005,"node_id":"MDU6TGFiZWw4NjM5OTAwNQ==","url":"https://api.github.com/repos/rclone/rclone/labels/bug","name":"bug","color":"fc2929","default":true,"description":null},{"id":1043114791,"node_id":"MDU6TGFiZWwxMDQzMTE0Nzkx","url":"https://api.github.com/repos/rclone/rclone/labels/Remote:%20Azure%20Blob","name":"Remote: Azure Blob","color":"fbca04","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/rclone/rclone/milestones/36","html_url":"https://github.com/rclone/rclone/milestone/36","labels_url":"https://api.github.com/repos/rclone/rclone/milestones/36/labels","id":4231972,"node_id":"MDk6TWlsZXN0b25lNDIzMTk3Mg==","number":36,"title":"v1.49","description":"","creator":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":18,"state":"closed","created_at":"2019-04-15T17:12:48Z","updated_at":"2019-08-27T09:35:39Z","due_on":"2019-08-24T07:00:00Z","closed_at":"2019-08-27T09:35:39Z"},"comments":2,"created_at":"2019-06-28T14:01:54Z","updated_at":"2019-07-01T10:52:27Z","closed_at":"2019-07-01T10:51:52Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Eg https://pub.rclone.org/integration-tests/2019-06-28-050155/\r\n\r\nSee https://pub.rclone.org/integration-tests/current for the most recent\r\n\r\n![image](https://user-images.githubusercontent.com/536803/60346073-4e654980-99b2-11e9-9d5f-33f23aa0cc93.png)\r\n\r\nThese all appear to have something to do with renaming directories...\r\n\r\nAccording to git bisect this was the commit which broke it f78cd1e0434ee597fb8937ba3cda0d5fd58becfe\r\n\r\nThis added context into the interface and passed the context on to the AzureBlob SDK which doesn't look as if it should have broken anything.\r\n\r\nThe error is this\r\n\r\n```\r\n$ ( cd fs/operations && go test -v -remote TestAzureBlob: -run TestDirMove -verbose )\r\n=== RUN   TestDirMove\r\n2019/06/28 14:53:16 DEBUG : A1/B2: Making directory\r\n2019/06/28 14:53:16 DEBUG : A1/B1/C3: Making directory\r\n2019/06/28 14:53:16 INFO  : A1/B1/three: Copied (server side copy)\r\n2019/06/28 14:53:16 INFO  : A1/one: Copied (server side copy)\r\n2019/06/28 14:53:16 INFO  : A1/two: Copied (server side copy)\r\n2019/06/28 14:53:16 INFO  : A1/B1/C1/four: Copied (server side copy)\r\n2019/06/28 14:53:16 INFO  : A1/B1/three: Deleted\r\n2019/06/28 14:53:16 INFO  : A1/one: Deleted\r\n2019/06/28 14:53:16 INFO  : A1/two: Deleted\r\n2019/06/28 14:53:16 INFO  : A1/B1/C1/four: Deleted\r\n2019/06/28 14:53:16 INFO  : A1/B1/C2/five: Copied (server side copy)\r\n2019/06/28 14:53:16 INFO  : A1/B1/C2/five: Deleted\r\n--- FAIL: TestDirMove (0.44s)\r\n    run.go:172: Remote \"Azure container rclone-test-jiganin7cujuvex3zahebab9\", Local \"Local file system at /tmp/rclone881171044\", Modify Window \"1ns\"\r\n    fstest.go:260: Filtering empty directory \"A1/B2\"\r\n    fstest.go:260: Filtering empty directory \"A1/B1/C3\"\r\n    require.go:794: \r\n        \tError Trace:\toperations_test.go:1168\r\n        \tError:      \tReceived unexpected error:\r\n        \t            \t-> github.com/ncw/rclone/vendor/github.com/Azure/azure-pipeline-go/pipeline.NewError, /home/ncw/go/src/github.com/ncw/rclone/vendor/github.com/Azure/azure-pipeline-go/pipeline/error.go:154\r\n        \t            \tHTTP request failed\r\n        \t            \t\r\n        \t            \tGet https://rclone.blob.core.windows.net/rclone-test-jiganin7cujuvex3zahebab9?comp=list&delimiter=&include=metadata&maxresults=1&prefix=A1%2FB1%2FC2%2F&restype=container&timeout=31536001: context canceled\r\n        \t            \t\r\n        \t            \tRenameDir rmdir\r\n        \t            \tgithub.com/ncw/rclone/fs/operations.DirMove\r\n        \t            \t\t/home/ncw/go/src/github.com/ncw/rclone/fs/operations/operations.go:1802\r\n        \t            \tgithub.com/ncw/rclone/fs/operations_test.TestDirMove\r\n        \t            \t\t/home/ncw/go/src/github.com/ncw/rclone/fs/operations/operations_test.go:1168\r\n        \t            \ttesting.tRunner\r\n        \t            \t\t/opt/go/go1.12/src/testing/testing.go:865\r\n        \t            \truntime.goexit\r\n        \t            \t\t/opt/go/go1.12/src/runtime/asm_amd64.s:1337\r\n        \tTest:       \tTestDirMove\r\nFAIL\r\n2019/06/28 14:53:16 DEBUG : Azure container rclone-test-jiganin7cujuvex3zahebab9: Purge remote\r\nexit status 1\r\nFAIL\tgithub.com/ncw/rclone/fs/operations\t0.475s\r\n```\r\n\r\nMaking this very small change (stopping the context propagation into the Azure SDK) fixes the problem\r\n\r\n```diff\r\ndiff --git a/backend/azureblob/azureblob.go b/backend/azureblob/azureblob.go\r\nindex 92c6893ec..0c54057fb 100644\r\n--- a/backend/azureblob/azureblob.go\r\n+++ b/backend/azureblob/azureblob.go\r\n@@ -520,6 +520,7 @@ type listFn func(remote string, object *azblob.BlobItem, isDirectory bool) error\r\n //\r\n // dir is the starting directory, \"\" for root\r\n func (f *Fs) list(ctx context.Context, dir string, recurse bool, maxResults uint, fn listFn) error {\r\n+\tctx = context.Background()\r\n \tf.containerOKMu.Lock()\r\n \tdeleted := f.containerDeleted\r\n \tf.containerOKMu.Unlock()\r\n```\r\n\r\nAny ideas @sandeepkru or @ajankovic ?","closed_by":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/3307/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rclone/rclone/issues/3307/timeline","performed_via_github_app":null,"state_reason":"completed"}