{"url":"https://api.github.com/repos/rclone/rclone/issues/5956","repository_url":"https://api.github.com/repos/rclone/rclone","labels_url":"https://api.github.com/repos/rclone/rclone/issues/5956/labels{/name}","comments_url":"https://api.github.com/repos/rclone/rclone/issues/5956/comments","events_url":"https://api.github.com/repos/rclone/rclone/issues/5956/events","html_url":"https://github.com/rclone/rclone/issues/5956","id":1115760030,"node_id":"I_kwDOAQ-n5M5CgSWe","number":5956,"title":"S3 multipart upload always fails checksum with `--s3-no-head` option","user":{"login":"c42f","id":601473,"node_id":"MDQ6VXNlcjYwMTQ3Mw==","avatar_url":"https://avatars.githubusercontent.com/u/601473?v=4","gravatar_id":"","url":"https://api.github.com/users/c42f","html_url":"https://github.com/c42f","followers_url":"https://api.github.com/users/c42f/followers","following_url":"https://api.github.com/users/c42f/following{/other_user}","gists_url":"https://api.github.com/users/c42f/gists{/gist_id}","starred_url":"https://api.github.com/users/c42f/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/c42f/subscriptions","organizations_url":"https://api.github.com/users/c42f/orgs","repos_url":"https://api.github.com/users/c42f/repos","events_url":"https://api.github.com/users/c42f/events{/privacy}","received_events_url":"https://api.github.com/users/c42f/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":86399005,"node_id":"MDU6TGFiZWw4NjM5OTAwNQ==","url":"https://api.github.com/repos/rclone/rclone/labels/bug","name":"bug","color":"fc2929","default":true,"description":null},{"id":314138213,"node_id":"MDU6TGFiZWwzMTQxMzgyMTM=","url":"https://api.github.com/repos/rclone/rclone/labels/Remote:%20S3","name":"Remote: S3","color":"fbca04","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/rclone/rclone/milestones/46","html_url":"https://github.com/rclone/rclone/milestone/46","labels_url":"https://api.github.com/repos/rclone/rclone/milestones/46/labels","id":6965450,"node_id":"MI_kwDOAQ-n5M4AakjK","number":46,"title":"v1.58","description":"Due date shifted 16.01.2022 -> 28.02.2022 by @ivandeex on 13.01.2022\r\ncc @ncw","creator":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":33,"state":"closed","created_at":"2021-07-20T20:07:20Z","updated_at":"2022-03-19T12:38:32Z","due_on":"2022-02-28T08:00:00Z","closed_at":"2022-03-19T12:38:32Z"},"comments":3,"created_at":"2022-01-27T04:25:38Z","updated_at":"2022-01-29T12:49:19Z","closed_at":"2022-01-29T12:49:05Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"When the `--s3-no-head` option is set and when a multipart upload is attempted (by default at the 200MiB boundary), `rclone copyto` fails reproducibly with a checksum error.\r\n\r\nFull details and `rclone` command are in the log below, but the relevant part of the log seems to be:\r\n\r\n```\r\ncorrupted on transfer: md5 hash differ \"100a7ce0ac810f7d1caa75ab9b5d3bfc\" vs \"EAp84KyBD30cqnWrm107/A==\"\r\n```\r\n\r\n`\"EAp84KyBD30cqnWrm107/A==\"` doesn't even look like a MD5 checksum so what's going on?  This seems to be the base64 encoded version of the correct checksum, as can be verified with a quick Julia script:\r\n\r\n```julia\r\njulia> using Base64\r\n\r\njulia> bytes2hex(base64decode(\"EAp84KyBD30cqnWrm107/A==\"))\r\n\"100a7ce0ac810f7d1caa75ab9b5d3bfc\"\r\n\r\njulia> bytes2hex(base64decode(\"EAp84KyBD30cqnWrm107/A==\"))  ==  \"100a7ce0ac810f7d1caa75ab9b5d3bfc\"\r\ntrue\r\n```\r\n\r\nWith the `--s3-no-head` option removed, this error disappears.\r\n\r\nHere's the detailed bug report form filled out:\r\n\r\n#### What is your rclone version (output from `rclone version`)\r\n\r\n```\r\nrclone v1.57.0\r\n- os/version: ubuntu 18.04 (64 bit)\r\n- os/kernel: 4.15.0-166-generic (x86_64)\r\n- os/type: linux\r\n- os/arch: amd64\r\n- go/version: go1.17.2\r\n- go/linking: static\r\n- go/tags: none\r\n```\r\n\r\n#### Which OS you are using and how many bits (e.g. Windows 7, 64 bit)\r\n\r\nUbuntu 18.04, 64 bit\r\n\r\n#### Which cloud storage system are you using? (e.g. Google Drive)\r\n\r\nAWS S3\r\n\r\n#### The command you were trying to run (e.g. `rclone copy /tmp remote:tmp`)\r\n\r\nI've reduced the `--s3-upload-cutoff` and `--s3-chunk-size` here for ease of testing, and only upload a 10MB file.  But removing these options and using a 210MB file will also display the bug.\r\n\r\n```bash\r\nhead -c 10M </dev/urandom > myfile\r\n\r\n/home/chris/local/rclone-v1.57.0-linux-amd64/rclone copyto myfile \\\r\n    jc:datasets-jl-test/rand_10M.dat \\\r\n    --config rclone.conf \\\r\n    --s3-no-head \\\r\n    --s3-upload-cutoff 1M --s3-chunk-size 5M\r\n```\r\n\r\n\r\n#### A log from the command with the `-vv` flag (e.g. output from `rclone -vv copy /tmp remote:tmp`)\r\n\r\n```\r\n2022/01/27 14:08:54 DEBUG : rclone: Version \"v1.57.0\" starting with parameters [\"/home/chris/local/rclone-v1.57.0-linux-amd64/rclone\" \"copyto\" \"myfile\" \"jc:datasets-jl-test/rand_10M.dat\" \"--config\" \"rclone.conf\" \"--s3-no-head\" \"--s3-upload-cutoff\" \"1M\" \"--s3-chunk-size\" \"5M\" \"-vv\" \"--log-file\" \"bug.log\"]\r\n2022/01/27 14:08:54 DEBUG : Creating backend with remote \"myfile\"\r\n2022/01/27 14:08:54 DEBUG : Using config file from \"/home/chris/work/ops/4171_rclone_multipart_checksum/rclone.conf\"\r\n2022/01/27 14:08:54 DEBUG : fs cache: adding new entry for parent of \"myfile\", \"/home/chris/work/ops/4171_rclone_multipart_checksum\"\r\n2022/01/27 14:08:54 DEBUG : Creating backend with remote \"jc:datasets-jl-test/\"\r\n2022/01/27 14:08:54 DEBUG : jc: detected overridden config - adding \"{QX2bg}\" suffix to name\r\n2022/01/27 14:08:54 DEBUG : fs cache: renaming cache item \"jc:datasets-jl-test/\" to be canonical \"jc{QX2bg}:datasets-jl-test\"\r\n2022/01/27 14:08:54 DEBUG : myfile: Need to transfer - File not found at Destination\r\n2022/01/27 14:08:55 DEBUG : rand_10M.dat: multipart upload starting chunk 1 size 5Mi offset 0/10Mi\r\n2022/01/27 14:08:55 DEBUG : rand_10M.dat: multipart upload starting chunk 2 size 5Mi offset 5Mi/10Mi\r\n2022/01/27 14:09:00 DEBUG : myfile: md5 = 100a7ce0ac810f7d1caa75ab9b5d3bfc (Local file system at /home/chris/work/ops/4171_rclone_multipart_checksum)\r\n2022/01/27 14:09:00 DEBUG : rand_10M.dat: md5 = EAp84KyBD30cqnWrm107/A== (S3 bucket datasets-jl-test)\r\n2022/01/27 14:09:00 ERROR : rand_10M.dat: corrupted on transfer: md5 hash differ \"100a7ce0ac810f7d1caa75ab9b5d3bfc\" vs \"EAp84KyBD30cqnWrm107/A==\"\r\n2022/01/27 14:09:00 INFO  : rand_10M.dat: Removing failed copy\r\n2022/01/27 14:09:00 ERROR : Attempt 1/3 failed with 1 errors and: corrupted on transfer: md5 hash differ \"100a7ce0ac810f7d1caa75ab9b5d3bfc\" vs \"EAp84KyBD30cqnWrm107/A==\"\r\n2022/01/27 14:09:00 DEBUG : myfile: Need to transfer - File not found at Destination\r\n2022/01/27 14:09:00 DEBUG : rand_10M.dat: multipart upload starting chunk 1 size 5Mi offset 0/10Mi\r\n2022/01/27 14:09:00 DEBUG : rand_10M.dat: multipart upload starting chunk 2 size 5Mi offset 5Mi/10Mi\r\n2022/01/27 14:09:05 DEBUG : myfile: md5 = 100a7ce0ac810f7d1caa75ab9b5d3bfc (Local file system at /home/chris/work/ops/4171_rclone_multipart_checksum)\r\n2022/01/27 14:09:05 DEBUG : rand_10M.dat: md5 = EAp84KyBD30cqnWrm107/A== (S3 bucket datasets-jl-test)\r\n2022/01/27 14:09:05 ERROR : rand_10M.dat: corrupted on transfer: md5 hash differ \"100a7ce0ac810f7d1caa75ab9b5d3bfc\" vs \"EAp84KyBD30cqnWrm107/A==\"\r\n2022/01/27 14:09:05 INFO  : rand_10M.dat: Removing failed copy\r\n2022/01/27 14:09:05 ERROR : Attempt 2/3 failed with 1 errors and: corrupted on transfer: md5 hash differ \"100a7ce0ac810f7d1caa75ab9b5d3bfc\" vs \"EAp84KyBD30cqnWrm107/A==\"\r\n2022/01/27 14:09:05 DEBUG : myfile: Need to transfer - File not found at Destination\r\n2022/01/27 14:09:05 DEBUG : rand_10M.dat: multipart upload starting chunk 1 size 5Mi offset 0/10Mi\r\n2022/01/27 14:09:05 DEBUG : rand_10M.dat: multipart upload starting chunk 2 size 5Mi offset 5Mi/10Mi\r\n2022/01/27 14:09:10 DEBUG : myfile: md5 = 100a7ce0ac810f7d1caa75ab9b5d3bfc (Local file system at /home/chris/work/ops/4171_rclone_multipart_checksum)\r\n2022/01/27 14:09:10 DEBUG : rand_10M.dat: md5 = EAp84KyBD30cqnWrm107/A== (S3 bucket datasets-jl-test)\r\n2022/01/27 14:09:10 ERROR : rand_10M.dat: corrupted on transfer: md5 hash differ \"100a7ce0ac810f7d1caa75ab9b5d3bfc\" vs \"EAp84KyBD30cqnWrm107/A==\"\r\n2022/01/27 14:09:10 INFO  : rand_10M.dat: Removing failed copy\r\n2022/01/27 14:09:10 ERROR : Attempt 3/3 failed with 1 errors and: corrupted on transfer: md5 hash differ \"100a7ce0ac810f7d1caa75ab9b5d3bfc\" vs \"EAp84KyBD30cqnWrm107/A==\"\r\n2022/01/27 14:09:10 INFO  : \r\nTransferred:   \t       30 MiB / 30 MiB, 100%, 1.875 MiB/s, ETA 0s\r\nErrors:                 1 (retrying may help)\r\nElapsed time:        16.5s\r\n\r\n2022/01/27 14:09:10 DEBUG : 9 go routines active\r\n2022/01/27 14:09:10 Failed to copyto: corrupted on transfer: md5 hash differ \"100a7ce0ac810f7d1caa75ab9b5d3bfc\" vs \"EAp84KyBD30cqnWrm107/A==\"\r\n```\r\n\r\n\r\n<!--- Please keep the note below for others who read your bug report. -->\r\n\r\n#### How to use GitHub\r\n\r\n* Please use the üëç [reaction](https://blog.github.com/2016-03-10-add-reactions-to-pull-requests-issues-and-comments/) to show that you are affected by the same issue.\r\n* Please don't comment if you have no relevant information to add. It's just extra noise for everyone subscribed to this issue.\r\n* Subscribe to receive notifications on status change and new comments.\r\n","closed_by":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/5956/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rclone/rclone/issues/5956/timeline","performed_via_github_app":null,"state_reason":"completed"}