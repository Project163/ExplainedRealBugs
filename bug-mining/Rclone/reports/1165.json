{"url":"https://api.github.com/repos/rclone/rclone/issues/6992","repository_url":"https://api.github.com/repos/rclone/rclone","labels_url":"https://api.github.com/repos/rclone/rclone/issues/6992/labels{/name}","comments_url":"https://api.github.com/repos/rclone/rclone/issues/6992/comments","events_url":"https://api.github.com/repos/rclone/rclone/issues/6992/events","html_url":"https://github.com/rclone/rclone/issues/6992","id":1699254378,"node_id":"I_kwDOAQ-n5M5lSJBq","number":6992,"title":"PikPak backend: Retrieving files via original quality media link returns transcoded version","user":{"login":"Computron010","id":56774862,"node_id":"MDQ6VXNlcjU2Nzc0ODYy","avatar_url":"https://avatars.githubusercontent.com/u/56774862?v=4","gravatar_id":"","url":"https://api.github.com/users/Computron010","html_url":"https://github.com/Computron010","followers_url":"https://api.github.com/users/Computron010/followers","following_url":"https://api.github.com/users/Computron010/following{/other_user}","gists_url":"https://api.github.com/users/Computron010/gists{/gist_id}","starred_url":"https://api.github.com/users/Computron010/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Computron010/subscriptions","organizations_url":"https://api.github.com/users/Computron010/orgs","repos_url":"https://api.github.com/users/Computron010/repos","events_url":"https://api.github.com/users/Computron010/events{/privacy}","received_events_url":"https://api.github.com/users/Computron010/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":5350216513,"node_id":"LA_kwDOAQ-n5M8AAAABPuXTQQ","url":"https://api.github.com/repos/rclone/rclone/labels/remote:%20PikPak","name":"remote: PikPak","color":"FBCA04","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":12,"created_at":"2023-05-07T21:59:56Z","updated_at":"2023-05-12T19:28:28Z","closed_at":"2023-05-12T18:42:01Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"#### What is the problem you are having with rclone?\r\n\r\nWhen downloading media files from pikpak via rclone, certain files are reported as \"corrupted as transfer\", because the file served by media links by PikPak have a size mismatch of what is expected.\r\n\r\nhttps://github.com/rclone/rclone/blob/243bcc9d0787276ccaccbbd914d70ede6a0305e6/backend/pikpak/pikpak.go#L1447\r\n\r\nWe use `Medias[0]` whenever possible to download a media file in its original resolution, whenever possible. However, I have noticed certain files do not offer Original quality media files in the UI. The `is_visible` property for `Medias[0]` is false.\r\n\r\nThese files, while reporting a valid Original quality URL in the PikPak API, do not serve the Original quality file. In fact, the links provided by `Medias[0]` and `Medias[1]` are identical.\r\n\r\nIn the logs below I download a large 7GB M2TS file, which has been transcoded by PikPak, and they have not allowed external playback in Original quality. rclone expects a 7GB file, but a 1080p transcoded file with size about 700MB is downloaded by the media links.\r\n\r\nI'm not entirely familiar with the PikPak backend, but the easiest would be to check the `is_visible` property or to compare the links of `Medias[0]` or `Medias[1]`. A further unrelated improvement may be to use the `original_file_index` property instead of hardcoding 0.\r\n\r\n#### What is your rclone version (output from `rclone version`)\r\n```\r\nrclone v1.63.0-beta.7016.f226f2dfb\r\n- os/version: ubuntu 20.04 (64 bit)\r\n- os/kernel: 5.8.0-1034-oracle (aarch64)\r\n- os/type: linux\r\n- os/arch: arm64 (ARMv8 compatible)\r\n- go/version: go1.20.4\r\n- go/linking: static\r\n- go/tags: none\r\n```\r\n\r\n#### Which cloud storage system are you using? (e.g. Google Drive)\r\n\r\npikpak. This is currently available only via beta.\r\n\r\n#### The command you were trying to run (e.g. `rclone copy /tmp remote:tmp`)\r\n\r\n`rclone copy pikpak:DISK/BDMV/STREAM/00003.m2ts .`\r\n\r\n#### A log from the command with the `-vv` flag (e.g. output from `rclone -vv copy /tmp remote:tmp`)\r\n\r\n```\r\n2023/05/07 21:43:19 DEBUG : rclone: Version \"v1.63.0-beta.7016.f226f2dfb\" starting with parameters [\"./rclone\" \"copy\" \"pikpak:DISK/BDMV/STREAM/00003.m2ts\" \".\" \"-P\" \"-vv\"]\r\n2023/05/07 21:43:19 DEBUG : Creating backend with remote \"pikpak:DISK/BDMV/STREAM/00003.m2ts\"\r\n2023/05/07 21:43:19 DEBUG : Using config file from \"/home/USER/.config/rclone/rclone.conf\"\r\n2023/05/07 21:43:23 DEBUG : fs cache: adding new entry for parent of \"pikpak:DISK/BDMV/STREAM/00003.m2ts\", \"pikpak:DISK/BDMV/STREAM\"\r\n2023/05/07 21:43:23 DEBUG : Creating backend with remote \".\"\r\n2023/05/07 21:43:23 DEBUG : fs cache: renaming cache item \".\" to be canonical \"/home/USER\"\r\n2023-05-07 21:43:23 DEBUG : 00003.m2ts: Need to transfer - File not found at Destination\r\n2023-05-07 21:43:23 DEBUG : 00003.m2ts: Using a media link\r\n2023-05-07 21:44:41 ERROR : 00003.m2ts: corrupted on transfer: sizes differ 7697805312 vs 740546288\r\n2023-05-07 21:44:41 INFO  : 00003.m2ts: Removing failed copy\r\n2023-05-07 21:44:41 ERROR : Attempt 1/3 failed with 1 errors and: corrupted on transfer: sizes differ 7697805312 vs 740546288\r\n2023-05-07 21:44:42 DEBUG : 00003.m2ts: Need to transfer - File not found at Destination\r\n2023-05-07 21:44:43 DEBUG : 00003.m2ts: Using a media link\r\n2023-05-07 21:45:54 ERROR : 00003.m2ts: corrupted on transfer: sizes differ 7697805312 vs 740546288\r\n2023-05-07 21:45:54 INFO  : 00003.m2ts: Removing failed copy\r\n2023-05-07 21:45:54 ERROR : Attempt 2/3 failed with 1 errors and: corrupted on transfer: sizes differ 7697805312 vs 740546288\r\n2023-05-07 21:45:55 DEBUG : 00003.m2ts: Need to transfer - File not found at Destination\r\n2023-05-07 21:45:55 DEBUG : 00003.m2ts: Using a media link\r\n2023-05-07 21:47:07 ERROR : 00003.m2ts: corrupted on transfer: sizes differ 7697805312 vs 740546288\r\n2023-05-07 21:47:07 INFO  : 00003.m2ts: Removing failed copy\r\n2023-05-07 21:47:07 ERROR : Attempt 3/3 failed with 1 errors and: corrupted on transfer: sizes differ 7697805312 vs 740546288\r\nTransferred:   \t    2.069 GiB / 2.069 GiB, 100%, 9.976 MiB/s, ETA 0s\r\nErrors:                 1 (retrying may help)\r\nElapsed time:      3m48.2s\r\n2023/05/07 21:47:07 INFO  :\r\nTransferred:   \t    2.069 GiB / 2.069 GiB, 100%, 9.976 MiB/s, ETA 0s\r\nErrors:                 1 (retrying may help)\r\nElapsed time:      3m48.2s\r\n```\r\n\r\n","closed_by":{"login":"wiserain","id":20354654,"node_id":"MDQ6VXNlcjIwMzU0NjU0","avatar_url":"https://avatars.githubusercontent.com/u/20354654?v=4","gravatar_id":"","url":"https://api.github.com/users/wiserain","html_url":"https://github.com/wiserain","followers_url":"https://api.github.com/users/wiserain/followers","following_url":"https://api.github.com/users/wiserain/following{/other_user}","gists_url":"https://api.github.com/users/wiserain/gists{/gist_id}","starred_url":"https://api.github.com/users/wiserain/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wiserain/subscriptions","organizations_url":"https://api.github.com/users/wiserain/orgs","repos_url":"https://api.github.com/users/wiserain/repos","events_url":"https://api.github.com/users/wiserain/events{/privacy}","received_events_url":"https://api.github.com/users/wiserain/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/6992/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rclone/rclone/issues/6992/timeline","performed_via_github_app":null,"state_reason":"completed"}