{"url":"https://api.github.com/repos/rclone/rclone/issues/6443","repository_url":"https://api.github.com/repos/rclone/rclone","labels_url":"https://api.github.com/repos/rclone/rclone/issues/6443/labels{/name}","comments_url":"https://api.github.com/repos/rclone/rclone/issues/6443/comments","events_url":"https://api.github.com/repos/rclone/rclone/issues/6443/events","html_url":"https://github.com/rclone/rclone/issues/6443","id":1373116106,"node_id":"I_kwDOAQ-n5M5R2BbK","number":6443,"title":"--s3-profile is failing when used with VPC endpoints","user":{"login":"rpattcorner","id":1488518,"node_id":"MDQ6VXNlcjE0ODg1MTg=","avatar_url":"https://avatars.githubusercontent.com/u/1488518?v=4","gravatar_id":"","url":"https://api.github.com/users/rpattcorner","html_url":"https://github.com/rpattcorner","followers_url":"https://api.github.com/users/rpattcorner/followers","following_url":"https://api.github.com/users/rpattcorner/following{/other_user}","gists_url":"https://api.github.com/users/rpattcorner/gists{/gist_id}","starred_url":"https://api.github.com/users/rpattcorner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rpattcorner/subscriptions","organizations_url":"https://api.github.com/users/rpattcorner/orgs","repos_url":"https://api.github.com/users/rpattcorner/repos","events_url":"https://api.github.com/users/rpattcorner/events{/privacy}","received_events_url":"https://api.github.com/users/rpattcorner/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":314138213,"node_id":"MDU6TGFiZWwzMTQxMzgyMTM=","url":"https://api.github.com/repos/rclone/rclone/labels/Remote:%20S3","name":"Remote: S3","color":"fbca04","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2022-09-14T14:43:46Z","updated_at":"2023-03-02T17:42:16Z","closed_at":"2023-03-02T17:39:31Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"#### The associated forum post URL from `https://forum.rclone.org`\r\nhttps://forum.rclone.org/t/rclone-copy-failing-again-with-s3-profile-where-aws-cli-succeeds/32904\r\n\r\n#### What is the problem you are having with rclone?\r\nS3 copy and lsf operations (for example) that reference an `--s3-profile` fail in combination with a VPC interface endpoint.\r\nThe operations succeed where no endpoint is specified\r\nThe operations succeed where an endpoint is specified but a profile is not specified\r\n\r\n#### What is your rclone version (output from `rclone version`)\r\n```\r\n$ rclone-beta version\r\nrclone v1.60.0-beta.6422.85eb9776b\r\n- os/version: centos 7.9.2009 (64 bit)\r\n- os/kernel: 3.10.0-1160.76.1.el7.x86_64 (x86_64)\r\n- os/type: linux\r\n- os/arch: amd64\r\n- go/version: go1.19\r\n- go/linking: static\r\n- go/tags: none\r\n```\r\n\r\n#### The configuration is:\r\n```\r\n[s3-standard]\r\ntype = s3\r\nprovider = AWS\r\nenv_auth = true\r\nregion = us-east-1\r\nendpoint = https://bucket.vpce-STUFF.us-east-1.vpce.amazonaws.com\r\nstorage_class = STANDARD\r\n```\r\nPlease note that the `bucket` in the endpoint specification is *not* a placeholder for a bucket name, but rather part of the AWS specification for addressing interface-style S3 endpoints, per the CLI examples in [this AWS article](https://docs.aws.amazon.com/AmazonS3/latest/userguide/privatelink-interface-endpoints.html).\r\n\r\nSee also the successful CLI counter-example below\r\n\r\n#### Which OS you are using and how many bits (e.g. Windows 7, 64 bit)\r\nCentOS 7 64bit\r\n\r\n#### Which cloud storage system are you using? (e.g. Google Drive)\r\nAWS S3\r\n\r\n#### The command you were trying to run (e.g. `rclone copy /tmp remote:tmp`)\r\n`$ rclone-beta lsf s3-standard:x20220908-rpc-1 --s3-profile dr_systems_profile -vv`\r\n\r\n#### A log from the command with the `-vv` flag (e.g. output from `rclone -vv copy /tmp remote:tmp`)\r\n```\r\n2022/09/14 10:10:38 DEBUG : rclone: Version \"v1.60.0-beta.6422.85eb9776b\" starting with parameters [\"/home/me/bin/rclone-beta/rclone\" \"lsf\" \"s3-standard:x20220908-rpc-1\" \"--s3-profile\" \"dr_systems_profile\" \"-vv\"]\r\n2022/09/14 10:10:38 DEBUG : Creating backend with remote \"s3-standard:x20220908-rpc-1\"\r\n2022/09/14 10:10:38 DEBUG : Using config file from \"~/.config/rclone/rclone.conf\"\r\n2022/09/14 10:10:38 DEBUG : s3-standard: detected overridden config - adding \"{ypUXU}\" suffix to name\r\n2022/09/14 10:10:38 DEBUG : fs cache: renaming cache item \"s3-standard:x20220908-rpc-1\" to be canonical \"s3-standard{ypUXU}:x20220908-rpc-1\"\r\n2022/09/14 10:11:22 ERROR : : error listing: SerializationError: failed to unmarshal error message\r\n        status code: 400, request id: \r\ncaused by: UnmarshalError: failed to unmarshal error message\r\n        00000000  3c 3f 78 6d 6c 20 76 65  72 73 69 6f 6e 3d 22 31  |<?xml version=\"1|\r\n00000010  2e 30 22 20 65 6e 63 6f  64 69 6e 67 3d 22 55 54  |.0\" encoding=\"UT|\r\n00000020  46 2d 38 22 3f 3e 0a 3c  45 72 72 6f 72 3e 3c 43  |F-8\"?>.<Error><C|\r\n00000030  6f 64 65 3e 49 6e 76 61  6c 69 64 52 65 71 75 65  |ode>InvalidReque|\r\n00000040  73 74 3c 2f 43 6f 64 65  3e 3c 4d 65 73 73 61 67  |st</Code><Messag|\r\n00000050  65 3e 4d 69 73 73 69 6e  67 20 72 65 71 75 69 72  |e>Missing requir|\r\n00000060  65 64 20 68 65 61 64 65  72 20 66 6f 72 20 74 68  |ed header for th|\r\n00000070  69 73 20 72 65 71 75 65  73 74 3a 20 78 2d 61 6d  |is request: x-am|\r\n00000080  7a 2d 63 6f 6e 74 65 6e  74 2d 73 68 61 32 35 36  |z-content-sha256|\r\n00000090  3c 2f 4d 65 73 73 61 67  65 3e 3c 52 65 71 75 65  |</Message><Reque|\r\n000000a0  73 74 49 64 3e 41 36 45  34 52 48 54 4e 44 4e 57  |stId>A6E4RHTNDNW|\r\n000000b0  43 4b 30 32 38 3c 2f 52  65 71 75 65 73 74 49 64  |CK028</RequestId|\r\n000000c0  3e 3c 48 6f 73 74 49 64  3e 4b 32 36 61 48 6a 4b  |><HostId>K26aHjK|\r\n000000d0  6d 77 38 71 4e 35 35 4a  37 66 70 6a 70 48 78 4e  |mw8qN55J7fpjpHxN|\r\n000000e0  55 4a 64 70 47 61 77 37  48 53 65 32 51 51 42 31  |UJdpGaw7HSe2QQB1|\r\n000000f0  43 54 73 4d 59 4c 6a 6f  48 49 42 57 6c 37 37 67  |CTsMYLjoHIBWl77g|\r\n00000100  65 59 41 32 59 30 4a 46  35 6e 4b 44 5a 43 5a 6f  |eYA2Y0JF5nKDZCZo|\r\n00000110  69 6f 76 34 3d 3c 2f 48  6f 73 74 49 64 3e 3c 2f  |iov4=</HostId></|\r\n00000120  45 72 72 6f 72 3e                                 |Error>|\r\n\r\ncaused by: unknown error response tag, {{ Error} []}\r\n2022/09/14 10:11:22 DEBUG : 2 go routines active\r\n2022/09/14 10:11:22 Failed to lsf with 2 errors: last error was: error in ListJSON: SerializationError: failed to unmarshal error message\r\n        status code: 400, request id: \r\ncaused by: UnmarshalError: failed to unmarshal error message\r\n        00000000  3c 3f 78 6d 6c 20 76 65  72 73 69 6f 6e 3d 22 31  |<?xml version=\"1|\r\n00000010  2e 30 22 20 65 6e 63 6f  64 69 6e 67 3d 22 55 54  |.0\" encoding=\"UT|\r\n00000020  46 2d 38 22 3f 3e 0a 3c  45 72 72 6f 72 3e 3c 43  |F-8\"?>.<Error><C|\r\n00000030  6f 64 65 3e 49 6e 76 61  6c 69 64 52 65 71 75 65  |ode>InvalidReque|\r\n00000040  73 74 3c 2f 43 6f 64 65  3e 3c 4d 65 73 73 61 67  |st</Code><Messag|\r\n00000050  65 3e 4d 69 73 73 69 6e  67 20 72 65 71 75 69 72  |e>**Missing requir|\r\n00000060  65 64 20 68 65 61 64 65  72 20 66 6f 72 20 74 68  |ed header for th|\r\n00000070  69 73 20 72 65 71 75 65  73 74 3a 20 78 2d 61 6d  |is request: x-am|\r\n00000080  7a 2d 63 6f 6e 74 65 6e  74 2d 73 68 61 32 35 36  |z-content-sha256|**\r\n00000090  3c 2f 4d 65 73 73 61 67  65 3e 3c 52 65 71 75 65  |</Message><Reque|\r\n000000a0  73 74 49 64 3e 41 36 45  34 52 48 54 4e 44 4e 57  |stId>A6E4RHTNDNW|\r\n000000b0  43 4b 30 32 38 3c 2f 52  65 71 75 65 73 74 49 64  |CK028</RequestId|\r\n000000c0  3e 3c 48 6f 73 74 49 64  3e 4b 32 36 61 48 6a 4b  |><HostId>K26aHjK|\r\n000000d0  6d 77 38 71 4e 35 35 4a  37 66 70 6a 70 48 78 4e  |mw8qN55J7fpjpHxN|\r\n000000e0  55 4a 64 70 47 61 77 37  48 53 65 32 51 51 42 31  |UJdpGaw7HSe2QQB1|\r\n000000f0  43 54 73 4d 59 4c 6a 6f  48 49 42 57 6c 37 37 67  |CTsMYLjoHIBWl77g|\r\n00000100  65 59 41 32 59 30 4a 46  35 6e 4b 44 5a 43 5a 6f  |eYA2Y0JF5nKDZCZo|\r\n00000110  69 6f 76 34 3d 3c 2f 48  6f 73 74 49 64 3e 3c 2f  |iov4=</HostId></|\r\n00000120  45 72 72 6f 72 3e                                 |Error>|\r\n\r\ncaused by: unknown error response tag, {{ Error} []}\r\n```\r\n\r\nPer the hex dump, the request might possibly be missing an **x-amz-sha256** header\r\n\r\n#### More Information\r\n\r\n **A CLI example showing that the endpoint works as specified** \r\n```\r\n$ aws s3 ls s3://x20220908-rpc-1 --endpoint-url https://bucket.vpce-0STUFF.s3.us-east-1.vpce.amazonaws.com --profile dr_systems_profile\r\n2022-09-14 09:46:03          9 foo\r\n2022-09-14 09:45:15         16 testfile\r\n```\r\nNote the presence of `bucket` in the successful endpoint URL\r\n\r\n **An rclone example from a privileged account** \r\nThe account in this example has privileges and therefore does not need the --s3-profile designation.  \r\n\r\nThis privileged example illustrates that the endpoint configuration in the rclone config is correct, and is fully functional when an `--s3-profile` is not specified in combination.\r\n```\r\n$ rclone-beta lsf s3-standard:x20220908-rpc-1 -vv\r\n2022/09/14 10:35:47 DEBUG : rclone: Version \"v1.60.0-beta.6422.85eb9776b\" starting with parameters [\"/home/me/bin/rclone-beta/rclone\" \"lsf\" \"s3-standard:x20220908-rpc-1\" \"-vv\"]\r\n2022/09/14 10:35:47 DEBUG : Creating backend with remote \"s3-standard:x20220908-rpc-1\"\r\n2022/09/14 10:35:47 DEBUG : Using config file from \"/home/pattcornerri/.config/rclone/rclone.conf\"\r\nfoo\r\ntestfile\r\n```\r\n**Business Case**\r\n`endpoint` is required in the configuration to make use of direct connects.\r\n`s3-profile` is required in the command to access granular privileges for the operation\r\n\r\n\r\n<!--- Please keep the note below for others who read your bug report. -->\r\n\r\n#### How to use GitHub\r\n\r\n* Please use the üëç [reaction](https://blog.github.com/2016-03-10-add-reactions-to-pull-requests-issues-and-comments/) to show that you are affected by the same issue.\r\n* Please don't comment if you have no relevant information to add. It's just extra noise for everyone subscribed to this issue.\r\n* Subscribe to receive notifications on status change and new comments.\r\n","closed_by":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/6443/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rclone/rclone/issues/6443/timeline","performed_via_github_app":null,"state_reason":"completed"}