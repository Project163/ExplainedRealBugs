{"url":"https://api.github.com/repos/rclone/rclone/issues/1181","repository_url":"https://api.github.com/repos/rclone/rclone","labels_url":"https://api.github.com/repos/rclone/rclone/issues/1181/labels{/name}","comments_url":"https://api.github.com/repos/rclone/rclone/issues/1181/comments","events_url":"https://api.github.com/repos/rclone/rclone/issues/1181/events","html_url":"https://github.com/rclone/rclone/issues/1181","id":210442128,"node_id":"MDU6SXNzdWUyMTA0NDIxMjg=","number":1181,"title":"rclone mount: race condition on subsequent file create and remove","user":{"login":"rafal-krypa","id":852802,"node_id":"MDQ6VXNlcjg1MjgwMg==","avatar_url":"https://avatars.githubusercontent.com/u/852802?v=4","gravatar_id":"","url":"https://api.github.com/users/rafal-krypa","html_url":"https://github.com/rafal-krypa","followers_url":"https://api.github.com/users/rafal-krypa/followers","following_url":"https://api.github.com/users/rafal-krypa/following{/other_user}","gists_url":"https://api.github.com/users/rafal-krypa/gists{/gist_id}","starred_url":"https://api.github.com/users/rafal-krypa/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rafal-krypa/subscriptions","organizations_url":"https://api.github.com/users/rafal-krypa/orgs","repos_url":"https://api.github.com/users/rafal-krypa/repos","events_url":"https://api.github.com/users/rafal-krypa/events{/privacy}","received_events_url":"https://api.github.com/users/rafal-krypa/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":86399005,"node_id":"MDU6TGFiZWw4NjM5OTAwNQ==","url":"https://api.github.com/repos/rclone/rclone/labels/bug","name":"bug","color":"fc2929","default":true,"description":null},{"id":430778096,"node_id":"MDU6TGFiZWw0MzA3NzgwOTY=","url":"https://api.github.com/repos/rclone/rclone/labels/VFS%20/%20mount","name":"VFS / mount","color":"0e8a16","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/rclone/rclone/milestones/27","html_url":"https://github.com/rclone/rclone/milestone/27","labels_url":"https://api.github.com/repos/rclone/rclone/milestones/27/labels","id":2804379,"node_id":"MDk6TWlsZXN0b25lMjgwNDM3OQ==","number":27,"title":"v1.40","description":"","creator":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":53,"state":"closed","created_at":"2017-09-30T13:34:06Z","updated_at":"2018-03-19T14:34:06Z","due_on":"2018-03-17T07:00:00Z","closed_at":"2018-03-19T14:34:06Z"},"comments":5,"created_at":"2017-02-27T10:21:54Z","updated_at":"2018-04-05T18:48:30Z","closed_at":"2018-02-11T17:59:18Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"There is a race condition in \"rclone mount\" implementation regarding creation and deletion of files. If an empty file is created in mounted directory and then quickly removed, the attempt to remove the file fails:\r\n\r\n    $ rclone mount -v -v -v  some_remote: mnt/\r\n    # on the other terminal:\r\n    $ touch mnt/test; rm mnt/test\r\n    rm: cannot remove 'mnt/test': No such file or directory\r\n\r\nThe following logs are produced by rclone:\r\n\r\n    2017/02/27 11:02:34 DEBUG : test: Dir.Lookup\r\n    2017/02/27 11:02:34 DEBUG : test: Dir.Create\r\n    2017/02/27 11:02:34 DEBUG : test: Dir.Create OK\r\n    2017/02/27 11:02:34 DEBUG : File.Attr valid=1m0s ino=0 size=0 mode=-rw-r--r--\r\n    2017/02/27 11:02:34 DEBUG : test: WriteFileHandle.Flush\r\n    2017/02/27 11:02:34 DEBUG : test: WriteFileHandle.Flush ignoring flush on unwritten handle\r\n    2017/02/27 11:02:34 DEBUG : File.Attr valid=1m0s ino=0 size=0 mode=-rw-r--r--\r\n    2017/02/27 11:02:34 DEBUG : test: WriteFileHandle.Flush\r\n    2017/02/27 11:02:34 DEBUG : test: WriteFileHandle.Flush ignoring flush on unwritten handle\r\n    2017/02/27 11:02:34 DEBUG : test: WriteFileHandle.Release closing\r\n    2017/02/27 11:02:34 DEBUG : test: Dir.Remove\r\n    2017/02/27 11:02:34 ERROR : test: Dir.Remove error: no such file or directory\r\n    2017/02/27 11:02:37 DEBUG : test: WriteFileHandle.Release OK\r\n\r\nWhen given enough time between file creation and removal, rclone works fine:\r\n\r\n    $ touch mnt/test; sleep 3; rm mnt/test\r\n\r\nCorrect logs look like this:\r\n\r\n    2017/02/27 11:02:59 DEBUG : test: Dir.Lookup\r\n    2017/02/27 11:02:59 DEBUG : test: Dir.Create\r\n    2017/02/27 11:02:59 DEBUG : test: Dir.Create OK\r\n    2017/02/27 11:02:59 DEBUG : File.Attr valid=1m0s ino=0 size=0 mode=-rw-r--r--\r\n    2017/02/27 11:02:59 DEBUG : test: WriteFileHandle.Flush\r\n    2017/02/27 11:02:59 DEBUG : test: WriteFileHandle.Flush ignoring flush on unwritten handle\r\n    2017/02/27 11:02:59 DEBUG : File.Attr valid=1m0s ino=0 size=0 mode=-rw-r--r--\r\n    2017/02/27 11:02:59 DEBUG : test: WriteFileHandle.Flush\r\n    2017/02/27 11:02:59 DEBUG : test: WriteFileHandle.Flush ignoring flush on unwritten handle\r\n    2017/02/27 11:02:59 DEBUG : test: WriteFileHandle.Release closing\r\n    2017/02/27 11:03:01 DEBUG : test: WriteFileHandle.Release OK\r\n    2017/02/27 11:03:02 DEBUG : test: Dir.Remove\r\n    2017/02/27 11:03:02 DEBUG : test: Dir.Remove OK\r\n\r\nThis issue prevents usage of rclone mounts together with Calibre.\r\nWhile trying to open or create Calibre library on an rclone mount point, Calibre tries to determine whether the directory respects case sensitivity in file names. It tests that by creating `calibre_test_case_sensitivity.txt` file, checking whether it was created, is accessible and whether `calibre_TesT_CaSe_sensitiVitY.Txt` is accessible too. Then Calibre tries to unlink the test file and proceed, but in this case unlink fails because of race condition in rclone, making Calibre unhappy.\r\n\r\nI tried running `rclone mount` with additional options, like `--write-back-cache` or `--min-age 0`, but it didn't help.\r\n\r\n<hr/>\r\n<hr/>\r\n\r\n> What is your rclone version (eg output from `rclone -V`)\r\n\r\nConfirmed on latest master branch (6bad0ad9c474749b1d8588a1ecdb0129e47607c3).\r\n\r\n> Which OS you are using and how many bits (eg Windows 7, 64 bit)\r\n\r\nLinux 64 bit.\r\n\r\n> Which cloud storage system are you using? (eg Google Drive)\r\n\r\nReproduced with Amacon Drive, Google Drive and Dropbox.\r\n\r\n> The command you were trying to run (eg `rclone copy /tmp remote:tmp`)\r\n\r\nDescribed above.\r\n\r\n> A log from the command with the `-vv` flag (eg output from `rclone -vv copy /tmp remote:tmp`)\r\n\r\nDescribed above.","closed_by":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/1181/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rclone/rclone/issues/1181/timeline","performed_via_github_app":null,"state_reason":"completed"}