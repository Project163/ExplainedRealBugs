{"url":"https://api.github.com/repos/rclone/rclone/issues/6426","repository_url":"https://api.github.com/repos/rclone/rclone","labels_url":"https://api.github.com/repos/rclone/rclone/issues/6426/labels{/name}","comments_url":"https://api.github.com/repos/rclone/rclone/issues/6426/comments","events_url":"https://api.github.com/repos/rclone/rclone/issues/6426/events","html_url":"https://github.com/rclone/rclone/issues/6426","id":1365584966,"node_id":"I_kwDOAQ-n5M5RZSxG","number":6426,"title":"FTP upload always delete file after upload when file size >40k","user":{"login":"sriccio","id":5239282,"node_id":"MDQ6VXNlcjUyMzkyODI=","avatar_url":"https://avatars.githubusercontent.com/u/5239282?v=4","gravatar_id":"","url":"https://api.github.com/users/sriccio","html_url":"https://github.com/sriccio","followers_url":"https://api.github.com/users/sriccio/followers","following_url":"https://api.github.com/users/sriccio/following{/other_user}","gists_url":"https://api.github.com/users/sriccio/gists{/gist_id}","starred_url":"https://api.github.com/users/sriccio/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sriccio/subscriptions","organizations_url":"https://api.github.com/users/sriccio/orgs","repos_url":"https://api.github.com/users/sriccio/repos","events_url":"https://api.github.com/users/sriccio/events{/privacy}","received_events_url":"https://api.github.com/users/sriccio/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":608259284,"node_id":"MDU6TGFiZWw2MDgyNTkyODQ=","url":"https://api.github.com/repos/rclone/rclone/labels/Remote:%20FTP","name":"Remote: FTP","color":"fbca04","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":23,"created_at":"2022-09-08T06:01:39Z","updated_at":"2023-03-07T14:35:17Z","closed_at":"2023-03-07T14:34:50Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"#### The associated forum post URL from `https://forum.rclone.org`\r\nNo post on forum.rclone.org (yet)\r\n\r\n\r\n#### What is the problem you are having with rclone?\r\nIt looks like FTP uploads fails for files bigger than 40k. The file is transfered then immediately deleted (I guess this is because the resulting file size is getting random, see below). For smaller files like, for example around 40k it works correctly.\r\n\r\nNote: I first discovered the issue while using rclone in mount mode with the same config and as only some files were uploaded to the target server I begin troubleshooting the issue using `copy` method.\r\n\r\nEdit: I forgot to add that I've checked everything was working correctly uploading these files to the same servers and from the same origin box but using `lftp`. It showed no issue.\r\n\r\n#### What is your rclone version (output from `rclone version`)\r\nrclone v1.59.1\r\n- os/version: ubuntu 22.04 (64 bit)\r\n- os/kernel: 5.15.0-47-generic (x86_64)\r\n- os/type: linux\r\n- os/arch: amd64\r\n- go/version: go1.18.5\r\n- go/linking: static\r\n- go/tags: none\r\n\r\n\r\n#### Which OS you are using and how many bits (e.g. Windows 7, 64 bit)\r\nUbuntu Linux 64 bit (see above)\r\n\r\n\r\n#### Which cloud storage system are you using? (e.g. Google Drive)\r\nFTP Server (pure-ftpd) running on another Ubuntu box. But I also tried with another FTP server on another machine and the result is the same.\r\n\r\n\r\n#### The command you were trying to run (e.g. `rclone copy /tmp remote:tmp`)\r\n```rclone copy test.40K web23:/ -vv --log-file bug.log```\r\nand \r\n```rclone copy test.41K web23:/ -vv --log-file bug.log```\r\n\r\nFor the records, the `rclone.conf` contains:\r\n```\r\n# cat ~/.config/rclone/rclone.conf \r\n\r\n[web23]\r\ntype = ftp\r\nhost = web23.somedomain.com\r\nuser = user\r\nport = 21\r\npass = ThisIsSomeUberRedactedSecretPass\r\nexplicit_tls = true\r\nconcurrency = 3\r\nno_check_certificate = true\r\ndisable_epsv = false\r\ndisable_mlsd = false\r\n```\r\n\r\n#### A log from the command with the `-vv` flag (e.g. output from `rclone -vv copy /tmp remote:tmp`)\r\nGenerating the files\r\n```\r\ndd if=/dev/urandom of=test.40K bs=40K count=1\r\ndd if=/dev/urandom of=test.41K bs=41K count=1\r\n```\r\n\r\nResult\r\n```\r\n-rw-r--r-- 1 root root   40960 Sep  8 07:37 test.40K\r\n-rw-r--r-- 1 root root   41984 Sep  8 07:52 test.41K\r\n```\r\n\r\nLog of `copy` of the 40k file\r\n```\r\n2022/09/08 07:49:53 DEBUG : rclone: Version \"v1.59.1\" starting with parameters [\"rclone\" \"copy\" \"test.40K\" \"web23:/\" \"-vv\" \"--log-file\" \"bug.log\"]\r\n2022/09/08 07:49:53 DEBUG : Creating backend with remote \"test.40K\"\r\n2022/09/08 07:49:53 DEBUG : Using config file from \"/root/.config/rclone/rclone.conf\"\r\n2022/09/08 07:49:53 DEBUG : fs cache: adding new entry for parent of \"test.40K\", \"/root/test\"\r\n2022/09/08 07:49:53 DEBUG : Creating backend with remote \"web23:/\"\r\n2022/09/08 07:49:53 DEBUG : ftp://web23.somedomain.com:21: Connecting to FTP server\r\n2022/09/08 07:49:53 DEBUG : test.40K: Need to transfer - File not found at Destination\r\n2022/09/08 07:49:53 INFO  : test.40K: Copied (new)\r\n2022/09/08 07:49:53 INFO  : \r\nTransferred:           40 KiB / 40 KiB, 100%, 0 B/s, ETA -\r\nTransferred:            1 / 1, 100%\r\nElapsed time:         0.1s\r\n```\r\n\r\nFTP Server log of the 40k file upload (size matches)\r\n```\r\nSep  8 07:36:33 web23 pure-ftpd[1867956]: (user@2a00:a500:0:93::dead:beef) [NOTICE] /home/user//test.40K uploaded  (40960 bytes, 39217.43KB/sec)\r\n```\r\n\r\nLog for attempt of `copy` of the `41k` file\r\n```\r\n2022/09/08 07:49:56 DEBUG : rclone: Version \"v1.59.1\" starting with parameters [\"rclone\" \"copy\" \"test.41K\" \"web23:/\" \"-vv\" \"--log-file\" \"bug.log\"]\r\n2022/09/08 07:49:56 DEBUG : Creating backend with remote \"test.41K\"\r\n2022/09/08 07:49:56 DEBUG : Using config file from \"/root/.config/rclone/rclone.conf\"\r\n2022/09/08 07:49:56 DEBUG : fs cache: adding new entry for parent of \"test.41K\", \"/root/test\"\r\n2022/09/08 07:49:56 DEBUG : Creating backend with remote \"web23:/\"\r\n2022/09/08 07:49:56 DEBUG : ftp://web23.somedomain.com:21: Connecting to FTP server\r\n2022/09/08 07:49:56 DEBUG : test.41K: Need to transfer - File not found at Destination\r\n2022/09/08 07:49:57 DEBUG : ftp://web23.somedomain.com:21: Connecting to FTP server\r\n2022/09/08 07:49:57 DEBUG : test.41K: Removed after failed upload: 1 error occurred:\r\n        * 451 Error during read from data connection\r\nTransfer aborted\r\n0.002 seconds (measured here), 4.17 Mbytes per second\r\n\r\n2022/09/08 07:49:57 ERROR : test.41K: Failed to copy: update stor: 1 error occurred:\r\n        * 451 Error during read from data connection\r\nTransfer aborted\r\n0.002 seconds (measured here), 4.17 Mbytes per second\r\n\r\n2022/09/08 07:49:57 ERROR : Attempt 1/3 failed with 1 errors and: update stor: 1 error occurred:\r\n        * 451 Error during read from data connection\r\nTransfer aborted\r\n0.002 seconds (measured here), 4.17 Mbytes per second\r\n\r\n2022/09/08 07:49:57 DEBUG : test.41K: Need to transfer - File not found at Destination\r\n2022/09/08 07:49:58 DEBUG : ftp://web23.somedomain.com:21: Connecting to FTP server\r\n2022/09/08 07:49:58 DEBUG : test.41K: Removed after failed upload: 1 error occurred:\r\n        * 451 Transfer aborted\r\n0.002 seconds (measured here), 9.13 Mbytes per second\r\n\r\n2022/09/08 07:49:58 ERROR : test.41K: Failed to copy: update stor: 1 error occurred:\r\n        * 451 Transfer aborted\r\n0.002 seconds (measured here), 9.13 Mbytes per second\r\n\r\n2022/09/08 07:49:58 ERROR : Attempt 2/3 failed with 1 errors and: update stor: 1 error occurred:\r\n        * 451 Transfer aborted\r\n0.002 seconds (measured here), 9.13 Mbytes per second\r\n\r\n2022/09/08 07:49:58 DEBUG : test.41K: Need to transfer - File not found at Destination\r\n2022/09/08 07:49:59 DEBUG : ftp://web23.somedomain.com:21: Connecting to FTP server\r\n2022/09/08 07:49:59 DEBUG : test.41K: Removed after failed upload: 1 error occurred:\r\n        * 451 Error during read from data connection\r\nTransfer aborted\r\n0.002 seconds (measured here), 16.32 Mbytes per second\r\n\r\n2022/09/08 07:49:59 ERROR : test.41K: Failed to copy: update stor: 1 error occurred:\r\n        * 451 Error during read from data connection\r\nTransfer aborted\r\n0.002 seconds (measured here), 16.32 Mbytes per second\r\n\r\n2022/09/08 07:49:59 ERROR : Attempt 3/3 failed with 1 errors and: update stor: 1 error occurred:\r\n        * 451 Error during read from data connection\r\nTransfer aborted\r\n0.002 seconds (measured here), 16.32 Mbytes per second\r\n\r\n2022/09/08 07:49:59 INFO  : \r\nTransferred:          123 KiB / 123 KiB, 100%, 40.998 KiB/s, ETA 0s\r\nErrors:                 1 (retrying may help)\r\nElapsed time:         3.4s\r\n\r\n2022/09/08 07:49:59 DEBUG : 4 go routines active\r\n2022/09/08 07:49:59 DEBUG : ftp://web23.somedomain.com:21: closing 1 unused connections\r\n2022/09/08 07:49:59 Failed to copy: update stor: 1 error occurred:\r\n        * 451 Error during read from data connection\r\nTransfer aborted\r\n0.002 seconds (measured here), 16.32 Mbytes per second\r\n```\r\n\r\nFTP Server log of the 41k file upload attempt (file size is starting to be random)\r\n```\r\nSep  8 07:49:56 web23 pure-ftpd[1941648]: (user@2a00:a500:0:93::dead:beef) [NOTICE] /home/user//test.41K uploaded  (7116 bytes, 4271.27KB/sec)\r\nSep  8 07:49:57 web23 pure-ftpd[1941672]: (user@2a00:a500:0:93::dead:beef) [NOTICE] Deleted /home/user/test.41K\r\nSep  8 07:49:57 web23 pure-ftpd[1941672]: (user@2a00:a500:0:93::dead:beef) [NOTICE] /home/user//test.41K uploaded  (17790 bytes, 9345.63KB/sec)\r\nSep  8 07:49:58 web23 pure-ftpd[1941723]: (user@2a00:a500:0:93::dead:beef) [NOTICE] Deleted /home/user//test.41K\r\nSep  8 07:49:58 web23 pure-ftpd[1941723]: (user@2a00:a500:0:93::dead:beef) [NOTICE] /home/user//test.41K uploaded  (32768 bytes, 16710.37KB/sec)\r\nSep  8 07:49:59 web23 pure-ftpd[1941757]: (user@2a00:a500:0:93::dead:beef) [NOTICE] Deleted /home/user//test.41K\r\n```\r\n\r\n\r\n\r\n\r\n<!--- Please keep the note below for others who read your bug report. -->\r\n\r\n#### How to use GitHub\r\n\r\n* Please use the üëç [reaction](https://blog.github.com/2016-03-10-add-reactions-to-pull-requests-issues-and-comments/) to show that you are affected by the same issue.\r\n* Please don't comment if you have no relevant information to add. It's just extra noise for everyone subscribed to this issue.\r\n* Subscribe to receive notifications on status change and new comments.\r\n","closed_by":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/6426/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rclone/rclone/issues/6426/timeline","performed_via_github_app":null,"state_reason":"completed"}