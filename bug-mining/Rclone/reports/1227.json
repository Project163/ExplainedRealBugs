{"url":"https://api.github.com/repos/rclone/rclone/issues/7282","repository_url":"https://api.github.com/repos/rclone/rclone","labels_url":"https://api.github.com/repos/rclone/rclone/issues/7282/labels{/name}","comments_url":"https://api.github.com/repos/rclone/rclone/issues/7282/comments","events_url":"https://api.github.com/repos/rclone/rclone/issues/7282/events","html_url":"https://github.com/rclone/rclone/issues/7282","id":1884185677,"node_id":"I_kwDOAQ-n5M5wTmRN","number":7282,"title":"Sync/Copy/Move: write list of transferred/deleted files","user":{"login":"nielash","id":31582349,"node_id":"MDQ6VXNlcjMxNTgyMzQ5","avatar_url":"https://avatars.githubusercontent.com/u/31582349?v=4","gravatar_id":"","url":"https://api.github.com/users/nielash","html_url":"https://github.com/nielash","followers_url":"https://api.github.com/users/nielash/followers","following_url":"https://api.github.com/users/nielash/following{/other_user}","gists_url":"https://api.github.com/users/nielash/gists{/gist_id}","starred_url":"https://api.github.com/users/nielash/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nielash/subscriptions","organizations_url":"https://api.github.com/users/nielash/orgs","repos_url":"https://api.github.com/users/nielash/repos","events_url":"https://api.github.com/users/nielash/events{/privacy}","received_events_url":"https://api.github.com/users/nielash/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":86399007,"node_id":"MDU6TGFiZWw4NjM5OTAwNw==","url":"https://api.github.com/repos/rclone/rclone/labels/enhancement","name":"enhancement","color":"84b6eb","default":true,"description":null},{"id":431089529,"node_id":"MDU6TGFiZWw0MzEwODk1Mjk=","url":"https://api.github.com/repos/rclone/rclone/labels/IMPORTANT","name":"IMPORTANT","color":"d93f0b","default":false,"description":null},{"id":2504885756,"node_id":"MDU6TGFiZWwyNTA0ODg1NzU2","url":"https://api.github.com/repos/rclone/rclone/labels/UX","name":"UX","color":"bfd4f2","default":false,"description":""},{"id":3427818774,"node_id":"LA_kwDOAQ-n5M7MUF0W","url":"https://api.github.com/repos/rclone/rclone/labels/bisync","name":"bisync","color":"1D76DB","default":false,"description":""},{"id":3479933419,"node_id":"LA_kwDOAQ-n5M7Pa5Hr","url":"https://api.github.com/repos/rclone/rclone/labels/stats","name":"stats","color":"8DD270","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":14,"created_at":"2023-09-06T14:49:36Z","updated_at":"2024-10-04T06:33:55Z","closed_at":"2024-01-20T19:50:10Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"This is a feature request for the ability to access a complete list of files transferred/deleted by Sync/Copy/Move, as well as their basic attributes and any errors encountered. This is similar to [`rclone check`](https://rclone.org/commands/rclone_check/)'s ability to output lists for `MissingOnDst`, `MissingOnSrc`, etc.\r\n\r\nWhile this would be a nice feature in general for many reasons, I am primarily interested because it's currently the blocking issue for [Bisync's biggest bug](https://github.com/rclone/rclone/issues/5676).\r\n\r\n<details open>\r\n<summary>\r\n\r\n ### Prior discussion (from #6797)</summary>\r\n\r\n@nielash:\r\n> Just wanted to mention, in case it's related to the work you're planning here, that it would be really helpful for [future `bisync` work](https://github.com/rclone/rclone/issues/5676) to have an easy way to access a complete list of transfers. Similar to [`accounting.Stats(ctx).Transferred()`](https://github.com/rclone/rclone/blob/25703ad20ed34a8990fc02913e17a74692050d21/fs/accounting/stats.go#L492-L506), but that one is limited to `MaxCompletedTransfers` (100) and doesn't include `modtime` or `hash`. My hope is to use this to avoid having to re-list each fs at the end of a bisync run to find out what happened during the `syncCopyMove` operations, as re-listing is more expensive and [error-prone](https://github.com/rclone/rclone/issues/6841).\r\n>\r\n> If this maybe already exists and I'm missing it, please let me know üòÉ I see how to access the total number of transfers/errors, but we would need a list to reconcile it with the initial directory listings to build the \"after\" snapshot. If keeping the full transfer list in memory is a concern, we could potentially work with just a list of errored transfers (and infer that anything not on this list was successful and now matches what we passed in.) But this is not entirely foolproof, as it leaves open the possibility that files changed in between the listing and copying.\r\n\r\n@ncw:\r\n\r\n> That isn't quite what is under discussion here, but what I think you want is something like we have for `operations.Check` where you can pass in `io.Writer`s to have the file names written to.\r\n> \r\n> ```\r\n> type CheckOpt struct {\r\n> \tFdst, Fsrc   fs.Fs     // fses to check\r\n> \tCheck        checkFn   // function to use for checking\r\n> \tOneWay       bool      // one way only?\r\n> \tCombined     io.Writer // a file with file names with leading sigils\r\n> \tMissingOnSrc io.Writer // files only in the destination\r\n> \tMissingOnDst io.Writer // files only in the source\r\n> \tMatch        io.Writer // matching files\r\n> \tDiffer       io.Writer // differing files\r\n> \tError        io.Writer // files with errors of some kind\r\n> }\r\n> ```\r\n> \r\n> If you read the docs for [rclone check](https://rclone.org/commands/rclone_check/) you'll see the bits about outputting file names to files. People have asked for exactly this for sync/copy/move and I think this internal inteface would suit your requirements too.\r\n> \r\n> I should probably change the `io.Writer` into a `func(remote string) error` to explicitly say it will be called with a path each time. We'd need a way of signalling high level retries also as the functions potentially get called each high level retry.\r\n\r\n@nielash:\r\n\r\n> Yes, this would be great! (I used this recently in https://github.com/rclone/rclone/commit/5ca61ab70543abf740999b874ed65ec3ffc890cf.) For bisync purposes I think we'd also need the `size`, `modtime`, and `hash` in addition to the list of names (at least to the extent that `syncCopyMove` already has this info -- and I think it does, as that's how it knows if a file is \"corrupted on transfer\".)</details>\r\n\r\nIn addition to the above, it would also be important to know whether each operation was a copy or delete, and whether it had an error. The end goal is to update the initial listing, which uses this format:\r\n\r\nhttps://github.com/rclone/rclone/blob/b750c50bfd4440e88cc66c718ca20e0892f6404f/cmd/bisync/listing.go#L27-L32\r\n\r\nSee also: \r\n\r\n- https://github.com/rclone/rclone/issues/3933\r\n- https://github.com/rclone/rclone/issues/5676\r\n- https://github.com/rclone/rclone/issues/6841\r\n- [Forum discussion](https://forum.rclone.org/t/bisync-bugs-and-feature-requests/37636#:~:text=5.%20Final%20listings%20should%20be%20created%20from%20initial%20snapshot%20%2B%20deltas%2C%20not%20full%20re%2Dscans%2C%20to%20avoid%20errors%20if%20files%20changed%20during%20sync)\r\n- A [recent user post](https://forum.rclone.org/t/bisync-missed-syncing-changed-file-no-error-no-warning/41174) about this bug\r\n\r\n<!--- Please keep the note below for others who read your feature request. -->\r\n\r\n#### How to use GitHub\r\n\r\n* Please use the üëç [reaction](https://blog.github.com/2016-03-10-add-reactions-to-pull-requests-issues-and-comments/) to show that you are affected by the same issue.\r\n* Please don't comment if you have no relevant information to add. It's just extra noise for everyone subscribed to this issue.\r\n* Subscribe to receive notifications on status change and new comments.\r\n","closed_by":{"login":"nielash","id":31582349,"node_id":"MDQ6VXNlcjMxNTgyMzQ5","avatar_url":"https://avatars.githubusercontent.com/u/31582349?v=4","gravatar_id":"","url":"https://api.github.com/users/nielash","html_url":"https://github.com/nielash","followers_url":"https://api.github.com/users/nielash/followers","following_url":"https://api.github.com/users/nielash/following{/other_user}","gists_url":"https://api.github.com/users/nielash/gists{/gist_id}","starred_url":"https://api.github.com/users/nielash/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nielash/subscriptions","organizations_url":"https://api.github.com/users/nielash/orgs","repos_url":"https://api.github.com/users/nielash/repos","events_url":"https://api.github.com/users/nielash/events{/privacy}","received_events_url":"https://api.github.com/users/nielash/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/7282/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rclone/rclone/issues/7282/timeline","performed_via_github_app":null,"state_reason":"completed"}