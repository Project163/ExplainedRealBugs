{"url":"https://api.github.com/repos/rclone/rclone/issues/4250","repository_url":"https://api.github.com/repos/rclone/rclone","labels_url":"https://api.github.com/repos/rclone/rclone/issues/4250/labels{/name}","comments_url":"https://api.github.com/repos/rclone/rclone/issues/4250/comments","events_url":"https://api.github.com/repos/rclone/rclone/issues/4250/events","html_url":"https://github.com/rclone/rclone/issues/4250","id":620739773,"node_id":"MDU6SXNzdWU2MjA3Mzk3NzM=","number":4250,"title":"Detect expired token (Google Drive)","user":{"login":"tbm","id":1556037,"node_id":"MDQ6VXNlcjE1NTYwMzc=","avatar_url":"https://avatars.githubusercontent.com/u/1556037?v=4","gravatar_id":"","url":"https://api.github.com/users/tbm","html_url":"https://github.com/tbm","followers_url":"https://api.github.com/users/tbm/followers","following_url":"https://api.github.com/users/tbm/following{/other_user}","gists_url":"https://api.github.com/users/tbm/gists{/gist_id}","starred_url":"https://api.github.com/users/tbm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tbm/subscriptions","organizations_url":"https://api.github.com/users/tbm/orgs","repos_url":"https://api.github.com/users/tbm/repos","events_url":"https://api.github.com/users/tbm/events{/privacy}","received_events_url":"https://api.github.com/users/tbm/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":86399007,"node_id":"MDU6TGFiZWw4NjM5OTAwNw==","url":"https://api.github.com/repos/rclone/rclone/labels/enhancement","name":"enhancement","color":"84b6eb","default":true,"description":null},{"id":306062764,"node_id":"MDU6TGFiZWwzMDYwNjI3NjQ=","url":"https://api.github.com/repos/rclone/rclone/labels/Remote:%20Drive","name":"Remote: Drive","color":"fbca04","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2020-05-19T07:19:16Z","updated_at":"2020-08-20T19:27:08Z","closed_at":"2020-05-19T15:22:24Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"#### What is the problem you are having with rclone?\r\n\r\nWhen I run rclone on a previously configured Google Drive, I get:\r\n\r\n```\r\n2020/05/19 15:08:34 Failed to create file system for \"spi-drive:audit/2019/README.pdf\": couldn't find root directory ID: Get https://www.googleapis.com/drive/v3/files/root?alt=json&fields=id&prettyPrint=false&supportsAllDrives=true: oauth2: cannot fetch token: 400 Bad Request\r\nResponse: {\r\n  \"error\": \"invalid_grant\",\r\n  \"error_description\": \"Bad Request\"\r\n}\r\n```\r\n\r\nThis issue was previously reported in #3073 but this was closed because the bug reporter didn't reply.\r\n\r\nIn this issue @ncw said:\r\n\r\n> I've never seen it go wrong but it does go wrong sometimes \r\n\r\n> So what I think you are asking for is that rclone detects this error\r\n> And translates it into something more user friendly.\r\n\r\n> This should definitely not be happening in normal operation though - can you replicate the problem reliably? If so can you work out why it is happening?\r\n\r\nThe same still applies.  Yes, the error should be more user friendly.\r\n\r\nFWIW, if I removed the expired token from the config, I get:\r\n\r\n> 2020/05/15 18:14:30 Failed to create file system for \"spi-drive:\": drive: failed when making oauth client: failed to create oauth client: empty token found - \r\nplease run rclone config again\r\n\r\nwhich is more user friendly.\r\n\r\nAnyway, why is this happening?  I configured the Google Drive in rclone last year and haven't used it in 10 months.  So I guess rclone doesn't cope well with really old tokens.\r\n\r\nI can repeat 100%.  I also saved the old config (with the old token), ran `rclone config` to get a new token; when I copy the old config in place I can reproduce this issue 100%.\r\n\r\n#### What is your rclone version (output from `rclone version`)\r\n\r\nI was using 1.45 and 1.50.2 from Debian previously but I've also verified that it happens with the Linux binary from GitHub: version 1.51.0.\r\n\r\n#### Which OS you are using and how many bits (eg Windows 7, 64 bit)\r\n\r\nDebian, 64 bit x86\r\n\r\n####  Which cloud storage system are you using? (eg Google Drive)\r\n\r\nGoogle Drive\r\n\r\n#### A log from the command with the `-vv` flag (eg output from `rclone -vv copy /tmp remote:tmp`)\r\n\r\nOutput with `-vv`:\r\n\r\n```\r\n~/rclone-v1.51.0-linux-amd64/rclone tree -vv spi-drive:audit/2019/README.pdf     \r\n2020/05/19 15:09:48 DEBUG : rclone: Version \"v1.51.0\" starting with parameters [\"/home/tbm/rclone-v1.51.0-linux-amd64/rclone\" \"tree\" \"-vv\" \"spi-drive:audit/2019/README.pdf\"]\r\n2020/05/19 15:09:48 DEBUG : Using config file from \"/home/tbm/.config/rclone/rclone.conf\"\r\n2020/05/19 15:09:48 DEBUG : spi-drive: Loaded invalid token from config file - ignoring\r\n2020/05/19 15:09:49 DEBUG : spi-drive: Token refresh failed try 1/5: oauth2: cannot fetch token: 400 Bad Request\r\nResponse: {\r\n  \"error\": \"invalid_grant\",\r\n  \"error_description\": \"Bad Request\"\r\n}\r\n2020/05/19 15:09:50 DEBUG : spi-drive: Loaded invalid token from config file - ignoring\r\n2020/05/19 15:09:50 DEBUG : spi-drive: Token refresh failed try 2/5: oauth2: cannot fetch token: 400 Bad Request\r\nResponse: {\r\n  \"error\": \"invalid_grant\",\r\n  \"error_description\": \"Bad Request\"\r\n}\r\n2020/05/19 15:09:51 DEBUG : spi-drive: Loaded invalid token from config file - ignoring\r\n2020/05/19 15:09:51 DEBUG : spi-drive: Token refresh failed try 3/5: oauth2: cannot fetch token: 400 Bad Request\r\nResponse: {\r\n  \"error\": \"invalid_grant\",\r\n  \"error_description\": \"Bad Request\"\r\n}\r\n2020/05/19 15:09:52 DEBUG : spi-drive: Loaded invalid token from config file - ignoring\r\n2020/05/19 15:09:53 DEBUG : spi-drive: Token refresh failed try 4/5: oauth2: cannot fetch token: 400 Bad Request\r\nResponse: {\r\n  \"error\": \"invalid_grant\",\r\n  \"error_description\": \"Bad Request\"\r\n}\r\n2020/05/19 15:09:54 DEBUG : spi-drive: Loaded invalid token from config file - ignoring\r\n2020/05/19 15:09:54 DEBUG : spi-drive: Token refresh failed try 5/5: oauth2: cannot fetch token: 400 Bad Request\r\nResponse: {\r\n  \"error\": \"invalid_grant\",\r\n  \"error_description\": \"Bad Request\"\r\n}\r\n2020/05/19 15:09:55 Failed to create file system for \"spi-drive:audit/2019/README.pdf\": couldn't find root directory ID: Get https://www.googleapis.com/drive/v3/files/root?alt=json&fields=id&prettyPrint=false&supportsAllDrives=true: oauth2: cannot fetch token: 400 Bad Request\r\nResponse: {\r\n  \"error\": \"invalid_grant\",\r\n  \"error_description\": \"Bad Request\"\r\n}\r\n```\r\n","closed_by":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/4250/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rclone/rclone/issues/4250/timeline","performed_via_github_app":null,"state_reason":"completed"}