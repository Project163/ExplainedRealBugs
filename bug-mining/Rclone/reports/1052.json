{"url":"https://api.github.com/repos/rclone/rclone/issues/5422","repository_url":"https://api.github.com/repos/rclone/rclone","labels_url":"https://api.github.com/repos/rclone/rclone/issues/5422/labels{/name}","comments_url":"https://api.github.com/repos/rclone/rclone/issues/5422/comments","events_url":"https://api.github.com/repos/rclone/rclone/issues/5422/events","html_url":"https://github.com/rclone/rclone/issues/5422","id":927498094,"node_id":"MDU6SXNzdWU5Mjc0OTgwOTQ=","number":5422,"title":"Include X-Amz-Content-Sha256 header for all requests to S3 (currently only done for requests with no content)","user":{"login":"ctgschollar","id":1866355,"node_id":"MDQ6VXNlcjE4NjYzNTU=","avatar_url":"https://avatars.githubusercontent.com/u/1866355?v=4","gravatar_id":"","url":"https://api.github.com/users/ctgschollar","html_url":"https://github.com/ctgschollar","followers_url":"https://api.github.com/users/ctgschollar/followers","following_url":"https://api.github.com/users/ctgschollar/following{/other_user}","gists_url":"https://api.github.com/users/ctgschollar/gists{/gist_id}","starred_url":"https://api.github.com/users/ctgschollar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ctgschollar/subscriptions","organizations_url":"https://api.github.com/users/ctgschollar/orgs","repos_url":"https://api.github.com/users/ctgschollar/repos","events_url":"https://api.github.com/users/ctgschollar/events{/privacy}","received_events_url":"https://api.github.com/users/ctgschollar/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":86399007,"node_id":"MDU6TGFiZWw4NjM5OTAwNw==","url":"https://api.github.com/repos/rclone/rclone/labels/enhancement","name":"enhancement","color":"84b6eb","default":true,"description":null},{"id":314138213,"node_id":"MDU6TGFiZWwzMTQxMzgyMTM=","url":"https://api.github.com/repos/rclone/rclone/labels/Remote:%20S3","name":"Remote: S3","color":"fbca04","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":18,"created_at":"2021-06-22T18:00:40Z","updated_at":"2024-08-13T21:29:31Z","closed_at":"2022-05-12T07:49:44Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"<!--\r\n\r\nWelcome :-)\r\n\r\nSo you've got an idea to improve rclone? We love that!\r\nYou'll be glad to hear we've incorporated hundreds of ideas from contributors already.\r\n\r\nProbably the latest beta (or stable) release has your feature, so try to update your rclone.\r\nThe update instructions are available at https://rclone.org/commands/rclone_selfupdate/\r\n\r\nIf it still isn't there, here is a checklist of things to do:\r\n\r\n  1. Search the old issues for your idea and +1 or comment on an existing issue if possible.\r\n  2. Discuss on the forum: https://forum.rclone.org/\r\n  3. Make a feature request issue (this is the right place!).\r\n  4. Be prepared to get involved making the feature :-)\r\n\r\nLooking forward to your great idea!\r\n\r\nThe Rclone Developers\r\n\r\n-->\r\n\r\n#### The associated forum post URL from `https://forum.rclone.org`\r\n\r\nI asked on the forum, but I haven't gotten any comments there yet unfortunately\r\nhttps://forum.rclone.org/t/send-x-amz-content-sha256-header-with-put-for-ceph-s3/24913\r\n\r\n#### What is your current rclone version (output from `rclone version`)?\r\nrclone v1.56.0-beta.5554.e635f4c0b\r\n- os/version: ubuntu 19.04 (64 bit)\r\n- os/kernel: 5.5.10-050510-generic (x86_64)\r\n- os/type: linux\r\n- os/arch: amd64\r\n- go/version: go1.16.5\r\n- go/linking: static\r\n- go/tags: none\r\n\r\n#### What problem are you are trying to solve?\r\n\r\nSome requests to my S3 endpoint do not include the X-Amz-Content-Sha256 header. Some do, I assume that the SHA256 is calculated as it is required to sign the request.\r\n\r\nI am trying to run my own authentication in between a Ceph S3 endpoint and different clients. To do this I need to resign each request and I would rather not have to calculate the SHA256 in my authentication endpoint if the client is already doing it. Especially seeing as rclone already includes this header for some requests. Frustratingly it is only included for empty requests at the moment, the only requests for which including the X-Amz-Content-Sha256 is not very useful as it is always the same.\r\n\r\nI show some examples below, for the command \r\n\r\n```\r\nrclone -vv --dump headers --config=conf/rclone.minio.conf copy /home/chris/git/red_auth/tests/test_data/10K local_red:/test/10K-put\r\n```\r\nWhere I try to upload a file 10K\r\n\r\nSee for empty head requests you have the header\r\n```\r\n2021/06/22 19:24:38 DEBUG : >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>\r\n2021/06/22 19:24:38 DEBUG : HTTP REQUEST (req 0xc00068d000)\r\n2021/06/22 19:24:38 DEBUG : HEAD /test/10K-put HTTP/1.1\r\nHost: red.tsolo.io:91\r\nUser-Agent: rclone/v1.56.0-beta.5554.e635f4c0b\r\nAuthorization: XXXX\r\nX-Amz-Content-Sha256: e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855\r\nX-Amz-Date: 20210622T172438Z\r\n\r\n2021/06/22 19:24:38 DEBUG : >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>\r\n```\r\n\r\nFor empty PUT requests you have the header (notice it is identical to the one above)\r\n```\r\n2021/06/22 19:24:38 DEBUG : <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<\r\n2021/06/22 19:24:38 DEBUG : 10K: Need to transfer - File not found at Destination\r\n2021/06/22 19:24:38 DEBUG : >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>\r\n2021/06/22 19:24:38 DEBUG : HTTP REQUEST (req 0xc000201b00)\r\n2021/06/22 19:24:38 DEBUG : PUT /test HTTP/1.1\r\nHost: red.tsolo.io:91\r\nUser-Agent: rclone/v1.56.0-beta.5554.e635f4c0b\r\nContent-Length: 0\r\nAuthorization: XXXX\r\nX-Amz-Acl: private\r\nX-Amz-Content-Sha256: e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855\r\nX-Amz-Date: 20210622T172438Z\r\nAccept-Encoding: gzip\r\n\r\n2021/06/22 19:24:38 DEBUG : >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>\r\n```\r\n\r\nAnd then for a PUT request where there is actual content and the header would be really useful in my case, it is missing.\r\n\r\n```\r\n2021/06/22 19:24:38 DEBUG : >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>\r\n2021/06/22 19:24:38 DEBUG : HTTP REQUEST (req 0xc000201d00)\r\n2021/06/22 19:24:38 DEBUG : PUT /test/10K-put/10K?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=minioadmin%2F20210622%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20210622T172438Z&X-Amz-Expires=900&X-Amz-SignedHeaders=content-md5%3Bcontent-type%3Bhost%3Bx-amz-acl%3Bx-amz-meta-mtime&X-Amz-Signature=8a683151d83a566491a3951b970ff101e7e499d23e7e6e373544be72b7e542d3 HTTP/1.1\r\nHost: red.tsolo.io:91\r\nUser-Agent: rclone/v1.56.0-beta.5554.e635f4c0b\r\nContent-Length: 10241\r\ncontent-md5: JTNr8mA9kHNPITNgDFfkZg==\r\ncontent-type: application/octet-stream\r\nx-amz-acl: private\r\nx-amz-meta-mtime: 1624093944.888508793\r\nAccept-Encoding: gzip\r\n\r\n2021/06/22 19:24:38 DEBUG : >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>\r\n```\r\n\r\n#### How do you think rclone should be changed to solve that?\r\n\r\nInclude the X-Amz-Content-Sha256 header for all requests to a S3 endpoint. It is already being calculated and rclone is using the header in some requests.\r\n\r\n<!--- Please keep the note below for others who read your feature request. -->\r\n\r\n#### How to use GitHub\r\n\r\n* Please use the üëç [reaction](https://blog.github.com/2016-03-10-add-reactions-to-pull-requests-issues-and-comments/) to show that you are affected by the same issue.\r\n* Please don't comment if you have no relevant information to add. It's just extra noise for everyone subscribed to this issue.\r\n* Subscribe to receive notifications on status change and new comments.\r\n","closed_by":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/5422/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rclone/rclone/issues/5422/timeline","performed_via_github_app":null,"state_reason":"completed"}