[{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/515780262","html_url":"https://github.com/rclone/rclone/issues/3381#issuecomment-515780262","issue_url":"https://api.github.com/repos/rclone/rclone/issues/3381","id":515780262,"node_id":"MDEyOklzc3VlQ29tbWVudDUxNTc4MDI2Mg==","user":{"login":"bdutro","id":5447668,"node_id":"MDQ6VXNlcjU0NDc2Njg=","avatar_url":"https://avatars.githubusercontent.com/u/5447668?v=4","gravatar_id":"","url":"https://api.github.com/users/bdutro","html_url":"https://github.com/bdutro","followers_url":"https://api.github.com/users/bdutro/followers","following_url":"https://api.github.com/users/bdutro/following{/other_user}","gists_url":"https://api.github.com/users/bdutro/gists{/gist_id}","starred_url":"https://api.github.com/users/bdutro/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bdutro/subscriptions","organizations_url":"https://api.github.com/users/bdutro/orgs","repos_url":"https://api.github.com/users/bdutro/repos","events_url":"https://api.github.com/users/bdutro/events{/privacy}","received_events_url":"https://api.github.com/users/bdutro/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-07-28T17:26:50Z","updated_at":"2019-07-28T17:26:50Z","body":"Here's a Python 2 script that will reproduce the error:\r\n\r\n    import os\r\n    import mmap\r\n\r\n    RCLONE_DIR = '/mnt/box_enc/'\r\n    TESTFILE = 'test'\r\n    RCLONE_TESTFILE = os.path.join(RCLONE_DIR, TESTFILE)\r\n\r\n    def run_test(filename):\r\n        print 'Writing to ' + filename\r\n        test_data = '0123456789'\r\n        with open(filename, 'wb+') as f:\r\n            f.truncate(len(test_data) + 2)\r\n            f.flush()\r\n            os.fdatasync(f.fileno())\r\n            st = os.fstat(f.fileno())\r\n            sz = st.st_size\r\n            mm = mmap.mmap(f.fileno(), sz, mmap.MAP_SHARED, mmap.PROT_READ | mmap.PROT_WRITE)\r\n            mm.write(test_data)\r\n            del mm\r\n            f.seek(len(test_data))\r\n            f.write('10')\r\n\r\n    print 'Testing local directory...'\r\n    run_test(TESTFILE) # Succeeds\r\n\r\n    print 'Testing rclone directory...'\r\n    run_test(RCLONE_TESTFILE) # Fails\r\n\r\nHere's another version that just does the dup() without getting mmap involved:\r\n\r\n```\r\nimport os\r\n\r\nRCLONE_DIR = '/mnt/box_enc/'\r\nTESTFILE = 'test'\r\nRCLONE_TESTFILE = os.path.join(RCLONE_DIR, TESTFILE)\r\n\r\ndef run_test(filename):\r\n    print 'Writing to ' + filename\r\n    test_data = '0123456789'\r\n    with open(filename, 'wb+') as f:\r\n        f.truncate(len(test_data) + 2)\r\n        f.flush()\r\n        os.fdatasync(f.fileno())\r\n        f2 = os.dup(f.fileno())\r\n        os.write(f2, test_data)\r\n        os.close(f2)\r\n        f.seek(len(test_data))\r\n        f.write('10')\r\n\r\nprint 'Testing local directory...'\r\nrun_test(TESTFILE)\r\n\r\nprint 'Testing rclone directory...'\r\nrun_test(RCLONE_TESTFILE)\r\n```","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/515780262/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"bdutro","id":5447668,"node_id":"MDQ6VXNlcjU0NDc2Njg=","avatar_url":"https://avatars.githubusercontent.com/u/5447668?v=4","gravatar_id":"","url":"https://api.github.com/users/bdutro","html_url":"https://github.com/bdutro","followers_url":"https://api.github.com/users/bdutro/followers","following_url":"https://api.github.com/users/bdutro/following{/other_user}","gists_url":"https://api.github.com/users/bdutro/gists{/gist_id}","starred_url":"https://api.github.com/users/bdutro/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bdutro/subscriptions","organizations_url":"https://api.github.com/users/bdutro/orgs","repos_url":"https://api.github.com/users/bdutro/repos","events_url":"https://api.github.com/users/bdutro/events{/privacy}","received_events_url":"https://api.github.com/users/bdutro/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/515925367","html_url":"https://github.com/rclone/rclone/issues/3381#issuecomment-515925367","issue_url":"https://api.github.com/repos/rclone/rclone/issues/3381","id":515925367,"node_id":"MDEyOklzc3VlQ29tbWVudDUxNTkyNTM2Nw==","user":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-07-29T09:50:18Z","updated_at":"2019-07-29T09:50:18Z","body":"Thanks for reporting this.\r\n\r\nI've edited my thoughts from [our discussion on the forum](https://forum.rclone.org/t/rclone-mount-vfs-cache-doesnt-appear-to-handle-dup-calls-gracefully/11030).\r\n\r\n### Discussion\r\n\r\nI think your analysis is correct.\r\n\r\nThe problem is all to do with the FUSE interface for flushing and releasing file handles. The `dup()` doesn't get passed to rclone.\r\n\r\nIf you take a look at the FUSE FAQ you'll get an idea of what happens: https://github.com/libfuse/libfuse/wiki/FAQ#user-content-which-method-is-called-on-the-close-system-call\r\n\r\nCurrently rclone tries to close the file in `flush` if at all possible then it can return errors to the user.  If the file handle hasn't been written to then it does nothing in `flush`.  This covers 90% of the uses of `dup()` which generally only write things from one process.\r\n\r\nThe strace above shows that the first process with FH 3 writes to the file and presumably the one with FH17 does too (though that isn't in the strace since the file is mmaped).  This means that when FH 17 is flushed, rclone will say - has this been written - yes, lets write it properly.\r\n\r\nSo when the process closes FH 3 it has already been closed and hence the error.\r\n\r\n### Solution\r\n\r\nI think the correct solution to this is to re-arrange what happens on `flush` and `release`.\r\n\r\nThe previous logic was taken from the non cached versions of read and write, and for those, I think we can't do any better.  However using `--vfs-cache-mode writes` or higher, we can do better.\r\n\r\nSo I think the right solution is\r\n\r\n- In flush\r\n    - if fh for cache file not open, return\r\n    - close cache fh\r\n    - if no writes since last flush, return\r\n    - sync file to cloud storage\r\n    - return but **do not** close the FUSE fh\r\n- In release\r\n    - run the flush code just in case (it should do nothing)\r\n    - close the FUSE fh - the file has already been synced here so no significant errors to return\r\n\r\nThat should minimise the file being written twice in flush.\r\n\r\nHere is the [flush code](https://github.com/ncw/rclone/blob/a35aa1360e3e09d4973d52d995f7edaae803adb3/vfs/read_write.go#L330) - the release code is just below if you want to see for yourself what is happening.\r\n\r\nThank you for the repro scripts - very useful. I'll turn the second one into a unit test for rclone.\r\n","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/515925367/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":2515924421,"node_id":"MDEyOkxhYmVsZWRFdmVudDI1MTU5MjQ0MjE=","url":"https://api.github.com/repos/rclone/rclone/issues/events/2515924421","actor":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2019-07-29T09:50:26Z","label":{"name":"bug","color":"fc2929"},"performed_via_github_app":null},{"id":2515924624,"node_id":"MDE1Ok1pbGVzdG9uZWRFdmVudDI1MTU5MjQ2MjQ=","url":"https://api.github.com/repos/rclone/rclone/issues/events/2515924624","actor":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"milestoned","commit_id":null,"commit_url":null,"created_at":"2019-07-29T09:50:31Z","milestone":{"title":"v1.49"},"performed_via_github_app":null},{"id":2515925025,"node_id":"MDEyOkxhYmVsZWRFdmVudDI1MTU5MjUwMjU=","url":"https://api.github.com/repos/rclone/rclone/issues/events/2515925025","actor":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2019-07-29T09:50:39Z","label":{"name":"VFS / mount","color":"0e8a16"},"performed_via_github_app":null},{"id":2586382691,"node_id":"MDE3OkRlbWlsZXN0b25lZEV2ZW50MjU4NjM4MjY5MQ==","url":"https://api.github.com/repos/rclone/rclone/issues/events/2586382691","actor":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"demilestoned","commit_id":null,"commit_url":null,"created_at":"2019-08-27T09:22:49Z","milestone":{"title":"v1.49"},"performed_via_github_app":null},{"id":2586382694,"node_id":"MDE1Ok1pbGVzdG9uZWRFdmVudDI1ODYzODI2OTQ=","url":"https://api.github.com/repos/rclone/rclone/issues/events/2586382694","actor":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"milestoned","commit_id":null,"commit_url":null,"created_at":"2019-08-27T09:22:49Z","milestone":{"title":"v1.50"},"performed_via_github_app":null},{"actor":{"login":"bdutro","id":5447668,"node_id":"MDQ6VXNlcjU0NDc2Njg=","avatar_url":"https://avatars.githubusercontent.com/u/5447668?v=4","gravatar_id":"","url":"https://api.github.com/users/bdutro","html_url":"https://github.com/bdutro","followers_url":"https://api.github.com/users/bdutro/followers","following_url":"https://api.github.com/users/bdutro/following{/other_user}","gists_url":"https://api.github.com/users/bdutro/gists{/gist_id}","starred_url":"https://api.github.com/users/bdutro/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bdutro/subscriptions","organizations_url":"https://api.github.com/users/bdutro/orgs","repos_url":"https://api.github.com/users/bdutro/repos","events_url":"https://api.github.com/users/bdutro/events{/privacy}","received_events_url":"https://api.github.com/users/bdutro/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-10-06T22:25:21Z","updated_at":"2019-10-06T22:25:21Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/rclone/rclone/issues/3596","repository_url":"https://api.github.com/repos/rclone/rclone","labels_url":"https://api.github.com/repos/rclone/rclone/issues/3596/labels{/name}","comments_url":"https://api.github.com/repos/rclone/rclone/issues/3596/comments","events_url":"https://api.github.com/repos/rclone/rclone/issues/3596/events","html_url":"https://github.com/rclone/rclone/pull/3596","id":503169513,"node_id":"MDExOlB1bGxSZXF1ZXN0MzI1MDgwNzc5","number":3596,"title":"Replace close() call in Flush() with writeback of dirty data to backing storage (Fix for #3381)","user":{"login":"bdutro","id":5447668,"node_id":"MDQ6VXNlcjU0NDc2Njg=","avatar_url":"https://avatars.githubusercontent.com/u/5447668?v=4","gravatar_id":"","url":"https://api.github.com/users/bdutro","html_url":"https://github.com/bdutro","followers_url":"https://api.github.com/users/bdutro/followers","following_url":"https://api.github.com/users/bdutro/following{/other_user}","gists_url":"https://api.github.com/users/bdutro/gists{/gist_id}","starred_url":"https://api.github.com/users/bdutro/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bdutro/subscriptions","organizations_url":"https://api.github.com/users/bdutro/orgs","repos_url":"https://api.github.com/users/bdutro/repos","events_url":"https://api.github.com/users/bdutro/events{/privacy}","received_events_url":"https://api.github.com/users/bdutro/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2019-10-06T22:25:21Z","updated_at":"2019-10-10T13:09:16Z","closed_at":"2019-10-09T09:07:31Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"draft":false,"repository":{"id":17803236,"node_id":"MDEwOlJlcG9zaXRvcnkxNzgwMzIzNg==","name":"rclone","full_name":"rclone/rclone","private":false,"owner":{"login":"rclone","id":24937341,"node_id":"MDEyOk9yZ2FuaXphdGlvbjI0OTM3MzQx","avatar_url":"https://avatars.githubusercontent.com/u/24937341?v=4","gravatar_id":"","url":"https://api.github.com/users/rclone","html_url":"https://github.com/rclone","followers_url":"https://api.github.com/users/rclone/followers","following_url":"https://api.github.com/users/rclone/following{/other_user}","gists_url":"https://api.github.com/users/rclone/gists{/gist_id}","starred_url":"https://api.github.com/users/rclone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rclone/subscriptions","organizations_url":"https://api.github.com/users/rclone/orgs","repos_url":"https://api.github.com/users/rclone/repos","events_url":"https://api.github.com/users/rclone/events{/privacy}","received_events_url":"https://api.github.com/users/rclone/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/rclone/rclone","description":"\"rsync for cloud storage\" - Google Drive, S3, Dropbox, Backblaze B2, One Drive, Swift, Hubic, Wasabi, Google Cloud Storage, Azure Blob, Azure Files, Yandex Files","fork":false,"url":"https://api.github.com/repos/rclone/rclone","forks_url":"https://api.github.com/repos/rclone/rclone/forks","keys_url":"https://api.github.com/repos/rclone/rclone/keys{/key_id}","collaborators_url":"https://api.github.com/repos/rclone/rclone/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/rclone/rclone/teams","hooks_url":"https://api.github.com/repos/rclone/rclone/hooks","issue_events_url":"https://api.github.com/repos/rclone/rclone/issues/events{/number}","events_url":"https://api.github.com/repos/rclone/rclone/events","assignees_url":"https://api.github.com/repos/rclone/rclone/assignees{/user}","branches_url":"https://api.github.com/repos/rclone/rclone/branches{/branch}","tags_url":"https://api.github.com/repos/rclone/rclone/tags","blobs_url":"https://api.github.com/repos/rclone/rclone/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/rclone/rclone/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/rclone/rclone/git/refs{/sha}","trees_url":"https://api.github.com/repos/rclone/rclone/git/trees{/sha}","statuses_url":"https://api.github.com/repos/rclone/rclone/statuses/{sha}","languages_url":"https://api.github.com/repos/rclone/rclone/languages","stargazers_url":"https://api.github.com/repos/rclone/rclone/stargazers","contributors_url":"https://api.github.com/repos/rclone/rclone/contributors","subscribers_url":"https://api.github.com/repos/rclone/rclone/subscribers","subscription_url":"https://api.github.com/repos/rclone/rclone/subscription","commits_url":"https://api.github.com/repos/rclone/rclone/commits{/sha}","git_commits_url":"https://api.github.com/repos/rclone/rclone/git/commits{/sha}","comments_url":"https://api.github.com/repos/rclone/rclone/comments{/number}","issue_comment_url":"https://api.github.com/repos/rclone/rclone/issues/comments{/number}","contents_url":"https://api.github.com/repos/rclone/rclone/contents/{+path}","compare_url":"https://api.github.com/repos/rclone/rclone/compare/{base}...{head}","merges_url":"https://api.github.com/repos/rclone/rclone/merges","archive_url":"https://api.github.com/repos/rclone/rclone/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/rclone/rclone/downloads","issues_url":"https://api.github.com/repos/rclone/rclone/issues{/number}","pulls_url":"https://api.github.com/repos/rclone/rclone/pulls{/number}","milestones_url":"https://api.github.com/repos/rclone/rclone/milestones{/number}","notifications_url":"https://api.github.com/repos/rclone/rclone/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/rclone/rclone/labels{/name}","releases_url":"https://api.github.com/repos/rclone/rclone/releases{/id}","deployments_url":"https://api.github.com/repos/rclone/rclone/deployments","created_at":"2014-03-16T16:19:57Z","updated_at":"2025-11-09T20:38:02Z","pushed_at":"2025-11-08T21:33:38Z","git_url":"git://github.com/rclone/rclone.git","ssh_url":"git@github.com:rclone/rclone.git","clone_url":"https://github.com/rclone/rclone.git","svn_url":"https://github.com/rclone/rclone","homepage":"https://rclone.org","size":217990,"stargazers_count":53422,"watchers_count":53422,"language":"Go","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":true,"has_pages":false,"has_discussions":false,"forks_count":4767,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":1169,"license":{"key":"mit","name":"MIT License","spdx_id":"MIT","url":"https://api.github.com/licenses/mit","node_id":"MDc6TGljZW5zZTEz"},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["azure-blob","azure-blob-storage","azure-files","backblaze-b2","cloud-storage","dropbox","encryption","ftp","fuse-filesystem","go","golang","google-cloud-storage","google-drive","onedrive","openstack-swift","rclone","s3","sftp","sync","webdav"],"visibility":"public","forks":4767,"open_issues":1169,"watchers":53422,"default_branch":"master","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"pull_request":{"url":"https://api.github.com/repos/rclone/rclone/pulls/3596","html_url":"https://github.com/rclone/rclone/pull/3596","diff_url":"https://github.com/rclone/rclone/pull/3596.diff","patch_url":"https://github.com/rclone/rclone/pull/3596.patch","merged_at":"2019-10-09T09:07:30Z"},"body":"<!--\r\nThank you very much for contributing code or documentation to rclone! Please\r\nfill out the following questions to make it easier for us to review your\r\nchanges.\r\n\r\nYou do not need to check all the boxes below all at once, feel free to take\r\nyour time and add more commits. If you're done and ready for review, please\r\ncheck the last box.\r\n-->\r\n\r\n#### What is the purpose of this change?\r\n\r\n<!--\r\nDescribe the changes here\r\n-->\r\n\r\nvfs: move writeback of dirty data out of close() method into its own method (FlushWrites) and remove close() call from Flush()\r\n    \r\nIf a file handle is duplicated with dup() and the duplicate handle is flushed, rclone will go ahead and close the file, making the original file handle stale. This change removes the close() call from Flush() and replaces it with FlushWrites() so that the file only gets closed when Release() is called. The new FlushWrites method takes care of actually writing the file back to the underlying storage.\r\n\r\nFixes #3381\r\n\r\n#### Was the change discussed in an issue or in the forum before?\r\n\r\nhttps://github.com/rclone/rclone/issues/3381\r\nhttps://forum.rclone.org/t/rclone-mount-vfs-cache-doesnt-appear-to-handle-dup-calls-gracefully/11030\r\n\r\n#### Checklist\r\n\r\n- [x] I have read the [contribution guidelines](https://github.com/rclone/rclone/blob/master/CONTRIBUTING.md#submitting-a-pull-request).\r\n- [x] I have added tests for all changes in this PR if appropriate.\r\n- [x] I have added documentation for the changes if appropriate.\r\n- [x] All commit messages are in [house style](https://github.com/rclone/rclone/blob/master/CONTRIBUTING.md#commit-messages).\r\n- [x] I'm done, this Pull Request is ready for review :-)\r\n","reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/3596/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rclone/rclone/issues/3596/timeline","performed_via_github_app":null,"state_reason":null}},"event":"cross-referenced"},{"id":2698235798,"node_id":"MDExOkNsb3NlZEV2ZW50MjY5ODIzNTc5OA==","url":"https://api.github.com/repos/rclone/rclone/issues/events/2698235798","actor":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"closed","commit_id":null,"commit_url":null,"created_at":"2019-10-09T09:07:31Z","state_reason":null,"performed_via_github_app":null},{"id":2698235868,"node_id":"MDE1OlJlZmVyZW5jZWRFdmVudDI2OTgyMzU4Njg=","url":"https://api.github.com/repos/rclone/rclone/issues/events/2698235868","actor":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"7d0d7e66ca0b088a79c5ae0a0eb9148cfd537dec","commit_url":"https://api.github.com/repos/rclone/rclone/commits/7d0d7e66ca0b088a79c5ae0a0eb9148cfd537dec","created_at":"2019-10-09T09:07:32Z","performed_via_github_app":null}]