{"url":"https://api.github.com/repos/rclone/rclone/issues/3345","repository_url":"https://api.github.com/repos/rclone/rclone","labels_url":"https://api.github.com/repos/rclone/rclone/issues/3345/labels{/name}","comments_url":"https://api.github.com/repos/rclone/rclone/issues/3345/comments","events_url":"https://api.github.com/repos/rclone/rclone/issues/3345/events","html_url":"https://github.com/rclone/rclone/issues/3345","id":467708446,"node_id":"MDU6SXNzdWU0Njc3MDg0NDY=","number":3345,"title":"upstream XML decoding bug.. command rclone info has broken s3 remote","user":{"login":"SocialCrypt-Verify","id":42997171,"node_id":"MDQ6VXNlcjQyOTk3MTcx","avatar_url":"https://avatars.githubusercontent.com/u/42997171?v=4","gravatar_id":"","url":"https://api.github.com/users/SocialCrypt-Verify","html_url":"https://github.com/SocialCrypt-Verify","followers_url":"https://api.github.com/users/SocialCrypt-Verify/followers","following_url":"https://api.github.com/users/SocialCrypt-Verify/following{/other_user}","gists_url":"https://api.github.com/users/SocialCrypt-Verify/gists{/gist_id}","starred_url":"https://api.github.com/users/SocialCrypt-Verify/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SocialCrypt-Verify/subscriptions","organizations_url":"https://api.github.com/users/SocialCrypt-Verify/orgs","repos_url":"https://api.github.com/users/SocialCrypt-Verify/repos","events_url":"https://api.github.com/users/SocialCrypt-Verify/events{/privacy}","received_events_url":"https://api.github.com/users/SocialCrypt-Verify/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":86399005,"node_id":"MDU6TGFiZWw4NjM5OTAwNQ==","url":"https://api.github.com/repos/rclone/rclone/labels/bug","name":"bug","color":"fc2929","default":true,"description":null},{"id":314138213,"node_id":"MDU6TGFiZWwzMTQxMzgyMTM=","url":"https://api.github.com/repos/rclone/rclone/labels/Remote:%20S3","name":"Remote: S3","color":"fbca04","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":25,"created_at":"2019-07-13T11:29:09Z","updated_at":"2019-10-15T19:04:14Z","closed_at":"2019-09-30T21:28:20Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"<!--\r\n\r\nWelcome :-) We understand you are having a problem with rclone; we want to help you with that!\r\n\r\nIf you've just got a question or aren't sure if you've found a bug then please use the rclone forum:\r\n\r\n    https://forum.rclone.org/\r\n\r\ninstead of filing an issue for a quick response.\r\n\r\nIf you are reporting a bug or asking for a new feature then please use one of the templates here:\r\n\r\n    https://github.com/ncw/rclone/issues/new\r\n\r\notherwise fill in the form below.\r\n\r\nThank you\r\n\r\nThe Rclone Developers\r\n\r\n-->\r\n\r\n\r\n#### Output of `rclone version`\r\nrclone v1.48.0\r\n- os/arch: linux/amd64\r\n- go version: go1.12.6\r\n\r\nUbuntu 18.04.2 LTS\r\n#### Describe the issue\r\nMy setup is S3-Compatable (Scaleway) remote >> Crypt.\r\n\r\nAfter unmounting the crypt remote \"encloud\" using \"fusermount -u\", I then manually cleared the vfs cache folder, and remounted with --cache-db-purge option. But then I was unable to list the directory or perform any other action on that remote, even when mounting with bypassing the crypt remote to see the encrypted files. Object storage crashed. The Scaleway support had to apply a hotfix for this bug at their end and had coprehensively explained the issue. \r\n\r\n**Scaleway team replicated the same situation on Amazon S3 and got the same error from rclone.**\r\n\r\nMounting string:\r\n`rclone mount encloud: /mnt/s3 --allow-other --contimeout 10m --max-read-ahead 64M --log-file \"/var/www/rclone.log\" --log-level NOTICE --fast-list --transfers 16 --buffer-size 64M --multi-thread-cutoff 64M --multi-thread-streams 16 --poll-interval 0 --vfs-cache-mode full --dir-cache-time 2160h --vfs-cache-max-age 720h --vfs-cache-max-size 10G --vfs-read-chunk-size 64M --vfs-read-chunk-size-limit 128M --retries 200 --retries-sleep 1s --no-gzip-encoding --stats 24h --stats-one-line --gid 33 --uid 33 --umask 007 --daemon`\r\n\r\nHere is the rclone config:\r\n`[cloud]\r\ntype = s3\r\nprovider = Other\r\naccess_key_id = ***\r\nsecret_access_key = ***\r\nregion = nl-ams\r\nendpoint = s3.nl-ams.scw.cloud\r\nacl = private\r\nbucket_acl = private\r\nupload_cutoff = 256M\r\nchunk_size = 256M\r\nupload_concurrency = 8\r\nforce_path_style = false\r\n\r\n[encloud]\r\ntype = crypt\r\nremote = cloud:/album/cloud\r\nfilename_encryption = standard\r\ndirectory_name_encryption = true\r\npassword = ***\r\npassword2 = ***`\r\n\r\n\r\nScaleway Team response to he issue:\r\n\r\n> Hello,\r\n> \r\n> First of all, thank you for your report, we did have an encoding bug on our\r\n> end, which is now fixed. The problem you are now having is on the rclone's\r\n> side, and there is nothing we can do about it.\r\n> \r\n> Rclone did upload object with control characters in the names. For example:\r\n> \r\n>     data/-position-left-05\r\n> \r\n> Which is:\r\n> \r\n>     00000000  64 61 74 61 2f 05 2d 70  6f 73 69 74 69 6f 6e 2d  |data/.-position-|\r\n>     00000010  6c 65 66 74 2d 30 35 0a                           |left-05.\r\n> \r\n> Notice the 0x05 just before the '-'.\r\n> \r\n> Now, the first time you reported the bug to us, the gateway was crashing on\r\n> listing, because our underlying encoding library was panicking on characters\r\n> such as this one. We now have the same comportement as Amazon, which is\r\n> introducing the characters in the XML: \"&#x05\".\r\n> \r\n> However, in this specific case, the 1.0 XML parsers are not compatible with\r\n> such characters, that is why rclone is failing on mount (The same bug is\r\n> happening to our console right now, which is why you cannot list via the web\r\n> interface).\r\n> \r\n> Amazon specifies the ?encoding-type=url parameter for such cases.\r\n> From Amazon's documentation[1]:\r\n> \r\n>     Param: encoding-type\r\n>     Description: Requests Amazon S3 to encode the response and specifies the\r\n>     encoding method to use.\r\n> \r\n>     An object key can contain any Unicode character. However, XML 1.0 parsers\r\n>     cannot parse some characters, such as characters with an ASCII value from 0 to\r\n>     10. For characters that are not supported in XML 1.0, you can add this\r\n>     parameter to request that Amazon S3 encode the keys in the response.\r\n> \r\n>     Type: String\r\n>     Default: None\r\n>     Valid value: url\r\n> \r\n> We did test on the Amazon S3 gateway, with those objects names, and rclone\r\n> fails the same way. This is why I believe the rclone s3 crypt implementation is\r\n> broken in this way, since it uploads special object names, without specifying\r\n> the encoding type to url on listing.\r\n> \r\n> In the meantime, I suggest you use another tool to access your data. Another\r\n> workaround will be to list your files with `aws s3 ls` (which is using the\r\n> encoding-type=url) and spot the files that have control characters in their\r\n> names. You can attempt to delete them in order to be able to mount your bucket\r\n> with rclone.\r\n> \r\n> In the hope I have answered all your questions,\r\n> \r\n> [1] https://docs.aws.amazon.com/AmazonS3/latest/API/v2-RESTBucketGET.html\r\n> \r\n> \r\n> Cordialement / Best regards,\r\n> \r\n> Pierre-Antoine PAGANELLI\r\n> \r\n> Customer Success Specialist Advanced\r\n\r\nRclone logged error **before** hotfix at scaleway:\r\n`2019/07/09 17:34:17 ERROR : /: Dir.Stat error: InternalError: We encountered an internal error. Please try again.\r\nstatus code: 500, request id: tx795027a68d2d416f8d704-005d24b3f8, host id: tx795027a68d2d416f8d704-005d24b3f8`\r\n\r\nRclone logged error **after** hotfix at scaleway:\r\n`2019/07/11 19:55:10 ERROR : /: Dir.Stat error: SerializationError: failed to decode REST XML response\r\nstatus code: 200, request id: txc7bdb342b42a43faa97f8-005d2777fd\r\ncaused by: XML syntax error on line 2: illegal character code U+0001`\r\n\r\n\r\n\r\nThis issue cause a lot of issues for us because this set up is running in production environment...\r\nAt this moment I didn't try to interact with the storage directly through the native scaleway's cli and just restored the backup to a new bucket.\r\n\r\nThis doesn't look production ready,..\r\nAny thoughts ?","closed_by":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/3345/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rclone/rclone/issues/3345/timeline","performed_via_github_app":null,"state_reason":"completed"}