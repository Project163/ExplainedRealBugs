{"url":"https://api.github.com/repos/rclone/rclone/issues/3172","repository_url":"https://api.github.com/repos/rclone/rclone","labels_url":"https://api.github.com/repos/rclone/rclone/issues/3172/labels{/name}","comments_url":"https://api.github.com/repos/rclone/rclone/issues/3172/comments","events_url":"https://api.github.com/repos/rclone/rclone/issues/3172/events","html_url":"https://github.com/rclone/rclone/issues/3172","id":441105942,"node_id":"MDU6SXNzdWU0NDExMDU5NDI=","number":3172,"title":"Behaviour for HTTP API is not the same as with CLI API","user":{"login":"ajankovic","id":509084,"node_id":"MDQ6VXNlcjUwOTA4NA==","avatar_url":"https://avatars.githubusercontent.com/u/509084?v=4","gravatar_id":"","url":"https://api.github.com/users/ajankovic","html_url":"https://github.com/ajankovic","followers_url":"https://api.github.com/users/ajankovic/followers","following_url":"https://api.github.com/users/ajankovic/following{/other_user}","gists_url":"https://api.github.com/users/ajankovic/gists{/gist_id}","starred_url":"https://api.github.com/users/ajankovic/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajankovic/subscriptions","organizations_url":"https://api.github.com/users/ajankovic/orgs","repos_url":"https://api.github.com/users/ajankovic/repos","events_url":"https://api.github.com/users/ajankovic/events{/privacy}","received_events_url":"https://api.github.com/users/ajankovic/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":86399005,"node_id":"MDU6TGFiZWw4NjM5OTAwNQ==","url":"https://api.github.com/repos/rclone/rclone/labels/bug","name":"bug","color":"fc2929","default":true,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/rclone/rclone/milestones/36","html_url":"https://github.com/rclone/rclone/milestone/36","labels_url":"https://api.github.com/repos/rclone/rclone/milestones/36/labels","id":4231972,"node_id":"MDk6TWlsZXN0b25lNDIzMTk3Mg==","number":36,"title":"v1.49","description":"","creator":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":18,"state":"closed","created_at":"2019-04-15T17:12:48Z","updated_at":"2019-08-27T09:35:39Z","due_on":"2019-08-24T07:00:00Z","closed_at":"2019-08-27T09:35:39Z"},"comments":3,"created_at":"2019-05-07T08:30:29Z","updated_at":"2019-07-01T14:32:47Z","closed_at":"2019-07-01T14:32:47Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"<!--\r\n\r\nWelcome :-) We understand you are having a problem with rclone; we want to help you with that!\r\n\r\nIf you've just got a question or aren't sure if you've found a bug then please use the rclone forum:\r\n\r\n    https://forum.rclone.org/\r\n\r\ninstead of filing an issue for a quick response.\r\n\r\nIf you think you might have found a bug, please can you try to replicate it with the latest beta?\r\n\r\n    https://beta.rclone.org/\r\n    \r\nIf you can still replicate it with the latest beta, then please fill in the info below which makes our lives much easier.  A log with -vv will make our day :-)\r\n\r\nThank you\r\n\r\nThe Rclone Developers\r\n\r\n-->\r\n\r\n#### What is the problem you are having with rclone?\r\n\r\nSending requests that should fail (missing local dir, access denied to remote, etc.) to rclone HTTP server are not failing. They end with empty object and 200 code result. Tested with both curl and rclone rc.\r\n\r\nExample:\r\n\r\n```\r\na> rclone rcd -vv --rc-no-auth\r\nb> rclone rc sync/move srcFs=/non-existent/ dstFs=created-but-inaccessible-remote:bucket/test\r\n{}\r\nb> curl --verbose -H \"Content-Type: application/json\" -d '{\"srcFs\":\"local-dir-that-exists\", \"dstFs\":\"created-but-inaccessible-remote:bucket/test\"}' http://localhost:5572/sync/move\r\n*   Trying 127.0.0.1...\r\n* TCP_NODELAY set\r\n* Connected to localhost (127.0.0.1) port 5572 (#0)\r\n> POST /sync/move HTTP/1.1\r\n> Host: localhost:5572\r\n> User-Agent: curl/7.58.0\r\n> Accept: */*\r\n> Content-Type: application/json\r\n> Content-Length: 65\r\n> \r\n* upload completely sent off: 65 out of 65 bytes\r\n< HTTP/1.1 200 OK\r\n< Access-Control-Allow-Headers: \r\n< Access-Control-Allow-Origin: *\r\n< Date: Tue, 07 May 2019 08:11:03 GMT\r\n< Content-Length: 3\r\n< Content-Type: text/plain; charset=utf-8\r\n< \r\n{}\r\n\r\n```\r\n\r\nSame request made with CLI is reporting an error (with retries) and exiting with `1`. I've taken a look at the code and it seems that CLI calls are wrapped with `cmd.Run` function which integrates with `accounting` and has retries. This functionality is not available within handler for HTTP server so requests never fail. Although available in the server error logs.\r\n\r\nWhich leads me to another \"API design\" question, why is for example `sync.MoveDir` not returning an error on failure? It seems currently the only way to know if there was a failure is to use `accounting.Stats`. From how these top level functions are used it seems like entire call chain depends on these top level functions to return errors.\r\n\r\n#### What is your rclone version (output from `rclone version`)\r\n\r\nrclone v1.47.0-DEV\r\n- os/arch: linux/amd64\r\n- go version: go1.12.4\r\n\r\nUbuntu 18.04\r\n\r\n####  Which cloud storage system are you using? (eg Google Drive)\r\n\r\nAWS S3 but it shouldn't matter to this issue.\r\n\r\n#### A log from the command with the `-vv` flag (eg output from `rclone -vv copy /tmp remote:tmp`)\r\n\r\nHTTP Server logs:\r\n\r\n```\r\n2019/05/07 10:28:09 DEBUG : rclone: Version \"v1.47.0-DEV\" starting with parameters [\"rclone\" \"rcd\" \"-vv\" \"--rc-no-auth\"]\r\n2019/05/07 10:28:09 NOTICE: Serving remote control on http://127.0.0.1:5572/\r\n2019/05/07 10:28:14 DEBUG : rc: \"sync/move\": with parameters map[dstFs:bla:bucket/test srcFs:/non-existent/]\r\n2019/05/07 10:28:14 DEBUG : Using config file from \"/home/alek/.config/rclone/rclone.conf\"\r\n2019/05/07 10:28:15 ERROR : S3 bucket bucket path test/: Failed to update region for bucket: reading bucket location failed: AccessDenied: Access Denied\r\n\tstatus code: 403, request id: 5F13BD3082D862ED, host id: FlUy7pvhPWARqV4qVNBGRhKbrIykPXQnFAfRoU/6CK6HGs3qyWaZq/u57YLYOjqbn0yAa0WyoKM=\r\n2019/05/07 10:28:15 ERROR : S3 bucket bucket path test/: Failed to update region for bucket: reading bucket location failed: AccessDenied: Access Denied\r\n\tstatus code: 403, request id: F45BAF0FA7E4A5D9, host id: SRxpFTaW90nTzWMToU5XBAeHI4lepEBM3mtTJrBwHx2L99FMQhqz2rLEtrcX+qDzKm6bcPx4u4g=\r\n2019/05/07 10:28:15 ERROR : : error reading source directory: directory not found\r\n2019/05/07 10:28:15 INFO  : S3 bucket bucket path test/: Waiting for checks to finish\r\n2019/05/07 10:28:15 INFO  : S3 bucket bucket path test/: Waiting for transfers to finish\r\n2019/05/07 10:28:15 DEBUG : rc: \"sync/move\": reply map[]: <nil>\r\n2019/05/07 10:28:57 DEBUG : rc: \"sync/move\": with parameters map[dstFs:bla:scylla-manager-aleksandar/bash srcFs:tmp]\r\n2019/05/07 10:28:57 ERROR : : error reading source directory: directory not found\r\n2019/05/07 10:28:57 INFO  : S3 bucket scylla-manager-aleksandar path bash/: Waiting for checks to finish\r\n2019/05/07 10:28:57 INFO  : S3 bucket scylla-manager-aleksandar path bash/: Waiting for transfers to finish\r\n2019/05/07 10:28:57 DEBUG : rc: \"sync/move\": reply map[]: <nil>\r\n```\r\n","closed_by":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/3172/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rclone/rclone/issues/3172/timeline","performed_via_github_app":null,"state_reason":"completed"}