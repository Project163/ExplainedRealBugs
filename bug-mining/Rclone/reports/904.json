{"url":"https://api.github.com/repos/rclone/rclone/issues/4892","repository_url":"https://api.github.com/repos/rclone/rclone","labels_url":"https://api.github.com/repos/rclone/rclone/issues/4892/labels{/name}","comments_url":"https://api.github.com/repos/rclone/rclone/issues/4892/comments","events_url":"https://api.github.com/repos/rclone/rclone/issues/4892/events","html_url":"https://github.com/rclone/rclone/issues/4892","id":775585124,"node_id":"MDU6SXNzdWU3NzU1ODUxMjQ=","number":4892,"title":"vfs: file handle leak with --vfs-cache-mode full and --buffer-size 0","user":{"login":"ivandeex","id":9028053,"node_id":"MDQ6VXNlcjkwMjgwNTM=","avatar_url":"https://avatars.githubusercontent.com/u/9028053?v=4","gravatar_id":"","url":"https://api.github.com/users/ivandeex","html_url":"https://github.com/ivandeex","followers_url":"https://api.github.com/users/ivandeex/followers","following_url":"https://api.github.com/users/ivandeex/following{/other_user}","gists_url":"https://api.github.com/users/ivandeex/gists{/gist_id}","starred_url":"https://api.github.com/users/ivandeex/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ivandeex/subscriptions","organizations_url":"https://api.github.com/users/ivandeex/orgs","repos_url":"https://api.github.com/users/ivandeex/repos","events_url":"https://api.github.com/users/ivandeex/events{/privacy}","received_events_url":"https://api.github.com/users/ivandeex/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":86399005,"node_id":"MDU6TGFiZWw4NjM5OTAwNQ==","url":"https://api.github.com/repos/rclone/rclone/labels/bug","name":"bug","color":"fc2929","default":true,"description":null},{"id":430778096,"node_id":"MDU6TGFiZWw0MzA3NzgwOTY=","url":"https://api.github.com/repos/rclone/rclone/labels/VFS%20/%20mount","name":"VFS / mount","color":"0e8a16","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/rclone/rclone/milestones/41","html_url":"https://github.com/rclone/rclone/milestone/41","labels_url":"https://api.github.com/repos/rclone/rclone/milestones/41/labels","id":5478342,"node_id":"MDk6TWlsZXN0b25lNTQ3ODM0Mg==","number":41,"title":"v1.54","description":"","creator":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":55,"state":"closed","created_at":"2020-05-29T14:52:51Z","updated_at":"2021-02-03T16:09:01Z","due_on":"2021-01-30T08:00:00Z","closed_at":"2021-02-03T16:05:14Z"},"comments":6,"created_at":"2020-12-28T21:00:41Z","updated_at":"2021-01-21T18:35:29Z","closed_at":"2021-01-21T18:35:22Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Originally posted by  @daniele-spl in https://github.com/rclone/rclone/issues/2614#issuecomment-747559631, https://github.com/rclone/rclone/issues/2614#issuecomment-748204966\r\n\r\n#### What is the problem you are having with rclone?\r\n\r\nlsof output right now, application already closed some files\r\nlsof -c rclone | wc -l\r\n1027\r\n\r\nError 1: vfs cache: failed to transfer file from cache to remote: failed to open source object .... too many open files\r\n\r\nError 2: Non-out-of-space error encountered during open\r\n\r\nAs soon as this happens, i can see RSS of rclone is increasing to some gig and CPU is up to 400%. Normal mode is 20/30% CPU.\r\n\r\nThe open file issue is just a result of the the main issue. I mean, a static limit to somewhere near 1030 anyhow is not that good, but in most cases you shouldnt come up there.\r\n\r\nMy issue was, that vfs caching did not work properly.\r\n\r\nI get the same error like #4639 \r\n\r\nIts really strange. After a reboot of the system I get:\r\n```\r\n2020/12/18 15:40:14 ERROR : Failed to create vfs cache - disabling: failed to make cache directory: make cache directory failed: mkdir /mnt/resource/rclonecache: permission denied\r\n```\r\n\r\nAfter that its doing a direct transfer to azure. Cause I open a lot of files and also a lot of small files. So the open file issue is related to the http connections to the azure storage.\r\n\r\nThen you wrote me to enable debug log, so I restarted the service with the debug flag, It restarted without any errors. The above Error does not come up, when i restart the service or just start it without the deamon flag at command line.\r\nBUT: It still cannot use the cache and is creating interesting logs but does nothing at all.\r\n\r\n#### What is your rclone version, OS, backend\r\n\r\nVersion: rclone-1.53.2\r\nOS: SLES 12 SP5\r\nBackend: Azure Blob\r\n\r\n#### The command you were trying to run (e.g. `rclone copy /tmp remote:tmp`)\r\n\r\n`rclone mount`\r\n\r\nI did a `cp` from the mount to a local directory\r\n\r\nI found the issue at least for me. I had the flag --buffer-size 0\r\nThats not working and caused all the error messages during transfer with cache configured.\r\n\r\nThese are my current testing parameters:\r\n--cache-dir /tmp/cache --track-renames --dir-cache-time 24h --attr-timeout 4m --vfs-write-back 5s --vfs-cache-mode=full --checksum --vfs-cache-max-age 1m --vfs-cache-max-size 200G --log-level=DEBUG --allow-other --allow-non-empty --debug-fuse --buffer-size 1\r\n\r\nThe same with buffer-size 0 is throwing the errors.\r\n\r\n#### A log from the command with the `-vv` flag (e.g. output from `rclone -vv copy /tmp remote:tmp`)\r\n\r\n<details>\r\n<summary>Click to see log</summary>\r\n\r\n```\r\n2020/12/18 16:37:30 DEBUG : test/journal.gz3: ChunkedReader.Read at 819200 length 32768 chunkOffset 786432 chunkSize 134217728\r\n2020/12/18 16:37:30 DEBUG : test/journal.gz3: ChunkedReader.Read at -1 length 32768 chunkOffset 1572864 chunkSize 134217728\r\n2020/12/18 16:37:30 DEBUG : test/journal.gz3: ChunkedReader.openRange at 1572864 length 134217728\r\n2020/12/18 16:37:30 DEBUG : test/journal.gz3: ChunkedReader.RangeSeek from -1 to 1310720 length -1\r\n2020/12/18 16:37:30 DEBUG : test/journal.gz3: ChunkedReader.Read at -1 length 32768 chunkOffset 1310720 chunkSize 134217728\r\n2020/12/18 16:37:30 DEBUG : test/journal.gz3: ChunkedReader.openRange at 1310720 length 134217728\r\n2020/12/18 16:37:30 DEBUG : test/journal.gz3: ChunkedReader.RangeSeek from -1 to 1441792 length -1\r\n2020/12/18 16:37:30 DEBUG : test/journal.gz3: ChunkedReader.Read at -1 length 32768 chunkOffset 1441792 chunkSize 134217728\r\n2020/12/18 16:37:30 DEBUG : test/journal.gz3: ChunkedReader.openRange at 1441792 length 134217728\r\n2020/12/18 16:37:30 DEBUG : test/journal.gz3: ChunkedReader.RangeSeek from -1 to 1703936 length -1\r\n2020/12/18 16:37:30 DEBUG : test/journal.gz3: ChunkedReader.Read at -1 length 32768 chunkOffset 1703936 chunkSize 134217728\r\n2020/12/18 16:37:30 DEBUG : test/journal.gz3: ChunkedReader.openRange at 1703936 length 134217728\r\n2020/12/18 16:37:30 DEBUG : test/journal.gz3: ChunkedReader.RangeSeek from -1 to 1572864 length -1\r\n2020/12/18 16:37:30 DEBUG : test/journal.gz3: ChunkedReader.Read at 851968 length 32768 chunkOffset 786432 chunkSize 134217728\r\n2020/12/18 16:37:30 DEBUG : test/journal.gz3: ChunkedReader.Read at -1 length 32768 chunkOffset 1572864 chunkSize 134217728\r\n2020/12/18 16:37:30 DEBUG : test/journal.gz3: ChunkedReader.openRange at 1572864 length 134217728\r\n2020/12/18 16:37:30 DEBUG : test/journal.gz3: ChunkedReader.RangeSeek from -1 to 1310720 length -1\r\n2020/12/18 16:37:30 DEBUG : test/journal.gz3: ChunkedReader.Read at -1 length 32768 chunkOffset 1310720 chunkSize 134217728\r\n2020/12/18 16:37:30 DEBUG : test/journal.gz3: ChunkedReader.openRange at 1310720 length 134217728\r\n2020/12/18 16:37:30 DEBUG : test/journal.gz3: ChunkedReader.RangeSeek from -1 to 1441792 length -1\r\n2020/12/18 16:37:30 DEBUG : test/journal.gz3: ChunkedReader.Read at -1 length 32768 chunkOffset 1441792 chunkSize 134217728\r\n2020/12/18 16:37:30 DEBUG : test/journal.gz3: ChunkedReader.openRange at 1441792 length 134217728\r\n2020/12/18 16:37:30 DEBUG : test/journal.gz3: ChunkedReader.RangeSeek from -1 to 1703936 length -1\r\n2020/12/18 16:37:30 DEBUG : test/journal.gz3: ChunkedReader.Read at -1 length 32768 chunkOffset 1703936 chunkSize 134217728\r\n2020/12/18 16:37:30 DEBUG : test/journal.gz3: ChunkedReader.openRange at 1703936 length 134217728\r\n2020/12/18 16:37:30 DEBUG : test/journal.gz3: ChunkedReader.RangeSeek from -1 to 1572864 length -1\r\n2020/12/18 16:37:30 DEBUG : test/journal.gz3: ChunkedReader.Read at 884736 length 32768 chunkOffset 786432 chunkSize 134217728\r\n2020/12/18 16:37:30 DEBUG : test/journal.gz3: ChunkedReader.Read at -1 length 32768 chunkOffset 1572864 chunkSize 134217728\r\n2020/12/18 16:37:30 DEBUG : test/journal.gz3: ChunkedReader.openRange at 1572864 length 134217728\r\n2020/12/18 16:37:30 DEBUG : test/journal.gz3: ChunkedReader.RangeSeek from -1 to 1310720 length -1\r\n2020/12/18 16:37:30 DEBUG : test/journal.gz3: ChunkedReader.Read at -1 length 32768 chunkOffset 1310720 chunkSize 134217728\r\n2020/12/18 16:37:30 DEBUG : test/journal.gz3: ChunkedReader.openRange at 1310720 length 134217728\r\n2020/12/18 16:37:30 DEBUG : test/journal.gz3: ChunkedReader.RangeSeek from -1 to 1441792 length -1\r\n2020/12/18 16:37:30 DEBUG : test/journal.gz3: ChunkedReader.Read at -1 length 32768 chunkOffset 1441792 chunkSize 134217728\r\n2020/12/18 16:37:30 DEBUG : test/journal.gz3: ChunkedReader.openRange at 1441792 length 134217728\r\n2020/12/18 16:37:30 DEBUG : test/journal.gz3: ChunkedReader.RangeSeek from -1 to 1703936 length -1\r\n2020/12/18 16:37:30 DEBUG : test/journal.gz3: ChunkedReader.Read at -1 length 32768 chunkOffset 1703936 chunkSize 134217728\r\n2020/12/18 16:37:30 DEBUG : test/journal.gz3: ChunkedReader.openRange at 1703936 length 134217728\r\n2020/12/18 16:37:30 DEBUG : test/journal.gz3: ChunkedReader.RangeSeek from -1 to 1572864 length -1\r\n2020/12/18 16:37:30 DEBUG : test/journal.gz3: ChunkedReader.Read at 917504 length 32768 chunkOffset 786432 chunkSize 134217728\r\n2020/12/18 16:37:30 DEBUG : test/journal.gz3: ChunkedReader.Read at -1 length 32768 chunkOffset 1572864 chunkSize 134217728\r\n2020/12/18 16:37:30 DEBUG : test/journal.gz3: ChunkedReader.openRange at 1572864 length 134217728\r\n```\r\n\r\n</details>\r\n","closed_by":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/4892/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rclone/rclone/issues/4892/timeline","performed_via_github_app":null,"state_reason":"completed"}