[{"id":14664310809,"node_id":"RTE_lADOAQ-n5M6aXn3HzwAAAANqD6AZ","url":"https://api.github.com/repos/rclone/rclone/issues/events/14664310809","actor":{"login":"cmackenzie1","id":10947617,"node_id":"MDQ6VXNlcjEwOTQ3NjE3","avatar_url":"https://avatars.githubusercontent.com/u/10947617?v=4","gravatar_id":"","url":"https://api.github.com/users/cmackenzie1","html_url":"https://github.com/cmackenzie1","followers_url":"https://api.github.com/users/cmackenzie1/followers","following_url":"https://api.github.com/users/cmackenzie1/following{/other_user}","gists_url":"https://api.github.com/users/cmackenzie1/gists{/gist_id}","starred_url":"https://api.github.com/users/cmackenzie1/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cmackenzie1/subscriptions","organizations_url":"https://api.github.com/users/cmackenzie1/orgs","repos_url":"https://api.github.com/users/cmackenzie1/repos","events_url":"https://api.github.com/users/cmackenzie1/events{/privacy}","received_events_url":"https://api.github.com/users/cmackenzie1/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"renamed","commit_id":null,"commit_url":null,"created_at":"2024-10-15T20:54:35Z","rename":{"from":"Regression in Downloading Compressed files from Cloudflare R2","to":"Regression in downloading compressed files from Cloudflare R2"},"performed_via_github_app":null},{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2415151099","html_url":"https://github.com/rclone/rclone/issues/8137#issuecomment-2415151099","issue_url":"https://api.github.com/repos/rclone/rclone/issues/8137","id":2415151099,"node_id":"IC_kwDOAQ-n5M6P9Ef7","user":{"login":"cmackenzie1","id":10947617,"node_id":"MDQ6VXNlcjEwOTQ3NjE3","avatar_url":"https://avatars.githubusercontent.com/u/10947617?v=4","gravatar_id":"","url":"https://api.github.com/users/cmackenzie1","html_url":"https://github.com/cmackenzie1","followers_url":"https://api.github.com/users/cmackenzie1/followers","following_url":"https://api.github.com/users/cmackenzie1/following{/other_user}","gists_url":"https://api.github.com/users/cmackenzie1/gists{/gist_id}","starred_url":"https://api.github.com/users/cmackenzie1/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cmackenzie1/subscriptions","organizations_url":"https://api.github.com/users/cmackenzie1/orgs","repos_url":"https://api.github.com/users/cmackenzie1/repos","events_url":"https://api.github.com/users/cmackenzie1/events{/privacy}","received_events_url":"https://api.github.com/users/cmackenzie1/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-10-15T21:04:26Z","updated_at":"2024-10-15T21:06:26Z","body":"Grepping through the latest changes between 1.67 and 1.68, perhaps this condition is no longer being matched on in >=1.68? \r\n\r\nhttps://github.com/rclone/rclone/blob/a19ddffe92b905ec535758f5f9fe6cd6451f806b/backend/s3/s3.go#L5934-L5942","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2415151099/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"cmackenzie1","id":10947617,"node_id":"MDQ6VXNlcjEwOTQ3NjE3","avatar_url":"https://avatars.githubusercontent.com/u/10947617?v=4","gravatar_id":"","url":"https://api.github.com/users/cmackenzie1","html_url":"https://github.com/cmackenzie1","followers_url":"https://api.github.com/users/cmackenzie1/followers","following_url":"https://api.github.com/users/cmackenzie1/following{/other_user}","gists_url":"https://api.github.com/users/cmackenzie1/gists{/gist_id}","starred_url":"https://api.github.com/users/cmackenzie1/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cmackenzie1/subscriptions","organizations_url":"https://api.github.com/users/cmackenzie1/orgs","repos_url":"https://api.github.com/users/cmackenzie1/repos","events_url":"https://api.github.com/users/cmackenzie1/events{/privacy}","received_events_url":"https://api.github.com/users/cmackenzie1/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2422334836","html_url":"https://github.com/rclone/rclone/issues/8137#issuecomment-2422334836","issue_url":"https://api.github.com/repos/rclone/rclone/issues/8137","id":2422334836,"node_id":"IC_kwDOAQ-n5M6QYeV0","user":{"login":"darthShadow","id":6824881,"node_id":"MDQ6VXNlcjY4MjQ4ODE=","avatar_url":"https://avatars.githubusercontent.com/u/6824881?v=4","gravatar_id":"","url":"https://api.github.com/users/darthShadow","html_url":"https://github.com/darthShadow","followers_url":"https://api.github.com/users/darthShadow/followers","following_url":"https://api.github.com/users/darthShadow/following{/other_user}","gists_url":"https://api.github.com/users/darthShadow/gists{/gist_id}","starred_url":"https://api.github.com/users/darthShadow/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/darthShadow/subscriptions","organizations_url":"https://api.github.com/users/darthShadow/orgs","repos_url":"https://api.github.com/users/darthShadow/repos","events_url":"https://api.github.com/users/darthShadow/events{/privacy}","received_events_url":"https://api.github.com/users/darthShadow/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-10-18T12:14:06Z","updated_at":"2024-10-18T12:14:06Z","body":"Adding `--dump headers` to the command will help us see the returned headers.","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2422334836/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"darthShadow","id":6824881,"node_id":"MDQ6VXNlcjY4MjQ4ODE=","avatar_url":"https://avatars.githubusercontent.com/u/6824881?v=4","gravatar_id":"","url":"https://api.github.com/users/darthShadow","html_url":"https://github.com/darthShadow","followers_url":"https://api.github.com/users/darthShadow/followers","following_url":"https://api.github.com/users/darthShadow/following{/other_user}","gists_url":"https://api.github.com/users/darthShadow/gists{/gist_id}","starred_url":"https://api.github.com/users/darthShadow/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/darthShadow/subscriptions","organizations_url":"https://api.github.com/users/darthShadow/orgs","repos_url":"https://api.github.com/users/darthShadow/repos","events_url":"https://api.github.com/users/darthShadow/events{/privacy}","received_events_url":"https://api.github.com/users/darthShadow/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":14755441438,"node_id":"LE_lADOAQ-n5M6aXn3HzwAAAANvfise","url":"https://api.github.com/repos/rclone/rclone/issues/events/14755441438","actor":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2024-10-20T21:58:22Z","label":{"name":"bug","color":"fc2929"},"performed_via_github_app":null},{"id":14755441440,"node_id":"LE_lADOAQ-n5M6aXn3HzwAAAANvfisg","url":"https://api.github.com/repos/rclone/rclone/issues/events/14755441440","actor":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2024-10-20T21:58:22Z","label":{"name":"Remote: S3","color":"fbca04"},"performed_via_github_app":null},{"id":14755441623,"node_id":"MIE_lADOAQ-n5M6aXn3HzwAAAANvfivX","url":"https://api.github.com/repos/rclone/rclone/issues/events/14755441623","actor":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"milestoned","commit_id":null,"commit_url":null,"created_at":"2024-10-20T21:58:26Z","milestone":{"title":"v1.69"},"performed_via_github_app":null},{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2428884998","html_url":"https://github.com/rclone/rclone/issues/8137#issuecomment-2428884998","issue_url":"https://api.github.com/repos/rclone/rclone/issues/8137","id":2428884998,"node_id":"IC_kwDOAQ-n5M6QxdgG","user":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-10-22T10:18:56Z","updated_at":"2024-10-22T10:18:56Z","body":"@cmackenzie1 I see your files are gzipped files `20221220T193149Z_20221220T193219Z_f27449c5.log.gz` - how were these uploaded?\r\n\r\nHere is what happens when I upload a `.gz` file and download it\r\n\r\n```\r\n$ rclone copy -P Downloads/xen-4.6.3.tar.gz r2:rclone1/\r\nTransferred:       18.794 MiB / 18.794 MiB, 100%, 1.878 MiB/s, ETA 0s\r\nTransferred:            1 / 1, 100%\r\nElapsed time:        10.4s\r\n\r\n$ rclone copy -P r2:rclone1/xen-4.6.3.tar.gz /tmp/\r\nTransferred:       18.794 MiB / 18.794 MiB, 100%, 4.999 MiB/s, ETA 0s\r\nTransferred:            1 / 1, 100%\r\nElapsed time:         3.6s\r\n\r\n$ md5sum Downloads/xen-4.6.3.tar.gz /tmp/xen-4.6.3.tar.gz\r\n26419d8477082dbdb32ec75b00f00643  Downloads/xen-4.6.3.tar.gz\r\n26419d8477082dbdb32ec75b00f00643  /tmp/xen-4.6.3.tar.gz\r\n```\r\n\r\nThe uploaded file does not have `Content-Encoding: gzip`. I don't think `.gz` files want to be uploaded with `Content-Encoding: gzip` and you should probably fix that!\r\n\r\nHowever that doesn't explain the regression you are seeing.\r\n\r\nIf I do try to upload a file with `Content-Encoding: gzip` that fails in a very similar way\r\n\r\n```\r\n$ for i in `seq 1000`; do echo $i >> file.txt ; done\r\n\r\n$ rclone copy -vv --retries 1 --header-upload 'Content-Encoding: gzip' file.txt r2:rclone1/\r\n2024/10/22 10:44:47 DEBUG : rclone: Version \"v1.69.0-beta.8381.daa14dd69.fix-2975-mount-symlinks\" starting with parameters [\"rclone\" \"copy\" \"-vv\" \"--retries\" \"1\" \"--header-upload\" \"Content-Encoding: gzip\" \"file.txt\" \"r2:rclone1/\"]\r\n2024/10/22 10:44:47 DEBUG : Creating backend with remote \"file.txt\"\r\n2024/10/22 10:44:47 DEBUG : Using config file from \"/home/ncw/.rclone.conf\"\r\n2024/10/22 10:44:47 DEBUG : fs cache: renaming child cache item \"file.txt\" to be canonical for parent \"/home/ncw\"\r\n2024/10/22 10:44:47 DEBUG : Creating backend with remote \"r2:rclone1/\"\r\n2024/10/22 10:44:47 DEBUG : fs cache: renaming cache item \"r2:rclone1/\" to be canonical \"r2:rclone1\"\r\n2024/10/22 10:44:47 DEBUG : file.txt: Need to transfer - File not found at Destination\r\n2024/10/22 10:44:48 ERROR : file.txt: corrupted on transfer: sizes differ src(Local file system at /home/ncw) 3899 vs dst(S3 bucket rclone1) 0\r\n2024/10/22 10:44:48 INFO  : file.txt: Removing failed copy\r\n2024/10/22 10:44:48 ERROR : Attempt 1/1 failed with 1 errors and: corrupted on transfer: sizes differ src(Local file system at /home/ncw) 3899 vs dst(S3 bucket rclone1) 0\r\n2024/10/22 10:44:48 INFO  : \r\nTransferred:   \t    3.808 KiB / 3.808 KiB, 100%, 3.808 KiB/s, ETA 0s\r\nErrors:                 1 (retrying may help)\r\nElapsed time:         1.0s\r\n\r\n2024/10/22 10:44:48 DEBUG : 7 go routines active\r\n2024/10/22 10:44:48 NOTICE: Failed to copy: corrupted on transfer: sizes differ src(Local file system at /home/ncw) 3899 vs dst(S3 bucket rclone1) 0\r\n```\r\n\r\nWhereas this works fine with older rclone\r\n\r\n```\r\nrclone-v1.67.0 copy -vv --retries 1 --header-upload 'Content-Encoding: gzip' file.txt r2:rclone1/\r\n```\r\n\r\nAnd this then replicates your problem\r\n\r\n```\r\n$ rclone-v1.67.0 copyto -vv --retries 1 r2:rclone1/file.txt /tmp/file.txt.1.67.0\r\n2024/10/22 10:48:12 DEBUG : rclone: Version \"v1.67.0\" starting with parameters [\"rclone-v1.67.0\" \"copyto\" \"-vv\" \"--retries\" \"1\" \"r2:rclone1/file.txt\" \"/tmp/file.txt.1.67.0\"]\r\n2024/10/22 10:48:12 DEBUG : Creating backend with remote \"r2:rclone1/file.txt\"\r\n2024/10/22 10:48:12 DEBUG : Using config file from \"/home/ncw/.rclone.conf\"\r\n2024/10/22 10:48:12 DEBUG : Resolving service \"s3\" region \"auto\"\r\n2024/10/22 10:48:12 DEBUG : fs cache: adding new entry for parent of \"r2:rclone1/file.txt\", \"r2:rclone1\"\r\n2024/10/22 10:48:12 DEBUG : Creating backend with remote \"/tmp/\"\r\n2024/10/22 10:48:12 DEBUG : fs cache: renaming cache item \"/tmp/\" to be canonical \"/tmp\"\r\n2024/10/22 10:48:12 DEBUG : file.txt: Need to transfer - File not found at Destination\r\n2024/10/22 10:48:12 NOTICE: file.txt: Not decompressing 'Content-Encoding: gzip' compressed file. Use --s3-decompress to override\r\n2024/10/22 10:48:12 DEBUG : file.txt: md5 = 1ca665693609f32ce05e6257c6a3b28d OK\r\n2024/10/22 10:48:12 DEBUG : file.txt.1.67.0.xefeluf4.partial: renamed to: file.txt.1.67.0\r\n2024/10/22 10:48:12 INFO  : file.txt: Copied (new) to: file.txt.1.67.0\r\n2024/10/22 10:48:12 INFO  : \r\nTransferred:   \t    3.808 KiB / 3.808 KiB, 100%, 0 B/s, ETA -\r\nTransferred:            1 / 1, 100%\r\nElapsed time:         0.4s\r\n\r\n2024/10/22 10:48:12 DEBUG : 8 go routines active\r\n```\r\n\r\nvs failure with current version\r\n\r\n```\r\n$ rclone-v1.68.1 copyto -vv --retries 1 r2:rclone1/file.txt /tmp/file.txt.1.68.1\r\n2024/10/22 10:48:23 DEBUG : rclone: Version \"v1.68.1\" starting with parameters [\"rclone-v1.68.1\" \"copyto\" \"-vv\" \"--retries\" \"1\" \"r2:rclone1/file.txt\" \"/tmp/file.txt.1.68.1\"]\r\n2024/10/22 10:48:23 DEBUG : Creating backend with remote \"r2:rclone1/file.txt\"\r\n2024/10/22 10:48:23 DEBUG : Using config file from \"/home/ncw/.rclone.conf\"\r\n2024/10/22 10:48:23 DEBUG : fs cache: adding new entry for parent of \"r2:rclone1/file.txt\", \"r2:rclone1\"\r\n2024/10/22 10:48:23 DEBUG : Creating backend with remote \"/tmp/\"\r\n2024/10/22 10:48:23 DEBUG : fs cache: renaming cache item \"/tmp/\" to be canonical \"/tmp\"\r\n2024/10/22 10:48:23 DEBUG : file.txt: Need to transfer - File not found at Destination\r\n2024/10/22 10:48:23 ERROR : file.txt.1.68.1.ac4748ef.partial: corrupted on transfer: sizes differ src(S3 bucket rclone1) 0 vs dst(Local file system at /tmp) 3899\r\n2024/10/22 10:48:23 INFO  : file.txt.1.68.1.ac4748ef.partial: Removing failed copy\r\n2024/10/22 10:48:23 ERROR : Attempt 1/1 failed with 1 errors and: corrupted on transfer: sizes differ src(S3 bucket rclone1) 0 vs dst(Local file system at /tmp) 3899\r\n2024/10/22 10:48:23 INFO  : \r\nTransferred:   \t    3.808 KiB / 3.808 KiB, 100%, 0 B/s, ETA -\r\nErrors:                 1 (retrying may help)\r\nElapsed time:         0.3s\r\n\r\n2024/10/22 10:48:23 DEBUG : 9 go routines active\r\n2024/10/22 10:48:23 NOTICE: Failed to copyto: corrupted on transfer: sizes differ src(S3 bucket rclone1) 0 vs dst(Local file system at /tmp) 3899\r\n```\r\n\r\nI think what is going on here is that this is Cloudflare's transparent gzip decoding. I noticed this when doing the SDKv2 port here 8aef1de695268ba874da08d4016bb3cd9eca988b - for some reason I never got to the bottom of the new SDK and the old SDK behave differently here.\r\n\r\nThat commit added a note to the docs\r\n\r\n> Note that Cloudflare decompresses files uploaded with `Content-Encoding: gzip` by default which is a deviation from what AWS does. If this is causing a problem then upload the files with `--header-upload \"Cache-Control: no-transform\"`\r\n\r\nAnd if we do that, it all works fine\r\n\r\nUpload\r\n\r\n```\r\n$ rclone-v1.68.1 copy -vv --retries 1 --header-upload 'Content-Encoding: gzip' --header-upload \"Cache-Control: no-transform\" file.txt r2:rclone1/\r\n2024/10/22 10:53:54 DEBUG : rclone: Version \"v1.68.1\" starting with parameters [\"rclone-v1.68.1\" \"copy\" \"-vv\" \"--retries\" \"1\" \"--header-upload\" \"Content-Encoding: gzip\" \"--header-upload\" \"Cache-Control: no-transform\" \"file.txt\" \"r2:rclone1/\"]\r\n2024/10/22 10:53:54 DEBUG : Creating backend with remote \"file.txt\"\r\n2024/10/22 10:53:54 DEBUG : Using config file from \"/home/ncw/.rclone.conf\"\r\n2024/10/22 10:53:54 DEBUG : fs cache: adding new entry for parent of \"file.txt\", \"/home/ncw\"\r\n2024/10/22 10:53:54 DEBUG : Creating backend with remote \"r2:rclone1/\"\r\n2024/10/22 10:53:54 DEBUG : fs cache: renaming cache item \"r2:rclone1/\" to be canonical \"r2:rclone1\"\r\n2024/10/22 10:53:54 DEBUG : file.txt: Need to transfer - File not found at Destination\r\n2024/10/22 10:53:55 DEBUG : file.txt: md5 = 1ca665693609f32ce05e6257c6a3b28d OK\r\n2024/10/22 10:53:55 INFO  : file.txt: Copied (new)\r\n2024/10/22 10:53:55 INFO  : \r\nTransferred:   \t    3.808 KiB / 3.808 KiB, 100%, 0 B/s, ETA -\r\nTransferred:            1 / 1, 100%\r\nElapsed time:         0.7s\r\n\r\n2024/10/22 10:53:55 DEBUG : 7 go routines active\r\n```\r\n\r\nand download\r\n\r\n```\r\n$ rclone-v1.68.1 copyto -vv --retries 1 r2:rclone1/file.txt /tmp/file.txt.1.68.1\r\n2024/10/22 10:54:12 DEBUG : rclone: Version \"v1.68.1\" starting with parameters [\"rclone-v1.68.1\" \"copyto\" \"-vv\" \"--retries\" \"1\" \"r2:rclone1/file.txt\" \"/tmp/file.txt.1.68.1\"]\r\n2024/10/22 10:54:12 DEBUG : Creating backend with remote \"r2:rclone1/file.txt\"\r\n2024/10/22 10:54:12 DEBUG : Using config file from \"/home/ncw/.rclone.conf\"\r\n2024/10/22 10:54:12 DEBUG : fs cache: adding new entry for parent of \"r2:rclone1/file.txt\", \"r2:rclone1\"\r\n2024/10/22 10:54:12 DEBUG : Creating backend with remote \"/tmp/\"\r\n2024/10/22 10:54:12 DEBUG : fs cache: renaming cache item \"/tmp/\" to be canonical \"/tmp\"\r\n2024/10/22 10:54:12 DEBUG : file.txt: Need to transfer - File not found at Destination\r\n2024/10/22 10:54:13 NOTICE: file.txt: Not decompressing 'Content-Encoding: gzip' compressed file. Use --s3-decompress to override\r\n2024/10/22 10:54:13 DEBUG : file.txt: md5 = 1ca665693609f32ce05e6257c6a3b28d OK\r\n2024/10/22 10:54:13 DEBUG : file.txt.1.68.1.240a4a31.partial: renamed to: file.txt.1.68.1\r\n2024/10/22 10:54:13 INFO  : file.txt: Copied (new) to: file.txt.1.68.1\r\n2024/10/22 10:54:13 INFO  : \r\nTransferred:   \t    3.808 KiB / 3.808 KiB, 100%, 0 B/s, ETA -\r\nTransferred:            1 / 1, 100%\r\nElapsed time:         0.4s\r\n\r\n2024/10/22 10:54:13 DEBUG : 8 go routines active\r\n```\r\n\r\nIf I compare the requests with 1.67 and 1.68 (with `-vv --dump headers`) I see\r\n\r\n```\r\n$ rclone-v1.67.0 copyto -vv --dump headers --retries 1 r2:rclone1/file.txt /tmp/file.txt.1111\r\n\r\n2024/10/22 11:00:27 DEBUG : <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<\r\n2024/10/22 11:00:27 DEBUG : file.txt: Need to transfer - File not found at Destination\r\n2024/10/22 11:00:27 DEBUG : >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>\r\n2024/10/22 11:00:27 DEBUG : HTTP REQUEST (req 0xc0009aa6c0)\r\n2024/10/22 11:00:27 DEBUG : GET /rclone1/file.txt HTTP/1.1\r\nHost: 14aad7c9ed489151b51557e321b246cf.r2.cloudflarestorage.com\r\nUser-Agent: rclone/v1.67.0\r\nAccept-Encoding: gzip\r\nAuthorization: XXXX\r\nX-Amz-Content-Sha256: e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855\r\nX-Amz-Date: 20241022T100027Z\r\n\r\n2024/10/22 11:00:27 DEBUG : >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>\r\n2024/10/22 11:00:27 DEBUG : <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<\r\n2024/10/22 11:00:27 DEBUG : HTTP RESPONSE (req 0xc0009aa6c0)\r\n2024/10/22 11:00:27 DEBUG : HTTP/1.1 200 OK\r\nContent-Length: 3899\r\nAccept-Ranges: bytes\r\nCf-Ray: 8d68a3f3bfeebea0-LHR\r\nConnection: keep-alive\r\nContent-Encoding: gzip\r\nContent-Type: text/plain; charset=utf-8\r\nDate: Tue, 22 Oct 2024 10:00:27 GMT\r\nEtag: \"1ca665693609f32ce05e6257c6a3b28d\"\r\nLast-Modified: Tue, 22 Oct 2024 09:59:55 GMT\r\nServer: cloudflare\r\nVary: Accept-Encoding\r\nX-Amz-Meta-Mtime: 1729590134.775546531\r\n\r\n2024/10/22 11:00:27 DEBUG : <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<\r\n2024/10/22 11:00:27 NOTICE: file.txt: Not decompressing 'Content-Encoding: gzip' compressed file. Use --s3-decompress to override\r\n```\r\n\r\nBut if I try that with 1.68\r\n\r\n```\r\n2024/10/22 11:02:46 DEBUG : <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<\r\n2024/10/22 11:02:46 DEBUG : file.txt: Need to transfer - File not found at Destination\r\n2024/10/22 11:02:46 DEBUG : >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>\r\n2024/10/22 11:02:46 DEBUG : HTTP REQUEST (req 0xc000b1b540)\r\n2024/10/22 11:02:46 DEBUG : GET /rclone1/file.txt?x-id=GetObject HTTP/1.1\r\nHost: 14aad7c9ed489151b51557e321b246cf.r2.cloudflarestorage.com\r\nUser-Agent: rclone/v1.68.1\r\nAccept-Encoding: identity\r\nAmz-Sdk-Invocation-Id: 20bbf29b-eece-4cc7-a1b5-d401370cc611\r\nAmz-Sdk-Request: attempt=1; max=10\r\nAuthorization: XXXX\r\nX-Amz-Content-Sha256: e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855\r\nX-Amz-Date: 20241022T100246Z\r\n\r\n2024/10/22 11:02:46 DEBUG : >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>\r\n2024/10/22 11:02:46 DEBUG : <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<\r\n2024/10/22 11:02:46 DEBUG : HTTP RESPONSE (req 0xc000b1b540)\r\n2024/10/22 11:02:46 DEBUG : HTTP/1.1 200 OK\r\nTransfer-Encoding: chunked\r\nCf-Ray: 8d68a757edce6557-LHR\r\nConnection: keep-alive\r\nContent-Type: text/plain; charset=utf-8\r\nDate: Tue, 22 Oct 2024 10:02:46 GMT\r\nEtag: W/\"1ca665693609f32ce05e6257c6a3b28d\"\r\nLast-Modified: Tue, 22 Oct 2024 09:59:55 GMT\r\nServer: cloudflare\r\nVary: Accept-Encoding\r\nX-Amz-Meta-Mtime: 1729590134.775546531\r\n\r\n2024/10/22 11:02:46 DEBUG : <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<\r\n2024/10/22 11:02:46 ERROR : file.txt.2222.ac4748ef.partial: corrupted on transfer: sizes differ src(S3 bucket rclone1) 0 vs dst(Local file system at /tmp) 3899\r\n2024/10/22 11:02:46 INFO  : file.txt.2222.ac4748ef.partial: Removing failed copy\r\n2024/10/22 11:02:46 ERROR : Attempt 1/1 failed with 1 errors and: corrupted on transfer: sizes differ src(S3 bucket rclone1) 0 vs dst(Local file system at /tmp) 3899\r\n```\r\n\r\nThe problem is that the `Content-Encoding: gzip` does not appear in the RESPONSE.\r\n\r\nThis is probably because 1.68 didn't send an `Accept-Encoding: gzip` like 1.67 did in the REQUEST.\r\n\r\nI think ultimately this is the cause of the regression.\r\n\r\nWe do attempt to set it here (use gzip encoding is set for Cloudflare and even if you set it manually with `--s3-use-accept-encoding-gzip=true` it makes no difference)\r\n\r\nhttps://github.com/rclone/rclone/blob/264c9fb2c00d85cc9cf294797d72e4f2af5c931d/backend/s3/s3.go#L5875-L5879\r\n\r\nSo for some reason that `Accept-Encoding: gzip` is not making it through the new SDKv2.\r\n\r\nFixing this will require a deep dive in to the SDKv2 internals\r\n\r\nI'll update my findings in the next post as this one has got rather long already!","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2428884998/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":14782164914,"node_id":"MEE_lADOAQ-n5M6aXn3HzwAAAANxFe-y","url":"https://api.github.com/repos/rclone/rclone/issues/events/14782164914","actor":{"login":"cmackenzie1","id":10947617,"node_id":"MDQ6VXNlcjEwOTQ3NjE3","avatar_url":"https://avatars.githubusercontent.com/u/10947617?v=4","gravatar_id":"","url":"https://api.github.com/users/cmackenzie1","html_url":"https://github.com/cmackenzie1","followers_url":"https://api.github.com/users/cmackenzie1/followers","following_url":"https://api.github.com/users/cmackenzie1/following{/other_user}","gists_url":"https://api.github.com/users/cmackenzie1/gists{/gist_id}","starred_url":"https://api.github.com/users/cmackenzie1/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cmackenzie1/subscriptions","organizations_url":"https://api.github.com/users/cmackenzie1/orgs","repos_url":"https://api.github.com/users/cmackenzie1/repos","events_url":"https://api.github.com/users/cmackenzie1/events{/privacy}","received_events_url":"https://api.github.com/users/cmackenzie1/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2024-10-22T10:18:57Z","performed_via_github_app":null},{"id":14782164934,"node_id":"SE_lADOAQ-n5M6aXn3HzwAAAANxFe_G","url":"https://api.github.com/repos/rclone/rclone/issues/events/14782164934","actor":{"login":"cmackenzie1","id":10947617,"node_id":"MDQ6VXNlcjEwOTQ3NjE3","avatar_url":"https://avatars.githubusercontent.com/u/10947617?v=4","gravatar_id":"","url":"https://api.github.com/users/cmackenzie1","html_url":"https://github.com/cmackenzie1","followers_url":"https://api.github.com/users/cmackenzie1/followers","following_url":"https://api.github.com/users/cmackenzie1/following{/other_user}","gists_url":"https://api.github.com/users/cmackenzie1/gists{/gist_id}","starred_url":"https://api.github.com/users/cmackenzie1/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cmackenzie1/subscriptions","organizations_url":"https://api.github.com/users/cmackenzie1/orgs","repos_url":"https://api.github.com/users/cmackenzie1/repos","events_url":"https://api.github.com/users/cmackenzie1/events{/privacy}","received_events_url":"https://api.github.com/users/cmackenzie1/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2024-10-22T10:18:58Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2429028182","html_url":"https://github.com/rclone/rclone/issues/8137#issuecomment-2429028182","issue_url":"https://api.github.com/repos/rclone/rclone/issues/8137","id":2429028182,"node_id":"IC_kwDOAQ-n5M6QyAdW","user":{"login":"darthShadow","id":6824881,"node_id":"MDQ6VXNlcjY4MjQ4ODE=","avatar_url":"https://avatars.githubusercontent.com/u/6824881?v=4","gravatar_id":"","url":"https://api.github.com/users/darthShadow","html_url":"https://github.com/darthShadow","followers_url":"https://api.github.com/users/darthShadow/followers","following_url":"https://api.github.com/users/darthShadow/following{/other_user}","gists_url":"https://api.github.com/users/darthShadow/gists{/gist_id}","starred_url":"https://api.github.com/users/darthShadow/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/darthShadow/subscriptions","organizations_url":"https://api.github.com/users/darthShadow/orgs","repos_url":"https://api.github.com/users/darthShadow/repos","events_url":"https://api.github.com/users/darthShadow/events{/privacy}","received_events_url":"https://api.github.com/users/darthShadow/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-10-22T11:29:54Z","updated_at":"2024-10-22T11:29:54Z","body":"Looks like it's disabled by default now in v2:\r\n\r\nhttps://github.com/aws/aws-sdk-go-v2/blob/3bab20015daf03d8d70e6ee8601b8aeb457d855f/service/s3/api_op_GetObject.go#L742\r\n\r\nhttps://github.com/aws/aws-sdk-go-v2/blob/3bab20015daf03d8d70e6ee8601b8aeb457d855f/service/s3/api_client.go#L929-L931\r\n\r\nhttps://github.com/aws/aws-sdk-go-v2/blob/3bab20015daf03d8d70e6ee8601b8aeb457d855f/service/internal/accept-encoding/accept_encoding_gzip.go#L37\r\n\r\nhttps://github.com/aws/aws-sdk-go-v2/blob/3bab20015daf03d8d70e6ee8601b8aeb457d855f/service/internal/accept-encoding/accept_encoding_gzip.go#L65","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2429028182/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"darthShadow","id":6824881,"node_id":"MDQ6VXNlcjY4MjQ4ODE=","avatar_url":"https://avatars.githubusercontent.com/u/6824881?v=4","gravatar_id":"","url":"https://api.github.com/users/darthShadow","html_url":"https://github.com/darthShadow","followers_url":"https://api.github.com/users/darthShadow/followers","following_url":"https://api.github.com/users/darthShadow/following{/other_user}","gists_url":"https://api.github.com/users/darthShadow/gists{/gist_id}","starred_url":"https://api.github.com/users/darthShadow/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/darthShadow/subscriptions","organizations_url":"https://api.github.com/users/darthShadow/orgs","repos_url":"https://api.github.com/users/darthShadow/repos","events_url":"https://api.github.com/users/darthShadow/events{/privacy}","received_events_url":"https://api.github.com/users/darthShadow/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2429778845","html_url":"https://github.com/rclone/rclone/issues/8137#issuecomment-2429778845","issue_url":"https://api.github.com/repos/rclone/rclone/issues/8137","id":2429778845,"node_id":"IC_kwDOAQ-n5M6Q03ud","user":{"login":"cmackenzie1","id":10947617,"node_id":"MDQ6VXNlcjEwOTQ3NjE3","avatar_url":"https://avatars.githubusercontent.com/u/10947617?v=4","gravatar_id":"","url":"https://api.github.com/users/cmackenzie1","html_url":"https://github.com/cmackenzie1","followers_url":"https://api.github.com/users/cmackenzie1/followers","following_url":"https://api.github.com/users/cmackenzie1/following{/other_user}","gists_url":"https://api.github.com/users/cmackenzie1/gists{/gist_id}","starred_url":"https://api.github.com/users/cmackenzie1/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cmackenzie1/subscriptions","organizations_url":"https://api.github.com/users/cmackenzie1/orgs","repos_url":"https://api.github.com/users/cmackenzie1/repos","events_url":"https://api.github.com/users/cmackenzie1/events{/privacy}","received_events_url":"https://api.github.com/users/cmackenzie1/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-10-22T16:48:12Z","updated_at":"2024-10-22T16:48:12Z","body":"Thanks for the responses @darthShadow and @ncw.\r\n\r\n> I don't think .gz files want to be uploaded with Content-Encoding: gzip and you should probably fix that!\r\n\r\n@ncw could you expand more on your reasoning behind that? Or did you mean to say \"_without_ Content-Encoding: gzip\"? \r\n\r\nThe objects are uploaded with `Content-Type: application/json` and `Content-Encoding: gzip` to R2. I work on both ends of the pipe that produces these objects at Cloudflare, but right now I am just wearing my object-consumer hat ðŸŽ©. \r\n\r\nThe transparent decompression of Cloudflare R2 only affects `GetObject` object operation and shouldn't apply to any `PutObject` commands. We frequently recommend users to use `rclone` because it handles the use case of downloading these files **without Cloudflare R2 decompressing them during `GetObject`** (until SDKv2 that is ðŸ˜‰) -- so thank you for putting a fix on the roadmap! We also have a draft of these docs that should soon land on our Developer Documentation for Cloudflare R2, which will hopefully help others understand this behavior. [^1]\r\n\r\n---\r\n\r\nBelow is the metadata returned for the object when using 1.68 and 1.67 which does confirm that the `content-encoding` header is no longer being returned to the metadata due to the new AWS SDK not including `Accept-Encoding: gzip`!\r\n\r\n```\r\nâžœ  rclone-versions git:(cole/DS-14740) âœ— rclone lsjson -M --stat datalab-r2:cloudflare-logs/workers_trace_events/20221220/20221220T193149Z_20221220T193219Z_f27449c5.log.gz | jq\r\n{\r\n  \"Path\": \"20221220T193149Z_20221220T193219Z_f27449c5.log.gz\",\r\n  \"Name\": \"20221220T193149Z_20221220T193219Z_f27449c5.log.gz\",\r\n  \"Size\": 0,\r\n  \"MimeType\": \"application/json\",\r\n  \"ModTime\": \"2022-12-20T19:32:19.000000000Z\",\r\n  \"IsDir\": false,\r\n  \"Tier\": \"STANDARD\",\r\n  \"Metadata\": {\r\n    \"btime\": \"2022-12-20T19:32:19Z\",\r\n    \"content-type\": \"application/json\",\r\n    \"tier\": \"STANDARD\"\r\n  }\r\n}\r\n\r\nâžœ  rclone-versions git:(cole/DS-14740) âœ— rclone-v1.67.0-osx-arm64/rclone lsjson -M --stat datalab-r2:cloudflare-logs/workers_trace_events/20221220/20221220T193149Z_20221220T193219Z_f27449c5.log.gz | jq\r\n{\r\n  \"Path\": \"20221220T193149Z_20221220T193219Z_f27449c5.log.gz\",\r\n  \"Name\": \"20221220T193149Z_20221220T193219Z_f27449c5.log.gz\",\r\n  \"Size\": 279,\r\n  \"MimeType\": \"application/json\",\r\n  \"ModTime\": \"2022-12-20T19:32:19.000000000Z\",\r\n  \"IsDir\": false,\r\n  \"Tier\": \"STANDARD\",\r\n  \"Metadata\": {\r\n    \"btime\": \"2022-12-20T19:32:19Z\",\r\n    \"content-encoding\": \"gzip\",\r\n    \"content-type\": \"application/json\",\r\n    \"tier\": \"STANDARD\"\r\n  }\r\n}\r\n```\r\n\r\n[^1]: https://github.com/cloudflare/cloudflare-docs/pull/17328","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2429778845/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"cmackenzie1","id":10947617,"node_id":"MDQ6VXNlcjEwOTQ3NjE3","avatar_url":"https://avatars.githubusercontent.com/u/10947617?v=4","gravatar_id":"","url":"https://api.github.com/users/cmackenzie1","html_url":"https://github.com/cmackenzie1","followers_url":"https://api.github.com/users/cmackenzie1/followers","following_url":"https://api.github.com/users/cmackenzie1/following{/other_user}","gists_url":"https://api.github.com/users/cmackenzie1/gists{/gist_id}","starred_url":"https://api.github.com/users/cmackenzie1/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cmackenzie1/subscriptions","organizations_url":"https://api.github.com/users/cmackenzie1/orgs","repos_url":"https://api.github.com/users/cmackenzie1/repos","events_url":"https://api.github.com/users/cmackenzie1/events{/privacy}","received_events_url":"https://api.github.com/users/cmackenzie1/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":14789165783,"node_id":"MEE_lADOAQ-n5M6aXn3HzwAAAANxgMLX","url":"https://api.github.com/repos/rclone/rclone/issues/events/14789165783","actor":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2024-10-22T16:48:13Z","performed_via_github_app":null},{"id":14789165800,"node_id":"SE_lADOAQ-n5M6aXn3HzwAAAANxgMLo","url":"https://api.github.com/repos/rclone/rclone/issues/events/14789165800","actor":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2024-10-22T16:48:13Z","performed_via_github_app":null},{"id":14789165819,"node_id":"MEE_lADOAQ-n5M6aXn3HzwAAAANxgML7","url":"https://api.github.com/repos/rclone/rclone/issues/events/14789165819","actor":{"login":"darthShadow","id":6824881,"node_id":"MDQ6VXNlcjY4MjQ4ODE=","avatar_url":"https://avatars.githubusercontent.com/u/6824881?v=4","gravatar_id":"","url":"https://api.github.com/users/darthShadow","html_url":"https://github.com/darthShadow","followers_url":"https://api.github.com/users/darthShadow/followers","following_url":"https://api.github.com/users/darthShadow/following{/other_user}","gists_url":"https://api.github.com/users/darthShadow/gists{/gist_id}","starred_url":"https://api.github.com/users/darthShadow/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/darthShadow/subscriptions","organizations_url":"https://api.github.com/users/darthShadow/orgs","repos_url":"https://api.github.com/users/darthShadow/repos","events_url":"https://api.github.com/users/darthShadow/events{/privacy}","received_events_url":"https://api.github.com/users/darthShadow/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2024-10-22T16:48:13Z","performed_via_github_app":null},{"id":14789165830,"node_id":"SE_lADOAQ-n5M6aXn3HzwAAAANxgMMG","url":"https://api.github.com/repos/rclone/rclone/issues/events/14789165830","actor":{"login":"darthShadow","id":6824881,"node_id":"MDQ6VXNlcjY4MjQ4ODE=","avatar_url":"https://avatars.githubusercontent.com/u/6824881?v=4","gravatar_id":"","url":"https://api.github.com/users/darthShadow","html_url":"https://github.com/darthShadow","followers_url":"https://api.github.com/users/darthShadow/followers","following_url":"https://api.github.com/users/darthShadow/following{/other_user}","gists_url":"https://api.github.com/users/darthShadow/gists{/gist_id}","starred_url":"https://api.github.com/users/darthShadow/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/darthShadow/subscriptions","organizations_url":"https://api.github.com/users/darthShadow/orgs","repos_url":"https://api.github.com/users/darthShadow/repos","events_url":"https://api.github.com/users/darthShadow/events{/privacy}","received_events_url":"https://api.github.com/users/darthShadow/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2024-10-22T16:48:13Z","performed_via_github_app":null},{"actor":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-10-22T18:28:46Z","updated_at":"2024-10-22T18:28:46Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/aws/aws-sdk-go-v2/issues/2848","repository_url":"https://api.github.com/repos/aws/aws-sdk-go-v2","labels_url":"https://api.github.com/repos/aws/aws-sdk-go-v2/issues/2848/labels{/name}","comments_url":"https://api.github.com/repos/aws/aws-sdk-go-v2/issues/2848/comments","events_url":"https://api.github.com/repos/aws/aws-sdk-go-v2/issues/2848/events","html_url":"https://github.com/aws/aws-sdk-go-v2/issues/2848","id":2606177189,"node_id":"I_kwDOBbjpF86bVxul","number":2848,"title":"MIGRATION ISSUE: s3: Can no longer use Accept-Encoding: gzip on GetObject","user":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":790750661,"node_id":"MDU6TGFiZWw3OTA3NTA2NjE=","url":"https://api.github.com/repos/aws/aws-sdk-go-v2/labels/response-requested","name":"response-requested","color":"666666","default":false,"description":"Waiting on additional info and feedback. Will move to \"closing-soon\" in 7 days."},{"id":4723088034,"node_id":"LA_kwDOBbjpF88AAAABGYSaog","url":"https://api.github.com/repos/aws/aws-sdk-go-v2/labels/p3","name":"p3","color":"F5DEB3","default":false,"description":"This is a minor priority issue"},{"id":6981164679,"node_id":"LA_kwDOBbjpF88AAAABoBwehw","url":"https://api.github.com/repos/aws/aws-sdk-go-v2/labels/v1-v2-inconsistency","name":"v1-v2-inconsistency","color":"008cff","default":false,"description":"v1-v2-inconsistency Behavior has changed from v1 to v2, or feature is missing altogether"}],"state":"closed","locked":false,"assignee":{"login":"RanVaknin","id":50976344,"node_id":"MDQ6VXNlcjUwOTc2MzQ0","avatar_url":"https://avatars.githubusercontent.com/u/50976344?v=4","gravatar_id":"","url":"https://api.github.com/users/RanVaknin","html_url":"https://github.com/RanVaknin","followers_url":"https://api.github.com/users/RanVaknin/followers","following_url":"https://api.github.com/users/RanVaknin/following{/other_user}","gists_url":"https://api.github.com/users/RanVaknin/gists{/gist_id}","starred_url":"https://api.github.com/users/RanVaknin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/RanVaknin/subscriptions","organizations_url":"https://api.github.com/users/RanVaknin/orgs","repos_url":"https://api.github.com/users/RanVaknin/repos","events_url":"https://api.github.com/users/RanVaknin/events{/privacy}","received_events_url":"https://api.github.com/users/RanVaknin/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"RanVaknin","id":50976344,"node_id":"MDQ6VXNlcjUwOTc2MzQ0","avatar_url":"https://avatars.githubusercontent.com/u/50976344?v=4","gravatar_id":"","url":"https://api.github.com/users/RanVaknin","html_url":"https://github.com/RanVaknin","followers_url":"https://api.github.com/users/RanVaknin/followers","following_url":"https://api.github.com/users/RanVaknin/following{/other_user}","gists_url":"https://api.github.com/users/RanVaknin/gists{/gist_id}","starred_url":"https://api.github.com/users/RanVaknin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/RanVaknin/subscriptions","organizations_url":"https://api.github.com/users/RanVaknin/orgs","repos_url":"https://api.github.com/users/RanVaknin/repos","events_url":"https://api.github.com/users/RanVaknin/events{/privacy}","received_events_url":"https://api.github.com/users/RanVaknin/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":5,"created_at":"2024-10-22T18:28:45Z","updated_at":"2024-10-29T09:13:30Z","closed_at":"2024-10-24T23:07:57Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":96004375,"node_id":"MDEwOlJlcG9zaXRvcnk5NjAwNDM3NQ==","name":"aws-sdk-go-v2","full_name":"aws/aws-sdk-go-v2","private":false,"owner":{"login":"aws","id":2232217,"node_id":"MDEyOk9yZ2FuaXphdGlvbjIyMzIyMTc=","avatar_url":"https://avatars.githubusercontent.com/u/2232217?v=4","gravatar_id":"","url":"https://api.github.com/users/aws","html_url":"https://github.com/aws","followers_url":"https://api.github.com/users/aws/followers","following_url":"https://api.github.com/users/aws/following{/other_user}","gists_url":"https://api.github.com/users/aws/gists{/gist_id}","starred_url":"https://api.github.com/users/aws/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/aws/subscriptions","organizations_url":"https://api.github.com/users/aws/orgs","repos_url":"https://api.github.com/users/aws/repos","events_url":"https://api.github.com/users/aws/events{/privacy}","received_events_url":"https://api.github.com/users/aws/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/aws/aws-sdk-go-v2","description":"AWS SDK for the Go programming language. ","fork":false,"url":"https://api.github.com/repos/aws/aws-sdk-go-v2","forks_url":"https://api.github.com/repos/aws/aws-sdk-go-v2/forks","keys_url":"https://api.github.com/repos/aws/aws-sdk-go-v2/keys{/key_id}","collaborators_url":"https://api.github.com/repos/aws/aws-sdk-go-v2/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/aws/aws-sdk-go-v2/teams","hooks_url":"https://api.github.com/repos/aws/aws-sdk-go-v2/hooks","issue_events_url":"https://api.github.com/repos/aws/aws-sdk-go-v2/issues/events{/number}","events_url":"https://api.github.com/repos/aws/aws-sdk-go-v2/events","assignees_url":"https://api.github.com/repos/aws/aws-sdk-go-v2/assignees{/user}","branches_url":"https://api.github.com/repos/aws/aws-sdk-go-v2/branches{/branch}","tags_url":"https://api.github.com/repos/aws/aws-sdk-go-v2/tags","blobs_url":"https://api.github.com/repos/aws/aws-sdk-go-v2/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/aws/aws-sdk-go-v2/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/aws/aws-sdk-go-v2/git/refs{/sha}","trees_url":"https://api.github.com/repos/aws/aws-sdk-go-v2/git/trees{/sha}","statuses_url":"https://api.github.com/repos/aws/aws-sdk-go-v2/statuses/{sha}","languages_url":"https://api.github.com/repos/aws/aws-sdk-go-v2/languages","stargazers_url":"https://api.github.com/repos/aws/aws-sdk-go-v2/stargazers","contributors_url":"https://api.github.com/repos/aws/aws-sdk-go-v2/contributors","subscribers_url":"https://api.github.com/repos/aws/aws-sdk-go-v2/subscribers","subscription_url":"https://api.github.com/repos/aws/aws-sdk-go-v2/subscription","commits_url":"https://api.github.com/repos/aws/aws-sdk-go-v2/commits{/sha}","git_commits_url":"https://api.github.com/repos/aws/aws-sdk-go-v2/git/commits{/sha}","comments_url":"https://api.github.com/repos/aws/aws-sdk-go-v2/comments{/number}","issue_comment_url":"https://api.github.com/repos/aws/aws-sdk-go-v2/issues/comments{/number}","contents_url":"https://api.github.com/repos/aws/aws-sdk-go-v2/contents/{+path}","compare_url":"https://api.github.com/repos/aws/aws-sdk-go-v2/compare/{base}...{head}","merges_url":"https://api.github.com/repos/aws/aws-sdk-go-v2/merges","archive_url":"https://api.github.com/repos/aws/aws-sdk-go-v2/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/aws/aws-sdk-go-v2/downloads","issues_url":"https://api.github.com/repos/aws/aws-sdk-go-v2/issues{/number}","pulls_url":"https://api.github.com/repos/aws/aws-sdk-go-v2/pulls{/number}","milestones_url":"https://api.github.com/repos/aws/aws-sdk-go-v2/milestones{/number}","notifications_url":"https://api.github.com/repos/aws/aws-sdk-go-v2/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/aws/aws-sdk-go-v2/labels{/name}","releases_url":"https://api.github.com/repos/aws/aws-sdk-go-v2/releases{/id}","deployments_url":"https://api.github.com/repos/aws/aws-sdk-go-v2/deployments","created_at":"2017-07-02T05:30:15Z","updated_at":"2025-11-09T18:34:02Z","pushed_at":"2025-11-08T07:44:10Z","git_url":"git://github.com/aws/aws-sdk-go-v2.git","ssh_url":"git@github.com:aws/aws-sdk-go-v2.git","clone_url":"https://github.com/aws/aws-sdk-go-v2.git","svn_url":"https://github.com/aws/aws-sdk-go-v2","homepage":"","size":981196,"stargazers_count":3342,"watchers_count":3342,"language":"Go","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":false,"has_pages":true,"has_discussions":true,"forks_count":732,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":90,"license":{"key":"apache-2.0","name":"Apache License 2.0","spdx_id":"Apache-2.0","url":"https://api.github.com/licenses/apache-2.0","node_id":"MDc6TGljZW5zZTI="},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["aws","aws-sdk","go","golang"],"visibility":"public","forks":732,"open_issues":90,"watchers":3342,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"### Pre-Migration Checklist\r\n\r\n- [X] I've read the [Migration Guide](https://aws.github.io/aws-sdk-go-v2/docs/migrating/).\r\n- [X] I've checked [AWS Forums](https://forums.aws.amazon.com) and [StackOverflow](https://stackoverflow.com/questions/tagged/aws-sdk-go) for similar migration issues.\r\n\r\n### Go Version Used\r\n\r\ngo1.23.2\r\n\r\n### Describe the Migration Issue\r\n\r\nIn SDK v1 it was possible to specify `Accept-Encoding: gzip` on a GET of an s3 object.\r\n\r\nThis is necessary because without it both Cloudflare R2 and the S3 compatible interface to Google Cloud Storage will transparently decompress files stored **with** `Content-Encoding: gzip` and **without** `Cache-Control: no-transform` and rclone wants to be able to download the files as uploaded otherwise the MD5SUM in the ETags don't match.\r\n\r\nThis is explained in [the google cloud storage docs](https://cloud.google.com/storage/docs/transcoding#decompressive_transcoding). Cloudflare R2 appears to work the same way ~~but I can't find the docs for that.~~ [as this pending commit shows](https://github.com/cloudflare/cloudflare-docs/pull/17328/files).\r\n\r\nThe SDK v1 let users add `Accept-Encoding: gzip` however the SDK v2 seems to overwrite it with `Accept-Encoding: identity` whatever I try.\r\n\r\nThis had lead to this rclone issue https://github.com/rclone/rclone/issues/8137\r\n\r\n### Code Comparison\r\n\r\nV1 code snippet to add `Accept-Encoding: gzip`\r\n\r\n```go\r\n\treq := s3.GetObjectInput{\r\n\t\tBucket:    &bucket,\r\n\t\tKey:       &bucketPath,\r\n\t\tVersionId: o.versionID,\r\n\t}\r\n\tif o.fs.opt.RequesterPays {\r\n\t\treq.RequestPayer = aws.String(s3.RequestPayerRequester)\r\n\t}\r\n        //...\r\n\thttpReq, resp := o.fs.c.GetObjectRequest(&req)\r\n\tfs.FixRangeOption(options, o.bytes)\r\n\r\n\t// Override the automatic decompression in the transport to\r\n\t// download compressed files as-is\r\n\tif o.fs.opt.UseAcceptEncodingGzip.Value {\r\n\t\thttpReq.HTTPRequest.Header.Set(\"Accept-Encoding\", \"gzip\")\r\n\t}\r\n\r\n        // ...\r\n\r\n\terr = o.fs.pacer.Call(func() (bool, error) {\r\n\t\tvar err error\r\n\t\thttpReq.HTTPRequest = httpReq.HTTPRequest.WithContext(ctx)\r\n\t\terr = httpReq.Send()\r\n\t\treturn o.fs.shouldRetry(ctx, err)\r\n\t})\r\n```\r\n\r\nand the converted to the SDKv2 code\r\n\r\n```go\r\n\treq := s3.GetObjectInput{\r\n\t\tBucket:    &bucket,\r\n\t\tKey:       &bucketPath,\r\n\t\tVersionId: o.versionID,\r\n\t}\r\n\tif o.fs.opt.RequesterPays {\r\n\t\treq.RequestPayer = types.RequestPayerRequester\r\n\t}\r\n        //...\r\n\tfs.FixRangeOption(options, o.bytes)\r\n\r\n\tvar APIOptions []func(*middleware.Stack) error\r\n\r\n\t// Override the automatic decompression in the transport to\r\n\t// download compressed files as-is\r\n\tif o.fs.opt.UseAcceptEncodingGzip.Value {\r\n                // NB I can change this to any other header and it gets added, but `Accept-Encoding: gzip` is ignored\r\n\t\tAPIOptions = append(APIOptions, smithyhttp.SetHeaderValue(\"Accept-Encoding\", \"gzip\"))\r\n\t}\r\n\r\n        //...\r\n\r\n\tvar resp *s3.GetObjectOutput\r\n\terr = o.fs.pacer.Call(func() (bool, error) {\r\n\t\tvar err error\r\n\t\tresp, err = o.fs.c.GetObject(ctx, &req, s3.WithAPIOptions(APIOptions...))\r\n\t\treturn o.fs.shouldRetry(ctx, err)\r\n\t})\r\n```\r\n\r\n### Observed Differences/Errors\r\n\r\nWith SDK v1 we see `Accept-Encoding: gzip` in the REQUEST\r\n\r\n```\r\n2024/10/22 11:00:27 DEBUG : HTTP REQUEST (req 0xc0009aa6c0)\r\n2024/10/22 11:00:27 DEBUG : GET /rclone1/file.txt HTTP/1.1\r\nHost: 14aad7c9ed489151b51557e321b246cf.r2.cloudflarestorage.com\r\nUser-Agent: rclone/v1.67.0\r\nAccept-Encoding: gzip\r\nAuthorization: XXXX\r\nX-Amz-Content-Sha256: e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855\r\nX-Amz-Date: 20241022T100027Z\r\n\r\n2024/10/22 11:00:27 DEBUG : HTTP RESPONSE (req 0xc0009aa6c0)\r\n2024/10/22 11:00:27 DEBUG : HTTP/1.1 200 OK\r\nContent-Length: 3899\r\nAccept-Ranges: bytes\r\nCf-Ray: 8d68a3f3bfeebea0-LHR\r\nConnection: keep-alive\r\nContent-Encoding: gzip\r\nContent-Type: text/plain; charset=utf-8\r\nDate: Tue, 22 Oct 2024 10:00:27 GMT\r\nEtag: \"1ca665693609f32ce05e6257c6a3b28d\"\r\nLast-Modified: Tue, 22 Oct 2024 09:59:55 GMT\r\nServer: cloudflare\r\nVary: Accept-Encoding\r\nX-Amz-Meta-Mtime: 1729590134.775546531\r\n```\r\n\r\nAnd with SDKv2 - Note the Accept-Encoding has been turned into `identity` in the REQUEST\r\n\r\n```\r\n2024/10/22 11:02:46 DEBUG : HTTP REQUEST (req 0xc000b1b540)\r\n2024/10/22 11:02:46 DEBUG : GET /rclone1/file.txt?x-id=GetObject HTTP/1.1\r\nHost: 14aad7c9ed489151b51557e321b246cf.r2.cloudflarestorage.com\r\nUser-Agent: rclone/v1.68.1\r\nAccept-Encoding: identity\r\nAmz-Sdk-Invocation-Id: 20bbf29b-eece-4cc7-a1b5-d401370cc611\r\nAmz-Sdk-Request: attempt=1; max=10\r\nAuthorization: XXXX\r\nX-Amz-Content-Sha256: e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855\r\nX-Amz-Date: 20241022T100246Z\r\n\r\n2024/10/22 11:02:46 DEBUG : HTTP RESPONSE (req 0xc000b1b540)\r\n2024/10/22 11:02:46 DEBUG : HTTP/1.1 200 OK\r\nTransfer-Encoding: chunked\r\nCf-Ray: 8d68a757edce6557-LHR\r\nConnection: keep-alive\r\nContent-Type: text/plain; charset=utf-8\r\nDate: Tue, 22 Oct 2024 10:02:46 GMT\r\nEtag: W/\"1ca665693609f32ce05e6257c6a3b28d\"\r\nLast-Modified: Tue, 22 Oct 2024 09:59:55 GMT\r\nServer: cloudflare\r\nVary: Accept-Encoding\r\nX-Amz-Meta-Mtime: 1729590134.775546531\r\n```\r\n\r\n\r\n### Additional Context\r\n\r\nThis problem does not occur with AWS S3. However it could be worked around with the SDK v1 and can no longer be worked around with the SDK v2 so I think it counts as a regression.","reactions":{"url":"https://api.github.com/repos/aws/aws-sdk-go-v2/issues/2848/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/aws/aws-sdk-go-v2/issues/2848/timeline","performed_via_github_app":null,"state_reason":"completed"}},"event":"cross-referenced"},{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2430004495","html_url":"https://github.com/rclone/rclone/issues/8137#issuecomment-2430004495","issue_url":"https://api.github.com/repos/rclone/rclone/issues/8137","id":2430004495,"node_id":"IC_kwDOAQ-n5M6Q1u0P","user":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-10-22T18:48:50Z","updated_at":"2024-10-22T18:48:50Z","body":"I spent a long time looking through the SDKv2 internals and I couldn't find a workaround for this. I made an upstream issue here about this https://github.com/aws/aws-sdk-go-v2/issues/2848 indicating that this is a regression in the SDK. Maybe there is a workaround that they can suggest.\r\n\r\n> > I don't think .gz files want to be uploaded with Content-Encoding: gzip and you should probably fix that!\r\n> \r\n> could you expand more on your reasoning behind that? Or did you mean to say \"_without_ Content-Encoding: gzip\"?\r\n>\r\n> The objects are uploaded with `Content-Type: application/json` and `Content-Encoding: gzip` to R2. I work on both ends of the pipe that produces these objects at Cloudflare, but right now I am just wearing my object-consumer hat ðŸŽ©.\r\n\r\nI would only add `Content-Encoding: gzip` if I was uploading a file that was already gzipped that I wanted to be transparently decompressed. That might be exactly the case you are using here but in that case I wouldn't expect to see `.gz` extensions as the user will download `file.log.gz` and find that it isn't compressed with gzip at all.\r\n\r\nThe above doesn't change the issue though it was just my observation, and apologies in advance if it is incorrect!\r\n\r\n> The transparent decompression of Cloudflare R2 only affects `GetObject` object operation and shouldn't apply to any `PutObject` commands. \r\n\r\nI agree.\r\n\r\n> We frequently recommend users to use `rclone` because it handles the use case of downloading these files **without Cloudflare R2 decompressing them during `GetObject`** (until SDKv2 that is ðŸ˜‰) -- so thank you for putting a fix on the roadmap! \r\n\r\n:heart: \r\n\r\nI do like my object storage systems to give me back exactly the same data I put in, so I'd like to fix this too!\r\n\r\n> We also have a draft of these docs that should soon land on our Developer Documentation for Cloudflare R2, which will hopefully help others understand this behavior. [1](#user-content-fn-1-ee206e71b6768fb80085dd80dc1b5cef)\r\n\r\nExcellent! I couldn't find the docs when I made the issue above.\r\n\r\n> Below is the metadata returned for the object when using 1.68 and 1.67 which does confirm that the `content-encoding` header is no longer being returned to the metadata due to the new AWS SDK not including `Accept-Encoding: gzip`!\r\n\r\nThank you for the confirmation.\r\n","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2430004495/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2430012607","html_url":"https://github.com/rclone/rclone/issues/8137#issuecomment-2430012607","issue_url":"https://api.github.com/repos/rclone/rclone/issues/8137","id":2430012607,"node_id":"IC_kwDOAQ-n5M6Q1wy_","user":{"login":"darthShadow","id":6824881,"node_id":"MDQ6VXNlcjY4MjQ4ODE=","avatar_url":"https://avatars.githubusercontent.com/u/6824881?v=4","gravatar_id":"","url":"https://api.github.com/users/darthShadow","html_url":"https://github.com/darthShadow","followers_url":"https://api.github.com/users/darthShadow/followers","following_url":"https://api.github.com/users/darthShadow/following{/other_user}","gists_url":"https://api.github.com/users/darthShadow/gists{/gist_id}","starred_url":"https://api.github.com/users/darthShadow/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/darthShadow/subscriptions","organizations_url":"https://api.github.com/users/darthShadow/orgs","repos_url":"https://api.github.com/users/darthShadow/repos","events_url":"https://api.github.com/users/darthShadow/events{/privacy}","received_events_url":"https://api.github.com/users/darthShadow/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-10-22T18:53:20Z","updated_at":"2024-10-22T18:53:42Z","body":"Just a thought, but would it be possible to remove the `DisableGzip` middleware from the stack in a custom middleware option? It seems like that's a supported workaround (example for a different middleware: https://github.com/aws/aws-sdk-go-v2/discussions/2090#discussioncomment-10043878).","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2430012607/reactions","total_count":3,"+1":1,"-1":0,"laugh":0,"hooray":1,"confused":0,"heart":1,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"darthShadow","id":6824881,"node_id":"MDQ6VXNlcjY4MjQ4ODE=","avatar_url":"https://avatars.githubusercontent.com/u/6824881?v=4","gravatar_id":"","url":"https://api.github.com/users/darthShadow","html_url":"https://github.com/darthShadow","followers_url":"https://api.github.com/users/darthShadow/followers","following_url":"https://api.github.com/users/darthShadow/following{/other_user}","gists_url":"https://api.github.com/users/darthShadow/gists{/gist_id}","starred_url":"https://api.github.com/users/darthShadow/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/darthShadow/subscriptions","organizations_url":"https://api.github.com/users/darthShadow/orgs","repos_url":"https://api.github.com/users/darthShadow/repos","events_url":"https://api.github.com/users/darthShadow/events{/privacy}","received_events_url":"https://api.github.com/users/darthShadow/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":14791310832,"node_id":"REFE_lADOAQ-n5M6aXn3HzwAAAANxoX3w","url":"https://api.github.com/repos/rclone/rclone/issues/events/14791310832","actor":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"ea603435f918fe4039d156da8f61ad565901f81b","commit_url":"https://api.github.com/repos/rclone/rclone/commits/ea603435f918fe4039d156da8f61ad565901f81b","created_at":"2024-10-22T19:16:49Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2430064686","html_url":"https://github.com/rclone/rclone/issues/8137#issuecomment-2430064686","issue_url":"https://api.github.com/repos/rclone/rclone/issues/8137","id":2430064686,"node_id":"IC_kwDOAQ-n5M6Q19gu","user":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-10-22T19:20:04Z","updated_at":"2024-10-22T19:20:04Z","body":"Excellent suggestion @darthShadow \r\n\r\nI thought that wasn't going to be possible as the `DisableGzip` middleware is in an `internal` package so not accessible from the outside world. However all we need is its `ID` to remove it, and assuming that doesn't change, that is a fixed string `DisableAcceptEncodingGzip`.\r\n\r\nSo here is a potential fix for the problem\r\n\r\n[v1.69.0-beta.8377.ea603435f.fix-8137-s3-cloudflare-gzip](https://beta.rclone.org/branch/fix-8137-s3-cloudflare-gzip/v1.69.0-beta.8377.ea603435f.fix-8137-s3-cloudflare-gzip/) on branch [fix-8137-s3-cloudflare-gzip](https://github.com/rclone/rclone/tree/fix-8137-s3-cloudflare-gzip) (uploaded in 15-30 mins)\r\n\r\nThis should bring the use of `Accept-Encoding:` back into line with rclone 1.67 - rclone will add `Accept-Encoding: gzip` to all requests (except if configured otherwise).\r\n\r\nPlease let me know how you get on with this @cmackenzie1 ","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2430064686/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":14791355984,"node_id":"MEE_lADOAQ-n5M6aXn3HzwAAAANxoi5Q","url":"https://api.github.com/repos/rclone/rclone/issues/events/14791355984","actor":{"login":"darthShadow","id":6824881,"node_id":"MDQ6VXNlcjY4MjQ4ODE=","avatar_url":"https://avatars.githubusercontent.com/u/6824881?v=4","gravatar_id":"","url":"https://api.github.com/users/darthShadow","html_url":"https://github.com/darthShadow","followers_url":"https://api.github.com/users/darthShadow/followers","following_url":"https://api.github.com/users/darthShadow/following{/other_user}","gists_url":"https://api.github.com/users/darthShadow/gists{/gist_id}","starred_url":"https://api.github.com/users/darthShadow/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/darthShadow/subscriptions","organizations_url":"https://api.github.com/users/darthShadow/orgs","repos_url":"https://api.github.com/users/darthShadow/repos","events_url":"https://api.github.com/users/darthShadow/events{/privacy}","received_events_url":"https://api.github.com/users/darthShadow/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2024-10-22T19:20:06Z","performed_via_github_app":null},{"id":14791356002,"node_id":"SE_lADOAQ-n5M6aXn3HzwAAAANxoi5i","url":"https://api.github.com/repos/rclone/rclone/issues/events/14791356002","actor":{"login":"darthShadow","id":6824881,"node_id":"MDQ6VXNlcjY4MjQ4ODE=","avatar_url":"https://avatars.githubusercontent.com/u/6824881?v=4","gravatar_id":"","url":"https://api.github.com/users/darthShadow","html_url":"https://github.com/darthShadow","followers_url":"https://api.github.com/users/darthShadow/followers","following_url":"https://api.github.com/users/darthShadow/following{/other_user}","gists_url":"https://api.github.com/users/darthShadow/gists{/gist_id}","starred_url":"https://api.github.com/users/darthShadow/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/darthShadow/subscriptions","organizations_url":"https://api.github.com/users/darthShadow/orgs","repos_url":"https://api.github.com/users/darthShadow/repos","events_url":"https://api.github.com/users/darthShadow/events{/privacy}","received_events_url":"https://api.github.com/users/darthShadow/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2024-10-22T19:20:06Z","performed_via_github_app":null},{"id":14791356025,"node_id":"MEE_lADOAQ-n5M6aXn3HzwAAAANxoi55","url":"https://api.github.com/repos/rclone/rclone/issues/events/14791356025","actor":{"login":"cmackenzie1","id":10947617,"node_id":"MDQ6VXNlcjEwOTQ3NjE3","avatar_url":"https://avatars.githubusercontent.com/u/10947617?v=4","gravatar_id":"","url":"https://api.github.com/users/cmackenzie1","html_url":"https://github.com/cmackenzie1","followers_url":"https://api.github.com/users/cmackenzie1/followers","following_url":"https://api.github.com/users/cmackenzie1/following{/other_user}","gists_url":"https://api.github.com/users/cmackenzie1/gists{/gist_id}","starred_url":"https://api.github.com/users/cmackenzie1/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cmackenzie1/subscriptions","organizations_url":"https://api.github.com/users/cmackenzie1/orgs","repos_url":"https://api.github.com/users/cmackenzie1/repos","events_url":"https://api.github.com/users/cmackenzie1/events{/privacy}","received_events_url":"https://api.github.com/users/cmackenzie1/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2024-10-22T19:20:06Z","performed_via_github_app":null},{"id":14791356038,"node_id":"SE_lADOAQ-n5M6aXn3HzwAAAANxoi6G","url":"https://api.github.com/repos/rclone/rclone/issues/events/14791356038","actor":{"login":"cmackenzie1","id":10947617,"node_id":"MDQ6VXNlcjEwOTQ3NjE3","avatar_url":"https://avatars.githubusercontent.com/u/10947617?v=4","gravatar_id":"","url":"https://api.github.com/users/cmackenzie1","html_url":"https://github.com/cmackenzie1","followers_url":"https://api.github.com/users/cmackenzie1/followers","following_url":"https://api.github.com/users/cmackenzie1/following{/other_user}","gists_url":"https://api.github.com/users/cmackenzie1/gists{/gist_id}","starred_url":"https://api.github.com/users/cmackenzie1/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cmackenzie1/subscriptions","organizations_url":"https://api.github.com/users/cmackenzie1/orgs","repos_url":"https://api.github.com/users/cmackenzie1/repos","events_url":"https://api.github.com/users/cmackenzie1/events{/privacy}","received_events_url":"https://api.github.com/users/cmackenzie1/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2024-10-22T19:20:06Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2430159623","html_url":"https://github.com/rclone/rclone/issues/8137#issuecomment-2430159623","issue_url":"https://api.github.com/repos/rclone/rclone/issues/8137","id":2430159623,"node_id":"IC_kwDOAQ-n5M6Q2UsH","user":{"login":"cmackenzie1","id":10947617,"node_id":"MDQ6VXNlcjEwOTQ3NjE3","avatar_url":"https://avatars.githubusercontent.com/u/10947617?v=4","gravatar_id":"","url":"https://api.github.com/users/cmackenzie1","html_url":"https://github.com/cmackenzie1","followers_url":"https://api.github.com/users/cmackenzie1/followers","following_url":"https://api.github.com/users/cmackenzie1/following{/other_user}","gists_url":"https://api.github.com/users/cmackenzie1/gists{/gist_id}","starred_url":"https://api.github.com/users/cmackenzie1/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cmackenzie1/subscriptions","organizations_url":"https://api.github.com/users/cmackenzie1/orgs","repos_url":"https://api.github.com/users/cmackenzie1/repos","events_url":"https://api.github.com/users/cmackenzie1/events{/privacy}","received_events_url":"https://api.github.com/users/cmackenzie1/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-10-22T20:09:21Z","updated_at":"2024-10-22T20:09:21Z","body":"@ncw thanks for the quick fix! I tried it out, and it is working for `copy` but doesn't work for `lsjson -M --stat`, so I am assuming this middleware needs to be stripped for `HeadObject` requests as well?\r\n\r\n```\r\nâžœ  rclone-versions git:(cole/DS-14740) âœ— rclone-v1.69.0-beta.8377.ea603435f.fix-8137-s3-cloudflare-gzip-osx-arm64/rclone lsjson -M --stat datalab-r2:cloudflare-logs/workers_trace_events/20221220/20221220T193149Z_20221220T193219Z_f27449c5.log.gz | jq\r\n{\r\n  \"Path\": \"20221220T193149Z_20221220T193219Z_f27449c5.log.gz\",\r\n  \"Name\": \"20221220T193149Z_20221220T193219Z_f27449c5.log.gz\",\r\n  \"Size\": 0,\r\n  \"MimeType\": \"application/json\",\r\n  \"ModTime\": \"2022-12-20T19:32:19.000000000Z\",\r\n  \"IsDir\": false,\r\n  \"Tier\": \"STANDARD\",\r\n  \"Metadata\": {\r\n    \"btime\": \"2022-12-20T19:32:19Z\",\r\n    \"content-type\": \"application/json\",\r\n    \"tier\": \"STANDARD\"\r\n  }\r\n}\r\nâžœ  rclone-versions git:(cole/DS-14740) âœ— rclone-v1.69.0-beta.8377.ea603435f.fix-8137-s3-cloudflare-gzip-osx-arm64/rclone copy datalab-r2:cloudflare-logs/workers_trace_events/20221220/20221220T193149Z_20221220T193219Z_f27449c5.log.gz .\r\n2024/10/22 13:04:45 NOTICE: 20221220T193149Z_20221220T193219Z_f27449c5.log.gz: Not decompressing 'Content-Encoding: gzip' compressed file. Use --s3-decompress to override\r\nâžœ  rclone-versions git:(cole/DS-14740) âœ— file 20221220T193149Z_20221220T193219Z_f27449c5.log.gz\r\n20221220T193149Z_20221220T193219Z_f27449c5.log.gz: gzip compressed data, original size modulo 2^32 363\r\n```","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2430159623/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"cmackenzie1","id":10947617,"node_id":"MDQ6VXNlcjEwOTQ3NjE3","avatar_url":"https://avatars.githubusercontent.com/u/10947617?v=4","gravatar_id":"","url":"https://api.github.com/users/cmackenzie1","html_url":"https://github.com/cmackenzie1","followers_url":"https://api.github.com/users/cmackenzie1/followers","following_url":"https://api.github.com/users/cmackenzie1/following{/other_user}","gists_url":"https://api.github.com/users/cmackenzie1/gists{/gist_id}","starred_url":"https://api.github.com/users/cmackenzie1/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cmackenzie1/subscriptions","organizations_url":"https://api.github.com/users/cmackenzie1/orgs","repos_url":"https://api.github.com/users/cmackenzie1/repos","events_url":"https://api.github.com/users/cmackenzie1/events{/privacy}","received_events_url":"https://api.github.com/users/cmackenzie1/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":14792036860,"node_id":"MEE_lADOAQ-n5M6aXn3HzwAAAANxrJH8","url":"https://api.github.com/repos/rclone/rclone/issues/events/14792036860","actor":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2024-10-22T20:09:23Z","performed_via_github_app":null},{"id":14792036875,"node_id":"SE_lADOAQ-n5M6aXn3HzwAAAANxrJIL","url":"https://api.github.com/repos/rclone/rclone/issues/events/14792036875","actor":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2024-10-22T20:09:23Z","performed_via_github_app":null},{"id":14810588017,"node_id":"REFE_lADOAQ-n5M6aXn3HzwAAAANyx6Nx","url":"https://api.github.com/repos/rclone/rclone/issues/events/14810588017","actor":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"5b629abdc4cbd3302b96db0974e537fb6f90217b","commit_url":"https://api.github.com/repos/rclone/rclone/commits/5b629abdc4cbd3302b96db0974e537fb6f90217b","created_at":"2024-10-23T10:45:37Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2431710947","html_url":"https://github.com/rclone/rclone/issues/8137#issuecomment-2431710947","issue_url":"https://api.github.com/repos/rclone/rclone/issues/8137","id":2431710947,"node_id":"IC_kwDOAQ-n5M6Q8Pbj","user":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-10-23T10:46:53Z","updated_at":"2024-10-23T10:46:53Z","body":"Can you give this a go? This seems to work for HEAD requests now. \r\n\r\nThanks\r\n\r\n[v1.69.0-beta.8377.5b629abdc.fix-8137-s3-cloudflare-gzip](https://beta.rclone.org/branch/fix-8137-s3-cloudflare-gzip/v1.69.0-beta.8377.5b629abdc.fix-8137-s3-cloudflare-gzip/) on branch [fix-8137-s3-cloudflare-gzip](https://github.com/rclone/rclone/tree/fix-8137-s3-cloudflare-gzip) (uploaded in 15-30 mins)","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2431710947/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":1,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2432741351","html_url":"https://github.com/rclone/rclone/issues/8137#issuecomment-2432741351","issue_url":"https://api.github.com/repos/rclone/rclone/issues/8137","id":2432741351,"node_id":"IC_kwDOAQ-n5M6RAK_n","user":{"login":"cmackenzie1","id":10947617,"node_id":"MDQ6VXNlcjEwOTQ3NjE3","avatar_url":"https://avatars.githubusercontent.com/u/10947617?v=4","gravatar_id":"","url":"https://api.github.com/users/cmackenzie1","html_url":"https://github.com/cmackenzie1","followers_url":"https://api.github.com/users/cmackenzie1/followers","following_url":"https://api.github.com/users/cmackenzie1/following{/other_user}","gists_url":"https://api.github.com/users/cmackenzie1/gists{/gist_id}","starred_url":"https://api.github.com/users/cmackenzie1/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cmackenzie1/subscriptions","organizations_url":"https://api.github.com/users/cmackenzie1/orgs","repos_url":"https://api.github.com/users/cmackenzie1/repos","events_url":"https://api.github.com/users/cmackenzie1/events{/privacy}","received_events_url":"https://api.github.com/users/cmackenzie1/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2024-10-23T16:07:06Z","updated_at":"2024-10-23T16:07:06Z","body":"Looks great! Thanks again for such a quick fix â¤ï¸ \r\n\r\n```\r\nâžœ  rclone-versions rclone-v1.69.0-beta.8377.5b629abdc.fix-8137-s3-cloudflare-gzip-osx-arm64/rclone copy datalab-r2:cloudflare-logs/workers_trace_events/20221220/20221220T193149Z_20221220T193219Z_f27449c5.log.gz .\r\n2024/10/23 09:05:58 NOTICE: 20221220T193149Z_20221220T193219Z_f27449c5.log.gz: Not decompressing 'Content-Encoding: gzip' compressed file. Use --s3-decompress to override\r\nâžœ  rclone-versions file 20221220T193149Z_20221220T193219Z_f27449c5.log.gz\r\n20221220T193149Z_20221220T193219Z_f27449c5.log.gz: gzip compressed data, original size modulo 2^32 363\r\nâžœ  rclone-versions rclone-v1.69.0-beta.8377.5b629abdc.fix-8137-s3-cloudflare-gzip-osx-arm64/rclone lsjson -M --stat datalab-r2:cloudflare-logs/workers_trace_events/20221220/20221220T193149Z_20221220T193219Z_f27449c5.log.gz\r\n{\r\n\t\"Path\": \"20221220T193149Z_20221220T193219Z_f27449c5.log.gz\",\r\n\t\"Name\": \"20221220T193149Z_20221220T193219Z_f27449c5.log.gz\",\r\n\t\"Size\": 279,\r\n\t\"MimeType\": \"application/json\",\r\n\t\"ModTime\": \"2022-12-20T19:32:19.000000000Z\",\r\n\t\"IsDir\": false,\r\n\t\"Tier\": \"STANDARD\",\r\n\t\"Metadata\": {\r\n\t\t\"btime\": \"2022-12-20T19:32:19Z\",\r\n\t\t\"content-encoding\": \"gzip\",\r\n\t\t\"content-type\": \"application/json\",\r\n\t\t\"tier\": \"STANDARD\"\r\n\t}\r\n}\r\n```","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/comments/2432741351/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"cmackenzie1","id":10947617,"node_id":"MDQ6VXNlcjEwOTQ3NjE3","avatar_url":"https://avatars.githubusercontent.com/u/10947617?v=4","gravatar_id":"","url":"https://api.github.com/users/cmackenzie1","html_url":"https://github.com/cmackenzie1","followers_url":"https://api.github.com/users/cmackenzie1/followers","following_url":"https://api.github.com/users/cmackenzie1/following{/other_user}","gists_url":"https://api.github.com/users/cmackenzie1/gists{/gist_id}","starred_url":"https://api.github.com/users/cmackenzie1/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cmackenzie1/subscriptions","organizations_url":"https://api.github.com/users/cmackenzie1/orgs","repos_url":"https://api.github.com/users/cmackenzie1/repos","events_url":"https://api.github.com/users/cmackenzie1/events{/privacy}","received_events_url":"https://api.github.com/users/cmackenzie1/received_events","type":"User","user_view_type":"public","site_admin":false}}]