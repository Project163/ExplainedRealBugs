{"url":"https://api.github.com/repos/rclone/rclone/issues/6791","repository_url":"https://api.github.com/repos/rclone/rclone","labels_url":"https://api.github.com/repos/rclone/rclone/issues/6791/labels{/name}","comments_url":"https://api.github.com/repos/rclone/rclone/issues/6791/comments","events_url":"https://api.github.com/repos/rclone/rclone/issues/6791/events","html_url":"https://github.com/rclone/rclone/issues/6791","id":1600585087,"node_id":"I_kwDOAQ-n5M5fZv1_","number":6791,"title":"sftp: using key_use_agent and key_file together requires private key outside of SSH agent","user":{"login":"Arnavion","id":1096010,"node_id":"MDQ6VXNlcjEwOTYwMTA=","avatar_url":"https://avatars.githubusercontent.com/u/1096010?v=4","gravatar_id":"","url":"https://api.github.com/users/Arnavion","html_url":"https://github.com/Arnavion","followers_url":"https://api.github.com/users/Arnavion/followers","following_url":"https://api.github.com/users/Arnavion/following{/other_user}","gists_url":"https://api.github.com/users/Arnavion/gists{/gist_id}","starred_url":"https://api.github.com/users/Arnavion/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Arnavion/subscriptions","organizations_url":"https://api.github.com/users/Arnavion/orgs","repos_url":"https://api.github.com/users/Arnavion/repos","events_url":"https://api.github.com/users/Arnavion/events{/privacy}","received_events_url":"https://api.github.com/users/Arnavion/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2023-02-27T06:49:29Z","updated_at":"2023-03-17T11:44:47Z","closed_at":"2023-03-17T11:44:21Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"#### What is the problem you are having with rclone?\r\n\r\nI have multiple SSH keys in my agent, and want rclone to use one specific key to connect to the host rather than try all of them in sequence. The latter behavior is problematic since hosts can disconnect clients after too many key attempts, and even with regular openssh it's common practice to specify `IdentityKeyFile /path/to/public/key` to limit `ssh` to just that one key.\r\n\r\nFor example, an openssh config might look like:\r\n\r\n```\r\nHost somehost\r\n\tIdentityFile ~/identities/arnavion\r\n\tIdentitiesOnly yes\r\n```\r\n\r\n... where `~/identities/arnavion` is the *public key* file (despite being used as the `IdentityFile`, ie the one that contains `ssh-ed25519 AAAA...`.\r\n\r\nOn the surface, it looks like rclone supports that behavior with this config:\r\n\r\n```\r\n[somehost]\r\ntype = sftp\r\nhost = somehost\r\nkey_file = ~/identities/arnavion\r\nkey_use_agent = true\r\n```\r\n\r\nProblem 1: [The code](https://github.com/rclone/rclone/blob/56b582cdb9e68c9941e90bae47f6144c45e82a8a/backend/sftp/sftp.go#L784-L788) looks for `~/identities/arnavion.pub`, which in my case does not exist. I assume the code was written with the assumption that it would be used with paths like `~/.ssh/id_ed25519` so that it would use the matching pubkey.\r\n\r\nWhile I would prefer to not have to change my workflow just for rclone's sake, I decided to work around it temporarily with:\r\n\r\n```sh\r\nln -s ~/identities/arnavion ~/.ssh/id_ed25519.pub\r\n```\r\n\r\n... and changed the rclone config to:\r\n\r\n```\r\nkey_file = ~/.ssh/id_ed25519\r\n```\r\n\r\n... but this led to...\r\n\r\nProblem 2: [The code](https://github.com/rclone/rclone/blob/56b582cdb9e68c9941e90bae47f6144c45e82a8a/backend/sftp/sftp.go#L811-L817) still fails because it still requires `~/.ssh/id_ed25519` to exist, even though it should have no reason to access that file because it ought to use the agent.\r\n\r\nSo ideally:\r\n\r\n1. rclone would use `key_file` as-is instead of appending `.pub` to it. Or maybe repurpose `pubkey_file` for this for the sake of backward-compatibility with `key_file`'s behavior.\r\n\r\n2. If (1) is not done, ie rclone continues to append `.pub` to the `key_file` value, then it should not care about whether the `key_file` itself exists or not.\r\n\r\n#### What is your rclone version (output from `rclone version`)\r\n\r\n```\r\nrclone v1.61.1-DEV\r\n- os/version: opensuse-tumbleweed (64 bit)\r\n- os/kernel: 6.1.10-1-default (x86_64)\r\n- os/type: linux\r\n- os/arch: amd64\r\n- go/version: go1.19.4\r\n- go/linking: dynamic\r\n- go/tags: none\r\n```\r\n\r\n#### Which OS you are using and how many bits (e.g. Windows 7, 64 bit)\r\n\r\nOpenSUSE Tumbleweed x86_64\r\n\r\n#### Which cloud storage system are you using? (e.g. Google Drive)\r\n\r\nPersonal SSH-accessible server\r\n\r\n#### The command you were trying to run (e.g. `rclone copy /tmp remote:tmp`)\r\n\r\n`rclone lsd somehost:/`\r\n\r\n#### A log from the command with the `-vv` flag (e.g. output from `rclone -vv copy /tmp remote:tmp`)\r\n\r\nProblem 1:\r\n\r\n```\r\n<7>DEBUG : rclone: Version \"v1.61.1-DEV\" starting with parameters [\"rclone\" \"-vv\" \"lsd\" \"somehost:/\"]\r\n<7>DEBUG : rclone: systemd logging support activated\r\n<7>DEBUG : Creating backend with remote \"somehost:/\"\r\n<7>DEBUG : Using config file from \"/home/arnavion/.config/rclone/rclone.conf\"\r\nFailed to create file system for \"somehost:/\": failed to read public key file: open /home/arnavion/identities/arnavion.pub: no such file or directory\r\n```\r\n\r\nProblem 2:\r\n\r\n```\r\n<7>DEBUG : rclone: Version \"v1.61.1-DEV\" starting with parameters [\"rclone\" \"-vv\" \"lsd\" \"somehost:/\"]\r\n<7>DEBUG : rclone: systemd logging support activated\r\n<7>DEBUG : Creating backend with remote \"somehost:/\"\r\n<7>DEBUG : Using config file from \"/home/arnavion/.config/rclone/rclone.conf\"\r\nFailed to create file system for \"somehost:/\": failed to read private key file: open /home/arnavion/.ssh/id_ed25519: no such file or directory\r\n```\r\n\r\n<!--- Please keep the note below for others who read your bug report. -->\r\n\r\n#### How to use GitHub\r\n\r\n* Please use the üëç [reaction](https://blog.github.com/2016-03-10-add-reactions-to-pull-requests-issues-and-comments/) to show that you are affected by the same issue.\r\n* Please don't comment if you have no relevant information to add. It's just extra noise for everyone subscribed to this issue.\r\n* Subscribe to receive notifications on status change and new comments.\r\n","closed_by":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/6791/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rclone/rclone/issues/6791/timeline","performed_via_github_app":null,"state_reason":"completed"}