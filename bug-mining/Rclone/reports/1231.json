{"url":"https://api.github.com/repos/rclone/rclone/issues/7270","repository_url":"https://api.github.com/repos/rclone/rclone","labels_url":"https://api.github.com/repos/rclone/rclone/issues/7270/labels{/name}","comments_url":"https://api.github.com/repos/rclone/rclone/issues/7270/comments","events_url":"https://api.github.com/repos/rclone/rclone/issues/7270/events","html_url":"https://github.com/rclone/rclone/issues/7270","id":1878899657,"node_id":"I_kwDOAQ-n5M5v_bvJ","number":7270,"title":"bisync: handle unicode normalization consistently","user":{"login":"nielash","id":31582349,"node_id":"MDQ6VXNlcjMxNTgyMzQ5","avatar_url":"https://avatars.githubusercontent.com/u/31582349?v=4","gravatar_id":"","url":"https://api.github.com/users/nielash","html_url":"https://github.com/nielash","followers_url":"https://api.github.com/users/nielash/followers","following_url":"https://api.github.com/users/nielash/following{/other_user}","gists_url":"https://api.github.com/users/nielash/gists{/gist_id}","starred_url":"https://api.github.com/users/nielash/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nielash/subscriptions","organizations_url":"https://api.github.com/users/nielash/orgs","repos_url":"https://api.github.com/users/nielash/repos","events_url":"https://api.github.com/users/nielash/events{/privacy}","received_events_url":"https://api.github.com/users/nielash/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":86399005,"node_id":"MDU6TGFiZWw4NjM5OTAwNQ==","url":"https://api.github.com/repos/rclone/rclone/labels/bug","name":"bug","color":"fc2929","default":true,"description":null},{"id":431089529,"node_id":"MDU6TGFiZWw0MzEwODk1Mjk=","url":"https://api.github.com/repos/rclone/rclone/labels/IMPORTANT","name":"IMPORTANT","color":"d93f0b","default":false,"description":null},{"id":2510652221,"node_id":"MDU6TGFiZWwyNTEwNjUyMjIx","url":"https://api.github.com/repos/rclone/rclone/labels/encoding","name":"encoding","color":"b3baf2","default":false,"description":""},{"id":3427818774,"node_id":"LA_kwDOAQ-n5M7MUF0W","url":"https://api.github.com/repos/rclone/rclone/labels/bisync","name":"bisync","color":"1D76DB","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"nielash","id":31582349,"node_id":"MDQ6VXNlcjMxNTgyMzQ5","avatar_url":"https://avatars.githubusercontent.com/u/31582349?v=4","gravatar_id":"","url":"https://api.github.com/users/nielash","html_url":"https://github.com/nielash","followers_url":"https://api.github.com/users/nielash/followers","following_url":"https://api.github.com/users/nielash/following{/other_user}","gists_url":"https://api.github.com/users/nielash/gists{/gist_id}","starred_url":"https://api.github.com/users/nielash/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nielash/subscriptions","organizations_url":"https://api.github.com/users/nielash/orgs","repos_url":"https://api.github.com/users/nielash/repos","events_url":"https://api.github.com/users/nielash/events{/privacy}","received_events_url":"https://api.github.com/users/nielash/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"nielash","id":31582349,"node_id":"MDQ6VXNlcjMxNTgyMzQ5","avatar_url":"https://avatars.githubusercontent.com/u/31582349?v=4","gravatar_id":"","url":"https://api.github.com/users/nielash","html_url":"https://github.com/nielash","followers_url":"https://api.github.com/users/nielash/followers","following_url":"https://api.github.com/users/nielash/following{/other_user}","gists_url":"https://api.github.com/users/nielash/gists{/gist_id}","starred_url":"https://api.github.com/users/nielash/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nielash/subscriptions","organizations_url":"https://api.github.com/users/nielash/orgs","repos_url":"https://api.github.com/users/nielash/repos","events_url":"https://api.github.com/users/nielash/events{/privacy}","received_events_url":"https://api.github.com/users/nielash/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/rclone/rclone/milestones/11","html_url":"https://github.com/rclone/rclone/milestone/11","labels_url":"https://api.github.com/repos/rclone/rclone/milestones/11/labels","id":1480382,"node_id":"MDk6TWlsZXN0b25lMTQ4MDM4Mg==","number":11,"title":"Soon","description":"Issues which are a good idea but haven't been assigned a specific release yet.","creator":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":75,"closed_issues":94,"state":"open","created_at":"2016-01-02T12:56:46Z","updated_at":"2025-10-12T21:14:16Z","due_on":null,"closed_at":null},"comments":0,"created_at":"2023-09-03T01:24:05Z","updated_at":"2024-01-20T19:50:13Z","closed_at":"2024-01-20T19:50:12Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Bisync sometimes normalizes NFD to NFC and sometimes does not, causing errors in some scenarios (particularly for users of macOS). See https://forum.rclone.org/t/bisync-question/41434/12\r\n\r\nHere is a bare-minimum case to reproduce:\r\n```\r\n% rclone touch NFD/oÃà \r\n% rclone touch NFC/√∂\r\n% rclone bisync NFD NFC --resync\r\n2023/09/02 18:23:08 NOTICE: bisync is EXPERIMENTAL. Don't use in production!\r\n% rclone bisync NFD NFC         \r\n2023/09/02 18:23:17 NOTICE: bisync is EXPERIMENTAL. Don't use in production!\r\n2023/09/02 18:23:17 ERROR : -          Path1 file not found in Path2       - oÃà\r\n2023/09/02 18:23:17 ERROR : -          Path2 file not found in Path1       - √∂\r\n2023/09/02 18:23:17 ERROR : Bisync critical error: path1 and path2 are out of sync, run --resync to recover\r\n2023/09/02 18:23:17 ERROR : Bisync aborted. Must run --resync to recover.\r\n% \r\n```\r\n\r\nAs background context: most of the world uses NFC, but macOS prefers NFD for some reason, and will sometimes ([but not always](https://eclecticlight.co/2017/04/06/apfs-is-currently-unusable-with-most-non-english-languages/)) convert NFC filenames to NFD invisibly. (See also: #7072)\r\n\r\nRclone's `copy` and `sync` commands (including the ones used by `bisync` under-the-hood) automatically normalize to NFC, unless `--no-unicode-normalization` is specified. This is why you can usually `rclone sync` between mac and non-mac without issue -- rclone will recognize the NFC and NFD versions as the same filename.\r\n\r\nThe trouble is that there are three places where bisync does NOT do this:\r\n\r\n1. When building the list of files that need to be transferred during `--resync`\r\n2. When building the list of deltas during a non-resync, but only for so-called [\"Unusual sync checks\"](https://tip.rclone.org/bisync/#unusual-sync-checks)\r\n3. When comparing Path1 to Path2 during `--check-sync`\r\n\r\n1 and 2 end up being (mostly) harmless, because although it will try to copy the NFC and NFD versions as different files, the underlying `copy` function it calls is smart enough to realize they are the same file. It will therefore leave the files alone (if already equal) or update one of them (if not equal), but never create a duplicate.\r\n\r\n3 is where the problem is most visible. Because `--check-sync` never normalizes, it thinks the NFC and NFD versions are different files. It therefore thinks something went wrong during the bisync run, because at the end of the run the Path1 file list does not exactly match Path2. Accordingly, it throws a critical error. (`--check-sync` is true by default, but can be overridden with `--check-sync=false`.)\r\n\r\nThe long-term solution is probably that `bisync` should support normalization in the same manner as `sync` (i.e. always normalize when comparing between paths, unless `--no-unicode-normalization` has been specified.) In the mean time, as a short-term solution, the issue can be bypassed by using `--check-sync=false`.\r\n\r\nAlso worth noting: in https://github.com/rclone/rclone/issues/5679#issuecomment-1689295692 we are contemplating whether `--check-sync` should perhaps just be replaced by outsourcing it to the more robust [rclone check](https://tip.rclone.org/bisync/#concurrent-modifications), which duplicates a lot of the same functionality, but does it better. That may ultimately be the answer here too, at least for item 3 (`--check-sync`). But I think items 1 and 2 do still need to be addressed regardless, as they are (at best) misleading to users (for instance, dry runs indicate that files will be transferred when they are not in fact new/changed and won't really be transferred.)\r\n\r\nOne more note: it seems that macOS will accept NFC filenames when created via terminal commands, but not when created via apps or Finder. This is why we don't tend to see these issues at first with files synced from cloud to mac via rclone, but the same files could present issues later if edited by an app or Finder. (This is also why `rclone touch NFC/√∂` in the above repro will work, even on mac.)\r\n\r\n<!--- Please keep the note below for others who read your bug report. -->\r\n\r\n#### How to use GitHub\r\n\r\n* Please use the üëç [reaction](https://blog.github.com/2016-03-10-add-reactions-to-pull-requests-issues-and-comments/) to show that you are affected by the same issue.\r\n* Please don't comment if you have no relevant information to add. It's just extra noise for everyone subscribed to this issue.\r\n* Subscribe to receive notifications on status change and new comments.\r\n","closed_by":{"login":"nielash","id":31582349,"node_id":"MDQ6VXNlcjMxNTgyMzQ5","avatar_url":"https://avatars.githubusercontent.com/u/31582349?v=4","gravatar_id":"","url":"https://api.github.com/users/nielash","html_url":"https://github.com/nielash","followers_url":"https://api.github.com/users/nielash/followers","following_url":"https://api.github.com/users/nielash/following{/other_user}","gists_url":"https://api.github.com/users/nielash/gists{/gist_id}","starred_url":"https://api.github.com/users/nielash/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nielash/subscriptions","organizations_url":"https://api.github.com/users/nielash/orgs","repos_url":"https://api.github.com/users/nielash/repos","events_url":"https://api.github.com/users/nielash/events{/privacy}","received_events_url":"https://api.github.com/users/nielash/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/7270/reactions","total_count":3,"+1":3,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rclone/rclone/issues/7270/timeline","performed_via_github_app":null,"state_reason":"completed"}