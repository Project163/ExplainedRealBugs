{"url":"https://api.github.com/repos/rclone/rclone/issues/7455","repository_url":"https://api.github.com/repos/rclone/rclone","labels_url":"https://api.github.com/repos/rclone/rclone/issues/7455/labels{/name}","comments_url":"https://api.github.com/repos/rclone/rclone/issues/7455/comments","events_url":"https://api.github.com/repos/rclone/rclone/issues/7455/events","html_url":"https://github.com/rclone/rclone/issues/7455","id":2010008068,"node_id":"I_kwDOAQ-n5M53zkoE","number":7455,"title":"serve s3: Incorrect handling of not found key prefix","user":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":6247854145,"node_id":"LA_kwDOAQ-n5M8AAAABdGawQQ","url":"https://api.github.com/repos/rclone/rclone/labels/serve%20s3","name":"serve s3","color":"895AE4","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2023-11-24T17:06:33Z","updated_at":"2023-11-24T20:47:29Z","closed_at":"2023-11-24T20:47:29Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Incorrect handling of not found key prefix\r\n\r\nThis is causing integration test failures, eg\r\n\r\n```\r\nfs/operations$ go test -test.v -test.timeout 1h0m0s -remote serves3: -fast-list -test.run '^(TestRmdirsLeaveRoot)$' -verbose -dump-bodies\r\n```\r\n\r\nThis can be demonstrated by\r\n\r\n```\r\nrclone lsf serves3:files/notfound --dump-bodies\r\n```\r\n\r\n```\r\n2023/11/24 17:03:32 DEBUG : HTTP REQUEST (req 0xc000a6b100)\r\n2023/11/24 17:03:32 DEBUG : GET /files?delimiter=%2F&encoding-type=url&list-type=2&max-keys=1000&prefix=notfound%2F HTTP/1.1\r\nHost: 127.0.0.1:8080\r\nUser-Agent: rclone/\r\nAuthorization: XXXX\r\nX-Amz-Content-Sha256: e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855\r\nX-Amz-Date: 20231124T170332Z\r\nAccept-Encoding: gzip\r\n```\r\n\r\nWhich incorrectly gives no such key\r\n\r\n```\r\n2023/11/24 17:03:32 DEBUG : HTTP RESPONSE (req 0xc000a6b100)\r\n2023/11/24 17:03:32 DEBUG : HTTP/1.1 404 Not Found\r\nContent-Length: 111\r\nAccess-Control-Allow-Headers: Accept, Accept-Encoding, Authorization, Content-Disposition, Content-Length, Content-Type, X-Amz-Date, X-Amz-User-Agent, X-CSRF-Token, x-amz-acl, x-amz-content-sha256, x-amz-meta-filename, x-amz-meta-from, x-amz-meta-private, x-amz-meta-to, x-amz-security-token\r\nAccess-Control-Allow-Methods: POST, GET, OPTIONS, PUT, DELETE, HEAD\r\nAccess-Control-Allow-Origin: *\r\nAccess-Control-Expose-Headers: ETag\r\nContent-Type: text/xml; charset=utf-8\r\nDate: Fri, 24 Nov 2023 17:03:32 GMT\r\nServer: AmazonS3\r\nX-Amz-Id-2: MDEwMzBBMUI4MDRGMzVCNDAxMDMwQTFCODA0RjM1QjQwMTAzMEExQjgwNEYzNUI0MDEwMzBBMUI4MDRGMzVCNA==\r\nX-Amz-Request-Id: 01030A1B804F35B4\r\n\r\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n<Error>\r\n  <Code>NoSuchKey</Code>\r\n  <Message>NoSuchKey</Message>\r\n</Error>\r\n```\r\n\r\nBut AWS just gives an empty result\r\n\r\n    lsf s3:rclone/notfound -vv --dump bodies\r\n\r\n```\r\n2023/11/24 17:02:14 DEBUG : HTTP REQUEST (req 0xc000ca6300)\r\n2023/11/24 17:02:14 DEBUG : GET /?delimiter=%2F&encoding-type=url&list-type=2&max-keys=1000&prefix=notfound%2F HTTP/1.1\r\nHost: rclone.s3.eu-west-2.amazonaws.com\r\nUser-Agent: rclone/\r\nAuthorization: XXXX\r\nX-Amz-Content-Sha256: e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855\r\nX-Amz-Date: 20231124T170214Z\r\nAccept-Encoding: gzip\r\n```\r\n\r\n```\r\n2023/11/24 17:02:14 DEBUG : HTTP RESPONSE (req 0xc000ca6300)\r\n2023/11/24 17:02:14 DEBUG : HTTP/1.1 200 OK\r\nTransfer-Encoding: chunked\r\nContent-Type: application/xml\r\nDate: Fri, 24 Nov 2023 17:02:16 GMT\r\nServer: AmazonS3\r\nX-Amz-Bucket-Region: eu-west-2\r\nX-Amz-Id-2: lwSxrPB+HIVSlIG3g2t2UQifZnKGh3lcpQVAcclEuWwROGBvnzcVUzvZJp+U9wnlpj7JmNx94M0=\r\nX-Amz-Request-Id: 4KSCF7CH5ST25ZTK\r\n\r\n12e\r\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n<ListBucketResult xmlns=\"http://s3.amazonaws.com/doc/2006-03-01/\"><Name>rclone</Name><Prefix>notfound/</Prefix><KeyCount>0</KeyCount><MaxKeys>1000</MaxKeys><Delimiter>/</Delimiter><EncodingType>url</EncodingType><IsTruncated>false</IsTruncated></ListBucketResult>\r\n0\r\n\r\n```\r\n#### How to use GitHub\r\n\r\n* Please use the üëç [reaction](https://blog.github.com/2016-03-10-add-reactions-to-pull-requests-issues-and-comments/) to show that you are affected by the same issue.\r\n* Please don't comment if you have no relevant information to add. It's just extra noise for everyone subscribed to this issue.\r\n* Subscribe to receive notifications on status change and new comments.\r\n","closed_by":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/7455/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rclone/rclone/issues/7455/timeline","performed_via_github_app":null,"state_reason":"completed"}