{"url":"https://api.github.com/repos/rclone/rclone/issues/5583","repository_url":"https://api.github.com/repos/rclone/rclone","labels_url":"https://api.github.com/repos/rclone/rclone/issues/5583/labels{/name}","comments_url":"https://api.github.com/repos/rclone/rclone/issues/5583/comments","events_url":"https://api.github.com/repos/rclone/rclone/issues/5583/events","html_url":"https://github.com/rclone/rclone/issues/5583","id":989864210,"node_id":"MDU6SXNzdWU5ODk4NjQyMTA=","number":5583,"title":"Cleanup uncommitted blocks in Azure Blob storage in case of upload errors","user":{"login":"sschols","id":60104242,"node_id":"MDQ6VXNlcjYwMTA0MjQy","avatar_url":"https://avatars.githubusercontent.com/u/60104242?v=4","gravatar_id":"","url":"https://api.github.com/users/sschols","html_url":"https://github.com/sschols","followers_url":"https://api.github.com/users/sschols/followers","following_url":"https://api.github.com/users/sschols/following{/other_user}","gists_url":"https://api.github.com/users/sschols/gists{/gist_id}","starred_url":"https://api.github.com/users/sschols/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sschols/subscriptions","organizations_url":"https://api.github.com/users/sschols/orgs","repos_url":"https://api.github.com/users/sschols/repos","events_url":"https://api.github.com/users/sschols/events{/privacy}","received_events_url":"https://api.github.com/users/sschols/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":86399007,"node_id":"MDU6TGFiZWw4NjM5OTAwNw==","url":"https://api.github.com/repos/rclone/rclone/labels/enhancement","name":"enhancement","color":"84b6eb","default":true,"description":null},{"id":718218493,"node_id":"MDU6TGFiZWw3MTgyMTg0OTM=","url":"https://api.github.com/repos/rclone/rclone/labels/help%20wanted","name":"help wanted","color":"c2e0c6","default":true,"description":null},{"id":1043114791,"node_id":"MDU6TGFiZWwxMDQzMTE0Nzkx","url":"https://api.github.com/repos/rclone/rclone/labels/Remote:%20Azure%20Blob","name":"Remote: Azure Blob","color":"fbca04","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/rclone/rclone/milestones/58","html_url":"https://github.com/rclone/rclone/milestone/58","labels_url":"https://api.github.com/repos/rclone/rclone/milestones/58/labels","id":11570782,"node_id":"MI_kwDOAQ-n5M4AsI5e","number":58,"title":"v1.70","description":"","creator":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":30,"state":"closed","created_at":"2024-09-11T21:18:44Z","updated_at":"2025-06-23T15:40:38Z","due_on":"2025-06-17T07:00:00Z","closed_at":"2025-06-19T17:12:14Z"},"comments":10,"created_at":"2021-09-07T11:04:39Z","updated_at":"2025-01-22T12:02:12Z","closed_at":"2025-01-22T11:56:14Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"<!--\r\n\r\nWelcome :-) We understand you are having a problem with rclone; we want to help you with that!\r\n\r\nIf you've just got a question or aren't sure if you've found a bug then please use the rclone forum:\r\n\r\n    https://forum.rclone.org/\r\n\r\ninstead of filing an issue for a quick response.\r\n\r\nIf you are reporting a bug or asking for a new feature then please use one of the templates here:\r\n\r\n    https://github.com/rclone/rclone/issues/new\r\n\r\notherwise fill in the form below.\r\n\r\nThank you\r\n\r\nThe Rclone Developers\r\n\r\n-->\r\n\r\n\r\n#### Output of `rclone version`\r\n\r\n```\r\nrclone v1.55.1\r\n- os/version: redhat 8.2 (64 bit)\r\n- os/kernel: 4.18.0-193.60.2.el8_2.x86_64 (x86_64)\r\n- os/type: linux\r\n- os/arch: amd64\r\n- go/version: go1.16.3\r\n- go/linking: static\r\n- go/tags: none\r\n```\r\n\r\n#### Describe the issue\r\n\r\nWe're uploading rather large files into an Azure storage account using `rclone copy`, and when that upload fails, lots of uncommitted blocks get left behind. Azure has a limit of 100.000 uncommitted blocks per storage account, so when you then try to upload other stuff into that account, or simply the same file again, you can run into this limit. This causes errors like the following:\r\n\r\n```\r\n2021-08-31 06:03:30 ERROR : ***/***.tgz: Failed to copy: write error: -> github.com/Azure/azure-storage-blob-go/azblob.newStorageError, github.com/Azure/azure-storage-blob-go@v0.13.0/azblob/zc_storage_error.go:42\r\n===== RESPONSE ERROR (ServiceCode=BlockCountExceedsLimit) =====\r\nDescription=The uncommitted block count cannot exceed the maximum limit of 100,000 blocks.\r\nRequestId:***\r\nTime:2021-08-31T04:03:30.3894990Z, Details:\r\n   Code: BlockCountExceedsLimit\r\n   PUT https://**********.blob.core.windows.net/***/****/*****.tgz?blockid=******&comp=block&timeout=31536001\r\n   Authorization: REDACTED\r\n   Content-Length: [16777216]\r\n   User-Agent: [rclone/v1.55.1]\r\n   X-Ms-Client-Request-Id: [***]\r\n   X-Ms-Date: [Tue, 31 Aug 2021 04:03:30 GMT]\r\n   X-Ms-Version: [2019-12-12]\r\n   --------------------------------------------------------------------------------\r\n   RESPONSE Status: 409 The uncommitted block count cannot exceed the maximum limit of 100,000 blocks.\r\n   Content-Length: [269]\r\n   Content-Type: [application/xml]\r\n   Date: [Tue, 31 Aug 2021 04:03:30 GMT]\r\n   Server: [Windows-Azure-Blob/1.0 Microsoft-HTTPAPI/2.0]\r\n   X-Ms-Client-Request-Id: [***]\r\n   X-Ms-Error-Code: [BlockCountExceedsLimit]\r\n   X-Ms-Request-Id: [***]\r\n   X-Ms-Version: [2019-12-12]\r\nTransferred:     144.822M / 1.527 TBytes, 0%, 419.168 MBytes/s, ETA 1h3m39s\r\nErrors:                 1 (retrying may help)\r\nChecks:                12 / 12, 100%\r\nTransferred:            1 / 3, 33%\r\nElapsed time:         0.4s\r\n```\r\nThe same occurs with a newer 1.56.0 version of rclone.\r\n\r\nAzure cleans out uncommitted blocks every 7 days only, so waiting for this garbage collection is not feasible.\r\n\r\nA solution is to create a small or empty dummy blob with the same name as the one that failed, and when uploading this one successfully and deleting it again, the uncommitted blocks of a previous upload are removed automatically. This behavior is described at https://stackoverflow.com/questions/68662051/how-to-delete-uncommitted-blocks-in-azure-blob-storage.\r\n\r\nIt would be great if rclone could try to do the same thing automatically. Say if an upload fails for whatever reasons, it tries to cleanup be uploading and deleting an empty blob. azcopy seems to do the same thing, as mentioned in a GitHub issue comment here: https://github.com/MicrosoftDocs/azure-docs/issues/36347#issuecomment-541457962\r\n","closed_by":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/5583/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rclone/rclone/issues/5583/timeline","performed_via_github_app":null,"state_reason":"completed"}