{"url":"https://api.github.com/repos/rclone/rclone/issues/4883","repository_url":"https://api.github.com/repos/rclone/rclone","labels_url":"https://api.github.com/repos/rclone/rclone/issues/4883/labels{/name}","comments_url":"https://api.github.com/repos/rclone/rclone/issues/4883/comments","events_url":"https://api.github.com/repos/rclone/rclone/issues/4883/events","html_url":"https://github.com/rclone/rclone/issues/4883","id":772720267,"node_id":"MDU6SXNzdWU3NzI3MjAyNjc=","number":4883,"title":"SFTP Storages - Unable to access - socket: too many open files ","user":{"login":"mchrisson","id":11784158,"node_id":"MDQ6VXNlcjExNzg0MTU4","avatar_url":"https://avatars.githubusercontent.com/u/11784158?v=4","gravatar_id":"","url":"https://api.github.com/users/mchrisson","html_url":"https://github.com/mchrisson","followers_url":"https://api.github.com/users/mchrisson/followers","following_url":"https://api.github.com/users/mchrisson/following{/other_user}","gists_url":"https://api.github.com/users/mchrisson/gists{/gist_id}","starred_url":"https://api.github.com/users/mchrisson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mchrisson/subscriptions","organizations_url":"https://api.github.com/users/mchrisson/orgs","repos_url":"https://api.github.com/users/mchrisson/repos","events_url":"https://api.github.com/users/mchrisson/events{/privacy}","received_events_url":"https://api.github.com/users/mchrisson/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":86399005,"node_id":"MDU6TGFiZWw4NjM5OTAwNQ==","url":"https://api.github.com/repos/rclone/rclone/labels/bug","name":"bug","color":"fc2929","default":true,"description":null},{"id":608259405,"node_id":"MDU6TGFiZWw2MDgyNTk0MDU=","url":"https://api.github.com/repos/rclone/rclone/labels/Remote:%20SFTP","name":"Remote: SFTP","color":"fbca04","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/rclone/rclone/milestones/43","html_url":"https://github.com/rclone/rclone/milestone/43","labels_url":"https://api.github.com/repos/rclone/rclone/milestones/43/labels","id":5847508,"node_id":"MDk6TWlsZXN0b25lNTg0NzUwOA==","number":43,"title":"v1.55","description":"","creator":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":55,"state":"closed","created_at":"2020-09-05T13:45:35Z","updated_at":"2021-04-03T13:38:18Z","due_on":"2021-03-31T07:00:00Z","closed_at":"2021-04-03T13:38:18Z"},"comments":17,"created_at":"2020-12-22T07:40:26Z","updated_at":"2021-02-16T12:40:11Z","closed_at":"2021-02-16T12:39:22Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"<!--\r\n\r\nWelcome :-) We understand you are having a problem with rclone; we want to help you with that!\r\n\r\nIf you've just got a question or aren't sure if you've found a bug then please use the rclone forum:\r\n\r\n    https://forum.rclone.org/\r\n\r\ninstead of filing an issue for a quick response.\r\n\r\nIf you think you might have found a bug, please can you try to replicate it with the latest beta?\r\n\r\n    https://beta.rclone.org/\r\n    \r\nIf you can still replicate it with the latest beta, then please fill in the info below which makes our lives much easier.  A log with -vv will make our day :-)\r\n\r\nThank you\r\n\r\nThe Rclone Developers\r\n\r\n-->\r\n\r\n#### What is the problem you are having with rclone?\r\nI use rclone to perform file operations on SFTP storages via my nodeJS based application.\r\n\r\nThe observations is that,\r\nAfter rclone process is running for a really long time (I have configured it to run as a service on ubuntu), and there have been many operations performed mostly listing files, etc. I am no longer able to perform any further operations. All I get is the following error (masqueraded).\r\n\r\n`{\r\n\t\"error\": \"NewFs: couldn't connect SSH: dial tcp 15.97.xxx.xx:22: socket: too many open files\",\r\n\t\"input\": {\r\n\t\t\"fs\": \"SFTP-Store-xxxxx:\",\r\n\t\t\"remote\": \"xxxx/xxxx/xxxxxx/xxxxxxxxxx\"\r\n\t},\r\n\t\"path\": \"operations/list\",\r\n\t\"status\": 500\r\n}`\r\n\r\nI found many similar [threads](https://github.com/rclone/rclone/issues/1111), suggesting bumping up the ulimit.\r\nWell I believe that this may just increase the amount of time before which this error starts showing up again, but not solve the issue.\r\n\r\nThe current ulimit is default to 1024.\r\n\r\nAlso, here's the output of `lsof | grep \"rclone\" | wc -l`\r\n8213\r\n\r\nAlso of `lsof | grep \"rclone\"` (snippet)\r\nrclone    11323 25901             root 1011u     IPv4          123373227       0t0        TCP \\<hostname-of-server-running-rclone>:45468->15.1.xxx.xx:ssh (ESTABLISHED)\r\nrclone    11323 25901             root 1012u     IPv4          123343544       0t0        TCP \\<hostname-of-server-running-rclone>:45082->15.1.xxx.xx:ssh (ESTABLISHED)\r\nrclone    11323 25901             root 1013u     IPv4          123313393       0t0        TCP \\<hostname-of-server-running-rclone>:47984->\\<hostname-of-SFTP-server>:ssh (ESTABLISHED)\r\nrclone    11323 25901             root 1014u     IPv4          123312025       0t0        TCP \\<hostname-of-server-running-rclone>:47986->\\<hostname-of-SFTP-server>:ssh (ESTABLISHED)\r\nrclone    11323 25901             root 1015u     IPv4          123404822       0t0        TCP \\<hostname-of-server-running-rclone>:49316->\\<hostname-of-SFTP-server>:ssh (ESTABLISHED)\r\nrclone    11323 25901             root 1016u     IPv4          123343555       0t0        TCP \\<hostname-of-server-running-rclone>:48382->\\<hostname-of-SFTP-server>:ssh (ESTABLISHED)\r\nrclone    11323 25901             root 1017u     IPv4          123376162       0t0        TCP \\<hostname-of-server-running-rclone>:49032->\\<hostname-of-SFTP-server>:ssh (ESTABLISHED)\r\nrclone    11323 25901             root 1018u     IPv4          123373236       0t0        TCP \\<hostname-of-server-running-rclone>:48802->\\<hostname-of-SFTP-server>:ssh (ESTABLISHED)\r\nrclone    11323 25901             root 1019u     IPv4          123373368       0t0        TCP \\<hostname-of-server-running-rclone>:49140->\\<hostname-of-SFTP-server>:ssh (ESTABLISHED)\r\nrclone    11323 25901             root 1020u     IPv4          123373238       0t0        TCP \\<hostname-of-server-running-rclone>:48818->\\<hostname-of-SFTP-server>:ssh (ESTABLISHED)\r\nrclone    11323 25901             root 1021u     IPv4          123344101       0t0        TCP \\<hostname-of-server-running-rclone>:48370->\\<hostname-of-SFTP-server>:ssh (ESTABLISHED)\r\nrclone    11323 25901             root 1022u     IPv4          123344102       0t0        TCP \\<hostname-of-server-running-rclone>:48372->\\<hostname-of-SFTP-server>:ssh (ESTABLISHED)\r\nrclone    11323 25901             root 1023u     IPv4          123343550       0t0        TCP \\<hostname-of-server-running-rclone>:48374->\\<hostname-of-SFTP-server>:ssh (ESTABLISHED)\r\n\r\nI see too many connections that stay \"ESTABLISHED\". I wonder why these don't close and rather stay connected.\r\n\r\nThe output of `lsof | grep \"rclone\" | grep -i \"close\"` is empty.\r\n\r\nPerhaps, there is a file descriptor leak OR may be SSH connections being kept active after every operation, thus growing in number unnecessarily.\r\n\r\nOfcourse, restarting rclone resolves the issue, but I don't intent to be restarting it.\r\n\r\n#### What is your rclone version (output from `rclone version`)\r\nrclone v1.53.2\r\n- os/arch: linux/amd64\r\n- go version: go1.15.3\r\n\r\n#### Which OS you are using and how many bits (e.g. Windows 7, 64 bit)\r\nUbuntu 18.04.3 LTS, 64 bit\r\n\r\n\r\n####  Which cloud storage system are you using? (e.g. Google Drive)\r\nSFTP\r\n\r\n\r\n#### The command you were trying to run (e.g. `rclone copy /tmp remote:tmp`)\r\nUsing rclone API to list files or any other operations on the remote storage for that matter.\r\n\r\n\r\n#### A log from the command with the `-vv` flag (e.g. output from `rclone -vv copy /tmp remote:tmp`)\r\nBelow is the response from 'operations/list' on storage: \"SFTP-Store-xxxxx\" using API.\r\n\r\n`{\r\n\t\"error\": \"NewFs: couldn't connect SSH: dial tcp 15.97.xxx.xx:22: socket: too many open files\",\r\n\t\"input\": {\r\n\t\t\"fs\": \"SFTP-Store-xxxxx:\",\r\n\t\t\"remote\": \"xxxx/xxxx/xxxxxx/xxxxxxxxxx\"\r\n\t},\r\n\t\"path\": \"operations/list\",\r\n\t\"status\": 500\r\n}`\r\n\r\n","closed_by":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/4883/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rclone/rclone/issues/4883/timeline","performed_via_github_app":null,"state_reason":"completed"}