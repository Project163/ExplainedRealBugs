{"url":"https://api.github.com/repos/rclone/rclone/issues/4929","repository_url":"https://api.github.com/repos/rclone/rclone","labels_url":"https://api.github.com/repos/rclone/rclone/issues/4929/labels{/name}","comments_url":"https://api.github.com/repos/rclone/rclone/issues/4929/comments","events_url":"https://api.github.com/repos/rclone/rclone/issues/4929/events","html_url":"https://github.com/rclone/rclone/issues/4929","id":785586508,"node_id":"MDU6SXNzdWU3ODU1ODY1MDg=","number":4929,"title":"Union mount attempts to write to a read-only upstream","user":{"login":"robotoshi","id":6509778,"node_id":"MDQ6VXNlcjY1MDk3Nzg=","avatar_url":"https://avatars.githubusercontent.com/u/6509778?v=4","gravatar_id":"","url":"https://api.github.com/users/robotoshi","html_url":"https://github.com/robotoshi","followers_url":"https://api.github.com/users/robotoshi/followers","following_url":"https://api.github.com/users/robotoshi/following{/other_user}","gists_url":"https://api.github.com/users/robotoshi/gists{/gist_id}","starred_url":"https://api.github.com/users/robotoshi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/robotoshi/subscriptions","organizations_url":"https://api.github.com/users/robotoshi/orgs","repos_url":"https://api.github.com/users/robotoshi/repos","events_url":"https://api.github.com/users/robotoshi/events{/privacy}","received_events_url":"https://api.github.com/users/robotoshi/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":86399005,"node_id":"MDU6TGFiZWw4NjM5OTAwNQ==","url":"https://api.github.com/repos/rclone/rclone/labels/bug","name":"bug","color":"fc2929","default":true,"description":null},{"id":1076920341,"node_id":"MDU6TGFiZWwxMDc2OTIwMzQx","url":"https://api.github.com/repos/rclone/rclone/labels/Remote:%20Union","name":"Remote: Union","color":"fbca04","default":false,"description":""},{"id":1891823079,"node_id":"MDU6TGFiZWwxODkxODIzMDc5","url":"https://api.github.com/repos/rclone/rclone/labels/waiting%20for%20reply...","name":"waiting for reply...","color":"ef0093","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/rclone/rclone/milestones/43","html_url":"https://github.com/rclone/rclone/milestone/43","labels_url":"https://api.github.com/repos/rclone/rclone/milestones/43/labels","id":5847508,"node_id":"MDk6TWlsZXN0b25lNTg0NzUwOA==","number":43,"title":"v1.55","description":"","creator":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":55,"state":"closed","created_at":"2020-09-05T13:45:35Z","updated_at":"2021-04-03T13:38:18Z","due_on":"2021-03-31T07:00:00Z","closed_at":"2021-04-03T13:38:18Z"},"comments":3,"created_at":"2021-01-14T01:54:31Z","updated_at":"2021-03-15T19:22:22Z","closed_at":"2021-03-15T19:22:21Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"#### What is the problem you are having with rclone?\r\n\r\nAccording to the documentation for the Union backend:\r\n\r\n> - All **action** policies will filter out remotes which are tagged as **read-only**.\r\n> - All **create** policies will filter out remotes which are tagged **read-only** or **no-create**.\r\n\r\nBut this does not appear to always be obeyed.\r\nIf I mount a union of a read-only upstream and a writeable local upstream, then modify a file that is only present on the read-only one, rclone keeps on trying to upload that change to the read-only upstream and then failing because it's read-only!\r\n\r\nWhat I would *really* like is for it to do a copy-on-write and just create that modified file on my local upstream, but I think I saw that as a really old feature request. Most importantly thoughis for it to quit trying to upload to a remote that it knows is read-only.\r\n\r\nFlags `--retries`, `--retries-sleep`, and `--low-level-retries` all appear to have no effect on th number or duration of the retries.\r\n\r\nI've tried rc API calls `vfs/forget`, `vfs/refresh` as well as sending a SIGHUP, but they do not actually clear the cache enough to completely foget about the modified file. \r\n(Side note: `cache/expire` returns a 404)\r\n\r\n#### What is your rclone version (output from `rclone version`)\r\n\r\n```\r\nrclone v1.53.3\r\n- os/arch: linux/amd64\r\n- go version: go1.15.5\r\n```\r\nInstalled using the most recent .deb\r\n\r\n#### Which OS you are using and how many bits (e.g. Windows 7, 64 bit)\r\n\r\nUbuntu 20.04.1 LTS \"Focal\" (64-bit)\r\n\r\n####  Which cloud storage system are you using? (e.g. Google Drive)\r\n\r\nLocal+Local\r\nand\r\nLocal+HTTP\r\n\r\n#### The command you were trying to run\r\n\r\n`rclone mount -vv merge: /home/user/my-mount --vfs-cache-mode=writes`\r\n\r\n#### The rclone config contents with secrets removed.\r\n\r\n```\r\n  [my-local]\r\n  type = local\r\n  \r\n  [my-remote]\r\n  type = http\r\n  url = http://localhost:8080\r\n  \r\n  [merge]\r\n  type = union\r\n  upstreams = my-local:/home/user/dir my-remote:/:ro\r\n  action_policy = all\r\n  create_policy = all\r\n  search_policy = all\r\n```\r\n\r\n#### A log from the command with the `-vv` flag (e.g. output from `rclone -vv copy /tmp remote:tmp`)\r\n\r\n```\r\n2021/01/10 22:17:33 DEBUG : read-only-file.txt: vfs cache: starting upload\r\n2021/01/10 22:17:33 ERROR : read-only-file.txt: Failed to copy: permission denied\r\n2021/01/10 22:17:33 ERROR : read-only-file.txt: vfs cache: failed to upload try #1, will retry in 10s: vfs cache: failed to transfer file from cache to remote: permission denied\r\n...\r\n```\r\n\r\n#### Workaround\r\n\r\nThe only workaround I've found to make it forget about the files and restore the originals from the remote is to manually delete the file from the VFS cache (`rm ~/.cache/vfs/path/to/file`), at which point it will attempt to \"upload\" it again and \"succeed\"\r\n\r\n```\r\n2021/01/13 18:40:19 DEBUG : vfs cache RemoveNotInUse (maxAge=3600000000000, emptyOnly=false): item path/to/file not removed, freed 0 bytes\r\n2021/01/13 18:40:19 INFO  : vfs cache: cleaned: objects 1 (was 1) in use 1, to upload 1, uploading 0, total size 104 (was 104)\r\n2021/01/13 18:40:19 DEBUG : path/to/file: vfs cache: starting upload\r\n2021/01/13 18:40:19 DEBUG : path/to/file: vfs cache: writeback object to VFS layer\r\n2021/01/13 18:40:19 DEBUG : : Added virtual directory entry vAdd: \"H.h\"\r\n2021/01/13 18:40:19 INFO  : path/to/file: vfs cache: upload succeeded try #2\r\n2021/01/13 18:41:19 DEBUG : vfs cache RemoveNotInUse (maxAge=3600000000000, emptyOnly=false): item path/to/file not removed, freed 0 bytes\r\n2021/01/13 18:41:19 INFO  : vfs cache: cleaned: objects 1 (was 1) in use 0, to upload 0, uploading 0, total size 104 (was 104)\r\n```\r\nAnd that's basically fine.  Seems like it's still claiming to keep the file in its cache, but the working directory is restored and it doesn't keep retrying.\r\nNote how it still reports the file as \"not removed\".\r\nIt appears the only way to make it *truly* \"forget\" about the file is to restart rclone.","closed_by":{"login":"ncw","id":536803,"node_id":"MDQ6VXNlcjUzNjgwMw==","avatar_url":"https://avatars.githubusercontent.com/u/536803?v=4","gravatar_id":"","url":"https://api.github.com/users/ncw","html_url":"https://github.com/ncw","followers_url":"https://api.github.com/users/ncw/followers","following_url":"https://api.github.com/users/ncw/following{/other_user}","gists_url":"https://api.github.com/users/ncw/gists{/gist_id}","starred_url":"https://api.github.com/users/ncw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncw/subscriptions","organizations_url":"https://api.github.com/users/ncw/orgs","repos_url":"https://api.github.com/users/ncw/repos","events_url":"https://api.github.com/users/ncw/events{/privacy}","received_events_url":"https://api.github.com/users/ncw/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rclone/rclone/issues/4929/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rclone/rclone/issues/4929/timeline","performed_via_github_app":null,"state_reason":"completed"}