{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/3180","repository_url":"https://api.github.com/repos/BurntSushi/ripgrep","labels_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/3180/labels{/name}","comments_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/3180/comments","events_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/3180/events","html_url":"https://github.com/BurntSushi/ripgrep/issues/3180","id":3507581025,"node_id":"I_kwDOAzJbyc7REXBh","number":3180,"title":"rg panic caused by --replace, --multiline, a particular pattern, and search text containing repeats and newlines","user":{"login":"edhalter","id":11418429,"node_id":"MDQ6VXNlcjExNDE4NDI5","avatar_url":"https://avatars.githubusercontent.com/u/11418429?v=4","gravatar_id":"","url":"https://api.github.com/users/edhalter","html_url":"https://github.com/edhalter","followers_url":"https://api.github.com/users/edhalter/followers","following_url":"https://api.github.com/users/edhalter/following{/other_user}","gists_url":"https://api.github.com/users/edhalter/gists{/gist_id}","starred_url":"https://api.github.com/users/edhalter/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/edhalter/subscriptions","organizations_url":"https://api.github.com/users/edhalter/orgs","repos_url":"https://api.github.com/users/edhalter/repos","events_url":"https://api.github.com/users/edhalter/events{/privacy}","received_events_url":"https://api.github.com/users/edhalter/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":339721678,"node_id":"MDU6TGFiZWwzMzk3MjE2Nzg=","url":"https://api.github.com/repos/BurntSushi/ripgrep/labels/bug","name":"bug","color":"fc2929","default":true,"description":"A bug."}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2025-10-12T17:29:32Z","updated_at":"2025-10-12T21:25:20Z","closed_at":"2025-10-12T21:25:20Z","author_association":"NONE","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Please tick this box to confirm you have reviewed the above.\n\n- [x] I have a different issue.\n\n### What version of ripgrep are you using?\n\nripgrep 14.1.1\n\nfeatures:+pcre2\nsimd(compile):+SSE2,-SSSE3,-AVX2\nsimd(runtime):+SSE2,+SSSE3,+AVX2\n\nPCRE2 10.43 is available (JIT is available)\n\n### How did you install ripgrep?\n\nGentoo Portage\n\n### What operating system are you using ripgrep on?\n\nGentoo Linux\n\n### Describe your bug.\n\nWhen using the --replace and --multiline flags w/ certain search patterns, ripgrep panics when it searches text containing certain sequences of repeated text and newlines. The panic message is \"slice index starts at x but ends at y\", where x and y are integers and y < x.\n\nBackground: I have a program that runs ripgrep (and other regex software), parses its output, and counts and displays word sequences. Ripgrep has performed great; I've used many, many different search patterns on ~50 MiB of English text in ~5,000 files. Recently ran across this bug. The initial search pattern was much more complicated -- I spent some time simplifying it down to these 2 minimal test cases. (If it's useful, I can explain why the various groups in the pattern are there.)\n\nEach minimal search pattern is extremely specific. Removing almost any element will prevent the bug from appearing; for example, changing the initial group from `(^|[^a-z])` to `^`, or changing the \"\\s\" in the middle to \" \". Similar situation for the search text: for the lines2 test case, changing the initial \" \" to \"a\" prevents the bug from appearing.\n\n### What are the steps to reproduce the behavior?\n\ntest case 1:\n\n```\nlines2=$(printf \" b b b b b b b b\\nc\")\necho \"$lines2\" > lines2.txt\nrg \"(^|[^a-z])((([a-z]+)?)\\s)?b(\\s([a-z]+)?)($|[^a-z])\" --replace=x --multiline lines2.txt\n```\n\ntest case 2:\n\n```\nlines5=$(printf \" b\\nb\\nb\\nb\\nc\")\necho \"$lines5\" > lines5.txt\nrg \"(^|[^a-z])((([a-z]+)?)\\s)?b(\\s([a-z]+)?)($|[^a-z])\" --replace=x --multiline lines5.txt\n```\n\n### What is the actual behavior?\n\nNote: The backtraces for the lines2 test case and the lines5 test case are identical, except for the slice indices mentioned in the panic messages at the top.\n\ncmd:\n\n`RUST_BACKTRACE=1 rg \"(^|[^a-z])((([a-z]+)?)\\s)?b(\\s([a-z]+)?)($|[^a-z])\" --replace=x --multiline --debug lines2.txt`\n\noutput:\n```\nrg: DEBUG|rg::flags::parse|crates/core/flags/parse.rs:97: no extra arguments found from configuration file\nrg: DEBUG|rg::flags::hiargs|crates/core/flags/hiargs.rs:1083: number of paths given to search: 1\nrg: DEBUG|rg::flags::hiargs|crates/core/flags/hiargs.rs:1094: is_one_file? true\nrg: DEBUG|rg::flags::hiargs|crates/core/flags/hiargs.rs:1269: found hostname for hyperlink configuration: i7-5820k\nrg: DEBUG|rg::flags::hiargs|crates/core/flags/hiargs.rs:1279: hyperlink format: \"\"\nrg: DEBUG|rg::flags::hiargs|crates/core/flags/hiargs.rs:174: using 1 thread(s)\nrg: DEBUG|globset|crates/globset/src/lib.rs:453: built glob set; 0 literals, 0 basenames, 12 extensions, 0 prefixes, 0 suffixes, 0 required extensions, 0 regexes\nthread 'main' panicked at /var/tmp/portage/sys-apps/ripgrep-14.1.1-r1/work/ripgrep-14.1.1/crates/printer/src/util.rs:568:22:\nslice index starts at 18 but ends at 17\nstack backtrace:\n   0: rust_begin_unwind\n             at /rustc/f6e511eec7342f59a25f7c0534f1dbea00d01b14/library/std/src/panicking.rs:662:5\n   1: core::panicking::panic_fmt\n             at /rustc/f6e511eec7342f59a25f7c0534f1dbea00d01b14/library/core/src/panicking.rs:74:14\n   2: core::slice::index::slice_index_order_fail_rt\n             at /rustc/f6e511eec7342f59a25f7c0534f1dbea00d01b14/library/core/src/slice/index.rs:85:5\n   3: core::slice::index::slice_index_order_fail\n             at /rustc/f6e511eec7342f59a25f7c0534f1dbea00d01b14/library/core/src/slice/index.rs:78:5\n   4: <core::ops::range::Range<usize> as core::slice::index::SliceIndex<[T]>>::index\n             at /rustc/f6e511eec7342f59a25f7c0534f1dbea00d01b14/library/core/src/slice/index.rs:464:13\n   5: core::slice::index::<impl core::ops::index::Index<I> for [T]>::index\n             at /rustc/f6e511eec7342f59a25f7c0534f1dbea00d01b14/library/core/src/slice/index.rs:16:9\n   6: grep_printer::util::replace_with_captures_in_context\n             at /var/tmp/portage/sys-apps/ripgrep-14.1.1-r1/work/ripgrep-14.1.1/crates/printer/src/util.rs:568:22\n   7: grep_printer::util::Replacer<M>::replace_all\n             at /var/tmp/portage/sys-apps/ripgrep-14.1.1-r1/work/ripgrep-14.1.1/crates/printer/src/util.rs:81:13\n   8: grep_printer::standard::StandardSink<M,W>::replace\n             at /var/tmp/portage/sys-apps/ripgrep-14.1.1-r1/work/ripgrep-14.1.1/crates/printer/src/standard.rs:769:13\n   9: <grep_printer::standard::StandardSink<M,W> as grep_searcher::sink::Sink>::matched\n             at /var/tmp/portage/sys-apps/ripgrep-14.1.1-r1/work/ripgrep-14.1.1/crates/printer/src/standard.rs:835:9\n  10: <&mut S as grep_searcher::sink::Sink>::matched\n             at /var/tmp/portage/sys-apps/ripgrep-14.1.1-r1/work/ripgrep-14.1.1/crates/searcher/src/sink.rs:234:9\n  11: grep_searcher::searcher::core::Core<M,S>::sink_matched\n             at /var/tmp/portage/sys-apps/ripgrep-14.1.1-r1/work/ripgrep-14.1.1/crates/searcher/src/searcher/core.rs:468:25\n  12: grep_searcher::searcher::core::Core<M,S>::matched\n             at /var/tmp/portage/sys-apps/ripgrep-14.1.1-r1/work/ripgrep-14.1.1/crates/searcher/src/searcher/core.rs:94:9\n  13: grep_searcher::searcher::glue::MultiLine<M,S>::sink_matched\n             at /var/tmp/portage/sys-apps/ripgrep-14.1.1-r1/work/ripgrep-14.1.1/crates/searcher/src/searcher/glue.rs:299:19\n  14: grep_searcher::searcher::glue::MultiLine<M,S>::run\n             at /var/tmp/portage/sys-apps/ripgrep-14.1.1-r1/work/ripgrep-14.1.1/crates/searcher/src/searcher/glue.rs:172:38\n  15: grep_searcher::searcher::Searcher::search_slice\n             at /var/tmp/portage/sys-apps/ripgrep-14.1.1-r1/work/ripgrep-14.1.1/crates/searcher/src/searcher/mod.rs:770:13\n  16: grep_searcher::searcher::Searcher::search_file_maybe_path\n             at /var/tmp/portage/sys-apps/ripgrep-14.1.1-r1/work/ripgrep-14.1.1/crates/searcher/src/searcher/mod.rs:671:20\n  17: grep_searcher::searcher::Searcher::search_path\n             at /var/tmp/portage/sys-apps/ripgrep-14.1.1-r1/work/ripgrep-14.1.1/crates/searcher/src/searcher/mod.rs:636:9\n  18: rg::search::search_path\n             at /var/tmp/portage/sys-apps/ripgrep-14.1.1-r1/work/ripgrep-14.1.1/crates/core/search.rs:387:13\n  19: rg::search::SearchWorker<W>::search_path\n             at /var/tmp/portage/sys-apps/ripgrep-14.1.1-r1/work/ripgrep-14.1.1/crates/core/search.rs:345:33\n  20: rg::search::SearchWorker<W>::search\n             at /var/tmp/portage/sys-apps/ripgrep-14.1.1-r1/work/ripgrep-14.1.1/crates/core/search.rs:264:13\n  21: rg::search\n             at /var/tmp/portage/sys-apps/ripgrep-14.1.1-r1/work/ripgrep-14.1.1/crates/core/main.rs:126:35\n  22: rg::run\n             at /var/tmp/portage/sys-apps/ripgrep-14.1.1-r1/work/ripgrep-14.1.1/crates/core/main.rs:87:54\n  23: rg::main\n             at /var/tmp/portage/sys-apps/ripgrep-14.1.1-r1/work/ripgrep-14.1.1/crates/core/main.rs:44:11\n  24: core::ops::function::FnOnce::call_once\n             at /rustc/f6e511eec7342f59a25f7c0534f1dbea00d01b14/library/core/src/ops/function.rs:250:5\n```\n\nslightly-longer backtrace w/ [RUST_BACKTRACE=full](https://gist.github.com/edhalter/bb05fea4784390663ffb88d6aed33bf1)\n\n### What is the expected behavior?\n\nripgrep should have returned matching text","closed_by":{"login":"BurntSushi","id":456674,"node_id":"MDQ6VXNlcjQ1NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/456674?v=4","gravatar_id":"","url":"https://api.github.com/users/BurntSushi","html_url":"https://github.com/BurntSushi","followers_url":"https://api.github.com/users/BurntSushi/followers","following_url":"https://api.github.com/users/BurntSushi/following{/other_user}","gists_url":"https://api.github.com/users/BurntSushi/gists{/gist_id}","starred_url":"https://api.github.com/users/BurntSushi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BurntSushi/subscriptions","organizations_url":"https://api.github.com/users/BurntSushi/orgs","repos_url":"https://api.github.com/users/BurntSushi/repos","events_url":"https://api.github.com/users/BurntSushi/events{/privacy}","received_events_url":"https://api.github.com/users/BurntSushi/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/3180/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/3180/timeline","performed_via_github_app":null,"state_reason":"completed"}