[{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/516658303","html_url":"https://github.com/BurntSushi/ripgrep/issues/1335#issuecomment-516658303","issue_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/1335","id":516658303,"node_id":"MDEyOklzc3VlQ29tbWVudDUxNjY1ODMwMw==","user":{"login":"BurntSushi","id":456674,"node_id":"MDQ6VXNlcjQ1NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/456674?v=4","gravatar_id":"","url":"https://api.github.com/users/BurntSushi","html_url":"https://github.com/BurntSushi","followers_url":"https://api.github.com/users/BurntSushi/followers","following_url":"https://api.github.com/users/BurntSushi/following{/other_user}","gists_url":"https://api.github.com/users/BurntSushi/gists{/gist_id}","starred_url":"https://api.github.com/users/BurntSushi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BurntSushi/subscriptions","organizations_url":"https://api.github.com/users/BurntSushi/orgs","repos_url":"https://api.github.com/users/BurntSushi/repos","events_url":"https://api.github.com/users/BurntSushi/events{/privacy}","received_events_url":"https://api.github.com/users/BurntSushi/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-07-31T01:39:31Z","updated_at":"2019-07-31T01:39:31Z","body":"Unfortunately, there is really nothing I can do unless I can reproduce it. I'd suggest trying to reproduce the performance difference on a corpus that we both have access to.\r\n\r\nI generally find it difficult to read the data you've given to me. I'm not really sure what I'm looking at or the nature of the query or the corpus. For example, how many matches are printed? Do ripgrep and grep print the same output? Do your timings really suggest that multi-threaded ripgrep is slower than single threaded grep? That's pretty crazy to me if true, and suggests something wonky is going on. Is there anything special about your system's configuration?","author_association":"OWNER","reactions":{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/516658303/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"BurntSushi","id":456674,"node_id":"MDQ6VXNlcjQ1NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/456674?v=4","gravatar_id":"","url":"https://api.github.com/users/BurntSushi","html_url":"https://github.com/BurntSushi","followers_url":"https://api.github.com/users/BurntSushi/followers","following_url":"https://api.github.com/users/BurntSushi/following{/other_user}","gists_url":"https://api.github.com/users/BurntSushi/gists{/gist_id}","starred_url":"https://api.github.com/users/BurntSushi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BurntSushi/subscriptions","organizations_url":"https://api.github.com/users/BurntSushi/orgs","repos_url":"https://api.github.com/users/BurntSushi/repos","events_url":"https://api.github.com/users/BurntSushi/events{/privacy}","received_events_url":"https://api.github.com/users/BurntSushi/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":2521712644,"node_id":"MDEyOkxhYmVsZWRFdmVudDI1MjE3MTI2NDQ=","url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/events/2521712644","actor":{"login":"BurntSushi","id":456674,"node_id":"MDQ6VXNlcjQ1NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/456674?v=4","gravatar_id":"","url":"https://api.github.com/users/BurntSushi","html_url":"https://github.com/BurntSushi","followers_url":"https://api.github.com/users/BurntSushi/followers","following_url":"https://api.github.com/users/BurntSushi/following{/other_user}","gists_url":"https://api.github.com/users/BurntSushi/gists{/gist_id}","starred_url":"https://api.github.com/users/BurntSushi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BurntSushi/subscriptions","organizations_url":"https://api.github.com/users/BurntSushi/orgs","repos_url":"https://api.github.com/users/BurntSushi/repos","events_url":"https://api.github.com/users/BurntSushi/events{/privacy}","received_events_url":"https://api.github.com/users/BurntSushi/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2019-07-31T01:39:48Z","label":{"name":"question","color":"cc317c"},"performed_via_github_app":null},{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/516658483","html_url":"https://github.com/BurntSushi/ripgrep/issues/1335#issuecomment-516658483","issue_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/1335","id":516658483,"node_id":"MDEyOklzc3VlQ29tbWVudDUxNjY1ODQ4Mw==","user":{"login":"BurntSushi","id":456674,"node_id":"MDQ6VXNlcjQ1NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/456674?v=4","gravatar_id":"","url":"https://api.github.com/users/BurntSushi","html_url":"https://github.com/BurntSushi","followers_url":"https://api.github.com/users/BurntSushi/followers","following_url":"https://api.github.com/users/BurntSushi/following{/other_user}","gists_url":"https://api.github.com/users/BurntSushi/gists{/gist_id}","starred_url":"https://api.github.com/users/BurntSushi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BurntSushi/subscriptions","organizations_url":"https://api.github.com/users/BurntSushi/orgs","repos_url":"https://api.github.com/users/BurntSushi/repos","events_url":"https://api.github.com/users/BurntSushi/events{/privacy}","received_events_url":"https://api.github.com/users/BurntSushi/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-07-31T01:40:29Z","updated_at":"2019-07-31T01:40:29Z","body":"I also find it interesting that you don't have AVX enabled in your CPU. To me, that suggests your CPU is quite old. What kind of CPU is it and how many cores does it have?","author_association":"OWNER","reactions":{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/516658483/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"BurntSushi","id":456674,"node_id":"MDQ6VXNlcjQ1NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/456674?v=4","gravatar_id":"","url":"https://api.github.com/users/BurntSushi","html_url":"https://github.com/BurntSushi","followers_url":"https://api.github.com/users/BurntSushi/followers","following_url":"https://api.github.com/users/BurntSushi/following{/other_user}","gists_url":"https://api.github.com/users/BurntSushi/gists{/gist_id}","starred_url":"https://api.github.com/users/BurntSushi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BurntSushi/subscriptions","organizations_url":"https://api.github.com/users/BurntSushi/orgs","repos_url":"https://api.github.com/users/BurntSushi/repos","events_url":"https://api.github.com/users/BurntSushi/events{/privacy}","received_events_url":"https://api.github.com/users/BurntSushi/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/516735729","html_url":"https://github.com/BurntSushi/ripgrep/issues/1335#issuecomment-516735729","issue_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/1335","id":516735729,"node_id":"MDEyOklzc3VlQ29tbWVudDUxNjczNTcyOQ==","user":{"login":"zsugabubus","id":30056345,"node_id":"MDQ6VXNlcjMwMDU2MzQ1","avatar_url":"https://avatars.githubusercontent.com/u/30056345?v=4","gravatar_id":"","url":"https://api.github.com/users/zsugabubus","html_url":"https://github.com/zsugabubus","followers_url":"https://api.github.com/users/zsugabubus/followers","following_url":"https://api.github.com/users/zsugabubus/following{/other_user}","gists_url":"https://api.github.com/users/zsugabubus/gists{/gist_id}","starred_url":"https://api.github.com/users/zsugabubus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zsugabubus/subscriptions","organizations_url":"https://api.github.com/users/zsugabubus/orgs","repos_url":"https://api.github.com/users/zsugabubus/repos","events_url":"https://api.github.com/users/zsugabubus/events{/privacy}","received_events_url":"https://api.github.com/users/zsugabubus/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-07-31T07:40:40Z","updated_at":"2019-07-31T07:41:41Z","body":"> I generally find it difficult to read the data you've given to me.\r\n\r\nSorry, I tried to make it readable. So that's a directory listing. To find out what causes the slowdown:\r\n* Printed some statistics about individual files (`size`, `files`),\r\n* I ran rg/grep on every entry (`{rg,grep}time`),\r\n* I ran rg/grep on every file in the directory, but excluding the current entry (`{rg,grep}wothistime`)\r\n    For example, if you have `a, b, c` files in your directory, you will see the result of `time rg a c` at row `./b` and column `rgwothistime`.\r\n\r\n1) This two (`rg b` + `rg a c`) should be \"equal\" with the running time of rg/grep on the whole directory (`rg .` -> lists the directories internally, instead of getting filenames from arguments).\r\n2) Sum of  rg/grep times on individual files (`{rg,grep}time`) also should be \"equal\"/comparable with rg/grep times on the whole directory. `rg a` + `rg b` + `rg c` =?= `rg .`\r\n\r\nI hope it helps a bit.\r\n\r\n> For example, how many matches are printed? Do ripgrep and grep print the same output?\r\n\r\nYes, sorry, both prints two matches.\r\n\r\n> Do your timings really suggest that multi-threaded ripgrep is slower than single threaded grep?\r\n\r\nYes, for example with `-j2` it wasn't ~1 second but 6.\r\n\r\n> Is there anything special about your system's configuration?\r\n\r\nI wouldn't say. I'm just working on tmpfs, but it just should make things faster.\r\n\r\n> What kind of CPU is it and how many cores does it have?\r\n\r\n[Intel(R) Core(TM) i5-2410M CPU @ 2.30GHz](https://ark.intel.com/content/www/us/en/ark/products/52224/intel-core-i5-2410m-processor-3m-cache-up-to-2-90-ghz.html)\r\n\r\n> I'd suggest trying to reproduce the performance difference on a corpus that we both have access to.\r\n\r\nTried on linux codebase now, but no luck. \r\n\r\n> Unfortunately, there is really nothing I can do unless I can reproduce it.\r\n\r\nYeah, I know. Later in the day I can run profiler tools on rg.","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/516735729/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"zsugabubus","id":30056345,"node_id":"MDQ6VXNlcjMwMDU2MzQ1","avatar_url":"https://avatars.githubusercontent.com/u/30056345?v=4","gravatar_id":"","url":"https://api.github.com/users/zsugabubus","html_url":"https://github.com/zsugabubus","followers_url":"https://api.github.com/users/zsugabubus/followers","following_url":"https://api.github.com/users/zsugabubus/following{/other_user}","gists_url":"https://api.github.com/users/zsugabubus/gists{/gist_id}","starred_url":"https://api.github.com/users/zsugabubus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zsugabubus/subscriptions","organizations_url":"https://api.github.com/users/zsugabubus/orgs","repos_url":"https://api.github.com/users/zsugabubus/repos","events_url":"https://api.github.com/users/zsugabubus/events{/privacy}","received_events_url":"https://api.github.com/users/zsugabubus/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/516824062","html_url":"https://github.com/BurntSushi/ripgrep/issues/1335#issuecomment-516824062","issue_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/1335","id":516824062,"node_id":"MDEyOklzc3VlQ29tbWVudDUxNjgyNDA2Mg==","user":{"login":"zsugabubus","id":30056345,"node_id":"MDQ6VXNlcjMwMDU2MzQ1","avatar_url":"https://avatars.githubusercontent.com/u/30056345?v=4","gravatar_id":"","url":"https://api.github.com/users/zsugabubus","html_url":"https://github.com/zsugabubus","followers_url":"https://api.github.com/users/zsugabubus/followers","following_url":"https://api.github.com/users/zsugabubus/following{/other_user}","gists_url":"https://api.github.com/users/zsugabubus/gists{/gist_id}","starred_url":"https://api.github.com/users/zsugabubus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zsugabubus/subscriptions","organizations_url":"https://api.github.com/users/zsugabubus/orgs","repos_url":"https://api.github.com/users/zsugabubus/repos","events_url":"https://api.github.com/users/zsugabubus/events{/privacy}","received_events_url":"https://api.github.com/users/zsugabubus/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-07-31T12:18:48Z","updated_at":"2019-07-31T12:18:48Z","body":"I tried obfuscating the files but timings became distorted in a great extent. Instead, I quickly made a little syscall statistics.\r\n\r\n##### grep\r\n```\r\n$ time grep -o file\\\\.php -r . | wc -l\r\n2\r\ngrep --color=auto -o file\\\\.php -r .  0.18s user 0.10s system 98% cpu 0.290 total\r\nwc -l  0.00s user 0.00s system 0% cpu 0.288 total\r\n\r\n$ time strace -fc grep -o file\\\\.php -r . | wc -l\r\n2\r\n% time     seconds  usecs/call     calls    errors syscall\r\n------ ----------- ----------- --------- --------- ----------------\r\n 27.47    0.132252           5     23744           read\r\n 19.48    0.093756           6     14792         7 openat\r\n 17.93    0.086329           4     17569           close\r\n 13.95    0.067153           4     14787           fstat\r\n  7.82    0.037661           4      8346           fcntl\r\n  6.71    0.032310           5      5562           newfstatat\r\n  6.47    0.031156           5      5564           getdents64\r\n  0.11    0.000534          66         8           munmap\r\n  0.02    0.000095           6        14           lseek\r\n  0.02    0.000093           3        26           mmap\r\n  0.00    0.000022          22         1           write\r\n  0.00    0.000000           0         2           stat\r\n  0.00    0.000000           0         6           mprotect\r\n  0.00    0.000000           0         6           brk\r\n  0.00    0.000000           0         3           rt_sigaction\r\n  0.00    0.000000           0         1           rt_sigprocmask\r\n  0.00    0.000000           0         1           access\r\n  0.00    0.000000           0         1           execve\r\n  0.00    0.000000           0         1           sigaltstack\r\n  0.00    0.000000           0         1           fstatfs\r\n  0.00    0.000000           0         2         1 arch_prctl\r\n  0.00    0.000000           0         1           futex\r\n  0.00    0.000000           0         1           set_tid_address\r\n  0.00    0.000000           0         1           set_robust_list\r\n  0.00    0.000000           0         1           prlimit64\r\n------ ----------- ----------- --------- --------- ----------------\r\n100.00    0.481361                 90441         8 total\r\nstrace -fc grep -o file\\\\.php -r .  0.78s user 2.47s system 119% cpu 2.722 total\r\nwc -l  0.00s user 0.00s system 0% cpu 2.709 total\r\n\r\n```\r\n\r\n##### ripgrep\r\n```\r\n$ time rg -o file\\\\.php | wc -l\r\n2\r\nrg -o file\\\\.php  3.93s user 0.44s system 379% cpu 1.153 total\r\nwc -l  0.00s user 0.00s system 0% cpu 1.153 total\r\n\r\n$ time strace -cf rg -o file\\\\.php | wc -l\r\nstrace: Process 31403 attached\r\nstrace: Process 31404 attached\r\nstrace: Process 31405 attached\r\nstrace: Process 31406 attached\r\n2\r\n% time     seconds  usecs/call     calls    errors syscall\r\n------ ----------- ----------- --------- --------- ----------------\r\n 38.56    0.960239        1574       610       149 futex\r\n 25.61    0.637726          17     35550           read\r\n 19.73    0.491392          19     25185     11059 openat\r\n  7.87    0.196092          13     14126           close\r\n  3.61    0.089929          16      5548           getdents64\r\n  1.81    0.045032          16      2785           fstat\r\n  1.80    0.044863          15      2805      2787 stat\r\n  0.42    0.010535          22       460           mprotect\r\n  0.26    0.006442         429        15           munmap\r\n  0.20    0.005027         418        12           mremap\r\n  0.05    0.001256         125        10           nanosleep\r\n  0.05    0.001123          23        48           mmap\r\n  0.01    0.000222          20        11           brk\r\n  0.01    0.000158          39         4           madvise\r\n  0.00    0.000065          13         5           getrandom\r\n  0.00    0.000045           3        15           sigaltstack\r\n  0.00    0.000033          16         2           write\r\n  0.00    0.000000           0         8           lseek\r\n  0.00    0.000000           0         5           rt_sigaction\r\n  0.00    0.000000           0         1           rt_sigprocmask\r\n  0.00    0.000000           0        13        12 ioctl\r\n  0.00    0.000000           0         1           access\r\n  0.00    0.000000           0         4           clone\r\n  0.00    0.000000           0         1           execve\r\n  0.00    0.000000           0         1           fcntl\r\n  0.00    0.000000           0         7           getcwd\r\n  0.00    0.000000           0         2         1 arch_prctl\r\n  0.00    0.000000           0        13           sched_getaffinity\r\n  0.00    0.000000           0         1           set_tid_address\r\n  0.00    0.000000           0         5           set_robust_list\r\n  0.00    0.000000           0         2           prlimit64\r\n------ ----------- ----------- --------- --------- ----------------\r\n100.00    2.490179                 87255     14008 total\r\nstrace -cf rg -o file\\\\.php  3.65s user 2.05s system 249% cpu 2.286 total\r\nwc -l  0.00s user 0.00s system 0% cpu 2.285 total\r\n","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/516824062/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"zsugabubus","id":30056345,"node_id":"MDQ6VXNlcjMwMDU2MzQ1","avatar_url":"https://avatars.githubusercontent.com/u/30056345?v=4","gravatar_id":"","url":"https://api.github.com/users/zsugabubus","html_url":"https://github.com/zsugabubus","followers_url":"https://api.github.com/users/zsugabubus/followers","following_url":"https://api.github.com/users/zsugabubus/following{/other_user}","gists_url":"https://api.github.com/users/zsugabubus/gists{/gist_id}","starred_url":"https://api.github.com/users/zsugabubus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zsugabubus/subscriptions","organizations_url":"https://api.github.com/users/zsugabubus/orgs","repos_url":"https://api.github.com/users/zsugabubus/repos","events_url":"https://api.github.com/users/zsugabubus/events{/privacy}","received_events_url":"https://api.github.com/users/zsugabubus/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/516853086","html_url":"https://github.com/BurntSushi/ripgrep/issues/1335#issuecomment-516853086","issue_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/1335","id":516853086,"node_id":"MDEyOklzc3VlQ29tbWVudDUxNjg1MzA4Ng==","user":{"login":"BurntSushi","id":456674,"node_id":"MDQ6VXNlcjQ1NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/456674?v=4","gravatar_id":"","url":"https://api.github.com/users/BurntSushi","html_url":"https://github.com/BurntSushi","followers_url":"https://api.github.com/users/BurntSushi/followers","following_url":"https://api.github.com/users/BurntSushi/following{/other_user}","gists_url":"https://api.github.com/users/BurntSushi/gists{/gist_id}","starred_url":"https://api.github.com/users/BurntSushi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BurntSushi/subscriptions","organizations_url":"https://api.github.com/users/BurntSushi/orgs","repos_url":"https://api.github.com/users/BurntSushi/repos","events_url":"https://api.github.com/users/BurntSushi/events{/privacy}","received_events_url":"https://api.github.com/users/BurntSushi/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-07-31T13:39:09Z","updated_at":"2019-07-31T13:39:09Z","body":"The syscall frequency table is quite interesting. ripgrep not only appears to be opening more files than grep, but it's also getting errors for a lot of them. A few more thoughts:\r\n\r\n* Are you _sure_ there isn't anything weird about your system?\r\n* Does your directory hierarchy contain a lot of `.ignore` or `.gitignore` files?\r\n* How many total directories are in your tree?\r\n* Can you try running ripgrep with `rg -uuu` and `rg -uuu -j1`? (And show the syscall frequency table for each, as well as timings.) Effectively, `rg -uuu -j1` should do roughly the same work that `grep -r` does, since the `-uuu` disables automatic filtering (ignore files, hidden files, binary files), while the `-j1` flag forces single threaded search, just like `grep`. So it's the closest \"apples to apples\" comparison you can get.\r\n* Sanity check: do you have a ripgrep config file enabled that is setting additional flags?\r\n* Can you run ripgrep with the `--debug` flag and look at the output for anything unusal? You won't be able to share this directly since it will contain file names. Running with `--trace` might also be good, but it will contain a lot more output.\r\n\r\nThe `time` output you've shared is also interesting, in that most of the additional time is spent in `user`, not `sys`, so the syscall frequency table may wind up being a red herring.\r\n\r\nIs it possible for you to narrow down the corpus? For example, if you run ripgrep (and grep) on the each top-level directory in your tree, do they all have similar timings? Hopefully, one of those directories will take much longer to search with ripgrep than grep, which should then let you repeat the process recursively.\r\n\r\nI think it would be nice if ripgrep grew a flag that allowed it to print the total search time for each individual file. You can _almost_ get it with the `--json` output, but it will only show elapsed search times for files that contain matches. You can get it show elapsed time for _every_ file it searches by setting [`always_begin_end` to `true`](https://github.com/BurntSushi/ripgrep/blob/bc37c32717301abf26e5aecc942688d2ddd63692/src/args.rs#L749). If you do make that change, then this should output a table how much time it takes to search each file. If a particular file (or small number of files) stand out as taking a long time to search, then that will perhaps narrow things down. But this does require making aforementioned change to ripgrep and re-compiling:\r\n\r\n```\r\n$ rg 'fn is_' src/ --json | rg '\"type\":\"end\"' | jq -j -r '.data.path.text, \" \", .data.stats.elapsed.human, \"\\n\"'\r\nsrc/subject.rs 0.000024s\r\nsrc/args.rs 0.000058s\r\n```","author_association":"OWNER","reactions":{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/516853086/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"BurntSushi","id":456674,"node_id":"MDQ6VXNlcjQ1NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/456674?v=4","gravatar_id":"","url":"https://api.github.com/users/BurntSushi","html_url":"https://github.com/BurntSushi","followers_url":"https://api.github.com/users/BurntSushi/followers","following_url":"https://api.github.com/users/BurntSushi/following{/other_user}","gists_url":"https://api.github.com/users/BurntSushi/gists{/gist_id}","starred_url":"https://api.github.com/users/BurntSushi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BurntSushi/subscriptions","organizations_url":"https://api.github.com/users/BurntSushi/orgs","repos_url":"https://api.github.com/users/BurntSushi/repos","events_url":"https://api.github.com/users/BurntSushi/events{/privacy}","received_events_url":"https://api.github.com/users/BurntSushi/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/516902295","html_url":"https://github.com/BurntSushi/ripgrep/issues/1335#issuecomment-516902295","issue_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/1335","id":516902295,"node_id":"MDEyOklzc3VlQ29tbWVudDUxNjkwMjI5NQ==","user":{"login":"zsugabubus","id":30056345,"node_id":"MDQ6VXNlcjMwMDU2MzQ1","avatar_url":"https://avatars.githubusercontent.com/u/30056345?v=4","gravatar_id":"","url":"https://api.github.com/users/zsugabubus","html_url":"https://github.com/zsugabubus","followers_url":"https://api.github.com/users/zsugabubus/followers","following_url":"https://api.github.com/users/zsugabubus/following{/other_user}","gists_url":"https://api.github.com/users/zsugabubus/gists{/gist_id}","starred_url":"https://api.github.com/users/zsugabubus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zsugabubus/subscriptions","organizations_url":"https://api.github.com/users/zsugabubus/orgs","repos_url":"https://api.github.com/users/zsugabubus/repos","events_url":"https://api.github.com/users/zsugabubus/events{/privacy}","received_events_url":"https://api.github.com/users/zsugabubus/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-07-31T15:35:17Z","updated_at":"2019-07-31T17:07:15Z","body":"> The syscall frequency table is quite interesting. ripgrep not only appears to be opening more files than grep, but it's also getting errors for a lot of them.\r\n\r\nMy naïve first thought about it was that (before I got the statistics) maybe ripgrep always chooses next paths to explore in a very unfortunate way. I know nothing about internal working of ripgrep, but an unbalanced directory structure can cause it, can it be possible?\r\n\r\n> Are you sure there isn't anything weird about your system?\r\n\r\nAt first I ran it in a custom `systemd-nspawn(1)` container, where I first experienced the issue, but then I run several tests on my real machine too and got the _exact same results_. I can only think `tmpfs` that could be a little bit \"weird\".\r\n\r\n> Does your directory hierarchy contain a lot of .ignore or .gitignore files?\r\n\r\n```\r\n$ find -name '.*ignore' -print0 | wc -l --files0-from=/dev/stdin | tail -1\r\n328 total\r\n```\r\n\r\nThese files contain mostly things that don't exist, so `--no-ignore` gives 60-80ms speedup, but sometimes not even that much. In my initial comment I put `--no-ignore` in parenthesis, because it meant only marginal difference.\r\n\r\n> How many total directories are in your tree?\r\n\r\n```\r\n$ find -type d | wc -l\r\n2473\r\n```\r\n\r\n> Sanity check: do you have a ripgrep config file enabled that is setting additional flags?\r\n\r\nNo.\r\n\r\n> Can you try running ripgrep with rg -uuu and rg -uuu -j1?\r\n\r\n```\r\n$ time rg -uuu -o file\\\\.php | wc -l\r\n2\r\nrg -uuu -o file\\\\.php  7.00s user 0.50s system 350% cpu 2.140 total\r\nwc -l  0.00s user 0.00s system 0% cpu 2.140 total\r\n```\r\n[`strace -CrTfo ../strace -s0 rg -uuu -o file\\\\.php | wc -l && sed -i '100,$s/\".\\+\"/\"string\"/' ../strace`](https://gist.github.com/zsugabubus/562714382920713c9ebea08a6813cf1e/raw/d0a5524c0a0d12e60297c365e771d1b12338ffdf/rg.strace)\r\n\r\n```\r\n$ time rg -uuu -j1 -o file\\\\.php | wc -l\r\n2\r\nrg -uuu -j1 -o file\\\\.php  6.26s user 0.18s system 99% cpu 6.485 total\r\nwc -l  0.00s user 0.00s system 0% cpu 6.484 total\r\n```\r\n\r\n[`strace -CrTfo ../strace -s0 rg -uuu -j1 -o file\\\\.php | wc -l && sed -i '100,$s/\".\\+\"/\"string\"/' ../strace`](https://gist.github.com/zsugabubus/c20d1d23bdb801e427b5ee67eb8a4dac/raw/b8bbf0f5a94a72ef0252f228782770c79a5b7b61/rg-j1.strace)\r\n\r\n> Can you run ripgrep with the --debug flag\r\n\r\nRan with `--debug --trace`:\r\n```\r\ng/searching using generic reader/d\r\ng/will use fast line searcher/d\r\ng/ignoring/d\r\ng/searching via roll buffer strategy/d\r\ng/glob converted to regex/d\r\ng/built glob set/d\r\n\r\nDEBUG|grep_regex::literal|grep-regex/src/literal.rs:59: literal prefixes detected: Literals { lits: [Complete(file.php)], limit_size: 250, limit_class: 10 }\r\nTRACE|grep_regex::matcher|grep-regex/src/matcher.rs:56: final regex: \"file\\\\.php\"\r\n```\r\n\r\n> Is it possible for you to narrow down the corpus? For example, if you run ripgrep (and grep) on the each top-level directory in your tree, do they all have similar timings? Hopefully, one of those directories will take much longer to search with ripgrep than grep, which should then let you repeat the process recursively.\r\n\r\nThis is what I did and would like to illustrate with my table above. ripgrepping the top level directory takes 964ms, but total search time of individual children files and directories is not more than ~300ms. Take the 4th entry for example. It takes 217ms, but if I try to ripgrep its children one-by-one, then their total search time will be (more) less. So there is no one big file.\r\n\r\nThere are no binary files, just text files with very looong lines (7.5 millon characters).\r\n\r\n> setting always_begin_end to true\r\n\r\nHmm. I got _very very weird_ [results](https://gist.github.com/zsugabubus/79f82a623d2d1804c96814875dfe7b87).","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/516902295/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"zsugabubus","id":30056345,"node_id":"MDQ6VXNlcjMwMDU2MzQ1","avatar_url":"https://avatars.githubusercontent.com/u/30056345?v=4","gravatar_id":"","url":"https://api.github.com/users/zsugabubus","html_url":"https://github.com/zsugabubus","followers_url":"https://api.github.com/users/zsugabubus/followers","following_url":"https://api.github.com/users/zsugabubus/following{/other_user}","gists_url":"https://api.github.com/users/zsugabubus/gists{/gist_id}","starred_url":"https://api.github.com/users/zsugabubus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zsugabubus/subscriptions","organizations_url":"https://api.github.com/users/zsugabubus/orgs","repos_url":"https://api.github.com/users/zsugabubus/repos","events_url":"https://api.github.com/users/zsugabubus/events{/privacy}","received_events_url":"https://api.github.com/users/zsugabubus/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/516920049","html_url":"https://github.com/BurntSushi/ripgrep/issues/1335#issuecomment-516920049","issue_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/1335","id":516920049,"node_id":"MDEyOklzc3VlQ29tbWVudDUxNjkyMDA0OQ==","user":{"login":"BurntSushi","id":456674,"node_id":"MDQ6VXNlcjQ1NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/456674?v=4","gravatar_id":"","url":"https://api.github.com/users/BurntSushi","html_url":"https://github.com/BurntSushi","followers_url":"https://api.github.com/users/BurntSushi/followers","following_url":"https://api.github.com/users/BurntSushi/following{/other_user}","gists_url":"https://api.github.com/users/BurntSushi/gists{/gist_id}","starred_url":"https://api.github.com/users/BurntSushi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BurntSushi/subscriptions","organizations_url":"https://api.github.com/users/BurntSushi/orgs","repos_url":"https://api.github.com/users/BurntSushi/repos","events_url":"https://api.github.com/users/BurntSushi/events{/privacy}","received_events_url":"https://api.github.com/users/BurntSushi/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-07-31T16:19:52Z","updated_at":"2019-07-31T16:19:52Z","body":"> This is what I did and would like to illustrate with my table above. ripgrepping the top level directory takes 964ms, but total search time of individual children files and directories is not more than ~300ms.\r\n\r\nI mean, _compared_ to grep. Your second entry has `real 0m0.919s` for ripgrep, but `real 0m0.009s` for grep. But as I said before, the table is hard to understand because it's not totally clear how it was produced. (The command you've shown is quite complex.)\r\n\r\n> There are no binary files, just text files with very looong lines (7.5 millon).\r\n\r\nHow long are the lines? And do you mean to say there are 7.5 million _files_? Quite frankly, I'm pretty surprised that grep is searching that entire directory in under a second (if I am to understand your timings correctly). For example, on my checkout of the entire Chromium repository, `grep -r Openbox` takes about 7.3 seconds to complete, and there are only ~230,000 files. In contrast, ripgrep takes 1.7 seconds when multi-threaded and 7.9 seconds single threaded (which is actually an interesting slowdown compared to grep here which I'll also investigate, but not nearly as much as yours).\r\n\r\nSo maybe the other idea I have is whether grep is actually searching all of your data or not. Could you compare `rg -uuua` with `grep -ra`? Another thing to try is `rg -uuu . ./ > output.rg` vs `grep -r . ./ > output.grep`, and then compare the output. Are they roughly similar size?","author_association":"OWNER","reactions":{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/516920049/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"BurntSushi","id":456674,"node_id":"MDQ6VXNlcjQ1NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/456674?v=4","gravatar_id":"","url":"https://api.github.com/users/BurntSushi","html_url":"https://github.com/BurntSushi","followers_url":"https://api.github.com/users/BurntSushi/followers","following_url":"https://api.github.com/users/BurntSushi/following{/other_user}","gists_url":"https://api.github.com/users/BurntSushi/gists{/gist_id}","starred_url":"https://api.github.com/users/BurntSushi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BurntSushi/subscriptions","organizations_url":"https://api.github.com/users/BurntSushi/orgs","repos_url":"https://api.github.com/users/BurntSushi/repos","events_url":"https://api.github.com/users/BurntSushi/events{/privacy}","received_events_url":"https://api.github.com/users/BurntSushi/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/516926273","html_url":"https://github.com/BurntSushi/ripgrep/issues/1335#issuecomment-516926273","issue_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/1335","id":516926273,"node_id":"MDEyOklzc3VlQ29tbWVudDUxNjkyNjI3Mw==","user":{"login":"zsugabubus","id":30056345,"node_id":"MDQ6VXNlcjMwMDU2MzQ1","avatar_url":"https://avatars.githubusercontent.com/u/30056345?v=4","gravatar_id":"","url":"https://api.github.com/users/zsugabubus","html_url":"https://github.com/zsugabubus","followers_url":"https://api.github.com/users/zsugabubus/followers","following_url":"https://api.github.com/users/zsugabubus/following{/other_user}","gists_url":"https://api.github.com/users/zsugabubus/gists{/gist_id}","starred_url":"https://api.github.com/users/zsugabubus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zsugabubus/subscriptions","organizations_url":"https://api.github.com/users/zsugabubus/orgs","repos_url":"https://api.github.com/users/zsugabubus/repos","events_url":"https://api.github.com/users/zsugabubus/events{/privacy}","received_events_url":"https://api.github.com/users/zsugabubus/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-07-31T16:37:25Z","updated_at":"2019-07-31T16:37:35Z","body":"> 7.5 million files\r\n\r\nI meant 7.5 million character long lines.","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/516926273/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"zsugabubus","id":30056345,"node_id":"MDQ6VXNlcjMwMDU2MzQ1","avatar_url":"https://avatars.githubusercontent.com/u/30056345?v=4","gravatar_id":"","url":"https://api.github.com/users/zsugabubus","html_url":"https://github.com/zsugabubus","followers_url":"https://api.github.com/users/zsugabubus/followers","following_url":"https://api.github.com/users/zsugabubus/following{/other_user}","gists_url":"https://api.github.com/users/zsugabubus/gists{/gist_id}","starred_url":"https://api.github.com/users/zsugabubus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zsugabubus/subscriptions","organizations_url":"https://api.github.com/users/zsugabubus/orgs","repos_url":"https://api.github.com/users/zsugabubus/repos","events_url":"https://api.github.com/users/zsugabubus/events{/privacy}","received_events_url":"https://api.github.com/users/zsugabubus/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/516931306","html_url":"https://github.com/BurntSushi/ripgrep/issues/1335#issuecomment-516931306","issue_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/1335","id":516931306,"node_id":"MDEyOklzc3VlQ29tbWVudDUxNjkzMTMwNg==","user":{"login":"zsugabubus","id":30056345,"node_id":"MDQ6VXNlcjMwMDU2MzQ1","avatar_url":"https://avatars.githubusercontent.com/u/30056345?v=4","gravatar_id":"","url":"https://api.github.com/users/zsugabubus","html_url":"https://github.com/zsugabubus","followers_url":"https://api.github.com/users/zsugabubus/followers","following_url":"https://api.github.com/users/zsugabubus/following{/other_user}","gists_url":"https://api.github.com/users/zsugabubus/gists{/gist_id}","starred_url":"https://api.github.com/users/zsugabubus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zsugabubus/subscriptions","organizations_url":"https://api.github.com/users/zsugabubus/orgs","repos_url":"https://api.github.com/users/zsugabubus/repos","events_url":"https://api.github.com/users/zsugabubus/events{/privacy}","received_events_url":"https://api.github.com/users/zsugabubus/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-07-31T16:52:09Z","updated_at":"2019-07-31T17:13:27Z","body":"###### Break the command along ':'s and you will see how values were computed.\r\n\r\n> Your second entry has real 0m0.919s for ripgrep, but real 0m0.009s for grep.\r\n\r\nI guess 0.919s is at `rgwothistime` and 0.009s is at `rgtime` columns. Both times are for ripgrep. For matching grep times scroll right.\r\n\r\n* `rgtime` means: simply `time rg ./xx`. It took only 0.009s because it was a small directory.\r\n* `rg w/o this time` means: `time rg {every other ./file you see there except ./xx}`.\r\n\r\nI know `w/o this` columns seem bullshit, but it just a sanity check. One column shows times for `rg ./xx` and the column next to it shows times for `rg {every other ./file you see there except ./xx}`. If we add up this two, we should get time for `rg ./xx   +  {every other ./file except ./xx}` == `rg {every children of .}` == `rg .`.\r\n\r\n","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/516931306/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"zsugabubus","id":30056345,"node_id":"MDQ6VXNlcjMwMDU2MzQ1","avatar_url":"https://avatars.githubusercontent.com/u/30056345?v=4","gravatar_id":"","url":"https://api.github.com/users/zsugabubus","html_url":"https://github.com/zsugabubus","followers_url":"https://api.github.com/users/zsugabubus/followers","following_url":"https://api.github.com/users/zsugabubus/following{/other_user}","gists_url":"https://api.github.com/users/zsugabubus/gists{/gist_id}","starred_url":"https://api.github.com/users/zsugabubus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zsugabubus/subscriptions","organizations_url":"https://api.github.com/users/zsugabubus/orgs","repos_url":"https://api.github.com/users/zsugabubus/repos","events_url":"https://api.github.com/users/zsugabubus/events{/privacy}","received_events_url":"https://api.github.com/users/zsugabubus/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/516941856","html_url":"https://github.com/BurntSushi/ripgrep/issues/1335#issuecomment-516941856","issue_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/1335","id":516941856,"node_id":"MDEyOklzc3VlQ29tbWVudDUxNjk0MTg1Ng==","user":{"login":"zsugabubus","id":30056345,"node_id":"MDQ6VXNlcjMwMDU2MzQ1","avatar_url":"https://avatars.githubusercontent.com/u/30056345?v=4","gravatar_id":"","url":"https://api.github.com/users/zsugabubus","html_url":"https://github.com/zsugabubus","followers_url":"https://api.github.com/users/zsugabubus/followers","following_url":"https://api.github.com/users/zsugabubus/following{/other_user}","gists_url":"https://api.github.com/users/zsugabubus/gists{/gist_id}","starred_url":"https://api.github.com/users/zsugabubus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zsugabubus/subscriptions","organizations_url":"https://api.github.com/users/zsugabubus/orgs","repos_url":"https://api.github.com/users/zsugabubus/repos","events_url":"https://api.github.com/users/zsugabubus/events{/privacy}","received_events_url":"https://api.github.com/users/zsugabubus/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-07-31T17:20:37Z","updated_at":"2019-07-31T17:22:31Z","body":"##### `rg -uuua` vs `grep -ra`\r\n\r\n```\r\nrg -uuua file\\\\.php               6.97s user 0.43s system 383% cpu 1.928 total\r\ngrep --color=auto -ra file\\\\.php  0.15s user 0.11s system  98% cpu 0.265 total\r\n```\r\n\r\n`rg -aj4` is around 1.3.\r\n\r\n##### `rg -uuu . ./` vs `grep -r . ./`\r\n\r\n```\r\nrg -uuu . ./              > /tmp/out.rg    4.84s user 0.68s system 346% cpu 1.594 total\r\ngrep --color=auto -r . ./ > /tmp/out.grep  0.37s user 0.20s system  96% cpu 0.591 total\r\n```\r\n\r\nSizes: 173M±0.6M.","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/516941856/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"zsugabubus","id":30056345,"node_id":"MDQ6VXNlcjMwMDU2MzQ1","avatar_url":"https://avatars.githubusercontent.com/u/30056345?v=4","gravatar_id":"","url":"https://api.github.com/users/zsugabubus","html_url":"https://github.com/zsugabubus","followers_url":"https://api.github.com/users/zsugabubus/followers","following_url":"https://api.github.com/users/zsugabubus/following{/other_user}","gists_url":"https://api.github.com/users/zsugabubus/gists{/gist_id}","starred_url":"https://api.github.com/users/zsugabubus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zsugabubus/subscriptions","organizations_url":"https://api.github.com/users/zsugabubus/orgs","repos_url":"https://api.github.com/users/zsugabubus/repos","events_url":"https://api.github.com/users/zsugabubus/events{/privacy}","received_events_url":"https://api.github.com/users/zsugabubus/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/516950832","html_url":"https://github.com/BurntSushi/ripgrep/issues/1335#issuecomment-516950832","issue_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/1335","id":516950832,"node_id":"MDEyOklzc3VlQ29tbWVudDUxNjk1MDgzMg==","user":{"login":"BurntSushi","id":456674,"node_id":"MDQ6VXNlcjQ1NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/456674?v=4","gravatar_id":"","url":"https://api.github.com/users/BurntSushi","html_url":"https://github.com/BurntSushi","followers_url":"https://api.github.com/users/BurntSushi/followers","following_url":"https://api.github.com/users/BurntSushi/following{/other_user}","gists_url":"https://api.github.com/users/BurntSushi/gists{/gist_id}","starred_url":"https://api.github.com/users/BurntSushi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BurntSushi/subscriptions","organizations_url":"https://api.github.com/users/BurntSushi/orgs","repos_url":"https://api.github.com/users/BurntSushi/repos","events_url":"https://api.github.com/users/BurntSushi/events{/privacy}","received_events_url":"https://api.github.com/users/BurntSushi/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-07-31T17:45:15Z","updated_at":"2019-07-31T17:45:15Z","body":"My next step here would be to keep comparing directories. In your table, there are lots of directories that have ripgrep being much slower than grep. I would just keep digging into those directories recursively until you widdle the corpus down. It might also be interesting to try your search in a way where both tools exclude files with very long lines, if that's possible.\r\n\r\nMy guess is that the 7.5 million character lines has something to do with this. That is extremely unusual for a plain text file, and it's plausible it's exposing pathological behavior in either tool.","author_association":"OWNER","reactions":{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/516950832/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"BurntSushi","id":456674,"node_id":"MDQ6VXNlcjQ1NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/456674?v=4","gravatar_id":"","url":"https://api.github.com/users/BurntSushi","html_url":"https://github.com/BurntSushi","followers_url":"https://api.github.com/users/BurntSushi/followers","following_url":"https://api.github.com/users/BurntSushi/following{/other_user}","gists_url":"https://api.github.com/users/BurntSushi/gists{/gist_id}","starred_url":"https://api.github.com/users/BurntSushi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BurntSushi/subscriptions","organizations_url":"https://api.github.com/users/BurntSushi/orgs","repos_url":"https://api.github.com/users/BurntSushi/repos","events_url":"https://api.github.com/users/BurntSushi/events{/privacy}","received_events_url":"https://api.github.com/users/BurntSushi/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/516957498","html_url":"https://github.com/BurntSushi/ripgrep/issues/1335#issuecomment-516957498","issue_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/1335","id":516957498,"node_id":"MDEyOklzc3VlQ29tbWVudDUxNjk1NzQ5OA==","user":{"login":"zsugabubus","id":30056345,"node_id":"MDQ6VXNlcjMwMDU2MzQ1","avatar_url":"https://avatars.githubusercontent.com/u/30056345?v=4","gravatar_id":"","url":"https://api.github.com/users/zsugabubus","html_url":"https://github.com/zsugabubus","followers_url":"https://api.github.com/users/zsugabubus/followers","following_url":"https://api.github.com/users/zsugabubus/following{/other_user}","gists_url":"https://api.github.com/users/zsugabubus/gists{/gist_id}","starred_url":"https://api.github.com/users/zsugabubus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zsugabubus/subscriptions","organizations_url":"https://api.github.com/users/zsugabubus/orgs","repos_url":"https://api.github.com/users/zsugabubus/repos","events_url":"https://api.github.com/users/zsugabubus/events{/privacy}","received_events_url":"https://api.github.com/users/zsugabubus/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-07-31T18:03:30Z","updated_at":"2019-07-31T18:05:41Z","body":"> My guess is that the 7.5 million character lines has something to do with this.\r\n\r\nMaybe, but on the other hand '\\n' is just like any other character, and these lines don't have to be printed. And as an important note:\r\n* either time info of JSON output is buggy and really the long lines cause the slowdown,\r\n* or it has nothing to do with file sizes and line length.\r\n\r\nWhy? Look at my `always_begin_end = true` [results from above](https://gist.github.com/zsugabubus/79f82a623d2d1804c96814875dfe7b87):\r\n```\r\n(top 1000 slowest)\r\n      time          size\r\n 993: 0.024438s      587\r\n...\r\n1001: 0.046391s  7528513\r\n(slowest)\r\n```\r\n\r\nThat 7.5M file is one long line. It takes the longest time to scan: 0.05s. 8 lines above a 0.0006M file took 0.02s to scan. ~Impossible~. My best guess would be it's waiting for something. Maybe a spinlock, if not syscalls?\r\n\r\n(I checked three times the results and it's not an individual case... but the most shocking.)","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/516957498/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"zsugabubus","id":30056345,"node_id":"MDQ6VXNlcjMwMDU2MzQ1","avatar_url":"https://avatars.githubusercontent.com/u/30056345?v=4","gravatar_id":"","url":"https://api.github.com/users/zsugabubus","html_url":"https://github.com/zsugabubus","followers_url":"https://api.github.com/users/zsugabubus/followers","following_url":"https://api.github.com/users/zsugabubus/following{/other_user}","gists_url":"https://api.github.com/users/zsugabubus/gists{/gist_id}","starred_url":"https://api.github.com/users/zsugabubus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zsugabubus/subscriptions","organizations_url":"https://api.github.com/users/zsugabubus/orgs","repos_url":"https://api.github.com/users/zsugabubus/repos","events_url":"https://api.github.com/users/zsugabubus/events{/privacy}","received_events_url":"https://api.github.com/users/zsugabubus/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/516962434","html_url":"https://github.com/BurntSushi/ripgrep/issues/1335#issuecomment-516962434","issue_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/1335","id":516962434,"node_id":"MDEyOklzc3VlQ29tbWVudDUxNjk2MjQzNA==","user":{"login":"BurntSushi","id":456674,"node_id":"MDQ6VXNlcjQ1NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/456674?v=4","gravatar_id":"","url":"https://api.github.com/users/BurntSushi","html_url":"https://github.com/BurntSushi","followers_url":"https://api.github.com/users/BurntSushi/followers","following_url":"https://api.github.com/users/BurntSushi/following{/other_user}","gists_url":"https://api.github.com/users/BurntSushi/gists{/gist_id}","starred_url":"https://api.github.com/users/BurntSushi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BurntSushi/subscriptions","organizations_url":"https://api.github.com/users/BurntSushi/orgs","repos_url":"https://api.github.com/users/BurntSushi/repos","events_url":"https://api.github.com/users/BurntSushi/events{/privacy}","received_events_url":"https://api.github.com/users/BurntSushi/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-07-31T18:17:22Z","updated_at":"2019-07-31T18:17:56Z","body":"> but on the other hand '\\n' is just like any other character, and these lines don't have to be printed\r\n\r\nNope, that's very wrong. Both grep (AFAIK) and ripgrep _require_ an entire line to be in memory in order to search it. Therefore, when reading from a file, they both (should) buffer until it sees EOF or the next `\\n`. This is related to binary files, which very frequently have long sequences of bytes without a `\\n` in them. The way the `-a/--text` flag works in both grep and ripgrep is to replace all `NUL` bytes with a line terminator, which prevents exorbitant memory usage in most cases. This isn't done by default since both grep and ripgrep will stop searching when they see a NUL byte. Thus, plain text files with very long lines could be provoking something pathological here. (Note that this is super subtle, and has taken me a long time to work out completely.)\r\n\r\nRemember, I am **just guessing** based on my mental model of how these programs work and my interpretation of the data you've presented so far. Both things could be wrong in subtle ways. ;-)\r\n\r\nI agree that your JSON results are a bit interesting. I'm not sure what to make of them. I think I'm at a loss at this point and would require a reproduction to move further.","author_association":"OWNER","reactions":{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/516962434/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"BurntSushi","id":456674,"node_id":"MDQ6VXNlcjQ1NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/456674?v=4","gravatar_id":"","url":"https://api.github.com/users/BurntSushi","html_url":"https://github.com/BurntSushi","followers_url":"https://api.github.com/users/BurntSushi/followers","following_url":"https://api.github.com/users/BurntSushi/following{/other_user}","gists_url":"https://api.github.com/users/BurntSushi/gists{/gist_id}","starred_url":"https://api.github.com/users/BurntSushi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BurntSushi/subscriptions","organizations_url":"https://api.github.com/users/BurntSushi/orgs","repos_url":"https://api.github.com/users/BurntSushi/repos","events_url":"https://api.github.com/users/BurntSushi/events{/privacy}","received_events_url":"https://api.github.com/users/BurntSushi/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/516966640","html_url":"https://github.com/BurntSushi/ripgrep/issues/1335#issuecomment-516966640","issue_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/1335","id":516966640,"node_id":"MDEyOklzc3VlQ29tbWVudDUxNjk2NjY0MA==","user":{"login":"zsugabubus","id":30056345,"node_id":"MDQ6VXNlcjMwMDU2MzQ1","avatar_url":"https://avatars.githubusercontent.com/u/30056345?v=4","gravatar_id":"","url":"https://api.github.com/users/zsugabubus","html_url":"https://github.com/zsugabubus","followers_url":"https://api.github.com/users/zsugabubus/followers","following_url":"https://api.github.com/users/zsugabubus/following{/other_user}","gists_url":"https://api.github.com/users/zsugabubus/gists{/gist_id}","starred_url":"https://api.github.com/users/zsugabubus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zsugabubus/subscriptions","organizations_url":"https://api.github.com/users/zsugabubus/orgs","repos_url":"https://api.github.com/users/zsugabubus/repos","events_url":"https://api.github.com/users/zsugabubus/events{/privacy}","received_events_url":"https://api.github.com/users/zsugabubus/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-07-31T18:29:03Z","updated_at":"2019-07-31T18:29:03Z","body":"> Nope, that's very wrong\r\n\r\nOops, sorry. What was in my mind is that they don't have to be printed, so they don't have to be stored. Silly thing.\r\n","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/516966640/reactions","total_count":1,"+1":0,"-1":0,"laugh":1,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"zsugabubus","id":30056345,"node_id":"MDQ6VXNlcjMwMDU2MzQ1","avatar_url":"https://avatars.githubusercontent.com/u/30056345?v=4","gravatar_id":"","url":"https://api.github.com/users/zsugabubus","html_url":"https://github.com/zsugabubus","followers_url":"https://api.github.com/users/zsugabubus/followers","following_url":"https://api.github.com/users/zsugabubus/following{/other_user}","gists_url":"https://api.github.com/users/zsugabubus/gists{/gist_id}","starred_url":"https://api.github.com/users/zsugabubus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zsugabubus/subscriptions","organizations_url":"https://api.github.com/users/zsugabubus/orgs","repos_url":"https://api.github.com/users/zsugabubus/repos","events_url":"https://api.github.com/users/zsugabubus/events{/privacy}","received_events_url":"https://api.github.com/users/zsugabubus/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/516973071","html_url":"https://github.com/BurntSushi/ripgrep/issues/1335#issuecomment-516973071","issue_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/1335","id":516973071,"node_id":"MDEyOklzc3VlQ29tbWVudDUxNjk3MzA3MQ==","user":{"login":"zsugabubus","id":30056345,"node_id":"MDQ6VXNlcjMwMDU2MzQ1","avatar_url":"https://avatars.githubusercontent.com/u/30056345?v=4","gravatar_id":"","url":"https://api.github.com/users/zsugabubus","html_url":"https://github.com/zsugabubus","followers_url":"https://api.github.com/users/zsugabubus/followers","following_url":"https://api.github.com/users/zsugabubus/following{/other_user}","gists_url":"https://api.github.com/users/zsugabubus/gists{/gist_id}","starred_url":"https://api.github.com/users/zsugabubus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zsugabubus/subscriptions","organizations_url":"https://api.github.com/users/zsugabubus/orgs","repos_url":"https://api.github.com/users/zsugabubus/repos","events_url":"https://api.github.com/users/zsugabubus/events{/privacy}","received_events_url":"https://api.github.com/users/zsugabubus/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-07-31T18:45:41Z","updated_at":"2019-07-31T18:45:41Z","body":"I can't believe it, but hurray ripgrep is faster:\r\n```\r\n$ time rg file\\\\.php ./.../thathugefile\r\nrg file\\\\.php                  0.01s user 0.01s system 96% cpu 0.015 total\r\n$ time grep file\\\\.php ./.../thathugefile\r\ngrep --color=auto file.php     0.02s user 0.02s system 98% cpu 0.038 total\r\n```\r\n\r\nNotes:\r\n1) times differ (!): not 0.046391s as above, just 0.015s,\r\n2) ripgrep handles extreme line length excellently,\r\n3) this huge file isn't in that folder that takes 200ms to scan (4th entry),\r\n4) my conclusion would be that the key to the solution isn't in long lines, but something really different.\r\n\r\n----\r\n\r\nSo... what if it isn't an issue with ripgrep but an issue with `walkdir` (or whatever it uses).\r\n\r\n> Note that tokei has similar running time.\r\n\r\n```\r\n$ time strace -fc tokei\r\n% time     seconds  usecs/call     calls    errors syscall\r\n------ ----------- ----------- --------- --------- ----------------\r\n 44.92    1.346454        2259       596       138 futex\r\n 31.02    0.929767           9     97796           read\r\n 14.12    0.423211          17     24584     11063 openat\r\n  4.52    0.135603          10     13521           close\r\n  2.38    0.071207          12      5548           getdents64\r\n  1.33    0.039944          14      2789      2787 stat\r\n  1.05    0.031580          11      2782           fstat\r\n  0.32    0.009592          17       543           mprotect\r\n  0.17    0.005214           8       590           sched_yield\r\n  0.05    0.001363          80        17           sigaltstack\r\n  0.03    0.000822         137         6           clone\r\n  0.03    0.000767          17        43           mmap\r\n  0.02    0.000691         345         2           nanosleep\r\n  0.01    0.000338          48         7           set_robust_list\r\n  0.01    0.000282          25        11           munmap\r\n  0.01    0.000188          23         8           sched_getaffinity\r\n  0.00    0.000133          19         7           mremap\r\n  0.00    0.000090          30         3           getrandom\r\n  0.00    0.000052           6         8           lseek\r\n  0.00    0.000036           7         5           rt_sigaction\r\n  0.00    0.000032           4         7           brk\r\n  0.00    0.000025          25         1           access\r\n  0.00    0.000022          11         2         1 arch_prctl\r\n  0.00    0.000021          10         2           getcwd\r\n  0.00    0.000017           8         2           prlimit64\r\n  0.00    0.000013          13         1           ioctl\r\n  0.00    0.000012          12         1           execve\r\n  0.00    0.000009           9         1           set_tid_address\r\n  0.00    0.000008           8         1           rt_sigprocmask\r\n  0.00    0.000008           8         1           fcntl\r\n  0.00    0.000000           0         1           write\r\n  0.00    0.000000           0         2           madvise\r\n------ ----------- ----------- --------- --------- ----------------\r\n100.00    2.997501                148888     13989 total\r\nstrace -fc tokei  4.90s user 3.29s system 251% cpu 3.259 total\r\n```\r\n\r\nSeems similar, don't you think?\r\n","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/516973071/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"zsugabubus","id":30056345,"node_id":"MDQ6VXNlcjMwMDU2MzQ1","avatar_url":"https://avatars.githubusercontent.com/u/30056345?v=4","gravatar_id":"","url":"https://api.github.com/users/zsugabubus","html_url":"https://github.com/zsugabubus","followers_url":"https://api.github.com/users/zsugabubus/followers","following_url":"https://api.github.com/users/zsugabubus/following{/other_user}","gists_url":"https://api.github.com/users/zsugabubus/gists{/gist_id}","starred_url":"https://api.github.com/users/zsugabubus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zsugabubus/subscriptions","organizations_url":"https://api.github.com/users/zsugabubus/orgs","repos_url":"https://api.github.com/users/zsugabubus/repos","events_url":"https://api.github.com/users/zsugabubus/events{/privacy}","received_events_url":"https://api.github.com/users/zsugabubus/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/517044005","html_url":"https://github.com/BurntSushi/ripgrep/issues/1335#issuecomment-517044005","issue_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/1335","id":517044005,"node_id":"MDEyOklzc3VlQ29tbWVudDUxNzA0NDAwNQ==","user":{"login":"BurntSushi","id":456674,"node_id":"MDQ6VXNlcjQ1NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/456674?v=4","gravatar_id":"","url":"https://api.github.com/users/BurntSushi","html_url":"https://github.com/BurntSushi","followers_url":"https://api.github.com/users/BurntSushi/followers","following_url":"https://api.github.com/users/BurntSushi/following{/other_user}","gists_url":"https://api.github.com/users/BurntSushi/gists{/gist_id}","starred_url":"https://api.github.com/users/BurntSushi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BurntSushi/subscriptions","organizations_url":"https://api.github.com/users/BurntSushi/orgs","repos_url":"https://api.github.com/users/BurntSushi/repos","events_url":"https://api.github.com/users/BurntSushi/events{/privacy}","received_events_url":"https://api.github.com/users/BurntSushi/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-07-31T22:20:06Z","updated_at":"2019-07-31T22:20:06Z","body":"I poked at the long lines because a 7.5 million character long line is highly unusual, so it's just a shot in the dark with respect to it being an anomaly.\r\n\r\nI cannot come up with any hypothesis that would explain slowness in ripgrep's directory traversal. Multithreaded and single threaded directory traversal use completely different code, so the issue would need to be present in  both implementations. I wrote both of them myself, so it's possible.\r\n\r\nWhile the syscall traces are interesting, your `time` output suggests the difference is in `user` time and not `sys` time, which points away from the specific syscalls invoked.\r\n\r\nI'm afraid the only path forward here is to either recursively widdle the corpus down so that a proper analysis can be done, or by giving me a reproduction so that I can investigate myself. Sorry. :-/","author_association":"OWNER","reactions":{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/517044005/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"BurntSushi","id":456674,"node_id":"MDQ6VXNlcjQ1NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/456674?v=4","gravatar_id":"","url":"https://api.github.com/users/BurntSushi","html_url":"https://github.com/BurntSushi","followers_url":"https://api.github.com/users/BurntSushi/followers","following_url":"https://api.github.com/users/BurntSushi/following{/other_user}","gists_url":"https://api.github.com/users/BurntSushi/gists{/gist_id}","starred_url":"https://api.github.com/users/BurntSushi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BurntSushi/subscriptions","organizations_url":"https://api.github.com/users/BurntSushi/orgs","repos_url":"https://api.github.com/users/BurntSushi/repos","events_url":"https://api.github.com/users/BurntSushi/events{/privacy}","received_events_url":"https://api.github.com/users/BurntSushi/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/517044437","html_url":"https://github.com/BurntSushi/ripgrep/issues/1335#issuecomment-517044437","issue_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/1335","id":517044437,"node_id":"MDEyOklzc3VlQ29tbWVudDUxNzA0NDQzNw==","user":{"login":"BurntSushi","id":456674,"node_id":"MDQ6VXNlcjQ1NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/456674?v=4","gravatar_id":"","url":"https://api.github.com/users/BurntSushi","html_url":"https://github.com/BurntSushi","followers_url":"https://api.github.com/users/BurntSushi/followers","following_url":"https://api.github.com/users/BurntSushi/following{/other_user}","gists_url":"https://api.github.com/users/BurntSushi/gists{/gist_id}","starred_url":"https://api.github.com/users/BurntSushi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BurntSushi/subscriptions","organizations_url":"https://api.github.com/users/BurntSushi/orgs","repos_url":"https://api.github.com/users/BurntSushi/repos","events_url":"https://api.github.com/users/BurntSushi/events{/privacy}","received_events_url":"https://api.github.com/users/BurntSushi/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-07-31T22:21:38Z","updated_at":"2019-07-31T22:21:38Z","body":"Tokei uses the same directory traversal code as ripgrep, so that is an interesting point in favor of that being the slow down. But I still can't think of a hypothesis to explain it.","author_association":"OWNER","reactions":{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/517044437/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"BurntSushi","id":456674,"node_id":"MDQ6VXNlcjQ1NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/456674?v=4","gravatar_id":"","url":"https://api.github.com/users/BurntSushi","html_url":"https://github.com/BurntSushi","followers_url":"https://api.github.com/users/BurntSushi/followers","following_url":"https://api.github.com/users/BurntSushi/following{/other_user}","gists_url":"https://api.github.com/users/BurntSushi/gists{/gist_id}","starred_url":"https://api.github.com/users/BurntSushi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BurntSushi/subscriptions","organizations_url":"https://api.github.com/users/BurntSushi/orgs","repos_url":"https://api.github.com/users/BurntSushi/repos","events_url":"https://api.github.com/users/BurntSushi/events{/privacy}","received_events_url":"https://api.github.com/users/BurntSushi/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/517091917","html_url":"https://github.com/BurntSushi/ripgrep/issues/1335#issuecomment-517091917","issue_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/1335","id":517091917,"node_id":"MDEyOklzc3VlQ29tbWVudDUxNzA5MTkxNw==","user":{"login":"BurntSushi","id":456674,"node_id":"MDQ6VXNlcjQ1NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/456674?v=4","gravatar_id":"","url":"https://api.github.com/users/BurntSushi","html_url":"https://github.com/BurntSushi","followers_url":"https://api.github.com/users/BurntSushi/followers","following_url":"https://api.github.com/users/BurntSushi/following{/other_user}","gists_url":"https://api.github.com/users/BurntSushi/gists{/gist_id}","starred_url":"https://api.github.com/users/BurntSushi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BurntSushi/subscriptions","organizations_url":"https://api.github.com/users/BurntSushi/orgs","repos_url":"https://api.github.com/users/BurntSushi/repos","events_url":"https://api.github.com/users/BurntSushi/events{/privacy}","received_events_url":"https://api.github.com/users/BurntSushi/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-08-01T02:21:38Z","updated_at":"2019-08-01T02:21:38Z","body":"Have you tried different queries? e.g., `filephp` with no period? Or other queries in general?","author_association":"OWNER","reactions":{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/517091917/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"BurntSushi","id":456674,"node_id":"MDQ6VXNlcjQ1NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/456674?v=4","gravatar_id":"","url":"https://api.github.com/users/BurntSushi","html_url":"https://github.com/BurntSushi","followers_url":"https://api.github.com/users/BurntSushi/followers","following_url":"https://api.github.com/users/BurntSushi/following{/other_user}","gists_url":"https://api.github.com/users/BurntSushi/gists{/gist_id}","starred_url":"https://api.github.com/users/BurntSushi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BurntSushi/subscriptions","organizations_url":"https://api.github.com/users/BurntSushi/orgs","repos_url":"https://api.github.com/users/BurntSushi/repos","events_url":"https://api.github.com/users/BurntSushi/events{/privacy}","received_events_url":"https://api.github.com/users/BurntSushi/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/517188079","html_url":"https://github.com/BurntSushi/ripgrep/issues/1335#issuecomment-517188079","issue_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/1335","id":517188079,"node_id":"MDEyOklzc3VlQ29tbWVudDUxNzE4ODA3OQ==","user":{"login":"zsugabubus","id":30056345,"node_id":"MDQ6VXNlcjMwMDU2MzQ1","avatar_url":"https://avatars.githubusercontent.com/u/30056345?v=4","gravatar_id":"","url":"https://api.github.com/users/zsugabubus","html_url":"https://github.com/zsugabubus","followers_url":"https://api.github.com/users/zsugabubus/followers","following_url":"https://api.github.com/users/zsugabubus/following{/other_user}","gists_url":"https://api.github.com/users/zsugabubus/gists{/gist_id}","starred_url":"https://api.github.com/users/zsugabubus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zsugabubus/subscriptions","organizations_url":"https://api.github.com/users/zsugabubus/orgs","repos_url":"https://api.github.com/users/zsugabubus/repos","events_url":"https://api.github.com/users/zsugabubus/events{/privacy}","received_events_url":"https://api.github.com/users/zsugabubus/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-08-01T08:40:28Z","updated_at":"2019-08-01T09:41:10Z","body":"> Have you tried different queries?\r\n\r\nYes, of course, but results have to taken with care, because with \"complex\" regexp queries ripgrep can easily beat grep even if it's slowed down by this issue. But generally speaking yes, if I grep for regexp-less or queries with moderated amount of regexps I get similar times.\r\n\r\n---\r\n\r\nIn the mean time, I created some simple projects to test `ignore` and `walkdir` crates. Probably You do, but I didn't think of it before, that `openat` and `stat` errors come from nonexistent `.ignore` and `.git`... etc files.\r\n\r\n**UPDATE**: And futex errors come from `ignore` crate parallel walking.\r\n\r\n**UPDATE2**: Walking the directory: 0.150s; parallel: highly varies between 0.125-0.170s. I will try making some changes in the parallel walk code of `ignore` to see if some changes.","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/517188079/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":1},"performed_via_github_app":null,"event":"commented","actor":{"login":"zsugabubus","id":30056345,"node_id":"MDQ6VXNlcjMwMDU2MzQ1","avatar_url":"https://avatars.githubusercontent.com/u/30056345?v=4","gravatar_id":"","url":"https://api.github.com/users/zsugabubus","html_url":"https://github.com/zsugabubus","followers_url":"https://api.github.com/users/zsugabubus/followers","following_url":"https://api.github.com/users/zsugabubus/following{/other_user}","gists_url":"https://api.github.com/users/zsugabubus/gists{/gist_id}","starred_url":"https://api.github.com/users/zsugabubus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zsugabubus/subscriptions","organizations_url":"https://api.github.com/users/zsugabubus/orgs","repos_url":"https://api.github.com/users/zsugabubus/repos","events_url":"https://api.github.com/users/zsugabubus/events{/privacy}","received_events_url":"https://api.github.com/users/zsugabubus/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/517233530","html_url":"https://github.com/BurntSushi/ripgrep/issues/1335#issuecomment-517233530","issue_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/1335","id":517233530,"node_id":"MDEyOklzc3VlQ29tbWVudDUxNzIzMzUzMA==","user":{"login":"BurntSushi","id":456674,"node_id":"MDQ6VXNlcjQ1NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/456674?v=4","gravatar_id":"","url":"https://api.github.com/users/BurntSushi","html_url":"https://github.com/BurntSushi","followers_url":"https://api.github.com/users/BurntSushi/followers","following_url":"https://api.github.com/users/BurntSushi/following{/other_user}","gists_url":"https://api.github.com/users/BurntSushi/gists{/gist_id}","starred_url":"https://api.github.com/users/BurntSushi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BurntSushi/subscriptions","organizations_url":"https://api.github.com/users/BurntSushi/orgs","repos_url":"https://api.github.com/users/BurntSushi/repos","events_url":"https://api.github.com/users/BurntSushi/events{/privacy}","received_events_url":"https://api.github.com/users/BurntSushi/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-08-01T10:54:00Z","updated_at":"2019-08-01T10:54:57Z","body":"> But generally speaking yes, if I grep for regexp-less or queries with moderated amount of regexps I get similar times\r\n\r\nFor grins, can you try searching for `qqqqqqqqqq`? (I am trying to rule out pathological behavior in the literal searcher. ripgrep uses a different one from grep. Searching for a pattern with the same rare letter repeated should hopefully put these on a level playing field. Again, just a shot in the dark.)\r\n\r\n>  Probably You do, but I didn't think of it before, that openat and stat errors come from nonexistent .ignore and .git... etc files.\r\n\r\nRight yeah. Those shouldn't be happening though when running with `-uuu`. If they are, then that's a bug.\r\n\r\nThanks for really digging into this! I'll be quite curious to see what you find!","author_association":"OWNER","reactions":{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/517233530/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"BurntSushi","id":456674,"node_id":"MDQ6VXNlcjQ1NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/456674?v=4","gravatar_id":"","url":"https://api.github.com/users/BurntSushi","html_url":"https://github.com/BurntSushi","followers_url":"https://api.github.com/users/BurntSushi/followers","following_url":"https://api.github.com/users/BurntSushi/following{/other_user}","gists_url":"https://api.github.com/users/BurntSushi/gists{/gist_id}","starred_url":"https://api.github.com/users/BurntSushi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BurntSushi/subscriptions","organizations_url":"https://api.github.com/users/BurntSushi/orgs","repos_url":"https://api.github.com/users/BurntSushi/repos","events_url":"https://api.github.com/users/BurntSushi/events{/privacy}","received_events_url":"https://api.github.com/users/BurntSushi/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/517259096","html_url":"https://github.com/BurntSushi/ripgrep/issues/1335#issuecomment-517259096","issue_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/1335","id":517259096,"node_id":"MDEyOklzc3VlQ29tbWVudDUxNzI1OTA5Ng==","user":{"login":"zsugabubus","id":30056345,"node_id":"MDQ6VXNlcjMwMDU2MzQ1","avatar_url":"https://avatars.githubusercontent.com/u/30056345?v=4","gravatar_id":"","url":"https://api.github.com/users/zsugabubus","html_url":"https://github.com/zsugabubus","followers_url":"https://api.github.com/users/zsugabubus/followers","following_url":"https://api.github.com/users/zsugabubus/following{/other_user}","gists_url":"https://api.github.com/users/zsugabubus/gists{/gist_id}","starred_url":"https://api.github.com/users/zsugabubus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zsugabubus/subscriptions","organizations_url":"https://api.github.com/users/zsugabubus/orgs","repos_url":"https://api.github.com/users/zsugabubus/repos","events_url":"https://api.github.com/users/zsugabubus/events{/privacy}","received_events_url":"https://api.github.com/users/zsugabubus/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-08-01T12:11:17Z","updated_at":"2019-08-01T12:12:36Z","body":"> can you try searching for qqqqqqqqqq?\r\n\r\nSearched for every such pattern using `{0..9} {a..z} {A..Z}` letters, but it stays around 1.2s (grep 0.3s). (There were about 5 cases when it dropped slightly below 1s.) \r\n\r\nripgrep had higher variance in times (0.92-1.23s) compared to grep (0.29-0.36s). Aside form the working of the algorithm, it suggests me that it's the effect of the bug.\r\n","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/517259096/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"zsugabubus","id":30056345,"node_id":"MDQ6VXNlcjMwMDU2MzQ1","avatar_url":"https://avatars.githubusercontent.com/u/30056345?v=4","gravatar_id":"","url":"https://api.github.com/users/zsugabubus","html_url":"https://github.com/zsugabubus","followers_url":"https://api.github.com/users/zsugabubus/followers","following_url":"https://api.github.com/users/zsugabubus/following{/other_user}","gists_url":"https://api.github.com/users/zsugabubus/gists{/gist_id}","starred_url":"https://api.github.com/users/zsugabubus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zsugabubus/subscriptions","organizations_url":"https://api.github.com/users/zsugabubus/orgs","repos_url":"https://api.github.com/users/zsugabubus/repos","events_url":"https://api.github.com/users/zsugabubus/events{/privacy}","received_events_url":"https://api.github.com/users/zsugabubus/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/517263049","html_url":"https://github.com/BurntSushi/ripgrep/issues/1335#issuecomment-517263049","issue_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/1335","id":517263049,"node_id":"MDEyOklzc3VlQ29tbWVudDUxNzI2MzA0OQ==","user":{"login":"zsugabubus","id":30056345,"node_id":"MDQ6VXNlcjMwMDU2MzQ1","avatar_url":"https://avatars.githubusercontent.com/u/30056345?v=4","gravatar_id":"","url":"https://api.github.com/users/zsugabubus","html_url":"https://github.com/zsugabubus","followers_url":"https://api.github.com/users/zsugabubus/followers","following_url":"https://api.github.com/users/zsugabubus/following{/other_user}","gists_url":"https://api.github.com/users/zsugabubus/gists{/gist_id}","starred_url":"https://api.github.com/users/zsugabubus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zsugabubus/subscriptions","organizations_url":"https://api.github.com/users/zsugabubus/orgs","repos_url":"https://api.github.com/users/zsugabubus/repos","events_url":"https://api.github.com/users/zsugabubus/events{/privacy}","received_events_url":"https://api.github.com/users/zsugabubus/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-08-01T12:22:31Z","updated_at":"2019-08-01T12:33:27Z","body":"I think I got it. Look at the times.\r\n\r\n```                                                                                                                                                                \r\n~/ripgrep/target/release/rg 'abrakadabra'  4.07s user 0.52s system 350% cpu 1.308 total                                                                                                                                                             \r\n~/ripgrep/target/release/rg 'abrakadabra'  2.03s user 0.49s system 357% cpu 0.706 total                                                                                                                                                             \r\n~/ripgrep/target/release/rg 'abrakadabra'  4.09s user 0.44s system 349% cpu 1.298 total                                                                                                                                                               \r\n~/ripgrep/target/release/rg 'abrakadabra'  3.87s user 0.45s system 361% cpu 1.194 total                                                                                                                                                             \r\n~/ripgrep/target/release/rg 'abrakadabra'  1.24s user 0.35s system 349% cpu 0.455 total\r\n\r\n# Later:\r\n~/ripgrep/target/release/rg 'abrakadabra'  3.08s user 0.42s system 360% cpu 0.972 total\r\n~/ripgrep/target/release/rg 'abrakadabra'  2.27s user 0.38s system 349% cpu 0.757 total\r\n~/ripgrep/target/release/rg 'abrakadabra'  2.14s user 0.40s system 360% cpu 0.706 total\r\n~/ripgrep/target/release/rg 'abrakadabra'  3.99s user 0.48s system 360% cpu 1.240 total\r\n~/ripgrep/target/release/rg 'abrakadabra'  3.78s user 0.46s system 353% cpu 1.200 total\r\n~/ripgrep/target/release/rg 'abrakadabra'  2.54s user 0.38s system 362% cpu 0.807 total\r\n~/ripgrep/target/release/rg 'abrakadabra'  3.68s user 0.45s system 361% cpu 1.144 total\r\n~/ripgrep/target/release/rg 'abrakadabra'  3.58s user 0.52s system 351% cpu 1.163 total\r\n~/ripgrep/target/release/rg 'abrakadabra'  2.14s user 0.38s system 364% cpu 0.691 total\r\n~/ripgrep/target/release/rg 'abrakadabra'  2.83s user 0.41s system 356% cpu 0.908 total\r\n~/ripgrep/target/release/rg 'abrakadabra'  1.35s user 0.35s system 348% cpu 0.489 total\r\n```\r\n\r\nUsed a little shitty hack, that tells some threads to refuse to the work if it is a directory, so basically one threads does the directory traversal and others taking care of files. It can have huge performance penalty though, but... it works sometimes.\r\n\r\n---\r\n\r\n(Contains probable fix for removing unnecessary `sleep`.)\r\n\r\n```diff\r\ndiff --git a/ignore/src/walk.rs b/ignore/src/walk.rs\r\nindex df796d4..ecced49 100644\r\n--- a/ignore/src/walk.rs\r\n+++ b/ignore/src/walk.rs\r\n@@ -1161,7 +1161,7 @@ impl WalkParallel {\r\n         let num_quitting = Arc::new(AtomicUsize::new(0));\r\n         let quit_now = Arc::new(AtomicBool::new(false));\r\n         let mut handles = vec![];\r\n-        for _ in 0..threads {\r\n+        for i in 0..threads {\r\n             let worker = Worker {\r\n                 f: mkf(),\r\n                 tx: tx.clone(),\r\n@@ -1177,7 +1177,7 @@ impl WalkParallel {\r\n                 follow_links: self.follow_links,\r\n                 skip: self.skip.clone(),\r\n             };\r\n-            handles.push(thread::spawn(|| worker.run()));\r\n+            handles.push(thread::spawn(move || worker.run(i > 0)));\r\n         }\r\n         drop(tx);\r\n         drop(rx);\r\n@@ -1314,7 +1314,7 @@ impl Worker {\r\n     ///\r\n     /// The worker will call the caller's callback for all entries that aren't\r\n     /// skipped by the ignore matcher.\r\n-    fn run(mut self) {\r\n+    fn run(mut self, files_only: bool) {\r\n         while let Some(mut work) = self.get_work() {\r\n             // If the work is not a directory, then we can just execute the\r\n             // caller's callback immediately and move on.\r\n@@ -1331,6 +1331,12 @@ impl Worker {\r\n                     return;\r\n                 }\r\n             }\r\n+\r\n+            if files_only {\r\n+                self.tx.send(Message::Work(work)).unwrap();\r\n+                continue;\r\n+            }\r\n+\r\n             let readdir = match work.read_dir() {\r\n                 Ok(readdir) => readdir,\r\n                 Err(err) => {\r\n@@ -1470,11 +1476,12 @@ impl Worker {\r\n     /// If all work has been exhausted, then this returns None. The worker\r\n     /// should then subsequently quit.\r\n     fn get_work(&mut self) -> Option<Work> {\r\n+        let mut value = self.rx.try_recv().map_err(|_| ());\r\n         loop {\r\n             if self.is_quit_now() {\r\n                 return None;\r\n             }\r\n-            match self.rx.try_recv() {\r\n+            match value {\r\n                 Ok(Message::Work(work)) => {\r\n                     self.waiting(false);\r\n                     self.quitting(false);\r\n@@ -1514,22 +1521,15 @@ impl Worker {\r\n                 Err(_) => {\r\n                     self.waiting(true);\r\n                     self.quitting(false);\r\n+                    // If all threads are waiting, then quit.\r\n                     if self.num_waiting() == self.threads {\r\n                         for _ in 0..self.threads {\r\n                             self.tx.send(Message::Quit).unwrap();\r\n                         }\r\n-                    } else {\r\n-                        // You're right to consider this suspicious, but it's\r\n-                        // a useful heuristic to permit producers to catch up\r\n-                        // to consumers without burning the CPU. It is also\r\n-                        // useful as a means to prevent burning the CPU if only\r\n-                        // one worker is left doing actual work. It's not\r\n-                        // perfect and it doesn't leave the CPU completely\r\n-                        // idle, but it's not clear what else we can do. :-/\r\n-                        thread::sleep(Duration::from_millis(1));\r\n                     }\r\n                 }\r\n             }\r\n+            value = self.rx.recv().map_err(|_| ());\r\n         }\r\n     }\r\n```","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/517263049/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"zsugabubus","id":30056345,"node_id":"MDQ6VXNlcjMwMDU2MzQ1","avatar_url":"https://avatars.githubusercontent.com/u/30056345?v=4","gravatar_id":"","url":"https://api.github.com/users/zsugabubus","html_url":"https://github.com/zsugabubus","followers_url":"https://api.github.com/users/zsugabubus/followers","following_url":"https://api.github.com/users/zsugabubus/following{/other_user}","gists_url":"https://api.github.com/users/zsugabubus/gists{/gist_id}","starred_url":"https://api.github.com/users/zsugabubus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zsugabubus/subscriptions","organizations_url":"https://api.github.com/users/zsugabubus/orgs","repos_url":"https://api.github.com/users/zsugabubus/repos","events_url":"https://api.github.com/users/zsugabubus/events{/privacy}","received_events_url":"https://api.github.com/users/zsugabubus/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/517267705","html_url":"https://github.com/BurntSushi/ripgrep/issues/1335#issuecomment-517267705","issue_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/1335","id":517267705,"node_id":"MDEyOklzc3VlQ29tbWVudDUxNzI2NzcwNQ==","user":{"login":"BurntSushi","id":456674,"node_id":"MDQ6VXNlcjQ1NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/456674?v=4","gravatar_id":"","url":"https://api.github.com/users/BurntSushi","html_url":"https://github.com/BurntSushi","followers_url":"https://api.github.com/users/BurntSushi/followers","following_url":"https://api.github.com/users/BurntSushi/following{/other_user}","gists_url":"https://api.github.com/users/BurntSushi/gists{/gist_id}","starred_url":"https://api.github.com/users/BurntSushi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BurntSushi/subscriptions","organizations_url":"https://api.github.com/users/BurntSushi/orgs","repos_url":"https://api.github.com/users/BurntSushi/repos","events_url":"https://api.github.com/users/BurntSushi/events{/privacy}","received_events_url":"https://api.github.com/users/BurntSushi/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-08-01T12:35:59Z","updated_at":"2019-08-01T12:35:59Z","body":"Hmmm but that doesn't explain why single-threaded ripgrep is so much slower than single-threaded grep?","author_association":"OWNER","reactions":{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/517267705/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"BurntSushi","id":456674,"node_id":"MDQ6VXNlcjQ1NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/456674?v=4","gravatar_id":"","url":"https://api.github.com/users/BurntSushi","html_url":"https://github.com/BurntSushi","followers_url":"https://api.github.com/users/BurntSushi/followers","following_url":"https://api.github.com/users/BurntSushi/following{/other_user}","gists_url":"https://api.github.com/users/BurntSushi/gists{/gist_id}","starred_url":"https://api.github.com/users/BurntSushi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BurntSushi/subscriptions","organizations_url":"https://api.github.com/users/BurntSushi/orgs","repos_url":"https://api.github.com/users/BurntSushi/repos","events_url":"https://api.github.com/users/BurntSushi/events{/privacy}","received_events_url":"https://api.github.com/users/BurntSushi/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/517270092","html_url":"https://github.com/BurntSushi/ripgrep/issues/1335#issuecomment-517270092","issue_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/1335","id":517270092,"node_id":"MDEyOklzc3VlQ29tbWVudDUxNzI3MDA5Mg==","user":{"login":"zsugabubus","id":30056345,"node_id":"MDQ6VXNlcjMwMDU2MzQ1","avatar_url":"https://avatars.githubusercontent.com/u/30056345?v=4","gravatar_id":"","url":"https://api.github.com/users/zsugabubus","html_url":"https://github.com/zsugabubus","followers_url":"https://api.github.com/users/zsugabubus/followers","following_url":"https://api.github.com/users/zsugabubus/following{/other_user}","gists_url":"https://api.github.com/users/zsugabubus/gists{/gist_id}","starred_url":"https://api.github.com/users/zsugabubus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zsugabubus/subscriptions","organizations_url":"https://api.github.com/users/zsugabubus/orgs","repos_url":"https://api.github.com/users/zsugabubus/repos","events_url":"https://api.github.com/users/zsugabubus/events{/privacy}","received_events_url":"https://api.github.com/users/zsugabubus/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-08-01T12:42:10Z","updated_at":"2019-08-01T12:42:10Z","body":"Ehhh.","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/517270092/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"zsugabubus","id":30056345,"node_id":"MDQ6VXNlcjMwMDU2MzQ1","avatar_url":"https://avatars.githubusercontent.com/u/30056345?v=4","gravatar_id":"","url":"https://api.github.com/users/zsugabubus","html_url":"https://github.com/zsugabubus","followers_url":"https://api.github.com/users/zsugabubus/followers","following_url":"https://api.github.com/users/zsugabubus/following{/other_user}","gists_url":"https://api.github.com/users/zsugabubus/gists{/gist_id}","starred_url":"https://api.github.com/users/zsugabubus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zsugabubus/subscriptions","organizations_url":"https://api.github.com/users/zsugabubus/orgs","repos_url":"https://api.github.com/users/zsugabubus/repos","events_url":"https://api.github.com/users/zsugabubus/events{/privacy}","received_events_url":"https://api.github.com/users/zsugabubus/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/517315667","html_url":"https://github.com/BurntSushi/ripgrep/issues/1335#issuecomment-517315667","issue_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/1335","id":517315667,"node_id":"MDEyOklzc3VlQ29tbWVudDUxNzMxNTY2Nw==","user":{"login":"zsugabubus","id":30056345,"node_id":"MDQ6VXNlcjMwMDU2MzQ1","avatar_url":"https://avatars.githubusercontent.com/u/30056345?v=4","gravatar_id":"","url":"https://api.github.com/users/zsugabubus","html_url":"https://github.com/zsugabubus","followers_url":"https://api.github.com/users/zsugabubus/followers","following_url":"https://api.github.com/users/zsugabubus/following{/other_user}","gists_url":"https://api.github.com/users/zsugabubus/gists{/gist_id}","starred_url":"https://api.github.com/users/zsugabubus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zsugabubus/subscriptions","organizations_url":"https://api.github.com/users/zsugabubus/orgs","repos_url":"https://api.github.com/users/zsugabubus/repos","events_url":"https://api.github.com/users/zsugabubus/events{/privacy}","received_events_url":"https://api.github.com/users/zsugabubus/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-08-01T14:37:22Z","updated_at":"2019-08-01T14:37:22Z","body":"* Where does ripgrep can do lot's of memcpy?\r\n* Why does ripgrep read 3 bytes at first from files?","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/517315667/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"zsugabubus","id":30056345,"node_id":"MDQ6VXNlcjMwMDU2MzQ1","avatar_url":"https://avatars.githubusercontent.com/u/30056345?v=4","gravatar_id":"","url":"https://api.github.com/users/zsugabubus","html_url":"https://github.com/zsugabubus","followers_url":"https://api.github.com/users/zsugabubus/followers","following_url":"https://api.github.com/users/zsugabubus/following{/other_user}","gists_url":"https://api.github.com/users/zsugabubus/gists{/gist_id}","starred_url":"https://api.github.com/users/zsugabubus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zsugabubus/subscriptions","organizations_url":"https://api.github.com/users/zsugabubus/orgs","repos_url":"https://api.github.com/users/zsugabubus/repos","events_url":"https://api.github.com/users/zsugabubus/events{/privacy}","received_events_url":"https://api.github.com/users/zsugabubus/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/517316649","html_url":"https://github.com/BurntSushi/ripgrep/issues/1335#issuecomment-517316649","issue_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/1335","id":517316649,"node_id":"MDEyOklzc3VlQ29tbWVudDUxNzMxNjY0OQ==","user":{"login":"BurntSushi","id":456674,"node_id":"MDQ6VXNlcjQ1NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/456674?v=4","gravatar_id":"","url":"https://api.github.com/users/BurntSushi","html_url":"https://github.com/BurntSushi","followers_url":"https://api.github.com/users/BurntSushi/followers","following_url":"https://api.github.com/users/BurntSushi/following{/other_user}","gists_url":"https://api.github.com/users/BurntSushi/gists{/gist_id}","starred_url":"https://api.github.com/users/BurntSushi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BurntSushi/subscriptions","organizations_url":"https://api.github.com/users/BurntSushi/orgs","repos_url":"https://api.github.com/users/BurntSushi/repos","events_url":"https://api.github.com/users/BurntSushi/events{/privacy}","received_events_url":"https://api.github.com/users/BurntSushi/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-08-01T14:39:37Z","updated_at":"2019-08-01T14:39:37Z","body":"> Where does ripgrep can do lot's of memcpy?\r\n\r\nSorry, don't know what you mean. Probably when reading files.\r\n\r\n> Why does ripgrep read 3 bytes at first from files?\r\n\r\nTo check the BOM.","author_association":"OWNER","reactions":{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/517316649/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"BurntSushi","id":456674,"node_id":"MDQ6VXNlcjQ1NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/456674?v=4","gravatar_id":"","url":"https://api.github.com/users/BurntSushi","html_url":"https://github.com/BurntSushi","followers_url":"https://api.github.com/users/BurntSushi/followers","following_url":"https://api.github.com/users/BurntSushi/following{/other_user}","gists_url":"https://api.github.com/users/BurntSushi/gists{/gist_id}","starred_url":"https://api.github.com/users/BurntSushi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BurntSushi/subscriptions","organizations_url":"https://api.github.com/users/BurntSushi/orgs","repos_url":"https://api.github.com/users/BurntSushi/repos","events_url":"https://api.github.com/users/BurntSushi/events{/privacy}","received_events_url":"https://api.github.com/users/BurntSushi/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/517327221","html_url":"https://github.com/BurntSushi/ripgrep/issues/1335#issuecomment-517327221","issue_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/1335","id":517327221,"node_id":"MDEyOklzc3VlQ29tbWVudDUxNzMyNzIyMQ==","user":{"login":"zsugabubus","id":30056345,"node_id":"MDQ6VXNlcjMwMDU2MzQ1","avatar_url":"https://avatars.githubusercontent.com/u/30056345?v=4","gravatar_id":"","url":"https://api.github.com/users/zsugabubus","html_url":"https://github.com/zsugabubus","followers_url":"https://api.github.com/users/zsugabubus/followers","following_url":"https://api.github.com/users/zsugabubus/following{/other_user}","gists_url":"https://api.github.com/users/zsugabubus/gists{/gist_id}","starred_url":"https://api.github.com/users/zsugabubus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zsugabubus/subscriptions","organizations_url":"https://api.github.com/users/zsugabubus/orgs","repos_url":"https://api.github.com/users/zsugabubus/repos","events_url":"https://api.github.com/users/zsugabubus/events{/privacy}","received_events_url":"https://api.github.com/users/zsugabubus/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-08-01T15:04:27Z","updated_at":"2019-08-01T15:04:27Z","body":"> Sorry, don't know what you mean. Probably when reading files.\r\n\r\nFrom perf report it seems like ripgrep does nothing just copies memory all the time.\r\n\r\n> To check the BOM.\r\n\r\nJust because, it shows up as a separate syscall. It means a bunch of syscalls and 0.1s (estimated) in total in my case. Can't a bigger chunk be read?","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/517327221/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"zsugabubus","id":30056345,"node_id":"MDQ6VXNlcjMwMDU2MzQ1","avatar_url":"https://avatars.githubusercontent.com/u/30056345?v=4","gravatar_id":"","url":"https://api.github.com/users/zsugabubus","html_url":"https://github.com/zsugabubus","followers_url":"https://api.github.com/users/zsugabubus/followers","following_url":"https://api.github.com/users/zsugabubus/following{/other_user}","gists_url":"https://api.github.com/users/zsugabubus/gists{/gist_id}","starred_url":"https://api.github.com/users/zsugabubus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zsugabubus/subscriptions","organizations_url":"https://api.github.com/users/zsugabubus/orgs","repos_url":"https://api.github.com/users/zsugabubus/repos","events_url":"https://api.github.com/users/zsugabubus/events{/privacy}","received_events_url":"https://api.github.com/users/zsugabubus/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/517329927","html_url":"https://github.com/BurntSushi/ripgrep/issues/1335#issuecomment-517329927","issue_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/1335","id":517329927,"node_id":"MDEyOklzc3VlQ29tbWVudDUxNzMyOTkyNw==","user":{"login":"BurntSushi","id":456674,"node_id":"MDQ6VXNlcjQ1NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/456674?v=4","gravatar_id":"","url":"https://api.github.com/users/BurntSushi","html_url":"https://github.com/BurntSushi","followers_url":"https://api.github.com/users/BurntSushi/followers","following_url":"https://api.github.com/users/BurntSushi/following{/other_user}","gists_url":"https://api.github.com/users/BurntSushi/gists{/gist_id}","starred_url":"https://api.github.com/users/BurntSushi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BurntSushi/subscriptions","organizations_url":"https://api.github.com/users/BurntSushi/orgs","repos_url":"https://api.github.com/users/BurntSushi/repos","events_url":"https://api.github.com/users/BurntSushi/events{/privacy}","received_events_url":"https://api.github.com/users/BurntSushi/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-08-01T15:11:05Z","updated_at":"2019-08-01T15:11:05Z","body":"I'd have to see it myself.\r\n\r\n> Just because, it shows up as a separate syscall. It means a bunch of syscalls and 0.1s (estimated) in total in my case. Can't a bigger chunk be read?\r\n\r\nThe answers to these types of questions is almost always \"yes.\" But I don't know what the complexities are off the top of my head, nor do I know what the trade-offs are. It would require someone making the change and measuring it.\r\n\r\nI think looking at these micro-optimizations is probably a distraction, and I really just do not have the time or patience to go back and forth about them all the time. I realize you're being super helpful here by trying to diagnose a performance problem, but all I have are guesses and bad theories. The most likely explanation, given that you can reproduce this on other corpora, is that there is something special about your corpus that is provoking some kind of bad behavior in ripgrep.","author_association":"OWNER","reactions":{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/517329927/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"BurntSushi","id":456674,"node_id":"MDQ6VXNlcjQ1NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/456674?v=4","gravatar_id":"","url":"https://api.github.com/users/BurntSushi","html_url":"https://github.com/BurntSushi","followers_url":"https://api.github.com/users/BurntSushi/followers","following_url":"https://api.github.com/users/BurntSushi/following{/other_user}","gists_url":"https://api.github.com/users/BurntSushi/gists{/gist_id}","starred_url":"https://api.github.com/users/BurntSushi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BurntSushi/subscriptions","organizations_url":"https://api.github.com/users/BurntSushi/orgs","repos_url":"https://api.github.com/users/BurntSushi/repos","events_url":"https://api.github.com/users/BurntSushi/events{/privacy}","received_events_url":"https://api.github.com/users/BurntSushi/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/517404090","html_url":"https://github.com/BurntSushi/ripgrep/issues/1335#issuecomment-517404090","issue_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/1335","id":517404090,"node_id":"MDEyOklzc3VlQ29tbWVudDUxNzQwNDA5MA==","user":{"login":"zsugabubus","id":30056345,"node_id":"MDQ6VXNlcjMwMDU2MzQ1","avatar_url":"https://avatars.githubusercontent.com/u/30056345?v=4","gravatar_id":"","url":"https://api.github.com/users/zsugabubus","html_url":"https://github.com/zsugabubus","followers_url":"https://api.github.com/users/zsugabubus/followers","following_url":"https://api.github.com/users/zsugabubus/following{/other_user}","gists_url":"https://api.github.com/users/zsugabubus/gists{/gist_id}","starred_url":"https://api.github.com/users/zsugabubus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zsugabubus/subscriptions","organizations_url":"https://api.github.com/users/zsugabubus/orgs","repos_url":"https://api.github.com/users/zsugabubus/repos","events_url":"https://api.github.com/users/zsugabubus/events{/privacy}","received_events_url":"https://api.github.com/users/zsugabubus/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-08-01T18:25:19Z","updated_at":"2019-08-01T20:42:34Z","body":"I also know that not this causes the slowdown for me, I just thought you would be interested in it. \r\n\r\nAnyway, I'm not sure I understand why 10000 system calls (linear in searched files), that takes up 10% of running time is labeled as micro-optimization.\r\n\r\n---\r\n\r\nI flattened the directories, to exclude my slow directory traversal theory.\r\n* ripgrep still reproduced the issue, with the same times,\r\n* ran ripgrep on files less then `x` size, then files greater than `x` size; the sum of the two running times didn't match (was less) the needed time for ripgrepping all files,\r\n* grep always overperformed ripgrep in the previous tests, so I thought that really there are files that hard for ripgrep,\r\n* so I run ripgrep and grep on each file in a for loop; result: nothing curious.\r\n\r\nThe last thing I can think is:\r\n```\r\n    88.76%    88.76%  rg       libc-2.29.so        [.] __memmove_sse2_unaligned_erms\r\n+   88.76%     0.00%  rg       libc-2.29.so        [.] __memcpy_sse2_unaligned_erms (inlined)\r\n+   88.38%     0.00%  rg       rg                  [.] 0x00005557c69de13c\r\n     0.45%     0.00%  rg       libc-2.29.so        [.] __GI___libc_realloc (inlined)\r\n```","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/517404090/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"zsugabubus","id":30056345,"node_id":"MDQ6VXNlcjMwMDU2MzQ1","avatar_url":"https://avatars.githubusercontent.com/u/30056345?v=4","gravatar_id":"","url":"https://api.github.com/users/zsugabubus","html_url":"https://github.com/zsugabubus","followers_url":"https://api.github.com/users/zsugabubus/followers","following_url":"https://api.github.com/users/zsugabubus/following{/other_user}","gists_url":"https://api.github.com/users/zsugabubus/gists{/gist_id}","starred_url":"https://api.github.com/users/zsugabubus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zsugabubus/subscriptions","organizations_url":"https://api.github.com/users/zsugabubus/orgs","repos_url":"https://api.github.com/users/zsugabubus/repos","events_url":"https://api.github.com/users/zsugabubus/events{/privacy}","received_events_url":"https://api.github.com/users/zsugabubus/received_events","type":"User","user_view_type":"public","site_admin":false}}]