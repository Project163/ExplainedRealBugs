{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/1860","repository_url":"https://api.github.com/repos/BurntSushi/ripgrep","labels_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/1860/labels{/name}","comments_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/1860/comments","events_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/1860/events","html_url":"https://github.com/BurntSushi/ripgrep/issues/1860","id":873527442,"node_id":"MDU6SXNzdWU4NzM1Mjc0NDI=","number":1860,"title":"Slower search with combination word boundary and multiple regex on certain files","user":{"login":"ethack","id":1696711,"node_id":"MDQ6VXNlcjE2OTY3MTE=","avatar_url":"https://avatars.githubusercontent.com/u/1696711?v=4","gravatar_id":"","url":"https://api.github.com/users/ethack","html_url":"https://github.com/ethack","followers_url":"https://api.github.com/users/ethack/followers","following_url":"https://api.github.com/users/ethack/following{/other_user}","gists_url":"https://api.github.com/users/ethack/gists{/gist_id}","starred_url":"https://api.github.com/users/ethack/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ethack/subscriptions","organizations_url":"https://api.github.com/users/ethack/orgs","repos_url":"https://api.github.com/users/ethack/repos","events_url":"https://api.github.com/users/ethack/events{/privacy}","received_events_url":"https://api.github.com/users/ethack/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2021-05-01T04:14:22Z","updated_at":"2021-05-02T03:21:40Z","closed_at":"2021-05-01T11:45:57Z","author_association":"NONE","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"#### What version of ripgrep are you using?\r\n\r\n```bash\r\nrg --version\r\nripgrep 12.1.1\r\n-SIMD -AVX (compiled)\r\n+SIMD +AVX (runtime)\r\n```\r\n\r\n#### How did you install ripgrep?\r\n\r\n```\r\napt-get -y install ripgrep\r\n```\r\n\r\n#### What operating system are you using ripgrep on?\r\n\r\nRipgrep is inside a docker container.\r\nHost: Pop!_OS 20.04 (Ubuntu 20.04 variant)\r\nContainer: Ubuntu 21.04 Hirsute\r\nKernel:\r\n```\r\nuname -mr\r\n5.11.0-7614-generic x86_64\r\n```\r\n\r\n#### Describe your bug.\r\n\r\nThis may be a duplicate or related to #1760. I am getting much slower execution time when using word boundaries `\\b` in a regex. The search performance is:\r\n- Fast with a `\\b` search pattern.\r\n- Slow with a `\\b` search pattern plus an additional pattern.\r\n- Fast with a `\\b` search pattern plus an additional pattern when `--no-unicode` is used.\r\n- Fast with a `\\b` search pattern plus an additional pattern on a differently formatted file (TSV vs JSON).\r\n\r\n#### What are the steps to reproduce the behavior?\r\n\r\nHere are the two files which can be used to reproduce the issue.\r\n[conn.json.log](https://github.com/BurntSushi/ripgrep/files/6408803/conn.json.log)\r\n[conn.tsv.log](https://github.com/BurntSushi/ripgrep/files/6408805/conn.tsv.log)\r\n\r\nThese are [Zeek](https://zeek.org/) conn log files that contain the same information but in different formats. `conn.tsv.log` is tab-separated and was converted to JSON to generate `conn.json.log`. The files I uploaded are the `head -1000` of two larger files. I can provide the larger logs if they would be useful.\r\n\r\n```\r\n# original larger logs\r\ndu -h conn.tsv.log\r\n54M conn.tsv.log\r\nwc -l conn.tsv.log\r\n455545 conn.tsv.log\r\n\r\ndu -h conn.json.log\r\n150M\tconn.json.log\r\nwc -l conn.json.log\r\n455536 conn.json.log\r\n```\r\n\r\nThe `time` command differences are very small with the files I uploaded, but I'll also provide [hyperfine](https://github.com/sharkdp/hyperfine) output for both the full logs and the ones I uploaded.\r\n\r\n#### What is the actual behavior?\r\n\r\nThe following timings are on the larger logs.\r\n\r\nWhen I use a regex for an IP address, the search time is very small (<1s).\r\n```\r\n$ time rg -e '\\b10\\.55\\.182\\.100\\b' conn.json.log >/dev/null\r\nrg -e '\\b10\\.55\\.182\\.100\\b' conn.json.log > /dev/null  0.73s user 0.16s system 381% cpu 0.231 total\r\n```\r\n\r\nWhen I add an additional regex, the search time is long (>30sec).\r\n```\r\n$ time rg -e '^#' -e '\\b10\\.55\\.182\\.100\\b' conn.json.log >/dev/null\r\nrg -e '^#' -e '\\b10\\.55\\.182\\.100\\b' conn.json.log > /dev/null  151.99s user 1.41s system 401% cpu 38.231 total\r\n```\r\n\r\nIf I add `--no-unicode`, the search time drops back down (<1s).\r\n```\r\n$ time rg --no-unicode -e '^#' -e '\\b10\\.55\\.182\\.100\\b' conn.json.log >/dev/null\r\nrg --no-unicode -e '^#' -e '\\b10\\.55\\.182\\.100\\b' conn.json.log > /dev/null  0.28s user 0.01s system 98% cpu 0.300 total\r\n```\r\n\r\nThis next part puzzles me even more. Recall that the TSV file was used to generate the JSON file. I know these aren't the same and are quite different file sizes. But it's not like a bunch of non-ASCII characters got added to one file and not the other. If I run the command from the JSON file that caused the long search time on the TSV, the search time is short (<1s).\r\n```\r\n$ time rg -e '^#' -e '\\b10\\.55\\.182\\.100\\b' conn.tsv.log >/dev/null\r\nrg -e '^#' -e '\\b10\\.55\\.182\\.100\\b' conn.tsv.log > /dev/null  0.12s user 0.01s system 99% cpu 0.131 total\r\n```\r\n\r\nHere are hyperfine results that compare the last three commands, along with using `--no-unicode` on the TSV file for good measure.\r\n\r\n```\r\n$ hyperfine -w 1 -i \\\r\n  -n tsv-unicode \"rg -e '^#' -e '\\b10\\.55\\.182\\.100\\b' conn.tsv.log\" \\\r\n  -n tsv-no-unicode \"rg --no-unicode -e '^#' -e '\\b10\\.55\\.182\\.100\\b' conn.tsv.log\" \\\r\n  -n json-unicode \"rg -e '^#' -e '\\b10\\.55\\.182\\.100\\b' conn.json.log\" \\\r\n  -n json-no-unicode \"rg --no-unicode -e '^#' -e '\\b10\\.55\\.182\\.100\\b' conn.json.log\"\r\n\r\nBenchmark #1: tsv-unicode\r\n  Time (mean ± σ):     150.1 ms ±   7.5 ms    [User: 531.0 ms, System: 54.8 ms]\r\n  Range (min … max):   133.6 ms … 166.4 ms    22 runs\r\n \r\nBenchmark #2: tsv-no-unicode\r\n  Time (mean ± σ):     156.6 ms ±   8.9 ms    [User: 559.2 ms, System: 57.2 ms]\r\n  Range (min … max):   144.6 ms … 188.8 ms    19 runs\r\n \r\nBenchmark #3: json-unicode\r\n  Time (mean ± σ):     46.889 s ±  1.209 s    [User: 187.340 s, System: 1.998 s]\r\n  Range (min … max):   45.547 s … 49.531 s    10 runs\r\n \r\nBenchmark #4: json-no-unicode\r\n  Time (mean ± σ):     508.9 ms ±  20.1 ms    [User: 1.863 s, System: 0.186 s]\r\n  Range (min … max):   462.8 ms … 531.0 ms    10 runs\r\n \r\nSummary\r\n  'tsv-unicode' ran\r\n    1.04 ± 0.08 times faster than 'tsv-no-unicode'\r\n    3.39 ± 0.22 times faster than 'json-no-unicode'\r\n  312.32 ± 17.55 times faster than 'json-unicode'\r\n```\r\n\r\nAnd here are hyperfine results with nearly the same commands on the smaller files provided, just to show that the same differences can be seen.\r\n\r\n```\r\n$ hyperfine -w 1 \\\r\n  -n rg-tsv \"rg -e '^#' -e '\\b10\\.55\\.182\\.100\\b' conn.tsv.log | wc -l\" \\\r\n  -n rg-json \"rg -e '^#' -e '\\b10\\.55\\.182\\.100\\b' conn.json.log | wc -l\" \\\r\n  -n rg-json-no-unicode \"rg --no-unicode -e '^#' -e '\\b10\\.55\\.182\\.100\\b' conn.json.log | wc -l\"\r\n\r\nBenchmark #1: rg-tsv\r\n  Time (mean ± σ):       5.0 ms ±   2.0 ms    [User: 4.0 ms, System: 1.7 ms]\r\n  Range (min … max):     2.8 ms …  11.6 ms    866 runs\r\n \r\n  Warning: Command took less than 5 ms to complete. Results might be inaccurate.\r\n \r\nBenchmark #2: rg-json\r\n  Time (mean ± σ):      59.8 ms ±   5.6 ms    [User: 58.6 ms, System: 1.6 ms]\r\n  Range (min … max):    51.5 ms …  70.9 ms    50 runs\r\n \r\nBenchmark #3: rg-json-no-unicode\r\n  Time (mean ± σ):       6.0 ms ±   2.1 ms    [User: 4.8 ms, System: 2.0 ms]\r\n  Range (min … max):     3.1 ms …  11.7 ms    775 runs\r\n \r\n  Warning: Command took less than 5 ms to complete. Results might be inaccurate.\r\n \r\nSummary\r\n  'rg-tsv' ran\r\n    1.20 ± 0.63 times faster than 'rg-json-no-unicode'\r\n   11.89 ± 4.76 times faster than 'rg-json'\r\n```\r\n\r\nHere are several debug outputs.\r\n\r\nFast (one search pattern):\r\n```\r\n$ rg --debug  -e '\\b10\\.55\\.182\\.100\\b' conn.json.log >/dev/null         \r\nDEBUG|grep_regex::literal|/usr/share/cargo/registry/ripgrep-12.1.1/debian/cargo_registry/grep-regex-0.1.8/src/literal.rs:180: required literal found: \"10.55.182.100\"\r\nDEBUG|grep_regex::matcher|/usr/share/cargo/registry/ripgrep-12.1.1/debian/cargo_registry/grep-regex-0.1.8/src/matcher.rs:50: extracted fast line regex: (?-u:10\\x2e55\\x2e182\\x2e100)\r\nDEBUG|globset|/usr/share/cargo/registry/ripgrep-12.1.1/debian/cargo_registry/globset-0.4.5/src/lib.rs:431: built glob set; 0 literals, 0 basenames, 12 extensions, 0 prefixes, 0 suffixes, 0 required extensions, 0 regexes\r\n```\r\n\r\nSlow (two search patterns):\r\n```\r\n$ rg --debug -e '^#' -e '\\b10\\.55\\.182\\.100\\b' conn.json.log >/dev/null\r\nDEBUG|globset|/usr/share/cargo/registry/ripgrep-12.1.1/debian/cargo_registry/globset-0.4.5/src/lib.rs:431: built glob set; 0 literals, 0 basenames, 12 extensions, 0 prefixes, 0 suffixes, 0 required extensions, 0 regexes\r\n```\r\n\r\nFast (two search patterns, --no-unicode):\r\n```\r\n$ rg --debug --no-unicode -e '^#' -e '\\b10\\.55\\.182\\.100\\b' conn.json.log >/dev/null\r\nDEBUG|globset|/usr/share/cargo/registry/ripgrep-12.1.1/debian/cargo_registry/globset-0.4.5/src/lib.rs:431: built glob set; 0 literals, 0 basenames, 12 extensions, 0 prefixes, 0 suffixes, 0 required extensions, 0 regexes\r\n```\r\n\r\nFast (two search patterns, TSV):\r\n```\r\n$ rg --debug -e '^#' -e '\\b10\\.55\\.182\\.100\\b' conn.tsv.log >/dev/null             \r\nDEBUG|globset|/usr/share/cargo/registry/ripgrep-12.1.1/debian/cargo_registry/globset-0.4.5/src/lib.rs:431: built glob set; 0 literals, 0 basenames, 12 extensions, 0 prefixes, 0 suffixes, 0 required extensions, 0 regexes\r\n```\r\n\r\nFast (two search patterns, no word boundaries):\r\n```\r\n$ rg --debug -e '^#' -e '10\\.55\\.182\\.100' conn.json.log >/dev/null\r\nDEBUG|globset|/usr/share/cargo/registry/ripgrep-12.1.1/debian/cargo_registry/globset-0.4.5/src/lib.rs:431: built glob set; 0 literals, 0 basenames, 12 extensions, 0 prefixes, 0 suffixes, 0 required extensions, 0 regexes\r\n```\r\n\r\n#### What is the expected behavior?\r\n\r\nIdeally, I'd like the slow search to take roughly the same time as the other fast searches.\r\n\r\nI understand from #1760 that word boundaries with Unicode is a slow process. But if that's the case here, I wonder why the same search on a different file can be so much faster?","closed_by":{"login":"BurntSushi","id":456674,"node_id":"MDQ6VXNlcjQ1NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/456674?v=4","gravatar_id":"","url":"https://api.github.com/users/BurntSushi","html_url":"https://github.com/BurntSushi","followers_url":"https://api.github.com/users/BurntSushi/followers","following_url":"https://api.github.com/users/BurntSushi/following{/other_user}","gists_url":"https://api.github.com/users/BurntSushi/gists{/gist_id}","starred_url":"https://api.github.com/users/BurntSushi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BurntSushi/subscriptions","organizations_url":"https://api.github.com/users/BurntSushi/orgs","repos_url":"https://api.github.com/users/BurntSushi/repos","events_url":"https://api.github.com/users/BurntSushi/events{/privacy}","received_events_url":"https://api.github.com/users/BurntSushi/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/1860/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/1860/timeline","performed_via_github_app":null,"state_reason":"completed"}