{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/1638","repository_url":"https://api.github.com/repos/BurntSushi/ripgrep","labels_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/1638/labels{/name}","comments_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/1638/comments","events_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/1638/events","html_url":"https://github.com/BurntSushi/ripgrep/issues/1638","id":653235860,"node_id":"MDU6SXNzdWU2NTMyMzU4NjA=","number":1638,"title":"BOMs are not stripped consistently in --json output","user":{"login":"acheronfail","id":34289614,"node_id":"MDQ6VXNlcjM0Mjg5NjE0","avatar_url":"https://avatars.githubusercontent.com/u/34289614?v=4","gravatar_id":"","url":"https://api.github.com/users/acheronfail","html_url":"https://github.com/acheronfail","followers_url":"https://api.github.com/users/acheronfail/followers","following_url":"https://api.github.com/users/acheronfail/following{/other_user}","gists_url":"https://api.github.com/users/acheronfail/gists{/gist_id}","starred_url":"https://api.github.com/users/acheronfail/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/acheronfail/subscriptions","organizations_url":"https://api.github.com/users/acheronfail/orgs","repos_url":"https://api.github.com/users/acheronfail/repos","events_url":"https://api.github.com/users/acheronfail/events{/privacy}","received_events_url":"https://api.github.com/users/acheronfail/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":339721678,"node_id":"MDU6TGFiZWwzMzk3MjE2Nzg=","url":"https://api.github.com/repos/BurntSushi/ripgrep/labels/bug","name":"bug","color":"fc2929","default":true,"description":"A bug."},{"id":1849506066,"node_id":"MDU6TGFiZWwxODQ5NTA2MDY2","url":"https://api.github.com/repos/BurntSushi/ripgrep/labels/rollup","name":"rollup","color":"ffccee","default":false,"description":"A PR that has been merged with many others in a rollup."}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2020-07-08T11:54:22Z","updated_at":"2021-06-01T01:51:24Z","closed_at":"2021-06-01T01:51:24Z","author_association":"NONE","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"#### What version of ripgrep are you using?\r\n\r\n```\r\nripgrep 12.0.1\r\n-SIMD -AVX (compiled)\r\n+SIMD +AVX (runtime)\r\n```\r\n\r\n#### How did you install ripgrep?\r\n\r\n```\r\ncargo install ripgrep\r\n```\r\n\r\n#### What operating system are you using ripgrep on?\r\n\r\n```\r\nArch Linux 5.7.6\r\n```\r\n\r\n#### Describe your bug.\r\n\r\nWhen using ripgrep's `--json` flag on a file encoded as \"UTF 8 with BOM\" the BOM is not accounted for (as opposed to other encodings, such as UTF 16).\r\n\r\n#### What are the steps to reproduce the behavior?\r\n\r\nUTF8\r\n\r\n```bash\r\n# Create a UTF8 encoded file (without BOM)\r\nprintf \"\\x66\\x6f\\x6f\" > utf8\r\n# Run ripgrep\r\nrg foo ./utf8 --json\r\n```\r\n\r\nUTF8 BOM\r\n\r\n```bash\r\n# Create a UTF8 encoded file (with BOM)\r\nprintf \"\\xef\\xbb\\xbf\\x66\\x6f\\x6f\" > utf8bom\r\n# Run ripgrep\r\nrg foo ./utf8bom --json\r\n```\r\n\r\nUTF16\r\n\r\n```bash\r\n# Create a UTF16 encoded file (has BOM)\r\nprintf \"\\xff\\xfe\\x66\\x00\\x6f\\x00\\x6f\\x00\" > utf16\r\n# Run ripgrep\r\nrg foo ./utf16 --json\r\n```\r\n\r\n#### What is the actual behavior?\r\n\r\nHere is the JSON output for the above three code blocks.\r\n\r\nUTF8\r\n\r\n```\r\n{\"type\":\"begin\",\"data\":{\"path\":{\"text\":\"./utf8\"}}}\r\n{\"type\":\"match\",\"data\":{\"path\":{\"text\":\"./utf8\"},\"lines\":{\"text\":\"foo\"},\"line_number\":1,\"absolute_offset\":0,\"submatches\":[{\"match\":{\"text\":\"foo\"},\"start\":0,\"end\":3}]}}\r\n{\"type\":\"end\",\"data\":{\"path\":{\"text\":\"./utf8\"},\"binary_offset\":null,\"stats\":{\"elapsed\":{\"secs\":0,\"nanos\":42600,\"human\":\"0.000043s\"},\"searches\":1,\"searches_with_match\":1,\"bytes_searched\":3,\"bytes_printed\":219,\"matched_lines\":1,\"matches\":1}}}\r\n{\"data\":{\"elapsed_total\":{\"human\":\"0.007219s\",\"nanos\":7218625,\"secs\":0},\"stats\":{\"bytes_printed\":219,\"bytes_searched\":3,\"elapsed\":{\"human\":\"0.000043s\",\"nanos\":42600,\"secs\":0},\"matched_lines\":1,\"matches\":1,\"searches\":1,\"searches_with_match\":1}},\"type\":\"summary\"}\r\n```\r\n\r\nUTF8 BOM\r\n\r\n```\r\n{\"type\":\"begin\",\"data\":{\"path\":{\"text\":\"./utf8bom\"}}}\r\n{\"type\":\"match\",\"data\":{\"path\":{\"text\":\"./utf8bom\"},\"lines\":{\"text\":\"ï»¿foo\"},\"line_number\":1,\"absolute_offset\":0,\"submatches\":[{\"match\":{\"text\":\"foo\"},\"start\":3,\"end\":6}]}}\r\n{\"type\":\"end\",\"data\":{\"path\":{\"text\":\"./utf8bom\"},\"binary_offset\":null,\"stats\":{\"elapsed\":{\"secs\":0,\"nanos\":47766,\"human\":\"0.000048s\"},\"searches\":1,\"searches_with_match\":1,\"bytes_searched\":6,\"bytes_printed\":228,\"matched_lines\":1,\"matches\":1}}}\r\n{\"data\":{\"elapsed_total\":{\"human\":\"0.007849s\",\"nanos\":7849144,\"secs\":0},\"stats\":{\"bytes_printed\":228,\"bytes_searched\":6,\"elapsed\":{\"human\":\"0.000048s\",\"nanos\":47766,\"secs\":0},\"matched_lines\":1,\"matches\":1,\"searches\":1,\"searches_with_match\":1}},\"type\":\"summary\"}\r\n```\r\n\r\nUTF16\r\n\r\n```\r\n{\"type\":\"begin\",\"data\":{\"path\":{\"text\":\"./utf16\"}}}\r\n{\"type\":\"match\",\"data\":{\"path\":{\"text\":\"./utf16\"},\"lines\":{\"text\":\"foo\"},\"line_number\":1,\"absolute_offset\":0,\"submatches\":[{\"match\":{\"text\":\"foo\"},\"start\":0,\"end\":3}]}}\r\n{\"type\":\"end\",\"data\":{\"path\":{\"text\":\"./utf16\"},\"binary_offset\":null,\"stats\":{\"elapsed\":{\"secs\":0,\"nanos\":43947,\"human\":\"0.000044s\"},\"searches\":1,\"searches_with_match\":1,\"bytes_searched\":3,\"bytes_printed\":221,\"matched_lines\":1,\"matches\":1}}}\r\n{\"data\":{\"elapsed_total\":{\"human\":\"0.006400s\",\"nanos\":6399559,\"secs\":0},\"stats\":{\"bytes_printed\":221,\"bytes_searched\":3,\"elapsed\":{\"human\":\"0.000044s\",\"nanos\":43947,\"secs\":0},\"matched_lines\":1,\"matches\":1,\"searches\":1,\"searches_with_match\":1}},\"type\":\"summary\"}\r\n```\r\n\r\n#### What is the expected behavior?\r\n\r\nI personally expected that ripgrep would strip the UTF8 BOM from the JSON report since that's what it does for UTF16 encodings. However, I'm not sure if this should be the case or not, considering that a UTF8 BOM is an optional file header.\r\n","closed_by":{"login":"BurntSushi","id":456674,"node_id":"MDQ6VXNlcjQ1NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/456674?v=4","gravatar_id":"","url":"https://api.github.com/users/BurntSushi","html_url":"https://github.com/BurntSushi","followers_url":"https://api.github.com/users/BurntSushi/followers","following_url":"https://api.github.com/users/BurntSushi/following{/other_user}","gists_url":"https://api.github.com/users/BurntSushi/gists{/gist_id}","starred_url":"https://api.github.com/users/BurntSushi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BurntSushi/subscriptions","organizations_url":"https://api.github.com/users/BurntSushi/orgs","repos_url":"https://api.github.com/users/BurntSushi/repos","events_url":"https://api.github.com/users/BurntSushi/events{/privacy}","received_events_url":"https://api.github.com/users/BurntSushi/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/1638/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/1638/timeline","performed_via_github_app":null,"state_reason":"completed"}