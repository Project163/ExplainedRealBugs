[{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/360454750","html_url":"https://github.com/BurntSushi/ripgrep/issues/760#issuecomment-360454750","issue_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/760","id":360454750,"node_id":"MDEyOklzc3VlQ29tbWVudDM2MDQ1NDc1MA==","user":{"login":"BurntSushi","id":456674,"node_id":"MDQ6VXNlcjQ1NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/456674?v=4","gravatar_id":"","url":"https://api.github.com/users/BurntSushi","html_url":"https://github.com/BurntSushi","followers_url":"https://api.github.com/users/BurntSushi/followers","following_url":"https://api.github.com/users/BurntSushi/following{/other_user}","gists_url":"https://api.github.com/users/BurntSushi/gists{/gist_id}","starred_url":"https://api.github.com/users/BurntSushi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BurntSushi/subscriptions","organizations_url":"https://api.github.com/users/BurntSushi/orgs","repos_url":"https://api.github.com/users/BurntSushi/repos","events_url":"https://api.github.com/users/BurntSushi/events{/privacy}","received_events_url":"https://api.github.com/users/BurntSushi/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-01-25T12:37:25Z","updated_at":"2018-01-25T12:37:25Z","body":"Thanks for the report! This is definitely because of memory mapping. The reason why you're seeing inconsistencies is because memory mapping is enabled by default using heuristics. e.g., If you search a directory, it's always disabled. But if you search a small number of single files, then it's generally enabled.\r\n\r\nThere is indeed a special case where memory mapping these sorts of files doesn't work. Currently, [ripgrep detects this by asking the file size](https://github.com/BurntSushi/ripgrep/blob/35f802166d1c5788e8c833f398d13b9c9e8cb360/src/worker.rs#L285-L292). If the size is 0, then it always uses standard `read` calls instead of memory maps. Interestingly, it looks like these files do not report a size of `0`:\r\n\r\n```\r\n$ stat /sys/devices/system/cpu/vulnerabilities/meltdown \r\n  File: /sys/devices/system/cpu/vulnerabilities/meltdown\r\n  Size: 4096            Blocks: 0          IO Block: 4096   regular file\r\nDevice: 13h/19d Inode: 57          Links: 1\r\nAccess: (0444/-r--r--r--)  Uid: (    0/    root)   Gid: (    0/    root)\r\nAccess: 2018-01-25 07:29:47.883246649 -0500\r\nModify: 2018-01-25 07:29:47.883246649 -0500\r\nChange: 2018-01-25 07:29:47.883246649 -0500\r\n Birth: -\r\n```\r\n\r\nI confess that my file size trick was not informed by what the OS purports to guarantee, but rather, it was informed by observed behavior. It looks like it doesn't work in this case.\r\n\r\nI suppose the fix to this is to look at the error returned by opening a memory map, and if it's a \"no such device\" error, then perhaps we should fallback to normal `read` calls.","author_association":"OWNER","reactions":{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/360454750/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"BurntSushi","id":456674,"node_id":"MDQ6VXNlcjQ1NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/456674?v=4","gravatar_id":"","url":"https://api.github.com/users/BurntSushi","html_url":"https://github.com/BurntSushi","followers_url":"https://api.github.com/users/BurntSushi/followers","following_url":"https://api.github.com/users/BurntSushi/following{/other_user}","gists_url":"https://api.github.com/users/BurntSushi/gists{/gist_id}","starred_url":"https://api.github.com/users/BurntSushi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BurntSushi/subscriptions","organizations_url":"https://api.github.com/users/BurntSushi/orgs","repos_url":"https://api.github.com/users/BurntSushi/repos","events_url":"https://api.github.com/users/BurntSushi/events{/privacy}","received_events_url":"https://api.github.com/users/BurntSushi/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":1441544566,"node_id":"MDEyOkxhYmVsZWRFdmVudDE0NDE1NDQ1NjY=","url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/events/1441544566","actor":{"login":"BurntSushi","id":456674,"node_id":"MDQ6VXNlcjQ1NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/456674?v=4","gravatar_id":"","url":"https://api.github.com/users/BurntSushi","html_url":"https://github.com/BurntSushi","followers_url":"https://api.github.com/users/BurntSushi/followers","following_url":"https://api.github.com/users/BurntSushi/following{/other_user}","gists_url":"https://api.github.com/users/BurntSushi/gists{/gist_id}","starred_url":"https://api.github.com/users/BurntSushi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BurntSushi/subscriptions","organizations_url":"https://api.github.com/users/BurntSushi/orgs","repos_url":"https://api.github.com/users/BurntSushi/repos","events_url":"https://api.github.com/users/BurntSushi/events{/privacy}","received_events_url":"https://api.github.com/users/BurntSushi/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2018-01-25T12:37:32Z","label":{"name":"bug","color":"fc2929"},"performed_via_github_app":null},{"id":1451969998,"node_id":"MDExOkNsb3NlZEV2ZW50MTQ1MTk2OTk5OA==","url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/events/1451969998","actor":{"login":"BurntSushi","id":456674,"node_id":"MDQ6VXNlcjQ1NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/456674?v=4","gravatar_id":"","url":"https://api.github.com/users/BurntSushi","html_url":"https://github.com/BurntSushi","followers_url":"https://api.github.com/users/BurntSushi/followers","following_url":"https://api.github.com/users/BurntSushi/following{/other_user}","gists_url":"https://api.github.com/users/BurntSushi/gists{/gist_id}","starred_url":"https://api.github.com/users/BurntSushi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BurntSushi/subscriptions","organizations_url":"https://api.github.com/users/BurntSushi/orgs","repos_url":"https://api.github.com/users/BurntSushi/repos","events_url":"https://api.github.com/users/BurntSushi/events{/privacy}","received_events_url":"https://api.github.com/users/BurntSushi/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"closed","commit_id":"93943793c314e0566ed57d7c0642c3b818c76c50","commit_url":"https://api.github.com/repos/BurntSushi/ripgrep/commits/93943793c314e0566ed57d7c0642c3b818c76c50","created_at":"2018-02-01T00:20:49Z","state_reason":null,"performed_via_github_app":null}]