{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/2750","repository_url":"https://api.github.com/repos/BurntSushi/ripgrep","labels_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/2750/labels{/name}","comments_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/2750/comments","events_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/2750/events","html_url":"https://github.com/BurntSushi/ripgrep/issues/2750","id":2175024055,"node_id":"I_kwDOAzJbyc6BpDu3","number":2750,"title":"rg allocates too much memory with: `rg --files --ignore-file ~/.ultimate-gitignore`","user":{"login":"wis","id":9993663,"node_id":"MDQ6VXNlcjk5OTM2NjM=","avatar_url":"https://avatars.githubusercontent.com/u/9993663?v=4","gravatar_id":"","url":"https://api.github.com/users/wis","html_url":"https://github.com/wis","followers_url":"https://api.github.com/users/wis/followers","following_url":"https://api.github.com/users/wis/following{/other_user}","gists_url":"https://api.github.com/users/wis/gists{/gist_id}","starred_url":"https://api.github.com/users/wis/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wis/subscriptions","organizations_url":"https://api.github.com/users/wis/orgs","repos_url":"https://api.github.com/users/wis/repos","events_url":"https://api.github.com/users/wis/events{/privacy}","received_events_url":"https://api.github.com/users/wis/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":339721678,"node_id":"MDU6TGFiZWwzMzk3MjE2Nzg=","url":"https://api.github.com/repos/BurntSushi/ripgrep/labels/bug","name":"bug","color":"fc2929","default":true,"description":"A bug."},{"id":1849506066,"node_id":"MDU6TGFiZWwxODQ5NTA2MDY2","url":"https://api.github.com/repos/BurntSushi/ripgrep/labels/rollup","name":"rollup","color":"ffccee","default":false,"description":"A PR that has been merged with many others in a rollup."}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2024-03-07T23:49:03Z","updated_at":"2025-10-11T00:13:32Z","closed_at":"2025-10-11T00:13:32Z","author_association":"NONE","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Please tick this box to confirm you have reviewed the above.\r\n\r\n- [X] I have a different issue.\r\n\r\n### What version of ripgrep are you using?\r\n\r\n```\r\nripgrep 14.1.0\r\n\r\nfeatures:-simd-accel,+pcre2\r\nsimd(compile):+SSE2,-SSSE3,-AVX2\r\nsimd(runtime):+SSE2,+SSSE3,+AVX2\r\n\r\nPCRE2 10.42 is available (JIT is available)\r\n```\r\n\r\n### How did you install ripgrep?\r\n\r\n`sudo pacman -S ripgrep` (Arch Linux package manager)\r\n\r\n### What operating system are you using ripgrep on?\r\n\r\nArch Linux on WSL2\r\n```\r\nsh uname -a\r\nLinux my-hostname 5.15.146.1-microsoft-standard-WSL2 #1 SMP Thu Jan 11 04:09:03 UTC 2024 x86_64 GNU/Linux\r\n```\r\n\r\n### Describe your bug.\r\n\r\nripgrep process uses 7.1 Gibibytes of memory and is *really* slow (before getting killed by OS for allocating too much RAM),\r\nwhen you run `rg --files --ignore-file ~/.ultimate-gitignore`, and `.ultimate-gitignore`  being a big/huge .[gitignore file](https://github.com/BurntSushi/ripgrep/files/14531210/default.ultimate-gitignore.txt), with 16332 lines (304KB), 9298 entries (or lines [with empty lines and comments are removed](https://github.com/BurntSushi/ripgrep/files/14531205/default.ultimate-gitignore-entries-only.txt))\r\n\r\nthis \"Ultimate .gitignore\" file is created by running `cat * > .ultimate-gitignore` in this directory [github.com/toptal/gitignore/templates](https://github.com/toptal/gitignore/tree/0a7fb01801c62ca53ab2dcd73ab96185e159e864/templates)\r\n\r\n### What are the steps to reproduce the behavior?\r\n\r\n> If the corpus is too big and you cannot decrease its size, file the bug anyway and the ripgrep maintainers will help figure out next steps.\r\n\r\nNope, the corpus is not too big, it is only 2 files and a .git directory, I made sure to test it on a small corpus but my original use case was to use this command anywhere on disk, e.g. the `$HOME` directory \r\n\r\nYou can download these 2 files and .git directory by cloning this repo: [wis/killall-for-Windows](https://github.com/wis/killall-for-Windows/tree/92e3296b1292731cc17c62005e651024f47662ba/)\r\n\r\nand again, the command is: `rg --files --ignore-file ~/.ultimate-gitignore`\r\n\r\n### What is the actual behavior?\r\n\r\ncommand:\r\n```\r\nrg --files --ignore-file ~/.ultimate-gitignore\r\n```\r\n\r\noutput:\r\n```\r\nkillall.c\r\nzsh: killed     rg --files --ignore-file ~/.gitignore\r\n```\r\n\r\nThe command runs for 10 seconds and the process allocates 7.1 Gibibytes and has on average 50% CPU usage/utilization.\r\n\r\n### What is the expected behavior?\r\n\r\nList all the files in the current directory, excluding the ones that match the patterns in the `.ultimate-gitignore` file \r\n\r\nEDIT: I tried using `fd`, as Andrew [recommends here](https://github.com/BurntSushi/ripgrep/issues/2314#issuecomment-1261317817): \r\n> You could also use a purpose driven tool specifically for searching by file name: https://github.com/sharkdp/fd/\r\n\r\nbut it also suffers from the same issue, the process allocates too much memory and gets killed by the OS.\r\n\r\nI am starting to think this issue is fundamentally unfixable, given the nature of ripgrep's (and fd's) implementation, \r\nI don't think you can \"load\" and compile this much patterns into memory and have this grantee by the regex crate:\r\n> This implementation uses finite automata and guarantees linear time matching on all inputs.\r\n\r\nIt's either ripgrep uses, or keeps using this fast regex implementation, which seems to me to trade off memory for speed,\r\nor it's either ripgrep would be able to run this command, or a command that has this many patterns.\r\nIt's like:\r\n1. fast ripgrep (pattern matching)\r\n2. able to run this command\r\nâ€”pick one\r\n\r\nEDIT2: I read the section on memory in the manpage, as recommended by Andrew [in this comment here](https://github.com/BurntSushi/ripgrep/issues/1553#issuecomment-615189031):\r\n> There are cases where ripgrep may use a lot of memory. They are documented in the man page. Please consult those to see if they match your use case.\r\n\r\n...and I then ran the command above with the `-j1` flag, as recommended in the manpage, \r\nthe command worked, it finished and exited sucessfully, but it was *quite* slow, even on a directory as small as the one mentioned above, with 2 files and 1 directory in it.\r\nthe command took 0.9 seconds to finish, on average, whereas `rg --files` takes 0.025 seconds (25 milliseconds) to finish, on average.","closed_by":{"login":"BurntSushi","id":456674,"node_id":"MDQ6VXNlcjQ1NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/456674?v=4","gravatar_id":"","url":"https://api.github.com/users/BurntSushi","html_url":"https://github.com/BurntSushi","followers_url":"https://api.github.com/users/BurntSushi/followers","following_url":"https://api.github.com/users/BurntSushi/following{/other_user}","gists_url":"https://api.github.com/users/BurntSushi/gists{/gist_id}","starred_url":"https://api.github.com/users/BurntSushi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BurntSushi/subscriptions","organizations_url":"https://api.github.com/users/BurntSushi/orgs","repos_url":"https://api.github.com/users/BurntSushi/repos","events_url":"https://api.github.com/users/BurntSushi/events{/privacy}","received_events_url":"https://api.github.com/users/BurntSushi/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/2750/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/2750/timeline","performed_via_github_app":null,"state_reason":"completed"}