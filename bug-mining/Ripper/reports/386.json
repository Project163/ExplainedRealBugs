{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/2122","repository_url":"https://api.github.com/repos/BurntSushi/ripgrep","labels_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/2122/labels{/name}","comments_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/2122/comments","events_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/2122/events","html_url":"https://github.com/BurntSushi/ripgrep/issues/2122","id":1099501409,"node_id":"I_kwDOAzJbyc5BiQ9h","number":2122,"title":"Reading fifo: Output is buffered until fifo writer closes","user":{"login":"spencerwilson","id":5624115,"node_id":"MDQ6VXNlcjU2MjQxMTU=","avatar_url":"https://avatars.githubusercontent.com/u/5624115?v=4","gravatar_id":"","url":"https://api.github.com/users/spencerwilson","html_url":"https://github.com/spencerwilson","followers_url":"https://api.github.com/users/spencerwilson/followers","following_url":"https://api.github.com/users/spencerwilson/following{/other_user}","gists_url":"https://api.github.com/users/spencerwilson/gists{/gist_id}","starred_url":"https://api.github.com/users/spencerwilson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/spencerwilson/subscriptions","organizations_url":"https://api.github.com/users/spencerwilson/orgs","repos_url":"https://api.github.com/users/spencerwilson/repos","events_url":"https://api.github.com/users/spencerwilson/events{/privacy}","received_events_url":"https://api.github.com/users/spencerwilson/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":339721682,"node_id":"MDU6TGFiZWwzMzk3MjE2ODI=","url":"https://api.github.com/repos/BurntSushi/ripgrep/labels/invalid","name":"invalid","color":"e6e6e6","default":true,"description":"An issue that is not actually a bug or a feature that already exists."}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-01-11T18:39:11Z","updated_at":"2023-11-24T20:06:51Z","closed_at":"2023-11-24T20:06:43Z","author_association":"NONE","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"#### What version of ripgrep are you using?\r\n\r\nripgrep 13.0.0\r\n-SIMD -AVX (compiled)\r\n\r\n#### How did you install ripgrep?\r\n\r\nbrew install ripgrep\r\n\r\n#### What operating system are you using ripgrep on?\r\n\r\nmacOS 11.3\r\nDarwin Kernel Version 20.4.0: Fri Mar  5 01:14:02 PST 2021; root:xnu-7195.101.1~3/RELEASE_ARM64_T8101\r\n\r\n#### Describe your bug.\r\n\r\nWhen reading a fifo file and instructed to buffer output by line, ripgrep buffers its output neither by line (as expected) nor by block (as it otherwise supports), but rather until the other end of the fifo is closed.\r\n\r\nMy use case: I have a large stream (probably hundreds of GB; it's `jq --stream -c` output on a 13 GB JSON object) that I'm teeing into multiple fifos, each with a single ripgrep reader. I was alerted to this bug when I noticed ever-growing resident set size on the ripgrep processes and delayed output from the ripgreps (their output appeared only when tee closed its end of the fifo).\r\n\r\n#### What are the steps to reproduce the behavior?\r\n\r\n```sh\r\nrm -f yesfifo\r\nmkfifo yesfifo\r\nyes > yesfifo &\r\nrg --line-buffered . yesfifo > rgout &\r\n\r\n# Let rg process more than a block worth of input (13 MB on my system)\r\n# During this time, rg never writes to stdout.\r\n# Expectation is that it writes once per line of input.\r\nsleep 0.25\r\n\r\n# Terminate `yes`, closing the write end of the FIFO.\r\n# Now rg writes its accumulated output to stdout.\r\nkill %1\r\n```\r\n\r\nYou can increase the sleep duration (but increase disk consumption) to make it easier confirm the lack of stdout writes during the sleep.\r\n\r\nI've not verified any issues regarding buffered output when reading regular files.\r\n\r\n#### What is the actual behavior?\r\n\r\nrg buffers its output until the fifo writer closes.\r\n\r\n#### What is the expected behavior?\r\n\r\nBehavior described in the manual: rg decides buffering strategy based the terminal environment by default, but that can be overridden with options like `--line-buffered`. In the example above my expectation is that the output is line buffered.","closed_by":{"login":"BurntSushi","id":456674,"node_id":"MDQ6VXNlcjQ1NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/456674?v=4","gravatar_id":"","url":"https://api.github.com/users/BurntSushi","html_url":"https://github.com/BurntSushi","followers_url":"https://api.github.com/users/BurntSushi/followers","following_url":"https://api.github.com/users/BurntSushi/following{/other_user}","gists_url":"https://api.github.com/users/BurntSushi/gists{/gist_id}","starred_url":"https://api.github.com/users/BurntSushi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BurntSushi/subscriptions","organizations_url":"https://api.github.com/users/BurntSushi/orgs","repos_url":"https://api.github.com/users/BurntSushi/repos","events_url":"https://api.github.com/users/BurntSushi/events{/privacy}","received_events_url":"https://api.github.com/users/BurntSushi/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/2122/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/2122/timeline","performed_via_github_app":null,"state_reason":"not_planned"}