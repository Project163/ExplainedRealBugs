[{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/1185529117","html_url":"https://github.com/BurntSushi/ripgrep/issues/2260#issuecomment-1185529117","issue_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/2260","id":1185529117,"node_id":"IC_kwDOAzJbyc5Gqb0d","user":{"login":"BurntSushi","id":456674,"node_id":"MDQ6VXNlcjQ1NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/456674?v=4","gravatar_id":"","url":"https://api.github.com/users/BurntSushi","html_url":"https://github.com/BurntSushi","followers_url":"https://api.github.com/users/BurntSushi/followers","following_url":"https://api.github.com/users/BurntSushi/following{/other_user}","gists_url":"https://api.github.com/users/BurntSushi/gists{/gist_id}","starred_url":"https://api.github.com/users/BurntSushi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BurntSushi/subscriptions","organizations_url":"https://api.github.com/users/BurntSushi/orgs","repos_url":"https://api.github.com/users/BurntSushi/repos","events_url":"https://api.github.com/users/BurntSushi/events{/privacy}","received_events_url":"https://api.github.com/users/BurntSushi/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-07-15T13:08:45Z","updated_at":"2022-07-15T13:08:45Z","body":"OK so this is definitely a bug, but a pretty gnarly one and the result of two different optimizations in play here that result in inconsistent behavior.\r\n\r\nHere's the short term thing you want: you should enable `multi_line` on `RegexMatcherBuilder`. Otherwise, your `^` and `$` are interpreted as \"beginning and end of text\" instead of \"beginning and end of text, or beginning and end of line.\" The latter is generally what you want in a grep tool, and the former is generally not tested as well and thus uncovered a bug.\r\n\r\nThe longer story here is that there is an optimization in place that tries to look for matching lines the \"fast\" way, which avoids iterating over every line in the haystack. When this optimization is used, your regex with `^` and `$` doesn't match because your haystack includes a trailing newline character. That is, `^[GATC]+$` does not match `AGTC\\n`. `(?m)^[GATC]+$` will match it though.\r\n\r\nSo... why does `^[GATC]{20,}$` match but `^[NGATC]{20,}$` does not? Well, the former has literals extracted from it. Namely, `G`, `A`, `T` and `C`. ripgrep will look for matches of those literals before running the full regex engine. The second regex exceeds the heuristic literal extraction routine and _no_ literals are extracted from it. This in means ripgrep runs the full regex engine. In both cases though, the \"fast\" line matching algorithm is used. In that \"fast\" variant, we first look for a \"candidate\" match:\r\n\r\nhttps://github.com/BurntSushi/ripgrep/blob/dd104b5bcd7628b2e2ba9ca8e9832c03fd3dab07/crates/searcher/src/searcher/core.rs#L376\r\n\r\nIf a candidate is found, then we need to confirm it:\r\n\r\nhttps://github.com/BurntSushi/ripgrep/blob/dd104b5bcd7628b2e2ba9ca8e9832c03fd3dab07/crates/searcher/src/searcher/core.rs#L393-L416\r\n\r\nSo when literals are extracted (in the case of `[GATC]`), the candidate search just looks for matches of `[GATC]`. When a candidate is found, the **line terminators are stripped** and then we try to confirm the match. Since the line terminator is stripped, your regex matches.\r\n\r\nBut when literals aren't extracted, the candidate search just runs the full regex engine. But since this is a fast path, the meat of the optimization is that the candidate search doesn't care about lines per se and so there is no opportunity to strip line terminators. Thus, your `[NGATC]` regex never matches.\r\n\r\nThe right thing to do here is to probably disable the fast line search optimization if there are any anchors in the regex that only match beginning/end of test (as opposed to anchors that match either the beginning/end of text or the beginning/end of lines). The \"slow\" path iterates over every line, strips the line terminators and then runs the regex as you would expect. And in this case, both of your regexes match. This is why if you remove your `line_terminator(b'\\n')` option, then you get expected results. That `line_terminator` option is necessary to trigger the fast path.","author_association":"OWNER","reactions":{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/1185529117/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"BurntSushi","id":456674,"node_id":"MDQ6VXNlcjQ1NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/456674?v=4","gravatar_id":"","url":"https://api.github.com/users/BurntSushi","html_url":"https://github.com/BurntSushi","followers_url":"https://api.github.com/users/BurntSushi/followers","following_url":"https://api.github.com/users/BurntSushi/following{/other_user}","gists_url":"https://api.github.com/users/BurntSushi/gists{/gist_id}","starred_url":"https://api.github.com/users/BurntSushi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BurntSushi/subscriptions","organizations_url":"https://api.github.com/users/BurntSushi/orgs","repos_url":"https://api.github.com/users/BurntSushi/repos","events_url":"https://api.github.com/users/BurntSushi/events{/privacy}","received_events_url":"https://api.github.com/users/BurntSushi/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":7002179345,"node_id":"CE_lADOAzJbyc5N1T4CzwAAAAGhXMcR","url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/events/7002179345","actor":{"login":"BurntSushi","id":456674,"node_id":"MDQ6VXNlcjQ1NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/456674?v=4","gravatar_id":"","url":"https://api.github.com/users/BurntSushi","html_url":"https://github.com/BurntSushi","followers_url":"https://api.github.com/users/BurntSushi/followers","following_url":"https://api.github.com/users/BurntSushi/following{/other_user}","gists_url":"https://api.github.com/users/BurntSushi/gists{/gist_id}","starred_url":"https://api.github.com/users/BurntSushi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BurntSushi/subscriptions","organizations_url":"https://api.github.com/users/BurntSushi/orgs","repos_url":"https://api.github.com/users/BurntSushi/repos","events_url":"https://api.github.com/users/BurntSushi/events{/privacy}","received_events_url":"https://api.github.com/users/BurntSushi/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"closed","commit_id":"8e57989cd20379acfca28a341da61df177daca1c","commit_url":"https://api.github.com/repos/BurntSushi/ripgrep/commits/8e57989cd20379acfca28a341da61df177daca1c","created_at":"2022-07-15T14:01:01Z","state_reason":null,"performed_via_github_app":null},{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/1185578705","html_url":"https://github.com/BurntSushi/ripgrep/issues/2260#issuecomment-1185578705","issue_url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/2260","id":1185578705,"node_id":"IC_kwDOAzJbyc5Gqn7R","user":{"login":"BurntSushi","id":456674,"node_id":"MDQ6VXNlcjQ1NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/456674?v=4","gravatar_id":"","url":"https://api.github.com/users/BurntSushi","html_url":"https://github.com/BurntSushi","followers_url":"https://api.github.com/users/BurntSushi/followers","following_url":"https://api.github.com/users/BurntSushi/following{/other_user}","gists_url":"https://api.github.com/users/BurntSushi/gists{/gist_id}","starred_url":"https://api.github.com/users/BurntSushi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BurntSushi/subscriptions","organizations_url":"https://api.github.com/users/BurntSushi/orgs","repos_url":"https://api.github.com/users/BurntSushi/repos","events_url":"https://api.github.com/users/BurntSushi/events{/privacy}","received_events_url":"https://api.github.com/users/BurntSushi/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2022-07-15T14:03:26Z","updated_at":"2022-07-15T14:03:26Z","body":"This should be fixed in `grep 0.2.9`, `grep-regex 0.1.10` and `grep-searcher 0.1.9`.","author_association":"OWNER","reactions":{"url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/comments/1185578705/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"BurntSushi","id":456674,"node_id":"MDQ6VXNlcjQ1NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/456674?v=4","gravatar_id":"","url":"https://api.github.com/users/BurntSushi","html_url":"https://github.com/BurntSushi","followers_url":"https://api.github.com/users/BurntSushi/followers","following_url":"https://api.github.com/users/BurntSushi/following{/other_user}","gists_url":"https://api.github.com/users/BurntSushi/gists{/gist_id}","starred_url":"https://api.github.com/users/BurntSushi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BurntSushi/subscriptions","organizations_url":"https://api.github.com/users/BurntSushi/orgs","repos_url":"https://api.github.com/users/BurntSushi/repos","events_url":"https://api.github.com/users/BurntSushi/events{/privacy}","received_events_url":"https://api.github.com/users/BurntSushi/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":7002196707,"node_id":"LE_lADOAzJbyc5N1T4CzwAAAAGhXQrj","url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/events/7002196707","actor":{"login":"BurntSushi","id":456674,"node_id":"MDQ6VXNlcjQ1NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/456674?v=4","gravatar_id":"","url":"https://api.github.com/users/BurntSushi","html_url":"https://github.com/BurntSushi","followers_url":"https://api.github.com/users/BurntSushi/followers","following_url":"https://api.github.com/users/BurntSushi/following{/other_user}","gists_url":"https://api.github.com/users/BurntSushi/gists{/gist_id}","starred_url":"https://api.github.com/users/BurntSushi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BurntSushi/subscriptions","organizations_url":"https://api.github.com/users/BurntSushi/orgs","repos_url":"https://api.github.com/users/BurntSushi/repos","events_url":"https://api.github.com/users/BurntSushi/events{/privacy}","received_events_url":"https://api.github.com/users/BurntSushi/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2022-07-15T14:03:39Z","label":{"name":"bug","color":"fc2929"},"performed_via_github_app":null},{"id":11656581067,"node_id":"REFE_lADOAzJbyc5N1T4CzwAAAAK2yU_L","url":"https://api.github.com/repos/BurntSushi/ripgrep/issues/events/11656581067","actor":{"login":"liqipeng","id":6264774,"node_id":"MDQ6VXNlcjYyNjQ3NzQ=","avatar_url":"https://avatars.githubusercontent.com/u/6264774?v=4","gravatar_id":"","url":"https://api.github.com/users/liqipeng","html_url":"https://github.com/liqipeng","followers_url":"https://api.github.com/users/liqipeng/followers","following_url":"https://api.github.com/users/liqipeng/following{/other_user}","gists_url":"https://api.github.com/users/liqipeng/gists{/gist_id}","starred_url":"https://api.github.com/users/liqipeng/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/liqipeng/subscriptions","organizations_url":"https://api.github.com/users/liqipeng/orgs","repos_url":"https://api.github.com/users/liqipeng/repos","events_url":"https://api.github.com/users/liqipeng/events{/privacy}","received_events_url":"https://api.github.com/users/liqipeng/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"8e57989cd20379acfca28a341da61df177daca1c","commit_url":"https://api.github.com/repos/liqipeng/rust-ripgrep/commits/8e57989cd20379acfca28a341da61df177daca1c","created_at":"2024-01-31T14:27:36Z","performed_via_github_app":null}]