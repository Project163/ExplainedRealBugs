{"url":"https://api.github.com/repos/etcd-io/etcd/issues/12285","repository_url":"https://api.github.com/repos/etcd-io/etcd","labels_url":"https://api.github.com/repos/etcd-io/etcd/issues/12285/labels{/name}","comments_url":"https://api.github.com/repos/etcd-io/etcd/issues/12285/comments","events_url":"https://api.github.com/repos/etcd-io/etcd/issues/12285/events","html_url":"https://github.com/etcd-io/etcd/issues/12285","id":699504259,"node_id":"MDU6SXNzdWU2OTk1MDQyNTk=","number":12285,"title":"Force new cluster causes etcd to panic when learner members are added","user":{"login":"galal-hussein","id":3309968,"node_id":"MDQ6VXNlcjMzMDk5Njg=","avatar_url":"https://avatars.githubusercontent.com/u/3309968?v=4","gravatar_id":"","url":"https://api.github.com/users/galal-hussein","html_url":"https://github.com/galal-hussein","followers_url":"https://api.github.com/users/galal-hussein/followers","following_url":"https://api.github.com/users/galal-hussein/following{/other_user}","gists_url":"https://api.github.com/users/galal-hussein/gists{/gist_id}","starred_url":"https://api.github.com/users/galal-hussein/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/galal-hussein/subscriptions","organizations_url":"https://api.github.com/users/galal-hussein/orgs","repos_url":"https://api.github.com/users/galal-hussein/repos","events_url":"https://api.github.com/users/galal-hussein/events{/privacy}","received_events_url":"https://api.github.com/users/galal-hussein/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2020-09-11T16:22:16Z","updated_at":"2020-09-15T15:59:37Z","closed_at":"2020-09-15T15:59:37Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"etcd version: v3.4.13\r\n\r\nIssue:\r\n\r\nthe issue was seen in k3s https://github.com/rancher/k3s/issues/2131 when --cluster-reset is passed which internally passing a --force-new-cluster to etcd node, If --force-new-cluster flag is passed to a cluster where it had previous learner members added, etcd panics with the following error:\r\n```\r\n{\"level\":\"info\",\"ts\":\"2020-09-11T16:10:24.260Z\",\"caller\":\"etcdmain/etcd.go:134\",\"msg\":\"server has been already initialized\",\"data-dir\":\"/var/lib/etcd\",\"dir-type\":\"member\"}\r\n{\"level\":\"info\",\"ts\":\"2020-09-11T16:10:24.260Z\",\"caller\":\"embed/etcd.go:117\",\"msg\":\"configuring peer listeners\",\"listen-peer-urls\":[\"http://0.0.0.0:2380\"]}\r\n{\"level\":\"info\",\"ts\":\"2020-09-11T16:10:24.262Z\",\"caller\":\"embed/etcd.go:127\",\"msg\":\"configuring client listeners\",\"listen-client-urls\":[\"http://0.0.0.0:2379\",\"http://0.0.0.0:4001\"]}\r\n{\"level\":\"info\",\"ts\":\"2020-09-11T16:10:24.263Z\",\"caller\":\"embed/etcd.go:302\",\"msg\":\"starting an etcd server\",\"etcd-version\":\"3.4.13\",\"git-sha\":\"ae9734ed2\",\"go-version\":\"go1.12.17\",\"go-os\":\"linux\",\"go-arch\":\"amd64\",\"max-cpu-set\":2,\"max-cpu-available\":2,\"member-initialized\":true,\"name\":\"etcd0\",\"data-dir\":\"/var/lib/etcd\",\"wal-dir\":\"\",\"wal-dir-dedicated\":\"\",\"member-dir\":\"/var/lib/etcd/member\",\"force-new-cluster\":true,\"heartbeat-interval\":\"100ms\",\"election-timeout\":\"1s\",\"initial-election-tick-advance\":true,\"snapshot-count\":100000,\"snapshot-catchup-entries\":5000,\"initial-advertise-peer-urls\":[\"http://172.31.35.28:2380\"],\"listen-peer-urls\":[\"http://0.0.0.0:2380\"],\"advertise-client-urls\":[\"http://172.31.35.28:2379\",\"http://172.31.35.28:4001\"],\"listen-client-urls\":[\"http://0.0.0.0:2379\",\"http://0.0.0.0:4001\"],\"listen-metrics-urls\":[],\"cors\":[\"*\"],\"host-whitelist\":[\"*\"],\"initial-cluster\":\"\",\"initial-cluster-state\":\"new\",\"initial-cluster-token\":\"\",\"quota-size-bytes\":2147483648,\"pre-vote\":false,\"initial-corrupt-check\":false,\"corrupt-check-time-interval\":\"0s\",\"auto-compaction-mode\":\"periodic\",\"auto-compaction-retention\":\"0s\",\"auto-compaction-interval\":\"0s\",\"discovery-url\":\"\",\"discovery-proxy\":\"\"}\r\n2020-09-11 16:10:24.263932 W | pkg/fileutil: check file permission: directory \"/var/lib/etcd\" exist, but the permission is \"drwxr-xr-x\". The recommended permission is \"-rwx------\" to prevent possible unprivileged access to the data.\r\n{\"level\":\"info\",\"ts\":\"2020-09-11T16:10:24.264Z\",\"caller\":\"etcdserver/backend.go:80\",\"msg\":\"opened backend db\",\"path\":\"/var/lib/etcd/member/snap/db\",\"took\":\"118.408Âµs\"}\r\n{\"level\":\"panic\",\"ts\":\"2020-09-11T16:10:24.265Z\",\"caller\":\"etcdserver/raft.go:704\",\"msg\":\"unknown ConfChange Type\",\"type\":\"ConfChangeAddLearnerNode\",\"stacktrace\":\"go.etcd.io/etcd/etcdserver.getIDs\\n\\t/tmp/etcd-release-3.4.13/etcd/release/etcd/etcdserver/raft.go:704\\ngo.etcd.io/etcd/etcdserver.restartAsStandaloneNode\\n\\t/tmp/etcd-release-3.4.13/etcd/release/etcd/etcdserver/raft.go:611\\ngo.etcd.io/etcd/etcdserver.NewServer\\n\\t/tmp/etcd-release-3.4.13/etcd/release/etcd/etcdserver/server.go:482\\ngo.etcd.io/etcd/embed.StartEtcd\\n\\t/tmp/etcd-release-3.4.13/etcd/release/etcd/embed/etcd.go:214\\ngo.etcd.io/etcd/etcdmain.startEtcd\\n\\t/tmp/etcd-release-3.4.13/etcd/release/etcd/etcdmain/etcd.go:302\\ngo.etcd.io/etcd/etcdmain.startEtcdOrProxyV2\\n\\t/tmp/etcd-release-3.4.13/etcd/release/etcd/etcdmain/etcd.go:144\\ngo.etcd.io/etcd/etcdmain.Main\\n\\t/tmp/etcd-release-3.4.13/etcd/release/etcd/etcdmain/main.go:46\\nmain.main\\n\\t/tmp/etcd-release-3.4.13/etcd/release/etcd/main.go:28\\nruntime.main\\n\\t/usr/local/go/src/runtime/proc.go:200\"}\r\npanic: unknown ConfChange Type\r\n\r\ngoroutine 1 [running]:\r\ngo.uber.org/zap/zapcore.(*CheckedEntry).Write(0xc00013f550, 0xc000205180, 0x1, 0x1)\r\n\t/home/ANT.AMAZON.COM/leegyuho/go/pkg/mod/go.uber.org/zap@v1.10.0/zapcore/entry.go:229 +0x546\r\ngo.uber.org/zap.(*Logger).Panic(0xc00007b860, 0x10a7a53, 0x17, 0xc000205180, 0x1, 0x1)\r\n\t/home/ANT.AMAZON.COM/leegyuho/go/pkg/mod/go.uber.org/zap@v1.10.0/logger.go:225 +0x7f\r\ngo.etcd.io/etcd/etcdserver.getIDs(0xc00007b860, 0x0, 0xc00012c900, 0x7, 0x8, 0x0, 0x0, 0x0)\r\n\t/tmp/etcd-release-3.4.13/etcd/release/etcd/etcdserver/raft.go:704 +0x582\r\ngo.etcd.io/etcd/etcdserver.restartAsStandaloneNode(0x7ffc2b9e6ddd, 0x5, 0x0, 0x0, 0x0, 0x0, 0xc00019e700, 0x2, 0x2, 0xc000125380, ...)\r\n\t/tmp/etcd-release-3.4.13/etcd/release/etcd/etcdserver/raft.go:611 +0x255\r\ngo.etcd.io/etcd/etcdserver.NewServer(0x7ffc2b9e6ddd, 0x5, 0x0, 0x0, 0x0, 0x0, 0xc00019e700, 0x2, 0x2, 0xc000125380, ...)\r\n\t/tmp/etcd-release-3.4.13/etcd/release/etcd/etcdserver/server.go:482 +0x122f\r\ngo.etcd.io/etcd/embed.StartEtcd(0xc000202000, 0xc00035c000, 0x0, 0x0)\r\n\t/tmp/etcd-release-3.4.13/etcd/release/etcd/embed/etcd.go:214 +0x988\r\ngo.etcd.io/etcd/etcdmain.startEtcd(0xc000202000, 0x10963d6, 0x6, 0xc000125701, 0x2)\r\n\t/tmp/etcd-release-3.4.13/etcd/release/etcd/etcdmain/etcd.go:302 +0x40\r\ngo.etcd.io/etcd/etcdmain.startEtcdOrProxyV2()\r\n\t/tmp/etcd-release-3.4.13/etcd/release/etcd/etcdmain/etcd.go:144 +0x2ef9\r\ngo.etcd.io/etcd/etcdmain.Main()\r\n\t/tmp/etcd-release-3.4.13/etcd/release/etcd/etcdmain/main.go:46 +0x38\r\nmain.main()\r\n\t/tmp/etcd-release-3.4.13/etcd/release/etcd/main.go:28 +0x20\r\n```\r\n\r\n*To reproduce*\r\n\r\n- start a 1 member etcd cluster, for example:\r\n```\r\ndocker run -d -v /var/lib/etcd:/var/lib/etcd -p 4001:4001 -p 2380:2380 -p 2379:2379  --name etcd quay.io/coreos/etcd:v3.4.13 etcd  --name etcd0  -advertise-client-urls http://172.31.35.28:2379,http://172.31.35.28:4001  -listen-client-urls http://0.0.0.0:2379,http://0.0.0.0:4001  -initial-advertise-peer-urls http://172.31.35.28:2380  -listen-peer-urls http://0.0.0.0:2380  -initial-cluster-token etcd-cluster-1  --data-dir /var/lib/etcd -initial-cluster etcd0=http://172.31.35.28:2380 -initial-cluster-state new\r\n```\r\n\r\n- add another member as a learner \r\n```\r\netcdctl member add --learner etcd1 --peer-urls=\"http://172.31.34.59:2380\"\r\n```\r\n\r\n- start the other etcd node\r\n```\r\ndocker run -d -v /var/lib/etcd:/var/lib/etcd -p 4001:4001 -p 2380:2380 -p 2379:2379  --name etcd quay.io/coreos/etcd:v3.4.13 etcd  --name etcd1  -advertise-client-urls http://172.31.34.59:2379,http://172.31.34.59:4001  --data-dir /var/lib/etcd -listen-client-urls http://0.0.0.0:2379,http://0.0.0.0:4001  -initial-advertise-peer-urls http://172.31.34.59:2380  -listen-peer-urls http://0.0.0.0:2380  -initial-cluster-token etcd-cluster-1  -initial-cluster etcd0=http://172.31.35.28:2380,etcd1=http://172.31.34.59:2380  -initial-cluster-state existing\r\n```\r\n- promote the learner node\r\n```\r\netcdctl member promote 9b83f879a67d44eb\r\n```\r\n- stop both etcd0 and 1 and then start etcd0 with --force-new-cluster\r\n```\r\ndocker run -d -v /var/lib/etcd:/var/lib/etcd -p 4001:4001 -p 2380:2380 -p 2379:2379  --name etcd quay.io/coreos/etcd:v3.4.13 etcd  --name etcd0  -advertise-client-urls http://172.31.35.28:2379,http://172.31.35.28:4001  -listen-client-urls http://0.0.0.0:2379,http://0.0.0.0:4001  -initial-advertise-peer-urls http://172.31.35.28:2380  -listen-peer-urls http://0.0.0.0:2380  -initial-cluster-token etcd-cluster-1  --data-dir /var/lib/etcd -initial-cluster etcd0=http://172.31.35.28:2380 -initial-cluster-state new --force-new-cluster --logger=zap --log-level=debug\r\n```\r\n\r\nThe error appears to be in this line https://github.com/etcd-io/etcd/blob/76e769ce95ca0d4d0e3486712d96956260db04b8/etcdserver/raft.go#L642, it appears that getIds() function doesnt handle config change \"ConfChangeAddLearnerNode\" when getting the ID of members in a given snapshot","closed_by":{"login":"jingyih","id":23108879,"node_id":"MDQ6VXNlcjIzMTA4ODc5","avatar_url":"https://avatars.githubusercontent.com/u/23108879?v=4","gravatar_id":"","url":"https://api.github.com/users/jingyih","html_url":"https://github.com/jingyih","followers_url":"https://api.github.com/users/jingyih/followers","following_url":"https://api.github.com/users/jingyih/following{/other_user}","gists_url":"https://api.github.com/users/jingyih/gists{/gist_id}","starred_url":"https://api.github.com/users/jingyih/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jingyih/subscriptions","organizations_url":"https://api.github.com/users/jingyih/orgs","repos_url":"https://api.github.com/users/jingyih/repos","events_url":"https://api.github.com/users/jingyih/events{/privacy}","received_events_url":"https://api.github.com/users/jingyih/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/etcd-io/etcd/issues/12285/reactions","total_count":2,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":1,"eyes":0},"timeline_url":"https://api.github.com/repos/etcd-io/etcd/issues/12285/timeline","performed_via_github_app":null,"state_reason":"completed"}