{"url":"https://api.github.com/repos/etcd-io/etcd/issues/17001","repository_url":"https://api.github.com/repos/etcd-io/etcd","labels_url":"https://api.github.com/repos/etcd-io/etcd/issues/17001/labels{/name}","comments_url":"https://api.github.com/repos/etcd-io/etcd/issues/17001/comments","events_url":"https://api.github.com/repos/etcd-io/etcd/issues/17001/events","html_url":"https://github.com/etcd-io/etcd/issues/17001","id":2007436090,"node_id":"I_kwDOAKtHts53pws6","number":17001,"title":"Using a direct method call with v3client that doesn't go through gRPC to call the Endpoints() method results in a null pointer, causing a panic. ","user":{"login":"113xiaoji","id":31875988,"node_id":"MDQ6VXNlcjMxODc1OTg4","avatar_url":"https://avatars.githubusercontent.com/u/31875988?v=4","gravatar_id":"","url":"https://api.github.com/users/113xiaoji","html_url":"https://github.com/113xiaoji","followers_url":"https://api.github.com/users/113xiaoji/followers","following_url":"https://api.github.com/users/113xiaoji/following{/other_user}","gists_url":"https://api.github.com/users/113xiaoji/gists{/gist_id}","starred_url":"https://api.github.com/users/113xiaoji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/113xiaoji/subscriptions","organizations_url":"https://api.github.com/users/113xiaoji/orgs","repos_url":"https://api.github.com/users/113xiaoji/repos","events_url":"https://api.github.com/users/113xiaoji/events{/privacy}","received_events_url":"https://api.github.com/users/113xiaoji/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":46697272,"node_id":"MDU6TGFiZWw0NjY5NzI3Mg==","url":"https://api.github.com/repos/etcd-io/etcd/labels/type/bug","name":"type/bug","color":"d61552","default":false,"description":""},{"id":1966361840,"node_id":"MDU6TGFiZWwxOTY2MzYxODQw","url":"https://api.github.com/repos/etcd-io/etcd/labels/stale","name":"stale","color":"f9b3e6","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":10,"created_at":"2023-11-23T03:40:22Z","updated_at":"2025-06-05T00:12:26Z","closed_at":"2025-06-05T00:12:26Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Bug report criteria\r\n\r\n- [X] This bug report is not security related, security issues should be disclosed privately via security@etcd.io.\r\n- [X] This is not a support request or question, support requests or questions should be raised in the etcd [discussion forums](https://github.com/etcd-io/etcd/discussions).\r\n- [X] You have read the etcd [bug reporting guidelines](https://github.com/etcd-io/etcd/blob/main/Documentation/contributor-guide/reporting_bugs.md).\r\n- [X] Existing open issues along with etcd [frequently asked questions](https://etcd.io/docs/latest/faq) have been checked and this is not a duplicate.\r\n\r\n### What happened?\r\n\r\nUsing a direct method call with v3client that doesn't go through gRPC to call the Endpoints() method results in a null pointer, causing a panic. The reason is that a variable named `mu` of type `*sync.RWMutex` is not initialized.\r\n\r\n## Background\r\n\r\nIn an effort to minimize Kubernetes (k8s), the apiserver code has been intrusively modified to directly use a v3client for invoking embedded etcd. However, calling the Endpoints() method of etcd's client using this approach leads to a null pointer dereference, causing a panic. The issue stems from an uninitialized variable named `epMu` of type `*sync.RWMutex`.\r\n\r\n### Issue Description\r\n\r\nThe panic occurs as follows:\r\n\r\n```\r\npanic: runtime error: invalid memory address or nil pointer dereference\r\n[signal SIGSEGV: segmentation violation code=0x1 addr=0x10 pc=0xa41eac]\r\n\r\ngoroutine 1 [running]:\r\nsync.(*RWMutex).RLock(...)\r\n        C:/Program Files/Go1.19/go/src/sync/rwmutex.go:69\r\ngo.etcd.io/etcd/client/v3.(*Client).Endpoints(0xc0000fe380)\r\n        /go/pkg/mod/go.etcd.io/etcd/client/v3@v3.5.10/client.go:164 +0x4c\r\nmain.main()\r\n        D:/01work/code/go/test/main.go:32 +0x1cc    // Endpoints lists the registered endpoints for the client.\r\n```\r\n\r\n\r\n\r\nThe null pointer occurs in `client/v3/client.go`, where `c.mu` is not initialized:\r\n\r\n```go\r\n// Endpoints lists the registered endpoints for the client.\r\nfunc (c *Client) Endpoints() []string {\r\n\t// copy the slice; protect original endpoints from being changed\r\n\tc.mu.RLock()\r\n\tdefer c.mu.RUnlock()\r\n\teps := make([]string, len(c.cfg.Endpoints))\r\n\tcopy(eps, c.cfg.Endpoints)\r\n\treturn eps\r\n}\r\n```\r\n\r\n\r\n\r\nLooking at the initialization code in `server/etcdserver/api/v3client/v3client.go`:\r\n\r\n```go\r\n// New creates a clientv3 client that wraps an in-process EtcdServer. Instead\r\n// of making gRPC calls through sockets, the client makes direct function calls\r\n// to the etcd server through its api/v3rpc function interfaces.\r\nfunc New(s *etcdserver.EtcdServer) *clientv3.Client {\r\n\tc := clientv3.NewCtxClient(context.Background(), clientv3.WithZapLogger(s.Logger()))\r\n\r\n\tkvc := adapter.KvServerToKvClient(v3rpc.NewQuotaKVServer(s))\r\n\tc.KV = clientv3.NewKVFromKVClient(kvc, c)\r\n\r\n\tlc := adapter.LeaseServerToLeaseClient(v3rpc.NewQuotaLeaseServer(s))\r\n\tc.Lease = clientv3.NewLeaseFromLeaseClient(lc, c, time.Second)\r\n\r\n\twc := adapter.WatchServerToWatchClient(v3rpc.NewWatchServer(s))\r\n\tc.Watcher = &watchWrapper{clientv3.NewWatchFromWatchClient(wc, c)}\r\n\r\n\tmc := adapter.MaintenanceServerToMaintenanceClient(v3rpc.NewMaintenanceServer(s))\r\n\tc.Maintenance = clientv3.NewMaintenanceFromMaintenanceClient(mc, c)\r\n\r\n\tclc := adapter.ClusterServerToClusterClient(v3rpc.NewClusterServer(s))\r\n\tc.Cluster = clientv3.NewClusterFromClusterClient(clc, c)\r\n\r\n\ta := adapter.AuthServerToAuthClient(v3rpc.NewAuthServer(s))\r\n\tc.Auth = clientv3.NewAuthFromAuthClient(a, c)\r\n\r\n\treturn c\r\n}\r\n\r\n```\r\n\r\n\r\n\r\nAnd in `client/v3/client.go`, `NewCtxClient` only initializes `lgMu`, not `mu`:\r\n\r\n```go\r\n// NewCtxClient creates a client with a context but no underlying grpc\r\n// connection. This is useful for embedded cases that override the\r\n// service interface implementations and do not need connection management.\r\nfunc NewCtxClient(ctx context.Context, opts ...Option) *Client {\r\n\tcctx, cancel := context.WithCancel(ctx)\r\n\tc := &Client{ctx: cctx, cancel: cancel, lgMu: new(sync.RWMutex)}\r\n\tfor _, opt := range opts {\r\n\t\topt(c)\r\n\t}\r\n\tif c.lg == nil {\r\n\t\tc.lg = zap.NewNop()\r\n\t}\r\n\treturn c\r\n}\r\n```\r\n\r\n\r\n\r\n### Problem\r\n\r\nThe main issue is that when using a direct method call approach with a v3client to access an embedded etcd, the necessary mutex (`mu`) in the etcd client is not being initialized. This oversight leads to a runtime panic when attempting to lock this mutex for reading endpoint information.\r\n\r\n### Resolution\r\n\r\nTo resolve this issue, it's necessary to ensure that all required fields, including `mu`, are properly initialized in the etcd client when it's created. This might involve modifying the `New` function in `v3client.go` or the `NewCtxClient` function in `client.go` to include initialization of the `mu` field.\r\n\r\n### What did you expect to happen?\r\n\r\nRunning normally, no null pointer.\r\n\r\n### How can we reproduce it (as minimally and precisely as possible)?\r\n\r\ndemo\r\n\r\n```go\r\npackage main\r\n\r\nimport (\r\n\t\"go.etcd.io/etcd/server/v3/etcdserver/api/v3client\"\r\n\t\"log\"\r\n\t\"time\"\r\n\r\n\t\"go.etcd.io/etcd/server/v3/embed\"\r\n)\r\n\r\nfunc main() {\r\n\tcfg := embed.NewConfig()\r\n\tcfg.Dir = \"default.etcd\"\r\n\tcfg.MaxSnapFiles = 10\r\n\tcfg.MaxSnapFiles = 10\r\n\r\n\te, err := embed.StartEtcd(cfg)\r\n\tif err != nil {\r\n\t\tlog.Fatal(err)\r\n\t}\r\n\tselect {\r\n\tcase <-e.Server.ReadyNotify():\r\n\t\tlog.Println(\"Embedded etcd is ready!\")\r\n\t\tcli := v3client.New(e.Server)\r\n\t\tendpoints := cli.Endpoints()\r\n\t\tlog.Printf(\"endpoint is %v\", endpoints)\r\n\r\n\tcase <-time.After(60 * time.Second):\r\n\t\te.Server.Stop()\r\n\t\te.Close()\r\n\t\tlog.Fatal(\"Embedded etcd took too long to start!\")\r\n\t}\r\n\r\n\t<-e.Server.StopNotify()\r\n\tlog.Println(\"Embedded etcd is stopped\")\r\n\r\n}\r\n\r\n```\r\n\r\n\r\n\r\n### Anything else we need to know?\r\n\r\nHope to solve version 3.5.4.and master\r\n\r\n### Etcd version (please run commands below)\r\n\r\ntest 3.5.4, 3.5.10 still exist\r\n\r\n### Etcd configuration (command line flags or environment variables)\r\n\r\nsee demo\r\n\r\n### Etcd debug information (please run commands below, feel free to obfuscate the IP address or FQDN in the output)\r\n\r\nno need\r\n\r\n### Relevant log output\r\n\r\n```Shell\r\nlog\r\n\r\n\r\n{\"level\":\"warn\",\"ts\":\"2023-11-23T11:33:41.920945+0800\",\"caller\":\"embed/config.go:676\",\"msg\":\"Running http and grpc server on single port. This is not recommended for production.\"}\r\n{\"level\":\"info\",\"ts\":\"2023-11-23T11:33:41.921003+0800\",\"caller\":\"embed/etcd.go:127\",\"msg\":\"configuring peer listeners\",\"listen-peer-urls\":[\"http://localhost:2380\"]}\r\n{\"level\":\"info\",\"ts\":\"2023-11-23T11:33:41.921678+0800\",\"caller\":\"embed/etcd.go:135\",\"msg\":\"configuring client listeners\",\"listen-client-urls\":[\"http://localhost:2379\"]}\r\n{\"level\":\"info\",\"ts\":\"2023-11-23T11:33:41.921826+0800\",\"caller\":\"embed/etcd.go:309\",\"msg\":\"starting an etcd server\",\"etcd-version\":\"3.5.10\",\"git-sha\":\"Not provided (use ./build instead of go build)\",\"go-version\":\"go1.19.4\",\"go-os\":\"linux\",\"go-arch\":\"amd64\",\"max-cpu-set\":16,\"max-cpu-available\":16,\"member-initialized\":true,\"name\":\"default\",\"data-dir\":\"default.etcd\",\"wal-dir\":\"\",\"wal-dir-dedicated\":\"\",\"member-dir\":\"default.etcd/member\",\"force-new-cluster\":false,\"heartbeat-interval\":\"100ms\",\"election-timeout\":\"1s\",\"initial-election-tick-advance\":true,\"snapshot-count\":100000,\"max-wals\":5,\"max-snapshots\":10,\"snapshot-catchup-entries\":5000,\"initial-advertise-peer-urls\":[\"http://localhost:2380\"],\"listen-peer-urls\":[\"http://localhost:2380\"],\"advertise-client-urls\":[\"http://localhost:2379\"],\"listen-client-urls\":[\"http://localhost:2379\"],\"listen-metrics-urls\":[],\"cors\":[\"*\"],\"host-whitelist\":[\"*\"],\"initial-cluster\":\"\",\"initial-cluster-state\":\"new\",\"initial-cluster-token\":\"\",\"quota-backend-bytes\":2147483648,\"max-request-bytes\":1572864,\"max-concurrent-streams\":4294967295,\"pre-vote\":true,\"initial-corrupt-check\":false,\"corrupt-check-time-interval\":\"0s\",\"compact-check-time-enabled\":false,\"compact-check-time-interval\":\"1m0s\",\"auto-compaction-mode\":\"\",\"auto-compaction-retention\":\"0s\",\"auto-compaction-interval\":\"0s\",\"discovery-url\":\"\",\"discovery-proxy\":\"\",\"downgrade-check-interval\":\"5s\"}\r\n{\"level\":\"info\",\"ts\":\"2023-11-23T11:33:41.92286+0800\",\"caller\":\"etcdserver/backend.go:81\",\"msg\":\"opened backend db\",\"path\":\"default.etcd/member/snap/db\",\"took\":\"860.481Âµs\"}\r\n{\"level\":\"info\",\"ts\":\"2023-11-23T11:33:41.923029+0800\",\"caller\":\"etcdserver/server.go:530\",\"msg\":\"No snapshot found. Recovering WAL from scratch!\"}\r\n{\"level\":\"info\",\"ts\":\"2023-11-23T11:33:41.924212+0800\",\"caller\":\"etcdserver/raft.go:530\",\"msg\":\"restarting local member\",\"cluster-id\":\"cdf818194e3a8c32\",\"local-member-id\":\"8e9e05c52164694d\",\"commit-index\":31}\r\n{\"level\":\"info\",\"ts\":\"2023-11-23T11:33:41.924461+0800\",\"logger\":\"raft\",\"caller\":\"etcdserver/zap_raft.go:77\",\"msg\":\"8e9e05c52164694d switched to configuration voters=()\"}\r\n{\"level\":\"info\",\"ts\":\"2023-11-23T11:33:41.924495+0800\",\"logger\":\"raft\",\"caller\":\"etcdserver/zap_raft.go:77\",\"msg\":\"8e9e05c52164694d became follower at term 11\"}\r\n{\"level\":\"info\",\"ts\":\"2023-11-23T11:33:41.924507+0800\",\"logger\":\"raft\",\"caller\":\"etcdserver/zap_raft.go:77\",\"msg\":\"newRaft 8e9e05c52164694d [peers: [], term: 11, commit: 31, applied: 0, lastindex: 31, lastterm: 11]\"}\r\n{\"level\":\"warn\",\"ts\":\"2023-11-23T11:33:41.925618+0800\",\"caller\":\"auth/store.go:1241\",\"msg\":\"simple token is not cryptographically signed\"}\r\n{\"level\":\"info\",\"ts\":\"2023-11-23T11:33:41.926804+0800\",\"caller\":\"mvcc/kvstore.go:407\",\"msg\":\"kvstore restored\",\"current-rev\":10}\r\n{\"level\":\"info\",\"ts\":\"2023-11-23T11:33:41.928037+0800\",\"caller\":\"etcdserver/quota.go:94\",\"msg\":\"enabled backend quota with default value\",\"quota-name\":\"v3-applier\",\"quota-size-bytes\":2147483648,\"quota-size\":\"2.1 GB\"}\r\n{\"level\":\"info\",\"ts\":\"2023-11-23T11:33:41.929179+0800\",\"caller\":\"etcdserver/server.go:854\",\"msg\":\"starting etcd server\",\"local-member-id\":\"8e9e05c52164694d\",\"local-server-version\":\"3.5.10\",\"cluster-version\":\"to_be_decided\"}\r\n{\"level\":\"info\",\"ts\":\"2023-11-23T11:33:41.92923+0800\",\"caller\":\"fileutil/purge.go:44\",\"msg\":\"started to purge file\",\"dir\":\"default.etcd/member/snap\",\"suffix\":\"snap.db\",\"max\":10,\"interval\":\"30s\"}\r\n{\"level\":\"info\",\"ts\":\"2023-11-23T11:33:41.929267+0800\",\"caller\":\"fileutil/purge.go:44\",\"msg\":\"started to purge file\",\"dir\":\"default.etcd/member/snap\",\"suffix\":\"snap\",\"max\":10,\"interval\":\"30s\"}\r\n{\"level\":\"info\",\"ts\":\"2023-11-23T11:33:41.929468+0800\",\"caller\":\"fileutil/purge.go:44\",\"msg\":\"started to purge file\",\"dir\":\"default.etcd/member/wal\",\"suffix\":\"wal\",\"max\":5,\"interval\":\"30s\"}\r\n{\"level\":\"info\",\"ts\":\"2023-11-23T11:33:41.929236+0800\",\"caller\":\"etcdserver/server.go:754\",\"msg\":\"starting initial election tick advance\",\"election-ticks\":10}\r\n{\"level\":\"info\",\"ts\":\"2023-11-23T11:33:41.92995+0800\",\"logger\":\"raft\",\"caller\":\"etcdserver/zap_raft.go:77\",\"msg\":\"8e9e05c52164694d switched to configuration voters=(10276657743932975437)\"}\r\n{\"level\":\"info\",\"ts\":\"2023-11-23T11:33:41.930018+0800\",\"caller\":\"membership/cluster.go:421\",\"msg\":\"added member\",\"cluster-id\":\"cdf818194e3a8c32\",\"local-member-id\":\"8e9e05c52164694d\",\"added-peer-id\":\"8e9e05c52164694d\",\"added-peer-peer-urls\":[\"http://localhost:2380\"]}\r\n{\"level\":\"info\",\"ts\":\"2023-11-23T11:33:41.930098+0800\",\"caller\":\"membership/cluster.go:584\",\"msg\":\"set initial cluster version\",\"cluster-id\":\"cdf818194e3a8c32\",\"local-member-id\":\"8e9e05c52164694d\",\"cluster-version\":\"3.5\"}\r\n{\"level\":\"info\",\"ts\":\"2023-11-23T11:33:41.93012+0800\",\"caller\":\"api/capability.go:75\",\"msg\":\"enabled capabilities for version\",\"cluster-version\":\"3.5\"}\r\n{\"level\":\"info\",\"ts\":\"2023-11-23T11:33:41.93128+0800\",\"caller\":\"embed/etcd.go:278\",\"msg\":\"now serving peer/client/metrics\",\"local-member-id\":\"8e9e05c52164694d\",\"initial-advertise-peer-urls\":[\"http://localhost:2380\"],\"listen-peer-urls\":[\"http://localhost:2380\"],\"advertise-client-urls\":[\"http://localhost:2379\"],\"listen-client-urls\":[\"http://localhost:2379\"],\"listen-metrics-urls\":[]}\r\n{\"level\":\"info\",\"ts\":\"2023-11-23T11:33:41.931291+0800\",\"caller\":\"embed/etcd.go:597\",\"msg\":\"serving peer traffic\",\"address\":\"127.0.0.1:2380\"}\r\n{\"level\":\"info\",\"ts\":\"2023-11-23T11:33:41.93132+0800\",\"caller\":\"embed/etcd.go:569\",\"msg\":\"cmux::serve\",\"address\":\"127.0.0.1:2380\"}\r\n{\"level\":\"info\",\"ts\":\"2023-11-23T11:33:43.825288+0800\",\"logger\":\"raft\",\"caller\":\"etcdserver/zap_raft.go:77\",\"msg\":\"8e9e05c52164694d is starting a new election at term 11\"}\r\n{\"level\":\"info\",\"ts\":\"2023-11-23T11:33:43.825331+0800\",\"logger\":\"raft\",\"caller\":\"etcdserver/zap_raft.go:77\",\"msg\":\"8e9e05c52164694d became pre-candidate at term 11\"}\r\n{\"level\":\"info\",\"ts\":\"2023-11-23T11:33:43.825356+0800\",\"logger\":\"raft\",\"caller\":\"etcdserver/zap_raft.go:77\",\"msg\":\"8e9e05c52164694d received MsgPreVoteResp from 8e9e05c52164694d at term 11\"}\r\n{\"level\":\"info\",\"ts\":\"2023-11-23T11:33:43.825371+0800\",\"logger\":\"raft\",\"caller\":\"etcdserver/zap_raft.go:77\",\"msg\":\"8e9e05c52164694d became candidate at term 12\"}\r\n{\"level\":\"info\",\"ts\":\"2023-11-23T11:33:43.825378+0800\",\"logger\":\"raft\",\"caller\":\"etcdserver/zap_raft.go:77\",\"msg\":\"8e9e05c52164694d received MsgVoteResp from 8e9e05c52164694d at term 12\"}\r\n{\"level\":\"info\",\"ts\":\"2023-11-23T11:33:43.825388+0800\",\"logger\":\"raft\",\"caller\":\"etcdserver/zap_raft.go:77\",\"msg\":\"8e9e05c52164694d became leader at term 12\"}\r\n{\"level\":\"info\",\"ts\":\"2023-11-23T11:33:43.825396+0800\",\"logger\":\"raft\",\"caller\":\"etcdserver/zap_raft.go:77\",\"msg\":\"raft.node: 8e9e05c52164694d elected leader 8e9e05c52164694d at term 12\"}\r\n{\"level\":\"info\",\"ts\":\"2023-11-23T11:33:43.826476+0800\",\"caller\":\"etcdserver/server.go:2062\",\"msg\":\"published local member to cluster through raft\",\"local-member-id\":\"8e9e05c52164694d\",\"local-member-attributes\":\"{Name:default ClientURLs:[http://localhost:2379]}\",\"request-path\":\"/0/members/8e9e05c52164694d/attributes\",\"cluster-id\":\"cdf818194e3a8c32\",\"publish-timeout\":\"7s\"}\r\n2023/11/23 11:33:43 Embedded etcd is ready!\r\npanic: runtime error: invalid memory address or nil pointer dereference\r\n[signal SIGSEGV: segmentation violation code=0x1 addr=0x10 pc=0xa41eac]\r\n\r\ngoroutine 1 [running]:\r\nsync.(*RWMutex).RLock(...)\r\n        C:/Program Files/Go1.19/go/src/sync/rwmutex.go:69\r\ngo.etcd.io/etcd/client/v3.(*Client).Endpoints(0xc00066e540)\r\n        go/pkg/mod/go.etcd.io/etcd/client/v3@v3.5.10/client.go:164 +0x4c\r\nmain.main()\r\n        D:/01work/code/go/test/main.go:25 +0x18a\r\n\r\n```\r\n```\r\n","closed_by":{"login":"github-actions[bot]","id":41898282,"node_id":"MDM6Qm90NDE4OTgyODI=","avatar_url":"https://avatars.githubusercontent.com/in/15368?v=4","gravatar_id":"","url":"https://api.github.com/users/github-actions%5Bbot%5D","html_url":"https://github.com/apps/github-actions","followers_url":"https://api.github.com/users/github-actions%5Bbot%5D/followers","following_url":"https://api.github.com/users/github-actions%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/github-actions%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/github-actions%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/github-actions%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/github-actions%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/github-actions%5Bbot%5D/repos","events_url":"https://api.github.com/users/github-actions%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/github-actions%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/etcd-io/etcd/issues/17001/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/etcd-io/etcd/issues/17001/timeline","performed_via_github_app":null,"state_reason":"not_planned"}