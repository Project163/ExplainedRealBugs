{"url":"https://api.github.com/repos/etcd-io/etcd/issues/10688","repository_url":"https://api.github.com/repos/etcd-io/etcd","labels_url":"https://api.github.com/repos/etcd-io/etcd/issues/10688/labels{/name}","comments_url":"https://api.github.com/repos/etcd-io/etcd/issues/10688/comments","events_url":"https://api.github.com/repos/etcd-io/etcd/issues/10688/events","html_url":"https://github.com/etcd-io/etcd/issues/10688","id":438083353,"node_id":"MDU6SXNzdWU0MzgwODMzNTM=","number":10688,"title":"WAL not cleaned up on failed creation","user":{"login":"joshcc3","id":2796667,"node_id":"MDQ6VXNlcjI3OTY2Njc=","avatar_url":"https://avatars.githubusercontent.com/u/2796667?v=4","gravatar_id":"","url":"https://api.github.com/users/joshcc3","html_url":"https://github.com/joshcc3","followers_url":"https://api.github.com/users/joshcc3/followers","following_url":"https://api.github.com/users/joshcc3/following{/other_user}","gists_url":"https://api.github.com/users/joshcc3/gists{/gist_id}","starred_url":"https://api.github.com/users/joshcc3/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/joshcc3/subscriptions","organizations_url":"https://api.github.com/users/joshcc3/orgs","repos_url":"https://api.github.com/users/joshcc3/repos","events_url":"https://api.github.com/users/joshcc3/events{/privacy}","received_events_url":"https://api.github.com/users/joshcc3/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2019-04-28T18:04:38Z","updated_at":"2019-05-10T22:09:17Z","closed_at":"2019-05-10T22:09:17Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I ran etcd (default config) with the data-dir located in a bind mounted directory in a container running on windows. This [Fsync](https://github.com/etcd-io/etcd/blob/efcc1088f038915f9e5dcc456e7f9d4412a49b74/wal/wal.go#L200) is not supported and on the first run it Panics without cleaning up the WAL dir. As a consequence, on the subsequent run the node enters 'restart' mode however since the peers haven't been added it isn't able to make 'progress' and choose a leader and times out trying to publish its information into the cluster.\r\nWhile I dont think etcd needs to support this type of storage, I do think that getting to this stage is a bug. I'm interested in contributing to etcd and would be interested in tackling this issue.\r\n\r\nOn the first run (fails to fsync)\r\n```\r\nroot@ea793ad78415:/workdir/etcd# rm -rf default.etcd\r\nroot@ea793ad78415:/workdir/etcd# ./build && ./bin/etcd --logger zap\r\n{\"level\":\"warn\",\"ts\":\"2019-04-28T17:34:03.360Z\",\"caller\":\"etcdmain/etcd.go:119\",\"msg\":\"'data-dir' was empty; using default\",\"data-dir\":\"default.etcd\"}\r\n{\"level\":\"info\",\"ts\":\"2019-04-28T17:34:03.361Z\",\"caller\":\"embed/etcd.go:117\",\"msg\":\"configuring peer listeners\",\"listen-peer-urls\":[\"http://localhost:2380\"]}\r\n{\"level\":\"info\",\"ts\":\"2019-04-28T17:34:03.361Z\",\"caller\":\"embed/etcd.go:127\",\"msg\":\"configuring client listeners\",\"listen-client-urls\":[\"http://localhost:2379\"]}\r\n{\"level\":\"info\",\"ts\":\"2019-04-28T17:34:03.362Z\",\"caller\":\"embed/etcd.go:297\",\"msg\":\"starting an etcd server\",\"etcd-version\":\"3.3.0+git\",\"git-sha\":\"efcc1088f\",\"go-versio\r\nn\":\"go1.11.4\",\"go-os\":\"linux\",\"go-arch\":\"amd64\",\"max-cpu-set\":2,\"max-cpu-available\":2,\"member-initialized\":false,\"name\":\"default\",\"data-dir\":\"default.etcd\",\"wal-dir\":\"\"\r\n,\"wal-dir-dedicated\":\"\",\"member-dir\":\"default.etcd/member\",\"force-new-cluster\":false,\"heartbeat-interval\":\"100ms\",\"election-timeout\":\"1s\",\"initial-election-tick-advance\r\n\":true,\"snapshot-count\":100000,\"snapshot-catchup-entries\":5000,\"initial-advertise-peer-urls\":[\"http://localhost:2380\"],\"listen-peer-urls\":[\"http://localhost:2380\"],\"adv\r\nertise-client-urls\":[\"http://localhost:2379\"],\"listen-client-urls\":[\"http://localhost:2379\"],\"listen-metrics-urls\":[],\"cors\":[\"*\"],\"host-whitelist\":[\"*\"],\"initial-clust\r\ner\":\"default=http://localhost:2380\",\"initial-cluster-state\":\"new\",\"initial-cluster-token\":\"etcd-cluster\",\"quota-size-bytes\":2147483648,\"pre-vote\":false,\"initial-corrupt\r\n-check\":false,\"corrupt-check-time-interval\":\"0s\",\"auto-compaction-mode\":\"periodic\",\"auto-compaction-retention\":\"0s\",\"auto-compaction-interval\":\"0s\",\"discovery-url\":\"\",\"\r\ndiscovery-proxy\":\"\"}\r\n{\"level\":\"info\",\"ts\":\"2019-04-28T17:34:03.384Z\",\"caller\":\"etcdserver/backend.go:79\",\"msg\":\"opened backend db\",\"path\":\"default.etcd/member/snap/db\",\"took\":\"3.8817ms\"}\r\n{\"level\":\"info\",\"ts\":\"2019-04-28T17:34:03.403Z\",\"caller\":\"wal/wal.go:252\",\"msg\":\"closing WAL to release flock and retry directory renaming\",\"from\":\"default.etcd/member/\r\nwal.tmp\",\"to\":\"default.etcd/member/wal\"}\r\n{\"level\":\"warn\",\"ts\":\"2019-04-28T17:34:03.426Z\",\"caller\":\"wal/wal.go:202\",\"msg\":\"failed to fsync the parent data directory file\",\"parent-dir-path\":\"default.etcd/member\"\r\n,\"dir-path\":\"default.etcd/member/wal\",\"error\":\"sync default.etcd/member: invalid argument\"}\r\n{\"level\":\"panic\",\"ts\":\"2019-04-28T17:34:03.426Z\",\"caller\":\"etcdserver/raft.go:432\",\"msg\":\"failed to create WAL\",\"error\":\"sync default.etcd/member: invalid argument\",\"st\r\nacktrace\":\"go.etcd.io/etcd/etcdserver.startNode\\n\\t/workdir/etcd/etcdserver/raft.go:432\\ngo.etcd.io/etcd/etcdserver.NewServer\\n\\t/workdir/etcd/etcdserver/server.go:399\\\r\nngo.etcd.io/etcd/embed.StartEtcd\\n\\t/workdir/etcd/embed/etcd.go:209\\ngo.etcd.io/etcd/etcdmain.startEtcd\\n\\t/workdir/etcd/etcdmain/etcd.go:302\\ngo.etcd.io/etcd/etcdmain.\r\nstartEtcdOrProxyV2\\n\\t/workdir/etcd/etcdmain/etcd.go:160\\ngo.etcd.io/etcd/etcdmain.Main\\n\\t/workdir/etcd/etcdmain/main.go:46\\nmain.main\\n\\t/workdir/etcd/main.go:28\\nrun\r\ntime.main\\n\\t/usr/local/go/src/runtime/proc.go:201\"}\r\npanic: failed to create WAL\r\n\r\ngoroutine 1 [running]:\r\ngo.uber.org/zap/zapcore.(*CheckedEntry).Write(0xc000084d10, 0xc00006cec0, 0x1, 0x1)\r\n        /code/raft-go/pkg/mod/go.uber.org/zap@v1.9.1/zapcore/entry.go:229 +0x515\r\ngo.uber.org/zap.(*Logger).Panic(0xc00006f2c0, 0xf1cefb, 0x14, 0xc00006cec0, 0x1, 0x1)\r\n        /code/raft-go/pkg/mod/go.uber.org/zap@v1.9.1/logger.go:225 +0x7f\r\ngo.etcd.io/etcd/etcdserver.startNode(0xf117a1, 0x7, 0x0, 0x0, 0x0, 0x0, 0xc00019cd80, 0x1, 0x1, 0xc00019cc00, ...)\r\n        /workdir/etcd/etcdserver/raft.go:432 +0x33c\r\ngo.etcd.io/etcd/etcdserver.NewServer(0xf117a1, 0x7, 0x0, 0x0, 0x0, 0x0, 0xc00019cd80, 0x1, 0x1, 0xc00019cc00, ...)\r\n        /workdir/etcd/etcdserver/server.go:399 +0x4187\r\ngo.etcd.io/etcd/embed.StartEtcd(0xc000288000, 0xc0003ec000, 0x0, 0x0)\r\n        /workdir/etcd/embed/etcd.go:209 +0x959\r\ngo.etcd.io/etcd/etcdmain.startEtcd(0xc000288000, 0xf0e862, 0x3, 0xf0f801, 0x5)\r\n        /workdir/etcd/etcdmain/etcd.go:302 +0x40\r\ngo.etcd.io/etcd/etcdmain.startEtcdOrProxyV2()\r\n        /workdir/etcd/etcdmain/etcd.go:160 +0x33a2\r\ngo.etcd.io/etcd/etcdmain.Main()\r\n        /workdir/etcd/etcdmain/main.go:46 +0x37\r\nmain.main()\r\n        /workdir/etcd/main.go:28 +0x20\r\n```\r\nInitial entries to bootstrap peers have not been added to the log but it still exists\r\n```\r\nroot@ea793ad78415:/workdir/etcd# ls -lart default.etcd/member/wal\r\ntotal 125000\r\n-rwxr-xr-x 1 root root 64000000 Apr 28 17:34 0.tmp\r\n-rwxr-xr-x 1 root root 64000000 Apr 28 17:34 0000000000000000-0000000000000000.wal\r\ndrwxrwxrwx 2 root root        0 Apr 28 17:34 .\r\ndrwxrwxrwx 2 root root        0 Apr 28 17:34 ..\r\n```\r\n\r\nSubsequent run where it times out trying to publish info:\r\n```\r\nroot@ea793ad78415:/workdir/etcd# ./bin/etcd --logger zap\r\n{\"level\":\"warn\",\"ts\":\"2019-04-28T17:34:15.203Z\",\"caller\":\"etcdmain/etcd.go:119\",\"msg\":\"'data-dir' was empty; using default\",\"data-dir\":\"default.etcd\"}\r\n{\"level\":\"info\",\"ts\":\"2019-04-28T17:34:15.206Z\",\"caller\":\"etcdmain/etcd.go:134\",\"msg\":\"server has been already initialized\",\"data-dir\":\"default.etcd\",\"dir-type\":\"member\r\n\"}\r\n{\"level\":\"info\",\"ts\":\"2019-04-28T17:34:15.206Z\",\"caller\":\"embed/etcd.go:117\",\"msg\":\"configuring peer listeners\",\"listen-peer-urls\":[\"http://localhost:2380\"]}\r\n{\"level\":\"info\",\"ts\":\"2019-04-28T17:34:15.207Z\",\"caller\":\"embed/etcd.go:127\",\"msg\":\"configuring client listeners\",\"listen-client-urls\":[\"http://localhost:2379\"]}\r\n{\"level\":\"info\",\"ts\":\"2019-04-28T17:34:15.209Z\",\"caller\":\"embed/etcd.go:297\",\"msg\":\"starting an etcd server\",\"etcd-version\":\"3.3.0+git\",\"git-sha\":\"efcc1088f\",\"go-versio\r\nn\":\"go1.11.4\",\"go-os\":\"linux\",\"go-arch\":\"amd64\",\"max-cpu-set\":2,\"max-cpu-available\":2,\"member-initialized\":true,\"name\":\"default\",\"data-dir\":\"default.etcd\",\"wal-dir\":\"\",\r\n\"wal-dir-dedicated\":\"\",\"member-dir\":\"default.etcd/member\",\"force-new-cluster\":false,\"heartbeat-interval\":\"100ms\",\"election-timeout\":\"1s\",\"initial-election-tick-advance\"\r\n:true,\"snapshot-count\":100000,\"snapshot-catchup-entries\":5000,\"initial-advertise-peer-urls\":[\"http://localhost:2380\"],\"listen-peer-urls\":[\"http://localhost:2380\"],\"adve\r\nrtise-client-urls\":[\"http://localhost:2379\"],\"listen-client-urls\":[\"http://localhost:2379\"],\"listen-metrics-urls\":[],\"cors\":[\"*\"],\"host-whitelist\":[\"*\"],\"initial-cluste\r\nr\":\"\",\"initial-cluster-state\":\"new\",\"initial-cluster-token\":\"\",\"quota-size-bytes\":2147483648,\"pre-vote\":false,\"initial-corrupt-check\":false,\"corrupt-check-time-interval\r\n\":\"0s\",\"auto-compaction-mode\":\"periodic\",\"auto-compaction-retention\":\"0s\",\"auto-compaction-interval\":\"0s\",\"discovery-url\":\"\",\"discovery-proxy\":\"\"}\r\n{\"level\":\"info\",\"ts\":\"2019-04-28T17:34:15.224Z\",\"caller\":\"etcdserver/backend.go:79\",\"msg\":\"opened backend db\",\"path\":\"default.etcd/member/snap/db\",\"took\":\"2.4036ms\"}\r\n{\"level\":\"info\",\"ts\":\"2019-04-28T17:34:15.249Z\",\"caller\":\"etcdserver/raft.go:498\",\"msg\":\"restarting local member\",\"cluster-id\":\"cdf818194e3a8c32\",\"local-member-id\":\"8e9\r\ne05c52164694d\",\"commit-index\":0}\r\n{\"level\":\"info\",\"ts\":\"2019-04-28T17:34:15.250Z\",\"caller\":\"raft/raft.go:712\",\"msg\":\"8e9e05c52164694d became follower at term 0\"}\r\n{\"level\":\"info\",\"ts\":\"2019-04-28T17:34:15.250Z\",\"caller\":\"raft/raft.go:389\",\"msg\":\"newRaft 8e9e05c52164694d [peers: [], term: 0, commit: 0, applied: 0, lastindex: 0, la\r\nstterm: 0]\"}\r\n{\"level\":\"warn\",\"ts\":\"2019-04-28T17:34:15.264Z\",\"caller\":\"auth/store.go:1288\",\"msg\":\"simple token is not cryptographically signed\"}\r\n{\"level\":\"info\",\"ts\":\"2019-04-28T17:34:15.273Z\",\"caller\":\"etcdserver/quota.go:98\",\"msg\":\"enabled backend quota with default value\",\"quota-name\":\"v3-applier\",\"quota-size\r\n-bytes\":2147483648,\"quota-size\":\"2.1 GB\"}\r\n{\"level\":\"info\",\"ts\":\"2019-04-28T17:34:15.277Z\",\"caller\":\"etcdserver/server.go:774\",\"msg\":\"starting etcd server\",\"local-member-id\":\"8e9e05c52164694d\",\"local-server-vers\r\nion\":\"3.3.0+git\",\"cluster-version\":\"to_be_decided\"}\r\n{\"level\":\"info\",\"ts\":\"2019-04-28T17:34:15.279Z\",\"caller\":\"embed/etcd.go:239\",\"msg\":\"now serving peer/client/metrics\",\"local-member-id\":\"8e9e05c52164694d\",\"initial-adver\r\ntise-peer-urls\":[\"http://localhost:2380\"],\"listen-peer-urls\":[\"http://localhost:2380\"],\"advertise-client-urls\":[\"http://localhost:2379\"],\"listen-client-urls\":[\"http://l\r\nocalhost:2379\"],\"listen-metrics-urls\":[]}\r\n{\"level\":\"info\",\"ts\":\"2019-04-28T17:34:15.279Z\",\"caller\":\"embed/etcd.go:574\",\"msg\":\"serving peer traffic\",\"address\":\"127.0.0.1:2380\"}\r\n{\"level\":\"info\",\"ts\":\"2019-04-28T17:34:15.280Z\",\"caller\":\"etcdserver/server.go:662\",\"msg\":\"starting initial election tick advance\",\"election-ticks\":10}\r\n{\"level\":\"warn\",\"ts\":\"2019-04-28T17:34:22.280Z\",\"caller\":\"etcdserver/server.go:1853\",\"msg\":\"failed to publish local member to cluster through raft\",\"local-member-id\":\"8\r\ne9e05c52164694d\",\"local-member-attributes\":\"{Name:default ClientURLs:[http://localhost:2379]}\",\"request-path\":\"/0/members/8e9e05c52164694d/attributes\",\"publish-timeout\"\r\n:\"7s\",\"error\":\"etcdserver: request timed out\"}\r\n^C\r\n```\r\n\r\nI think (one of?) 2 things could be done:\r\n - Delete the WAL dir and panic if anything after the rename fails so that it's not left in an inconsistent state after a panic.\r\n - If no entries are detected in a WAL on startup then add them in.\r\n\r\n\r\nLet me know your thoughts? \r\nI'm not too familiar with the code base yet but I think that's the cause?\r\n\r\n","closed_by":{"login":"xiang90","id":4479947,"node_id":"MDQ6VXNlcjQ0Nzk5NDc=","avatar_url":"https://avatars.githubusercontent.com/u/4479947?v=4","gravatar_id":"","url":"https://api.github.com/users/xiang90","html_url":"https://github.com/xiang90","followers_url":"https://api.github.com/users/xiang90/followers","following_url":"https://api.github.com/users/xiang90/following{/other_user}","gists_url":"https://api.github.com/users/xiang90/gists{/gist_id}","starred_url":"https://api.github.com/users/xiang90/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/xiang90/subscriptions","organizations_url":"https://api.github.com/users/xiang90/orgs","repos_url":"https://api.github.com/users/xiang90/repos","events_url":"https://api.github.com/users/xiang90/events{/privacy}","received_events_url":"https://api.github.com/users/xiang90/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/etcd-io/etcd/issues/10688/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/etcd-io/etcd/issues/10688/timeline","performed_via_github_app":null,"state_reason":"completed"}