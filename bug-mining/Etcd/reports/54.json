{"url":"https://api.github.com/repos/etcd-io/etcd/issues/19253","repository_url":"https://api.github.com/repos/etcd-io/etcd","labels_url":"https://api.github.com/repos/etcd-io/etcd/issues/19253/labels{/name}","comments_url":"https://api.github.com/repos/etcd-io/etcd/issues/19253/comments","events_url":"https://api.github.com/repos/etcd-io/etcd/issues/19253/events","html_url":"https://github.com/etcd-io/etcd/issues/19253","id":2803747980,"node_id":"I_kwDOAKtHts6nHcyM","number":19253,"title":"etcdutl Snapshot Status: TotalKey Calculation Inquiry","user":{"login":"jxustc","id":8032725,"node_id":"MDQ6VXNlcjgwMzI3MjU=","avatar_url":"https://avatars.githubusercontent.com/u/8032725?v=4","gravatar_id":"","url":"https://api.github.com/users/jxustc","html_url":"https://github.com/jxustc","followers_url":"https://api.github.com/users/jxustc/followers","following_url":"https://api.github.com/users/jxustc/following{/other_user}","gists_url":"https://api.github.com/users/jxustc/gists{/gist_id}","starred_url":"https://api.github.com/users/jxustc/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jxustc/subscriptions","organizations_url":"https://api.github.com/users/jxustc/orgs","repos_url":"https://api.github.com/users/jxustc/repos","events_url":"https://api.github.com/users/jxustc/events{/privacy}","received_events_url":"https://api.github.com/users/jxustc/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":4108243858,"node_id":"LA_kwDOAKtHts703tOS","url":"https://api.github.com/repos/etcd-io/etcd/labels/stage/triaged","name":"stage/triaged","color":"2D8E09","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2025-01-22T08:40:39Z","updated_at":"2025-02-07T15:15:19Z","closed_at":"2025-02-07T15:15:19Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"\n### Discussed in https://github.com/etcd-io/etcd/discussions/19012\n\n<div type='discussions-op-text'>\n\n<sup>Originally posted by **jxustc** December  5, 2024</sup>\n## Problem Description\r\nWhen using the `etcdutl snapshot status` command, I've observed the following characteristics of TotalKey calculation:\r\n- Current implementation counts keys across all buckets in the bbolt database\r\n- Includes keys beyond visible etcd key-value data\r\n- Key counts in other buckets may vary with different etcd versions\r\n\r\n## Case\r\n<img width=\"978\" alt=\"image\" src=\"https://github.com/user-attachments/assets/dd2093de-1357-476a-87b0-a3d5de2ed21d\">\r\n\r\n![image](https://github.com/user-attachments/assets/7878cd3a-28ec-4fbf-b586-033beb4d0d3a)\r\n\r\n\r\nDuring  testing, I discovered that the TotalKey calculation includes keys from various internal buckets beyond the main key-value store:\r\n### Identified Included Keys\r\n- In `meta` bucket:\r\n  - `term`\r\n  - `scheduledCompactRev`\r\n  - `confState`\r\n  - ...\r\n- In `auth` bucket:\r\n  - `authRevision`\r\n- Keys from other internal buckets\r\n\r\n\r\n## Specific Questions\r\n1. What is the precise definition of TotalKey?\r\n2. Is the current calculation method appropriate?\r\n3. Should the count be limited to etcd key-value entries?\r\n\r\n## Potential Implementation Approach\r\n\r\n```golang\r\nfunc (s *v3Manager) Status(dbPath string) (ds Status, err error) {\r\n\t...\r\n\tif err = db.View(func(tx *bolt.Tx) error {\r\n\t\t...\r\n\t\tc := tx.Cursor()\r\n\t\tfor next, _ := c.First(); next != nil; next, _ = c.Next() {\r\n\t\t\tb := tx.Bucket(next)\r\n\t\t\tif b == nil {\r\n\t\t\t\treturn fmt.Errorf(\"nil bucket: %q\", string(next))\r\n\t\t\t}\r\n\t\t\t_, err = h.Write(next)\r\n\t\t\tif err != nil {\r\n\t\t\t\treturn fmt.Errorf(\"cannot hash bucket name: %q err: %w\", string(next), err)\r\n\t\t\t}\r\n\r\n\t\t\tiskeyb := (bytes.Equal(next, schema.Key.Name()))\r\n\t\t\tif err = b.ForEach(func(k, v []byte) error {\r\n\t\t\t\t_, err = h.Write(k)\r\n\t\t\t\tif err != nil {\r\n\t\t\t\t\treturn fmt.Errorf(\"cannot hash bucket key: %q err: %w\", k, err)\r\n\t\t\t\t}\r\n\t\t\t\t_, err = h.Write(v)\r\n\t\t\t\tif err != nil {\r\n\t\t\t\t\treturn fmt.Errorf(\"cannot hash bucket key: %q value: %q err: %w\", k, v, err)\r\n\t\t\t\t}\r\n\t\t\t\tif iskeyb {\r\n\t\t\t\t\tvar rev mvcc.Revision\r\n\t\t\t\t\trev, err = bytesToRev(k)\r\n\t\t\t\t\tif err != nil {\r\n\t\t\t\t\t\treturn fmt.Errorf(\"cannot parse revision key: %q err: %w\", k, err)\r\n\t\t\t\t\t}\r\n\t\t\t\t\tds.Revision = rev.Main\r\n\r\n\t\t\t\t\tvar kv mvccpb.KeyValue\r\n\t\t\t\t\terr = kv.Unmarshal(v)\r\n\t\t\t\t\tif err != nil {\r\n\t\t\t\t\t\treturn fmt.Errorf(\"cannot unmarshal value, key: %q value: %q err: %w\", k, v, err)\r\n\t\t\t\t\t}\r\n                                         // move to here \r\n                                         ds.TotalKey++\r\n\t\t\t\t}\r\n                                 // remove \r\n\t\t\t\tds.TotalKey++\r\n\t\t\t\treturn nil\r\n\t\t\t}); err != nil {\r\n\t\t\t\treturn fmt.Errorf(\"error during bucket key iteration, name: %q err: %w\", string(next), err)\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn nil\r\n\t}); err != nil {\r\n\t\treturn ds, err\r\n\t}\r\n...\r\n}\r\n```\r\n\r\n**Besides this solution, could we possibly add a field to count the number of non-built-in key-value pairs in etcd?**\r\n\r\n## Proposed Improvement\r\n\r\nIf appropriate, I am willing to submit a PR to implement this change. </div>","closed_by":{"login":"ahrtr","id":30739825,"node_id":"MDQ6VXNlcjMwNzM5ODI1","avatar_url":"https://avatars.githubusercontent.com/u/30739825?v=4","gravatar_id":"","url":"https://api.github.com/users/ahrtr","html_url":"https://github.com/ahrtr","followers_url":"https://api.github.com/users/ahrtr/followers","following_url":"https://api.github.com/users/ahrtr/following{/other_user}","gists_url":"https://api.github.com/users/ahrtr/gists{/gist_id}","starred_url":"https://api.github.com/users/ahrtr/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ahrtr/subscriptions","organizations_url":"https://api.github.com/users/ahrtr/orgs","repos_url":"https://api.github.com/users/ahrtr/repos","events_url":"https://api.github.com/users/ahrtr/events{/privacy}","received_events_url":"https://api.github.com/users/ahrtr/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/etcd-io/etcd/issues/19253/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/etcd-io/etcd/issues/19253/timeline","performed_via_github_app":null,"state_reason":"completed"}