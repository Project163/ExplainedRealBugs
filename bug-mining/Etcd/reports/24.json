{"url":"https://api.github.com/repos/etcd-io/etcd/issues/12680","repository_url":"https://api.github.com/repos/etcd-io/etcd","labels_url":"https://api.github.com/repos/etcd-io/etcd/issues/12680/labels{/name}","comments_url":"https://api.github.com/repos/etcd-io/etcd/issues/12680/comments","events_url":"https://api.github.com/repos/etcd-io/etcd/issues/12680/events","html_url":"https://github.com/etcd-io/etcd/issues/12680","id":804762655,"node_id":"MDU6SXNzdWU4MDQ3NjI2NTU=","number":12680,"title":"Small number of high latency requests after a leader election","user":{"login":"Cjen1","id":11444677,"node_id":"MDQ6VXNlcjExNDQ0Njc3","avatar_url":"https://avatars.githubusercontent.com/u/11444677?v=4","gravatar_id":"","url":"https://api.github.com/users/Cjen1","html_url":"https://github.com/Cjen1","followers_url":"https://api.github.com/users/Cjen1/followers","following_url":"https://api.github.com/users/Cjen1/following{/other_user}","gists_url":"https://api.github.com/users/Cjen1/gists{/gist_id}","starred_url":"https://api.github.com/users/Cjen1/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Cjen1/subscriptions","organizations_url":"https://api.github.com/users/Cjen1/orgs","repos_url":"https://api.github.com/users/Cjen1/repos","events_url":"https://api.github.com/users/Cjen1/events{/privacy}","received_events_url":"https://api.github.com/users/Cjen1/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":848127959,"node_id":"MDU6TGFiZWw4NDgxMjc5NTk=","url":"https://api.github.com/repos/etcd-io/etcd/labels/stage/investigating","name":"stage/investigating","color":"E0E0E0","default":false,"description":""},{"id":2717379621,"node_id":"MDU6TGFiZWwyNzE3Mzc5NjIx","url":"https://api.github.com/repos/etcd-io/etcd/labels/priority/important-soon","name":"priority/important-soon","color":"D93F0B","default":false,"description":"Must be staffed and worked on either currently, or very soon, ideally in time for the next release."}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":13,"created_at":"2021-02-09T17:35:52Z","updated_at":"2021-03-23T14:57:35Z","closed_at":"2021-03-23T14:57:35Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I've recently been testing etcd's availability around leader failures.\r\n\r\nIf I create a new client is follows: \r\n```\r\n  cli_v3, err := clientv3.New(clientv3.Config{\r\n          Endpoints:            endpoints,\r\n          DialTimeout:          dialTimeout,\r\n          DialKeepAliveTime:    dialTimeout / 2,\r\n          DialKeepAliveTimeout: dialTimeout * 2,\r\n          AutoSyncInterval:     dialTimeout / 2,\r\n  })\r\n```\r\n\r\nAnd the load generator dispatches 1000 requests per second, using a new goroutine for each requests such that each request is applied asynchronously.\r\n\r\nIn a three node configuration when I kill the leader 20s into the test (it restarts at 40s), I observe the following odd behaviour:\r\n\r\n![etcd-leader](https://user-images.githubusercontent.com/11444677/107401458-cdad7f80-6afa-11eb-98d1-82faf129a05e.png)\r\n\r\nThis shows the latency of requests dispatched at a given point in time.\r\n\r\nAt 20s the leader is killed and a leader election occurs, thus requests submitted during this period are stalled until the election completes. This explains the lack of requests submitted between 20s and 21s which have latencies lower than a 100ms.\r\n\r\nHowever after the election there is a subset of requests (~10%-15%) which are stalled for a further about 8s (the curving down line of high latency requests).\r\n\r\nAre there any possible reasons for this? I've found it to be relatively reproducible, but can't find a possible reason for it.\r\n\r\n(The nodes are all running on my local machine. The nodes and the client are running etcd v3.4.14)","closed_by":{"login":"ptabor","id":11505763,"node_id":"MDQ6VXNlcjExNTA1NzYz","avatar_url":"https://avatars.githubusercontent.com/u/11505763?v=4","gravatar_id":"","url":"https://api.github.com/users/ptabor","html_url":"https://github.com/ptabor","followers_url":"https://api.github.com/users/ptabor/followers","following_url":"https://api.github.com/users/ptabor/following{/other_user}","gists_url":"https://api.github.com/users/ptabor/gists{/gist_id}","starred_url":"https://api.github.com/users/ptabor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ptabor/subscriptions","organizations_url":"https://api.github.com/users/ptabor/orgs","repos_url":"https://api.github.com/users/ptabor/repos","events_url":"https://api.github.com/users/ptabor/events{/privacy}","received_events_url":"https://api.github.com/users/ptabor/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/etcd-io/etcd/issues/12680/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/etcd-io/etcd/issues/12680/timeline","performed_via_github_app":null,"state_reason":"completed"}