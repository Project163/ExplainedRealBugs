{"url":"https://api.github.com/repos/etcd-io/etcd/issues/14325","repository_url":"https://api.github.com/repos/etcd-io/etcd","labels_url":"https://api.github.com/repos/etcd-io/etcd/issues/14325/labels{/name}","comments_url":"https://api.github.com/repos/etcd-io/etcd/issues/14325/comments","events_url":"https://api.github.com/repos/etcd-io/etcd/issues/14325/events","html_url":"https://github.com/etcd-io/etcd/issues/14325","id":1333337320,"node_id":"I_kwDOAKtHts5PeRzo","number":14325,"title":"Periodic corruption check doesn’t do anything after compaction","user":{"login":"justinhellreich-stripe","id":92693517,"node_id":"U_kgDOBYZkDQ","avatar_url":"https://avatars.githubusercontent.com/u/92693517?v=4","gravatar_id":"","url":"https://api.github.com/users/justinhellreich-stripe","html_url":"https://github.com/justinhellreich-stripe","followers_url":"https://api.github.com/users/justinhellreich-stripe/followers","following_url":"https://api.github.com/users/justinhellreich-stripe/following{/other_user}","gists_url":"https://api.github.com/users/justinhellreich-stripe/gists{/gist_id}","starred_url":"https://api.github.com/users/justinhellreich-stripe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/justinhellreich-stripe/subscriptions","organizations_url":"https://api.github.com/users/justinhellreich-stripe/orgs","repos_url":"https://api.github.com/users/justinhellreich-stripe/repos","events_url":"https://api.github.com/users/justinhellreich-stripe/events{/privacy}","received_events_url":"https://api.github.com/users/justinhellreich-stripe/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":46697272,"node_id":"MDU6TGFiZWw0NjY5NzI3Mg==","url":"https://api.github.com/repos/etcd-io/etcd/labels/type/bug","name":"type/bug","color":"d61552","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-08-09T14:23:39Z","updated_at":"2022-10-13T07:17:39Z","closed_at":"2022-10-13T07:17:39Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### What happened?\n\nAfter turning on `--experimental-corrupt-check-time`, I’ve noticed that any time there has been a compaction and no recent write to etcd, the corruption check fails to actually run. \r\n\r\nThe output on the leader is\r\n```\r\n{\"level\":\"info\",\"ts\":\"2022-08-02T17:55:38.557Z\",\"caller\":\"etcdserver/corrupt.go:244\",\"msg\":\"finished peer corruption check\",\"number-of-peers-checked\":0}\r\n```\r\n\r\nLooking at a follower, we see the requested revision has been compacted\r\n\r\n```\r\n{\"level\":\"warn\",\"ts\":\"2022-08-02T17:48:38.516Z\",\"caller\":\"etcdserver/corrupt.go:377\",\"msg\":\"failed to get hashKV\",\"requested-revision\":2592,\"error\":\"mvcc: required revision has been compacted\"}\r\n```\r\n\r\nI then wrote a key to etcd and observed the corruption check working correctly on the next run.\n\n### What did you expect to happen?\n\nThe corruption check should work regardless of whether or not a compaction has happened very recently.\n\n### How can we reproduce it (as minimally and precisely as possible)?\n\n- Set `--experimental-corrupt-check-time` to something very short like 1m\r\n- Compact your etcd cluster\r\n- Note that the next corruption check doesn't work\r\n- Insert a key into etcd\r\n- Note that the next corruption check does work\n\n### Anything else we need to know?\n\n_No response_\n\n### Etcd version (please run commands below)\n\n<details>\r\n\r\n```console\r\n$ etcd --version\r\netcd Version: 3.5.3\r\nGit SHA: GitNotFound\r\nGo Version: go1.16.2\r\nGo OS/Arch: linux/amd64\r\n\r\n$ etcdctl version\r\netcdctl version: 3.5.3\r\nAPI version: 3.5\r\n```\r\n\r\n</details>\r\n\n\n### Etcd configuration (command line flags or environment variables)\n\n<details>\r\n  ...\r\n  --enable-v2=false\r\n  --auto-compaction-retention=1h\r\n  --experimental-corrupt-check-time=6h\r\n  --experimental-initial-corrupt-check\r\n  --log-level 'info'\r\n  ...\r\n</details>\r\n\n\n### Etcd debug information (please run commands blow, feel free to obfuscate the IP address or FQDN in the output)\n\n<details>\r\n\r\nLeaving these off. Happy to share more details if required. It is a healthy five node cluster, no learners, all running v3.5.3.\r\n\r\n```console\r\n$ etcdctl member list -w table\r\n# paste output here\r\n\r\n$ etcdctl --endpoints=<member list> endpoint status -w table\r\n# paste output here\r\n```\r\n\r\n</details>\r\n\n\n### Relevant log output\n\n_No response_","closed_by":{"login":"ahrtr","id":30739825,"node_id":"MDQ6VXNlcjMwNzM5ODI1","avatar_url":"https://avatars.githubusercontent.com/u/30739825?v=4","gravatar_id":"","url":"https://api.github.com/users/ahrtr","html_url":"https://github.com/ahrtr","followers_url":"https://api.github.com/users/ahrtr/followers","following_url":"https://api.github.com/users/ahrtr/following{/other_user}","gists_url":"https://api.github.com/users/ahrtr/gists{/gist_id}","starred_url":"https://api.github.com/users/ahrtr/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ahrtr/subscriptions","organizations_url":"https://api.github.com/users/ahrtr/orgs","repos_url":"https://api.github.com/users/ahrtr/repos","events_url":"https://api.github.com/users/ahrtr/events{/privacy}","received_events_url":"https://api.github.com/users/ahrtr/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/etcd-io/etcd/issues/14325/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/etcd-io/etcd/issues/14325/timeline","performed_via_github_app":null,"state_reason":"completed"}