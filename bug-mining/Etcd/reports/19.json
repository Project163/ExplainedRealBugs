{"url":"https://api.github.com/repos/etcd-io/etcd/issues/12385","repository_url":"https://api.github.com/repos/etcd-io/etcd","labels_url":"https://api.github.com/repos/etcd-io/etcd/issues/12385/labels{/name}","comments_url":"https://api.github.com/repos/etcd-io/etcd/issues/12385/comments","events_url":"https://api.github.com/repos/etcd-io/etcd/issues/12385/events","html_url":"https://github.com/etcd-io/etcd/issues/12385","id":718619228,"node_id":"MDU6SXNzdWU3MTg2MTkyMjg=","number":12385,"title":"watch stream return \"permission denied\" if token expired","user":{"login":"cfz","id":1214480,"node_id":"MDQ6VXNlcjEyMTQ0ODA=","avatar_url":"https://avatars.githubusercontent.com/u/1214480?v=4","gravatar_id":"","url":"https://api.github.com/users/cfz","html_url":"https://github.com/cfz","followers_url":"https://api.github.com/users/cfz/followers","following_url":"https://api.github.com/users/cfz/following{/other_user}","gists_url":"https://api.github.com/users/cfz/gists{/gist_id}","starred_url":"https://api.github.com/users/cfz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cfz/subscriptions","organizations_url":"https://api.github.com/users/cfz/orgs","repos_url":"https://api.github.com/users/cfz/repos","events_url":"https://api.github.com/users/cfz/events{/privacy}","received_events_url":"https://api.github.com/users/cfz/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":20,"created_at":"2020-10-10T13:22:18Z","updated_at":"2025-07-30T02:28:35Z","closed_at":"2022-09-19T14:33:50Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"i ran into the similar problem as #8914\r\n\r\ni'm using v3.4.13 server and v3.4.12 client.\r\ni can reproduce the error using following steps:\r\n\r\non one terminal , start etcd server and enable auth and shroten the default token ttl:\r\n```\r\netcd --log-level warn --logger zap --auth-token-ttl 10 & \r\netcdctl user add root:root\r\netcdctl user grant-role root root\r\netcdctl auth enable\r\n```\r\n\r\non the other termianal, run a the demo program:\r\n```\r\ncfz@cfz-desktop:~/ws/etcd-watch-demo$ cat main.go\r\npackage main\r\n\r\nimport (\r\n        \"context\"\r\n        \"fmt\"\r\n        \"sync\"\r\n        \"time\"\r\n\r\n        \"go.etcd.io/etcd/clientv3\"\r\n)\r\n\r\nvar wg sync.WaitGroup\r\n\r\nfunc main() {\r\n        cfg := clientv3.Config{\r\n                Endpoints: []string{\"http://127.0.0.1:2379\"},\r\n                Username:  \"root\",\r\n                Password:  \"root\",\r\n                LogConfig: nil,\r\n        }\r\n\r\n        cli, err := clientv3.New(cfg)\r\n        if err != nil {\r\n                panic(err)\r\n        }\r\n\r\n        watch(cli, 1)\r\n        time.Sleep(1 * time.Second)\r\n        watch(cli, 2)\r\n        time.Sleep(11 * time.Second)\r\n        watch(cli, 3)\r\n        time.Sleep(1 * time.Second)\r\n        watch(cli, 4)\r\n\r\n        wg.Wait()\r\n}\r\n\r\nfunc watch(cli *clientv3.Client, num int) {\r\n        wg.Add(1)\r\n\r\n        go func() {\r\n                defer wg.Done()\r\n                for wr := range cli.Watch(context.Background(), \"\") {\r\n                        if wr.Err() != nil {\r\n                                fmt.Printf(\"%#v\\n\", wr.Err())\r\n                        }\r\n                }\r\n\r\n                fmt.Printf(\"#%v watch existed\\n\", num)\r\n        }()\r\n}\r\ncfz@cfz-desktop:~/ws/etcd-watch-demo$ go run main.go\r\n&errors.errorString{s:\"rpc error: code = PermissionDenied desc = etcdserver: permission denied\"}\r\n#3 watch exited\r\n&errors.errorString{s:\"rpc error: code = PermissionDenied desc = etcdserver: permission denied\"}\r\n#4 watch exited\r\n```\r\n\r\nas shown in the log , the 1st and 2nd watch is ok, while the 3rd and 4th report \"permission denied\"\r\n\r\nmeanwile, etcd server will log following:\r\n```\r\n{\"level\":\"warn\",\"ts\":\"2020-10-10T20:34:45.010+0800\",\"caller\":\"auth/store.go:1301\",\"msg\":\"invalid auth token\",\"token\":\"JWourXlCoFPTxMHj.8\"}\r\n{\"level\":\"warn\",\"ts\":\"2020-10-10T20:34:46.010+0800\",\"caller\":\"auth/store.go:1301\",\"msg\":\"invalid auth token\",\"token\":\"JWourXlCoFPTxMHj.8\"}\r\n```\r\n\r\ni think the causes are:\r\n- the grpc stream's authentication token is provided at the time when the stream is initialized\r\n- the client is trying to reusing the same grpc stream(if avaliable) to setup new watch substream.\r\n- the token attached to the stream would be expired if no other requests to extend its ttl.\r\n\r\n","closed_by":{"login":"mitake","id":1173955,"node_id":"MDQ6VXNlcjExNzM5NTU=","avatar_url":"https://avatars.githubusercontent.com/u/1173955?v=4","gravatar_id":"","url":"https://api.github.com/users/mitake","html_url":"https://github.com/mitake","followers_url":"https://api.github.com/users/mitake/followers","following_url":"https://api.github.com/users/mitake/following{/other_user}","gists_url":"https://api.github.com/users/mitake/gists{/gist_id}","starred_url":"https://api.github.com/users/mitake/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mitake/subscriptions","organizations_url":"https://api.github.com/users/mitake/orgs","repos_url":"https://api.github.com/users/mitake/repos","events_url":"https://api.github.com/users/mitake/events{/privacy}","received_events_url":"https://api.github.com/users/mitake/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/etcd-io/etcd/issues/12385/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/etcd-io/etcd/issues/12385/timeline","performed_via_github_app":null,"state_reason":"completed"}