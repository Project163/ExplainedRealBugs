{"url":"https://api.github.com/repos/google/guava/issues/3570","repository_url":"https://api.github.com/repos/google/guava","labels_url":"https://api.github.com/repos/google/guava/issues/3570/labels{/name}","comments_url":"https://api.github.com/repos/google/guava/issues/3570/comments","events_url":"https://api.github.com/repos/google/guava/issues/3570/events","html_url":"https://github.com/google/guava/issues/3570","id":483099241,"node_id":"MDU6SXNzdWU0ODMwOTkyNDE=","number":3570,"title":"Reuse of ImmutableSet.Builder with expected size leading to infinite loop on ImmutableSet.contains","user":{"login":"tomasisonfire","id":11581474,"node_id":"MDQ6VXNlcjExNTgxNDc0","avatar_url":"https://avatars.githubusercontent.com/u/11581474?v=4","gravatar_id":"","url":"https://api.github.com/users/tomasisonfire","html_url":"https://github.com/tomasisonfire","followers_url":"https://api.github.com/users/tomasisonfire/followers","following_url":"https://api.github.com/users/tomasisonfire/following{/other_user}","gists_url":"https://api.github.com/users/tomasisonfire/gists{/gist_id}","starred_url":"https://api.github.com/users/tomasisonfire/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tomasisonfire/subscriptions","organizations_url":"https://api.github.com/users/tomasisonfire/orgs","repos_url":"https://api.github.com/users/tomasisonfire/repos","events_url":"https://api.github.com/users/tomasisonfire/events{/privacy}","received_events_url":"https://api.github.com/users/tomasisonfire/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":143499063,"node_id":"MDU6TGFiZWwxNDM0OTkwNjM=","url":"https://api.github.com/repos/google/guava/labels/type=defect","name":"type=defect","color":"e11d21","default":false,"description":"Bug, not working as expected"},{"id":143499064,"node_id":"MDU6TGFiZWwxNDM0OTkwNjQ=","url":"https://api.github.com/repos/google/guava/labels/status=fixed","name":"status=fixed","color":"6eb26e","default":false,"description":""},{"id":143505259,"node_id":"MDU6TGFiZWwxNDM1MDUyNTk=","url":"https://api.github.com/repos/google/guava/labels/package=collect","name":"package=collect","color":"62a0e5","default":false,"description":""},{"id":691861983,"node_id":"MDU6TGFiZWw2OTE4NjE5ODM=","url":"https://api.github.com/repos/google/guava/labels/P1","name":"P1","color":"f7833b","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/google/guava/milestones/30","html_url":"https://github.com/google/guava/milestone/30","labels_url":"https://api.github.com/repos/google/guava/milestones/30/labels","id":4959711,"node_id":"MDk6TWlsZXN0b25lNDk1OTcxMQ==","number":30,"title":"28.2","description":"","creator":{"login":"cpovirk","id":1703908,"node_id":"MDQ6VXNlcjE3MDM5MDg=","avatar_url":"https://avatars.githubusercontent.com/u/1703908?v=4","gravatar_id":"","url":"https://api.github.com/users/cpovirk","html_url":"https://github.com/cpovirk","followers_url":"https://api.github.com/users/cpovirk/followers","following_url":"https://api.github.com/users/cpovirk/following{/other_user}","gists_url":"https://api.github.com/users/cpovirk/gists{/gist_id}","starred_url":"https://api.github.com/users/cpovirk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cpovirk/subscriptions","organizations_url":"https://api.github.com/users/cpovirk/orgs","repos_url":"https://api.github.com/users/cpovirk/repos","events_url":"https://api.github.com/users/cpovirk/events{/privacy}","received_events_url":"https://api.github.com/users/cpovirk/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":6,"state":"closed","created_at":"2019-12-27T13:29:55Z","updated_at":"2019-12-27T13:30:47Z","due_on":null,"closed_at":"2019-12-27T13:30:47Z"},"comments":2,"created_at":"2019-08-20T21:47:34Z","updated_at":"2019-12-27T13:30:35Z","closed_at":"2019-08-21T18:48:26Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"The following snippet produces an infinite loop inside the method ImmutableSet.contains:\r\n\r\n```java\r\nImmutableSet.Builder<Object> builder = ImmutableSet.builderWithExpectedSize(6);\r\nbuilder.add(0);\r\nbuilder.build();\r\nImmutableSet<Object> subject = builder.add(1).add(2).add(3).build();\r\nboolean contains = subject.contains(4);\r\n```\r\n\r\nThis behavior was first observed in guava 25.1-jre and it still happens in version 28.0-jre.\r\n\r\nAnalyzing the source code, I think there is a problem in the implementation of ImmutableSet.RegularSetBuilderImpl.review(). As it decides to reduce the _hashTable_, it does not recompute the _expandTableThreshold_ nor _maxRunBeforeFallback_. From this point, I observed two consequences:\r\n\r\n1. Given a RegularSetBuilderImpl with D distinct elements. \r\nAfter resizing the hashTable to size N, if the (N-D) distinct elements are added, the subsequent build() method would return an instance of ImmutableSet that reproduces the infinite loop on method contains.\r\n2. In the same scenario as above, when the (N+1)th element is added to the builder, the RegularSetBuilderImpl will iterate _maxRunBeforeFallback_ times in a full hashTable, until it falls back to the JdkBackedSetBuilderImpl.\r\n\r\n","closed_by":{"login":"cpovirk","id":1703908,"node_id":"MDQ6VXNlcjE3MDM5MDg=","avatar_url":"https://avatars.githubusercontent.com/u/1703908?v=4","gravatar_id":"","url":"https://api.github.com/users/cpovirk","html_url":"https://github.com/cpovirk","followers_url":"https://api.github.com/users/cpovirk/followers","following_url":"https://api.github.com/users/cpovirk/following{/other_user}","gists_url":"https://api.github.com/users/cpovirk/gists{/gist_id}","starred_url":"https://api.github.com/users/cpovirk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cpovirk/subscriptions","organizations_url":"https://api.github.com/users/cpovirk/orgs","repos_url":"https://api.github.com/users/cpovirk/repos","events_url":"https://api.github.com/users/cpovirk/events{/privacy}","received_events_url":"https://api.github.com/users/cpovirk/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/google/guava/issues/3570/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/google/guava/issues/3570/timeline","performed_via_github_app":null,"state_reason":"completed"}