{"url":"https://api.github.com/repos/google/guava/issues/7401","repository_url":"https://api.github.com/repos/google/guava","labels_url":"https://api.github.com/repos/google/guava/issues/7401/labels{/name}","comments_url":"https://api.github.com/repos/google/guava/issues/7401/comments","events_url":"https://api.github.com/repos/google/guava/issues/7401/events","html_url":"https://github.com/google/guava/issues/7401","id":2543578101,"node_id":"I_kwDOATXBkc6Xm-v1","number":7401,"title":"testlib collections: `@Require(absent = ...)` considers implicit features","user":{"login":"Marcono1234","id":11685886,"node_id":"MDQ6VXNlcjExNjg1ODg2","avatar_url":"https://avatars.githubusercontent.com/u/11685886?v=4","gravatar_id":"","url":"https://api.github.com/users/Marcono1234","html_url":"https://github.com/Marcono1234","followers_url":"https://api.github.com/users/Marcono1234/followers","following_url":"https://api.github.com/users/Marcono1234/following{/other_user}","gists_url":"https://api.github.com/users/Marcono1234/gists{/gist_id}","starred_url":"https://api.github.com/users/Marcono1234/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Marcono1234/subscriptions","organizations_url":"https://api.github.com/users/Marcono1234/orgs","repos_url":"https://api.github.com/users/Marcono1234/repos","events_url":"https://api.github.com/users/Marcono1234/events{/privacy}","received_events_url":"https://api.github.com/users/Marcono1234/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":143499063,"node_id":"MDU6TGFiZWwxNDM0OTkwNjM=","url":"https://api.github.com/repos/google/guava/labels/type=defect","name":"type=defect","color":"e11d21","default":false,"description":"Bug, not working as expected"},{"id":143504641,"node_id":"MDU6TGFiZWwxNDM1MDQ2NDE=","url":"https://api.github.com/repos/google/guava/labels/package=testing","name":"package=testing","color":"62a0e5","default":false,"description":""},{"id":691862394,"node_id":"MDU6TGFiZWw2OTE4NjIzOTQ=","url":"https://api.github.com/repos/google/guava/labels/P3","name":"P3","color":"c5c5c5","default":false,"description":"no SLO"}],"state":"closed","locked":false,"assignee":{"login":"chaoren","id":10055601,"node_id":"MDQ6VXNlcjEwMDU1NjAx","avatar_url":"https://avatars.githubusercontent.com/u/10055601?v=4","gravatar_id":"","url":"https://api.github.com/users/chaoren","html_url":"https://github.com/chaoren","followers_url":"https://api.github.com/users/chaoren/followers","following_url":"https://api.github.com/users/chaoren/following{/other_user}","gists_url":"https://api.github.com/users/chaoren/gists{/gist_id}","starred_url":"https://api.github.com/users/chaoren/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chaoren/subscriptions","organizations_url":"https://api.github.com/users/chaoren/orgs","repos_url":"https://api.github.com/users/chaoren/repos","events_url":"https://api.github.com/users/chaoren/events{/privacy}","received_events_url":"https://api.github.com/users/chaoren/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"chaoren","id":10055601,"node_id":"MDQ6VXNlcjEwMDU1NjAx","avatar_url":"https://avatars.githubusercontent.com/u/10055601?v=4","gravatar_id":"","url":"https://api.github.com/users/chaoren","html_url":"https://github.com/chaoren","followers_url":"https://api.github.com/users/chaoren/followers","following_url":"https://api.github.com/users/chaoren/following{/other_user}","gists_url":"https://api.github.com/users/chaoren/gists{/gist_id}","starred_url":"https://api.github.com/users/chaoren/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chaoren/subscriptions","organizations_url":"https://api.github.com/users/chaoren/orgs","repos_url":"https://api.github.com/users/chaoren/repos","events_url":"https://api.github.com/users/chaoren/events{/privacy}","received_events_url":"https://api.github.com/users/chaoren/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/google/guava/milestones/38","html_url":"https://github.com/google/guava/milestone/38","labels_url":"https://api.github.com/repos/google/guava/milestones/38/labels","id":12058843,"node_id":"MI_kwDOATXBkc4AuADb","number":38,"title":"33.4.0","description":"","creator":{"login":"cpovirk","id":1703908,"node_id":"MDQ6VXNlcjE3MDM5MDg=","avatar_url":"https://avatars.githubusercontent.com/u/1703908?v=4","gravatar_id":"","url":"https://api.github.com/users/cpovirk","html_url":"https://github.com/cpovirk","followers_url":"https://api.github.com/users/cpovirk/followers","following_url":"https://api.github.com/users/cpovirk/following{/other_user}","gists_url":"https://api.github.com/users/cpovirk/gists{/gist_id}","starred_url":"https://api.github.com/users/cpovirk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cpovirk/subscriptions","organizations_url":"https://api.github.com/users/cpovirk/orgs","repos_url":"https://api.github.com/users/cpovirk/repos","events_url":"https://api.github.com/users/cpovirk/events{/privacy}","received_events_url":"https://api.github.com/users/cpovirk/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":2,"state":"closed","created_at":"2024-12-17T01:19:53Z","updated_at":"2024-12-17T01:20:34Z","due_on":null,"closed_at":"2024-12-17T01:20:34Z"},"comments":0,"created_at":"2024-09-23T20:19:19Z","updated_at":"2024-12-17T01:20:29Z","closed_at":"2024-10-05T22:05:09Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Guava Version\r\n\r\n33.3.0-jre\r\n\r\n### Description\r\n\r\nThe `@CollectionFeature.Require(absent = ...)` element is supposed to determine which features should _not_ be enabled. The problem is that for `absent` it also considers implicit features:\r\nhttps://github.com/google/guava/blob/a3b51888c2456350ab11694c28d7a72173f3b897/guava-testlib/src/com/google/common/collect/testing/features/FeatureUtil.java#L191-L192\r\n\r\nThis is probably wrong, because for `absent` the direction is the opposite.\r\nFor example the feature `ALLOWS_NULL_VALUES` implies `ALLOWS_NULL_QUERIES`.\r\nAnd `CollectionAddTester#testAdd_nullUnsupported()` specifies `absent = ALLOWS_NULL_VALUES`.\r\n\r\nWith the current implementation this means if `ALLOWS_NULL_QUERIES` is enabled but `ALLOWS_NULL_VALUES` is not, then `testAdd_nullUnsupported` is erroneously not executed, even though it works fine regardless of whether `ALLOWS_NULL_QUERIES` is used. The correct behavior for `absent` would be to not consider implicit features (or am I overlooking a use case?)[^1].\r\n\r\nThis means you cannot test a collection which permits `null` queries, but disallows `null` values, because\r\n- if you don't use `ALLOWS_NULL_QUERIES`, then `null` queries are not tested\r\n- if you use `ALLOWS_NULL_QUERIES`, then `null` additions (which should throw) are not tested\r\n\r\n\r\n[^1]: Maybe even for `Require(value = ...)` (= feature is present) it would not be necessary to check implicit features, because users can only opt-in into features, but not disable them again (or is that possible?). So if the main required feature is enabled, the implicit feature is enabled as well.\r\n\r\n### Example\r\n\r\n```java\r\nAtomicBoolean calledAddNull = new AtomicBoolean(false);\r\nclass NonNullList<E> extends AbstractList<E> {\r\n  private final List<E> delegate = new ArrayList<>();\r\n\r\n  @Override\r\n  public int size() {\r\n    return delegate.size();\r\n  }\r\n\r\n  @Override\r\n  public E get(int index) {\r\n    return delegate.get(index);\r\n  }\r\n\r\n  @Override\r\n  public void add(int index, E element) {\r\n    if (element == null) {\r\n      calledAddNull.set(true);\r\n    }\r\n    Objects.requireNonNull(element);\r\n    delegate.add(index, element);\r\n  }\r\n}\r\n\r\nTest test = ListTestSuiteBuilder.using(new TestStringListGenerator() {\r\n  @Override\r\n  protected List<String> create(String[] elements) {\r\n    List<String> list = new NonNullList<>();\r\n    list.addAll(Arrays.asList(elements));\r\n    return list;\r\n  }\r\n})\r\n  .withFeatures(\r\n    CollectionSize.ONE,\r\n    // CollectionFeature.ALLOWS_NULL_QUERIES,\r\n    CollectionFeature.SUPPORTS_ADD\r\n  )\r\n  .named(\"NonNullList\")\r\n  .createTestSuite();\r\n\r\nTestResult testResult = new TestResult();\r\ntest.run(testResult);\r\n\r\nSystem.out.println(\"Called `add(null)`: \" + calledAddNull.get());\r\nif (testResult.wasSuccessful()) {\r\n  System.out.println(\"SUCCESS\");\r\n} else {\r\n  System.out.println(\"ERROR\");\r\n  System.out.println(\"failures: \" + Collections.list(testResult.failures()));\r\n  System.out.println(\"errors: \" + Collections.list(testResult.errors()));\r\n}\r\n```\r\n\r\nRun once with `ALLOWS_NULL_QUERIES` enabled, and once with it disabled.\r\n\r\n\r\n### Expected Behavior\r\n\r\nIn both cases \"Called `add(null)`: true\" should have been printed\r\n\r\n### Actual Behavior\r\n\r\nWhen `ALLOWS_NULL_QUERIES` is enabled, \"Called `add(null)`: false\" is printed\r\n\r\n\r\n### Packages\r\n\r\ncom.google.common.testing\r\n\r\n### Platforms\r\n\r\nJava 17\r\n\r\n### Checklist\r\n\r\n- [X] I agree to follow the [code of conduct](https://github.com/google/.github/blob/master/CODE_OF_CONDUCT.md).\r\n\r\n- [X] I can reproduce the bug with the [latest](https://github.com/google/guava/releases/latest) version of Guava available.\r\n","closed_by":{"login":"copybara-service[bot]","id":56741989,"node_id":"MDM6Qm90NTY3NDE5ODk=","avatar_url":"https://avatars.githubusercontent.com/in/44061?v=4","gravatar_id":"","url":"https://api.github.com/users/copybara-service%5Bbot%5D","html_url":"https://github.com/apps/copybara-service","followers_url":"https://api.github.com/users/copybara-service%5Bbot%5D/followers","following_url":"https://api.github.com/users/copybara-service%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/copybara-service%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/copybara-service%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/copybara-service%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/copybara-service%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/copybara-service%5Bbot%5D/repos","events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/google/guava/issues/7401/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/google/guava/issues/7401/timeline","performed_via_github_app":null,"state_reason":"completed"}