{"url":"https://api.github.com/repos/google/guava/issues/2101","repository_url":"https://api.github.com/repos/google/guava","labels_url":"https://api.github.com/repos/google/guava/issues/2101/labels{/name}","comments_url":"https://api.github.com/repos/google/guava/issues/2101/comments","events_url":"https://api.github.com/repos/google/guava/issues/2101/events","html_url":"https://github.com/google/guava/issues/2101","id":93726979,"node_id":"MDU6SXNzdWU5MzcyNjk3OQ==","number":2101,"title":"Wrong RemovalCause published on cache.invaldateAll()","user":{"login":"ben-manes","id":378614,"node_id":"MDQ6VXNlcjM3ODYxNA==","avatar_url":"https://avatars.githubusercontent.com/u/378614?v=4","gravatar_id":"","url":"https://api.github.com/users/ben-manes","html_url":"https://github.com/ben-manes","followers_url":"https://api.github.com/users/ben-manes/followers","following_url":"https://api.github.com/users/ben-manes/following{/other_user}","gists_url":"https://api.github.com/users/ben-manes/gists{/gist_id}","starred_url":"https://api.github.com/users/ben-manes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ben-manes/subscriptions","organizations_url":"https://api.github.com/users/ben-manes/orgs","repos_url":"https://api.github.com/users/ben-manes/repos","events_url":"https://api.github.com/users/ben-manes/events{/privacy}","received_events_url":"https://api.github.com/users/ben-manes/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":143499063,"node_id":"MDU6TGFiZWwxNDM0OTkwNjM=","url":"https://api.github.com/repos/google/guava/labels/type=defect","name":"type=defect","color":"e11d21","default":false,"description":"Bug, not working as expected"},{"id":143499064,"node_id":"MDU6TGFiZWwxNDM0OTkwNjQ=","url":"https://api.github.com/repos/google/guava/labels/status=fixed","name":"status=fixed","color":"6eb26e","default":false,"description":""},{"id":143506482,"node_id":"MDU6TGFiZWwxNDM1MDY0ODI=","url":"https://api.github.com/repos/google/guava/labels/package=cache","name":"package=cache","color":"62a0e5","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/google/guava/milestones/14","html_url":"https://github.com/google/guava/milestone/14","labels_url":"https://api.github.com/repos/google/guava/milestones/14/labels","id":849127,"node_id":"MDk6TWlsZXN0b25lODQ5MTI3","number":14,"title":"19.0","description":"","creator":{"login":"cgdecker","id":101568,"node_id":"MDQ6VXNlcjEwMTU2OA==","avatar_url":"https://avatars.githubusercontent.com/u/101568?v=4","gravatar_id":"","url":"https://api.github.com/users/cgdecker","html_url":"https://github.com/cgdecker","followers_url":"https://api.github.com/users/cgdecker/followers","following_url":"https://api.github.com/users/cgdecker/following{/other_user}","gists_url":"https://api.github.com/users/cgdecker/gists{/gist_id}","starred_url":"https://api.github.com/users/cgdecker/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cgdecker/subscriptions","organizations_url":"https://api.github.com/users/cgdecker/orgs","repos_url":"https://api.github.com/users/cgdecker/repos","events_url":"https://api.github.com/users/cgdecker/events{/privacy}","received_events_url":"https://api.github.com/users/cgdecker/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":43,"state":"closed","created_at":"2014-11-01T03:47:25Z","updated_at":"2016-10-06T21:34:37Z","due_on":null,"closed_at":"2015-12-11T19:51:02Z"},"comments":2,"created_at":"2015-07-08T08:04:36Z","updated_at":"2015-12-01T19:30:16Z","closed_at":"2015-11-30T22:26:14Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"When the cache is being cleared, either through `Cache.invalidateAll()` or `asMap().clear()`, the removal cause is always `EXPLICIT`. However the map may contain expired or GC'd entries that would be removed on the next maintenance cycle. The removal cause should indicate the actual state of the entry, not merely the action that triggered the eventual removal.\n\nDue to weak and soft references the key or value may be null. A listener should only expect to receive a null key or value if the cause is `COLLECTED`, as indicated by `RemovalNotification`:\n\n> The key and/or value may be null if they were already garbage collected.\n\nTherefore a listener might decide to inspect the properties without a null guard, leading to an NPE.\n\n``` java\n@Test\npublic void clear_expireAfterAccess() {\n  FakeTicker ticker = new FakeTicker();\n  RemovalListener<Integer, Integer> listener = Mockito.mock(RemovalListener.class);\n  ArgumentCaptor<RemovalNotification<Integer, Integer>> captor =\n      ArgumentCaptor.forClass(RemovalNotification.class);\n  Cache<Integer, Integer> cache = CacheBuilder.newBuilder()\n      .expireAfterAccess(1, TimeUnit.MINUTES)\n      .removalListener(listener)\n      .ticker(ticker)\n      .build();\n  cache.put(1, 1);\n  ticker.advance(10, TimeUnit.MINUTES);\n  cache.invalidateAll();\n\n  verify(listener).onRemoval(captor.capture());\n  assertThat(captor.getValue().getCause(), is(RemovalCause.EXPIRED));\n}\n```\n\nThe fix is to change `LocalCache$Segment#clear()` to inspect the key, value, and expiration status when determining the cause. \n\nUnfortunately this race condition is more widespread due to `enqueueNotification` not being tolerant to a garbage collection nulling out the key/value. Prior to constructing the notification, the method must take a strong reference to the key and value, check if either was collected, and if so publish a `COLLECTED` instead of the caller's cause.\n","closed_by":{"login":"cpovirk","id":1703908,"node_id":"MDQ6VXNlcjE3MDM5MDg=","avatar_url":"https://avatars.githubusercontent.com/u/1703908?v=4","gravatar_id":"","url":"https://api.github.com/users/cpovirk","html_url":"https://github.com/cpovirk","followers_url":"https://api.github.com/users/cpovirk/followers","following_url":"https://api.github.com/users/cpovirk/following{/other_user}","gists_url":"https://api.github.com/users/cpovirk/gists{/gist_id}","starred_url":"https://api.github.com/users/cpovirk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cpovirk/subscriptions","organizations_url":"https://api.github.com/users/cpovirk/orgs","repos_url":"https://api.github.com/users/cpovirk/repos","events_url":"https://api.github.com/users/cpovirk/events{/privacy}","received_events_url":"https://api.github.com/users/cpovirk/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/google/guava/issues/2101/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/google/guava/issues/2101/timeline","performed_via_github_app":null,"state_reason":"completed"}