<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:37:34 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SLING-3189] LogbackManager causes lockup on second startup</title>
                <link>https://issues.apache.org/jira/browse/SLING-3189</link>
                <project id="12310710" key="SLING">Sling</project>
                    <description>&lt;p&gt;Looks like I didn&apos;t test yesterday&apos;s &lt;a href=&quot;https://issues.apache.org/jira/browse/SLING-3185&quot; title=&quot;ClassCastException in o.a.s.commons.log&amp;#39;s LogbackManager at bundle activation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SLING-3185&quot;&gt;&lt;del&gt;SLING-3185&lt;/del&gt;&lt;/a&gt; fix thoroughly enough, I&apos;m seeing a system lockup on second startup of the current trunk launchpad.&lt;/p&gt;

&lt;p&gt;Steps to reproduce:&lt;br/&gt;
1. Start launchpad/builder runnable jar with no existing sling folder, Sling starts fine.&lt;br/&gt;
2. Stop and restart.&lt;br/&gt;
3. Sling doesn&apos;t start, the BundleWiringImpl waits forever on a classloading call triggered by StaticLoggerBinder.getSingleton()&lt;/p&gt;

&lt;p&gt;Stack trace:&lt;br/&gt;
Daemon Thread &lt;span class=&quot;error&quot;&gt;&amp;#91;FelixStartLevel&amp;#93;&lt;/span&gt; (Suspended)	&lt;br/&gt;
	owns: BundleWiringImpl$BundleClassLoaderJava5  (id=40)	&lt;br/&gt;
	waiting for: HashMap&amp;lt;K,V&amp;gt;  (id=41)	&lt;br/&gt;
	Object.wait(long) line: not available &lt;span class=&quot;error&quot;&gt;&amp;#91;native method&amp;#93;&lt;/span&gt;	&lt;br/&gt;
	HashMap&amp;lt;K,V&amp;gt;(Object).wait() line: 485	&lt;br/&gt;
	BundleWiringImpl$BundleClassLoaderJava5(BundleWiringImpl$BundleClassLoader).findClass(String) line: 2050	&lt;br/&gt;
	BundleWiringImpl.findClassOrResourceByDelegation(String, boolean) line: 1472	&lt;br/&gt;
	BundleWiringImpl.access$400(BundleWiringImpl, String, boolean) line: 75	&lt;br/&gt;
	BundleWiringImpl$BundleClassLoaderJava5(BundleWiringImpl$BundleClassLoader).loadClass(String, boolean) line: 1923	&lt;br/&gt;
	BundleWiringImpl$BundleClassLoaderJava5(ClassLoader).loadClass(String) line: 247	&lt;br/&gt;
	LogbackManager.ensureSlf4jIsInitialized() line: 147	&lt;br/&gt;
	LogbackManager.&amp;lt;init&amp;gt;(BundleContext) line: 103	&lt;br/&gt;
	Activator.start(BundleContext) line: 55	&lt;/p&gt;</description>
                <environment></environment>
        <key id="12674500">SLING-3189</key>
            <summary>LogbackManager causes lockup on second startup</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="chetanm">Chetan Mehrotra</assignee>
                                    <reporter username="bdelacretaz">Bertrand Delacretaz</reporter>
                        <labels>
                    </labels>
                <created>Fri, 18 Oct 2013 12:37:52 +0000</created>
                <updated>Fri, 7 Mar 2014 06:16:22 +0000</updated>
                            <resolved>Tue, 5 Nov 2013 11:46:31 +0000</resolved>
                                    <version>Commons Log 3.0.2</version>
                                    <fixVersion>Commons Log 4.0.0</fixVersion>
                                    <component>Commons</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13799127" author="chetanm" created="Fri, 18 Oct 2013 14:18:48 +0000"  >&lt;p&gt;I feared this situation would arise with my fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/SLING-3185&quot; title=&quot;ClassCastException in o.a.s.commons.log&amp;#39;s LogbackManager at bundle activation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SLING-3185&quot;&gt;&lt;del&gt;SLING-3185&lt;/del&gt;&lt;/a&gt;. Would try to reproduce and come with proper fix&lt;/p&gt;</comment>
                            <comment id="13799797" author="chetanm" created="Sat, 19 Oct 2013 06:07:37 +0000"  >&lt;p&gt;I tried to reproduce the issue locally but it does not happen on my setup. I used the latest Sling created from launchpad/builder module.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bdelacretaz&quot; class=&quot;user-hover&quot; rel=&quot;bdelacretaz&quot;&gt;bdelacretaz&lt;/a&gt; Can you provide thread dump for the above deadlock?&lt;/p&gt;</comment>
                            <comment id="13800455" author="bdelacretaz" created="Mon, 21 Oct 2013 08:20:03 +0000"  >&lt;p&gt;Here&apos;s the full stack trace.&lt;/p&gt;</comment>
                            <comment id="13800473" author="chetanm" created="Mon, 21 Oct 2013 08:45:13 +0000"  >&lt;p&gt;From seeing the thread dump I think following is happening&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Sling installer installs all bundles at a given Start Level like 1&lt;/li&gt;
	&lt;li&gt;At start level 1 we have various bundles like Commons Log and Jetty&lt;/li&gt;
	&lt;li&gt;Jetty has an optional dependency on SLF4J&lt;/li&gt;
	&lt;li&gt;Once all the bundles are resolved the bundles are started. In some cases Jetty bundle gets started first.&lt;/li&gt;
	&lt;li&gt;If Jetty gets started first it triggers SLF4J initialization in a separate thread (diff from main Framework thread) and the SLF4J would access the StaticLoggerBinder provided by Logback jar packaged within Commons Log bundle. This is triggered via static initializer logic in org.slf4j.LoggerFactory#getILoggerFactory &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;. Note that by this time Commons Log bundle has not be started. In this process at some stage it needs lock on the Commons Log classloader&lt;/li&gt;
	&lt;li&gt;Commons Log bundle itself require access to the return value of ILoggerFactory.getILoggerFactory() in its BundleActivator.start as its that singleton LoggerContext instance which needs to be used by LogbackManager for further configuration. It currently hold the Common Log classloader lock&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;This lead to a deadlock and stalls the system. One possible fix I can think of is&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Commons Log activator checks if the LoggerFactory is initialized i.e. &lt;tt&gt;LoggerFactory.getILoggerFactory() instanceof LoggerContext&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;If not initialized then it would starting the initialization in a separate thread where it would wait till &lt;tt&gt;LoggerFactory&lt;/tt&gt; is initialized and only then start LogbackManager&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Thoughts?&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;http://bugzilla.slf4j.org/show_bug.cgi?id=106&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://bugzilla.slf4j.org/show_bug.cgi?id=106&lt;/a&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/qos-ch/slf4j/blob/master/slf4j-api/src/main/java/org/slf4j/LoggerFactory.java#L292&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/qos-ch/slf4j/blob/master/slf4j-api/src/main/java/org/slf4j/LoggerFactory.java#L292&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13800484" author="bdelacretaz" created="Mon, 21 Oct 2013 09:01:52 +0000"  >&lt;p&gt;I like the idea of initializing in a separate thread. &lt;/p&gt;

&lt;p&gt;As mentioned at &lt;a href=&quot;https://issues.apache.org/jira/browse/SLING-3185&quot; title=&quot;ClassCastException in o.a.s.commons.log&amp;#39;s LogbackManager at bundle activation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SLING-3185&quot;&gt;&lt;del&gt;SLING-3185&lt;/del&gt;&lt;/a&gt; the commons log bundle causes circular dependencies, as it&apos;s exporting the org.slf4j.impl packages which slf4j needs to startup. Having those come from a distinct bundle might make things easier but according to Chetan it&apos;s not that easy to implement that separation. Decoupling the bundle&apos;s initialization in a separate thread should break those loops.&lt;/p&gt;</comment>
                            <comment id="13800495" author="fmeschbe" created="Mon, 21 Oct 2013 09:19:41 +0000"  >&lt;p&gt;Reading &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; I wonder whether this might be an approach to the problem: Can we make sure to only do minimal, default, setup in StaticLoggerBinder.SINGLETON.getLoggerFactory() such as to not do any further class loading and then have the &quot;commons log&quot; activator do the actual heavy listing configuration ?&lt;/p&gt;

&lt;p&gt;Apart from it being nice to solve this problem, I hope this is a corner case &amp;#8211; Logback intialization caused by a paralell thread causing deadlock between Logback and classloaders. And we can also mitigate this by moving the jetty bundle to another start level, which should actually be the case ?&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;http://logback.qos.ch/manual/configuration.html#joranDirectly&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://logback.qos.ch/manual/configuration.html#joranDirectly&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13800503" author="chetanm" created="Mon, 21 Oct 2013 09:32:07 +0000"  >&lt;blockquote&gt;&lt;p&gt;Reading &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; I wonder whether this might be an approach to the problem &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That is what is being done. The default config used is &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; and later we introduce our integration config via &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;And we can also mitigate this by moving the jetty bundle to another start level&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That would help. I have been using Commons Log with Adobe CQ (Sling based App) where the HTTP service starts at a later start level. And I have not hit this issue so far for past 2 months. &lt;/p&gt;

&lt;p&gt;So unless changing startlevel does not pose much issue in terms of upgrade I suggest&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Move Jetty to a later start level - or some how ensure that commons log activator is called first&lt;/li&gt;
	&lt;li&gt;In additon use the thread based approach to workaround such cases. The logic would ensure that new thread is only used when Slf4j is not initialized&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/sling/blob/trunk/bundles/commons/log/src/main/resources/logback.xml&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/sling/blob/trunk/bundles/commons/log/src/main/resources/logback.xml&lt;/a&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/sling/blob/trunk/bundles/commons/log/src/main/resources/logback-empty.xml&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/sling/blob/trunk/bundles/commons/log/src/main/resources/logback-empty.xml&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13800510" author="fmeschbe" created="Mon, 21 Oct 2013 09:42:25 +0000"  >&lt;p&gt;Ok. I agree we should do both - move Jetty to a higher startlevel (also the bridge for servlet container deployments) as well as taking the asychronous approach when this situation is detected.&lt;/p&gt;</comment>
                            <comment id="13800516" author="bdelacretaz" created="Mon, 21 Oct 2013 09:50:19 +0000"  >&lt;p&gt;I also think we need both changes - while it&apos;s the Jetty bundle that causes the issue in this case, others might as well.&lt;/p&gt;

&lt;p&gt;Also, when upgrading existing systems we might see different combinations, so the commons log bundle should be as robust as possible w.r.t these initialization problems.&lt;/p&gt;</comment>
                            <comment id="13800564" author="cziegeler" created="Mon, 21 Oct 2013 11:49:48 +0000"  >&lt;p&gt;I&apos;m not that happy about solving this by changing the start level. Start levels should not be abused to solve problems. If we have a chance to fix this without depending on startup order, we should go that way&lt;/p&gt;</comment>
                            <comment id="13801716" author="chetanm" created="Tue, 22 Oct 2013 11:08:38 +0000"  >&lt;p&gt;Patch which uses a separate thread to configure Logback in case SLF4J is not initialized yet.&lt;/p&gt;

&lt;p&gt;I tried to reproduce the issue locally but somehow it does not show up. So &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bdelacretaz&quot; class=&quot;user-hover&quot; rel=&quot;bdelacretaz&quot;&gt;bdelacretaz&lt;/a&gt; would require you to test the patch on your system and see if it resolves the issue&lt;/p&gt;</comment>
                            <comment id="13813872" author="chetanm" created="Tue, 5 Nov 2013 11:46:31 +0000"  >&lt;p&gt;Patch was applied by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bdelacretaz&quot; class=&quot;user-hover&quot; rel=&quot;bdelacretaz&quot;&gt;bdelacretaz&lt;/a&gt; at rev &lt;a href=&quot;http://svn.apache.org/r1534615&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1534615&lt;/a&gt; and seems to resolve the issue for now.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12674301">SLING-3185</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12609637" name="SLING-3189.patch" size="6680" author="chetanm" created="Tue, 22 Oct 2013 11:08:38 +0000"/>
                            <attachment id="12609379" name="SLING-3189.stack.txt" size="14382" author="bdelacretaz" created="Mon, 21 Oct 2013 08:20:03 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>354122</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 2 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1p1wf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>354414</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>