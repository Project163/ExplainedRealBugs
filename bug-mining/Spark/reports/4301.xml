<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:49:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-18622] Missing Reference in Multi Union Clauses Cause by TypeCoercion</title>
                <link>https://issues.apache.org/jira/browse/SPARK-18622</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;spark-sql&amp;gt; explain extended
         &amp;gt; select a
         &amp;gt; from
         &amp;gt; (
         &amp;gt;   select 0 a, 0 b
         &amp;gt; union all
         &amp;gt;   select sum(1) a, &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(0 as bigint) b
         &amp;gt; union all
         &amp;gt;   select 0 a, 0 b
         &amp;gt; )t;
 
== Parsed Logical Plan ==
&lt;span class=&quot;code-quote&quot;&gt;&apos;Project [&apos;&lt;/span&gt;a]
+- &apos;SubqueryAlias t
   +- &apos;Union
      :- &apos;Union
      :  :- Project [0 AS a#0, 0 AS b#1]
      :  :  +- OneRowRelation$
      :  +- &lt;span class=&quot;code-quote&quot;&gt;&apos;Project [&apos;&lt;/span&gt;sum(1) AS a#2, &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(0 as bigint) AS b#3L]
      :     +- OneRowRelation$
      +- Project [0 AS a#4, 0 AS b#5]
         +- OneRowRelation$
 
== Analyzed Logical Plan ==
a: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;
Project [a#0]
+- SubqueryAlias t
   +- Union
      :- !Project [a#0, b#9L]
      :  +- Union
      :     :- Project [&lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(a#0 as bigint) AS a#11L, b#9L]
      :     :  +- Project [a#0, &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(b#1 as bigint) AS b#9L]
      :     :     +- Project [0 AS a#0, 0 AS b#1]
      :     :        +- OneRowRelation$
      :     +- Project [a#2L, b#3L]
      :        +- Project [a#2L, b#3L]
      :           +- Aggregate [sum(&lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(1 as bigint)) AS a#2L, &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(0 as bigint) AS b#3L]
      :              +- OneRowRelation$
      +- Project [a#4, &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(b#5 as bigint) AS b#10L]
         +- Project [0 AS a#4, 0 AS b#5]
            +- OneRowRelation$
 
== Optimized Logical Plan ==
org.apache.spark.sql.AnalysisException: resolved attribute(s) a#0 missing from a#11L,b#9L in &lt;span class=&quot;code-keyword&quot;&gt;operator&lt;/span&gt; !Project [a#0, b#9L];;
Project [a#0]
+- SubqueryAlias t
   +- Union
      :- !Project [a#0, b#9L]
      :  +- Union
      :     :- Project [&lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(a#0 as bigint) AS a#11L, b#9L]
      :     :  +- Project [a#0, &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(b#1 as bigint) AS b#9L]
      :     :     +- Project [0 AS a#0, 0 AS b#1]
      :     :        +- OneRowRelation$
      :     +- Project [a#2L, b#3L]
      :        +- Project [a#2L, b#3L]
      :           +- Aggregate [sum(&lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(1 as bigint)) AS a#2L, &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(0 as bigint) AS b#3L]
      :              +- OneRowRelation$
      +- Project [a#4, &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(b#5 as bigint) AS b#10L]
         +- Project [0 AS a#4, 0 AS b#5]
            +- OneRowRelation$
 
== Physical Plan ==
org.apache.spark.sql.AnalysisException: resolved attribute(s) a#0 missing from a#11L,b#9L in &lt;span class=&quot;code-keyword&quot;&gt;operator&lt;/span&gt; !Project [a#0, b#9L];;
Project [a#0]
+- SubqueryAlias t
   +- Union
      :- !Project [a#0, b#9L]
      :  +- Union
      :     :- Project [&lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(a#0 as bigint) AS a#11L, b#9L]
      :     :  +- Project [a#0, &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(b#1 as bigint) AS b#9L]
      :     :     +- Project [0 AS a#0, 0 AS b#1]
      :     :        +- OneRowRelation$
      :     +- Project [a#2L, b#3L]
      :        +- Project [a#2L, b#3L]
      :           +- Aggregate [sum(&lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(1 as bigint)) AS a#2L, &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(0 as bigint) AS b#3L]
      :              +- OneRowRelation$
      +- Project [a#4, &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(b#5 as bigint) AS b#10L]
         +- Project [0 AS a#4, 0 AS b#5]
            +- OneRowRelation$
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Key Points to re-produce issue:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;3 or more union clauses;&lt;/li&gt;
	&lt;li&gt;One column is sum aggregate in one union clause, and is Integer type in other union clause;&lt;/li&gt;
	&lt;li&gt;Another column has different date types in union clauses;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The reason of issue:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Step 1: Apply TypeCoercion.WidenSetOperationTypes, add project with cast since the union clauses has different datatypes for one column; With 3 union clauses, the inner union clause also be projected with cast;&lt;/li&gt;
	&lt;li&gt;Step 2: Apply TypeCoercion.FunctionArgumentConversion, the return type of sum(int) will be extended to BigInt, meaning one column in union clauses changed datatype;&lt;/li&gt;
	&lt;li&gt;Step 3: Apply TypeCoercion.WidenSetOperationTypes again, another cast project added in inner union clause, since sum(int) datatype changed; at this point, the reference of project ON inner union will be missed, since the project IN inner union is newly added, see the  Analyzed Logical Plan;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Solutions to fix:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Since set operation type coercion should be applied after inner clause be stabled, apply WidenSetOperationTypes at last will fix the issue;&lt;/li&gt;
	&lt;li&gt;To avoiding multi level projects on set operation clause, handle the existing cast project carefully in WidenSetOperationTypes should be also work;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Appreciate for any comments.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13024022">SPARK-18622</key>
            <summary>Missing Reference in Multi Union Clauses Cause by TypeCoercion</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hvanhovell">Herman van H&#246;vell</assignee>
                                    <reporter username="sunyerui">Yerui Sun</reporter>
                        <labels>
                    </labels>
                <created>Tue, 29 Nov 2016 09:14:53 +0000</created>
                <updated>Tue, 18 Aug 2020 10:00:18 +0000</updated>
                            <resolved>Wed, 30 Nov 2016 07:26:53 +0000</resolved>
                                    <version>1.6.3</version>
                    <version>2.0.2</version>
                                    <fixVersion>2.1.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15706342" author="apachespark" created="Tue, 29 Nov 2016 19:48:07 +0000"  >&lt;p&gt;User &apos;hvanhovell&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/16063&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/16063&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17179511" author="kkyong" created="Tue, 18 Aug 2020 10:00:18 +0000"  >&lt;p&gt;I have the same issue in spark 2.3.4&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-32638&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SPARK-32638&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;the issue seem not be resolved .&#160;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 13 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i36w6n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>