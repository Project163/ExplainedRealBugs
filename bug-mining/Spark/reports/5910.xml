<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:01:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-22713] OOM caused by the memory contention and memory leak in TaskMemoryManager</title>
                <link>https://issues.apache.org/jira/browse/SPARK-22713</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;The pdf version of this issue with high-quality figures is available at &lt;a href=&quot;https://github.com/JerryLead/Misc/blob/master/OOM-TasksMemoryManager/report/OOM-TaskMemoryManager.pdf&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/JerryLead/Misc/blob/master/OOM-TasksMemoryManager/report/OOM-TaskMemoryManager.pdf&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Abstract&amp;#93;&lt;/span&gt;&lt;/b&gt; &lt;/p&gt;

&lt;p&gt;I recently encountered an OOM error in a PageRank application (&lt;em&gt;org.apache.spark.examples.SparkPageRank&lt;/em&gt;). After profiling the application, I found the OOM error is related to the memory contention in shuffle spill phase. Here, the memory contention means that a task tries to release some old memory consumers from memory for keeping the new memory consumers. After analyzing the OOM heap dump, I found the root cause is a memory leak in &lt;em&gt;TaskMemoryManager&lt;/em&gt;. Since memory contention is common in shuffle phase, this is a critical bug/defect. In the following sections, I will use the application dataflow, execution log, heap dump, and source code to identify the root cause.&lt;/p&gt;


&lt;p&gt;&lt;b&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Application&amp;#93;&lt;/span&gt;&lt;/b&gt; &lt;/p&gt;

&lt;p&gt;This is a PageRank application from Spark&#8217;s example library. The following figure shows the application dataflow. The source code is available at [1].&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://raw.githubusercontent.com/JerryLead/Misc/master/OOM-TasksMemoryManager/figures/PageRankDataflow.png&quot; width=&quot;100%&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Failure symptoms&amp;#93;&lt;/span&gt;&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;This application has a map stage and many iterative reduce stages. An OOM error occurs in a reduce task (Task-28) as follows.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://github.com/JerryLead/Misc/blob/master/OOM-TasksMemoryManager/figures/Stage.png?raw=true&quot; width=&quot;100%&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://github.com/JerryLead/Misc/blob/master/OOM-TasksMemoryManager/figures/task.png?raw=true&quot; width=&quot;100%&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;OOM root cause identification&amp;#93;&lt;/span&gt;&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;Each executor has 1 CPU core and 6.5GB memory, so it only runs one task at a time. After analyzing the application dataflow, error log, heap dump, and source code, I found the following steps lead to the OOM error. &lt;/p&gt;

&lt;p&gt;=&amp;gt; The MemoryManager found that there is not enough memory to cache the &lt;em&gt;links:ShuffledRDD&lt;/em&gt; (rdd-5-28, red circles in the dataflow figure).&lt;br/&gt;
&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://github.com/JerryLead/Misc/blob/master/OOM-TasksMemoryManager/figures/ShuffledRDD.png?raw=true&quot; width=&quot;100%&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;=&amp;gt; The task needs to shuffle twice (1st shuffle and 2nd shuffle in the dataflow figure).&lt;br/&gt;
=&amp;gt; The task needs to generate two &lt;em&gt;ExternalAppendOnlyMap&lt;/em&gt; (E1 for 1st shuffle and E2 for 2nd shuffle) in sequence.&lt;br/&gt;
=&amp;gt; The 1st shuffle begins and ends. E1 aggregates all the shuffled data of 1st shuffle and achieves 3.3 GB.&lt;br/&gt;
&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://github.com/JerryLead/Misc/blob/master/OOM-TasksMemoryManager/figures/FirstShuffle.png?raw=true&quot; width=&quot;100%&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;br/&gt;
=&amp;gt; The 2nd shuffle begins. E2 is aggregating the shuffled data of 2nd shuffle, and finding that there is not enough memory left. This triggers the memory contention.&lt;br/&gt;
&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://github.com/JerryLead/Misc/blob/master/OOM-TasksMemoryManager/figures/SecondShuffle.png?raw=true&quot; width=&quot;100%&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;br/&gt;
=&amp;gt; To handle the memory contention, the &lt;em&gt;TaskMemoryManager&lt;/em&gt; releases E1 (spills it onto disk) and assumes that the 3.3GB space is free now.&lt;br/&gt;
&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://github.com/JerryLead/Misc/blob/master/OOM-TasksMemoryManager/figures/MemoryContention.png?raw=true&quot; width=&quot;100%&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;br/&gt;
=&amp;gt; E2 continues to aggregates the shuffled records of 2nd shuffle. However, E2 encounters an OOM error while shuffling.&lt;br/&gt;
&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://github.com/JerryLead/Misc/blob/master/OOM-TasksMemoryManager/figures/OOMbefore.png?raw=true&quot; width=&quot;100%&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;br/&gt;
&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://github.com/JerryLead/Misc/blob/master/OOM-TasksMemoryManager/figures/OOMError.png?raw=true&quot; width=&quot;100%&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Guess&amp;#93;&lt;/span&gt;&lt;/b&gt; &lt;br/&gt;
The task memory usage below reveals that there is not memory drop down. So, the cause may be that the 3.3GB &lt;em&gt;ExternalAppendOnlyMap&lt;/em&gt; (E1) is not actually released by the &lt;em&gt;TaskMemoryManger&lt;/em&gt;. &lt;br/&gt;
&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://github.com/JerryLead/Misc/blob/master/OOM-TasksMemoryManager/figures/GCFigure.png?raw=true&quot; width=&quot;100%&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;


&lt;p&gt;&lt;b&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Root cause&amp;#93;&lt;/span&gt;&lt;/b&gt; &lt;br/&gt;
After analyzing the heap dump, I found the guess is right (the 3.3GB &lt;em&gt;ExternalAppendOnlyMap&lt;/em&gt; is actually not released). The 1.6GB object is &lt;em&gt;ExternalAppendOnlyMap (E2)&lt;/em&gt;.&lt;br/&gt;
&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://github.com/JerryLead/Misc/blob/master/OOM-TasksMemoryManager/figures/heapdump.png?raw=true&quot; width=&quot;100%&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Question&amp;#93;&lt;/span&gt;&lt;/b&gt; &lt;br/&gt;
Why the released &lt;em&gt;ExternalAppendOnlyMap&lt;/em&gt; is still in memory?&lt;br/&gt;
The source code of &lt;em&gt;ExternalAppendOnlyMap&lt;/em&gt; shows that the &lt;em&gt;currentMap&lt;/em&gt; (&lt;em&gt;AppendOnlyMap&lt;/em&gt;) has been set to &lt;em&gt;null&lt;/em&gt; when the spill action is finished.&lt;br/&gt;
&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://github.com/JerryLead/Misc/blob/master/OOM-TasksMemoryManager/figures/SourceCode.png?raw=true&quot; width=&quot;100%&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Root cause in the source code&amp;#93;&lt;/span&gt;&lt;/b&gt; I further analyze the reference chain of unreleased &lt;em&gt;ExternalAppendOnlyMap&lt;/em&gt;. The reference chain shows that the 3.3GB &lt;em&gt;ExternalAppendOnlyMap&lt;/em&gt; is still referenced by the &lt;em&gt;upstream/readingIterator&lt;/em&gt; and further referenced by &lt;em&gt;TaskMemoryManager&lt;/em&gt; as follows. So, the root cause in the source code is that the &lt;em&gt;ExternalAppendOnlyMap&lt;/em&gt; is still referenced by other iterators (setting the &lt;em&gt;currentMap&lt;/em&gt; to &lt;em&gt;null&lt;/em&gt; is not enough).&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://github.com/JerryLead/Misc/blob/master/OOM-TasksMemoryManager/figures/References.png?raw=true&quot; width=&quot;100%&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Potential solution&amp;#93;&lt;/span&gt;&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;Setting the &lt;em&gt;upstream/readingIterator&lt;/em&gt; to &lt;em&gt;null&lt;/em&gt; after the &lt;em&gt;forceSpill&lt;/em&gt;() action. I will try this solution in these days.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;References&amp;#93;&lt;/span&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; PageRank source code. &lt;a href=&quot;https://github.com/JerryLead/SparkGC/blob/master/src/main/scala/applications/graph/PageRank.scala&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/JerryLead/SparkGC/blob/master/src/main/scala/applications/graph/PageRank.scala&lt;/a&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; Task execution log. &lt;a href=&quot;https://github.com/JerryLead/Misc/blob/master/OOM-TasksMemoryManager/log/TaskExecutionLog.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/JerryLead/Misc/blob/master/OOM-TasksMemoryManager/log/TaskExecutionLog.txt&lt;/a&gt; &lt;/p&gt;


</description>
                <environment></environment>
        <key id="13123128">SPARK-22713</key>
            <summary>OOM caused by the memory contention and memory leak in TaskMemoryManager</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="eyalfa">Eyal Farago</assignee>
                                    <reporter username="jerrylead">Lijie Xu</reporter>
                        <labels>
                    </labels>
                <created>Wed, 6 Dec 2017 09:00:53 +0000</created>
                <updated>Sun, 16 Sep 2018 03:22:55 +0000</updated>
                            <resolved>Mon, 13 Aug 2018 12:56:48 +0000</resolved>
                                    <version>2.1.1</version>
                    <version>2.1.2</version>
                                    <fixVersion>2.4.0</fixVersion>
                                    <component>Shuffle</component>
                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>19</watches>
                                                                                                                <comments>
                            <comment id="16481468" author="eyalfa" created="Sat, 19 May 2018 04:54:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jerrylead&quot; class=&quot;user-hover&quot; rel=&quot;jerrylead&quot;&gt;jerrylead&lt;/a&gt;, excellent investigation and description of the issue, I&apos;ll open a PR shortly.&lt;/p&gt;</comment>
                            <comment id="16481475" author="apachespark" created="Sat, 19 May 2018 05:12:04 +0000"  >&lt;p&gt;User &apos;eyalfa&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/21369&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/21369&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16481881" author="eyalfa" created="Sun, 20 May 2018 09:32:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jerrylead&quot; class=&quot;user-hover&quot; rel=&quot;jerrylead&quot;&gt;jerrylead&lt;/a&gt;, what&apos;s the relation to &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-22286&quot; title=&quot;OutOfMemoryError caused by memory leak and large serializer batch size in ExternalAppendOnlyMap&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-22286&quot;&gt;&lt;del&gt;SPARK-22286&lt;/del&gt;&lt;/a&gt;? does solving this at least partially solve that as well?&lt;/p&gt;</comment>
                            <comment id="16578245" author="cloud_fan" created="Mon, 13 Aug 2018 12:56:48 +0000"  >&lt;p&gt;Issue resolved by pull request 21369&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/21369&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/21369&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16578322" author="eyalfa" created="Mon, 13 Aug 2018 14:10:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jerrylead&quot; class=&quot;user-hover&quot; rel=&quot;jerrylead&quot;&gt;jerrylead&lt;/a&gt;, can you please test this?&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 14 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3nld3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>