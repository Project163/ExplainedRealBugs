<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:35:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-11596] SQL execution very slow for nested query plans because of DataFrame.withNewExecutionId</title>
                <link>https://issues.apache.org/jira/browse/SPARK-11596</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;For nested query plans like a recursive unionAll, withExecutionId is extremely slow, likely because of repeated string concatenation in QueryPlan.simpleString&lt;/p&gt;

&lt;p&gt;Test case:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;(1 to 100).foldLeft[Option[DataFrame]] (None) { (curr, idx) =&amp;gt;
    println(s&lt;span class=&quot;code-quote&quot;&gt;&quot;PROCESSING &amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt; $idx&quot;&lt;/span&gt;)
    val df = sqlContext.sparkContext.parallelize((0 to 10).zipWithIndex).toDF(&lt;span class=&quot;code-quote&quot;&gt;&quot;A&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;B&quot;&lt;/span&gt;)
    val union = curr.map(_.unionAll(df)).getOrElse(df)
    union.cache()
    println(&lt;span class=&quot;code-quote&quot;&gt;&quot;&amp;gt;&amp;gt;&quot;&lt;/span&gt; + union.count)
    &lt;span class=&quot;code-comment&quot;&gt;//union.show()
&lt;/span&gt;    Some(union)
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Stack trace:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;scala.collection.TraversableOnce$class.addString(TraversableOnce.scala:320)&lt;br/&gt;
scala.collection.AbstractIterator.addString(Iterator.scala:1157)&lt;br/&gt;
scala.collection.TraversableOnce$class.mkString(TraversableOnce.scala:286)&lt;br/&gt;
scala.collection.AbstractIterator.mkString(Iterator.scala:1157)&lt;br/&gt;
scala.collection.TraversableOnce$class.mkString(TraversableOnce.scala:288)&lt;br/&gt;
scala.collection.AbstractIterator.mkString(Iterator.scala:1157)&lt;br/&gt;
org.apache.spark.sql.catalyst.trees.TreeNode.argString(TreeNode.scala:364)&lt;br/&gt;
org.apache.spark.sql.catalyst.trees.TreeNode.simpleString(TreeNode.scala:367)&lt;br/&gt;
org.apache.spark.sql.catalyst.plans.QueryPlan.simpleString(QueryPlan.scala:168)&lt;br/&gt;
org.apache.spark.sql.catalyst.trees.TreeNode.generateTreeString(TreeNode.scala:401)&lt;br/&gt;
org.apache.spark.sql.catalyst.trees.TreeNode$$anonfun$generateTreeString$1.apply(TreeNode.scala:403)&lt;br/&gt;
org.apache.spark.sql.catalyst.trees.TreeNode$$anonfun$generateTreeString$1.apply(TreeNode.scala:403)&lt;br/&gt;
scala.collection.immutable.List.foreach(List.scala:318)&lt;br/&gt;
org.apache.spark.sql.catalyst.trees.TreeNode.generateTreeString(TreeNode.scala:403)&lt;br/&gt;
org.apache.spark.sql.catalyst.trees.TreeNode$$anonfun$generateTreeString$1.apply(TreeNode.scala:403)&lt;br/&gt;
org.apache.spark.sql.catalyst.trees.TreeNode$$anonfun$generateTreeString$1.apply(TreeNode.scala:403)&lt;br/&gt;
scala.collection.immutable.List.foreach(List.scala:318)&lt;br/&gt;
org.apache.spark.sql.catalyst.trees.TreeNode.generateTreeString(TreeNode.scala:403)&lt;br/&gt;
org.apache.spark.sql.catalyst.trees.TreeNode$$anonfun$generateTreeString$1.apply(TreeNode.scala:403)&lt;br/&gt;
org.apache.spark.sql.catalyst.trees.TreeNode$$anonfun$generateTreeString$1.apply(TreeNode.scala:403)&lt;br/&gt;
scala.collection.immutable.List.foreach(List.scala:318)&lt;br/&gt;
org.apache.spark.sql.catalyst.trees.TreeNode.generateTreeString(TreeNode.scala:403)&lt;br/&gt;
org.apache.spark.sql.catalyst.trees.TreeNode.treeString(TreeNode.scala:372)&lt;br/&gt;
org.apache.spark.sql.catalyst.trees.TreeNode.toString(TreeNode.scala:369)&lt;br/&gt;
org.apache.spark.sql.SQLContext$QueryExecution.stringOrError(SQLContext.scala:936)&lt;br/&gt;
org.apache.spark.sql.SQLContext$QueryExecution.toString(SQLContext.scala:949)&lt;br/&gt;
org.apache.spark.sql.execution.SQLExecution$.withNewExecutionId(SQLExecution.scala:52)&lt;br/&gt;
org.apache.spark.sql.DataFrame.withNewExecutionId(DataFrame.scala:1903)&lt;br/&gt;
org.apache.spark.sql.DataFrame.collect(DataFrame.scala:1384)&lt;br/&gt;
org.apache.spark.sql.DataFrame.count(DataFrame.scala:1402)&lt;/p&gt;&lt;/blockquote&gt;</description>
                <environment></environment>
        <key id="12911587">SPARK-11596</key>
            <summary>SQL execution very slow for nested query plans because of DataFrame.withNewExecutionId</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yhuai">Yin Huai</assignee>
                                    <reporter username="copris">Cristian Opris</reporter>
                        <labels>
                    </labels>
                <created>Mon, 9 Nov 2015 17:02:03 +0000</created>
                <updated>Wed, 2 Dec 2015 12:12:48 +0000</updated>
                            <resolved>Wed, 2 Dec 2015 01:19:41 +0000</resolved>
                                    <version>1.5.1</version>
                                    <fixVersion>1.6.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15012325" author="yhuai" created="Wed, 18 Nov 2015 23:16:02 +0000"  >&lt;p&gt;Right now, UnionAll operator is a binary operator. Seems reasonable to change it to accept more than 2 children. Then, we can expose a method to let users union more than 2 DFs.&lt;/p&gt;</comment>
                            <comment id="15012386" author="onetoinfinity@yahoo.com" created="Wed, 18 Nov 2015 23:45:08 +0000"  >&lt;p&gt;This is not what this is about. It&apos;s very useful to have UnionAll work recursively or iteratively.&lt;/p&gt;

&lt;p&gt;The problem is not with the execution of the actual plan, but in creating an execution ID, QueryPlan.simpleString is very inefficient I suspect because it copies Strings instead of using StringBuffers all the way through.&lt;/p&gt;

&lt;p&gt;Basically this is a very expensive toString, with a very simple fix. Any chance you might look into it, it&apos;s should be straightforward to fix. For objective reasons I&apos;m not able to.&lt;/p&gt;</comment>
                            <comment id="15019051" author="yhuai" created="Fri, 20 Nov 2015 23:29:27 +0000"  >&lt;p&gt;For your case, the most of time was taken by the job execution (every union.count triggers a job execution). Seems toString does not take a significant amount of time compared with the time spent on job execution.&lt;/p&gt;</comment>
                            <comment id="15019096" author="onetoinfinity@yahoo.com" created="Fri, 20 Nov 2015 23:50:05 +0000"  >&lt;p&gt;Sorry, my repro code was missing a cache() statement. I added it now and that should make the actual execution - triggered intentionally by count(), yes - very cheap.&lt;/p&gt;

&lt;p&gt;You&apos;ll still see that after only about 10 iterations it becomes extremely slow.&lt;/p&gt;

&lt;p&gt;The issue is in QueryExecution.toString() which is called from SQLExecution.withNewExecutionId()&lt;/p&gt;

&lt;p&gt;I actually verified this by removing the transformation of the plans into strings there, rebuilding and rerunning, and I can see the problem goes away.&lt;/p&gt;</comment>
                            <comment id="15019158" author="onetoinfinity@yahoo.com" created="Sat, 21 Nov 2015 00:16:34 +0000"  >&lt;p&gt;Although you are right that this does not reproduce without caching. It does get slower because it needs to recompute the chain everytime, but without caching it actually finishes all 100 iterations in a reasonable amount of time. With caching it virtually stops after about 20 iterations and spend all the time in toString&lt;/p&gt;

&lt;p&gt;I suspect this is because the query plans are different and there is some query plan triggered by caching that has a very expensive toString ?&lt;/p&gt;</comment>
                            <comment id="15019241" author="onetoinfinity@yahoo.com" created="Sat, 21 Nov 2015 01:17:25 +0000"  >&lt;p&gt;Ok, I found a much simpler repro. Note the below does not actually execute, just generates the plans.  DF.explain() takes a very long time here:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;val c = (1 to 20).foldLeft[Option[DataFrame]] (None) { (curr, idx) =&amp;gt;
    println(s&lt;span class=&quot;code-quote&quot;&gt;&quot;PROCESSING &amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt; $idx&quot;&lt;/span&gt;)
    val df = sqlContext.sparkContext.parallelize((0 to 10).zipWithIndex).toDF(&lt;span class=&quot;code-quote&quot;&gt;&quot;A&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;B&quot;&lt;/span&gt;)
    val union = curr.map(_.unionAll(df)).getOrElse(df)
    union.cache()
    Some(union)
  }

c.get.explain(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) &lt;span class=&quot;code-comment&quot;&gt;//&amp;lt;--- &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; is very expensive&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15019267" author="onetoinfinity@yahoo.com" created="Sat, 21 Nov 2015 01:40:47 +0000"  >&lt;p&gt;Looks like the problem is here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/spark/blob/master/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/trees/TreeNode.scala#L358&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/master/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/trees/TreeNode.scala#L358&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; tn: TreeNode[_] &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; tn.toString contains &lt;span class=&quot;code-quote&quot;&gt;&quot;\n&quot;&lt;/span&gt; =&amp;gt; s&lt;span class=&quot;code-quote&quot;&gt;&quot;(${tn.simpleString})&quot;&lt;/span&gt; :: Nil
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When this condition is true the tree evaluation becomes exponential. &lt;/p&gt;</comment>
                            <comment id="15020172" author="yhuai" created="Sat, 21 Nov 2015 02:24:59 +0000"  >&lt;p&gt;Thank you for investigating! I will also take a look.&lt;/p&gt;</comment>
                            <comment id="15034058" author="onetoinfinity@yahoo.com" created="Tue, 1 Dec 2015 16:56:42 +0000"  >&lt;p&gt;Any chance this can be fixed soon ? It looks like a straightforward simple bug to me, but it can have quite an impact.  &lt;/p&gt;</comment>
                            <comment id="15034787" author="apachespark" created="Tue, 1 Dec 2015 22:49:25 +0000"  >&lt;p&gt;User &apos;yhuai&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/10079&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/10079&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15034789" author="yhuai" created="Tue, 1 Dec 2015 22:50:46 +0000"  >&lt;p&gt;Can you try &lt;a href=&quot;https://github.com/apache/spark/pull/10079/files?&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/10079/files?&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15035054" author="marmbrus" created="Wed, 2 Dec 2015 01:19:41 +0000"  >&lt;p&gt;Issue resolved by pull request 10079&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/10079&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/10079&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15035700" author="onetoinfinity@yahoo.com" created="Wed, 2 Dec 2015 12:12:48 +0000"  >&lt;p&gt;That&apos;s great, thank you&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12773615" name="screenshot-1.png" size="239084" author="yhuai" created="Fri, 20 Nov 2015 23:27:22 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 50 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2o5bz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12333083">1.6.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>