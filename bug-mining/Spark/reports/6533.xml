<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:05:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-28156] Join plan sometimes does not use cached query</title>
                <link>https://issues.apache.org/jira/browse/SPARK-28156</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;I came across&#160;a case where a cached query is&#160;referenced&#160;on both sides of a join,&#160;but the InMemoryRelation is inserted&#160;on only one side. This case occurs only when the cached query uses a (Hive-style) view.&lt;/p&gt;

&lt;p&gt;Consider this example:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;// create the data
val df1 = Seq.tabulate(10) { x =&amp;gt; (x, x + 1, x + 2, x + 3) }.toDF(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;, &quot;d&quot;)
df1.write.mode(&quot;overwrite&quot;).format(&quot;orc&quot;).saveAsTable(&quot;table1&quot;)
sql(&quot;drop view if exists table1_vw&quot;)
sql(&quot;create view table1_vw as select * from table1&quot;)

// create the cached query
val cacheddataDf = sql(&quot;&quot;&quot;
select a, b, c, d
from table1_vw
&quot;&quot;&quot;)

import org.apache.spark.storage.StorageLevel.DISK_ONLY
cacheddataDf.createOrReplaceTempView(&quot;cacheddata&quot;)
cacheddataDf.persist(DISK_ONLY)

// main query
val queryDf = sql(s&quot;&quot;&quot;
select leftside.a, leftside.b
from cacheddata leftside
join cacheddata rightside
on leftside.a = rightside.a
&quot;&quot;&quot;)

queryDf.explain(true)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Note that the optimized plan does not use an InMemoryRelation for the right side, but instead just uses a Relation:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Project [a#45, b#46]
+- Join Inner, (a#45 = a#37)
   :- Project [a#45, b#46]
   :  +- Filter isnotnull(a#45)
   :     +- InMemoryRelation [a#45, b#46, c#47, d#48], StorageLevel(disk, 1 replicas)
   :           +- *(1) FileScan orc default.table1[a#37,b#38,c#39,d#40] Batched: true, DataFilters: [], Format: ORC, Location: InMemoryFileIndex[file:/Users/brobbins/github/spark_upstream/spark-warehouse/table1], PartitionFilters: [], PushedFilters: [], ReadSchema: struct&amp;lt;a:int,b:int,c:int,d:int&amp;gt;
   +- Project [a#37]
      +- Filter isnotnull(a#37)
         +- Relation[a#37,b#38,c#39,d#40] orc

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The fragment does not match the cached query because AliasViewChild adds an extra projection under the View on the right side (see #2 below).&lt;/p&gt;

&lt;p&gt;AliasViewChild adds the extra projection because the exprIds in the View&apos;s output appears to have been renamed by Analyzer$ResolveReferences (#1 below). I have not yet looked at why.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;-
-
-
   +- SubqueryAlias `rightside`
      +- SubqueryAlias `cacheddata`
         +- Project [a#73, b#74, c#75, d#76]
            +- SubqueryAlias `default`.`table1_vw`
(#1) -&amp;gt;        +- View (`default`.`table1_vw`, [a#73,b#74,c#75,d#76])
(#2) -&amp;gt;           +- Project [cast(a#45 as int) AS a#73, cast(b#46 as int) AS b#74, cast(c#47 as int) AS c#75, cast(d#48 as int) AS d#76]
                     +- Project [cast(a#37 as int) AS a#45, cast(b#38 as int) AS b#46, cast(c#39 as int) AS c#47, cast(d#40 as int) AS d#48]
                        +- Project [a#37, b#38, c#39, d#40]
                           +- SubqueryAlias `default`.`table1`
                              +- Relation[a#37,b#38,c#39,d#40] orc

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In a larger query (where cachedata may be referred on either side only indirectly), this phenomenon can create certain oddities, as the fragment is not replaced with InMemoryRelation, and&#160;the fragment is present when the plan is optimized as a whole.&lt;/p&gt;

&lt;p&gt;In Spark 2.1.3, Spark uses InMemoryRelation on both sides.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13241375">SPARK-28156</key>
            <summary>Join plan sometimes does not use cached query</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="viirya">L. C. Hsieh</assignee>
                                    <reporter username="bersprockets">Bruce Robbins</reporter>
                        <labels>
                    </labels>
                <created>Tue, 25 Jun 2019 01:48:37 +0000</created>
                <updated>Thu, 1 Aug 2019 20:51:25 +0000</updated>
                            <resolved>Wed, 3 Jul 2019 13:25:45 +0000</resolved>
                                    <version>2.3.3</version>
                    <version>2.4.3</version>
                    <version>3.0.0</version>
                                    <fixVersion>2.3.4</fixVersion>
                    <fixVersion>2.4.4</fixVersion>
                    <fixVersion>3.0.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16877831" author="cloud_fan" created="Wed, 3 Jul 2019 13:25:45 +0000"  >&lt;p&gt;Issue resolved by pull request 24960&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/24960&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/24960&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 19 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z042c0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>