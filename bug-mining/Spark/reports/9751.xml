<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:42:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-46957] Migrated shuffle data files from the decommissioned node should be removed when job completed</title>
                <link>https://issues.apache.org/jira/browse/SPARK-46957</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Hi, we have a long-lived Spark application run on a standalone cluster on GCP and we are using spot instances. To reduce the impact of preempted instances, we have enabled node decommission to let the preempted node migrate its shuffle data to other instances before it is deleted by GCP.&lt;/p&gt;

&lt;p&gt;However, we found the migrated shuffle data from the decommissioned node is never removed. (same behavior on spark-3.5)&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Reproduce steps:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;1. Start spark-shell with 3 executors and enable decommission on both driver/worker&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
start-worker.sh[3331]: Spark Command: /usr/lib/jvm/java-17-openjdk-amd64/bin/java -cp /opt/spark/conf/:/opt/spark/jars/* -Dspark.worker.cleanup.appDataTtl=1800 -Dspark.decommission.enabled=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; -Xmx1g org.apache.spark.deploy.worker.Worker --webui-port 8081 spark:&lt;span class=&quot;code-comment&quot;&gt;//master-01.com:7077 &lt;/span&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
/opt/spark/bin/spark-shell --master spark:&lt;span class=&quot;code-comment&quot;&gt;//master-01.spark.com:7077 \
&lt;/span&gt;  --total-executor-cores 12 \
  --conf spark.decommission.enabled=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; \
  --conf spark.storage.decommission.enabled=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; \
  --conf spark.storage.decommission.shuffleBlocks.enabled=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; \
  --conf spark.storage.decommission.rddBlocks.enabled=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;2.&#160;Manually stop 1 worker during execution&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
(1 to 10).foreach { i =&amp;gt;
  println(s&lt;span class=&quot;code-quote&quot;&gt;&quot;start iter $i ...&quot;&lt;/span&gt;)
  val longString = &lt;span class=&quot;code-quote&quot;&gt;&quot;Lorem ipsum dolor sit amet, consectetur adipiscing elit. &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt; eget tortor id libero ultricies faucibus nec ac neque. Vivamus ac risus vitae mi efficitur lacinia. Quisque dignissim quam vel tellus placerat, non laoreet elit rhoncus. Nam et magna id dui tempor sagittis. Aliquam erat volutpat. &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt; tristique purus ac eros bibendum, at varius velit viverra. Sed eleifend luctus massa, ac accumsan leo feugiat ac. Sed id nisl et enim tristique auctor. Sed vel ante nec leo placerat tincidunt. Ut varius, risus nec sodales tempor, odio augue euismod ipsum, nec tristique e&quot;&lt;/span&gt;
  val df = (1 to 10000 * i).map(j =&amp;gt; (j, s&lt;span class=&quot;code-quote&quot;&gt;&quot;${j}_${longString}&quot;&lt;/span&gt;)).toDF(&lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;mystr&quot;&lt;/span&gt;)

  df.repartition(6).count()
  &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.gc()
  println(s&lt;span class=&quot;code-quote&quot;&gt;&quot;finished iter $i, wait 15s &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; next round&quot;&lt;/span&gt;)
  &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(15*1000)
}
&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.gc()

start iter 1 ...
finished iter 1, wait 15s &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; next round
... &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;3. Check the migrated shuffle data files on the remaining workers&lt;/p&gt;

&lt;p&gt;&lt;b&gt;decommissioned node&lt;/b&gt;: migrated shuffle file successfully&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
less /mnt/spark_work/app-20240202084807-0003/1/stdout | grep &lt;span class=&quot;code-quote&quot;&gt;&apos;Migrated &apos;&lt;/span&gt;
24/02/02 08:48:53 INFO BlockManagerDecommissioner: Migrated migrate_shuffle_4_41 to BlockManagerId(2, 10.67.5.139, 35949, None)
24/02/02 08:48:53 INFO BlockManagerDecommissioner: Migrated migrate_shuffle_4_38 to BlockManagerId(0, 10.67.5.134, 36175, None)
24/02/02 08:48:53 INFO BlockManagerDecommissioner: Migrated migrate_shuffle_4_47 to BlockManagerId(0, 10.67.5.134, 36175, None)
24/02/02 08:48:53 INFO BlockManagerDecommissioner: Migrated migrate_shuffle_4_44 to BlockManagerId(2, 10.67.5.139, 35949, None)
24/02/02 08:48:53 INFO BlockManagerDecommissioner: Migrated migrate_shuffle_5_52 to BlockManagerId(0, 10.67.5.134, 36175, None)
24/02/02 08:48:53 INFO BlockManagerDecommissioner: Migrated migrate_shuffle_5_55 to BlockManagerId(2, 10.67.5.139, 35949, None) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;b&gt;remaining shuffle data files on the other workers&lt;/b&gt;: the migrated shuffle files are never removed&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
10.67.5.134 | CHANGED | rc=0 &amp;gt;&amp;gt;
-rw-r--r-- 1 spark spark 126 Feb  2 08:48 /mnt/spark/spark-b25878b3-8b3c-4cff-ba4d-41f6d128da7c/executor-b8f83524-9270-4f35-83ca-ceb13af2b7d1/blockmgr-f05c4d8e-e1a5-4822-a6e9-49be760b67a2/13/shuffle_4_47_0.data
-rw-r--r-- 1 spark spark 126 Feb  2 08:48 /mnt/spark/spark-b25878b3-8b3c-4cff-ba4d-41f6d128da7c/executor-b8f83524-9270-4f35-83ca-ceb13af2b7d1/blockmgr-f05c4d8e-e1a5-4822-a6e9-49be760b67a2/31/shuffle_4_38_0.data
-rw-r--r-- 1 spark spark 32 Feb  2 08:48 /mnt/spark/spark-b25878b3-8b3c-4cff-ba4d-41f6d128da7c/executor-b8f83524-9270-4f35-83ca-ceb13af2b7d1/blockmgr-f05c4d8e-e1a5-4822-a6e9-49be760b67a2/3a/shuffle_5_52_0.data
10.67.5.139 | CHANGED | rc=0 &amp;gt;&amp;gt;
-rw-r--r-- 1 spark spark 126 Feb  2 08:48 /mnt/spark/spark-ab501bec-ddd2-4b82-af3e-f2731066e580/executor-1ca5ad78-1d75-453d-88ab-487d7cdfacb7/blockmgr-f09eb18d-b0e4-48f9-a4ed-5587cef25a16/27/shuffle_4_41_0.data
-rw-r--r-- 1 spark spark 126 Feb  2 08:48 /mnt/spark/spark-ab501bec-ddd2-4b82-af3e-f2731066e580/executor-1ca5ad78-1d75-453d-88ab-487d7cdfacb7/blockmgr-f09eb18d-b0e4-48f9-a4ed-5587cef25a16/36/shuffle_4_44_0.data
-rw-r--r-- 1 spark spark 32 Feb  2 08:48 /mnt/spark/spark-ab501bec-ddd2-4b82-af3e-f2731066e580/executor-1ca5ad78-1d75-453d-88ab-487d7cdfacb7/blockmgr-f09eb18d-b0e4-48f9-a4ed-5587cef25a16/29/shuffle_5_55_0.data &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Expected behavior:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;The migrated shuffle data files should be removed after job completed&lt;/p&gt;</description>
                <environment></environment>
        <key id="13567155">SPARK-46957</key>
            <summary>Migrated shuffle data files from the decommissioned node should be removed when job completed</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="Ngone51">wuyi</assignee>
                                    <reporter username="yujhe.li">Yu-Jhe Li</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 2 Feb 2024 09:23:15 +0000</created>
                <updated>Mon, 15 Sep 2025 12:53:58 +0000</updated>
                            <resolved>Thu, 27 Jun 2024 08:48:09 +0000</resolved>
                                    <version>3.0.0</version>
                                    <fixVersion>3.5.2</fixVersion>
                    <fixVersion>3.4.4</fixVersion>
                    <fixVersion>4.0.0</fixVersion>
                                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17856284" author="ngone51" created="Wed, 19 Jun 2024 14:20:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yujhe.li&quot; class=&quot;user-hover&quot; rel=&quot;yujhe.li&quot;&gt;yujhe.li&lt;/a&gt; Thanks for reporting this bug. I&apos;ll submit a fix.&lt;/p&gt;</comment>
                            <comment id="17860385" author="wuyi" created="Thu, 27 Jun 2024 08:48:09 +0000"  >&lt;p&gt;Issue resolved by pull request 47037&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/47037&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/47037&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17860437" author="yao" created="Thu, 27 Jun 2024 11:15:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/spark/commit/7aa12b6cd01da88cbbb3e8c6e50863e6139315b7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/commit/7aa12b6cd01da88cbbb3e8c6e50863e6139315b7&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/commit/f8b1040ea006fe48df6bb52e0ace4dce54ab6d56&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/commit/f8b1040ea006fe48df6bb52e0ace4dce54ab6d56&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Reverted it from 3.4 and 3.5 to fix the CI&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13628942">SPARK-53581</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13069723">SPARK-20624</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 19 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1n688:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>