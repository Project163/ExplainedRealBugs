<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:17:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-31854] Different results of query execution with wholestage codegen on and off</title>
                <link>https://issues.apache.org/jira/browse/SPARK-31854</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Preface: I&apos;m creating Kotlin API for spark to take best parts from three worlds &#8212; spark scala, spark java and kotlin.&lt;/p&gt;

&lt;p&gt;What is nice &#8212; it works in most scenarios.&lt;/p&gt;

&lt;p&gt;But i&apos;ve hit following cornercase:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-scala&quot;&gt;
withSpark(props = mapOf(&lt;span class=&quot;code-quote&quot;&gt;&quot;spark.sql.codegen.wholeStage&quot;&lt;/span&gt; to &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)) {
    dsOf(1, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, 2)
            .map { c(it) }
            .debugCodegen()
            .show()
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;c(it) is creation of unnamed tuple&lt;/p&gt;

&lt;p&gt;It fails with exception&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.NullPointerException: Null value appeared in non-nullable field:
top level Product or row object
If the schema is inferred from a Scala tuple/&lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; class, or a Java bean, please &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; to use scala.Option[_] or other nullable types (e.g. java.lang.&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt; instead of &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;/scala.Int).
	at org.apache.spark.sql.catalyst.expressions.GeneratedClass$GeneratedIteratorForCodegenStage1.serializefromobject_doConsume_0$(Unknown Source)
	at org.apache.spark.sql.catalyst.expressions.GeneratedClass$GeneratedIteratorForCodegenStage1.mapelements_doConsume_0$(Unknown Source)
	at org.apache.spark.sql.catalyst.expressions.GeneratedClass$GeneratedIteratorForCodegenStage1.deserializetoobject_doConsume_0$(Unknown Source)
	at org.apache.spark.sql.catalyst.expressions.GeneratedClass$GeneratedIteratorForCodegenStage1.processNext(Unknown Source)
&#8230;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I know, in Scala it won&apos;t work, so I could stop here. But it works in Kotlin if I turn wholestage codegen off!&lt;/p&gt;

&lt;p&gt;Moreover, if we will dig into generated code (when wholestage codegen is on), we&apos;ll see that basically flow is following:&lt;br/&gt;
If one of elements in source dataset was null we wil throw NPE no matter what.&lt;/p&gt;

&lt;p&gt;Flow is as follows:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void serializefromobject_doConsume_0(org.jetbrains.spark.api.Arity1 serializefromobject_expr_0_0, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; serializefromobject_exprIsNull_0_0) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; java.io.IOException {
    serializefromobject_doConsume_0(mapelements_value_1, mapelements_isNull_1);
        mapelements_isNull_1 = mapelements_resultIsNull_0;
            mapelements_resultIsNull_0 = mapelements_exprIsNull_0_0;
                &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void mapelements_doConsume_0(java.lang.&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt; mapelements_expr_0_0, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; mapelements_exprIsNull_0_0) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; java.io.IOException {
                    mapelements_doConsume_0(deserializetoobject_value_0, deserializetoobject_isNull_0);
                        deserializetoobject_resultIsNull_0 = deserializetoobject_exprIsNull_0_0;
                            &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void deserializetoobject_doConsume_0(InternalRow localtablescan_row_0, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; deserializetoobject_expr_0_0, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; deserializetoobject_exprIsNull_0_0) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; java.io.IOException {
                                deserializetoobject_doConsume_0(localtablescan_row_0, localtablescan_value_0, localtablescan_isNull_0);
                                    &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; localtablescan_isNull_0 = localtablescan_row_0.isNullAt(0);
        mapelements_isNull_1 = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;You can find generated code in it&apos;s original view and slightly simplified and refacored version &lt;a href=&quot;https://gist.github.com/asm0dey/5c0fa4c985ab999b383d16257b515100&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I believe that Spark should not behave differently when wholestage codegen is on and off and differences in behavior look like a bug.&lt;/p&gt;

&lt;p&gt;My Spark version is 3.0.0-preview2&lt;/p&gt;</description>
                <environment></environment>
        <key id="13307957">SPARK-31854</key>
            <summary>Different results of query execution with wholestage codegen on and off</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="maropu">Takeshi Yamamuro</assignee>
                                    <reporter username="asm0dey">Pasha Finkeshteyn</reporter>
                        <labels>
                    </labels>
                <created>Thu, 28 May 2020 08:39:36 +0000</created>
                <updated>Mon, 1 Jun 2020 11:12:31 +0000</updated>
                            <resolved>Mon, 1 Jun 2020 04:52:52 +0000</resolved>
                                    <version>2.0.2</version>
                    <version>2.1.3</version>
                    <version>2.2.3</version>
                    <version>2.3.4</version>
                    <version>2.4.5</version>
                    <version>3.0.0</version>
                                    <fixVersion>2.4.7</fixVersion>
                    <fixVersion>3.0.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17119334" author="maropu" created="Fri, 29 May 2020 07:10:21 +0000"  >&lt;p&gt;Could you show us a query to reproduce the issue in our env? If we don&apos;t have it, we cannot look into it. Anyway, thanks for the report.&lt;/p&gt;</comment>
                            <comment id="17119352" author="asm0dey" created="Fri, 29 May 2020 07:28:21 +0000"  >&lt;p&gt;What do you mean by query? It is written in Kotlin and is on top of report. &lt;/p&gt;

&lt;p&gt;If you need alternative query in Scala it will be like following&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
spark.conf.set(&lt;span class=&quot;code-quote&quot;&gt;&quot;spark.sql.codegen.wholeStage&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)

Seq(1.asInstanceOf[&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;], &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;.asInstanceOf[&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;], 3.asInstanceOf[&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;]).toDS().map(v=&amp;gt;(v,v)).show()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It also works when spark.sql.codegen.wholeStage is false and doesn&apos;t when it is on.&lt;/p&gt;</comment>
                            <comment id="17120412" author="maropu" created="Sun, 31 May 2020 05:37:41 +0000"  >&lt;p&gt;Thanks for your report. Yea. that should be a bug of the whole-stage codegen as you said.&lt;/p&gt;</comment>
                            <comment id="17120413" author="apachespark" created="Sun, 31 May 2020 05:39:01 +0000"  >&lt;p&gt;User &apos;maropu&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/28681&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/28681&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17120746" author="dongjoon" created="Mon, 1 Jun 2020 04:10:36 +0000"  >&lt;p&gt;I also verified this at 2.0.2 ~ 2.3.4 and updated the affected versions.&lt;/p&gt;</comment>
                            <comment id="17120750" author="maropu" created="Mon, 1 Jun 2020 04:18:19 +0000"  >&lt;p&gt;Thanks for the update, Dongjoon.&lt;/p&gt;</comment>
                            <comment id="17120759" author="cloud_fan" created="Mon, 1 Jun 2020 04:52:52 +0000"  >&lt;p&gt;Issue resolved by pull request 28681&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/28681&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/28681&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17120800" author="apachespark" created="Mon, 1 Jun 2020 07:42:30 +0000"  >&lt;p&gt;User &apos;maropu&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/28691&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/28691&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17120801" author="apachespark" created="Mon, 1 Jun 2020 07:42:59 +0000"  >&lt;p&gt;User &apos;maropu&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/28691&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/28691&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 24 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0f96g:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>