<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:49:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-18251] DataSet API | RuntimeException: Null value appeared in non-nullable field when holding Option Case Class</title>
                <link>https://issues.apache.org/jira/browse/SPARK-18251</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;I am running into a runtime exception when a DataSet is holding an Empty object instance for an Option type that is holding non-nullable field. For instance, if we have the following case class:&lt;/p&gt;

&lt;p&gt;case class DataRow(id: Int, value: String)&lt;/p&gt;

&lt;p&gt;Then, DataSet[Option&lt;span class=&quot;error&quot;&gt;&amp;#91;DataRow&amp;#93;&lt;/span&gt;] can only hold Some(DataRow) objects and cannot hold Empty. If it does so, the following exception is thrown:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Exception in thread &quot;main&quot; org.apache.spark.SparkException: Job aborted due to stage failure: Task 6 in stage 0.0 failed 1 times, most recent failure: Lost task 6.0 in stage 0.0 (TID 6, localhost): java.lang.RuntimeException: Null value appeared in non-nullable field:
- field (class: &quot;scala.Int&quot;, name: &quot;id&quot;)
- option value class: &quot;DataSetOptBug.DataRow&quot;
- root class: &quot;scala.Option&quot;
If the schema is inferred from a Scala tuple/case class, or a Java bean, please try to use scala.Option[_] or other nullable types (e.g. java.lang.Integer instead of int/scala.Int).
	at org.apache.spark.sql.catalyst.expressions.GeneratedClass$GeneratedIterator.agg_doAggregateWithoutKey$(Unknown Source)
	at org.apache.spark.sql.catalyst.expressions.GeneratedClass$GeneratedIterator.processNext(Unknown Source)
	at org.apache.spark.sql.execution.BufferedRowIterator.hasNext(BufferedRowIterator.java:43)
	at org.apache.spark.sql.execution.WholeStageCodegenExec$$anonfun$8$$anon$1.hasNext(WholeStageCodegenExec.scala:370)
	at scala.collection.Iterator$$anon$11.hasNext(Iterator.scala:408)
	at org.apache.spark.shuffle.sort.BypassMergeSortShuffleWriter.write(BypassMergeSortShuffleWriter.java:125)
	at org.apache.spark.scheduler.ShuffleMapTask.runTask(ShuffleMapTask.scala:79)
	at org.apache.spark.scheduler.ShuffleMapTask.runTask(ShuffleMapTask.scala:47)
	at org.apache.spark.scheduler.Task.run(Task.scala:86)
	at org.apache.spark.executor.Executor$TaskRunner.run(Executor.scala:274)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	at java.lang.Thread.run(Thread.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The bug can be reproduce by using the program: &lt;a href=&quot;https://gist.github.com/aniketbhatnagar/2ed74613f70d2defe999c18afaa4816e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/aniketbhatnagar/2ed74613f70d2defe999c18afaa4816e&lt;/a&gt;&lt;/p&gt;</description>
                <environment>&lt;p&gt;OS X&lt;/p&gt;</environment>
        <key id="13017588">SPARK-18251</key>
            <summary>DataSet API | RuntimeException: Null value appeared in non-nullable field when holding Option Case Class</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cloud_fan">Wenchen Fan</assignee>
                                    <reporter username="aniket">Aniket Bhatnagar</reporter>
                        <labels>
                    </labels>
                <created>Thu, 3 Nov 2016 10:49:13 +0000</created>
                <updated>Mon, 5 Dec 2016 04:52:55 +0000</updated>
                            <resolved>Wed, 30 Nov 2016 21:36:42 +0000</resolved>
                                    <version>2.0.1</version>
                                    <fixVersion>2.2.0</fixVersion>
                                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="15651228" author="jayadevan.m" created="Wed, 9 Nov 2016 15:26:03 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aniket&quot; class=&quot;user-hover&quot; rel=&quot;aniket&quot;&gt;aniket&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I tried to run your code. I am able to run successfully&lt;/p&gt;

&lt;p&gt;data.map(i =&amp;gt; if (i &amp;lt; 500) &lt;/p&gt;
{ Some(DataRow(i.toInt, s&quot;i$i&quot;)) }
&lt;p&gt; else &lt;/p&gt;
{ Option.empty }
&lt;p&gt;).filter(_.isEmpty).count().&lt;/p&gt;

&lt;p&gt;I don&apos;t think .map(_.get) is required. Just count will give the result.&lt;/p&gt;
</comment>
                            <comment id="15658492" author="aniket" created="Fri, 11 Nov 2016 23:22:49 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jayadevan.m&quot; class=&quot;user-hover&quot; rel=&quot;jayadevan.m&quot;&gt;jayadevan.m&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Which version of scala and spark did you use? I can reproduce this on spark 2.0.1 and scala 2.11.8. I have created a sample project with all the dependencies to easily reproduce this:&lt;br/&gt;
&lt;a href=&quot;https://github.com/aniketbhatnagar/SPARK-18251-data-set-option-bug&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/aniketbhatnagar/SPARK-18251-data-set-option-bug&lt;/a&gt;&lt;br/&gt;
To reproduce the bug, simple checkout the project and run the command sbt run.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Aniket&lt;/p&gt;</comment>
                            <comment id="15670877" author="hvanhovell" created="Wed, 16 Nov 2016 16:19:54 +0000"  >&lt;p&gt;I cannot reproduce this on master or branch 2.1. This is still an issue on 2.0, see: &lt;a href=&quot;https://databricks-prod-cloudfront.cloud.databricks.com/public/4027ec902e239c93eaaa8714f173bcfc/2728434780191932/4444281805930326/6987336228780374/latest.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://databricks-prod-cloudfront.cloud.databricks.com/public/4027ec902e239c93eaaa8714f173bcfc/2728434780191932/4444281805930326/6987336228780374/latest.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cloud_fan&quot; class=&quot;user-hover&quot; rel=&quot;cloud_fan&quot;&gt;cloud_fan&lt;/a&gt; Any idea which patch fixed this?&lt;/p&gt;</comment>
                            <comment id="15673708" author="cloud_fan" created="Thu, 17 Nov 2016 13:21:12 +0000"  >&lt;p&gt;This is a tricky problem.&lt;/p&gt;

&lt;p&gt;First, using `Option&lt;span class=&quot;error&quot;&gt;&amp;#91;T&amp;#93;&lt;/span&gt;` as the type of Dataset is not well supported, you can try `Seq(Some(1 -&amp;gt; &quot;a&quot;), None).toDS.collect`, it will return `Array(Some(1 -&amp;gt; a), Some(0 -&amp;gt; null))` instead of `Array(Some((1,a)), None)`. The reason is, we explicitly forbid users to use null as top-level non-flat objects, but we forget to handle top level None. We should create a ticket for it.&lt;/p&gt;

&lt;p&gt;In Spark 2.0, typed filter is not optimized well, so the example code will first deserialize row to object, then apply the map function, then serialize the mapped object to row, then the filter operator will deserialize the row to object, and apply the filter function. In Spark 2.1, typed filter will be pushed down through `SerializeFromObject`, which means the process get optimized to: deserialize row to object, then apply the map function, then apply the filter function, then serialize object to row. So this bug is kind of hidden in Spark 2.1(the null check exception is thrown during serialization)&lt;/p&gt;

&lt;p&gt;We have 2 choices here:&lt;br/&gt;
1. forbid top-level None, as well as null.&lt;br/&gt;
2. treat `Option` like a normal product, which is a single field struct.&lt;/p&gt;

&lt;p&gt;Any ideas? cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yhuai&quot; class=&quot;user-hover&quot; rel=&quot;yhuai&quot;&gt;yhuai&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lian+cheng&quot; class=&quot;user-hover&quot; rel=&quot;lian cheng&quot;&gt;lian cheng&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=marmbrus&quot; class=&quot;user-hover&quot; rel=&quot;marmbrus&quot;&gt;marmbrus&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15677396" author="lian cheng" created="Fri, 18 Nov 2016 18:36:47 +0000"  >&lt;p&gt;I&apos;d prefer option 1 because of consistency of the semantics, and I don&apos;t think this is really a bug since &lt;tt&gt;Option[T]&lt;/tt&gt; shouldn&apos;t be used as top level &lt;tt&gt;Dataset&lt;/tt&gt; types anyway.&lt;/p&gt;

&lt;p&gt;While doing schema inference, Catalyst always translates &lt;tt&gt;Option[T]&lt;/tt&gt; to the nullable version of &lt;tt&gt;T&apos;&lt;/tt&gt;, where &lt;tt&gt;T&apos;&lt;/tt&gt; is the inferred data type of &lt;tt&gt;T&lt;/tt&gt;. Take &lt;tt&gt;case class A(i: Option[Int])&lt;/tt&gt; as an example, if we go for option 2, then what should the inferred schema of &lt;tt&gt;A&lt;/tt&gt; be? To keep the original semantics, it should be&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;new StructType()
  .add(&quot;i&quot;, IntegerType, nullable = true)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;while option 2 requires&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;new StructType()
  .add(&quot;i&quot;, new StructType()
    .add(&quot;value&quot;, IntegerType, nullable = true), nullable = true)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;since now &lt;tt&gt;Option[T]&lt;/tt&gt; is treated as a single field struct.&lt;/p&gt;

&lt;p&gt;Option 1 keeps the current semantics, which is pretty clear and easy to reason about, while option 2 either introduces inconsistency or requires us to further special case schema inference for top level &lt;tt&gt;Dataset&lt;/tt&gt; types.&lt;/p&gt;</comment>
                            <comment id="15686862" author="apachespark" created="Tue, 22 Nov 2016 14:17:05 +0000"  >&lt;p&gt;User &apos;cloud-fan&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/15979&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/15979&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15709857" author="lian cheng" created="Wed, 30 Nov 2016 21:36:43 +0000"  >&lt;p&gt;Issue resolved by pull request 15979&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/15979&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/15979&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15709869" author="lian cheng" created="Wed, 30 Nov 2016 21:41:31 +0000"  >&lt;p&gt;One more comment about why we shouldn&apos;t allow a &lt;tt&gt;Option[T &amp;lt;: Product]&lt;/tt&gt; to be used as top-level Dataset type: one way to think about this more intuitively is to make an analogy to databases. In a database table, you cannot mark a row itself as null. Instead, you are only allowed to mark a field of a row to be null.&lt;/p&gt;

&lt;p&gt;Instead of using &lt;tt&gt;Option[T &amp;lt;: Product]&lt;/tt&gt;, the user should resort to &lt;tt&gt;Tuple1[T &amp;lt;: Product]&lt;/tt&gt;. Thus, you have a row consisting of a single field, which can be filled with either a null or a struct.&lt;/p&gt;</comment>
                            <comment id="15721228" author="koert" created="Mon, 5 Dec 2016 04:52:55 +0000"  >&lt;p&gt;i think all of these arguments are very valid, however to me they argue for a constraint on the top-level type of the Dataset, not the Encoder. the difference matters because Encoders are also used for types that are not the top-level type of the Dataset, such as the key type in groupByKey, or the buffer in an Aggregator.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 50 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i35sh3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>