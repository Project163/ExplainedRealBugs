<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:32:18 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-39347] Generate wrong time window when (timestamp-startTime) % slideDuration &lt; 0</title>
                <link>https://issues.apache.org/jira/browse/SPARK-39347</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Since the generation strategy of the sliding window in PR &lt;a href=&quot;#35362&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;35362&lt;/a&gt;(&lt;a href=&quot;https://github.com/apache/spark/pull/35362&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/35362&lt;/a&gt;) is changed to the current one, and that leads to a new problem.&lt;/p&gt;

&lt;p&gt;A window generation error occurs when the time required to process the recorded data is negative and the modulo value between the time and window length is less than 0. In the current test cases, this bug does not thorw up.&lt;/p&gt;

&lt;p&gt;[ test(&quot;negative timestamps&quot;)](&lt;a href=&quot;https://github.com/apache/spark/blob/master/sql/core/src/test/scala/org/apache/spark/sql/DataFrameTimeWindowingSuite.scala#L299&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/master/sql/core/src/test/scala/org/apache/spark/sql/DataFrameTimeWindowingSuite.scala#L299&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
val df1 = Seq(
  (&lt;span class=&quot;code-quote&quot;&gt;&quot;1970-01-01 00:00:02&quot;&lt;/span&gt;, 1),
  (&lt;span class=&quot;code-quote&quot;&gt;&quot;1970-01-01 00:00:12&quot;&lt;/span&gt;, 2)).toDF(&lt;span class=&quot;code-quote&quot;&gt;&quot;time&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;value&quot;&lt;/span&gt;)
val df2 = Seq(
  (LocalDateTime.parse(&lt;span class=&quot;code-quote&quot;&gt;&quot;1970-01-01T00:00:02&quot;&lt;/span&gt;), 1),
  (LocalDateTime.parse(&lt;span class=&quot;code-quote&quot;&gt;&quot;1970-01-01T00:00:12&quot;&lt;/span&gt;), 2)).toDF(&lt;span class=&quot;code-quote&quot;&gt;&quot;time&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;value&quot;&lt;/span&gt;)

Seq(df1, df2).foreach { df =&amp;gt;
  checkAnswer(
    df.select(window($&lt;span class=&quot;code-quote&quot;&gt;&quot;time&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;10 seconds&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;10 seconds&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;5 seconds&quot;&lt;/span&gt;), $&lt;span class=&quot;code-quote&quot;&gt;&quot;value&quot;&lt;/span&gt;)
      .orderBy($&lt;span class=&quot;code-quote&quot;&gt;&quot;window.start&quot;&lt;/span&gt;.asc)
      .select($&lt;span class=&quot;code-quote&quot;&gt;&quot;window.start&quot;&lt;/span&gt;.&lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(StringType), $&lt;span class=&quot;code-quote&quot;&gt;&quot;window.end&quot;&lt;/span&gt;.&lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(StringType), $&lt;span class=&quot;code-quote&quot;&gt;&quot;value&quot;&lt;/span&gt;),
    Seq(
      Row(&lt;span class=&quot;code-quote&quot;&gt;&quot;1969-12-31 23:59:55&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;1970-01-01 00:00:05&quot;&lt;/span&gt;, 1),
      Row(&lt;span class=&quot;code-quote&quot;&gt;&quot;1970-01-01 00:00:05&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;1970-01-01 00:00:15&quot;&lt;/span&gt;, 2))
  )
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The timestamp of the above test data is not negative, and the value modulo the window length is not negative, so it can be passes the test case.&lt;/p&gt;

&lt;p&gt;An exception occurs when the timestamp becomes something like this.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
val df3 = Seq(
  (&lt;span class=&quot;code-quote&quot;&gt;&quot;1969-12-31 00:00:02&quot;&lt;/span&gt;, 1),
  (&lt;span class=&quot;code-quote&quot;&gt;&quot;1969-12-31 00:00:12&quot;&lt;/span&gt;, 2)).toDF(&lt;span class=&quot;code-quote&quot;&gt;&quot;time&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;value&quot;&lt;/span&gt;)
val df4 = Seq(
  (LocalDateTime.parse(&lt;span class=&quot;code-quote&quot;&gt;&quot;1969-12-31T00:00:02&quot;&lt;/span&gt;), 1),
  (LocalDateTime.parse(&lt;span class=&quot;code-quote&quot;&gt;&quot;1969-12-31T00:00:12&quot;&lt;/span&gt;), 2)).toDF(&lt;span class=&quot;code-quote&quot;&gt;&quot;time&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;value&quot;&lt;/span&gt;)

Seq(df3, df4).foreach { df =&amp;gt;
  checkAnswer(
    df.select(window($&lt;span class=&quot;code-quote&quot;&gt;&quot;time&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;10 seconds&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;10 seconds&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;5 seconds&quot;&lt;/span&gt;), $&lt;span class=&quot;code-quote&quot;&gt;&quot;value&quot;&lt;/span&gt;)
      .orderBy($&lt;span class=&quot;code-quote&quot;&gt;&quot;window.start&quot;&lt;/span&gt;.asc)
      .select($&lt;span class=&quot;code-quote&quot;&gt;&quot;window.start&quot;&lt;/span&gt;.&lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(StringType), $&lt;span class=&quot;code-quote&quot;&gt;&quot;window.end&quot;&lt;/span&gt;.&lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(StringType), $&lt;span class=&quot;code-quote&quot;&gt;&quot;value&quot;&lt;/span&gt;),
    Seq(
      Row(&lt;span class=&quot;code-quote&quot;&gt;&quot;1969-12-30 23:59:55&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;1969-12-31 00:00:05&quot;&lt;/span&gt;, 1),
      Row(&lt;span class=&quot;code-quote&quot;&gt;&quot;1969-12-31 00:00:05&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;1969-12-31 00:00:15&quot;&lt;/span&gt;, 2))
  )
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;run and get unexpected result:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
== Results ==
!== Correct Answer - 2 == &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;== Spark Answer - 2 ==
!struct&amp;lt;&amp;gt; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;struct&amp;lt;CAST(window.start AS STRING):string,CAST(window.end AS STRING):string,value:&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&amp;gt;
![1969-12-30 23:59:55,1969-12-31 00:00:05,1] &#160; [1969-12-31 00:00:05,1969-12-31 00:00:15,1]
![1969-12-31 00:00:05,1969-12-31 00:00:15,2] &#160; [1969-12-31 00:00:15,1969-12-31 00:00:25,2]&#160;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;benchmark result&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;oldlogic&lt;a href=&quot;#18364&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;18364&lt;/a&gt;(&lt;a href=&quot;https://github.com/apache/spark/pull/18364&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/18364&lt;/a&gt;) &#160;VS &#12304;fix version&#12305;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Running benchmark: tumbling windows
Running &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt;: old logic
Stopped after 407 iterations, 10012 ms
Running &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt;: &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; logic
Stopped after 615 iterations, 10007 ms
Java HotSpot(TM) 64-Bit Server VM 1.8.0_181-b13 on Windows 10 10.0
Intel64 Family 6 Model 158 Stepping 10, GenuineIntel
tumbling windows: &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; Best Time(ms) &#160; Avg Time(ms) &#160; Stdev(ms) &#160; &#160;Rate(M/s) &#160; Per Row(ns) &#160; Relative
------------------------------------------------------------------------------------------------------------------------
old logic &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;17 &#160; &#160; &#160; &#160; &#160; &#160; 25 &#160; &#160; &#160; &#160; &#160; 9 &#160; &#160; &#160; &#160;580.1 &#160; &#160; &#160; &#160; &#160; 1.7 &#160; &#160; &#160; 1.0X
&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; logic &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;15 &#160; &#160; &#160; &#160; &#160; &#160; 16 &#160; &#160; &#160; &#160; &#160; 2 &#160; &#160; &#160; &#160;680.8 &#160; &#160; &#160; &#160; &#160; 1.5 &#160; &#160; &#160; 1.2X
Running benchmark: sliding windows
Running &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt;: old logic
Stopped after 10 iterations, 10296 ms
Running &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt;: &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; logic
Stopped after 15 iterations, 10391 ms
Java HotSpot(TM) 64-Bit Server VM 1.8.0_181-b13 on Windows 10 10.0
Intel64 Family 6 Model 158 Stepping 10, GenuineIntel
sliding windows: &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;Best Time(ms) &#160; Avg Time(ms) &#160; Stdev(ms) &#160; &#160;Rate(M/s) &#160; Per Row(ns) &#160; Relative
------------------------------------------------------------------------------------------------------------------------
old logic &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;1000 &#160; &#160; &#160; &#160; &#160; 1030 &#160; &#160; &#160; &#160; &#160;19 &#160; &#160; &#160; &#160; 10.0 &#160; &#160; &#160; &#160; 100.0 &#160; &#160; &#160; 1.0X
&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; logic &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; 668 &#160; &#160; &#160; &#160; &#160; &#160;693 &#160; &#160; &#160; &#160; &#160;21 &#160; &#160; &#160; &#160; 15.0 &#160; &#160; &#160; &#160; &#160;66.8 &#160; &#160; &#160; 1.5X
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Fixed version than PR &lt;a href=&quot;#38069&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;38069&lt;/a&gt;(&lt;a href=&quot;https://github.com/apache/spark/pull/35362&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/35362&lt;/a&gt;) lost a bit of the performance.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13447664">SPARK-39347</key>
            <summary>Generate wrong time window when (timestamp-startTime) % slideDuration &lt; 0</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="WweiL">Wei Liu</assignee>
                                    <reporter username="nyingping">nyingping</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 31 May 2022 09:41:05 +0000</created>
                <updated>Sat, 7 Sep 2024 10:05:19 +0000</updated>
                            <resolved>Mon, 6 Feb 2023 03:08:13 +0000</resolved>
                                    <version>3.3.0</version>
                                    <fixVersion>3.4.0</fixVersion>
                    <fixVersion>3.5.0</fixVersion>
                                    <component>Structured Streaming</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17544716" author="apachespark" created="Wed, 1 Jun 2022 06:03:40 +0000"  >&lt;p&gt;User &apos;nyingping&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/36737&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/36737&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17682906" author="apachespark" created="Wed, 1 Feb 2023 08:21:26 +0000"  >&lt;p&gt;User &apos;WweiL&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/39843&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/39843&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17682907" author="apachespark" created="Wed, 1 Feb 2023 08:22:01 +0000"  >&lt;p&gt;User &apos;WweiL&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/39843&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/39843&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17684397" author="kabhwan" created="Mon, 6 Feb 2023 03:08:13 +0000"  >&lt;p&gt;Issue resolved via &lt;a href=&quot;https://github.com/apache/spark/pull/39843&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/39843&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 40 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z12tp4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>