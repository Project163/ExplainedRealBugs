<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:46:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-16826] java.util.Hashtable limits the throughput of PARSE_URL()</title>
                <link>https://issues.apache.org/jira/browse/SPARK-16826</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Hello!&lt;/p&gt;

&lt;p&gt;I&apos;m using &lt;tt&gt;c4.8xlarge&lt;/tt&gt; instances on EC2 with 36 cores and doing lots of &lt;tt&gt;parse_url(url, &quot;host&quot;)&lt;/tt&gt; in Spark SQL.&lt;/p&gt;

&lt;p&gt;Unfortunately it seems that there is an internal thread-safe cache in there, and the instances end up being 90% idle.&lt;/p&gt;

&lt;p&gt;When I view the thread dump for my executors, most of the executor threads are &quot;BLOCKED&quot;, in that state:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.util.Hashtable.get(Hashtable.java:362)
java.net.URL.getURLStreamHandler(URL.java:1135)
java.net.URL.&amp;lt;init&amp;gt;(URL.java:599)
java.net.URL.&amp;lt;init&amp;gt;(URL.java:490)
java.net.URL.&amp;lt;init&amp;gt;(URL.java:439)
org.apache.spark.sql.catalyst.expressions.ParseUrl.getUrl(stringExpressions.scala:731)
org.apache.spark.sql.catalyst.expressions.ParseUrl.parseUrlWithoutKey(stringExpressions.scala:772)
org.apache.spark.sql.catalyst.expressions.ParseUrl.eval(stringExpressions.scala:785)
org.apache.spark.sql.catalyst.expressions.GeneratedClass$SpecificPredicate.eval(Unknown Source)
org.apache.spark.sql.catalyst.expressions.codegen.GeneratePredicate$$anonfun$create$2.apply(GeneratePredicate.scala:69)
org.apache.spark.sql.catalyst.expressions.codegen.GeneratePredicate$$anonfun$create$2.apply(GeneratePredicate.scala:69)
org.apache.spark.sql.execution.FilterExec$$anonfun$17$$anonfun$apply$2.apply(basicPhysicalOperators.scala:203)
org.apache.spark.sql.execution.FilterExec$$anonfun$17$$anonfun$apply$2.apply(basicPhysicalOperators.scala:202)
scala.collection.Iterator$$anon$13.hasNext(Iterator.scala:463)
org.apache.spark.sql.catalyst.expressions.GeneratedClass$GeneratedIterator.processNext(Unknown Source)
org.apache.spark.sql.execution.BufferedRowIterator.hasNext(BufferedRowIterator.java:43)
org.apache.spark.sql.execution.WholeStageCodegenExec$$anonfun$8$$anon$1.hasNext(WholeStageCodegenExec.scala:370)
scala.collection.Iterator$$anon$11.hasNext(Iterator.scala:408)
org.apache.spark.shuffle.sort.BypassMergeSortShuffleWriter.write(BypassMergeSortShuffleWriter.java:147)
org.apache.spark.scheduler.ShuffleMapTask.runTask(ShuffleMapTask.scala:79)
org.apache.spark.scheduler.ShuffleMapTask.runTask(ShuffleMapTask.scala:47)
org.apache.spark.scheduler.Task.run(Task.scala:85)
org.apache.spark.executor.Executor$TaskRunner.run(Executor.scala:274)
java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;However, when I switch from 1 executor with 36 cores to 9 executors with 4 cores, throughput is almost 10x higher and the CPUs are back at ~100% use.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</description>
                <environment></environment>
        <key id="12993828">SPARK-16826</key>
            <summary>java.util.Hashtable limits the throughput of PARSE_URL()</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sylvinus">Sylvain Zimmer</assignee>
                                    <reporter username="sylvinus">Sylvain Zimmer</reporter>
                        <labels>
                    </labels>
                <created>Sun, 31 Jul 2016 21:31:05 +0000</created>
                <updated>Fri, 12 Jan 2018 08:50:06 +0000</updated>
                            <resolved>Fri, 5 Aug 2016 19:56:08 +0000</resolved>
                                    <version>2.0.0</version>
                                    <fixVersion>2.1.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15402110" author="srowen" created="Mon, 1 Aug 2016 14:24:53 +0000"  >&lt;p&gt;The contention is in the JDK class java.net.URL itself, and it does look like an unfortunate bottleneck from ages ago. There&apos;s a static, globally synchronized Hashtable here, which explains why multiple JVM (executors) alleviates the problem. We can&apos;t fix that directly. See also &lt;a href=&quot;http://www.supermind.org/blog/580/java-net-url-synchronization-bottleneck&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.supermind.org/blog/580/java-net-url-synchronization-bottleneck&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;We also probably have to rely on the behavior of this class to parse a URL. I don&apos;t see a good alternative here? You can avoid the lookup if you pass in the URLStreamHandler manually which would mean reimplementing some of the same logic in URL. That then means the overhead of looking up a SecurityManager though.&lt;/p&gt;

&lt;p&gt;What about just avoiding a load of calls to parseURL at once, is that at all reasonable? like rearranging the pipeline to filter or remove duplicates earlier upstream?&lt;/p&gt;</comment>
                            <comment id="15403165" author="sylvinus" created="Tue, 2 Aug 2016 01:14:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srowen&quot; class=&quot;user-hover&quot; rel=&quot;srowen&quot;&gt;srowen&lt;/a&gt; thanks for the pointers! &lt;/p&gt;

&lt;p&gt;I&apos;m parsing every hyperlink found in Common Crawl, so there are billions of unique ones, no way around it.&lt;/p&gt;

&lt;p&gt;Wouldn&apos;t it be possible to switch to another implementation with an API similar to java.net.URL? As I understand it we never need the URLStreamHandler in the first place anyway?&lt;/p&gt;

&lt;p&gt;I&apos;m not a Java expert but what about &lt;tt&gt;java.net.URI&lt;/tt&gt; or &lt;tt&gt;org.apache.catalina.util.URL&lt;/tt&gt; for instance?&lt;/p&gt;</comment>
                            <comment id="15403222" author="srowen" created="Tue, 2 Aug 2016 02:04:27 +0000"  >&lt;p&gt;URI.toURL just follows the same code path. Does URI itself parse all the same fields? Didn&apos;t think so because URIs are a superset of URLs.&lt;/p&gt;

&lt;p&gt;Definitely open to suggestions. Anything that can parse the same fields respectably is OK.&lt;/p&gt;</comment>
                            <comment id="15403236" author="sylvinus" created="Tue, 2 Aug 2016 02:21:19 +0000"  >&lt;p&gt;Sorry I can&apos;t be more helpful on the Java side... But I think there must be some high-quality URL parsing code somewhere in the Apache foundation already &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15403262" author="sylvinus" created="Tue, 2 Aug 2016 02:41:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srowen&quot; class=&quot;user-hover&quot; rel=&quot;srowen&quot;&gt;srowen&lt;/a&gt; what about this? &lt;br/&gt;
&lt;a href=&quot;https://github.com/sylvinus/spark/commit/98119a08368b1cd1faf3f25a32910ad6717c5c02&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/sylvinus/spark/commit/98119a08368b1cd1faf3f25a32910ad6717c5c02&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The tests seem to pass and I don&apos;t think it uses the problematic code paths in java.net.URL (except for getFile but that may be could be fixed easily)&lt;/p&gt;</comment>
                            <comment id="15406868" author="apachespark" created="Thu, 4 Aug 2016 00:09:07 +0000"  >&lt;p&gt;User &apos;sylvinus&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/14488&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/14488&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15409973" author="srowen" created="Fri, 5 Aug 2016 19:56:09 +0000"  >&lt;p&gt;Issue resolved by pull request 14488&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/14488&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/14488&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                            <outwardlinks description="incorporates">
                                        <issuelink>
            <issuekey id="13130460">SPARK-23056</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 15 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i31q4f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>