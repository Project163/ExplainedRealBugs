<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:07:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-28917] Jobs can hang because of race of RDD.dependencies</title>
                <link>https://issues.apache.org/jira/browse/SPARK-28917</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;&lt;tt&gt;RDD.dependencies&lt;/tt&gt; stores the precomputed cache value, but it is not thread-safe.  This can lead to a race where the value gets overwritten, but the DAGScheduler gets stuck in an inconsistent state.  In particular, this can happen when there is a race between the DAGScheduler event loop, and another thread (eg. a user thread, if there is multi-threaded job submission).&lt;/p&gt;


&lt;p&gt;First, a job is submitted by the user, which then computes the result Stage and its parents:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/spark/blob/24655583f1cb5dae2e80bb572604fb4a9761ec07/core/src/main/scala/org/apache/spark/scheduler/DAGScheduler.scala#L983&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/24655583f1cb5dae2e80bb572604fb4a9761ec07/core/src/main/scala/org/apache/spark/scheduler/DAGScheduler.scala#L983&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Which eventually makes a call to &lt;tt&gt;rdd.dependencies&lt;/tt&gt;:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/spark/blob/24655583f1cb5dae2e80bb572604fb4a9761ec07/core/src/main/scala/org/apache/spark/scheduler/DAGScheduler.scala#L519&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/24655583f1cb5dae2e80bb572604fb4a9761ec07/core/src/main/scala/org/apache/spark/scheduler/DAGScheduler.scala#L519&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;At the same time, the user could also touch &lt;tt&gt;rdd.dependencies&lt;/tt&gt; in another thread, which could overwrite the stored value because of the race.&lt;/p&gt;

&lt;p&gt;Then the DAGScheduler checks the dependencies &lt;b&gt;again&lt;/b&gt; later on in the job submission, via &lt;tt&gt;getMissingParentStages&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/spark/blob/24655583f1cb5dae2e80bb572604fb4a9761ec07/core/src/main/scala/org/apache/spark/scheduler/DAGScheduler.scala#L1025&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/24655583f1cb5dae2e80bb572604fb4a9761ec07/core/src/main/scala/org/apache/spark/scheduler/DAGScheduler.scala#L1025&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Because it will find new dependencies, it will create entirely different stages.  Now the job has some orphaned stages which will never run.&lt;/p&gt;

&lt;p&gt;One symptoms of this are seeing disjoint sets of stages in the &quot;Parents of final stage&quot; and the &quot;Missing parents&quot; messages on job submission (however this is not required).&lt;/p&gt;

&lt;p&gt;(&lt;b&gt;EDIT&lt;/b&gt;: Seeing repeated msgs &quot;Registering RDD X&quot; actually is just fine, it is not a symptom of a problem at all.  It just means the RDD is the &lt;b&gt;input&lt;/b&gt; to multiple shuffles.)&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[INFO] 2019-08-15 23:22:31,570 org.apache.spark.SparkContext logInfo - Starting job: count at XXX.scala:462
...
[INFO] 2019-08-15 23:22:31,573 org.apache.spark.scheduler.DAGScheduler logInfo - Registering RDD 14 (repartition at XXX.scala:421)
...
...
[INFO] 2019-08-15 23:22:31,582 org.apache.spark.scheduler.DAGScheduler logInfo - Got job 1 (count at XXX.scala:462) with 40 output partitions
[INFO] 2019-08-15 23:22:31,582 org.apache.spark.scheduler.DAGScheduler logInfo - Final stage: ResultStage 5 (count at XXX.scala:462)
[INFO] 2019-08-15 23:22:31,582 org.apache.spark.scheduler.DAGScheduler logInfo - Parents of final stage: List(ShuffleMapStage 4)
[INFO] 2019-08-15 23:22:31,599 org.apache.spark.scheduler.DAGScheduler logInfo - Registering RDD 14 (repartition at XXX.scala:421)
[INFO] 2019-08-15 23:22:31,599 org.apache.spark.scheduler.DAGScheduler logInfo - Missing parents: List(ShuffleMapStage 6)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Another symptom is only visible with DEBUG logs turned on for DAGScheduler &amp;#8211; you will calls to &lt;tt&gt;submitStage(Stage X)&lt;/tt&gt; multiple times, followed by a different set of missing stages.  eg. here, we see stage 1 first is missing stage 0 as a dependency, and then later on its missing stage 23:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;19/09/19 22:28:15 DEBUG scheduler.DAGScheduler: submitStage(ShuffleMapStage 1)
19/09/19 22:28:15 DEBUG scheduler.DAGScheduler: missing: List(ShuffleMapStage 0)
...
19/09/19 22:32:01 DEBUG scheduler.DAGScheduler: submitStage(ShuffleMapStage 1)
19/09/19 22:32:01 DEBUG scheduler.DAGScheduler: missing: List(ShuffleMapStage 23)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Note that there is a similar issue w/ &lt;tt&gt;rdd.partitions&lt;/tt&gt;.  In particular for some RDDs, &lt;tt&gt;partitions&lt;/tt&gt; references &lt;tt&gt;dependencies&lt;/tt&gt; (eg. &lt;tt&gt;CoGroupedRDD&lt;/tt&gt;).  &lt;/p&gt;

&lt;p&gt;There is also an issue that &lt;tt&gt;rdd.storageLevel&lt;/tt&gt; is read and cached in the scheduler, but it could be modified simultaneously by the user in another thread.   But, I can&apos;t see a way it could effect the scheduler.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;WORKAROUND&lt;/b&gt;:&lt;br/&gt;
(a) call &lt;tt&gt;rdd.dependencies&lt;/tt&gt; while you know that RDD is only getting touched by one thread (eg. in the thread that created it, or before you submit multiple jobs touching that RDD from other threads). Then that value will get cached.&lt;br/&gt;
(b) don&apos;t submit jobs from multiple threads.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13253753">SPARK-28917</key>
            <summary>Jobs can hang because of race of RDD.dependencies</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="irashid">Imran Rashid</assignee>
                                    <reporter username="irashid">Imran Rashid</reporter>
                        <labels>
                    </labels>
                <created>Thu, 29 Aug 2019 16:22:32 +0000</created>
                <updated>Sun, 17 May 2020 17:48:37 +0000</updated>
                            <resolved>Tue, 8 Oct 2019 18:43:45 +0000</resolved>
                                    <version>2.3.3</version>
                    <version>2.4.3</version>
                                    <fixVersion>2.4.5</fixVersion>
                    <fixVersion>3.0.0</fixVersion>
                                    <component>Scheduler</component>
                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="16918764" author="irashid" created="Thu, 29 Aug 2019 16:33:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markhamstra&quot; class=&quot;user-hover&quot; rel=&quot;markhamstra&quot;&gt;markhamstra&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jiangxb1987&quot; class=&quot;user-hover&quot; rel=&quot;jiangxb1987&quot;&gt;jiangxb1987&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tgraves&quot; class=&quot;user-hover&quot; rel=&quot;tgraves&quot;&gt;tgraves&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Ngone51&quot; class=&quot;user-hover&quot; rel=&quot;Ngone51&quot;&gt;Ngone51&lt;/a&gt; would appreciate your thoughts on this.  I think the bug I&apos;ve described above is pretty clear.  However, the part which I&apos;m wondering about a bit more is whether there is more mutability in RDD that could cause problems.&lt;/p&gt;

&lt;p&gt;For the case I have of this, I only know for sure that the user is calling &lt;tt&gt;rdd.cache()&lt;/tt&gt; in another thread.  But I can&apos;t see how that would leave to the symptoms I describe above.  I don&apos;t know that they are doing anything in ther user thread which would touch &lt;tt&gt;rdd.dependencies&lt;/tt&gt;, but I also don&apos;t have full visibility into everything they are doing, so this still seems like the best explanation to me.&lt;/p&gt;</comment>
                            <comment id="16921424" author="tgraves" created="Tue, 3 Sep 2019 13:27:48 +0000"  >&lt;p&gt;So for this to happen, you essentially have to have that RDD referenced in 2 separate threads and the second thread to start operating on it before it has been materialized in the first thread, correct?&lt;/p&gt;

&lt;p&gt;I see how it can change with a checkpoint, but like you say I&apos;m not sure how the cache would cause this. Anyway you can see if they are checkpointing?&#160;&lt;/p&gt;</comment>
                            <comment id="16930616" author="irashid" created="Mon, 16 Sep 2019 14:38:29 +0000"  >&lt;p&gt;I finally got some more info about this case &amp;#8211; they are not using checkpointing, nor touching dependencies.  It seems things work consistently once they move the call to &lt;tt&gt;rdd.cache()&lt;/tt&gt; before touching the RDD with multiple threads, so it could still be that caching alone is enough to mess this up somehow.&lt;/p&gt;

&lt;p&gt;Just by coincidence, another entirely separate group is reporting what looks to be a very similar bug with submitting jobs from multiple threads.  Its not exactly the same, though &amp;#8211; it doesn&apos;t have the orphaned stages in the logs, but does have repeated RDD registration.&lt;/p&gt;</comment>
                            <comment id="16947121" author="vanzin" created="Tue, 8 Oct 2019 18:43:45 +0000"  >&lt;p&gt;Issue resolved by pull request 25951&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/25951&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/25951&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 6 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z065y8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>