<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:42:10 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-13902] Make DAGScheduler not to create duplicate stage.</title>
                <link>https://issues.apache.org/jira/browse/SPARK-13902</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;&lt;tt&gt;DAGScheduler&lt;/tt&gt; sometimes generate incorrect stage graph.&lt;/p&gt;

&lt;p&gt;Suppose you have the following DAG (please see this in monospaced font):&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[A] &amp;lt;--(s_A)-- [B] &amp;lt;--(s_B)-- [C] &amp;lt;--(s_C)-- [D]
            \                /
              &amp;lt;-------------
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Note: [] means an RDD, () means a shuffle dependency.&lt;/p&gt;

&lt;p&gt;Here, RDD &lt;tt&gt;B&lt;/tt&gt; has a shuffle dependency on RDD &lt;tt&gt;A&lt;/tt&gt;, and RDD &lt;tt&gt;C&lt;/tt&gt; has shuffle dependency on both &lt;tt&gt;B&lt;/tt&gt; and &lt;tt&gt;A&lt;/tt&gt;. The shuffle dependency IDs are numbers in the &lt;tt&gt;DAGScheduler&lt;/tt&gt;, but to make the example easier to understand, let&apos;s call the shuffled data from &lt;tt&gt;A&lt;/tt&gt; shuffle dependency ID &lt;tt&gt;s_A&lt;/tt&gt; and the shuffled data from &lt;tt&gt;B&lt;/tt&gt; shuffle dependency ID &lt;tt&gt;s_B&lt;/tt&gt;.&lt;br/&gt;
The &lt;tt&gt;getAncestorShuffleDependencies&lt;/tt&gt; method in &lt;tt&gt;DAGScheduler&lt;/tt&gt; (incorrectly) does not check for duplicates when it&apos;s adding ShuffleDependencies to the parents data structure, so for this DAG, when &lt;tt&gt;getAncestorShuffleDependencies&lt;/tt&gt; gets called on &lt;tt&gt;C&lt;/tt&gt; (previous of the final RDD), &lt;tt&gt;getAncestorShuffleDependencies&lt;/tt&gt; will return &lt;tt&gt;s_A&lt;/tt&gt;, &lt;tt&gt;s_B&lt;/tt&gt;, &lt;tt&gt;s_A&lt;/tt&gt; (&lt;tt&gt;s_A&lt;/tt&gt; gets added twice: once when the method &quot;visit&quot;s RDD &lt;tt&gt;C&lt;/tt&gt;, and once when the method &quot;visit&quot;s RDD &lt;tt&gt;B&lt;/tt&gt;). This is problematic because this line of code: &lt;a href=&quot;https://github.com/apache/spark/blob/8ef3399/core/src/main/scala/org/apache/spark/scheduler/DAGScheduler.scala#L289&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/8ef3399/core/src/main/scala/org/apache/spark/scheduler/DAGScheduler.scala#L289&lt;/a&gt; then generates a new shuffle stage for each dependency returned by &lt;tt&gt;getAncestorShuffleDependencies&lt;/tt&gt;, resulting in duplicate map stages that compute the map output from RDD A.&lt;/p&gt;

&lt;p&gt;As a result, &lt;tt&gt;DAGScheduler&lt;/tt&gt; generates the following stages and their parents for each shuffle:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; stage &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; parents &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; s_A &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; ShuffleMapStage 2 &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; List() &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; s_B &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; ShuffleMapStage 1 &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; List(ShuffleMapStage 0) &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; s_C &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; ShuffleMapStage 3 &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; List(ShuffleMapStage 1, ShuffleMapStage 2) &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &amp;#45; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; ResultStage 4 &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; List(ShuffleMapStage 3) &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;The stage for &lt;tt&gt;s_A&lt;/tt&gt; should be &lt;tt&gt;ShuffleMapStage 0&lt;/tt&gt;, but the stage for &lt;tt&gt;s_A&lt;/tt&gt; is generated twice as &lt;tt&gt;ShuffleMapStage 2&lt;/tt&gt; and &lt;tt&gt;ShuffleMapStage 0&lt;/tt&gt; is overwritten by &lt;tt&gt;ShuffleMapStage 2&lt;/tt&gt;, and the stage &lt;tt&gt;ShuffleMap Stage1&lt;/tt&gt; keeps referring the &lt;em&gt;old&lt;/em&gt; stage &lt;tt&gt;ShuffleMapStage 0&lt;/tt&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12950441">SPARK-13902</key>
            <summary>Make DAGScheduler not to create duplicate stage.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ueshin">Takuya Ueshin</assignee>
                                    <reporter username="ueshin">Takuya Ueshin</reporter>
                        <labels>
                    </labels>
                <created>Tue, 15 Mar 2016 08:44:20 +0000</created>
                <updated>Sun, 17 May 2020 17:48:44 +0000</updated>
                            <resolved>Thu, 12 May 2016 19:37:59 +0000</resolved>
                                                    <fixVersion>2.0.0</fixVersion>
                                    <component>Scheduler</component>
                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15194946" author="apachespark" created="Tue, 15 Mar 2016 08:53:04 +0000"  >&lt;p&gt;User &apos;ueshin&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/11720&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/11720&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15219262" author="apachespark" created="Thu, 31 Mar 2016 03:21:03 +0000"  >&lt;p&gt;User &apos;ueshin&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/12060&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/12060&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15255798" author="apachespark" created="Mon, 25 Apr 2016 02:35:58 +0000"  >&lt;p&gt;User &apos;ueshin&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/12655&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/12655&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15256642" author="kayousterhout" created="Mon, 25 Apr 2016 17:26:17 +0000"  >&lt;p&gt;A few questions about your example:&lt;/p&gt;

&lt;p&gt;-Why is there a shuffle id for the first stage (shuffle map stage 2)? It seems like that stage doesn&apos;t have a shuffle dependency (since it doesn&apos;t have any parents, and none is shown in your diagram)&lt;br/&gt;
-It seems like the parents for ShuffleMapStage4 (which, if I understand correctly, corresponds to &lt;span class=&quot;error&quot;&gt;&amp;#91;D&amp;#93;&lt;/span&gt; in your diagram) should be shuffle map stage 1 and shuffle map stage 3? (since &lt;span class=&quot;error&quot;&gt;&amp;#91;D&amp;#93;&lt;/span&gt; depends on &lt;span class=&quot;error&quot;&gt;&amp;#91;B&amp;#93;&lt;/span&gt;, not on &lt;span class=&quot;error&quot;&gt;&amp;#91;A&amp;#93;&lt;/span&gt;)?&lt;br/&gt;
-Similarly, it seems like the parents for ShuffleMapStage5 should be shuffle map stage 3 and shuffle map stage 4?&lt;/p&gt;</comment>
                            <comment id="15256669" author="kayousterhout" created="Mon, 25 Apr 2016 17:40:58 +0000"  >&lt;p&gt;After looking at this a bit more, I think I understand the issue better.  Is this a correct description of the issue?&lt;/p&gt;

&lt;p&gt;Suppose you have the following DAG: &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;                            
[A] &amp;lt;---- [B] &amp;lt;---- [C]
            \        /
              &amp;lt;------
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Here,  RDD B has a shuffle dependency on RDD A, and RDD C has shuffle dependency on both B and A.  The shuffle dependency IDs are numbers in the DAGScheduler, but to make the example easier to understand, let&apos;s call the shuffled data from A shuffle dependency ID s_A and the shuffled data from B shuffle dependency ID s_B.&lt;/p&gt;

&lt;p&gt;The getAncestorShuffleDependencies method in DAGScheduler (incorrectly) does not check for duplicates when it&apos;s adding ShuffleDependencies to the parents data structure, so for this DAG, when getAncestorShuffleDependencies gets called on C (the final RDD), getAncestorShuffleDependencies will return s_B, s_A, s_A (s_A gets added twice: once when the method &quot;visit&quot;s RDD C, and once when the method &quot;visit&quot;s RDD B).  This is problematic because this line of code: &lt;a href=&quot;https://github.com/apache/spark/blob/master/core/src/main/scala/org/apache/spark/scheduler/DAGScheduler.scala#L289&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/master/core/src/main/scala/org/apache/spark/scheduler/DAGScheduler.scala#L289&lt;/a&gt; then generates a new shuffle stage for each dependency returned by getAncestorShuffleDependencies, resulting in duplicate map stages that compute the map output from RDD A.&lt;/p&gt;</comment>
                            <comment id="15257481" author="ueshin" created="Tue, 26 Apr 2016 03:11:31 +0000"  >&lt;p&gt;I&apos;m sorry, I made a mistake.&lt;br/&gt;
I should have written the number in the diagram, but I wrote the actual shuffle id from DAGScheduler we can get when we run the test.&lt;br/&gt;
I&apos;ll update it.&lt;/p&gt;

&lt;p&gt;So the rest of your questions are right.&lt;/p&gt;</comment>
                            <comment id="15257496" author="ueshin" created="Tue, 26 Apr 2016 03:27:14 +0000"  >&lt;p&gt;Yes, exactly.&lt;/p&gt;</comment>
                            <comment id="15257721" author="ueshin" created="Tue, 26 Apr 2016 08:15:55 +0000"  >&lt;p&gt;I found that the example above does not reproduce the issue.&lt;/p&gt;

&lt;p&gt;We need some more condition to reproduce this.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;We need at least one more stage before the RDD A for shuffle dependency to duplicate.&lt;/li&gt;
	&lt;li&gt;We need to reach the duplicating shuffle dependency earlier than its descendant like [B]&amp;#45;[C]&amp;#45;[D] or [C]&amp;#45;[D]&amp;#45;[E] in my example to collect shuffle id in wrong order.&lt;/li&gt;
	&lt;li&gt;We need at least one more stage after the RDD C as a result stage.&lt;br/&gt;
The method &lt;tt&gt;getAncestorShuffleDependencies&lt;/tt&gt; is used only while finding ancestors of &lt;tt&gt;ShuffleMapStage&lt;/tt&gt;, not while finding ancestors of &lt;tt&gt;ResultStage&lt;/tt&gt;.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;So the simpler example to reproduce the issue is as follows:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[A] &amp;lt;--(s_A)-- [B] &amp;lt;--(s_B)-- [C] &amp;lt;--(s_C)-- [D] &amp;lt;--(s_D)-- [E]
                  \                         /
                   &amp;lt;-----------------------
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Here, RDDs A to E have shuffle dependency on the each previous RDD, and RDD D also has one-to-one dependency on RDD B, i.e. RDD D have a shuffle dependency on RDD C and one-to-one dependency on RDD B.&lt;/p&gt;

&lt;p&gt;But the behavior of &lt;tt&gt;getAncestorShuffleDependencies&lt;/tt&gt; is slightly different as &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kayousterhout&quot; class=&quot;user-hover&quot; rel=&quot;kayousterhout&quot;&gt;kayousterhout&lt;/a&gt; described.&lt;/p&gt;

&lt;p&gt;It returns the shuffle ids s_B, s_A, s_C but while creating the stages for the ids, s_A is duplicated at &lt;a href=&quot;https://github.com/apache/spark/blob/master/core/src/main/scala/org/apache/spark/scheduler/DAGScheduler.scala#L289&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/master/core/src/main/scala/org/apache/spark/scheduler/DAGScheduler.scala#L289&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;At first  it creates a stage for s_B but parent stage for s_A is also created in the &lt;tt&gt;newOrUsedShuffleStage&lt;/tt&gt; method and then another stage for s_A is created again here.&lt;br/&gt;
The stage for s_B refers &lt;em&gt;old&lt;/em&gt; stage for s_A as its parent and DAGScheduler manages the &lt;em&gt;new&lt;/em&gt; stage for s_A.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12896590">SPARK-10842</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12954571">SPARK-14269</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 30 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2up3b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>