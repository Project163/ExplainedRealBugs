<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:02:49 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-26147] Python UDFs in join condition fail even when using columns from only one side of join</title>
                <link>https://issues.apache.org/jira/browse/SPARK-26147</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;The rule &lt;tt&gt;PullOutPythonUDFInJoinCondition&lt;/tt&gt; was implemented in &lt;a href=&quot;https://github.com/apache/spark/commit/2a8cbfddba2a59d144b32910c68c22d0199093fe&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/commit/2a8cbfddba2a59d144b32910c68c22d0199093fe&lt;/a&gt;&lt;br/&gt;
 As far as I understand, this rule was intended to prevent the use of Python UDFs in join condition if they take arguments from both sides of the join, and this doesn&apos;t make sense in combination with the join type.&lt;/p&gt;

&lt;p&gt;The rule &lt;tt&gt;PullOutPythonUDFInJoinCondition&lt;/tt&gt; seems to make an assumption, that if a given UDF is only using columns from a single side of the join, it will be already pushed down under the join before this rule is executed.&lt;/p&gt;

&lt;p&gt;However, this is not always the case. Here&apos;s a simple example that fails, even though it looks like it should run just fine (and it does in earlier versions of Spark):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
from pyspark.sql &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; Row
from pyspark.sql.types &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; StringType
from pyspark.sql.functions &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; udf

cars_list = [ Row(&lt;span class=&quot;code-quote&quot;&gt;&quot;NL&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;1234AB&quot;&lt;/span&gt;), Row(&lt;span class=&quot;code-quote&quot;&gt;&quot;UK&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;987654&quot;&lt;/span&gt;) ]
insurance_list = [ Row(&lt;span class=&quot;code-quote&quot;&gt;&quot;NL-1234AB&quot;&lt;/span&gt;), Row(&lt;span class=&quot;code-quote&quot;&gt;&quot;BE-112233&quot;&lt;/span&gt;) ]

spark.createDataFrame(data = cars_list, schema = [&lt;span class=&quot;code-quote&quot;&gt;&quot;country&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;plate_nr&quot;&lt;/span&gt;]).createOrReplaceTempView(&lt;span class=&quot;code-quote&quot;&gt;&quot;cars&quot;&lt;/span&gt;)
spark.createDataFrame(data = insurance_list, schema = [&lt;span class=&quot;code-quote&quot;&gt;&quot;insurance_code&quot;&lt;/span&gt;]).createOrReplaceTempView(&lt;span class=&quot;code-quote&quot;&gt;&quot;insurance&quot;&lt;/span&gt;)

to_insurance_code = udf(lambda x, y: x + &lt;span class=&quot;code-quote&quot;&gt;&quot;-&quot;&lt;/span&gt; + y, StringType())	
sqlContext.udf.register(&lt;span class=&quot;code-quote&quot;&gt;&apos;to_insurance_code&apos;&lt;/span&gt;, to_insurance_code)

spark.conf.set(&lt;span class=&quot;code-quote&quot;&gt;&quot;spark.sql.crossJoin.enabled&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;)

# This query runs just fine.
sql(&quot;&quot;&quot;
  SELECT country, plate_nr, insurance_code
  FROM cars LEFT OUTER JOIN insurance
  ON CONCAT(country, &lt;span class=&quot;code-quote&quot;&gt;&apos;-&apos;&lt;/span&gt;, plate_nr) = insurance_code
&quot;&quot;&quot;).show()

# This equivalent query fails with:
# pyspark.sql.utils.AnalysisException: u&lt;span class=&quot;code-quote&quot;&gt;&apos;Using PythonUDF in join condition of join type LeftOuter is not supported.;&apos;&lt;/span&gt;
sql(&quot;&quot;&quot;
  SELECT country, plate_nr, insurance_code
  FROM cars LEFT OUTER JOIN insurance
  ON to_insurance_code(country, plate_nr) = insurance_code
&quot;&quot;&quot;).show()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cloud_fan&quot; class=&quot;user-hover&quot; rel=&quot;cloud_fan&quot;&gt;cloud_fan&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=XuanYuan&quot; class=&quot;user-hover&quot; rel=&quot;XuanYuan&quot;&gt;XuanYuan&lt;/a&gt; fyi&lt;/p&gt;</description>
                <environment></environment>
        <key id="13200080">SPARK-26147</key>
            <summary>Python UDFs in join condition fail even when using columns from only one side of join</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cloud_fan">Wenchen Fan</assignee>
                                    <reporter username="ala.luszczak">Ala Luszczak</reporter>
                        <labels>
                    </labels>
                <created>Thu, 22 Nov 2018 13:41:11 +0000</created>
                <updated>Wed, 28 Nov 2018 12:54:49 +0000</updated>
                            <resolved>Wed, 28 Nov 2018 12:54:26 +0000</resolved>
                                    <version>2.4.0</version>
                                    <fixVersion>2.4.1</fixVersion>
                    <fixVersion>3.0.0</fixVersion>
                                    <component>PySpark</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16700274" author="apachespark" created="Tue, 27 Nov 2018 11:23:59 +0000"  >&lt;p&gt;User &apos;cloud-fan&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/23153&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23153&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16701837" author="cloud_fan" created="Wed, 28 Nov 2018 12:54:27 +0000"  >&lt;p&gt;Issue resolved by pull request 23153&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/23153&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23153&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 50 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|s00s1s:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>