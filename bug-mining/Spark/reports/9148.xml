<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:34:00 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-44448] Wrong results for dense_rank() &lt;= k from InferWindowGroupLimit and DenseRankLimitIterator</title>
                <link>https://issues.apache.org/jira/browse/SPARK-44448</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Top-k filters on a dense_rank() window function return wrong results, due to a bug in optimization InferWindowGroupLimit, specifically in the code for DenseRankLimitIterator, introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-37099&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SPARK-37099&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Repro:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
create or replace temp view t1 (p, o) as values (1, 1), (1, 1), (1, 2), (2, 1), (2, 1), (2, 2);

select * from (select *, dense_rank() over (partition by p order by o) as rnk from t1) where rnk = 1;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Spark result:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[1,1,1]
[1,1,1]
[2,1,1]&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Correct result:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[1,1,1]
[1,1,1]
[2,1,1]
[2,1,1]&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The bug is in &lt;tt&gt;DenseRankLimitIterator&lt;/tt&gt;, it fails to reset state properly when transitioning from one window partition to the next. &lt;tt&gt;reset&lt;/tt&gt; only resets &lt;tt&gt;rank = 0&lt;/tt&gt;, what it is missing is to reset &lt;tt&gt;currentRankRow = null&lt;/tt&gt;. This means that when processing the second and later window partitions, the rank incorrectly gets incremented based on comparing the ordering of the last row of the previous partition to the first row of the new partition.&lt;/p&gt;

&lt;p&gt;This means that a dense_rank window func that has more than one window partition and more than one row with dense_rank = 1 in the second or later partitions can give wrong results when optimized.&lt;/p&gt;

&lt;p&gt;(&lt;tt&gt;RankLimitIterator&lt;/tt&gt; narrowly avoids this bug by happenstance, the first row in the new partition will try to increment rank, but increment it by the value of count which is 0, so it happens to work by accident).&lt;/p&gt;

&lt;p&gt;Unfortunately, tests for the optimization only had a single row per rank, so did not catch the bug as the bug requires multiple rows per rank.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13543701">SPARK-44448</key>
            <summary>Wrong results for dense_rank() &lt;= k from InferWindowGroupLimit and DenseRankLimitIterator</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jchen5">Jack Chen</assignee>
                                    <reporter username="jchen5">Jack Chen</reporter>
                        <labels>
                            <label>correctness</label>
                    </labels>
                <created>Sun, 16 Jul 2023 22:46:12 +0000</created>
                <updated>Fri, 24 Nov 2023 22:54:18 +0000</updated>
                            <resolved>Wed, 19 Jul 2023 01:13:40 +0000</resolved>
                                    <version>3.5.0</version>
                                    <fixVersion>3.5.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17743592" author="q79969786" created="Mon, 17 Jul 2023 01:13:07 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=beliefer&quot; class=&quot;user-hover&quot; rel=&quot;beliefer&quot;&gt;beliefer&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17743594" author="JIRAUSER299035" created="Mon, 17 Jul 2023 01:21:23 +0000"  >&lt;p&gt;Fix PR: &lt;a href=&quot;https://github.com/apache/spark/pull/42026&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/42026&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17744045" author="snoot" created="Tue, 18 Jul 2023 03:22:05 +0000"  >&lt;p&gt;User &apos;jchen5&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/42026&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/42026&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17744046" author="snoot" created="Tue, 18 Jul 2023 03:23:45 +0000"  >&lt;p&gt;User &apos;jchen5&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/42026&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/42026&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17744052" author="snoot" created="Tue, 18 Jul 2023 03:30:08 +0000"  >&lt;p&gt;User &apos;jchen5&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/42042&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/42042&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17744053" author="snoot" created="Tue, 18 Jul 2023 03:31:05 +0000"  >&lt;p&gt;User &apos;jchen5&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/42042&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/42042&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17744397" author="cloud_fan" created="Wed, 19 Jul 2023 01:13:40 +0000"  >&lt;p&gt;Issue resolved by pull request 42026&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/42026&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/42026&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 16 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1j69k:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12352848">3.5.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>