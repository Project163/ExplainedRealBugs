<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:55:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-21998] SortMergeJoinExec did not calculate its outputOrdering correctly during physical planning</title>
                <link>https://issues.apache.org/jira/browse/SPARK-21998</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Right now the calculation of SortMergeJoinExec&apos;s outputOrdering relies on the fact that its children have already been sorted on the join keys, while this is often not true until EnsureRequirements has been applied.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  /**
   * For SMJ, child&apos;s output must have been sorted on key or expressions with the same order as
   * key, so we can get ordering &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; key from child&apos;s output ordering.
   */
  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; def getKeyOrdering(keys: Seq[Expression], childOutputOrdering: Seq[SortOrder])
    : Seq[SortOrder] = {
    keys.zip(childOutputOrdering).map { &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; (key, childOrder) =&amp;gt;
      SortOrder(key, Ascending, childOrder.sameOrderExpressions + childOrder.child - key)
    }
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Thus SortMergeJoinExec&apos;s outputOrdering is most likely not correct during the physical planning stage, and as a result, potential physical optimizations that rely on the required/output orderings, like &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-18591&quot; title=&quot;Replace hash-based aggregates with sort-based ones if inputs already sorted&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-18591&quot;&gt;&lt;del&gt;SPARK-18591&lt;/del&gt;&lt;/a&gt;, will not work for SortMergeJoinExec.&lt;br/&gt;
The right behavior of &lt;tt&gt;getKeyOrdering(keys, childOutputOrdering)&lt;/tt&gt; should be:&lt;br/&gt;
1. If the childOutputOrdering satisfies (is a superset of) the required child ordering =&amp;gt; childOutputOrdering&lt;br/&gt;
2. Otherwise =&amp;gt; required child ordering&lt;/p&gt;</description>
                <environment></environment>
        <key id="13102039">SPARK-21998</key>
            <summary>SortMergeJoinExec did not calculate its outputOrdering correctly during physical planning</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="maryannxue">Wei Xue</assignee>
                                    <reporter username="maryannxue">Wei Xue</reporter>
                        <labels>
                    </labels>
                <created>Wed, 13 Sep 2017 19:17:06 +0000</created>
                <updated>Fri, 22 Sep 2017 06:58:29 +0000</updated>
                            <resolved>Fri, 22 Sep 2017 06:58:29 +0000</resolved>
                                    <version>2.2.0</version>
                                    <fixVersion>2.3.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16165403" author="maropu" created="Wed, 13 Sep 2017 22:35:23 +0000"  >&lt;p&gt;I think the orders depend on their children, e.g. &lt;a href=&quot;https://github.com/apache/spark/commit/e9c91badce64731ffd3e53cbcd9f044a7593e6b8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/commit/e9c91badce64731ffd3e53cbcd9f044a7593e6b8&lt;/a&gt;. If you have other cases the Spark planner adds unnecessary sorts, could you put an concrete example? Thanks! &lt;/p&gt;</comment>
                            <comment id="16165765" author="maryannxue" created="Thu, 14 Sep 2017 05:20:50 +0000"  >&lt;p&gt;Thank you for pointing this out, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maropu&quot; class=&quot;user-hover&quot; rel=&quot;maropu&quot;&gt;maropu&lt;/a&gt;! Yes, you are right.&lt;br/&gt;
It would be more accurate to say that the outputOrdering of SortMergeJoinExec should be a superset of (i.e., satisfy) the join key ordering.&lt;br/&gt;
Let&apos;s look at &lt;tt&gt;SELECT * FROM t1 JOIN t2 ON t1.a = t2.z&lt;/tt&gt; for example and focus on &lt;tt&gt;t1&lt;/tt&gt; for simplicity,&lt;br/&gt;
1) If t1 is not sorted on a, the SMJ outputOrdering should be (a, ASC)&lt;br/&gt;
2) If t1 is sorted on a, the SMJ outputOrdering should be (a, ASC)&lt;br/&gt;
3) If t1 is sorted both on a and b, the SMJ outputOrdering should at least include (a, ASC), and whether the SMJ output is still sorted on b remains implementation specific, and in current Spark SQL implementation it surely is. But we can imagine a less smart SMJ implementation which cannot avoid extra sorting on t1 and meanwhile uses an unstable sorting can destroy the sortedness of column b.&lt;/p&gt;

&lt;p&gt;Anyway, my point is the current SMJ implementation will return NOTHING as outputOrdering when the child ordering is not immediately available and can only return the right value at a later stage after EnsureRequirements happens. You can try my query example in &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-18591?focusedCommentId=16165148&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-16165148&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SPARK-18591?focusedCommentId=16165148&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-16165148&lt;/a&gt; with your proposed change for &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-18591&quot; title=&quot;Replace hash-based aggregates with sort-based ones if inputs already sorted&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-18591&quot;&gt;&lt;del&gt;SPARK-18591&lt;/del&gt;&lt;/a&gt; and see what&apos;s going on.&lt;/p&gt;</comment>
                            <comment id="16172166" author="apachespark" created="Tue, 19 Sep 2017 18:54:04 +0000"  >&lt;p&gt;User &apos;maryannxue&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/19281&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/19281&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16172169" author="maryannxue" created="Tue, 19 Sep 2017 18:55:22 +0000"  >&lt;p&gt;Thanks again for your comment, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maropu&quot; class=&quot;user-hover&quot; rel=&quot;maropu&quot;&gt;maropu&lt;/a&gt;! I changed the title and description of this JIRA accordingly and created a PR as &lt;a href=&quot;https://github.com/apache/spark/pull/19281&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/19281&lt;/a&gt;. Could you please take a look?&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 9 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3k17b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>