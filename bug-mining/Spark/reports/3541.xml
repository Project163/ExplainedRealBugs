<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:43:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-15415] Marking partitions for broadcast broken</title>
                <link>https://issues.apache.org/jira/browse/SPARK-15415</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;I couldn&apos;t get the broadcast(DataFrame) sql function to work in Spark 2.0.&lt;/p&gt;

&lt;p&gt;It does work in Spark 1.6.1:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;$ pyspark --conf spark.sql.autoBroadcastJoinThreshold=0
&amp;gt;&amp;gt;&amp;gt; df = sqlCtx.range(1000);df2 = sqlCtx.range(1000);df.join(pyspark.sql.functions.broadcast(df2), &lt;span class=&quot;code-quote&quot;&gt;&apos;id&apos;&lt;/span&gt;).explain()
== Physical Plan ==
Project [id#0L]
+- BroadcastHashJoin [id#0L], [id#1L], BuildRight
   :- ConvertToUnsafe
   :  +- Scan ExistingRDD[id#0L]
   +- ConvertToUnsafe
      +- Scan ExistingRDD[id#1L]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;While in Spark 2.0 this results in:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&amp;gt;&amp;gt;&amp;gt; df = sqlCtx.range(1000);df2 = sqlCtx.range(1000);df.join(pyspark.sql.functions.broadcast(df2), &lt;span class=&quot;code-quote&quot;&gt;&apos;id&apos;&lt;/span&gt;).explain()
== Physical Plan ==
WholeStageCodegen
:  +- Project [id#6L]
:     +- SortMergeJoin [id#6L], [id#9L], Inner, None
:        :- INPUT
:        +- INPUT
:- WholeStageCodegen
:  :  +- Sort [id#6L ASC], &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, 0
:  :     +- INPUT
:  +- Exchange hashpartitioning(id#6L, 200), None
:     +- WholeStageCodegen
:        :  +- Range 0, 1, 8, 1000, [id#6L]
+- WholeStageCodegen
   :  +- Sort [id#9L ASC], &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, 0
   :     +- INPUT
   +- ReusedExchange [id#9L], Exchange hashpartitioning(id#6L, 200), None
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;While it should look like (output when you remove the spark.sql.autoBroadcastJoinThreshold conf):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;== Physical Plan ==
WholeStageCodegen
:  +- Project [id#0L]
:     +- BroadcastHashJoin [id#0L], [id#3L], Inner, BuildRight, None
:        :- Range 0, 1, 8, 1000, [id#0L]
:        +- INPUT
+- BroadcastExchange HashedRelationBroadcastMode(List(input[0, bigint]))
   +- WholeStageCodegen
      :  +- Range 0, 1, 8, 1000, [id#3L]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12971281">SPARK-15415</key>
            <summary>Marking partitions for broadcast broken</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jurriaanpruis">Jurriaan Pruis</assignee>
                                    <reporter username="jurriaanpruis">Jurriaan Pruis</reporter>
                        <labels>
                    </labels>
                <created>Thu, 19 May 2016 20:15:11 +0000</created>
                <updated>Sun, 22 May 2016 06:01:28 +0000</updated>
                            <resolved>Sun, 22 May 2016 06:01:28 +0000</resolved>
                                    <version>2.0.0</version>
                                    <fixVersion>2.0.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15292134" author="davies" created="Thu, 19 May 2016 21:06:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jurriaanpruis&quot; class=&quot;user-hover&quot; rel=&quot;jurriaanpruis&quot;&gt;jurriaanpruis&lt;/a&gt; The implementation of broadcast() had been changed in 2.0, so it will not work with spark.sql.autoBroadcastJoinThreshold=0,&lt;br/&gt;
spark.sql.autoBroadcastJoinThreshold should be at least 1 to use broadcast(), otherwise no broadcast join will be used.&lt;/p&gt;</comment>
                            <comment id="15292239" author="rxin" created="Thu, 19 May 2016 22:08:25 +0000"  >&lt;p&gt;I discussed with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davies&quot; class=&quot;user-hover&quot; rel=&quot;davies&quot;&gt;davies&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=marmbrus&quot; class=&quot;user-hover&quot; rel=&quot;marmbrus&quot;&gt;marmbrus&lt;/a&gt; offline. We now actually think this is worth fixing, not for just this case, but to make broadcast hint more deterministic. &lt;/p&gt;

&lt;p&gt;In Spark branch-2.0, the way broadcast hint works is by setting the size estimate to 1, and that&apos;s why your test case no longer works. There is another problem that if somebody sets the broadcast threshold to a low value (say 2), then the broadcast hint might not work either as long as the user adds a project that increases the size. The problem comes from overloading statistics to apply hints.&lt;/p&gt;

&lt;p&gt;So the proposed fix is to add another field to Statistics called &quot;isBroadcastable&quot;, and then broadcast hint simply sets that instead. We would need to change operators so isBroadcastable is propagated throughout query plans. This can be best done by using the copy ctor on Statistics (e.g. child.statistics.copy(sizeInBytes = ...)).&lt;/p&gt;

&lt;p&gt;One thing is that we should make sure in joins we don&apos;t propagate isBroadcastable, because join could explode the size. &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jurriaanpruis&quot; class=&quot;user-hover&quot; rel=&quot;jurriaanpruis&quot;&gt;jurriaanpruis&lt;/a&gt; do you think you can work on this in the next few days so we can commit this into 2.0?&lt;/p&gt;

</comment>
                            <comment id="15292828" author="jurriaanpruis" created="Fri, 20 May 2016 06:41:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rxin&quot; class=&quot;user-hover&quot; rel=&quot;rxin&quot;&gt;rxin&lt;/a&gt; I could try to work on that. The reason I ran into this issue was that Spark was broadcasting a 8M rows table which resulted in my driver going OOM. Reducing the autoBroadcastJoinThreshold didn&apos;t help unless I would reduce it to very small values which would result in nothing being broadcasted at all (which is a bug too I guess, maybe it&apos;s is calculating the sizeInBytes incorrectly?). So I tried to fix the problem by reducing it to zero and only marking the tables I needed to be broadcasted, but that didn&apos;t work. I guess what I really needed was a &apos;do not broadcast&apos; hint. &lt;/p&gt;</comment>
                            <comment id="15295220" author="apachespark" created="Sat, 21 May 2016 19:28:03 +0000"  >&lt;p&gt;User &apos;jurriaan&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/13244&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/13244&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 26 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2y8gv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12329449">2.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>