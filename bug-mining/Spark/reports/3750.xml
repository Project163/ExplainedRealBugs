<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:45:23 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-13850] TimSort Comparison method violates its general contract</title>
                <link>https://issues.apache.org/jira/browse/SPARK-13850</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;While running a query which does a group by on a large dataset, the query fails with following stack trace. &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Job aborted due to stage failure: Task 4077 in stage 1.3 failed 4 times, most recent failure: Lost task 4077.3 in stage 1.3 (TID 88702, hadoop3030.prn2.facebook.com): java.lang.IllegalArgumentException: Comparison method violates its general contract!
	at org.apache.spark.util.collection.TimSort$SortState.mergeLo(TimSort.java:794)
	at org.apache.spark.util.collection.TimSort$SortState.mergeAt(TimSort.java:525)
	at org.apache.spark.util.collection.TimSort$SortState.mergeCollapse(TimSort.java:453)
	at org.apache.spark.util.collection.TimSort$SortState.access$200(TimSort.java:325)
	at org.apache.spark.util.collection.TimSort.sort(TimSort.java:153)
	at org.apache.spark.util.collection.Sorter.sort(Sorter.scala:37)
	at org.apache.spark.util.collection.unsafe.sort.UnsafeInMemorySorter.getSortedIterator(UnsafeInMemorySorter.java:228)
	at org.apache.spark.util.collection.unsafe.sort.UnsafeExternalSorter.spill(UnsafeExternalSorter.java:186)
	at org.apache.spark.memory.TaskMemoryManager.acquireExecutionMemory(TaskMemoryManager.java:175)
	at org.apache.spark.memory.TaskMemoryManager.allocatePage(TaskMemoryManager.java:249)
	at org.apache.spark.memory.MemoryConsumer.allocatePage(MemoryConsumer.java:112)
	at org.apache.spark.util.collection.unsafe.sort.UnsafeExternalSorter.acquireNewPageIfNecessary(UnsafeExternalSorter.java:318)
	at org.apache.spark.util.collection.unsafe.sort.UnsafeExternalSorter.insertRecord(UnsafeExternalSorter.java:333)
	at org.apache.spark.sql.execution.UnsafeExternalRowSorter.insertRow(UnsafeExternalRowSorter.java:91)
	at org.apache.spark.sql.execution.UnsafeExternalRowSorter.sort(UnsafeExternalRowSorter.java:168)
	at org.apache.spark.sql.execution.Sort$$anonfun$1.apply(Sort.scala:90)
	at org.apache.spark.sql.execution.Sort$$anonfun$1.apply(Sort.scala:64)
	at org.apache.spark.rdd.RDD$$anonfun$mapPartitionsInternal$1$$anonfun$apply$21.apply(RDD.scala:728)
	at org.apache.spark.rdd.RDD$$anonfun$mapPartitionsInternal$1$$anonfun$apply$21.apply(RDD.scala:728)
	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)
	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:306)
	at org.apache.spark.rdd.RDD.iterator(RDD.scala:270)
	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)
	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:306)
	at org.apache.spark.rdd.RDD.iterator(RDD.scala:270)
	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)
	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:306)
	at org.apache.spark.rdd.RDD.iterator(RDD.scala:270)
	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)
	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:306)
	at org.apache.spark.rdd.RDD.iterator(RDD.scala:270)
	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)
	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:306)
	at org.apache.spark.rdd.RDD.iterator(RDD.scala:270)
	at org.apache.spark.scheduler.ResultTask.runTask(ResultTask.scala:66)
	at org.apache.spark.scheduler.Task.run(Task.scala:89)
	at org.apache.spark.executor.Executor$TaskRunner.run(Executor.scala:214)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Please note that the same query used to succeed in Spark 1.5 so it seems like a regression in 1.6.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12949761">SPARK-13850</key>
            <summary>TimSort Comparison method violates its general contract</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sameerag">Sameer Agarwal</assignee>
                                    <reporter username="sitalkedia@gmail.com">Sital Kedia</reporter>
                        <labels>
                    </labels>
                <created>Mon, 14 Mar 2016 05:37:38 +0000</created>
                <updated>Sun, 17 May 2020 18:31:18 +0000</updated>
                            <resolved>Wed, 15 Jun 2016 18:57:02 +0000</resolved>
                                    <version>1.6.0</version>
                                    <fixVersion>1.6.2</fixVersion>
                    <fixVersion>2.0.0</fixVersion>
                                    <component>Shuffle</component>
                    <component>Spark Core</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="15192932" author="srowen" created="Mon, 14 Mar 2016 08:56:53 +0000"  >&lt;p&gt;Duplicate of &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-8428&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SPARK-8428&lt;/a&gt;, but you gave no detail&lt;/p&gt;</comment>
                            <comment id="15193172" author="srowen" created="Mon, 14 Mar 2016 12:20:13 +0000"  >&lt;p&gt;Better, but this still looks like &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-12055&quot; title=&quot;TimSort failing with error when writing a partitioned data set&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-12055&quot;&gt;&lt;del&gt;SPARK-12055&lt;/del&gt;&lt;/a&gt; for example&lt;/p&gt;</comment>
                            <comment id="15193861" author="sitalkedia@gmail.com" created="Mon, 14 Mar 2016 18:41:15 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srowen&quot; class=&quot;user-hover&quot; rel=&quot;srowen&quot;&gt;srowen&lt;/a&gt;, The PR related to &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-12055&quot; title=&quot;TimSort failing with error when writing a partitioned data set&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-12055&quot;&gt;&lt;del&gt;SPARK-12055&lt;/del&gt;&lt;/a&gt; was merged in 1.5 and we are seeing this issue in 1.6. So unfortunately the issue is not resolved yet. &lt;/p&gt;</comment>
                            <comment id="15218850" author="dvoskin" created="Wed, 30 Mar 2016 20:58:19 +0000"  >&lt;p&gt;We&apos;re having a query fail on an inner join of two large HIVE tables with the same stack trace. The query worked on 1.5, and works on 1.6.0 if spark.memory.useLegacyMode is true, but fails on 1.6.0 when useLegacyMode is not enabled. &lt;/p&gt;

&lt;p&gt;EDIT: 1.6.1 without useLegacyMode enabled also fails with the same exception.&lt;/p&gt;

&lt;p&gt;EDIT: A bit more info, the tables the query is failing on are 50,000,000,000 and 20,000,000 rows. The same query succeeds joining a 25,000,000,000 row table and the same 20,000,000 row second table on 1.6.0 and 1.6.1 without useLegacy mode enabled. It also fails the same way joining a 50,000,000,000 row table created by duplicating the 25,000,000,000 row table with the same second table.&lt;/p&gt;</comment>
                            <comment id="15280841" author="yhuai" created="Wed, 11 May 2016 21:12:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-12055&quot; title=&quot;TimSort failing with error when writing a partitioned data set&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-12055&quot;&gt;&lt;del&gt;SPARK-12055&lt;/del&gt;&lt;/a&gt;  duplicates &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-12030&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SPARK-12030&lt;/a&gt;, which was merged in both 1.5 branch and 1.6.0.&lt;/p&gt;</comment>
                            <comment id="15283106" author="apachespark" created="Fri, 13 May 2016 20:30:05 +0000"  >&lt;p&gt;User &apos;sitalkedia&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/13107&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/13107&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15283110" author="sitalkedia@gmail.com" created="Fri, 13 May 2016 20:32:53 +0000"  >&lt;p&gt;I have found a workaround for this issue. Please take a look at the PR. &lt;/p&gt;</comment>
                            <comment id="15285980" author="yhuai" created="Tue, 17 May 2016 03:50:22 +0000"  >&lt;p&gt;Can you explain the root cause at here?&lt;/p&gt;</comment>
                            <comment id="15286906" author="sitalkedia@gmail.com" created="Tue, 17 May 2016 16:00:40 +0000"  >&lt;p&gt;I am not 100% sure of the root cause, but I suspect this is happening when JVM is trying to allocate very large size buffer for pointer array. The issue might be because the JVM is not able to allocate large buffer in contiguous memory location on heap and since the unsafe operations assume contiguous memory location of the objects, any unsafe operation on large buffer results in memory corruption which manifests as TimSort issue.&lt;/p&gt;</comment>
                            <comment id="15302892" author="apachespark" created="Thu, 26 May 2016 20:49:09 +0000"  >&lt;p&gt;User &apos;sameeragarwal&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/13336&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/13336&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12838675">SPARK-8428</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12980914">SPARK-16070</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 25 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2ukx3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12334910">1.6.2</customfieldvalue>
    <customfieldvalue id="12329449">2.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>