<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:59:29 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-23986] CompileException when using too many avg aggregation after joining</title>
                <link>https://issues.apache.org/jira/browse/SPARK-23986</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Considering the following code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    val df1: DataFrame = sparkSession.sparkContext
      .makeRDD(Seq((0, 1, 2, 3, 4, 5, 6)))
      .toDF(&lt;span class=&quot;code-quote&quot;&gt;&quot;key&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;col1&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;col2&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;col3&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;col4&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;col5&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;col6&quot;&lt;/span&gt;)

    val df2: DataFrame = sparkSession.sparkContext
      .makeRDD(Seq((0, &lt;span class=&quot;code-quote&quot;&gt;&quot;val1&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;val2&quot;&lt;/span&gt;)))
      .toDF(&lt;span class=&quot;code-quote&quot;&gt;&quot;key&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;dummy1&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;dummy2&quot;&lt;/span&gt;)

    val agg = df1
      .join(df2, df1(&lt;span class=&quot;code-quote&quot;&gt;&quot;key&quot;&lt;/span&gt;) === df2(&lt;span class=&quot;code-quote&quot;&gt;&quot;key&quot;&lt;/span&gt;), &lt;span class=&quot;code-quote&quot;&gt;&quot;leftouter&quot;&lt;/span&gt;)
      .groupBy(df1(&lt;span class=&quot;code-quote&quot;&gt;&quot;key&quot;&lt;/span&gt;))
      .agg(
        avg(&lt;span class=&quot;code-quote&quot;&gt;&quot;col2&quot;&lt;/span&gt;).as(&lt;span class=&quot;code-quote&quot;&gt;&quot;avg2&quot;&lt;/span&gt;),
        avg(&lt;span class=&quot;code-quote&quot;&gt;&quot;col3&quot;&lt;/span&gt;).as(&lt;span class=&quot;code-quote&quot;&gt;&quot;avg3&quot;&lt;/span&gt;),
        avg(&lt;span class=&quot;code-quote&quot;&gt;&quot;col4&quot;&lt;/span&gt;).as(&lt;span class=&quot;code-quote&quot;&gt;&quot;avg4&quot;&lt;/span&gt;),
        avg(&lt;span class=&quot;code-quote&quot;&gt;&quot;col1&quot;&lt;/span&gt;).as(&lt;span class=&quot;code-quote&quot;&gt;&quot;avg1&quot;&lt;/span&gt;),
        avg(&lt;span class=&quot;code-quote&quot;&gt;&quot;col5&quot;&lt;/span&gt;).as(&lt;span class=&quot;code-quote&quot;&gt;&quot;avg5&quot;&lt;/span&gt;),
        avg(&lt;span class=&quot;code-quote&quot;&gt;&quot;col6&quot;&lt;/span&gt;).as(&lt;span class=&quot;code-quote&quot;&gt;&quot;avg6&quot;&lt;/span&gt;)
      )

    val head = agg.take(1)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This logs the following exception:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ERROR CodeGenerator: failed to compile: org.codehaus.commons.compiler.CompileException: File &lt;span class=&quot;code-quote&quot;&gt;&apos;generated.java&apos;&lt;/span&gt;, Line 467, Column 28: Redefinition of parameter &lt;span class=&quot;code-quote&quot;&gt;&quot;agg_expr_11&quot;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I am not a spark expert but after investigation, I realized that the generated &lt;tt&gt;doConsume&lt;/tt&gt; method is responsible of the exception.&lt;/p&gt;

&lt;p&gt;Indeed, &lt;tt&gt;avg&lt;/tt&gt;&#160;calls several times&#160;&lt;tt&gt;org.apache.spark.sql.execution.CodegenSupport.constructDoConsumeFunction&lt;/tt&gt;. The 1st time with the &apos;avg&apos; Expr and a second time for the base aggregation&#160;Expr (count and sum).&lt;/p&gt;

&lt;p&gt;The problem comes from the&#160;generation of parameters in CodeGenerator:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  /**
   * Returns a term name that is unique within &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; instance of a `CodegenContext`.
   */
  def freshName(name: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;): &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; = &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; {
    val fullName = &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (freshNamePrefix == &quot;&quot;) {
      name
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
      s&lt;span class=&quot;code-quote&quot;&gt;&quot;${freshNamePrefix}_$name&quot;&lt;/span&gt;
    }
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (freshNameIds.contains(fullName)) {
      val id = freshNameIds(fullName)
      freshNameIds(fullName) = id + 1
      s&lt;span class=&quot;code-quote&quot;&gt;&quot;$fullName$id&quot;&lt;/span&gt;
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
      freshNameIds += fullName -&amp;gt; 1
      fullName
    }
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The&#160;&lt;tt&gt;freshNameIds&lt;/tt&gt; already contains &lt;tt&gt;agg_expr_&lt;span class=&quot;error&quot;&gt;&amp;#91;1..6&amp;#93;&lt;/span&gt;&lt;/tt&gt;&#160;from the 1st call.&lt;br/&gt;
 The second call is made with &lt;tt&gt;agg_expr_&lt;span class=&quot;error&quot;&gt;&amp;#91;1..12&amp;#93;&lt;/span&gt;&lt;/tt&gt; and generates the following names:&lt;br/&gt;
 &lt;tt&gt;agg_expr_&lt;span class=&quot;error&quot;&gt;&amp;#91;11|21|31|41|51|61|11|12&amp;#93;&lt;/span&gt;&lt;/tt&gt;. We then have a parameter name conflicts in the generated code: &lt;tt&gt;agg_expr_11.&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;Appending the &apos;id&apos; in s&quot;$fullName$id&quot; to generate unique term name is source of conflict. Maybe simply using undersoce can solve this issue : $fullName_$id&quot;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13152532">SPARK-23986</key>
            <summary>CompileException when using too many avg aggregation after joining</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mgaido">Marco Gaido</assignee>
                                    <reporter username="RustedBones">Michel Davit</reporter>
                        <labels>
                    </labels>
                <created>Sun, 15 Apr 2018 08:42:42 +0000</created>
                <updated>Fri, 24 May 2019 21:28:38 +0000</updated>
                            <resolved>Tue, 17 Apr 2018 16:38:55 +0000</resolved>
                                    <version>2.3.0</version>
                                    <fixVersion>2.3.1</fixVersion>
                    <fixVersion>2.4.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="16438818" author="kiszk" created="Sun, 15 Apr 2018 19:33:09 +0000"  >&lt;p&gt;Thank for reporting an issue with deep dive.&lt;/p&gt;

&lt;p&gt;When I run this repro with the latest master, it works well without an exception. When I checked the generated code, I cannot find variables &lt;tt&gt;agg_expr_&lt;span class=&quot;error&quot;&gt;&amp;#91;21|31|41|51|61&amp;#93;&lt;/span&gt;&lt;/tt&gt;. I will check it with branch-2.3 tomorrow.&lt;br/&gt;
Would it be possible to attach the log file of the generated code?&lt;/p&gt;</comment>
                            <comment id="16438885" author="kiszk" created="Mon, 16 Apr 2018 00:35:04 +0000"  >&lt;p&gt;While I also checked it with branch-2.3, it works well without any exception.&lt;/p&gt;</comment>
                            <comment id="16439318" author="rustedbones" created="Mon, 16 Apr 2018 11:41:49 +0000"  >&lt;p&gt;I tested on Spark v2.3.0&lt;br/&gt;
I attached the generated code:&#160;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12919207/12919207_spark-generated.java&quot; title=&quot;spark-generated.java attached to SPARK-23986&quot;&gt;spark-generated.java&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&#160;. Here is the faulty&#160; line (467):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void agg_doConsume1(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; agg_expr_01, &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; agg_expr_11, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_exprIsNull_1, &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; agg_expr_21, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_exprIsNull_2, &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; agg_expr_31, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_exprIsNull_3, &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; agg_expr_41, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_exprIsNull_4, &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; agg_expr_51, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_exprIsNull_5, &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; agg_expr_61, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_exprIsNull_6, &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; agg_expr_7, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_exprIsNull_7, &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; agg_expr_8, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_exprIsNull_8, &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; agg_expr_9, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_exprIsNull_9, &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; agg_expr_10, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_exprIsNull_10, &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; agg_expr_11, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_exprIsNull_11, &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; agg_expr_12, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_exprIsNull_12) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; java.io.IOException
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Maybe a precision: the code does not throw, it just logs an error. I also checked the computed average values, everything seems correct.&lt;/p&gt;</comment>
                            <comment id="16439398" author="mgaido" created="Mon, 16 Apr 2018 12:57:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=RustedBones&quot; class=&quot;user-hover&quot; rel=&quot;RustedBones&quot;&gt;RustedBones&lt;/a&gt; I was able to reproduce. Yes, I do agree with you in all your analysis and also with your proposal of solution. I am submitting a patch. Thanks for reporting this.&lt;/p&gt;</comment>
                            <comment id="16439417" author="apachespark" created="Mon, 16 Apr 2018 13:11:06 +0000"  >&lt;p&gt;User &apos;mgaido91&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/21080&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/21080&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16439915" author="rustedbones" created="Mon, 16 Apr 2018 19:26:04 +0000"  >&lt;p&gt;Thx&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mgaido&quot; class=&quot;user-hover&quot; rel=&quot;mgaido&quot;&gt;mgaido&lt;/a&gt;. I didn&apos;t have time to setup the environment to submit the pull request this weekend &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16441125" author="cloud_fan" created="Tue, 17 Apr 2018 16:38:55 +0000"  >&lt;p&gt;Issue resolved by pull request 21080&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/21080&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/21080&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16609708" author="dzanozin" created="Mon, 10 Sep 2018 19:46:10 +0000"  >&lt;p&gt;Spark 2.3.1 still generates methods with duplicate parameter names. I&apos;ve just got this method (which obviously failed with the following exception: &quot;&lt;tt&gt;ERROR CodeGenerator:91 - failed to compile: org.codehaus.commons.compiler.CompileException: File &apos;generated.java&apos;, Line 686, Column 28: Redefinition of parameter &quot;agg_expr_21&quot;&lt;/tt&gt;&quot; ):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 686 */&lt;/span&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void agg_doConsume1(&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt; agg_expr_01, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_exprIsNull_01,
                            &lt;span class=&quot;code-object&quot;&gt;short&lt;/span&gt; agg_expr_11, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_exprIsNull_11,
                            &lt;span class=&quot;code-object&quot;&gt;short&lt;/span&gt; agg_expr_21, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_exprIsNull_21,
                            &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; agg_expr_31, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_exprIsNull_31,
                            &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; agg_expr_41, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_exprIsNull_41,
                            &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; agg_expr_51, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_exprIsNull_51,
                            UTF8String agg_expr_61, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_exprIsNull_61,
                            &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt; agg_expr_71, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_exprIsNull_71,
                            &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; agg_expr_81, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_exprIsNull_81,
                            &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; agg_expr_91, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_exprIsNull_91,
                            &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; agg_expr_101, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_exprIsNull_101,
                            &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; agg_expr_111, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_exprIsNull_111,
                            &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; agg_expr_121, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_exprIsNull_121,
                            &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; agg_expr_131, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_exprIsNull_131,
                            &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; agg_expr_141, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_exprIsNull_141,
                            &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; agg_expr_151, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_exprIsNull_151,
                            &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_expr_161, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_exprIsNull_161,
                            &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; agg_expr_171,
                            &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt; agg_expr_18, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_exprIsNull_18,
                            &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_expr_19, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_exprIsNull_19,
                            &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt; agg_expr_20, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_exprIsNull_20,
                            &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_expr_21, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_exprIsNull_21,
                            &lt;span class=&quot;code-object&quot;&gt;short&lt;/span&gt; agg_expr_22, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_exprIsNull_22,
                            &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; agg_expr_23, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_exprIsNull_23) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; java.io.IOException {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16610259" author="mgaido" created="Tue, 11 Sep 2018 08:19:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dzanozin&quot; class=&quot;user-hover&quot; rel=&quot;dzanozin&quot;&gt;dzanozin&lt;/a&gt; thanks for reporting this, may you please provide a reproducer for that? Thanks. Anyway, it seems that this patch is not applied according to the code you have pasted here (after the patch, we should have &lt;tt&gt;agg_doConsume_1&lt;/tt&gt; as function name).&lt;/p&gt;</comment>
                            <comment id="16610330" author="dzanozin" created="Tue, 11 Sep 2018 09:11:06 +0000"  >&lt;p&gt;Well, it&apos;s a bit hard to provide the exact code we use when this failure occurs, many aggregated attributes with several custom UDFs. The same code works fine with a different dataframe which differs from the first one by having 1 string attribute instead of 4 int ones (among other 22 attributes). Here is the DF schema which fails:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;scala&amp;gt; df.printSchema()
root
 |-- attr1: timestamp (nullable = true)
 |-- attr2: string (nullable = true)
 |-- attr3: integer (nullable = true)
 |-- attr4: integer (nullable = true)
 |-- attr5: string (nullable = true)
 |-- attr6: integer (nullable = true)
 |-- attr7: byte (nullable = true)
 |-- attr8: integer (nullable = true)
 |-- attr9: timestamp (nullable = true)
 |-- attr10: string (nullable = true)
 |-- attr11: byte (nullable = true)
 |-- attr12: short (nullable = true)
 |-- attr13: short (nullable = true)
 |-- attr14: integer (nullable = true)
 |-- attr15: integer (nullable = true)
 |-- attr16: short (nullable = true)
 |-- attr17: integer (nullable = true)
 |-- attr18: string (nullable = true)
 |-- attr19: byte (nullable = true)
 |-- attr20: byte (nullable = true)
 |-- attr21: integer (nullable = true)
 |-- attr22: date (nullable = true)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;if we replace attr12-attr15 (which represent a unique record key and are part of a group by statement) with a single string attr (a primary key of another object type) the code works fine.&lt;/p&gt;

&lt;p&gt;Information about the execution environment:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;spark-2.3.1-bin-without-hadoop
hadoop-2.8.4
Scala 2.11.8
Java HotSpot(TM) 64-Bit Server VM, Java 1.8.0_162
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16610334" author="mgaido" created="Tue, 11 Sep 2018 09:21:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dzanozin&quot; class=&quot;user-hover&quot; rel=&quot;dzanozin&quot;&gt;dzanozin&lt;/a&gt; can you then please try the reproducer above reported in the JIRA in your env? I just tried it on 2.3.1 and it works for me. At least we can be sure that this is a different issue. Without a reproducer is nearly impossible to work on this, because - as I mentioned you - you seem to miss the patch, otherwise &lt;tt&gt;agg_doConsume1&lt;/tt&gt; should have been &lt;tt&gt;agg_doConsume_1&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16610412" author="dzanozin" created="Tue, 11 Sep 2018 10:32:28 +0000"  >&lt;p&gt;Please accept my apologies. I had to spend more time on this investigation. That was a problem with one specific machine configuration where we run the tests and which had a mess with old and new spark/hadoop versions.&lt;br/&gt;
Runs fine on other machines and works as expected on the test machine after cleaning up Spark 2.3.0 debris.&lt;br/&gt;
Now generates the method signature as expected:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void agg_doConsume_1(&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt; agg_expr_0_1, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_exprIsNull_0_1,
                             &lt;span class=&quot;code-object&quot;&gt;short&lt;/span&gt; agg_expr_1_1, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_exprIsNull_1_1,
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Thank you for your time and sorry again!&lt;/p&gt;</comment>
                            <comment id="16784482" author="pedromorfeu" created="Tue, 5 Mar 2019 14:15:55 +0000"  >&lt;p&gt;&lt;del&gt;Guys,&#160;is there a workaround for the folks that can&apos;t&#160;upgrade Spark version? Thanks.&lt;/del&gt;&lt;/p&gt;

&lt;p&gt;Here&apos;s my workaround for, say, 10&#160;aggregation operations:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;dataframe1 = aggregations 1 to 5&lt;/li&gt;
	&lt;li&gt;dataframe2 = aggregations 6 to 10&lt;/li&gt;
	&lt;li&gt;dataframe1.join(dataframe2)&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="16836658" author="sdangi1" created="Thu, 9 May 2019 19:57:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pedromorfeu&quot; class=&quot;user-hover&quot; rel=&quot;pedromorfeu&quot;&gt;pedromorfeu&lt;/a&gt; I tried the workaround you mentioned above, but still encountered this issue (my code is below).&lt;/p&gt;

&lt;p&gt;Since I don&apos;t have access to Spark 2.3.1, is there another workaround I can try with Spark 2.3.0?&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
val sumColNames = List[&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;](...)  &lt;span class=&quot;code-comment&quot;&gt;// list of 25 Strings
&lt;/span&gt;val sumCols: List[Column] = sumColNames.map(name =&amp;gt; sum(col(name)))

&lt;span class=&quot;code-comment&quot;&gt;/** code that causes error */&lt;/span&gt;
val output = input
.groupBy(groupByColNames map col: _*)
.agg(sumCols.head, sumCols.tail: _*)

&lt;span class=&quot;code-comment&quot;&gt;/** workaround I tried */&lt;/span&gt;
val middleIdx = sumCols.length / 2
val sumColsFirstHalf = sumCols.slice(0, middleIdx)
val sumColsSecondHalf = sumCols.slice(middleIdx, sumCols.length)

val grouped = input.groupBy(groupByCols)
val data1 = grouped.agg(sumColsFirstHalf.head, sumColsFirstHalf.tail: _*)
val data2 = grouped.agg(sumColsSecondHalf.head, sumColsSecondHalf.tail: _*)
val output = data1.join(data2, groupByColNames)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16836950" author="pedromorfeu" created="Fri, 10 May 2019 06:52:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sdangi1&quot; class=&quot;user-hover&quot; rel=&quot;sdangi1&quot;&gt;sdangi1&lt;/a&gt;, how many operations do you have in each&#160;aggregation? If it&apos;s&#160;more than 5, I would suggest to slice it even more.&lt;/p&gt;</comment>
                            <comment id="16847906" author="sdangi1" created="Fri, 24 May 2019 21:27:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pedromorfeu&quot; class=&quot;user-hover&quot; rel=&quot;pedromorfeu&quot;&gt;pedromorfeu&lt;/a&gt; I had 25&#160;columns in my sumCols list &#8211; once I split it up into 5 groups of 5, it worked!&#160; Thank you very much for your workaround and suggestion.&lt;/p&gt;

&lt;p&gt;As a&#160;reference for anyone else who wants to try this &#8211; here is the workaround code that worked for me:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
val sumColNames = List[&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;](...)  &lt;span class=&quot;code-comment&quot;&gt;// list of 25 column names
&lt;/span&gt;val sumCols: List[Column] = sumColNames.map(name =&amp;gt; sum(col(name)))

val grouped = input.groupBy(groupByColNames map col: _*)

/** only &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; 5 agg operations at a time, collect the results into a list,
  * and then use reduce to join them all together into one dataframe
  */
val step = 5
val output = List.range(0, sumCols.length, step)
  .map(idx =&amp;gt; {
    val cols = sumCols.slice(idx, idx + step)
    grouped.agg(cols.head, cols.tail: _*)
  })
  .reduce((df1, df2) =&amp;gt; df1.join(df2, groupByColNames))&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12919207" name="spark-generated.java" size="50492" author="RustedBones" created="Mon, 16 Apr 2018 11:41:17 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 25 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3skev:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>