<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:30:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-39393] Parquet data source only supports push-down predicate filters for non-repeated primitive types</title>
                <link>https://issues.apache.org/jira/browse/SPARK-39393</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;I use an example to illustrate the problem. The reason for the problem and the problem-solving approach are stated below.&lt;/p&gt;

&lt;p&gt;Assume follow Protocol buffer schema:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
message Model {
&#160;&#160;&#160;&#160; string name = 1;
&#160;&#160;&#160;&#160; repeated string keywords = 2;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Suppose a parquet file is created from a set of records in the above format with the help of the &lt;tt&gt;parquet-protobuf&lt;/tt&gt; library.&lt;/p&gt;

&lt;p&gt;Using Spark version 3.0.2 or older, we could run the following query using &lt;tt&gt;spark-shell&lt;/tt&gt;:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
val data = spark.read.parquet(&lt;span class=&quot;code-quote&quot;&gt;&quot;/path/to/parquet&quot;&lt;/span&gt;)
data.registerTempTable(&lt;span class=&quot;code-quote&quot;&gt;&quot;models&quot;&lt;/span&gt;)
spark.sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;select * from models where array_contains(keywords, &lt;span class=&quot;code-quote&quot;&gt;&apos;X&apos;&lt;/span&gt;)&quot;&lt;/span&gt;).show(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;But after updating Spark, we get the following error:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Caused by: java.lang.IllegalArgumentException: FilterPredicates &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; not currently support repeated columns. Column keywords is repeated.
&#160; at org.apache.parquet.filter2.predicate.SchemaCompatibilityValidator.validateColumn(SchemaCompatibilityValidator.java:176)
&#160; at org.apache.parquet.filter2.predicate.SchemaCompatibilityValidator.validateColumnFilterPredicate(SchemaCompatibilityValidator.java:149)
&#160; at org.apache.parquet.filter2.predicate.SchemaCompatibilityValidator.visit(SchemaCompatibilityValidator.java:89)
&#160; at org.apache.parquet.filter2.predicate.SchemaCompatibilityValidator.visit(SchemaCompatibilityValidator.java:56)
&#160; at org.apache.parquet.filter2.predicate.Operators$NotEq.accept(Operators.java:192)
&#160; at org.apache.parquet.filter2.predicate.SchemaCompatibilityValidator.validate(SchemaCompatibilityValidator.java:61)
&#160; at org.apache.parquet.filter2.compat.RowGroupFilter.visit(RowGroupFilter.java:95)
&#160; at org.apache.parquet.filter2.compat.RowGroupFilter.visit(RowGroupFilter.java:45)
&#160; at org.apache.parquet.filter2.compat.FilterCompat$FilterPredicateCompat.accept(FilterCompat.java:149)
&#160; at org.apache.parquet.filter2.compat.RowGroupFilter.filterRowGroups(RowGroupFilter.java:72)
&#160; at org.apache.parquet.hadoop.ParquetFileReader.filterRowGroups(ParquetFileReader.java:870)
&#160; at org.apache.parquet.hadoop.ParquetFileReader.&amp;lt;init&amp;gt;(ParquetFileReader.java:789)
&#160; at org.apache.parquet.hadoop.ParquetFileReader.open(ParquetFileReader.java:657)
&#160; at org.apache.parquet.hadoop.ParquetRecordReader.initializeInternalReader(ParquetRecordReader.java:162)
&#160; at org.apache.parquet.hadoop.ParquetRecordReader.initialize(ParquetRecordReader.java:140)
&#160; at org.apache.spark.sql.execution.datasources.parquet.ParquetFileFormat.$anonfun$buildReaderWithPartitionValues$2(ParquetFileFormat.scala:373)
&#160; at org.apache.spark.sql.execution.datasources.FileScanRDD$$anon$1.org$apache$spark$sql$execution$datasources$FileScanRDD$$anon$$readCurrentFile(FileScanRDD.scala:127)
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;At first it seems the problem is the parquet library. But in fact, our problem is because of this line that has been around since 2014 (based on Git history):&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/parquet-mr/blob/master/parquet-column/src/main/java/org/apache/parquet/filter2/predicate/SchemaCompatibilityValidator.java#L194&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Parquet Schema Compatibility Validator&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;After some check, I notice that the cause of the problem is due to a change in the data filtering conditions:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
spark.sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;select * from log where array_contains(keywords, &lt;span class=&quot;code-quote&quot;&gt;&apos;X&apos;&lt;/span&gt;)&quot;&lt;/span&gt;).explain(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);

&lt;span class=&quot;code-comment&quot;&gt;// Spark 3.0.2 and older
&lt;/span&gt;== Physical Plan ==
... 
+- FileScan parquet [link#0,keywords#1]
&#160; DataFilters: [array_contains(keywords#1, Google)]
&#160; PushedFilters: []
&#160; ...

&lt;span class=&quot;code-comment&quot;&gt;// Spark 3.1.0 and newer
&lt;/span&gt;== Physical Plan == ... 
+- FileScan parquet [link#0,keywords#1]
  DataFilters: [isnotnull(keywords#1),  array_contains(keywords#1, Google)]
  PushedFilters: [IsNotNull(keywords)]
  ...&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;It&apos;s good that the filtering section has become smarter. Unfortunately, due to unfamiliarity with code base, I could not find the exact location of the change and related pull request. In general, this change is suitable for non-repeated parquet fields, but in the repeated field, it causes an error from the parquet library. (Like the example given)&lt;/p&gt;

&lt;p&gt;The only temporary solution in my opinion to solve the problem is to disable the following setting, which in general greatly reduces performance:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
SET spark.sql.parquet.filterPushdown=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt; &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I created a patch for this bug and a pull request will be sent soon.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13448637">SPARK-39393</key>
            <summary>Parquet data source only supports push-down predicate filters for non-repeated primitive types</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="borjianamin">Amin Borjian</assignee>
                                    <reporter username="borjianamin">Amin Borjian</reporter>
                        <labels>
                            <label>parquet</label>
                    </labels>
                <created>Mon, 6 Jun 2022 19:49:01 +0000</created>
                <updated>Thu, 9 Jun 2022 08:42:33 +0000</updated>
                            <resolved>Wed, 8 Jun 2022 21:12:20 +0000</resolved>
                                    <version>3.1.0</version>
                    <version>3.1.1</version>
                    <version>3.1.2</version>
                    <version>3.2.0</version>
                    <version>3.2.1</version>
                                    <fixVersion>3.1.3</fixVersion>
                    <fixVersion>3.3.0</fixVersion>
                    <fixVersion>3.2.2</fixVersion>
                    <fixVersion>3.4.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17550660" author="apachespark" created="Mon, 6 Jun 2022 21:12:28 +0000"  >&lt;p&gt;User &apos;Borjianamin98&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/36781&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/36781&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 23 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z12zpc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>