<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:26:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-35817] Queries against wide Avro tables can be slow</title>
                <link>https://issues.apache.org/jira/browse/SPARK-35817</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;A query against an Avro table can be quite slow when all are true:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;There are many columns in the Avro file&lt;/li&gt;
	&lt;li&gt;The query contains a wide projection&lt;/li&gt;
	&lt;li&gt;There are many splits in the input&lt;/li&gt;
	&lt;li&gt;Some of the splits are read serially (e.g., less executors than there are tasks)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;A write to an Avro table can be quite slow when all are true:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;There are many columns in the new rows&lt;/li&gt;
	&lt;li&gt;The operation is creating many files&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;For example, a single-threaded query against a 6000 column Avro data set with 50K rows and 20 files takes less than a minute with Spark 3.0.1 but over 7 minutes with Spark 3.2.0-SNAPSHOT.&lt;/p&gt;

&lt;p&gt;The culprit appears to be this line of code:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/blob/3fb044e043a2feab01d79b30c25b93d4fd166b12/external/avro/src/main/scala/org/apache/spark/sql/avro/AvroUtils.scala#L226&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/3fb044e043a2feab01d79b30c25b93d4fd166b12/external/avro/src/main/scala/org/apache/spark/sql/avro/AvroUtils.scala#L226&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;For each split, AvroDeserializer will call this function once for each column in the projection, resulting in a potential n^2 lookup per split.&lt;/p&gt;

&lt;p&gt;For each file, AvroSerializer will call this function once for each column, resulting in an n^2 lookup per file.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13384592">SPARK-35817</key>
            <summary>Queries against wide Avro tables can be slow</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bersprockets">Bruce Robbins</assignee>
                                    <reporter username="bersprockets">Bruce Robbins</reporter>
                        <labels>
                    </labels>
                <created>Fri, 18 Jun 2021 20:41:46 +0000</created>
                <updated>Fri, 25 Jun 2021 04:15:50 +0000</updated>
                            <resolved>Fri, 25 Jun 2021 04:15:50 +0000</resolved>
                                    <version>3.1.1</version>
                    <version>3.1.2</version>
                    <version>3.2.0</version>
                                    <fixVersion>3.2.0</fixVersion>
                    <fixVersion>3.1.3</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17365697" author="bersprockets" created="Fri, 18 Jun 2021 20:44:05 +0000"  >&lt;p&gt;The referenced line of code is meant to respect case sensitivity settings.&lt;/p&gt;

&lt;p&gt;I think I have a fix that still respects case sensitivity. I will try to make a PR in the next day or so.&lt;/p&gt;</comment>
                            <comment id="17365762" author="xkrogen" created="Fri, 18 Jun 2021 22:04:56 +0000"  >&lt;p&gt;Thanks for catching this &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bersprockets&quot; class=&quot;user-hover&quot; rel=&quot;bersprockets&quot;&gt;bersprockets&lt;/a&gt;! I will be happy to contribute as well, given I&apos;m the original author of &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-34133&quot; title=&quot;[AVRO] Respect case sensitivity when performing Catalyst-to-Avro field matching&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-34133&quot;&gt;&lt;del&gt;SPARK-34133&lt;/del&gt;&lt;/a&gt;. Let me know if there&apos;s anything I can do or provide input on. I guess we should create a map of one sides&apos; fields (with lowercased names for case-insensitivity) and do lookups, to reduce the O(N^2) complexity to O(N) (N for map creation and N constant-time lookups during resolution).&lt;/p&gt;</comment>
                            <comment id="17365764" author="bersprockets" created="Fri, 18 Jun 2021 22:32:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xkrogen&quot; class=&quot;user-hover&quot; rel=&quot;xkrogen&quot;&gt;xkrogen&lt;/a&gt;&lt;br/&gt;
Thanks!&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;I guess we should create a map of one sides&apos; fields (with lowercased names for case-insensitivity) &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;That&apos;s what I did locally to test it out: a map (keyed by lowercased names) with sequences as the values (since the lower case name could map to multiple mixed case fields).&lt;/p&gt;</comment>
                            <comment id="17365834" author="apachespark" created="Sat, 19 Jun 2021 02:07:24 +0000"  >&lt;p&gt;User &apos;bersprockets&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/32969&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/32969&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17365835" author="apachespark" created="Sat, 19 Jun 2021 02:07:42 +0000"  >&lt;p&gt;User &apos;bersprockets&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/32969&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/32969&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17369172" author="apachespark" created="Fri, 25 Jun 2021 01:48:16 +0000"  >&lt;p&gt;User &apos;bersprockets&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/33072&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/33072&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17369231" author="gengliang.wang" created="Fri, 25 Jun 2021 04:15:50 +0000"  >&lt;p&gt;Issue resolved by pull request 33072&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/33072&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/33072&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 20 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0s308:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>