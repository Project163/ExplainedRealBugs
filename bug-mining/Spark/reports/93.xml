<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:12:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-942] Do not materialize partitions when DISK_ONLY storage level is used</title>
                <link>https://issues.apache.org/jira/browse/SPARK-942</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;If an operation returns a generating iterator (i.e. one that creates return values as the &apos;next&apos; method is called), for example as the result of a &apos;flatMap&apos; call on an RDD, the CacheManager first completely unrolls the iterator into an Array buffer before passing it to the blockManager (CacheManager.scala:74). Only after the entire iterator has been put into a buffer does it check if there is enough space in memory to store the data (BlockManager.scala:608). &lt;br/&gt;
In the attached test, the code can complete the operation of &apos;saveAsTextFile&apos; of text strings if it is called directly on the result RDD of a flatMap operation, this is because it is given an iterator result, and works on the map-then-save operation as the results are generated. In the other branch, a &apos;persist&apos; is called, and the cacheManger first tries to un-roll the entire iterator before deciding to store it too disk, this will cause a Memory Error (on systems with -Xmx512m)&lt;/p&gt;

&lt;p&gt;In the cases where storing to disk is an option perhaps the CacheManager(or the BlockManager), can start to scan the iterator, calculating its size as the is pushed into a buffer as it goes (rather pushing everything into a buffer in a single operation), and if it determines that it will run out of memory, start pushing the already buffered portion of the iterator to disk, and then finish scanning the original iterator pushing that onto disk.&lt;/p&gt;


&lt;p&gt;Example Code (switch value of &apos;fail&apos; variable to toggle behavior):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;MemTest.scala&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.SparkContext
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.storage.StorageLevel

&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Expander(base:&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, count:&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;) &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; Iterator[&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;] {
  &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; i = 0;
  def next() : &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; = {
    i += 1;
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; base + i.toString;
  }
  def hasNext() : &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt; = i &amp;lt; count;
}

object MemTest {
    def expand(s:&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, i:&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;) : Iterator[&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;] = {
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Expander(s,i)
    }
    def main(args:Array[&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;]) = {
        val fail = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
        val sc = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SparkContext(&lt;span class=&quot;code-quote&quot;&gt;&quot;local&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;mem_test&quot;&lt;/span&gt;);
        val seeds = sc.parallelize( Array(
          &lt;span class=&quot;code-quote&quot;&gt;&quot;This is the first sentence that we will test:&quot;&lt;/span&gt;,
          &lt;span class=&quot;code-quote&quot;&gt;&quot;This is the second sentence that we will test:&quot;&lt;/span&gt;,
          &lt;span class=&quot;code-quote&quot;&gt;&quot;This is the third sentence that we will test:&quot;&lt;/span&gt;
        ) ); 
        val out = seeds.flatMap(expand(_,10000000));
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (fail) {
          out.map(_ + &lt;span class=&quot;code-quote&quot;&gt;&quot;...&quot;&lt;/span&gt;).persist(StorageLevel.MEMORY_AND_DISK).saveAsTextFile(&lt;span class=&quot;code-quote&quot;&gt;&quot;test.out&quot;&lt;/span&gt;)
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
          out.map(_ + &lt;span class=&quot;code-quote&quot;&gt;&quot;...&quot;&lt;/span&gt;).saveAsTextFile(&lt;span class=&quot;code-quote&quot;&gt;&quot;test.out&quot;&lt;/span&gt;)
        }
    }
} 

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12704764">SPARK-942</key>
            <summary>Do not materialize partitions when DISK_ONLY storage level is used</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kellrott">Kyle Ellrott</assignee>
                                    <reporter username="kellrott">Kyle Ellrott</reporter>
                        <labels>
                    </labels>
                <created>Sun, 20 Oct 2013 21:36:09 +0000</created>
                <updated>Mon, 17 Mar 2014 10:21:14 +0000</updated>
                            <resolved>Mon, 17 Mar 2014 10:21:14 +0000</resolved>
                                    <version>0.8.0</version>
                    <version>0.8.1</version>
                    <version>0.9.0</version>
                                    <fixVersion>1.0.0</fixVersion>
                                    <component>Block Manager</component>
                    <component>Spark Core</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="13953359" author="kellrott" created="Sat, 2 Nov 2013 15:55:02 +0000"  >&lt;p&gt;This happens with persist set to StorageLevel.DISK_ONLY as well.&lt;/p&gt;</comment>
                            <comment id="13953400" author="kellrott" created="Sat, 16 Nov 2013 22:52:07 +0000"  >&lt;p&gt;Fix submitted: &lt;a href=&quot;https://github.com/apache/incubator-spark/pull/180&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/incubator-spark/pull/180&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13953987" author="patrick" created="Thu, 6 Mar 2014 14:47:36 +0000"  >&lt;p&gt;I changed the title slightly here. This is a problem not only for generative iterators but even for normal `map` operations that happen to return large values. In all these cases we materialize the input partition even though, when writing to disk, we don&apos;t have to.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12704798">SPARK-1201</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>382994</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 37 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1tze7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>383262</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>