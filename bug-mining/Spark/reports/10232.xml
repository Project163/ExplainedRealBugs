<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:48:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-47547] observed false positive rate in bloom filter is greater than expected for large n</title>
                <link>https://issues.apache.org/jira/browse/SPARK-47547</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;When creating a bloom filter out of a large number of elements (&amp;gt;400 million or so) with an fpp (false positive rate) of 1% in Spark, the observed false positive rate appears to be much higher, as much as 20%.&lt;/p&gt;

&lt;p&gt;This is demonstrated below in this spark shell:&lt;/p&gt;


&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;      ____              __
     / __/__  ___ _____/ /__
    _\ \/ _ \/ _ `/ __/  &apos;_/
   /___/ .__/\_,_/_/ /_/\_\   version 3.5.0-amzn-0
      /_/
         
Using Scala version 2.12.17 (OpenJDK 64-Bit Server VM, Java 17.0.10)
Type in expressions to have them evaluated.
Type :help for more information.

scala&amp;gt; import java.security.MessageDigest
import java.security.MessageDigest

scala&amp;gt; import scala.util.Random
import scala.util.Random

scala&amp;gt; import org.apache.spark.util.sketch.BloomFilter
import org.apache.spark.util.sketch.BloomFilter

scala&amp;gt; 

scala&amp;gt; // Function to generate a random SHA1 hash

scala&amp;gt; def generateRandomSha1(): String = {
     |   val randomString = Random.alphanumeric.take(20).mkString
     |   val sha1 = MessageDigest.getInstance(&quot;SHA-1&quot;)
     |   sha1.update(randomString.getBytes(&quot;UTF-8&quot;))
     |   val digest = sha1.digest
     |   digest.map(&quot;%02x&quot;.format(_)).mkString
     | }
generateRandomSha1: ()String

scala&amp;gt; 

scala&amp;gt; // Generate a DataFrame with 500 million rows of random SHA1 hashes

scala&amp;gt; val df = spark.range(500000000).map(_ =&amp;gt; generateRandomSha1()).toDF(&quot;Hash&quot;)
df: org.apache.spark.sql.DataFrame = [Hash: string]

scala&amp;gt; // Create a bloom filter out of this collection of strings.

scala&amp;gt; val bloom_filter = df.stat.bloomFilter(&quot;Hash&quot;, 500000000, 0.01)
bloom_filter: org.apache.spark.util.sketch.BloomFilter = org.apache.spark.util.sketch.BloomFilterImpl@a14c0ba9

scala&amp;gt; // Generate another 10,000 random hashes

scala&amp;gt; val random_sha1s = List.fill(10000)(generateRandomSha1())
random_sha1s: List[String] = List(f3cbfd9bd836ea917ebc0dfc5330135cfde322a3, 4bff8d58799e517a1ba78236db9b52353dd39b56, 775bdd9d138a79eeae7308617f5c0d1d0e1c1697, abbd761b7768f3cbadbffc0c7947185856c4943d, 343692fe61c552f73ad6bc2d2d3072cc456da1db, faf4430055c528c9a00a46e9fae7dc25047ffaf3, 255b5d56c39bfba861647fff67704e6bc758d683, dae8e0910a368f034958ae232aa5f5285486a8ac, 3680dbd34437ca661592a7e4d39782c9c77fb4ba, f5b43f7a77c9d9ea28101a1848d8b1a1c0a65b82, 5bda825102026bc0da731dc84d56a499ccff0fe1, 158d7b3ce949422de421d5e110e3f6903af4f8e1, 2efcae5cb10273a0f5e89ae34fa3156238ab0555, 8d241012d42097f80f30e8ead227d75ab77086d2, 307495c98ae5f25026b91e60cf51d4f9f1ad7f4b, 8fc2f55563ab67d4ec87ff7b04a4a01e821814a3, b413572d14ee16c6c575ca3472adff62a8cbfa3d, 9219233b0e8afe57d7d5cb6...

scala&amp;gt; // Check how many of these random hashes return a positive result when passed into mightContain

scala&amp;gt; random_sha1s.map(c =&amp;gt; bloom_filter.mightContain(c)).count(_ == true)
res0: Int = 2153 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I believe this is the result of the bloom filter implementation using 32bit hashes. Since the maximum value that can be returned by the k hash functions is ~2.14 billion (max integer value in Java), bloom filters with m &amp;gt; ~2.14 billion have degraded performance resulting from not using any bits at indices greater than ~2.14 billion.&#160;&lt;/p&gt;

&lt;p&gt;This was a known bug in Guava that was fixed several years ago, but it looks like the fix was never ported to Spark. See &lt;a href=&quot;https://github.com/google/guava/issues/1119&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/google/guava/issues/1119&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Of course, using a different hash function strategy would break existing uses of this code, so we should tread with caution here.&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13573216">SPARK-47547</key>
            <summary>observed false positive rate in bloom filter is greater than expected for large n</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ishnagy">Ish Nagy</assignee>
                                    <reporter username="nconroy40">Nathan Conroy</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 25 Mar 2024 14:57:25 +0000</created>
                <updated>Sat, 2 Aug 2025 15:30:07 +0000</updated>
                            <resolved>Wed, 23 Jul 2025 10:15:14 +0000</resolved>
                                    <version>3.5.0</version>
                    <version>4.0.0</version>
                                    <fixVersion>4.1.0</fixVersion>
                                    <component>Spark Core</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17839660" author="JIRAUSER305200" created="Mon, 22 Apr 2024 13:28:27 +0000"  >&lt;p&gt;I&apos;ll work on this issue.&lt;/p&gt;</comment>
                            <comment id="17952695" author="JIRAUSER302340" created="Mon, 19 May 2025 17:27:35 +0000"  >&lt;p&gt;Hi all,&lt;/p&gt;

&lt;p&gt;I&apos;m working on &lt;a href=&quot;https://github.com/apache/spark/pull/50933&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR#50933&lt;/a&gt;, which should address the 32bit index truncation issue, without completely replacing the currently used MurMur3 implementation.&lt;/p&gt;</comment>
                            <comment id="18009216" author="ptoth" created="Wed, 23 Jul 2025 10:15:14 +0000"  >&lt;p&gt;Issue resolved by pull request 50933&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/50933&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/50933&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1o75k:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>