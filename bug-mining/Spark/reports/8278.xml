<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:28:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-37392] Catalyst optimizer very time-consuming and memory-intensive with some &quot;explode(array)&quot; </title>
                <link>https://issues.apache.org/jira/browse/SPARK-37392</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;The problem occurs with the simple code below:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; session.implicits._

Seq(
  (1, &lt;span class=&quot;code-quote&quot;&gt;&quot;x&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;x&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;x&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;x&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;x&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;x&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;x&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;x&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;x&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;x&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;x&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;x&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;x&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;x&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;x&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;x&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;x&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;x&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;x&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;x&quot;&lt;/span&gt;)
).toDF()
  .checkpoint() &lt;span class=&quot;code-comment&quot;&gt;// or save and reload to truncate lineage
&lt;/span&gt;  .createOrReplaceTempView(&lt;span class=&quot;code-quote&quot;&gt;&quot;sub&quot;&lt;/span&gt;)

session.sql(&quot;&quot;&quot;
  SELECT
    *
  FROM
  (
    SELECT
      EXPLODE( ARRAY( * ) ) result
    FROM
    (
      SELECT
        _1 a, _2 b, _3 c, _4 d, _5 e, _6 f, _7 g, _8 h, _9 i, _10 j, _11 k, _12 l, _13 m, _14 n, _15 o, _16 p, _17 q, _18 r, _19 s, _20 t, _21 u
      FROM
        sub
    )
  )
  WHERE
    result != &apos;&apos;
  &quot;&quot;&quot;).show() &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;It takes several minutes and a very high Java heap usage, when it should be immediate.&lt;/p&gt;

&lt;p&gt;It does not occur when replacing the unique integer value (1) with a string value (&lt;em&gt;&quot;x&quot;&lt;/em&gt;).&lt;/p&gt;

&lt;p&gt;All the time is spent in the &lt;em&gt;PruneFilters&lt;/em&gt; optimization rule.&lt;/p&gt;

&lt;p&gt;Not reproduced in Spark 2.4.1.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13412849">SPARK-37392</key>
            <summary>Catalyst optimizer very time-consuming and memory-intensive with some &quot;explode(array)&quot; </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cloud_fan">Wenchen Fan</assignee>
                                    <reporter username="martinf">Francois MARTIN</reporter>
                        <labels>
                    </labels>
                <created>Fri, 19 Nov 2021 19:58:47 +0000</created>
                <updated>Wed, 31 Aug 2022 22:52:41 +0000</updated>
                            <resolved>Wed, 8 Dec 2021 05:07:45 +0000</resolved>
                                    <version>3.1.2</version>
                    <version>3.2.0</version>
                                    <fixVersion>3.1.3</fixVersion>
                    <fixVersion>3.2.1</fixVersion>
                    <fixVersion>3.3.0</fixVersion>
                                    <component>Optimizer</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="17452656" author="joshrosen" created="Thu, 2 Dec 2021 23:35:43 +0000"  >&lt;p&gt;When I ran this in &lt;tt&gt;spark-shell&lt;/tt&gt; it triggered an OOM in &lt;tt&gt;LogicalPlan.constraints()&lt;/tt&gt;. It In the heap dump I spotted an &lt;tt&gt;ExpressionSet&lt;/tt&gt; with over 100,000 expressions.&lt;/p&gt;

&lt;p&gt;Based on the constraints that I saw I think that they were introduced by the &lt;tt&gt;InferFiltersFromGenerate&lt;/tt&gt; rule and that some sort of unexpected rule interaction is resulting in a huge blowup of derived constraints in &lt;tt&gt;PruneFilters&lt;/tt&gt;. The &lt;tt&gt;InferFiltersFromGenerate&lt;/tt&gt; rule was introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-32295&quot; title=&quot;Add not null and size &amp;gt; 0 filters before inner explode to benefit from predicate pushdown&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-32295&quot;&gt;&lt;del&gt;SPARK-32295&lt;/del&gt;&lt;/a&gt; / Spark 3.1.0, which could explain why this issue isn&apos;t reproducible in Spark 2.4.1.&lt;/p&gt;

&lt;p&gt;Looking at the constraints in the huge &lt;tt&gt;ExpressionSet&lt;/tt&gt;, it looks like the vast majority (&amp;gt; 99%) of the constraints are &lt;tt&gt;GreaterThan&lt;/tt&gt; or &lt;tt&gt;LessThan&lt;/tt&gt; constraints of the form:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;GreaterThan(Size(CreateArray(...)), Literal(0))&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;LessThan(Literal(0), Size(CreateArray(...)))&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I think the &lt;tt&gt;GreaterThan&lt;/tt&gt; comes from &lt;tt&gt;InferFiltersFromGenerate&lt;/tt&gt; and suspect that the &lt;tt&gt;LessThan&lt;/tt&gt; equivalents are introduced via expression canonicalization.&lt;/p&gt;

&lt;p&gt;We&apos;ll need to dig a bit deeper to figure out what&apos;s leading to this buildup of duplicate constraints. Perhaps it&apos;s some sort of interaction between this particular shape of constraint, the constraint propagation system, and canonicalization? I&apos;m not sure yet.&lt;/p&gt;</comment>
                            <comment id="17453034" author="cloud_fan" created="Fri, 3 Dec 2021 14:14:25 +0000"  >&lt;p&gt;Great investigation, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=joshrosen&quot; class=&quot;user-hover&quot; rel=&quot;joshrosen&quot;&gt;joshrosen&lt;/a&gt; !&lt;/p&gt;

&lt;p&gt;I think for this particular case, we should apply constant folding during constraints inferences, to avoid generating a lot of predicates that can be optimized out later. e.g. `Size(CreateArray(...))` can be optimized into a literal.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17454148" author="cloud_fan" created="Mon, 6 Dec 2021 17:49:06 +0000"  >&lt;p&gt;I&apos;ve figured out the root cause. The problem part of the query plan is:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#160; &#160;+- Project [_1#21 AS a#106, _2#22 AS b#107, _3#23 AS c#108, _4#24 AS d#109, _5#25 AS e#110, _6#26 AS f#111, _7#27 AS g#112, _8#28 AS h#113, _9#29 AS i#114, _10#30 AS j#115, _11#31 AS k#116, _12#32 AS l#117, _13#33 AS m#118, _14#34 AS n#119, _15#35 AS o#120, _16#36 AS p#121, _17#37 AS q#122, _18#38 AS r#123, _19#39 AS s#124, _20#40 AS t#125, _21#41 AS u#126]
&#160; &#160; &#160; +- Filter (size(array(&lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(_1#21 as string), _2#22, _3#23, _4#24, _5#25, _6#26, _7#27, _8#28, _9#29, _10#30, _11#31, _12#32, _13#33, _14#34, _15#35, _16#36, _17#37, _18#38, _19#39, _20#40, _21#41), &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) &amp;gt; 0)
&#160; &#160; &#160; &#160; &#160;+- LogicalRDD [_1#21, _2#22, _3#23, _4#24, _5#25, _6#26, _7#27, _8#28, _9#29, _10#30, _11#31, _12#32, _13#33, _14#34, _15#35, _16#36, _17#37, _18#38, _19#39, _20#40, _21#41] &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;When calculating the constraints of the Project, the code is&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; allConstraints = child.constraints
projectList.foreach {
  &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; a @ Alias(l: Literal, _) =&amp;gt;
    allConstraints += EqualNullSafe(a.toAttribute, l)
  &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; a @ Alias(e, _) =&amp;gt;
    &lt;span class=&quot;code-comment&quot;&gt;// For every alias in `projectList`, replace the reference in constraints by its attribute.
&lt;/span&gt;    allConstraints ++= allConstraints.map(_ transform {
      &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; expr: Expression &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; expr.semanticEquals(e) =&amp;gt;
        a.toAttribute
    })
    allConstraints += EqualNullSafe(e, a.toAttribute)
  &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; _ =&amp;gt; &lt;span class=&quot;code-comment&quot;&gt;// Don&apos;t change.
&lt;/span&gt;} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The `allConstraints` starts with a single `size(...)` predicate, and then we keep doubling it for each alias in the project list, which leads to around 2^20 predicates.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&amp;gt; It does not occur when replacing the unique integer value (1) with a string value (&lt;em&gt;&quot;x&quot;&lt;/em&gt;).&lt;/p&gt;

&lt;p&gt;This is because we don&apos;t have the `cast(_1#21 as string)`, and can optimize `size(array(...))` into a constant. The optimizer rule is too conservative, and skips optimizing `size(array(cast(_1#21 as string), ...))` because cast may fail and has side effects.&lt;/p&gt;</comment>
                            <comment id="17454191" author="apachespark" created="Mon, 6 Dec 2021 18:53:13 +0000"  >&lt;p&gt;User &apos;cloud-fan&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/34823&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/34823&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17454192" author="apachespark" created="Mon, 6 Dec 2021 18:54:01 +0000"  >&lt;p&gt;User &apos;cloud-fan&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/34823&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/34823&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17454955" author="cloud_fan" created="Wed, 8 Dec 2021 05:07:45 +0000"  >&lt;p&gt;Issue resolved by pull request 34823&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/34823&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/34823&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17484072" author="JIRAUSER284404" created="Sat, 29 Jan 2022 04:50:08 +0000"  >&lt;p&gt;Is there a plan to backport the changes to 3.1.2 and 3.2.0?&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13479191">SPARK-40262</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 41 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0wx34:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>