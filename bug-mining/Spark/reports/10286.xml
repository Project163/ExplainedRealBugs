<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:48:45 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-53342] CreateDataFrame will silently truncate data with multiple Arrow RecordBatches</title>
                <link>https://issues.apache.org/jira/browse/SPARK-53342</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;This is created from a discussion here: &lt;a href=&quot;https://github.com/apache/spark-connect-go/issues/155&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark-connect-go/issues/155&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Essentially the ArrowConverters do not properly deal with Arrow data that is serialized as multiple record batches. This in turn leads to missing data when loading from a local dataframe that has arrow data that is serialized with more than one record batch.&lt;/p&gt;

&lt;p&gt;Trivial PySpark repro:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-python&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; pyspark.sql.connect.plan &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; LocalRelation
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; pyspark.sql.types &lt;span class=&quot;code-keyword&quot;&gt;as&lt;/span&gt; t
&lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; pyspark.sql.connect.dataframe &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; DataFrame &lt;span class=&quot;code-keyword&quot;&gt;as&lt;/span&gt; CDF

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; pyarrow &lt;span class=&quot;code-keyword&quot;&gt;as&lt;/span&gt; pa
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; pyarrow.ipc &lt;span class=&quot;code-keyword&quot;&gt;as&lt;/span&gt; ipc

&lt;span class=&quot;code-comment&quot;&gt;# Create table &lt;span class=&quot;code-keyword&quot;&gt;with&lt;/span&gt; 100 integer rows &lt;span class=&quot;code-keyword&quot;&gt;and&lt;/span&gt; a single column named &lt;span class=&quot;code-quote&quot;&gt;&quot;ID&quot;&lt;/span&gt;
&lt;/span&gt;table = pa.Table.from_arrays([pa.array(&lt;span class=&quot;code-object&quot;&gt;range&lt;/span&gt;(100), &lt;span class=&quot;code-object&quot;&gt;type&lt;/span&gt;=pa.int64())], names=[&lt;span class=&quot;code-quote&quot;&gt;&quot;ID&quot;&lt;/span&gt;])

&lt;span class=&quot;code-comment&quot;&gt;# Serialize &lt;span class=&quot;code-keyword&quot;&gt;as&lt;/span&gt; Arrow IPC into a byte array &lt;span class=&quot;code-keyword&quot;&gt;with&lt;/span&gt; exactly 10 record batches
&lt;/span&gt;sink = pa.BufferOutputStream()
&lt;span class=&quot;code-keyword&quot;&gt;with&lt;/span&gt; ipc.new_stream(sink, table.schema) &lt;span class=&quot;code-keyword&quot;&gt;as&lt;/span&gt; writer:
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; b &lt;span class=&quot;code-keyword&quot;&gt;in&lt;/span&gt; table.to_batches(max_chunksize=10):
        &lt;span class=&quot;code-object&quot;&gt;print&lt;/span&gt;(&lt;span class=&quot;code-quote&quot;&gt;&quot;batch....&quot;&lt;/span&gt;)
        writer.write_batch(b)

ipc_bytes = sink.getvalue().to_pybytes()


schema = t.StructType([
    t.StructField(&lt;span class=&quot;code-quote&quot;&gt;&quot;ID&quot;&lt;/span&gt;, t.LongType(), &lt;span class=&quot;code-keyword&quot;&gt;&lt;span class=&quot;code-object&quot;&gt;True&lt;/span&gt;&lt;/span&gt;)
])

lr = LocalRelation(table, schema.json())
lr_df = CDF(lr, spark)
agg_df = lr_df.groupBy().count()

agg_df.show()

&lt;span class=&quot;code-comment&quot;&gt;# Extract the plan &lt;span class=&quot;code-keyword&quot;&gt;and&lt;/span&gt; modify the local relation
&lt;/span&gt;plan = agg_df._plan.to_proto(spark._client)
new_p = agg_df._plan.to_proto(spark._client)
new_p.root.aggregate.&lt;span class=&quot;code-object&quot;&gt;input&lt;/span&gt;.local_relation.data = ipc_bytes


&lt;span class=&quot;code-comment&quot;&gt;#&lt;span class=&quot;code-object&quot;&gt;print&lt;/span&gt;(plan)
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;#&lt;span class=&quot;code-object&quot;&gt;print&lt;/span&gt;(new_p)
&lt;/span&gt;

spark._client.to_table(plan, {})

spark._client.to_table(new_p, {})
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13626889">SPARK-53342</key>
            <summary>CreateDataFrame will silently truncate data with multiple Arrow RecordBatches</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="grundprinzip-db">Martin Grund</assignee>
                                    <reporter username="grundprinzip-db">Martin Grund</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 20 Aug 2025 19:36:34 +0000</created>
                <updated>Mon, 8 Sep 2025 19:11:43 +0000</updated>
                            <resolved>Tue, 26 Aug 2025 20:29:54 +0000</resolved>
                                    <version>3.5.0</version>
                                    <fixVersion>4.1.0</fixVersion>
                    <fixVersion>4.0.1</fixVersion>
                                    <component>Connect</component>
                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="18016375" author="dongjoon" created="Tue, 26 Aug 2025 20:29:54 +0000"  >&lt;p&gt;Issue resolved by pull request 52090&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/52090&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/52090&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="18016396" author="dongjoon" created="Tue, 26 Aug 2025 23:23:56 +0000"  >&lt;p&gt;This is backported to branch-4.0 via &lt;a href=&quot;https://github.com/apache/spark/pull/52130&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/52130&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1xcgw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>