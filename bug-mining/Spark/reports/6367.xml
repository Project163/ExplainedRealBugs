<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:04:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-27112] Spark Scheduler encounters two independent Deadlocks when trying to kill executors either due to dynamic allocation or blacklisting </title>
                <link>https://issues.apache.org/jira/browse/SPARK-27112</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Recently, a few spark users in the organization have reported that their jobs were getting stuck. On further analysis, it was found out that there exist two independent deadlocks and either of them occur under different circumstances. The screenshots for these two deadlocks are attached here.&#160;&lt;/p&gt;

&lt;p&gt;We were able to reproduce the deadlocks with the following piece of code:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.hadoop.conf.Configuration
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.hadoop.fs.{FileSystem, Path}

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.spark._
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.TaskContext

&lt;span class=&quot;code-comment&quot;&gt;// Simple example of Word Count in Scala
&lt;/span&gt;object ScalaWordCount {
def main(args: Array[&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;]) {

&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (args.length &amp;lt; 2) {
&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.err.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;Usage: ScalaWordCount &amp;lt;inputFilesURI&amp;gt; &amp;lt;outputFilesUri&amp;gt;&quot;&lt;/span&gt;)
&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.exit(1)
}

val conf = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SparkConf().setAppName(&lt;span class=&quot;code-quote&quot;&gt;&quot;Scala Word Count&quot;&lt;/span&gt;)
val sc = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SparkContext(conf)

&lt;span class=&quot;code-comment&quot;&gt;// get the input file uri
&lt;/span&gt;val inputFilesUri = args(0)

&lt;span class=&quot;code-comment&quot;&gt;// get the output file uri
&lt;/span&gt;val outputFilesUri = args(1)

&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) {
val textFile = sc.textFile(inputFilesUri)
val counts = textFile.flatMap(line =&amp;gt; line.split(&lt;span class=&quot;code-quote&quot;&gt;&quot; &quot;&lt;/span&gt;))
.map(word =&amp;gt; {&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (TaskContext.get.partitionId == 5 &amp;amp;&amp;amp; TaskContext.get.attemptNumber == 0) &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Exception(&lt;span class=&quot;code-quote&quot;&gt;&quot;Fail &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; blacklisting&quot;&lt;/span&gt;) &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; (word, 1)})
.reduceByKey(_ + _)
counts.saveAsTextFile(outputFilesUri)
val conf: Configuration = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Configuration()
val path: Path = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Path(outputFilesUri)
val hdfs: FileSystem = FileSystem.get(conf)
hdfs.delete(path, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
}

sc.stop()
}
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Additionally, to ensure that the deadlock surfaces up soon enough, I also added a small delay in the Spark code here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/spark/blob/master/core/src/main/scala/org/apache/spark/scheduler/BlacklistTracker.scala#L256&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/master/core/src/main/scala/org/apache/spark/scheduler/BlacklistTracker.scala#L256&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
executorIdToFailureList.remove(exec)
updateNextExpiryTime()
&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(2000)
killBlacklistedExecutor(exec)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Also make sure that the following configs are set when launching the above spark job:&lt;br/&gt;
&lt;b&gt;spark.blacklist.enabled=true&lt;/b&gt;&lt;br/&gt;
&lt;b&gt;spark.blacklist.killBlacklistedExecutors=true&lt;/b&gt;&lt;br/&gt;
&lt;b&gt;spark.blacklist.application.maxFailedTasksPerExecutor=1&lt;/b&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13220569">SPARK-27112</key>
            <summary>Spark Scheduler encounters two independent Deadlocks when trying to kill executors either due to dynamic allocation or blacklisting </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pgandhi">Parth Gandhi</assignee>
                                    <reporter username="pgandhi">Parth Gandhi</reporter>
                        <labels>
                    </labels>
                <created>Fri, 8 Mar 2019 23:34:52 +0000</created>
                <updated>Sat, 23 Mar 2019 17:41:07 +0000</updated>
                            <resolved>Mon, 18 Mar 2019 15:35:24 +0000</resolved>
                                    <version>2.4.0</version>
                    <version>3.0.0</version>
                                    <fixVersion>2.3.4</fixVersion>
                    <fixVersion>2.4.1</fixVersion>
                    <fixVersion>3.0.0</fixVersion>
                                    <component>Scheduler</component>
                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16795113" author="irashid" created="Mon, 18 Mar 2019 15:35:24 +0000"  >&lt;p&gt;Fixed by &lt;a href=&quot;https://github.com/apache/spark/pull/24072&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/24072&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16796539" author="irashid" created="Tue, 19 Mar 2019 21:24:20 +0000"  >&lt;p&gt;Fixed in 2.4 &amp;amp; 2.3 by &lt;a href=&quot;https://github.com/apache/spark/pull/24134&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/24134&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16796677" author="irashid" created="Wed, 20 Mar 2019 01:43:29 +0000"  >&lt;p&gt;I revised the fix version for 2.4 to 2.4.2, as I just realized rc8 was cut before this was committed.  If there is another rc, we should adjust the fix version.&lt;/p&gt;</comment>
                            <comment id="16797253" author="dhruve ashar" created="Wed, 20 Mar 2019 15:09:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=irashid&quot; class=&quot;user-hover&quot; rel=&quot;irashid&quot;&gt;irashid&lt;/a&gt; - I think this is a critical bug and since it is resolved we should include it in the rc8.&lt;/p&gt;</comment>
                            <comment id="16797321" author="irashid" created="Wed, 20 Mar 2019 16:24:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Dhruve+Ashar&quot; class=&quot;user-hover&quot; rel=&quot;Dhruve Ashar&quot;&gt;Dhruve Ashar&lt;/a&gt; &amp;#8211; rc8 is already defined, there is nothing I (or anybody else) can do to change that.  I simply updated the jira to reflect that.  However, you might request that rc8 does not become 2.4.1, and instead we roll an rc9 with this this fix.  You should respond to the VOTE thread for rc8 on the dev list with your concerns, that&apos;s the right forum for this (thanks for the reminder btw, I will mention it there as well).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12961771" name="Screen Shot 2019-02-26 at 4.10.26 PM.png" size="534285" author="pgandhi" created="Fri, 8 Mar 2019 23:36:01 +0000"/>
                            <attachment id="12961772" name="Screen Shot 2019-02-26 at 4.10.48 PM.png" size="596021" author="pgandhi" created="Fri, 8 Mar 2019 23:36:09 +0000"/>
                            <attachment id="12961773" name="Screen Shot 2019-02-26 at 4.11.11 PM.png" size="354286" author="pgandhi" created="Fri, 8 Mar 2019 23:36:14 +0000"/>
                            <attachment id="12961774" name="Screen Shot 2019-02-26 at 4.11.26 PM.png" size="577427" author="pgandhi" created="Fri, 8 Mar 2019 23:36:20 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 34 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z00io0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>