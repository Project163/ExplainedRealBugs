<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:35:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-11275] [SQL] Incorrect results when using rollup/cube </title>
                <link>https://issues.apache.org/jira/browse/SPARK-11275</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Spark SQL is unable to generate a correct result when the following query using rollup. &lt;br/&gt;
    &quot;select a, b, sum(a + b) as sumAB, GROUPING__ID from mytable group by a, b with rollup&quot;&lt;/p&gt;

&lt;p&gt;Spark SQL generates a wrong result:&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2,4,6,3&amp;#93;&lt;/span&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2,null,null,1&amp;#93;&lt;/span&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;1,null,null,1&amp;#93;&lt;/span&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;null,null,null,0&amp;#93;&lt;/span&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;1,2,3,3&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;The table mytable is super simple, containing two rows and two columns:&lt;br/&gt;
testData = Seq((1, 2), (2, 4)).toDF(&quot;a&quot;, &quot;b&quot;)&lt;/p&gt;

&lt;p&gt;After turning off codegen, the query plan is like &lt;/p&gt;

&lt;p&gt;== Parsed Logical Plan ==&lt;br/&gt;
&apos;Rollup &lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;#39;a,&amp;#39;b&amp;#93;&lt;/span&gt;, &lt;a href=&quot;#20),unresolvedalias(&amp;#39;GROUPING__ID)&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;unresolvedalias(&apos;a),unresolvedalias(&apos;b),unresolvedalias(&apos;sum((&apos;a + &apos;b)) AS sumAB#20),unresolvedalias(&apos;GROUPING__ID)&lt;/a&gt;&lt;br/&gt;
 &apos;UnresolvedRelation `mytable`, None&lt;/p&gt;

&lt;p&gt;== Analyzed Logical Plan ==&lt;br/&gt;
a: int, b: int, sumAB: bigint, GROUPING__ID: int&lt;br/&gt;
Aggregate &lt;a href=&quot;#2,b#3,grouping__id#23&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;a#2,b#3,grouping__id#23&lt;/a&gt;, &lt;a href=&quot;#2,b#3,sum(cast((a#2 + b#3) as bigint)) AS sumAB#20L,GROUPING__ID#23&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;a#2,b#3,sum(cast((a#2 + b#3) as bigint)) AS sumAB#20L,GROUPING__ID#23&lt;/a&gt;&lt;br/&gt;
 Expand &lt;span class=&quot;error&quot;&gt;&amp;#91;0,1,3&amp;#93;&lt;/span&gt;, &lt;a href=&quot;#2,b#3&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;a#2,b#3&lt;/a&gt;, grouping__id#23&lt;br/&gt;
  Subquery mytable&lt;br/&gt;
   Project &lt;a href=&quot;#0 AS a#2,_2#1 AS b#3&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;_1#0 AS a#2,_2#1 AS b#3&lt;/a&gt;&lt;br/&gt;
    LocalRelation &lt;a href=&quot;#0,_2#1&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;_1#0,_2#1&lt;/a&gt;, [&lt;span class=&quot;error&quot;&gt;&amp;#91;1,2&amp;#93;&lt;/span&gt;,&lt;span class=&quot;error&quot;&gt;&amp;#91;2,4&amp;#93;&lt;/span&gt;]&lt;/p&gt;

&lt;p&gt;== Optimized Logical Plan ==&lt;br/&gt;
Aggregate &lt;a href=&quot;#2,b#3,grouping__id#23&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;a#2,b#3,grouping__id#23&lt;/a&gt;, &lt;a href=&quot;#2,b#3,sum(cast((a#2 + b#3) as bigint)) AS sumAB#20L,GROUPING__ID#23&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;a#2,b#3,sum(cast((a#2 + b#3) as bigint)) AS sumAB#20L,GROUPING__ID#23&lt;/a&gt;&lt;br/&gt;
 Expand &lt;span class=&quot;error&quot;&gt;&amp;#91;0,1,3&amp;#93;&lt;/span&gt;, &lt;a href=&quot;#2,b#3&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;a#2,b#3&lt;/a&gt;, grouping__id#23&lt;br/&gt;
  LocalRelation &lt;a href=&quot;#2,b#3&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;a#2,b#3&lt;/a&gt;, [&lt;span class=&quot;error&quot;&gt;&amp;#91;1,2&amp;#93;&lt;/span&gt;,&lt;span class=&quot;error&quot;&gt;&amp;#91;2,4&amp;#93;&lt;/span&gt;]&lt;/p&gt;

&lt;p&gt;== Physical Plan ==&lt;br/&gt;
Aggregate false, &lt;a href=&quot;#2,b#3,grouping__id#23&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;a#2,b#3,grouping__id#23&lt;/a&gt;, &lt;a href=&quot;#2,b#3,sum(PartialSum#24L) AS sumAB#20L,grouping__id#23&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;a#2,b#3,sum(PartialSum#24L) AS sumAB#20L,grouping__id#23&lt;/a&gt;&lt;br/&gt;
 Exchange hashpartitioning(a#2,b#3,grouping__id#23,5)&lt;br/&gt;
  Aggregate true, &lt;a href=&quot;#2,b#3,grouping__id#23&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;a#2,b#3,grouping__id#23&lt;/a&gt;, &lt;a href=&quot;#2,b#3,grouping__id#23,sum(cast((a#2 + b#3) as bigint)) AS PartialSum#24L&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;a#2,b#3,grouping__id#23,sum(cast((a#2 + b#3) as bigint)) AS PartialSum#24L&lt;/a&gt;&lt;br/&gt;
   Expand &lt;a href=&quot;#2, null, 1),List(a#2, b#3, 3)&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;List(null, null, 0),List(a#2, null, 1),List(a#2, b#3, 3)&lt;/a&gt;, &lt;a href=&quot;#2,b#3,grouping__id#23&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;a#2,b#3,grouping__id#23&lt;/a&gt;&lt;br/&gt;
    LocalTableScan &lt;a href=&quot;#2,b#3&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;a#2,b#3&lt;/a&gt;, [&lt;span class=&quot;error&quot;&gt;&amp;#91;1,2&amp;#93;&lt;/span&gt;,&lt;span class=&quot;error&quot;&gt;&amp;#91;2,4&amp;#93;&lt;/span&gt;]&lt;/p&gt;

&lt;p&gt;Below are my observations:&lt;/p&gt;

&lt;p&gt;1. Generation of GROUP__ID looks OK. &lt;br/&gt;
2. The problem still exists no matter whether turning on/off CODEGEN&lt;br/&gt;
3. Rollup still works in a simple query when group-by columns have only one column. For example, &quot;select b, sum(a), GROUPING__ID from mytable group by b with rollup&quot;&lt;br/&gt;
4. The buckets in &quot;HiveDataFrameAnalytcisSuite&quot; are misleading. Unfortunately, they hide the bugs. Although the buckets passed, they just compare the results of SQL and Dataframe. This way is unable to capture the regression when both return the same wrong results.  &lt;br/&gt;
5. The same problem also exists in cube. I have not started the investigation in cube, but I believe the root causes should be the same. &lt;br/&gt;
6. It looks like all the logical plans are correct.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12907296">SPARK-11275</key>
            <summary>[SQL] Incorrect results when using rollup/cube </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="a1ray">Andrew Ray</assignee>
                                    <reporter username="smilegator">Xiao Li</reporter>
                        <labels>
                    </labels>
                <created>Fri, 23 Oct 2015 06:11:53 +0000</created>
                <updated>Thu, 19 Nov 2015 23:12:26 +0000</updated>
                            <resolved>Thu, 19 Nov 2015 23:11:56 +0000</resolved>
                                    <version>1.3.0</version>
                    <version>1.4.0</version>
                    <version>1.5.1</version>
                                    <fixVersion>1.6.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="14975366" author="smilegator" created="Mon, 26 Oct 2015 23:48:55 +0000"  >&lt;p&gt;I think the same query should work in Spark 1.3, since this feature was introduced in the following JIRA: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-2663&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SPARK-2663&lt;/a&gt; &lt;/p&gt;

&lt;p&gt;Unfortunately, Spark 1.3 always returns an empty result set. &lt;/p&gt;</comment>
                            <comment id="14981338" author="a1ray" created="Thu, 29 Oct 2015 21:37:50 +0000"  >&lt;p&gt;I think that I understand what is happening here. Any expression involving one of the group by columns in a cube/rollup gets evaluated wrong. This is missed in unit testing since the tests only check that the dataframe operations give the same result as SQL, but they are both handled by the same incorrect logic. I&apos;ll put a PR together to fix it and provide better unit tests.&lt;/p&gt;</comment>
                            <comment id="14983324" author="smilegator" created="Fri, 30 Oct 2015 21:11:33 +0000"  >&lt;p&gt;Hi, Andrew, &lt;/p&gt;

&lt;p&gt;Expression is not the root cause. The implementation of cube/rollup is incomplete. I am trying to test all the edge cases. Also working on the fix. Unfortunately, when I fix this problem, I keep finding more bugs in the code base. &lt;/p&gt;

&lt;p&gt;Thanks, &lt;/p&gt;

&lt;p&gt;Xiao &lt;/p&gt;</comment>
                            <comment id="14984539" author="smilegator" created="Sun, 1 Nov 2015 20:44:15 +0000"  >&lt;p&gt;A simple fix can resolve this issue by using subquery. Thus, trying to modify the analyzer.  &lt;/p&gt;</comment>
                            <comment id="14984814" author="smilegator" created="Mon, 2 Nov 2015 07:07:13 +0000"  >&lt;p&gt;My fix is ready. Now, trying to add the test cases. Hopefully, I can finish all of them tomorrow. &lt;/p&gt;</comment>
                            <comment id="14984863" author="hvanhovell" created="Mon, 2 Nov 2015 08:02:02 +0000"  >&lt;p&gt;This is caused by the fact that the logical Expand operator does not make a difference between expressions used for grouping and for aggregation.&lt;/p&gt;

&lt;p&gt;Looking forward to the PR.&lt;/p&gt;</comment>
                            <comment id="14984881" author="smilegator" created="Mon, 2 Nov 2015 08:41:10 +0000"  >&lt;p&gt;Agree. It becomes more complex when you need to resolve both cases at the same times. When people understand the problem, the fix looks very straightforward.  &lt;/p&gt;</comment>
                            <comment id="14985935" author="apachespark" created="Mon, 2 Nov 2015 20:13:05 +0000"  >&lt;p&gt;User &apos;gatorsmile&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/9419&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/9419&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14986764" author="apachespark" created="Tue, 3 Nov 2015 06:22:05 +0000"  >&lt;p&gt;User &apos;aray&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/9429&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/9429&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15011732" author="apachespark" created="Wed, 18 Nov 2015 19:20:04 +0000"  >&lt;p&gt;User &apos;aray&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/9815&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/9815&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15014698" author="yhuai" created="Thu, 19 Nov 2015 23:11:56 +0000"  >&lt;p&gt;Issue resolved by pull request 9815&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/9815&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/9815&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2nf0v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12333083">1.6.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>