<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:31:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-41313] AM shutdown hook fails with IllegalStateException if AM crashes on startup (recurrence of SPARK-3900)</title>
                <link>https://issues.apache.org/jira/browse/SPARK-41313</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-3900&quot; title=&quot;ApplicationMaster&amp;#39;s shutdown hook fails and IllegalStateException is thrown.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-3900&quot;&gt;&lt;del&gt;SPARK-3900&lt;/del&gt;&lt;/a&gt; fixed the &lt;tt&gt;IllegalStateException&lt;/tt&gt; in cleanupStagingDir in ApplicationMaster&apos;s shutdownhook. However, &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-21138&quot; title=&quot;Cannot delete staging dir when the clusters of &amp;quot;spark.yarn.stagingDir&amp;quot; and &amp;quot;spark.hadoop.fs.defaultFS&amp;quot; are different &quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-21138&quot;&gt;&lt;del&gt;SPARK-21138&lt;/del&gt;&lt;/a&gt; accidentally reverted/undid that change when fixing the &quot;Wrong FS&quot; bug. Now, we are seeing &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-3900&quot; title=&quot;ApplicationMaster&amp;#39;s shutdown hook fails and IllegalStateException is thrown.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-3900&quot;&gt;&lt;del&gt;SPARK-3900&lt;/del&gt;&lt;/a&gt; reported by our users at Linkedin. We need to bring back the fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-3900&quot; title=&quot;ApplicationMaster&amp;#39;s shutdown hook fails and IllegalStateException is thrown.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-3900&quot;&gt;&lt;del&gt;SPARK-3900&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The illegalStateException when creating a new filesystem object is due to the limitation in Hadoop that we can not register a shutdownhook during shutdown. So, when a spark job fails during pre-launch, as part of shutdown, cleanupStagingDir would be called. Then, if we attempt to create a new filesystem object for the first time, HDFS would try to register a hook to shutdown KeyProviderCache when creating a ClientContext for DFSClient. As a result, we hit the &lt;tt&gt;IllegalStateException&lt;/tt&gt;. We should avoid the creation of a new filesystem object in cleanupStagingDir() when it is called in a shutdown hook. This was introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-3900&quot; title=&quot;ApplicationMaster&amp;#39;s shutdown hook fails and IllegalStateException is thrown.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-3900&quot;&gt;&lt;del&gt;SPARK-3900&lt;/del&gt;&lt;/a&gt;. However, &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-21138&quot; title=&quot;Cannot delete staging dir when the clusters of &amp;quot;spark.yarn.stagingDir&amp;quot; and &amp;quot;spark.hadoop.fs.defaultFS&amp;quot; are different &quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-21138&quot;&gt;&lt;del&gt;SPARK-21138&lt;/del&gt;&lt;/a&gt; accidentally reverted/undid that change. We need to bring back that fix to Spark to avoid the &lt;tt&gt;IllegalStateException&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;&#160;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13507186">SPARK-41313</key>
            <summary>AM shutdown hook fails with IllegalStateException if AM crashes on startup (recurrence of SPARK-3900)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="xinglin">Xing Lin</assignee>
                                    <reporter username="xinglin">Xing Lin</reporter>
                        <labels>
                    </labels>
                <created>Tue, 29 Nov 2022 05:04:51 +0000</created>
                <updated>Sun, 4 Dec 2022 14:25:08 +0000</updated>
                            <resolved>Sun, 4 Dec 2022 14:25:08 +0000</resolved>
                                    <version>3.4.0</version>
                                    <fixVersion>3.4.0</fixVersion>
                                    <component>Spark Core</component>
                    <component>YARN</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17640398" author="apachespark" created="Tue, 29 Nov 2022 05:57:26 +0000"  >&lt;p&gt;User &apos;xinglin&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/38832&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/38832&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17640399" author="apachespark" created="Tue, 29 Nov 2022 05:57:36 +0000"  >&lt;p&gt;User &apos;xinglin&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/38832&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/38832&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17643016" author="srowen" created="Sun, 4 Dec 2022 14:25:08 +0000"  >&lt;p&gt;Issue resolved by pull request 38832&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/38832&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/38832&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12747329">SPARK-3900</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13080788">SPARK-21138</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 49 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1cxy8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311620" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Shepherd</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>xkrogen</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>