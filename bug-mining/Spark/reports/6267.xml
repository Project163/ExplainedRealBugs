<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:03:51 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-26711] JSON Schema inference takes 15 times longer</title>
                <link>https://issues.apache.org/jira/browse/SPARK-26711</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;I noticed that the first benchmark/case of JSONBenchmark (&quot;JSON schema inferring&quot;, &quot;No encoding&quot;) was taking an hour to run, when it used to run in 4-5 minutes.&lt;/p&gt;

&lt;p&gt;The culprit seems to be this commit: &lt;a href=&quot;https://github.com/apache/spark/commit/d72571e51d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/commit/d72571e51d&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;A quick look using a profiler, and it seems to be spending 99% of its time doing some kind of exception handling in JsonInferSchema.scala.&lt;/p&gt;

&lt;p&gt;You can reproduce&#160;in the spark-shell by recreating&#160;the data used by the benchmark&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;scala&amp;gt; :paste
val rowsNum = 100 * 1000 * 1000
spark.sparkContext.range(0, rowsNum, 1)
        .map(_ =&amp;gt; &quot;a&quot;)
        .toDF(&quot;fieldA&quot;)
        .write
        .option(&quot;encoding&quot;, &quot;UTF-8&quot;)
        .json(&quot;utf8.json&quot;)

// Entering paste mode (ctrl-D to finish)

// Exiting paste mode, now interpreting.
rowsNum: Int = 100000000
scala&amp;gt; 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Then you can run the test by hand starting spark-shell as so (emulating SqlBasedBenchmark):&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; bin/spark-shell --driver-memory 8g \
  --conf &quot;spark.sql.autoBroadcastJoinThreshold=1&quot; \
  --conf &quot;spark.sql.shuffle.partitions=1&quot; --master &quot;local[1]&quot;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;On commit d72571e51d:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;scala&amp;gt; val start = System.currentTimeMillis; spark.read.json(&quot;utf8.json&quot;);  System.currentTimeMillis-start
start: Long = 1548297682225
res0: Long = 815978 &amp;lt;== 13.6 minutes
scala&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;On the previous commit (86100df54b):&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;scala&amp;gt; val start = System.currentTimeMillis; spark.read.json(&quot;utf8.json&quot;);  System.currentTimeMillis-start
start: Long = 1548298927151
res0: Long = 50087 &amp;lt;= 50 seconds
scala&amp;gt; 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I also tried &lt;tt&gt;spark.read.option(&quot;inferTimestamp&quot;, false).json(&quot;utf8.json&quot;)&lt;/tt&gt;, but that option didn&apos;t seem to make a difference in run time. Edit: &lt;tt&gt;inferTimestamp&lt;/tt&gt; does, in fact, have an impact: It halves the run time. However, that means even with &lt;tt&gt;inferTimestamp&lt;/tt&gt;, the run time is still 7 times slower than before.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13211440">SPARK-26711</key>
            <summary>JSON Schema inference takes 15 times longer</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bersprockets">Bruce Robbins</assignee>
                                    <reporter username="bersprockets">Bruce Robbins</reporter>
                        <labels>
                    </labels>
                <created>Thu, 24 Jan 2019 03:13:29 +0000</created>
                <updated>Mon, 12 Dec 2022 18:10:49 +0000</updated>
                            <resolved>Sat, 26 Jan 2019 00:16:09 +0000</resolved>
                                    <version>3.0.0</version>
                                    <fixVersion>3.0.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16750704" author="bersprockets" created="Thu, 24 Jan 2019 04:22:10 +0000"  >&lt;p&gt;ping &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maxgekk&quot; class=&quot;user-hover&quot; rel=&quot;maxgekk&quot;&gt;maxgekk&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hyukjin.kwon&quot; class=&quot;user-hover&quot; rel=&quot;hyukjin.kwon&quot;&gt;hyukjin.kwon&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16750713" author="gurwls223" created="Thu, 24 Jan 2019 04:40:34 +0000"  >&lt;p&gt;So how was the time if &lt;tt&gt;inferTimestamp&lt;/tt&gt; was enable/disabled? It would be odd even if there&apos;s regression with &lt;tt&gt;inferTimestamp&lt;/tt&gt; disabled. It just compares one if-else.&lt;/p&gt;</comment>
                            <comment id="16750741" author="bersprockets" created="Thu, 24 Jan 2019 05:46:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hyukjin.kwon&quot; class=&quot;user-hover&quot; rel=&quot;hyukjin.kwon&quot;&gt;hyukjin.kwon&lt;/a&gt;&lt;br/&gt;
 inferTimestamp=&amp;lt;default&amp;gt;: ~13 min&lt;br/&gt;
 inferTimestamp=false: ~7 min&lt;/p&gt;

&lt;p&gt;7 minutes is a lot better than 13 minutes, but still not as good as&#160;50 seconds.&lt;/p&gt;

&lt;p&gt;A quick look in the profiler shows that in the case where&#160;inferTimestamp is &lt;em&gt;disabled&lt;/em&gt;, Spark is spending 96% of its time here:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
val bigDecimal = decimalParser(field)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;That line did change in the original commit.&lt;/p&gt;</comment>
                            <comment id="16750748" author="gurwls223" created="Thu, 24 Jan 2019 06:04:16 +0000"  >&lt;p&gt;Hm, the results say something is wrong hm. 50 sec &amp;lt;&amp;gt; 7 mins sounds serious. &lt;/p&gt;</comment>
                            <comment id="16751655" author="bersprockets" created="Thu, 24 Jan 2019 22:33:50 +0000"  >&lt;p&gt;Re: 7 minutes vs. 50 seconds:&lt;/p&gt;

&lt;p&gt;Looking at the code, it appears the difference is this:&lt;/p&gt;

&lt;p&gt;Before the timestamp inference change,&#160;options.prefersDecimal was checked before attempting to convert the String to a BigDecimal. If options.prefersDecimal is disabled, we would not bother with the conversion.&lt;/p&gt;

&lt;p&gt;After the timestamp inference change, we always attempt to convert the String to a BigDecimal regardless of the setting of options.prefersDecimal (we still use options.prefersDecimal to determine what type to return)&lt;/p&gt;

&lt;p&gt;My guess is that attempting to convert every string to a BigDecimal is very expensive.&lt;/p&gt;</comment>
                            <comment id="16752102" author="gurwls223" created="Fri, 25 Jan 2019 09:56:19 +0000"  >&lt;p&gt;Oh, right. Sounds a good lead to follow. We can just add `lazy val decimalTry` to that val in that case. Can you try and make a PR?&#160;&lt;/p&gt;</comment>
                            <comment id="16752103" author="gurwls223" created="Fri, 25 Jan 2019 09:58:03 +0000"  >&lt;p&gt;Just open a PR that replace one line after manually testing it. I don&apos;t think we should update the benchmark again since you&apos;re going to update it in&#160;&lt;a href=&quot;https://github.com/apache/spark/pull/23336&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23336&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16752304" author="bersprockets" created="Fri, 25 Jan 2019 14:31:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hyukjin.kwon&quot; class=&quot;user-hover&quot; rel=&quot;hyukjin.kwon&quot;&gt;hyukjin.kwon&lt;/a&gt; Ok, that worked. I&#160;had in my mind a&#160;more verbose fix. I will&#160;open a PR with the one line change.&lt;/p&gt;</comment>
                            <comment id="16752839" author="dongjoon" created="Sat, 26 Jan 2019 00:16:09 +0000"  >&lt;p&gt;This is resolved via &lt;a href=&quot;https://github.com/apache/spark/pull/23653&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23653&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 42 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|yi08y0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>