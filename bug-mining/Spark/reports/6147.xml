<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:02:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-26024] Dataset API: repartitionByRange(...) has inconsistent behaviour</title>
                <link>https://issues.apache.org/jira/browse/SPARK-26024</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;I recently played with the &lt;tt&gt;repartitionByRange&lt;/tt&gt; method for DataFrame introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-22614&quot; title=&quot;Expose range partitioning shuffle&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-22614&quot;&gt;&lt;del&gt;SPARK-22614&lt;/del&gt;&lt;/a&gt;. For DataFrames larger than the one tested in the code (which has only 10 elements), the code sends back random results.&lt;/p&gt;

&lt;p&gt;As a test for showing the inconsistent behaviour, I start as the unit code used to test &lt;tt&gt;repartitionByRange&lt;/tt&gt; (&lt;a href=&quot;https://github.com/apache/spark/blob/master/sql/core/src/test/scala/org/apache/spark/sql/DataFrameSuite.scala#L352&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;) but I increase the size of the initial array to 1000, repartition using 3 partitions, and count the number of element per-partitions:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// Shuffle numbers from 0 to 1000, and make a DataFrame
&lt;/span&gt;val df = Random.shuffle(0.to(1000)).toDF(&lt;span class=&quot;code-quote&quot;&gt;&quot;val&quot;&lt;/span&gt;)

&lt;span class=&quot;code-comment&quot;&gt;// Repartition it using 3 partitions
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// Sum up number of elements in each partition, and collect it.
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// And &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; it several times
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (i &amp;lt;- 0 to 9) {
&#160; &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; counts = df.repartitionByRange(3, col(&lt;span class=&quot;code-quote&quot;&gt;&quot;val&quot;&lt;/span&gt;))
&#160;&#160;&#160; .mapPartitions{part =&amp;gt; Iterator(part.size)}
    .collect()
  println(counts.toList)
}
&lt;span class=&quot;code-comment&quot;&gt;// -&amp;gt; the number of elements in each partition varies...&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I do not know whether it is expected (I will dig further in the code), but it sounds like a bug.&lt;br/&gt;
 Or I just misinterpret what &lt;tt&gt;repartitionByRange&lt;/tt&gt; is for?&lt;br/&gt;
 Any ideas?&lt;/p&gt;

&lt;p&gt;Thanks!&lt;br/&gt;
 Julien&lt;/p&gt;</description>
                <environment>&lt;p&gt;Spark version 2.3.2&lt;/p&gt;</environment>
        <key id="13197907">SPARK-26024</key>
            <summary>Dataset API: repartitionByRange(...) has inconsistent behaviour</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="JulienPeloton">Julien Peloton</assignee>
                                    <reporter username="JulienPeloton">Julien Peloton</reporter>
                        <labels>
                            <label>dataFrame</label>
                            <label>partitioning</label>
                            <label>repartition</label>
                            <label>spark-sql</label>
                    </labels>
                <created>Mon, 12 Nov 2018 21:48:19 +0000</created>
                <updated>Wed, 28 Nov 2018 17:01:00 +0000</updated>
                            <resolved>Mon, 19 Nov 2018 14:26:20 +0000</resolved>
                                    <version>2.3.0</version>
                    <version>2.3.1</version>
                    <version>2.3.2</version>
                                    <fixVersion>3.0.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16685131" author="mgaido" created="Tue, 13 Nov 2018 12:31:37 +0000"  >&lt;p&gt;I think this is the expected behavior, as Spark samples &lt;tt&gt;spark.sql.execution.rangeExchange.sampleSizePerPartition&lt;/tt&gt; items in order to determine the ranges. Hence, the output may not be consistent, since sampling can return different values. You can increase &lt;tt&gt;spark.sql.execution.rangeExchange.sampleSizePerPartition&lt;/tt&gt; if you want it to be more precise.&lt;/p&gt;</comment>
                            <comment id="16685181" author="julienpeloton" created="Tue, 13 Nov 2018 13:19:42 +0000"  >&lt;p&gt;Hi Marco and thanks for your quick reply.&lt;/p&gt;

&lt;p&gt;You are absolutely right, setting a higher &lt;tt&gt;sampleSizePerPartition&lt;/tt&gt; fixes the number of elements to be the same at all iterations.&lt;/p&gt;

&lt;p&gt;I note however the lack of documentation on this. To my opinion, adding documentation appears to me quite crucial as the default &lt;tt&gt;sampleSizePerPartition&lt;/tt&gt; is quite small (100). So in most of the real-life cases the same input to &lt;tt&gt;repartitionByRange&lt;/tt&gt; will lead to random number of elements per partition.&lt;/p&gt;</comment>
                            <comment id="16685192" author="mgaido" created="Tue, 13 Nov 2018 13:25:55 +0000"  >&lt;p&gt;I am not sure about that &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=JulienPeloton&quot; class=&quot;user-hover&quot; rel=&quot;JulienPeloton&quot;&gt;JulienPeloton&lt;/a&gt;. In general we don&apos;t expose too many specific configurations, as it would become very complex for a user to check them all. Let me cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cloud_fan&quot; class=&quot;user-hover&quot; rel=&quot;cloud_fan&quot;&gt;cloud_fan&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=smilegator&quot; class=&quot;user-hover&quot; rel=&quot;smilegator&quot;&gt;smilegator&lt;/a&gt; for their opinion on this. &lt;/p&gt;</comment>
                            <comment id="16685532" author="cloud_fan" created="Tue, 13 Nov 2018 17:48:52 +0000"  >&lt;p&gt;range partitioner is usually not very accurate due to performance reasons. You are welcome to send a patch to improve the doc. But I will not increase `sampleSizePerPartition` too much, as it may hurt performance or even OOM. Why would you need a super accurate range partitioner for your (large) data set?  &lt;/p&gt;</comment>
                            <comment id="16685638" author="julienpeloton" created="Tue, 13 Nov 2018 19:25:43 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cloud_fan&quot; class=&quot;user-hover&quot; rel=&quot;cloud_fan&quot;&gt;cloud_fan&lt;/a&gt; I would not advocate to increase the size of &lt;tt&gt;sampleSizePerPartition&lt;/tt&gt; as well, but mentioning on the doc its impact on the result makes sense to me. I will submit a patch then, thanks.&lt;/p&gt;

&lt;p&gt;&lt;cite&gt;Why would you need a super accurate range partitioner for your (large) data set&lt;/cite&gt;&lt;/p&gt;

&lt;p&gt;It&apos;s more about reproducibility than anything else. For a given input set of parameters, I want the same repartitioned output - partition size included. In addition, I&apos;m working in astronomy and I am used to the low-level RDD API (using &lt;tt&gt;partitioners&lt;/tt&gt;) which is more flexible and detailed for custom partitioning to my opinion. &lt;/p&gt;</comment>
                            <comment id="16685737" author="apachespark" created="Tue, 13 Nov 2018 21:03:12 +0000"  >&lt;p&gt;User &apos;JulienPeloton&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/23025&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23025&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16685738" author="apachespark" created="Tue, 13 Nov 2018 21:04:07 +0000"  >&lt;p&gt;User &apos;JulienPeloton&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/23025&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23025&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16691761" author="cloud_fan" created="Mon, 19 Nov 2018 14:26:20 +0000"  >&lt;p&gt;Issue resolved by pull request 23025&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/23025&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23025&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16702146" author="apachespark" created="Wed, 28 Nov 2018 17:01:00 +0000"  >&lt;p&gt;User &apos;srowen&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/23167&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23167&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 50 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|s00erk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311620" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Shepherd</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>a.ionescu</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>