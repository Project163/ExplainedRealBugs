<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:31:51 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-41192] Task finished before speculative task scheduled leads to holding idle executors</title>
                <link>https://issues.apache.org/jira/browse/SPARK-41192</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;When task finished before speculative task has been scheduled by DAGScheduler, then the speculative tasks will be considered as pending and count towards the calculation of number of needed executors, which will lead to request more executors than needed&lt;/p&gt;
&lt;h2&gt;&lt;a name=&quot;Background%26Reproduce&quot;&gt;&lt;/a&gt;Background &amp;amp; Reproduce&lt;/h2&gt;

&lt;p&gt;In one of our production job, we found that ExecutorAllocationManager was holding more executors than needed.&#160;&lt;/p&gt;

&lt;p&gt;We found it&apos;s difficult to reproduce in the test environment. In order to stably reproduce and debug, we temporarily annotated the scheduling code of speculative tasks in TaskSetManager:363 to ensure that the task be completed before the speculative task being scheduled.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// Original code
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; def dequeueTask(
&#160; &#160; execId: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;,
&#160; &#160; host: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;,
&#160; &#160; maxLocality: TaskLocality.Value): Option[(Int, TaskLocality.Value, &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;)] = {
&#160; &lt;span class=&quot;code-comment&quot;&gt;// Tries to schedule a regular task first; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; it returns None, then schedules
&lt;/span&gt;&#160; &lt;span class=&quot;code-comment&quot;&gt;// a speculative task
&lt;/span&gt;&#160; dequeueTaskHelper(execId, host, maxLocality, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;).orElse(
&#160; &#160; dequeueTaskHelper(execId, host, maxLocality, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;))
}&#160;
&lt;span class=&quot;code-comment&quot;&gt;// Speculative task will never be scheduled
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; def dequeueTask(
&#160; &#160; execId: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;,
&#160; &#160; host: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;,
&#160; &#160; maxLocality: TaskLocality.Value): Option[(Int, TaskLocality.Value, &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;)] = {
&#160; &lt;span class=&quot;code-comment&quot;&gt;// Tries to schedule a regular task first; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; it returns None, then schedules
&lt;/span&gt;&#160; &lt;span class=&quot;code-comment&quot;&gt;// a speculative task
&lt;/span&gt;&#160; dequeueTaskHelper(execId, host, maxLocality, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)
}&#160; &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Referring to examples in &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-30511&quot; title=&quot;Spark marks intentionally killed speculative tasks as pending leads to holding idle executors&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-30511&quot;&gt;&lt;del&gt;SPARK-30511&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;You will see when running the last task, we would be hold 38 executors (see attachment), which is exactly (149 + 1) / 4 = 38. But actually there are only 2 tasks in running, which requires Math.min(20, 2/4) = 20 executors indeed.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
./bin/spark-shell --master yarn --conf spark.speculation=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; --conf spark.executor.cores=4 --conf spark.dynamicAllocation.enabled=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; --conf spark.dynamicAllocation.minExecutors=20 --conf spark.dynamicAllocation.maxExecutors=1000 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
val n = 4000
val someRDD = sc.parallelize(1 to n, n)
someRDD.mapPartitionsWithIndex( (index: Int, it: Iterator[Int]) =&amp;gt; {
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (index &amp;gt; 3998) {
&#160; &#160; &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(1000 * 1000)
} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (index &amp;gt; 3850) {
&#160; &#160; &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(50 * 1000) &lt;span class=&quot;code-comment&quot;&gt;// Fake running tasks
&lt;/span&gt;} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&#160; &#160; &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(100)
}
Array.fill[Int](1)(1).iterator&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I will have a PR ready to fix this issue&lt;/p&gt;</description>
                <environment></environment>
        <key id="13503350">SPARK-41192</key>
            <summary>Task finished before speculative task scheduled leads to holding idle executors</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="toujours33">Yazhi Wang</assignee>
                                    <reporter username="toujours33">Yazhi Wang</reporter>
                        <labels>
                            <label>dynamic_allocation</label>
                    </labels>
                <created>Fri, 18 Nov 2022 04:13:04 +0000</created>
                <updated>Wed, 21 Dec 2022 03:36:56 +0000</updated>
                            <resolved>Wed, 21 Dec 2022 03:36:56 +0000</resolved>
                                    <version>3.2.2</version>
                    <version>3.3.1</version>
                                    <fixVersion>3.4.0</fixVersion>
                                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17635708" author="apachespark" created="Fri, 18 Nov 2022 07:36:51 +0000"  >&lt;p&gt;User &apos;toujours33&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/38709&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/38709&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17635762" author="apachespark" created="Fri, 18 Nov 2022 09:43:14 +0000"  >&lt;p&gt;User &apos;toujours33&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/38711&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/38711&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17635763" author="apachespark" created="Fri, 18 Nov 2022 09:43:43 +0000"  >&lt;p&gt;User &apos;toujours33&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/38711&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/38711&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17650066" author="mridulm80" created="Wed, 21 Dec 2022 03:36:56 +0000"  >&lt;p&gt;Issue resolved by pull request 38711&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/38711&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/38711&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13052356" name="dynamic-executors" size="42187" author="toujours33" created="Fri, 18 Nov 2022 05:05:52 +0000"/>
                            <attachment id="13052357" name="dynamic-log" size="50488" author="toujours33" created="Fri, 18 Nov 2022 05:05:57 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 46 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1cabk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>