<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:31:03 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-40407] Repartition of DataFrame can result in severe data skew in some special case</title>
                <link>https://issues.apache.org/jira/browse/SPARK-40407</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-scala&quot;&gt;
_val df = spark.range(0, 100, 1, 50).repartition(4)_
_val v = df.rdd.mapPartitions { iter =&amp;gt; {_
&#160; &#160; &#160; &#160; _Iterator.single(iter.length)_
{_}}{_}{_}.collect(){_}
_println(v.mkString(&lt;span class=&quot;code-quote&quot;&gt;&quot;,&quot;&lt;/span&gt;))_
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The above simple code outputs `50,0,0,50`, which means there is no data in partition 1 and partition 2.&lt;/p&gt;

&lt;p&gt;I just debugged it and found the RoundRobin seems to ensure to distribute the records evenly *&lt;b&gt;in the same partition&lt;/b&gt;*, and not guarantee it between partitions.&lt;/p&gt;

&lt;p&gt;Below is the code to generate the key&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-scala&quot;&gt;
&#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; RoundRobinPartitioning(numPartitions) =&amp;gt;
&#160; &#160; &#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// Distributes elements evenly across output partitions, starting from a random partition.
&lt;/span&gt;&#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; position = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Random(TaskContext.get().partitionId()).nextInt(numPartitions) &#160;
&#160; &#160; &#160; &#160; (row: InternalRow) =&amp;gt; {
&#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// The HashPartitioner will handle the `mod` by the number of partitions
&lt;/span&gt;&#160; &#160; &#160; &#160; &#160; position += 1
&#160; &#160; &#160; &#160; &#160; position
&#160; &#160; &#160; &#160; }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In this case, There are 50 partitions, each partition will only compute 2 elements. The issue for RoundRobin here is it always starts with &lt;b&gt;position=2&lt;/b&gt; to do the Roundrobin.&lt;/p&gt;

&lt;p&gt;See the output of Random&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-scala&quot;&gt;
scala&amp;gt; (1 to 200).foreach(partitionId =&amp;gt; print(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Random(partitionId).nextInt(4) + &lt;span class=&quot;code-quote&quot;&gt;&quot; &quot;&lt;/span&gt;)) &#160;&lt;span class=&quot;code-comment&quot;&gt;// the position is always 2.
&lt;/span&gt;2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2&#160;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Similarly, the below Random code also outputs the same value,&#160;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-scala&quot;&gt;
(1 to 200).foreach(partitionId =&amp;gt; print(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Random(partitionId).nextInt(2) + &lt;span class=&quot;code-quote&quot;&gt;&quot; &quot;&lt;/span&gt;))

(1 to 200).foreach(partitionId =&amp;gt; print(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Random(partitionId).nextInt(4) + &lt;span class=&quot;code-quote&quot;&gt;&quot; &quot;&lt;/span&gt;))

(1 to 200).foreach(partitionId =&amp;gt; print(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Random(partitionId).nextInt(8) + &lt;span class=&quot;code-quote&quot;&gt;&quot; &quot;&lt;/span&gt;))

(1 to 200).foreach(partitionId =&amp;gt; print(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Random(partitionId).nextInt(16) + &lt;span class=&quot;code-quote&quot;&gt;&quot; &quot;&lt;/span&gt;))

(1 to 200).foreach(partitionId =&amp;gt; print(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Random(partitionId).nextInt(32) + &lt;span class=&quot;code-quote&quot;&gt;&quot; &quot;&lt;/span&gt;))
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Let&apos;s go back to this case,&lt;/p&gt;

&lt;p&gt;Consider partition 0, the total elements are &lt;span class=&quot;error&quot;&gt;&amp;#91;0, 1&amp;#93;&lt;/span&gt;, so when shuffle writes, for element 0, the key will be (position + 1) = 2 + 1 = 3%4=3, the element 1, the key will be (position + 1)=(3+1)=4%4 = 0&lt;br/&gt;
consider partition 1, the total elements are &lt;span class=&quot;error&quot;&gt;&amp;#91;2, 3&amp;#93;&lt;/span&gt;, so when shuffle writes, for element 2, the key will be (position + 1) = 2 + 1 = 3%4=3, the element 3, the key will be (position + 1)=(3+1)=4%4 = 0&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The calculation is also applied for other left partitions since the starting position is always 2 for this case.&lt;/p&gt;

&lt;p&gt;So, as you can see, each partition will write its elements to Partition &lt;span class=&quot;error&quot;&gt;&amp;#91;0, 3&amp;#93;&lt;/span&gt;, which results in Partition &lt;span class=&quot;error&quot;&gt;&amp;#91;1, 2&amp;#93;&lt;/span&gt; without any data.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I will try to provide the patch to fix this issue.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13481066">SPARK-40407</key>
            <summary>Repartition of DataFrame can result in severe data skew in some special case</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="wbo4958">Bobby Wang</assignee>
                                    <reporter username="wbo4958">Bobby Wang</reporter>
                        <labels>
                    </labels>
                <created>Mon, 12 Sep 2022 08:38:25 +0000</created>
                <updated>Thu, 6 Oct 2022 16:57:05 +0000</updated>
                            <resolved>Thu, 22 Sep 2022 13:00:34 +0000</resolved>
                                    <version>3.0.1</version>
                    <version>3.1.1</version>
                    <version>3.1.2</version>
                    <version>3.1.3</version>
                    <version>3.2.1</version>
                    <version>3.3.0</version>
                    <version>3.2.2</version>
                                    <fixVersion>3.3.1</fixVersion>
                    <fixVersion>3.2.3</fixVersion>
                    <fixVersion>3.4.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17603002" author="apachespark" created="Mon, 12 Sep 2022 08:58:54 +0000"  >&lt;p&gt;User &apos;wbo4958&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/37855&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/37855&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17608271" author="cloud_fan" created="Thu, 22 Sep 2022 13:00:34 +0000"  >&lt;p&gt;Issue resolved by pull request 37855&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/37855&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/37855&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 7 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z18ha0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>