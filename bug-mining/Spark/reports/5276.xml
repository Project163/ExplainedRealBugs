<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:56:50 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-22306] INFER_AND_SAVE overwrites important metadata in Parquet Metastore table</title>
                <link>https://issues.apache.org/jira/browse/SPARK-22306</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;I noticed some critical changes on my hive tables and realized that they were caused by a simple select on SparkSQL. Looking at the logs, I found out that this select was actually performing an update on the database &quot;Saving case-sensitive schema for table&quot;. &lt;br/&gt;
I then found out that Spark 2.2.0 introduces a new default value for spark.sql.hive.caseSensitiveInferenceMode (see &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-20888&quot; title=&quot;Document HiveCaseSensitiveInferenceMode.INFER_AND_SAVE in Spark SQL 2.1 to 2.2 migration notes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-20888&quot;&gt;&lt;del&gt;SPARK-20888&lt;/del&gt;&lt;/a&gt;): INFER_AND_SAVE&lt;/p&gt;

&lt;p&gt;The issue is that this update changes critical metadata of the table, in particular:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;changes the owner to the current user&lt;/li&gt;
	&lt;li&gt;removes bucketing metadata (BUCKETING_COLS, SDS)&lt;/li&gt;
	&lt;li&gt;removes sorting metadata (SORT_COLS)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Switching the property to: NEVER_INFER prevents the issue.&lt;/p&gt;

&lt;p&gt;Also, note that the damage can be fix manually in Hive with e.g.:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;alter&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;table&lt;/span&gt; [&lt;span class=&quot;code-keyword&quot;&gt;table_name&lt;/span&gt;] 
&lt;span class=&quot;code-keyword&quot;&gt;clustered&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;by&lt;/span&gt; ([col1], [col2]) 
sorted &lt;span class=&quot;code-keyword&quot;&gt;by&lt;/span&gt; ([colA], [colB])
&lt;span class=&quot;code-keyword&quot;&gt;into&lt;/span&gt; [n] buckets
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;b&gt;REPRODUCE (branch-2.2)&lt;/b&gt;&lt;br/&gt;
In Spark 2.1.x (branch-2.1), NEVER_INFER is used. Spark 2.3 (master) branch is good due to &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-17729&quot; title=&quot;Enable creating hive bucketed tables&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-17729&quot;&gt;&lt;del&gt;SPARK-17729&lt;/del&gt;&lt;/a&gt;. This is a regression on Spark 2.2 only. By default, Parquet Hive table is affected and only Hive may suffer from this.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
hive&amp;gt; CREATE TABLE t(a string, b string) CLUSTERED BY (a, b) SORTED BY (a, b) INTO 10 BUCKETS STORED AS PARQUET;
hive&amp;gt; INSERT INTO t VALUES(&lt;span class=&quot;code-quote&quot;&gt;&apos;a&apos;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&apos;b&apos;&lt;/span&gt;);
hive&amp;gt; DESC FORMATTED t;
...
Num Buckets:        	10
Bucket Columns:     	[a, b]
Sort Columns:       	[Order(col:a, order:1), Order(col:b, order:1)]

scala&amp;gt; sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT * FROM t&quot;&lt;/span&gt;).show(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)

hive&amp;gt; DESC FORMATTED t;
Num Buckets:        	-1
Bucket Columns:     	[]
Sort Columns:       	[]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;Hive 2.3.0 (PostgresQL metastore, stored as Parquet)&lt;br/&gt;
Spark 2.2.0&lt;/p&gt;</environment>
        <key id="13110299">SPARK-22306</key>
            <summary>INFER_AND_SAVE overwrites important metadata in Parquet Metastore table</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cloud_fan">Wenchen Fan</assignee>
                                    <reporter username="WhoisDavid">David Malinge</reporter>
                        <labels>
                    </labels>
                <created>Wed, 18 Oct 2017 14:18:14 +0000</created>
                <updated>Sat, 1 Jun 2019 02:14:34 +0000</updated>
                            <resolved>Thu, 2 Nov 2017 11:38:17 +0000</resolved>
                                    <version>2.2.0</version>
                                    <fixVersion>2.2.1</fixVersion>
                    <fixVersion>2.3.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16210105" author="dongjoon" created="Wed, 18 Oct 2017 21:50:46 +0000"  >&lt;p&gt;Hi, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cloud_fan&quot; class=&quot;user-hover&quot; rel=&quot;cloud_fan&quot;&gt;cloud_fan&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=smilegator&quot; class=&quot;user-hover&quot; rel=&quot;smilegator&quot;&gt;smilegator&lt;/a&gt;.&lt;br/&gt;
Should we change the default value to prevent this regression?&lt;/p&gt;</comment>
                            <comment id="16210127" author="dongjoon" created="Wed, 18 Oct 2017 22:07:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=WhoisDavid&quot; class=&quot;user-hover&quot; rel=&quot;WhoisDavid&quot;&gt;WhoisDavid&lt;/a&gt;.&lt;br/&gt;
Your table is &apos;STORED AS PARQUET&apos;, right?&lt;br/&gt;
Could you try `spark.sql.hive.convertMetastoreParquet.mergeSchema=false`, too?&lt;/p&gt;</comment>
                            <comment id="16211129" author="whoisdavid" created="Thu, 19 Oct 2017 14:32:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dongjoon&quot; class=&quot;user-hover&quot; rel=&quot;dongjoon&quot;&gt;dongjoon&lt;/a&gt;&lt;br/&gt;
Seems to be set to false by default (or at least in my current setup)&lt;/p&gt;</comment>
                            <comment id="16211276" author="dongjoon" created="Thu, 19 Oct 2017 16:03:07 +0000"  >&lt;p&gt;Thank you for confirming.&lt;br/&gt;
Sorry for asking again, could you turn off `spark.sql.hive.convertMetastoreParquet=false`?&lt;/p&gt;</comment>
                            <comment id="16211375" author="dongjoon" created="Thu, 19 Oct 2017 17:16:17 +0000"  >&lt;p&gt;Hi. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=WhoisDavid&quot; class=&quot;user-hover&quot; rel=&quot;WhoisDavid&quot;&gt;WhoisDavid&lt;/a&gt;.&lt;br/&gt;
Spark 2.3 seems to be okay due to &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-17729&quot; title=&quot;Enable creating hive bucketed tables&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-17729&quot;&gt;&lt;del&gt;SPARK-17729&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
I can check the bucket spec is preserved like `Some(10 buckets, bucket columns: &lt;span class=&quot;error&quot;&gt;&amp;#91;a, b&amp;#93;&lt;/span&gt;, sort columns: &lt;span class=&quot;error&quot;&gt;&amp;#91;a, b&amp;#93;&lt;/span&gt;)`.&lt;br/&gt;
You can download the snapshot and try that.&lt;/p&gt;</comment>
                            <comment id="16211433" author="whoisdavid" created="Thu, 19 Oct 2017 17:51:03 +0000"  >&lt;p&gt;With:&lt;br/&gt;
spark.sql.hive.caseSensitiveInferenceMode=INFER_AND_SAVE&lt;br/&gt;
spark.sql.hive.convertMetastoreParquet=false&lt;/p&gt;

&lt;p&gt;The issue does not happen. Leaves the bucketing/sorting/owner as is.&lt;/p&gt;</comment>
                            <comment id="16211518" author="dongjoon" created="Thu, 19 Oct 2017 18:37:28 +0000"  >&lt;p&gt;When we release 2.2.1, we had better give a warning about this regression.&lt;/p&gt;</comment>
                            <comment id="16211633" author="dongjoon" created="Thu, 19 Oct 2017 19:54:04 +0000"  >&lt;p&gt;Hi, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=budde&quot; class=&quot;user-hover&quot; rel=&quot;budde&quot;&gt;budde&lt;/a&gt;.&lt;br/&gt;
Could you take a look this issue in Spark 2.2.0?&lt;/p&gt;</comment>
                            <comment id="16211642" author="budde" created="Thu, 19 Oct 2017 20:00:35 +0000"  >&lt;p&gt;I&apos;ll take a look and potentially start on a patch as soon as I get the time. Should be the next day or two.&lt;/p&gt;</comment>
                            <comment id="16211670" author="dongjoon" created="Thu, 19 Oct 2017 20:20:27 +0000"  >&lt;p&gt;Thank you, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=budde&quot; class=&quot;user-hover&quot; rel=&quot;budde&quot;&gt;budde&lt;/a&gt;!&lt;/p&gt;</comment>
                            <comment id="16218903" author="cloud_fan" created="Wed, 25 Oct 2017 15:34:50 +0000"  >&lt;p&gt;Seems like the `alterTable` removes some table metadata unexpectedly. I&apos;m checking it.&lt;/p&gt;</comment>
                            <comment id="16226640" author="cloud_fan" created="Tue, 31 Oct 2017 11:22:29 +0000"  >&lt;p&gt;This is a known issue before Spark 2.3: ALTER TABLE at Spark side erases the bucketing information of a hive table. However, for this certain case, the ALTER TABLE is triggered automatically, which it&apos;s pretty bad for users because of this bug.&lt;/p&gt;

&lt;p&gt;I&apos;m going to handle this case specially and suggest users to upgrade to Spark 2.3.&lt;/p&gt;</comment>
                            <comment id="16226944" author="apachespark" created="Tue, 31 Oct 2017 15:04:04 +0000"  >&lt;p&gt;User &apos;cloud-fan&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/19622&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/19622&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16235594" author="cloud_fan" created="Thu, 2 Nov 2017 11:38:17 +0000"  >&lt;p&gt;Issue resolved by pull request 19622&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/19622&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/19622&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16235725" author="apachespark" created="Thu, 2 Nov 2017 13:32:04 +0000"  >&lt;p&gt;User &apos;cloud-fan&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/19644&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/19644&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13043351">SPARK-19611</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13074910">SPARK-20888</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13111244">SPARK-22329</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310051">
                    <name>Supercedes</name>
                                            <outwardlinks description="supercedes">
                                        <issuelink>
            <issuekey id="13111244">SPARK-22329</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 2 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3letz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>