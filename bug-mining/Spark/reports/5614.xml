<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:59:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-23598] WholeStageCodegen can lead to IllegalAccessError  calling append for HashAggregateExec</title>
                <link>https://issues.apache.org/jira/browse/SPARK-23598</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Got&#160;the following stacktrace&#160;for a large QueryPlan using WholeStageCodeGen:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.IllegalAccessError: tried to access method org.apache.spark.sql.execution.BufferedRowIterator.append(Lorg/apache/spark/sql/catalyst/InternalRow;)V from class org.apache.spark.sql.catalyst.expressions.GeneratedClass$GeneratedIteratorForCodegenStage7$agg_NestedClass
at org.apache.spark.sql.catalyst.expressions.GeneratedClass$GeneratedIteratorForCodegenStage7$agg_NestedClass.agg_doAggregateWithKeysOutput$(Unknown Source)
at org.apache.spark.sql.catalyst.expressions.GeneratedClass$GeneratedIteratorForCodegenStage7.processNext(Unknown Source)
at org.apache.spark.sql.execution.BufferedRowIterator.hasNext(BufferedRowIterator.java:43)
at org.apache.spark.sql.execution.WholeStageCodegenExec$$anonfun$10$$anon$1.hasNext(WholeStageCodegenExec.scala:614)
at scala.collection.Iterator$$anon$11.hasNext(Iterator.scala:408)
at org.apache.spark.shuffle.sort.BypassMergeSortShuffleWriter.write(BypassMergeSortShuffleWriter.java:125)
at org.apache.spark.scheduler.ShuffleMapTask.runTask(ShuffleMapTask.scala:96)
at org.apache.spark.scheduler.ShuffleMapTask.runTask(ShuffleMapTask.scala:53)
at org.apache.spark.scheduler.Task.run(Task.scala:109)
at org.apache.spark.executor.Executor$TaskRunner.run(Executor.scala:345)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;After disabling codegen, everything works.&lt;/p&gt;

&lt;p&gt;The root cause seems to be that we are trying to call the protected&#160;&lt;em&gt;append&lt;/em&gt; method of&#160;&lt;a href=&quot;https://github.com/apache/spark/blob/master/sql/core/src/main/java/org/apache/spark/sql/execution/BufferedRowIterator.java#L68&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;BufferedRowIterator&lt;/a&gt;&#160;from an inner-class of a sub-class that is loaded by a different class-loader (after codegen compilation).&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://docs.oracle.com/javase/specs/jvms/se7/html/jvms-5.html#jvms-5.4.4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://docs.oracle.com/javase/specs/jvms/se7/html/jvms-5.html#jvms-5.4.4&lt;/a&gt;&#160;states that a protected method&#160;&lt;em&gt;R&lt;/em&gt;&#160;can be accessed only&#160;if one of the following two conditions is fulfilled:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;R is protected and is declared in a class C, and D is either a subclass of C or C itself. Furthermore, if R is not static, then the symbolic reference to R must contain a symbolic reference to a class T, such that T is either a subclass of D, a superclass of D, or D itself.&lt;/li&gt;
	&lt;li&gt;R is either protected or has default access (that is, neither public nor protected nor private), and is declared by a class in the same run-time package as D.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;2.) doesn&apos;t apply as we have loaded the class with a different class loader (and are in a different package) and 1.) doesn&apos;t apply because we are apparently trying to call the method from an inner class of a subclass of&#160;&lt;em&gt;BufferedRowIterator&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;Looking at the Code path of&#160;&lt;em&gt;WholeStageCodeGen&lt;/em&gt;, the following happens:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;In&#160;&lt;a href=&quot;https://github.com/apache/spark/blob/master/sql/core/src/main/scala/org/apache/spark/sql/execution/WholeStageCodegenExec.scala#L527&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;WholeStageCodeGen&lt;/a&gt;, we create the subclass of &lt;em&gt;BufferedRowIterator&lt;/em&gt;, along with a &lt;em&gt;processNext&lt;/em&gt;&#160;method for processing the output of the child plan.&lt;/li&gt;
	&lt;li&gt;In the child, which is a &lt;a href=&quot;https://github.com/apache/spark/blob/master/sql/core/src/main/scala/org/apache/spark/sql/execution/aggregate/HashAggregateExec.scala#L517&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;HashAggregateExec&lt;/a&gt;, we create the method which shows up at the top of&#160;the stack trace (called&#160;&lt;em&gt;doAggregateWithKeysOutput&lt;/em&gt;&#160;)&lt;/li&gt;
	&lt;li&gt;We add this method to the compiled code invoking&#160;&lt;em&gt;addNewFunction&lt;/em&gt;&#160;of&#160;&lt;a href=&quot;https://github.com/apache/spark/blob/master/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/expressions/codegen/CodeGenerator.scala#L460&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CodeGenerator&lt;/a&gt;&lt;br/&gt;
In the generated function body we call the&#160;&lt;em&gt;append&lt;/em&gt; method.|&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Now,&#160;the&#160;&lt;em&gt;addNewFunction&lt;/em&gt; method states that:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;If the code for the `OuterClass` grows too large, the function will be inlined into a new private, inner class
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This indeed seems to happen: the&#160;&lt;em&gt;doAggregateWithKeysOutput&lt;/em&gt;&#160;method is put into a new private inner class. Thus, it doesn&apos;t have access to the protected&#160;&lt;em&gt;append&lt;/em&gt; method anymore but still tries to call it, which results in the&#160;&lt;em&gt;IllegalAccessError.&lt;/em&gt;&#160;&lt;/p&gt;

&lt;p&gt;Possible fixes:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Pass in the&#160;&lt;em&gt;inlineToOuterClass&lt;/em&gt; flag when invoking the&#160;&lt;em&gt;addNewFunction&lt;/em&gt;&lt;/li&gt;
	&lt;li&gt;Make the&#160;&lt;em&gt;append&lt;/em&gt;&#160;method public&lt;/li&gt;
	&lt;li&gt;Re-declare the&#160;&lt;em&gt;append&lt;/em&gt;&#160;method in the generated subclass (just invoking &lt;em&gt;super&lt;/em&gt;). This way, inner classes should have access to it.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13142525">SPARK-23598</key>
            <summary>WholeStageCodegen can lead to IllegalAccessError  calling append for HashAggregateExec</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kiszk">Kazuaki Ishizaki</assignee>
                                    <reporter username="dvogelbacher">David Vogelbacher</reporter>
                        <labels>
                    </labels>
                <created>Mon, 5 Mar 2018 13:20:26 +0000</created>
                <updated>Tue, 27 Mar 2018 04:08:50 +0000</updated>
                            <resolved>Tue, 13 Mar 2018 22:05:25 +0000</resolved>
                                    <version>2.4.0</version>
                                    <fixVersion>2.3.1</fixVersion>
                    <fixVersion>2.4.0</fixVersion>
                                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="16386100" author="hvanhovell" created="Mon, 5 Mar 2018 13:53:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dvogelbacher&quot; class=&quot;user-hover&quot; rel=&quot;dvogelbacher&quot;&gt;dvogelbacher&lt;/a&gt; Do you have some code which we can use to reproduce this?&lt;/p&gt;</comment>
                            <comment id="16386234" author="mgaido" created="Mon, 5 Mar 2018 15:45:36 +0000"  >&lt;p&gt;thanks for reporting this. Actually the one which you designed as a possible fix isn&apos;t really an option, because it would mean basically inlining everything to the outer class, which causes other problems (namely the Java limit for constant pool entries). Redeclaring it seems a bit hacky to me (and it causes an extra function call for each row...). I&apos;d go for making the method public, if no better option comes out.&lt;/p&gt;</comment>
                            <comment id="16389745" author="dvogelbacher" created="Wed, 7 Mar 2018 16:10:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hvanhovell&quot; class=&quot;user-hover&quot; rel=&quot;hvanhovell&quot;&gt;hvanhovell&lt;/a&gt; unfortunately, I can&apos;t extract any code for reproducing.&lt;br/&gt;
It should be possible to come up with code, by making a large enough query (one that adds many methods in the code gen stage) and contains a HashAggregateExec node.&lt;/p&gt;

&lt;p&gt;Or to make it even easier, one could compile spark with a lowered `final val GENERATED_CLASS_SIZE_THRESHOLD` in &lt;a href=&quot;https://github.com/apache/spark/blob/master/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/expressions/codegen/CodeGenerator.scala#L1170&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CodeGenerator title&lt;/a&gt;, to force the generation of the private inner class.&lt;/p&gt;</comment>
                            <comment id="16389766" author="kiszk" created="Wed, 7 Mar 2018 16:38:44 +0000"  >&lt;p&gt;I also think that the easiest way is to make &lt;tt&gt;append&lt;/tt&gt;&#160;public.&lt;/p&gt;</comment>
                            <comment id="16391373" author="mgaido" created="Thu, 8 Mar 2018 15:11:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dvogelbacher&quot; class=&quot;user-hover&quot; rel=&quot;dvogelbacher&quot;&gt;dvogelbacher&lt;/a&gt; the parameter you are talking about is taken in account only when we split expressions and it is not done in HashAggregateExec. I haven&apos;t been able to reproduce this. If you can provide a sample to reproduce this, it would be very helpful.&lt;/p&gt;</comment>
                            <comment id="16391709" author="dvogelbacher" created="Thu, 8 Mar 2018 18:38:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mgaido&quot; class=&quot;user-hover&quot; rel=&quot;mgaido&quot;&gt;mgaido&lt;/a&gt; &lt;tt&gt;HashAggregateExec&lt;/tt&gt; calls &lt;tt&gt;addNewFunction&lt;/tt&gt;, which calls &lt;tt&gt;addNewFunctionInternal&lt;/tt&gt; which uses that flag and checks if the current size is bigger than &lt;tt&gt;GENERATED_CLASS_SIZE_THRESHOLD&lt;/tt&gt; (&lt;a href=&quot;https://github.com/apache/spark/blob/master/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/expressions/codegen/CodeGenerator.scala#L478&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;see&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;I just compiled develop with &lt;tt&gt;GENERATED_CLASS_SIZE_THRESHOLD&lt;/tt&gt; set to -1 and was able to reproduce (cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hvanhovell&quot; class=&quot;user-hover&quot; rel=&quot;hvanhovell&quot;&gt;hvanhovell&lt;/a&gt;) . I applied the following diff before compiling:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;diff --git a/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/expressions/codegen/CodeGenerator.scala b/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/expressions/codegen/CodeGenerator.scala
index 793824b0b0..7fad817d89 100644
--- a/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/expressions/codegen/CodeGenerator.scala
+++ b/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/expressions/codegen/CodeGenerator.scala
@@ -1167,7 +1167,7 @@ object CodeGenerator extends Logging {
   // limit, 65,536. We cannot know how many constants will be inserted for a class, so we use a
   // threshold of 1000k bytes to determine when a function should be inlined to a private, inner
   // class.
-  final val GENERATED_CLASS_SIZE_THRESHOLD = 1000000
+  final val GENERATED_CLASS_SIZE_THRESHOLD = -1

   // This is the threshold for the number of global variables, whose types are primitive type or
   // complex type (e.g. more than one-dimensional array), that will be placed at the outer class
(END)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then, I executed a simple groupBy-Aggregate in the spark-shell and got the same error:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&#10140;  spark git:(master) &#10007; ./bin/spark-shell
18/03/08 18:30:24 WARN Utils: Your hostname, dvogelbac resolves to a loopback address: 127.0.0.1; using 10.111.11.111 instead (on interface en0)
18/03/08 18:30:24 WARN Utils: Set SPARK_LOCAL_IP if you need to bind to another address
18/03/08 18:30:24 WARN NativeCodeLoader: Unable to load native-hadoop library for your platform... using builtin-java classes where applicable
Using Spark&apos;s default log4j profile: org/apache/spark/log4j-defaults.properties
Setting default log level to &quot;WARN&quot;.
To adjust logging level use sc.setLogLevel(newLevel). For SparkR, use setLogLevel(newLevel).
Spark context Web UI available at http://10.111.11.111:4040
Spark context available as &apos;sc&apos; (master = local[*], app id = local-1520533829643).
Spark session available as &apos;spark&apos;.
Welcome to
      ____              __
     / __/__  ___ _____/ /__
    _\ \/ _ \/ _ `/ __/  &apos;_/
   /___/ .__/\_,_/_/ /_/\_\   version 2.4.0-SNAPSHOT
      /_/

Using Scala version 2.11.8 (Java HotSpot(TM) 64-Bit Server VM, Java 1.8.0_121)
Type in expressions to have them evaluated.
Type :help for more information.

scala&amp;gt; spark.conf.set(&quot;spark.sql.codegen.wholeStage&quot;, true)

scala&amp;gt; val df_pet_age = Seq(
     |   (8, &quot;bat&quot;),
     |   (5, &quot;bat&quot;),
     |   (15, &quot;bat&quot;),
     |   (30, &quot;mouse&quot;),
     |   (15, &quot;mouse&quot;),
     |   (23, &quot;mouse&quot;),
     |   (8, &quot;horse&quot;),
     |   (-5, &quot;horse&quot;)
     | ).toDF(&quot;age&quot;, &quot;name&quot;)
df_pet_age: org.apache.spark.sql.DataFrame = [age: int, name: string]

scala&amp;gt; df_pet_age.groupBy(&quot;name&quot;).avg(&quot;age&quot;).show()
18/03/08 18:31:20 ERROR Executor: Exception in task 1.0 in stage 0.0 (TID 1)
java.lang.IllegalAccessError: tried to access method org.apache.spark.sql.execution.BufferedRowIterator.stopEarly()Z from class org.apache.spark.sql.catalyst.expressions.GeneratedClass$GeneratedIteratorForCodegenStage1$agg_NestedClass1
	at org.apache.spark.sql.catalyst.expressions.GeneratedClass$GeneratedIteratorForCodegenStage1$agg_NestedClass1.agg_doAggregateWithKeys$(Unknown Source)
	at org.apache.spark.sql.catalyst.expressions.GeneratedClass$GeneratedIteratorForCodegenStage1.processNext(Unknown Source)
	at org.apache.spark.sql.execution.BufferedRowIterator.hasNext(BufferedRowIterator.java:43)
	at org.apache.spark.sql.execution.WholeStageCodegenExec$$anonfun$11$$anon$1.hasNext(WholeStageCodegenExec.scala:616)
	at scala.collection.Iterator$$anon$11.hasNext(Iterator.scala:408)
	at org.apache.spark.shuffle.sort.BypassMergeSortShuffleWriter.write(BypassMergeSortShuffleWriter.java:125)
	at org.apache.spark.scheduler.ShuffleMapTask.runTask(ShuffleMapTask.scala:96)
	at org.apache.spark.scheduler.ShuffleMapTask.runTask(ShuffleMapTask.scala:53)
	at org.apache.spark.scheduler.Task.run(Task.scala:109)
	at org.apache.spark.executor.Executor$TaskRunner.run(Executor.scala:345)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	at java.lang.Thread.run(Thread.java:745)
18/03/08 18:31:20 ERROR Executor: Exception in task 5.0 in stage 0.0 (TID 5)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It is actually failing trying to invoke a different method in &lt;tt&gt;BufferedRowIterator&lt;/tt&gt; now (&lt;tt&gt;stopEarly&lt;/tt&gt;), but it is the same problem. That method is also declared &lt;tt&gt;protected&lt;/tt&gt; and can&apos;t be accessed.&lt;/p&gt;


</comment>
                            <comment id="16391834" author="kiszk" created="Thu, 8 Mar 2018 19:46:56 +0000"  >&lt;p&gt;Thanks, I confirmed that I can reproduce this issue with the master.&lt;/p&gt;

&lt;p&gt;Generated code is here&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 001 */&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; generate(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[] references) {
&lt;span class=&quot;code-comment&quot;&gt;/* 002 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; GeneratedIteratorForCodegenStage1(references);
&lt;span class=&quot;code-comment&quot;&gt;/* 003 */&lt;/span&gt; }
&lt;span class=&quot;code-comment&quot;&gt;/* 004 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 005 */&lt;/span&gt; &lt;span class=&quot;code-comment&quot;&gt;// codegenStageId=1
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 006 */&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;GeneratedIteratorForCodegenStage1 &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; org.apache.spark.sql.execution.BufferedRowIterator {
&lt;span class=&quot;code-comment&quot;&gt;/* 007 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[] references;
&lt;span class=&quot;code-comment&quot;&gt;/* 008 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; scala.collection.Iterator[] inputs;
&lt;span class=&quot;code-comment&quot;&gt;/* 009 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_initAgg;
&lt;span class=&quot;code-comment&quot;&gt;/* 010 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_bufIsNull;
&lt;span class=&quot;code-comment&quot;&gt;/* 011 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; agg_bufValue;
&lt;span class=&quot;code-comment&quot;&gt;/* 012 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_bufIsNull1;
&lt;span class=&quot;code-comment&quot;&gt;/* 013 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; agg_bufValue1;
&lt;span class=&quot;code-comment&quot;&gt;/* 014 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; agg_FastHashMap agg_fastHashMap;
&lt;span class=&quot;code-comment&quot;&gt;/* 015 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.unsafe.KVIterator&amp;lt;UnsafeRow, UnsafeRow&amp;gt; agg_fastHashMapIter;
&lt;span class=&quot;code-comment&quot;&gt;/* 016 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.unsafe.KVIterator agg_mapIter;
&lt;span class=&quot;code-comment&quot;&gt;/* 017 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.UnsafeFixedWidthAggregationMap agg_hashMap;
&lt;span class=&quot;code-comment&quot;&gt;/* 018 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.UnsafeKVExternalSorter agg_sorter;
&lt;span class=&quot;code-comment&quot;&gt;/* 019 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; scala.collection.Iterator inputadapter_input;
&lt;span class=&quot;code-comment&quot;&gt;/* 020 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_agg_isNull11;
&lt;span class=&quot;code-comment&quot;&gt;/* 021 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_agg_isNull25;
&lt;span class=&quot;code-comment&quot;&gt;/* 022 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.BufferHolder[] agg_mutableStateArray1 = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.BufferHolder[2];
&lt;span class=&quot;code-comment&quot;&gt;/* 023 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter[] agg_mutableStateArray2 = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter[2];
&lt;span class=&quot;code-comment&quot;&gt;/* 024 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; UnsafeRow[] agg_mutableStateArray = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; UnsafeRow[2];
&lt;span class=&quot;code-comment&quot;&gt;/* 025 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 026 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; GeneratedIteratorForCodegenStage1(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[] references) {
&lt;span class=&quot;code-comment&quot;&gt;/* 027 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.references = references;
&lt;span class=&quot;code-comment&quot;&gt;/* 028 */&lt;/span&gt;   }
&lt;span class=&quot;code-comment&quot;&gt;/* 029 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 030 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void init(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; index, scala.collection.Iterator[] inputs) {
&lt;span class=&quot;code-comment&quot;&gt;/* 031 */&lt;/span&gt;     partitionIndex = index;
&lt;span class=&quot;code-comment&quot;&gt;/* 032 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.inputs = inputs;
&lt;span class=&quot;code-comment&quot;&gt;/* 033 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 034 */&lt;/span&gt;     agg_fastHashMap = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; agg_FastHashMap(((org.apache.spark.sql.execution.aggregate.HashAggregateExec) references[0] &lt;span class=&quot;code-comment&quot;&gt;/* plan */&lt;/span&gt;).getTaskMemoryManager(), ((org.apache.spark.sql.execution.aggregate.HashAggregateExec) references[0] &lt;span class=&quot;code-comment&quot;&gt;/* plan */&lt;/span&gt;).getEmptyAggregationBuffer());
&lt;span class=&quot;code-comment&quot;&gt;/* 035 */&lt;/span&gt;     agg_hashMap = ((org.apache.spark.sql.execution.aggregate.HashAggregateExec) references[0] &lt;span class=&quot;code-comment&quot;&gt;/* plan */&lt;/span&gt;).createHashMap();
&lt;span class=&quot;code-comment&quot;&gt;/* 036 */&lt;/span&gt;     inputadapter_input = inputs[0];
&lt;span class=&quot;code-comment&quot;&gt;/* 037 */&lt;/span&gt;     agg_mutableStateArray[0] = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; UnsafeRow(1);
&lt;span class=&quot;code-comment&quot;&gt;/* 038 */&lt;/span&gt;     agg_mutableStateArray1[0] = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.BufferHolder(agg_mutableStateArray[0], 32);
&lt;span class=&quot;code-comment&quot;&gt;/* 039 */&lt;/span&gt;     agg_mutableStateArray2[0] = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter(agg_mutableStateArray1[0], 1);
&lt;span class=&quot;code-comment&quot;&gt;/* 040 */&lt;/span&gt;     agg_mutableStateArray[1] = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; UnsafeRow(3);
&lt;span class=&quot;code-comment&quot;&gt;/* 041 */&lt;/span&gt;     agg_mutableStateArray1[1] = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.BufferHolder(agg_mutableStateArray[1], 32);
&lt;span class=&quot;code-comment&quot;&gt;/* 042 */&lt;/span&gt;     agg_mutableStateArray2[1] = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter(agg_mutableStateArray1[1], 3);
&lt;span class=&quot;code-comment&quot;&gt;/* 043 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 044 */&lt;/span&gt;   }
&lt;span class=&quot;code-comment&quot;&gt;/* 045 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 046 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;agg_FastHashMap {
&lt;span class=&quot;code-comment&quot;&gt;/* 047 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.RowBasedKeyValueBatch batch;
&lt;span class=&quot;code-comment&quot;&gt;/* 048 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;[] buckets;
&lt;span class=&quot;code-comment&quot;&gt;/* 049 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; capacity = 1 &amp;lt;&amp;lt; 16;
&lt;span class=&quot;code-comment&quot;&gt;/* 050 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; loadFactor = 0.5;
&lt;span class=&quot;code-comment&quot;&gt;/* 051 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; numBuckets = (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) (capacity / loadFactor);
&lt;span class=&quot;code-comment&quot;&gt;/* 052 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; maxSteps = 2;
&lt;span class=&quot;code-comment&quot;&gt;/* 053 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; numRows = 0;
&lt;span class=&quot;code-comment&quot;&gt;/* 054 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.types.StructType keySchema = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.types.StructType().add(((java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;) references[1] &lt;span class=&quot;code-comment&quot;&gt;/* keyName */&lt;/span&gt;), org.apache.spark.sql.types.DataTypes.StringType);
&lt;span class=&quot;code-comment&quot;&gt;/* 055 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.types.StructType valueSchema = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.types.StructType().add(((java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;) references[2] &lt;span class=&quot;code-comment&quot;&gt;/* keyName */&lt;/span&gt;), org.apache.spark.sql.types.DataTypes.DoubleType)
&lt;span class=&quot;code-comment&quot;&gt;/* 056 */&lt;/span&gt;     .add(((java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;) references[3] &lt;span class=&quot;code-comment&quot;&gt;/* keyName */&lt;/span&gt;), org.apache.spark.sql.types.DataTypes.LongType);
&lt;span class=&quot;code-comment&quot;&gt;/* 057 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; emptyVBase;
&lt;span class=&quot;code-comment&quot;&gt;/* 058 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; emptyVOff;
&lt;span class=&quot;code-comment&quot;&gt;/* 059 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; emptyVLen;
&lt;span class=&quot;code-comment&quot;&gt;/* 060 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isBatchFull = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 061 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 062 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; agg_FastHashMap(
&lt;span class=&quot;code-comment&quot;&gt;/* 063 */&lt;/span&gt;       org.apache.spark.memory.TaskMemoryManager taskMemoryManager,
&lt;span class=&quot;code-comment&quot;&gt;/* 064 */&lt;/span&gt;       InternalRow emptyAggregationBuffer) {
&lt;span class=&quot;code-comment&quot;&gt;/* 065 */&lt;/span&gt;       batch = org.apache.spark.sql.catalyst.expressions.RowBasedKeyValueBatch
&lt;span class=&quot;code-comment&quot;&gt;/* 066 */&lt;/span&gt;       .allocate(keySchema, valueSchema, taskMemoryManager, capacity);
&lt;span class=&quot;code-comment&quot;&gt;/* 067 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 068 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; UnsafeProjection valueProjection = UnsafeProjection.create(valueSchema);
&lt;span class=&quot;code-comment&quot;&gt;/* 069 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] emptyBuffer = valueProjection.apply(emptyAggregationBuffer).getBytes();
&lt;span class=&quot;code-comment&quot;&gt;/* 070 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 071 */&lt;/span&gt;       emptyVBase = emptyBuffer;
&lt;span class=&quot;code-comment&quot;&gt;/* 072 */&lt;/span&gt;       emptyVOff = Platform.BYTE_ARRAY_OFFSET;
&lt;span class=&quot;code-comment&quot;&gt;/* 073 */&lt;/span&gt;       emptyVLen = emptyBuffer.length;
&lt;span class=&quot;code-comment&quot;&gt;/* 074 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 075 */&lt;/span&gt;       buckets = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;[numBuckets];
&lt;span class=&quot;code-comment&quot;&gt;/* 076 */&lt;/span&gt;       java.util.Arrays.fill(buckets, -1);
&lt;span class=&quot;code-comment&quot;&gt;/* 077 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 078 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 079 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.UnsafeRow findOrInsert(UTF8String agg_key) {
&lt;span class=&quot;code-comment&quot;&gt;/* 080 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; h = hash(agg_key);
&lt;span class=&quot;code-comment&quot;&gt;/* 081 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; step = 0;
&lt;span class=&quot;code-comment&quot;&gt;/* 082 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; idx = (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) h &amp;amp; (numBuckets - 1);
&lt;span class=&quot;code-comment&quot;&gt;/* 083 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (step &amp;lt; maxSteps) {
&lt;span class=&quot;code-comment&quot;&gt;/* 084 */&lt;/span&gt;         &lt;span class=&quot;code-comment&quot;&gt;// Return bucket index &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; it&apos;s either an empty slot or already contains the key
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 085 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (buckets[idx] == -1) {
&lt;span class=&quot;code-comment&quot;&gt;/* 086 */&lt;/span&gt;           &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (numRows &amp;lt; capacity &amp;amp;&amp;amp; !isBatchFull) {
&lt;span class=&quot;code-comment&quot;&gt;/* 087 */&lt;/span&gt;             &lt;span class=&quot;code-comment&quot;&gt;// creating the unsafe &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; entry
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 088 */&lt;/span&gt;             UnsafeRow agg_result = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; UnsafeRow(1);
&lt;span class=&quot;code-comment&quot;&gt;/* 089 */&lt;/span&gt;             org.apache.spark.sql.catalyst.expressions.codegen.BufferHolder agg_holder
&lt;span class=&quot;code-comment&quot;&gt;/* 090 */&lt;/span&gt;             = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.BufferHolder(agg_result,
&lt;span class=&quot;code-comment&quot;&gt;/* 091 */&lt;/span&gt;               32);
&lt;span class=&quot;code-comment&quot;&gt;/* 092 */&lt;/span&gt;             org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter agg_rowWriter
&lt;span class=&quot;code-comment&quot;&gt;/* 093 */&lt;/span&gt;             = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter(
&lt;span class=&quot;code-comment&quot;&gt;/* 094 */&lt;/span&gt;               agg_holder,
&lt;span class=&quot;code-comment&quot;&gt;/* 095 */&lt;/span&gt;               1);
&lt;span class=&quot;code-comment&quot;&gt;/* 096 */&lt;/span&gt;             agg_holder.reset(); &lt;span class=&quot;code-comment&quot;&gt;//TODO: investigate &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; reset or zeroout are actually needed
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 097 */&lt;/span&gt;             agg_rowWriter.zeroOutNullBytes();
&lt;span class=&quot;code-comment&quot;&gt;/* 098 */&lt;/span&gt;             agg_rowWriter.write(0, agg_key);
&lt;span class=&quot;code-comment&quot;&gt;/* 099 */&lt;/span&gt;             agg_result.setTotalSize(agg_holder.totalSize());
&lt;span class=&quot;code-comment&quot;&gt;/* 100 */&lt;/span&gt;             &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; kbase = agg_result.getBaseObject();
&lt;span class=&quot;code-comment&quot;&gt;/* 101 */&lt;/span&gt;             &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; koff = agg_result.getBaseOffset();
&lt;span class=&quot;code-comment&quot;&gt;/* 102 */&lt;/span&gt;             &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; klen = agg_result.getSizeInBytes();
&lt;span class=&quot;code-comment&quot;&gt;/* 103 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 104 */&lt;/span&gt;             UnsafeRow vRow
&lt;span class=&quot;code-comment&quot;&gt;/* 105 */&lt;/span&gt;             = batch.appendRow(kbase, koff, klen, emptyVBase, emptyVOff, emptyVLen);
&lt;span class=&quot;code-comment&quot;&gt;/* 106 */&lt;/span&gt;             &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (vRow == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 107 */&lt;/span&gt;               isBatchFull = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 108 */&lt;/span&gt;             } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 109 */&lt;/span&gt;               buckets[idx] = numRows++;
&lt;span class=&quot;code-comment&quot;&gt;/* 110 */&lt;/span&gt;             }
&lt;span class=&quot;code-comment&quot;&gt;/* 111 */&lt;/span&gt;             &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; vRow;
&lt;span class=&quot;code-comment&quot;&gt;/* 112 */&lt;/span&gt;           } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 113 */&lt;/span&gt;             &lt;span class=&quot;code-comment&quot;&gt;// No more space
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 114 */&lt;/span&gt;             &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 115 */&lt;/span&gt;           }
&lt;span class=&quot;code-comment&quot;&gt;/* 116 */&lt;/span&gt;         } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (equals(idx, agg_key)) {
&lt;span class=&quot;code-comment&quot;&gt;/* 117 */&lt;/span&gt;           &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; batch.getValueRow(buckets[idx]);
&lt;span class=&quot;code-comment&quot;&gt;/* 118 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 119 */&lt;/span&gt;         idx = (idx + 1) &amp;amp; (numBuckets - 1);
&lt;span class=&quot;code-comment&quot;&gt;/* 120 */&lt;/span&gt;         step++;
&lt;span class=&quot;code-comment&quot;&gt;/* 121 */&lt;/span&gt;       }
&lt;span class=&quot;code-comment&quot;&gt;/* 122 */&lt;/span&gt;       &lt;span class=&quot;code-comment&quot;&gt;// Didn&apos;t find it
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 123 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 124 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 125 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 126 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; equals(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; idx, UTF8String agg_key) {
&lt;span class=&quot;code-comment&quot;&gt;/* 127 */&lt;/span&gt;       UnsafeRow row = batch.getKeyRow(buckets[idx]);
&lt;span class=&quot;code-comment&quot;&gt;/* 128 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; (row.getUTF8String(0).equals(agg_key));
&lt;span class=&quot;code-comment&quot;&gt;/* 129 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 130 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 131 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; hash(UTF8String agg_key) {
&lt;span class=&quot;code-comment&quot;&gt;/* 132 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; agg_hash = 0;
&lt;span class=&quot;code-comment&quot;&gt;/* 133 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 134 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; agg_result = 0;
&lt;span class=&quot;code-comment&quot;&gt;/* 135 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] agg_bytes = agg_key.getBytes();
&lt;span class=&quot;code-comment&quot;&gt;/* 136 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; agg_bytes.length; i++) {
&lt;span class=&quot;code-comment&quot;&gt;/* 137 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; agg_hash1 = agg_bytes[i];
&lt;span class=&quot;code-comment&quot;&gt;/* 138 */&lt;/span&gt;         agg_result = (agg_result ^ (0x9e3779b9)) + agg_hash1 + (agg_result &amp;lt;&amp;lt; 6) + (agg_result &amp;gt;&amp;gt;&amp;gt; 2);
&lt;span class=&quot;code-comment&quot;&gt;/* 139 */&lt;/span&gt;       }
&lt;span class=&quot;code-comment&quot;&gt;/* 140 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 141 */&lt;/span&gt;       agg_hash = (agg_hash ^ (0x9e3779b9)) + agg_result + (agg_hash &amp;lt;&amp;lt; 6) + (agg_hash &amp;gt;&amp;gt;&amp;gt; 2);
&lt;span class=&quot;code-comment&quot;&gt;/* 142 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 143 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; agg_hash;
&lt;span class=&quot;code-comment&quot;&gt;/* 144 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 145 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 146 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; org.apache.spark.unsafe.KVIterator&amp;lt;UnsafeRow, UnsafeRow&amp;gt; rowIterator() {
&lt;span class=&quot;code-comment&quot;&gt;/* 147 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; batch.rowIterator();
&lt;span class=&quot;code-comment&quot;&gt;/* 148 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 149 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 150 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void close() {
&lt;span class=&quot;code-comment&quot;&gt;/* 151 */&lt;/span&gt;       batch.close();
&lt;span class=&quot;code-comment&quot;&gt;/* 152 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 153 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 154 */&lt;/span&gt;   }
&lt;span class=&quot;code-comment&quot;&gt;/* 155 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 156 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void processNext() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; java.io.IOException {
&lt;span class=&quot;code-comment&quot;&gt;/* 157 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!agg_initAgg) {
&lt;span class=&quot;code-comment&quot;&gt;/* 158 */&lt;/span&gt;       agg_initAgg = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 159 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; wholestagecodegen_beforeAgg = &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.nanoTime();
&lt;span class=&quot;code-comment&quot;&gt;/* 160 */&lt;/span&gt;       agg_nestedClassInstance1.agg_doAggregateWithKeys();
&lt;span class=&quot;code-comment&quot;&gt;/* 161 */&lt;/span&gt;       ((org.apache.spark.sql.execution.metric.SQLMetric) references[8] &lt;span class=&quot;code-comment&quot;&gt;/* aggTime */&lt;/span&gt;).add((&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.nanoTime() - wholestagecodegen_beforeAgg) / 1000000);
&lt;span class=&quot;code-comment&quot;&gt;/* 162 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 163 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 164 */&lt;/span&gt;     &lt;span class=&quot;code-comment&quot;&gt;// output the result
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 165 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 166 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (agg_fastHashMapIter.next()) {
&lt;span class=&quot;code-comment&quot;&gt;/* 167 */&lt;/span&gt;       UnsafeRow agg_aggKey = (UnsafeRow) agg_fastHashMapIter.getKey();
&lt;span class=&quot;code-comment&quot;&gt;/* 168 */&lt;/span&gt;       UnsafeRow agg_aggBuffer = (UnsafeRow) agg_fastHashMapIter.getValue();
&lt;span class=&quot;code-comment&quot;&gt;/* 169 */&lt;/span&gt;       wholestagecodegen_nestedClassInstance.agg_doAggregateWithKeysOutput(agg_aggKey, agg_aggBuffer);
&lt;span class=&quot;code-comment&quot;&gt;/* 170 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 171 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (shouldStop()) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 172 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 173 */&lt;/span&gt;     agg_fastHashMap.close();
&lt;span class=&quot;code-comment&quot;&gt;/* 174 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 175 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (agg_mapIter.next()) {
&lt;span class=&quot;code-comment&quot;&gt;/* 176 */&lt;/span&gt;       UnsafeRow agg_aggKey = (UnsafeRow) agg_mapIter.getKey();
&lt;span class=&quot;code-comment&quot;&gt;/* 177 */&lt;/span&gt;       UnsafeRow agg_aggBuffer = (UnsafeRow) agg_mapIter.getValue();
&lt;span class=&quot;code-comment&quot;&gt;/* 178 */&lt;/span&gt;       wholestagecodegen_nestedClassInstance.agg_doAggregateWithKeysOutput(agg_aggKey, agg_aggBuffer);
&lt;span class=&quot;code-comment&quot;&gt;/* 179 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 180 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (shouldStop()) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 181 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 182 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 183 */&lt;/span&gt;     agg_mapIter.close();
&lt;span class=&quot;code-comment&quot;&gt;/* 184 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (agg_sorter == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 185 */&lt;/span&gt;       agg_hashMap.free();
&lt;span class=&quot;code-comment&quot;&gt;/* 186 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 187 */&lt;/span&gt;   }
&lt;span class=&quot;code-comment&quot;&gt;/* 188 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 189 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; wholestagecodegen_NestedClass wholestagecodegen_nestedClassInstance = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; wholestagecodegen_NestedClass();
&lt;span class=&quot;code-comment&quot;&gt;/* 190 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; agg_NestedClass1 agg_nestedClassInstance1 = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; agg_NestedClass1();
&lt;span class=&quot;code-comment&quot;&gt;/* 191 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; agg_NestedClass agg_nestedClassInstance = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; agg_NestedClass();
&lt;span class=&quot;code-comment&quot;&gt;/* 192 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 193 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;agg_NestedClass1 {
&lt;span class=&quot;code-comment&quot;&gt;/* 194 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void agg_doAggregateWithKeys() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; java.io.IOException {
&lt;span class=&quot;code-comment&quot;&gt;/* 195 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (inputadapter_input.hasNext() &amp;amp;&amp;amp; !stopEarly()) {
&lt;span class=&quot;code-comment&quot;&gt;/* 196 */&lt;/span&gt;         InternalRow inputadapter_row = (InternalRow) inputadapter_input.next();
&lt;span class=&quot;code-comment&quot;&gt;/* 197 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; inputadapter_value = inputadapter_row.getInt(0);
&lt;span class=&quot;code-comment&quot;&gt;/* 198 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; inputadapter_isNull1 = inputadapter_row.isNullAt(1);
&lt;span class=&quot;code-comment&quot;&gt;/* 199 */&lt;/span&gt;         UTF8String inputadapter_value1 = inputadapter_isNull1 ?
&lt;span class=&quot;code-comment&quot;&gt;/* 200 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; : (inputadapter_row.getUTF8String(1));
&lt;span class=&quot;code-comment&quot;&gt;/* 201 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 202 */&lt;/span&gt;         agg_nestedClassInstance.agg_doConsume(inputadapter_row, inputadapter_value, inputadapter_value1, inputadapter_isNull1);
&lt;span class=&quot;code-comment&quot;&gt;/* 203 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (shouldStop()) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 204 */&lt;/span&gt;       }
&lt;span class=&quot;code-comment&quot;&gt;/* 205 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 206 */&lt;/span&gt;       agg_fastHashMapIter = agg_fastHashMap.rowIterator();
&lt;span class=&quot;code-comment&quot;&gt;/* 207 */&lt;/span&gt;       agg_mapIter = ((org.apache.spark.sql.execution.aggregate.HashAggregateExec) references[0] &lt;span class=&quot;code-comment&quot;&gt;/* plan */&lt;/span&gt;).finishAggregate(agg_hashMap, agg_sorter, ((org.apache.spark.sql.execution.metric.SQLMetric) references[4] &lt;span class=&quot;code-comment&quot;&gt;/* peakMemory */&lt;/span&gt;), ((org.apache.spark.sql.execution.metric.SQLMetric) references[5] &lt;span class=&quot;code-comment&quot;&gt;/* spillSize */&lt;/span&gt;), ((org.apache.spark.sql.execution.metric.SQLMetric) references[6] &lt;span class=&quot;code-comment&quot;&gt;/* avgHashProbe */&lt;/span&gt;));
&lt;span class=&quot;code-comment&quot;&gt;/* 208 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 209 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 210 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 211 */&lt;/span&gt;   }
&lt;span class=&quot;code-comment&quot;&gt;/* 212 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 213 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;wholestagecodegen_NestedClass {
&lt;span class=&quot;code-comment&quot;&gt;/* 214 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void agg_doAggregateWithKeysOutput(UnsafeRow agg_keyTerm, UnsafeRow agg_bufferTerm)
&lt;span class=&quot;code-comment&quot;&gt;/* 215 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; java.io.IOException {
&lt;span class=&quot;code-comment&quot;&gt;/* 216 */&lt;/span&gt;       ((org.apache.spark.sql.execution.metric.SQLMetric) references[7] &lt;span class=&quot;code-comment&quot;&gt;/* numOutputRows */&lt;/span&gt;).add(1);
&lt;span class=&quot;code-comment&quot;&gt;/* 217 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 218 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_isNull35 = agg_keyTerm.isNullAt(0);
&lt;span class=&quot;code-comment&quot;&gt;/* 219 */&lt;/span&gt;       UTF8String agg_value37 = agg_isNull35 ?
&lt;span class=&quot;code-comment&quot;&gt;/* 220 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; : (agg_keyTerm.getUTF8String(0));
&lt;span class=&quot;code-comment&quot;&gt;/* 221 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_isNull36 = agg_bufferTerm.isNullAt(0);
&lt;span class=&quot;code-comment&quot;&gt;/* 222 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; agg_value38 = agg_isNull36 ?
&lt;span class=&quot;code-comment&quot;&gt;/* 223 */&lt;/span&gt;       -1.0 : (agg_bufferTerm.getDouble(0));
&lt;span class=&quot;code-comment&quot;&gt;/* 224 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_isNull37 = agg_bufferTerm.isNullAt(1);
&lt;span class=&quot;code-comment&quot;&gt;/* 225 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; agg_value39 = agg_isNull37 ?
&lt;span class=&quot;code-comment&quot;&gt;/* 226 */&lt;/span&gt;       -1L : (agg_bufferTerm.getLong(1));
&lt;span class=&quot;code-comment&quot;&gt;/* 227 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 228 */&lt;/span&gt;       agg_mutableStateArray1[1].reset();
&lt;span class=&quot;code-comment&quot;&gt;/* 229 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 230 */&lt;/span&gt;       agg_mutableStateArray2[1].zeroOutNullBytes();
&lt;span class=&quot;code-comment&quot;&gt;/* 231 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 232 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (agg_isNull35) {
&lt;span class=&quot;code-comment&quot;&gt;/* 233 */&lt;/span&gt;         agg_mutableStateArray2[1].setNullAt(0);
&lt;span class=&quot;code-comment&quot;&gt;/* 234 */&lt;/span&gt;       } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 235 */&lt;/span&gt;         agg_mutableStateArray2[1].write(0, agg_value37);
&lt;span class=&quot;code-comment&quot;&gt;/* 236 */&lt;/span&gt;       }
&lt;span class=&quot;code-comment&quot;&gt;/* 237 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 238 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (agg_isNull36) {
&lt;span class=&quot;code-comment&quot;&gt;/* 239 */&lt;/span&gt;         agg_mutableStateArray2[1].setNullAt(1);
&lt;span class=&quot;code-comment&quot;&gt;/* 240 */&lt;/span&gt;       } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 241 */&lt;/span&gt;         agg_mutableStateArray2[1].write(1, agg_value38);
&lt;span class=&quot;code-comment&quot;&gt;/* 242 */&lt;/span&gt;       }
&lt;span class=&quot;code-comment&quot;&gt;/* 243 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 244 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (agg_isNull37) {
&lt;span class=&quot;code-comment&quot;&gt;/* 245 */&lt;/span&gt;         agg_mutableStateArray2[1].setNullAt(2);
&lt;span class=&quot;code-comment&quot;&gt;/* 246 */&lt;/span&gt;       } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 247 */&lt;/span&gt;         agg_mutableStateArray2[1].write(2, agg_value39);
&lt;span class=&quot;code-comment&quot;&gt;/* 248 */&lt;/span&gt;       }
&lt;span class=&quot;code-comment&quot;&gt;/* 249 */&lt;/span&gt;       agg_mutableStateArray[1].setTotalSize(agg_mutableStateArray1[1].totalSize());
&lt;span class=&quot;code-comment&quot;&gt;/* 250 */&lt;/span&gt;       append(agg_mutableStateArray[1]);
&lt;span class=&quot;code-comment&quot;&gt;/* 251 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 252 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 253 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 254 */&lt;/span&gt;   }
&lt;span class=&quot;code-comment&quot;&gt;/* 255 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 256 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;agg_NestedClass {
&lt;span class=&quot;code-comment&quot;&gt;/* 257 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void agg_doConsume(InternalRow inputadapter_row, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; agg_expr_0, UTF8String agg_expr_1, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_exprIsNull_1) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; java.io.IOException {
&lt;span class=&quot;code-comment&quot;&gt;/* 258 */&lt;/span&gt;       UnsafeRow agg_unsafeRowAggBuffer = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 259 */&lt;/span&gt;       UnsafeRow agg_fastAggBuffer = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 260 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 261 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 262 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!agg_exprIsNull_1) {
&lt;span class=&quot;code-comment&quot;&gt;/* 263 */&lt;/span&gt;           agg_fastAggBuffer = agg_fastHashMap.findOrInsert(
&lt;span class=&quot;code-comment&quot;&gt;/* 264 */&lt;/span&gt;             agg_expr_1);
&lt;span class=&quot;code-comment&quot;&gt;/* 265 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 266 */&lt;/span&gt;       }
&lt;span class=&quot;code-comment&quot;&gt;/* 267 */&lt;/span&gt;       &lt;span class=&quot;code-comment&quot;&gt;// Cannot find the key in fast hash map, &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; regular hash map.
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 268 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (agg_fastAggBuffer == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 269 */&lt;/span&gt;         &lt;span class=&quot;code-comment&quot;&gt;// generate grouping key
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 270 */&lt;/span&gt;         agg_mutableStateArray1[0].reset();
&lt;span class=&quot;code-comment&quot;&gt;/* 271 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 272 */&lt;/span&gt;         agg_mutableStateArray2[0].zeroOutNullBytes();
&lt;span class=&quot;code-comment&quot;&gt;/* 273 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 274 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (agg_exprIsNull_1) {
&lt;span class=&quot;code-comment&quot;&gt;/* 275 */&lt;/span&gt;           agg_mutableStateArray2[0].setNullAt(0);
&lt;span class=&quot;code-comment&quot;&gt;/* 276 */&lt;/span&gt;         } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 277 */&lt;/span&gt;           agg_mutableStateArray2[0].write(0, agg_expr_1);
&lt;span class=&quot;code-comment&quot;&gt;/* 278 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 279 */&lt;/span&gt;         agg_mutableStateArray[0].setTotalSize(agg_mutableStateArray1[0].totalSize());
&lt;span class=&quot;code-comment&quot;&gt;/* 280 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; agg_value7 = 42;
&lt;span class=&quot;code-comment&quot;&gt;/* 281 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 282 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!agg_exprIsNull_1) {
&lt;span class=&quot;code-comment&quot;&gt;/* 283 */&lt;/span&gt;           agg_value7 = org.apache.spark.unsafe.hash.Murmur3_x86_32.hashUnsafeBytes(agg_expr_1.getBaseObject(), agg_expr_1.getBaseOffset(), agg_expr_1.numBytes(), agg_value7);
&lt;span class=&quot;code-comment&quot;&gt;/* 284 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 285 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 286 */&lt;/span&gt;           &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; to get the buffer from hash map
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 287 */&lt;/span&gt;           agg_unsafeRowAggBuffer =
&lt;span class=&quot;code-comment&quot;&gt;/* 288 */&lt;/span&gt;           agg_hashMap.getAggregationBufferFromUnsafeRow(agg_mutableStateArray[0], agg_value7);
&lt;span class=&quot;code-comment&quot;&gt;/* 289 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 290 */&lt;/span&gt;         &lt;span class=&quot;code-comment&quot;&gt;// Can&apos;t allocate buffer from the hash map. Spill the map and fallback to sort-based
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 291 */&lt;/span&gt;         &lt;span class=&quot;code-comment&quot;&gt;// aggregation after processing all input rows.
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 292 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (agg_unsafeRowAggBuffer == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 293 */&lt;/span&gt;           &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (agg_sorter == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 294 */&lt;/span&gt;             agg_sorter = agg_hashMap.destructAndCreateExternalSorter();
&lt;span class=&quot;code-comment&quot;&gt;/* 295 */&lt;/span&gt;           } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 296 */&lt;/span&gt;             agg_sorter.merge(agg_hashMap.destructAndCreateExternalSorter());
&lt;span class=&quot;code-comment&quot;&gt;/* 297 */&lt;/span&gt;           }
&lt;span class=&quot;code-comment&quot;&gt;/* 298 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 299 */&lt;/span&gt;           &lt;span class=&quot;code-comment&quot;&gt;// the hash map had be spilled, it should have enough memory now,
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 300 */&lt;/span&gt;           &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; to allocate buffer again.
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 301 */&lt;/span&gt;           agg_unsafeRowAggBuffer = agg_hashMap.getAggregationBufferFromUnsafeRow(
&lt;span class=&quot;code-comment&quot;&gt;/* 302 */&lt;/span&gt;             agg_mutableStateArray[0], agg_value7);
&lt;span class=&quot;code-comment&quot;&gt;/* 303 */&lt;/span&gt;           &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (agg_unsafeRowAggBuffer == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 304 */&lt;/span&gt;             &lt;span class=&quot;code-comment&quot;&gt;// failed to allocate the first page
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 305 */&lt;/span&gt;             &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; OutOfMemoryError(&lt;span class=&quot;code-quote&quot;&gt;&quot;No enough memory &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; aggregation&quot;&lt;/span&gt;);
&lt;span class=&quot;code-comment&quot;&gt;/* 306 */&lt;/span&gt;           }
&lt;span class=&quot;code-comment&quot;&gt;/* 307 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 308 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 309 */&lt;/span&gt;       }
&lt;span class=&quot;code-comment&quot;&gt;/* 310 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 311 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (agg_fastAggBuffer != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 312 */&lt;/span&gt;         &lt;span class=&quot;code-comment&quot;&gt;// common sub-expressions
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 313 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_isNull21 = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 314 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; agg_value23 = -1L;
&lt;span class=&quot;code-comment&quot;&gt;/* 315 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 316 */&lt;/span&gt;           agg_value23 = (&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;) agg_expr_0;
&lt;span class=&quot;code-comment&quot;&gt;/* 317 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 318 */&lt;/span&gt;         &lt;span class=&quot;code-comment&quot;&gt;// evaluate aggregate function
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 319 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_isNull23 = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 320 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; agg_value25 = -1.0;
&lt;span class=&quot;code-comment&quot;&gt;/* 321 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 322 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_isNull24 = agg_fastAggBuffer.isNullAt(0);
&lt;span class=&quot;code-comment&quot;&gt;/* 323 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; agg_value26 = agg_isNull24 ?
&lt;span class=&quot;code-comment&quot;&gt;/* 324 */&lt;/span&gt;         -1.0 : (agg_fastAggBuffer.getDouble(0));
&lt;span class=&quot;code-comment&quot;&gt;/* 325 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!agg_isNull24) {
&lt;span class=&quot;code-comment&quot;&gt;/* 326 */&lt;/span&gt;           agg_agg_isNull25 = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 327 */&lt;/span&gt;           &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; agg_value27 = -1.0;
&lt;span class=&quot;code-comment&quot;&gt;/* 328 */&lt;/span&gt;           &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 329 */&lt;/span&gt;             &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_isNull26 = agg_isNull21;
&lt;span class=&quot;code-comment&quot;&gt;/* 330 */&lt;/span&gt;             &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; agg_value28 = -1.0;
&lt;span class=&quot;code-comment&quot;&gt;/* 331 */&lt;/span&gt;             &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!agg_isNull21) {
&lt;span class=&quot;code-comment&quot;&gt;/* 332 */&lt;/span&gt;               agg_value28 = (&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;) agg_value23;
&lt;span class=&quot;code-comment&quot;&gt;/* 333 */&lt;/span&gt;             }
&lt;span class=&quot;code-comment&quot;&gt;/* 334 */&lt;/span&gt;             &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!agg_isNull26) {
&lt;span class=&quot;code-comment&quot;&gt;/* 335 */&lt;/span&gt;               agg_agg_isNull25 = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 336 */&lt;/span&gt;               agg_value27 = agg_value28;
&lt;span class=&quot;code-comment&quot;&gt;/* 337 */&lt;/span&gt;               &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 338 */&lt;/span&gt;             }
&lt;span class=&quot;code-comment&quot;&gt;/* 339 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 340 */&lt;/span&gt;             &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_isNull27 = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 341 */&lt;/span&gt;             &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; agg_value29 = -1.0;
&lt;span class=&quot;code-comment&quot;&gt;/* 342 */&lt;/span&gt;             &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 343 */&lt;/span&gt;               agg_value29 = (&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;) 0;
&lt;span class=&quot;code-comment&quot;&gt;/* 344 */&lt;/span&gt;             }
&lt;span class=&quot;code-comment&quot;&gt;/* 345 */&lt;/span&gt;             &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!agg_isNull27) {
&lt;span class=&quot;code-comment&quot;&gt;/* 346 */&lt;/span&gt;               agg_agg_isNull25 = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 347 */&lt;/span&gt;               agg_value27 = agg_value29;
&lt;span class=&quot;code-comment&quot;&gt;/* 348 */&lt;/span&gt;               &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 349 */&lt;/span&gt;             }
&lt;span class=&quot;code-comment&quot;&gt;/* 350 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 351 */&lt;/span&gt;           } &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
&lt;span class=&quot;code-comment&quot;&gt;/* 352 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 353 */&lt;/span&gt;           agg_isNull23 = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;; &lt;span class=&quot;code-comment&quot;&gt;// resultCode could change nullability.
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 354 */&lt;/span&gt;           agg_value25 = agg_value26 + agg_value27;
&lt;span class=&quot;code-comment&quot;&gt;/* 355 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 356 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 357 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_isNull29 = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 358 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; agg_value31 = -1L;
&lt;span class=&quot;code-comment&quot;&gt;/* 359 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt; &amp;amp;&amp;amp; agg_isNull21) {
&lt;span class=&quot;code-comment&quot;&gt;/* 360 */&lt;/span&gt;           &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_isNull31 = agg_fastAggBuffer.isNullAt(1);
&lt;span class=&quot;code-comment&quot;&gt;/* 361 */&lt;/span&gt;           &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; agg_value33 = agg_isNull31 ?
&lt;span class=&quot;code-comment&quot;&gt;/* 362 */&lt;/span&gt;           -1L : (agg_fastAggBuffer.getLong(1));
&lt;span class=&quot;code-comment&quot;&gt;/* 363 */&lt;/span&gt;           agg_isNull29 = agg_isNull31;
&lt;span class=&quot;code-comment&quot;&gt;/* 364 */&lt;/span&gt;           agg_value31 = agg_value33;
&lt;span class=&quot;code-comment&quot;&gt;/* 365 */&lt;/span&gt;         } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 366 */&lt;/span&gt;           &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_isNull32 = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 367 */&lt;/span&gt;           &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; agg_value34 = -1L;
&lt;span class=&quot;code-comment&quot;&gt;/* 368 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 369 */&lt;/span&gt;           &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_isNull33 = agg_fastAggBuffer.isNullAt(1);
&lt;span class=&quot;code-comment&quot;&gt;/* 370 */&lt;/span&gt;           &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; agg_value35 = agg_isNull33 ?
&lt;span class=&quot;code-comment&quot;&gt;/* 371 */&lt;/span&gt;           -1L : (agg_fastAggBuffer.getLong(1));
&lt;span class=&quot;code-comment&quot;&gt;/* 372 */&lt;/span&gt;           &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!agg_isNull33) {
&lt;span class=&quot;code-comment&quot;&gt;/* 373 */&lt;/span&gt;             agg_isNull32 = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;; &lt;span class=&quot;code-comment&quot;&gt;// resultCode could change nullability.
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 374 */&lt;/span&gt;             agg_value34 = agg_value35 + 1L;
&lt;span class=&quot;code-comment&quot;&gt;/* 375 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 376 */&lt;/span&gt;           }
&lt;span class=&quot;code-comment&quot;&gt;/* 377 */&lt;/span&gt;           agg_isNull29 = agg_isNull32;
&lt;span class=&quot;code-comment&quot;&gt;/* 378 */&lt;/span&gt;           agg_value31 = agg_value34;
&lt;span class=&quot;code-comment&quot;&gt;/* 379 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 380 */&lt;/span&gt;         &lt;span class=&quot;code-comment&quot;&gt;// update fast row
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 381 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!agg_isNull23) {
&lt;span class=&quot;code-comment&quot;&gt;/* 382 */&lt;/span&gt;           agg_fastAggBuffer.setDouble(0, agg_value25);
&lt;span class=&quot;code-comment&quot;&gt;/* 383 */&lt;/span&gt;         } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 384 */&lt;/span&gt;           agg_fastAggBuffer.setNullAt(0);
&lt;span class=&quot;code-comment&quot;&gt;/* 385 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 386 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 387 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!agg_isNull29) {
&lt;span class=&quot;code-comment&quot;&gt;/* 388 */&lt;/span&gt;           agg_fastAggBuffer.setLong(1, agg_value31);
&lt;span class=&quot;code-comment&quot;&gt;/* 389 */&lt;/span&gt;         } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 390 */&lt;/span&gt;           agg_fastAggBuffer.setNullAt(1);
&lt;span class=&quot;code-comment&quot;&gt;/* 391 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 392 */&lt;/span&gt;       } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 393 */&lt;/span&gt;         &lt;span class=&quot;code-comment&quot;&gt;// common sub-expressions
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 394 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_isNull7 = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 395 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; agg_value9 = -1L;
&lt;span class=&quot;code-comment&quot;&gt;/* 396 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 397 */&lt;/span&gt;           agg_value9 = (&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;) agg_expr_0;
&lt;span class=&quot;code-comment&quot;&gt;/* 398 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 399 */&lt;/span&gt;         &lt;span class=&quot;code-comment&quot;&gt;// evaluate aggregate function
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 400 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_isNull9 = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 401 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; agg_value11 = -1.0;
&lt;span class=&quot;code-comment&quot;&gt;/* 402 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 403 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_isNull10 = agg_unsafeRowAggBuffer.isNullAt(0);
&lt;span class=&quot;code-comment&quot;&gt;/* 404 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; agg_value12 = agg_isNull10 ?
&lt;span class=&quot;code-comment&quot;&gt;/* 405 */&lt;/span&gt;         -1.0 : (agg_unsafeRowAggBuffer.getDouble(0));
&lt;span class=&quot;code-comment&quot;&gt;/* 406 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!agg_isNull10) {
&lt;span class=&quot;code-comment&quot;&gt;/* 407 */&lt;/span&gt;           agg_agg_isNull11 = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 408 */&lt;/span&gt;           &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; agg_value13 = -1.0;
&lt;span class=&quot;code-comment&quot;&gt;/* 409 */&lt;/span&gt;           &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 410 */&lt;/span&gt;             &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_isNull12 = agg_isNull7;
&lt;span class=&quot;code-comment&quot;&gt;/* 411 */&lt;/span&gt;             &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; agg_value14 = -1.0;
&lt;span class=&quot;code-comment&quot;&gt;/* 412 */&lt;/span&gt;             &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!agg_isNull7) {
&lt;span class=&quot;code-comment&quot;&gt;/* 413 */&lt;/span&gt;               agg_value14 = (&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;) agg_value9;
&lt;span class=&quot;code-comment&quot;&gt;/* 414 */&lt;/span&gt;             }
&lt;span class=&quot;code-comment&quot;&gt;/* 415 */&lt;/span&gt;             &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!agg_isNull12) {
&lt;span class=&quot;code-comment&quot;&gt;/* 416 */&lt;/span&gt;               agg_agg_isNull11 = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 417 */&lt;/span&gt;               agg_value13 = agg_value14;
&lt;span class=&quot;code-comment&quot;&gt;/* 418 */&lt;/span&gt;               &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 419 */&lt;/span&gt;             }
&lt;span class=&quot;code-comment&quot;&gt;/* 420 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 421 */&lt;/span&gt;             &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_isNull13 = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 422 */&lt;/span&gt;             &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; agg_value15 = -1.0;
&lt;span class=&quot;code-comment&quot;&gt;/* 423 */&lt;/span&gt;             &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 424 */&lt;/span&gt;               agg_value15 = (&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;) 0;
&lt;span class=&quot;code-comment&quot;&gt;/* 425 */&lt;/span&gt;             }
&lt;span class=&quot;code-comment&quot;&gt;/* 426 */&lt;/span&gt;             &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!agg_isNull13) {
&lt;span class=&quot;code-comment&quot;&gt;/* 427 */&lt;/span&gt;               agg_agg_isNull11 = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 428 */&lt;/span&gt;               agg_value13 = agg_value15;
&lt;span class=&quot;code-comment&quot;&gt;/* 429 */&lt;/span&gt;               &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 430 */&lt;/span&gt;             }
&lt;span class=&quot;code-comment&quot;&gt;/* 431 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 432 */&lt;/span&gt;           } &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
&lt;span class=&quot;code-comment&quot;&gt;/* 433 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 434 */&lt;/span&gt;           agg_isNull9 = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;; &lt;span class=&quot;code-comment&quot;&gt;// resultCode could change nullability.
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 435 */&lt;/span&gt;           agg_value11 = agg_value12 + agg_value13;
&lt;span class=&quot;code-comment&quot;&gt;/* 436 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 437 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 438 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_isNull15 = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 439 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; agg_value17 = -1L;
&lt;span class=&quot;code-comment&quot;&gt;/* 440 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt; &amp;amp;&amp;amp; agg_isNull7) {
&lt;span class=&quot;code-comment&quot;&gt;/* 441 */&lt;/span&gt;           &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_isNull17 = agg_unsafeRowAggBuffer.isNullAt(1);
&lt;span class=&quot;code-comment&quot;&gt;/* 442 */&lt;/span&gt;           &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; agg_value19 = agg_isNull17 ?
&lt;span class=&quot;code-comment&quot;&gt;/* 443 */&lt;/span&gt;           -1L : (agg_unsafeRowAggBuffer.getLong(1));
&lt;span class=&quot;code-comment&quot;&gt;/* 444 */&lt;/span&gt;           agg_isNull15 = agg_isNull17;
&lt;span class=&quot;code-comment&quot;&gt;/* 445 */&lt;/span&gt;           agg_value17 = agg_value19;
&lt;span class=&quot;code-comment&quot;&gt;/* 446 */&lt;/span&gt;         } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 447 */&lt;/span&gt;           &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_isNull18 = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 448 */&lt;/span&gt;           &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; agg_value20 = -1L;
&lt;span class=&quot;code-comment&quot;&gt;/* 449 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 450 */&lt;/span&gt;           &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_isNull19 = agg_unsafeRowAggBuffer.isNullAt(1);
&lt;span class=&quot;code-comment&quot;&gt;/* 451 */&lt;/span&gt;           &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; agg_value21 = agg_isNull19 ?
&lt;span class=&quot;code-comment&quot;&gt;/* 452 */&lt;/span&gt;           -1L : (agg_unsafeRowAggBuffer.getLong(1));
&lt;span class=&quot;code-comment&quot;&gt;/* 453 */&lt;/span&gt;           &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!agg_isNull19) {
&lt;span class=&quot;code-comment&quot;&gt;/* 454 */&lt;/span&gt;             agg_isNull18 = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;; &lt;span class=&quot;code-comment&quot;&gt;// resultCode could change nullability.
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 455 */&lt;/span&gt;             agg_value20 = agg_value21 + 1L;
&lt;span class=&quot;code-comment&quot;&gt;/* 456 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 457 */&lt;/span&gt;           }
&lt;span class=&quot;code-comment&quot;&gt;/* 458 */&lt;/span&gt;           agg_isNull15 = agg_isNull18;
&lt;span class=&quot;code-comment&quot;&gt;/* 459 */&lt;/span&gt;           agg_value17 = agg_value20;
&lt;span class=&quot;code-comment&quot;&gt;/* 460 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 461 */&lt;/span&gt;         &lt;span class=&quot;code-comment&quot;&gt;// update unsafe row buffer
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 462 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!agg_isNull9) {
&lt;span class=&quot;code-comment&quot;&gt;/* 463 */&lt;/span&gt;           agg_unsafeRowAggBuffer.setDouble(0, agg_value11);
&lt;span class=&quot;code-comment&quot;&gt;/* 464 */&lt;/span&gt;         } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 465 */&lt;/span&gt;           agg_unsafeRowAggBuffer.setNullAt(0);
&lt;span class=&quot;code-comment&quot;&gt;/* 466 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 467 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 468 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!agg_isNull15) {
&lt;span class=&quot;code-comment&quot;&gt;/* 469 */&lt;/span&gt;           agg_unsafeRowAggBuffer.setLong(1, agg_value17);
&lt;span class=&quot;code-comment&quot;&gt;/* 470 */&lt;/span&gt;         } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 471 */&lt;/span&gt;           agg_unsafeRowAggBuffer.setNullAt(1);
&lt;span class=&quot;code-comment&quot;&gt;/* 472 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 473 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 474 */&lt;/span&gt;       }
&lt;span class=&quot;code-comment&quot;&gt;/* 475 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 476 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 477 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 478 */&lt;/span&gt;   }
&lt;span class=&quot;code-comment&quot;&gt;/* 479 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 480 */&lt;/span&gt; }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16392360" author="apachespark" created="Fri, 9 Mar 2018 03:45:04 +0000"  >&lt;p&gt;User &apos;kiszk&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/20779&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/20779&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16412835" author="dongjoon" created="Sat, 24 Mar 2018 23:34:29 +0000"  >&lt;p&gt;Hi, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hvanhovell&quot; class=&quot;user-hover&quot; rel=&quot;hvanhovell&quot;&gt;hvanhovell&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kiszk&quot; class=&quot;user-hover&quot; rel=&quot;kiszk&quot;&gt;kiszk&lt;/a&gt;.&lt;br/&gt;
Although this test case is failing in `branch-2.3` sometimes, I added `2.3.1` to `Fixed Versions` because the patch landed on `branch-2.3`.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins/view/Spark%20QA%20Test%20(Dashboard)/job/spark-branch-2.3-test-sbt-hadoop-2.6/lastCompletedBuild/testReport/org.apache.spark.sql.execution/WholeStageCodegenSuite/SPARK_23598__Codegen_working_for_lots_of_aggregation_operations_without_runtime_errors/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins/view/Spark%20QA%20Test%20(Dashboard)/job/spark-branch-2.3-test-sbt-hadoop-2.6/lastCompletedBuild/testReport/org.apache.spark.sql.execution/WholeStageCodegenSuite/SPARK_23598__Codegen_working_for_lots_of_aggregation_operations_without_runtime_errors/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16413213" author="hvanhovell" created="Sun, 25 Mar 2018 22:02:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dongjoon&quot; class=&quot;user-hover&quot; rel=&quot;dongjoon&quot;&gt;dongjoon&lt;/a&gt; thanks for doing this. As for the failing tests, I have backported the&#160;hotfix&#160;to branch-2.3.&lt;/p&gt;</comment>
                            <comment id="16414984" author="dongjoon" created="Tue, 27 Mar 2018 04:08:50 +0000"  >&lt;p&gt;Thank you, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hvanhovell&quot; class=&quot;user-hover&quot; rel=&quot;hvanhovell&quot;&gt;hvanhovell&lt;/a&gt; !&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 34 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3qvaf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>