<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:38:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-12316] Stack overflow with endless call of `Delegation token thread` when application end.</title>
                <link>https://issues.apache.org/jira/browse/SPARK-12316</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;When application end, AM will clean the staging dir.&lt;br/&gt;
But if the driver trigger to update the delegation token, it will can&apos;t find the right token file and then it will endless cycle call the method &apos;updateCredentialsIfRequired&apos;.&lt;br/&gt;
Then it lead to StackOverflowError.&lt;br/&gt;
&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12779495/20151210045149.jpg&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;br/&gt;
&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12779496/20151210045533.jpg&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12921577">SPARK-12316</key>
            <summary>Stack overflow with endless call of `Delegation token thread` when application end.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="carlmartin">Zhaowei Huang</assignee>
                                    <reporter username="carlmartin">Zhaowei Huang</reporter>
                        <labels>
                    </labels>
                <created>Mon, 14 Dec 2015 07:03:58 +0000</created>
                <updated>Sun, 17 May 2020 18:16:53 +0000</updated>
                            <resolved>Thu, 25 Feb 2016 15:15:14 +0000</resolved>
                                    <version>1.6.0</version>
                                    <fixVersion>1.6.1</fixVersion>
                    <fixVersion>2.0.0</fixVersion>
                                    <component>Spark Core</component>
                    <component>YARN</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15059602" author="devaraj.k" created="Wed, 16 Dec 2015 07:04:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=carlmartin&quot; class=&quot;user-hover&quot; rel=&quot;carlmartin&quot;&gt;carlmartin&lt;/a&gt;, can you provide the stack trace for this error? Thanks.&lt;/p&gt;</comment>
                            <comment id="15071399" author="apachespark" created="Fri, 25 Dec 2015 07:37:03 +0000"  >&lt;p&gt;User &apos;SaintBacchus&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/10475&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/10475&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15137000" author="tgraves" created="Mon, 8 Feb 2016 14:35:20 +0000"  >&lt;p&gt;you say &quot;endless cycle call&quot; do you mean the application master hangs?  It seems like it should throw and if the application is done it should just exit anyway since the AM is just calling stop on it.    I just want to clarify what is happening because I assume even if you wait a minute you could still hit the same condition once when its tearing down.&lt;/p&gt;</comment>
                            <comment id="15140024" author="hshreedharan" created="Tue, 9 Feb 2016 23:52:04 +0000"  >&lt;p&gt;So the issue is that the driver got rid of the staging directory before the executors/client-mode-driver were done, correct? I don&apos;t think delaying is the check - we should probably look at another solution - either wait for all executors to be done before removing the staging directory, or if we find that the staging directory is gone, just don&apos;t retry (because there is no point?)&lt;/p&gt;</comment>
                            <comment id="15148023" author="carlmartin" created="Tue, 16 Feb 2016 02:25:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tgraves&quot; class=&quot;user-hover&quot; rel=&quot;tgraves&quot;&gt;tgraves&lt;/a&gt; The application would not hit the same condition because one minute later all the  non-deamon threads had exited.&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hshreedharan&quot; class=&quot;user-hover&quot; rel=&quot;hshreedharan&quot;&gt;hshreedharan&lt;/a&gt; Driver and ApplicationMaster will both try to delete the staging directory. If we want to make sure the ExecutorDelegationTokenUpdater stopped before the ApplicationMaster had exited, it will have to add some RPC call between these threads. So I think add a try after one minuter may be an easy to avoid this issue.&lt;/p&gt;</comment>
                            <comment id="15148662" author="tgraves" created="Tue, 16 Feb 2016 14:32:59 +0000"  >&lt;p&gt;I&apos;m not following how this ended up in an infinite loop.  Can you please describe exactly what you are seeing?&lt;/p&gt;

&lt;p&gt;for instance, shutdown is happening you happen to hit updateCredentialsIfRequired.  But if the File isn&apos;t found you would get an exception and fall back to schedule it an hour later in the catch NonFatal.  If the stop was already called then delegationTokenRenewer.shutdown() should have happened and I assume schedule would have thrown (perhaps I&apos;m wrong here).&lt;/p&gt;

</comment>
                            <comment id="15149810" author="carlmartin" created="Wed, 17 Feb 2016 04:01:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tgraves&quot; class=&quot;user-hover&quot; rel=&quot;tgraves&quot;&gt;tgraves&lt;/a&gt; The function of listFilesSorted will not throw the exception, it only log the exception. So it will not schedule it an hour later and it will schedule it immediately and then go into another loop.&lt;/p&gt;</comment>
                            <comment id="15150583" author="tgraves" created="Wed, 17 Feb 2016 14:43:27 +0000"  >&lt;p&gt;Ah ok, thanks for the clarification.  I&apos;ll make any further comments on the PR.&lt;/p&gt;</comment>
                            <comment id="15150616" author="tgraves" created="Wed, 17 Feb 2016 15:07:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hshreedharan&quot; class=&quot;user-hover&quot; rel=&quot;hshreedharan&quot;&gt;hshreedharan&lt;/a&gt; I think what you are saying also makes sense but is a much bigger change. as I mention on the Pr we just checked for the credentials file so if it didn&apos;t get renewed then something strange happened anyway so delaying 1 minute to retry seems reasonable.&lt;/p&gt;

&lt;p&gt;We can definitely add in more logic around this too. For instance only retry a certain number of tries or if the staging dir is gone rather then no files within it, immediately exit but I think that can be done separately.  &lt;/p&gt;

&lt;p&gt;Please comment on the PR if you have alternate ideas.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12779495" name="20151210045149.jpg" size="108323" author="carlmartin" created="Fri, 25 Dec 2015 07:16:09 +0000"/>
                            <attachment id="12779496" name="20151210045533.jpg" size="96919" author="carlmartin" created="Fri, 25 Dec 2015 07:16:09 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 39 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2pucn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>