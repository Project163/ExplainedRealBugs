<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:55:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-19326] Speculated task attempts do not get launched in few scenarios</title>
                <link>https://issues.apache.org/jira/browse/SPARK-19326</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Speculated copies of tasks do not get launched in some cases.&lt;/p&gt;

&lt;p&gt;Examples:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;All the running executors have no CPU slots left to accommodate a speculated copy of the task(s). If the all running executors reside over a set of slow / bad hosts, they will keep the job running for long time&lt;/li&gt;
	&lt;li&gt;`spark.task.cpus` &amp;gt; 1 and the running executor has not filled up all its CPU slots. Since the &lt;a href=&quot;https://github.com/apache/spark/blob/2e139eed3194c7b8814ff6cf007d4e8a874c1e4d/core/src/main/scala/org/apache/spark/scheduler/TaskSetManager.scala#L283&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;speculated copies of tasks should run on different host&lt;/a&gt; and not the host where the first copy was launched.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In both these cases, `ExecutorAllocationManager` does not know about pending speculation task attempts and thinks that all the resource demands are well taken care of. (&lt;a href=&quot;https://github.com/apache/spark/blob/6ee28423ad1b2e6089b82af64a31d77d3552bb38/core/src/main/scala/org/apache/spark/ExecutorAllocationManager.scala#L265&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;relevant code&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;This adds variation in the job completion times and more importantly SLA misses &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; In prod, with a large number of jobs, I see this happening more often than one would think. Chasing the bad hosts or reason for slowness doesn&apos;t scale.&lt;/p&gt;

&lt;p&gt;Here is a tiny repro. Note that you need to launch this with (Mesos or YARN or standalone deploy mode) along with `--conf spark.speculation=true --conf spark.executor.cores=4 --conf spark.dynamicAllocation.maxExecutors=100`&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;val n = 100
val someRDD = sc.parallelize(1 to n, n)
someRDD.mapPartitionsWithIndex( (index: Int, it: Iterator[Int]) =&amp;gt; {
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (index == 1) {
  &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;.MaxValue)  &lt;span class=&quot;code-comment&quot;&gt;// fake &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; running task(s)
&lt;/span&gt;}
it.toList.map(x =&amp;gt; index + &lt;span class=&quot;code-quote&quot;&gt;&quot;, &quot;&lt;/span&gt; + x).iterator
}).collect
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13036841">SPARK-19326</key>
            <summary>Speculated task attempts do not get launched in few scenarios</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="tejasp">Tejas Patil</reporter>
                        <labels>
                    </labels>
                <created>Sun, 22 Jan 2017 03:45:48 +0000</created>
                <updated>Sun, 17 May 2020 17:46:47 +0000</updated>
                            <resolved>Wed, 23 Aug 2017 03:32:33 +0000</resolved>
                                    <version>2.0.2</version>
                    <version>2.1.0</version>
                                    <fixVersion>2.3.0</fixVersion>
                                    <component>Scheduler</component>
                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="15833270" author="tejasp" created="Sun, 22 Jan 2017 03:58:00 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kayousterhout&quot; class=&quot;user-hover&quot; rel=&quot;kayousterhout&quot;&gt;kayousterhout&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=irashid&quot; class=&quot;user-hover&quot; rel=&quot;irashid&quot;&gt;irashid&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vanzin&quot; class=&quot;user-hover&quot; rel=&quot;vanzin&quot;&gt;vanzin&lt;/a&gt; &lt;/p&gt;

&lt;p&gt;`ExecutorAllocationManager` currently determines &quot;is there any need to allocate new executor ?&quot; based on the `running` and `pending` tasks. This accounting is purely based on a listener which does not know anything speculated tasks. From the code I could see that this was &lt;a href=&quot;https://github.com/apache/spark/blob/6ee28423ad1b2e6089b82af64a31d77d3552bb38/core/src/main/scala/org/apache/spark/ExecutorAllocationManager.scala#L579&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;intentionally done&lt;/a&gt; in the original patch which introduced this. Changing this doesn&apos;t look like a point fix to me so would like to get your opinion about this.&lt;/p&gt;</comment>
                            <comment id="15850214" author="tejasp" created="Thu, 2 Feb 2017 17:28:15 +0000"  >&lt;p&gt;ping &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kayousterhout&quot; class=&quot;user-hover&quot; rel=&quot;kayousterhout&quot;&gt;kayousterhout&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=irashid&quot; class=&quot;user-hover&quot; rel=&quot;irashid&quot;&gt;irashid&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vanzin&quot; class=&quot;user-hover&quot; rel=&quot;vanzin&quot;&gt;vanzin&lt;/a&gt;  !!&lt;/p&gt;</comment>
                            <comment id="15850548" author="kayousterhout" created="Thu, 2 Feb 2017 21:32:02 +0000"  >&lt;p&gt;What is the bad behavior that occurs with your example code?  Is the problem that only one executor is requested, so no speculation can occur because there&apos;s not a different node to run tasks on?&lt;/p&gt;</comment>
                            <comment id="15851006" author="tejasp" created="Fri, 3 Feb 2017 03:36:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kayousterhout&quot; class=&quot;user-hover&quot; rel=&quot;kayousterhout&quot;&gt;kayousterhout&lt;/a&gt; : I have updated the configs in the repro example in jira description. &lt;/p&gt;

&lt;p&gt;&amp;gt;&amp;gt; Is the problem that only one executor is requested, so no speculation can occur because there&apos;s not a different node to run tasks on&lt;/p&gt;

&lt;p&gt;No. There are multiple executors launched in the start but later as tasks finish they are released. In the end there might be one single executor left running a single long running task. There is no speculation happening in such case.&lt;/p&gt;
</comment>
                            <comment id="15852085" author="kayousterhout" created="Fri, 3 Feb 2017 20:34:34 +0000"  >&lt;p&gt;I see that makes sense; thanks for the additional explanation.  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=andrewor14&quot; class=&quot;user-hover&quot; rel=&quot;andrewor14&quot;&gt;andrewor14&lt;/a&gt; did you think about this issue when implementing dynamic allocation originally? I noticed there&apos;a a &lt;span class=&quot;error&quot;&gt;&amp;#91;comment saying that speculation is not considered for simplicity&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://github.com/apache/spark/blob/6ee28423ad1b2e6089b82af64a31d77d3552bb38/core/src/main/scala/org/apache/spark/ExecutorAllocationManager.scala#L579&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/6ee28423ad1b2e6089b82af64a31d77d3552bb38/core/src/main/scala/org/apache/spark/ExecutorAllocationManager.scala#L579&lt;/a&gt;), but it does seem like this functionality can prevent speculation from occurring.&lt;/p&gt;</comment>
                            <comment id="15868889" author="tejasp" created="Thu, 16 Feb 2017 00:33:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=andrewor14&quot; class=&quot;user-hover&quot; rel=&quot;andrewor14&quot;&gt;andrewor14&lt;/a&gt; : Ping !!&lt;/p&gt;</comment>
                            <comment id="15869020" author="andrewor14" created="Thu, 16 Feb 2017 02:41:23 +0000"  >&lt;p&gt;Sorry for slipping on this. When I was implementing the feature the goal was to get it working for normal cases first, so I wouldn&apos;t be surprised if it doesn&apos;t work with speculation. I don&apos;t think there&apos;s a fundamental reason why it can&apos;t be supported. Someone just needs to implement it.&lt;/p&gt;</comment>
                            <comment id="15869112" author="tejasp" created="Thu, 16 Feb 2017 04:00:04 +0000"  >&lt;p&gt;Thanks for the info !!&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=andrewor14&quot; class=&quot;user-hover&quot; rel=&quot;andrewor14&quot;&gt;andrewor14&lt;/a&gt; / &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kayousterhout&quot; class=&quot;user-hover&quot; rel=&quot;kayousterhout&quot;&gt;kayousterhout&lt;/a&gt; : I am happy to work on this. Two approaches I can think of are:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Add an event in listener to inform `ExecutorAllocationManager` about tasks from speculation.&lt;/li&gt;
	&lt;li&gt;`ExecutorAllocationManager` should not be depending on listener and have some other event based mechanism to drive have communication between `ExecutorAllocationManager` and `TaskSetManager`. This is cleaner solution but it will be bigger change.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;What do you think ?&lt;/p&gt;</comment>
                            <comment id="15869244" author="andrewor14" created="Thu, 16 Feb 2017 05:27:00 +0000"  >&lt;p&gt;I would say it&apos;s a bad idea to make ExecutorAllocationManager talk to the TaskSetManager. The existing listener interface is relatively isolated. I&apos;m not sure if you need to introduce a new event to capture speculation. You might be able to just write an `if` case that checks whether speculation is enabled and run some logic in the listener to detect speculated tasks.&lt;/p&gt;</comment>
                            <comment id="15869314" author="tejasp" created="Thu, 16 Feb 2017 06:19:16 +0000"  >&lt;p&gt;&amp;gt; You might be able to just write an `if` case that checks whether speculation is enabled and run some logic in the listener to detect speculated tasks.&lt;/p&gt;

&lt;p&gt;For ExecutorAllocationManager to detect that there needs to be speculation, it would basically would have to duplicate what TaskSetManager does to find candidates for speculation (unless you have some better way). Thats bad because there would be two entities making decisions about speculation.&lt;/p&gt;</comment>
                            <comment id="16070457" author="apachespark" created="Fri, 30 Jun 2017 17:30:06 +0000"  >&lt;p&gt;User &apos;janewangfb&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/18492&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/18492&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16137824" author="cloud_fan" created="Wed, 23 Aug 2017 03:32:33 +0000"  >&lt;p&gt;Issue resolved by pull request 18492&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/18492&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/18492&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16137826" author="cloud_fan" created="Wed, 23 Aug 2017 03:34:23 +0000"  >&lt;p&gt;janewangfb can you provide your JIRA id so that I can assign this ticket to you? thanks!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13244980">SPARK-28403</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 12 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i391gv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>