<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:29:21 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-34805] PySpark loses metadata in DataFrame fields when selecting nested columns</title>
                <link>https://issues.apache.org/jira/browse/SPARK-34805</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;For a DataFrame schema with nested StructTypes, where metadata is set for fields in the schema, that metadata is lost when a DataFrame selects nested fields. &#160;For example, suppose&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
df.schema.fields[0].dataType.fields[0].metadata
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;returns a non-empty dictionary, then&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
df.select(&lt;span class=&quot;code-quote&quot;&gt;&apos;Field0.SubField0&apos;&lt;/span&gt;).schema.fields[0].metadata&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;returns an empty dictionary, where &quot;Field0&quot; is the name of the first field in the DataFrame and &quot;SubField0&quot; is the name of the first nested field under &quot;Field0&quot;.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13366410">SPARK-34805</key>
            <summary>PySpark loses metadata in DataFrame fields when selecting nested columns</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="Pyrrho">Mark Ressler</reporter>
                        <labels>
                    </labels>
                <created>Fri, 19 Mar 2021 17:42:48 +0000</created>
                <updated>Wed, 21 Sep 2022 06:08:06 +0000</updated>
                            <resolved>Mon, 21 Mar 2022 16:38:49 +0000</resolved>
                                    <version>3.0.1</version>
                    <version>3.1.1</version>
                                    <fixVersion>3.3.0</fixVersion>
                                    <component>PySpark</component>
                        <due></due>
                            <votes>4</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="17337491" author="emitc2h" created="Fri, 30 Apr 2021 16:23:40 +0000"  >&lt;p&gt;I believe this is not a PySpark-specific issue. We have a unit test in &lt;a href=&quot;https://transmogrif.ai/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;transmogif.ai&lt;/a&gt; where we are specifying &lt;a href=&quot;https://github.com/salesforce/TransmogrifAI/blob/90a0f298f14506a27c84a71de414d53a30cf687f/core/src/test/scala/com/salesforce/op/stages/impl/preparators/SanityCheckerTest.scala#L137&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;column metadata manually&lt;/a&gt;&#160;and check whether the metadata is properly passed on to a model that consumes this column.&#160;The column metadata is properly given to the column using &lt;tt&gt;.as(columnName, metadata)&lt;/tt&gt;, but is immediately lost once the select is executed. I&apos;ve traced the issue to the changes in &lt;tt&gt;ExpressionEncoder&lt;/tt&gt;:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;In Spark 2.4, &lt;a href=&quot;https://github.com/apache/spark/blob/e89526d2401b3a04719721c923a6f630e555e286/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/encoders/ExpressionEncoder.scala#L222&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;it takes it a schema argument&lt;/a&gt; through which the column metadata is passed along&lt;/li&gt;
	&lt;li&gt;In Spark 3.0, &lt;a href=&quot;https://github.com/apache/spark/blob/39889df32a7a916d826e255fda6fc62e2a3d7971/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/encoders/ExpressionEncoder.scala#L232&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;it no longer takes&lt;/a&gt; this schema parameter and it seems like the column metadata is lost as a result&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I can&apos;t tell if this was intentional or not, but it renders the metadata argument of the &lt;tt&gt;.as&lt;/tt&gt; &lt;a href=&quot;https://github.com/apache/spark/blob/39889df32a7a916d826e255fda6fc62e2a3d7971/sql/core/src/main/scala/org/apache/spark/sql/Column.scala#L1133&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;method&lt;/a&gt;&#160;in &lt;tt&gt;Column&lt;/tt&gt; mostly useless.&lt;/p&gt;</comment>
                            <comment id="17478610" author="kevinwallimann" created="Wed, 19 Jan 2022 11:51:51 +0000"  >&lt;p&gt;The problem happens in Scala as well. I attached a scala file &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13039082/13039082_nested_columns_metadata.scala&quot; title=&quot;nested_columns_metadata.scala attached to SPARK-34805&quot;&gt;nested_columns_metadata.scala&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; to demonstrate the issue. I tried it in the spark-shell of versions 2.4.7, 3.1.2 and 3.2.0, always with the same result. This behavior is a bug, because the documentation for &lt;tt&gt;StructField&lt;/tt&gt; clearly says that the &quot;metadata should be preserved during transformation if the content of the column is not modified, e.g, in selection&quot;&lt;/p&gt;</comment>
                            <comment id="17479989" author="apachespark" created="Fri, 21 Jan 2022 10:47:09 +0000"  >&lt;p&gt;User &apos;kevinwallimann&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/35270&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/35270&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17479991" author="apachespark" created="Fri, 21 Jan 2022 10:47:38 +0000"  >&lt;p&gt;User &apos;kevinwallimann&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/35270&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/35270&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17509996" author="cloud_fan" created="Mon, 21 Mar 2022 16:38:49 +0000"  >&lt;p&gt;Issue resolved by pull request 35270&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/35270&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/35270&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13022671" name="jsonMetadataTest.py" size="2451" author="Pyrrho" created="Fri, 19 Mar 2021 17:43:32 +0000"/>
                            <attachment id="13039082" name="nested_columns_metadata.scala" size="829" author="kevinwallimann" created="Wed, 19 Jan 2022 11:49:00 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 34 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0ozog:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>