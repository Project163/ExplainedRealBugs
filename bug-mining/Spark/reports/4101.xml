<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:47:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-16827] Stop reporting spill metrics as shuffle metrics</title>
                <link>https://issues.apache.org/jira/browse/SPARK-16827</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;One of our hive job which looks like this -&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; SELECT  userid
     FROM  table1 a
     JOIN table2 b
      ON    a.ds = &lt;span class=&quot;code-quote&quot;&gt;&apos;2016-07-15&apos;&lt;/span&gt;
      AND  b.ds = &lt;span class=&quot;code-quote&quot;&gt;&apos;2016-07-15&apos;&lt;/span&gt;
      AND  a.source_id = b.id
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After upgrade to Spark 2.0 the job is significantly slow.  Digging a little into it, we found out that one of the stages produces excessive amount of shuffle data.  Please note that this is a regression from Spark 1.6. Stage 2 of the job which used to produce 32KB shuffle data with 1.6, now produces more than 400GB with Spark 2.0. We also tried turning off whole stage code generation but that did not help. &lt;/p&gt;

&lt;p&gt;PS - Even if the intermediate shuffle data size is huge, the job still produces accurate output.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12993836">SPARK-16827</key>
            <summary>Stop reporting spill metrics as shuffle metrics</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="chobrian">Brian Cho</assignee>
                                    <reporter username="sitalkedia@gmail.com">Sital Kedia</reporter>
                        <labels>
                            <label>performance</label>
                    </labels>
                <created>Mon, 1 Aug 2016 00:24:02 +0000</created>
                <updated>Sat, 12 Nov 2016 17:27:49 +0000</updated>
                            <resolved>Wed, 12 Oct 2016 23:01:47 +0000</resolved>
                                    <version>2.0.0</version>
                                                    <component>Shuffle</component>
                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="15401405" author="sitalkedia@gmail.com" created="Mon, 1 Aug 2016 00:33:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rxin&quot; class=&quot;user-hover&quot; rel=&quot;rxin&quot;&gt;rxin&lt;/a&gt; - Any idea how to debug this issue?&lt;/p&gt;</comment>
                            <comment id="15401407" author="rxin" created="Mon, 1 Aug 2016 00:35:27 +0000"  >&lt;p&gt;Did the plan in Spark 1.6 use a broadcast join, and in 2.0 use a shuffle join?&lt;/p&gt;</comment>
                            <comment id="15401413" author="sitalkedia@gmail.com" created="Mon, 1 Aug 2016 00:51:30 +0000"  >&lt;p&gt;That is not the case. There is no broadcast join involved, its using shuffle join in both 1.6 and 2.0.&lt;/p&gt;

&lt;p&gt;Plan in 1.6 -&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Project [target_id#136L AS userid#115L]
+- SortMergeJoin [source_id#135L], [id#140L]
   :- Sort [source_id#135L ASC], &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, 0
   :  +- TungstenExchange hashpartitioning(source_id#135L,800), None
   :     +- ConvertToUnsafe
   :        +- HiveTableScan [target_id#136L,source_id#135L], MetastoreRelation foo, table1, Some(a), [(ds#134 = 2016-07-15)]
   +- Sort [id#140L ASC], &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, 0
      +- TungstenExchange hashpartitioning(id#140L,800), None
         +- ConvertToUnsafe
            +- HiveTableScan [id#140L], MetastoreRelation foo, table2, Some(b), [(ds#139 = 2016-07-15)]

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Plan in 2.0  - &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;*Project [target_id#151L AS userid#111L]
+- *SortMergeJoin [source_id#150L], [id#155L], Inner
   :- *Sort [source_id#150L ASC], &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, 0
   :  +- Exchange hashpartitioning(source_id#150L, 800)
   :     +- *Filter isnotnull(source_id#150L)
   :        +- HiveTableScan [source_id#150L, target_id#151L], MetastoreRelation foo, table1, a, [isnotnull(ds#149), (ds#149 = 2016-07-15)]
   +- *Sort [id#155L ASC], &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, 0
      +- Exchange hashpartitioning(id#155L, 800)
         +- *Filter isnotnull(id#155L)
            +- HiveTableScan [id#155L], MetastoreRelation foo, table2, b, [isnotnull(ds#154), (ds#154 = 2016-07-15)]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15401523" author="sitalkedia@gmail.com" created="Mon, 1 Aug 2016 04:52:39 +0000"  >&lt;p&gt;Actually it seems like this is a bug in shuffle write metrics calculation, actual amount of shuffle data written might be the same,  because the final output is exactly the same. &lt;/p&gt;</comment>
                            <comment id="15402455" author="rxin" created="Mon, 1 Aug 2016 17:24:09 +0000"  >&lt;p&gt;Does the performance diff?&lt;/p&gt;</comment>
                            <comment id="15402461" author="sitalkedia@gmail.com" created="Mon, 1 Aug 2016 17:29:50 +0000"  >&lt;p&gt;Performance is worse for this job. But I suspect this is not because of shuffle data write. Will update once I figure out the reason.&lt;/p&gt;</comment>
                            <comment id="15406328" author="thomastechs" created="Wed, 3 Aug 2016 18:09:57 +0000"  >&lt;p&gt;I understand what you have mentioned is w.r.t to the 1.6 vs 2.0;  Having said that when I faced performance issue, because of skewed partitions, I had to go for a re-partition before the join, which helped improving the performance way better.&lt;/p&gt;

&lt;p&gt;One thing, I am trying to understand is the real execution stages from webUI and how they can be mapped to the explain plans.Please share some light in this , if it is possible, may be a little out of context here.&lt;/p&gt;</comment>
                            <comment id="15546142" author="chobrian" created="Tue, 4 Oct 2016 17:58:38 +0000"  >&lt;p&gt;We found that the &quot;shuffle write&quot; metric was also including writes of spill files, inflating the amount of shuffle writes. This even showed up for final stages when no shuffle writes should take place. I&apos;ll upload screenshots on the PR.&lt;/p&gt;</comment>
                            <comment id="15546160" author="apachespark" created="Tue, 4 Oct 2016 18:02:07 +0000"  >&lt;p&gt;User &apos;dafrista&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/15347&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/15347&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15546330" author="rxin" created="Tue, 4 Oct 2016 19:05:04 +0000"  >&lt;p&gt;We should probably separate the on-disk spill from the shuffle size. Would you have time to work on that?&lt;/p&gt;</comment>
                            <comment id="15546365" author="chobrian" created="Tue, 4 Oct 2016 19:17:07 +0000"  >&lt;p&gt;Sure, having the actual spill metrics is something we&apos;re interested in as well. I&apos;d like to work on it, but I might not get to it immediately.&lt;/p&gt;</comment>
                            <comment id="15570193" author="apachespark" created="Wed, 12 Oct 2016 23:22:05 +0000"  >&lt;p&gt;User &apos;dafrista&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/15455&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/15455&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15570446" author="dreamworks007" created="Thu, 13 Oct 2016 01:12:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rxin&quot; class=&quot;user-hover&quot; rel=&quot;rxin&quot;&gt;rxin&lt;/a&gt;, for this one, I think spill byte (both memory and disk), and shuffle bytes are already logged and reported, right ?&lt;br/&gt;
Also, if I want to add spill time metrics, do you suggest I create a parent class DiskWriteMetrics, and ShuffleWriteMetrics and my new class (eg SpillWriteMetrics) inherit from it, and then pass parent class(DiskWriteMetrics) to UnsafeSorterSpillWriter &lt;a href=&quot;https://github.com/facebook/FB-Spark/blob/fb-2.0/core/src/main/java/org/apache/spark/util/collection/unsafe/sort/UnsafeExternalSorter.java#L209&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/facebook/FB-Spark/blob/fb-2.0/core/src/main/java/org/apache/spark/util/collection/unsafe/sort/UnsafeExternalSorter.java#L209&lt;/a&gt; ?  &lt;/p&gt;

&lt;p&gt;Or do you suggest rename the ShuffleWriteMetrics class to something like WriteMetrics ?&lt;/p&gt;</comment>
                            <comment id="15570716" author="rxin" created="Thu, 13 Oct 2016 03:43:14 +0000"  >&lt;p&gt;See &lt;a href=&quot;https://github.com/apache/spark/pull/15455/files&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/15455/files&lt;/a&gt; &lt;/p&gt;

&lt;p&gt;The spill there is not tracked.&lt;/p&gt;

&lt;p&gt;Also I don&apos;t think it is that useful to track spill time, because you can&apos;t actually measure that accurately due to pipelining.&lt;/p&gt;</comment>
                            <comment id="15571007" author="dreamworks007" created="Thu, 13 Oct 2016 06:23:15 +0000"  >&lt;p&gt;I am quite new to spark, but I think I am getting some confusion on the requirement now - &lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sitalkedia%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;sitalkedia@gmail.com&quot;&gt;sitalkedia@gmail.com&lt;/a&gt; , &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chobrian&quot; class=&quot;user-hover&quot; rel=&quot;chobrian&quot;&gt;chobrian&lt;/a&gt; , could you please give some comment here as for the requirement based on what &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rxin&quot; class=&quot;user-hover&quot; rel=&quot;rxin&quot;&gt;rxin&lt;/a&gt; said ?&lt;/p&gt;</comment>
                            <comment id="15603249" author="apachespark" created="Mon, 24 Oct 2016 21:18:07 +0000"  >&lt;p&gt;User &apos;dreamworks007&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/15616&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/15616&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15659972" author="dreamworks007" created="Sat, 12 Nov 2016 17:27:49 +0000"  >&lt;p&gt;ping ping..&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 1 week, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i31q67:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12338608">2.0.3</customfieldvalue>
    <customfieldvalue id="12335644">2.1.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>