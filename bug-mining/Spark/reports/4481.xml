<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:50:45 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-16473] BisectingKMeans Algorithm failing with java.util.NoSuchElementException: key not found</title>
                <link>https://issues.apache.org/jira/browse/SPARK-16473</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Hello , &lt;/p&gt;

&lt;p&gt;I am using apache spark 1.6.1. &lt;br/&gt;
I am executing bisecting k means algorithm on a specific dataset .&lt;br/&gt;
Dataset details :- &lt;br/&gt;
K=100,&lt;br/&gt;
input vector =100K*100k&lt;br/&gt;
Memory assigned 16GB per node ,&lt;br/&gt;
number of nodes =2.&lt;/p&gt;

&lt;p&gt; Till K=75 it os working fine , but when I set k=100 , it fails with java.util.NoSuchElementException: key not found. &lt;/p&gt;

&lt;p&gt;&lt;b&gt;I suspect it is failing because of lack of some resources , but somehow exception does not convey anything as why this spark job failed.&lt;/b&gt; &lt;/p&gt;

&lt;p&gt;Please can someone point me to root cause of this exception , why it is failing. &lt;/p&gt;

&lt;p&gt;This is the exception stack-trace:- &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.util.NoSuchElementException: key not found: 166 
        at scala.collection.MapLike$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;(MapLike.scala:228) 
        at scala.collection.AbstractMap.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;(Map.scala:58) 
        at scala.collection.MapLike$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;apply(MapLike.scala:141) 
        at scala.collection.AbstractMap.apply(Map.scala:58) 
        at org.apache.spark.mllib.clustering.BisectingKMeans$$anonfun$org$apache$spark$mllib$clustering$BisectingKMeans$$updateAssignments$1$$anonfun$2.apply$mcDJ$sp(BisectingKMeans.scala:338)
        at org.apache.spark.mllib.clustering.BisectingKMeans$$anonfun$org$apache$spark$mllib$clustering$BisectingKMeans$$updateAssignments$1$$anonfun$2.apply(BisectingKMeans.scala:337)
        at org.apache.spark.mllib.clustering.BisectingKMeans$$anonfun$org$apache$spark$mllib$clustering$BisectingKMeans$$updateAssignments$1$$anonfun$2.apply(BisectingKMeans.scala:337)
        at scala.collection.TraversableOnce$$anonfun$minBy$1.apply(TraversableOnce.scala:231) 
        at scala.collection.LinearSeqOptimized$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;foldLeft(LinearSeqOptimized.scala:111) 
        at scala.collection.immutable.List.foldLeft(List.scala:84) 
        at scala.collection.LinearSeqOptimized$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;reduceLeft(LinearSeqOptimized.scala:125) 
        at scala.collection.immutable.List.reduceLeft(List.scala:84) 
        at scala.collection.TraversableOnce$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;minBy(TraversableOnce.scala:231) 
        at scala.collection.AbstractTraversable.minBy(Traversable.scala:105) 
        at org.apache.spark.mllib.clustering.BisectingKMeans$$anonfun$org$apache$spark$mllib$clustering$BisectingKMeans$$updateAssignments$1.apply(BisectingKMeans.scala:337) 
        at org.apache.spark.mllib.clustering.BisectingKMeans$$anonfun$org$apache$spark$mllib$clustering$BisectingKMeans$$updateAssignments$1.apply(BisectingKMeans.scala:334) 
        at scala.collection.Iterator$$anon$11.next(Iterator.scala:328) 
        at scala.collection.Iterator$$anon$14.hasNext(Iterator.scala:389) 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Issue is that , it is failing but not giving any explicit message as to why it failed.&lt;/p&gt;</description>
                <environment>&lt;p&gt;AWS EC2 linux instance. &lt;/p&gt;</environment>
        <key id="12988121">SPARK-16473</key>
            <summary>BisectingKMeans Algorithm failing with java.util.NoSuchElementException: key not found</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="imatiach">Ilya Matiach</assignee>
                                    <reporter username="alokob.be@gmail.com">Alok Bhandari</reporter>
                        <labels>
                    </labels>
                <created>Sun, 10 Jul 2016 11:09:51 +0000</created>
                <updated>Thu, 5 Oct 2017 21:04:39 +0000</updated>
                            <resolved>Tue, 24 Jan 2017 11:30:05 +0000</resolved>
                                    <version>1.6.1</version>
                    <version>2.0.0</version>
                                    <fixVersion>2.1.1</fixVersion>
                    <fixVersion>2.2.0</fixVersion>
                                    <component>ML</component>
                    <component>MLlib</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15391713" author="alokob.be@gmail.com" created="Mon, 25 Jul 2016 11:09:47 +0000"  >&lt;p&gt;After reducing maxIterations for BisectingKMeans it finished successfully , does that mean maxIterations are data-set specific ?&lt;/p&gt;</comment>
                            <comment id="15611340" author="alokob.be@gmail.com" created="Thu, 27 Oct 2016 09:35:00 +0000"  >&lt;p&gt;This issue continue to exist for spark 2.0 &quot;ml&quot; library. Is this feature going to get any support?&lt;/p&gt;</comment>
                            <comment id="15647165" author="alokob.be@gmail.com" created="Tue, 8 Nov 2016 10:28:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=josephkb&quot; class=&quot;user-hover&quot; rel=&quot;josephkb&quot;&gt;josephkb&lt;/a&gt; , I have just found that you have worked on mllib , please can you help me out getting input about this issue.&lt;/p&gt;</comment>
                            <comment id="15762532" author="imatiach" created="Mon, 19 Dec 2016 22:42:03 +0000"  >&lt;p&gt;I&apos;m interested in looking into this issue.  Would it be possible to get a dataset (either the original one or some mock dataset) which can be used to reproduce this error?&lt;/p&gt;</comment>
                            <comment id="15763324" author="alokob.be@gmail.com" created="Tue, 20 Dec 2016 05:36:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=imatiach&quot; class=&quot;user-hover&quot; rel=&quot;imatiach&quot;&gt;imatiach&lt;/a&gt; , thanks for showing interest in this issue. I will try to share the dataset with you , please can you suggest where should I share it ? should I share it through github? is it fine?&lt;/p&gt;

&lt;p&gt;Also , I have tried to diagnose this issue on my own , from my analysis it looks like , it is failing if it tries to bisect a node which does not have any children. I also have added a code fix , but not sure if this is the correct solution :- &lt;/p&gt;

&lt;p&gt;&lt;b&gt;Suggested solution&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;BisectingkMeans.scala&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; def updateAssignments(
      assignments: RDD[(&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;, VectorWithNorm)],
      divisibleIndices: Set[&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;],
      newClusterCenters: Map[&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;, VectorWithNorm]): RDD[(&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;, VectorWithNorm)] = {
    assignments.map { &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; (index, v) =&amp;gt;
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (divisibleIndices.contains(index)) {
        val children = Seq(leftChildIndex(index), rightChildIndex(index))
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ( children.length&amp;gt;0 ) {
        val selected = children.minBy { child =&amp;gt;
          KMeans.fastSquaredDistance(newClusterCenters(child), v)
        }
        (selected, v)
        }&lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
          (index, v)
        }
      } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
        (index, v)
      }
    }
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;b&gt;Original code&lt;/b&gt; &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;BisectingkMeans.scala&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; def updateAssignments(
      assignments: RDD[(&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;, VectorWithNorm)],
      divisibleIndices: Set[&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;],
      newClusterCenters: Map[&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;, VectorWithNorm]): RDD[(&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;, VectorWithNorm)] = {
    assignments.map { &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; (index, v) =&amp;gt;
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (divisibleIndices.contains(index)) {
        val children = Seq(leftChildIndex(index), rightChildIndex(index))
        val selected = children.minBy { child =&amp;gt;
          KMeans.fastSquaredDistance(newClusterCenters(child), v)
        }
        (selected, v)
      } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
        (index, v)
      }
    }
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15764892" author="imatiach" created="Tue, 20 Dec 2016 18:33:03 +0000"  >&lt;p&gt;I will start a pull request for the change.  I would like to add a test case that verifies the bug is fixed though.  Maybe you can send the sample dataset through github, and I can take a look?&lt;/p&gt;</comment>
                            <comment id="15764905" author="apachespark" created="Tue, 20 Dec 2016 18:37:03 +0000"  >&lt;p&gt;User &apos;imatiach-msft&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/16355&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/16355&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15764909" author="imatiach" created="Tue, 20 Dec 2016 18:38:50 +0000"  >&lt;p&gt;I&apos;ve added a pull request here:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/16355&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/16355&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;It would be nice to add a test case in spark itself to verify the code fix.&lt;/p&gt;</comment>
                            <comment id="15764964" author="imatiach" created="Tue, 20 Dec 2016 19:02:20 +0000"  >&lt;p&gt;If you could put the sample dataset on google drive or one drive and send me the link that would be great.  Putting the dataset on github would work too.  How large is the dataset?&lt;/p&gt;</comment>
                            <comment id="15765027" author="imatiach" created="Tue, 20 Dec 2016 19:26:03 +0000"  >&lt;p&gt;Do you have a smaller dataset than the one in the description which can reproduce the bug?&lt;/p&gt;</comment>
                            <comment id="15836054" author="srowen" created="Tue, 24 Jan 2017 11:30:05 +0000"  >&lt;p&gt;Resolved by &lt;a href=&quot;https://github.com/apache/spark/pull/16355&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/16355&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16129818" author="podongfeng" created="Thu, 17 Aug 2017 03:09:01 +0000"  >&lt;p&gt;If the &lt;tt&gt;sparseDataset&lt;/tt&gt; in  &lt;tt&gt;BisectingKMeansSuite&lt;/tt&gt; is cached, then test case &lt;tt&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-16473&quot; title=&quot;BisectingKMeans Algorithm failing with java.util.NoSuchElementException: key not found&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-16473&quot;&gt;&lt;del&gt;SPARK-16473&lt;/del&gt;&lt;/a&gt;: Verify Bisecting K-Means does not fail in edge case whereone cluster is empty after split&lt;/tt&gt; always fails.&lt;br/&gt;
See PR &lt;a href=&quot;https://github.com/apache/spark/pull/16763/files#diff-beaf4409631709a875704e6a4d0a1c13R37&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/16763/files#diff-beaf4409631709a875704e6a4d0a1c13R37&lt;/a&gt; &lt;/p&gt;</comment>
                            <comment id="16193675" author="imatiach" created="Thu, 5 Oct 2017 21:04:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=podongfeng&quot; class=&quot;user-hover&quot; rel=&quot;podongfeng&quot;&gt;podongfeng&lt;/a&gt; interesting - it looks like the dataset representation is somehow changing when it is cached?  My guess is that the row order may be changing or the numeric values may be changing?  The test failure itself is ok if the number of clusters is equal to k (which is actually perfectly fine for the algorithm), it just means that the dataset was not generated correctly to hit the very special edge case I was looking for, where one cluster is empty after a split in bisecting k-means.  I can&apos;t seem to see the test failure error message in your PR, could you run another build and post it here?  We may need to add some debugging/print statements everywhere to determine how the data is changing when you cache it - this doesn&apos;t mean there is any bug in the algorithm, it just means the test needs to be changed so that the test data, even after caching, is the same as the original one.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 6 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i30ref:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12338779">2.1.1</customfieldvalue>
    <customfieldvalue id="12338275">2.2.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>