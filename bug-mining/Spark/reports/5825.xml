<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:00:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-24208] Cannot resolve column in self join after applying Pandas UDF</title>
                <link>https://issues.apache.org/jira/browse/SPARK-24208</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;I noticed that after applying Pandas UDF function, a self join of resulted DataFrame will fail to resolve columns. The workaround that I found is to recreate DataFrame with its RDD and schema.&lt;/p&gt;

&lt;p&gt;Below you can find a Python code that reproduces the issue.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
from pyspark &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; Row
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; pyspark.sql.functions as F

@F.pandas_udf(&lt;span class=&quot;code-quote&quot;&gt;&apos;key &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;, col string&apos;&lt;/span&gt;, F.PandasUDFType.GROUPED_MAP)
def dummy_pandas_udf(df):
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; df[[&lt;span class=&quot;code-quote&quot;&gt;&apos;key&apos;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&apos;col&apos;&lt;/span&gt;]]

df = spark.createDataFrame([Row(key=1,col=&lt;span class=&quot;code-quote&quot;&gt;&apos;A&apos;&lt;/span&gt;), Row(key=1,col=&lt;span class=&quot;code-quote&quot;&gt;&apos;B&apos;&lt;/span&gt;), Row(key=2,col=&lt;span class=&quot;code-quote&quot;&gt;&apos;C&apos;&lt;/span&gt;)])

# transformation that causes the issue
df = df.groupBy(&lt;span class=&quot;code-quote&quot;&gt;&apos;key&apos;&lt;/span&gt;).apply(dummy_pandas_udf)

# WORKAROUND that fixes the issue
# df = spark.createDataFrame(df.rdd, df.schema)

df.alias(&lt;span class=&quot;code-quote&quot;&gt;&apos;temp0&apos;&lt;/span&gt;).join(df.alias(&lt;span class=&quot;code-quote&quot;&gt;&apos;temp1&apos;&lt;/span&gt;), F.col(&lt;span class=&quot;code-quote&quot;&gt;&apos;temp0.key&apos;&lt;/span&gt;) == F.col(&lt;span class=&quot;code-quote&quot;&gt;&apos;temp1.key&apos;&lt;/span&gt;)).show()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;If workaround line is commented out, then above code fails with the following error:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
AnalysisExceptionTraceback (most recent call last)
&amp;lt;ipython-input-88-8de763656d6d&amp;gt; in &amp;lt;module&amp;gt;()
     12 # df = spark.createDataFrame(df.rdd, df.schema)
     13 
---&amp;gt; 14 df.alias(&lt;span class=&quot;code-quote&quot;&gt;&apos;temp0&apos;&lt;/span&gt;).join(df.alias(&lt;span class=&quot;code-quote&quot;&gt;&apos;temp1&apos;&lt;/span&gt;), F.col(&lt;span class=&quot;code-quote&quot;&gt;&apos;temp0.key&apos;&lt;/span&gt;) == F.col(&lt;span class=&quot;code-quote&quot;&gt;&apos;temp1.key&apos;&lt;/span&gt;)).show()

/usr/lib/spark/python/pyspark/sql/dataframe.py in join(self, other, on, how)
    929                 on = self._jseq([])
    930             &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; isinstance(how, basestring), &lt;span class=&quot;code-quote&quot;&gt;&quot;how should be basestring&quot;&lt;/span&gt;
--&amp;gt; 931             jdf = self._jdf.join(other._jdf, on, how)
    932         &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; DataFrame(jdf, self.sql_ctx)
    933 

/usr/lib/spark/python/lib/py4j-src.zip/py4j/java_gateway.py in __call__(self, *args)
   1158         answer = self.gateway_client.send_command(command)
   1159         return_value = get_return_value(
-&amp;gt; 1160             answer, self.gateway_client, self.target_id, self.name)
   1161 
   1162         &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; temp_arg in temp_args:

/usr/lib/spark/python/pyspark/sql/utils.py in deco(*a, **kw)
     67                                              e.java_exception.getStackTrace()))
     68             &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; s.startswith(&lt;span class=&quot;code-quote&quot;&gt;&apos;org.apache.spark.sql.AnalysisException: &apos;&lt;/span&gt;):
---&amp;gt; 69                 raise AnalysisException(s.split(&lt;span class=&quot;code-quote&quot;&gt;&apos;: &apos;&lt;/span&gt;, 1)[1], stackTrace)
     70             &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; s.startswith(&lt;span class=&quot;code-quote&quot;&gt;&apos;org.apache.spark.sql.catalyst.analysis&apos;&lt;/span&gt;):
     71                 raise AnalysisException(s.split(&lt;span class=&quot;code-quote&quot;&gt;&apos;: &apos;&lt;/span&gt;, 1)[1], stackTrace)

AnalysisException: u&lt;span class=&quot;code-quote&quot;&gt;&quot;cannot resolve &lt;span class=&quot;code-quote&quot;&gt;&apos;`temp0.key`&apos;&lt;/span&gt; given input columns: [temp0.key, temp0.col];;\n&lt;span class=&quot;code-quote&quot;&gt;&apos;Join Inner, (&apos;&lt;/span&gt;temp0.key = &apos;temp1.key)\n:- AnalysisBarrier\n:     +- SubqueryAlias temp0\n:        +- FlatMapGroupsInPandas [key#4099L], dummy_pandas_udf(col#4098, key#4099L), [key#4104L, col#4105]\n:           +- Project [key#4099L, col#4098, key#4099L]\n:              +- LogicalRDD [col#4098, key#4099L], &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;\n+- AnalysisBarrier\n      +- SubqueryAlias temp1\n         +- FlatMapGroupsInPandas [key#4099L], dummy_pandas_udf(col#4098, key#4099L), [key#4104L, col#4105]\n            +- Project [key#4099L, col#4098, key#4099L]\n               +- LogicalRDD [col#4098, key#4099L], &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;\n&quot;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The same happens, if instead of DataFrame API I use Spark SQL to do a self join:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
# df is a DataFrame after applying dummy_pandas_udf
df.createOrReplaceTempView(&lt;span class=&quot;code-quote&quot;&gt;&apos;df&apos;&lt;/span&gt;)
spark.sql(&apos;&apos;&apos;
    SELECT 
        *
    FROM df temp0
    LEFT JOIN df temp1 ON
        temp0.key == temp1.key
&apos;&apos;&apos;).show()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;AWS EMR 5.13.0&lt;br/&gt;
Amazon Hadoop distribution 2.8.3&lt;br/&gt;
Spark 2.3.0&lt;br/&gt;
Pandas 0.22.0&lt;/p&gt;</environment>
        <key id="13157872">SPARK-24208</key>
            <summary>Cannot resolve column in self join after applying Pandas UDF</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="4">Incomplete</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="rgan">Rafal Ganczarek</reporter>
                        <labels>
                            <label>bulk-closed</label>
                    </labels>
                <created>Tue, 8 May 2018 11:19:02 +0000</created>
                <updated>Mon, 12 Dec 2022 18:10:35 +0000</updated>
                            <resolved>Tue, 8 Oct 2019 05:41:33 +0000</resolved>
                                    <version>2.3.0</version>
                                                    <component>PySpark</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16468190" author="gurwls223" created="Wed, 9 May 2018 00:59:03 +0000"  >&lt;p&gt;Just for clarification, is it specific to Pandas UDF?&lt;/p&gt;</comment>
                            <comment id="16468532" author="rgan" created="Wed, 9 May 2018 08:12:57 +0000"  >&lt;p&gt;Yes, I don&apos;t know a way to reproduce the issue without use of Pandas UDF.&lt;/p&gt;

&lt;p&gt;I edited the issue description to (hopefully) avoid confusion.&lt;/p&gt;</comment>
                            <comment id="16524341" author="mstewart141" created="Tue, 26 Jun 2018 23:37:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hyukjin.kwon&quot; class=&quot;user-hover&quot; rel=&quot;hyukjin.kwon&quot;&gt;hyukjin.kwon&lt;/a&gt; I can confirm I ran into this issue too. The issue, as the OP noted, stems from&#160;having a pandas GROUPED_MAP UDF&#160;applied to a DF prior to attempting a self-join of said DF against itself. Beyond that I&apos;ve not investigated.&lt;/p&gt;</comment>
                            <comment id="16525210" author="mgaido" created="Wed, 27 Jun 2018 15:44:38 +0000"  >&lt;p&gt;I think this may be a duplicate of &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-24373&quot; title=&quot;&amp;quot;df.cache() df.count()&amp;quot; no longer eagerly caches data when the analyzed plans are different after re-analyzing the plans&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-24373&quot;&gt;&lt;del&gt;SPARK-24373&lt;/del&gt;&lt;/a&gt;. Can you try 2.3.1?&lt;/p&gt;</comment>
                            <comment id="16525363" author="mstewart141" created="Wed, 27 Jun 2018 18:12:09 +0000"  >&lt;p&gt;I can confirm this does not work on 2.3.1.&lt;/p&gt;</comment>
                            <comment id="16537082" author="apachespark" created="Mon, 9 Jul 2018 15:36:05 +0000"  >&lt;p&gt;User &apos;mgaido91&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/21737&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/21737&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16540612" author="apachespark" created="Wed, 11 Jul 2018 20:22:08 +0000"  >&lt;p&gt;User &apos;mgaido91&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/21751&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/21751&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 18 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3tgs7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>