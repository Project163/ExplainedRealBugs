<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:01:34 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-25368] Incorrect constraint inference returns wrong result</title>
                <link>https://issues.apache.org/jira/browse/SPARK-25368</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;there is a breaking change in spark 2.3 (I checked on 2.3.1 and 2.3.2-rc5)&lt;/p&gt;

&lt;p&gt;the following code recreates the&#160;problem&lt;br/&gt;
 (it&apos;s a bit convoluted examples, I tried to simplify it as much as possible from my code)&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.sql.{DataFrame, SQLContext}
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.sql.expressions.Window
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.sql.functions._

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; spark.implicits._

&lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Data(a: Option[Int],b: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;,c: Option[&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;],d: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;)

val df1 = spark.createDataFrame(Seq(
   Data(Some(1), &lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt;, None, &lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt;),
   Data(None, &lt;span class=&quot;code-quote&quot;&gt;&quot;2&quot;&lt;/span&gt;, Some(&lt;span class=&quot;code-quote&quot;&gt;&quot;2&quot;&lt;/span&gt;), &lt;span class=&quot;code-quote&quot;&gt;&quot;2&quot;&lt;/span&gt;)
))

val df2 = df1
.where( $&lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;.isNotNull)
.withColumn(&lt;span class=&quot;code-quote&quot;&gt;&quot;e&quot;&lt;/span&gt;, lit(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;).&lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(&lt;span class=&quot;code-quote&quot;&gt;&quot;string&quot;&lt;/span&gt;))

val columns = df2.columns.map(c =&amp;gt; col(c))

val df3 = df1
.select(
  $&lt;span class=&quot;code-quote&quot;&gt;&quot;c&quot;&lt;/span&gt;,
  $&lt;span class=&quot;code-quote&quot;&gt;&quot;b&quot;&lt;/span&gt; as &lt;span class=&quot;code-quote&quot;&gt;&quot;e&quot;&lt;/span&gt;
  )
  .withColumn(&lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;, lit(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;).&lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&quot;&lt;/span&gt;))
  .withColumn(&lt;span class=&quot;code-quote&quot;&gt;&quot;b&quot;&lt;/span&gt;, lit(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;).&lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(&lt;span class=&quot;code-quote&quot;&gt;&quot;string&quot;&lt;/span&gt;))
  .withColumn(&lt;span class=&quot;code-quote&quot;&gt;&quot;d&quot;&lt;/span&gt;, lit(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;).&lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(&lt;span class=&quot;code-quote&quot;&gt;&quot;string&quot;&lt;/span&gt;))
  .select(columns :_*)

val df4 =
  df2.union(df3)
  .withColumn(&lt;span class=&quot;code-quote&quot;&gt;&quot;e&quot;&lt;/span&gt;, last(col(&lt;span class=&quot;code-quote&quot;&gt;&quot;e&quot;&lt;/span&gt;), ignoreNulls = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;).over(Window.partitionBy($&lt;span class=&quot;code-quote&quot;&gt;&quot;c&quot;&lt;/span&gt;).orderBy($&lt;span class=&quot;code-quote&quot;&gt;&quot;d&quot;&lt;/span&gt;)))
  .filter($&lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;.isNotNull)

df4.show

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;notice that the last statement in for df4 is to filter rows where a is null&lt;/p&gt;

&lt;p&gt;in spark 2.2.1, the above code prints:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+---+---+----+---+---+ 
| a| b| c| d| e|
 +---+---+----+---+---+ 
| 1| 1|&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;| 1| 1| 
+---+---+----+---+---+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;in spark 2.3.x, it prints:&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+----+----+----+----+---+ 
| a| b| c| d| e| 
+----+----+----+----+---+ 
|&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;|&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;|&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;|&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;| 1| 
| 1| 1|&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;| 1| 1| 
|&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;|&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;| 2|&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;| 2|
 +----+----+----+----+---+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;the column a still contains null values&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;attached are the plans.&lt;/p&gt;

&lt;p&gt;in the parsed logical plan, the&#160;filter for&#160;isnotnull(&apos;a), is on top,&lt;br/&gt;
 but in the optimized logical plan, it is pushed down&lt;/p&gt;</description>
                <environment></environment>
        <key id="13183617">SPARK-25368</key>
            <summary>Incorrect constraint inference returns wrong result</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yumwang">Yuming Wang</assignee>
                                    <reporter username="lev">Lev Katzav</reporter>
                        <labels>
                            <label>correctness</label>
                    </labels>
                <created>Fri, 7 Sep 2018 12:06:04 +0000</created>
                <updated>Sun, 9 Sep 2018 22:49:36 +0000</updated>
                            <resolved>Sun, 9 Sep 2018 16:10:58 +0000</resolved>
                                    <version>2.3.0</version>
                    <version>2.3.1</version>
                                    <fixVersion>2.3.2</fixVersion>
                    <fixVersion>2.4.0</fixVersion>
                                    <component>Optimizer</component>
                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16608013" author="q79969786" created="Sat, 8 Sep 2018 10:48:45 +0000"  >&lt;p&gt;Can you try master,&#160;You provided test case&#160;can passed since&#160;&lt;a href=&quot;https://github.com/apache/spark/pull/22205&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/22205&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16608030" author="lev" created="Sat, 8 Sep 2018 12:09:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yumwang&quot; class=&quot;user-hover&quot; rel=&quot;yumwang&quot;&gt;yumwang&lt;/a&gt; yes, the code worked as expected on the master branch&lt;br/&gt;
how do you know that the linked PR is the one that fixes the problem?&lt;/p&gt;

&lt;p&gt;Since on version 2.3, it is possible to get incorrect result,&lt;br/&gt;
I&apos;m wondering would it make sense to backport that change into the 2.3 branch&lt;/p&gt;</comment>
                            <comment id="16608079" author="q79969786" created="Sat, 8 Sep 2018 15:15:08 +0000"  >&lt;p&gt;I think the root cause is &lt;a href=&quot;https://github.com/apache/spark/pull/20155.&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/20155.&lt;/a&gt;&#160;I will fix it soon.&lt;/p&gt;</comment>
                            <comment id="16608290" author="apachespark" created="Sun, 9 Sep 2018 04:29:04 +0000"  >&lt;p&gt;User &apos;wangyum&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/22368&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/22368&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16608291" author="apachespark" created="Sun, 9 Sep 2018 04:30:06 +0000"  >&lt;p&gt;User &apos;wangyum&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/22368&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/22368&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12938810" name="plan.txt" size="3221" author="lev" created="Fri, 7 Sep 2018 12:09:09 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 10 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3xu9j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>