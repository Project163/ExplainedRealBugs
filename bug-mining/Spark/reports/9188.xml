<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:34:16 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-44717] &quot;pyspark.pandas.resample&quot; is incorrect when DST is overlapped and setting &quot;spark.sql.timestampType&quot; to TIMESTAMP_NTZ does not help</title>
                <link>https://issues.apache.org/jira/browse/SPARK-44717</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Use one of the existing test:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&quot;11H&quot; case of test_dataframe_resample (pyspark.pandas.tests.test_resample.ResampleTests)&lt;/li&gt;
	&lt;li&gt;&quot;1001H&quot; case of test_series_resample (pyspark.pandas.tests.test_resample.ResampleTests)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;After setting the TZ for example to New York (like by using the following python code in a &quot;setUpClass&quot;:  &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;os.environ[&quot;TZ&quot;] = &apos;America/New_York&apos;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;)&lt;/p&gt;

&lt;p&gt;You will get the error for the latter mentioned test:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;======================================================================
FAIL [4.219s]: test_series_resample (pyspark.pandas.tests.test_resample.ResampleTests)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/__w/spark/spark/python/pyspark/pandas/tests/test_resample.py&quot;, line 276, in test_series_resample
    self._test_resample(self.pdf3.A, self.psdf3.A, [&quot;1001H&quot;], &quot;right&quot;, &quot;right&quot;, &quot;sum&quot;)
  File &quot;/__w/spark/spark/python/pyspark/pandas/tests/test_resample.py&quot;, line 259, in _test_resample
    self.assert_eq(
  File &quot;/__w/spark/spark/python/pyspark/testing/pandasutils.py&quot;, line 457, in assert_eq
    _assert_pandas_almost_equal(lobj, robj)
  File &quot;/__w/spark/spark/python/pyspark/testing/pandasutils.py&quot;, line 228, in _assert_pandas_almost_equal
    raise PySparkAssertionError(
pyspark.errors.exceptions.base.PySparkAssertionError: [DIFFERENT_PANDAS_SERIES] Series are not almost equal:
Left:
Freq: 1001H
float64
Right:
float64
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The problem is the in the pyspark resample there will be more resampled rows in the result. The DST change will cause those extra lines as the computed _&lt;em&gt;tmp_resample_bin_col&lt;/em&gt;_ be something like:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;| __index_level_0__  | __tmp_resample_bin_col__ | A
.....
|2011-03-08 00:00:00|2011-03-26 11:00:00     |0.3980551570183919  |
|2011-03-09 00:00:00|2011-03-26 11:00:00     |0.6511376673995046  |
|2011-03-10 00:00:00|2011-03-26 11:00:00     |0.6141085426890365  |
|2011-03-11 00:00:00|2011-03-26 11:00:00     |0.11557638066163867 |
|2011-03-12 00:00:00|2011-03-26 11:00:00     |0.4517788243490799  |
|2011-03-13 00:00:00|2011-03-26 11:00:00     |0.8637060550157284  |
|2011-03-14 00:00:00|2011-03-26 10:00:00     |0.8169499149450166  |
|2011-03-15 00:00:00|2011-03-26 10:00:00     |0.4585916249356583  |
|2011-03-16 00:00:00|2011-03-26 10:00:00     |0.8362472880832088  |
|2011-03-17 00:00:00|2011-03-26 10:00:00     |0.026716901748386812|
|2011-03-18 00:00:00|2011-03-26 10:00:00     |0.9086816462089563  |
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;You can see the extra lines around when the DST kicked in on 2011-03-13 in New York.&lt;/p&gt;

&lt;p&gt;Even setting the conf &quot;spark.sql.timestampType&quot; to&quot;TIMESTAMP_NTZ&quot; does not help.&lt;/p&gt;

&lt;p&gt;You can see my tests here:&lt;br/&gt;
&lt;a href=&quot;https://github.com/attilapiros/spark/pull/5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/attilapiros/spark/pull/5&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Pandas timestamps are TZ less:&lt;br/&gt;
`&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;import pandas as pd
a = pd.Timestamp(year=2011, month=3, day=13, hour=1)
b = pd.Timedelta(hours=1)

&amp;gt;&amp;gt; a 
Timestamp(&apos;2011-03-13 01:00:00&apos;)
&amp;gt;&amp;gt;&amp;gt; a+b
Timestamp(&apos;2011-03-13 02:00:00&apos;)
&amp;gt;&amp;gt;&amp;gt; a+b+b
Timestamp(&apos;2011-03-13 03:00:00&apos;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But pyspark TimestampType uses TZ and DST:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&amp;gt;&amp;gt;&amp;gt; sql(&quot;select  TIMESTAMP &apos;2011-03-13 01:00:00&apos;&quot;).show()
+-------------------------------+
|TIMESTAMP &apos;2011-03-13 01:00:00&apos;|
+-------------------------------+
|            2011-03-13 01:00:00|
+-------------------------------+

&amp;gt;&amp;gt;&amp;gt; sql(&quot;select  TIMESTAMP &apos;2011-03-13 01:00:00&apos; + make_interval(0,0,0,0,1,0,0)&quot;).show()
+--------------------------------------------------------------------+
|TIMESTAMP &apos;2011-03-13 01:00:00&apos; + make_interval(0, 0, 0, 0, 1, 0, 0)|
+--------------------------------------------------------------------+
|                                                 2011-03-13 03:00:00|
+--------------------------------------------------------------------+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The current resample code uses the above interval based calculation.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13546451">SPARK-44717</key>
            <summary>&quot;pyspark.pandas.resample&quot; is incorrect when DST is overlapped and setting &quot;spark.sql.timestampType&quot; to TIMESTAMP_NTZ does not help</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gurwls223">Hyukjin Kwon</assignee>
                                    <reporter username="attilapiros">Attila Zsolt Piros</reporter>
                        <labels>
                    </labels>
                <created>Tue, 8 Aug 2023 04:01:53 +0000</created>
                <updated>Wed, 9 Aug 2023 02:04:12 +0000</updated>
                            <resolved>Wed, 9 Aug 2023 02:04:12 +0000</resolved>
                                    <version>3.4.0</version>
                    <version>3.4.1</version>
                    <version>4.0.0</version>
                                    <fixVersion>3.5.0</fixVersion>
                    <fixVersion>4.0.0</fixVersion>
                                    <component>Pandas API on Spark</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17751886" author="attilapiros" created="Tue, 8 Aug 2023 04:05:10 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=itholic&quot; class=&quot;user-hover&quot; rel=&quot;itholic&quot;&gt;itholic&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gurwls223&quot; class=&quot;user-hover&quot; rel=&quot;gurwls223&quot;&gt;gurwls223&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17751887" author="gurwls223" created="Tue, 8 Aug 2023 04:14:05 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=podongfeng&quot; class=&quot;user-hover&quot; rel=&quot;podongfeng&quot;&gt;podongfeng&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17751899" author="gurwls223" created="Tue, 8 Aug 2023 05:26:07 +0000"  >&lt;p&gt;I think we should at least make this respects &lt;tt&gt;spark.sql.timestampType&lt;/tt&gt; when it;s set to &lt;tt&gt;TIMESTAMP_NTZ&lt;/tt&gt;. Took a quick look, and I think there&apos;s some problem in calculation logic in &lt;a href=&quot;https://github.com/apache/spark/blob/master/python/pyspark/pandas/resample.py#L277-L310&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/master/python/pyspark/pandas/resample.py#L277-L310&lt;/a&gt; especially date_trunc returns always &lt;tt&gt;TimestampType&lt;/tt&gt;. We might need a dedicated internal expression cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=podongfeng&quot; class=&quot;user-hover&quot; rel=&quot;podongfeng&quot;&gt;podongfeng&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17751928" author="gurwls223" created="Tue, 8 Aug 2023 07:51:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=attilapiros&quot; class=&quot;user-hover&quot; rel=&quot;attilapiros&quot;&gt;attilapiros&lt;/a&gt; which time zone are you in? Would you mind trying this one below:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;select  TIMESTAMP_NTZ &lt;span class=&quot;code-quote&quot;&gt;&apos;2011-03-13 01:00:00&apos;&lt;/span&gt; + make_interval(0,0,0,0,1,0,0)&quot;&lt;/span&gt;).show()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17751962" author="attilapiros" created="Tue, 8 Aug 2023 08:54:35 +0000"  >&lt;p&gt;The TIMESTAMP_NTZ would work for sure.&lt;/p&gt;

&lt;p&gt;Here is the test:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;$ export TZ=&quot;America/New_York&quot;
$ ./bin/pyspark
....
&amp;gt;&amp;gt;&amp;gt; sql(&quot;select  TIMESTAMP_NTZ &apos;2011-03-13 01:00:00&apos; + make_interval(0,0,0,0,1,0,0)&quot;).show()

+------------------------------------------------------------------------+
|TIMESTAMP_NTZ &apos;2011-03-13 01:00:00&apos; + make_interval(0, 0, 0, 0, 1, 0, 0)|
+------------------------------------------------------------------------+
|                                                     2011-03-13 02:00:00|
+------------------------------------------------------------------------+

&amp;gt;&amp;gt;&amp;gt; sql(&quot;select  TIMESTAMP &apos;2011-03-13 01:00:00&apos; + make_interval(0,0,0,0,1,0,0)&quot;).show()
+--------------------------------------------------------------------+
|TIMESTAMP &apos;2011-03-13 01:00:00&apos; + make_interval(0, 0, 0, 0, 1, 0, 0)|
+--------------------------------------------------------------------+
|                                                 2011-03-13 03:00:00|
+--------------------------------------------------------------------+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</comment>
                            <comment id="17752006" author="gurwls223" created="Tue, 8 Aug 2023 11:17:52 +0000"  >&lt;p&gt;Made a quick fix: &lt;a href=&quot;https://github.com/apache/spark/pull/42392&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/42392&lt;/a&gt;. I believe there are other corner cases like this a lot .. but the PR fixes this one alone for now.&lt;/p&gt;</comment>
                            <comment id="17752230" author="gurwls223" created="Wed, 9 Aug 2023 02:04:12 +0000"  >&lt;p&gt;Issue resolved by pull request 42392&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/42392&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/42392&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 13 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1jn7s:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>