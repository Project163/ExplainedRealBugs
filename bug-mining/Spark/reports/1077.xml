<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:20:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-4592] &quot;Worker registration failed: Duplicate worker ID&quot; error during Master failover</title>
                <link>https://issues.apache.org/jira/browse/SPARK-4592</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;When running Spark Standalone in high-availability mode, we sometimes see &quot;Worker registration failed: Duplicate worker ID&quot; errors which prevent workers from reconnecting to the new active master.  I&apos;ve attached full logs from a reproduction in my integration tests suite (which runs something similar to Spark&apos;s FaultToleranceTest).  Here&apos;s the relevant excerpt from a worker log during a failed run of the &quot;rolling outage&quot; test, which creates a multi-master cluster then repeatedly kills the active master, waits for workers to reconnect to a new active master, then kills that master, and so on.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;14/11/23 02:23:02 INFO WorkerWebUI: Started WorkerWebUI at http:&lt;span class=&quot;code-comment&quot;&gt;//172.17.0.90:8081
&lt;/span&gt;14/11/23 02:23:02 INFO Worker: Connecting to master spark:&lt;span class=&quot;code-comment&quot;&gt;//172.17.0.86:7077...
&lt;/span&gt;14/11/23 02:23:02 INFO Worker: Connecting to master spark:&lt;span class=&quot;code-comment&quot;&gt;//172.17.0.87:7077...
&lt;/span&gt;14/11/23 02:23:02 INFO Worker: Connecting to master spark:&lt;span class=&quot;code-comment&quot;&gt;//172.17.0.88:7077...
&lt;/span&gt;14/11/23 02:23:02 INFO Worker: Successfully registered with master spark:&lt;span class=&quot;code-comment&quot;&gt;//172.17.0.86:7077
&lt;/span&gt;14/11/23 02:23:03 INFO Worker: Asked to launch executor app-20141123022303-0000/1 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; spark-integration-tests
14/11/23 02:23:03 INFO ExecutorRunner: Launch command: &lt;span class=&quot;code-quote&quot;&gt;&quot;java&quot;&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;-cp&quot;&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;::/opt/sparkconf:/opt/spark/assembly/target/scala-2.10/spark-assembly-1.2.1-SNAPSHOT-hadoop1.0.4.jar&quot;&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;-XX:MaxPermSize=128m&quot;&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;-Dspark.driver.port=51271&quot;&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;-Xms512M&quot;&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;-Xmx512M&quot;&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.spark.executor.CoarseGrainedExecutorBackend&quot;&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;akka.tcp:&lt;span class=&quot;code-comment&quot;&gt;//sparkDriver@joshs-mbp.att.net:51271/user/CoarseGrainedScheduler&quot;&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;172.17.0.90&quot;&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;8&quot;&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;app-20141123022303-0000&quot;&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;akka.tcp://sparkWorker@172.17.0.90:8888/user/Worker&quot;&lt;/span&gt;
&lt;/span&gt;14/11/23 02:23:14 INFO Worker: Disassociated [akka.tcp:&lt;span class=&quot;code-comment&quot;&gt;//sparkWorker@172.17.0.90:8888] -&amp;gt; [akka.tcp://sparkMaster@172.17.0.86:7077] Disassociated !
&lt;/span&gt;14/11/23 02:23:14 ERROR Worker: Connection to master failed! Waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; master to reconnect...
14/11/23 02:23:14 INFO Worker: Connecting to master spark:&lt;span class=&quot;code-comment&quot;&gt;//172.17.0.86:7077...
&lt;/span&gt;14/11/23 02:23:14 INFO Worker: Connecting to master spark:&lt;span class=&quot;code-comment&quot;&gt;//172.17.0.87:7077...
&lt;/span&gt;14/11/23 02:23:14 INFO Worker: Connecting to master spark:&lt;span class=&quot;code-comment&quot;&gt;//172.17.0.88:7077...
&lt;/span&gt;14/11/23 02:23:14 WARN ReliableDeliverySupervisor: Association with remote system [akka.tcp:&lt;span class=&quot;code-comment&quot;&gt;//sparkMaster@172.17.0.86:7077] has failed, address is now gated &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; [5000] ms. Reason is: [Disassociated].
&lt;/span&gt;14/11/23 02:23:14 INFO Worker: Disassociated [akka.tcp:&lt;span class=&quot;code-comment&quot;&gt;//sparkWorker@172.17.0.90:8888] -&amp;gt; [akka.tcp://sparkMaster@172.17.0.86:7077] Disassociated !
&lt;/span&gt;14/11/23 02:23:14 ERROR Worker: Connection to master failed! Waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; master to reconnect...
14/11/23 02:23:14 INFO RemoteActorRefProvider$RemoteDeadLetterActorRef: Message [org.apache.spark.deploy.DeployMessages$RegisterWorker] from Actor[akka:&lt;span class=&quot;code-comment&quot;&gt;//sparkWorker/user/Worker#-1246122173] to Actor[akka://sparkWorker/deadLetters] was not delivered. [1] dead letters encountered. This logging can be turned off or adjusted with configuration settings &lt;span class=&quot;code-quote&quot;&gt;&apos;akka.log-dead-letters&apos;&lt;/span&gt; and &lt;span class=&quot;code-quote&quot;&gt;&apos;akka.log-dead-letters-during-shutdown&apos;&lt;/span&gt;.
&lt;/span&gt;14/11/23 02:23:14 INFO Worker: Not spawning another attempt to register with the master, since there is an attempt scheduled already.
14/11/23 02:23:14 INFO LocalActorRef: Message [akka.remote.transport.ActorTransportAdapter$DisassociateUnderlying] from Actor[akka:&lt;span class=&quot;code-comment&quot;&gt;//sparkWorker/deadLetters] to Actor[akka://sparkWorker/system/transports/akkaprotocolmanager.tcp0/akkaProtocol-tcp%3A%2F%2FsparkMaster%40172.17.0.86%3A7077-2#343365613] was not delivered. [2] dead letters encountered. This logging can be turned off or adjusted with configuration settings &lt;span class=&quot;code-quote&quot;&gt;&apos;akka.log-dead-letters&apos;&lt;/span&gt; and &lt;span class=&quot;code-quote&quot;&gt;&apos;akka.log-dead-letters-during-shutdown&apos;&lt;/span&gt;.
&lt;/span&gt;14/11/23 02:23:25 INFO Worker: Retrying connection to master (attempt # 1)
14/11/23 02:23:25 INFO Worker: Connecting to master spark:&lt;span class=&quot;code-comment&quot;&gt;//172.17.0.86:7077...
&lt;/span&gt;14/11/23 02:23:25 INFO Worker: Connecting to master spark:&lt;span class=&quot;code-comment&quot;&gt;//172.17.0.87:7077...
&lt;/span&gt;14/11/23 02:23:25 INFO Worker: Connecting to master spark:&lt;span class=&quot;code-comment&quot;&gt;//172.17.0.88:7077...
&lt;/span&gt;14/11/23 02:23:36 INFO Worker: Retrying connection to master (attempt # 2)
14/11/23 02:23:36 INFO Worker: Connecting to master spark:&lt;span class=&quot;code-comment&quot;&gt;//172.17.0.86:7077...
&lt;/span&gt;14/11/23 02:23:36 INFO Worker: Connecting to master spark:&lt;span class=&quot;code-comment&quot;&gt;//172.17.0.87:7077...
&lt;/span&gt;14/11/23 02:23:36 INFO Worker: Connecting to master spark:&lt;span class=&quot;code-comment&quot;&gt;//172.17.0.88:7077...
&lt;/span&gt;14/11/23 02:23:42 INFO Worker: Master has changed, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; master is at spark:&lt;span class=&quot;code-comment&quot;&gt;//172.17.0.87:7077
&lt;/span&gt;14/11/23 02:23:47 INFO Worker: Retrying connection to master (attempt # 3)
14/11/23 02:23:47 INFO Worker: Connecting to master spark:&lt;span class=&quot;code-comment&quot;&gt;//172.17.0.86:7077...
&lt;/span&gt;14/11/23 02:23:47 INFO Worker: Connecting to master spark:&lt;span class=&quot;code-comment&quot;&gt;//172.17.0.87:7077...
&lt;/span&gt;14/11/23 02:23:47 INFO Worker: Connecting to master spark:&lt;span class=&quot;code-comment&quot;&gt;//172.17.0.88:7077...
&lt;/span&gt;14/11/23 02:23:47 ERROR Worker: Worker registration failed: Duplicate worker ID
14/11/23 02:23:47 INFO ExecutorRunner: Killing process!
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12757621">SPARK-4592</key>
            <summary>&quot;Worker registration failed: Duplicate worker ID&quot; error during Master failover</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="andrewor14">Andrew Or</assignee>
                                    <reporter username="joshrosen">Josh Rosen</reporter>
                        <labels>
                    </labels>
                <created>Tue, 25 Nov 2014 06:13:05 +0000</created>
                <updated>Tue, 25 Nov 2014 23:47:22 +0000</updated>
                            <resolved>Tue, 25 Nov 2014 23:47:22 +0000</resolved>
                                    <version>1.2.0</version>
                                    <fixVersion>1.2.0</fixVersion>
                                    <component>Deploy</component>
                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14224108" author="joshrosen" created="Tue, 25 Nov 2014 06:15:05 +0000"  >&lt;p&gt;It looks like this is a bug that was introduced in &lt;a href=&quot;https://github.com/apache/spark/pull/2828&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;the patch&lt;/a&gt; for &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-3736&quot; title=&quot;Workers should reconnect to Master if disconnected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-3736&quot;&gt;&lt;del&gt;SPARK-3736&lt;/del&gt;&lt;/a&gt;.  Prior to that patch, a worker that became disassociated from a master would wait for a master to initiate a reconnection.  This behavior caused problems when a master failed by stopping and restarting, since the restarted master would never know to initiate a reconnection.  That patch addressed this issue by having workers attempt to reconnect to the master if they think they&apos;ve become disconnected.  When reviewing that patch, I wrote a &lt;a href=&quot;https://github.com/apache/spark/pull/2828#issuecomment-59602394&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;long comment&lt;/a&gt; that explains it in much more detail; that&apos;s a good reference for understanding its motivation.&lt;/p&gt;

&lt;p&gt;This change introduced a problem, though: there&apos;s now a race-condition during multi-master failover.  In the old multi-master code, a worker never initiates a reconnection attempt to a master; instead, it reconnects after the new active / primary master tells the worker that it&apos;s the new master.  With the addition of worker-initiated reconnect, there&apos;s a race-condition where the worker detects that it&apos;s become disconnected, goes down the list of known masters and tries to connect to each of them, successfully connects to the new primary master, then receives a &lt;tt&gt;ChangedMaster&lt;/tt&gt; event and attempts to connect to the new primary master &lt;em&gt;even though it&apos;s already connected&lt;/em&gt;, causing a duplicate worker registration.&lt;/p&gt;

&lt;p&gt;There are a number of ways that we might fix this, but we have to be careful because it seems likely that the worker-initiated reconnect could have introduced other problems:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;What happens if a worker sends a reconnection attempt to a live master which is not the new primary?  Will that non-primary master reject or redirect those registrations, or will it register the workers and cause a split-brain scenario to occur?&lt;/li&gt;
	&lt;li&gt;The Worker is implemented as an actor and thus does not have synchronization of its internal state since it assumes message-at-a-time processing, but the asynchronous re-registration timer thread may violate this assumption because it directly calls internal worker methods instead of sending messages to the worker&apos;s own mailbox.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;One simple fix might be to have the worker never initiate reconnection attempts when running in a multi-master environment.  I still need to think through whether this will cause new problems similar to &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-3736&quot; title=&quot;Workers should reconnect to Master if disconnected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-3736&quot;&gt;&lt;del&gt;SPARK-3736&lt;/del&gt;&lt;/a&gt;.  I don&apos;t think it will be a problem because that patch was motivated by cases where the master forgot who the worker was and couldn&apos;t initiate a reconnect.  If the list of registered workers is stored durably in ZooKeeper such that a worker is never told that it has registered until a record of its registration has become durable, then I think this is fine: if a live master thinks that a worker has disconnected, then it will initiate a reconnection; when a new master fails over, it will reconnect all workers based on the list from ZooKeeper. &lt;/p&gt;</comment>
                            <comment id="14224184" author="apachespark" created="Tue, 25 Nov 2014 08:10:02 +0000"  >&lt;p&gt;User &apos;andrewor14&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/3447&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/3447&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14224194" author="andrewor14" created="Tue, 25 Nov 2014 08:15:27 +0000"  >&lt;p&gt;I submitted a fix at &lt;a href=&quot;https://github.com/apache/spark/pull/3447&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/3447&lt;/a&gt;. For more detail, please read the message there. It should be noted that even this fix is still subject to more obscure race conditions. For instance:&lt;/p&gt;

&lt;p&gt;1. Master A dies, worker tries to reconnect&lt;br/&gt;
2. Master B comes up and notifies worker&lt;br/&gt;
3. Master A comes back up, and worker successfully re-registers with Master A&lt;br/&gt;
4. Worker additionally receives the notification from Master B, and now it listens to both masters&lt;/p&gt;

&lt;p&gt;As noted in the PR description, these race conditions are much less likely than the one this issue is trying to fix.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12704633">SPARK-981</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12683491" name="log.txt" size="52602" author="joshrosen" created="Tue, 25 Nov 2014 06:15:50 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i22r27:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12327369">1.2.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>