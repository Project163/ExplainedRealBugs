<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:29:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-6785] DateUtils can not handle date before 1970/01/01 correctly</title>
                <link>https://issues.apache.org/jira/browse/SPARK-6785</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;scala&amp;gt; val d = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Date(100)
d: java.sql.Date = 1969-12-31

scala&amp;gt; DateUtils.toJavaDate(DateUtils.fromJavaDate(d))
res1: java.sql.Date = 1970-01-01

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12819481">SPARK-6785</key>
            <summary>DateUtils can not handle date before 1970/01/01 correctly</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ckadner">Christian Kadner</assignee>
                                    <reporter username="davies">Davies Liu</reporter>
                        <labels>
                    </labels>
                <created>Wed, 8 Apr 2015 22:33:56 +0000</created>
                <updated>Fri, 29 Jul 2016 03:01:08 +0000</updated>
                            <resolved>Tue, 30 Jun 2015 19:23:11 +0000</resolved>
                                                    <fixVersion>1.5.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14542697" author="ckadner" created="Wed, 13 May 2015 20:54:40 +0000"  >&lt;p&gt;Hi Patrick,&lt;br/&gt;
I would like to work on this issue. Seems like the date conversion is thrown off by the time-zone adjustments and the fact that the interchange type is days instead of millis. I am preparing a pull-request which will also include test cases to cover more date conversion scenarios.&lt;/p&gt;
</comment>
                            <comment id="14548584" author="apachespark" created="Mon, 18 May 2015 19:18:02 +0000"  >&lt;p&gt;User &apos;ckadner&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/6236&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/6236&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14549123" author="apachespark" created="Mon, 18 May 2015 20:14:02 +0000"  >&lt;p&gt;User &apos;ckadner&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/6242&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/6242&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14549366" author="ckadner" created="Mon, 18 May 2015 22:15:38 +0000"  >&lt;div class=&quot;panel&quot; style=&quot;background-color: #FFFFCE;border-color: #ccc;border-style: dashed;border-width: 1px;&quot;&gt;&lt;div class=&quot;panelContent&quot; style=&quot;background-color: #FFFFCE;&quot;&gt;
&lt;p&gt;Pull Request &lt;ins&gt;&lt;a href=&quot;https://github.com/apache/spark/pull/6242&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;6242&lt;/a&gt;&lt;/ins&gt;&lt;/p&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;br class=&quot;atl-forced-newline&quot; /&gt;
Before my fix, the from-and-to Java date conversion of dates before 1970 will only work for &lt;tt&gt;java.sql.Date&lt;/tt&gt; objects that reflect a date and time exactly at midnight in the System&apos;s local time zone. &lt;br/&gt;
Otherwise, if the Date&apos;s time is just one millisecond before or after midnight, the result of the above conversion will be offset by one day for Dates before 1970 because of a rounding (truncation) flaw in the function &lt;tt&gt;DateUtils.millisToDays(Long):Int&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&lt;br class=&quot;atl-forced-newline&quot; /&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  scala&amp;gt; val df = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SimpleDateFormat(&lt;span class=&quot;code-quote&quot;&gt;&quot;yyyy-MM-dd HH:mm:ss&quot;&lt;/span&gt;)
  df: java.text.SimpleDateFormat = yyyy-MM-dd HH:mm:ss

  scala&amp;gt; val d1 = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Date(df.parse(&lt;span class=&quot;code-quote&quot;&gt;&quot;1969-01-01 00:00:00&quot;&lt;/span&gt;).getTime)
  d2: java.sql.Date = 1969-01-01
	
  scala&amp;gt; val d2 = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Date(df.parse(&lt;span class=&quot;code-quote&quot;&gt;&quot;1969-01-01 00:00:01&quot;&lt;/span&gt;).getTime)
  d2: java.sql.Date = 1969-01-01

  scala&amp;gt; DateUtils.toJavaDate(DateUtils.fromJavaDate(d1))
  res1: java.sql.Date = 1969-01-01
	
  scala&amp;gt; DateUtils.toJavaDate(DateUtils.fromJavaDate(d2))
  res2: java.sql.Date = 1969-01-02
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;br class=&quot;atl-forced-newline&quot; /&gt;&lt;/p&gt;

&lt;p&gt;What is the code doing and how to fix it:&lt;/p&gt;

&lt;p&gt;&lt;br class=&quot;atl-forced-newline&quot; /&gt;&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;A &lt;tt&gt;java.util.Date&lt;/tt&gt; is represented by milliseconds (&lt;tt&gt;Long&lt;/tt&gt;) since the Epoch (1970/01/01 0:00:00 GMT) with positive numbers for dates after and negative numbers for dates before 1970&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The function &lt;tt&gt;DateUtils.fromJavaDate(java.util.Date):Int&lt;/tt&gt; calculates the number of full days passed since 1970/01/01 00:00:00 (local time, not UTC), but by using the data type &lt;tt&gt;Long&lt;/tt&gt; (as opposed to &lt;tt&gt;Double&lt;/tt&gt;) when  converting milliseconds to days it essentially truncates the fractional part of days passed (disregarding the impact of hours, minutes, seconds)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The function &lt;tt&gt;DateUtils.toJavaDate(Int):Date&lt;/tt&gt; converts the given number of days into milliseconds and adds it 1970/01/01 00:00:00 (local time, not UTC)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;em&gt;Side note: The time-zone offset from UTC is factored in when converting a Date to days and removed when converting days to Date, so the time-zone shifting is neutralized in the round-trip conversion &lt;tt&gt;toJavaDate(fromJavaDate(java.util.Date))&lt;/tt&gt;.&lt;/em&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The truncation of partial days is not a problem for dates after 1970 since adding a fraction of a day to any date will not flip the calendar to the next day (since all our Dates start 0:00:00 AM)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;That truncation of partial days however is a problem when subtracting even a second from a &lt;tt&gt;Date&lt;/tt&gt; with time at 0:00:00 AM which should turn the calender back one day to the previous date&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Ideally the date conversion should be done using milliseconds, but since using days has been established already, the fix is to work with &lt;tt&gt;Double&lt;/tt&gt; to preserve fractions of days and use &lt;tt&gt;floor()&lt;/tt&gt; instead of the implicit truncate to round to a full number of days (&lt;tt&gt;Int&lt;/tt&gt;)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;br class=&quot;atl-forced-newline&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Pseudo-code example, adding or subtracting 1 hour to Date &quot;1970/01/01 0:00:00&quot; using milliseconds...&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;1970-01-01 0:00:00&quot;&lt;/span&gt; + 1 hr = &lt;span class=&quot;code-quote&quot;&gt;&quot;1970-01-01  1:00:00&quot;&lt;/span&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;1970-01-01 0:00:00&quot;&lt;/span&gt; - 1 hr = &lt;span class=&quot;code-quote&quot;&gt;&quot;1969-12-31 23:00:00&quot;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;br class=&quot;atl-forced-newline&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Same example, using full days. One hour is about 0.04 days. Using &lt;tt&gt;trunc()&lt;/tt&gt; versus &lt;tt&gt;floor()&lt;/tt&gt; we get ...  &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;trunc(+0.04) = +0  --&amp;gt;  &lt;span class=&quot;code-quote&quot;&gt;&quot;1970-01-01&quot;&lt;/span&gt; + 0 days = &lt;span class=&quot;code-quote&quot;&gt;&quot;1970-01-01&quot;&lt;/span&gt;    (correct)
floor(+0.04) = +0  --&amp;gt;  &lt;span class=&quot;code-quote&quot;&gt;&quot;1970-01-01&quot;&lt;/span&gt; + 0 days = &lt;span class=&quot;code-quote&quot;&gt;&quot;1970-01-01&quot;&lt;/span&gt;    (correct)

trunc(-0.04) = -0  --&amp;gt;  &lt;span class=&quot;code-quote&quot;&gt;&quot;1970-01-01&quot;&lt;/span&gt; + -0 days = &lt;span class=&quot;code-quote&quot;&gt;&quot;1970-01-01&quot;&lt;/span&gt;   (incorrect, bug)
floor(-0.04) = -1  --&amp;gt;  &lt;span class=&quot;code-quote&quot;&gt;&quot;1970-01-01&quot;&lt;/span&gt; + -1 day  = &lt;span class=&quot;code-quote&quot;&gt;&quot;1969-12-31&quot;&lt;/span&gt;   (correct, fix)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; 
def trunc(d: Dounble): Int = d.toInt
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14599278" author="apachespark" created="Wed, 24 Jun 2015 11:38:06 +0000"  >&lt;p&gt;User &apos;ckadner&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/6983&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/6983&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14608903" author="marmbrus" created="Tue, 30 Jun 2015 19:23:11 +0000"  >&lt;p&gt;Issue resolved by pull request 6983&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/6983&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/6983&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12993430">SPARK-16788</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 20 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2d00v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311620" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Shepherd</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>marmbrus</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12332078">1.5.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>