<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:48:50 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-18269] NumberFormatException when reading csv for a nullable column</title>
                <link>https://issues.apache.org/jira/browse/SPARK-18269</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Having a schema with a nullable column thrown an java.lang.NumberFormatException: null when the data + delimeter isn&apos;t specified in the csv.&lt;/p&gt;

&lt;p&gt;Specifying the schema:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;StructType(Array(
  StructField(&lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;, IntegerType, nullable = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;),
  StructField(&lt;span class=&quot;code-quote&quot;&gt;&quot;underlyingId&quot;&lt;/span&gt;, IntegerType, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
))
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Data (without trailing delimeter to specify the second column):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Read the data:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;sparkSession.read
    .schema(sourceSchema)
    .option(&lt;span class=&quot;code-quote&quot;&gt;&quot;header&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&quot;&lt;/span&gt;)
    .option(&lt;span class=&quot;code-quote&quot;&gt;&quot;delimiter&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;&quot;&quot;\t&quot;&lt;/span&gt;&quot;&quot;)
    .csv(files(dates): _*)
    .rdd
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Actual Result: &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.NumberFormatException: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.parseInt(&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.java:542)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.parseInt(&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.java:615)
	at scala.collection.immutable.StringLike$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;toInt(StringLike.scala:272)
	at scala.collection.immutable.StringOps.toInt(StringOps.scala:29)
	at org.apache.spark.sql.execution.datasources.csv.CSVTypeCast$.castTo(CSVInferSchema.scala:244)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Reason:&lt;br/&gt;
The csv line is parsed into a Map (indexSafeTokens), which is short of one value. So indexSafeTokens(index) throws a NullpointerException reading the optional value which isn&apos;t in the Map.&lt;/p&gt;

&lt;p&gt;The NullpointerException is then given to the CSVTypeCast.castTo(datum: String, .....) as the datum value.&lt;br/&gt;
The subsequent NumberFormatException is thrown due to the fact that a NullpointerException cannot be cast into the Type.&lt;/p&gt;

&lt;p&gt;Possible fix:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Use the provided schema to parse the line with the correct number of columns&lt;/li&gt;
	&lt;li&gt;Since its nullable implement a try catch on CSVRelation.csvParser indexSafeTokens(index)&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="13018026">SPARK-18269</key>
            <summary>NumberFormatException when reading csv for a nullable column</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gurwls223">Hyukjin Kwon</assignee>
                                    <reporter username="jzijlstra">Jork Zijlstra</reporter>
                        <labels>
                    </labels>
                <created>Fri, 4 Nov 2016 10:44:26 +0000</created>
                <updated>Mon, 12 Dec 2022 18:10:45 +0000</updated>
                            <resolved>Mon, 7 Nov 2016 02:51:30 +0000</resolved>
                                    <version>2.0.1</version>
                                    <fixVersion>2.1.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15636055" author="gurwls223" created="Fri, 4 Nov 2016 11:18:14 +0000"  >&lt;p&gt;Could you try set &lt;tt&gt;nullValue&lt;/tt&gt; to &lt;tt&gt;&quot;null&quot;&lt;/tt&gt;?&lt;/p&gt;</comment>
                            <comment id="15636069" author="gurwls223" created="Fri, 4 Nov 2016 11:24:22 +0000"  >&lt;p&gt;BTW, if I remember this correctly, it seems always forcing the schema to nullable for reading data with file-based data sources (except structured streaming) as you described in &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-18270&quot; title=&quot;Users schema with non-nullable properties is overidden with true&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-18270&quot;&gt;&lt;del&gt;SPARK-18270&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15636192" author="jzijlstra" created="Fri, 4 Nov 2016 12:22:06 +0000"  >&lt;p&gt;The error that is thrown is java.lang.NumberFormatException: null. In this case null is a NullPointerException and not the value &quot;null&quot;.&lt;br/&gt;
I did try this before submitting this issue but having the value &quot;null&quot; as nullValue doesn&apos;t work since &quot;null&quot; != NullPointerException.&lt;/p&gt;

&lt;p&gt;Apparently putting a NullpointerException in a parameter of type String works.&lt;/p&gt;</comment>
                            <comment id="15636353" author="gurwls223" created="Fri, 4 Nov 2016 13:39:25 +0000"  >&lt;p&gt;Ah, yes. it seems a bug. I can reproduce this. Thanks for correcting me. It will be a quicky fix. Please let me submit a PR.&lt;/p&gt;</comment>
                            <comment id="15636407" author="apachespark" created="Fri, 4 Nov 2016 13:59:07 +0000"  >&lt;p&gt;User &apos;HyukjinKwon&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/15767&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/15767&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15712431" author="jzijlstra" created="Thu, 1 Dec 2016 16:40:39 +0000"  >&lt;p&gt;Thanks for the quick response. Eagerly awaiting the spark 2.1 release.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 50 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i35v6f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>