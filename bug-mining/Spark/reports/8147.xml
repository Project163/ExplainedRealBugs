<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:27:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-36327] Spark sql creates staging dir inside database directory rather than creating inside table directory</title>
                <link>https://issues.apache.org/jira/browse/SPARK-36327</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Spark sql creates staging dir inside database directory rather than creating inside table directory.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This arises only when viewfs:// is configured. When the location is hdfs://, it doesn&apos;t occur.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Based on further investigation in file&#160;&lt;b&gt;SaveAsHiveFile.scala&lt;/b&gt;, I could see that the directory hierarchy has been not properly handled for viewFS condition.&lt;br/&gt;
Parent path(db path) is passed rather than passing the actual directory(table location).&lt;/p&gt;

&lt;p&gt;{{&lt;br/&gt;
// Mostly copied from Context.java#getExternalTmpPath of Hive 1.2&lt;br/&gt;
private def newVersionExternalTempPath(&lt;br/&gt;
path: Path,&lt;br/&gt;
hadoopConf: Configuration,&lt;br/&gt;
stagingDir: String): Path = {&lt;br/&gt;
val extURI: URI = path.toUri&lt;br/&gt;
if (extURI.getScheme == &quot;viewfs&quot;)&lt;/p&gt;

{ getExtTmpPathRelTo(path.getParent, hadoopConf, stagingDir) }

&lt;p&gt;else&lt;/p&gt;

{ new Path(getExternalScratchDir(extURI, hadoopConf, stagingDir), &quot;-ext-10000&quot;) }

&lt;p&gt;}&lt;br/&gt;
}}&lt;/p&gt;

&lt;p&gt;Please refer below lines&lt;/p&gt;

&lt;p&gt;===============================&lt;br/&gt;
if (extURI.getScheme == &quot;viewfs&quot;) {&lt;br/&gt;
getExtTmpPathRelTo(path.getParent, hadoopConf, stagingDir)&lt;br/&gt;
===============================&lt;/p&gt;</description>
                <environment></environment>
        <key id="13392292">SPARK-36327</key>
            <summary>Spark sql creates staging dir inside database directory rather than creating inside table directory</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="senthh">Senthil Kumar</assignee>
                                    <reporter username="senthh">Senthil Kumar</reporter>
                        <labels>
                    </labels>
                <created>Wed, 28 Jul 2021 08:50:40 +0000</created>
                <updated>Fri, 27 Aug 2021 19:59:20 +0000</updated>
                            <resolved>Fri, 27 Aug 2021 19:59:20 +0000</resolved>
                                    <version>3.1.2</version>
                                    <fixVersion>3.3.0</fixVersion>
                                    <component>Spark Core</component>
                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17388597" author="senthh" created="Wed, 28 Jul 2021 08:52:11 +0000"  >&lt;p&gt;Shall I work on this Jira to fix this issue?&lt;/p&gt;</comment>
                            <comment id="17389814" author="senthh" created="Thu, 29 Jul 2021 11:04:01 +0000"  >&lt;p&gt;Created PR&#160;&lt;a href=&quot;https://github.com/apache/spark/pull/33577&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/33577&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17389815" author="apachespark" created="Thu, 29 Jul 2021 11:04:14 +0000"  >&lt;p&gt;User &apos;senthh&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/33577&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/33577&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17389817" author="apachespark" created="Thu, 29 Jul 2021 11:04:50 +0000"  >&lt;p&gt;User &apos;senthh&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/33577&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/33577&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17389827" author="senthh" created="Thu, 29 Jul 2021 11:24:18 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dongjoon&quot; class=&quot;user-hover&quot; rel=&quot;dongjoon&quot;&gt;dongjoon&lt;/a&gt;,&#160; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hyukjin.kwon&quot; class=&quot;user-hover&quot; rel=&quot;hyukjin.kwon&quot;&gt;hyukjin.kwon&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Could you please review these minor changes?&#160;&lt;/p&gt;</comment>
                            <comment id="17390358" author="dongjoon" created="Fri, 30 Jul 2021 07:21:49 +0000"  >&lt;p&gt;I commented on the PR and looped other review, too. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=senthh&quot; class=&quot;user-hover&quot; rel=&quot;senthh&quot;&gt;senthh&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17390851" author="senthh" created="Sat, 31 Jul 2021 03:35:42 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sunchao&quot; class=&quot;user-hover&quot; rel=&quot;sunchao&quot;&gt;sunchao&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Hive is creating .staging directories inside &quot;/db/table&quot; location but Spark-sql creates .staging directories inside /db/&quot; location when we use hadoop federation(viewFs). But works as expected (creating .staging inside /db/table/ location for other filesystems like hdfs).&lt;/p&gt;

&lt;p&gt;HIVE:&lt;br/&gt;
{{&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;beeline&lt;br/&gt;
&amp;gt; use dicedb;&lt;br/&gt;
&amp;gt; insert into table part_test partition (j=1) values (1);&lt;br/&gt;
...&lt;br/&gt;
INFO : Loading data to table dicedb.part_test partition (j=1) from *&lt;b&gt;viewfs://cloudera/user/daisuke/dicedb/part_test/j=1/.hive-staging_hive_2021-07-19_13-04-44_989_6775328876605030677-1/-ext-10000&lt;/b&gt;*&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;}}&lt;/p&gt;

&lt;p&gt;but spark&apos;s behaviour,&lt;/p&gt;

&lt;p&gt;{{&lt;br/&gt;
spark-sql&amp;gt; use dicedb;&lt;br/&gt;
spark-sql&amp;gt; insert into table part_test partition (j=2) values (2);&lt;br/&gt;
21/07/19 13:07:37 INFO FileUtils: Creating directory if it doesn&apos;t exist: *&lt;b&gt;viewfs://cloudera/user/daisuke/dicedb/.hive-staging_hive_2021-07-19_13-07-37_317_5083528872437596950-1&lt;/b&gt;*&lt;br/&gt;
... &lt;br/&gt;
}}&lt;/p&gt;


&lt;p&gt;The reason why we require this change is , if we allow spark-sql to create .staging directory inside /db/ location then we will end-up with security issues. We need to provide permission for &quot;viewfs:///db/&quot; location to all users who submit spark jobs.&lt;/p&gt;

&lt;p&gt;After this change is applied spark-sql creates .staging inside /db/table/, similar to hive, as below,&lt;/p&gt;

&lt;p&gt;{{&lt;br/&gt;
spark-sql&amp;gt; use dicedb;&lt;br/&gt;
21/07/28 00:22:47 INFO SparkSQLCLIDriver: Time taken: 0.929 seconds&lt;br/&gt;
spark-sql&amp;gt; insert into table part_test partition (j=8) values (8);&lt;br/&gt;
21/07/28 00:23:25 INFO HiveMetaStoreClient: Closed a connection to metastore, current connections: 1&lt;br/&gt;
21/07/28 00:23:26 INFO FileUtils: Creating directory if it doesn&apos;t exist: *&lt;b&gt;viewfs://cloudera/user/daisuke/dicedb/part_test/.hive-staging_hive_2021-07-28_00-23-26_109_4548714524589026450-1&lt;/b&gt;* &lt;br/&gt;
}}&lt;/p&gt;

&lt;p&gt;The reason why we don&apos;t see this issue in Hive but only occurs in Spark-sql:&lt;/p&gt;

&lt;p&gt;In hive, &quot;/db/table/tmp&quot; directory structure is passed for path and hence path.getParent returns &quot;db/table/&quot; . But in Spark we just pass &quot;/db/table&quot; so it is not required to use &quot;path.getParent&quot; for hadoop federation(viewfs)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17406008" author="dongjoon" created="Fri, 27 Aug 2021 19:59:20 +0000"  >&lt;p&gt;Issue resolved by pull request 33577&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/33577&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/33577&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10431"><![CDATA[Important]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 11 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0teg0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>