<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:50:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-19093] Cached tables are not used in SubqueryExpression</title>
                <link>https://issues.apache.org/jira/browse/SPARK-19093</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;See reproduction at &lt;a href=&quot;https://databricks-prod-cloudfront.cloud.databricks.com/public/4027ec902e239c93eaaa8714f173bcfc/1903098128019500/2699761537338853/1395282846718893/latest.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://databricks-prod-cloudfront.cloud.databricks.com/public/4027ec902e239c93eaaa8714f173bcfc/1903098128019500/2699761537338853/1395282846718893/latest.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Consider the following:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Seq((&lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;b&quot;&lt;/span&gt;), (&lt;span class=&quot;code-quote&quot;&gt;&quot;c&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;d&quot;&lt;/span&gt;))
  .toDS
  .write
  .parquet(&lt;span class=&quot;code-quote&quot;&gt;&quot;/tmp/rows&quot;&lt;/span&gt;)

val df = spark.read.parquet(&lt;span class=&quot;code-quote&quot;&gt;&quot;/tmp/rows&quot;&lt;/span&gt;)
df.cache()
df.count()
df.createOrReplaceTempView(&lt;span class=&quot;code-quote&quot;&gt;&quot;rows&quot;&lt;/span&gt;)

spark.sql(&quot;&quot;&quot;
  select * from rows cross join rows
&quot;&quot;&quot;).explain(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)

spark.sql(&quot;&quot;&quot;
  select * from rows where not exists (select * from rows)
&quot;&quot;&quot;).explain(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In both plans, I&apos;d expect that both sides of the joins would read from the cached table for both the cross join and anti join, but the left anti join produces the following plan which only reads the left side from cache and reads the right side via a regular non-cahced scan:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;== Parsed Logical Plan ==
&apos;Project [*]
+- &apos;Filter NOT exists#3994
   :  +- &apos;Project [*]
   :     +- &apos;UnresolvedRelation `rows`
   +- &apos;UnresolvedRelation `rows`

== Analyzed Logical Plan ==
_1: string, _2: string
Project [_1#3775, _2#3776]
+- Filter NOT predicate-subquery#3994 []
   :  +- Project [_1#3775 AS _1#3775#4001, _2#3776 AS _2#3776#4002]
   :     +- Project [_1#3775, _2#3776]
   :        +- SubqueryAlias rows
   :           +- Relation[_1#3775,_2#3776] parquet
   +- SubqueryAlias rows
      +- Relation[_1#3775,_2#3776] parquet

== Optimized Logical Plan ==
Join LeftAnti
:- InMemoryRelation [_1#3775, _2#3776], &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, 10000, StorageLevel(disk, memory, deserialized, 1 replicas)
:     +- *FileScan parquet [_1#3775,_2#3776] Batched: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, Format: Parquet, Location: InMemoryFileIndex[dbfs:/tmp/rows], PartitionFilters: [], PushedFilters: [], ReadSchema: struct&amp;lt;_1:string,_2:string&amp;gt;
+- Project [_1#3775 AS _1#3775#4001, _2#3776 AS _2#3776#4002]
   +- Relation[_1#3775,_2#3776] parquet

== Physical Plan ==
BroadcastNestedLoopJoin BuildRight, LeftAnti
:- InMemoryTableScan [_1#3775, _2#3776]
:     +- InMemoryRelation [_1#3775, _2#3776], &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, 10000, StorageLevel(disk, memory, deserialized, 1 replicas)
:           +- *FileScan parquet [_1#3775,_2#3776] Batched: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, Format: Parquet, Location: InMemoryFileIndex[dbfs:/tmp/rows], PartitionFilters: [], PushedFilters: [], ReadSchema: struct&amp;lt;_1:string,_2:string&amp;gt;
+- BroadcastExchange IdentityBroadcastMode
   +- *Project [_1#3775 AS _1#3775#4001, _2#3776 AS _2#3776#4002]
      +- *FileScan parquet [_1#3775,_2#3776] Batched: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, Format: Parquet, Location: InMemoryFileIndex[dbfs:/tmp/rows], PartitionFilters: [], PushedFilters: [], ReadSchema: struct&amp;lt;_1:string,_2:string&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13032427">SPARK-19093</key>
            <summary>Cached tables are not used in SubqueryExpression</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dkbiswal">Dilip Biswal</assignee>
                                    <reporter username="joshrosen">Josh Rosen</reporter>
                        <labels>
                    </labels>
                <created>Fri, 6 Jan 2017 00:42:36 +0000</created>
                <updated>Fri, 17 Mar 2017 02:59:38 +0000</updated>
                            <resolved>Sun, 8 Jan 2017 22:10:01 +0000</resolved>
                                    <version>2.0.2</version>
                    <version>2.1.0</version>
                                    <fixVersion>2.1.1</fixVersion>
                    <fixVersion>2.2.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15803374" author="smilegator" created="Fri, 6 Jan 2017 03:18:58 +0000"  >&lt;p&gt;uh, this might be related to the subquery resolution.&lt;/p&gt;</comment>
                            <comment id="15803623" author="joshrosen" created="Fri, 6 Jan 2017 05:32:16 +0000"  >&lt;p&gt;I&apos;m not sure whether that&apos;s the case because I seemed to observe the cache resolving when using subqueries for regular joins. We should play around with it and see, though.&lt;/p&gt;</comment>
                            <comment id="15803647" author="smilegator" created="Fri, 6 Jan 2017 05:45:38 +0000"  >&lt;p&gt;Let me try to do more investigation in this. &lt;/p&gt;</comment>
                            <comment id="15803703" author="smilegator" created="Fri, 6 Jan 2017 06:16:02 +0000"  >&lt;p&gt;Yes. The relation in `PlanExpression` is not replaced by the cached relation. Do you want to fix it by yourself?&lt;/p&gt;</comment>
                            <comment id="15803709" author="joshrosen" created="Fri, 6 Jan 2017 06:19:54 +0000"  >&lt;p&gt;I&apos;m a bit too busy with other work to tackle this right now, so this is up for grabs in case you&apos;d like to work on it.&lt;/p&gt;

&lt;p&gt;To be clear, I guess the bug here impacts SubqueryExpression rather than LeftAntiJoin specifically? If so, I should go ahead and update the JIRA description to be a bit clearer.&lt;/p&gt;</comment>
                            <comment id="15803716" author="smilegator" created="Fri, 6 Jan 2017 06:23:15 +0000"  >&lt;p&gt;Yes. It is not related to LeftAntiJoin. It is in SubqueryExpression.&lt;/p&gt;

&lt;p&gt;My teammate or I will take it. Thanks!&lt;/p&gt;</comment>
                            <comment id="15803732" author="smilegator" created="Fri, 6 Jan 2017 06:30:41 +0000"  >&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;  /** Replaces segments of the given logical plan with cached versions where possible. */
  def useCachedData(plan: LogicalPlan): LogicalPlan = {
    plan transformDown {
      case currentFragment =&amp;gt;
        lookupCachedData(currentFragment)
          .map(_.cachedRepresentation.withOutput(currentFragment.output))
          .getOrElse(currentFragment)
    }
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The above function needs to consider the &lt;tt&gt;subqueryExpression&lt;/tt&gt;. &lt;/p&gt;</comment>
                            <comment id="15806285" author="apachespark" created="Sat, 7 Jan 2017 00:34:05 +0000"  >&lt;p&gt;User &apos;dilipbiswal&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/16493&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/16493&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 45 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i38c13:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>