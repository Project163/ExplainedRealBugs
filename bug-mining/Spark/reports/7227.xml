<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:17:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-29683] Job failed due to executor failures all available nodes are blacklisted</title>
                <link>https://issues.apache.org/jira/browse/SPARK-29683</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;My streaming job will fail &lt;b&gt;due to executor failures all available nodes are blacklisted&lt;/b&gt;. This exception is thrown only when all node is blacklisted:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
def isAllNodeBlacklisted: &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt; = currentBlacklistedYarnNodes.size &amp;gt;= numClusterNodes

val allBlacklistedNodes = excludeNodes ++ schedulerBlacklist ++ allocatorBlacklist.keySet
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;After diving into the code, I found some critical conditions not be handled properly:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;unchecked `excludeNodes`: it comes from user config. If not set properly, it may lead to &quot;currentBlacklistedYarnNodes.size &amp;gt;= numClusterNodes&quot;. For example, we may set some nodes not in Yarn cluster.
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
excludeNodes = (invalid1, invalid2, invalid3)
clusterNodes = (valid1, valid2)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;`numClusterNodes` may equals 0: When HA Yarn failover, it will take some time for all NodeManagers to register ResourceManager again. In this case, `numClusterNode` may equals 0 or some other number, and Spark driver failed.&lt;/li&gt;
	&lt;li&gt;too strong condition check: Spark driver will fail as long as &quot;currentBlacklistedYarnNodes.size &amp;gt;= numClusterNodes&quot;. This condition should not indicate a unrecovered fatal. For example, there are some NodeManagers restarting. So we can give some waiting time before job failed.&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="13265491">SPARK-29683</key>
            <summary>Job failed due to executor failures all available nodes are blacklisted</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="uncleGen">Genmao Yu</reporter>
                        <labels>
                    </labels>
                <created>Thu, 31 Oct 2019 09:35:34 +0000</created>
                <updated>Tue, 1 Nov 2022 03:08:45 +0000</updated>
                            <resolved>Tue, 1 Nov 2022 03:08:45 +0000</resolved>
                                    <version>3.0.0</version>
                                    <fixVersion>3.1.1</fixVersion>
                                    <component>Spark Core</component>
                    <component>YARN</component>
                        <due></due>
                            <votes>4</votes>
                                    <watches>13</watches>
                                                                                                                <comments>
                            <comment id="16967188" author="steven rand" created="Tue, 5 Nov 2019 03:12:09 +0000"  >&lt;p&gt;We&apos;re experiencing this as well during HA YARN failover.&lt;/p&gt;</comment>
                            <comment id="17121061" author="apachespark" created="Mon, 1 Jun 2020 14:47:03 +0000"  >&lt;p&gt;User &apos;cnZach&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/28606&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/28606&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17223929" author="dongwook" created="Fri, 30 Oct 2020 22:09:30 +0000"  >&lt;p&gt;I agree with Genmao, these logics that added by &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-16630&quot; title=&quot;Blacklist a node if executors won&amp;#39;t launch on it.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-16630&quot;&gt;&lt;del&gt;SPARK-16630&lt;/del&gt;&lt;/a&gt;&#160;is too strong condition to make application fail.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
def isAllNodeBlacklisted: &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt; = currentBlacklistedYarnNodes.size &amp;gt;= numClusterNodes
val allBlacklistedNodes = excludeNodes ++ schedulerBlacklist ++ allocatorBlacklist.keySet
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I think the above logic would work only for partial failure or intermittent issue that numClusterNodes isn&apos;t changed, in case of a scheduler or allocator failure become permanent failure that ResourceManager has to remove from its pool which numClusterNodes is changed, the above logic could fail.&lt;/p&gt;

&lt;p&gt;e.g) let&apos;s say a cluster has 2 NodeManagers(numClusterNodes = 2), and one NodeManager(N1) has the some issues that cause scheduling failures which ends up increasing schedulerBlacklist.size to 1, and later N1 can&apos;t recover from ResourceManager&apos;s perspective due to a hardware failure or decommissioned by operator or any other ways, in this case numClusterNodes becomes 1 which makes isAllNodeBlacklisted true, even if there is still 1 NodeManager available and &quot;spark.yarn.blacklist.executor.launch.blacklisting.enabled&quot; set to false&lt;/p&gt;

&lt;p&gt;Particularly in cloud environment, resizing of cluster happens all the times, for long-running spark application with many resize operations of cluster, schedulerBlacklist.size could keep increasing while numClusterNodes keep fluctuated, in addition even if&#160;currentBlacklistedYarnNodes.size &amp;gt;= numClusterNodes is true case, there could be new nodes would be added quickly.&#160;&lt;/p&gt;

&lt;p&gt;I found&#160;&lt;a href=&quot;https://github.com/apache/spark/commit/e70df2cea46f71461d8d401a420e946f999862c1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;e70df2cea46f71461d8d401a420e946f999862c1&lt;/a&gt; was added to handle the case of numClusterNode = 0.&lt;/p&gt;

&lt;p&gt;However for other cases as mentioned in this JIRA, I think just removing the following part from &lt;a href=&quot;https://github.com/apache/spark/blob/branch-2.4/resource-managers/yarn/src/main/scala/org/apache/spark/deploy/yarn/ApplicationMaster.scala#L535-L538&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ApplicationMaster&lt;/a&gt;&#160;would more make sense, because isAllNodeBlackListed doesn&apos;t necessarily mean running application needs to fail.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (allocator.isAllNodeBlacklisted) {
 finish(FinalApplicationStatus.FAILED,
 ApplicationMaster.EXIT_MAX_EXECUTOR_FAILURES,
 &lt;span class=&quot;code-quote&quot;&gt;&quot;Due to executor failures all available nodes are blacklisted&quot;&lt;/span&gt;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Or at least the above condition should apply as optional with&#160;&quot;spark.yarn.blacklist.executor.launch.blacklisting.enabled&quot; or some new configuration because &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-16630&quot; title=&quot;Blacklist a node if executors won&amp;#39;t launch on it.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-16630&quot;&gt;&lt;del&gt;SPARK-16630&lt;/del&gt;&lt;/a&gt;&#160;added as optional but the above logic impact regardless of any configuration.&lt;/p&gt;

&lt;p&gt;I wonder other&apos;s opinion about this.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17363055" author="djanand" created="Mon, 14 Jun 2021 16:22:57 +0000"  >&lt;p&gt;Facing the same issue with 3.0.1 with streaming:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Application Report :
Application-Id : application_123934893489289_0001
Application-Name : yyyyy
Application-Type : SPARK
User : livy
Queue : default
Application Priority : 0
Start-Time : 1622842590806
Finish-Time : 1623111223883
Progress : 100%
State : FINISHED
Final-State : FAILED
Tracking-URL : ip-xx.ec2.internal:18080/history/application_1123934893489289_0001/3
RPC Port : 36535
AM Host : ip-10-160-98-55.ec2.internal
Aggregate Resource Allocation : 41388024201 MB-seconds, 2854390 vcore-seconds
Aggregate Resource Preempted : 0 MB-seconds, 0 vcore-seconds
Log Aggregation Status : TIME_OUT
Diagnostics : Due to executor failures all available nodes are blacklisted
Unmanaged Application : false
Application Node Label Expression : &amp;lt;Not set&amp;gt;
AM container Node Label Expression : &amp;lt;DEFAULT_PARTITION&amp;gt;
TimeoutType : LIFETIME	ExpiryTime : UNLIMITED	RemainingTime : -1seconds
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Is there a workaround or any updates on this?&lt;/p&gt;</comment>
                            <comment id="17467921" author="apachespark" created="Mon, 3 Jan 2022 10:48:19 +0000"  >&lt;p&gt;User &apos;sungpeo&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/35089&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/35089&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17467924" author="apachespark" created="Mon, 3 Jan 2022 10:49:42 +0000"  >&lt;p&gt;User &apos;sungpeo&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/35089&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/35089&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17626884" author="attilapiros" created="Tue, 1 Nov 2022 00:23:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srowen&quot; class=&quot;user-hover&quot; rel=&quot;srowen&quot;&gt;srowen&lt;/a&gt; I think we can close this as this commit solved the issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/commit/e70df2cea46f71461d8d401a420e946f999862c1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/commit/e70df2cea46f71461d8d401a420e946f999862c1&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;What do you think?&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="12990894">SPARK-16630</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 2 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z084mw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>