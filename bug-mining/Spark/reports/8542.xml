<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:30:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-39448] Add ReplaceCTERefWithRepartition into nonExcludableRules list</title>
                <link>https://issues.apache.org/jira/browse/SPARK-39448</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;A unit test to test excluded rules:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-scala&quot;&gt;
/*
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed &lt;span class=&quot;code-keyword&quot;&gt;with&lt;/span&gt;
 * &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; work &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; additional information regarding copyright ownership.
 * The ASF licenses &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; file to You under the Apache License, Version 2.0
 * (the &lt;span class=&quot;code-quote&quot;&gt;&quot;License&quot;&lt;/span&gt;); you may not use &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; file except in compliance &lt;span class=&quot;code-keyword&quot;&gt;with&lt;/span&gt;
 * the License.  You may obtain a copy of the License at
 *
 *    http:&lt;span class=&quot;code-comment&quot;&gt;//www.apache.org/licenses/LICENSE-2.0
&lt;/span&gt; *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &lt;span class=&quot;code-quote&quot;&gt;&quot;AS IS&quot;&lt;/span&gt; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the specific language governing permissions and
 * limitations under the License.
 */
&lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt; org.apache.spark.sql

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.internal.config.Tests.IS_TESTING
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.launcher.SparkLauncher
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.sql.catalyst.util.resourceToString
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.sql.internal.SQLConf

&lt;span class=&quot;code-comment&quot;&gt;// scalastyle:off println
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;object&lt;/span&gt; ExcludedRulesTestSuite &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; TPCDSBase {
  &lt;span class=&quot;code-keyword&quot;&gt;override&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; spark = SparkSession.builder()
    .appName(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.getClass.getSimpleName)
    .master(&lt;span class=&quot;code-quote&quot;&gt;&quot;local[40]&quot;&lt;/span&gt;)
    .config(SparkLauncher.DRIVER_MEMORY, &lt;span class=&quot;code-quote&quot;&gt;&quot;4g&quot;&lt;/span&gt;)
    .config(SQLConf.SHUFFLE_PARTITIONS.key, 2)
    .getOrCreate()

  &lt;span class=&quot;code-keyword&quot;&gt;override&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;def&lt;/span&gt; injectStats: Boolean = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;

  createTables()

  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;lazy&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; excludableRules = spark.sessionState.optimizer.batches
    .flatMap(_.rules.map(_.ruleName))
    .distinct
    .filterNot(spark.sessionState.optimizer.nonExcludableRules.contains)

  &lt;span class=&quot;code-keyword&quot;&gt;def&lt;/span&gt; main(args: Array[String]): Unit = {
    System.setProperty(IS_TESTING.key, &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;)

    tpcdsQueries.foreach { name =&amp;gt;
      &lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; queryString = resourceToString(s&lt;span class=&quot;code-quote&quot;&gt;&quot;tpcds/$name.sql&quot;&lt;/span&gt;,
        classLoader = Thread.currentThread().getContextClassLoader)
      excludableRules.foreach { rule =&amp;gt;

        println(name + &lt;span class=&quot;code-quote&quot;&gt;&quot;: &quot;&lt;/span&gt; + rule)
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
          withSQLConf(SQLConf.OPTIMIZER_EXCLUDED_RULES.key -&amp;gt; rule) {
            sql(queryString).collect()
          }
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; {
          &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; e: Exception =&amp;gt;
            println(&lt;span class=&quot;code-quote&quot;&gt;&quot;Exception: &quot;&lt;/span&gt; + e.getMessage)
        }
      }
    }

    tpcdsQueriesV2_7_0.foreach { name =&amp;gt;
      &lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; queryString = resourceToString(s&lt;span class=&quot;code-quote&quot;&gt;&quot;tpcds-v2.7.0/$name.sql&quot;&lt;/span&gt;,
        classLoader = Thread.currentThread().getContextClassLoader)
      excludableRules.foreach { rule =&amp;gt;

        println(&lt;span class=&quot;code-quote&quot;&gt;&quot;tpcds-v2.7.0 &quot;&lt;/span&gt; + name + &lt;span class=&quot;code-quote&quot;&gt;&quot;: &quot;&lt;/span&gt; + rule)
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
          withSQLConf(SQLConf.OPTIMIZER_EXCLUDED_RULES.key -&amp;gt; rule) {
            sql(queryString).collect()
          }
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; {
          &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; e: Exception =&amp;gt;
            println(&lt;span class=&quot;code-quote&quot;&gt;&quot;Exception: &quot;&lt;/span&gt; + e.getMessage)
        }
      }
    }

    modifiedTPCDSQueries.foreach { name =&amp;gt;
      &lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; queryString = resourceToString(s&lt;span class=&quot;code-quote&quot;&gt;&quot;tpcds-modifiedQueries/$name.sql&quot;&lt;/span&gt;,
        classLoader = Thread.currentThread().getContextClassLoader)
      excludableRules.foreach { rule =&amp;gt;

        println(&lt;span class=&quot;code-quote&quot;&gt;&quot;tpcds-modifiedQueries &quot;&lt;/span&gt; + name + &lt;span class=&quot;code-quote&quot;&gt;&quot;: &quot;&lt;/span&gt; + rule)
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
          withSQLConf(SQLConf.OPTIMIZER_EXCLUDED_RULES.key -&amp;gt; rule) {
            sql(queryString).collect()
          }
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; {
          &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; e: Exception =&amp;gt;
            println(&lt;span class=&quot;code-quote&quot;&gt;&quot;Exception: &quot;&lt;/span&gt; + e.getMessage)
        }
      }
    }

    &lt;span class=&quot;code-comment&quot;&gt;// scalastyle:on println
&lt;/span&gt;  }
}

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13449623">SPARK-39448</key>
            <summary>Add ReplaceCTERefWithRepartition into nonExcludableRules list</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yumwang">Yuming Wang</assignee>
                                    <reporter username="yumwang">Yuming Wang</reporter>
                        <labels>
                    </labels>
                <created>Sat, 11 Jun 2022 13:26:01 +0000</created>
                <updated>Tue, 14 Jun 2022 07:44:11 +0000</updated>
                            <resolved>Tue, 14 Jun 2022 07:43:48 +0000</resolved>
                                    <version>3.3.0</version>
                    <version>3.4.0</version>
                                    <fixVersion>3.3.1</fixVersion>
                    <fixVersion>3.4.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17553111" author="apachespark" created="Sat, 11 Jun 2022 13:40:31 +0000"  >&lt;p&gt;User &apos;wangyum&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/36847&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/36847&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17553112" author="apachespark" created="Sat, 11 Jun 2022 13:41:14 +0000"  >&lt;p&gt;User &apos;wangyum&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/36847&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/36847&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17553362" author="dongjoon" created="Mon, 13 Jun 2022 01:42:24 +0000"  >&lt;p&gt;This occurs in the same in 3.3.0 RC6.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
scala&amp;gt; spark.version
val res0: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; = 3.3.0

scala&amp;gt; sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;set spark.sql.optimizer.excludedRules=org.apache.spark.sql.catalyst.optimizer.ReplaceCTERefWithRepartition&quot;&lt;/span&gt;)
val res1: org.apache.spark.sql.DataFrame = [key: string, value: string]

scala&amp;gt; sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT (SELECT avg(id) FROM range(10)),(SELECT sum(id) FROM range(10)),(SELECT count(distinct id) FROM range(10))&quot;&lt;/span&gt;).show
warning: 1 deprecation (since 2.13.3); &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; details, enable `:setting -deprecation` or `:replay -deprecation`
org.apache.spark.SparkException: The Spark SQL phase planning failed with an internal error. Please, fill a bug report in, and provide the full stack trace. &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17553951" author="dongjoon" created="Tue, 14 Jun 2022 07:43:48 +0000"  >&lt;p&gt;Issue resolved by pull request 36847&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/36847&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/36847&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 22 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z135qw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>