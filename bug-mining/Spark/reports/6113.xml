<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:02:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-25837] Web UI does not respect spark.ui.retainedJobs in some instances</title>
                <link>https://issues.apache.org/jira/browse/SPARK-25837</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Expected Behavior: Web UI only displays 1 completed job and remains responsive.&lt;/p&gt;

&lt;p&gt;Actual Behavior: Both during job execution and&#160;following all job completion for some non short amount of time&#160;the UI retains many completed jobs, causing limited responsiveness.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;To reproduce:&lt;/p&gt;

&lt;p&gt;&#160;&lt;br/&gt;
 &amp;gt;&#160;spark-shell --conf spark.ui.retainedJobs=1&lt;br/&gt;
 &#160;&lt;br/&gt;
 scala&amp;gt; import scala.concurrent._&lt;br/&gt;
 scala&amp;gt; import scala.concurrent.ExecutionContext.Implicits.global&lt;br/&gt;
 scala&amp;gt; for (i &amp;lt;- 0 until 50000) { Future&lt;/p&gt;

{ println(sc.parallelize(0 until i).collect.length) }

&lt;p&gt;}&lt;br/&gt;
 &#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The attached screenshot shows the state of the webui after running the repro code, you can see the ui is displaying some 43k completed jobs (takes a long time to load) after a few minutes of inactivity this will clear out, however&#160;in an application which continues to submit jobs every once in a while, the issue persists.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The issue seems to appear when running multiple jobs at once as well as in sequence for a while and may as well have something to do with high master CPU usage (thus the collect in the repro code). My rough guess would be whatever is managing clearing out completed jobs gets overwhelmed (on the master during repro htop reported almost full CPU usage across all 4 cores).&lt;/p&gt;</description>
                <environment>&lt;p&gt;Reproduction Environment:&lt;/p&gt;

&lt;p&gt;Spark 2.3.1&lt;/p&gt;

&lt;p&gt;Dataproc 1.3-deb9&lt;/p&gt;

&lt;p&gt;1x master&#160;4 vCPUs, 15 GB&lt;/p&gt;

&lt;p&gt;2x workers&#160;4 vCPUs, 15 GB&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</environment>
        <key id="13194199">SPARK-25837</key>
            <summary>Web UI does not respect spark.ui.retainedJobs in some instances</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="patrick.brown">Patrick Brown</assignee>
                                    <reporter username="patrick.brown">Patrick Brown</reporter>
                        <labels>
                    </labels>
                <created>Thu, 25 Oct 2018 17:10:56 +0000</created>
                <updated>Mon, 18 Mar 2019 11:05:18 +0000</updated>
                            <resolved>Thu, 1 Nov 2018 16:41:34 +0000</resolved>
                                    <version>2.3.1</version>
                                    <fixVersion>2.3.3</fixVersion>
                    <fixVersion>2.4.1</fixVersion>
                    <fixVersion>3.0.0</fixVersion>
                                    <component>Web UI</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16664051" author="patrick.brown" created="Thu, 25 Oct 2018 17:28:19 +0000"  >&lt;p&gt;I would be interested and happy to tackle this, if its an issue that the community agrees should be addressed.&lt;/p&gt;</comment>
                            <comment id="16667646" author="patrick.brown" created="Mon, 29 Oct 2018 19:39:17 +0000"  >&lt;p&gt;The fundamental problem seems to be in AppStatusLisener in the cleanupStages method.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Using the repro code above it appears that sometimes (not always) stages and tasks get slightly backed up. When this occurs the iteration through tasks starts taking longer and longer:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
val tasks = kvstore.view(classOf[TaskDataWrapper])
 .index(&lt;span class=&quot;code-quote&quot;&gt;&quot;stage&quot;&lt;/span&gt;)
 .first(key)
 .last(key)
 .asScala&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;


&lt;p&gt;This seems to be because for each stage we are then iterating through all the tasks (of which there can be ~400k in this repro code), which can go from taking ~10ms before the back up to ~300ms afterwards due to the large number of tasks. This causes a feedback loop in which the `cleanupStages` method cannot keep up.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16667707" author="apachespark" created="Mon, 29 Oct 2018 20:25:04 +0000"  >&lt;p&gt;User &apos;patrickbrownsync&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/22883&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/22883&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16671846" author="vanzin" created="Thu, 1 Nov 2018 16:41:34 +0000"  >&lt;p&gt;Issue resolved by pull request 22883&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/22883&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/22883&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16794932" author="xiaojuwu" created="Mon, 18 Mar 2019 11:05:18 +0000"  >&lt;p&gt;Did you verify this fix with the reproduce case above? I tried and found the issue is still there: the cleanup was still backed up but better than the version without this fix.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13205147">SPARK-26395</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12945622" name="Screen Shot 2018-10-23 at 4.40.51 PM (1).png" size="566579" author="patrick.brown" created="Thu, 25 Oct 2018 17:11:22 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 35 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3zn6n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>