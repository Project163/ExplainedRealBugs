<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:04:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-26961] Found Java-level deadlock in Spark Driver</title>
                <link>https://issues.apache.org/jira/browse/SPARK-26961</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Our spark job usually will finish in minutes, however, we recently found it take days to run, and we can only kill it when this happened.&lt;/p&gt;

&lt;p&gt;An investigation&#160;show all worker container could not connect drive after start, and driver is hanging, using jstack, we&#160;found a Java-level deadlock.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Jstack output for deadlock part is showing below:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Found one Java-level deadlock:&lt;br/&gt;
=============================&lt;br/&gt;
&quot;SparkUI-907&quot;:&lt;br/&gt;
 waiting to lock monitor 0x00007f387761b398 (object 0x00000005c0c1e5e0, a org.apache.hadoop.conf.Configuration),&lt;br/&gt;
 which is held by &quot;ForkJoinPool-1-worker-57&quot;&lt;br/&gt;
&quot;ForkJoinPool-1-worker-57&quot;:&lt;br/&gt;
 waiting to lock monitor 0x00007f3860574298 (object 0x00000005b7991168, a org.apache.spark.util.MutableURLClassLoader),&lt;br/&gt;
 which is held by &quot;ForkJoinPool-1-worker-7&quot;&lt;br/&gt;
&quot;ForkJoinPool-1-worker-7&quot;:&lt;br/&gt;
 waiting to lock monitor 0x00007f387761b398 (object 0x00000005c0c1e5e0, a org.apache.hadoop.conf.Configuration),&lt;br/&gt;
 which is held by &quot;ForkJoinPool-1-worker-57&quot;&lt;/p&gt;

&lt;p&gt;Java stack information for the threads listed above:&lt;br/&gt;
===================================================&lt;br/&gt;
&quot;SparkUI-907&quot;:&lt;br/&gt;
 at org.apache.hadoop.conf.Configuration.getOverlay(Configuration.java:1328)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;waiting to lock &amp;lt;0x00000005c0c1e5e0&amp;gt; (a org.apache.hadoop.conf.Configuration)&lt;br/&gt;
 at org.apache.hadoop.conf.Configuration.handleDeprecation(Configuration.java:684)&lt;br/&gt;
 at org.apache.hadoop.conf.Configuration.get(Configuration.java:1088)&lt;br/&gt;
 at org.apache.hadoop.conf.Configuration.getTrimmed(Configuration.java:1145)&lt;br/&gt;
 at org.apache.hadoop.conf.Configuration.getClass(Configuration.java:2363)&lt;br/&gt;
 at org.apache.hadoop.fs.FileSystem.getFileSystemClass(FileSystem.java:2840)&lt;br/&gt;
 at org.apache.hadoop.fs.FsUrlStreamHandlerFactory.createURLStreamHandler(FsUrlStreamHandlerFactory.java:74)&lt;br/&gt;
 at java.net.URL.getURLStreamHandler(URL.java:1142)&lt;br/&gt;
 at java.net.URL.&amp;lt;init&amp;gt;(URL.java:599)&lt;br/&gt;
 at java.net.URL.&amp;lt;init&amp;gt;(URL.java:490)&lt;br/&gt;
 at java.net.URL.&amp;lt;init&amp;gt;(URL.java:439)&lt;br/&gt;
 at org.apache.spark.ui.JettyUtils$$anon$4.doRequest(JettyUtils.scala:176)&lt;br/&gt;
 at org.apache.spark.ui.JettyUtils$$anon$4.doGet(JettyUtils.scala:161)&lt;br/&gt;
 at javax.servlet.http.HttpServlet.service(HttpServlet.java:687)&lt;br/&gt;
 at javax.servlet.http.HttpServlet.service(HttpServlet.java:790)&lt;br/&gt;
 at org.spark_project.jetty.servlet.ServletHolder.handle(ServletHolder.java:848)&lt;br/&gt;
 at org.spark_project.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1772)&lt;br/&gt;
 at org.apache.hadoop.yarn.server.webproxy.amfilter.AmIpFilter.doFilter(AmIpFilter.java:171)&lt;br/&gt;
 at org.spark_project.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1759)&lt;br/&gt;
 at org.spark_project.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:582)&lt;br/&gt;
 at org.spark_project.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1180)&lt;br/&gt;
 at org.spark_project.jetty.servlet.ServletHandler.doScope(ServletHandler.java:512)&lt;br/&gt;
 at org.spark_project.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1112)&lt;br/&gt;
 at org.spark_project.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:141)&lt;br/&gt;
 at org.spark_project.jetty.server.handler.gzip.GzipHandler.handle(GzipHandler.java:493)&lt;br/&gt;
 at org.spark_project.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:213)&lt;br/&gt;
 at org.spark_project.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:134)&lt;br/&gt;
 at org.spark_project.jetty.server.Server.handle(Server.java:534)&lt;br/&gt;
 at org.spark_project.jetty.server.HttpChannel.handle(HttpChannel.java:320)&lt;br/&gt;
 at org.spark_project.jetty.server.HttpConnection.onFillable(HttpConnection.java:251)&lt;br/&gt;
 at org.spark_project.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:283)&lt;br/&gt;
 at org.spark_project.jetty.io.FillInterest.fillable(FillInterest.java:108)&lt;br/&gt;
 at org.spark_project.jetty.io.SelectChannelEndPoint$2.run(SelectChannelEndPoint.java:93)&lt;br/&gt;
 at org.spark_project.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:671)&lt;br/&gt;
 at org.spark_project.jetty.util.thread.QueuedThreadPool$2.run(QueuedThreadPool.java:589)&lt;br/&gt;
 at java.lang.Thread.run(Thread.java:748)&lt;br/&gt;
&quot;ForkJoinPool-1-worker-57&quot;:&lt;br/&gt;
 at java.lang.ClassLoader.loadClass(ClassLoader.java:404)&lt;/li&gt;
	&lt;li&gt;waiting to lock &amp;lt;0x00000005b7991168&amp;gt; (a org.apache.spark.util.MutableURLClassLoader)&lt;br/&gt;
 at java.lang.ClassLoader.loadClass(ClassLoader.java:357)&lt;br/&gt;
 at org.apache.xerces.parsers.ObjectFactory.findProviderClass(Unknown Source)&lt;br/&gt;
 at org.apache.xerces.parsers.ObjectFactory.newInstance(Unknown Source)&lt;br/&gt;
 at org.apache.xerces.parsers.ObjectFactory.createObject(Unknown Source)&lt;br/&gt;
 at org.apache.xerces.parsers.ObjectFactory.createObject(Unknown Source)&lt;br/&gt;
 at org.apache.xerces.parsers.DOMParser.&amp;lt;init&amp;gt;(Unknown Source)&lt;br/&gt;
 at org.apache.xerces.parsers.DOMParser.&amp;lt;init&amp;gt;(Unknown Source)&lt;br/&gt;
 at org.apache.xerces.jaxp.DocumentBuilderImpl.&amp;lt;init&amp;gt;(Unknown Source)&lt;br/&gt;
 at org.apache.xerces.jaxp.DocumentBuilderFactoryImpl.newDocumentBuilder(Unknown Source)&lt;br/&gt;
 at org.apache.hadoop.conf.Configuration.loadResource(Configuration.java:2737)&lt;br/&gt;
 at org.apache.hadoop.conf.Configuration.loadResources(Configuration.java:2696)&lt;br/&gt;
 at org.apache.hadoop.conf.Configuration.getProps(Configuration.java:2579)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x00000005c0c1e5e0&amp;gt; (a org.apache.hadoop.conf.Configuration)&lt;br/&gt;
 at org.apache.hadoop.conf.Configuration.get(Configuration.java:1091)&lt;br/&gt;
 at org.apache.hadoop.conf.Configuration.getTrimmed(Configuration.java:1145)&lt;br/&gt;
 at org.apache.hadoop.conf.Configuration.getClass(Configuration.java:2363)&lt;br/&gt;
 at org.apache.hadoop.fs.FileSystem.getFileSystemClass(FileSystem.java:2840)&lt;br/&gt;
 at org.apache.hadoop.fs.FsUrlStreamHandlerFactory.createURLStreamHandler(FsUrlStreamHandlerFactory.java:74)&lt;br/&gt;
 at java.net.URL.getURLStreamHandler(URL.java:1142)&lt;br/&gt;
 at java.net.URL.&amp;lt;init&amp;gt;(URL.java:599)&lt;br/&gt;
 at java.net.URL.&amp;lt;init&amp;gt;(URL.java:490)&lt;br/&gt;
 at java.net.URL.&amp;lt;init&amp;gt;(URL.java:439)&lt;br/&gt;
 at java.net.JarURLConnection.parseSpecs(JarURLConnection.java:175)&lt;br/&gt;
 at java.net.JarURLConnection.&amp;lt;init&amp;gt;(JarURLConnection.java:158)&lt;br/&gt;
 at sun.net.www.protocol.jar.JarURLConnection.&amp;lt;init&amp;gt;(JarURLConnection.java:81)&lt;br/&gt;
 at sun.net.www.protocol.jar.Handler.openConnection(Handler.java:41)&lt;br/&gt;
 at java.net.URL.openConnection(URL.java:979)&lt;br/&gt;
 at java.net.URL.openStream(URL.java:1045)&lt;br/&gt;
 at java.util.ServiceLoader.parse(ServiceLoader.java:304)&lt;br/&gt;
 at java.util.ServiceLoader.access$200(ServiceLoader.java:185)&lt;br/&gt;
 at java.util.ServiceLoader$LazyIterator.hasNextService(ServiceLoader.java:357)&lt;br/&gt;
 at java.util.ServiceLoader$LazyIterator.hasNext(ServiceLoader.java:393)&lt;br/&gt;
 at java.util.ServiceLoader$1.hasNext(ServiceLoader.java:474)&lt;br/&gt;
 at scala.collection.convert.Wrappers$JIteratorWrapper.hasNext(Wrappers.scala:42)&lt;br/&gt;
 at scala.collection.Iterator$class.foreach(Iterator.scala:893)&lt;br/&gt;
 at scala.collection.AbstractIterator.foreach(Iterator.scala:1336)&lt;br/&gt;
 at scala.collection.IterableLike$class.foreach(IterableLike.scala:72)&lt;br/&gt;
 at scala.collection.AbstractIterable.foreach(Iterable.scala:54)&lt;br/&gt;
 at scala.collection.TraversableLike$class.filterImpl(TraversableLike.scala:247)&lt;br/&gt;
 at scala.collection.TraversableLike$class.filter(TraversableLike.scala:259)&lt;br/&gt;
 at scala.collection.AbstractTraversable.filter(Traversable.scala:104)&lt;br/&gt;
 at org.apache.spark.sql.execution.datasources.DataSource$.lookupDataSource(DataSource.scala:614)&lt;br/&gt;
 at org.apache.spark.sql.DataFrameReader.load(DataFrameReader.scala:190)&lt;br/&gt;
 at org.apache.spark.sql.DataFrameReader.load(DataFrameReader.scala:174)&lt;br/&gt;
 at com.amazon.economics.spark.dq.io.SanjuroDataRegistryData$class.readInstance(SanjuroDataRegistryData.scala:16)&lt;br/&gt;
 at com.amazon.economics.spark.dq.metrics.DifferenceRatioMetricSuite.readInstance(DifferenceRatioMetricSuite.scala:19)&lt;br/&gt;
 at com.amazon.economics.spark.dq.metrics.ComparisonStandardProvider$class.loadComparisonStandardInstance(ComparisonStandardProvider.scala:21)&lt;br/&gt;
 at com.amazon.economics.spark.dq.metrics.DifferenceRatioMetricSuite.loadComparisonStandardInstance(DifferenceRatioMetricSuite.scala:19)&lt;br/&gt;
 at com.amazon.economics.spark.dq.metrics.DifferenceRatioMetricSuite.compute(DifferenceRatioMetricSuite.scala:35)&lt;br/&gt;
 at com.amazon.economics.spark.dq.MetricsTaskRunner$$anonfun$run$1$$anonfun$1$$anonfun$apply$1$$anonfun$apply$2.apply(MetricsTaskRunner.scala:41)&lt;br/&gt;
 at com.amazon.economics.spark.dq.MetricsTaskRunner$$anonfun$run$1$$anonfun$1$$anonfun$apply$1$$anonfun$apply$2.apply(MetricsTaskRunner.scala:39)&lt;br/&gt;
 at scala.util.Try$.apply(Try.scala:192)&lt;br/&gt;
 at com.amazon.economics.spark.dq.MetricsTaskRunner$$anonfun$run$1$$anonfun$1$$anonfun$apply$1.apply(MetricsTaskRunner.scala:39)&lt;br/&gt;
 at com.amazon.economics.spark.dq.MetricsTaskRunner$$anonfun$run$1$$anonfun$1$$anonfun$apply$1.apply(MetricsTaskRunner.scala:32)&lt;br/&gt;
 at scala.collection.parallel.AugmentedIterableIterator$class.map2combiner(RemainsIterator.scala:115)&lt;br/&gt;
 at scala.collection.parallel.immutable.ParVector$ParVectorIterator.map2combiner(ParVector.scala:62)&lt;br/&gt;
 at scala.collection.parallel.ParIterableLike$Map.leaf(ParIterableLike.scala:1054)&lt;br/&gt;
 at scala.collection.parallel.Task$$anonfun$tryLeaf$1.apply$mcV$sp(Tasks.scala:49)&lt;br/&gt;
 at scala.collection.parallel.Task$$anonfun$tryLeaf$1.apply(Tasks.scala:48)&lt;br/&gt;
 at scala.collection.parallel.Task$$anonfun$tryLeaf$1.apply(Tasks.scala:48)&lt;br/&gt;
 at scala.collection.parallel.Task$class.tryLeaf(Tasks.scala:51)&lt;br/&gt;
 at scala.collection.parallel.ParIterableLike$Map.tryLeaf(ParIterableLike.scala:1051)&lt;br/&gt;
 at scala.collection.parallel.AdaptiveWorkStealingTasks$WrappedTask$class.compute(Tasks.scala:152)&lt;br/&gt;
 at scala.collection.parallel.AdaptiveWorkStealingForkJoinTasks$WrappedTask.compute(Tasks.scala:443)&lt;br/&gt;
 at scala.concurrent.forkjoin.RecursiveAction.exec(RecursiveAction.java:160)&lt;br/&gt;
 at scala.concurrent.forkjoin.ForkJoinTask.doExec(ForkJoinTask.java:260)&lt;br/&gt;
 at scala.concurrent.forkjoin.ForkJoinPool$WorkQueue.runTask(ForkJoinPool.java:1339)&lt;br/&gt;
 at scala.concurrent.forkjoin.ForkJoinPool.runWorker(ForkJoinPool.java:1979)&lt;br/&gt;
 at scala.concurrent.forkjoin.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:107)&lt;br/&gt;
&quot;ForkJoinPool-1-worker-7&quot;:&lt;br/&gt;
 at org.apache.hadoop.conf.Configuration.getOverlay(Configuration.java:1328)&lt;/li&gt;
	&lt;li&gt;waiting to lock &amp;lt;0x00000005c0c1e5e0&amp;gt; (a org.apache.hadoop.conf.Configuration)&lt;br/&gt;
 at org.apache.hadoop.conf.Configuration.handleDeprecation(Configuration.java:684)&lt;br/&gt;
 at org.apache.hadoop.conf.Configuration.get(Configuration.java:1088)&lt;br/&gt;
 at org.apache.hadoop.conf.Configuration.getTrimmed(Configuration.java:1145)&lt;br/&gt;
 at org.apache.hadoop.conf.Configuration.getClass(Configuration.java:2363)&lt;br/&gt;
 at org.apache.hadoop.fs.FileSystem.getFileSystemClass(FileSystem.java:2840)&lt;br/&gt;
 at org.apache.hadoop.fs.FsUrlStreamHandlerFactory.createURLStreamHandler(FsUrlStreamHandlerFactory.java:74)&lt;br/&gt;
 at java.net.URL.getURLStreamHandler(URL.java:1142)&lt;br/&gt;
 at java.net.URL.&amp;lt;init&amp;gt;(URL.java:420)&lt;br/&gt;
 at sun.misc.URLClassPath$JarLoader.&amp;lt;init&amp;gt;(URLClassPath.java:812)&lt;br/&gt;
 at sun.misc.URLClassPath$JarLoader$3.run(URLClassPath.java:1094)&lt;br/&gt;
 at sun.misc.URLClassPath$JarLoader$3.run(URLClassPath.java:1091)&lt;br/&gt;
 at java.security.AccessController.doPrivileged(Native Method)&lt;br/&gt;
 at sun.misc.URLClassPath$JarLoader.getResource(URLClassPath.java:1090)&lt;br/&gt;
 at sun.misc.URLClassPath$JarLoader.getResource(URLClassPath.java:1050)&lt;br/&gt;
 at sun.misc.URLClassPath.getResource(URLClassPath.java:239)&lt;br/&gt;
 at java.net.URLClassLoader$1.run(URLClassLoader.java:365)&lt;br/&gt;
 at java.net.URLClassLoader$1.run(URLClassLoader.java:362)&lt;br/&gt;
 at java.security.AccessController.doPrivileged(Native Method)&lt;br/&gt;
 at java.net.URLClassLoader.findClass(URLClassLoader.java:361)&lt;br/&gt;
 at java.lang.ClassLoader.loadClass(ClassLoader.java:424)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x00000005b7991168&amp;gt; (a org.apache.spark.util.MutableURLClassLoader)&lt;br/&gt;
 at java.lang.ClassLoader.loadClass(ClassLoader.java:357)&lt;br/&gt;
 at java.lang.Class.forName0(Native Method)&lt;br/&gt;
 at java.lang.Class.forName(Class.java:348)&lt;br/&gt;
 at scala.reflect.runtime.JavaMirrors$JavaMirror.javaClass(JavaMirrors.scala:555)&lt;br/&gt;
 at scala.reflect.runtime.JavaMirrors$JavaMirror.tryJavaClass(JavaMirrors.scala:559)&lt;br/&gt;
 at scala.reflect.runtime.SymbolLoaders$PackageScope$$anonfun$lookupEntry$1.apply(SymbolLoaders.scala:137)&lt;br/&gt;
 at scala.reflect.runtime.SymbolLoaders$PackageScope$$anonfun$lookupEntry$1.apply(SymbolLoaders.scala:126)&lt;br/&gt;
 at scala.reflect.runtime.Gil$class.gilSynchronized(Gil.scala:19)&lt;br/&gt;
 at scala.reflect.runtime.JavaUniverse.gilSynchronized(JavaUniverse.scala:16)&lt;br/&gt;
 at scala.reflect.runtime.SymbolLoaders$PackageScope.syncLockSynchronized(SymbolLoaders.scala:124)&lt;br/&gt;
 at scala.reflect.runtime.SymbolLoaders$PackageScope.lookupEntry(SymbolLoaders.scala:126)&lt;br/&gt;
 at scala.reflect.internal.Types$Type.findDecl(Types.scala:971)&lt;br/&gt;
 at scala.reflect.internal.Types$Type.decl(Types.scala:566)&lt;br/&gt;
 at scala.reflect.internal.SymbolTable.openPackageModule(SymbolTable.scala:335)&lt;br/&gt;
 at scala.reflect.runtime.SymbolLoaders$LazyPackageType$$anonfun$complete$2.apply$mcV$sp(SymbolLoaders.scala:74)&lt;br/&gt;
 at scala.reflect.runtime.SymbolLoaders$LazyPackageType$$anonfun$complete$2.apply(SymbolLoaders.scala:71)&lt;br/&gt;
 at scala.reflect.runtime.SymbolLoaders$LazyPackageType$$anonfun$complete$2.apply(SymbolLoaders.scala:71)&lt;br/&gt;
 at scala.reflect.internal.SymbolTable.slowButSafeEnteringPhaseNotLaterThan(SymbolTable.scala:263)&lt;br/&gt;
 at scala.reflect.runtime.SymbolLoaders$LazyPackageType.complete(SymbolLoaders.scala:71)&lt;br/&gt;
 at scala.reflect.internal.Symbols$Symbol.info(Symbols.scala:1514)&lt;br/&gt;
 at scala.reflect.runtime.SynchronizedSymbols$SynchronizedSymbol$$anon$1.scala$reflect$runtime$SynchronizedSymbols$SynchronizedSymbol$$super$info(SynchronizedSymbols.scala:174)&lt;br/&gt;
 at scala.reflect.runtime.SynchronizedSymbols$SynchronizedSymbol$$anonfun$info$1.apply(SynchronizedSymbols.scala:127)&lt;br/&gt;
 at scala.reflect.runtime.SynchronizedSymbols$SynchronizedSymbol$$anonfun$info$1.apply(SynchronizedSymbols.scala:127)&lt;br/&gt;
 at scala.reflect.runtime.Gil$class.gilSynchronized(Gil.scala:19)&lt;br/&gt;
 at scala.reflect.runtime.JavaUniverse.gilSynchronized(JavaUniverse.scala:16)&lt;br/&gt;
 at scala.reflect.runtime.SynchronizedSymbols$SynchronizedSymbol$class.gilSynchronizedIfNotThreadsafe(SynchronizedSymbols.scala:123)&lt;br/&gt;
 at scala.reflect.runtime.SynchronizedSymbols$SynchronizedSymbol$$anon$1.gilSynchronizedIfNotThreadsafe(SynchronizedSymbols.scala:174)&lt;br/&gt;
 at scala.reflect.runtime.SynchronizedSymbols$SynchronizedSymbol$class.info(SynchronizedSymbols.scala:127)&lt;br/&gt;
 at scala.reflect.runtime.SynchronizedSymbols$SynchronizedSymbol$$anon$1.info(SynchronizedSymbols.scala:174)&lt;br/&gt;
 at scala.reflect.internal.Types$TypeRef.thisInfo(Types.scala:2194)&lt;br/&gt;
 at scala.reflect.internal.Types$TypeRef.baseClasses(Types.scala:2199)&lt;br/&gt;
 at scala.reflect.internal.tpe.FindMembers$FindMemberBase.&amp;lt;init&amp;gt;(FindMembers.scala:17)&lt;br/&gt;
 at scala.reflect.internal.tpe.FindMembers$FindMember.&amp;lt;init&amp;gt;(FindMembers.scala:219)&lt;br/&gt;
 at scala.reflect.internal.Types$Type.scala$reflect$internal$Types$Type$$findMemberInternal$1(Types.scala:1014)&lt;br/&gt;
 at scala.reflect.internal.Types$Type.findMember(Types.scala:1016)&lt;br/&gt;
 at scala.reflect.internal.Types$Type.memberBasedOnName(Types.scala:631)&lt;br/&gt;
 at scala.reflect.internal.Types$Type.member(Types.scala:600)&lt;br/&gt;
 at scala.reflect.internal.Mirrors$RootsBase.getModuleOrClass(Mirrors.scala:48)&lt;br/&gt;
 at scala.reflect.internal.Mirrors$RootsBase.getModuleOrClass(Mirrors.scala:45)&lt;br/&gt;
 at scala.reflect.internal.Mirrors$RootsBase.getModuleOrClass(Mirrors.scala:45)&lt;br/&gt;
 at scala.reflect.internal.Mirrors$RootsBase.getModuleOrClass(Mirrors.scala:45)&lt;br/&gt;
 at scala.reflect.internal.Mirrors$RootsBase.getModuleOrClass(Mirrors.scala:45)&lt;br/&gt;
 at scala.reflect.internal.Mirrors$RootsBase.getModuleOrClass(Mirrors.scala:66)&lt;br/&gt;
 at scala.reflect.internal.Mirrors$RootsBase.staticModuleOrClass(Mirrors.scala:77)&lt;br/&gt;
 at scala.reflect.internal.Mirrors$RootsBase.staticModule(Mirrors.scala:161)&lt;br/&gt;
 at scala.reflect.internal.Mirrors$RootsBase.staticModule(Mirrors.scala:22)&lt;br/&gt;
 at org.apache.spark.sql.catalyst.ScalaReflection$$anonfun$schemaFor$1$$typecreator48$1.apply(ScalaReflection.scala:726)&lt;br/&gt;
 at scala.reflect.api.TypeTags$WeakTypeTagImpl.tpe$lzycompute(TypeTags.scala:232)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x00000005c0c47770&amp;gt; (a scala.reflect.api.TypeTags$TypeTagImpl)&lt;br/&gt;
 at scala.reflect.api.TypeTags$WeakTypeTagImpl.tpe(TypeTags.scala:232)&lt;br/&gt;
 at org.apache.spark.sql.catalyst.ScalaReflection$class.localTypeOf(ScalaReflection.scala:839)&lt;br/&gt;
 at org.apache.spark.sql.catalyst.ScalaReflection$.localTypeOf(ScalaReflection.scala:39)&lt;br/&gt;
 at org.apache.spark.sql.catalyst.ScalaReflection$$anonfun$schemaFor$1.apply(ScalaReflection.scala:726)&lt;br/&gt;
 at org.apache.spark.sql.catalyst.ScalaReflection$$anonfun$schemaFor$1.apply(ScalaReflection.scala:715)&lt;br/&gt;
 at scala.reflect.internal.tpe.TypeConstraints$UndoLog.undo(TypeConstraints.scala:56)&lt;br/&gt;
 at org.apache.spark.sql.catalyst.ScalaReflection$class.cleanUpReflectionObjects(ScalaReflection.scala:824)&lt;br/&gt;
 at org.apache.spark.sql.catalyst.ScalaReflection$.cleanUpReflectionObjects(ScalaReflection.scala:39)&lt;br/&gt;
 at org.apache.spark.sql.catalyst.ScalaReflection$.schemaFor(ScalaReflection.scala:714)&lt;br/&gt;
 at org.apache.spark.sql.catalyst.ScalaReflection$.schemaFor(ScalaReflection.scala:711)&lt;br/&gt;
 at org.apache.spark.sql.functions$.udf(functions.scala:3356)&lt;br/&gt;
 at com.amazon.economics.spark.stata.port.RowTotal$.rowtotalOf(RowTotal.scala:28)&lt;br/&gt;
 at com.amazon.economics.spark.stata.port.RowTotal$.rowtotalInt$lzycompute(RowTotal.scala:61)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x00000005c0c47858&amp;gt; (a com.amazon.economics.spark.stata.port.RowTotal$)&lt;br/&gt;
 at com.amazon.economics.spark.stata.port.RowTotal$.rowtotalInt(RowTotal.scala:61)&lt;br/&gt;
 at com.amazon.economics.spark.stata.port.DataFrameRowtotalOps.&amp;lt;init&amp;gt;(RowTotal.scala:71)&lt;br/&gt;
 at com.amazon.economics.spark.stata.port.DataFrameRowtotalOps$.toDataFrameRowTotalOps(RowTotal.scala:140)&lt;br/&gt;
 at com.amazon.economics.spark.dq.metrics.DifferenceRatioMetricSuite$$anonfun$1.apply(DifferenceRatioMetricSuite.scala:29)&lt;br/&gt;
 at com.amazon.economics.spark.dq.metrics.DifferenceRatioMetricSuite$$anonfun$1.apply(DifferenceRatioMetricSuite.scala:29)&lt;br/&gt;
 at scala.collection.LinearSeqOptimized$class.foldLeft(LinearSeqOptimized.scala:124)&lt;br/&gt;
 at scala.collection.immutable.List.foldLeft(List.scala:84)&lt;br/&gt;
 at com.amazon.economics.spark.dq.metrics.DifferenceRatioMetricSuite.compute(DifferenceRatioMetricSuite.scala:29)&lt;br/&gt;
 at com.amazon.economics.spark.dq.MetricsTaskRunner$$anonfun$run$1$$anonfun$1$$anonfun$apply$1$$anonfun$apply$2.apply(MetricsTaskRunner.scala:41)&lt;br/&gt;
 at com.amazon.economics.spark.dq.MetricsTaskRunner$$anonfun$run$1$$anonfun$1$$anonfun$apply$1$$anonfun$apply$2.apply(MetricsTaskRunner.scala:39)&lt;br/&gt;
 at scala.util.Try$.apply(Try.scala:192)&lt;br/&gt;
 at com.amazon.economics.spark.dq.MetricsTaskRunner$$anonfun$run$1$$anonfun$1$$anonfun$apply$1.apply(MetricsTaskRunner.scala:39)&lt;br/&gt;
 at com.amazon.economics.spark.dq.MetricsTaskRunner$$anonfun$run$1$$anonfun$1$$anonfun$apply$1.apply(MetricsTaskRunner.scala:32)&lt;br/&gt;
 at scala.collection.parallel.AugmentedIterableIterator$class.map2combiner(RemainsIterator.scala:115)&lt;br/&gt;
 at scala.collection.parallel.immutable.ParVector$ParVectorIterator.map2combiner(ParVector.scala:62)&lt;br/&gt;
 at scala.collection.parallel.ParIterableLike$Map.leaf(ParIterableLike.scala:1054)&lt;br/&gt;
 at scala.collection.parallel.Task$$anonfun$tryLeaf$1.apply$mcV$sp(Tasks.scala:49)&lt;br/&gt;
 at scala.collection.parallel.Task$$anonfun$tryLeaf$1.apply(Tasks.scala:48)&lt;br/&gt;
 at scala.collection.parallel.Task$$anonfun$tryLeaf$1.apply(Tasks.scala:48)&lt;br/&gt;
 at scala.collection.parallel.Task$class.tryLeaf(Tasks.scala:51)&lt;br/&gt;
 at scala.collection.parallel.ParIterableLike$Map.tryLeaf(ParIterableLike.scala:1051)&lt;br/&gt;
 at scala.collection.parallel.AdaptiveWorkStealingTasks$WrappedTask$class.compute(Tasks.scala:152)&lt;br/&gt;
 at scala.collection.parallel.AdaptiveWorkStealingForkJoinTasks$WrappedTask.compute(Tasks.scala:443)&lt;br/&gt;
 at scala.concurrent.forkjoin.RecursiveAction.exec(RecursiveAction.java:160)&lt;br/&gt;
 at scala.concurrent.forkjoin.ForkJoinTask.doExec(ForkJoinTask.java:260)&lt;br/&gt;
 at scala.concurrent.forkjoin.ForkJoinPool$WorkQueue.runTask(ForkJoinPool.java:1339)&lt;br/&gt;
 at scala.concurrent.forkjoin.ForkJoinPool.runWorker(ForkJoinPool.java:1979)&lt;br/&gt;
 at scala.concurrent.forkjoin.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:107)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Found 1 deadlock.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13217321">SPARK-26961</key>
            <summary>Found Java-level deadlock in Spark Driver</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ajithshetty">Ajith S</assignee>
                                    <reporter username="sol401430">Rong Jialei</reporter>
                        <labels>
                    </labels>
                <created>Thu, 21 Feb 2019 23:25:34 +0000</created>
                <updated>Mon, 12 Dec 2022 18:11:10 +0000</updated>
                            <resolved>Tue, 26 Mar 2019 00:09:15 +0000</resolved>
                                    <version>2.3.0</version>
                                    <fixVersion>2.3.4</fixVersion>
                    <fixVersion>2.4.2</fixVersion>
                    <fixVersion>3.0.0</fixVersion>
                                    <component>Spark Submit</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="16776211" author="gurwls223" created="Sun, 24 Feb 2019 10:23:42 +0000"  >&lt;p&gt;How did this happen? Would you be able to provide a reproducer and/or narrow down this further?&lt;/p&gt;</comment>
                            <comment id="16780534" author="ajithshetty" created="Thu, 28 Feb 2019 13:49:25 +0000"  >&lt;p&gt;I think the root cause is &lt;a href=&quot;https://github.com/apache/spark/blob/master/sql/core/src/main/scala/org/apache/spark/sql/internal/SharedState.scala#L185&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/master/sql/core/src/main/scala/org/apache/spark/sql/internal/SharedState.scala#L185&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;URL.setURLStreamHandlerFactory(new FsUrlStreamHandlerFactory())&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This induces the thread lock, this may be bug in a non spark env also&lt;/p&gt;

&lt;p&gt;Thread 1 : Does load class which will do below&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;waiting to lock &amp;lt;0x00000005c0c1e5e0&amp;gt; (a org.apache.hadoop.conf.Configuration)&lt;br/&gt;
at org.apache.hadoop.conf.Configuration.handleDeprecation(Configuration.java:684)&lt;br/&gt;
at org.apache.hadoop.conf.Configuration.get(Configuration.java:1088)&lt;br/&gt;
at org.apache.hadoop.conf.Configuration.getTrimmed(Configuration.java:1145)&lt;br/&gt;
at org.apache.hadoop.conf.Configuration.getClass(Configuration.java:2363)&lt;br/&gt;
at org.apache.hadoop.fs.FileSystem.getFileSystemClass(FileSystem.java:2840)&lt;br/&gt;
at org.apache.hadoop.fs.FsUrlStreamHandlerFactory.createURLStreamHandler(FsUrlStreamHandlerFactory.java:74)&lt;br/&gt;
at java.net.URL.getURLStreamHandler(URL.java:1142)&lt;br/&gt;
at java.net.URL.&amp;lt;init&amp;gt;(URL.java:420)&lt;br/&gt;
at sun.misc.URLClassPath$JarLoader.&amp;lt;init&amp;gt;(URLClassPath.java:812)&lt;br/&gt;
at sun.misc.URLClassPath$JarLoader$3.run(URLClassPath.java:1094)&lt;br/&gt;
at sun.misc.URLClassPath$JarLoader$3.run(URLClassPath.java:1091)&lt;br/&gt;
at java.security.AccessController.doPrivileged(Native Method)&lt;br/&gt;
at sun.misc.URLClassPath$JarLoader.getResource(URLClassPath.java:1090)&lt;br/&gt;
at sun.misc.URLClassPath$JarLoader.getResource(URLClassPath.java:1050)&lt;br/&gt;
at sun.misc.URLClassPath.getResource(URLClassPath.java:239)&lt;br/&gt;
at java.net.URLClassLoader$1.run(URLClassLoader.java:365)&lt;br/&gt;
at java.net.URLClassLoader$1.run(URLClassLoader.java:362)&lt;br/&gt;
at java.security.AccessController.doPrivileged(Native Method)&lt;br/&gt;
at java.net.URLClassLoader.findClass(URLClassLoader.java:361)&lt;br/&gt;
at java.lang.ClassLoader.loadClass(ClassLoader.java:424)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x00000005b7991168&amp;gt; (a org.apache.spark.util.MutableURLClassLoader)&lt;br/&gt;
at java.lang.ClassLoader.loadClass(ClassLoader.java:357)&lt;br/&gt;
at java.lang.Class.forName0(Native Method)&lt;br/&gt;
at java.lang.Class.forName(Class.java:348)&#160;&#160;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Thread 2 : Create new URL&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;waiting to lock &amp;lt;0x00000005b7991168&amp;gt; (a org.apache.spark.util.MutableURLClassLoader)&lt;br/&gt;
at java.lang.ClassLoader.loadClass(ClassLoader.java:357)&lt;br/&gt;
at org.apache.xerces.parsers.ObjectFactory.findProviderClass(Unknown Source)&lt;br/&gt;
at org.apache.xerces.parsers.ObjectFactory.newInstance(Unknown Source)&lt;br/&gt;
at org.apache.xerces.parsers.ObjectFactory.createObject(Unknown Source)&lt;br/&gt;
at org.apache.xerces.parsers.ObjectFactory.createObject(Unknown Source)&lt;br/&gt;
at org.apache.xerces.parsers.DOMParser.&amp;lt;init&amp;gt;(Unknown Source)&lt;br/&gt;
at org.apache.xerces.parsers.DOMParser.&amp;lt;init&amp;gt;(Unknown Source)&lt;br/&gt;
at org.apache.xerces.jaxp.DocumentBuilderImpl.&amp;lt;init&amp;gt;(Unknown Source)&lt;br/&gt;
at org.apache.xerces.jaxp.DocumentBuilderFactoryImpl.newDocumentBuilder(Unknown Source)&lt;br/&gt;
at org.apache.hadoop.conf.Configuration.loadResource(Configuration.java:2737)&lt;br/&gt;
at org.apache.hadoop.conf.Configuration.loadResources(Configuration.java:2696)&lt;br/&gt;
at org.apache.hadoop.conf.Configuration.getProps(Configuration.java:2579)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x00000005c0c1e5e0&amp;gt; (a org.apache.hadoop.conf.Configuration)&lt;br/&gt;
at org.apache.hadoop.conf.Configuration.get(Configuration.java:1091)&lt;br/&gt;
at org.apache.hadoop.conf.Configuration.getTrimmed(Configuration.java:1145)&lt;br/&gt;
at org.apache.hadoop.conf.Configuration.getClass(Configuration.java:2363)&lt;br/&gt;
at org.apache.hadoop.fs.FileSystem.getFileSystemClass(FileSystem.java:2840)&lt;br/&gt;
at org.apache.hadoop.fs.FsUrlStreamHandlerFactory.createURLStreamHandler(FsUrlStreamHandlerFactory.java:74)&lt;br/&gt;
at java.net.URL.getURLStreamHandler(URL.java:1142)&lt;br/&gt;
at java.net.URL.&amp;lt;init&amp;gt;(URL.java:599)&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16780771" author="sol401430" created="Thu, 28 Feb 2019 17:39:53 +0000"  >&lt;p&gt;Hi&#160;&lt;/p&gt;

&lt;p&gt;Thanks for the response, from our current investigation, we suspect the deadlock happened when 2 thread in drive process doing&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;one thread try to use DataSource&apos;&#160;lookupDataSource() function. e.g. in the deadlock stack info:&#160;&#160;org.apache.spark.sql.execution.datasources.DataSource$.lookupDataSource(DataSource.scala:614)&lt;/li&gt;
	&lt;li&gt;another thread call java.lang.Class.forName().&#160; e.g. in deadlock stack info:&#160; locked &amp;lt;0x00000005b7991168&amp;gt; (a org.apache.spark.util.MutableURLClassLoader)&lt;br/&gt;
at java.lang.ClassLoader.loadClass(ClassLoader.java:357)&lt;br/&gt;
at java.lang.Class.forName0(Native Method)&lt;br/&gt;
at java.lang.Class.forName(Class.java:348)&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Both call need to lock&#160;MutableURLClassLoader and&#160;a org.apache.hadoop.conf.Configuration, but they are doing so in different order.&lt;/p&gt;</comment>
                            <comment id="16781458" author="kabhwan" created="Fri, 1 Mar 2019 08:31:03 +0000"  >&lt;p&gt;Which distribution of Spark are you using? Specifically&#160;the&#160;Hadoop version since Configuration has been changed between 2.6 and 2.7.&lt;/p&gt;</comment>
                            <comment id="16782645" author="xsapphire" created="Sun, 3 Mar 2019 09:33:29 +0000"  >&lt;p&gt;Hi there,&lt;/p&gt;

&lt;p&gt;I&apos;m one of Jialei&apos;s coworkers.&#160;By using&#160;prototype&#160;&lt;a href=&quot;https://gist.github.com/Fruiter/159f82f9e5ff554a348f1a21263f8748&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/Fruiter/159f82f9e5ff554a348f1a21263f8748&lt;/a&gt;&#160;I can consistently reproduce the problem. I have tested on single machine with env:&lt;/p&gt;

&lt;p&gt;spark 2.3.0 + hadoop 2.8.1&lt;/p&gt;

&lt;p&gt;spark 2.4.0 + hadoop 3.2.0&lt;/p&gt;

&lt;p&gt;As mentioned by Ajith, the problem is caused by the&#160;global&#160;FsUrlStreamHandlerFactory instance. And there could be a loop such as&#160;ClassLoader -&amp;gt; FsUrlStreamHandlerFactory -&amp;gt; Configuration.&lt;/p&gt;</comment>
                            <comment id="16783227" author="ajithshetty" created="Mon, 4 Mar 2019 10:44:30 +0000"  >&lt;p&gt;The problem is here org.apache.spark.util.MutableURLClassLoader (entire classloader) is getting locked.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
at java.net.URLClassLoader.findClass(URLClassLoader.java:361)
at java.lang.&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.loadClass(&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.java:424)
locked &amp;lt;0x00000005b7991168&amp;gt; (a org.apache.spark.util.MutableURLClassLoader)
at java.lang.&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.loadClass(&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.java:357)
at java.lang.&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.forName0(Native Method)
at java.lang.&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.forName(&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.java:348)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Checking javadoc of java.lang.ClassLoader#getClassLoadingLock we see that &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
* If &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt; object is registered as
* parallel capable, the method returns a dedicated object associated
* with the specified &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;name. Otherwise, the method returns &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;
* &lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt; object&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Here we see for every class loading, a new object is created so it doesn&apos;t lock entire classloader itself if classloader is registered as ClassLoader.registerAsParallelCapable();&lt;/p&gt;

&lt;p&gt;Even though MutableURLClassLoader/NonClosableMutableURLClassLoader/ChildFirstURLClassLoader are&#160;subclass of java.net.URLClassLoader, they will need to explicitly do &lt;font color=&quot;#FF0000&quot;&gt;&lt;b&gt;ClassLoader.registerAsParallelCapable()&lt;/b&gt;&lt;/font&gt; (java.net.URLClassLoader does it in its static block)&lt;/p&gt;


&lt;p&gt;May be this would avoid the deadlock by making locks more granular.? any thoughts.?&lt;/p&gt;</comment>
                            <comment id="16783727" author="xsapphire" created="Mon, 4 Mar 2019 19:50:58 +0000"  >&lt;p&gt;Hi Ajith,&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;IMHO ClassLoader.registerAsParallelCapable() only helps to reduce the granularity of the lock. The lock will still be shared by loadClass calls with same &quot;className&quot;. Theoretically deadlock can still be triggered in certain cases.&lt;/p&gt;</comment>
                            <comment id="16789180" author="ajithshetty" created="Mon, 11 Mar 2019 05:53:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xsapphire&quot; class=&quot;user-hover&quot; rel=&quot;xsapphire&quot;&gt;xsapphire&lt;/a&gt; i agree with your opinion.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;cc&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hyukjin.kwon&quot; class=&quot;user-hover&quot; rel=&quot;hyukjin.kwon&quot;&gt;hyukjin.kwon&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cloud_fan&quot; class=&quot;user-hover&quot; rel=&quot;cloud_fan&quot;&gt;cloud_fan&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srowen&quot; class=&quot;user-hover&quot; rel=&quot;srowen&quot;&gt;srowen&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I do not see a clear way to fix this without changing&#160;org.apache.hadoop.fs.FsUrlStreamHandlerFactory.createURLStreamHandler ( or providing a spark&apos;s very own version of&#160;UrlStreamHandlerFactory where classloader can be locked before&#160;createURLStreamHandler)&lt;/p&gt;

&lt;p&gt;What you suggest.?&lt;/p&gt;</comment>
                            <comment id="16789598" author="srowen" created="Mon, 11 Mar 2019 14:00:37 +0000"  >&lt;p&gt;I think registerAsParallelCapable() sounds like it could resolve the actual issue in practice here. Let&apos;s do that, because these ClassLoader subclasses are called concurrently in some cases. We probably can&apos;t fix Hadoop here.&lt;/p&gt;

&lt;p&gt;Looks like there are 4-5 implementations in Spark. I think we can address all of them. It would have to go in a companion object to these classes, in Scala. I don&apos;t see a downside here other than that the locking is potentially more expensive as it&apos;s finer-grained?&lt;/p&gt;</comment>
                            <comment id="16789829" author="xsapphire" created="Mon, 11 Mar 2019 18:04:45 +0000"  >&lt;p&gt;I think the problem&#160;could be fixed from a more general prospect if there is a way to read Configuration without&#160;updating its content. That&#160;should help to ensure accessing Configuration object without triggering class loader. I&apos;m&#160;neither familiar with Hadoop nor Spark. So I don&apos;t know if that&apos;s a practical solution or not.&lt;/p&gt;

&lt;p&gt;I don&apos;t know how far&#160;will registerAsParallelCapable affect the whole system. Since it will cause storing one lock for&#160;each loaded class. I&apos;m not sure how large will that overhead be.&lt;/p&gt;</comment>
                            <comment id="16790208" author="ajithshetty" created="Tue, 12 Mar 2019 04:10:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srowen&quot; class=&quot;user-hover&quot; rel=&quot;srowen&quot;&gt;srowen&lt;/a&gt;&#160;Yes. I too have same opinion of fixing it via&#160;registerAsParallelCapable.&#160; But Its not possible to do via Companion Object. I Tried and found a issue. Refer&#160;&lt;a href=&quot;https://github.com/scala/bug/issues/11429&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/scala/bug/issues/11429&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;May be we need to move them to java implementation from scala to achieve this&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xsapphire&quot; class=&quot;user-hover&quot; rel=&quot;xsapphire&quot;&gt;xsapphire&lt;/a&gt; i think these class loaders are child classloaders of LaunchAppClassLoader which already has classes for jar in class path. So overhead may not be of higher magnitude&lt;/p&gt;</comment>
                            <comment id="16791634" author="srowen" created="Wed, 13 Mar 2019 12:16:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ajithshetty&quot; class=&quot;user-hover&quot; rel=&quot;ajithshetty&quot;&gt;ajithshetty&lt;/a&gt; I see, OK. It could happen in the class itself, in the constructor. The calls after the first would do nothing. &lt;/p&gt;</comment>
                            <comment id="16791712" author="ajithshetty" created="Wed, 13 Mar 2019 13:42:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srowen&quot; class=&quot;user-hover&quot; rel=&quot;srowen&quot;&gt;srowen&lt;/a&gt; That too will not work&lt;/p&gt;

&lt;p&gt;Here is my custom classloader&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;MYClassLoader(urls: Array[URL], parent: &lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;)
  &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; URLClassLoader(urls, parent) {

  &lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.registerAsParallelCapable()

  override def loadClass(name: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;): &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;[_] = {
    &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.loadClass(name)
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;If we see class initialization flow, we see that super constructor is called before ClassLoader.registerAsParallelCapable() line is hit, hence it doesn&apos;t take effect&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&amp;lt;init&amp;gt;:280, &lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt; (java.lang)
&amp;lt;init&amp;gt;:316, &lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt; (java.lang)
&amp;lt;init&amp;gt;:76, SecureClassLoader (java.security)
&amp;lt;init&amp;gt;:100, URLClassLoader (java.net)
&amp;lt;init&amp;gt;:23, MYClassLoader (org.apache.spark.util.ajith)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;as per&#160;&lt;a href=&quot;https://github.com/scala/bug/issues/11429&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/scala/bug/issues/11429&lt;/a&gt;&#160;scala 2.x do not have a pure static support yet. So moving classloader to a java based implementation may be only option we have&lt;/p&gt;</comment>
                            <comment id="16791739" author="srowen" created="Wed, 13 Mar 2019 14:11:40 +0000"  >&lt;p&gt;When I run your class and print the result of registerAsParallelCapable, it returns true. Yes, parent initialization happens first, but URLClassLoader is also parallel capable.&lt;/p&gt;</comment>
                            <comment id="16791751" author="ajithshetty" created="Wed, 13 Mar 2019 14:25:03 +0000"  >&lt;p&gt;1) Yes, the registerAsParallelCapable will return true, but if you inspect the classloader instance, parallelLockMap is still null as it was already initalized via super class constructor. so &lt;b&gt;it has no effect for already created instance&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12962345/12962345_image-2019-03-13-19-53-52-390.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;2) URLClassLoader is parallel capable as it does registration in static block which is before calling parent(ClassLoader) constructor. Also as per javadoc&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://docs.oracle.com/javase/8/docs/api/java/lang/ClassLoader.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://docs.oracle.com/javase/8/docs/api/java/lang/ClassLoader.html&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Note that the&#160;&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;&#160;&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;is registered as parallel capable by &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;. However, its subclasses still need to register themselves &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; they are parallel capable.&#160;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Hence MutableURLClassLoader lost its parallel capability by failing to register unlike URLClassLoader&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16794300" author="srowen" created="Sat, 16 Mar 2019 16:17:44 +0000"  >&lt;p&gt;Hm! OK, I believe it. That almost seems like a bug in the JDK. I don&apos;t see a way around it right now.&lt;/p&gt;</comment>
                            <comment id="16794403" author="xsapphire" created="Sun, 17 Mar 2019 03:20:17 +0000"  >&lt;p&gt;copy or create a new Configuration every time in &lt;a href=&quot;https://github.com/facebookarchive/hadoop-20/blob/master/src/core/org/apache/hadoop/fs/FsUrlStreamHandlerFactory.java#L64&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/facebookarchive/hadoop-20/blob/master/src/core/org/apache/hadoop/fs/FsUrlStreamHandlerFactory.java#L64&lt;/a&gt;&#160;should also help. But that&apos;s part of hadoop. Not sure if it&apos;s a good fix.&lt;/p&gt;</comment>
                            <comment id="16794517" author="ajithshetty" created="Sun, 17 Mar 2019 15:50:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xsapphire&quot; class=&quot;user-hover&quot; rel=&quot;xsapphire&quot;&gt;xsapphire&lt;/a&gt; nothing better if it can be fixed in hadoop library, but i doubt that.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srowen&quot; class=&quot;user-hover&quot; rel=&quot;srowen&quot;&gt;srowen&lt;/a&gt; can we have a java based classloader implementation for (MutableURLClassLoader/NonClosableMutableURLClassLoader/ChildFirstURLClassLoader) which can enable parallel capability and reduce the window of this deadlock from happening.?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16794532" author="srowen" created="Sun, 17 Mar 2019 16:43:21 +0000"  >&lt;p&gt;Yes, I think implementing in Java is viable just for this reason. At least for MutableURLClassLoader.&lt;/p&gt;</comment>
                            <comment id="16794551" author="ajithshetty" created="Sun, 17 Mar 2019 17:41:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srowen&quot; class=&quot;user-hover&quot; rel=&quot;srowen&quot;&gt;srowen&lt;/a&gt; ok, will raise a PR for this. Thanks&lt;/p&gt;</comment>
                            <comment id="16801257" author="srowen" created="Tue, 26 Mar 2019 00:09:15 +0000"  >&lt;p&gt;Issue resolved by pull request 24126&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/24126&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/24126&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17272272" author="ajithshetty" created="Tue, 26 Jan 2021 17:29:33 +0000"  >&lt;p&gt;Scala issue : &lt;a href=&quot;https://github.com/scala/bug/issues/11429&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/scala/bug/issues/11429&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13208759">SPARK-26587</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13443026">SPARK-39094</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13208759">SPARK-26587</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13219212">HADOOP-16159</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12962345" name="image-2019-03-13-19-53-52-390.png" size="118794" author="ajithshetty" created="Wed, 13 Mar 2019 14:23:54 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 42 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|yi192w:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>