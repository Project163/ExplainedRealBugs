<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:45:34 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-43221] Host local block fetching should use a block status of a block stored on disk</title>
                <link>https://issues.apache.org/jira/browse/SPARK-43221</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Spark on Yarn Cluster&lt;/p&gt;

&lt;p&gt;When multiple executors exist on a node, and the same block exists on both executors, with some in memory and some on disk.&lt;/p&gt;

&lt;p&gt;Probabilistically, the executor failed to obtain the block,throw Exception:&lt;/p&gt;

&lt;p&gt;java.lang.ArrayIndexOutofBoundsException: 0&lt;/p&gt;

&lt;p&gt;&#160; &#160; at org.apache.spark.broadcast.TorrentBroadcast.$anonfun$readBlocks$1(TorrentBroadcast.scala:183)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Next, I will replay the process of the problem occurring:&#160;&lt;/p&gt;

&lt;p&gt;step 1:&lt;/p&gt;

&lt;p&gt;The executor requests the driver to obtain block information(locationsAndStatusOption). The input parameters are BlockId and the host of its own node. Please note that it does not carry port information&lt;/p&gt;

&lt;p&gt;line:1092&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13057453/13057453_image-2023-04-21-00-24-22-059.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;step 2:&lt;/p&gt;

&lt;p&gt;On the driver side, the driver obtains all blockManagers holding the block based on the BlockId. For non remote shuffle scenarios, the driver will retrieve the first one with the blockId and blockManager from the locations&lt;/p&gt;

&lt;p&gt;Assuming that there are two BlockManagers holding the BlockId on this node, BM-1 holds the Block and stores it in memory, and BM-2 holds the Block and stores it in disk&lt;/p&gt;

&lt;p&gt;Assuming the returned status is of type memory and its disksize is 0&lt;/p&gt;

&lt;p&gt;line: 852, 856&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13057454/13057454_image-2023-04-21-00-30-41-851.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;step 3:&lt;/p&gt;

&lt;p&gt;This method will return a BlockLocationsAndStatus object. If there are BMs using disk, the disk&apos;s path information will be stored in localDirs&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13057455/13057455_image-2023-04-21-00-50-10-918.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;step 4:&lt;/p&gt;

&lt;p&gt;When the executor obtains locationsAndStatusOption, localDirs is not empty, but status.diskSize is 0&lt;/p&gt;

&lt;p&gt;line: 1102&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13057457/13057457_image-2023-04-21-00-54-11-968.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;step 5:&lt;/p&gt;

&lt;p&gt;The readDiskBlockFromSameHostExecutor only determines whether the Block file exists, and then directly uses the incoming blocksize to read the byte array. If the blocksize is 0, it returns an empty byte array&lt;/p&gt;

&lt;p&gt;Only checked if the file exists&lt;/p&gt;

&lt;p&gt;line: 1234, 1240&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13057458/13057458_image-2023-04-21-00-57-29-140.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Taking values from an empty array, causing an out of bounds problem&lt;/p&gt;</description>
                <environment></environment>
        <key id="13533426">SPARK-43221</key>
            <summary>Host local block fetching should use a block status of a block stored on disk</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="attilapiros">Attila Zsolt Piros</assignee>
                                    <reporter username="yorksity">Qiang Yang</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 20 Apr 2023 15:56:59 +0000</created>
                <updated>Thu, 13 Mar 2025 13:42:59 +0000</updated>
                            <resolved>Wed, 12 Mar 2025 18:53:05 +0000</resolved>
                                    <version>3.1.1</version>
                    <version>3.2.0</version>
                    <version>3.3.0</version>
                                    <fixVersion>4.1.0</fixVersion>
                    <fixVersion>3.5.6</fixVersion>
                    <fixVersion>4.0.0</fixVersion>
                                    <component>Block Manager</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="86400">24h</timeoriginalestimate>
                            <timeestimate seconds="86400">24h</timeestimate>
                                        <comments>
                            <comment id="17934625" author="dongjoon" created="Wed, 12 Mar 2025 18:53:05 +0000"  >&lt;p&gt;Issue resolved by pull request 50122&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/50122&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/50122&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13057452" name="image-2023-04-21-00-19-58-021.png" size="65897" author="yorksity" created="Thu, 20 Apr 2023 16:20:00 +0000"/>
                            <attachment id="13057453" name="image-2023-04-21-00-24-22-059.png" size="63257" author="yorksity" created="Thu, 20 Apr 2023 16:24:24 +0000"/>
                            <attachment id="13057454" name="image-2023-04-21-00-30-41-851.png" size="75718" author="yorksity" created="Thu, 20 Apr 2023 16:30:44 +0000"/>
                            <attachment id="13057455" name="image-2023-04-21-00-50-10-918.png" size="101461" author="yorksity" created="Thu, 20 Apr 2023 16:50:12 +0000"/>
                            <attachment id="13057456" name="image-2023-04-21-00-53-20-720.png" size="103762" author="yorksity" created="Thu, 20 Apr 2023 16:53:22 +0000"/>
                            <attachment id="13057457" name="image-2023-04-21-00-54-11-968.png" size="130996" author="yorksity" created="Thu, 20 Apr 2023 16:54:13 +0000"/>
                            <attachment id="13057458" name="image-2023-04-21-00-57-29-140.png" size="132103" author="yorksity" created="Thu, 20 Apr 2023 16:57:30 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            34 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1hf9c:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>