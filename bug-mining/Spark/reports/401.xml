<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:14:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-2104] RangePartitioner should use user specified serializer to serialize range bounds</title>
                <link>https://issues.apache.org/jira/browse/SPARK-2104</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Otherwise it is pretty annoying to do a sort on types that are not java serializable. &lt;/p&gt;

&lt;p&gt;To reproduce, just set the serializer to Kryo, and run the following job:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;JavaNonSerializableClass &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; Comparable { override def compareTo(o: JavaNonSerializableClass) = 0 }

sc.parallelize(Seq(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; JavaNonSerializableClass, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; JavaNonSerializableClass), 2).map(x =&amp;gt; (x,x)).sortByKey()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Basically the partitioner will always be serialized using Java (by the task closure serializer). However, the rangeBounds variable in RangePartitioner should be serialized with the user specified serializer. &lt;/p&gt;
</description>
                <environment></environment>
        <key id="12720489">SPARK-2104</key>
            <summary>RangePartitioner should use user specified serializer to serialize range bounds</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jerryshao">Saisai Shao</assignee>
                                    <reporter username="rxin">Reynold Xin</reporter>
                        <labels>
                    </labels>
                <created>Wed, 11 Jun 2014 00:35:23 +0000</created>
                <updated>Mon, 30 Jun 2014 06:00:09 +0000</updated>
                            <resolved>Mon, 30 Jun 2014 06:00:09 +0000</resolved>
                                                    <fixVersion>1.1.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14045413" author="jerryshao" created="Fri, 27 Jun 2014 01:23:22 +0000"  >&lt;p&gt;Hi Reynold, is that annoying message you mentioned above?&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;org.apache.spark.SparkException: Job aborted due to stage failure: Task not serializable: java.io.NotSerializableException: $iwC$$iwC$$iwC$$iwC$$iwC$$iwC$JavaNonSerializableClass&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Seems we can implement writeObject and readObject to use specified serializer like &lt;tt&gt;ParallelCollectionPartition&lt;/tt&gt;, is that what you want?&lt;/p&gt;</comment>
                            <comment id="14045419" author="rxin" created="Fri, 27 Jun 2014 01:35:18 +0000"  >&lt;p&gt;That sounds good!&lt;/p&gt;</comment>
                            <comment id="14045430" author="jerryshao" created="Fri, 27 Jun 2014 01:48:05 +0000"  >&lt;p&gt;Ok, got it. I will try to fix this issue &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14045504" author="rxin" created="Fri, 27 Jun 2014 04:17:58 +0000"  >&lt;p&gt;BTW I have some old code I wrote &amp;#8211; you can do your changes based on this&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
/**
 * A [[org.apache.spark.Partitioner]] that partitions sortable records by range into roughly
 * equal ranges. The ranges are determined by sampling the content of the RDD passed in.
 *
 * Note that the actual number of partitions created by the RangePartitioner might not be the same
 * as the `partitions` parameter, in the &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; where the number of sampled records is less than
 * the value of `partitions`.
 */
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;RangePartitioner[K : Ordering : ClassTag, V](
    &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; partitions: Int,
    @&lt;span class=&quot;code-keyword&quot;&gt;transient&lt;/span&gt; rdd: RDD[_ &amp;lt;: Product2[K,V]],
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; val ascending: &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt; = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
  &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; Partitioner {

  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; ordering = implicitly[Ordering[K]]

  &lt;span class=&quot;code-comment&quot;&gt;// An array of upper bounds &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the first (partitions - 1) partitions
&lt;/span&gt;  &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; rangeBounds: Array[K] = {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (partitions == 1) {
      Array()
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
      val rddSize = rdd.count()
      val maxSampleSize = partitions * 20.0
      val frac = math.min(maxSampleSize / math.max(rddSize, 1), 1.0)
      val rddSample = rdd.sample(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, frac, 1).map(_._1).collect().sorted
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (rddSample.length == 0) {
        Array()
      } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
        val bounds = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Array[K](partitions - 1)
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (i &amp;lt;- 0 until partitions - 1) {
          val index = (rddSample.length - 1) * (i + 1) / partitions
          bounds(i) = rddSample(index)
        }
        bounds
      }
    }
  }

  @&lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt;(classOf[IOException])
  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; def writeObject(out: ObjectOutputStream): Unit = {
    val sfactory = SparkEnv.get.serializer
    &lt;span class=&quot;code-comment&quot;&gt;// Treat java serializer with &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt; action rather than going thru serialization, to avoid a
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// separate serialization header.
&lt;/span&gt;    sfactory match {
      &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; js: JavaSerializer =&amp;gt; out.defaultWriteObject()
      &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; _ =&amp;gt;
        out.writeInt(partitions)
        val ser = sfactory.newInstance()
        Utils.serializeViaNestedStream(out, ser) { stream =&amp;gt;
          stream.writeObject(ordering)
          stream.writeObject(scala.reflect.classTag[K])
          stream.writeObject(rangeBounds)
        }
    }
  }

  @&lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt;(classOf[IOException])
  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; def readObject(in: ObjectInputStream): Unit = {

    val sfactory = SparkEnv.get.serializer
    sfactory match {
      &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; js: JavaSerializer =&amp;gt; in.defaultReadObject()
      &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; _ =&amp;gt;
        partitions = in.readInt()

        val ser = sfactory.newInstance()
        Utils.deserializeViaNestedStream(in, ser) { ds =&amp;gt;
          println(ds)
          ordering = ds.readObject[Ordering[K]]()
          implicit val classTag = ds.readObject[ClassTag[Array[K]]]()
          rangeBounds = ds.readObject[Array[K]]()(classTag)
          binarySearch = CollectionsUtils.makeBinarySearch[K]
        }
    }
  }

  def numPartitions = rangeBounds.length + 1

  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; binarySearch: ((Array[K], K) =&amp;gt; Int) = CollectionsUtils.makeBinarySearch[K]

  def getPartition(key: Any): Int = {
    val k = key.asInstanceOf[K]
    &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; partition = 0
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (rangeBounds.length &amp;lt; 1000) {
      &lt;span class=&quot;code-comment&quot;&gt;// If we have less than 100 partitions naive search
&lt;/span&gt;      &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (partition &amp;lt; rangeBounds.length &amp;amp;&amp;amp; ordering.gt(k, rangeBounds(partition))) {
        partition += 1
      }
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
      &lt;span class=&quot;code-comment&quot;&gt;// Determine which binary search method to use only once.
&lt;/span&gt;      partition = binarySearch(rangeBounds, k)
      &lt;span class=&quot;code-comment&quot;&gt;// binarySearch either returns the match location or -[insertion point]-1
&lt;/span&gt;      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (partition &amp;lt; 0) {
        partition = -partition-1
      }
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (partition &amp;gt; rangeBounds.length) {
        partition = rangeBounds.length
      }
    }
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (ascending) {
      partition
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
      rangeBounds.length - partition
    }
  }

  override def equals(other: Any): &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt; = other match {
    &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; r: RangePartitioner[_,_] =&amp;gt;
      r.rangeBounds.sameElements(rangeBounds) &amp;amp;&amp;amp; r.ascending == ascending
    &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; _ =&amp;gt;
      &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
  }

  override def hashCode(): Int = {
    val prime = 31
    &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; result = 1
    &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; i = 0
    &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (i &amp;lt; rangeBounds.length) {
      result = prime * result + rangeBounds(i).hashCode
      i += 1
    }
    result = prime * result + ascending.hashCode
    result
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14045519" author="jerryshao" created="Fri, 27 Jun 2014 04:59:22 +0000"  >&lt;p&gt;Hi Reynold, thanks a lot for your code. At first glance seems it is quite OK for the problem you mentioned, I&apos;m not sure is there any hiding corners I missed?&lt;/p&gt;</comment>
                            <comment id="14045520" author="rxin" created="Fri, 27 Jun 2014 05:01:55 +0000"  >&lt;p&gt;I don&apos;t really remember ... &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; It&apos;s been a while&lt;/p&gt;

&lt;p&gt;I guess adding tests would be important.&lt;/p&gt;</comment>
                            <comment id="14045524" author="jerryshao" created="Fri, 27 Jun 2014 05:04:45 +0000"  >&lt;p&gt;OK, got it. Thanks a lot&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>398688</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 21 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1wn07:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>398812</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12326686">1.1.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>