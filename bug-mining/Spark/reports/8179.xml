<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:27:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-36782] Deadlock between map-output-dispatcher and dispatcher-BlockManagerMaster upon migrating shuffle blocks</title>
                <link>https://issues.apache.org/jira/browse/SPARK-36782</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;I can observe a deadlock on the driver that can be triggered rather reliably in a job with a larger amount of tasks - upon using&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
spark.decommission.enabled: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
spark.storage.decommission.rddBlocks.enabled: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
spark.storage.decommission.shuffleBlocks.enabled: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
spark.storage.decommission.enabled: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;It origins in the&#160;&lt;tt&gt;dispatcher-BlockManagerMaster&lt;/tt&gt; making a call to&#160;&lt;tt&gt;updateBlockInfo&lt;/tt&gt; when shuffles are migrated. This is not performed by a thread from the pool but instead by the&#160;&lt;tt&gt;dispatcher-BlockManagerMaster&lt;/tt&gt; itself. I suppose this was done under the assumption that this would be very fast. However if the block that is updated is a shuffle index block it calls&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
mapOutputTracker.updateMapOutput(shuffleId, mapId, blockManagerId)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;for which it waits to acquire a write lock as part of the &lt;tt&gt;MapOutputTracker&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;If the timing is bad then one of the &lt;tt&gt;map-output-dispatchers&lt;/tt&gt; are holding this lock as part of e.g. &lt;tt&gt;serializedMapStatus&lt;/tt&gt;. In this function&#160;&lt;tt&gt;MapOutputTracker.serializeOutputStatuses&lt;/tt&gt; is called and as part of that we do&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (arrSize &amp;gt;= minBroadcastSize) {
 &lt;span class=&quot;code-comment&quot;&gt;// Use broadcast instead.
&lt;/span&gt; &lt;span class=&quot;code-comment&quot;&gt;// Important arr(0) is the tag == DIRECT, ignore that &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; deserializing !
&lt;/span&gt; &lt;span class=&quot;code-comment&quot;&gt;// arr is a nested Array so that it can handle over 2GB serialized data
&lt;/span&gt; val arr = chunkedByteBuf.getChunks().map(_.array())
 val bcast = broadcastManager.newBroadcast(arr, isLocal)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;which makes an RPC call to &lt;tt&gt;dispatcher-BlockManagerMaster&lt;/tt&gt;. That one however is unable to answer as it is blocked while waiting on the aforementioned lock. Hence the deadlock. The ingredients of this deadlock are therefore: sufficient size of the array to go the broadcast-path, as well as timing of incoming&#160;&lt;tt&gt;updateBlockInfo&lt;/tt&gt; call as happens regularly during decommissioning. Potentially earlier versions than 3.1.0 are affected but I could not sufficiently conclude that.&lt;/p&gt;

&lt;p&gt;I have a stacktrace of all driver threads showing the deadlock: &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13033720/13033720_spark_stacktrace_deadlock.txt&quot; title=&quot;spark_stacktrace_deadlock.txt attached to SPARK-36782&quot;&gt;spark_stacktrace_deadlock.txt&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;A coworker of mine wrote a patch that replicates the issue as a test case as well: &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13033721/13033721_0001-Add-test-showing-that-decommission-might-deadlock.patch&quot; title=&quot;0001-Add-test-showing-that-decommission-might-deadlock.patch attached to SPARK-36782&quot;&gt;0001-Add-test-showing-that-decommission-might-deadlock.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13401673">SPARK-36782</key>
            <summary>Deadlock between map-output-dispatcher and dispatcher-BlockManagerMaster upon migrating shuffle blocks</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="fthiele">Fabian Thiele</assignee>
                                    <reporter username="fthiele">Fabian Thiele</reporter>
                        <labels>
                    </labels>
                <created>Thu, 16 Sep 2021 14:03:32 +0000</created>
                <updated>Mon, 10 Jan 2022 20:30:28 +0000</updated>
                            <resolved>Thu, 23 Sep 2021 04:58:23 +0000</resolved>
                                    <version>3.1.0</version>
                    <version>3.1.1</version>
                    <version>3.1.2</version>
                    <version>3.2.0</version>
                    <version>3.1.3</version>
                    <version>3.2.1</version>
                    <version>3.3.0</version>
                                    <fixVersion>3.2.0</fixVersion>
                    <fixVersion>3.1.3</fixVersion>
                                    <component>Block Manager</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17417403" author="apachespark" created="Sun, 19 Sep 2021 21:27:03 +0000"  >&lt;p&gt;User &apos;f-thiele&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/34043&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/34043&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17418933" author="gengliang.wang" created="Thu, 23 Sep 2021 04:58:23 +0000"  >&lt;p&gt;Issue resolved by pull request 34043&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/34043&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/34043&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17418956" author="apachespark" created="Thu, 23 Sep 2021 06:00:48 +0000"  >&lt;p&gt;User &apos;Ngone51&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/34076&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/34076&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13033721" name="0001-Add-test-showing-that-decommission-might-deadlock.patch" size="2327" author="fthiele" created="Thu, 16 Sep 2021 14:04:21 +0000"/>
                            <attachment id="13033720" name="spark_stacktrace_deadlock.txt" size="160156" author="fthiele" created="Thu, 16 Sep 2021 14:03:55 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 7 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0v0bc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>