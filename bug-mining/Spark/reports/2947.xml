<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:36:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-12222] deserialize RoaringBitmap using Kryo serializer throw Buffer underflow exception</title>
                <link>https://issues.apache.org/jira/browse/SPARK-12222</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;here are some problems when deserialize RoaringBitmap. see the examples below:&lt;br/&gt;
run this piece of code&lt;br/&gt;
```&lt;br/&gt;
import com.esotericsoftware.kryo.io.&lt;/p&gt;
{Input =&amp;gt; KryoInput, Output =&amp;gt; KryoOutput}
&lt;p&gt;import java.io.DataInput&lt;/p&gt;

&lt;p&gt;    class KryoInputDataInputBridge(input: KryoInput) extends DataInput &lt;/p&gt;
{
      override def readLong(): Long = input.readLong()
      override def readChar(): Char = input.readChar()
      override def readFloat(): Float = input.readFloat()
      override def readByte(): Byte = input.readByte()
      override def readShort(): Short = input.readShort()
      override def readUTF(): String = input.readString() // readString in kryo does utf8
      override def readInt(): Int = input.readInt()
      override def readUnsignedShort(): Int = input.readShortUnsigned()
      override def skipBytes(n: Int): Int = input.skip(n.toLong).toInt
      override def readFully(b: Array[Byte]): Unit = input.read(b)
      override def readFully(b: Array[Byte], off: Int, len: Int): Unit = input.read(b, off, len)
      override def readLine(): String = throw new UnsupportedOperationException(&quot;readLine&quot;)
      override def readBoolean(): Boolean = input.readBoolean()
      override def readUnsignedByte(): Int = input.readByteUnsigned()
      override def readDouble(): Double = input.readDouble()
    }

&lt;p&gt;    class KryoOutputDataOutputBridge(output: KryoOutput) extends DataOutput &lt;/p&gt;
{
      override def writeFloat(v: Float): Unit = output.writeFloat(v)
      // There is no &quot;readChars&quot; counterpart, except maybe &quot;readLine&quot;, which is not supported
      override def writeChars(s: String): Unit = throw new UnsupportedOperationException(&quot;writeChars&quot;)
      override def writeDouble(v: Double): Unit = output.writeDouble(v)
      override def writeUTF(s: String): Unit = output.writeString(s) // writeString in kryo does UTF8
      override def writeShort(v: Int): Unit = output.writeShort(v)
      override def writeInt(v: Int): Unit = output.writeInt(v)
      override def writeBoolean(v: Boolean): Unit = output.writeBoolean(v)
      override def write(b: Int): Unit = output.write(b)
      override def write(b: Array[Byte]): Unit = output.write(b)
      override def write(b: Array[Byte], off: Int, len: Int): Unit = output.write(b, off, len)
      override def writeBytes(s: String): Unit = output.writeString(s)
      override def writeChar(v: Int): Unit = output.writeChar(v.toChar)
      override def writeLong(v: Long): Unit = output.writeLong(v)
      override def writeByte(v: Int): Unit = output.writeByte(v)
    }
&lt;p&gt;    val outStream = new FileOutputStream(&quot;D:&lt;br class=&quot;atl-forced-newline&quot; /&gt;wfserde&quot;)&lt;br/&gt;
    val output = new KryoOutput(outStream)&lt;br/&gt;
    val bitmap = new RoaringBitmap&lt;br/&gt;
    bitmap.add(1)&lt;br/&gt;
    bitmap.add(3)&lt;br/&gt;
    bitmap.add(5)&lt;br/&gt;
    bitmap.serialize(new KryoOutputDataOutputBridge(output))&lt;br/&gt;
    output.flush()&lt;br/&gt;
    output.close()&lt;/p&gt;

&lt;p&gt;    val inStream = new FileInputStream(&quot;D:&lt;br class=&quot;atl-forced-newline&quot; /&gt;wfserde&quot;)&lt;br/&gt;
    val input = new KryoInput(inStream)&lt;br/&gt;
    val ret = new RoaringBitmap&lt;br/&gt;
    ret.deserialize(new KryoInputDataInputBridge(input))&lt;/p&gt;

&lt;p&gt;    println(ret)&lt;br/&gt;
```&lt;/p&gt;

&lt;p&gt;this will throw `Buffer underflow` error:&lt;br/&gt;
```&lt;br/&gt;
com.esotericsoftware.kryo.KryoException: Buffer underflow.&lt;br/&gt;
	at com.esotericsoftware.kryo.io.Input.require(Input.java:156)&lt;br/&gt;
	at com.esotericsoftware.kryo.io.Input.skip(Input.java:131)&lt;br/&gt;
	at com.esotericsoftware.kryo.io.Input.skip(Input.java:264)&lt;br/&gt;
	at org.apache.spark.sql.SQLQuerySuite$$anonfun$6$KryoInputDataInputBridge$1.skipBytes&lt;br/&gt;
```&lt;/p&gt;

&lt;p&gt;after same investigation,  i found this is caused by a bug of kryo&apos;s `Input.skip(long count)`(&lt;a href=&quot;https://github.com/EsotericSoftware/kryo/issues/119&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/EsotericSoftware/kryo/issues/119&lt;/a&gt;) and we call this method in `KryoInputDataInputBridge`.&lt;/p&gt;

&lt;p&gt;So i think we can fix this issue in this two ways:&lt;br/&gt;
1) upgrade the kryo version to 2.23.0 or 2.24.0, which has fix this bug in kryo (i am not sure the upgrade is safe in spark, can you check it? @davies )&lt;/p&gt;

&lt;p&gt;2) we can bypass the  kryo&apos;s `Input.skip(long count)` by directly call another `skip` method in kryo&apos;s Input.java(&lt;a href=&quot;https://github.com/EsotericSoftware/kryo/blob/kryo-2.21/src/com/esotericsoftware/kryo/io/Input.java#L124&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/EsotericSoftware/kryo/blob/kryo-2.21/src/com/esotericsoftware/kryo/io/Input.java#L124&lt;/a&gt;), i.e. write the bug-fixed version of `Input.skip(long count)` in KryoInputDataInputBridge&apos;s `skipBytes` method:&lt;br/&gt;
```&lt;br/&gt;
   class KryoInputDataInputBridge(input: KryoInput) extends DataInput {&lt;br/&gt;
      ...&lt;br/&gt;
      override def skipBytes(n: Int): Int = {&lt;br/&gt;
        var remaining: Long = n&lt;br/&gt;
        while (remaining &amp;gt; 0) &lt;/p&gt;
{
          val skip = Math.min(Integer.MAX_VALUE, remaining).asInstanceOf[Int]
          input.skip(skip)
          remaining -= skip
        }
&lt;p&gt;        n&lt;br/&gt;
     }&lt;br/&gt;
      ...&lt;br/&gt;
    }&lt;br/&gt;
```&lt;/p&gt;</description>
                <environment></environment>
        <key id="12920260">SPARK-12222</key>
            <summary>deserialize RoaringBitmap using Kryo serializer throw Buffer underflow exception</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="scwf">Fei Wang</assignee>
                                    <reporter username="scwf">Fei Wang</reporter>
                        <labels>
                    </labels>
                <created>Wed, 9 Dec 2015 01:12:00 +0000</created>
                <updated>Thu, 10 Dec 2015 13:10:06 +0000</updated>
                            <resolved>Wed, 9 Dec 2015 05:33:12 +0000</resolved>
                                    <version>1.6.0</version>
                                    <fixVersion>1.6.0</fixVersion>
                    <fixVersion>2.0.0</fixVersion>
                                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15047917" author="apachespark" created="Wed, 9 Dec 2015 02:53:47 +0000"  >&lt;p&gt;User &apos;scwf&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/10213&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/10213&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15048076" author="davies" created="Wed, 9 Dec 2015 05:33:12 +0000"  >&lt;p&gt;Issue resolved by pull request 10213&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/10213&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/10213&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15050945" author="apachespark" created="Thu, 10 Dec 2015 13:10:06 +0000"  >&lt;p&gt;User &apos;adrian-wang&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/10253&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/10253&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 49 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2pmqv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>