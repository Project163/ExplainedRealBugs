<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:16:17 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-2650] Caching tables larger than memory causes OOMs</title>
                <link>https://issues.apache.org/jira/browse/SPARK-2650</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;The logic for setting up the initial column buffers is different for Spark SQL compared to Shark and I&apos;m seeing OOMs when caching tables that are larger than available memory (where shark was okay).&lt;/p&gt;

&lt;p&gt;Two suspicious things: the intialSize is always set to 0 so we always go with the default.  The default looks like it was copied from code like 10 * 1024 * 1024... but in Spark SQL its 10 * 102 * 1024.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12729227">SPARK-2650</key>
            <summary>Caching tables larger than memory causes OOMs</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="marmbrus">Michael Armbrust</assignee>
                                    <reporter username="marmbrus">Michael Armbrust</reporter>
                        <labels>
                    </labels>
                <created>Wed, 23 Jul 2014 18:13:41 +0000</created>
                <updated>Tue, 12 Aug 2014 06:12:10 +0000</updated>
                            <resolved>Tue, 12 Aug 2014 03:22:50 +0000</resolved>
                                    <version>1.0.0</version>
                    <version>1.0.1</version>
                                    <fixVersion>1.1.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14084397" author="lian cheng" created="Mon, 4 Aug 2014 07:31:56 +0000"  >&lt;p&gt;Did some experiments and came to some conclusions:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Needless to say, the &lt;tt&gt;10 * 1024 * 104&lt;/tt&gt; is definitely a typo, but it&apos;s not related to the OOMs. More reasonable initial buffer sizes don&apos;t help solving these OOMs.&lt;/li&gt;
	&lt;li&gt;The OOMs are also not related to whether the table size is larger than available memory. The cause is that the process of building in-memory columnar buffers is memory consuming, and multiple tasks building buffers in parallel eat too much memory altogether.&lt;/li&gt;
	&lt;li&gt;According to 2, reducing parallelism or increasing executor memory can workaround this issue. For example, a &lt;tt&gt;HiveThriftServer2&lt;/tt&gt; started with default executor memory (512MB) and &lt;tt&gt;--total-executor-cores=1&lt;/tt&gt; could cache a 1.7GB table.&lt;/li&gt;
	&lt;li&gt;Shark performs better than Spark SQL in this case, but still OOMs when the table gets larger: caching a 1.8GB table with default Shark configurations makes Shark OOM too.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I&apos;m investigating why Spark SQL consumes more memory than Shark when building in-memory columnar buffers.&lt;/p&gt;</comment>
                            <comment id="14085104" author="lian cheng" created="Mon, 4 Aug 2014 19:03:49 +0000"  >&lt;p&gt;Some additional comments after more experiments and some improvements:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;How exactly the OOMs occur when caching a large table (assume N cores and M memory are available within a single executor):
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;Say the table is so large that the underlying RDD is divided into X partitions (usually X &amp;gt;&amp;gt; N, let&apos;s assume this here)&lt;/li&gt;
		&lt;li&gt;When caching the table, N tasks are executed in parallel, building column buffers, each of them is memory consuming. Say, each task consumes Y memory in average.&lt;/li&gt;
		&lt;li&gt;At some point, memory consumptions of all N parallel tasks altogether, namely N * Y exceeds M, and an OOM is thrown&lt;/li&gt;
		&lt;li&gt;All tasks fail and retry, but fail again, until the driver stops retrying, and the job fail&lt;/li&gt;
		&lt;li&gt;I guess the reason that this issue hasn&apos;t been reported is that, usually N * Y &amp;lt; holds in production.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;Initial buffer sizes do affect the OOMs in a subtle way:
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;Too large an initial buffer size implies, apparently, larger memory consumption&lt;/li&gt;
		&lt;li&gt;Too small an initial buffer size causes the &lt;tt&gt;ColumnBuilder&lt;/tt&gt; keeps allocating larger buffers to ensure enough free space to hold more elements (12.5% larger at a time). Thus 212.5% larger space is required to finish growing a buffer (112.5% for the new buffer + 100% for the original one).&lt;/li&gt;
		&lt;li&gt;A well estimated initial buffer size should be 1) large enough to avoid buffer growing, and 2) small enough to avoid memory waste. For example, by hand tuning, 5MB can be a good initial size for an executor with 512M memory and 1 core to cache a 1.7GB table without any problem. But this value varies between different cluster configurations.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;An apparent approach to help fixing this issue is to try reducing the memory consumption during the column building process.
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;&lt;a href=&quot;https://github.com/apache/spark/pull/1769&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR #1769&lt;/a&gt; is submitted to reduce memory consumption of the column building proces.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;Another approach is to estimate the initial buffer size. To do this, Shark uses an estimated table partition size by leveraging HDFS block size and column element default size. We can use similar approach in Spark SQL for Hive tables, and some configurable initial size for non-Hive tables.
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;Currently &lt;tt&gt;InMemoryRelation&lt;/tt&gt; resides in package &lt;tt&gt;org.apache.spark.sql.columnar&lt;/tt&gt; and doesn&apos;t know anything about Hive tables. We can add an &lt;tt&gt;estimatedPartitionSize&lt;/tt&gt; method, and override it in a new &lt;tt&gt;InMemoryMetastoreRelation&lt;/tt&gt; to estimate RDD partition sizes of a Hive table. This will be done in another separate PR.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="14085115" author="apachespark" created="Mon, 4 Aug 2014 19:07:43 +0000"  >&lt;p&gt;User &apos;liancheng&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/1769&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/1769&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14092209" author="apachespark" created="Sun, 10 Aug 2014 21:27:20 +0000"  >&lt;p&gt;User &apos;marmbrus&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/1880&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/1880&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14093785" author="apachespark" created="Tue, 12 Aug 2014 06:12:10 +0000"  >&lt;p&gt;User &apos;liancheng&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/1901&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/1901&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12732487">SPARK-2902</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>407301</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 15 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1y36n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>407317</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12326686">1.1.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>