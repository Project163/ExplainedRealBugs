<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:30:25 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-39839] Handle special case of null variable-length Decimal with non-zero offsetAndSize in UnsafeRow structural integrity check</title>
                <link>https://issues.apache.org/jira/browse/SPARK-39839</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;The &lt;tt&gt;UnsafeRow&lt;/tt&gt; structural integrity check in &lt;tt&gt;UnsafeRowUtils.validateStructuralIntegrity&lt;/tt&gt; is added in Spark 3.1.0. It&#8217;s supposed to validate that a given &lt;tt&gt;UnsafeRow&lt;/tt&gt; conforms to the format that the &lt;tt&gt;UnsafeRowWriter&lt;/tt&gt; would have produced.&lt;/p&gt;

&lt;p&gt;Currently the check expects all fields that are marked as null should also have its field (i.e. the fixed-length part) set to all zeros. It needs to be updated to handle a special case for variable-length &lt;tt&gt;Decimal&lt;/tt&gt;s, where the &lt;tt&gt;UnsafeRowWriter&lt;/tt&gt; may mark a field as null but also leave the fixed-length part of the field as &lt;tt&gt;OffsetAndSize(offset=current_offset, size=0)&lt;/tt&gt;. This may happen when the &lt;tt&gt;Decimal&lt;/tt&gt; being written is either a real &lt;tt&gt;null&lt;/tt&gt; or has overflowed the specified precision.&lt;/p&gt;

&lt;p&gt;Logic in &lt;tt&gt;UnsafeRowWriter&lt;/tt&gt;:&lt;/p&gt;

&lt;p&gt;in general:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-scala&quot;&gt;
&#160; public void setNullAt(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; ordinal) {
&#160; &#160; BitSetMethods.set(getBuffer(), startingOffset, ordinal); &lt;span class=&quot;code-comment&quot;&gt;// set &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; bit
&lt;/span&gt;&#160; &#160; write(ordinal, 0L); &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&lt;span class=&quot;code-comment&quot;&gt;// also zero out the fixed-length field
&lt;/span&gt;&#160; } &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;special case for &lt;tt&gt;DecimalType&lt;/tt&gt;:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-scala&quot;&gt;
&#160; &#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// Make sure Decimal &lt;span class=&quot;code-keyword&quot;&gt;object&lt;/span&gt; has the same scale as DecimalType.
&lt;/span&gt;&#160; &#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// Note that we may pass in &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; Decimal &lt;span class=&quot;code-keyword&quot;&gt;object&lt;/span&gt; to set &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; it.
&lt;/span&gt;&#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (input == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || !input.changePrecision(precision, scale)) {
&#160; &#160; &#160; &#160; BitSetMethods.set(getBuffer(), startingOffset, ordinal); &lt;span class=&quot;code-comment&quot;&gt;// set &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; bit
&lt;/span&gt;&#160; &#160; &#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// keep the offset &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; future update
&lt;/span&gt;&#160; &#160; &#160; &#160; setOffsetAndSize(ordinal, 0); &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&lt;span class=&quot;code-comment&quot;&gt;// doesn&apos;t zero out the fixed-length field
&lt;/span&gt;&#160; &#160; &#160; } &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The special case is introduced to allow all {{DecimalType}}s (including both fixed-length and variable-length ones) to be mutable &#8211; thus need to leave space for the variable-length field even if it&#8217;s currently null.&lt;/p&gt;

&lt;p&gt;Note that this special case in &lt;tt&gt;UnsafeRowWriter&lt;/tt&gt; has been there since Spark 1.6.0, where as the integrity check was added in Spark 3.1.0. The check was originally added for Structured Streaming&#8217;s checkpoint evolution validation, so that a newer version of Spark can check whether or not an older checkpoint file for Structured Streaming queries can be supported, and/or if the contents of the checkpoint file is corrupted.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13472840">SPARK-39839</key>
            <summary>Handle special case of null variable-length Decimal with non-zero offsetAndSize in UnsafeRow structural integrity check</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rednaxelafx">Kris Mok</assignee>
                                    <reporter username="rednaxelafx">Kris Mok</reporter>
                        <labels>
                    </labels>
                <created>Fri, 22 Jul 2022 07:19:52 +0000</created>
                <updated>Thu, 28 Jul 2022 00:18:55 +0000</updated>
                            <resolved>Thu, 28 Jul 2022 00:18:55 +0000</resolved>
                                    <version>3.1.0</version>
                    <version>3.2.0</version>
                    <version>3.3.0</version>
                                    <fixVersion>3.3.1</fixVersion>
                    <fixVersion>3.2.3</fixVersion>
                    <fixVersion>3.4.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17569847" author="apachespark" created="Fri, 22 Jul 2022 07:26:50 +0000"  >&lt;p&gt;User &apos;rednaxelafx&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/37252&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/37252&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17572175" author="kabhwan" created="Thu, 28 Jul 2022 00:18:55 +0000"  >&lt;p&gt;Issue resolved by pull request 37252&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/37252&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/37252&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 15 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z172ts:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>