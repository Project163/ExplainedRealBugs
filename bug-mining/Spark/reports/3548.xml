<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:43:38 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-15282] UDF executed twice when filter on new column created by withColumn and the final value may be not correct</title>
                <link>https://issues.apache.org/jira/browse/SPARK-15282</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;I found this problem on spark version 1.6.1 and based on  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tedyu&quot; class=&quot;user-hover&quot; rel=&quot;tedyu&quot;&gt;tedyu&lt;/a&gt; in current master branch, the behavior is the same.&lt;br/&gt;
Basically, i used udf and df.withColumn to create a &quot;new&quot; column, and then i filter the values on this new columns and call show(action). I see the udf function (which is used to by withColumn to create the new column) is called twice(duplicated). And if filter on &quot;old&quot; column, udf only run once which is expected. I attached the example codes,  `filteredOnNewColumnDF.show` shows the problem.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;spark-shell&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;scala&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.sql.functions._
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.sql.functions._

scala&amp;gt; val df = sc.parallelize(Seq((&lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;b&quot;&lt;/span&gt;), (&lt;span class=&quot;code-quote&quot;&gt;&quot;a1&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;b1&quot;&lt;/span&gt;))).toDF(&lt;span class=&quot;code-quote&quot;&gt;&quot;old&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;old1&quot;&lt;/span&gt;)
df: org.apache.spark.sql.DataFrame = [old: string, old1: string]

scala&amp;gt; val udfFunc = udf((s: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;) =&amp;gt; {println(s&lt;span class=&quot;code-quote&quot;&gt;&quot;running udf($s)&quot;&lt;/span&gt;); s })
udfFunc: org.apache.spark.sql.UserDefinedFunction = UserDefinedFunction(&amp;lt;function1&amp;gt;,StringType,List(StringType))

scala&amp;gt; val newDF = df.withColumn(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt;&quot;&lt;/span&gt;, udfFunc(df(&lt;span class=&quot;code-quote&quot;&gt;&quot;old&quot;&lt;/span&gt;)))
newDF: org.apache.spark.sql.DataFrame = [old: string, old1: string, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt;: string]

scala&amp;gt; newDF.show
running udf(a)
running udf(a1)
+---+----+---+
|old|old1|&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt;|
+---+----+---+
|  a|   b|  a|
| a1|  b1| a1|
+---+----+---+


scala&amp;gt; val filteredOnNewColumnDF = newDF.filter(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &amp;lt;&amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&apos;a1&apos;&lt;/span&gt;&quot;&lt;/span&gt;)
filteredOnNewColumnDF: org.apache.spark.sql.DataFrame = [old: string, old1: string, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt;: string]

scala&amp;gt; val filteredOnOldColumnDF = newDF.filter(&lt;span class=&quot;code-quote&quot;&gt;&quot;old &amp;lt;&amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&apos;a1&apos;&lt;/span&gt;&quot;&lt;/span&gt;)
filteredOnOldColumnDF: org.apache.spark.sql.DataFrame = [old: string, old1: string, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt;: string]

scala&amp;gt; filteredOnNewColumnDF.show
running udf(a)
running udf(a)
running udf(a1)
+---+----+---+
|old|old1|&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt;|
+---+----+---+
|  a|   b|  a|
+---+----+---+


scala&amp;gt; filteredOnOldColumnDF.show
running udf(a)
+---+----+---+
|old|old1|&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt;|
+---+----+---+
|  a|   b|  a|
+---+----+---+

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;b&gt;Updated: user-defined functions must be deterministic. Due to optimization, duplicate invocations may be eliminated or the function may even be invoked more times than it is present in the query.&lt;/b&gt; refer to &lt;a href=&quot;https://github.com/apache/spark/pull/13087&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/13087&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;For our certain use case, I want to add more detail descriptions. In our project, firstly we generated a dataframe with one column called &quot;fileName&quot; one column called &quot;url&quot;, and then we use a udf function (used inside withColumn()) to download the files from the corresponding urls and filter out &apos;{}&apos; data before writing to hdfs:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;scala&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;// df: DataFrame[&lt;span class=&quot;code-quote&quot;&gt;&quot;fileName&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;url&quot;&lt;/span&gt;] 
&lt;/span&gt;val getDataUDF = udf((url: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;) =&amp;gt; {
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; { 
       download data
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; { &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; e: Exception =&amp;gt;
      &lt;span class=&quot;code-quote&quot;&gt;&quot;{}&quot;&lt;/span&gt;
    }
  })
val df2 = df.withColumn(&lt;span class=&quot;code-quote&quot;&gt;&quot;data&quot;&lt;/span&gt;, getDataUDF(df(&lt;span class=&quot;code-quote&quot;&gt;&quot;url&quot;&lt;/span&gt;)))
            .filter(&lt;span class=&quot;code-quote&quot;&gt;&quot;data &amp;lt;&amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&apos;{}&apos;&lt;/span&gt;&quot;&lt;/span&gt;)
df2.write.save(&lt;span class=&quot;code-quote&quot;&gt;&quot;hdfs path&quot;&lt;/span&gt;)

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Based on our logs, each file will be downloaded twice. As for the running time, the writing job with filter will be twice as the one without filter.&lt;/p&gt;

&lt;p&gt;Another problem is about data correctness. Because it&apos;s downloaded twice for each file, we came across some cases that the first downloading (getDataUDF) can get data (not &apos;{}&apos;), and the second downloading return &apos;{}&apos; because of certain connection exception. But i found the filter only worked on the first returned value so that spark will not remove this row but the value inside &quot;data&quot; column was &apos;{}&apos; which is the second returned value. &lt;b&gt;Even after filter, we get the result dataframe df2 like the follows (file2 with &apos;{}&apos; data should be removed)&lt;/b&gt;:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;fileName&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;url&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;data &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;     file1       &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;   url1    &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;    sth  &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;     file2       &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;   url2    &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;    &apos;{}&apos;   &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;&lt;b&gt;So on the high level, we still get &apos;{}&apos; data after filtering out &apos;{}&apos;, which is strange. The reason I think is that UDF function is executed twice when filter on new column created by withColumn, and two returned values are different: first one makes filter condition true and second one makes filter condition false. The dataframe will keep the second value which in fact should not appear after filter operation.&lt;/b&gt;&lt;/p&gt;
</description>
                <environment>&lt;p&gt;spark 1.6.1&lt;/p&gt;</environment>
        <key id="12968163">SPARK-15282</key>
            <summary>UDF executed twice when filter on new column created by withColumn and the final value may be not correct</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="3">Duplicate</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="linbojin">Linbo</reporter>
                        <labels>
                    </labels>
                <created>Thu, 12 May 2016 00:46:32 +0000</created>
                <updated>Wed, 13 Dec 2017 14:12:52 +0000</updated>
                            <resolved>Wed, 13 Dec 2017 14:12:52 +0000</resolved>
                                    <version>1.6.1</version>
                                                    <component>SQL</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="15281075" author="linbojin" created="Thu, 12 May 2016 00:54:25 +0000"  >&lt;p&gt;There is a related JIRA issue: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-13773&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SPARK-13773&lt;/a&gt; , not sure the problem is same.&lt;/p&gt;</comment>
                            <comment id="15281374" author="linbojin" created="Thu, 12 May 2016 09:40:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=marmbrus&quot; class=&quot;user-hover&quot; rel=&quot;marmbrus&quot;&gt;marmbrus&lt;/a&gt; Any suggestion? &lt;/p&gt;</comment>
                            <comment id="15282284" author="apachespark" created="Fri, 13 May 2016 00:33:03 +0000"  >&lt;p&gt;User &apos;dongjoon-hyun&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/13087&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/13087&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15297105" author="dongjoon" created="Mon, 23 May 2016 21:20:38 +0000"  >&lt;p&gt;Ah, I can not remove my PR links due to permissions.&lt;br/&gt;
Please ignore PR-13087.&lt;/p&gt;</comment>
                            <comment id="15297569" author="linbojin" created="Tue, 24 May 2016 02:55:32 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dongjoon&quot; class=&quot;user-hover&quot; rel=&quot;dongjoon&quot;&gt;dongjoon&lt;/a&gt;, I removed the link and also add more detail descriptions about our problem. Thank you very much for your help.&lt;/p&gt;</comment>
                            <comment id="15297719" author="dongjoon" created="Tue, 24 May 2016 05:38:24 +0000"  >&lt;p&gt;Thank you, @Linbo.&lt;br/&gt;
My approaches (defining ScalaUDF deterministic or changing PushDownPredicate optimizer) were not proper for this PR.&lt;br/&gt;
Sorry for that.&lt;/p&gt;</comment>
                            <comment id="16286951" author="cloud_fan" created="Tue, 12 Dec 2017 01:43:35 +0000"  >&lt;p&gt;Shall we resolve this ticket as now users can mark their UDFs as non-deterministic?&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="13068836">SPARK-20586</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 49 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2xpa7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>