<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:34:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-11655] SparkLauncherBackendSuite leaks child processes</title>
                <link>https://issues.apache.org/jira/browse/SPARK-11655</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;We&apos;ve been combatting an orphaned process issue on AMPLab Jenkins since October and I finally was able to dig in and figure out what&apos;s going on.&lt;/p&gt;

&lt;p&gt;After some sleuthing and working around OS limits and JDK bugs, I was able to get the full launch commands for the hanging orphaned processes. It looks like they&apos;re all running spark-submit:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;org.apache.spark.deploy.SparkSubmit --master local-cluster[1,1,1024] --conf spark.driver.extraClassPath=/home/jenkins/workspace/Spark-Master-SBT/AMPLAB_JENKINS_BUILD_PROFILE/hadoop2.0/label/spark-test/core/target/scala-2.10/test-classes:/home/jenkins/workspace/Spark-Master-SBT/AMPLAB_JENKINS_BUILD_PROFILE/hadoop2.0/label/spark-test/core/target/scala-2.10/classes:/home/jenkins/workspace/Spark-Master-SBT/AMPLAB_JENKINS_BUILD_PROFILE/hadoop2.0/label/spark-test/launcher/target/scala-2.10/classes:/home/jenkins/workspace/Spark-Master-SBT/AMPLAB_JENKINS_BUILD_PROFILE/hadoop2.0/label/spark-test/network/common/target/scala-2.10/classes:/home/jenkins/workspace/Spark-Master-SBT/AMPLAB_JENKINS_BUILD_PROFILE/hadoop2.0/label/spark-test/network/shuffle/target/scala-2.10/classes:/home/jenkins/workspace/Spark-Master-SBT/AMPLAB_JENKINS_BUILD_PROFILE/hadoop2.0/label/spark-test/unsafe/target/scala-2.10/classes:/home/jenkins/workspace/Spark-Master-SBT/AMPLAB_JENKINS_BUILD_PROFILE/hadoop2.0/label/spark-test/tags/target/scala-2.10/ -Xms1g -Xmx1g -Dtest.appender=console -XX:MaxPermSize=256m
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Based on the output of some Ganglia graphs, I was able to figure out that these leaks started around October 9.&lt;/p&gt;

&lt;p&gt; &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;a id=&quot;12771748_thumb&quot; href=&quot;https://issues.apache.org/jira/secure/attachment/12771748/12771748_screenshot-1.png&quot; title=&quot;screenshot-1.png&quot; file-preview-type=&quot;image&quot; file-preview-id=&quot;12771748&quot; file-preview-title=&quot;screenshot-1.png&quot;&gt;&lt;img style=&quot;border: 0px solid black&quot; role=&quot;presentation&quot;/&gt;&lt;/a&gt;&lt;/span&gt; &lt;/p&gt;

&lt;p&gt;This roughly lines up with when &lt;a href=&quot;https://github.com/apache/spark/pull/7052&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/7052&lt;/a&gt; was merged, which added LauncherBackendSuite. The launch arguments used in this suite seem to line up with the arguments that I observe in the hanging processes&apos; &lt;tt&gt;jps&lt;/tt&gt; output: &lt;a href=&quot;https://github.com/apache/spark/blame/1bc41125ee6306e627be212969854f639969c440/core/src/test/scala/org/apache/spark/launcher/LauncherBackendSuite.scala#L46&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blame/1bc41125ee6306e627be212969854f639969c440/core/src/test/scala/org/apache/spark/launcher/LauncherBackendSuite.scala#L46&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Interestingly, Jenkins doesn&apos;t show test timing or output for this suite! I think that what might be happening is that we have a mixed Scala/Java package, so maybe the two test runner XML files aren&apos;t being merged properly: &lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins/job/Spark-1.5-SBT/746/AMPLAB_JENKINS_BUILD_PROFILE=hadoop1.0,label=spark-test/testReport/org.apache.spark.launcher/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins/job/Spark-1.5-SBT/746/AMPLAB_JENKINS_BUILD_PROFILE=hadoop1.0,label=spark-test/testReport/org.apache.spark.launcher/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Whenever I try running this suite locally, it looks like it ends up creating a zombie SparkSubmit process! I think that what&apos;s happening is that the launcher&apos;s &lt;tt&gt;handle.kill()&lt;/tt&gt; call ends up destroying the bash &lt;tt&gt;spark-submit&lt;/tt&gt; subprocess such that its child process (a JVM) leaks.&lt;/p&gt;

&lt;p&gt;I think that we&apos;ll have to do something similar to what we do in PySpark when launching a child JVM from a Python / Bash process: connect it to a socket or stream such that it can detect its parent&apos;s death and clean up after itself appropriately.&lt;/p&gt;

&lt;p&gt;/cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shaneknapp&quot; class=&quot;user-hover&quot; rel=&quot;shaneknapp&quot;&gt;shaneknapp&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vanzin&quot; class=&quot;user-hover&quot; rel=&quot;vanzin&quot;&gt;vanzin&lt;/a&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12912180">SPARK-11655</key>
            <summary>SparkLauncherBackendSuite leaks child processes</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="vanzin">Marcelo Masiero Vanzin</assignee>
                                    <reporter username="joshrosen">Josh Rosen</reporter>
                        <labels>
                    </labels>
                <created>Wed, 11 Nov 2015 14:11:26 +0000</created>
                <updated>Wed, 18 Nov 2015 19:06:57 +0000</updated>
                            <resolved>Wed, 18 Nov 2015 19:06:57 +0000</resolved>
                                    <version>1.6.0</version>
                                    <fixVersion>1.6.0</fixVersion>
                                    <component>Tests</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15000424" author="shaneknapp" created="Wed, 11 Nov 2015 14:24:29 +0000"  >&lt;p&gt;actually, this started back in mid-may, but the impact definitely ramped up in october.   if you look at the attached graph, you&apos;ll see the overall process count ramp up then.  i was out of the office for most of august, and you can see the effect of me not being around to keep an eye on things.  then in october, things got REALLY bad (see second attached) and i started killing off the hanging processes daily, as evidenced by the sawtooth pattern.&lt;/p&gt;

&lt;p&gt;this affects all spark-test builds, btw.&lt;/p&gt;

&lt;p&gt;that being said, i like the socket/stream solution...  nice find!&lt;/p&gt;</comment>
                            <comment id="15000739" author="vanzin" created="Wed, 11 Nov 2015 17:31:21 +0000"  >&lt;p&gt;I&apos;ll take a look at the code.&lt;/p&gt;</comment>
                            <comment id="15000856" author="apachespark" created="Wed, 11 Nov 2015 18:27:05 +0000"  >&lt;p&gt;User &apos;vanzin&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/9633&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/9633&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15006978" author="shaneknapp" created="Mon, 16 Nov 2015 17:41:31 +0000"  >&lt;p&gt;just wanted to say that things are definitely looking a LOT better!  i&apos;ll keep an eye on things this week, but we&apos;re definitely out of the woods.&lt;/p&gt;

&lt;p&gt;thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=joshrosen&quot; class=&quot;user-hover&quot; rel=&quot;joshrosen&quot;&gt;joshrosen&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vanzin&quot; class=&quot;user-hover&quot; rel=&quot;vanzin&quot;&gt;vanzin&lt;/a&gt;!&lt;/p&gt;</comment>
                            <comment id="15011653" author="shaneknapp" created="Wed, 18 Nov 2015 18:48:43 +0000"  >&lt;p&gt;this is still happening, but nowhere nearly as much as before.&lt;/p&gt;

&lt;p&gt;the spark 1.6 SBT hadoop 2.0 build just timed out on jenkins, and left a hanging process that&apos;s eating up CPU on amp-jenkins-worker-02:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins/job/Spark-1.6-SBT/AMPLAB_JENKINS_BUILD_PROFILE=hadoop2.0,label=spark-test/56/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins/job/Spark-1.6-SBT/AMPLAB_JENKINS_BUILD_PROFILE=hadoop2.0,label=spark-test/56/console&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;it times out, as i&apos;ve noticed on other builds, while running the HiveThriftBinaryServerSuite tests.&lt;/p&gt;

&lt;p&gt;the PID on that worker is 201960...  i&apos;ll leave it alone and not kill it for now.&lt;/p&gt;</comment>
                            <comment id="15011671" author="vanzin" created="Wed, 18 Nov 2015 18:55:08 +0000"  >&lt;p&gt;That test doesn&apos;t use the launcher code, so it&apos;s most probably a different issue. I&apos;ll attach the jstack log to this bug just because there isn&apos;t a better place currently to do that.&lt;/p&gt;</comment>
                            <comment id="15011687" author="shaneknapp" created="Wed, 18 Nov 2015 18:59:47 +0000"  >&lt;p&gt;ah ok, good to know.  i&apos;ll kill that process now, if it&apos;s cool.&lt;/p&gt;</comment>
                            <comment id="15011700" author="vanzin" created="Wed, 18 Nov 2015 19:04:08 +0000"  >&lt;p&gt;yeah, it&apos;s fine. Also probably good to file a separate bug with the stack.log file I just attached.&lt;/p&gt;</comment>
                            <comment id="15011703" author="shaneknapp" created="Wed, 18 Nov 2015 19:05:40 +0000"  >&lt;p&gt;sounds good to me.  you can re-close this bug and i&apos;ll open a new one.&lt;br/&gt;
thanks, marcelo!&lt;/p&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12771751" name="month_of_doom.png" size="43660" author="shaneknapp" created="Wed, 11 Nov 2015 14:18:47 +0000"/>
                            <attachment id="12771748" name="screenshot-1.png" size="194835" author="joshrosen" created="Wed, 11 Nov 2015 14:11:50 +0000"/>
                            <attachment id="12773045" name="stack.log" size="106460" author="vanzin" created="Wed, 18 Nov 2015 18:55:48 +0000"/>
                            <attachment id="12771752" name="year_or_doom.png" size="35829" author="shaneknapp" created="Wed, 11 Nov 2015 14:18:47 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2o8zz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12333083">1.6.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>