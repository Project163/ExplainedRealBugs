<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:57:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-22431] Creating Permanent view with illegal type</title>
                <link>https://issues.apache.org/jira/browse/SPARK-22431</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;It is possible in Spark SQL to create a permanent view that uses an nested field with an illegal name.&lt;/p&gt;

&lt;p&gt;For example if we create the following view:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;create view x as select struct(&apos;a&apos; as `$q`, 1 as b) q
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;A simple select fails with the following exception:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;select * from x;

org.apache.spark.SparkException: Cannot recognize hive type string: struct&amp;lt;$q:string,b:int&amp;gt;
  at org.apache.spark.sql.hive.client.HiveClientImpl$.fromHiveColumn(HiveClientImpl.scala:812)
  at org.apache.spark.sql.hive.client.HiveClientImpl$$anonfun$getTableOption$1$$anonfun$apply$11$$anonfun$7.apply(HiveClientImpl.scala:378)
  at org.apache.spark.sql.hive.client.HiveClientImpl$$anonfun$getTableOption$1$$anonfun$apply$11$$anonfun$7.apply(HiveClientImpl.scala:378)
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Dropping the view isn&apos;t possible either:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;drop view x;

org.apache.spark.SparkException: Cannot recognize hive type string: struct&amp;lt;$q:string,b:int&amp;gt;
  at org.apache.spark.sql.hive.client.HiveClientImpl$.fromHiveColumn(HiveClientImpl.scala:812)
  at org.apache.spark.sql.hive.client.HiveClientImpl$$anonfun$getTableOption$1$$anonfun$apply$11$$anonfun$7.apply(HiveClientImpl.scala:378)
  at org.apache.spark.sql.hive.client.HiveClientImpl$$anonfun$getTableOption$1$$anonfun$apply$11$$anonfun$7.apply(HiveClientImpl.scala:378)
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13115766">SPARK-22431</key>
            <summary>Creating Permanent view with illegal type</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ksunitha">Sunitha Kambhampati</assignee>
                                    <reporter username="hvanhovell">Herman van H&#246;vell</reporter>
                        <labels>
                    </labels>
                <created>Thu, 2 Nov 2017 22:15:30 +0000</created>
                <updated>Tue, 28 Nov 2017 21:09:23 +0000</updated>
                            <resolved>Tue, 28 Nov 2017 21:09:23 +0000</resolved>
                                    <version>2.2.0</version>
                                    <fixVersion>2.3.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="16249505" author="ksunitha" created="Mon, 13 Nov 2017 12:30:49 +0000"  >&lt;p&gt;&lt;b&gt;Observations:&lt;/b&gt;&lt;br/&gt;
I ran a few tests with the STRUCT containing a `$a` and for the following scenarios:&lt;br/&gt;
a) create table, b) create view, c) create datasource table against the hive and in-memory catalog.   &lt;/p&gt;

&lt;p&gt;&lt;b&gt;A. Hive Catalog&lt;/b&gt;&lt;br/&gt;
&lt;ins&gt;1. Create Table (CTAS) - illegal type&lt;/ins&gt;   - Results in Error&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
spark-sql&amp;gt; CREATE TABLE t AS SELECT STRUCT(&lt;span class=&quot;code-quote&quot;&gt;&apos;a&apos;&lt;/span&gt; AS `$a`, 1 AS b) q;
17/11/10 22:50:45 WARN ObjectStore: Failed to get database global_temp, returning NoSuchObjectException
Error in query: org.apache.hadoop.hive.ql.metadata.HiveException: java.lang.IllegalArgumentException: Error: name expected at the position 7 of &lt;span class=&quot;code-quote&quot;&gt;&apos;struct&amp;lt;$a:string,b:&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&amp;gt;&apos;&lt;/span&gt; but &lt;span class=&quot;code-quote&quot;&gt;&apos;$&apos;&lt;/span&gt; is found.;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;ins&gt;2 Create Table &#8211; illegal type&lt;/ins&gt;  -	Results in Error&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
CREATE TABLE t(q STRUCT&amp;lt;`$a`:INT,col2:STRING&amp;gt;, i1 INT);
Error in query: org.apache.hadoop.hive.ql.metadata.HiveException: java.lang.IllegalArgumentException: Error: name expected at the position 7 of &lt;span class=&quot;code-quote&quot;&gt;&apos;struct&amp;lt;$a:&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,col2:string&amp;gt;:&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&apos;&lt;/span&gt; but &lt;span class=&quot;code-quote&quot;&gt;&apos;$&apos;&lt;/span&gt; is found.;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;ins&gt;3 Create DataSourceTable  - illegal type&lt;/ins&gt;  - &lt;br/&gt;
Try to store it in hive compatible way if possible, if this fails, then it tries to  store the metadata in Spark SQL format.   This is successful&lt;br/&gt;
With Parquet, there is error trying to store in hive compatible way so it falls back to persisting the metadata in Spark SQL specific format. &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
CREATE TABLE t(q STRUCT&amp;lt;`$a`:INT,col2:STRING&amp;gt;, i1 INT) USING PARQUET;	17/11/10 22:52:40 WARN HiveExternalCatalog: Could not persist `&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;`.`t` in a Hive compatible way. Persisting it into Hive metastore in Spark SQL specific format.
org.apache.hadoop.hive.ql.metadata.HiveException: java.lang.IllegalArgumentException: Error: name expected at the position 7 of &lt;span class=&quot;code-quote&quot;&gt;&apos;struct&amp;lt;$a:&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,col2:string&amp;gt;:&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&apos;&lt;/span&gt; but &lt;span class=&quot;code-quote&quot;&gt;&apos;$&apos;&lt;/span&gt; is found.
at org.apache.hadoop.hive.ql.metadata.Hive.createTable(Hive.java:720)
Caused by: java.lang.IllegalArgumentException: Error: name expected at the position 7 of &lt;span class=&quot;code-quote&quot;&gt;&apos;struct&amp;lt;$a:&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,col2:string&amp;gt;:&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&apos;&lt;/span&gt; but &lt;span class=&quot;code-quote&quot;&gt;&apos;$&apos;&lt;/span&gt; is found.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Retrieving the table metadata &#8211;  OK&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
select * from t;
Time taken: 0.912 seconds
spark-sql&amp;gt; describe formatted t;
q	struct&amp;lt;$a:&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,col2:string&amp;gt;	NULL
i1	&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;	NULL
		
# Detailed Table Information		
Database	&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;	
Table	t	
Owner	ksunitha	
Created Time	Fri Nov 10 22:52:40 IST 2017	
Last Access	Thu Jan 01 05:30:00 IST 1970	
Created By	Spark 2.3.0-SNAPSHOT	
Type	MANAGED	
Provider	PARQUET	
Table Properties	[transient_lastDdlTime=1510334560]	
Location	file:/Users/ksunitha/projects/trunk/spark/spark-warehouse/t	
Serde Library	org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe	
InputFormat	org.apache.hadoop.mapred.SequenceFileInputFormat	
OutputFormat	org.apache.hadoop.hive.ql.io.HiveSequenceFileOutputFormat	
Storage Properties	[serialization.format=1]	
Time taken: 0.071 seconds, Fetched 18 row(s)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;ins&gt;4. Create View - illegal type&lt;/ins&gt; &lt;br/&gt;
Creation successful.&lt;br/&gt;
Retrieving the view metadata &#8211; fails, so select, drop fail.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
CREATE VIEW t AS SELECT STRUCT(&lt;span class=&quot;code-quote&quot;&gt;&apos;a&apos;&lt;/span&gt; AS `$a`, 1 AS b) q;
Time taken: 0.036 seconds
spark-sql&amp;gt; select * from t;
17/11/10 22:57:22 ERROR SparkSQLDriver: Failed in [select * from t]
org.apache.spark.SparkException: Cannot recognize hive type string: struct&amp;lt;$a:string,b:&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&amp;#8211;&lt;br/&gt;
&lt;b&gt;B. InMemoryCatalog&lt;/b&gt;&lt;br/&gt;
&lt;ins&gt;1.Create Table -  illegal type&lt;/ins&gt;&lt;br/&gt;
N/A &#8211; Hive Support is needed &lt;/p&gt;

&lt;p&gt;&lt;ins&gt;2. Create DataSourceTable  - illegal type&lt;/ins&gt;&lt;br/&gt;
OK/Successful&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
CREATE TABLE t(q STRUCT&amp;lt;`$a`:INT,col2:STRING&amp;gt;, i1 INT) USING PARQUET
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Retrieving the table metadata &#8211; Select Query &#8211; OK&lt;/p&gt;

&lt;p&gt;&lt;ins&gt;3. Create View - illegal type&lt;/ins&gt;&lt;br/&gt;
Creation successful.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
CREATE VIEW t AS SELECT STRUCT(&lt;span class=&quot;code-quote&quot;&gt;&apos;a&apos;&lt;/span&gt; AS `$a`, 1 AS b) q
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Retrieving the view metadata and select query &#8211; OK &lt;/p&gt;


&lt;hr /&gt;
&lt;p&gt;&lt;b&gt;Cause:&lt;/b&gt;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;When you store the table metadata with provider as Hive, then it stores the schema that has a struct with illegal name in the catalog.&lt;br/&gt;
a.	If &lt;b&gt;table metadata&lt;/b&gt; is being stored, the underlying serde initialization catches any illegal parameters and throws an exception. &lt;br/&gt;
b.	If &lt;b&gt;view metadata&lt;/b&gt; is being stored, then hive has some special case logic and will not trigger any checks on the illegal parameters so the metadata for the view gets stored(/created) in the Hive metastore. But when retrieving a hive table&#8217;s metadata, Spark will make sure that it can read the schema and it is compatible with Spark and so when it retrieves the information from the Hive Metastore, it checks that the column datatype can be parsed by Spark.  Spark is not able to parse the struct with the illegal name because it is not quoted (backticked). &lt;/li&gt;
	&lt;li&gt;When you store the table metadata for a non-hive provider, then there are no checks done which is why the create and the select statements work fine.&lt;/li&gt;
	&lt;li&gt;CatalystSqlParser.parseDataType cannot parse the schema when the struct has an illegal name without the backtick.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;As the tests show, there are differences in the behavior.  &lt;/p&gt;

&lt;p&gt;&lt;b&gt;Some possible solutions:&lt;/b&gt;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Fix the hive table/view codepath to check whether the schema datatype is parseable by Spark before persisting it in the metastore. This change is localized to HiveClientImpl to do the check similar to the check in FromHiveColumn.  This is fail-fast and we will avoid the scenario where we write something to the metastore that we are unable to read it back ( ie the scenario in this jira description)&lt;/li&gt;
	&lt;li&gt;Improve storing and handling of the nested datatypes that have quoted (backtick identifiers) &#8211; This would need more changes after more investigation/input.&lt;/li&gt;
	&lt;li&gt;The tests show that there are differences in the behavior when using the in-memory versus the hive catalog.  Resolve inconsistent behavior ?&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;What do we want the desired behavior to be ?   Please share your thoughts/comments.  Thanks.&lt;/p&gt;</comment>
                            <comment id="16249511" author="hvanhovell" created="Mon, 13 Nov 2017 12:38:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ksunitha&quot; class=&quot;user-hover&quot; rel=&quot;ksunitha&quot;&gt;ksunitha&lt;/a&gt; Thanks for the thorough analysis! I think this is mainly a Hive metastore issue (that does not support column names with weird characters), and so I think we should keep this localized to the Hive code. I would go with option &apos;1&apos; for now.&lt;/p&gt;</comment>
                            <comment id="16249517" author="ksunitha" created="Mon, 13 Nov 2017 12:45:26 +0000"  >&lt;p&gt;Thanks for the response.   Option 1 sounds good.  I&apos;ll go ahead and create a PR for the same.&lt;/p&gt;</comment>
                            <comment id="16249756" author="hvanhovell" created="Mon, 13 Nov 2017 15:49:49 +0000"  >&lt;p&gt;I look forward to the PR &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16251739" author="apachespark" created="Tue, 14 Nov 2017 17:05:07 +0000"  >&lt;p&gt;User &apos;skambha&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/19747&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/19747&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 1 week ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3mc3z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12339551">2.3.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>