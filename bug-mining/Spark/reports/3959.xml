<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:46:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-17289] Sort based partial aggregation breaks due to SPARK-12978</title>
                <link>https://issues.apache.org/jira/browse/SPARK-17289</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;For the following query:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;val df2 = (0 to 1000).map(x =&amp;gt; (x % 2, x.toString)).toDF(&lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;b&quot;&lt;/span&gt;).createOrReplaceTempView(&lt;span class=&quot;code-quote&quot;&gt;&quot;t2&quot;&lt;/span&gt;)
spark.sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;select max(b) from t2 group by a&quot;&lt;/span&gt;).explain(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now, the SortAggregator won&apos;t insert Sort operator before partial aggregation, this will break sort-based partial aggregation.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;== Physical Plan ==
SortAggregate(key=[a#5], functions=[max(b#6)], output=[max(b)#17])
+- *Sort [a#5 ASC], &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, 0
   +- Exchange hashpartitioning(a#5, 200)
      +- SortAggregate(key=[a#5], functions=[partial_max(b#6)], output=[a#5, max#19])
         +- LocalTableScan [a#5, b#6]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In Spark 2.0 branch, the plan is:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;== Physical Plan ==
SortAggregate(key=[a#5], functions=[max(b#6)], output=[max(b)#17])
+- *Sort [a#5 ASC], &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, 0
   +- Exchange hashpartitioning(a#5, 200)
      +- SortAggregate(key=[a#5], functions=[partial_max(b#6)], output=[a#5, max#19])
         +- *Sort [a#5 ASC], &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, 0
            +- LocalTableScan [a#5, b#6]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This is related to &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-12978&quot; title=&quot;Skip unnecessary final group-by when input data already clustered with group-by keys&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-12978&quot;&gt;SPARK-12978&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13000919">SPARK-17289</key>
            <summary>Sort based partial aggregation breaks due to SPARK-12978</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="6">Invalid</resolution>
                                        <assignee username="maropu">Takeshi Yamamuro</assignee>
                                    <reporter username="clockfly">Sean Zhong</reporter>
                        <labels>
                    </labels>
                <created>Mon, 29 Aug 2016 10:25:15 +0000</created>
                <updated>Thu, 1 Sep 2016 05:23:50 +0000</updated>
                            <resolved>Thu, 1 Sep 2016 05:23:48 +0000</resolved>
                                                    <fixVersion>2.1.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="15446013" author="hvanhovell" created="Mon, 29 Aug 2016 14:21:43 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maropu&quot; class=&quot;user-hover&quot; rel=&quot;maropu&quot;&gt;maropu&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15446015" author="hvanhovell" created="Mon, 29 Aug 2016 14:22:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=clockfly&quot; class=&quot;user-hover&quot; rel=&quot;clockfly&quot;&gt;clockfly&lt;/a&gt; Are you working on this one?&lt;/p&gt;</comment>
                            <comment id="15446059" author="maropu" created="Mon, 29 Aug 2016 14:39:37 +0000"  >&lt;p&gt;yea, I&apos;ll check this.&lt;/p&gt;</comment>
                            <comment id="15446323" author="maropu" created="Mon, 29 Aug 2016 16:18:00 +0000"  >&lt;p&gt;This is probably because EnsureRequirements does not check if partial aggregation satisfies sort requirements.&lt;br/&gt;
We can fix this like;&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/compare/master...maropu:SPARK-17289#diff-cdb577e36041e4a27a605b6b3063fd54L167&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/compare/master...maropu:SPARK-17289#diff-cdb577e36041e4a27a605b6b3063fd54L167&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;cc: &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hvanhovell&quot; class=&quot;user-hover&quot; rel=&quot;hvanhovell&quot;&gt;hvanhovell&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15446341" author="hvanhovell" created="Mon, 29 Aug 2016 16:23:50 +0000"  >&lt;p&gt;Looks good. Can you open a PR?&lt;/p&gt;</comment>
                            <comment id="15446344" author="maropu" created="Mon, 29 Aug 2016 16:25:26 +0000"  >&lt;p&gt;okay. I&apos;ll add tests and open pr.&lt;/p&gt;</comment>
                            <comment id="15446615" author="apachespark" created="Mon, 29 Aug 2016 18:12:10 +0000"  >&lt;p&gt;User &apos;maropu&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/14865&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/14865&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15448462" author="lian cheng" created="Tue, 30 Aug 2016 08:44:54 +0000"  >&lt;p&gt;Issue resolved by pull request 14865&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/14865&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/14865&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15454362" author="cloud_fan" created="Thu, 1 Sep 2016 05:23:50 +0000"  >&lt;p&gt;The original PR that cause the bug has been reverted.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 11 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i32xun:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>