<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:57:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-22042] ReorderJoinPredicates can break when child&apos;s partitioning is not decided</title>
                <link>https://issues.apache.org/jira/browse/SPARK-22042</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;When `ReorderJoinPredicates` tries to get the `outputPartitioning` of its children, the children may not be properly constructed as the child-subtree has to still go through other planner rules.&lt;/p&gt;

&lt;p&gt;In this particular case, the child is `SortMergeJoinExec`. Since the required `Exchange` operators are not in place (because `EnsureRequirements` runs &lt;em&gt;after&lt;/em&gt; `ReorderJoinPredicates`), the join&apos;s children would not have partitioning defined. This breaks while creation the `PartitioningCollection` here : &lt;a href=&quot;https://github.com/apache/spark/blob/94439997d57875838a8283c543f9b44705d3a503/sql/core/src/main/scala/org/apache/spark/sql/execution/joins/SortMergeJoinExec.scala#L69&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/94439997d57875838a8283c543f9b44705d3a503/sql/core/src/main/scala/org/apache/spark/sql/execution/joins/SortMergeJoinExec.scala#L69&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Small repro:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;context.sql(&quot;SET spark.sql.autoBroadcastJoinThreshold=0&quot;)

val df = (0 until 50).map(i =&amp;gt; (i % 5, i % 13, i.toString)).toDF(&quot;i&quot;, &quot;j&quot;, &quot;k&quot;)
df.write.format(&quot;parquet&quot;).saveAsTable(&quot;table1&quot;)
df.write.format(&quot;parquet&quot;).saveAsTable(&quot;table2&quot;)
df.write.format(&quot;parquet&quot;).bucketBy(8, &quot;j&quot;, &quot;k&quot;).saveAsTable(&quot;bucketed_table&quot;)

sql(&quot;&quot;&quot;
  SELECT *
  FROM (
    SELECT a.i, a.j, a.k
    FROM bucketed_table a
    JOIN table1 b
    ON a.i = b.i
  ) c
  JOIN table2
  ON c.i = table2.i
&quot;&quot;&quot;).explain
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This fails with :&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.IllegalArgumentException: requirement failed: PartitioningCollection requires all of its partitionings have the same numPartitions.
  at scala.Predef$.require(Predef.scala:224)
  at org.apache.spark.sql.catalyst.plans.physical.PartitioningCollection.&amp;lt;init&amp;gt;(partitioning.scala:324)
  at org.apache.spark.sql.execution.joins.SortMergeJoinExec.outputPartitioning(SortMergeJoinExec.scala:69)
  at org.apache.spark.sql.execution.ProjectExec.outputPartitioning(basicPhysicalOperators.scala:82)
  at org.apache.spark.sql.execution.joins.ReorderJoinPredicates$$anonfun$apply$1.applyOrElse(ReorderJoinPredicates.scala:91)
  at org.apache.spark.sql.execution.joins.ReorderJoinPredicates$$anonfun$apply$1.applyOrElse(ReorderJoinPredicates.scala:76)
  at org.apache.spark.sql.catalyst.trees.TreeNode$$anonfun$transformUp$1.apply(TreeNode.scala:289)
  at org.apache.spark.sql.catalyst.trees.TreeNode$$anonfun$transformUp$1.apply(TreeNode.scala:289)
  at org.apache.spark.sql.catalyst.trees.CurrentOrigin$.withOrigin(TreeNode.scala:70)
  at org.apache.spark.sql.catalyst.trees.TreeNode.transformUp(TreeNode.scala:288)
  at org.apache.spark.sql.execution.joins.ReorderJoinPredicates.apply(ReorderJoinPredicates.scala:76)
  at org.apache.spark.sql.execution.joins.ReorderJoinPredicates.apply(ReorderJoinPredicates.scala:34)
  at org.apache.spark.sql.execution.QueryExecution$$anonfun$prepareForExecution$1.apply(QueryExecution.scala:100)
  at org.apache.spark.sql.execution.QueryExecution$$anonfun$prepareForExecution$1.apply(QueryExecution.scala:100)
  at scala.collection.LinearSeqOptimized$class.foldLeft(LinearSeqOptimized.scala:124)
  at scala.collection.immutable.List.foldLeft(List.scala:84)
  at org.apache.spark.sql.execution.QueryExecution.prepareForExecution(QueryExecution.scala:100)
  at org.apache.spark.sql.execution.QueryExecution.executedPlan$lzycompute(QueryExecution.scala:90)
  at org.apache.spark.sql.execution.QueryExecution.executedPlan(QueryExecution.scala:90)
  at org.apache.spark.sql.execution.QueryExecution$$anonfun$simpleString$1.apply(QueryExecution.scala:201)
  at org.apache.spark.sql.execution.QueryExecution$$anonfun$simpleString$1.apply(QueryExecution.scala:201)
  at org.apache.spark.sql.execution.QueryExecution.stringOrError(QueryExecution.scala:114)
  at org.apache.spark.sql.execution.QueryExecution.simpleString(QueryExecution.scala:201)
  at org.apache.spark.sql.execution.command.ExplainCommand.run(commands.scala:147)
  at org.apache.spark.sql.execution.command.ExecutedCommandExec.sideEffectResult$lzycompute(commands.scala:78)
  at org.apache.spark.sql.execution.command.ExecutedCommandExec.sideEffectResult(commands.scala:75)
  at org.apache.spark.sql.execution.command.ExecutedCommandExec.executeCollect(commands.scala:91)
  at org.apache.spark.sql.Dataset.explain(Dataset.scala:464)
  at org.apache.spark.sql.Dataset.explain(Dataset.scala:477)
  ... 60 elided
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13102800">SPARK-22042</key>
            <summary>ReorderJoinPredicates can break when child&apos;s partitioning is not decided</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tejasp">Tejas Patil</assignee>
                                    <reporter username="tejasp">Tejas Patil</reporter>
                        <labels>
                    </labels>
                <created>Sun, 17 Sep 2017 00:49:43 +0000</created>
                <updated>Thu, 21 Dec 2017 00:42:04 +0000</updated>
                            <resolved>Wed, 13 Dec 2017 07:30:30 +0000</resolved>
                                    <version>2.3.0</version>
                                    <fixVersion>2.3.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="16169148" author="tejasp" created="Sun, 17 Sep 2017 01:03:53 +0000"  >&lt;p&gt;At the core, the problem is `ReorderJoinPredicates` expects the input tree to be resolved (esp. when it comes to ensuring partitioning requirements). &lt;/p&gt;

&lt;p&gt;Possible fixes:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Option 1: Have `EnsureRequirements` be done before `ReorderJoinPredicates`. Since `EnsureRequirements` would have inserted sort and shuffle nodes, `ReorderJoinPredicates` would have to remove those out. This would definitely produce sub-optimal plans as `EnsureRequirements` would have done some decision making (eg. how many shuffle partitions to generate ?) and at that point `ReorderJoinPredicates` cannot correct that easily.&lt;/li&gt;
	&lt;li&gt;Option 2: In `EnsureRequirements`, apply `ReorderJoinPredicates` over the input tree before doing its core logic. Since the tree is transformed bottom-up, we can assure that the children are resolved before doing `ReorderJoinPredicates`. This will be simple change but would look weird given that we dont call rules from other rules (not to my knowledge).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I will create a PR for option #2 but will be happy to discuss if there are better solutions.&lt;/p&gt;</comment>
                            <comment id="16169153" author="apachespark" created="Sun, 17 Sep 2017 01:16:03 +0000"  >&lt;p&gt;User &apos;tejasapatil&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/19257&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/19257&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16220734" author="aash" created="Thu, 26 Oct 2017 16:37:57 +0000"  >&lt;p&gt;Hi I&apos;m seeing this problem as well, thanks for investigating and putting up a PR &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tejasp&quot; class=&quot;user-hover&quot; rel=&quot;tejasp&quot;&gt;tejasp&lt;/a&gt;!  Have you been running any of your clusters with a patched version of Spark including that change, and has it been behaving as expected?&lt;/p&gt;

&lt;p&gt;The repro one of my users independently provided was this:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;val rows = List(1, 2, 3, 4, 5, 6);
 
val df1 = sc.parallelize(rows).toDF(&quot;col&quot;).repartition(1);
val df2 = sc.parallelize(rows).toDF(&quot;col&quot;).repartition(2);
val df3 = sc.parallelize(rows).toDF(&quot;col&quot;).repartition(2);
 
val dd1 = df1.join(df2, df1.col(&quot;col&quot;).equalTo(df2.col(&quot;col&quot;))).join(df3, df2.col(&quot;col&quot;).equalTo(df3.col(&quot;col&quot;)));
 
dd1.show;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16247112" author="dongjoon" created="Fri, 10 Nov 2017 07:19:04 +0000"  >&lt;p&gt;Since this raises a runtime exception to the query, I raised this to Major. It would be great if 2.2.1 has this.&lt;br/&gt;
How do you think about this issue, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=smilegator&quot; class=&quot;user-hover&quot; rel=&quot;smilegator&quot;&gt;smilegator&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cloud_fan&quot; class=&quot;user-hover&quot; rel=&quot;cloud_fan&quot;&gt;cloud_fan&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="16247113" author="dongjoon" created="Fri, 10 Nov 2017 07:19:36 +0000"  >&lt;p&gt;Also, cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=felixcheung&quot; class=&quot;user-hover&quot; rel=&quot;felixcheung&quot;&gt;felixcheung&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16248372" author="felixcheung" created="Sat, 11 Nov 2017 06:59:05 +0000"  >&lt;p&gt;any taker? is this a blocker for 2.2.1?&lt;/p&gt;</comment>
                            <comment id="16248743" author="apachespark" created="Sun, 12 Nov 2017 00:31:08 +0000"  >&lt;p&gt;User &apos;tejasapatil&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/19725&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/19725&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16248745" author="tejasp" created="Sun, 12 Nov 2017 00:33:54 +0000"  >&lt;p&gt;Am trying out the suggestion discussed in &lt;a href=&quot;https://github.com/apache/spark/pull/19257#issuecomment-331069250&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/19257#issuecomment-331069250&lt;/a&gt; &lt;br/&gt;
Here is an unpolished but working PR : &lt;a href=&quot;https://github.com/apache/spark/pull/19725&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/19725&lt;/a&gt; (will polish it after observing the test case results).&lt;/p&gt;</comment>
                            <comment id="16249005" author="felixcheung" created="Sun, 12 Nov 2017 22:52:56 +0000"  >&lt;p&gt;since this is in 2.1.0 and 2.2.0, technically this isn&apos;t a regression. I will watch this fix but currently not a blocker for 2.2.1&lt;/p&gt;</comment>
                            <comment id="16299335" author="apachespark" created="Thu, 21 Dec 2017 00:42:04 +0000"  >&lt;p&gt;User &apos;tejasapatil&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/20041&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/20041&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 47 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3k5tr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12339551">2.3.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>