<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:04:03 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-26572] Join on distinct column with monotonically_increasing_id produces wrong output</title>
                <link>https://issues.apache.org/jira/browse/SPARK-26572</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;When joining a table with projected monotonically_increasing_id column after calling distinct with another table the operators do not get executed in the right order.&#160;&lt;/p&gt;

&lt;p&gt;Here is a minimal example:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.sql.{DataFrame, SparkSession, functions}

object JoinBug &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; App {

  &lt;span class=&quot;code-comment&quot;&gt;// Spark session setup
&lt;/span&gt;  val session =  SparkSession.builder().master(&lt;span class=&quot;code-quote&quot;&gt;&quot;local[*]&quot;&lt;/span&gt;).getOrCreate()
  &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; session.sqlContext.implicits._
  session.sparkContext.setLogLevel(&lt;span class=&quot;code-quote&quot;&gt;&quot;error&quot;&lt;/span&gt;)

  &lt;span class=&quot;code-comment&quot;&gt;// Bug in Spark: &lt;span class=&quot;code-quote&quot;&gt;&quot;monotonically_increasing_id&quot;&lt;/span&gt; is pushed down when it shouldn&apos;t be. Push down only happens when the
&lt;/span&gt;  &lt;span class=&quot;code-comment&quot;&gt;// DF containing the &lt;span class=&quot;code-quote&quot;&gt;&quot;monotonically_increasing_id&quot;&lt;/span&gt; expression is on the left side of the join.
&lt;/span&gt;  val baseTable = Seq((1), (1)).toDF(&lt;span class=&quot;code-quote&quot;&gt;&quot;idx&quot;&lt;/span&gt;)
  val distinctWithId = baseTable.distinct.withColumn(&lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;, functions.monotonically_increasing_id())
  val monotonicallyOnRight: DataFrame = baseTable.join(distinctWithId, &lt;span class=&quot;code-quote&quot;&gt;&quot;idx&quot;&lt;/span&gt;)
  val monotonicallyOnLeft: DataFrame = distinctWithId.join(baseTable, &lt;span class=&quot;code-quote&quot;&gt;&quot;idx&quot;&lt;/span&gt;)

  monotonicallyOnLeft.show &lt;span class=&quot;code-comment&quot;&gt;// Wrong
&lt;/span&gt;  monotonicallyOnRight.show &lt;span class=&quot;code-comment&quot;&gt;// Ok in Spark 2.2.2 - also wrong in Spark 2.4.0
&lt;/span&gt;
}

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;It produces the following output:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Wrong:
+---+------------+
|idx| id         |
+---+------------+
| 1|369367187456 |
| 1|369367187457 |
+---+------------+

Right:
+---+------------+
|idx| id         |
+---+------------+
| 1|369367187456 |
| 1|369367187456 |
+---+------------+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;We assume that the join operator triggers a pushdown of expressions (monotonically_increasing_id in this case) which gets pushed down to be executed before distinct. This produces non-distinct rows with unique id&apos;s. However it seems&#160;like this behavior only appears if the table with the projected expression is on the left side of the join in Spark 2.2.2 (for version 2.4.0 it fails on both joins).&lt;/p&gt;</description>
                <environment>&lt;p&gt;Running on Ubuntu 18.04LTS and Intellij 2018.2.5&lt;/p&gt;</environment>
        <key id="13208308">SPARK-26572</key>
            <summary>Join on distinct column with monotonically_increasing_id produces wrong output</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="petertoth">Peter Toth</assignee>
                                    <reporter username="soerenreichardt">S&#246;ren Reichardt</reporter>
                        <labels>
                            <label>correctness</label>
                    </labels>
                <created>Tue, 8 Jan 2019 13:16:39 +0000</created>
                <updated>Mon, 2 Mar 2020 19:36:48 +0000</updated>
                            <resolved>Fri, 15 Feb 2019 01:05:18 +0000</resolved>
                                    <version>2.0.2</version>
                    <version>2.1.3</version>
                    <version>2.2.2</version>
                    <version>2.3.2</version>
                    <version>2.4.0</version>
                                    <fixVersion>2.3.4</fixVersion>
                    <fixVersion>2.4.1</fixVersion>
                    <fixVersion>3.0.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>11</watches>
                                                                                                                <comments>
                            <comment id="16759788" author="maropu" created="Mon, 4 Feb 2019 11:34:16 +0000"  >&lt;p&gt;I checked I could reproduce this below and I set &quot;correctness&quot; in the Label.&lt;br/&gt;
It seems HashAggregate hits a bug if it has stateful expressions, e.g., monotonically_increasing_id, rand, ...&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
scala&amp;gt; val baseTable = Seq((1), (1)).toDF(&lt;span class=&quot;code-quote&quot;&gt;&quot;idx&quot;&lt;/span&gt;)
scala&amp;gt; val distinctWithId = baseTable.distinct.withColumn(&lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;, functions.monotonically_increasing_id())
scala&amp;gt; baseTable.join(distinctWithId, &lt;span class=&quot;code-quote&quot;&gt;&quot;idx&quot;&lt;/span&gt;).show
+---+------------+                                                              
|idx|          id|
+---+------------+
|  1|369367187456|
|  1|369367187457|
+---+------------+

scala&amp;gt; sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;SET spark.sql.codegen.wholeStage=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&quot;&lt;/span&gt;)
scala&amp;gt; baseTable.join(distinctWithId, &lt;span class=&quot;code-quote&quot;&gt;&quot;idx&quot;&lt;/span&gt;).show
+---+------------+
|idx|          id|
+---+------------+
|  1|369367187456|
|  1|369367187456|
+---+------------+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This is pretty a corner case, so I didn&apos;t set a blocker.&lt;/p&gt;</comment>
                            <comment id="16768841" author="maropu" created="Fri, 15 Feb 2019 01:05:18 +0000"  >&lt;p&gt;Resolved by&#160;&lt;a href=&quot;https://github.com/apache/spark/pull/23731&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23731&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 39 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|u00mkw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>