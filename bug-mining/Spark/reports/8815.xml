<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:31:56 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-41162] Anti-join must not be pushed below aggregation with ambiguous predicates</title>
                <link>https://issues.apache.org/jira/browse/SPARK-41162</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;The following query should return a single row as all values for &lt;tt&gt;id&lt;/tt&gt; except for the largest will be eliminated by the anti-join:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
val ids = Seq(1, 2, 3).toDF(&lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;).distinct()
val result = ids.withColumn(&lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;, $&lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt; + 1).join(ids, Seq(&lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;), &lt;span class=&quot;code-quote&quot;&gt;&quot;left_anti&quot;&lt;/span&gt;).collect()
&lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt;(result.length == 1)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Without the &lt;tt&gt;distinct()&lt;/tt&gt;, the assertion is true. With &lt;tt&gt;distinct()&lt;/tt&gt;, the assertion should still hold but is false.&lt;/p&gt;

&lt;p&gt;Rule &lt;tt&gt;PushDownLeftSemiAntiJoin&lt;/tt&gt; pushes the &lt;tt&gt;Join&lt;/tt&gt; below the left &lt;tt&gt;Aggregate&lt;/tt&gt; with join condition &lt;tt&gt;(id#750 + 1) = id#750&lt;/tt&gt;, which can never be true.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
=== Applying Rule org.apache.spark.sql.catalyst.optimizer.PushDownLeftSemiAntiJoin ===
!Join LeftAnti, (id#752 = id#750)                  &apos;Aggregate [id#750], [(id#750 + 1) AS id#752]
!:- Aggregate [id#750], [(id#750 + 1) AS id#752]   +- &apos;Join LeftAnti, ((id#750 + 1) = id#750)
!:  +- LocalRelation [id#750]                         :- LocalRelation [id#750]
!+- Aggregate [id#750], [id#750]                      +- Aggregate [id#750], [id#750]
!   +- LocalRelation [id#750]                            +- LocalRelation [id#750]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The optimizer then rightly removes the left-anti join altogether, returning the left child only.&lt;/p&gt;

&lt;p&gt;Rule &lt;tt&gt;PushDownLeftSemiAntiJoin&lt;/tt&gt; should not push down predicates that reference left &lt;b&gt;and&lt;/b&gt; right child.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13502915">SPARK-41162</key>
            <summary>Anti-join must not be pushed below aggregation with ambiguous predicates</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="enricomi">Enrico Minack</assignee>
                                    <reporter username="enricomi">Enrico Minack</reporter>
                        <labels>
                            <label>correctness</label>
                    </labels>
                <created>Wed, 16 Nov 2022 15:20:21 +0000</created>
                <updated>Sun, 12 Feb 2023 11:31:49 +0000</updated>
                            <resolved>Fri, 6 Jan 2023 03:33:42 +0000</resolved>
                                    <version>3.0.3</version>
                    <version>3.1.3</version>
                    <version>3.3.1</version>
                    <version>3.2.3</version>
                    <version>3.4.0</version>
                                    <fixVersion>3.2.4</fixVersion>
                    <fixVersion>3.3.2</fixVersion>
                    <fixVersion>3.4.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17634893" author="apachespark" created="Wed, 16 Nov 2022 15:37:26 +0000"  >&lt;p&gt;User &apos;EnricoMi&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/38676&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/38676&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17634894" author="apachespark" created="Wed, 16 Nov 2022 15:38:29 +0000"  >&lt;p&gt;User &apos;EnricoMi&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/38676&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/38676&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17648751" author="shardulm" created="Fri, 16 Dec 2022 18:27:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cloud_fan&quot; class=&quot;user-hover&quot; rel=&quot;cloud_fan&quot;&gt;cloud_fan&lt;/a&gt; Can you help take a look at this? This is a correctness issue and affects not just master but also 3.1+ if I am not wrong. We hit this issue in production with one of our user jobs.&lt;/p&gt;</comment>
                            <comment id="17648836" author="shuwang" created="Sat, 17 Dec 2022 00:30:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shardulm&quot; class=&quot;user-hover&quot; rel=&quot;shardulm&quot;&gt;shardulm&lt;/a&gt; Yes. Checked with Spark 3.1.2, and it&apos;s also an issue.&lt;/p&gt;</comment>
                            <comment id="17649418" author="apachespark" created="Mon, 19 Dec 2022 17:34:51 +0000"  >&lt;p&gt;User &apos;EnricoMi&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/39131&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/39131&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17654948" author="apachespark" created="Thu, 5 Jan 2023 12:35:12 +0000"  >&lt;p&gt;User &apos;EnricoMi&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/39409&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/39409&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17654949" author="apachespark" created="Thu, 5 Jan 2023 12:36:29 +0000"  >&lt;p&gt;User &apos;EnricoMi&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/39409&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/39409&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17655016" author="apachespark" created="Thu, 5 Jan 2023 15:51:32 +0000"  >&lt;p&gt;User &apos;EnricoMi&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/39411&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/39411&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17655017" author="apachespark" created="Thu, 5 Jan 2023 15:52:34 +0000"  >&lt;p&gt;User &apos;EnricoMi&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/39411&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/39411&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17655232" author="cloud_fan" created="Fri, 6 Jan 2023 03:33:42 +0000"  >&lt;p&gt;Issue resolved by pull request 39409&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/39409&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/39409&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 44 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1c7n4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>