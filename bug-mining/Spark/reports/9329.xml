<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:35:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-45543] InferWindowGroupLimit causes bug if the other window functions haven&apos;t the same window frame as the rank-like functions</title>
                <link>https://issues.apache.org/jira/browse/SPARK-45543</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;First, it&apos;s my first bug, so I&apos;m hoping I&apos;m doing it right, also, as I&apos;m not very knowledgeable about spark internals, I hope I diagnosed the problem correctly&lt;/p&gt;

&lt;p&gt;I found the degradation in spark version 3.5.0:&lt;/p&gt;

&lt;p&gt;When using multiple windows that share the same partition and ordering (but with different &quot;frame boundaries&quot;, where one window is a ranking function, &quot;WindowGroupLimit&quot; is added to the plan causing wrong values to be created from the other windows.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;This behavior didn&apos;t exist in versions 3.3 and 3.4.&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;Example:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-python&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; pysparkfrom pyspark.sql &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; functions &lt;span class=&quot;code-keyword&quot;&gt;as&lt;/span&gt; F, Window &#160;

df = spark.createDataFrame([
    {&lt;span class=&quot;code-quote&quot;&gt;&apos;row_id&apos;&lt;/span&gt;: 1, &lt;span class=&quot;code-quote&quot;&gt;&apos;name&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;Dave&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;score&apos;&lt;/span&gt;: 1, &lt;span class=&quot;code-quote&quot;&gt;&apos;year&apos;&lt;/span&gt;: 2020},
    {&lt;span class=&quot;code-quote&quot;&gt;&apos;row_id&apos;&lt;/span&gt;: 1, &lt;span class=&quot;code-quote&quot;&gt;&apos;name&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;Dave&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;score&apos;&lt;/span&gt;: 2, &lt;span class=&quot;code-quote&quot;&gt;&apos;year&apos;&lt;/span&gt;: 2022},
    {&lt;span class=&quot;code-quote&quot;&gt;&apos;row_id&apos;&lt;/span&gt;: 1, &lt;span class=&quot;code-quote&quot;&gt;&apos;name&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;Dave&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;score&apos;&lt;/span&gt;: 3, &lt;span class=&quot;code-quote&quot;&gt;&apos;year&apos;&lt;/span&gt;: 2023},
    {&lt;span class=&quot;code-quote&quot;&gt;&apos;row_id&apos;&lt;/span&gt;: 2, &lt;span class=&quot;code-quote&quot;&gt;&apos;name&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;Amy&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;score&apos;&lt;/span&gt;: 6, &lt;span class=&quot;code-quote&quot;&gt;&apos;year&apos;&lt;/span&gt;: 2021},
])

&lt;span class=&quot;code-comment&quot;&gt;# Create first window &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; row number
&lt;/span&gt;window_spec = Window.partitionBy(&lt;span class=&quot;code-quote&quot;&gt;&apos;row_id&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;name&apos;&lt;/span&gt;).orderBy(F.desc(&lt;span class=&quot;code-quote&quot;&gt;&apos;year&apos;&lt;/span&gt;))

&lt;span class=&quot;code-comment&quot;&gt;# Create additional window &lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; the first window &lt;span class=&quot;code-keyword&quot;&gt;with&lt;/span&gt; unbounded frame
&lt;/span&gt;unbound_spec = window_spec.rowsBetween(Window.unboundedPreceding, Window.unboundedFollowing)

&lt;span class=&quot;code-comment&quot;&gt;# Try to keep the first row by year, &lt;span class=&quot;code-keyword&quot;&gt;and&lt;/span&gt; also collect &lt;span class=&quot;code-object&quot;&gt;all&lt;/span&gt; scores into a &lt;span class=&quot;code-object&quot;&gt;list&lt;/span&gt;
&lt;/span&gt;df2 = df.withColumn(
    &lt;span class=&quot;code-quote&quot;&gt;&apos;rn&apos;&lt;/span&gt;, 
    F.row_number().over(window_spec)
).withColumn(
    &lt;span class=&quot;code-quote&quot;&gt;&apos;all_scores&apos;&lt;/span&gt;, 
    F.collect_list(&lt;span class=&quot;code-quote&quot;&gt;&apos;score&apos;&lt;/span&gt;).over(unbound_spec)
)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;So far everything works, and if we display df2:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;+----+------+-----+----+---+----------+
|name|row_id|score|year|rn |all_scores|
+----+------+-----+----+---+----------+
|Dave|1     |3    |2023|1  |[3, 2, 1] |
|Dave|1     |2    |2022|2  |[3, 2, 1] |
|Dave|1     |1    |2020|3  |[3, 2, 1] |
|Amy |2     |6    |2021|1  |[6]       |
+----+------+-----+----+---+----------+&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;However, once we filter to keep only the first row number:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;df2.filter(&quot;rn=1&quot;).show(truncate=False)
+----+------+-----+----+---+----------+
|name|row_id|score|year|rn |all_scores|
+----+------+-----+----+---+----------+
|Dave|1     |3    |2023|1  |[3]       |
|Amy |2     |6    |2021|1  |[6]       |
+----+------+-----+----+---+----------+&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;As you can see just filtering changed the &quot;all_scores&quot; array for Dave.&lt;/p&gt;

&lt;p&gt;(This example uses `collect_list`, however, the same result happens with other functions, such as max, min, count, etc)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Now, if instead of using the two windows we used, I will use the first window and a window with different ordering, or create a completely new window with same partition but no ordering, it will work fine:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-python&quot;&gt;
new_window = Window.partitionBy(&lt;span class=&quot;code-quote&quot;&gt;&apos;row_id&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;name&apos;&lt;/span&gt;).rowsBetween(Window.unboundedPreceding, Window.unboundedFollowing)

df3 = df.withColumn(
    &lt;span class=&quot;code-quote&quot;&gt;&apos;rn&apos;&lt;/span&gt;,
    F.row_number().over(window_spec)
).withColumn(
    &lt;span class=&quot;code-quote&quot;&gt;&apos;all_scores&apos;&lt;/span&gt;,
    F.collect_list(&lt;span class=&quot;code-quote&quot;&gt;&apos;score&apos;&lt;/span&gt;).over(new_window)
)
df3.&lt;span class=&quot;code-object&quot;&gt;filter&lt;/span&gt;(&lt;span class=&quot;code-quote&quot;&gt;&quot;rn=1&quot;&lt;/span&gt;).show(truncate=&lt;span class=&quot;code-keyword&quot;&gt;&lt;span class=&quot;code-object&quot;&gt;False&lt;/span&gt;&lt;/span&gt;)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;+----+------+-----+----+---+----------+
|name|row_id|score|year|rn |all_scores|
+----+------+-----+----+---+----------+
|Dave|1     |3    |2023|1  |[3, 2, 1] |
|Amy |2     |6    |2021|1  |[6]       |
+----+------+-----+----+---+----------+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In addition, if we use all 3 windows to create 3 different columns, it will also work ok. So it seems the issue happens only when all the windows used share the same partition and ordering.&lt;/p&gt;

&lt;p&gt;Here is the final plan for the faulty dataframe:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;df2.filter(&quot;rn=1&quot;).explain()
== Physical Plan ==
AdaptiveSparkPlan isFinalPlan=false
+- Filter (rn#9 = 1)
&#160; &#160;+- Window [row_number() windowspecdefinition(row_id#1L, name#0, year#3L DESC NULLS LAST, specifiedwindowframe(RowFrame, unboundedpreceding$(), currentrow$())) AS rn#9, collect_list(score#2L, 0, 0) windowspecdefinition(row_id#1L, name#0, year#3L DESC NULLS LAST, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS all_scores#16], [row_id#1L, name#0], [year#3L DESC NULLS LAST]
&#160; &#160; &#160; +- WindowGroupLimit [row_id#1L, name#0], [year#3L DESC NULLS LAST], row_number(), 1, Final
&#160; &#160; &#160; &#160; &#160;+- Sort [row_id#1L ASC NULLS FIRST, name#0 ASC NULLS FIRST, year#3L DESC NULLS LAST], false, 0
&#160; &#160; &#160; &#160; &#160; &#160; +- Exchange hashpartitioning(row_id#1L, name#0, 200), ENSURE_REQUIREMENTS, [plan_id=425]
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;+- WindowGroupLimit [row_id#1L, name#0], [year#3L DESC NULLS LAST], row_number(), 1, Partial
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; +- Sort [row_id#1L ASC NULLS FIRST, name#0 ASC NULLS FIRST, year#3L DESC NULLS LAST], false, 0
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;+- Scan ExistingRDD[name#0,row_id#1L,score#2L,year#3L]&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I suspect the issue is caused due to the &quot;WindowGroupLimit&quot; clause in the plan.&lt;/p&gt;

&lt;p&gt;This clause doesn&apos;t appear in the dataframes that work fine, and before filtering the rn.&lt;/p&gt;

&lt;p&gt;So I assume that since the optimizer detects that we want to only keep the first row of the ranking function, it first removes all other rows from the following computations, which causes the incorrect result or loss of data.&lt;/p&gt;

&lt;p&gt;I think the bug comes from this change (and the attached PRs):&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-44340&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SPARK-44340&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;It was added in spark 3.5.0, and in addition, I noticed that it was included in databricks release 13.3, which included spark 3.4.0, but also this fix in their release note. And evidently, this bug happens on databricks13 spark3.4, but not on my local spark 3.4&lt;/p&gt;

&lt;p&gt;tagging user &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=beliefer&quot; class=&quot;user-hover&quot; rel=&quot;beliefer&quot;&gt;beliefer&lt;/a&gt; as I believe you would know most about this.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13554149">SPARK-45543</key>
            <summary>InferWindowGroupLimit causes bug if the other window functions haven&apos;t the same window frame as the rank-like functions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="beliefer">Jiaan Geng</assignee>
                                    <reporter username="ronserruya">Ron Serruya</reporter>
                        <labels>
                            <label>correctness</label>
                            <label>data-loss</label>
                            <label>pull-request-available</label>
                    </labels>
                <created>Sun, 15 Oct 2023 16:22:24 +0000</created>
                <updated>Thu, 19 Oct 2023 12:19:06 +0000</updated>
                            <resolved>Thu, 19 Oct 2023 12:18:23 +0000</resolved>
                                    <version>3.5.0</version>
                                    <fixVersion>3.5.1</fixVersion>
                    <fixVersion>4.0.0</fixVersion>
                                    <component>Optimizer</component>
                    <component>Spark Core</component>
                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17775566" author="beliefer" created="Mon, 16 Oct 2023 07:20:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ronserruya&quot; class=&quot;user-hover&quot; rel=&quot;ronserruya&quot;&gt;ronserruya&lt;/a&gt;I see.&lt;/p&gt;</comment>
                            <comment id="17775974" author="beliefer" created="Tue, 17 Oct 2023 01:30:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ronserruya&quot; class=&quot;user-hover&quot; rel=&quot;ronserruya&quot;&gt;ronserruya&lt;/a&gt; Thank you.&lt;/p&gt;</comment>
                            <comment id="17777231" author="beliefer" created="Thu, 19 Oct 2023 12:18:23 +0000"  >&lt;p&gt;Issue resolved by pull request 43385&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/43385&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/43385&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 3 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1kybs:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>