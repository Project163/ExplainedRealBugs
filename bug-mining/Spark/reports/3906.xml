<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:46:30 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-17022] Potential deadlock in driver handling message</title>
                <link>https://issues.apache.org/jira/browse/SPARK-17022</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Suggest t1 &amp;lt; t2 &amp;lt; t3 &lt;br/&gt;
At t1, someone called YarnSchedulerBackend.doRequestTotalExecutors from one of three functions: CoarseGrainedSchedulerBackend.killExecutors, CoarseGrainedSchedulerBackend.requestTotalExecutors or CoarseGrainedSchedulerBackend.requestExecutors, in all of which will hold the lock `CoarseGrainedSchedulerBackend`.&lt;br/&gt;
Then YarnSchedulerBackend.doRequestTotalExecutors will send a RequestExecutors message to `yarnSchedulerEndpoint` and wait for reply.&lt;/p&gt;

&lt;p&gt;At t2, someone send a RemoveExecutor to `yarnSchedulerEndpoint` and the message is received by the endpoint.&lt;/p&gt;

&lt;p&gt;At t3, the RequestExexutor message sent at t1 is received by the endpoint.&lt;/p&gt;

&lt;p&gt;Then the endpoint would first handle RemoveExecutor then the RequestExecutor message.&lt;/p&gt;

&lt;p&gt;When handling RemoveExecutor, it would send the same message to `driverEndpoint` and wait for reply.&lt;/p&gt;

&lt;p&gt;In `driverEndpoint` it will request lock `CoarseGrainedSchedulerBackend` to handle that message, while the lock has been occupied in t1.&lt;/p&gt;

&lt;p&gt;So it would cause a deadlock.&lt;/p&gt;

&lt;p&gt;We have found the issue in our deployment, it would block the driver to make it handle no messages until the two message all went timeout.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12996657">SPARK-17022</key>
            <summary>Potential deadlock in driver handling message</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="WangTao">Tao Wang</assignee>
                                    <reporter username="WangTao">Tao Wang</reporter>
                        <labels>
                    </labels>
                <created>Thu, 11 Aug 2016 15:53:39 +0000</created>
                <updated>Sun, 17 May 2020 18:13:59 +0000</updated>
                            <resolved>Thu, 11 Aug 2016 22:10:06 +0000</resolved>
                                    <version>1.5.0</version>
                    <version>1.5.1</version>
                    <version>1.5.2</version>
                    <version>1.6.0</version>
                    <version>1.6.1</version>
                    <version>2.0.0</version>
                                    <fixVersion>2.0.1</fixVersion>
                    <fixVersion>2.1.0</fixVersion>
                                    <component>Spark Core</component>
                    <component>YARN</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="15417582" author="apachespark" created="Thu, 11 Aug 2016 16:57:34 +0000"  >&lt;p&gt;User &apos;WangTaoTheTonic&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/14605&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/14605&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15418470" author="jasonmoore2k" created="Fri, 12 Aug 2016 07:39:08 +0000"  >&lt;p&gt;This one is maybe related to &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-16533&quot; title=&quot;Spark application not handling preemption messages&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-16533&quot;&gt;&lt;del&gt;SPARK-16533&lt;/del&gt;&lt;/a&gt; and/or &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-16702&quot; title=&quot;Driver hangs after executors are lost&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-16702&quot;&gt;&lt;del&gt;SPARK-16702&lt;/del&gt;&lt;/a&gt;, right?  My team works in an environment where preemption (and killing of executors) is a common occurrence, so have been burnt a bit by this one.   We had been putting together a patch, but I&apos;ll see how this one holds up.&lt;/p&gt;</comment>
                            <comment id="15418488" author="wangtao" created="Fri, 12 Aug 2016 07:54:23 +0000"  >&lt;p&gt;looks like they are related, especially with &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-16702&quot; title=&quot;Driver hangs after executors are lost&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-16702&quot;&gt;&lt;del&gt;SPARK-16702&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15844450" author="jinxing6042@126.com" created="Sun, 29 Jan 2017 14:55:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=WangTao&quot; class=&quot;user-hover&quot; rel=&quot;WangTao&quot;&gt;WangTao&lt;/a&gt;&lt;br/&gt;
Thanks a lot for the PR you made, which make lots of sense. But could I ask one question?&lt;/p&gt;

&lt;p&gt;&lt;cite&gt;Then the endpoint would first handle RemoveExecutor then the RequestExecutor message.&lt;/cite&gt;&lt;/p&gt;

&lt;p&gt;Yes, but it doesn&apos;t mean that &lt;b&gt;RequestExecutor&lt;/b&gt; cannot be started to handle until the completion of handling &lt;b&gt;RemoveExecutor&lt;/b&gt;. I guess they can be processed concurrently. If that&apos;s correct, &lt;b&gt;RequestExecutor&lt;/b&gt; can still be handled, after which lock can be released.&lt;/p&gt;

&lt;p&gt;Any thoughts about this ?&lt;/p&gt;</comment>
                            <comment id="15856038" author="wangtao" created="Tue, 7 Feb 2017 13:59:40 +0000"  >

&lt;p&gt;Well, `YarnSchedulerEndpoint` is a *&lt;b&gt;ThreadSafeRpcEndpoint&lt;/b&gt;*, which can only handle one message at a time.&lt;/p&gt;


&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;quote&amp;#93;&lt;/span&gt;&lt;br/&gt;
Thread-safety means processing of one message happens before processing of the next message by&lt;br/&gt;
 the same [&lt;span class=&quot;error&quot;&gt;&amp;#91;ThreadSafeRpcEndpoint&amp;#93;&lt;/span&gt;].&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;/quote&amp;#93;&lt;/span&gt;&lt;/p&gt;






</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 41 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i327kn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>