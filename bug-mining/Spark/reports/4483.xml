<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:50:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-9435] Java UDFs don&apos;t work with GROUP BY expressions</title>
                <link>https://issues.apache.org/jira/browse/SPARK-9435</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;If you define a UDF in Java, for example by implementing the UDF1 interface, then try to use that UDF on a column in both the SELECT and GROUP BY clauses of a query, you&apos;ll get an error like this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT inc(y),COUNT(DISTINCT x) FROM test_table GROUP BY inc(y)&quot;&lt;/span&gt;

org.apache.spark.sql.AnalysisException: expression &lt;span class=&quot;code-quote&quot;&gt;&apos;y&apos;&lt;/span&gt; is neither present in the group by, nor is it an aggregate function. Add to group by or wrap in first() &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; you don&apos;t care which value you get.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We put together a minimal reproduction in the attached Java file, which makes use of the data in the text file attached.&lt;/p&gt;

&lt;p&gt;I&apos;m guessing there&apos;s some kind of issue with the equality implementation, so Spark can&apos;t tell that those two expressions are the same maybe? If you do the same thing from Scala, it works fine.&lt;/p&gt;

&lt;p&gt;Note for context: we ran into this issue while working around &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-9338&quot; title=&quot;Aliases from SELECT not available in GROUP BY&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-9338&quot;&gt;&lt;del&gt;SPARK-9338&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</description>
                <environment>&lt;p&gt;All&lt;/p&gt;</environment>
        <key id="12849916">SPARK-9435</key>
            <summary>Java UDFs don&apos;t work with GROUP BY expressions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gurwls223">Hyukjin Kwon</assignee>
                                    <reporter username="jaley">James Aley</reporter>
                        <labels>
                    </labels>
                <created>Wed, 29 Jul 2015 12:27:13 +0000</created>
                <updated>Mon, 12 Dec 2022 18:10:37 +0000</updated>
                            <resolved>Tue, 24 Jan 2017 06:21:42 +0000</resolved>
                                    <version>1.4.1</version>
                                    <fixVersion>2.1.1</fixVersion>
                    <fixVersion>2.2.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>10</watches>
                                                                                                                <comments>
                            <comment id="14645966" author="jaley" created="Wed, 29 Jul 2015 12:27:59 +0000"  >&lt;p&gt;Attaching minimal reproduction code.&lt;/p&gt;</comment>
                            <comment id="14735416" author="marmbrus" created="Tue, 8 Sep 2015 19:03:12 +0000"  >&lt;p&gt;From a quick glance, the problem is likely that the &lt;tt&gt;equals&lt;/tt&gt; function on Java UDFs is working correctly.  As a workaround you could probably calculate the udf in a nested select.&lt;/p&gt;</comment>
                            <comment id="15001866" author="doanduyhai" created="Thu, 12 Nov 2015 09:02:44 +0000"  >&lt;p&gt;Same error for me:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-comment&quot;&gt;// Register computeDecade() as a SparkSQL function
&lt;/span&gt;        sqlContext.udf().register(&lt;span class=&quot;code-quote&quot;&gt;&quot;computeDecade&quot;&lt;/span&gt;, (&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt; year) -&amp;gt; computeDecade(year), DataTypes.StringType);

        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; List&amp;lt;Album&amp;gt; albums = Arrays.asList(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Album(2000, &lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt;), &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Album(2000, &lt;span class=&quot;code-quote&quot;&gt;&quot;2&quot;&lt;/span&gt;), &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Album(2000, &lt;span class=&quot;code-quote&quot;&gt;&quot;3&quot;&lt;/span&gt;));

        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; JavaRDD&amp;lt;Album&amp;gt; rdd = javaSc.parallelize(albums);
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; DataFrame df = sqlContext.createDataFrame(rdd, Album.class);
        df.registerTempTable(&lt;span class=&quot;code-quote&quot;&gt;&quot;albums&quot;&lt;/span&gt;);

        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; DataFrame dataFrame = sqlContext.sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT computeDecade(year),count(title) &quot;&lt;/span&gt;+
                        &lt;span class=&quot;code-quote&quot;&gt;&quot; FROM albums &quot;&lt;/span&gt; +
                        &lt;span class=&quot;code-quote&quot;&gt;&quot; GROUP BY computeDecade(year)&quot;&lt;/span&gt;);

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15002126" author="doanduyhai" created="Thu, 12 Nov 2015 13:57:03 +0000"  >&lt;p&gt;Work-around: &lt;b&gt;define the UDF using the Scala API instead&lt;/b&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;ComputeDecadeFn &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; AbstractFunction1&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;,&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; Serializable {
        @Override
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; apply(&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt; year) {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; computeDecade(year);
        }
    }
      sqlContext.udf().register(&lt;span class=&quot;code-quote&quot;&gt;&quot;computeDecade&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ComputeDecadeFn(),
                JavaApiHelper.getTypeTag(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.class),
                JavaApiHelper.getTypeTag(&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.class));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt; You cannot use the lambda expression because the UDF function should be serializable.&lt;/p&gt;

&lt;p&gt; The &lt;em&gt;JavaApiHelper.getTypeTag()&lt;/em&gt; method  comes from &lt;b&gt;com.datastax.spark.connector.util.JavaApiHelper&lt;/b&gt; here: &lt;a href=&quot;https://github.com/datastax/spark-cassandra-connector/blob/master/spark-cassandra-connector/src/main/scala/com/datastax/spark/connector/util/JavaApiHelper.scala#L35&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/datastax/spark-cassandra-connector/blob/master/spark-cassandra-connector/src/main/scala/com/datastax/spark/connector/util/JavaApiHelper.scala#L35&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15813832" author="gurwls223" created="Tue, 10 Jan 2017 04:24:15 +0000"  >&lt;p&gt;This sill happens in the current master - &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;val df = Seq((1, 10), (2, 11), (3, 12)).toDF(&lt;span class=&quot;code-quote&quot;&gt;&quot;x&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;y&quot;&lt;/span&gt;)
val udf = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; UDF1[Int, Int]  {
  override def call(i: Int): Int = i + 1
}

spark.udf.register(&lt;span class=&quot;code-quote&quot;&gt;&quot;inc&quot;&lt;/span&gt;, udf, IntegerType)
df.createOrReplaceTempView(&lt;span class=&quot;code-quote&quot;&gt;&quot;tmp&quot;&lt;/span&gt;)
spark.sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT inc(y) FROM tmp GROUP BY inc(y)&quot;&lt;/span&gt;).show()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I tested both Scala and Java ones. and I believe the above one is simpler Scala one to reproduce the same issue.&lt;/p&gt;</comment>
                            <comment id="15819117" author="apachespark" created="Wed, 11 Jan 2017 20:46:04 +0000"  >&lt;p&gt;User &apos;HyukjinKwon&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/16553&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/16553&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15835729" author="smilegator" created="Tue, 24 Jan 2017 06:21:42 +0000"  >&lt;p&gt;Issue resolved by pull request 16553&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/16553&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/16553&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12747779" name="IncMain.java" size="2417" author="jaley" created="Wed, 29 Jul 2015 12:27:59 +0000"/>
                            <attachment id="12747780" name="points.txt" size="14" author="jaley" created="Wed, 29 Jul 2015 12:27:59 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 43 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2i2fr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>