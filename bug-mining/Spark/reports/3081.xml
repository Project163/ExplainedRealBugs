<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:37:51 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-12807] Spark External Shuffle not working in Hadoop clusters with Jackson 2.2.3</title>
                <link>https://issues.apache.org/jira/browse/SPARK-12807</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;When you try to try to use dynamic allocation on a Hadoop 2.6-based cluster, you get to see a stack trace in the NM logs, indicating a jackson 2.x version mismatch.&lt;/p&gt;

&lt;p&gt;(reported on the spark dev list)&lt;/p&gt;</description>
                <environment>&lt;p&gt;A Hadoop cluster with Jackson 2.2.3, spark running with dynamic allocation enabled&lt;/p&gt;</environment>
        <key id="12929868">SPARK-12807</key>
            <summary>Spark External Shuffle not working in Hadoop clusters with Jackson 2.2.3</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stevel@apache.org">Steve Loughran</assignee>
                                    <reporter username="stevel@apache.org">Steve Loughran</reporter>
                        <labels>
                    </labels>
                <created>Wed, 13 Jan 2016 16:38:42 +0000</created>
                <updated>Sun, 17 May 2020 18:17:02 +0000</updated>
                            <resolved>Tue, 9 Feb 2016 19:02:53 +0000</resolved>
                                    <version>1.6.0</version>
                                    <fixVersion>1.6.1</fixVersion>
                    <fixVersion>2.0.0</fixVersion>
                                    <component>Shuffle</component>
                    <component>Spark Core</component>
                    <component>YARN</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>12</watches>
                                                                                                                <comments>
                            <comment id="15096537" author="stevel@apache.org" created="Wed, 13 Jan 2016 17:00:07 +0000"  >&lt;p&gt;Needs either an upgrade to Hadoop&apos;s own dependencies (&lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-12705&quot; title=&quot;Upgrade Jackson 2.2.3 to 2.7.8&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-12705&quot;&gt;&lt;del&gt;HADOOP-12705&lt;/del&gt;&lt;/a&gt;) or YARN to support custom classpaths for aux services (&lt;a href=&quot;https://issues.apache.org/jira/browse/YARN-1593&quot; title=&quot;support out-of-proc AuxiliaryServices&quot; class=&quot;issue-link&quot; data-issue-key=&quot;YARN-1593&quot;&gt;YARN-1593&lt;/a&gt; or &lt;a href=&quot;https://issues.apache.org/jira/browse/YARN-4755&quot; title=&quot;Optimize sending appACLsUpdated event to TimelineServer while recovering completed applications&quot; class=&quot;issue-link&quot; data-issue-key=&quot;YARN-4755&quot;&gt;YARN-4755&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;Without any of those fixes, Spark will need to be rebuild with &lt;tt&gt;-Dfasterxml.jackson.version=2.2.3&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="15096711" author="maver1ck" created="Wed, 13 Jan 2016 18:13:18 +0000"  >&lt;p&gt;I think there will be a big problem with Spark 2.0.0.&lt;br/&gt;
As far as I know Jackson 2.2.3 is not compatible with 2.5.3.&lt;/p&gt;

&lt;p&gt;Maybe it&apos;s possible to build Shuffle Manager with different Jackson version than rest of the projekt.&lt;/p&gt;</comment>
                            <comment id="15096779" author="srowen" created="Wed, 13 Jan 2016 18:51:00 +0000"  >&lt;p&gt;Why? Spark is already not on Jackson 2.2.&lt;/p&gt;</comment>
                            <comment id="15096826" author="stevel@apache.org" created="Wed, 13 Jan 2016 19:13:38 +0000"  >&lt;p&gt;Jackson versioning is really a symptom of a greater problem: lack of classpath isolation in YARN aux services.&lt;/p&gt;

&lt;p&gt;Fixing CP isolation there &lt;a href=&quot;https://issues.apache.org/jira/browse/YARN-1573&quot; title=&quot;ZK store should use a private password for root-node-acls&quot; class=&quot;issue-link&quot; data-issue-key=&quot;YARN-1573&quot;&gt;&lt;del&gt;YARN-1573&lt;/del&gt;&lt;/a&gt; is the best option for Hadoop 2.9+; forked JVMs even better as you get failure isolation.  &lt;/p&gt;

&lt;p&gt;Short term (support for Hadoop &amp;lt;= 2.8), I don&apos;t know. &lt;/p&gt;

&lt;p&gt;I&apos;m now confused about what&apos;s happening here &#8212;as in &quot;why hasn&apos;t this problem surfaced before&quot;&lt;/p&gt;</comment>
                            <comment id="15097022" author="stevel@apache.org" created="Wed, 13 Jan 2016 21:25:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jerryshao&quot; class=&quot;user-hover&quot; rel=&quot;jerryshao&quot;&gt;jerryshao&lt;/a&gt; flagged up &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-9439&quot; title=&quot;ExternalShuffleService should be robust to NodeManager restarts in yarn&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-9439&quot;&gt;&lt;del&gt;SPARK-9439&lt;/del&gt;&lt;/a&gt; as the patch that made jackson2 a dependency for the shuffle; it&apos;s why this is a 1.6+ issue&lt;/p&gt;</comment>
                            <comment id="15097026" author="stevel@apache.org" created="Wed, 13 Jan 2016 21:28:28 +0000"  >&lt;p&gt;Stack&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;So connecting it gives error:

2016-01-11 16:56:51,222 INFO  containermanager.AuxServices
(AuxServices.java:addService(72)) - Adding auxiliary service
spark_shuffle, &lt;span class=&quot;code-quote&quot;&gt;&quot;spark_shuffle&quot;&lt;/span&gt;
2016-01-11 16:56:51,439 FATAL nodemanager.NodeManager
(NodeManager.java:initAndStartNodeManager(465)) - Error starting
NodeManager
java.lang.NoSuchMethodError:
com.fasterxml.jackson.core.JsonFactory.requiresPropertyOrdering()Z
       at com.fasterxml.jackson.databind.ObjectMapper.&amp;lt;init&amp;gt;(ObjectMapper.java:457)
       at com.fasterxml.jackson.databind.ObjectMapper.&amp;lt;init&amp;gt;(ObjectMapper.java:379)
       at org.apache.spark.network.shuffle.ExternalShuffleBlockResolver.&amp;lt;clinit&amp;gt;(ExternalShuffleBlockResolver.java:57)
       at org.apache.spark.network.shuffle.ExternalShuffleBlockHandler.&amp;lt;init&amp;gt;(ExternalShuffleBlockHandler.java:56)
       at org.apache.spark.network.yarn.YarnShuffleService.serviceInit(YarnShuffleService.java:128)
       at org.apache.hadoop.service.AbstractService.init(AbstractService.java:163)
       at org.apache.hadoop.yarn.server.nodemanager.containermanager.AuxServices.serviceInit(AuxServices.java:143)
       at org.apache.hadoop.service.AbstractService.init(AbstractService.java:163)
       at org.apache.hadoop.service.CompositeService.serviceInit(CompositeService.java:107)
       at org.apache.hadoop.yarn.server.nodemanager.containermanager.ContainerManagerImpl.serviceInit(ContainerManagerImpl.java:237)
       at org.apache.hadoop.service.AbstractService.init(AbstractService.java:163)
       at org.apache.hadoop.service.CompositeService.serviceInit(CompositeService.java:107)
       at org.apache.hadoop.yarn.server.nodemanager.NodeManager.serviceInit(NodeManager.java:253)
       at org.apache.hadoop.service.AbstractService.init(AbstractService.java:163)
       at org.apache.hadoop.yarn.server.nodemanager.NodeManager.initAndStartNodeManager(NodeManager.java:462)
       at org.apache.hadoop.yarn.server.nodemanager.NodeManager.main(NodeManager.java:509)

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15097028" author="maver1ck" created="Wed, 13 Jan 2016 21:29:29 +0000"  >&lt;p&gt;Observed today by me &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15097030" author="stevel@apache.org" created="Wed, 13 Jan 2016 21:30:42 +0000"  >&lt;p&gt;...+mismatch looks to be between version of &lt;tt&gt;com.fasterxml.jackson.databind.ObjectMapper&lt;/tt&gt; and the jackson core&lt;/p&gt;</comment>
                            <comment id="15102158" author="stevel@apache.org" created="Fri, 15 Jan 2016 17:42:33 +0000"  >&lt;p&gt;We can replicate this intermittently. It all depends on classpath ordering in the NM. If either versions complete set of JARs are loaded first: all is well. If there&apos;s a mix: stack trace.&lt;/p&gt;

&lt;p&gt;The ordering can not only break the shuffle and so DRA, it can stop the NM coming up. This is generally considered a serious issue by ops teams.&lt;/p&gt;</comment>
                            <comment id="15102169" author="srowen" created="Fri, 15 Jan 2016 17:46:34 +0000"  >&lt;p&gt;Yes in general I&apos;d assume Spark&apos;s classes/dependencies are supposed to come first in order to work. This certainly doesn&apos;t resolve all possible problems but yes I would expect more problems if other older versions of libs are given precdence.&lt;/p&gt;</comment>
                            <comment id="15102416" author="maver1ck" created="Fri, 15 Jan 2016 20:21:58 +0000"  >&lt;p&gt;Sean,&lt;br/&gt;
Maybe it&apos;s possible to compile YARN Shuffle with different version of Jackson than version using by Spark Core ?&lt;/p&gt;</comment>
                            <comment id="15102430" author="srowen" created="Fri, 15 Jan 2016 20:33:01 +0000"  >&lt;p&gt;Are you asking if it&apos;s possible, a possible explanation, a workaround?&lt;br/&gt;
I&apos;m still not sure why it&apos;s a problem (now). For example people seem to be running Spark shuffle just fine with recent Hadoop.&lt;/p&gt;</comment>
                            <comment id="15102441" author="maver1ck" created="Fri, 15 Jan 2016 20:43:30 +0000"  >&lt;p&gt;I&apos;m asking if it&apos;s possible.&lt;/p&gt;

&lt;p&gt;About running Spark shuffle. Did you miss link to: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-9439&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SPARK-9439&lt;/a&gt; ?&lt;br/&gt;
Problem started with Spark 1.6.0, because it&apos;s first version of Spark where Shuffle has Jackson dependency&lt;/p&gt;</comment>
                            <comment id="15102645" author="stevel@apache.org" created="Fri, 15 Jan 2016 23:02:35 +0000"  >&lt;p&gt;problem is there are no guarantees that the spark versions are backwards compatible with the older version. If they come first, the NM itself may fail.&lt;/p&gt;</comment>
                            <comment id="15102647" author="stevel@apache.org" created="Fri, 15 Jan 2016 23:03:51 +0000"  >&lt;p&gt;FWIW, I&apos;m workng on shading jackson in the shuffle JAR&lt;/p&gt;</comment>
                            <comment id="15102654" author="srowen" created="Fri, 15 Jan 2016 23:07:42 +0000"  >&lt;p&gt;I see, it&apos;s only the shuffle and only 1.6, and only happens to affect the shuffle service on YARN. Spark has otherwise been using later Jackson for a while. Shading is indeed probably the best thing for all of Spark&apos;s usages.&lt;/p&gt;</comment>
                            <comment id="15102662" author="stevel@apache.org" created="Fri, 15 Jan 2016 23:15:00 +0000"  >&lt;p&gt;work on YARN for isolation will address this in Hadoop 2.8+. But that does nothing for Hadoop &amp;lt;= 2.8. Shading will do this&lt;/p&gt;</comment>
                            <comment id="15102729" author="apachespark" created="Fri, 15 Jan 2016 23:57:05 +0000"  >&lt;p&gt;User &apos;steveloughran&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/10780&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/10780&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15102883" author="stevel@apache.org" created="Sat, 16 Jan 2016 01:30:41 +0000"  >&lt;p&gt;There&apos;s a PR to shade in trunk; I&apos;m going to do a 1.6 PR too, which should be identical (initially for ease of testing that the 1.6 branch is fixed)&lt;/p&gt;</comment>
                            <comment id="15102907" author="apachespark" created="Sat, 16 Jan 2016 01:51:04 +0000"  >&lt;p&gt;User &apos;steveloughran&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/10782&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/10782&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15102920" author="stevel@apache.org" created="Sat, 16 Jan 2016 02:15:56 +0000"  >&lt;p&gt;One thing to think about here is ramping up a notch and shading all the downstream dependencies in the YARN shuffle JAR. &lt;/p&gt;

&lt;p&gt;This is a JAR designed to be used in a specific place, the classpath. It now includes: netty, leveldb, some bits of com.google (in 1.6), some javax.annotation.&lt;/p&gt;

&lt;p&gt;What is also has for extra fun is a leveldb jni.so in native, as well as a netty one. This is going to be a problem; unless you can somehow isolate and shade that this shuffle JAR is going to force in a specific leveldb version on every bit of code picking up this JAR.&lt;/p&gt;</comment>
                            <comment id="15130884" author="vanzin" created="Wed, 3 Feb 2016 18:55:05 +0000"  >&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Guava is shaded in the final jar&lt;/li&gt;
	&lt;li&gt;Netty is a different version (4.x for Spark vs. 3.x for Hadoop) which lives in a different package, so fortunately no conflict&lt;/li&gt;
	&lt;li&gt;leveldb was intentionally kept at the same version as Hadoop, exactly because of the JNI bits&lt;/li&gt;
	&lt;li&gt;the javax annotations are not used at runtime so there&apos;s no need to shade them&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;That leaves only Jackson; in hindsight it would have been better not to include it in the shuffle service, but well, that&apos;s water under the bridge now. So that leaves two solutions:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;park it at the same version as Hadoop; assuming different versions of Hadoop use the same version...&lt;/li&gt;
	&lt;li&gt;relocate it&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Relocation is probably the safest choice given the many versions of Hadoop people may be using.&lt;/p&gt;</comment>
                            <comment id="15130901" author="maver1ck" created="Wed, 3 Feb 2016 19:02:24 +0000"  >&lt;p&gt;I can add that I&apos;m using 1.6.0 compiled with Jackson 2.2.3 and it&apos;s working brilliant.&lt;/p&gt;

&lt;p&gt;So solution park it at the same version as Hadoop is quite acceptable.&lt;/p&gt;</comment>
                            <comment id="15131015" author="stevel@apache.org" created="Wed, 3 Feb 2016 19:54:21 +0000"  >&lt;p&gt;the PR I&apos;ve got shades jackson; leveldb must stay in sync with hadoop as you can&apos;t shade JNI ... for that you need to rebuild leveldb or do what YARN will eventually do: fork the plugins. That helps on so many levels&lt;/p&gt;</comment>
                            <comment id="15132191" author="srowen" created="Thu, 4 Feb 2016 11:34:56 +0000"  >&lt;p&gt;I don&apos;t think we can park at 2.2.x. Spark already uses 2.5&lt;/p&gt;</comment>
                            <comment id="15133045" author="vanzin" created="Thu, 4 Feb 2016 21:15:07 +0000"  >&lt;blockquote&gt;&lt;p&gt;I don&apos;t think we can park at 2.2.x. Spark already uses 2.5&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That could be done just for the shuffle service. (Also, to be fair, Spark compiles and works fine with 2.2.x.)&lt;/p&gt;

&lt;p&gt;But either solution is fine.&lt;/p&gt;</comment>
                            <comment id="15133946" author="srowen" created="Fri, 5 Feb 2016 10:16:16 +0000"  >&lt;p&gt;Why vary this to use an earlier version - seems like all downside?&lt;/p&gt;</comment>
                            <comment id="15134412" author="stevel@apache.org" created="Fri, 5 Feb 2016 16:26:47 +0000"  >&lt;p&gt;It&apos;s good to hear that things work with older versions, but they do need to be compiled in sync. The risk with downgrading jackson versions  is that someone who has upgraded will find their code won&apos;t link any more. This is the same dilemma that &lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-10104&quot; title=&quot;Update jackson to 1.9.13&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-10104&quot;&gt;&lt;del&gt;HADOOP-10104&lt;/del&gt;&lt;/a&gt; created: revert or tell others &quot;sorry, time to upgrade&quot;. We went with the latter, but have added jackson to the list of dependencies whose upgrades are traumatic: Guava, protobuf (which will never be upgraded on the 2.x line)&lt;/p&gt;</comment>
                            <comment id="15134414" author="stevel@apache.org" created="Fri, 5 Feb 2016 16:29:07 +0000"  >&lt;p&gt;mixing dependency versions in a single project is dangerous. And it still runs the risk of being brittle against whatever version of jackson Hadoop namenodes run with. While I&apos;m not a fan of shading, until we get better classpath/process isolation in nodemanagers, shading here avoids problems and will ensure that ASF spark releases work with ASF Hadoop releases.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                                                <inwardlinks description="is broken by">
                                        <issuelink>
            <issuekey id="12849992">SPARK-9439</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                            <outwardlinks description="depends upon">
                                        <issuelink>
            <issuekey id="12929869">HADOOP-12705</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12688637">YARN-1593</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12929237">YARN-4577</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 41 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2r8zz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12334009">1.6.1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>