<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:21:38 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-4834] Spark fails to clean up cache / lock files in local dirs</title>
                <link>https://issues.apache.org/jira/browse/SPARK-4834</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;This issue was caused by &lt;a href=&quot;https://github.com/apache/spark/commit/7aacb7bfa&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/commit/7aacb7bfa&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;That change shares downloaded jar / files among multiple executors running on the same host by using a lock file and a cache file for each file the executor needs to download. The problem is that these lock and cache files are never deleted.&lt;/p&gt;

&lt;p&gt;On Yarn, the app&apos;s dir is automatically deleted when the app ends, so no files are left behind. But on standalone, there&apos;s no such thing as &quot;the app&apos;s dir&quot;; files will end up in &quot;/tmp&quot; or in whatever place the user configure in &quot;SPARK_LOCAL_DIRS&quot;, and will eventually start to fill that volume.&lt;/p&gt;

&lt;p&gt;We should add a way to clean up these files. It&apos;s not as simple as &quot;hey, just call File.deleteOnExit()!&quot; because we&apos;re talking about multiple processes accessing these files, so to maintain the efficiency gains of the original change, the files should only be deleted when the application is finished.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12761496">SPARK-4834</key>
            <summary>Spark fails to clean up cache / lock files in local dirs</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="vanzin">Marcelo Masiero Vanzin</assignee>
                                    <reporter username="vanzin">Marcelo Masiero Vanzin</reporter>
                        <labels>
                    </labels>
                <created>Fri, 12 Dec 2014 23:56:37 +0000</created>
                <updated>Thu, 28 May 2015 16:33:49 +0000</updated>
                            <resolved>Tue, 23 Dec 2014 20:02:42 +0000</resolved>
                                    <version>1.2.0</version>
                                    <fixVersion>1.2.1</fixVersion>
                    <fixVersion>1.3.0</fixVersion>
                                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="14245025" author="vanzin" created="Sat, 13 Dec 2014 00:12:19 +0000"  >&lt;p&gt;For example, after running a job that ends up uploading 3 files (the job&apos;s jar + two files using &quot;sc.addJar()&quot;), I end up with this:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;/tmp/8760687361418428261220_lock
/tmp/-15888563551418428259097_lock
/tmp/16304071011418428261208_lock
/tmp/8760687361418428261220_cache
/tmp/-15888563551418428259097_cache
/tmp/16304071011418428261208_cache
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;My first idea was to somehow delete these files when the executors go down. But for that, you&apos;d need to keep a ref count somewhere, turning the locking into something way more complicated than it is now.&lt;/p&gt;

&lt;p&gt;So my second solution would change the way local dirs are assigned. Basically, each Worker would create one app-specific dir for each directory in SPARK_LOCAL_DIRS, and set that variable when starting the executor. After the app is done, the Worker would clean up that directory. I haven&apos;t looked at whether this would require protocol changes, but it should be sort of simple to do.&lt;/p&gt;

&lt;p&gt;I&apos;ll start looking at the above solution, but feel free to suggest different approaches in the meantime.&lt;/p&gt;</comment>
                            <comment id="14247348" author="apachespark" created="Mon, 15 Dec 2014 22:28:56 +0000"  >&lt;p&gt;User &apos;vanzin&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/3705&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/3705&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14257442" author="joshrosen" created="Tue, 23 Dec 2014 20:02:42 +0000"  >&lt;p&gt;Issue resolved by pull request 3705&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/3705&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/3705&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14563183" author="zfry" created="Thu, 28 May 2015 16:12:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=joshrosen&quot; class=&quot;user-hover&quot; rel=&quot;joshrosen&quot;&gt;joshrosen&lt;/a&gt;, &lt;/p&gt;

&lt;p&gt;We are seeing behavior on Spark 1.3.0 where the &lt;em&gt;files&lt;/em&gt; in the &lt;tt&gt;spark.local.dir&lt;/tt&gt; directories are getting cleaned up, but not the &lt;em&gt;directories&lt;/em&gt; themselves. &lt;/p&gt;

&lt;p&gt;Its a pretty simple repro: &lt;br/&gt;
Run a job that does some shuffling, wait for the shuffle files to get cleaned up, go and look on disk at &lt;tt&gt;spark.local.dir&lt;/tt&gt; and notice that the directory(s) are still there, but there are no files in them. &lt;/p&gt;

&lt;p&gt;Should we open another ticket for this? Or can we reopen this one? &lt;/p&gt;
</comment>
                            <comment id="14563187" author="joshrosen" created="Thu, 28 May 2015 16:13:55 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zfry&quot; class=&quot;user-hover&quot; rel=&quot;zfry&quot;&gt;zfry&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Could you open a separate issue for this?  That will make it easier for us to track where the fix is applied, whether it introduces any new regressions, etc.  Thanks!.&lt;/p&gt;</comment>
                            <comment id="14563206" author="zfry" created="Thu, 28 May 2015 16:32:19 +0000"  >&lt;p&gt;Thanks Josh! &lt;/p&gt;

&lt;p&gt;I&apos;ve filed &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-7917&quot; title=&quot;Spark doesn&amp;#39;t clean up Application Directories (local dirs) &quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-7917&quot;&gt;&lt;del&gt;SPARK-7917&lt;/del&gt;&lt;/a&gt; to address. &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12759350">HIVE-9017</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12833482">SPARK-7917</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 25 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i23e5j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>