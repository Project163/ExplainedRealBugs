<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:25:29 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-6550] Add PreAnalyzer to keep logical plan consistent across DataFrame</title>
                <link>https://issues.apache.org/jira/browse/SPARK-6550</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;h2&gt;&lt;a name=&quot;Problems&quot;&gt;&lt;/a&gt;Problems&lt;/h2&gt;

&lt;p&gt;In some cases, the expressions in a logical plan will be modified to new ones during analysis, e.g. the handling for self-join cases. If some expressions are resolved based on the analyzed plan, they are referring to changed expression ids, not original ids.&lt;/p&gt;

&lt;p&gt;But the transformation of DataFrame will use logical plan to construct new DataFrame, e.g. &lt;tt&gt;groupBy&lt;/tt&gt; and aggregation. So in such cases, the expressions in these DataFrames will be inconsistent.&lt;/p&gt;

&lt;p&gt;The problems are specified as following:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Expression ids in logical plan are possibly inconsistent if expression ids are changed during analysis and some expressions are resolved after that&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;When we try to run the following codes:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;val df = Seq(1,2,3).map(i =&amp;gt; (i, i.toString)).toDF(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;str&quot;&lt;/span&gt;)
val df2 = df.as(&lt;span class=&quot;code-quote&quot;&gt;&apos;x).join(df.as(&apos;&lt;/span&gt;y), $&lt;span class=&quot;code-quote&quot;&gt;&quot;x.str&quot;&lt;/span&gt; === $&lt;span class=&quot;code-quote&quot;&gt;&quot;y.str&quot;&lt;/span&gt;).groupBy(&lt;span class=&quot;code-quote&quot;&gt;&quot;y.str&quot;&lt;/span&gt;).min(&lt;span class=&quot;code-quote&quot;&gt;&quot;y.&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&quot;&lt;/span&gt;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Because &lt;tt&gt;groupBy&lt;/tt&gt; and &lt;tt&gt;min&lt;/tt&gt; will perform resolving based on the analyzed logical plan, their expression ids refer to analyzed plan, instead of logical plan.&lt;/p&gt;

&lt;p&gt;So the logical plan of df2 looks like:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&apos;Aggregate [str#5], [str#5,MIN(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;#4) AS MIN(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;)#6]
 &lt;span class=&quot;code-quote&quot;&gt;&apos;Join Inner, Some((&apos;&lt;/span&gt;x.str = &apos;y.str))
  Subquery x
   Project [_1#0 AS &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;#2,_2#1 AS str#3]
    LocalRelation [_1#0,_2#1], [[1,1],[2,2],[3,3]]
  Subquery y
   Project [_1#0 AS &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;#2,_2#1 AS str#3]
    LocalRelation [_1#0,_2#1], [[1,1],[2,2],[3,3]]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;As you see, the expression ids in &lt;tt&gt;Aggregate&lt;/tt&gt; are different to the expression ids in &lt;tt&gt;Subquery y&lt;/tt&gt;. This is the first problem.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;The &lt;tt&gt;df2&lt;/tt&gt; can&apos;t be performed&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The showing logical plan of &lt;tt&gt;df2&lt;/tt&gt; can&apos;t be performed. Because the expression ids of &lt;tt&gt;Subquery y&lt;/tt&gt; will be modified for self-join handling during analysis, the analyzed plan of &lt;tt&gt;df2&lt;/tt&gt; becomes:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Aggregate [str#5], [str#5,MIN(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;#4) AS MIN(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;)#6]
 Join Inner, Some((str#3 = str#8))
  Subquery x
   Project [_1#0 AS &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;#2,_2#1 AS str#3]
    LocalRelation [_1#0,_2#1], [[1,1],[2,2],[3,3]]
  Subquery y
   Project [_1#0 AS &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;#7,_2#1 AS str#8]
    LocalRelation [_1#0,_2#1], [[1,1],[2,2],[3,3]]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The expressions referred in &lt;tt&gt;Aggregate&lt;/tt&gt; are not matching to these in &lt;tt&gt;Subquery y&lt;/tt&gt;. This is the second problem.&lt;/p&gt;

&lt;h2&gt;&lt;a name=&quot;Proposedsolution&quot;&gt;&lt;/a&gt;Proposed solution&lt;/h2&gt;

&lt;p&gt;We try to add a &lt;tt&gt;PreAnalyzer&lt;/tt&gt;. When a logical plan &lt;tt&gt;rawPlan&lt;/tt&gt; is given to SQLContext, it uses PreAnalyzer to modify the logical plan before assigning to &lt;tt&gt;QueryExecution.logical&lt;/tt&gt;. Then later operations will based on the pre-analyzed logical plan, instead of the original &lt;tt&gt;rawPlan&lt;/tt&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12785807">SPARK-6550</key>
            <summary>Add PreAnalyzer to keep logical plan consistent across DataFrame</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="marmbrus">Michael Armbrust</assignee>
                                    <reporter username="viirya">L. C. Hsieh</reporter>
                        <labels>
                    </labels>
                <created>Thu, 26 Mar 2015 08:30:10 +0000</created>
                <updated>Fri, 24 Apr 2015 00:31:22 +0000</updated>
                            <resolved>Fri, 27 Mar 2015 18:40:22 +0000</resolved>
                                                    <fixVersion>1.3.1</fixVersion>
                    <fixVersion>1.4.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14381571" author="apachespark" created="Thu, 26 Mar 2015 08:35:49 +0000"  >&lt;p&gt;User &apos;viirya&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/5203&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/5203&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14382746" author="apachespark" created="Thu, 26 Mar 2015 21:45:38 +0000"  >&lt;p&gt;User &apos;marmbrus&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/5217&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/5217&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14384341" author="marmbrus" created="Fri, 27 Mar 2015 18:40:22 +0000"  >&lt;p&gt;Issue resolved by pull request 5217&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/5217&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/5217&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 34 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i27dvb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12329486">1.3.1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>