<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:06:21 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-27330] ForeachWriter is not being closed once a batch is aborted</title>
                <link>https://issues.apache.org/jira/browse/SPARK-27330</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;in cases where a micro batch is being killed (interrupted), not during actual processing done by the &lt;tt&gt;ForeachDataWriter&lt;/tt&gt; (when iterating the iterator), &lt;tt&gt;DataWritingSparkTask&lt;/tt&gt; will&#160;handle the interruption and call&#160;&lt;tt&gt;dataWriter.abort()&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;the problem is that&#160;&lt;tt&gt;ForeachDataWriter&lt;/tt&gt; has an empty implementation&#160;for the abort method.&lt;/p&gt;

&lt;p&gt;due to that, I have tasks which uses the foreach writer and according to the &lt;a href=&quot;https://spark.apache.org/docs/latest/structured-streaming-programming-guide.html#foreach&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;documentation&lt;/a&gt;&#160;they are opening connections in the &quot;open&quot; method and closing the connections on the &quot;close&quot; method but since the &quot;close&quot; is never called, the connections are never closed&lt;/p&gt;

&lt;p&gt;this wasn&apos;t the behavior pre spark 2.4&lt;/p&gt;

&lt;p&gt;my suggestion is to call&#160;&lt;tt&gt;ForeachWriter.abort()&lt;/tt&gt; when &lt;tt&gt;DataWriter.abort()&lt;/tt&gt; is called,&#160; in order to notify the foreach writer that this task has failed&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
stack trace from the exception i have encountered:
 org.apache.spark.TaskKilledException: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
 at org.apache.spark.TaskContextImpl.killTaskIfInterrupted(TaskContextImpl.scala:149)
 at org.apache.spark.InterruptibleIterator.hasNext(InterruptibleIterator.scala:36)
 at scala.collection.Iterator$$anon$11.hasNext(Iterator.scala:408)
 at org.apache.spark.sql.execution.datasources.v2.DataWritingSparkTask$$anonfun$run$3.apply(WriteToDataSourceV2Exec.scala:117)
 at org.apache.spark.sql.execution.datasources.v2.DataWritingSparkTask$$anonfun$run$3.apply(WriteToDataSourceV2Exec.scala:116)
 at org.apache.spark.util.Utils$.tryWithSafeFinallyAndFailureCallbacks(Utils.scala:1394)
 at org.apache.spark.sql.execution.datasources.v2.DataWritingSparkTask$.run(WriteToDataSourceV2Exec.scala:146)
 at org.apache.spark.sql.execution.datasources.v2.WriteToDataSourceV2Exec$$anonfun$doExecute$2.apply(WriteToDataSourceV2Exec.scala:67)
 at org.apache.spark.sql.execution.datasources.v2.WriteToDataSourceV2Exec$$anonfun$doExecute$2.apply(WriteToDataSourceV2Exec.scala:66)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13225040">SPARK-27330</key>
            <summary>ForeachWriter is not being closed once a batch is aborted</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="eyalzit">Eyal Zituny</assignee>
                                    <reporter username="eyalzit">Eyal Zituny</reporter>
                        <labels>
                    </labels>
                <created>Sun, 31 Mar 2019 08:53:10 +0000</created>
                <updated>Mon, 12 Dec 2022 18:11:12 +0000</updated>
                            <resolved>Fri, 23 Aug 2019 14:44:04 +0000</resolved>
                                    <version>2.4.0</version>
                                    <fixVersion>2.4.4</fixVersion>
                    <fixVersion>3.0.0</fixVersion>
                                    <component>Structured Streaming</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16806086" author="eyalzit" created="Sun, 31 Mar 2019 09:05:23 +0000"  >&lt;p&gt;guys, let me know if my fix suggestion is make sense and i will provide a PR&lt;/p&gt;</comment>
                            <comment id="16806638" author="gsomogyi" created="Mon, 1 Apr 2019 10:45:35 +0000"  >&lt;p&gt;If processing throws any kind of exception then ForeachWriter never closed.&lt;br/&gt;
Just for my understanding what kind of problems have you faced when you&apos;ve written the following?&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;i have encountered issues in connections&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;A little bit more detail would be good.&lt;/p&gt;</comment>
                            <comment id="16806654" author="eyalzit" created="Mon, 1 Apr 2019 11:13:06 +0000"  >&lt;p&gt;I have updated the description, eventually i have tasks which are being killed without calling the &quot;close&quot; method and due to that i have connections which are never closed which lead to a leak in my connection pool.&lt;/p&gt;

&lt;p&gt;from the docs:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
streamingDatasetOfString.writeStream.foreach( &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ForeachWriter[&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;] {
  def open(partitionId: &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;, version: &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;): &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt; = {
    &lt;span class=&quot;code-comment&quot;&gt;// Open connection
&lt;/span&gt;  }

  def process(record: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;): Unit = {
    &lt;span class=&quot;code-comment&quot;&gt;// Write string to connection
&lt;/span&gt;  }

  def close(errorOrNull: Throwable): Unit = {
    &lt;span class=&quot;code-comment&quot;&gt;// Close the connection
&lt;/span&gt;  }}).start()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16806659" author="gsomogyi" created="Mon, 1 Apr 2019 11:19:54 +0000"  >&lt;p&gt;Now I see the point and makes sense from my perspective. A good example when CommitDeniedException has been thrown.&lt;br/&gt;
This can be properly unit tested. The tricky part is to make sure the close not called multiple times.&lt;/p&gt;</comment>
                            <comment id="16807316" author="gurwls223" created="Tue, 2 Apr 2019 00:31:16 +0000"  >&lt;p&gt;(I think &lt;tt&gt;close()&lt;/tt&gt; should be idempotent and documented as so)&lt;/p&gt;</comment>
                            <comment id="16817902" author="gsomogyi" created="Mon, 15 Apr 2019 11:59:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=eyalzit&quot; class=&quot;user-hover&quot; rel=&quot;eyalzit&quot;&gt;eyalzit&lt;/a&gt; are you working on this? Happy to file a PR if don&apos;t have time.&lt;/p&gt;</comment>
                            <comment id="16817918" author="eyalzit" created="Mon, 15 Apr 2019 12:17:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gsomogyi&quot; class=&quot;user-hover&quot; rel=&quot;gsomogyi&quot;&gt;gsomogyi&lt;/a&gt; yes, almost done with it&lt;/p&gt;</comment>
                            <comment id="16817926" author="gsomogyi" created="Mon, 15 Apr 2019 12:30:09 +0000"  >&lt;p&gt;Cool, ping me if you need review...&lt;/p&gt;</comment>
                            <comment id="16819054" author="eyalzit" created="Tue, 16 Apr 2019 14:12:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gsomogyi&quot; class=&quot;user-hover&quot; rel=&quot;gsomogyi&quot;&gt;gsomogyi&lt;/a&gt; i&apos;ve submitted a PR&lt;/p&gt;</comment>
                            <comment id="16914321" author="dongjoon" created="Fri, 23 Aug 2019 14:53:14 +0000"  >&lt;p&gt;Thank you, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=eyalzit&quot; class=&quot;user-hover&quot; rel=&quot;eyalzit&quot;&gt;eyalzit&lt;/a&gt;. You are added to the Apache Spark contributor group.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 12 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z01a5k:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>