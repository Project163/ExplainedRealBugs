<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:49:04 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-17348] Incorrect results from subquery transformation</title>
                <link>https://issues.apache.org/jira/browse/SPARK-17348</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Seq((1,1)).toDF(&quot;c1&quot;,&quot;c2&quot;).createOrReplaceTempView(&quot;t1&quot;)
Seq((1,1),(2,0)).toDF(&quot;c1&quot;,&quot;c2&quot;).createOrReplaceTempView(&quot;t2&quot;)
sql(&quot;select c1 from t1 where c1 in (select max(t2.c1) from t2 where t1.c2 &amp;gt;= t2.c2)&quot;).show

+---+
| c1|
+---+
|  1|
+---+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The correct result of the above query should be an empty set. Here is an explanation:&lt;/p&gt;

&lt;p&gt;Both rows from T2 satisfies the correlated predicate T1.C2 &amp;gt;= T2.C2 when T1.C1 = 1 so both rows needs to be processed in the same group of the aggregation process in the subquery. The result of the aggregation yields MAX(T2.C1) as 2. Therefore, the result of the evaluation of the predicate T1.C1 (which is 1) IN MAX(T2.C1) (which is 2) should be an empty set.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13001810">SPARK-17348</key>
            <summary>Incorrect results from subquery transformation</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nsyca">Nattavut Sutyanyong</assignee>
                                    <reporter username="nsyca">Nattavut Sutyanyong</reporter>
                        <labels>
                            <label>correctness</label>
                    </labels>
                <created>Wed, 31 Aug 2016 20:30:11 +0000</created>
                <updated>Tue, 15 Nov 2016 22:22:20 +0000</updated>
                            <resolved>Mon, 14 Nov 2016 20:04:19 +0000</resolved>
                                    <version>2.0.0</version>
                                    <fixVersion>2.0.3</fixVersion>
                    <fixVersion>2.1.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15453285" author="nsyca" created="Wed, 31 Aug 2016 20:36:01 +0000"  >&lt;p&gt;The root cause is in the rule &lt;tt&gt;ResolveSubquery&lt;/tt&gt; in Analysis phase where the correlated predicate &lt;tt&gt;T1.C2 &amp;gt;= T2.C2&lt;/tt&gt; is pulled up above the Aggregation operator.&lt;/p&gt;

 &lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;== Parsed Logical Plan ==
&apos;Project [&apos;c1]
+- &apos;Filter &apos;c1 IN (list#324)
   :  +- &apos;Project [unresolvedalias(&apos;max(&apos;t2.c1), None)]
   :     +- &apos;Filter (&apos;t1.c2 &amp;gt;= &apos;t2.c2)
   :        +- &apos;UnresolvedRelation `t2`
   +- &apos;UnresolvedRelation `t1`

== Analyzed Logical Plan ==
c1: int
Project [c1#334]
+- Filter predicate-subquery#324 [(c1#334 = max(c1)#339) &amp;amp;&amp;amp; (c2#335 &amp;gt;= c2#337)]
   :  +- Aggregate [c2#337], [max(c1#336) AS max(c1)#339, c2#337]
   :     +- SubqueryAlias t2
   :        +- Project [_1#299 AS c1#336, _2#300 AS c2#337]
   :           +- LocalRelation [_1#299, _2#300]
   +- SubqueryAlias t1
      +- Project [_1#288 AS c1#334, _2#289 AS c2#335]
         +- LocalRelation [_1#288, _2#289]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The pull up is okay only when the comparison is an equality.&lt;/p&gt;</comment>
                            <comment id="15453516" author="hvanhovell" created="Wed, 31 Aug 2016 22:06:36 +0000"  >&lt;p&gt;This is an interesting one. TBH I have never seen such a query being used in practice. Could you tell me what the analyzed plan should look like, because the only solution to me would be to implicitly join &lt;tt&gt;t1&lt;/tt&gt; to &lt;tt&gt;t2&lt;/tt&gt; in the subquery. &lt;/p&gt;

&lt;p&gt;For 2.0.1 we should fail analysis in this case. We have an analyzer rule in place to make sure no one uses aggregates in combination with correlated scalar subqueries. We could extend that or move that into analysis. It would be nice to have a fix for 2.1.&lt;/p&gt;</comment>
                            <comment id="15455851" author="nsyca" created="Thu, 1 Sep 2016 15:59:29 +0000"  >&lt;p&gt;Here is a use case:&lt;/p&gt;

&lt;p&gt;&quot;Find customers who bought items that are higher than the average price of the same items on the period of last two years from the date the items were bought.&quot;&lt;/p&gt;

&lt;p&gt;That is replacing from my example above:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;IN with &amp;gt;&lt;/li&gt;
	&lt;li&gt;the correlated predicate t1.c2 &amp;gt; t2.c2 with a BETWEEN..AND predicate for the 2-year period of the item bought&lt;/li&gt;
	&lt;li&gt;T1 is ITEM table&lt;/li&gt;
	&lt;li&gt;T2 is also the same ITEM table&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;and adding&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;perhaps a CUSTOMER table to join with the ITEM on the parent side to pick up customer profiles&lt;/li&gt;
	&lt;li&gt;and another correlated equality join on the ITEM_ID between the parent ITEM and the subquery ITEM&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The bottom line is Spark 2.0 supports only a subset of SQL subqueries. A good subset of them are blocked. This is, I believe, because of the lack of runtime capability to process subqueries, specifically correlated subqueries. The current implementation aggressively (and, as in this case, incorrectly) converts correlated subqueries to some forms of joins. If we want to support a full class of SQL subqueries, we cannot assume that all forms of subqueries can be &quot;de-correlated&quot; and we need to have a fallback plan to execute subqueries in runtime.&lt;/p&gt;

&lt;p&gt;This work is not a single PR work. It needs to craft out a design. Areas that we need to work are:&lt;/p&gt;

&lt;p&gt;1. (Assume I am right) Extend nested-loop join to support correlation processing, both shallow and deep correlations.&lt;br/&gt;
2. Rework on the representation in the Logical Plan to cover all the supported cases.&lt;br/&gt;
3. Rework and extend the &quot;de-correlation&quot; rewrite code.&lt;/p&gt;</comment>
                            <comment id="15629385" author="nsyca" created="Wed, 2 Nov 2016 15:54:30 +0000"  >&lt;p&gt;I propose to use this JIRA to just close off the incorrect result scenario as an error case. Or I could open a new JIRA for it and maintain this JIRA for a general solution of supporting subquery processing in run-time.&lt;/p&gt;

&lt;p&gt;I also propose that we should separate the subquery to join transform from Analyzer phase to Optimizer phase. My understanding is the objective of Analyzer phase is to process any unresolved constructs from the LogicalPlan output from Parser phase to resolved LogicalPlan. Then Optimizer phase will take the resolved LogicalPlan from Analyzer and make it an optimal LogicalPlan.&lt;/p&gt;</comment>
                            <comment id="15635199" author="apachespark" created="Fri, 4 Nov 2016 04:31:16 +0000"  >&lt;p&gt;User &apos;nsyca&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/15763&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/15763&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15635204" author="nsyca" created="Fri, 4 Nov 2016 04:33:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hvanhovell&quot; class=&quot;user-hover&quot; rel=&quot;hvanhovell&quot;&gt;hvanhovell&lt;/a&gt;, would you please review my PR to return an Analysis exception on the scenarios that could produce incorrect results? Thank you.&lt;/p&gt;</comment>
                            <comment id="15636886" author="nsyca" created="Fri, 4 Nov 2016 16:24:51 +0000"  >&lt;p&gt;I&apos;d like to a note that a piece of existing code that closes to address this problem but only done for the scalar subquery context can be found by searching this pattern in CheckAnalysis.scala (line 126):&lt;br/&gt;
&lt;em&gt;&quot;The correlated scalar subquery can only contain equality predicates:&quot;&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;An existing test coverage for that scenario is at&lt;br/&gt;
&lt;em&gt;SubquerySuite/non-equal correlated scalar subquery&lt;/em&gt;&lt;/p&gt;</comment>
                            <comment id="15637099" author="hvanhovell" created="Fri, 4 Nov 2016 17:36:03 +0000"  >&lt;p&gt;Yeah, it would be nice if you can consolidate the two, and put your current fix there as well.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13020945">SPARK-18455</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 2 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i333cn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>