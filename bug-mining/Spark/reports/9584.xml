<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:41:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-47177] Cached SQL plan do not display final AQE plan in explain string</title>
                <link>https://issues.apache.org/jira/browse/SPARK-47177</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;AQE plan is expected to display final plan after execution. This is not true for cached SQL plan: it will show the initial plan instead. This behavior change is introduced in &lt;a href=&quot;https://github.com/apache/spark/pull/40812&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/40812&lt;/a&gt; it tried to fix the concurrency issue with cached plan.&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;In short, the plan used to executed and the plan used to explain is not the same instance, thus causing the inconsistency.&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I don&apos;t have a clear idea how yet&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;maybe we just a coarse granularity lock in explain?&lt;/li&gt;
	&lt;li&gt;make innerChildren a function: clone the initial plan, every time checked for whether the original AQE plan is finalized (making the final flag atomic first, of course), if no return the cloned initial plan, if it&apos;s finalized, clone the final plan and return that one. But still this won&apos;t be able to reflect the AQE plan in real time, in a concurrent situation, but at least we have initial version and final version.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;A simple repro:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
d1 = spark.range(1000).withColumn(&lt;span class=&quot;code-quote&quot;&gt;&quot;key&quot;&lt;/span&gt;, expr(&lt;span class=&quot;code-quote&quot;&gt;&quot;id % 100&quot;&lt;/span&gt;)).groupBy(&lt;span class=&quot;code-quote&quot;&gt;&quot;key&quot;&lt;/span&gt;).agg({&lt;span class=&quot;code-quote&quot;&gt;&quot;key&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;count&quot;&lt;/span&gt;})
cached_d2 = d1.cache()
df = cached_d2.filter(&lt;span class=&quot;code-quote&quot;&gt;&quot;key &amp;gt; 10&quot;&lt;/span&gt;)
df.collect()&#160;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&amp;gt;&amp;gt;&amp;gt; df.explain()
== Physical Plan ==
AdaptiveSparkPlan isFinalPlan=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
+- == Final Plan ==
&#160; &#160;*(1) Filter (isnotnull(key#4L) AND (key#4L &amp;gt; 10))
&#160; &#160;+- TableCacheQueryStage 0
&#160; &#160; &#160; +- InMemoryTableScan [key#4L, count(key)#10L], [isnotnull(key#4L), (key#4L &amp;gt; 10)]
&#160; &#160; &#160; &#160; &#160; &#160; +- InMemoryRelation [key#4L, count(key)#10L], StorageLevel(disk, memory, deserialized, 1 replicas)
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; +- AdaptiveSparkPlan isFinalPlan=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;+- HashAggregate(keys=[key#4L], functions=[count(key#4L)])
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; +- Exchange hashpartitioning(key#4L, 200), ENSURE_REQUIREMENTS, [plan_id=24]
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;+- HashAggregate(keys=[key#4L], functions=[partial_count(key#4L)])
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; +- Project [(id#2L % 100) AS key#4L]
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;+- Range (0, 1000, step=1, splits=10)
+- == Initial Plan ==
&#160; &#160;Filter (isnotnull(key#4L) AND (key#4L &amp;gt; 10))
&#160; &#160;+- InMemoryTableScan [key#4L, count(key)#10L], [isnotnull(key#4L), (key#4L &amp;gt; 10)]
&#160; &#160; &#160; &#160; &#160;+- InMemoryRelation [key#4L, count(key)#10L], StorageLevel(disk, memory, deserialized, 1 replicas)
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;+- AdaptiveSparkPlan isFinalPlan=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; +- HashAggregate(keys=[key#4L], functions=[count(key#4L)])
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;+- Exchange hashpartitioning(key#4L, 200), ENSURE_REQUIREMENTS, [plan_id=24]
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; +- HashAggregate(keys=[key#4L], functions=[partial_count(key#4L)])
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;+- Project [(id#2L % 100) AS key#4L]
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; +- Range (0, 1000, step=1, splits=10)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13569916">SPARK-47177</key>
            <summary>Cached SQL plan do not display final AQE plan in explain string</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ulysses">XiDuo You</assignee>
                                    <reporter username="liuzq12">Ziqi Liu</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 27 Feb 2024 01:05:38 +0000</created>
                <updated>Tue, 5 Mar 2024 08:51:21 +0000</updated>
                            <resolved>Tue, 5 Mar 2024 02:16:05 +0000</resolved>
                                    <version>3.4.2</version>
                    <version>3.5.0</version>
                    <version>3.5.1</version>
                    <version>3.5.2</version>
                    <version>4.0.0</version>
                                    <fixVersion>3.5.2</fixVersion>
                    <fixVersion>3.4.3</fixVersion>
                    <fixVersion>4.0.0</fixVersion>
                                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17823394" author="ulysses" created="Tue, 5 Mar 2024 02:16:05 +0000"  >&lt;p&gt;Issue resolved by pull request 45282&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/45282&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/45282&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13532807">SPARK-43157</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 36 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1nmrs:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>