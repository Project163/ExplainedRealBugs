<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:54:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-21263] NumberFormatException is not thrown while converting an invalid string to float/double</title>
                <link>https://issues.apache.org/jira/browse/SPARK-21263</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;When reading a below-mentioned data by specifying user-defined schema, exception is not thrown. Refer the details :&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Data:&lt;/b&gt; &lt;br/&gt;
&apos;PatientID&apos;,&apos;PatientName&apos;,&apos;TotalBill&apos;&lt;br/&gt;
&apos;1000&apos;,&apos;Patient1&apos;,&apos;10u000&apos;&lt;br/&gt;
&apos;1001&apos;,&apos;Patient2&apos;,&apos;30000&apos;&lt;br/&gt;
&apos;1002&apos;,&apos;Patient3&apos;,&apos;40000&apos;&lt;br/&gt;
&apos;1003&apos;,&apos;Patient4&apos;,&apos;50000&apos;&lt;br/&gt;
&apos;1004&apos;,&apos;Patient5&apos;,&apos;60000&apos;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Source code&lt;/b&gt;: &lt;br/&gt;
Dataset dataset = sparkSession.read().schema(schema)&lt;br/&gt;
.option(INFER_SCHEMA, &quot;true&quot;)&lt;br/&gt;
.option(DELIMITER, &quot;,&quot;)&lt;br/&gt;
.option(QUOTE, &quot;\&quot;&quot;)&lt;br/&gt;
.option(MODE, Mode.PERMISSIVE)&lt;br/&gt;
.csv(sourceFile);&lt;/p&gt;

&lt;p&gt;When we collect the dataset data: &lt;br/&gt;
dataset.collectAsList();&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Schema1&lt;/b&gt;: &lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;StructField(PatientID,IntegerType,true), StructField(PatientName,StringType,true), StructField(TotalBill,IntegerType,true)&amp;#93;&lt;/span&gt;&lt;br/&gt;
*Result *: Throws NumerFormatException &lt;br/&gt;
Caused by: java.lang.NumberFormatException: For input string: &quot;10u000&quot;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Schema2&lt;/b&gt;: &lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;StructField(PatientID,IntegerType,true), StructField(PatientName,StringType,true), StructField(TotalBill,DoubleType,true)&amp;#93;&lt;/span&gt;&lt;br/&gt;
&lt;b&gt;Actual Result&lt;/b&gt;: &lt;br/&gt;
&quot;PatientID&quot;: 1000,&lt;br/&gt;
&quot;NumberOfVisits&quot;: &quot;400&quot;,&lt;br/&gt;
&quot;TotalBill&quot;: 10,&lt;br/&gt;
&lt;b&gt;Expected Result&lt;/b&gt;: Should throw NumberFormatException for input string &quot;10u000&quot;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13083694">SPARK-21263</key>
            <summary>NumberFormatException is not thrown while converting an invalid string to float/double</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gurwls223">Hyukjin Kwon</assignee>
                                    <reporter username="Navya Krishnappa">Navya Krishnappa</reporter>
                        <labels>
                    </labels>
                <created>Fri, 30 Jun 2017 07:40:14 +0000</created>
                <updated>Mon, 12 Dec 2022 18:11:05 +0000</updated>
                            <resolved>Tue, 11 Jul 2017 10:11:22 +0000</resolved>
                                    <version>2.1.1</version>
                                    <fixVersion>2.3.0</fixVersion>
                                    <component>Java API</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16069664" author="srowen" created="Fri, 30 Jun 2017 08:01:11 +0000"  >&lt;p&gt;This is because:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.text.NumberFormat.getInstance.parse(&lt;span class=&quot;code-quote&quot;&gt;&quot;10u000&quot;&lt;/span&gt;)
foo: &lt;span class=&quot;code-object&quot;&gt;Number&lt;/span&gt; = 10
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This is the code path used to parse a double in this case, and the Java libaries will just stop parsing if they can&apos;t interpret the rest of the input.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hyukjin.kwon&quot; class=&quot;user-hover&quot; rel=&quot;hyukjin.kwon&quot;&gt;hyukjin.kwon&lt;/a&gt; did you write it this way to account for varying decimal separators? instead of just &lt;tt&gt;.toDouble&lt;/tt&gt; or something? it&apos;s hard-coded to a US locale though.&lt;/p&gt;</comment>
                            <comment id="16069800" author="gurwls223" created="Fri, 30 Jun 2017 09:48:32 +0000"  >&lt;p&gt;The code path should be here - &lt;a href=&quot;https://github.com/apache/spark/blob/0b903caef3183c5113feb09995874f6a07aa6698/sql/core/src/main/scala/org/apache/spark/sql/execution/datasources/csv/UnivocityParser.scala#L121-L126&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/0b903caef3183c5113feb09995874f6a07aa6698/sql/core/src/main/scala/org/apache/spark/sql/execution/datasources/csv/UnivocityParser.scala#L121-L126&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I believe this is there since it is a thrid party in the first place - &lt;a href=&quot;https://github.com/databricks/spark-csv/commit/21b3d6233514894911147343be87df0cd42000eb&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/databricks/spark-csv/commit/21b3d6233514894911147343be87df0cd42000eb&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16069813" author="gurwls223" created="Fri, 30 Jun 2017 09:53:47 +0000"  >&lt;p&gt;Hm.. losing data sounds not quite good to me but I am unclear if we should call it a bug, in which case I believe we can fix it.&lt;/p&gt;</comment>
                            <comment id="16069911" author="srowen" created="Fri, 30 Jun 2017 10:56:21 +0000"  >&lt;p&gt;CC &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=falaki&quot; class=&quot;user-hover&quot; rel=&quot;falaki&quot;&gt;falaki&lt;/a&gt; as well for the original code&lt;/p&gt;

&lt;p&gt;Yeah, tough one. The original code is trying to handle Locale, as I expected. The Spark version does not as (for other good reasons) it is not sensitive to the machine&apos;s locale.&lt;/p&gt;

&lt;p&gt;I think the right behavior is therefore to fail on this type of input. I think it&apos;s more a fix than behavior change, IMHO, because getting &quot;10&quot; out of &quot;10u000&quot; silently doesn&apos;t sound like a good idea.&lt;/p&gt;

&lt;p&gt;We could use &lt;tt&gt;.toDouble&lt;/tt&gt;. We can also keep the current code but check whether it consumed all the input by checking &lt;tt&gt;ParsePosition&lt;/tt&gt; afterwards. I note that, for example, the current code would parse &quot;10e3&quot; as &quot;10&quot;, whereas &lt;tt&gt;.toDouble&lt;/tt&gt; would parse as 10000.0. So using the latter does introduce small behavior changes, but again, it seems less surprising to parse that correctly as scientific notation, like standard JVM parsing routines would?&lt;/p&gt;</comment>
                            <comment id="16072234" author="navya krishnappa" created="Mon, 3 Jul 2017 10:28:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sowen&quot; class=&quot;user-hover&quot; rel=&quot;sowen&quot;&gt;sowen&lt;/a&gt; &amp;amp; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hyukjin.kwon&quot; class=&quot;user-hover&quot; rel=&quot;hyukjin.kwon&quot;&gt;hyukjin.kwon&lt;/a&gt; Thanks for your comments. Let me know the resolution for this issue.&lt;/p&gt;</comment>
                            <comment id="16072241" author="srowen" created="Mon, 3 Jul 2017 10:34:30 +0000"  >&lt;p&gt;I believe I favor taking the small behavior change to fix the more important parsing problem, and change these to use .toDouble and .toFloat&lt;/p&gt;</comment>
                            <comment id="16074109" author="falaki" created="Tue, 4 Jul 2017 22:54:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sowen&quot; class=&quot;user-hover&quot; rel=&quot;sowen&quot;&gt;sowen&lt;/a&gt; note that user specified the mode to be PERMISSIVE. In this mode CSV data source will try to ignore errors and return some result. If the mode is FAILFAST, it should throw an exception. I see the permissiveness of different modes as follows:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;PERMISSIVE &amp;gt; DROPMALFORMED &amp;gt; FAILFAST
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Here we have different behavior for &lt;tt&gt;IntegerType&lt;/tt&gt; vs. &lt;tt&gt;DoubleType&lt;/tt&gt;. That needs to be fixed and behavior should be consistent.&lt;/p&gt;</comment>
                            <comment id="16074113" author="gurwls223" created="Tue, 4 Jul 2017 23:08:12 +0000"  >&lt;p&gt;Let me propose a change soon but Hm.. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=falaki&quot; class=&quot;user-hover&quot; rel=&quot;falaki&quot;&gt;falaki&lt;/a&gt;, however, isn&apos;t it unrelated with the parse mode as it is parsed correctly but the parsed one lost data partially?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;scala&amp;gt; spark.read.schema(&lt;span class=&quot;code-quote&quot;&gt;&quot;a DOUBLE&quot;&lt;/span&gt;).option(&lt;span class=&quot;code-quote&quot;&gt;&quot;mode&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;FAILFAST&quot;&lt;/span&gt;).csv(Seq(&lt;span class=&quot;code-quote&quot;&gt;&quot;10u12&quot;&lt;/span&gt;).toDS).show()
+----+
|   a|
+----+
|10.0|
+----+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;scala&amp;gt; spark.read.schema(&lt;span class=&quot;code-quote&quot;&gt;&quot;a INT&quot;&lt;/span&gt;).option(&lt;span class=&quot;code-quote&quot;&gt;&quot;mode&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;FAILFAST&quot;&lt;/span&gt;).csv(Seq(&lt;span class=&quot;code-quote&quot;&gt;&quot;10u12&quot;&lt;/span&gt;).toDS).show()
...
org.apache.spark.SparkException: Malformed records are detected in record parsing. Parse Mode: FAILFAST.
...
Caused by: java.lang.NumberFormatException: For input string: &lt;span class=&quot;code-quote&quot;&gt;&quot;10u12&quot;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16074118" author="gurwls223" created="Tue, 4 Jul 2017 23:35:01 +0000"  >&lt;p&gt;Ah, sorry, the original JIRA describes why it does not throw an exception. Yes, it should return &lt;tt&gt;null&lt;/tt&gt; instead.&lt;/p&gt;</comment>
                            <comment id="16074121" author="apachespark" created="Tue, 4 Jul 2017 23:46:03 +0000"  >&lt;p&gt;User &apos;HyukjinKwon&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/18532&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/18532&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16074292" author="srowen" created="Wed, 5 Jul 2017 06:10:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hyukjin.kwon&quot; class=&quot;user-hover&quot; rel=&quot;hyukjin.kwon&quot;&gt;hyukjin.kwon&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=falaki&quot; class=&quot;user-hover&quot; rel=&quot;falaki&quot;&gt;falaki&lt;/a&gt; Yeah I saw &quot;PERMISSIVE&quot; but I don&apos;t think that comes into play here. There is actually no parsing error at all, and &quot;10u000&quot; is considered correctly parsed as &quot;10&quot;.&lt;/p&gt;</comment>
                            <comment id="16082005" author="srowen" created="Tue, 11 Jul 2017 10:11:22 +0000"  >&lt;p&gt;Issue resolved by pull request 18532&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/18532&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/18532&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 19 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3gxnz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>