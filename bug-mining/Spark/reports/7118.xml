<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:15:45 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-31423] DATES and TIMESTAMPS for a certain range are off by 10 days when stored in ORC</title>
                <link>https://issues.apache.org/jira/browse/SPARK-31423</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;There is a range of days (1582-10-05 to 1582-10-14) for which DATEs and TIMESTAMPS are changed when stored in ORC. The value is off by 10 days.&lt;/p&gt;

&lt;p&gt;For example:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;scala&amp;gt; val df = sql(&quot;select cast(&apos;1582-10-14&apos; as DATE) dt&quot;)
df: org.apache.spark.sql.DataFrame = [dt: date]

scala&amp;gt; df.show // seems fine
+----------+
|        dt|
+----------+
|1582-10-14|
+----------+

scala&amp;gt; df.write.mode(&quot;overwrite&quot;).orc(&quot;/tmp/funny_orc_date&quot;)

scala&amp;gt; spark.read.orc(&quot;/tmp/funny_orc_date&quot;).show // off by 10 days
+----------+
|        dt|
+----------+
|1582-10-24|
+----------+

scala&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;ORC has the same issue with TIMESTAMPS:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;scala&amp;gt; val df = sql(&quot;select cast(&apos;1582-10-14 00:00:00&apos; as TIMESTAMP) ts&quot;)
df: org.apache.spark.sql.DataFrame = [ts: timestamp]

scala&amp;gt; df.show // seems fine
+-------------------+
|                 ts|
+-------------------+
|1582-10-14 00:00:00|
+-------------------+

scala&amp;gt; df.write.mode(&quot;overwrite&quot;).orc(&quot;/tmp/funny_orc_timestamp&quot;)

scala&amp;gt; spark.read.orc(&quot;/tmp/funny_orc_timestamp&quot;).show(truncate=false) // off by 10 days
+-------------------+
|ts                 |
+-------------------+
|1582-10-24 00:00:00|
+-------------------+

scala&amp;gt; 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;However, when written to Parquet or Avro, DATES and TIMESTAMPs for this range do not change.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;scala&amp;gt; val df = sql(&quot;select cast(&apos;1582-10-14&apos; as DATE) dt&quot;)
df: org.apache.spark.sql.DataFrame = [dt: date]

scala&amp;gt; df.write.mode(&quot;overwrite&quot;).parquet(&quot;/tmp/funny_parquet_date&quot;)

scala&amp;gt; spark.read.parquet(&quot;/tmp/funny_parquet_date&quot;).show // reflects original value
+----------+
|        dt|
+----------+
|1582-10-14|
+----------+

scala&amp;gt; val df = sql(&quot;select cast(&apos;1582-10-14&apos; as DATE) dt&quot;)
df: org.apache.spark.sql.DataFrame = [dt: date]

scala&amp;gt; df.write.mode(&quot;overwrite&quot;).format(&quot;avro&quot;).save(&quot;/tmp/funny_avro_date&quot;)

scala&amp;gt; spark.read.format(&quot;avro&quot;).load(&quot;/tmp/funny_avro_date&quot;).show // reflects original value
+----------+
|        dt|
+----------+
|1582-10-14|
+----------+

scala&amp;gt; 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;It&apos;s unclear to me whether ORC is behaving correctly or not, as this is how Spark 2.4 works with DATEs and TIMESTAMPs in general (and also how Spark 3.x works with DATEs and TIMESTAMPs in general when &lt;tt&gt;spark.sql.legacy.timeParserPolicy&lt;/tt&gt; is set to &lt;tt&gt;LEGACY&lt;/tt&gt;). In Spark 2.4, DATEs and TIMESTAMPs in this range don&apos;t exist:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;scala&amp;gt; sql(&quot;select cast(&apos;1582-10-14&apos; as DATE) dt&quot;).show // the same cast done in Spark 2.4
+----------+
|        dt|
+----------+
|1582-10-24|
+----------+

scala&amp;gt; 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I assume the following snippet is relevant (from the Wikipedia entry on the Gregorian calendar):&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;To deal with the 10 days&apos; difference (between calendar and reality)&lt;span class=&quot;error&quot;&gt;&amp;#91;Note 2&amp;#93;&lt;/span&gt; that this drift had already reached, the date was advanced so that 4 October 1582 was followed by 15 October 1582&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Spark 3.x should treat DATEs and TIMESTAMPS in this range consistently, and probably based on&#160;spark.sql.legacy.timeParserPolicy (or some other config) rather than file format.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13297820">SPARK-31423</key>
            <summary>DATES and TIMESTAMPS for a certain range are off by 10 days when stored in ORC</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="8">Not A Problem</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="bersprockets">Bruce Robbins</reporter>
                        <labels>
                    </labels>
                <created>Sat, 11 Apr 2020 23:28:19 +0000</created>
                <updated>Mon, 12 Dec 2022 18:10:56 +0000</updated>
                            <resolved>Fri, 17 Apr 2020 09:20:00 +0000</resolved>
                                    <version>3.0.0</version>
                    <version>3.1.0</version>
                                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17082039" author="gurwls223" created="Mon, 13 Apr 2020 04:22:04 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maxgekk&quot; class=&quot;user-hover&quot; rel=&quot;maxgekk&quot;&gt;maxgekk&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cloud_fan&quot; class=&quot;user-hover&quot; rel=&quot;cloud_fan&quot;&gt;cloud_fan&lt;/a&gt; FYI.&lt;/p&gt;</comment>
                            <comment id="17082228" author="cloud_fan" created="Mon, 13 Apr 2020 10:53:42 +0000"  >&lt;p&gt;FYI this is the behavior of Spark 2.4:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
scala&amp;gt; val df = sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;select &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(&lt;span class=&quot;code-quote&quot;&gt;&apos;1582-10-14&apos;&lt;/span&gt; as DATE) dt&quot;&lt;/span&gt;)
df: org.apache.spark.sql.DataFrame = [dt: date]

scala&amp;gt; df.show
+----------+
|        dt|
+----------+
|1582-10-24|
+----------+


scala&amp;gt; df.write.mode(&lt;span class=&quot;code-quote&quot;&gt;&quot;overwrite&quot;&lt;/span&gt;).orc(&lt;span class=&quot;code-quote&quot;&gt;&quot;/tmp/funny_orc_date&quot;&lt;/span&gt;)

scala&amp;gt; spark.read.orc(&lt;span class=&quot;code-quote&quot;&gt;&quot;/tmp/funny_orc_date&quot;&lt;/span&gt;).show
+----------+
|        dt|
+----------+
|1582-10-24|
+----------+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The result is wrong at the very beginning.&lt;/p&gt;</comment>
                            <comment id="17082498" author="bersprockets" created="Mon, 13 Apr 2020 17:11:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cloud_fan&quot; class=&quot;user-hover&quot; rel=&quot;cloud_fan&quot;&gt;cloud_fan&lt;/a&gt;&#160;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;FYI this is the behavior of Spark 2.4&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yes, I noted that in my description. What I mean is that in Spark 3.x (and without any legacy config touched), only ORC demonstrates this behavior. CAST, and the Parquet and Avro file formats do not demonstrate this behavior.&lt;/p&gt;</comment>
                            <comment id="17083314" author="maxgekk" created="Tue, 14 Apr 2020 14:58:15 +0000"  >&lt;p&gt;I am working on the issue.&lt;/p&gt;</comment>
                            <comment id="17083595" author="maxgekk" created="Tue, 14 Apr 2020 20:40:59 +0000"  >&lt;p&gt;I have debugged this slightly on Spark 2.4, so, &apos;1582-10-14&apos; falls to the case while parsing from UTF8String:&lt;br/&gt;
&lt;a href=&quot;https://github.com/AdoptOpenJDK/openjdk-jdk8u/blob/aa318070b27849f1fe00d14684b2a40f7b29bf79/jdk/src/share/classes/java/util/GregorianCalendar.java#L2762-L2768&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/AdoptOpenJDK/openjdk-jdk8u/blob/aa318070b27849f1fe00d14684b2a40f7b29bf79/jdk/src/share/classes/java/util/GregorianCalendar.java#L2762-L2768&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
                    &lt;span class=&quot;code-comment&quot;&gt;// The date is in a &lt;span class=&quot;code-quote&quot;&gt;&quot;missing&quot;&lt;/span&gt; period.
&lt;/span&gt;                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!isLenient()) {
                        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IllegalArgumentException(&lt;span class=&quot;code-quote&quot;&gt;&quot;the specified date doesn&apos;t exist&quot;&lt;/span&gt;);
                    }
                    &lt;span class=&quot;code-comment&quot;&gt;// Take the Julian date &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; compatibility, which
&lt;/span&gt;                    &lt;span class=&quot;code-comment&quot;&gt;// will produce a Gregorian date.
&lt;/span&gt;                    fixedDate = jfd;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In the strong mode, the code &lt;a href=&quot;https://github.com/apache/spark/blob/branch-2.4/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/util/DateTimeUtils.scala#L517&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/branch-2.4/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/util/DateTimeUtils.scala#L517&lt;/a&gt; would throw the exception:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IllegalArgumentException(&lt;span class=&quot;code-quote&quot;&gt;&quot;the specified date doesn&apos;t exist&quot;&lt;/span&gt;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;but we are in the &quot;weak&quot; mode, in this way Java 7 GregorianCalendar interprets the date especially:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// Take the Julian date &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; compatibility, which
&lt;/span&gt; &lt;span class=&quot;code-comment&quot;&gt;// will produce a Gregorian date.&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The date &apos;1582-10-14&apos; doesn&apos;t exist in the hybrid calendar used by Java 7 time API. It is questionable how to handle the date in such calendar. &lt;/p&gt;</comment>
                            <comment id="17083611" author="bersprockets" created="Tue, 14 Apr 2020 21:11:40 +0000"  >&lt;blockquote&gt;&lt;p&gt;It is questionable how to handle the date in such calendar.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Sorry if I am asking a dumb question. Are you saying that ORC stores only in the hybrid Julian calendar?&lt;/p&gt;</comment>
                            <comment id="17083822" author="cloud_fan" created="Wed, 15 Apr 2020 06:02:50 +0000"  >&lt;p&gt;The ORC file format spec doesn&apos;t specify the calendar, but the ORC library (reader and writer) uses java 7 Date/Timestamp which indicates the hybrid Julian calendar.&lt;/p&gt;</comment>
                            <comment id="17083828" author="cloud_fan" created="Wed, 15 Apr 2020 06:13:30 +0000"  >&lt;p&gt;We probably have a bug about picking the next valid date, but the behavior itself is expected: Spark always pick the next valid date&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
scala&amp;gt; sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;select date&lt;span class=&quot;code-quote&quot;&gt;&apos;1990-9-31&apos;&lt;/span&gt;&quot;&lt;/span&gt;).show
+-----------------+
|DATE &lt;span class=&quot;code-quote&quot;&gt;&apos;1990-10-01&apos;&lt;/span&gt;|
+-----------------+
|       1990-10-01|
+-----------------+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It&apos;s a bit weird that this date is valid in Spark but invalid in ORC because the calendar is different. I&apos;m OK to fail for this case, with a config to allow users to write it anyway by picking the next valid date.&lt;/p&gt;</comment>
                            <comment id="17084218" author="bersprockets" created="Wed, 15 Apr 2020 16:18:59 +0000"  >&lt;p&gt;OK, so this is a case of a limitation of the ORC library, and there is not much we can do about it in Spark (other than throw an user-overridable exception when this happens).&lt;/p&gt;

&lt;p&gt;Therefore, some users might see a case like this:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;val df = sql(&quot;select cast(&apos;1582-10-14&apos; as DATE) dt&quot;)
df.write.mode(&quot;overwrite&quot;).parquet(&quot;/tmp/dateparquet&quot;)
df.write.mode(&quot;overwrite&quot;).format(&quot;avro&quot;).save(&quot;/tmp/dateavro&quot;)
df.write.mode(&quot;overwrite&quot;).orc(&quot;/tmp/dateorc&quot;)

val dfParquet = spark.read.parquet(&quot;/tmp/dateparquet&quot;)
val dfAvro = spark.read.format(&quot;avro&quot;).load(&quot;/tmp/dateavro&quot;)
val dfOrc = spark.read.orc(&quot;/tmp/dateorc&quot;)

scala&amp;gt; 

scala&amp;gt; dfParquet.join(dfAvro, &quot;dt&quot;).count // can join to avro
res4: Long = 1

scala&amp;gt; dfParquet.join(dfOrc, &quot;dt&quot;).count // doesn&apos;t find it in orc
res5: Long = 0

scala&amp;gt; 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17084234" author="cloud_fan" created="Wed, 15 Apr 2020 16:42:39 +0000"  >&lt;p&gt;I hope the ORC community can figure this out and switch to/support the standard proleptic Gregorian calendar. One thing we can do is to check the behavior of Hive 3.x, as Hive also switches to the proleptic Gregorian calendar and should have the same issue.&lt;/p&gt;</comment>
                            <comment id="17084288" author="bersprockets" created="Wed, 15 Apr 2020 18:12:07 +0000"  >&lt;p&gt;Thanks. It seems we can either&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;close this as &quot;not a bug&quot;, or&lt;/li&gt;
	&lt;li&gt;I can file an ORC Jira (later this week, after I fiddle with the library a bit) and mark this as blocked on the ORC Jira.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17084308" author="maxgekk" created="Wed, 15 Apr 2020 18:45:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bersprockets&quot; class=&quot;user-hover&quot; rel=&quot;bersprockets&quot;&gt;bersprockets&lt;/a&gt; I think we should take the next valid date for any not-existed dates, see the linked PR.&lt;/p&gt;</comment>
                            <comment id="17085585" author="cloud_fan" created="Fri, 17 Apr 2020 09:19:47 +0000"  >&lt;p&gt;I&apos;m closing it as &quot;not a bug&quot;. This happens because we &quot;rebase&quot; the datetime values for the calendar changes. There are some dates exist in one calendar but not another. What we can do is to move to the next valid date. Eventually every place should use the standard calendar so we won&apos;t have this problem.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 30 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0djc8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>