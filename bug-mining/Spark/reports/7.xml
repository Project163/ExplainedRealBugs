<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:11:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-597] HashPartitioner incorrectly partitions RDD[Array[_]]</title>
                <link>https://issues.apache.org/jira/browse/SPARK-597</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Java arrays have &lt;tt&gt;hashCodes&lt;/tt&gt; that are based on the arrays&apos; identities rather than their contents &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;.  As a result, attempting to partition an &lt;tt&gt;RDD[Array&lt;span class=&quot;error&quot;&gt;&amp;#91;_&amp;#93;&lt;/span&gt;]&lt;/tt&gt; using a &lt;tt&gt;HashPartitioner&lt;/tt&gt; will produce an unexpected/incorrect result.&lt;/p&gt;

&lt;p&gt;This was the cause of a bug in PySpark, where I hash partition PairRDDs with &lt;tt&gt;Array&lt;span class=&quot;error&quot;&gt;&amp;#91;Byte&amp;#93;&lt;/span&gt;&lt;/tt&gt; keys.  In PySpark, I fixed this by using a custom &lt;tt&gt;Partitioner&lt;/tt&gt; that calls &lt;tt&gt;Arrays.hashCode(byte[])&lt;/tt&gt; when passed an &lt;tt&gt;Array&lt;span class=&quot;error&quot;&gt;&amp;#91;Byte&amp;#93;&lt;/span&gt;&lt;/tt&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;.&lt;/p&gt;

&lt;p&gt;I would like to address this issue more generally in Spark.&lt;/p&gt;

&lt;p&gt;We could add logic to &lt;tt&gt;HashPartitioner&lt;/tt&gt; to perform special handling for arrays, but I&apos;m not sure whether the additional branching would add a significant performance overhead.  The logic could become messy because the &lt;tt&gt;Arrays&lt;/tt&gt; module defines &lt;tt&gt;Arrays.hashCode()&lt;/tt&gt; for primitive arrays and &lt;tt&gt;Arrays.deepHashCode()&lt;/tt&gt; for Object arrays.  Perhaps Guava or Apache Commons has an implementation of this.&lt;/p&gt;

&lt;p&gt;An alternative would be to keep the current &lt;tt&gt;HashPartitioner&lt;/tt&gt; and add logic to print warnings (or to fail with an error) when shuffling an &lt;tt&gt;RDD[Array&lt;span class=&quot;error&quot;&gt;&amp;#91;_&amp;#93;&lt;/span&gt;]&lt;/tt&gt; using the default &lt;tt&gt;HashPartitioner&lt;/tt&gt;.&lt;/p&gt;


&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;http://stackoverflow.com/questions/744735/java-array-hashcode-implementation&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://stackoverflow.com/questions/744735/java-array-hashcode-implementation&lt;/a&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/JoshRosen/spark/commit/2ccf3b665280bf5b0919e3801d028126cb070dbd&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/JoshRosen/spark/commit/2ccf3b665280bf5b0919e3801d028126cb070dbd&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12704982">SPARK-597</key>
            <summary>HashPartitioner incorrectly partitions RDD[Array[_]]</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="joshrosen">Josh Rosen</assignee>
                                    <reporter username="joshrosen">Josh Rosen</reporter>
                        <labels>
                    </labels>
                <created>Sun, 28 Oct 2012 22:51:45 +0000</created>
                <updated>Wed, 8 Oct 2014 22:27:50 +0000</updated>
                            <resolved>Thu, 17 Jan 2013 10:43:12 +0000</resolved>
                                                    <fixVersion>0.6.2</fixVersion>
                    <fixVersion>0.7.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13952813" author="joshrosen" created="Sun, 28 Oct 2012 22:59:40 +0000"  >&lt;p&gt;There might be similar problems if arrays are used as &lt;tt&gt;Map&lt;/tt&gt; keys or are stored in a &lt;tt&gt;Set&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="13952255" author="matei" created="Mon, 29 Oct 2012 14:14:11 +0000"  >&lt;p&gt;This is a good catch, but it seems tough to do the right thing automatically in HashPartitioner, as you said. I think one interim fix is to add an ArrayPartitioner (or even ByteArrayPartitioner) and ask people to use that when their keys are byte arrays. I guess this is what you did in PySpark? We might be able to warn people of this condition in the PairRDDFunctions constructor, where we have a ClassManifest for the key K.&lt;/p&gt;

&lt;p&gt;Another option would be to choose the partitioner automatically based on the type of K, but let&apos;s try the other approach first and see whether there are any implications.&lt;/p&gt;</comment>
                            <comment id="13952787" author="joshrosen" created="Mon, 29 Oct 2012 15:58:18 +0000"  >&lt;p&gt;If we add ArrayPartitioner or ByteArrayPartitioner, then it might be useful to perform type checking to prevent mistakes like using a &lt;tt&gt;ByteArrayPartitioner&lt;/tt&gt; on an RDD with integer keys.  We might do this by adding a type parameter &lt;tt&gt;K&lt;/tt&gt; to &lt;tt&gt;Partitioner&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;The &lt;tt&gt;partitioner&lt;/tt&gt; field is defined for all RDDs, not just key-value RDDs, so its type would have to be &lt;tt&gt;Partitioner&lt;span class=&quot;error&quot;&gt;&amp;#91;Any&amp;#93;&lt;/span&gt;&lt;/tt&gt;.  However, &lt;tt&gt;partitioner&lt;/tt&gt; is a &lt;tt&gt;val&lt;/tt&gt;, so it only matters that a partitioner of the right type is passed in the RDD&apos;s constructor.&lt;/p&gt;

&lt;p&gt;I would declare &lt;tt&gt;Partitioner&lt;span class=&quot;error&quot;&gt;&amp;#91;-K&amp;#93;&lt;/span&gt;&lt;/tt&gt; to be contravariant in the key type, so that a &lt;tt&gt;Partitioner&lt;span class=&quot;error&quot;&gt;&amp;#91;Any&amp;#93;&lt;/span&gt;&lt;/tt&gt; can be used with an &lt;tt&gt;RDD[Array&lt;span class=&quot;error&quot;&gt;&amp;#91;Byte&amp;#93;&lt;/span&gt;]&lt;/tt&gt; but a &lt;tt&gt;Partitioner[Array&lt;span class=&quot;error&quot;&gt;&amp;#91;Byte&amp;#93;&lt;/span&gt;]&lt;/tt&gt; cannot be used with an &lt;tt&gt;RDD&lt;span class=&quot;error&quot;&gt;&amp;#91;Int&amp;#93;&lt;/span&gt;&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;If we take this approach, then we might want to split this into two commits: one that adds a warning when using &lt;tt&gt;HashPartitioner&lt;/tt&gt; with arrays of any kind, and another that changes &lt;tt&gt;Partition&lt;/tt&gt; and adds the type parameters.  This would retain backwards-compatibility for the existing releases, while allowing us to provide better type checking in future releases.&lt;/p&gt;

&lt;p&gt;Should I take a stab at this and submit a pull request?&lt;/p&gt;</comment>
                            <comment id="13952794" author="joshrosen" created="Mon, 29 Oct 2012 16:08:02 +0000"  >&lt;p&gt;Also, array keys will cause problems with map-side combiners, which use RDD keys as &lt;tt&gt;HashMap&lt;/tt&gt; keys.&lt;/p&gt;

&lt;p&gt;Is it worth supporting map-side combiners with array keys?  If not, an easy solution would be to fail with an error.  We could probably detect the error before the job ever runs.  This would require separate patches for the 0.5/0.6 and 0.7 branches, due to my shuffle refactoring changes in 0.7.&lt;/p&gt;</comment>
                            <comment id="13952834" author="joshrosen" created="Mon, 31 Dec 2012 20:35:31 +0000"  >&lt;p&gt;On reflection, it&apos;s probably a bad idea to use contravariant types in user-facing APIs because they could cause issues in the Java API.&lt;/p&gt;

&lt;p&gt;I submitted a pull request that causes Spark to throw exceptions in cases where we know that hashing arrays will produce incorrect results: &lt;a href=&quot;https://github.com/mesos/spark/pull/348&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/mesos/spark/pull/348&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13952842" author="matei" created="Thu, 17 Jan 2013 10:43:12 +0000"  >&lt;p&gt;Merged this into 0.6 as well.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12746703">SPARK-3847</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>383564</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 44 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1u2wv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>383832</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>