<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:44:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-15654] Reading gzipped files results in duplicate rows</title>
                <link>https://issues.apache.org/jira/browse/SPARK-15654</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;When gzipped files are larger then &lt;tt&gt;spark.sql.files.maxPartitionBytes&lt;/tt&gt; reading the file will result in duplicate rows in the dataframe.&lt;/p&gt;

&lt;p&gt;Given an example gzipped wordlist (of 740K bytes):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;$ gzcat words.gz |wc -l
235886
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Reading it using spark results in the following output:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&amp;gt;&amp;gt;&amp;gt; sqlContext.setConf(&lt;span class=&quot;code-quote&quot;&gt;&apos;spark.sql.files.maxPartitionBytes&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;1000&apos;&lt;/span&gt;)
&amp;gt;&amp;gt;&amp;gt; sqlContext.read.text(&lt;span class=&quot;code-quote&quot;&gt;&quot;/Users/jurriaanpruis/spark/words.gz&quot;&lt;/span&gt;).count()
81244093
&amp;gt;&amp;gt;&amp;gt; sqlContext.setConf(&lt;span class=&quot;code-quote&quot;&gt;&apos;spark.sql.files.maxPartitionBytes&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;10000&apos;&lt;/span&gt;)
&amp;gt;&amp;gt;&amp;gt; sqlContext.read.text(&lt;span class=&quot;code-quote&quot;&gt;&quot;/Users/jurriaanpruis/spark/words.gz&quot;&lt;/span&gt;).count()
8348566
&amp;gt;&amp;gt;&amp;gt; sqlContext.setConf(&lt;span class=&quot;code-quote&quot;&gt;&apos;spark.sql.files.maxPartitionBytes&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;100000&apos;&lt;/span&gt;)
&amp;gt;&amp;gt;&amp;gt; sqlContext.read.text(&lt;span class=&quot;code-quote&quot;&gt;&quot;/Users/jurriaanpruis/spark/words.gz&quot;&lt;/span&gt;).count()
1051469
&amp;gt;&amp;gt;&amp;gt; sqlContext.setConf(&lt;span class=&quot;code-quote&quot;&gt;&apos;spark.sql.files.maxPartitionBytes&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;1000000&apos;&lt;/span&gt;)
&amp;gt;&amp;gt;&amp;gt; sqlContext.read.text(&lt;span class=&quot;code-quote&quot;&gt;&quot;/Users/jurriaanpruis/spark/words.gz&quot;&lt;/span&gt;).count()
235886
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;You can clearly see how the number of rows scales with the number of partitions.&lt;br/&gt;
Somehow the data is duplicated when the number of partitions exceeds one (which as seen above approximately scales with the partition size). &lt;/p&gt;

&lt;p&gt;When using distinct you&apos;ll get the correct answer:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&amp;gt;&amp;gt;&amp;gt; sqlContext.setConf(&lt;span class=&quot;code-quote&quot;&gt;&apos;spark.sql.files.maxPartitionBytes&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;10000&apos;&lt;/span&gt;)
&amp;gt;&amp;gt;&amp;gt; sqlContext.read.text(&lt;span class=&quot;code-quote&quot;&gt;&quot;/Users/jurriaanpruis/spark/words.gz&quot;&lt;/span&gt;).distinct().count()
235886
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This looks like a pretty serious bug.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12973997">SPARK-15654</key>
            <summary>Reading gzipped files results in duplicate rows</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davies">Davies Liu</assignee>
                                    <reporter username="jurriaanpruis">Jurriaan Pruis</reporter>
                        <labels>
                    </labels>
                <created>Mon, 30 May 2016 14:44:47 +0000</created>
                <updated>Sat, 4 Mar 2017 10:02:22 +0000</updated>
                            <resolved>Fri, 10 Jun 2016 21:33:03 +0000</resolved>
                                    <version>2.0.0</version>
                                    <fixVersion>2.0.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>10</watches>
                                                                                                                <comments>
                            <comment id="15306731" author="jurriaanpruis" created="Mon, 30 May 2016 14:51:47 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davies&quot; class=&quot;user-hover&quot; rel=&quot;davies&quot;&gt;davies&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=marmbrus&quot; class=&quot;user-hover&quot; rel=&quot;marmbrus&quot;&gt;marmbrus&lt;/a&gt; I saw you guys worked on code regarding the &lt;tt&gt;FileSourceStrategy&lt;/tt&gt;. Maybe you know more about this issue/how to fix it?&lt;/p&gt;</comment>
                            <comment id="15306831" author="marmbrus" created="Mon, 30 May 2016 17:25:42 +0000"  >&lt;p&gt;Thanks for point this out!  Looks like we need to at least disable the splitting logic for gzip if we can find a better solution.  Any idea if other formats / codecs are affected?&lt;/p&gt;

&lt;p&gt;/Cc @yhuai&lt;/p&gt;</comment>
                            <comment id="15306866" author="jurriaanpruis" created="Mon, 30 May 2016 18:12:52 +0000"  >&lt;p&gt;Sorry, not sure about other formats. So this is due to gzipped files not being splittable?&lt;/p&gt;</comment>
                            <comment id="15307043" author="maropu" created="Tue, 31 May 2016 00:45:07 +0000"  >&lt;p&gt;Seems a root cause is that LineRecordReader cannot split files compressed by some codecs.&lt;br/&gt;
hadoop-v2.8+ throws an exception if these kinds of files are passed into LineRecordReader (&lt;a href=&quot;https://github.com/apache/hadoop/blame/trunk/hadoop-mapreduce-project/hadoop-mapreduce-client/hadoop-mapreduce-client-core/src/main/java/org/apache/hadoop/mapreduce/lib/input/LineRecordReader.java#L103&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/hadoop/blame/trunk/hadoop-mapreduce-project/hadoop-mapreduce-client/hadoop-mapreduce-client-core/src/main/java/org/apache/hadoop/mapreduce/lib/input/LineRecordReader.java#L103&lt;/a&gt;)&lt;br/&gt;
This is fixed in &lt;a href=&quot;https://issues.apache.org/jira/browse/MAPREDUCE-2094&quot; title=&quot;LineRecordReader should not seek into non-splittable, compressed streams.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;MAPREDUCE-2094&quot;&gt;&lt;del&gt;MAPREDUCE-2094&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;One solution is to set  Long.MaxValue at defaultMaxSplitBytes in FileSourceStrategy if unsplittable files detected there.&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/compare/master...maropu:SPARK-15654&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/compare/master...maropu:SPARK-15654&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15307425" author="jurriaanpruis" created="Tue, 31 May 2016 08:21:12 +0000"  >&lt;p&gt;You need to override maxSplitBytes, not defaultMaxSplitBytes, since maxSplitBytes is defined like this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;           val maxSplitBytes = &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.min(defaultMaxSplitBytes, &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.max(openCostInBytes, bytesPerCore))
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15307675" author="maropu" created="Tue, 31 May 2016 12:44:52 +0000"  >&lt;p&gt;Oh, my bad. Fixed.&lt;/p&gt;</comment>
                            <comment id="15310508" author="apachespark" created="Wed, 1 Jun 2016 15:46:04 +0000"  >&lt;p&gt;User &apos;maropu&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/13442&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/13442&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15317178" author="apachespark" created="Mon, 6 Jun 2016 20:34:04 +0000"  >&lt;p&gt;User &apos;davies&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/13531&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/13531&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15325322" author="davies" created="Fri, 10 Jun 2016 21:33:03 +0000"  >&lt;p&gt;Issue resolved by pull request 13531&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/13531&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/13531&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12954643">SPARK-14273</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 23 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2yp7j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12329449">2.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>