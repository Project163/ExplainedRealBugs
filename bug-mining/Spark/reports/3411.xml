<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:41:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-14886] RankingMetrics.ndcgAt  throw  java.lang.ArrayIndexOutOfBoundsException</title>
                <link>https://issues.apache.org/jira/browse/SPARK-14886</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; 
@Since(&lt;span class=&quot;code-quote&quot;&gt;&quot;1.2.0&quot;&lt;/span&gt;)
  def ndcgAt(k: Int): &lt;span class=&quot;code-object&quot;&gt;Double&lt;/span&gt; = {
    require(k &amp;gt; 0, &lt;span class=&quot;code-quote&quot;&gt;&quot;ranking position k should be positive&quot;&lt;/span&gt;)
    predictionAndLabels.map { &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; (pred, lab) =&amp;gt;
      val labSet = lab.toSet

      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (labSet.nonEmpty) {
        val labSetSize = labSet.size
        val n = math.min(math.max(pred.length, labSetSize), k)
        &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; maxDcg = 0.0
        &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; dcg = 0.0
        &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; i = 0
        &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (i &amp;lt; n) {
          val gain = 1.0 / math.log(i + 2)
          &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (labSet.contains(pred(i))) {
            dcg += gain
          }
          &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (i &amp;lt; labSetSize) {
            maxDcg += gain
          }
          i += 1
        }
        dcg / maxDcg
      } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
        logWarning(&lt;span class=&quot;code-quote&quot;&gt;&quot;Empty ground truth set, check input data&quot;&lt;/span&gt;)
        0.0
      }
    }.mean()
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&quot;if (labSet.contains(pred&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/information.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;))&quot; will throw ArrayIndexOutOfBoundsException when pred&apos;s size less then k.&lt;br/&gt;
That meas the true relevant documents has less size then the param k.&lt;br/&gt;
just try this with sample_movielens_data.txt&lt;br/&gt;
for example set pred.size to 5,labSetSize to 10,k to 20,then the n is 10. pred&lt;span class=&quot;error&quot;&gt;&amp;#91;10&amp;#93;&lt;/span&gt; not exists;&lt;br/&gt;
precisionAt is ok just because it has         &lt;br/&gt;
val n = math.min(pred.length, k)&lt;/p&gt;

</description>
                <environment></environment>
        <key id="12962129">SPARK-14886</key>
            <summary>RankingMetrics.ndcgAt  throw  java.lang.ArrayIndexOutOfBoundsException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="srowen">Sean R. Owen</assignee>
                                    <reporter username="licl">lichenglin</reporter>
                        <labels>
                    </labels>
                <created>Mon, 25 Apr 2016 03:05:34 +0000</created>
                <updated>Fri, 29 Apr 2016 07:24:39 +0000</updated>
                            <resolved>Fri, 29 Apr 2016 07:22:00 +0000</resolved>
                                    <version>1.6.1</version>
                                    <fixVersion>2.0.0</fixVersion>
                                    <component>MLlib</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15256010" author="srowen" created="Mon, 25 Apr 2016 07:29:52 +0000"  >&lt;p&gt;(Please format your code)&lt;/p&gt;</comment>
                            <comment id="15256016" author="srowen" created="Mon, 25 Apr 2016 07:34:11 +0000"  >&lt;p&gt;Yes I think &lt;tt&gt;if (labSet.contains(pred&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/information.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;)) {&lt;/tt&gt; needs to include the condition &lt;tt&gt;i &amp;lt; pred.length&lt;/tt&gt;. The case here is that the pred.length &amp;lt; labelSet.size &amp;lt;= k, in which case predictions are evaluated through to labelSet.size. But anything after the end of the predictions should be considered &quot;not in the label set&quot;. Go ahead and make a PR.&lt;/p&gt;</comment>
                            <comment id="15256065" author="mlnick" created="Mon, 25 Apr 2016 08:26:14 +0000"  >&lt;p&gt;Are you saying that the &quot;maxDCG&quot; should still be evaluated through the full label set (up to &quot;k&quot;, at least)?&lt;/p&gt;</comment>
                            <comment id="15256096" author="srowen" created="Mon, 25 Apr 2016 08:55:55 +0000"  >&lt;p&gt;No I don&apos;t think this concerns maxDCG in particular. It&apos;s evaluated through to the label set size (or k, if k is smaller of course). It does affect dcg, because the number of predictions may be less than the label set size. The rest of the predictions conceptually don&apos;t exist and do not match the label set, and so don&apos;t add to dcg.&lt;/p&gt;</comment>
                            <comment id="15262306" author="apachespark" created="Thu, 28 Apr 2016 15:13:04 +0000"  >&lt;p&gt;User &apos;srowen&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/12756&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/12756&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15263667" author="mlnick" created="Fri, 29 Apr 2016 07:22:00 +0000"  >&lt;p&gt;Issue resolved by pull request 12756&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/12756&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/12756&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 29 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2wo5r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>