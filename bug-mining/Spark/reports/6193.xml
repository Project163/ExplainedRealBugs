<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:03:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-26265] deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator</title>
                <link>https://issues.apache.org/jira/browse/SPARK-26265</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;The application is running on a cluster with 72000 cores and 182000G mem.&lt;/p&gt;

&lt;p&gt;Enviroment:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;spark.dynamicAllocation.minExecutors&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;5&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;spark.dynamicAllocation.initialExecutors&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;30&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;spark.dynamicAllocation.maxExecutors&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;400&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;spark.executor.cores&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;4&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;spark.executor.memory&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;20g&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&#160;&lt;/p&gt;

&lt;p&gt;Stage description:&lt;/p&gt;

&lt;p&gt;org.apache.spark.sql.hive.thriftserver.SparkSQLCLIDriver.processCmd(SparkSQLCLIDriver.scala:364) org.apache.hadoop.hive.cli.CliDriver.processLine(CliDriver.java:422) org.apache.hadoop.hive.cli.CliDriver.processLine(CliDriver.java:357) org.apache.spark.sql.hive.thriftserver.SparkSQLCLIDriver$.main(SparkSQLCLIDriver.scala:193) org.apache.spark.sql.hive.thriftserver.SparkSQLCLIDriver.main(SparkSQLCLIDriver.scala) sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) java.lang.reflect.Method.invoke(Method.java:498) org.apache.spark.deploy.JavaMainApplication.start(SparkApplication.scala:52) org.apache.spark.deploy.SparkSubmit$.org$apache$spark$deploy$SparkSubmit$$runMain(SparkSubmit.scala:894) org.apache.spark.deploy.SparkSubmit$.doRunMain$1(SparkSubmit.scala:198) org.apache.spark.deploy.SparkSubmit$.submit(SparkSubmit.scala:228) org.apache.spark.deploy.SparkSubmit$.main(SparkSubmit.scala:137) org.apache.spark.deploy.SparkSubmit.main(SparkSubmit.scala)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;jstack information as follow:&lt;/p&gt;

&lt;p&gt;Found one Java-level deadlock: ============================= &quot;Thread-ScriptTransformation-Feed&quot;: waiting to lock monitor 0x0000000000e0cb18 (object 0x00000002f1641538, a org.apache.spark.memory.TaskMemoryManager), which is held by &quot;Executor task launch worker for task 18899&quot; &quot;Executor task launch worker for task 18899&quot;: waiting to lock monitor 0x0000000000e09788 (object 0x0000000302faa3b0, a org.apache.spark.unsafe.map.BytesToBytesMap$MapIterator), which is held by &quot;Thread-ScriptTransformation-Feed&quot; Java stack information for the threads listed above: =================================================== &quot;Thread-ScriptTransformation-Feed&quot;: at org.apache.spark.memory.TaskMemoryManager.freePage(TaskMemoryManager.java:332) - waiting to lock &amp;lt;0x00000002f1641538&amp;gt; (a org.apache.spark.memory.TaskMemoryManager) at org.apache.spark.memory.MemoryConsumer.freePage(MemoryConsumer.java:130) at org.apache.spark.unsafe.map.BytesToBytesMap.access$300(BytesToBytesMap.java:66) at org.apache.spark.unsafe.map.BytesToBytesMap$MapIterator.advanceToNextPage(BytesToBytesMap.java:274) - locked &amp;lt;0x0000000302faa3b0&amp;gt; (a org.apache.spark.unsafe.map.BytesToBytesMap$MapIterator) at org.apache.spark.unsafe.map.BytesToBytesMap$MapIterator.next(BytesToBytesMap.java:313) at org.apache.spark.sql.execution.UnsafeFixedWidthAggregationMap$1.next(UnsafeFixedWidthAggregationMap.java:173) at org.apache.spark.sql.catalyst.expressions.GeneratedClass$GeneratedIteratorForCodegenStage2.processNext(Unknown Source) at org.apache.spark.sql.execution.BufferedRowIterator.hasNext(BufferedRowIterator.java:43) at org.apache.spark.sql.execution.WholeStageCodegenExec$$anonfun$10$$anon$1.hasNext(WholeStageCodegenExec.scala:614) at scala.collection.Iterator$$anon$11.hasNext(Iterator.scala:408) at scala.collection.Iterator$class.foreach(Iterator.scala:893) at scala.collection.AbstractIterator.foreach(Iterator.scala:1336) at org.apache.spark.sql.hive.execution.ScriptTransformationWriterThread$$anonfun$run$1.apply$mcV$sp(ScriptTransformationExec.scala:281) at org.apache.spark.sql.hive.execution.ScriptTransformationWriterThread$$anonfun$run$1.apply(ScriptTransformationExec.scala:270) at org.apache.spark.sql.hive.execution.ScriptTransformationWriterThread$$anonfun$run$1.apply(ScriptTransformationExec.scala:270) at org.apache.spark.util.Utils$.logUncaughtExceptions(Utils.scala:1995) at org.apache.spark.sql.hive.execution.ScriptTransformationWriterThread.run(ScriptTransformationExec.scala:270) &quot;Executor task launch worker for task 18899&quot;: at org.apache.spark.unsafe.map.BytesToBytesMap$MapIterator.spill(BytesToBytesMap.java:345) - waiting to lock &amp;lt;0x0000000302faa3b0&amp;gt; (a org.apache.spark.unsafe.map.BytesToBytesMap$MapIterator) at org.apache.spark.unsafe.map.BytesToBytesMap.spill(BytesToBytesMap.java:772) at org.apache.spark.memory.TaskMemoryManager.acquireExecutionMemory(TaskMemoryManager.java:180) - locked &amp;lt;0x00000002f1641538&amp;gt; (a org.apache.spark.memory.TaskMemoryManager) at org.apache.spark.memory.TaskMemoryManager.allocatePage(TaskMemoryManager.java:283) at org.apache.spark.memory.MemoryConsumer.allocatePage(MemoryConsumer.java:117) at org.apache.spark.shuffle.sort.ShuffleExternalSorter.acquireNewPageIfNecessary(ShuffleExternalSorter.java:371) at org.apache.spark.shuffle.sort.ShuffleExternalSorter.insertRecord(ShuffleExternalSorter.java:394) at org.apache.spark.shuffle.sort.UnsafeShuffleWriter.insertRecordIntoSorter(UnsafeShuffleWriter.java:267) at org.apache.spark.shuffle.sort.UnsafeShuffleWriter.write(UnsafeShuffleWriter.java:188) at org.apache.spark.scheduler.ShuffleMapTask.runTask(ShuffleMapTask.scala:96) at org.apache.spark.scheduler.ShuffleMapTask.runTask(ShuffleMapTask.scala:53) at org.apache.spark.scheduler.Task.run(Task.scala:109) at org.apache.spark.executor.Executor$TaskRunner.run(Executor.scala:345) at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) at java.lang.Thread.run(Thread.java:748) Found 1 deadlock.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13202243">SPARK-26265</key>
            <summary>deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="viirya">L. C. Hsieh</assignee>
                                    <reporter username="qianhan">qian han</reporter>
                        <labels>
                    </labels>
                <created>Tue, 4 Dec 2018 11:31:27 +0000</created>
                <updated>Mon, 12 Dec 2022 18:11:12 +0000</updated>
                            <resolved>Tue, 11 Dec 2018 13:13:59 +0000</resolved>
                                    <version>2.3.2</version>
                                    <fixVersion>2.4.1</fixVersion>
                    <fixVersion>3.0.0</fixVersion>
                                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16709556" author="gurwls223" created="Wed, 5 Dec 2018 02:58:12 +0000"  >&lt;p&gt;Please fill more information rather than just copying and pasting the error.&lt;/p&gt;</comment>
                            <comment id="16709809" author="gurwls223" created="Wed, 5 Dec 2018 09:20:57 +0000"  >&lt;p&gt;Mind if I ask:&lt;/p&gt;

&lt;p&gt;1. reproducers&lt;br/&gt;
2. What kind of codes did you run?&lt;br/&gt;
3. can you leave some analysis about the symptoms?&lt;/p&gt;

&lt;p&gt;Let&apos;s reopen when they are in the description.&lt;/p&gt;</comment>
                            <comment id="16711079" author="qianhan" created="Thu, 6 Dec 2018 07:43:56 +0000"  >&lt;ol&gt;
	&lt;li&gt;There are hundreds of thousand application running on our cluster per day. And this deadlock is happened only once. This cannot be reproduce easily.&lt;/li&gt;
	&lt;li&gt;I ran spark sql.&#160;INSERT OVERWRITE TABLE dm_abtest.rpt_live_tag_metric_daily PARTITION(date=&apos;20181129_bak&apos;) select vid, tag_name, tag_value, count&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; impr_user, avg(impr) impr_per_u, stddev_pop(impr) var_impr_per_u, avg(read) read_per_u, stddev_pop(read) var_read_per_u, avg(stay) stay_per_u, stddev_pop(stay) var_stay_per_u, sum(stay)/sum(read) stay_per_r, sum(read)/sum(impr) read_per_i, avg(finish) finish_per_u, stddev_pop(finish) var_finish_per_u from ( select vid, user_uid, user_uid_type, tag_name, tag_value, sum(impr) impr, sum(read) read, sum(stay) stay, sum(stay_count) stay_count, 0 finish from ( select transform(vid,user_uid,user_uid_type,tags,impr,read,stay,stay_count) USING &apos;python transform.py 111111&apos; AS (vids,user_uid,user_uid_type,tag_name,tag_value,impr,read,stay,stay_count) from ( SELECT vid, user_uid, user_uid_type, tags, count&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; impr, sum(all_read) read, sum(video_stay) stay, sum(if(video_stay&amp;gt;0, 1, 0)) stay_count FROM dm_abtest.stg_live_impression_stats_daily WHERE date=&apos;20181129&apos; and vid &amp;lt;&amp;gt; &apos;&apos; GROUP BY vid,user_uid,user_uid_type,tags ) t distribute by vids,user_uid,user_uid_type,tag_name,tag_value ) t lateral view explode(split(vids, &apos;,&apos;)) b as vid group by vid,user_uid,user_uid_type,tag_name,tag_value ) t group by vid,tag_name,tag_value&lt;/li&gt;
	&lt;li&gt;When deadlock happen, the executor hang and do nothing.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="16711500" author="gurwls223" created="Thu, 6 Dec 2018 14:19:15 +0000"  >&lt;p&gt;Thanks, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=qianhan&quot; class=&quot;user-hover&quot; rel=&quot;qianhan&quot;&gt;qianhan&lt;/a&gt;, can you investigate and make a fix to Spark?&lt;/p&gt;</comment>
                            <comment id="16712905" author="qianhan" created="Fri, 7 Dec 2018 14:12:13 +0000"  >&lt;p&gt;Okay&lt;/p&gt;</comment>
                            <comment id="16714419" author="apachespark" created="Mon, 10 Dec 2018 08:18:15 +0000"  >&lt;p&gt;User &apos;viirya&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/23272&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16714832" author="githubbot" created="Mon, 10 Dec 2018 14:54:48 +0000"  >&lt;p&gt;viirya commented on a change in pull request #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#discussion_r240187678&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#discussion_r240187678&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: core/src/test/java/org/apache/spark/unsafe/map/AbstractBytesToBytesMapSuite.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -667,4 +668,53 @@ public void testPeakMemoryUsed() {&lt;br/&gt;
     }&lt;br/&gt;
   }&lt;/p&gt;

&lt;p&gt;+  @Test&lt;br/&gt;
+  public void avoidDeadlock() throws InterruptedException {&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   I&apos;ve tried few ways to set a timeout logic, but don&apos;t work. The deadlock always hangs the test and timeout logic.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16714834" author="githubbot" created="Mon, 10 Dec 2018 14:56:19 +0000"  >&lt;p&gt;viirya commented on a change in pull request #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#discussion_r240187678&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#discussion_r240187678&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: core/src/test/java/org/apache/spark/unsafe/map/AbstractBytesToBytesMapSuite.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -667,4 +668,53 @@ public void testPeakMemoryUsed() {&lt;br/&gt;
     }&lt;br/&gt;
   }&lt;/p&gt;

&lt;p&gt;+  @Test&lt;br/&gt;
+  public void avoidDeadlock() throws InterruptedException {&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   I&apos;ve tried several ways to set a timeout logic, but don&apos;t work. The deadlock always hangs the test and timeout logic.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16714836" author="githubbot" created="Mon, 10 Dec 2018 14:56:59 +0000"  >&lt;p&gt;viirya commented on a change in pull request #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#discussion_r240204508&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#discussion_r240204508&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: core/src/test/java/org/apache/spark/unsafe/map/AbstractBytesToBytesMapSuite.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -667,4 +669,54 @@ public void testPeakMemoryUsed() {&lt;br/&gt;
     }&lt;br/&gt;
   }&lt;/p&gt;

&lt;p&gt;+  @Test&lt;br/&gt;
+  public void avoidDeadlock() throws InterruptedException {&lt;br/&gt;
+    memoryManager.limit(PAGE_SIZE_BYTES);&lt;br/&gt;
+    MemoryMode mode = useOffHeapMemoryAllocator() ? MemoryMode.OFF_HEAP: MemoryMode.ON_HEAP;&lt;br/&gt;
+    TestMemoryConsumer c1 = new TestMemoryConsumer(taskMemoryManager, mode);&lt;br/&gt;
+    BytesToBytesMap map =&lt;br/&gt;
+      new BytesToBytesMap(taskMemoryManager, blockManager, serializerManager, 1, 0.5, 1024);&lt;br/&gt;
+&lt;br/&gt;
+    Runnable memoryConsumer = new Runnable() {&lt;br/&gt;
+      @Override&lt;br/&gt;
+      public void run() {&lt;br/&gt;
+        int i = 0;&lt;br/&gt;
+        long used = 0;&lt;br/&gt;
+        while (i &amp;lt; 10) &lt;/p&gt;
{
+          c1.use(10000000);
+          used += 10000000;
+          i++;
+        }
&lt;p&gt;+        c1.free(used);&lt;br/&gt;
+      }&lt;br/&gt;
+    };&lt;br/&gt;
+&lt;br/&gt;
+    Thread thread = new Thread(memoryConsumer);&lt;br/&gt;
+&lt;br/&gt;
+    try {&lt;br/&gt;
+      int i;&lt;br/&gt;
+      for (i = 0; i &amp;lt; 1024; i++) {&lt;br/&gt;
+        final long[] arr = new long[]&lt;/p&gt;
{i}
&lt;p&gt;;&lt;br/&gt;
+        final BytesToBytesMap.Location loc = map.lookup(arr, Platform.LONG_ARRAY_OFFSET, 8);&lt;br/&gt;
+        loc.append(arr, Platform.LONG_ARRAY_OFFSET, 8, arr, Platform.LONG_ARRAY_OFFSET, 8);&lt;br/&gt;
+      }&lt;br/&gt;
+&lt;br/&gt;
+      // Starts to require memory at another memory consumer.&lt;br/&gt;
+      thread.start();&lt;br/&gt;
+&lt;br/&gt;
+      BytesToBytesMap.MapIterator iter = map.destructiveIterator();&lt;br/&gt;
+      for (i = 0; i &amp;lt; 1024; i++) &lt;/p&gt;
{
+        iter.next();
+      }
&lt;p&gt;+      assertFalse(iter.hasNext());&lt;br/&gt;
+    } finally {&lt;br/&gt;
+      map.free();&lt;br/&gt;
+      thread.join();&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   This line just makes sure `memoryConsumer` to end and free acquired memory.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16715215" author="githubbot" created="Mon, 10 Dec 2018 17:44:10 +0000"  >&lt;p&gt;SparkQA commented on issue #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#issuecomment-445905638&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#issuecomment-445905638&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   **&lt;a href=&quot;#99914 has finished&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Test build #99914 has finished&lt;/a&gt;(&lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/99914/testReport)**&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/99914/testReport)**&lt;/a&gt; for PR 23272 at commit &lt;span class=&quot;error&quot;&gt;&amp;#91;`4c621d2`&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://github.com/apache/spark/commit/4c621d2bd36c50a10591d93ccd77bd7c0432a873&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/commit/4c621d2bd36c50a10591d93ccd77bd7c0432a873&lt;/a&gt;).&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;This patch passes all tests.&lt;/li&gt;
	&lt;li&gt;This patch merges cleanly.&lt;/li&gt;
	&lt;li&gt;This patch adds no public classes.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16715217" author="githubbot" created="Mon, 10 Dec 2018 17:45:08 +0000"  >&lt;p&gt;SparkQA removed a comment on issue #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#issuecomment-445815520&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#issuecomment-445815520&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   **&lt;a href=&quot;#99914 has started&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Test build #99914 has started&lt;/a&gt;(&lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/99914/testReport)**&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/99914/testReport)**&lt;/a&gt; for PR 23272 at commit &lt;span class=&quot;error&quot;&gt;&amp;#91;`4c621d2`&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://github.com/apache/spark/commit/4c621d2bd36c50a10591d93ccd77bd7c0432a873&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/commit/4c621d2bd36c50a10591d93ccd77bd7c0432a873&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16715221" author="githubbot" created="Mon, 10 Dec 2018 17:46:42 +0000"  >&lt;p&gt;AmplabJenkins commented on issue #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#issuecomment-445906442&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#issuecomment-445906442&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Merged build finished. Test PASSed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16715222" author="githubbot" created="Mon, 10 Dec 2018 17:46:43 +0000"  >&lt;p&gt;AmplabJenkins commented on issue #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#issuecomment-445906449&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#issuecomment-445906449&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Test PASSed.&lt;br/&gt;
   Refer to this link for build results (access rights to CI server needed): &lt;br/&gt;
   &lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins//job/SparkPullRequestBuilder/99914/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins//job/SparkPullRequestBuilder/99914/&lt;/a&gt;&lt;br/&gt;
   Test PASSed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16715223" author="githubbot" created="Mon, 10 Dec 2018 17:47:08 +0000"  >&lt;p&gt;AmplabJenkins removed a comment on issue #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#issuecomment-445906442&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#issuecomment-445906442&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Merged build finished. Test PASSed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16715224" author="githubbot" created="Mon, 10 Dec 2018 17:47:08 +0000"  >&lt;p&gt;AmplabJenkins removed a comment on issue #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#issuecomment-445906449&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#issuecomment-445906449&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Test PASSed.&lt;br/&gt;
   Refer to this link for build results (access rights to CI server needed): &lt;br/&gt;
   &lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins//job/SparkPullRequestBuilder/99914/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins//job/SparkPullRequestBuilder/99914/&lt;/a&gt;&lt;br/&gt;
   Test PASSed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16715235" author="githubbot" created="Mon, 10 Dec 2018 17:54:31 +0000"  >&lt;p&gt;SparkQA commented on issue #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#issuecomment-445909073&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#issuecomment-445909073&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   **&lt;a href=&quot;#99915 has finished&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Test build #99915 has finished&lt;/a&gt;(&lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/99915/testReport)**&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/99915/testReport)**&lt;/a&gt; for PR 23272 at commit &lt;span class=&quot;error&quot;&gt;&amp;#91;`9d52320`&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://github.com/apache/spark/commit/9d52320e24077a8c94639aad6b21a4af5d3e83d9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/commit/9d52320e24077a8c94639aad6b21a4af5d3e83d9&lt;/a&gt;).&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;This patch passes all tests.&lt;/li&gt;
	&lt;li&gt;This patch merges cleanly.&lt;/li&gt;
	&lt;li&gt;This patch adds no public classes.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16715237" author="githubbot" created="Mon, 10 Dec 2018 17:55:11 +0000"  >&lt;p&gt;SparkQA removed a comment on issue #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#issuecomment-445815525&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#issuecomment-445815525&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   **&lt;a href=&quot;#99915 has started&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Test build #99915 has started&lt;/a&gt;(&lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/99915/testReport)**&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/99915/testReport)**&lt;/a&gt; for PR 23272 at commit &lt;span class=&quot;error&quot;&gt;&amp;#91;`9d52320`&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://github.com/apache/spark/commit/9d52320e24077a8c94639aad6b21a4af5d3e83d9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/commit/9d52320e24077a8c94639aad6b21a4af5d3e83d9&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16715239" author="githubbot" created="Mon, 10 Dec 2018 17:56:43 +0000"  >&lt;p&gt;AmplabJenkins commented on issue #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#issuecomment-445909862&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#issuecomment-445909862&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Merged build finished. Test PASSed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16715240" author="githubbot" created="Mon, 10 Dec 2018 17:56:44 +0000"  >&lt;p&gt;AmplabJenkins commented on issue #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#issuecomment-445909870&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#issuecomment-445909870&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Test PASSed.&lt;br/&gt;
   Refer to this link for build results (access rights to CI server needed): &lt;br/&gt;
   &lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins//job/SparkPullRequestBuilder/99915/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins//job/SparkPullRequestBuilder/99915/&lt;/a&gt;&lt;br/&gt;
   Test PASSed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16715242" author="githubbot" created="Mon, 10 Dec 2018 17:57:08 +0000"  >&lt;p&gt;AmplabJenkins removed a comment on issue #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#issuecomment-445909862&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#issuecomment-445909862&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Merged build finished. Test PASSed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16715243" author="githubbot" created="Mon, 10 Dec 2018 17:57:09 +0000"  >&lt;p&gt;AmplabJenkins removed a comment on issue #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#issuecomment-445909870&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#issuecomment-445909870&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Test PASSed.&lt;br/&gt;
   Refer to this link for build results (access rights to CI server needed): &lt;br/&gt;
   &lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins//job/SparkPullRequestBuilder/99915/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins//job/SparkPullRequestBuilder/99915/&lt;/a&gt;&lt;br/&gt;
   Test PASSed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16715997" author="githubbot" created="Tue, 11 Dec 2018 02:22:26 +0000"  >&lt;p&gt;cloud-fan commented on a change in pull request #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#discussion_r240453178&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#discussion_r240453178&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: core/src/main/java/org/apache/spark/unsafe/map/BytesToBytesMap.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -283,6 +290,9 @@ private void advanceToNextPage() {&lt;br/&gt;
           }&lt;br/&gt;
         }&lt;br/&gt;
       }&lt;br/&gt;
+      if (pageToFree != null) {&lt;br/&gt;
+        freePage(pageToFree);&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   is it possible that this page is already freed by another consumer?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16716074" author="githubbot" created="Tue, 11 Dec 2018 03:28:09 +0000"  >&lt;p&gt;viirya commented on issue #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#issuecomment-446059510&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#issuecomment-446059510&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   I think the page is used exclusively by the map and the iterator. So it&lt;br/&gt;
   could not be freed by other consumer.&lt;/p&gt;

&lt;p&gt;   On Tue, Dec 11, 2018, 10:23 Wenchen Fan &amp;lt;notifications@github.com wrote:&lt;/p&gt;

&lt;p&gt;   &amp;gt; &lt;b&gt;@cloud-fan&lt;/b&gt; commented on this pull request.&lt;br/&gt;
   &amp;gt; ------------------------------&lt;br/&gt;
   &amp;gt;&lt;br/&gt;
   &amp;gt; In core/src/main/java/org/apache/spark/unsafe/map/BytesToBytesMap.java&lt;br/&gt;
   &amp;gt; &amp;lt;&lt;a href=&quot;https://github.com/apache/spark/pull/23272#discussion_r240453178&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#discussion_r240453178&lt;/a&gt;&amp;gt;:&lt;br/&gt;
   &amp;gt;&lt;br/&gt;
   &amp;gt; &amp;gt; @@ -283,6 +290,9 @@ private void advanceToNextPage() &lt;/p&gt;
{
   &amp;gt;            }
&lt;p&gt;   &amp;gt;          }&lt;br/&gt;
   &amp;gt;        }&lt;br/&gt;
   &amp;gt; +      if (pageToFree != null) {&lt;br/&gt;
   &amp;gt; +        freePage(pageToFree);&lt;br/&gt;
   &amp;gt;&lt;br/&gt;
   &amp;gt; is it possible that this page is already freed by another consumer?&lt;br/&gt;
   &amp;gt;&lt;br/&gt;
   &amp;gt; &#8212;&lt;br/&gt;
   &amp;gt; You are receiving this because you were mentioned.&lt;br/&gt;
   &amp;gt; Reply to this email directly, view it on GitHub&lt;br/&gt;
   &amp;gt; &amp;lt;&lt;a href=&quot;https://github.com/apache/spark/pull/23272#pullrequestreview-183486914&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#pullrequestreview-183486914&lt;/a&gt;&amp;gt;,&lt;br/&gt;
   &amp;gt; or mute the thread&lt;br/&gt;
   &amp;gt; &amp;lt;&lt;a href=&quot;https://github.com/notifications/unsubscribe-auth/AAEM9-_lp7w_wK9mWUYjtPT1h9o5O0rzks5u3xcSgaJpZM4ZK2_Y&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/notifications/unsubscribe-auth/AAEM9-_lp7w_wK9mWUYjtPT1h9o5O0rzks5u3xcSgaJpZM4ZK2_Y&lt;/a&gt;&amp;gt;&lt;br/&gt;
   &amp;gt; .&lt;br/&gt;
   &amp;gt;&lt;/p&gt;


&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16716080" author="githubbot" created="Tue, 11 Dec 2018 03:33:30 +0000"  >&lt;p&gt;cloud-fan commented on a change in pull request #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#discussion_r240463496&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#discussion_r240463496&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: core/src/main/java/org/apache/spark/unsafe/map/BytesToBytesMap.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -283,6 +290,9 @@ private void advanceToNextPage() {&lt;br/&gt;
           }&lt;br/&gt;
         }&lt;br/&gt;
       }&lt;br/&gt;
+      if (pageToFree != null) {&lt;br/&gt;
+        freePage(pageToFree);&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   the `MapIterator.spill` will be called by `BytesToBytesMap.spill` which will be called by other consumers.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16716097" author="githubbot" created="Tue, 11 Dec 2018 03:43:46 +0000"  >&lt;p&gt;dongjoon-hyun commented on a change in pull request #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#discussion_r240464776&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#discussion_r240464776&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: core/src/test/java/org/apache/spark/unsafe/map/AbstractBytesToBytesMapSuite.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -667,4 +669,54 @@ public void testPeakMemoryUsed() {&lt;br/&gt;
     }&lt;br/&gt;
   }&lt;/p&gt;

&lt;p&gt;+  @Test&lt;br/&gt;
+  public void avoidDeadlock() throws InterruptedException {&lt;br/&gt;
+    memoryManager.limit(PAGE_SIZE_BYTES);&lt;br/&gt;
+    MemoryMode mode = useOffHeapMemoryAllocator() ? MemoryMode.OFF_HEAP: MemoryMode.ON_HEAP;&lt;br/&gt;
+    TestMemoryConsumer c1 = new TestMemoryConsumer(taskMemoryManager, mode);&lt;br/&gt;
+    BytesToBytesMap map =&lt;br/&gt;
+      new BytesToBytesMap(taskMemoryManager, blockManager, serializerManager, 1, 0.5, 1024);&lt;br/&gt;
+&lt;br/&gt;
+    Runnable memoryConsumer = new Runnable() {&lt;br/&gt;
+      @Override&lt;br/&gt;
+      public void run() {&lt;br/&gt;
+        int i = 0;&lt;br/&gt;
+        long used = 0;&lt;br/&gt;
+        while (i &amp;lt; 10) &lt;/p&gt;
{
+          c1.use(10000000);
+          used += 10000000;
+          i++;
+        }
&lt;p&gt;+        c1.free(used);&lt;br/&gt;
+      }&lt;br/&gt;
+    };&lt;br/&gt;
+&lt;br/&gt;
+    Thread thread = new Thread(memoryConsumer);&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   Shall we use a short form (10 lines) instead of line 680 ~ 694?&lt;br/&gt;
   ```java&lt;br/&gt;
       Thread thread = new Thread(() -&amp;gt; {&lt;br/&gt;
         int i = 0;&lt;br/&gt;
         long used = 0;&lt;br/&gt;
         while (i &amp;lt; 10) &lt;/p&gt;
{
           c1.use(10000000);
           used += 10000000;
           i++;
         }
&lt;p&gt;         c1.free(used);&lt;br/&gt;
       });&lt;br/&gt;
   ```&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16716111" author="githubbot" created="Tue, 11 Dec 2018 03:52:03 +0000"  >&lt;p&gt;dongjoon-hyun commented on a change in pull request #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#discussion_r240465896&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#discussion_r240465896&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: core/src/test/java/org/apache/spark/unsafe/map/AbstractBytesToBytesMapSuite.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -667,4 +669,54 @@ public void testPeakMemoryUsed() {&lt;br/&gt;
     }&lt;br/&gt;
   }&lt;/p&gt;

&lt;p&gt;+  @Test&lt;br/&gt;
+  public void avoidDeadlock() throws InterruptedException {&lt;br/&gt;
+    memoryManager.limit(PAGE_SIZE_BYTES);&lt;br/&gt;
+    MemoryMode mode = useOffHeapMemoryAllocator() ? MemoryMode.OFF_HEAP: MemoryMode.ON_HEAP;&lt;br/&gt;
+    TestMemoryConsumer c1 = new TestMemoryConsumer(taskMemoryManager, mode);&lt;br/&gt;
+    BytesToBytesMap map =&lt;br/&gt;
+      new BytesToBytesMap(taskMemoryManager, blockManager, serializerManager, 1, 0.5, 1024);&lt;br/&gt;
+&lt;br/&gt;
+    Runnable memoryConsumer = new Runnable() {&lt;br/&gt;
+      @Override&lt;br/&gt;
+      public void run() {&lt;br/&gt;
+        int i = 0;&lt;br/&gt;
+        long used = 0;&lt;br/&gt;
+        while (i &amp;lt; 10) &lt;/p&gt;
{
+          c1.use(10000000);
+          used += 10000000;
+          i++;
+        }
&lt;p&gt;+        c1.free(used);&lt;br/&gt;
+      }&lt;br/&gt;
+    };&lt;br/&gt;
+&lt;br/&gt;
+    Thread thread = new Thread(memoryConsumer);&lt;br/&gt;
+&lt;br/&gt;
+    try {&lt;br/&gt;
+      int i;&lt;br/&gt;
+      for (i = 0; i &amp;lt; 1024; i++) {&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   Let&apos;s use `for (int i = 0; ...` here and line 708 because `int i` is not referenced outside of `for` loop.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16716124" author="githubbot" created="Tue, 11 Dec 2018 04:04:33 +0000"  >&lt;p&gt;dongjoon-hyun commented on a change in pull request #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#discussion_r240465896&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#discussion_r240465896&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: core/src/test/java/org/apache/spark/unsafe/map/AbstractBytesToBytesMapSuite.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -667,4 +669,54 @@ public void testPeakMemoryUsed() {&lt;br/&gt;
     }&lt;br/&gt;
   }&lt;/p&gt;

&lt;p&gt;+  @Test&lt;br/&gt;
+  public void avoidDeadlock() throws InterruptedException {&lt;br/&gt;
+    memoryManager.limit(PAGE_SIZE_BYTES);&lt;br/&gt;
+    MemoryMode mode = useOffHeapMemoryAllocator() ? MemoryMode.OFF_HEAP: MemoryMode.ON_HEAP;&lt;br/&gt;
+    TestMemoryConsumer c1 = new TestMemoryConsumer(taskMemoryManager, mode);&lt;br/&gt;
+    BytesToBytesMap map =&lt;br/&gt;
+      new BytesToBytesMap(taskMemoryManager, blockManager, serializerManager, 1, 0.5, 1024);&lt;br/&gt;
+&lt;br/&gt;
+    Runnable memoryConsumer = new Runnable() {&lt;br/&gt;
+      @Override&lt;br/&gt;
+      public void run() {&lt;br/&gt;
+        int i = 0;&lt;br/&gt;
+        long used = 0;&lt;br/&gt;
+        while (i &amp;lt; 10) &lt;/p&gt;
{
+          c1.use(10000000);
+          used += 10000000;
+          i++;
+        }
&lt;p&gt;+        c1.free(used);&lt;br/&gt;
+      }&lt;br/&gt;
+    };&lt;br/&gt;
+&lt;br/&gt;
+    Thread thread = new Thread(memoryConsumer);&lt;br/&gt;
+&lt;br/&gt;
+    try {&lt;br/&gt;
+      int i;&lt;br/&gt;
+      for (i = 0; i &amp;lt; 1024; i++) {&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   &lt;sub&gt;Let&apos;s use `for (int i = 0; ...` here and line 708 because `int i` is not referenced outside of `for` loop.&lt;/sub&gt;&lt;br/&gt;
   Never mind. I found that this is the convention in this test suite.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16716139" author="githubbot" created="Tue, 11 Dec 2018 04:21:53 +0000"  >&lt;p&gt;viirya commented on issue #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#issuecomment-446067447&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#issuecomment-446067447&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Oh, you meant that the page is freed by other using this map or iterator.&lt;br/&gt;
   Is it a problem?&lt;/p&gt;

&lt;p&gt;   I think it should not be a case that more than one consumers free the same&lt;br/&gt;
   page at the same time.&lt;/p&gt;

&lt;p&gt;   On Tue, Dec 11, 2018, 11:34 Wenchen Fan &amp;lt;notifications@github.com wrote:&lt;/p&gt;

&lt;p&gt;   &amp;gt; &lt;b&gt;@cloud-fan&lt;/b&gt; commented on this pull request.&lt;br/&gt;
   &amp;gt; ------------------------------&lt;br/&gt;
   &amp;gt;&lt;br/&gt;
   &amp;gt; In core/src/main/java/org/apache/spark/unsafe/map/BytesToBytesMap.java&lt;br/&gt;
   &amp;gt; &amp;lt;&lt;a href=&quot;https://github.com/apache/spark/pull/23272#discussion_r240463496&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#discussion_r240463496&lt;/a&gt;&amp;gt;:&lt;br/&gt;
   &amp;gt;&lt;br/&gt;
   &amp;gt; &amp;gt; @@ -283,6 +290,9 @@ private void advanceToNextPage() &lt;/p&gt;
{
   &amp;gt;            }
&lt;p&gt;   &amp;gt;          }&lt;br/&gt;
   &amp;gt;        }&lt;br/&gt;
   &amp;gt; +      if (pageToFree != null) {&lt;br/&gt;
   &amp;gt; +        freePage(pageToFree);&lt;br/&gt;
   &amp;gt;&lt;br/&gt;
   &amp;gt; the MapIterator.spill will be called by BytesToBytesMap.spill which will&lt;br/&gt;
   &amp;gt; be called by other consumers.&lt;br/&gt;
   &amp;gt;&lt;br/&gt;
   &amp;gt; &#8212;&lt;br/&gt;
   &amp;gt; You are receiving this because you were mentioned.&lt;br/&gt;
   &amp;gt; Reply to this email directly, view it on GitHub&lt;br/&gt;
   &amp;gt; &amp;lt;&lt;a href=&quot;https://github.com/apache/spark/pull/23272#discussion_r240463496&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#discussion_r240463496&lt;/a&gt;&amp;gt;, or mute&lt;br/&gt;
   &amp;gt; the thread&lt;br/&gt;
   &amp;gt; &amp;lt;&lt;a href=&quot;https://github.com/notifications/unsubscribe-auth/AAEM91AsLKsA5zS0gXEhip3GuUcVjJ7-ks5u3yfAgaJpZM4ZK2_Y&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/notifications/unsubscribe-auth/AAEM91AsLKsA5zS0gXEhip3GuUcVjJ7-ks5u3yfAgaJpZM4ZK2_Y&lt;/a&gt;&amp;gt;&lt;br/&gt;
   &amp;gt; .&lt;br/&gt;
   &amp;gt;&lt;/p&gt;


&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16716148" author="githubbot" created="Tue, 11 Dec 2018 04:25:36 +0000"  >&lt;p&gt;viirya commented on issue #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#issuecomment-446067993&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#issuecomment-446067993&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   If you worry that the page is to be freed by the other consumer using the&lt;br/&gt;
   map iterator and also the map iterator itself, because I am not in front of&lt;br/&gt;
   laptop so I can&apos;t check it. But I guess freePage should already cover it.&lt;/p&gt;

&lt;p&gt;   On Tue, Dec 11, 2018, 11:34 Wenchen Fan &amp;lt;notifications@github.com wrote:&lt;/p&gt;

&lt;p&gt;   &amp;gt; &lt;b&gt;@cloud-fan&lt;/b&gt; commented on this pull request.&lt;br/&gt;
   &amp;gt; ------------------------------&lt;br/&gt;
   &amp;gt;&lt;br/&gt;
   &amp;gt; In core/src/main/java/org/apache/spark/unsafe/map/BytesToBytesMap.java&lt;br/&gt;
   &amp;gt; &amp;lt;&lt;a href=&quot;https://github.com/apache/spark/pull/23272#discussion_r240463496&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#discussion_r240463496&lt;/a&gt;&amp;gt;:&lt;br/&gt;
   &amp;gt;&lt;br/&gt;
   &amp;gt; &amp;gt; @@ -283,6 +290,9 @@ private void advanceToNextPage() &lt;/p&gt;
{
   &amp;gt;            }
&lt;p&gt;   &amp;gt;          }&lt;br/&gt;
   &amp;gt;        }&lt;br/&gt;
   &amp;gt; +      if (pageToFree != null) {&lt;br/&gt;
   &amp;gt; +        freePage(pageToFree);&lt;br/&gt;
   &amp;gt;&lt;br/&gt;
   &amp;gt; the MapIterator.spill will be called by BytesToBytesMap.spill which will&lt;br/&gt;
   &amp;gt; be called by other consumers.&lt;br/&gt;
   &amp;gt;&lt;br/&gt;
   &amp;gt; &#8212;&lt;br/&gt;
   &amp;gt; You are receiving this because you were mentioned.&lt;br/&gt;
   &amp;gt; Reply to this email directly, view it on GitHub&lt;br/&gt;
   &amp;gt; &amp;lt;&lt;a href=&quot;https://github.com/apache/spark/pull/23272#discussion_r240463496&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#discussion_r240463496&lt;/a&gt;&amp;gt;, or mute&lt;br/&gt;
   &amp;gt; the thread&lt;br/&gt;
   &amp;gt; &amp;lt;&lt;a href=&quot;https://github.com/notifications/unsubscribe-auth/AAEM91AsLKsA5zS0gXEhip3GuUcVjJ7-ks5u3yfAgaJpZM4ZK2_Y&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/notifications/unsubscribe-auth/AAEM91AsLKsA5zS0gXEhip3GuUcVjJ7-ks5u3yfAgaJpZM4ZK2_Y&lt;/a&gt;&amp;gt;&lt;br/&gt;
   &amp;gt; .&lt;br/&gt;
   &amp;gt;&lt;/p&gt;


&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16716429" author="githubbot" created="Tue, 11 Dec 2018 07:59:00 +0000"  >&lt;p&gt;viirya commented on a change in pull request #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#discussion_r240503360&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#discussion_r240503360&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: core/src/main/java/org/apache/spark/unsafe/map/BytesToBytesMap.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -283,6 +290,9 @@ private void advanceToNextPage() {&lt;br/&gt;
           }&lt;br/&gt;
         }&lt;br/&gt;
       }&lt;br/&gt;
+      if (pageToFree != null) {&lt;br/&gt;
+        freePage(pageToFree);&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   The page to free (`currentPage`) is removed from `dataPages` and advanced to next page when locking on the `MapIterator` object. The locking will prevent the same page to be freed by calling `spill` at another consumer.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16716469" author="githubbot" created="Tue, 11 Dec 2018 08:06:26 +0000"  >&lt;p&gt;SparkQA commented on issue #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#issuecomment-446108367&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#issuecomment-446108367&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   **&lt;a href=&quot;#99956 has started&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Test build #99956 has started&lt;/a&gt;(&lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/99956/testReport)**&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/99956/testReport)**&lt;/a&gt; for PR 23272 at commit &lt;span class=&quot;error&quot;&gt;&amp;#91;`0405527`&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://github.com/apache/spark/commit/04055278a02800c6d3ac67ddb2d9acc2c3baa18d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/commit/04055278a02800c6d3ac67ddb2d9acc2c3baa18d&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16716470" author="githubbot" created="Tue, 11 Dec 2018 08:06:28 +0000"  >&lt;p&gt;AmplabJenkins commented on issue #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#issuecomment-446108377&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#issuecomment-446108377&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Merged build finished. Test PASSed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16716471" author="githubbot" created="Tue, 11 Dec 2018 08:06:29 +0000"  >&lt;p&gt;AmplabJenkins commented on issue #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#issuecomment-446108381&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#issuecomment-446108381&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Test PASSed.&lt;br/&gt;
   Refer to this link for build results (access rights to CI server needed): &lt;br/&gt;
   &lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins//job/testing-k8s-prb-make-spark-distribution-unified/5959/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins//job/testing-k8s-prb-make-spark-distribution-unified/5959/&lt;/a&gt;&lt;br/&gt;
   Test PASSed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16716476" author="githubbot" created="Tue, 11 Dec 2018 08:07:08 +0000"  >&lt;p&gt;AmplabJenkins removed a comment on issue #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#issuecomment-446108377&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#issuecomment-446108377&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Merged build finished. Test PASSed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16716477" author="githubbot" created="Tue, 11 Dec 2018 08:07:08 +0000"  >&lt;p&gt;AmplabJenkins removed a comment on issue #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#issuecomment-446108381&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#issuecomment-446108381&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Test PASSed.&lt;br/&gt;
   Refer to this link for build results (access rights to CI server needed): &lt;br/&gt;
   &lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins//job/testing-k8s-prb-make-spark-distribution-unified/5959/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins//job/testing-k8s-prb-make-spark-distribution-unified/5959/&lt;/a&gt;&lt;br/&gt;
   Test PASSed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16716556" author="githubbot" created="Tue, 11 Dec 2018 08:34:08 +0000"  >&lt;p&gt;cloud-fan commented on a change in pull request #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#discussion_r240511960&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#discussion_r240511960&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: core/src/main/java/org/apache/spark/unsafe/map/BytesToBytesMap.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -283,6 +290,9 @@ private void advanceToNextPage() {&lt;br/&gt;
           }&lt;br/&gt;
         }&lt;br/&gt;
       }&lt;br/&gt;
+      if (pageToFree != null) {&lt;br/&gt;
+        freePage(pageToFree);&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   ah I misread the code. Can you move `synchronized` from `spill` method and put it in method definition?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16716763" author="githubbot" created="Tue, 11 Dec 2018 10:10:06 +0000"  >&lt;p&gt;viirya commented on a change in pull request #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#discussion_r240545803&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#discussion_r240545803&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: core/src/main/java/org/apache/spark/unsafe/map/BytesToBytesMap.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -283,6 +290,9 @@ private void advanceToNextPage() {&lt;br/&gt;
           }&lt;br/&gt;
         }&lt;br/&gt;
       }&lt;br/&gt;
+      if (pageToFree != null) {&lt;br/&gt;
+        freePage(pageToFree);&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   Moved.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16716769" author="githubbot" created="Tue, 11 Dec 2018 10:15:38 +0000"  >&lt;p&gt;SparkQA commented on issue #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#issuecomment-446147339&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#issuecomment-446147339&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   **&lt;a href=&quot;#99966 has started&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Test build #99966 has started&lt;/a&gt;(&lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/99966/testReport)**&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/99966/testReport)**&lt;/a&gt; for PR 23272 at commit &lt;span class=&quot;error&quot;&gt;&amp;#91;`0849083`&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://github.com/apache/spark/commit/08490838470d4f8e291d2d94ebadf32576a60205&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/commit/08490838470d4f8e291d2d94ebadf32576a60205&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16716770" author="githubbot" created="Tue, 11 Dec 2018 10:15:43 +0000"  >&lt;p&gt;AmplabJenkins commented on issue #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#issuecomment-446147362&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#issuecomment-446147362&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Merged build finished. Test PASSed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16716771" author="githubbot" created="Tue, 11 Dec 2018 10:15:44 +0000"  >&lt;p&gt;AmplabJenkins commented on issue #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#issuecomment-446147370&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#issuecomment-446147370&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Test PASSed.&lt;br/&gt;
   Refer to this link for build results (access rights to CI server needed): &lt;br/&gt;
   &lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins//job/testing-k8s-prb-make-spark-distribution-unified/5966/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins//job/testing-k8s-prb-make-spark-distribution-unified/5966/&lt;/a&gt;&lt;br/&gt;
   Test PASSed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16716772" author="githubbot" created="Tue, 11 Dec 2018 10:16:10 +0000"  >&lt;p&gt;AmplabJenkins removed a comment on issue #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#issuecomment-446147362&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#issuecomment-446147362&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Merged build finished. Test PASSed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16716773" author="githubbot" created="Tue, 11 Dec 2018 10:16:11 +0000"  >&lt;p&gt;AmplabJenkins removed a comment on issue #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#issuecomment-446147370&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#issuecomment-446147370&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Test PASSed.&lt;br/&gt;
   Refer to this link for build results (access rights to CI server needed): &lt;br/&gt;
   &lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins//job/testing-k8s-prb-make-spark-distribution-unified/5966/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins//job/testing-k8s-prb-make-spark-distribution-unified/5966/&lt;/a&gt;&lt;br/&gt;
   Test PASSed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16716813" author="githubbot" created="Tue, 11 Dec 2018 10:39:44 +0000"  >&lt;p&gt;cloud-fan commented on issue #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#issuecomment-446155283&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#issuecomment-446155283&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   LGTM. last question: does the test always reproduce the bug? Or it has some randomness?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717006" author="githubbot" created="Tue, 11 Dec 2018 12:24:27 +0000"  >&lt;p&gt;SparkQA commented on issue #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#issuecomment-446184428&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#issuecomment-446184428&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   **&lt;a href=&quot;#99956 has finished&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Test build #99956 has finished&lt;/a&gt;(&lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/99956/testReport)**&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/99956/testReport)**&lt;/a&gt; for PR 23272 at commit &lt;span class=&quot;error&quot;&gt;&amp;#91;`0405527`&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://github.com/apache/spark/commit/04055278a02800c6d3ac67ddb2d9acc2c3baa18d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/commit/04055278a02800c6d3ac67ddb2d9acc2c3baa18d&lt;/a&gt;).&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;This patch passes all tests.&lt;/li&gt;
	&lt;li&gt;This patch merges cleanly.&lt;/li&gt;
	&lt;li&gt;This patch adds no public classes.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717007" author="githubbot" created="Tue, 11 Dec 2018 12:25:10 +0000"  >&lt;p&gt;SparkQA removed a comment on issue #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#issuecomment-446108367&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#issuecomment-446108367&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   **&lt;a href=&quot;#99956 has started&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Test build #99956 has started&lt;/a&gt;(&lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/99956/testReport)**&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/99956/testReport)**&lt;/a&gt; for PR 23272 at commit &lt;span class=&quot;error&quot;&gt;&amp;#91;`0405527`&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://github.com/apache/spark/commit/04055278a02800c6d3ac67ddb2d9acc2c3baa18d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/commit/04055278a02800c6d3ac67ddb2d9acc2c3baa18d&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717009" author="githubbot" created="Tue, 11 Dec 2018 12:26:24 +0000"  >&lt;p&gt;AmplabJenkins commented on issue #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#issuecomment-446184932&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#issuecomment-446184932&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Merged build finished. Test PASSed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717010" author="githubbot" created="Tue, 11 Dec 2018 12:26:25 +0000"  >&lt;p&gt;AmplabJenkins commented on issue #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#issuecomment-446184937&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#issuecomment-446184937&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Test PASSed.&lt;br/&gt;
   Refer to this link for build results (access rights to CI server needed): &lt;br/&gt;
   &lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins//job/SparkPullRequestBuilder/99956/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins//job/SparkPullRequestBuilder/99956/&lt;/a&gt;&lt;br/&gt;
   Test PASSed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717013" author="githubbot" created="Tue, 11 Dec 2018 12:27:10 +0000"  >&lt;p&gt;AmplabJenkins removed a comment on issue #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#issuecomment-446184932&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#issuecomment-446184932&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Merged build finished. Test PASSed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717014" author="githubbot" created="Tue, 11 Dec 2018 12:27:11 +0000"  >&lt;p&gt;AmplabJenkins removed a comment on issue #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#issuecomment-446184937&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#issuecomment-446184937&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Test PASSed.&lt;br/&gt;
   Refer to this link for build results (access rights to CI server needed): &lt;br/&gt;
   &lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins//job/SparkPullRequestBuilder/99956/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins//job/SparkPullRequestBuilder/99956/&lt;/a&gt;&lt;br/&gt;
   Test PASSed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717055" author="githubbot" created="Tue, 11 Dec 2018 12:48:05 +0000"  >&lt;p&gt;viirya commented on issue #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#issuecomment-446190635&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#issuecomment-446190635&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   &amp;gt; last question: does the test always reproduce the bug? Or it has some randomness?&lt;/p&gt;

&lt;p&gt;   If without the change, as I tried it locally 10 times, the test can reproduce the bug 10 times. But I&apos;m not sure if it is 100% to reproduce the bug.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717060" author="githubbot" created="Tue, 11 Dec 2018 12:49:46 +0000"  >&lt;p&gt;viirya edited a comment on issue #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#issuecomment-446190635&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#issuecomment-446190635&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   &amp;gt; last question: does the test always reproduce the bug? Or it has some randomness?&lt;/p&gt;

&lt;p&gt;   If without the change, as I tried it locally 10 times, the test can reproduce the bug 10 times. But I&apos;m not sure if it is 100% to reproduce the bug. I think we can&apos;t always to reproduce a deadlock like this.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717081" author="githubbot" created="Tue, 11 Dec 2018 13:06:50 +0000"  >&lt;p&gt;cloud-fan commented on issue #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#issuecomment-446195615&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#issuecomment-446195615&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   thanks, merging to master!&lt;/p&gt;

&lt;p&gt;   Can you send a new PR for 2.4 without the `synchronized` move around?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717098" author="githubbot" created="Tue, 11 Dec 2018 13:11:26 +0000"  >&lt;p&gt;viirya commented on issue #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#issuecomment-446196909&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#issuecomment-446196909&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   &amp;gt; Can you send a new PR for 2.4 without the synchronized move around?&lt;/p&gt;

&lt;p&gt;   Ok.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717099" author="githubbot" created="Tue, 11 Dec 2018 13:11:38 +0000"  >&lt;p&gt;viirya edited a comment on issue #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#issuecomment-446196909&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#issuecomment-446196909&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   &amp;gt; Can you send a new PR for 2.4 without the synchronized move around?&lt;/p&gt;

&lt;p&gt;   Ok. Thanks.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717103" author="githubbot" created="Tue, 11 Dec 2018 13:13:27 +0000"  >&lt;p&gt;asfgit closed pull request #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/core/src/main/java/org/apache/spark/unsafe/map/BytesToBytesMap.java b/core/src/main/java/org/apache/spark/unsafe/map/BytesToBytesMap.java&lt;br/&gt;
index 405e529464152..fbba002f1f80f 100644&lt;br/&gt;
&amp;#8212; a/core/src/main/java/org/apache/spark/unsafe/map/BytesToBytesMap.java&lt;br/&gt;
+++ b/core/src/main/java/org/apache/spark/unsafe/map/BytesToBytesMap.java&lt;br/&gt;
@@ -255,11 +255,18 @@ private MapIterator(int numRecords, Location loc, boolean destructive) {&lt;br/&gt;
     }&lt;/p&gt;

&lt;p&gt;     private void advanceToNextPage() {&lt;br/&gt;
+      // &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;: We will first lock this `MapIterator` and then `TaskMemoryManager` when going&lt;br/&gt;
+      // to free a memory page by calling `freePage`. At the same time, it is possibly that another&lt;br/&gt;
+      // memory consumer first locks `TaskMemoryManager` and then this `MapIterator` when it&lt;br/&gt;
+      // acquires memory and causes spilling on this `MapIterator`. To avoid deadlock here, we keep&lt;br/&gt;
+      // reference to the page to free and free it after releasing the lock of `MapIterator`.&lt;br/&gt;
+      MemoryBlock pageToFree = null;&lt;br/&gt;
+&lt;br/&gt;
       synchronized (this) {&lt;br/&gt;
         int nextIdx = dataPages.indexOf(currentPage) + 1;&lt;br/&gt;
         if (destructive &amp;amp;&amp;amp; currentPage != null) &lt;/p&gt;
{
           dataPages.remove(currentPage);
-          freePage(currentPage);
+          pageToFree = currentPage;
           nextIdx --;
         }
&lt;p&gt;         if (dataPages.size() &amp;gt; nextIdx) {&lt;br/&gt;
@@ -283,6 +290,9 @@ private void advanceToNextPage() {&lt;br/&gt;
           }&lt;br/&gt;
         }&lt;br/&gt;
       }&lt;br/&gt;
+      if (pageToFree != null) &lt;/p&gt;
{
+        freePage(pageToFree);
+      }
&lt;p&gt;     }&lt;/p&gt;

&lt;p&gt;     @Override&lt;br/&gt;
@@ -329,52 +339,50 @@ public Location next() {&lt;br/&gt;
       }&lt;br/&gt;
     }&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public long spill(long numBytes) throws IOException {&lt;/li&gt;
	&lt;li&gt;synchronized (this) {&lt;/li&gt;
	&lt;li&gt;if (!destructive || dataPages.size() == 1) 
{
-          return 0L;
-        }
&lt;p&gt;+    public synchronized long spill(long numBytes) throws IOException {&lt;br/&gt;
+      if (!destructive || dataPages.size() == 1) &lt;/p&gt;
{
+        return 0L;
+      }&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;updatePeakMemoryUsed();&lt;br/&gt;
+      updatePeakMemoryUsed();&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// TODO: use existing ShuffleWriteMetrics&lt;/li&gt;
	&lt;li&gt;ShuffleWriteMetrics writeMetrics = new ShuffleWriteMetrics();&lt;br/&gt;
+      // TODO: use existing ShuffleWriteMetrics&lt;br/&gt;
+      ShuffleWriteMetrics writeMetrics = new ShuffleWriteMetrics();&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;long released = 0L;&lt;/li&gt;
	&lt;li&gt;while (dataPages.size() &amp;gt; 0) {&lt;/li&gt;
	&lt;li&gt;MemoryBlock block = dataPages.getLast();&lt;/li&gt;
	&lt;li&gt;// The currentPage is used, cannot be released&lt;/li&gt;
	&lt;li&gt;if (block == currentPage) 
{
-            break;
-          }&lt;br/&gt;
+      long released = 0L;&lt;br/&gt;
+      while (dataPages.size() &amp;gt; 0) {&lt;br/&gt;
+        MemoryBlock block = dataPages.getLast();&lt;br/&gt;
+        // The currentPage is used, cannot be released&lt;br/&gt;
+        if (block == currentPage) {
+          break;
+        }&lt;br/&gt;
 &lt;br/&gt;
-          Object base = block.getBaseObject();&lt;br/&gt;
-          long offset = block.getBaseOffset();&lt;br/&gt;
-          int numRecords = UnsafeAlignedOffset.getSize(base, offset);&lt;br/&gt;
-          int uaoSize = UnsafeAlignedOffset.getUaoSize();&lt;br/&gt;
-          offset += uaoSize;&lt;br/&gt;
-          final UnsafeSorterSpillWriter writer =&lt;br/&gt;
-            new UnsafeSorterSpillWriter(blockManager, 32 * 1024, writeMetrics, numRecords);&lt;br/&gt;
-          while (numRecords &amp;gt; 0) {
-            int length = UnsafeAlignedOffset.getSize(base, offset);
-            writer.write(base, offset + uaoSize, length, 0);
-            offset += uaoSize + length + 8;
-            numRecords--;
-          }&lt;br/&gt;
-          writer.close();&lt;br/&gt;
-          spillWriters.add(writer);&lt;br/&gt;
+        Object base = block.getBaseObject();&lt;br/&gt;
+        long offset = block.getBaseOffset();&lt;br/&gt;
+        int numRecords = UnsafeAlignedOffset.getSize(base, offset);&lt;br/&gt;
+        int uaoSize = UnsafeAlignedOffset.getUaoSize();&lt;br/&gt;
+        offset += uaoSize;&lt;br/&gt;
+        final UnsafeSorterSpillWriter writer =&lt;br/&gt;
+                new UnsafeSorterSpillWriter(blockManager, 32 * 1024, writeMetrics, numRecords);&lt;br/&gt;
+        while (numRecords &amp;gt; 0) {
+          int length = UnsafeAlignedOffset.getSize(base, offset);
+          writer.write(base, offset + uaoSize, length, 0);
+          offset += uaoSize + length + 8;
+          numRecords--;
+        }&lt;br/&gt;
+        writer.close();&lt;br/&gt;
+        spillWriters.add(writer);&lt;br/&gt;
 &lt;br/&gt;
-          dataPages.removeLast();&lt;br/&gt;
-          released += block.size();&lt;br/&gt;
-          freePage(block);&lt;br/&gt;
+        dataPages.removeLast();&lt;br/&gt;
+        released += block.size();&lt;br/&gt;
+        freePage(block);&lt;br/&gt;
 &lt;br/&gt;
-          if (released &amp;gt;= numBytes) {-            break;-          }
&lt;p&gt;+        if (released &amp;gt;= numBytes) &lt;/p&gt;
{
+          break;
         }
&lt;p&gt;-&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;return released;&lt;br/&gt;
       }&lt;br/&gt;
+&lt;br/&gt;
+      return released;&lt;br/&gt;
     }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     @Override&lt;br/&gt;
diff --git a/core/src/test/java/org/apache/spark/memory/TestMemoryConsumer.java b/core/src/test/java/org/apache/spark/memory/TestMemoryConsumer.java&lt;br/&gt;
index 0bbaea6b834b8..6aa577d1bf797 100644&lt;br/&gt;
&amp;#8212; a/core/src/test/java/org/apache/spark/memory/TestMemoryConsumer.java&lt;br/&gt;
+++ b/core/src/test/java/org/apache/spark/memory/TestMemoryConsumer.java&lt;br/&gt;
@@ -38,12 +38,12 @@ public long spill(long size, MemoryConsumer trigger) throws IOException &lt;/p&gt;
{
     return used;
   }

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;void use(long size) {&lt;br/&gt;
+  public void use(long size) 
{
     long got = taskMemoryManager.acquireExecutionMemory(size, this);
     used += got;
   }&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;void free(long size) {&lt;br/&gt;
+  public void free(long size) 
{
     used -= size;
     taskMemoryManager.releaseExecutionMemory(size, this);
   }
&lt;p&gt;diff --git a/core/src/test/java/org/apache/spark/unsafe/map/AbstractBytesToBytesMapSuite.java b/core/src/test/java/org/apache/spark/unsafe/map/AbstractBytesToBytesMapSuite.java&lt;br/&gt;
index aa29232e73e13..089dda7568a73 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/core/src/test/java/org/apache/spark/unsafe/map/AbstractBytesToBytesMapSuite.java&lt;br/&gt;
+++ b/core/src/test/java/org/apache/spark/unsafe/map/AbstractBytesToBytesMapSuite.java&lt;br/&gt;
@@ -33,6 +33,8 @@&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; import org.apache.spark.SparkConf;&lt;br/&gt;
 import org.apache.spark.executor.ShuffleWriteMetrics;&lt;br/&gt;
+import org.apache.spark.memory.MemoryMode;&lt;br/&gt;
+import org.apache.spark.memory.TestMemoryConsumer;&lt;br/&gt;
 import org.apache.spark.memory.TaskMemoryManager;&lt;br/&gt;
 import org.apache.spark.memory.TestMemoryManager;&lt;br/&gt;
 import org.apache.spark.network.util.JavaUtils;&lt;br/&gt;
@@ -667,4 +669,49 @@ public void testPeakMemoryUsed() {&lt;br/&gt;
     }&lt;br/&gt;
   }&lt;/p&gt;

&lt;p&gt;+  @Test&lt;br/&gt;
+  public void avoidDeadlock() throws InterruptedException {&lt;br/&gt;
+    memoryManager.limit(PAGE_SIZE_BYTES);&lt;br/&gt;
+    MemoryMode mode = useOffHeapMemoryAllocator() ? MemoryMode.OFF_HEAP: MemoryMode.ON_HEAP;&lt;br/&gt;
+    TestMemoryConsumer c1 = new TestMemoryConsumer(taskMemoryManager, mode);&lt;br/&gt;
+    BytesToBytesMap map =&lt;br/&gt;
+      new BytesToBytesMap(taskMemoryManager, blockManager, serializerManager, 1, 0.5, 1024);&lt;br/&gt;
+&lt;br/&gt;
+    Thread thread = new Thread(() -&amp;gt; {&lt;br/&gt;
+      int i = 0;&lt;br/&gt;
+      long used = 0;&lt;br/&gt;
+      while (i &amp;lt; 10) &lt;/p&gt;
{
+        c1.use(10000000);
+        used += 10000000;
+        i++;
+      }
&lt;p&gt;+      c1.free(used);&lt;br/&gt;
+    });&lt;br/&gt;
+&lt;br/&gt;
+    try {&lt;br/&gt;
+      int i;&lt;br/&gt;
+      for (i = 0; i &amp;lt; 1024; i++) {&lt;br/&gt;
+        final long[] arr = new long[]&lt;/p&gt;
{i}
&lt;p&gt;;&lt;br/&gt;
+        final BytesToBytesMap.Location loc = map.lookup(arr, Platform.LONG_ARRAY_OFFSET, 8);&lt;br/&gt;
+        loc.append(arr, Platform.LONG_ARRAY_OFFSET, 8, arr, Platform.LONG_ARRAY_OFFSET, 8);&lt;br/&gt;
+      }&lt;br/&gt;
+&lt;br/&gt;
+      // Starts to require memory at another memory consumer.&lt;br/&gt;
+      thread.start();&lt;br/&gt;
+&lt;br/&gt;
+      BytesToBytesMap.MapIterator iter = map.destructiveIterator();&lt;br/&gt;
+      for (i = 0; i &amp;lt; 1024; i++) &lt;/p&gt;
{
+        iter.next();
+      }
&lt;p&gt;+      assertFalse(iter.hasNext());&lt;br/&gt;
+    } finally {&lt;br/&gt;
+      map.free();&lt;br/&gt;
+      thread.join();&lt;br/&gt;
+      for (File spillFile : spillFilesCreated) &lt;/p&gt;
{
+        assertFalse(&quot;Spill file &quot; + spillFile.getPath() + &quot; was not cleaned up&quot;,
+          spillFile.exists());
+      }
&lt;p&gt;+    }&lt;br/&gt;
+  }&lt;br/&gt;
+&lt;br/&gt;
 }&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717198" author="githubbot" created="Tue, 11 Dec 2018 13:53:05 +0000"  >&lt;p&gt;SparkQA commented on issue #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#issuecomment-446209546&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#issuecomment-446209546&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   **&lt;a href=&quot;#99966 has finished&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Test build #99966 has finished&lt;/a&gt;(&lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/99966/testReport)**&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/99966/testReport)**&lt;/a&gt; for PR 23272 at commit &lt;span class=&quot;error&quot;&gt;&amp;#91;`0849083`&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://github.com/apache/spark/commit/08490838470d4f8e291d2d94ebadf32576a60205&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/commit/08490838470d4f8e291d2d94ebadf32576a60205&lt;/a&gt;).&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;This patch *&lt;b&gt;fails Spark unit tests&lt;/b&gt;*.&lt;/li&gt;
	&lt;li&gt;This patch merges cleanly.&lt;/li&gt;
	&lt;li&gt;This patch adds no public classes.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717199" author="githubbot" created="Tue, 11 Dec 2018 13:54:06 +0000"  >&lt;p&gt;AmplabJenkins commented on issue #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#issuecomment-446209885&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#issuecomment-446209885&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Merged build finished. Test FAILed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717200" author="githubbot" created="Tue, 11 Dec 2018 13:54:07 +0000"  >&lt;p&gt;AmplabJenkins commented on issue #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#issuecomment-446209891&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#issuecomment-446209891&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Test FAILed.&lt;br/&gt;
   Refer to this link for build results (access rights to CI server needed): &lt;br/&gt;
   &lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins//job/SparkPullRequestBuilder/99966/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins//job/SparkPullRequestBuilder/99966/&lt;/a&gt;&lt;br/&gt;
   Test FAILed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717201" author="githubbot" created="Tue, 11 Dec 2018 13:54:09 +0000"  >&lt;p&gt;SparkQA removed a comment on issue #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#issuecomment-446147339&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#issuecomment-446147339&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   **&lt;a href=&quot;#99966 has started&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Test build #99966 has started&lt;/a&gt;(&lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/99966/testReport)**&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/99966/testReport)**&lt;/a&gt; for PR 23272 at commit &lt;span class=&quot;error&quot;&gt;&amp;#91;`0849083`&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://github.com/apache/spark/commit/08490838470d4f8e291d2d94ebadf32576a60205&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/commit/08490838470d4f8e291d2d94ebadf32576a60205&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717202" author="githubbot" created="Tue, 11 Dec 2018 13:54:09 +0000"  >&lt;p&gt;AmplabJenkins removed a comment on issue #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#issuecomment-446209885&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#issuecomment-446209885&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Merged build finished. Test FAILed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717203" author="githubbot" created="Tue, 11 Dec 2018 13:55:11 +0000"  >&lt;p&gt;AmplabJenkins removed a comment on issue #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#issuecomment-446209891&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#issuecomment-446209891&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Test FAILed.&lt;br/&gt;
   Refer to this link for build results (access rights to CI server needed): &lt;br/&gt;
   &lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins//job/SparkPullRequestBuilder/99966/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins//job/SparkPullRequestBuilder/99966/&lt;/a&gt;&lt;br/&gt;
   Test FAILed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717221" author="githubbot" created="Tue, 11 Dec 2018 14:08:12 +0000"  >&lt;p&gt;viirya opened a new pull request #23289: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;BRANCH-2.4&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23289&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23289&lt;/a&gt;&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What changes were proposed in this pull request?&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   In `BytesToBytesMap.MapIterator.advanceToNextPage`, We will first lock this `MapIterator` and then `TaskMemoryManager` when going to free a memory page by calling `freePage`. At the same time, it is possibly that another memory consumer first locks `TaskMemoryManager` and then this `MapIterator` when it acquires memory and causes spilling on this `MapIterator`.&lt;/p&gt;

&lt;p&gt;   So it ends with the `MapIterator` object holds lock to the `MapIterator` object and waits for lock on `TaskMemoryManager`, and the other consumer holds lock to `TaskMemoryManager` and waits for lock on the `MapIterator` object.&lt;/p&gt;

&lt;p&gt;   To avoid deadlock here, this patch proposes to keep reference to the page to free and free it after releasing the lock of `MapIterator`.&lt;/p&gt;

&lt;p&gt;   This backports the fix to branch-2.4.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;How was this patch tested?&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    Added test and manually test by running the test 100 times to make sure there is no deadlock.&lt;/p&gt;


&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717222" author="githubbot" created="Tue, 11 Dec 2018 14:08:20 +0000"  >&lt;p&gt;viirya commented on issue #23289: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;BRANCH-2.4&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23289#issuecomment-446214510&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23289#issuecomment-446214510&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   cc @cloud-fan &lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717225" author="githubbot" created="Tue, 11 Dec 2018 14:09:48 +0000"  >&lt;p&gt;viirya commented on issue #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#issuecomment-446214942&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#issuecomment-446214942&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   I think the failed tests are unrelated. cc @cloud-fan &lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717227" author="githubbot" created="Tue, 11 Dec 2018 14:10:07 +0000"  >&lt;p&gt;SparkQA commented on issue #23289: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;BRANCH-2.4&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23289#issuecomment-446215048&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23289#issuecomment-446215048&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   **&lt;a href=&quot;#99978 has started&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Test build #99978 has started&lt;/a&gt;(&lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/99978/testReport)**&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/99978/testReport)**&lt;/a&gt; for PR 23289 at commit &lt;span class=&quot;error&quot;&gt;&amp;#91;`e408ea6`&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://github.com/apache/spark/commit/e408ea6dfe77f65f71038a196c5bfd371b970052&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/commit/e408ea6dfe77f65f71038a196c5bfd371b970052&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717231" author="githubbot" created="Tue, 11 Dec 2018 14:16:04 +0000"  >&lt;p&gt;AmplabJenkins commented on issue #23289: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;BRANCH-2.4&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23289#issuecomment-446216964&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23289#issuecomment-446216964&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Merged build finished. Test PASSed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717232" author="githubbot" created="Tue, 11 Dec 2018 14:16:06 +0000"  >&lt;p&gt;AmplabJenkins commented on issue #23289: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;BRANCH-2.4&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23289#issuecomment-446216975&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23289#issuecomment-446216975&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Test PASSed.&lt;br/&gt;
   Refer to this link for build results (access rights to CI server needed): &lt;br/&gt;
   &lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins//job/testing-k8s-prb-make-spark-distribution-unified/5977/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins//job/testing-k8s-prb-make-spark-distribution-unified/5977/&lt;/a&gt;&lt;br/&gt;
   Test PASSed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717236" author="githubbot" created="Tue, 11 Dec 2018 14:17:12 +0000"  >&lt;p&gt;AmplabJenkins removed a comment on issue #23289: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;BRANCH-2.4&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23289#issuecomment-446216964&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23289#issuecomment-446216964&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Merged build finished. Test PASSed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717257" author="githubbot" created="Tue, 11 Dec 2018 14:26:01 +0000"  >&lt;p&gt;SparkQA commented on issue #23289: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;BRANCH-2.4&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23289#issuecomment-446220331&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23289#issuecomment-446220331&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   **&lt;a href=&quot;#99978 has finished&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Test build #99978 has finished&lt;/a&gt;(&lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/99978/testReport)**&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/99978/testReport)**&lt;/a&gt; for PR 23289 at commit &lt;span class=&quot;error&quot;&gt;&amp;#91;`e408ea6`&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://github.com/apache/spark/commit/e408ea6dfe77f65f71038a196c5bfd371b970052&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/commit/e408ea6dfe77f65f71038a196c5bfd371b970052&lt;/a&gt;).&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;This patch *&lt;b&gt;fails Java style tests&lt;/b&gt;*.&lt;/li&gt;
	&lt;li&gt;This patch merges cleanly.&lt;/li&gt;
	&lt;li&gt;This patch adds no public classes.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717258" author="githubbot" created="Tue, 11 Dec 2018 14:26:08 +0000"  >&lt;p&gt;SparkQA removed a comment on issue #23289: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;BRANCH-2.4&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23289#issuecomment-446215048&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23289#issuecomment-446215048&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   **&lt;a href=&quot;#99978 has started&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Test build #99978 has started&lt;/a&gt;(&lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/99978/testReport)**&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/99978/testReport)**&lt;/a&gt; for PR 23289 at commit &lt;span class=&quot;error&quot;&gt;&amp;#91;`e408ea6`&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://github.com/apache/spark/commit/e408ea6dfe77f65f71038a196c5bfd371b970052&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/commit/e408ea6dfe77f65f71038a196c5bfd371b970052&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717259" author="githubbot" created="Tue, 11 Dec 2018 14:26:08 +0000"  >&lt;p&gt;AmplabJenkins commented on issue #23289: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;BRANCH-2.4&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23289#issuecomment-446220380&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23289#issuecomment-446220380&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Merged build finished. Test FAILed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717260" author="githubbot" created="Tue, 11 Dec 2018 14:26:10 +0000"  >&lt;p&gt;AmplabJenkins commented on issue #23289: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;BRANCH-2.4&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23289#issuecomment-446220388&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23289#issuecomment-446220388&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Test FAILed.&lt;br/&gt;
   Refer to this link for build results (access rights to CI server needed): &lt;br/&gt;
   &lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins//job/SparkPullRequestBuilder/99978/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins//job/SparkPullRequestBuilder/99978/&lt;/a&gt;&lt;br/&gt;
   Test FAILed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717263" author="githubbot" created="Tue, 11 Dec 2018 14:27:09 +0000"  >&lt;p&gt;AmplabJenkins removed a comment on issue #23289: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;BRANCH-2.4&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23289#issuecomment-446220380&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23289#issuecomment-446220380&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Merged build finished. Test FAILed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717267" author="githubbot" created="Tue, 11 Dec 2018 14:28:09 +0000"  >&lt;p&gt;AmplabJenkins removed a comment on issue #23289: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;BRANCH-2.4&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23289#issuecomment-446220388&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23289#issuecomment-446220388&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Test FAILed.&lt;br/&gt;
   Refer to this link for build results (access rights to CI server needed): &lt;br/&gt;
   &lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins//job/SparkPullRequestBuilder/99978/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins//job/SparkPullRequestBuilder/99978/&lt;/a&gt;&lt;br/&gt;
   Test FAILed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717283" author="githubbot" created="Tue, 11 Dec 2018 14:44:02 +0000"  >&lt;p&gt;AmplabJenkins commented on issue #23289: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;BRANCH-2.4&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23289#issuecomment-446226764&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23289#issuecomment-446226764&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Merged build finished. Test PASSed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717284" author="githubbot" created="Tue, 11 Dec 2018 14:44:02 +0000"  >&lt;p&gt;AmplabJenkins commented on issue #23289: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;BRANCH-2.4&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23289#issuecomment-446226774&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23289#issuecomment-446226774&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Test PASSed.&lt;br/&gt;
   Refer to this link for build results (access rights to CI server needed): &lt;br/&gt;
   &lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins//job/testing-k8s-prb-make-spark-distribution-unified/5979/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins//job/testing-k8s-prb-make-spark-distribution-unified/5979/&lt;/a&gt;&lt;br/&gt;
   Test PASSed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717286" author="githubbot" created="Tue, 11 Dec 2018 14:44:08 +0000"  >&lt;p&gt;AmplabJenkins removed a comment on issue #23289: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;BRANCH-2.4&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23289#issuecomment-446226764&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23289#issuecomment-446226764&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Merged build finished. Test PASSed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717287" author="githubbot" created="Tue, 11 Dec 2018 14:44:08 +0000"  >&lt;p&gt;AmplabJenkins removed a comment on issue #23289: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;BRANCH-2.4&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23289#issuecomment-446226774&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23289#issuecomment-446226774&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Test PASSed.&lt;br/&gt;
   Refer to this link for build results (access rights to CI server needed): &lt;br/&gt;
   &lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins//job/testing-k8s-prb-make-spark-distribution-unified/5979/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins//job/testing-k8s-prb-make-spark-distribution-unified/5979/&lt;/a&gt;&lt;br/&gt;
   Test PASSed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717288" author="githubbot" created="Tue, 11 Dec 2018 14:44:15 +0000"  >&lt;p&gt;SparkQA commented on issue #23289: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;BRANCH-2.4&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23289#issuecomment-446226854&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23289#issuecomment-446226854&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   **&lt;a href=&quot;#99980 has started&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Test build #99980 has started&lt;/a&gt;(&lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/99980/testReport)**&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/99980/testReport)**&lt;/a&gt; for PR 23289 at commit &lt;span class=&quot;error&quot;&gt;&amp;#91;`d520a97`&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://github.com/apache/spark/commit/d520a97a584bd4f17c8ff0f62d18794a214fa38f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/commit/d520a97a584bd4f17c8ff0f62d18794a214fa38f&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717711" author="githubbot" created="Tue, 11 Dec 2018 18:27:33 +0000"  >&lt;p&gt;kiszk commented on a change in pull request #23272: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23272#discussion_r240735509&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#discussion_r240735509&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: core/src/main/java/org/apache/spark/unsafe/map/BytesToBytesMap.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -283,6 +290,9 @@ private void advanceToNextPage() {&lt;br/&gt;
           }&lt;br/&gt;
         }&lt;br/&gt;
       }&lt;br/&gt;
+      if (pageToFree != null) {&lt;br/&gt;
+        freePage(pageToFree);&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   @viirya @cloud-fan Sorry for late comment. But, I have one question.&lt;/p&gt;

&lt;p&gt;   Before this PR, `freePage(currentPage)` is always called if `if (destructive &amp;amp;&amp;amp; currentPage != null)` is satisfied.  &lt;br/&gt;
   After this PR, `freePage(pageToFree)` may not be called if `if (dataPages.size() &amp;gt; nextIdx) &lt;/p&gt;
{ ...}
&lt;p&gt;` throw an exception. In that case, I am curious whether `pageToFree` is collected somewhere or not.&lt;/p&gt;


&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717817" author="githubbot" created="Tue, 11 Dec 2018 19:21:36 +0000"  >&lt;p&gt;SparkQA commented on issue #23289: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;BRANCH-2.4&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23289#issuecomment-446327823&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23289#issuecomment-446327823&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   **&lt;a href=&quot;#99980 has finished&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Test build #99980 has finished&lt;/a&gt;(&lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/99980/testReport)**&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/99980/testReport)**&lt;/a&gt; for PR 23289 at commit &lt;span class=&quot;error&quot;&gt;&amp;#91;`d520a97`&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://github.com/apache/spark/commit/d520a97a584bd4f17c8ff0f62d18794a214fa38f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/commit/d520a97a584bd4f17c8ff0f62d18794a214fa38f&lt;/a&gt;).&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;This patch passes all tests.&lt;/li&gt;
	&lt;li&gt;This patch merges cleanly.&lt;/li&gt;
	&lt;li&gt;This patch adds no public classes.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717820" author="githubbot" created="Tue, 11 Dec 2018 19:22:09 +0000"  >&lt;p&gt;SparkQA removed a comment on issue #23289: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;BRANCH-2.4&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23289#issuecomment-446226854&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23289#issuecomment-446226854&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   **&lt;a href=&quot;#99980 has started&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Test build #99980 has started&lt;/a&gt;(&lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/99980/testReport)**&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/99980/testReport)**&lt;/a&gt; for PR 23289 at commit &lt;span class=&quot;error&quot;&gt;&amp;#91;`d520a97`&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://github.com/apache/spark/commit/d520a97a584bd4f17c8ff0f62d18794a214fa38f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/commit/d520a97a584bd4f17c8ff0f62d18794a214fa38f&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717823" author="githubbot" created="Tue, 11 Dec 2018 19:22:53 +0000"  >&lt;p&gt;AmplabJenkins commented on issue #23289: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;BRANCH-2.4&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23289#issuecomment-446328319&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23289#issuecomment-446328319&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Merged build finished. Test PASSed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717824" author="githubbot" created="Tue, 11 Dec 2018 19:22:54 +0000"  >&lt;p&gt;AmplabJenkins commented on issue #23289: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;BRANCH-2.4&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23289#issuecomment-446328326&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23289#issuecomment-446328326&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Test PASSed.&lt;br/&gt;
   Refer to this link for build results (access rights to CI server needed): &lt;br/&gt;
   &lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins//job/SparkPullRequestBuilder/99980/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins//job/SparkPullRequestBuilder/99980/&lt;/a&gt;&lt;br/&gt;
   Test PASSed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717825" author="githubbot" created="Tue, 11 Dec 2018 19:23:14 +0000"  >&lt;p&gt;AmplabJenkins removed a comment on issue #23289: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;BRANCH-2.4&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23289#issuecomment-446328326&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23289#issuecomment-446328326&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Test PASSed.&lt;br/&gt;
   Refer to this link for build results (access rights to CI server needed): &lt;br/&gt;
   &lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins//job/SparkPullRequestBuilder/99980/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins//job/SparkPullRequestBuilder/99980/&lt;/a&gt;&lt;br/&gt;
   Test PASSed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717826" author="githubbot" created="Tue, 11 Dec 2018 19:23:15 +0000"  >&lt;p&gt;AmplabJenkins removed a comment on issue #23289: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;BRANCH-2.4&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23289#issuecomment-446328319&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23289#issuecomment-446328319&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Merged build finished. Test PASSed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717935" author="githubbot" created="Tue, 11 Dec 2018 20:22:10 +0000"  >&lt;p&gt;dongjoon-hyun commented on issue #23289: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;BRANCH-2.4&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23289#issuecomment-446348301&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23289#issuecomment-446348301&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Thanks. Merged to branch-2.4.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16718296" author="githubbot" created="Wed, 12 Dec 2018 00:46:07 +0000"  >&lt;p&gt;viirya commented on issue #23289: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;BRANCH-2.4&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23289#issuecomment-446418768&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23289#issuecomment-446418768&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Thanks @dongjoon-hyun @cloud-fan &lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16718297" author="githubbot" created="Wed, 12 Dec 2018 00:46:14 +0000"  >&lt;p&gt;viirya closed pull request #23289: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;BRANCH-2.4&amp;#93;&lt;/span&gt; Fix deadlock in BytesToBytesMap.MapIterator when locking both BytesToBytesMap.MapIterator and TaskMemoryManager&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23289&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23289&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/core/src/main/java/org/apache/spark/unsafe/map/BytesToBytesMap.java b/core/src/main/java/org/apache/spark/unsafe/map/BytesToBytesMap.java&lt;br/&gt;
index 9b6cbab38cbcc..64650336c9371 100644&lt;br/&gt;
&amp;#8212; a/core/src/main/java/org/apache/spark/unsafe/map/BytesToBytesMap.java&lt;br/&gt;
+++ b/core/src/main/java/org/apache/spark/unsafe/map/BytesToBytesMap.java&lt;br/&gt;
@@ -267,11 +267,18 @@ private MapIterator(int numRecords, Location loc, boolean destructive) {&lt;br/&gt;
     }&lt;/p&gt;

&lt;p&gt;     private void advanceToNextPage() {&lt;br/&gt;
+      // &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;: We will first lock this `MapIterator` and then `TaskMemoryManager` when going&lt;br/&gt;
+      // to free a memory page by calling `freePage`. At the same time, it is possibly that another&lt;br/&gt;
+      // memory consumer first locks `TaskMemoryManager` and then this `MapIterator` when it&lt;br/&gt;
+      // acquires memory and causes spilling on this `MapIterator`. To avoid deadlock here, we keep&lt;br/&gt;
+      // reference to the page to free and free it after releasing the lock of `MapIterator`.&lt;br/&gt;
+      MemoryBlock pageToFree = null;&lt;br/&gt;
+&lt;br/&gt;
       synchronized (this) {&lt;br/&gt;
         int nextIdx = dataPages.indexOf(currentPage) + 1;&lt;br/&gt;
         if (destructive &amp;amp;&amp;amp; currentPage != null) &lt;/p&gt;
{
           dataPages.remove(currentPage);
-          freePage(currentPage);
+          pageToFree = currentPage;
           nextIdx --;
         }
&lt;p&gt;         if (dataPages.size() &amp;gt; nextIdx) {&lt;br/&gt;
@@ -295,6 +302,9 @@ private void advanceToNextPage() {&lt;br/&gt;
           }&lt;br/&gt;
         }&lt;br/&gt;
       }&lt;br/&gt;
+      if (pageToFree != null) &lt;/p&gt;
{
+        freePage(pageToFree);
+      }
&lt;p&gt;     }&lt;/p&gt;

&lt;p&gt;     @Override&lt;br/&gt;
diff --git a/core/src/test/java/org/apache/spark/memory/TestMemoryConsumer.java b/core/src/test/java/org/apache/spark/memory/TestMemoryConsumer.java&lt;br/&gt;
index 0bbaea6b834b8..6aa577d1bf797 100644&lt;br/&gt;
&amp;#8212; a/core/src/test/java/org/apache/spark/memory/TestMemoryConsumer.java&lt;br/&gt;
+++ b/core/src/test/java/org/apache/spark/memory/TestMemoryConsumer.java&lt;br/&gt;
@@ -38,12 +38,12 @@ public long spill(long size, MemoryConsumer trigger) throws IOException &lt;/p&gt;
{
     return used;
   }

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;void use(long size) {&lt;br/&gt;
+  public void use(long size) 
{
     long got = taskMemoryManager.acquireExecutionMemory(size, this);
     used += got;
   }&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;void free(long size) {&lt;br/&gt;
+  public void free(long size) 
{
     used -= size;
     taskMemoryManager.releaseExecutionMemory(size, this);
   }
&lt;p&gt;diff --git a/core/src/test/java/org/apache/spark/unsafe/map/AbstractBytesToBytesMapSuite.java b/core/src/test/java/org/apache/spark/unsafe/map/AbstractBytesToBytesMapSuite.java&lt;br/&gt;
index 53a233f698c7a..278d28f7bf479 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/core/src/test/java/org/apache/spark/unsafe/map/AbstractBytesToBytesMapSuite.java&lt;br/&gt;
+++ b/core/src/test/java/org/apache/spark/unsafe/map/AbstractBytesToBytesMapSuite.java&lt;br/&gt;
@@ -33,6 +33,8 @@&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; import org.apache.spark.SparkConf;&lt;br/&gt;
 import org.apache.spark.executor.ShuffleWriteMetrics;&lt;br/&gt;
+import org.apache.spark.memory.MemoryMode;&lt;br/&gt;
+import org.apache.spark.memory.TestMemoryConsumer;&lt;br/&gt;
 import org.apache.spark.memory.TaskMemoryManager;&lt;br/&gt;
 import org.apache.spark.memory.TestMemoryManager;&lt;br/&gt;
 import org.apache.spark.network.util.JavaUtils;&lt;br/&gt;
@@ -667,4 +669,49 @@ public void testPeakMemoryUsed() {&lt;br/&gt;
     }&lt;br/&gt;
   }&lt;/p&gt;

&lt;p&gt;+  @Test&lt;br/&gt;
+  public void avoidDeadlock() throws InterruptedException {&lt;br/&gt;
+    memoryManager.limit(PAGE_SIZE_BYTES);&lt;br/&gt;
+    MemoryMode mode = useOffHeapMemoryAllocator() ? MemoryMode.OFF_HEAP: MemoryMode.ON_HEAP;&lt;br/&gt;
+    TestMemoryConsumer c1 = new TestMemoryConsumer(taskMemoryManager, mode);&lt;br/&gt;
+    BytesToBytesMap map =&lt;br/&gt;
+      new BytesToBytesMap(taskMemoryManager, blockManager, serializerManager, 1, 0.5, 1024, false);&lt;br/&gt;
+&lt;br/&gt;
+    Thread thread = new Thread(() -&amp;gt; {&lt;br/&gt;
+      int i = 0;&lt;br/&gt;
+      long used = 0;&lt;br/&gt;
+      while (i &amp;lt; 10) &lt;/p&gt;
{
+        c1.use(10000000);
+        used += 10000000;
+        i++;
+      }
&lt;p&gt;+      c1.free(used);&lt;br/&gt;
+    });&lt;br/&gt;
+&lt;br/&gt;
+    try {&lt;br/&gt;
+      int i;&lt;br/&gt;
+      for (i = 0; i &amp;lt; 1024; i++) {&lt;br/&gt;
+        final long[] arr = new long[]&lt;/p&gt;
{i}
&lt;p&gt;;&lt;br/&gt;
+        final BytesToBytesMap.Location loc = map.lookup(arr, Platform.LONG_ARRAY_OFFSET, 8);&lt;br/&gt;
+        loc.append(arr, Platform.LONG_ARRAY_OFFSET, 8, arr, Platform.LONG_ARRAY_OFFSET, 8);&lt;br/&gt;
+      }&lt;br/&gt;
+&lt;br/&gt;
+      // Starts to require memory at another memory consumer.&lt;br/&gt;
+      thread.start();&lt;br/&gt;
+&lt;br/&gt;
+      BytesToBytesMap.MapIterator iter = map.destructiveIterator();&lt;br/&gt;
+      for (i = 0; i &amp;lt; 1024; i++) &lt;/p&gt;
{
+        iter.next();
+      }
&lt;p&gt;+      assertFalse(iter.hasNext());&lt;br/&gt;
+    } finally {&lt;br/&gt;
+      map.free();&lt;br/&gt;
+      thread.join();&lt;br/&gt;
+      for (File spillFile : spillFilesCreated) &lt;/p&gt;
{
+        assertFalse(&quot;Spill file &quot; + spillFile.getPath() + &quot; was not cleaned up&quot;,
+          spillFile.exists());
+      }
&lt;p&gt;+    }&lt;br/&gt;
+  }&lt;br/&gt;
+&lt;br/&gt;
 }&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16718438" author="githubbot" created="Wed, 12 Dec 2018 04:06:33 +0000"  >&lt;p&gt;viirya opened a new pull request #23294: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Followup&amp;#93;&lt;/span&gt; Put freePage into a finally block&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23294&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23294&lt;/a&gt;&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What changes were proposed in this pull request?&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   Based on the &lt;span class=&quot;error&quot;&gt;&amp;#91;comment&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://github.com/apache/spark/pull/23272#discussion_r240735509&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23272#discussion_r240735509&lt;/a&gt;), it seems to be better to put `freePage` into a `finally` block. This patch as a follow-up to do so.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;How was this patch tested?&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   Existing tests.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16722025" author="githubbot" created="Sat, 15 Dec 2018 05:55:49 +0000"  >&lt;p&gt;asfgit closed pull request #23294: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26265&quot; title=&quot;deadlock between TaskMemoryManager and BytesToBytesMap$MapIterator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26265&quot;&gt;&lt;del&gt;SPARK-26265&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Core&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Followup&amp;#93;&lt;/span&gt; Put freePage into a finally block&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23294&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23294&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/core/src/main/java/org/apache/spark/unsafe/map/BytesToBytesMap.java b/core/src/main/java/org/apache/spark/unsafe/map/BytesToBytesMap.java&lt;br/&gt;
index fbba002f1f80f..7df8aafb2b674 100644&lt;br/&gt;
&amp;#8212; a/core/src/main/java/org/apache/spark/unsafe/map/BytesToBytesMap.java&lt;br/&gt;
+++ b/core/src/main/java/org/apache/spark/unsafe/map/BytesToBytesMap.java&lt;br/&gt;
@@ -262,36 +262,39 @@ private void advanceToNextPage() {&lt;br/&gt;
       // reference to the page to free and free it after releasing the lock of `MapIterator`.&lt;br/&gt;
       MemoryBlock pageToFree = null;&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;synchronized (this) {&lt;/li&gt;
	&lt;li&gt;int nextIdx = dataPages.indexOf(currentPage) + 1;&lt;/li&gt;
	&lt;li&gt;if (destructive &amp;amp;&amp;amp; currentPage != null) 
{
-          dataPages.remove(currentPage);
-          pageToFree = currentPage;
-          nextIdx --;
-        }&lt;/li&gt;
	&lt;li&gt;if (dataPages.size() &amp;gt; nextIdx) 
{
-          currentPage = dataPages.get(nextIdx);
-          pageBaseObject = currentPage.getBaseObject();
-          offsetInPage = currentPage.getBaseOffset();
-          recordsInPage = UnsafeAlignedOffset.getSize(pageBaseObject, offsetInPage);
-          offsetInPage += UnsafeAlignedOffset.getUaoSize();
-        }
&lt;p&gt; else {&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;currentPage = null;&lt;/li&gt;
	&lt;li&gt;if (reader != null) {&lt;/li&gt;
	&lt;li&gt;handleFailedDelete();&lt;br/&gt;
+      try {&lt;br/&gt;
+        synchronized (this) {&lt;br/&gt;
+          int nextIdx = dataPages.indexOf(currentPage) + 1;&lt;br/&gt;
+          if (destructive &amp;amp;&amp;amp; currentPage != null) 
{
+            dataPages.remove(currentPage);
+            pageToFree = currentPage;
+            nextIdx--;
           }&lt;/li&gt;
	&lt;li&gt;try 
{
-            Closeables.close(reader, /* swallowIOException = */ false);
-            reader = spillWriters.getFirst().getReader(serializerManager);
-            recordsInPage = -1;
-          }
&lt;p&gt; catch (IOException e) {&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;// Scala iterator does not handle exception&lt;/li&gt;
	&lt;li&gt;Platform.throwException(e);&lt;br/&gt;
+          if (dataPages.size() &amp;gt; nextIdx) 
{
+            currentPage = dataPages.get(nextIdx);
+            pageBaseObject = currentPage.getBaseObject();
+            offsetInPage = currentPage.getBaseOffset();
+            recordsInPage = UnsafeAlignedOffset.getSize(pageBaseObject, offsetInPage);
+            offsetInPage += UnsafeAlignedOffset.getUaoSize();
+          }
&lt;p&gt; else &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+            currentPage = null;+            if (reader != null) {
+              handleFailedDelete();
+            }+            try {
+              Closeables.close(reader, /* swallowIOException = */ false);
+              reader = spillWriters.getFirst().getReader(serializerManager);
+              recordsInPage = -1;
+            } catch (IOException e) {
+              // Scala iterator does not handle exception
+              Platform.throwException(e);
+            }           }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;         }&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;}&lt;/li&gt;
	&lt;li&gt;if (pageToFree != null) 
{
-        freePage(pageToFree);
+      }
&lt;p&gt; finally &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+        if (pageToFree != null) {
+          freePage(pageToFree);
+        }       }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;     }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;






&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 48 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|s015b4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>