<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:38:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-13652] TransportClient.sendRpcSync returns wrong results</title>
                <link>https://issues.apache.org/jira/browse/SPARK-13652</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;TransportClient is not thread safe and if it is called from multiple threads, the messages can&apos;t be encoded and decoded correctly. Below is my code,and it will print wrong message.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException, InterruptedException {

        TransportServer server = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TransportContext(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TransportConf(&lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;,
                &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MapConfigProvider(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashMap&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;())), &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RankHandler()).
                createServer(8081, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; LinkedList&amp;lt;TransportServerBootstrap&amp;gt;());

        TransportContext context = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TransportContext(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TransportConf(&lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;,
                &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MapConfigProvider(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashMap&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;())), &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; NoOpRpcHandler(), &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; TransportClientFactory clientFactory = context.createClientFactory();
        List&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;&amp;gt; ts = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;&amp;gt;();
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; 10; i++) {
            ts.add(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Runnable&lt;/span&gt;() {
                @Override
                &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void run() {
                    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; j = 0; j &amp;lt; 1000; j++) {
                        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                            ByteBuf buf = Unpooled.buffer(8);
                            buf.writeLong((&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;) j);
                            ByteBuffer byteBuffer = clientFactory.createClient(&lt;span class=&quot;code-quote&quot;&gt;&quot;localhost&quot;&lt;/span&gt;, 8081).
                                    sendRpcSync(buf.nioBuffer(), &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;.MAX_VALUE);

                            &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; response = byteBuffer.getLong();
                            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (response != j) {
                                &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.err.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;send:&quot;&lt;/span&gt; + j + &lt;span class=&quot;code-quote&quot;&gt;&quot;,response:&quot;&lt;/span&gt; + response);
                            }
                        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
                            e.printStackTrace();
                        }
                    }
                }
            }));
            ts.get(i).start();
        }
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; t : ts) {
            t.join();
        }
        server.close();

    }


&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;RankHandler &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; RpcHandler {

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Logger logger = LoggerFactory.getLogger(RankHandler.class);
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; StreamManager streamManager;

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; RankHandler() {
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.streamManager = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; OneForOneStreamManager();
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void receive(TransportClient client, ByteBuffer msg, RpcResponseCallback callback) {
        callback.onSuccess(msg);
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; StreamManager getStreamManager() {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; streamManager;
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;it will print as below&lt;br/&gt;
send:221,response:222&lt;br/&gt;
send:233,response:234&lt;br/&gt;
send:312,response:313&lt;br/&gt;
send:358,response:359&lt;br/&gt;
...&lt;/p&gt;</description>
                <environment></environment>
        <key id="12946589">SPARK-13652</key>
            <summary>TransportClient.sendRpcSync returns wrong results</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="zsxwing">Shixiong Zhu</assignee>
                                    <reporter username="huang_yuu">huangyu</reporter>
                        <labels>
                    </labels>
                <created>Thu, 3 Mar 2016 16:16:05 +0000</created>
                <updated>Fri, 4 Mar 2016 09:11:01 +0000</updated>
                            <resolved>Fri, 4 Mar 2016 06:55:18 +0000</resolved>
                                    <version>1.6.0</version>
                                    <fixVersion>1.6.2</fixVersion>
                    <fixVersion>2.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15178038" author="srowen" created="Thu, 3 Mar 2016 16:21:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=huang_yuu&quot; class=&quot;user-hover&quot; rel=&quot;huang_yuu&quot;&gt;huang_yuu&lt;/a&gt; please fix the title&lt;/p&gt;</comment>
                            <comment id="15178061" author="srowen" created="Thu, 3 Mar 2016 16:31:40 +0000"  >&lt;p&gt;I don&apos;t think it&apos;s supposed to work this way:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; * Construct an instance of TransportClient using {@link TransportClientFactory}. A single
 * TransportClient may be used &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; multiple streams, but any given stream must be restricted to a
 * single client, in order to avoid out-of-order responses.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15178100" author="huang_yuu" created="Thu, 3 Mar 2016 16:50:13 +0000"  >&lt;p&gt;Does it mean that for a TransportClient I can&apos;t send rpc messages in parallel. Then how can I use it in multiple threads,because i see the comment &quot;Concurrency: thread safe and can be called from multiple threads.&quot;? Can you give me a example? Thank you very much&lt;/p&gt;</comment>
                            <comment id="15178121" author="srowen" created="Thu, 3 Mar 2016 16:58:23 +0000"  >&lt;p&gt;I think you can send from multiple threads to multiple streams, but not to one stream from multiple threads.&lt;/p&gt;</comment>
                            <comment id="15178698" author="zsxwing" created="Thu, 3 Mar 2016 22:07:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=huang_yuu&quot; class=&quot;user-hover&quot; rel=&quot;huang_yuu&quot;&gt;huang_yuu&lt;/a&gt; Confirmed that there is a bug in sendRpcSync. Patch is on the way.&lt;/p&gt;</comment>
                            <comment id="15178712" author="apachespark" created="Thu, 3 Mar 2016 22:14:05 +0000"  >&lt;p&gt;User &apos;zsxwing&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/11499&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/11499&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15178715" author="zsxwing" created="Thu, 3 Mar 2016 22:18:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=huang_yuu&quot; class=&quot;user-hover&quot; rel=&quot;huang_yuu&quot;&gt;huang_yuu&lt;/a&gt; I tested my patch using your codes and it worked. Thanks for reporting it and nice reproducer.&lt;/p&gt;</comment>
                            <comment id="15178723" author="zsxwing" created="Thu, 3 Mar 2016 22:24:29 +0000"  >&lt;p&gt;Updated &quot;Affects Version/s&quot;. This bug only exists in 1.6.0 and master&lt;/p&gt;</comment>
                            <comment id="15179157" author="huang_yuu" created="Fri, 4 Mar 2016 02:03:49 +0000"  >&lt;p&gt;I think the doc is about fetching stream rather than sendRpc&lt;/p&gt;</comment>
                            <comment id="15179186" author="huang_yuu" created="Fri, 4 Mar 2016 02:38:52 +0000"  >&lt;p&gt;I used your patch and it worked, great!!&lt;/p&gt;</comment>
                            <comment id="15179588" author="huang_yuu" created="Fri, 4 Mar 2016 09:11:01 +0000"  >&lt;p&gt;This issue has been fixed by Shixiong Zhu&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12791198" name="RankHandler.java" size="929" author="huang_yuu" created="Thu, 3 Mar 2016 16:22:52 +0000"/>
                            <attachment id="12791199" name="Test.java" size="2339" author="huang_yuu" created="Thu, 3 Mar 2016 16:22:52 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 37 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2u3tj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>