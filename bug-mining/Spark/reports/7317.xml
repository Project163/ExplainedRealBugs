<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:18:04 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-32159] New udaf(Aggregator) has an integration bug with UnresolvedMapObjects serialization</title>
                <link>https://issues.apache.org/jira/browse/SPARK-32159</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;The new user defined aggregator feature (&lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-27296&quot; title=&quot;Efficient User Defined Aggregators &quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-27296&quot;&gt;&lt;del&gt;SPARK-27296&lt;/del&gt;&lt;/a&gt;) based on calling &apos;functions.udaf(aggregator)&apos; works fine when the aggregator input type is atomic, e.g. &apos;Aggregator&lt;span class=&quot;error&quot;&gt;&amp;#91;Double, _, _&amp;#93;&lt;/span&gt;&apos;, however if the input type is an array, like &apos;Aggregator[Array&lt;span class=&quot;error&quot;&gt;&amp;#91;Double&amp;#93;&lt;/span&gt;, _, _]&apos;,&#160; it is tripping over the following:&lt;/p&gt;

&lt;p&gt;/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;When constructing [&lt;span class=&quot;error&quot;&gt;&amp;#91;MapObjects&amp;#93;&lt;/span&gt;], the element type must be given, which may not be available&lt;/li&gt;
	&lt;li&gt;before analysis. This class acts like a placeholder for [&lt;span class=&quot;error&quot;&gt;&amp;#91;MapObjects&amp;#93;&lt;/span&gt;], and will be replaced by&lt;/li&gt;
	&lt;li&gt;[&lt;span class=&quot;error&quot;&gt;&amp;#91;MapObjects&amp;#93;&lt;/span&gt;] during analysis after the input data is resolved.&lt;/li&gt;
	&lt;li&gt;Note that, ideally we should not serialize and send unresolved expressions to executors, but&lt;/li&gt;
	&lt;li&gt;users may accidentally do this(e.g. mistakenly reference an encoder instance when implementing&lt;/li&gt;
	&lt;li&gt;Aggregator). Here we mark `function` as transient because it may reference scala Type, which is&lt;/li&gt;
	&lt;li&gt;not serializable. Then even users mistakenly reference unresolved expression and serialize it,&lt;/li&gt;
	&lt;li&gt;it&apos;s just a performance issue(more network traffic), and will not fail.&lt;br/&gt;
 */&lt;br/&gt;
 case class UnresolvedMapObjects(&lt;br/&gt;
 &lt;font color=&quot;#de350b&quot;&gt;@transient function: Expression =&amp;gt; Expression&lt;/font&gt;,&lt;br/&gt;
 child: Expression,&lt;br/&gt;
 customCollectionCls: Option[Class&lt;span class=&quot;error&quot;&gt;&amp;#91;_&amp;#93;&lt;/span&gt;] = None) extends UnaryExpression with Unevaluable {&lt;br/&gt;
 override lazy val resolved = false&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;override def dataType: DataType = customCollectionCls.map(ObjectType.apply).getOrElse&lt;/p&gt;

{ throw new UnsupportedOperationException(&quot;not resolved&quot;) }

&lt;p&gt;}&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;The &apos;@transient&apos; is causing the function to be unpacked as &apos;null&apos; over on the executors, and it is causing a null-pointer exception here, when it tries to do &apos;function(loopVar)&apos;&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;object MapObjects {&lt;br/&gt;
 def apply(&lt;br/&gt;
 function: Expression =&amp;gt; Expression,&lt;br/&gt;
 inputData: Expression,&lt;br/&gt;
 elementType: DataType,&lt;br/&gt;
 elementNullable: Boolean = true,&lt;br/&gt;
 customCollectionCls: Option[Class&lt;span class=&quot;error&quot;&gt;&amp;#91;_&amp;#93;&lt;/span&gt;] = None): MapObjects =&lt;/p&gt;

&lt;p&gt;{ val loopVar = LambdaVariable(&quot;MapObject&quot;, elementType, elementNullable) MapObjects(loopVar, &lt;font color=&quot;#de350b&quot;&gt;function(loopVar)&lt;/font&gt;, inputData, customCollectionCls) }&lt;/p&gt;

&lt;p&gt;}&lt;/p&gt;

&lt;p&gt;&lt;b&gt;I believe it may be possible to just use &apos;loopVar&apos; instead of &apos;function(loopVar)&apos;, whenever &apos;function&apos; is null, but need second opinion from catalyst developers on what a robust fix should be&lt;/b&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13314757">SPARK-32159</key>
            <summary>New udaf(Aggregator) has an integration bug with UnresolvedMapObjects serialization</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="eje">Erik Erlandson</assignee>
                                    <reporter username="eje">Erik Erlandson</reporter>
                        <labels>
                    </labels>
                <created>Thu, 2 Jul 2020 18:05:27 +0000</created>
                <updated>Thu, 9 Jul 2020 08:42:59 +0000</updated>
                            <resolved>Thu, 9 Jul 2020 08:42:59 +0000</resolved>
                                    <version>3.0.0</version>
                                    <fixVersion>3.0.1</fixVersion>
                    <fixVersion>3.1.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17150490" author="eje" created="Thu, 2 Jul 2020 18:11:01 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cloud_fan&quot; class=&quot;user-hover&quot; rel=&quot;cloud_fan&quot;&gt;cloud_fan&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17150590" author="apachespark" created="Thu, 2 Jul 2020 21:22:33 +0000"  >&lt;p&gt;User &apos;erikerlandson&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/28983&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/28983&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17150591" author="apachespark" created="Thu, 2 Jul 2020 21:23:13 +0000"  >&lt;p&gt;User &apos;erikerlandson&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/28983&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/28983&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17150593" author="dongjoon" created="Thu, 2 Jul 2020 21:33:41 +0000"  >&lt;p&gt;Hi, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=eje&quot; class=&quot;user-hover&quot; rel=&quot;eje&quot;&gt;eje&lt;/a&gt;. Shall we set `Target Version` to `3.0.1`?&lt;/p&gt;</comment>
                            <comment id="17154340" author="cloud_fan" created="Thu, 9 Jul 2020 08:42:59 +0000"  >&lt;p&gt;Issue resolved by pull request 28983&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/28983&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/28983&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 18 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0gewg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12347862">3.0.1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>