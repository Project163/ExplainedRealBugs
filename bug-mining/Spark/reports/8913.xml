<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:32:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-42539] User-provided JARs can override Spark&apos;s Hive metadata client JARs when using &quot;builtin&quot;</title>
                <link>https://issues.apache.org/jira/browse/SPARK-42539</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Recently we observed that on version 3.2.0 and Java 8, it is possible for user-provided Hive JARs to break the ability for Spark, via the Hive metadata client / &lt;tt&gt;IsolatedClientLoader&lt;/tt&gt;, to communicate with Hive Metastore, when using the default behavior of the &quot;builtin&quot; Hive version. After &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-35321&quot; title=&quot;Spark 3.x can&amp;#39;t talk to HMS 1.2.x and lower due to get_all_functions Thrift API missing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-35321&quot;&gt;&lt;del&gt;SPARK-35321&lt;/del&gt;&lt;/a&gt;, when Spark is compiled against Hive &amp;gt;= 2.3.9 and the &quot;builtin&quot; Hive client version is used, we will call the method &lt;tt&gt;Hive.getWithoutRegisterFns()&lt;/tt&gt; (from &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-21563&quot; title=&quot;Improve Table#getEmptyTable performance by disable registerAllFunctionsOnce&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-21563&quot;&gt;&lt;del&gt;HIVE-21563&lt;/del&gt;&lt;/a&gt;) instead of &lt;tt&gt;Hive.get()&lt;/tt&gt;. If the user has included, for example, &lt;tt&gt;hive-exec-2.3.8.jar&lt;/tt&gt; on their classpath, the client will break with a &lt;tt&gt;NoSuchMethodError&lt;/tt&gt;. This particular failure mode was resolved in 3.2.1 by &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-37446&quot; title=&quot;hive-2.3.9 related API use invoke method&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-37446&quot;&gt;&lt;del&gt;SPARK-37446&lt;/del&gt;&lt;/a&gt;, but while investigating, we found a general issue that it&apos;s possible for user JARs to override Spark&apos;s own JARs &amp;#8211; but only inside of the IsolatedClientLoader when using &quot;builtin&quot;. This happens because even when Spark is configured to use the &quot;builtin&quot; Hive classes, it still creates a separate URLClassLoader for the HiveClientImpl used for HMS communication. To get the set of JAR URLs to use for this classloader, Spark &lt;a href=&quot;https://github.com/apache/spark/blob/87e3d5625e76bb734b8dd753bfb25002822c8585/sql/hive/src/main/scala/org/apache/spark/sql/hive/HiveUtils.scala#L412-L438&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;collects all of the JARs used by the user classloader (and its parent, and that classloader&apos;s parent, and so on)&lt;/a&gt;. Thus the newly created classloader will have all of the same JARs as the user classloader, but the ordering has been reversed! User JARs get prioritized ahead of system JARs, because the classloader hierarchy is traversed from bottom-to-top. For example let&apos;s say we have user JARs &quot;foo.jar&quot; and &quot;hive-exec-2.3.8.jar&quot;. The user classloader will look like this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
MutableURLClassLoader
-- foo.jar
-- hive-exec-2.3.8.jar
-- parent: URLClassLoader
----- spark-core_2.12-3.2.0.jar
----- ...
----- hive-exec-2.3.9.jar
----- ...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This setup provides the expected behavior within the user classloader; it will first check the parent, so hive-exec-2.3.9.jar takes precedence, and the MutableURLClassLoader is only checked if the class doesn&apos;t exist in the parent. But when a JAR list is constructed for the IsolatedClientLoader, it traverses the URLs from MutableURLClassLoader first, then it&apos;s parent, so the final list looks like (in order):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
URLClassLoader [IsolatedClientLoader]
-- foo.jar
-- hive-exec-2.3.8.jar
-- spark-core_2.12-3.2.0.jar
-- ...
-- hive-exec-2.3.9.jar
-- ...
-- parent: boot classloader (JVM classes)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Now when a lookup happens, all of the JARs are within the same URLClassLoader, and the user JARs are in front of the Spark ones, so the user JARs get prioritized. This is the opposite of the expected behavior when using the default user/application classloader in Spark, which has parent-first behavior, prioritizing the Spark/system classes over the user classes. (Note that this behavior is correct when using the &lt;tt&gt;ChildFirstURLClassLoader&lt;/tt&gt;.)&lt;/p&gt;

&lt;p&gt;After &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-37446&quot; title=&quot;hive-2.3.9 related API use invoke method&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-37446&quot;&gt;&lt;del&gt;SPARK-37446&lt;/del&gt;&lt;/a&gt;, the NoSuchMethodError is no longer an issue, but this still breaks assumptions about how user JARs should be treated vs. system JARs, and presents the ability for the client to break in other ways. For example in &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-37446&quot; title=&quot;hive-2.3.9 related API use invoke method&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-37446&quot;&gt;&lt;del&gt;SPARK-37446&lt;/del&gt;&lt;/a&gt; it describes a scenario whereby Hive 2.3.8 JARs have been included; the changes in Hive 2.3.9 were needed to improve compatibility with older HMS, so if a user were to accidentally include these older JARs, it could break the ability of Spark to communicate with HMS 1.x&lt;/p&gt;

&lt;p&gt;I see two solutions to this:&lt;/p&gt;

&lt;p&gt;&lt;b&gt;(A) Remove the separate classloader entirely when using &quot;builtin&quot;&lt;/b&gt;&lt;br/&gt;
Starting from 3.0.0, due to &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26839&quot; title=&quot;Work around classloader changes in Java 9 for Hive isolation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26839&quot;&gt;&lt;del&gt;SPARK-26839&lt;/del&gt;&lt;/a&gt;, when using Java 9+, we don&apos;t even create a new classloader when using &quot;builtin&quot;. This makes sense, as &lt;a href=&quot;https://github.com/apache/spark/pull/24057#discussion_r265142878&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;called out in this comment&lt;/a&gt;, since the point of &quot;builtin&quot; is to use the existing JARs on the classpath anyway. This proposes simply extending the changes from &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26839&quot; title=&quot;Work around classloader changes in Java 9 for Hive isolation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26839&quot;&gt;&lt;del&gt;SPARK-26839&lt;/del&gt;&lt;/a&gt; to all Java versions, instead of restricting to Java 9+ only.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;(B) Reverse the ordering of parent/child JARs when constructing the URL list&lt;/b&gt;&lt;br/&gt;
The most targeted fix that can be made is to simply reverse the ordering on &lt;a href=&quot;https://github.com/apache/spark/blob/87e3d5625e76bb734b8dd753bfb25002822c8585/sql/hive/src/main/scala/org/apache/spark/sql/hive/HiveUtils.scala#L419&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this line in HiveUtils&lt;/a&gt;, which prioritizes child-classloader JARs over parent-classloader JARs, reversing the expected ordering. There is already special handling for &lt;tt&gt;ChildFirstURLClassLoader&lt;/tt&gt;, so all that needs to be done is to reverse this order.&lt;/p&gt;

&lt;p&gt;I prefer (A) because I think it is a clean solution in that it both simplifies the classloader setup, and reduces divergence / special handling for different Java versions. At the time &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26839&quot; title=&quot;Work around classloader changes in Java 9 for Hive isolation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26839&quot;&gt;&lt;del&gt;SPARK-26839&lt;/del&gt;&lt;/a&gt; went in (2019), Java 9+ support was newer and less well-tested. Now after a few years we can see that the approach in &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26839&quot; title=&quot;Work around classloader changes in Java 9 for Hive isolation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26839&quot;&gt;&lt;del&gt;SPARK-26839&lt;/del&gt;&lt;/a&gt; clearly works well, so I see no reason &lt;em&gt;not&lt;/em&gt; to extend this approach to other Java versions as well.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13525927">SPARK-42539</key>
            <summary>User-provided JARs can override Spark&apos;s Hive metadata client JARs when using &quot;builtin&quot;</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="xkrogen">Erik Krogen</assignee>
                                    <reporter username="xkrogen">Erik Krogen</reporter>
                        <labels>
                    </labels>
                <created>Thu, 23 Feb 2023 17:52:20 +0000</created>
                <updated>Wed, 19 Apr 2023 00:06:39 +0000</updated>
                            <resolved>Tue, 18 Apr 2023 23:59:10 +0000</resolved>
                                    <version>3.1.3</version>
                    <version>3.2.3</version>
                    <version>3.3.2</version>
                                    <fixVersion>3.5.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17692820" author="apachespark" created="Thu, 23 Feb 2023 18:13:21 +0000"  >&lt;p&gt;User &apos;xkrogen&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/40144&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/40144&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17694211" author="csun" created="Mon, 27 Feb 2023 22:58:16 +0000"  >&lt;p&gt;Issue resolved by pull request 40144&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/40144&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/40144&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17694297" author="gurwls223" created="Tue, 28 Feb 2023 04:06:11 +0000"  >&lt;p&gt;Reverted in &lt;a href=&quot;https://github.com/apache/spark/commit/5627ceeddb45f2796fb8ad08b9f1c8a163823b2b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/commit/5627ceeddb45f2796fb8ad08b9f1c8a163823b2b&lt;/a&gt; and &lt;a href=&quot;https://github.com/apache/spark/commit/26009d47c1f80897d65445fe48d8d5f2edcf848c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/commit/26009d47c1f80897d65445fe48d8d5f2edcf848c&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17694752" author="apachespark" created="Tue, 28 Feb 2023 21:48:42 +0000"  >&lt;p&gt;User &apos;xkrogen&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/40224&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/40224&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17694753" author="apachespark" created="Tue, 28 Feb 2023 21:49:36 +0000"  >&lt;p&gt;User &apos;xkrogen&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/40224&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/40224&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17713800" author="xkrogen" created="Tue, 18 Apr 2023 23:59:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=csun&quot; class=&quot;user-hover&quot; rel=&quot;csun&quot;&gt;csun&lt;/a&gt; it looks like this didn&apos;t get marked as closed / fix-version updated when the PR was merged. I believe this went only into 3.5.0; the original PR went into branch-3.4 but was reverted and the second PR didn&apos;t make it to branch-3.4. I&apos;ve marked the fix version as 3.5.0 but please correct me if I&apos;m wrong here:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&amp;gt; glog apache/branch-3.4 | grep SPARK-42539
* 26009d47c1f 2023-02-28 Revert &lt;span class=&quot;code-quote&quot;&gt;&quot;[SPARK-42539][SQL][HIVE] Eliminate separate classloader when using &lt;span class=&quot;code-quote&quot;&gt;&apos;builtin&apos;&lt;/span&gt; Hive version &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; metadata client&quot;&lt;/span&gt; [Hyukjin Kwon &amp;lt;gurwls223@apache.org&amp;gt;]
* 40a4019dfc5 2023-02-27 [SPARK-42539][SQL][HIVE] Eliminate separate classloader when using &lt;span class=&quot;code-quote&quot;&gt;&apos;builtin&apos;&lt;/span&gt; Hive version &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; metadata client [Erik Krogen &amp;lt;xkrogen@apache.org&amp;gt;]


&amp;gt; glog apache/master | grep SPARK-42539
* 2e34427d4f3 2023-03-01 [SPARK-42539][SQL][HIVE] Eliminate separate classloader when using &lt;span class=&quot;code-quote&quot;&gt;&apos;builtin&apos;&lt;/span&gt; Hive version &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; metadata client [Erik Krogen &amp;lt;xkrogen@apache.org&amp;gt;]
* 5627ceeddb4 2023-02-28 Revert &lt;span class=&quot;code-quote&quot;&gt;&quot;[SPARK-42539][SQL][HIVE] Eliminate separate classloader when using &lt;span class=&quot;code-quote&quot;&gt;&apos;builtin&apos;&lt;/span&gt; Hive version &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; metadata client&quot;&lt;/span&gt; [Hyukjin Kwon &amp;lt;gurwls223@apache.org&amp;gt;]
* 27ad5830f9a 2023-02-27 [SPARK-42539][SQL][HIVE] Eliminate separate classloader when using &lt;span class=&quot;code-quote&quot;&gt;&apos;builtin&apos;&lt;/span&gt; Hive version &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; metadata client [Erik Krogen &amp;lt;xkrogen@apache.org&amp;gt;] &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17713801" author="sunchao" created="Wed, 19 Apr 2023 00:06:30 +0000"  >&lt;p&gt;Oops my bad&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xkrogen&quot; class=&quot;user-hover&quot; rel=&quot;xkrogen&quot;&gt;xkrogen&lt;/a&gt;&#160;- you&apos;re right, this is not in Spark 3.5 release, sorry! I must have forgotten to mark it resolved when the second PR got merged.&#160;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 29 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1g534:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>