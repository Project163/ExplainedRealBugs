<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:02:50 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-25829] remove duplicated map keys with last wins policy</title>
                <link>https://issues.apache.org/jira/browse/SPARK-25829</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;In Spark SQL, we apply &quot;earlier entry wins&quot; semantic to duplicated map keys. e.g.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
scala&amp;gt; sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT map(1,2,1,3)[1]&quot;&lt;/span&gt;).show
+------------------+
|map(1, 2, 1, 3)[1]|
+------------------+
|                 2|
+------------------+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;However, this handling is not applied consistently.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13194021">SPARK-25829</key>
            <summary>remove duplicated map keys with last wins policy</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cloud_fan">Wenchen Fan</assignee>
                                    <reporter username="cloud_fan">Wenchen Fan</reporter>
                        <labels>
                    </labels>
                <created>Thu, 25 Oct 2018 00:48:05 +0000</created>
                <updated>Tue, 18 Feb 2020 02:11:41 +0000</updated>
                            <resolved>Wed, 28 Nov 2018 15:43:25 +0000</resolved>
                                    <version>2.4.0</version>
                                    <fixVersion>3.0.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                                                            <comments>
                            <comment id="16663103" author="cloud_fan" created="Thu, 25 Oct 2018 02:19:41 +0000"  >&lt;p&gt;After more thoughts, both the map lookup behavior and `Dataset.collect` behavior are visible to end-users. It&apos;s hard to say which one is the official semantic as there is no doc, and we have to do behavior change for one of them.&lt;/p&gt;

&lt;p&gt;If we want to stick with the &quot;earlier entry wins&quot; semantic, then we need to fix the 3 sub-tasks listed here.&lt;/p&gt;

&lt;p&gt;If we want to stick with the &quot;later entry wins&quot; semantic, then we need to fix the map lookup(GetMapValue) and other related functions like `map_filter`, or deduplicate map keys at all the places that may create map. And for 2.4 we should revert these function if they are newly added, like `map_filter`.&lt;/p&gt;

&lt;p&gt;Any ideas? cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rxin&quot; class=&quot;user-hover&quot; rel=&quot;rxin&quot;&gt;rxin&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=LI%2CXiao&quot; class=&quot;user-hover&quot; rel=&quot;LI,Xiao&quot;&gt;LI,Xiao&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dongjoon&quot; class=&quot;user-hover&quot; rel=&quot;dongjoon&quot;&gt;dongjoon&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=viirya&quot; class=&quot;user-hover&quot; rel=&quot;viirya&quot;&gt;viirya&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mgaido&quot; class=&quot;user-hover&quot; rel=&quot;mgaido&quot;&gt;mgaido&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16663118" author="cloud_fan" created="Thu, 25 Oct 2018 02:48:54 +0000"  >&lt;p&gt;More investigation on &quot;later entry wins&quot;.&lt;/p&gt;

&lt;p&gt;If we still allow duplicated keys in map physically, following functions need to be updated:&lt;br/&gt;
Explode, PosExplode, GetMapValue, MapKeys, MapValues, MapEntries, TransformKeys, TransformValues, MapZipWith&lt;/p&gt;

&lt;p&gt;If we want to forbid duplicated keys in map, following functions need to be updated:&lt;br/&gt;
CreateMap, MapFromArrays, MapFromEntries, StringToMap, MapConcat, TransformKeys, MapFilter, and also reading map from data sources.&lt;/p&gt;

&lt;p&gt;So &quot;later entry wins&quot; semantic is more ideal but needs more works.&lt;/p&gt;</comment>
                            <comment id="16663121" author="cloud_fan" created="Thu, 25 Oct 2018 02:51:42 +0000"  >&lt;p&gt;If we decide to follow &quot;later entry wins&quot;, the following functions need to be reverted from 2.4&lt;br/&gt;
MapFilter, MapZipWith, TransformKeys, TransformValues&lt;/p&gt;</comment>
                            <comment id="16663230" author="dongjoon" created="Thu, 25 Oct 2018 04:41:39 +0000"  >&lt;p&gt;Thank you for further investigation! Both tasks look not easy. For me, +1 for `later entry wins` semantics because it&apos;s Java/Scala language style and many users know those languages. Also, Spark works in that way, especially during the writing operation.&lt;/p&gt;</comment>
                            <comment id="16663368" author="kiszk" created="Thu, 25 Oct 2018 07:23:31 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ueshin&quot; class=&quot;user-hover&quot; rel=&quot;ueshin&quot;&gt;ueshin&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16663394" author="kiszk" created="Thu, 25 Oct 2018 07:40:25 +0000"  >&lt;p&gt;I am curious about behavior in other systems such as Presto.&lt;br/&gt;
Here are test cases for &lt;a href=&quot;https://github.com/prestodb/presto/blob/master/presto-main/src/test/java/com/facebook/presto/type/TestArrayOperators.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;array&lt;/a&gt; and &lt;a href=&quot;https://github.com/prestodb/presto/blob/master/presto-main/src/test/java/com/facebook/presto/type/TestMapOperators.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;map&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16663484" author="viirya" created="Thu, 25 Oct 2018 09:26:32 +0000"  >&lt;p&gt;Besides Java/Scala, maybe we can be consistent with common behavior of other SQL systems, if any.&lt;/p&gt;

&lt;p&gt;From the test case above, looks like Presto disallows duplicate keys in map. &lt;a href=&quot;https://github.com/prestodb/presto/blob/master/presto-main/src/test/java/com/facebook/presto/type/TestMapOperators.java#L123&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/prestodb/presto/blob/master/presto-main/src/test/java/com/facebook/presto/type/TestMapOperators.java#L123&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16663539" author="viirya" created="Thu, 25 Oct 2018 10:11:28 +0000"  >&lt;p&gt;Although I think the inconsistent handling exists for a while, if we decide &quot;later entry wins&quot; and revert some functions from 2.4, will this be a blocker for 2.4?&lt;/p&gt;</comment>
                            <comment id="16663553" author="mgaido" created="Thu, 25 Oct 2018 10:28:46 +0000"  >&lt;p&gt;I think the main issue is that since this is not a SQL standard thing, every DB works in its way. Eg. Postgres just says that when duplicate keys are entered, there is no guarantee on the result (&lt;a href=&quot;https://www.postgresql.org/docs/9.0/static/hstore.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://www.postgresql.org/docs/9.0/static/hstore.html&lt;/a&gt;); not a great policy, I agree. Maybe we can check Hive, since Spark takes much of its behavior from it. Anyway, I think we just need to define a coherent behavior across the codebase.&lt;/p&gt;

&lt;p&gt;One consideration is that enforcing a policy like Presto (eg. fail in such a situation) has 2 main drawbacks:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;We usually don&apos;t fail with bad data (most of the times we return NULL instead of throwing exceptions in other situations);&lt;/li&gt;
	&lt;li&gt;Checking if a key is already present, with the current &lt;tt&gt;ArrayData&lt;/tt&gt; representation, is very inefficient and we can do workarounds for this, but we would need to replicate workarounds in any function which can produce keys, so it is going to be problematic to maintain.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16696393" author="apachespark" created="Fri, 23 Nov 2018 05:35:38 +0000"  >&lt;p&gt;User &apos;cloud-fan&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/23124&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23124&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16696394" author="apachespark" created="Fri, 23 Nov 2018 05:36:09 +0000"  >&lt;p&gt;User &apos;cloud-fan&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/23124&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23124&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16702039" author="cloud_fan" created="Wed, 28 Nov 2018 15:43:25 +0000"  >&lt;p&gt;Issue resolved by pull request 23124&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/23124&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23124&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16708648" author="apachespark" created="Tue, 4 Dec 2018 12:45:34 +0000"  >&lt;p&gt;User &apos;mgaido91&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/23217&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23217&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16708650" author="apachespark" created="Tue, 4 Dec 2018 12:46:16 +0000"  >&lt;p&gt;User &apos;mgaido91&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/23217&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23217&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13193928">SPARK-25823</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13194047">SPARK-25832</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                            <subtask id="13193949">SPARK-25824</subtask>
                            <subtask id="13194022">SPARK-25830</subtask>
                            <subtask id="13194023">SPARK-25831</subtask>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 50 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3zm33:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>