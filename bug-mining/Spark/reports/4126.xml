<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:48:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-17870] ML/MLLIB: ChiSquareSelector based on Statistics.chiSqTest(RDD) is wrong </title>
                <link>https://issues.apache.org/jira/browse/SPARK-17870</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;The method to count ChiSqureTestResult in mllib/feature/ChiSqSelector.scala  (line 233) is wrong.&lt;/p&gt;

&lt;p&gt;For feature selection method ChiSquareSelector, it is based on the ChiSquareTestResult.statistic (ChiSqure value) to select the features. It select the features with the largest ChiSqure value. But the Degree of Freedom (df) of ChiSqure value is different in Statistics.chiSqTest(RDD), and for different df, you cannot base on ChiSqure value to select features.&lt;/p&gt;

&lt;p&gt;Because of the wrong method to count ChiSquare value, the feature selection results are strange.&lt;br/&gt;
Take the test suite in ml/feature/ChiSqSelectorSuite.scala as an example:&lt;br/&gt;
If use selectKBest to select: the feature 3 will be selected.&lt;br/&gt;
If use selectFpr to select: feature 1 and 2 will be selected. &lt;br/&gt;
This is strange. &lt;/p&gt;

&lt;p&gt;I use scikit learn to test the same data with the same parameters. &lt;br/&gt;
When use selectKBest to select: feature 1 will be selected. &lt;br/&gt;
When use selectFpr to select: feature 1 and 2 will be selected. &lt;br/&gt;
This result is make sense. because the df of each feature in scikit learn is the same.&lt;/p&gt;

&lt;p&gt;I plan to submit a PR for this problem.&lt;/p&gt;


</description>
                <environment></environment>
        <key id="13011295">SPARK-17870</key>
            <summary>ML/MLLIB: ChiSquareSelector based on Statistics.chiSqTest(RDD) is wrong </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="peng.meng@intel.com">Peng Meng</assignee>
                                    <reporter username="peng.meng@intel.com">Peng Meng</reporter>
                        <labels>
                    </labels>
                <created>Tue, 11 Oct 2016 08:50:30 +0000</created>
                <updated>Tue, 25 Oct 2016 19:04:02 +0000</updated>
                            <resolved>Fri, 14 Oct 2016 11:49:10 +0000</resolved>
                                                    <fixVersion>2.1.0</fixVersion>
                                    <component>ML</component>
                    <component>MLlib</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15564959" author="srowen" created="Tue, 11 Oct 2016 09:04:22 +0000"  >&lt;p&gt;Oof, I&apos;m pretty certain you&apos;re correct. You can rank on the p-value (which is a function of DoF) but not the raw statistic. It&apos;s an easy change at least because this is already computed. Can&apos;t believe I missed that.&lt;/p&gt;</comment>
                            <comment id="15565041" author="peng.meng@intel.com" created="Tue, 11 Oct 2016 09:48:35 +0000"  >&lt;p&gt;hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srowen&quot; class=&quot;user-hover&quot; rel=&quot;srowen&quot;&gt;srowen&lt;/a&gt;, thanks very much for you quickly reply. &lt;br/&gt;
yes,the p-value is better than raw statistic in this case, because p-value is count  based on DoF and raw statistic.&lt;br/&gt;
raw statistic is also popular for feature selection. The SelectKBest and SelectPercentile in scikit learn is based on raw statistic. &lt;br/&gt;
The question here is we should use the same DoF like scikit learn to count ChiSquare value. &lt;br/&gt;
For this JIRA, I propose to change the method to count ChiSquare value like what is done in scikit learn (change Statistics.chiSqTest(RDD)). &lt;/p&gt;

&lt;p&gt;Thanks very much.  &lt;/p&gt;</comment>
                            <comment id="15565180" author="srowen" created="Tue, 11 Oct 2016 11:13:25 +0000"  >&lt;p&gt;I don&apos;t think the raw statistic can be directly compared here because the features do not have even nearly the same number of &apos;buckets&apos;, not necessarily. A given test statistic value is &quot;less remarkable&quot; when there are more DoF; what&apos;s high for a binary-valued feature may not be high at all for one taking on 100 values.&lt;/p&gt;

&lt;p&gt;Does scikit really use the statistic? because you&apos;re also saying it does something that gives different results from ranking on the statistic.&lt;/p&gt;</comment>
                            <comment id="15565225" author="peng.meng@intel.com" created="Tue, 11 Oct 2016 11:44:53 +0000"  >&lt;p&gt;yes, the selectKBest and selectPercentile in scikit learn only use statistic.&lt;br/&gt;
Because the method to count ChiSquare value is different, the DoF of all features in scikit learn are the same. so it can do that.&lt;/p&gt;

&lt;p&gt;The ChiSquare Value compute process is like this:&lt;br/&gt;
 suppose we have data:&lt;br/&gt;
X = [ 8 7 0&lt;br/&gt;
         0 9 6&lt;br/&gt;
         0 9 8&lt;br/&gt;
         8 9 5]&lt;br/&gt;
y = &lt;span class=&quot;error&quot;&gt;&amp;#91;0 1 1 2&amp;#93;&lt;/span&gt;T, this is the test suite data of ml/feature/ChiSquareSelectorSuite.scala&lt;br/&gt;
sci-kit learn to compute chiSquare value is like this:&lt;br/&gt;
first:&lt;br/&gt;
Y = [1 0 0&lt;br/&gt;
        0 1 0&lt;br/&gt;
        0  1 0&lt;br/&gt;
        0  0 1]&lt;br/&gt;
observed = Y&apos;*X=&lt;br/&gt;
[8  7    0&lt;br/&gt;
 0  18 14&lt;br/&gt;
 8   9   5]&lt;br/&gt;
expected = &lt;br/&gt;
[4 8.5 4.75&lt;br/&gt;
 8 17  9.5&lt;br/&gt;
 4  8.5  4.75]&lt;br/&gt;
_chisquare(ovserved, expected): to compute all features ChiSquare value, we can see all the DF of each feature is the same.&lt;/p&gt;

&lt;p&gt;Bug for spark Statistics.chiSqTest(RDD), is use another method, for each feature, construct a contingency table. So the DF is different for each feature.  &lt;/p&gt;

&lt;p&gt;For &quot;gives different results from ranking on the statistic&quot;, this is because the parameters different.&lt;br/&gt;
For previous example, if use SelectKBest(2), the selected feature is the same as SelectFpr(0.2) in scikit learn&lt;/p&gt;


</comment>
                            <comment id="15565238" author="srowen" created="Tue, 11 Oct 2016 11:54:08 +0000"  >&lt;p&gt;I don&apos;t quite understand this example, can you point me to the source? the chi-squared statistic is indeed a function of observed and expected counts, but I&apos;d expect those to be a vector of counts, one for each class. If you&apos;re saying that each row contains observed counts for one feature&apos;s classes, then yes in this particular construction each of them has the same number of classes (columns). But that isn&apos;t generally true; that can&apos;t be an assumption scikit makes? I bet I&apos;m missing something.&lt;/p&gt;</comment>
                            <comment id="15565251" author="peng.meng@intel.com" created="Tue, 11 Oct 2016 12:02:22 +0000"  >&lt;p&gt;The scikit learn code is here: &lt;a href=&quot;https://github.com/scikit-learn/scikit-learn/blob/412996f09b6756752dfd3736c306d46fca8f1aa1/sklearn/feature_selection/univariate_selection.py&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/scikit-learn/scikit-learn/blob/412996f09b6756752dfd3736c306d46fca8f1aa1/sklearn/feature_selection/univariate_selection.py&lt;/a&gt;, line 422 for selectKBest, chiSquare compute is also on the same page.&lt;/p&gt;

&lt;p&gt;For the last example, each row of X is a sample, it contain three features, totally 4 samples. Y is the label.&lt;br/&gt;
Thanks very much.  &lt;/p&gt;</comment>
                            <comment id="15565315" author="peng.meng@intel.com" created="Tue, 11 Oct 2016 12:42:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/spark/pull/1484#issuecomment-51024568&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/1484#issuecomment-51024568&lt;/a&gt;&lt;br/&gt;
Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mengxr&quot; class=&quot;user-hover&quot; rel=&quot;mengxr&quot;&gt;mengxr&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=avulanov&quot; class=&quot;user-hover&quot; rel=&quot;avulanov&quot;&gt;avulanov&lt;/a&gt; , what do you think about this JIRA. &lt;/p&gt;</comment>
                            <comment id="15566284" author="srowen" created="Tue, 11 Oct 2016 19:01:57 +0000"  >&lt;p&gt;OK I get it, they&apos;re doing different things really. The scikit version is computing the statistic for count-valued features vs categorical label, and the Spark version is computing this for categorical features vs categorical labels. Although the number of label classes is constant in both cases, the Spark computation would depend on the number of feature classes too. Yes, it does need to be changed in Spark.&lt;/p&gt;</comment>
                            <comment id="15566467" author="avulanov" created="Tue, 11 Oct 2016 20:20:24 +0000"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;`SelectKBest`&amp;#93;&lt;/span&gt;(&lt;a href=&quot;http://scikit-learn.org/stable/modules/generated/sklearn.feature_selection.SelectKBest.html#sklearn.feature_selection.SelectKBest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://scikit-learn.org/stable/modules/generated/sklearn.feature_selection.SelectKBest.html#sklearn.feature_selection.SelectKBest&lt;/a&gt;) works with &quot;a Function taking two arrays X and y, and returning a pair of arrays (scores, pvalues) or a single array with scores&quot;. According to what you observe, it uses pvalues for sorting of `chi2` outputs. Indeed, it is the case for all functions that return two arrays: &lt;a href=&quot;https://github.com/scikit-learn/scikit-learn/blob/412996f/sklearn/feature_selection/univariate_selection.py#L331&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/scikit-learn/scikit-learn/blob/412996f/sklearn/feature_selection/univariate_selection.py#L331&lt;/a&gt;. Alternative, one case use raw `chi2` scores for sorting. She need to pass only the first array from `chi2` to `SelectKBest`. As far as I remember, using raw chi2 scores is default in Weka&apos;s &lt;span class=&quot;error&quot;&gt;&amp;#91;ChiSquaredAttributeEval&amp;#93;&lt;/span&gt;(&lt;a href=&quot;http://weka.sourceforge.net/doc.stable/weka/attributeSelection/ChiSquaredAttributeEval.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://weka.sourceforge.net/doc.stable/weka/attributeSelection/ChiSquaredAttributeEval.html&lt;/a&gt;). So, I would not claim that either of approaches is incorrect. According to &lt;span class=&quot;error&quot;&gt;&amp;#91;Introduction to IR&amp;#93;&lt;/span&gt;(&lt;a href=&quot;http://nlp.stanford.edu/IR-book/html/htmledition/assessing-as-a-feature-selection-methodassessing-chi-square-as-a-feature-selection-method-1.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://nlp.stanford.edu/IR-book/html/htmledition/assessing-as-a-feature-selection-methodassessing-chi-square-as-a-feature-selection-method-1.html&lt;/a&gt;), there might be an issue with computing p-values because then chi2-test is used multiple times. Using plain chi2 values does not involve statistical test, so it might be treated as just some ranking with no statistical implications.&lt;/p&gt;</comment>
                            <comment id="15566586" author="srowen" created="Tue, 11 Oct 2016 20:58:09 +0000"  >&lt;p&gt;If the degrees of freedom are the same across the tests, then ranking on p-value or statistic should give the same ranking because the p-value is a monotonically decreasing function of the statistic. That&apos;s the case in what the scikit code is effectively doing because there are always (# label classes - 1) degrees of freedom. Really the p-value is the comparable quantity, but there&apos;s no point computing it in this case because it&apos;s just for ranking.&lt;/p&gt;

&lt;p&gt;The Spark code performs a chi-squared test but applies it to answer a different question, where DOF is no longer the same; it&apos;s (# label classes - 1) * (# feature classes - 1) in the contingency table here. p-value is no longer always smaller when the statistic is larger. So it&apos;s necessary to actually use the p-values for what Spark is doing.&lt;/p&gt;</comment>
                            <comment id="15567170" author="peng.meng@intel.com" created="Wed, 12 Oct 2016 01:10:00 +0000"  >&lt;p&gt;hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=avulanov&quot; class=&quot;user-hover&quot; rel=&quot;avulanov&quot;&gt;avulanov&lt;/a&gt;, the question here is not use raw chi2 scores or pvalues, the question is if use raw chi2 scores, the DoF should be the same.   &lt;br/&gt;
&quot;chi2-test is used multiple times&quot; is another problem.  According to (&lt;a href=&quot;http://nlp.stanford.edu/IR-book/html/htmledition/assessing-as-a-feature-selection-methodassessing-chi-square-as-a-feature-selection-method-1.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://nlp.stanford.edu/IR-book/html/htmledition/assessing-as-a-feature-selection-methodassessing-chi-square-as-a-feature-selection-method-1.html&lt;/a&gt;),&quot;whenever a statistical test is used multiple times, then the probability of getting at least one error increases.&quot;, this problem is partially solved by Select the p-values corresponding to Family-wise error rate (SelectFwe, &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-17645&quot; title=&quot;Add feature selector methods based on: False Discovery Rate (FDR) and Family Wise Error rate (FWE)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-17645&quot;&gt;&lt;del&gt;SPARK-17645&lt;/del&gt;&lt;/a&gt;). Thanks very much.&lt;/p&gt;

&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srowen&quot; class=&quot;user-hover&quot; rel=&quot;srowen&quot;&gt;srowen&lt;/a&gt;, I totally agree with your comments. Based on the DoF is different in Spark ChiSquare value, we can use the p-values for Spark SelectKBest, and SelectPercentile. Thanks very much.&lt;/p&gt;

&lt;p&gt;I will submit a pr for this.&lt;/p&gt;</comment>
                            <comment id="15567244" author="apachespark" created="Wed, 12 Oct 2016 01:48:06 +0000"  >&lt;p&gt;User &apos;mpjlu&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/15444&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/15444&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15575103" author="srowen" created="Fri, 14 Oct 2016 11:49:11 +0000"  >&lt;p&gt;Issue resolved by pull request 15444&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/15444&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/15444&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310060">
                    <name>Container</name>
                                                                <inwardlinks description="Is contained by">
                                        <issuelink>
            <issuekey id="13007959">SPARK-17692</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12996547">SPARK-17017</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 5 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i34psf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>