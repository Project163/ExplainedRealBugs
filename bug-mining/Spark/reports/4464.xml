<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:50:38 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-18113] Sending AskPermissionToCommitOutput failed, driver enter into task deadloop</title>
                <link>https://issues.apache.org/jira/browse/SPARK-18113</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Executor sends &lt;b&gt;AskPermissionToCommitOutput&lt;/b&gt; to driver failed, and retry another sending. Driver receives 2 AskPermissionToCommitOutput messages and handles them. But executor ignores the first response(true) and receives the second response(false). The TaskAttemptNumber for this partition in authorizedCommittersByStage is locked forever. Driver enters into infinite loop.&lt;/p&gt;

&lt;h4&gt;&lt;a name=&quot;DriverLog%3A&quot;&gt;&lt;/a&gt;Driver Log:&lt;/h4&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;16/10/25 05:38:28 INFO TaskSetManager: Starting task 24.0 in stage 2.0 (TID 110, cwss04.sh01.com, partition 24, PROCESS_LOCAL, 5248 bytes)
...
16/10/25 05:39:00 WARN TaskSetManager: Lost task 24.0 in stage 2.0 (TID 110, cwss04.sh01.com): TaskCommitDenied (Driver denied task commit) for job: 2, partition: 24, attemptNumber: 0
...
16/10/25 05:39:00 INFO OutputCommitCoordinator: Task was denied committing, stage: 2, partition: 24, attempt: 0
...
16/10/26 15:53:03 INFO TaskSetManager: Starting task 24.1 in stage 2.0 (TID 119, cwss04.sh01.com, partition 24, PROCESS_LOCAL, 5248 bytes)
...
16/10/26 15:53:05 WARN TaskSetManager: Lost task 24.1 in stage 2.0 (TID 119, cwss04.sh01.com): TaskCommitDenied (Driver denied task commit) for job: 2, partition: 24, attemptNumber: 1
16/10/26 15:53:05 INFO OutputCommitCoordinator: Task was denied committing, stage: 2, partition: 24, attempt: 1
...
16/10/26 15:53:05 INFO TaskSetManager: Starting task 24.28654 in stage 2.0 (TID 28733, cwss04.sh01.com, partition 24, PROCESS_LOCAL, 5248 bytes)
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;h4&gt;&lt;a name=&quot;ExecutorLog%3A&quot;&gt;&lt;/a&gt;Executor Log:&lt;/h4&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;...
16/10/25 05:38:42 INFO Executor: Running task 24.0 in stage 2.0 (TID 110)
...
16/10/25 05:39:10 WARN NettyRpcEndpointRef: Error sending message [message = AskPermissionToCommitOutput(2,24,0)] in 1 attempts
org.apache.spark.rpc.RpcTimeoutException: Futures timed out after [10 seconds]. This timeout is controlled by spark.rpc.askTimeout
        at org.apache.spark.rpc.RpcTimeout.org$apache$spark$rpc$RpcTimeout$$createRpcTimeoutException(RpcTimeout.scala:48)
        at org.apache.spark.rpc.RpcTimeout$$anonfun$addMessageIfTimeout$1.applyOrElse(RpcTimeout.scala:63)
        at org.apache.spark.rpc.RpcTimeout$$anonfun$addMessageIfTimeout$1.applyOrElse(RpcTimeout.scala:59)
        at scala.PartialFunction$OrElse.apply(PartialFunction.scala:167)
        at org.apache.spark.rpc.RpcTimeout.awaitResult(RpcTimeout.scala:83)
        at org.apache.spark.rpc.RpcEndpointRef.askWithRetry(RpcEndpointRef.scala:102)
        at org.apache.spark.rpc.RpcEndpointRef.askWithRetry(RpcEndpointRef.scala:78)
        at org.apache.spark.scheduler.OutputCommitCoordinator.canCommit(OutputCommitCoordinator.scala:95)
        at org.apache.spark.mapred.SparkHadoopMapRedUtil$.commitTask(SparkHadoopMapRedUtil.scala:73)
        at org.apache.spark.SparkHadoopWriter.commit(SparkHadoopWriter.scala:106)
        at org.apache.spark.rdd.PairRDDFunctions$$anonfun$saveAsHadoopDataset$1$$anonfun$13.apply(PairRDDFunctions.scala:1212)
        at org.apache.spark.rdd.PairRDDFunctions$$anonfun$saveAsHadoopDataset$1$$anonfun$13.apply(PairRDDFunctions.scala:1190)
        at org.apache.spark.scheduler.ResultTask.runTask(ResultTask.scala:70)
        at org.apache.spark.scheduler.Task.run(Task.scala:86)
        at org.apache.spark.executor.Executor$TaskRunner.run(Executor.scala:279)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1153)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)
        at java.lang.Thread.run(Thread.java:785)
Caused by: java.util.concurrent.TimeoutException: Futures timed out after [10 seconds]
        at scala.concurrent.impl.Promise$DefaultPromise.ready(Promise.scala:219)
        at scala.concurrent.impl.Promise$DefaultPromise.result(Promise.scala:223)
        at scala.concurrent.Await$$anonfun$result$1.apply(package.scala:190)
        at scala.concurrent.BlockContext$DefaultBlockContext$.blockOn(BlockContext.scala:53)
        at scala.concurrent.Await$.result(package.scala:190)
        at org.apache.spark.rpc.RpcTimeout.awaitResult(RpcTimeout.scala:81)
        ... 13 more
...
16/10/25 05:39:16 INFO Executor: Running task 24.1 in stage 2.0 (TID 119)
...
16/10/25 05:39:24 INFO SparkHadoopMapRedUtil: attempt_201610250536_0002_m_000024_119: Not committed because the driver did not authorize commit
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;ol&gt;
	&lt;li&gt;cat /etc/redhat-release&lt;br/&gt;
Red Hat Enterprise Linux Server release 7.2 (Maipo)&lt;/li&gt;
&lt;/ol&gt;
</environment>
        <key id="13015355">SPARK-18113</key>
            <summary>Sending AskPermissionToCommitOutput failed, driver enter into task deadloop</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jinxing6042@126.com">Jin Xing</assignee>
                                    <reporter username="xq2005">xuqing</reporter>
                        <labels>
                    </labels>
                <created>Wed, 26 Oct 2016 09:41:16 +0000</created>
                <updated>Sun, 17 May 2020 17:48:38 +0000</updated>
                            <resolved>Wed, 18 Jan 2017 18:48:40 +0000</resolved>
                                    <version>2.0.1</version>
                                    <fixVersion>2.2.0</fixVersion>
                                    <component>Scheduler</component>
                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="15608015" author="xq2005" created="Wed, 26 Oct 2016 09:48:53 +0000"  >&lt;p&gt;Fix is easy, in handleAskPermissionToCommit&lt;/p&gt;

&lt;p&gt;when (existingCommitter &amp;amp;&amp;amp; attemptNumber == authorizedCommitters(partition)) ,  return true too.&lt;/p&gt;</comment>
                            <comment id="15802102" author="aash" created="Thu, 5 Jan 2017 18:24:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xq2005&quot; class=&quot;user-hover&quot; rel=&quot;xq2005&quot;&gt;xq2005&lt;/a&gt; can you please send a PR to &lt;a href=&quot;https://github.com/apache/spark&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark&lt;/a&gt; with your proposed change?&lt;/p&gt;

&lt;p&gt;I think I&apos;m seeing the same issue and would like to see the code diff you&apos;re suggesting so I can test the fix.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="15806897" author="jinxing6042@126.com" created="Sat, 7 Jan 2017 06:10:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xq2005&quot; class=&quot;user-hover&quot; rel=&quot;xq2005&quot;&gt;xq2005&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aash&quot; class=&quot;user-hover&quot; rel=&quot;aash&quot;&gt;aash&lt;/a&gt;&lt;br/&gt;
I am seeing this issue in my cluster some times. If &lt;b&gt;OutputCommittCoordinatorEndpoint&lt;/b&gt; receive &lt;b&gt;AskPermissionToCommitOutput&lt;/b&gt; for the first time, &lt;b&gt;OutputCommitCoordinatoryEndpoint&lt;/b&gt; will mark the task attempt as a committer in &lt;b&gt;authorizedCommittersByStage&lt;/b&gt; and send back the response. But if the worker failed to get the response in &lt;b&gt;spark.rpc.timeout&lt;/b&gt;, it will retry sending &lt;b&gt;AskPermissionToCommitOutput&lt;/b&gt;. However it will be denied by &lt;b&gt;OutputCommitCoordinatorEndpoint&lt;/b&gt;, because it has already registered a committer for the partition, even though the registered committer and the worker are the same. &lt;br/&gt;
Reproducing is easy:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;OutputCommitCoordinator.scala&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;......
  &lt;span class=&quot;code-comment&quot;&gt;// Marked &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt;[scheduler] instead of &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; so &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; can be mocked in tests
&lt;/span&gt;  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt;[scheduler] def handleAskPermissionToCommit(
      stage: StageId,
      partition: PartitionId,
      attemptNumber: TaskAttemptNumber): &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt; = &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; {
    authorizedCommittersByStage.get(stage) match {
      &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; Some(authorizedCommitters) =&amp;gt;
        authorizedCommitters(partition) match {
          &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; NO_AUTHORIZED_COMMITTER =&amp;gt;
            logDebug(s&lt;span class=&quot;code-quote&quot;&gt;&quot;Authorizing attemptNumber=$attemptNumber to commit &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; stage=$stage, &quot;&lt;/span&gt; +
              s&lt;span class=&quot;code-quote&quot;&gt;&quot;partition=$partition&quot;&lt;/span&gt;)
            authorizedCommitters(partition) = attemptNumber
            &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(150000)
            &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
          &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; existingCommitter =&amp;gt;
            logDebug(s&lt;span class=&quot;code-quote&quot;&gt;&quot;Denying attemptNumber=$attemptNumber to commit &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; stage=$stage, &quot;&lt;/span&gt; +
              s&lt;span class=&quot;code-quote&quot;&gt;&quot;partition=$partition; existingCommitter = $existingCommitter&quot;&lt;/span&gt;)
            &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
        }
      &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; None =&amp;gt;
        logDebug(s&lt;span class=&quot;code-quote&quot;&gt;&quot;Stage $stage has completed, so not allowing attempt number $attemptNumber of&quot;&lt;/span&gt; +
          s&lt;span class=&quot;code-quote&quot;&gt;&quot;partition $partition to commit&quot;&lt;/span&gt;)
        &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
    }
  }
......
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;When worker asks to be registered as a committer for the first time, sleep 150 seconds, which is bigger than &lt;b&gt;spark.rpc.timeout=120 seconds&lt;/b&gt;. when worker retries &lt;b&gt;AskPermissionToCommitOutput&lt;/b&gt; it will get &lt;b&gt;CommitDeniedException&lt;/b&gt;, then the task will fail with reason &lt;b&gt;TaskCommitDenied&lt;/b&gt;, which is not regarded as a task failure(&lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-11178&quot; title=&quot;Improve naming around task failures in scheduler code&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-11178&quot;&gt;&lt;del&gt;SPARK-11178&lt;/del&gt;&lt;/a&gt;), so TaskScheduler will schedule this task infinitely.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xq2005&quot; class=&quot;user-hover&quot; rel=&quot;xq2005&quot;&gt;xq2005&lt;/a&gt;&lt;br/&gt;
If you don&apos;t have time, could I make a pr for this?&lt;/p&gt;</comment>
                            <comment id="15809638" author="apachespark" created="Sun, 8 Jan 2017 16:27:03 +0000"  >&lt;p&gt;User &apos;jinxing64&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/16503&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/16503&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15811041" author="aash" created="Mon, 9 Jan 2017 08:25:14 +0000"  >&lt;p&gt;Thanks for sending in that PR &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jinxing6042%40126.com&quot; class=&quot;user-hover&quot; rel=&quot;jinxing6042@126.com&quot;&gt;jinxing6042@126.com&lt;/a&gt;!  It&apos;s very similar to the one I&apos;ve also been testing &amp;#8211; see &lt;a href=&quot;https://github.com/palantir/spark/pull/79&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/palantir/spark/pull/79&lt;/a&gt; for that diff (I haven&apos;t sent a PR into Apache yet).&lt;/p&gt;

&lt;p&gt;Has that fixed the problem for you?&lt;/p&gt;</comment>
                            <comment id="15812002" author="jinxing6042@126.com" created="Mon, 9 Jan 2017 15:12:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aash&quot; class=&quot;user-hover&quot; rel=&quot;aash&quot;&gt;aash&lt;/a&gt;&lt;br/&gt;
Thanks a lot for your reply!&lt;br/&gt;
I think the ideas we have for this issue are the same; I think both can solve my problem;&lt;br/&gt;
And how do you think about the unit test raised in my pr ? Could you leave some comments if possible ?&lt;br/&gt;
It&apos;s my first PR for spark. It&apos;s great if you can give some advice ~~Thanks a lot ! : )&lt;/p&gt;</comment>
                            <comment id="15812819" author="aash" created="Mon, 9 Jan 2017 20:54:33 +0000"  >&lt;p&gt;I&apos;ve done some more diagnosis on an example I saw, and think there&apos;s a failure mode that &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-8029&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SPARK-8029&lt;/a&gt; didn&apos;t consider.  Here&apos;s the sequence of steps I think causes this issue:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;executor requests a task commit&lt;/li&gt;
	&lt;li&gt;coordinator approves commit and sends response message&lt;/li&gt;
	&lt;li&gt;executor is preempted by YARN!&lt;/li&gt;
	&lt;li&gt;response message goes nowhere&lt;/li&gt;
	&lt;li&gt;OCC has attempt=0 fixed for that stage/partition now so no other attempt will succeed &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Are you running in YARN with preemption enabled? Is there preemption activity around the time of the task deadloop?&lt;/p&gt;</comment>
                            <comment id="15817067" author="jinxing6042@126.com" created="Wed, 11 Jan 2017 03:49:37 +0000"  >&lt;p&gt;Thanks a lot for your reply~ &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aash&quot; class=&quot;user-hover&quot; rel=&quot;aash&quot;&gt;aash&lt;/a&gt;. Your comment is very helpful;&lt;/p&gt;

&lt;p&gt;In my cluster preemption is enabled, but I didn&apos;t find preemption activity around the deadloop.&lt;br/&gt;
I think anything cause the &lt;b&gt;AskPermissionToCommitOutput&apos;s&lt;/b&gt; response timeout can lead to this deadloop.&lt;br/&gt;
Maybe there are two things need to do:&lt;br/&gt;
1. It&apos;s suitable to use &lt;b&gt;ask&lt;/b&gt; to replace &lt;b&gt;askWithRetry&lt;/b&gt;, which is too expensive and bug proven. If timeout, just fail the task and let Spark reschedule it;&lt;br/&gt;
2. Coordinator receiver should be idempotent for &lt;b&gt;AskPermissionToCommitOutput&lt;/b&gt;.&lt;/p&gt;</comment>
                            <comment id="15855585" author="xukun" created="Tue, 7 Feb 2017 08:52:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jinxing6042%40126.com&quot; class=&quot;user-hover&quot; rel=&quot;jinxing6042@126.com&quot;&gt;jinxing6042@126.com&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aash&quot; class=&quot;user-hover&quot; rel=&quot;aash&quot;&gt;aash&lt;/a&gt;&lt;br/&gt;
 I&apos;ve met the same question. Here&apos;s the sequence of steps:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;executor requests a task commit&lt;/li&gt;
	&lt;li&gt;coordinator approves commit and sends response message&lt;/li&gt;
	&lt;li&gt;executor receive response message and goes susscess and send StatusUpdate to driver&lt;/li&gt;
	&lt;li&gt;executor is preempted by YARN before receive StatusUpdate&lt;/li&gt;
	&lt;li&gt;task retry because of ExecutorLost and no other attempt will succeed&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I think this pr can not resolve this scene. can you give me some advices?&lt;/p&gt;</comment>
                            <comment id="15859015" author="jinxing6042@126.com" created="Thu, 9 Feb 2017 04:45:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xukun&quot; class=&quot;user-hover&quot; rel=&quot;xukun&quot;&gt;xukun&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Can you reproduce the bug with steps above?&lt;/p&gt;

&lt;p&gt;When ExecutorLost, &lt;b&gt;TaskSetManager&lt;/b&gt; will call:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;sched.dagScheduler.taskEnded(
            tasks(index), Resubmitted, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, Seq.empty, info)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then lock in &lt;b&gt;OutputCommitCoordinator&lt;/b&gt; will be cleared. So I don&apos;t think the scenario you raised exists.&lt;br/&gt;
Let me know if you have different ideas &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15865359" author="xukun" created="Tue, 14 Feb 2017 08:33:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jinxing6042%40126.com&quot; class=&quot;user-hover&quot; rel=&quot;jinxing6042@126.com&quot;&gt;jinxing6042@126.com&lt;/a&gt;&lt;br/&gt;
yes. reproduce steps:&lt;/p&gt;

&lt;p&gt;1. executor is running task x.0&lt;br/&gt;
2. appmaster get completed container statuses and tell driver to remove executor (now executor is not killed,it is still running.)&lt;br/&gt;
3. driver process CompletionEvent and TaskSetManager will call:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;sched.dagScheduler.taskEnded(
            tasks(index), Resubmitted, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, Seq.empty, info)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;4.task x.0 request a task commit and coordinator approves commit and sends response message&lt;br/&gt;
5.drvier receive AskPermissionToCommitOutput and authorize attemptNumber=0 for partition x&lt;br/&gt;
6.driver starting task x.1 because of ExecutorLost and enter into task deadloop&lt;/p&gt;

&lt;p&gt;When appmaster  get completed container statuses , executor is not preempted immediately. executor will be killed after a while. After TaskSetManager call&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;sched.dagScheduler.taskEnded(
            tasks(index), Resubmitted, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, Seq.empty, info)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;, task x.0 will send AskPermissionToCommitOutput. So driver enter into task deadloop.&lt;/p&gt;</comment>
                            <comment id="15865536" author="aash" created="Tue, 14 Feb 2017 10:21:02 +0000"  >&lt;p&gt;Thanks for the updates you both.  I&apos;ve been working with a coworker who&apos;s seeing this on a cluster of his and we think the deadloop is caused by an interaction between commit authorization and preemption (his cluster has lots of preemption occurring).&lt;/p&gt;

&lt;p&gt;You can see the in-progress patch we&apos;ve been working on at &lt;a href=&quot;https://github.com/palantir/spark/pull/94&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/palantir/spark/pull/94&lt;/a&gt; which adds a two-phase commit sequence to the OutputCommitCoordinator.  We&apos;re not done testing it yet but it might provide a useful example for discussion here.&lt;/p&gt;

&lt;p&gt;Maybe also we should file another ticket for the deadloop in preemption scenario, which is a little different from the deadloop in lost message scenario (what I think the already-merged PR fixes).&lt;/p&gt;</comment>
                            <comment id="15865644" author="xukun" created="Tue, 14 Feb 2017 11:49:43 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aash&quot; class=&quot;user-hover&quot; rel=&quot;aash&quot;&gt;aash&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Thanks for your reply. I think &lt;a href=&quot;https://github.com/palantir/spark/pull/94&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/palantir/spark/pull/94&lt;/a&gt; can not resolve this scenario.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;driver:  starting task 678.0 --- Lost executor --- retry 678.1 --- Authorizing attemptNumber=0,partition=678 --- Denying attemptNumber=1,partition=678 -- deadloop

executor:  Running task 678.0 -------------------------------------outputCommitCoordinator.canCommit ---- finished task 678.0 ---- RECEIVED SIGNAL 15: 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After driver retry task 678.1,  executor execute outputCommitCoordinator.canCommit. Because It is a gap between appmaster get completed container statuses and executor is killed.&lt;/p&gt;</comment>
                            <comment id="15865778" author="aash" created="Tue, 14 Feb 2017 13:38:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xukun&quot; class=&quot;user-hover&quot; rel=&quot;xukun&quot;&gt;xukun&lt;/a&gt; the scenario you describe should be accommodated by the newly-added &lt;tt&gt;spark.scheduler.outputcommitcoordinator.maxwaittime&lt;/tt&gt; in that PR, which sets a timeout for how long an executor can hold the commit lock for a task.  If the executor fails while holding the lock, then after that period of time the lock will be released and a subsequent executor will be able to commit the task.  By default right now it is 2min.&lt;/p&gt;</comment>
                            <comment id="15867124" author="xukun" created="Wed, 15 Feb 2017 02:46:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aash&quot; class=&quot;user-hover&quot; rel=&quot;aash&quot;&gt;aash&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;According my scenario and &lt;a href=&quot;https://github.com/palantir/spark/pull/94&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/palantir/spark/pull/94&lt;/a&gt; code&lt;/p&gt;

&lt;p&gt;task 678.0&lt;br/&gt;
outputCommitCoordinator.canCommit will match CommitState(NO_AUTHORIZED_COMMITTER, _, Uncommitted) =&amp;gt;  CommitState(attemptNumber, System.nanoTime(), MidCommit)&lt;/p&gt;

&lt;p&gt;outputCommitCoordinator.commitDone match CommitState(existingCommitter, startTime, MidCommit) if attemptNumber == existingCommitter =&amp;gt;&lt;br/&gt;
 CommitState(attemptNumber, startTime, Committed)&lt;/p&gt;

&lt;p&gt;task 678.1&lt;br/&gt;
outputCommitCoordinator.canCommit match CommitState(existingCommitter, _, Committed) &lt;/p&gt;

&lt;p&gt;If executor is preempted after outputCommitCoordinator.commitDone, driver still enter into task deadloop&lt;/p&gt;</comment>
                            <comment id="15875599" author="jinxing6042@126.com" created="Tue, 21 Feb 2017 08:40:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xukun&quot; class=&quot;user-hover&quot; rel=&quot;xukun&quot;&gt;xukun&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I got the scenario you described. &lt;/p&gt;

&lt;p&gt;&lt;cite&gt;When appmaster get completed container statuses , executor is not preempted immediately. executor will be killed after a while.&lt;/cite&gt;&lt;br/&gt;
Yes, I think this is the root cause of this bug, which can be fixed by &lt;a href=&quot;https://github.com/palantir/spark/pull/94&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/palantir/spark/pull/94&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;cite&gt;If executor is preempted after outputCommitCoordinator.commitDone, driver still enter into task deadloop&lt;/cite&gt;&lt;br/&gt;
I hardly agree with above. Since when &lt;b&gt;commitDone&lt;/b&gt; is called, no more &lt;b&gt;AskPermissionToCommit&lt;/b&gt; will be sent again. Thus I believe &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;sched.dagScheduler.taskEnded(
            tasks(index), Resubmitted, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, Seq.empty, info)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;can clean the commit lock clearly, following &lt;b&gt;AskPermissionToCommit&lt;/b&gt; from other task attempt will be authorized.&lt;br/&gt;
Thoughts ?&lt;/p&gt;</comment>
                            <comment id="15880279" author="xukun" created="Thu, 23 Feb 2017 11:28:12 +0000"  >&lt;p&gt;[~jinxing6042&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jinxing6042%40126.com&quot; class=&quot;user-hover&quot; rel=&quot;jinxing6042@126.com&quot;&gt;jinxing6042@126.com&lt;/a&gt;&lt;br/&gt;
When appmaster get completed container statuses , executor is not preempted immediately. executor will be killed after a while.&lt;br/&gt;
Yes, I think this is the root cause of this bug, which can be fixed by &lt;a href=&quot;https://github.com/palantir/spark/pull/94&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/palantir/spark/pull/94&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Sorry, I don&apos;t understand. &lt;br/&gt;
my steps is :&lt;br/&gt;
1.task 678.0 -&amp;gt; AskPermissionToCommitOutput&lt;br/&gt;
2.task 678.0 -&amp;gt; InformCommitDone&lt;br/&gt;
3.task 678.1 -&amp;gt; AskPermissionToCommitOutput&lt;br/&gt;
4.task 678.1 -&amp;gt; InformCommitDone&lt;br/&gt;
I think it is not fixed by &lt;a href=&quot;https://github.com/palantir/spark/pull/94&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/palantir/spark/pull/94&lt;/a&gt;. Can u show me the step? &lt;br/&gt;
Thanks!&lt;/p&gt;</comment>
                            <comment id="15893222" author="aash" created="Thu, 2 Mar 2017 23:15:49 +0000"  >&lt;p&gt;We discovered another bug related to committing that causes task deadloop and have work being done in &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-19631&quot; title=&quot;OutputCommitCoordinator should not allow commits for already failed tasks&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-19631&quot;&gt;&lt;del&gt;SPARK-19631&lt;/del&gt;&lt;/a&gt; to fix it.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12834470">SPARK-8029</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 37 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i35epr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>