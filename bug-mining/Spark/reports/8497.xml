<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:29:50 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-37544] sequence over dates with month interval is producing incorrect results</title>
                <link>https://issues.apache.org/jira/browse/SPARK-37544</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Sequence function with dates and step interval in months producing unexpected results.&lt;/p&gt;

&lt;p&gt;Here is a sample using Spark 3.2 (though the behavior is the same in 3.1.1 and presumably earlier):&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;scala&amp;gt; spark.sql(&quot;select sequence(date &apos;2021-01-01&apos;, date &apos;2022-01-01&apos;, interval &apos;3&apos; month) x, date &apos;2021-01-01&apos; + interval &apos;3&apos; month y&quot;).collect()&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;res1: Array&lt;span class=&quot;error&quot;&gt;&amp;#91;org.apache.spark.sql.Row&amp;#93;&lt;/span&gt; = Array(&lt;span class=&quot;error&quot;&gt;&amp;#91;WrappedArray(2021-01-01, &lt;font color=&quot;#FF0000&quot;&gt;&lt;b&gt;2021-03-31, 2021-06-30, 2021-09-30,&lt;/b&gt; &lt;/font&gt;&lt;font color=&quot;#172b4d&quot;&gt;2022-01-01&lt;/font&gt;),2021-04-01&amp;#93;&lt;/span&gt;)&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;Expected result of adding 3 months to the 2021-01-01 is 2021-04-01, while sequence returns 2021-03-31.&lt;/p&gt;

&lt;p&gt;At the same time sequence over timestamps works as expected:&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;scala&amp;gt; spark.sql(&quot;select sequence(timestamp &apos;2021-01-01 00:00&apos;, timestamp &apos;2022-01-01 00:00&apos;, interval &apos;3&apos; month) x&quot;).collect()&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;res2: Array&lt;span class=&quot;error&quot;&gt;&amp;#91;org.apache.spark.sql.Row&amp;#93;&lt;/span&gt; = Array(&lt;span class=&quot;error&quot;&gt;&amp;#91;WrappedArray(2021-01-01 00:00:00.0, *2021-04-01* 00:00:00.0, *2021-07-01* 00:00:00.0, *2021-10-01* 00:00:00.0, 2022-01-01 00:00:00.0)&amp;#93;&lt;/span&gt;)&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;A similar issue was reported in the past - &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-31654&quot; title=&quot;sequence producing inconsistent intervals for month step&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-31654&quot;&gt;&lt;del&gt;SPARK-31654&lt;/del&gt;&lt;/a&gt; sequence producing inconsistent intervals for month step - ASF JIRA (apache.org)&lt;br/&gt;
It&apos;s marked resolved, but the problem is either resurfaced or was never actually fixed.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Ubuntu 20, OSX 11.6&lt;br/&gt;
OpenJDK 11, Spark 3.2&lt;/p&gt;</environment>
        <key id="13415375">SPARK-37544</key>
            <summary>sequence over dates with month interval is producing incorrect results</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bersprockets">Bruce Robbins</assignee>
                                    <reporter username="seva_ostapenko">Vsevolod Ostapenko</reporter>
                        <labels>
                            <label>correctness</label>
                    </labels>
                <created>Sat, 4 Dec 2021 06:09:38 +0000</created>
                <updated>Mon, 12 Dec 2022 18:10:46 +0000</updated>
                            <resolved>Sun, 15 May 2022 00:28:24 +0000</resolved>
                                    <version>3.1.1</version>
                    <version>3.2.0</version>
                                    <fixVersion>3.3.0</fixVersion>
                    <fixVersion>3.1.4</fixVersion>
                    <fixVersion>3.2.2</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17454398" author="gurwls223" created="Tue, 7 Dec 2021 06:25:59 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maxgekk&quot; class=&quot;user-hover&quot; rel=&quot;maxgekk&quot;&gt;maxgekk&lt;/a&gt; FYI&lt;/p&gt;</comment>
                            <comment id="17454406" author="maxgekk" created="Tue, 7 Dec 2021 06:37:50 +0000"  >&lt;p&gt;We switched Spark&apos;s master on ANSI intervals recently. I ran the same example on it:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
spark-sql&amp;gt; select sequence(date &lt;span class=&quot;code-quote&quot;&gt;&apos;2021-01-01&apos;&lt;/span&gt;, date &lt;span class=&quot;code-quote&quot;&gt;&apos;2022-01-01&apos;&lt;/span&gt;, interval &lt;span class=&quot;code-quote&quot;&gt;&apos;3&apos;&lt;/span&gt; month) x, date &lt;span class=&quot;code-quote&quot;&gt;&apos;2021-01-01&apos;&lt;/span&gt; + interval &lt;span class=&quot;code-quote&quot;&gt;&apos;3&apos;&lt;/span&gt; month y;
[2021-01-01,2021-04-01,2021-07-01,2021-10-01,2022-01-01] &#160; &#160;2021-04-01 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17536865" author="bersprockets" created="Fri, 13 May 2022 20:18:31 +0000"  >&lt;p&gt;Reproduction of the bug depends on your time zone. It all works as expected if you are running in the UTC time zone. The master branch will still produce incorrect results if your local time zone is, say, &lt;tt&gt;America/Los_Angeles&lt;/tt&gt;. For example:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;spark-sql&amp;gt; select sequence(date &apos;2021-01-01&apos;, date &apos;2022-01-01&apos;, interval &apos;3&apos; month) x;
[2021-01-01,2021-03-31,2021-06-30,2021-09-30,2022-01-01]
Time taken: 0.664 seconds, Fetched 1 row(s)
spark-sql&amp;gt; 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;InternalSequenceBase converts the date to micros by multiplying days by micros per day. This converts the date into a time zone agnostic timestamp. However, InternalSequenceBase uses a function to perform the arithmetic (DateTimeUtils#timestampAddInterval) that assumes a &lt;em&gt;time zone aware&lt;/em&gt; timestamp.&lt;/p&gt;

&lt;p&gt;If your time zone is America/Los_Angeles, and you specify a start date of &apos;2021-01-01&apos;, InternalSequenceBase converts that to &apos;2021-01-01 00:00:00 UTC&apos;. However, what we should pass to DateTimeUtils#timestampAddInterval is &apos;2021-01-01 00:00:00 &lt;em&gt;PST&lt;/em&gt;&apos; . As a result, the sequence ends up adding 3 months to &apos;2020-12-31 16:00 PST&apos;, which is &apos;2021-03-31 16:00 PDT&apos;.&lt;/p&gt;

&lt;p&gt;This is why the second value in the sequence is 2021-03-31 and not 2021-04-01.&lt;/p&gt;

&lt;p&gt;One fix is to change InternalSequenceBase to use timestampNTZAddInterval for dates. However, that would put sequences out-of-sync with Spark&apos;s date arithmetic, which &lt;em&gt;is&lt;/em&gt; time zone aware. Take for example the following Spark date arithmetic:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;select cast(date&apos;2022-03-09&apos; + interval &apos;4&apos; days &apos;23&apos; hour as date) as x;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In the &lt;tt&gt;America/Los_Angeles&lt;/tt&gt; time zone, it returns &lt;tt&gt;2022-03-14&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;However, in the &lt;tt&gt;UTC&lt;/tt&gt; time zone, it instead returns &lt;tt&gt;2022-03-13&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;So to be consistent with Spark date arithmetic, InternalSequenceBase should use daysToMicros and microsToDays for dates rather than simply multiplying days by a scale value. I will put up a PR that does exactly that in the next day or so.&lt;/p&gt;</comment>
                            <comment id="17536910" author="apachespark" created="Fri, 13 May 2022 22:03:25 +0000"  >&lt;p&gt;User &apos;bersprockets&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/36546&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/36546&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17536911" author="apachespark" created="Fri, 13 May 2022 22:03:47 +0000"  >&lt;p&gt;User &apos;bersprockets&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/36546&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/36546&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17537119" author="gurwls223" created="Sun, 15 May 2022 00:28:24 +0000"  >&lt;p&gt;Fixed in &lt;a href=&quot;https://github.com/apache/spark/pull/36546&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/36546&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17581068" author="apachespark" created="Wed, 17 Aug 2022 23:04:51 +0000"  >&lt;p&gt;User &apos;bersprockets&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/37559&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/37559&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 12 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0xcns:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>