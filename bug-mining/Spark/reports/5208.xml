<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:56:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-20466] HadoopRDD#addLocalConfiguration throws NPE</title>
                <link>https://issues.apache.org/jira/browse/SPARK-20466</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;in spark2.0.2, it throws NPE&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  17/04/23 08:19:55 ERROR executor.Executor: Exception in task 439.0 in stage 16.0 (TID 986)$ 
java.lang.NullPointerException$
^Iat org.apache.spark.rdd.HadoopRDD$.addLocalConfiguration(HadoopRDD.scala:373)$
^Iat org.apache.spark.rdd.HadoopRDD$$anon$1.&amp;lt;init&amp;gt;(HadoopRDD.scala:243)$
^Iat org.apache.spark.rdd.HadoopRDD.compute(HadoopRDD.scala:208)$
^Iat org.apache.spark.rdd.HadoopRDD.compute(HadoopRDD.scala:101)$
^Iat org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:319)$
^Iat org.apache.spark.rdd.RDD.iterator(RDD.scala:283)$
^Iat org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)$
^Iat org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:319)$
^Iat org.apache.spark.rdd.RDD.iterator(RDD.scala:283)$
^Iat org.apache.spark.scheduler.ResultTask.runTask(ResultTask.scala:70)$
^Iat org.apache.spark.scheduler.Task.run(Task.scala:86)$
^Iat org.apache.spark.executor.Executor$TaskRunner.run(Executor.scala:274)$
^Iat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)$
^Iat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)$
^Iat java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)$
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;suggestion to add some code to avoid NPE&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; 

   &lt;span class=&quot;code-comment&quot;&gt;/** Add Hadoop configuration specific to a single partition and attempt. */&lt;/span&gt;
  def addLocalConfiguration(jobTrackerId: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, jobId: Int, splitId: Int, attemptId: Int,
                            conf: JobConf) {
    val jobID = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; JobID(jobTrackerId, jobId)
    val taId = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TaskAttemptID(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TaskID(jobID, TaskType.MAP, splitId), attemptId)
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ( conf != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;){
    conf.set(&lt;span class=&quot;code-quote&quot;&gt;&quot;mapred.tip.id&quot;&lt;/span&gt;, taId.getTaskID.toString)
    conf.set(&lt;span class=&quot;code-quote&quot;&gt;&quot;mapred.task.id&quot;&lt;/span&gt;, taId.toString)
    conf.setBoolean(&lt;span class=&quot;code-quote&quot;&gt;&quot;mapred.task.is.map&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
    conf.setInt(&lt;span class=&quot;code-quote&quot;&gt;&quot;mapred.task.partition&quot;&lt;/span&gt;, splitId)
    conf.set(&lt;span class=&quot;code-quote&quot;&gt;&quot;mapred.job.id&quot;&lt;/span&gt;, jobID.toString)
   }
  }


&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13066960">SPARK-20466</key>
            <summary>HadoopRDD#addLocalConfiguration throws NPE</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stakiar">Sahil Takiar</assignee>
                                    <reporter username="kellyzly">liyunzhang</reporter>
                        <labels>
                    </labels>
                <created>Wed, 26 Apr 2017 07:13:02 +0000</created>
                <updated>Sun, 17 May 2020 18:13:58 +0000</updated>
                            <resolved>Tue, 3 Oct 2017 23:57:14 +0000</resolved>
                                    <version>2.0.2</version>
                                    <fixVersion>2.1.3</fixVersion>
                    <fixVersion>2.2.1</fixVersion>
                    <fixVersion>2.3.0</fixVersion>
                                    <component>Spark Core</component>
                    <component>YARN</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="15984292" author="kellyzly" created="Wed, 26 Apr 2017 07:15:55 +0000"  >&lt;p&gt;NPE_log describes the detailed info.&lt;/p&gt;</comment>
                            <comment id="16056985" author="q79969786" created="Wed, 21 Jun 2017 04:45:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kellyzly&quot; class=&quot;user-hover&quot; rel=&quot;kellyzly&quot;&gt;kellyzly&lt;/a&gt; How to reproduce it?&lt;/p&gt;</comment>
                            <comment id="16056991" author="kellyzly" created="Wed, 21 Jun 2017 04:53:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=q79969786&quot; class=&quot;user-hover&quot; rel=&quot;q79969786&quot;&gt;q79969786&lt;/a&gt;: found the NPE when runing Hive on Spark on TPCx-BB. But i did not remember to run which query to find this exception. But it is better to add a judge( if conf != null ) in &lt;a href=&quot;https://github.com/apache/spark/blob/master/core/src/main/scala/org/apache/spark/rdd/HadoopRDD.scala#L374&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;code&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16057325" author="srowen" created="Wed, 21 Jun 2017 10:57:22 +0000"  >&lt;p&gt;Hm, I think the question is how the JobConf is ever null here. I think adding a null check here would only be a band-aid, or at least, something that would need to be taken care of consistently across many more classes.&lt;/p&gt;</comment>
                            <comment id="16170759" author="stakiar" created="Mon, 18 Sep 2017 21:32:14 +0000"  >&lt;p&gt;I just hit this issue in Hive-on-Spark when running some TPC-DS queries. It seems to be intermittent, re-tries of the task succeed. I have a very similar stack trace:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.NullPointerException
        at org.apache.spark.rdd.HadoopRDD$.addLocalConfiguration(HadoopRDD.scala:364)
        at org.apache.spark.rdd.HadoopRDD$$anon$1.&amp;amp;lt;init&amp;amp;gt;(HadoopRDD.scala:238)
        at org.apache.spark.rdd.HadoopRDD.compute(HadoopRDD.scala:211)
        at org.apache.spark.rdd.HadoopRDD.compute(HadoopRDD.scala:101)
        at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:306)
        at org.apache.spark.rdd.RDD.iterator(RDD.scala:270)
        at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)
        at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:306)
        at org.apache.spark.rdd.RDD.iterator(RDD.scala:270)
        at org.apache.spark.scheduler.ShuffleMapTask.runTask(ShuffleMapTask.scala:73)
        at org.apache.spark.scheduler.ShuffleMapTask.runTask(ShuffleMapTask.scala:41)
        at org.apache.spark.scheduler.Task.run(Task.scala:89)
        at org.apache.spark.executor.Executor$TaskRunner.run(Executor.scala:242)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The &lt;tt&gt;JobConf&lt;/tt&gt; object can be &lt;tt&gt;null&lt;/tt&gt; if &lt;tt&gt;HadoopRDD#getJobConf&lt;/tt&gt; returns &lt;tt&gt;null&lt;/tt&gt;. Looks like there is a race condition in &lt;tt&gt;#getJobConf&lt;/tt&gt; &lt;a href=&quot;https://github.com/apache/spark/blob/master/core/src/main/scala/org/apache/spark/rdd/HadoopRDD.scala#L160&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. The method &lt;tt&gt;HadoopRDD.containsCachedMetadata&lt;/tt&gt; looks into an internal metadata cache - &lt;tt&gt;SparkEnv#hadoopJobMetadata&lt;/tt&gt;. This cache uses soft references, so the JVM may reclaim entries from the map whenever there is some GC pressure. In which case, any get request on the key will return a &lt;tt&gt;null&lt;/tt&gt;. The race condition is that the &lt;tt&gt;#getJobConf&lt;/tt&gt; method first checks if the cache contains the key, and then retrieves it. In between the &lt;tt&gt;containsKey&lt;/tt&gt; and &lt;tt&gt;get&lt;/tt&gt; its possible the the key is GCed by the JVM. This would cause &lt;tt&gt;#getJobConf&lt;/tt&gt; to return &lt;tt&gt;null&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;The fix should be pretty simple, don&apos;t use the &lt;tt&gt;containsKey(key)&lt;/tt&gt; method on the cache, just run a &lt;tt&gt;get(key)&lt;/tt&gt; and check if it returns &lt;tt&gt;null&lt;/tt&gt; or not.&lt;/p&gt;

&lt;p&gt;Happy to create a PR if other agrees with my analysis.&lt;/p&gt;</comment>
                            <comment id="16171009" author="kellyzly" created="Tue, 19 Sep 2017 02:17:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stakiar&quot; class=&quot;user-hover&quot; rel=&quot;stakiar&quot;&gt;stakiar&lt;/a&gt;:  &lt;br/&gt;
this exception happened on which query of tpcds?  I found in another benchmark test(TPCx-BB)&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;This cache uses soft references, so the JVM may reclaim entries from the map whenever there is some GC pressure. In which case, any get request on the key will return a null. The race condition is that the #getJobConf method first checks if the cache contains the key, and then retrieves. In between the containsKey and get its possible the the key is GCed by the JVM. &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;this exception is because &lt;tt&gt;HadoopRDD.containsCachedMetadata(jobConfCacheKey)&lt;/tt&gt; returns soft reference and it will return &lt;tt&gt;null&lt;/tt&gt; when GC happens? If it changes to &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ( HadoopRDD.getCachedMetadata(jobConfCacheKey) != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
        logDebug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Re-using cached JobConf&quot;&lt;/span&gt;)
        HadoopRDD.getCachedMetadata(jobConfCacheKey).asInstanceOf[JobConf]
      }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; HadoopRDD.getCachedMetadata(jobConfCacheKey) will not return null if GC happens?&lt;/p&gt;


</comment>
                            <comment id="16172747" author="stakiar" created="Wed, 20 Sep 2017 04:51:40 +0000"  >&lt;p&gt;I can&apos;t remember exactly which query, I was running a chain of about 10 TPC-DS queries, all in the same HoS session. It was a 1 TB Parquet dataset though.&lt;/p&gt;

&lt;p&gt;The exception is because &lt;tt&gt;HadoopRDD.containsCachedMetadata&lt;/tt&gt; can return &lt;tt&gt;true&lt;/tt&gt;, but then a future call to &lt;tt&gt;HadoopRDD.getCachedMetadata&lt;/tt&gt; on the same key, can return &lt;tt&gt;null&lt;/tt&gt;. This can happen if the JVM decided to GC some of the entires in the metadata cache (which it can since &lt;a href=&quot;https://docs.oracle.com/javase/7/docs/api/java/lang/ref/SoftReference.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;soft references&lt;/a&gt; are used).&lt;/p&gt;

&lt;p&gt;We would have to change it to something like:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
    &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; conf = HadoopRDD.getCachedMetadata(jobConfCacheKey)
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (conf != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
        logDebug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Re-using cached JobConf&quot;&lt;/span&gt;)
        HadoopRDD.getCachedMetadata(jobConfCacheKey).asInstanceOf[JobConf]
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;m not sure how to write it exactly in Scala, but something like that. Once you create &lt;tt&gt;Object conf&lt;/tt&gt; and point it to the result of &lt;tt&gt;HadoopRDD.getCachedMetdata(jobConfCacheKey)&lt;/tt&gt;, you then have a hard reference to the object and it can no longer be GCd.&lt;/p&gt;</comment>
                            <comment id="16179463" author="stakiar" created="Mon, 25 Sep 2017 18:08:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srowen&quot; class=&quot;user-hover&quot; rel=&quot;srowen&quot;&gt;srowen&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vanzin&quot; class=&quot;user-hover&quot; rel=&quot;vanzin&quot;&gt;vanzin&lt;/a&gt; does my analysis of this bug make sense? If you agree this is a bug, I can make a PR to fix it.&lt;/p&gt;</comment>
                            <comment id="16179498" author="vanzin" created="Mon, 25 Sep 2017 18:19:41 +0000"  >&lt;p&gt;Explanation makes sense, but your proposed solution is also race-prone (two calls to &lt;tt&gt;getCachedMetadata&lt;/tt&gt;). You want something like:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Option(HadoopRDD.getCachedMetadata(jobConfCacheKey)).getOrElse( &lt;span class=&quot;code-comment&quot;&gt;/* recover from when there&apos;s no cached metadata */&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16179535" author="stakiar" created="Mon, 25 Sep 2017 18:37:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vanzin&quot; class=&quot;user-hover&quot; rel=&quot;vanzin&quot;&gt;vanzin&lt;/a&gt; thanks for taking a look. Yes, you are right. I&apos;ll start working on a PR.&lt;/p&gt;</comment>
                            <comment id="16188827" author="apachespark" created="Mon, 2 Oct 2017 21:04:03 +0000"  >&lt;p&gt;User &apos;sahilTakiar&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/19413&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/19413&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12865082" name="NPE_log" size="8447" author="kellyzly" created="Wed, 26 Apr 2017 07:15:55 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 7 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3e45j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>