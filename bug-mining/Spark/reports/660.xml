<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:16:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-3277] LZ4 compression cause the the ExternalSort exception</title>
                <link>https://issues.apache.org/jira/browse/SPARK-3277</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;I tested the LZ4 compression,and it come up with such problem.(with wordcount)&lt;br/&gt;
Also I tested the snappy and LZF,and they were OK.&lt;br/&gt;
At last I set the  &quot;spark.shuffle.spill&quot; as false to avoid such exeception, but once open this &quot;switch&quot;, this error would come.&lt;br/&gt;
It seems that if num of the[ words is few, wordcount will go through,but if it is a complex text ,this problem will show&lt;br/&gt;
Exeception Info as follow:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.AssertionError: assertion failed
        at scala.Predef$.&lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt;(Predef.scala:165)
        at org.apache.spark.util.collection.ExternalAppendOnlyMap$DiskMapIterator.&amp;lt;init&amp;gt;(ExternalAppendOnlyMap.scala:416)
        at org.apache.spark.util.collection.ExternalAppendOnlyMap.spill(ExternalAppendOnlyMap.scala:235)
        at org.apache.spark.util.collection.ExternalAppendOnlyMap.insertAll(ExternalAppendOnlyMap.scala:150)
        at org.apache.spark.Aggregator.combineValuesByKey(Aggregator.scala:58)
        at org.apache.spark.shuffle.hash.HashShuffleWriter.write(HashShuffleWriter.scala:55)
        at org.apache.spark.scheduler.ShuffleMapTask.runTask(ShuffleMapTask.scala:68)
        at org.apache.spark.scheduler.ShuffleMapTask.runTask(ShuffleMapTask.scala:41)
        at org.apache.spark.scheduler.Task.run(Task.scala:54)
        at org.apache.spark.executor.Executor$TaskRunner.run(Executor.scala:177)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:722)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12737317">SPARK-3277</key>
            <summary>LZ4 compression cause the the ExternalSort exception</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="andrewor14">Andrew Or</assignee>
                                    <reporter username="carlmartin">Zhaowei Huang</reporter>
                        <labels>
                    </labels>
                <created>Thu, 28 Aug 2014 06:27:12 +0000</created>
                <updated>Wed, 5 Nov 2014 10:45:23 +0000</updated>
                            <resolved>Fri, 29 Aug 2014 00:06:29 +0000</resolved>
                                    <version>1.0.2</version>
                    <version>1.1.0</version>
                                    <fixVersion>1.1.0</fixVersion>
                                    <component>Shuffle</component>
                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="14113741" author="mridulm80" created="Thu, 28 Aug 2014 13:26:34 +0000"  >&lt;p&gt;This looks like unrelated changes pushed to BlockObjectWriter as part of introduction of ShuffleWriteMetrics.&lt;br/&gt;
I had introducing checks and also documented that we must not infer size based on position of stream after flush - since close can write data to the streams (and one flush can result in more data getting generated which need not be flushed to streams).&lt;/p&gt;

&lt;p&gt;Apparently this logic was modified subsequently causing this bug.&lt;br/&gt;
Solution would be to revert changes to update shuffleBytesWritten before close of stream.&lt;br/&gt;
It must be done after close and based on file.length&lt;/p&gt;</comment>
                            <comment id="14113789" author="carlmartin" created="Thu, 28 Aug 2014 14:24:15 +0000"  >&lt;p&gt;Sorry,I can not understand it clearly since I&apos;m not familiar with the code of this class.&lt;br/&gt;
Can you point the line number of the code where it goes wrong or make a pr to fix this problem &lt;/p&gt;</comment>
                            <comment id="14114014" author="mridulm80" created="Thu, 28 Aug 2014 17:34:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=matei&quot; class=&quot;user-hover&quot; rel=&quot;matei&quot;&gt;matei&lt;/a&gt; Attaching a patch which reproduces the bug consistently.&lt;br/&gt;
I suspect the issue is more serious than what I detailed above - spill to disk seems completely broken if I understood the assertion message correctly.&lt;br/&gt;
Unfortunately, this is based on a few minutes of free time I could grab - so a more principled debugging session is definitely warranted !&lt;/p&gt;
</comment>
                            <comment id="14114022" author="mridulm80" created="Thu, 28 Aug 2014 17:36:55 +0000"  >&lt;p&gt;Attached patch is against master, though I noticed similar changes in 1.1 also : but not yet verified.&lt;/p&gt;</comment>
                            <comment id="14114026" author="mridulm80" created="Thu, 28 Aug 2014 17:39:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hzw&quot; class=&quot;user-hover&quot; rel=&quot;hzw&quot;&gt;hzw&lt;/a&gt; did you notice this against 1.0.2 ?&lt;br/&gt;
I did not think the changes for consolidated shuffle were backported to that branch, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mateiz&quot; class=&quot;user-hover&quot; rel=&quot;mateiz&quot;&gt;mateiz&lt;/a&gt; can comment more though.&lt;/p&gt;</comment>
                            <comment id="14114039" author="andrewor14" created="Thu, 28 Aug 2014 17:43:56 +0000"  >&lt;p&gt;This assert was added after 1.0.2. I&apos;m assuming what you mean is that you&apos;re running a commit on master after 1.0.2 is released.&lt;/p&gt;</comment>
                            <comment id="14114247" author="matei" created="Thu, 28 Aug 2014 19:58:36 +0000"  >&lt;p&gt;Thanks Mridul &amp;#8211; I think Andrew and Patrick have figured this out.&lt;/p&gt;</comment>
                            <comment id="14114484" author="mridulm80" created="Thu, 28 Aug 2014 22:24:25 +0000"  >&lt;p&gt;Sounds great, thx !&lt;br/&gt;
I suspect it is because for lzo we configure it to write block on flush (partial if insufficient data to fill block); but for lz4, either such config does not exist or we dont use that.&lt;br/&gt;
Resulting in flush becoming noop in case the data in current block is insufficientto cause a compressed block to be created - while close will force patial block to be written out.&lt;/p&gt;

&lt;p&gt;Which is why the asserion lists all sizes as 0&lt;/p&gt;</comment>
                            <comment id="14114551" author="apachespark" created="Thu, 28 Aug 2014 23:00:43 +0000"  >&lt;p&gt;User &apos;andrewor14&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/2187&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/2187&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14114635" author="pwendell" created="Fri, 29 Aug 2014 00:06:29 +0000"  >&lt;p&gt;Fixed by &lt;a href=&quot;https://github.com/apache/spark/pull/2187&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/2187&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Thanks to everyone who helped isolate and debug this.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12665024" name="test_lz4_bug.patch" size="1877" author="mridulm80" created="Thu, 28 Aug 2014 17:36:55 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 12 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1zfg7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>