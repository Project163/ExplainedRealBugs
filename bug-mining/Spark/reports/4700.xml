<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:52:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-19556] Broadcast data is not encrypted when I/O encryption is on</title>
                <link>https://issues.apache.org/jira/browse/SPARK-19556</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;&lt;tt&gt;TorrentBroadcast&lt;/tt&gt; uses a couple of &quot;back doors&quot; into the block manager to write and read data:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!blockManager.putBytes(pieceId, bytes, MEMORY_AND_DISK_SER, tellMaster = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)) {
        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SparkException(s&lt;span class=&quot;code-quote&quot;&gt;&quot;Failed to store $pieceId of $broadcastId in local BlockManager&quot;&lt;/span&gt;)
      }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;      bm.getLocalBytes(pieceId) match {
        &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; Some(block) =&amp;gt;
          blocks(pid) = block
          releaseLock(pieceId)
        &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; None =&amp;gt;
          bm.getRemoteBytes(pieceId) match {
            &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; Some(b) =&amp;gt;
              &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (checksumEnabled) {
                val sum = calcChecksum(b.chunks(0))
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (sum != checksums(pid)) {
                  &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SparkException(s&lt;span class=&quot;code-quote&quot;&gt;&quot;corrupt remote block $pieceId of $broadcastId:&quot;&lt;/span&gt; +
                    s&lt;span class=&quot;code-quote&quot;&gt;&quot; $sum != ${checksums(pid)}&quot;&lt;/span&gt;)
                }
              }
              &lt;span class=&quot;code-comment&quot;&gt;// We found the block from remote executors/driver&apos;s BlockManager, so put the block
&lt;/span&gt;              &lt;span class=&quot;code-comment&quot;&gt;// in &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; executor&apos;s BlockManager.
&lt;/span&gt;              &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!bm.putBytes(pieceId, b, StorageLevel.MEMORY_AND_DISK_SER, tellMaster = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)) {
                &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SparkException(
                  s&lt;span class=&quot;code-quote&quot;&gt;&quot;Failed to store $pieceId of $broadcastId in local BlockManager&quot;&lt;/span&gt;)
              }
              blocks(pid) = b
            &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; None =&amp;gt;
              &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SparkException(s&lt;span class=&quot;code-quote&quot;&gt;&quot;Failed to get $pieceId of $broadcastId&quot;&lt;/span&gt;)
          }
      }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The thing these block manager methods have in common is that they bypass the encryption code; so broadcast data is stored unencrypted in the block manager, causing unencrypted data to be written to disk if those blocks need to be evicted from memory.&lt;/p&gt;

&lt;p&gt;The correct fix here is actually not to change &lt;tt&gt;TorrentBroadcast&lt;/tt&gt;, but to fix the block manager so that:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;data stored in memory is not encrypted&lt;/li&gt;
	&lt;li&gt;data written to disk is encrypted&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This would simplify the code paths that use BlockManager / SerializerManager APIs (e.g. see &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-19520&quot; title=&quot;WAL should not be encrypted&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-19520&quot;&gt;&lt;del&gt;SPARK-19520&lt;/del&gt;&lt;/a&gt;), but requires some tricky changes inside the BlockManager to still be able to use file channels to avoid reading whole blocks back into memory so they can be decrypted.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13042208">SPARK-19556</key>
            <summary>Broadcast data is not encrypted when I/O encryption is on</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="vanzin">Marcelo Masiero Vanzin</assignee>
                                    <reporter username="vanzin">Marcelo Masiero Vanzin</reporter>
                        <labels>
                    </labels>
                <created>Fri, 10 Feb 2017 22:56:53 +0000</created>
                <updated>Wed, 29 Mar 2017 12:28:40 +0000</updated>
                            <resolved>Wed, 29 Mar 2017 12:28:40 +0000</resolved>
                                    <version>2.1.0</version>
                                    <fixVersion>2.2.0</fixVersion>
                                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15867152" author="unclegen" created="Wed, 15 Feb 2017 03:32:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vanzin&quot; class=&quot;user-hover&quot; rel=&quot;vanzin&quot;&gt;vanzin&lt;/a&gt; I am working on this, could you please assign it to me?&lt;/p&gt;</comment>
                            <comment id="15867161" author="vanzin" created="Wed, 15 Feb 2017 03:41:29 +0000"  >&lt;p&gt;We don&apos;t generally assign bugs. Leaving a message should be enough in case anyone else was also thinking about working on it.&lt;/p&gt;</comment>
                            <comment id="15871134" author="apachespark" created="Fri, 17 Feb 2017 04:02:03 +0000"  >&lt;p&gt;User &apos;uncleGen&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/16972&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/16972&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15925067" author="apachespark" created="Tue, 14 Mar 2017 21:40:04 +0000"  >&lt;p&gt;User &apos;vanzin&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/17295&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/17295&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15947025" author="cloud_fan" created="Wed, 29 Mar 2017 12:28:40 +0000"  >&lt;p&gt;Issue resolved by pull request 17295&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/17295&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/17295&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 33 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i39xmf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>