<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:55:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-21595] introduction of spark.sql.windowExec.buffer.spill.threshold in spark 2.2 breaks existing workflow</title>
                <link>https://issues.apache.org/jira/browse/SPARK-21595</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;My pyspark code has the following statement:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;# assign row key &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; tracking
df = df.withColumn(
        &lt;span class=&quot;code-quote&quot;&gt;&apos;association_idx&apos;&lt;/span&gt;,
        sqlf.row_number().over(
            Window.orderBy(&lt;span class=&quot;code-quote&quot;&gt;&apos;uid1&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;uid2&apos;&lt;/span&gt;)
        )
    )
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;where df is a long, skinny (450M rows, 10 columns) dataframe. So this creates one large window for the whole dataframe to sort over.&lt;br/&gt;
In spark 2.1 this works without problem, in spark 2.2 this fails either with out of memory exception or too many open files exception, depending on memory settings (which is what I tried first to fix this).&lt;br/&gt;
Monitoring the blockmgr, I see that spark 2.1 creates 152 files, spark 2.2 creates &amp;gt;110,000 files.&lt;br/&gt;
In the log I see the following messages (110,000 of these):&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;17/08/01 08:55:37 INFO UnsafeExternalSorter: Spilling data because number of spilledRecords crossed the threshold 4096
17/08/01 08:55:37 INFO UnsafeExternalSorter: Thread 156 spilling sort data of 64.1 MB to disk (0  time so far)
17/08/01 08:55:37 INFO UnsafeExternalSorter: Spilling data because number of spilledRecords crossed the threshold 4096
17/08/01 08:55:37 INFO UnsafeExternalSorter: Thread 156 spilling sort data of 64.1 MB to disk (1  time so far)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So I started hunting for clues in UnsafeExternalSorter, without luck. What I had missed was this one message:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;17/08/01 08:55:37 INFO ExternalAppendOnlyUnsafeRowArray: Reached spill threshold of 4096 rows, switching to org.apache.spark.util.collection.unsafe.sort.UnsafeExternalSorter
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Which allowed me to track down the issue. &lt;br/&gt;
By changing the configuration to include:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;spark.sql.windowExec.buffer.spill.threshold	2097152
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I got it to work again and with the same performance as spark 2.1.&lt;br/&gt;
I have workflows where I use windowing functions that do not fail, but took a performance hit due to the excessive spilling when using the default of 4096.&lt;br/&gt;
I think to make it easier to track down these issues this config variable should be included in the configuration documentation. &lt;br/&gt;
Maybe 4096 is too small of a default value?&lt;/p&gt;</description>
                <environment>&lt;p&gt;pyspark on linux&lt;/p&gt;</environment>
        <key id="13091590">SPARK-21595</key>
            <summary>introduction of spark.sql.windowExec.buffer.spill.threshold in spark 2.2 breaks existing workflow</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tejasp">Tejas Patil</assignee>
                                    <reporter username="sreiling">Stephan Reiling</reporter>
                        <labels>
                            <label>documentation</label>
                            <label>regression</label>
                    </labels>
                <created>Tue, 1 Aug 2017 15:29:03 +0000</created>
                <updated>Wed, 21 Feb 2024 13:34:29 +0000</updated>
                            <resolved>Fri, 11 Aug 2017 20:02:04 +0000</resolved>
                                    <version>2.2.0</version>
                                    <fixVersion>2.2.1</fixVersion>
                    <fixVersion>2.3.0</fixVersion>
                                    <component>Documentation</component>
                    <component>PySpark</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="16110053" author="tejasp" created="Wed, 2 Aug 2017 00:40:27 +0000"  >&lt;p&gt;This config was introduced by me in &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-13450&quot; title=&quot;SortMergeJoin will OOM when join rows have lot of same keys&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-13450&quot;&gt;&lt;del&gt;SPARK-13450&lt;/del&gt;&lt;/a&gt;. The reason why 4096 was used is because before the change it was using 4096 as threshold to switch to `UnsafeExternalSorter` (see WindowExec.scala in &lt;a href=&quot;https://github.com/apache/spark/pull/16909/files&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/16909/files&lt;/a&gt;). I don&apos;t have real workloads which use WINDOW operator so would defer from proposing a value but I am open to change the default value to something that works well for everyone. After you bumped up the config, how many files were generated ? I want to know what value would effectively create the same number of files as spark 2.1 did.&lt;/p&gt;</comment>
                            <comment id="16113388" author="hvanhovell" created="Thu, 3 Aug 2017 19:59:49 +0000"  >&lt;p&gt;The old and the new code are not exactly the same. The old code path would start using a disk spilling buffer when a window would become larger than 4096 rows. The key difference is that old code path would not start to spill at that point, that would only happen when the Spark would get pressed for memory and the memory manager starts to force spills. The current version is overly active and starts spilling at a much earlier stage. We have seen similar problems with customer workloads on our end.&lt;/p&gt;

&lt;p&gt;We either need to set this to a more sensible default, or return this to the old behavior.&lt;/p&gt;</comment>
                            <comment id="16113622" author="tejasp" created="Thu, 3 Aug 2017 22:36:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hvanhovell&quot; class=&quot;user-hover&quot; rel=&quot;hvanhovell&quot;&gt;hvanhovell&lt;/a&gt; : I am fine with either options you mentioned. &lt;/p&gt;

&lt;p&gt;one more option: Right now the (switch from in-memory to `UnsafeExternalSorter`) and (`UnsafeExternalSorter` spilling to disk) is controlled by a single threshold. If we de-couple those two using separate thresholds, then the &quot;spill on memory pressure&quot; behavior will be achieved. The threshold for in-memory can be kept small and keeping the spilling to disk higher will avoid excessive disk spills. This is fairly simple change to do. What do you think ?&lt;/p&gt;</comment>
                            <comment id="16114255" author="sreiling" created="Fri, 4 Aug 2017 11:15:30 +0000"  >&lt;p&gt;I have tried out a couple of settings for spark.sql.windowExec.buffer.spill.threshold and I have now settled on 4M as the default for it in my workflows. This gives about the same behavior as spark 2.1. But this is dependent on the amount of spark memory and the size of the rows in the dataframe.&lt;br/&gt;
I am not in favor of introducing another threshold for this. If the spilling is delayed, but then happens with the low threshold of 4096 rows, in my case this would still spill 110k files to disk and potentially cause a &quot;too many open files&quot; exception (right ?).&lt;br/&gt;
Just looking at the spilling behavior, it would be better if the value would not specify the number of rows, but the amount of memory. So instead of 4096 rows, it would specify 500MB of memory, and then spill chunks of 500MB to disk. How many rows this is would change case by case.&lt;/p&gt;</comment>
                            <comment id="16114694" author="tejasp" created="Fri, 4 Aug 2017 17:40:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sreiling&quot; class=&quot;user-hover&quot; rel=&quot;sreiling&quot;&gt;sreiling&lt;/a&gt; Spilling will happen only when &lt;em&gt;both&lt;/em&gt; these are met:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;number of records exceeds the limit of in-memory array. Earlier this was hardcoded to be 4096, with the change it will be configurable (default value = 4096).&lt;/li&gt;
	&lt;li&gt;there is less memory on the executors due to many consumers OR a spill threshold based on number of records has reached (this was always configurable and defaulted to `UnsafeExternalSorter.DEFAULT_NUM_ELEMENTS_FOR_SPILL_THRESHOLD`).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This was what used to happen in v2.1 and what I am proposing. The second criteria takes care of looking at the actual memory utilization (spill threshold value used to be defaulted to a super large value so typically the memory pressure situation kicks in before that).&lt;/p&gt;

&lt;p&gt;Here is a PR for that : &lt;a href=&quot;https://github.com/apache/spark/pull/18843&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/18843&lt;/a&gt; Please take a look and share your feedback.&lt;/p&gt;</comment>
                            <comment id="17088302" author="rakesh_shah" created="Tue, 21 Apr 2020 05:14:29 +0000"  >&lt;p&gt;Hi&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sreiling&quot; class=&quot;user-hover&quot; rel=&quot;sreiling&quot;&gt;sreiling&lt;/a&gt; I am also facing same issue where my shuffle is taking a long time,&lt;/p&gt;

&lt;p&gt;Here I am joining two tables in spark, but before this point there is a window function being used.&lt;/p&gt;

&lt;p&gt;When I debugged i saw this below info, when I tried to change the property I am not able to change it, it still shows same.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;20/04/21 04:15:18 INFO Executor: Finished task 935.0 in stage 43.0 (TID 28873). 26714 bytes result sent to driver&lt;br/&gt;
20/04/21 04:18:20 INFO ExternalAppendOnlyUnsafeRowArray: Reached spill threshold of 4096 rows, switching to org.apache.spark.util.collection.unsafe.sort.UnsafeExternalSorter&lt;br/&gt;
20/04/21 04:18:20 INFO ExternalAppendOnlyUnsafeRowArray: Reached spill threshold of 4096 rows, switching to org.apache.spark.util.collection.unsafe.sort.UnsafeExternalSorter&lt;br/&gt;
20/04/21 04:18:20 INFO ExternalAppendOnlyUnsafeRowArray: Reached spill threshold of 4096 rows, switching to org.apache.spark.util.collection.unsafe.sort.UnsafeExternalSorter&lt;br/&gt;
20/04/21 04:20:49 INFO ExternalAppendOnlyUnsafeRowArray: Reached spill threshold of 4096 rows, switching to org.apache.spark.util.collection.unsafe.sort.UnsafeExternalSorter&lt;br/&gt;
20/04/21 04:20:49 INFO ExternalAppendOnlyUnsafeRowArray: Reached spill threshold of 4096 rows, switching to org.apache.spark.util.collection.unsafe.sort.UnsafeExternalSorter&lt;br/&gt;
20/04/21 04:20:49 INFO ExternalAppendOnlyUnsafeRowArray: Reached spill threshold of 4096 rows, switching to org.apache.spark.util.collection.uns&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;can you please help me with this.&lt;/p&gt;</comment>
                            <comment id="17819249" author="hande" created="Wed, 21 Feb 2024 13:33:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Rakesh_Shah&quot; class=&quot;user-hover&quot; rel=&quot;Rakesh_Shah&quot;&gt;Rakesh_Shah&lt;/a&gt;&#160; How did you manage to solve this ? I am getting this in my streaming query, it does aggregations similar to other streaming queries in same job. However it fails and I get&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

{&quot;timestamp&quot;:&quot;21/02/2024 07:11:35&quot;,&quot;logLevel&quot;:&quot;ERROR&quot;,&quot;class&quot;:&quot;MapOutputTracker&quot;,&quot;thread&quot;:&quot;Executor task launch worker for task 25.0 in stage 2.1 (TID 75)&quot;,&quot;message&quot;:&quot;Missing an output location for shuffle 5 partition 35&quot;}

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Can you please help ?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tejasp&quot; class=&quot;user-hover&quot; rel=&quot;tejasp&quot;&gt;tejasp&lt;/a&gt;&#160; Can you please help ?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;My spark version is 3.4.0&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 37 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3i9tz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>