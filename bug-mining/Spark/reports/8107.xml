<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:27:17 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-36339] aggsBuffer should collect AggregateExpression in the map range</title>
                <link>https://issues.apache.org/jira/browse/SPARK-36339</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;show demo for this ISSUE:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// SQL without error
&lt;/span&gt;
SELECT name, count(name) c
FROM VALUES (&lt;span class=&quot;code-quote&quot;&gt;&apos;Alice&apos;&lt;/span&gt;), (&lt;span class=&quot;code-quote&quot;&gt;&apos;Bob&apos;&lt;/span&gt;) people(name)
GROUP BY name GROUPING SETS(name);

&lt;span class=&quot;code-comment&quot;&gt;// An error is reported after exchanging the order of the query columns:
&lt;/span&gt;
SELECT count(name) c, name
FROM VALUES (&lt;span class=&quot;code-quote&quot;&gt;&apos;Alice&apos;&lt;/span&gt;), (&lt;span class=&quot;code-quote&quot;&gt;&apos;Bob&apos;&lt;/span&gt;) people(name)
GROUP BY name GROUPING SETS(name);

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The error message is&#65306;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Error in query: expression &lt;span class=&quot;code-quote&quot;&gt;&apos;people.`name`&apos;&lt;/span&gt; is neither present in the group by, nor is it an aggregate function. Add to group by or wrap in first() (or first_value) &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; you don&apos;t care which value you get.;;
Aggregate [name#5, spark_grouping_id#3], [count(name#1) AS c#0L, name#1]
+- Expand [List(name#1, name#4, 0)], [name#1, name#5, spark_grouping_id#3]
   +- Project [name#1, name#1 AS name#4]
      +- SubqueryAlias `people`
         +- LocalRelation [name#1]

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;So far, I have checked that there is no problem before version 2.3.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;During debugging, I found that the behavior of constructAggregateExprs in ResolveGroupingAnalytics has changed.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    /*
     * Construct &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; aggregate expressions by replacing grouping functions.
     */
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; def constructAggregateExprs(
        groupByExprs: Seq[Expression],
        aggregations: Seq[NamedExpression],
        groupByAliases: Seq[Alias],
        groupingAttrs: Seq[Expression],
        gid: Attribute): Seq[NamedExpression] = aggregations.map {
      &lt;span class=&quot;code-comment&quot;&gt;// collect all the found AggregateExpression, so we can check an expression is part of
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// any AggregateExpression or not.
&lt;/span&gt;      val aggsBuffer = ArrayBuffer[Expression]()
      &lt;span class=&quot;code-comment&quot;&gt;// Returns whether the expression belongs to any expressions in `aggsBuffer` or not.
&lt;/span&gt;      def isPartOfAggregation(e: Expression): &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt; = {
        aggsBuffer.exists(a =&amp;gt; a.find(_ eq e).isDefined)
      }
      replaceGroupingFunc(_, groupByExprs, gid).transformDown {
        &lt;span class=&quot;code-comment&quot;&gt;// AggregateExpression should be computed on the unmodified value of its argument
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// expressions, so we should not replace any references to grouping expression
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// inside it.
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; e: AggregateExpression =&amp;gt;
          aggsBuffer += e
          e
        &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; e &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; isPartOfAggregation(e) =&amp;gt; e
        &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; e =&amp;gt;
          &lt;span class=&quot;code-comment&quot;&gt;// Replace expression by expand output attribute.
&lt;/span&gt;          val index = groupByAliases.indexWhere(_.child.semanticEquals(e))
          &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (index == -1) {
            e
          } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
            groupingAttrs(index)
          }
      }.asInstanceOf[NamedExpression]
    }

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;When performing aggregations.map, the aggsBuffer here seems to be outside the scope of the map. It can store the AggregateExpression of all the elements processed by the map function, but this is not before 2.3.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13392454">SPARK-36339</key>
            <summary>aggsBuffer should collect AggregateExpression in the map range</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gaoyajun02">gaoyajun02</assignee>
                                    <reporter username="gaoyajun02">gaoyajun02</reporter>
                        <labels>
                            <label>grouping</label>
                    </labels>
                <created>Thu, 29 Jul 2021 04:51:24 +0000</created>
                <updated>Wed, 1 Sep 2021 04:49:59 +0000</updated>
                            <resolved>Fri, 6 Aug 2021 08:35:25 +0000</resolved>
                                    <version>2.4.8</version>
                    <version>3.0.3</version>
                    <version>3.1.2</version>
                                    <fixVersion>3.2.0</fixVersion>
                    <fixVersion>3.1.3</fixVersion>
                    <fixVersion>3.0.4</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17389746" author="apachespark" created="Thu, 29 Jul 2021 08:23:15 +0000"  >&lt;p&gt;User &apos;gaoyajun02&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/33574&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/33574&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17394625" author="cloud_fan" created="Fri, 6 Aug 2021 08:35:25 +0000"  >&lt;p&gt;Issue resolved by pull request 33574&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/33574&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/33574&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17394657" author="apachespark" created="Fri, 6 Aug 2021 09:37:49 +0000"  >&lt;p&gt;User &apos;gaoyajun02&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/33667&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/33667&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17394709" author="apachespark" created="Fri, 6 Aug 2021 11:17:03 +0000"  >&lt;p&gt;User &apos;gaoyajun02&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/33669&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/33669&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17407816" author="apachespark" created="Wed, 1 Sep 2021 04:49:59 +0000"  >&lt;p&gt;User &apos;gaoyajun02&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/33884&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/33884&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 10 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0tfg0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12349602">3.1.2</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>