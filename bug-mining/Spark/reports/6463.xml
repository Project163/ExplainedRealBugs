<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:05:16 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-27347] Fix supervised driver retry logic when agent crashes/restarts</title>
                <link>https://issues.apache.org/jira/browse/SPARK-27347</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Ran into scenarios where&#160;&lt;tt&gt;--supervised&lt;/tt&gt;&#160;Spark jobs were retried multiple times when an agent would crash, come back, and re-register even when those jobs had already relaunched on a different agent.&lt;/p&gt;

&lt;p&gt;That is:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;supervised driver is running on agent1&lt;/li&gt;
	&lt;li&gt;agent1 crashes&lt;/li&gt;
	&lt;li&gt;driver is relaunched on another agent as `&amp;lt;task-id&amp;gt;-retry-1`&lt;/li&gt;
	&lt;li&gt;agent1 comes back online and re-registers with scheduler&lt;/li&gt;
	&lt;li&gt;spark relaunches the same job as `&amp;lt;task-id&amp;gt;-retry-2`&lt;/li&gt;
	&lt;li&gt;now there are two jobs running simultaneously and the first retry job is effectively orphaned within Zookeeper&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This is because when an agent&#160;comes back and re-registers, it&#160;sends a status update&#160;&lt;tt&gt;TASK_FAILED&lt;/tt&gt;&#160;for its old driver-task. Previous logic would indiscriminately remove the&#160;&lt;tt&gt;submissionId from Zookeeper&apos;s launchedDrivers&lt;/tt&gt;&#160;node and add it to&#160;&lt;tt&gt;retryList&lt;/tt&gt;&#160;node.&lt;/p&gt;

&lt;p&gt;Then, when a new offer came in, it would relaunch another -retry&#160;task even though one was previously running.&lt;/p&gt;

&lt;p&gt;Sample log looks something like this:&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
19/01/15 19:21:38 TRACE MesosClusterScheduler: Received offers from Mesos: 
... [offers] ...
19/01/15 19:21:39 TRACE MesosClusterScheduler: Using offer 5d421001-0630-4214-9ecb-d5838a2ec149-O2532 to launch driver driver-20190115192138-0001 with taskId: value: &lt;span class=&quot;code-quote&quot;&gt;&quot;driver-20190115192138-0001&quot;&lt;/span&gt;
...
19/01/15 19:21:42 INFO MesosClusterScheduler: Received status update: taskId=driver-20190115192138-0001 state=TASK_STARTING message=&apos;&apos;
19/01/15 19:21:43 INFO MesosClusterScheduler: Received status update: taskId=driver-20190115192138-0001 state=TASK_RUNNING message=&apos;&apos;
...
19/01/15 19:29:12 INFO MesosClusterScheduler: Received status update: taskId=driver-20190115192138-0001 state=TASK_LOST message=&lt;span class=&quot;code-quote&quot;&gt;&apos;health check timed out&apos;&lt;/span&gt; reason=REASON_SLAVE_REMOVED
...
19/01/15 19:31:12 TRACE MesosClusterScheduler: Using offer 5d421001-0630-4214-9ecb-d5838a2ec149-O2681 to launch driver driver-20190115192138-0001 with taskId: value: &lt;span class=&quot;code-quote&quot;&gt;&quot;driver-20190115192138-0001-retry-1&quot;&lt;/span&gt;
...
19/01/15 19:31:15 INFO MesosClusterScheduler: Received status update: taskId=driver-20190115192138-0001-retry-1 state=TASK_STARTING message=&apos;&apos;
19/01/15 19:31:16 INFO MesosClusterScheduler: Received status update: taskId=driver-20190115192138-0001-retry-1 state=TASK_RUNNING message=&apos;&apos;
...
19/01/15 19:33:45 INFO MesosClusterScheduler: Received status update: taskId=driver-20190115192138-0001 state=TASK_FAILED message=&lt;span class=&quot;code-quote&quot;&gt;&apos;Unreachable agent re-reregistered&apos;&lt;/span&gt;
...
19/01/15 19:33:45 INFO MesosClusterScheduler: Received status update: taskId=driver-20190115192138-0001 state=TASK_FAILED message=&lt;span class=&quot;code-quote&quot;&gt;&apos;Abnormal executor termination: unknown container&apos;&lt;/span&gt; reason=REASON_EXECUTOR_TERMINATED
19/01/15 19:33:45 ERROR MesosClusterScheduler: Unable to find driver with driver-20190115192138-0001 in status update
...
19/01/15 19:33:47 TRACE MesosClusterScheduler: Using offer 5d421001-0630-4214-9ecb-d5838a2ec149-O2729 to launch driver driver-20190115192138-0001 with taskId: value: &lt;span class=&quot;code-quote&quot;&gt;&quot;driver-20190115192138-0001-retry-2&quot;&lt;/span&gt;
...
19/01/15 19:33:50 INFO MesosClusterScheduler: Received status update: taskId=driver-20190115192138-0001-retry-2 state=TASK_STARTING message=&apos;&apos;
19/01/15 19:33:51 INFO MesosClusterScheduler: Received status update: taskId=driver-20190115192138-0001-retry-2 state=TASK_RUNNING message=&apos;&apos;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13225564">SPARK-27347</key>
            <summary>Fix supervised driver retry logic when agent crashes/restarts</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stran">Sam Tran</assignee>
                                    <reporter username="stran">Sam Tran</reporter>
                        <labels>
                    </labels>
                <created>Tue, 2 Apr 2019 15:31:33 +0000</created>
                <updated>Fri, 10 May 2019 17:58:05 +0000</updated>
                            <resolved>Fri, 10 May 2019 17:56:43 +0000</resolved>
                                    <version>2.2.1</version>
                    <version>2.3.2</version>
                    <version>2.4.0</version>
                                    <fixVersion>2.3.4</fixVersion>
                    <fixVersion>2.4.4</fixVersion>
                    <fixVersion>3.0.0</fixVersion>
                                    <component>Mesos</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="16837490" author="dongjoon" created="Fri, 10 May 2019 17:56:43 +0000"  >&lt;p&gt;This is resolved via &lt;a href=&quot;https://github.com/apache/spark/pull/24276&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/24276&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 27 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z01ddc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>