<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:31:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-41914] Sorting issue with partitioned-writing and planned write optimization disabled</title>
                <link>https://issues.apache.org/jira/browse/SPARK-41914</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Spark 3.4.0 introduced option &lt;tt&gt;spark.sql.optimizer.plannedWrite.enabled&lt;/tt&gt;, which is enabled by default. When disabled, partitioned writing loses in-partition order when spilling occurs.&lt;/p&gt;

&lt;p&gt;This is related to &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-40885&quot; title=&quot;Spark will filter out data field sorting when dynamic partitions and data fields are sorted at the same time&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-40885&quot;&gt;&lt;del&gt;SPARK-40885&lt;/del&gt;&lt;/a&gt; where setting option &lt;tt&gt;spark.sql.optimizer.plannedWrite.enabled&lt;/tt&gt; to &lt;tt&gt;true&lt;/tt&gt; will remove the existing sort (for &lt;tt&gt;day&lt;/tt&gt; and &lt;tt&gt;id&lt;/tt&gt;) entirely.&lt;/p&gt;

&lt;p&gt;Run this with 512m memory and one executor, e.g.:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
spark-shell --driver-memory 512m --master &lt;span class=&quot;code-quote&quot;&gt;&quot;local[1]&quot;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-scala&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.sql.SaveMode

spark.conf.set(&lt;span class=&quot;code-quote&quot;&gt;&quot;spark.sql.optimizer.plannedWrite.enabled&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)

&lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; ids = 2000000
&lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; days = 2
&lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; parts = 2

&lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; ds = spark.range(0, days, 1, parts).withColumnRenamed(&lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;day&quot;&lt;/span&gt;).join(spark.range(0, ids, 1, parts))

ds.repartition($&lt;span class=&quot;code-quote&quot;&gt;&quot;day&quot;&lt;/span&gt;)
  .sortWithinPartitions($&lt;span class=&quot;code-quote&quot;&gt;&quot;day&quot;&lt;/span&gt;, $&lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;)
  .write
  .partitionBy(&lt;span class=&quot;code-quote&quot;&gt;&quot;day&quot;&lt;/span&gt;)
  .mode(SaveMode.Overwrite)
  .csv(&lt;span class=&quot;code-quote&quot;&gt;&quot;interleaved.csv&quot;&lt;/span&gt;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Check the written files are sorted (states OK when file is sorted):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-bash&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;for&lt;/span&gt; file &lt;span class=&quot;code-object&quot;&gt;in&lt;/span&gt; interleaved.csv/day\=*/part-*
&lt;span class=&quot;code-object&quot;&gt;do&lt;/span&gt;
  echo &lt;span class=&quot;code-quote-red&quot;&gt;&quot;$(sort -n &quot;&lt;/span&gt;&lt;span class=&quot;code-object&quot;&gt;$file&lt;/span&gt;&lt;span class=&quot;code-quote-red&quot;&gt;&quot; | md5sum | cut -d &quot;&lt;/span&gt; &lt;span class=&quot;code-quote-red&quot;&gt;&quot; -f 1)  &lt;span class=&quot;code-object&quot;&gt;$file&lt;/span&gt;&quot;&lt;/span&gt;
&lt;span class=&quot;code-object&quot;&gt;done&lt;/span&gt; | md5sum -c
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Files should look like this&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
0
1
2
...
1048576
1048577
1048578
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;But they look like&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
0
1048576
1
1048577
2
1048578
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The cause issue is the same as in &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-40588&quot; title=&quot;Sorting issue with partitioned-writing and AQE turned on&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-40588&quot;&gt;&lt;del&gt;SPARK-40588&lt;/del&gt;&lt;/a&gt;. A sort (for &lt;tt&gt;day&lt;/tt&gt;) is added on top of the existing sort (for &lt;tt&gt;day&lt;/tt&gt; and &lt;tt&gt;id&lt;/tt&gt;). Spilling interleaves the sorted spill files.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Sort [input[0, bigint, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;] ASC NULLS FIRST], &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, 0
+- AdaptiveSparkPlan isFinalPlan=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
   +- Sort [day#2L ASC NULLS FIRST, id#4L ASC NULLS FIRST], &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, 0
      +- Exchange hashpartitioning(day#2L, 200), REPARTITION_BY_COL, [plan_id=30]
         +- BroadcastNestedLoopJoin BuildLeft, Inner
            :- BroadcastExchange IdentityBroadcastMode, [plan_id=28]
            :  +- Project [id#0L AS day#2L]
            :     +- Range (0, 2, step=1, splits=2)
            +- Range (0, 2000000, step=1, splits=2)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13516724">SPARK-41914</key>
            <summary>Sorting issue with partitioned-writing and planned write optimization disabled</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="enricomi">Enrico Minack</assignee>
                                    <reporter username="enricomi">Enrico Minack</reporter>
                        <labels>
                            <label>correctness</label>
                    </labels>
                <created>Thu, 5 Jan 2023 21:05:03 +0000</created>
                <updated>Fri, 2 Aug 2024 02:47:21 +0000</updated>
                            <resolved>Tue, 10 Jan 2023 05:10:26 +0000</resolved>
                                    <version>3.4.0</version>
                                    <fixVersion>3.4.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17655428" author="apachespark" created="Fri, 6 Jan 2023 12:33:49 +0000"  >&lt;p&gt;User &apos;EnricoMi&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/39431&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/39431&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17656419" author="cloud_fan" created="Tue, 10 Jan 2023 05:10:26 +0000"  >&lt;p&gt;Issue resolved by pull request 39431&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/39431&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/39431&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13587645">SPARK-49091</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 44 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1ekls:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>