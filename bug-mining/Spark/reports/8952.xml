<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:32:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-42753] ReusedExchange refers to non-existent node</title>
                <link>https://issues.apache.org/jira/browse/SPARK-42753</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;There is an AQE &#8220;issue&#8220; where during AQE planning, the Exchange &quot;that&apos;s being&quot; reused could be replaced in the plan tree. So, when we print the query plan, the ReusedExchange will refer to an &#8220;unknown&#8220; Exchange. An example below:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
(2775) ReusedExchange [Reuses &lt;span class=&quot;code-keyword&quot;&gt;operator&lt;/span&gt; id: unknown]
&#160;Output [3]: [sr_customer_sk#271, sr_store_sk#275, sum#377L]&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Below is an example to demonstrate the root cause:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
AdaptiveSparkPlan
&#160; |-- SomeNode X (subquery xxx)
&#160; &#160; &#160; |-- Exchange A
&#160; &#160; &#160; &#160; &#160; |-- SomeNode Y
&#160; &#160; &#160; &#160; &#160; &#160; &#160; |-- Exchange B
Subquery:Hosting &lt;span class=&quot;code-keyword&quot;&gt;operator&lt;/span&gt; = SomeNode Hosting Expression = xxx dynamicpruning#388
AdaptiveSparkPlan
&#160; |-- SomeNode M
&#160; &#160; &#160; |-- Exchange C
&#160; &#160; &#160; &#160; &#160; |-- SomeNode N
&#160; &#160; &#160; &#160; &#160; &#160; &#160; |-- Exchange D
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Step 1: Exchange B is materialized and the QueryStage is added to stage cache&lt;/p&gt;

&lt;p&gt;Step 2: Exchange D reuses Exchange B&lt;/p&gt;

&lt;p&gt;Step 3: Exchange C is materialized and the QueryStage is added to stage cache&lt;/p&gt;

&lt;p&gt;Step 4: Exchange A reuses Exchange C&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Then the final plan looks like:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
AdaptiveSparkPlan
&#160; |-- SomeNode X (subquery xxx)
&#160; &#160; &#160; |-- Exchange A -&amp;gt; ReusedExchange (reuses Exchange C)

Subquery:Hosting &lt;span class=&quot;code-keyword&quot;&gt;operator&lt;/span&gt; = SomeNode Hosting Expression = xxx dynamicpruning#388
AdaptiveSparkPlan
&#160; |-- SomeNode M
&#160; &#160; &#160; |-- Exchange C -&amp;gt; PhotonShuffleMapStage ....
&#160; &#160; &#160; &#160; &#160; |-- SomeNode N
&#160; &#160; &#160; &#160; &#160; &#160; &#160; |-- Exchange D -&amp;gt; ReusedExchange (reuses Exchange B)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;As a result, the ReusedExchange (reuses Exchange B) will refer to a non-exist node. This &lt;b&gt;DOES NOT&lt;/b&gt; affect query execution but will cause the query visualization malfunction in the following ways:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;The ReusedExchange child subtree will still appear in the Spark UI graph but will contain no node IDs.&lt;/li&gt;
	&lt;li&gt;The ReusedExchange node details in the Explain plan will refer to a UNKNOWN node. Example below.&lt;/li&gt;
&lt;/ol&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
(2775) ReusedExchange [Reuses &lt;span class=&quot;code-keyword&quot;&gt;operator&lt;/span&gt; id: unknown]&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;ol&gt;
	&lt;li&gt;The child exchange and its subtree may be missing from the Explain text completely. No node details or tree string shown.&lt;/li&gt;
&lt;/ol&gt;
</description>
                <environment></environment>
        <key id="13528042">SPARK-42753</key>
            <summary>ReusedExchange refers to non-existent node</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="3" iconUrl="https://issues.apache.org/jira/images/icons/statuses/inprogress.png" description="This issue is being actively worked on at the moment by the assignee.">In Progress</status>
                    <statusCategory id="4" key="indeterminate" colorName="yellow"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="steven.chen">Steven Chen</reporter>
                        <labels>
                    </labels>
                <created>Fri, 10 Mar 2023 22:13:13 +0000</created>
                <updated>Sun, 12 Mar 2023 19:28:40 +0000</updated>
                                            <version>3.4.0</version>
                                                    <component>Spark Core</component>
                    <component>Web UI</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17699148" author="zing" created="Sat, 11 Mar 2023 02:33:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=steven.chen&quot; class=&quot;user-hover&quot; rel=&quot;steven.chen&quot;&gt;steven.chen&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;Can you provide the reproduction code?&lt;/p&gt;</comment>
                            <comment id="17699388" author="apachespark" created="Sun, 12 Mar 2023 19:28:19 +0000"  >&lt;p&gt;User &apos;StevenChenDatabricks&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/40385&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/40385&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17699389" author="apachespark" created="Sun, 12 Mar 2023 19:28:40 +0000"  >&lt;p&gt;User &apos;StevenChenDatabricks&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/40385&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/40385&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 35 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1gi40:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>