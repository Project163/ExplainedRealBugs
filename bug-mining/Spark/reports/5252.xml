<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:56:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-21991] [LAUNCHER] LauncherServer acceptConnections thread sometime dies if machine has very high load</title>
                <link>https://issues.apache.org/jira/browse/SPARK-21991</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;The way the &lt;em&gt;LauncherServer&lt;/em&gt; &lt;em&gt;acceptConnections&lt;/em&gt; thread schedules client timeouts causes (non-deterministically) the thread to die with the following exception if the machine is under very high load:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Exception in thread &quot;LauncherServer-1&quot; java.lang.IllegalStateException: Task already scheduled or cancelled
        at java.util.Timer.sched(Timer.java:401)
        at java.util.Timer.schedule(Timer.java:193)
        at org.apache.spark.launcher.LauncherServer.acceptConnections(LauncherServer.java:249)
        at org.apache.spark.launcher.LauncherServer.access$000(LauncherServer.java:80)
        at org.apache.spark.launcher.LauncherServer$1.run(LauncherServer.java:143)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The issue is related to the ordering of actions that the &lt;em&gt;acceptConnections&lt;/em&gt; thread uses to handle a client connection:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;create timeout action&lt;/li&gt;
	&lt;li&gt;create client thread&lt;/li&gt;
	&lt;li&gt;start client thread&lt;/li&gt;
	&lt;li&gt;schedule timeout action&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Under normal conditions the scheduling of the timeout action happen before the client thread has a chance to start, however if the machine is under very high load the client thread can receive CPU time before the timeout action gets scheduled.&lt;/p&gt;

&lt;p&gt;If this condition happen, the client thread cancel the timeout action (which is not yet been scheduled) and goes on, but as soon as the &lt;em&gt;acceptConnections&lt;/em&gt; thread gets the CPU back, it will try to schedule the timeout action (which has already been canceled) thus raising the exception.&lt;/p&gt;

&lt;p&gt;Changing the order in which the client thread gets started and the timeout gets scheduled seems to be sufficient to fix this issue.&lt;/p&gt;

&lt;p&gt;As stated above the issue is non-deterministic, I faced the issue multiple times on a single-node machine submitting a high number of short jobs sequentially, but I couldn&apos;t easily create a test reproducing the issue. &lt;/p&gt;</description>
                <environment>&lt;p&gt;Single node machine running Ubuntu 16.04.2 LTS (4.4.0-79-generic)&lt;br/&gt;
YARN 2.7.2&lt;br/&gt;
Spark 2.0.2&lt;/p&gt;</environment>
        <key id="13101894">SPARK-21991</key>
            <summary>[LAUNCHER] LauncherServer acceptConnections thread sometime dies if machine has very high load</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nivox">Andrea Zito</assignee>
                                    <reporter username="nivox">Andrea Zito</reporter>
                        <labels>
                    </labels>
                <created>Wed, 13 Sep 2017 09:02:22 +0000</created>
                <updated>Wed, 25 Oct 2017 18:04:04 +0000</updated>
                            <resolved>Wed, 25 Oct 2017 17:12:21 +0000</resolved>
                                    <version>2.0.2</version>
                    <version>2.1.0</version>
                    <version>2.1.1</version>
                    <version>2.2.0</version>
                                    <fixVersion>2.0.3</fixVersion>
                    <fixVersion>2.1.3</fixVersion>
                    <fixVersion>2.2.1</fixVersion>
                    <fixVersion>2.3.0</fixVersion>
                                    <component>Spark Submit</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16164372" author="apachespark" created="Wed, 13 Sep 2017 09:17:03 +0000"  >&lt;p&gt;User &apos;nivox&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/19217&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/19217&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16216529" author="aash" created="Tue, 24 Oct 2017 08:37:57 +0000"  >&lt;p&gt;Thanks for debugging and diagnosing this &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nivox&quot; class=&quot;user-hover&quot; rel=&quot;nivox&quot;&gt;nivox&lt;/a&gt;! I&apos;m seeing the same issue right now on one of my Spark clusters so am interested in getting your fix in to mainline Spark for my users.&lt;/p&gt;

&lt;p&gt;Have you deployed the change from your linked PR in a live setting, and has it fixed the issue for you?&lt;/p&gt;</comment>
                            <comment id="16216572" author="nivox" created="Tue, 24 Oct 2017 08:58:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aash&quot; class=&quot;user-hover&quot; rel=&quot;aash&quot;&gt;aash&lt;/a&gt; I&apos;ve tested it on a staging environment and it seemed to resolve the issue. However I didn&apos;t deploy it to the affected system since I didn&apos;t want to run a patched Spark distribution. For the time being I&apos;ve setup a script to detect when the issue happen and restart the component. &lt;br/&gt;
This is obviously an ugly workaround and I would much prefer to have Spark handle it.&lt;/p&gt;</comment>
                            <comment id="16219139" author="aash" created="Wed, 25 Oct 2017 17:29:16 +0000"  >&lt;p&gt;Thanks for the contribution to Spark &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nivox&quot; class=&quot;user-hover&quot; rel=&quot;nivox&quot;&gt;nivox&lt;/a&gt;!  I&apos;ll be testing this on some clusters of mine and will echo back here if I see any problems.  Cheers!&lt;/p&gt;</comment>
                            <comment id="16219202" author="apachespark" created="Wed, 25 Oct 2017 18:04:04 +0000"  >&lt;p&gt;User &apos;ash211&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/19574&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/19574&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 3 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3k0b3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311620" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Shepherd</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>vanzin</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>