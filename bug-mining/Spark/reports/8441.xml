<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:29:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-28090] Spark hangs when an execution plan has many projections on nested structs</title>
                <link>https://issues.apache.org/jira/browse/SPARK-28090</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;This was already posted (#28016), but the provided example didn&apos;t always reproduce the error. This example consistently reproduces the issue.&lt;/p&gt;

&lt;p&gt;Spark applications freeze on execution plan optimization stage (Catalyst) when a logical execution plan contains a lot of projections that operate on nested struct fields.&lt;/p&gt;

&lt;p&gt;The code listed below demonstrates the issue.&lt;/p&gt;

&lt;p&gt;To reproduce the Spark App does the following:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;A small dataframe is created from a JSON example.&lt;/li&gt;
	&lt;li&gt;Several nested transformations (negation of a number) are applied&#160;on struct fields and each time a new struct field is created.&#160;&lt;/li&gt;
	&lt;li&gt;Once more than&#160;9 such transformations are applied the Catalyst optimizer freezes on optimizing the execution plan.&lt;/li&gt;
	&lt;li&gt;You can control the freezing by choosing different upper&#160;bound for the Range. E.g. it will work file if the upper bound is 5, but will hang is the bound is 10.&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt; com.example

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.sql._
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.sql.functions._
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.sql.types.{StructField, StructType}
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; scala.collection.mutable.ListBuffer

object SparkApp1IssueSelfContained {

  &lt;span class=&quot;code-comment&quot;&gt;// A sample data &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a dataframe with nested structs
&lt;/span&gt;  val sample: List[&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;] =
    &lt;span class=&quot;code-quote&quot;&gt;&quot;&quot;&quot; { &quot;&lt;/span&gt;numerics&lt;span class=&quot;code-quote&quot;&gt;&quot;: {&quot;&lt;/span&gt;num1&lt;span class=&quot;code-quote&quot;&gt;&quot;: 101, &quot;&lt;/span&gt;num2&lt;span class=&quot;code-quote&quot;&gt;&quot;: 102, &quot;&lt;/span&gt;num3&lt;span class=&quot;code-quote&quot;&gt;&quot;: 103, &quot;&lt;/span&gt;num4&lt;span class=&quot;code-quote&quot;&gt;&quot;: 104, &quot;&lt;/span&gt;num5&lt;span class=&quot;code-quote&quot;&gt;&quot;: 105, &quot;&lt;/span&gt;num6&lt;span class=&quot;code-quote&quot;&gt;&quot;: 106, &quot;&lt;/span&gt;num7&lt;span class=&quot;code-quote&quot;&gt;&quot;: 107, &quot;&lt;/span&gt;num8&lt;span class=&quot;code-quote&quot;&gt;&quot;: 108, &quot;&lt;/span&gt;num9&lt;span class=&quot;code-quote&quot;&gt;&quot;: 109, &quot;&lt;/span&gt;num10&lt;span class=&quot;code-quote&quot;&gt;&quot;: 110, &quot;&lt;/span&gt;num11&lt;span class=&quot;code-quote&quot;&gt;&quot;: 111, &quot;&lt;/span&gt;num12&lt;span class=&quot;code-quote&quot;&gt;&quot;: 112, &quot;&lt;/span&gt;num13&lt;span class=&quot;code-quote&quot;&gt;&quot;: 113, &quot;&lt;/span&gt;num14&lt;span class=&quot;code-quote&quot;&gt;&quot;: 114, &quot;&lt;/span&gt;num15&lt;span class=&quot;code-quote&quot;&gt;&quot;: 115} } &quot;&lt;/span&gt;&quot;&quot; ::
    &lt;span class=&quot;code-quote&quot;&gt;&quot;&quot;&quot; { &quot;&lt;/span&gt;numerics&lt;span class=&quot;code-quote&quot;&gt;&quot;: {&quot;&lt;/span&gt;num1&lt;span class=&quot;code-quote&quot;&gt;&quot;: 201, &quot;&lt;/span&gt;num2&lt;span class=&quot;code-quote&quot;&gt;&quot;: 202, &quot;&lt;/span&gt;num3&lt;span class=&quot;code-quote&quot;&gt;&quot;: 203, &quot;&lt;/span&gt;num4&lt;span class=&quot;code-quote&quot;&gt;&quot;: 204, &quot;&lt;/span&gt;num5&lt;span class=&quot;code-quote&quot;&gt;&quot;: 205, &quot;&lt;/span&gt;num6&lt;span class=&quot;code-quote&quot;&gt;&quot;: 206, &quot;&lt;/span&gt;num7&lt;span class=&quot;code-quote&quot;&gt;&quot;: 207, &quot;&lt;/span&gt;num8&lt;span class=&quot;code-quote&quot;&gt;&quot;: 208, &quot;&lt;/span&gt;num9&lt;span class=&quot;code-quote&quot;&gt;&quot;: 209, &quot;&lt;/span&gt;num10&lt;span class=&quot;code-quote&quot;&gt;&quot;: 210, &quot;&lt;/span&gt;num11&lt;span class=&quot;code-quote&quot;&gt;&quot;: 211, &quot;&lt;/span&gt;num12&lt;span class=&quot;code-quote&quot;&gt;&quot;: 212, &quot;&lt;/span&gt;num13&lt;span class=&quot;code-quote&quot;&gt;&quot;: 213, &quot;&lt;/span&gt;num14&lt;span class=&quot;code-quote&quot;&gt;&quot;: 214, &quot;&lt;/span&gt;num15&lt;span class=&quot;code-quote&quot;&gt;&quot;: 215} } &quot;&lt;/span&gt;&quot;&quot; ::
    &lt;span class=&quot;code-quote&quot;&gt;&quot;&quot;&quot; { &quot;&lt;/span&gt;numerics&lt;span class=&quot;code-quote&quot;&gt;&quot;: {&quot;&lt;/span&gt;num1&lt;span class=&quot;code-quote&quot;&gt;&quot;: 301, &quot;&lt;/span&gt;num2&lt;span class=&quot;code-quote&quot;&gt;&quot;: 302, &quot;&lt;/span&gt;num3&lt;span class=&quot;code-quote&quot;&gt;&quot;: 303, &quot;&lt;/span&gt;num4&lt;span class=&quot;code-quote&quot;&gt;&quot;: 304, &quot;&lt;/span&gt;num5&lt;span class=&quot;code-quote&quot;&gt;&quot;: 305, &quot;&lt;/span&gt;num6&lt;span class=&quot;code-quote&quot;&gt;&quot;: 306, &quot;&lt;/span&gt;num7&lt;span class=&quot;code-quote&quot;&gt;&quot;: 307, &quot;&lt;/span&gt;num8&lt;span class=&quot;code-quote&quot;&gt;&quot;: 308, &quot;&lt;/span&gt;num9&lt;span class=&quot;code-quote&quot;&gt;&quot;: 309, &quot;&lt;/span&gt;num10&lt;span class=&quot;code-quote&quot;&gt;&quot;: 310, &quot;&lt;/span&gt;num11&lt;span class=&quot;code-quote&quot;&gt;&quot;: 311, &quot;&lt;/span&gt;num12&lt;span class=&quot;code-quote&quot;&gt;&quot;: 312, &quot;&lt;/span&gt;num13&lt;span class=&quot;code-quote&quot;&gt;&quot;: 313, &quot;&lt;/span&gt;num14&lt;span class=&quot;code-quote&quot;&gt;&quot;: 314, &quot;&lt;/span&gt;num15&lt;span class=&quot;code-quote&quot;&gt;&quot;: 315} } &quot;&lt;/span&gt;&quot;&quot; ::
    Nil

  /**
    * Transforms a column inside a nested struct. The transformed value will be put into a &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; field of that nested struct
    *
    * The output column name can omit the full path as the field will be created at the same level of nesting as the input column.
    *
    * @param inputColumnName  A column name &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; which to apply the transformation, e.g. `company.employee.firstName`.
    * @param outputColumnName The output column name. The path is optional, e.g. you can use `transformedName` instead of `company.employee.transformedName`.
    * @param expression       A function that applies a transformation to a column as a Spark expression.
    * @&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; A dataframe with a &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; field that contains transformed values.
    */
  def transformInsideNestedStruct(df: DataFrame,
                                  inputColumnName: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;,
                                  outputColumnName: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;,
                                  expression: Column =&amp;gt; Column): DataFrame = {
    def mapStruct(schema: StructType, path: Seq[&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;], parentColumn: Option[Column] = None): Seq[Column] = {
      val mappedFields = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ListBuffer[Column]()

      def handleMatchedLeaf(field: StructField, curColumn: Column): Seq[Column] = {
        val newColumn = expression(curColumn).as(outputColumnName)
        mappedFields += newColumn
        Seq(curColumn)
      }

      def handleMatchedNonLeaf(field: StructField, curColumn: Column): Seq[Column] = {
        &lt;span class=&quot;code-comment&quot;&gt;// Non-leaf columns need to be further processed recursively
&lt;/span&gt;        field.dataType match {
          &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; dt: StructType =&amp;gt; Seq(struct(mapStruct(dt, path.tail, Some(curColumn)): _*).as(field.name))
          &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; _ =&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IllegalArgumentException(s&lt;span class=&quot;code-quote&quot;&gt;&quot;Field &lt;span class=&quot;code-quote&quot;&gt;&apos;${field.name}&apos;&lt;/span&gt; is not a struct type.&quot;&lt;/span&gt;)
        }
      }

      val fieldName = path.head
      val isLeaf = path.lengthCompare(2) &amp;lt; 0

      val newColumns = schema.fields.flatMap(field =&amp;gt; {
        &lt;span class=&quot;code-comment&quot;&gt;// This is the original column (struct field) we want to process
&lt;/span&gt;        val curColumn = parentColumn match {
          &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; None =&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Column(field.name)
          &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; Some(col) =&amp;gt; col.getField(field.name).as(field.name)
        }

        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (field.name.compareToIgnoreCase(fieldName) != 0) {
          &lt;span class=&quot;code-comment&quot;&gt;// Copy unrelated fields as they were
&lt;/span&gt;          Seq(curColumn)
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
          &lt;span class=&quot;code-comment&quot;&gt;// We have found a match
&lt;/span&gt;          &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isLeaf) {
            handleMatchedLeaf(field, curColumn)
          } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
            handleMatchedNonLeaf(field, curColumn)
          }
        }
      })

      newColumns ++ mappedFields
    }

    val schema = df.schema
    val path = inputColumnName.split(&lt;span class=&quot;code-quote&quot;&gt;&apos;.&apos;&lt;/span&gt;)
    df.select(mapStruct(schema, path): _*)
  }

  /**
    * This Spark Job demonstrates an issue of execution plan freezing when there are a lot of projections
    * involving nested structs in an execution plan.
    *
    * The example works as follows:
    * - A small dataframe is created from a JSON example above
    * - A nested withColumn map transformation is used to apply a transformation on a struct field and create
    *   a &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; struct field.
    * - Once more than 9 such transformations are applied the Catalyst optimizer freezes on optimizing
    *   the execution plan
    *
    */
  def main(args: Array[&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;]): Unit = {

    val sparkBuilder = SparkSession.builder().appName(&lt;span class=&quot;code-quote&quot;&gt;&quot;Nested Projections Issue Example&quot;&lt;/span&gt;)
    val spark = sparkBuilder
      .master(&lt;span class=&quot;code-quote&quot;&gt;&quot;local[4]&quot;&lt;/span&gt;)
      .getOrCreate()

    &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; spark.implicits._

    val dfInput = spark.read.json(sample.toDS)

    &lt;span class=&quot;code-comment&quot;&gt;// Apply several negations. You can change the number of negations by changing the upper bound of the range up to 16
&lt;/span&gt;    val dfOutput = Range(1,12).foldLeft(dfInput)( (df, i) =&amp;gt; {
      transformInsideNestedStruct(df, s&lt;span class=&quot;code-quote&quot;&gt;&quot;numerics.num$i&quot;&lt;/span&gt;, s&lt;span class=&quot;code-quote&quot;&gt;&quot;out_num$i&quot;&lt;/span&gt;, c =&amp;gt; -c)
    })

    dfOutput.printSchema()
    dfOutput.explain(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
    dfOutput.show(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)
  }

}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;Tried in&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Spark 2.2.1, Spark 2.4.3 in local mode on Linux, MasOS and Windows&lt;/li&gt;
	&lt;li&gt;Spark 2.4.3 / Yarn on a Linux cluster&lt;/li&gt;
&lt;/ul&gt;
</environment>
        <key id="13240120">SPARK-28090</key>
            <summary>Spark hangs when an execution plan has many projections on nested structs</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="petertoth">Peter Toth</assignee>
                                    <reporter username="yruslan2">Ruslan Yushchenko</reporter>
                        <labels>
                    </labels>
                <created>Tue, 18 Jun 2019 06:56:41 +0000</created>
                <updated>Sat, 16 Apr 2022 20:19:14 +0000</updated>
                            <resolved>Sun, 3 Apr 2022 07:49:13 +0000</resolved>
                                    <version>2.4.3</version>
                                    <fixVersion>3.4.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>3</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="16876150" author="iskenderunlu804" created="Mon, 1 Jul 2019 12:28:17 +0000"  >&lt;p&gt;I will try to work on this issue as my first contribution trial.&lt;/p&gt;</comment>
                            <comment id="17485917" author="apachespark" created="Wed, 2 Feb 2022 16:12:04 +0000"  >&lt;p&gt;User &apos;peter-toth&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/35382&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/35382&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17516467" author="dongjoon" created="Sun, 3 Apr 2022 07:49:13 +0000"  >&lt;p&gt;This is resolved via &lt;a href=&quot;https://github.com/apache/spark/pull/35382&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/35382&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13436867">SPARK-38712</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 32 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z03um0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>