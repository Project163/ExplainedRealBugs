<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:28:29 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-8079] NPE when HadoopFsRelation.prepareForWriteJob throws exception</title>
                <link>https://issues.apache.org/jira/browse/SPARK-8079</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Take &lt;tt&gt;ParquetRelation2&lt;/tt&gt; as an example, the following Spark shell code may cause an unexpected NPE:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; sqlContext._
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; sqlContext.implicits._

range(1, 3).select($&lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt; as &lt;span class=&quot;code-quote&quot;&gt;&quot;a b&quot;&lt;/span&gt;).write.format(&lt;span class=&quot;code-quote&quot;&gt;&quot;parquet&quot;&lt;/span&gt;).save(&lt;span class=&quot;code-quote&quot;&gt;&quot;file:&lt;span class=&quot;code-comment&quot;&gt;///tmp/foo&quot;&lt;/span&gt;)&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Exceptions thrown:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;import sqlContext._
import sqlContext.implicits._

range(1, 3).select($&quot;id&quot; as &quot;a b&quot;).write.format(&quot;parquet&quot;).save(&quot;file:///tmp/foo&quot;)

java.lang.RuntimeException: Attribute name &quot;a b&quot; contains invalid character(s) among &quot; ,;{}()   =&quot;. Please use alias to rename it.
        at scala.sys.package$.error(package.scala:27)
        at org.apache.spark.sql.parquet.ParquetTypesConverter$$anonfun$checkSpecialCharacters$2.apply(ParquetTypes.scala:414)
        at org.apache.spark.sql.parquet.ParquetTypesConverter$$anonfun$checkSpecialCharacters$2.apply(ParquetTypes.scala:412)
        at scala.collection.immutable.List.foreach(List.scala:318)
        at org.apache.spark.sql.parquet.ParquetTypesConverter$.checkSpecialCharacters(ParquetTypes.scala:412)
        at org.apache.spark.sql.parquet.ParquetTypesConverter$.convertToString(ParquetTypes.scala:423)
        at org.apache.spark.sql.parquet.RowWriteSupport$.setSchema(ParquetTableSupport.scala:383)
        at org.apache.spark.sql.parquet.ParquetRelation2.prepareJobForWrite(newParquet.scala:230)
        ...
java.lang.NullPointerException
        at org.apache.spark.sql.sources.BaseWriterContainer.abortJob(commands.scala:372)
        at org.apache.spark.sql.sources.InsertIntoHadoopFsRelation.insert(commands.scala:137)
        at org.apache.spark.sql.sources.InsertIntoHadoopFsRelation.run(commands.scala:114)
        at org.apache.spark.sql.execution.ExecutedCommand.sideEffectResult$lzycompute(commands.scala:57)
        at org.apache.spark.sql.execution.ExecutedCommand.sideEffectResult(commands.scala:57)
        ...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Note that the first &lt;tt&gt;RuntimeException&lt;/tt&gt; is expected, while the following NPE is not.&lt;/p&gt;

&lt;p&gt;The reason of the NPE is that, &lt;tt&gt;BaseWriterContainer.driverSideSetup()&lt;/tt&gt; calls &lt;tt&gt;relation.prepareForWriteJob()&lt;/tt&gt; AND initializes the &lt;tt&gt;OutputCommitter&lt;/tt&gt; used for the subsequent write job. However, if the former throws an exception, the latter is not properly initialized, thus an NPE is thrown when aborting the job because the &lt;tt&gt;OutputCommitter&lt;/tt&gt; is still null.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12835059">SPARK-8079</key>
            <summary>NPE when HadoopFsRelation.prepareForWriteJob throws exception</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="lian cheng">Cheng Lian</assignee>
                                    <reporter username="lian cheng">Cheng Lian</reporter>
                        <labels>
                    </labels>
                <created>Wed, 3 Jun 2015 13:58:11 +0000</created>
                <updated>Sat, 6 Jun 2015 10:57:23 +0000</updated>
                            <resolved>Sat, 6 Jun 2015 09:26:45 +0000</resolved>
                                    <version>1.4.0</version>
                                    <fixVersion>1.4.1</fixVersion>
                    <fixVersion>1.5.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14570885" author="apachespark" created="Wed, 3 Jun 2015 14:12:11 +0000"  >&lt;p&gt;User &apos;liancheng&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/6612&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/6612&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14575635" author="lian cheng" created="Sat, 6 Jun 2015 08:33:41 +0000"  >&lt;p&gt;Bascially, in &lt;tt&gt;InsertIntoHadoopFsRelation&lt;/tt&gt; we need to be careful whenever a user defined method is invoked.  Because they may throw unexpected exception and causes the write job/task to abort.  More specifically, we need to keep an eye on the following methods:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;tt&gt;HadoopFsRelation.prepareForWriteJob&lt;/tt&gt;: This method is called on the driver side &lt;b&gt;before&lt;/b&gt; the write job is issued. It initializes the write job by decorating the &lt;tt&gt;job&lt;/tt&gt; instance passed in, and returning an &lt;tt&gt;OutputWriterFactory&lt;/tt&gt; which produces &lt;tt&gt;OutputWriter&lt;/tt&gt; instances on the executor side. Note that, if this method throws any exception, we should &lt;b&gt;not&lt;/b&gt; abort the job since the job hasn&apos;t been issued yet. Especially, the &lt;tt&gt;OutputCommitter&lt;/tt&gt; used to commit/abort the job may not be properly initialized yet (which is the case described in this ticket).&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;OutputWriter.&amp;lt;init&amp;gt;&lt;/tt&gt;, &lt;tt&gt;OutputWriter.write&lt;/tt&gt;, and &lt;tt&gt;OutputWriter.close&lt;/tt&gt;: These methods are called on executor side while a write task is being executed. Failures of these methods require task abortion.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14575647" author="lian cheng" created="Sat, 6 Jun 2015 09:26:45 +0000"  >&lt;p&gt;Issue resolved by pull request 6612&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/6612&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/6612&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 24 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2fktz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12332153">1.4.1</customfieldvalue>
    <customfieldvalue id="12332078">1.5.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>