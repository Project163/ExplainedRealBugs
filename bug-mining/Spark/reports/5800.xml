<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:00:23 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-24552] Task attempt numbers are reused when stages are retried</title>
                <link>https://issues.apache.org/jira/browse/SPARK-24552</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;When stages are retried due to shuffle failures, task attempt numbers are reused. This causes a correctness bug in the v2 data sources write path.&lt;/p&gt;

&lt;p&gt;Data sources (both the original and v2) pass the task attempt to writers so that writers can use the attempt number to track and clean up data from failed or speculative attempts. In the v2 docs for DataWriterFactory, the attempt number&apos;s javadoc states that &quot;Implementations can use this attempt number to distinguish writers of different task attempts.&quot;&lt;/p&gt;

&lt;p&gt;When two attempts of a stage use the same (partition, attempt) pair, two tasks can create the same data and attempt to commit. The commit coordinator prevents both from committing and will abort the attempt that finishes last. When using the (partition, attempt) pair to track data, the aborted task may delete data associated with the (partition, attempt) pair. If that happens, the data for the task that committed is also deleted as well, which is a correctness bug.&lt;/p&gt;

&lt;p&gt;For a concrete example, I have a data source that creates files in place named with &lt;tt&gt;part-&amp;lt;partition&amp;gt;&lt;del&gt;&amp;lt;attempt&amp;gt;&lt;/del&gt;&amp;lt;uuid&amp;gt;.&amp;lt;format&amp;gt;&lt;/tt&gt;. Because these files are written in place, both tasks create the same file and the one that is aborted deletes the file, leading to data corruption when the file is added to the table.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13165916">SPARK-24552</key>
            <summary>Task attempt numbers are reused when stages are retried</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rdblue">Ryan Blue</assignee>
                                    <reporter username="rdblue">Ryan Blue</reporter>
                        <labels>
                    </labels>
                <created>Wed, 13 Jun 2018 19:47:36 +0000</created>
                <updated>Tue, 26 Jun 2018 00:08:39 +0000</updated>
                            <resolved>Tue, 26 Jun 2018 00:08:39 +0000</resolved>
                                    <version>2.1.1</version>
                    <version>2.2.0</version>
                    <version>2.2.1</version>
                    <version>2.3.0</version>
                    <version>2.3.1</version>
                                    <fixVersion>2.2.2</fixVersion>
                    <fixVersion>2.3.2</fixVersion>
                    <fixVersion>2.4.0</fixVersion>
                                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                                                                                <comments>
                            <comment id="16511590" author="rdblue" created="Wed, 13 Jun 2018 19:51:38 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vanzin&quot; class=&quot;user-hover&quot; rel=&quot;vanzin&quot;&gt;vanzin&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=henryr&quot; class=&quot;user-hover&quot; rel=&quot;henryr&quot;&gt;henryr&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cloud_fan&quot; class=&quot;user-hover&quot; rel=&quot;cloud_fan&quot;&gt;cloud_fan&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16511593" author="apachespark" created="Wed, 13 Jun 2018 19:55:05 +0000"  >&lt;p&gt;User &apos;rdblue&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/21558&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/21558&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16511674" author="irashid" created="Wed, 13 Jun 2018 21:15:52 +0000"  >&lt;p&gt;I wouldn&apos;t call this a bug in the scheduler, though I agree its definitely confusing and not clearly documented at all.  I think this has always been the meaning of the attempt number.  It might be confusing for other cases to change its meaning now &amp;#8211; eg. its useful to know how many failed attempts you had within one taskset, and some code out there might be using max(attemptNumber) now as a proxy for that.&lt;/p&gt;

&lt;p&gt;For sure we should improve the documentation.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markhamstra&quot; class=&quot;user-hover&quot; rel=&quot;markhamstra&quot;&gt;markhamstra&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tgraves&quot; class=&quot;user-hover&quot; rel=&quot;tgraves&quot;&gt;tgraves&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jiangxb1987&quot; class=&quot;user-hover&quot; rel=&quot;jiangxb1987&quot;&gt;jiangxb1987&lt;/a&gt; for some more opinions on the scheduler side.&lt;/p&gt;</comment>
                            <comment id="16511695" author="jiangxb1987" created="Wed, 13 Jun 2018 21:43:48 +0000"  >&lt;p&gt;IIUC stageAttemptId + taskAttemptNumber shall probably define a unique task attempt, and it carries enough information to know how many failed attempts you had previously.&lt;/p&gt;</comment>
                            <comment id="16512500" author="tgraves" created="Thu, 14 Jun 2018 14:00:36 +0000"  >&lt;p&gt;I agree, I don&apos;t think changing the attempt number at this point does much help and could cause confusion.&#160; I would rather see something like this change if we do major reworking of the scheduler.&lt;/p&gt;</comment>
                            <comment id="16512504" author="tgraves" created="Thu, 14 Jun 2018 14:02:44 +0000"  >&lt;p&gt;Note if this is a correctness bug and can&#160;cause data loss/corruption it needs to be a blocker, changed to blocker, if I am misunderstanding please update.&lt;/p&gt;</comment>
                            <comment id="16512519" author="tgraves" created="Thu, 14 Jun 2018 14:12:58 +0000"  >&lt;p&gt;sorry just realized the v2 api is&#160;still marked experiment so downgrading to critical&lt;/p&gt;</comment>
                            <comment id="16516522" author="vanzin" created="Tue, 19 Jun 2018 01:32:12 +0000"  >&lt;p&gt;I forked the output commiter issue into &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-24589&quot; title=&quot;OutputCommitCoordinator may allow duplicate commits&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-24589&quot;&gt;&lt;del&gt;SPARK-24589&lt;/del&gt;&lt;/a&gt; so that we have a separate record of each issue.&lt;/p&gt;</comment>
                            <comment id="16516525" author="vanzin" created="Tue, 19 Jun 2018 01:37:02 +0000"  >&lt;p&gt;Added some target versions. We should take the chance to fix this now.&lt;/p&gt;</comment>
                            <comment id="16519430" author="tgraves" created="Thu, 21 Jun 2018 14:28:14 +0000"  >&lt;p&gt;this is actually a problem with hadoop committers, v1 and v2&lt;/p&gt;</comment>
                            <comment id="16519445" author="tgraves" created="Thu, 21 Jun 2018 14:47:04 +0000"  >&lt;p&gt;more details on hadoop committer side:&lt;/p&gt;

&lt;p&gt;So I think the commit/delete thing is also an issue for existing v1 and hadoop committers as well. So this doesn&apos;t fully solve the problem. spark uses a file format like (HadoopMapReduceWriteConfigUtil/HadoopMapRedWriteConfigUtil):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
{date}_{rddid}_{m/r}_{partitionid}_{task attempt number}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I believe the same fix as the v2 would work using the taskAttemptId instead of the attemptNumber.&lt;/p&gt;

&lt;p&gt;In the case we have the stage failure and a second stage attempt the task attempt number could be the same and thus both tasks write to the same place. If one of them fails or is told not to commit it could delete the output which is being used by both.&lt;/p&gt;

&lt;p&gt;Need to think through all the scenarios to make sure its covered.&lt;/p&gt;</comment>
                            <comment id="16519723" author="apachespark" created="Thu, 21 Jun 2018 20:00:05 +0000"  >&lt;p&gt;User &apos;vanzin&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/21606&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/21606&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16520742" author="apachespark" created="Fri, 22 Jun 2018 20:08:07 +0000"  >&lt;p&gt;User &apos;vanzin&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/21615&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/21615&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16520752" author="apachespark" created="Fri, 22 Jun 2018 20:26:05 +0000"  >&lt;p&gt;User &apos;vanzin&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/21616&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/21616&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16522976" author="vanzin" created="Tue, 26 Jun 2018 00:08:39 +0000"  >&lt;p&gt;Giving credit to Ryan since he found the issue and provided the initial fix, although the final fix was a little more extensive.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 21 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3utw7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12341660">2.1.3</customfieldvalue>
    <customfieldvalue id="12342171">2.2.2</customfieldvalue>
    <customfieldvalue id="12343289">2.3.2</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>