<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:59:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-10878] Race condition when resolving Maven coordinates via Ivy</title>
                <link>https://issues.apache.org/jira/browse/SPARK-10878</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;I&apos;ve recently been shell-scripting the creation of many concurrent Spark-on-YARN apps and observing a fraction of them to fail with what I&apos;m guessing is a race condition in their Maven-coordinate resolution.&lt;/p&gt;

&lt;p&gt;For example, I might spawn an app for each path in file &lt;tt&gt;paths&lt;/tt&gt; with the following shell script:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;cat paths | parallel &lt;span class=&quot;code-quote&quot;&gt;&quot;$SPARK_HOME/bin/spark-submit foo.jar {}&quot;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When doing this, I observe some fraction of the spawned jobs to fail with errors like:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;:: retrieving :: org.apache.spark#spark-submit-parent
        confs: [&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;]
Exception in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt; java.lang.RuntimeException: problem during retrieve of org.apache.spark#spark-submit-parent: java.text.ParseException: failed to parse report: /hpc/users/willir31/.ivy2/cache/org.apache.spark-spark-submit-parent-&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;.xml: Premature end of file.
        at org.apache.ivy.core.retrieve.RetrieveEngine.retrieve(RetrieveEngine.java:249)
        at org.apache.ivy.core.retrieve.RetrieveEngine.retrieve(RetrieveEngine.java:83)
        at org.apache.ivy.Ivy.retrieve(Ivy.java:551)
        at org.apache.spark.deploy.SparkSubmitUtils$.resolveMavenCoordinates(SparkSubmit.scala:1006)
        at org.apache.spark.deploy.SparkSubmit$.prepareSubmitEnvironment(SparkSubmit.scala:286)
        at org.apache.spark.deploy.SparkSubmit$.submit(SparkSubmit.scala:153)
        at org.apache.spark.deploy.SparkSubmit$.main(SparkSubmit.scala:120)
        at org.apache.spark.deploy.SparkSubmit.main(SparkSubmit.scala)
Caused by: java.text.ParseException: failed to parse report: /hpc/users/willir31/.ivy2/cache/org.apache.spark-spark-submit-parent-&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;.xml: Premature end of file.
        at org.apache.ivy.plugins.report.XmlReportParser.parse(XmlReportParser.java:293)
        at org.apache.ivy.core.retrieve.RetrieveEngine.determineArtifactsToCopy(RetrieveEngine.java:329)
        at org.apache.ivy.core.retrieve.RetrieveEngine.retrieve(RetrieveEngine.java:118)
        ... 7 more
Caused by: org.xml.sax.SAXParseException; Premature end of file.
        at org.apache.xerces.util.ErrorHandlerWrapper.createSAXParseException(Unknown Source)
        at org.apache.xerces.util.ErrorHandlerWrapper.fatalError(Unknown Source)
        at org.apache.xerces.impl.XMLErrorReporter.reportError(Unknown Source)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The more apps I try to launch simultaneously, the greater fraction of them seem to fail with this or similar errors; a batch of ~10 will usually work fine, a batch of 15 will see a few failures, and a batch of ~60 will have dozens of failures.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://gist.github.com/ryan-williams/648bff70e518de0c7c84&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;This gist shows 11 recent failures I observed&lt;/a&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12901496">SPARK-10878</key>
            <summary>Race condition when resolving Maven coordinates via Ivy</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kiszk">Kazuaki Ishizaki</assignee>
                                    <reporter username="rdub">Ryan Williams</reporter>
                        <labels>
                    </labels>
                <created>Wed, 30 Sep 2015 02:35:20 +0000</created>
                <updated>Mon, 12 Dec 2022 18:10:44 +0000</updated>
                            <resolved>Thu, 10 May 2018 21:44:10 +0000</resolved>
                                    <version>1.5.0</version>
                                    <fixVersion>2.3.1</fixVersion>
                    <fixVersion>2.4.0</fixVersion>
                                    <component>Spark Core</component>
                        <due></due>
                            <votes>6</votes>
                                    <watches>16</watches>
                                                                                                                <comments>
                            <comment id="15036893" author="joshrosen" created="Wed, 2 Dec 2015 23:50:08 +0000"  >&lt;p&gt;I think this is because Spark&apos;s use of the Ivy cache and Ivy resolution files is not concurrency-safe. In this instance, I think that the Spark processes are contending while trying to write a POM file to pass to Ivy. SBT works around this problem by using a lock file to coordinate between SBT processes running on the same machine, so we could do something similar to handle that.&lt;/p&gt;

&lt;p&gt;However, even after doing that I think we&apos;d still possibly be vulnerable to race-conditions between SBT and Spark if they&apos;re sharing the same Ivy cache. See &lt;a href=&quot;https://github.com/apache/spark/pull/9624#issuecomment-156922650&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/9624#issuecomment-156922650&lt;/a&gt; for some discussion on a related issue.&lt;/p&gt;</comment>
                            <comment id="15036896" author="joshrosen" created="Wed, 2 Dec 2015 23:50:22 +0000"  >&lt;p&gt;Also, ping &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brkyvz&quot; class=&quot;user-hover&quot; rel=&quot;brkyvz&quot;&gt;brkyvz&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15515811" author="junche" created="Fri, 23 Sep 2016 08:41:14 +0000"  >&lt;p&gt;It seems this issue is still active. Is there a good workaround? Does Spark 2.0 have the same issue? It looks like Spark 1.6 has the issue too. &lt;/p&gt;</comment>
                            <comment id="15783531" author="ajs" created="Wed, 28 Dec 2016 19:16:36 +0000"  >&lt;p&gt;I see this with Spark 2.0 as well.&lt;/p&gt;

&lt;p&gt;There doesn&apos;t appear to be a good workaround, although I assume avoiding &lt;tt&gt;--packages&lt;/tt&gt; means the Ivy cache isn&apos;t used and therefore the conflict can&apos;t occur.&lt;/p&gt;</comment>
                            <comment id="15989526" author="jeeyoungk" created="Fri, 28 Apr 2017 22:10:40 +0000"  >&lt;p&gt;Can&apos;t we fix the race condition, at least for the pom-submitting part if we override the function&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;  /** A nice function to use in tests as well. Values are dummy strings. */
  def getModuleDescriptor: DefaultModuleDescriptor = DefaultModuleDescriptor.newDefaultInstance(
    ModuleRevisionId.newInstance(&quot;org.apache.spark&quot;, &quot;spark-submit-parent&quot;, &quot;1.0&quot;))
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;to generate random strings?&lt;/p&gt;</comment>
                            <comment id="15993888" author="joshrosen" created="Tue, 2 May 2017 22:11:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jeeyoungk&quot; class=&quot;user-hover&quot; rel=&quot;jeeyoungk&quot;&gt;jeeyoungk&lt;/a&gt;, my understanding is that there are two possible sources of races here:&lt;/p&gt;

&lt;p&gt;1. Racing on the module descriptor / POM that we write out. Your suggestion of using a dummy string would address that.&lt;br/&gt;
2. Racing on writes to other files in the Ivy resolution cache. This is more likely to occur when the cache is initially clean and would manifest itself as corruption in other files.&lt;/p&gt;

&lt;p&gt;Given this, I think the most robust solution is to use separate resolution caches since that would solve both problems in one fell swoop. If that&apos;s going to be hard then the partial fix of randomizing the module descriptor version (say, to use a timestamp) isn&apos;t a bad idea because it&apos;s pretty cheap to implement and probably covers the majority of real-world races here.&lt;/p&gt;</comment>
                            <comment id="15998731" author="jeeyoungk" created="Fri, 5 May 2017 18:28:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=joshrosen&quot; class=&quot;user-hover&quot; rel=&quot;joshrosen&quot;&gt;joshrosen&lt;/a&gt; Yes, I realized what are potential race conditions (both inside Ivy and how Spark uses Ivy). Regarding (1), even if Ivy becomes thread-safe, writing a temporary pom file with a fixed filename would break things - thus I think this is valuable thing to to do. I can attempt a patch around this.&lt;/p&gt;

&lt;p&gt;Regarding (2), I think it is quite inefficient solution, to have multiple resolution caches to get around this. My cache directory is half gigabytes right now, and having that per spark job seems inefficient.&lt;/p&gt;</comment>
                            <comment id="16057797" author="toddpi314" created="Wed, 21 Jun 2017 16:29:30 +0000"  >&lt;p&gt;Any chance we can move the priority of this issue up? &lt;/p&gt;

&lt;p&gt;This is causing some issues on large Spark clusters with Yarn and PySpark. &lt;/p&gt;

&lt;p&gt;Currently, a work-around is to throttle a single job to cache then expect concurrent jobs to deploy. This isn&apos;t ideal as with parallel jobs, there is a long-poll waiting for the initial job to complete.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="16109778" author="mshen" created="Tue, 1 Aug 2017 21:08:52 +0000"  >&lt;p&gt;We hit the same issue in our infrastructure where concurrent Livy clients submits Spark applications at the same time.&lt;br/&gt;
Created the following PR to fix this issue, at least the part that&apos;s more likely to happen.&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/18801&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/18801&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=joshrosen&quot; class=&quot;user-hover&quot; rel=&quot;joshrosen&quot;&gt;joshrosen&lt;/a&gt;,&lt;br/&gt;
Could you please help to take a look at this PR?&lt;/p&gt;</comment>
                            <comment id="16111588" author="gurwls223" created="Wed, 2 Aug 2017 19:21:45 +0000"  >&lt;p&gt;User &apos;Victsm&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/18801&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/18801&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16465065" author="apachespark" created="Sun, 6 May 2018 10:29:06 +0000"  >&lt;p&gt;User &apos;kiszk&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/21251&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/21251&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16471167" author="vanzin" created="Thu, 10 May 2018 21:44:10 +0000"  >&lt;p&gt;I don&apos;t know&#160;what&apos;s the&#160;jira username for victsm, so assigning to Kazuaki.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13089229">SPARK-21507</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 27 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2mftz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>