<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:03:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-26078] WHERE .. IN fails to filter rows when used in combination with UNION</title>
                <link>https://issues.apache.org/jira/browse/SPARK-26078</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Hey,&lt;/p&gt;

&lt;p&gt;We encountered a case where Spark SQL does not seem to handle WHERE .. IN correctly, when used in combination with UNION, but instead returns also rows that do not fulfill the condition. Swapping the order of the datasets in the UNION makes the problem go away. Repro below:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
sql = SQLContext(sc)

a = spark.createDataFrame([{&lt;span class=&quot;code-quote&quot;&gt;&apos;id&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;a&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;num&apos;&lt;/span&gt;: 2}, {&lt;span class=&quot;code-quote&quot;&gt;&apos;id&apos;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&apos;b&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;num&apos;&lt;/span&gt;:1}])
b = spark.createDataFrame([{&lt;span class=&quot;code-quote&quot;&gt;&apos;id&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;a&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;num&apos;&lt;/span&gt;: 2}, {&lt;span class=&quot;code-quote&quot;&gt;&apos;id&apos;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&apos;b&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;num&apos;&lt;/span&gt;:1}])
a.registerTempTable(&lt;span class=&quot;code-quote&quot;&gt;&apos;a&apos;&lt;/span&gt;)
b.registerTempTable(&lt;span class=&quot;code-quote&quot;&gt;&apos;b&apos;&lt;/span&gt;)

bug = sql.sql(&quot;&quot;&quot;
    SELECT id,num,source FROM
    (
        SELECT id, num, &lt;span class=&quot;code-quote&quot;&gt;&apos;a&apos;&lt;/span&gt; as source FROM a
        UNION ALL
        SELECT id, num, &lt;span class=&quot;code-quote&quot;&gt;&apos;b&apos;&lt;/span&gt; as source FROM b
    ) AS c
    WHERE c.id IN (SELECT id FROM b WHERE num = 2)
&quot;&quot;&quot;)

no_bug = sql.sql(&quot;&quot;&quot;
    SELECT id,num,source FROM
    (
        SELECT id, num, &lt;span class=&quot;code-quote&quot;&gt;&apos;b&apos;&lt;/span&gt; as source FROM b
        UNION ALL
        SELECT id, num, &lt;span class=&quot;code-quote&quot;&gt;&apos;a&apos;&lt;/span&gt; as source FROM a
    ) AS c
    WHERE c.id IN (SELECT id FROM b WHERE num = 2)
&quot;&quot;&quot;)

bug.show()
no_bug.show()

bug.explain(True)
no_bug.explain(True)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This results in one extra row in the &quot;bug&quot; DF coming from DF &quot;b&quot;, that should not be there as it&#160;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&amp;gt;&amp;gt;&amp;gt; bug.show()
+---+---+------+
| id|num|source|
+---+---+------+
|  a|  2|     a|
|  a|  2|     b|
|  b|  1|     b|
+---+---+------+

&amp;gt;&amp;gt;&amp;gt; no_bug.show()
+---+---+------+
| id|num|source|
+---+---+------+
|  a|  2|     b|
|  a|  2|     a|
+---+---+------+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;The reason can be seen in the query plans:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&amp;gt;&amp;gt;&amp;gt; bug.explain(True)
...
== Optimized Logical Plan ==
Union
:- Project [id#0, num#1L, a AS source#136]
:  +- Join LeftSemi, (id#0 = id#4)
:     :- LogicalRDD [id#0, num#1L], &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
:     +- Project [id#4]
:        +- Filter (isnotnull(num#5L) &amp;amp;&amp;amp; (num#5L = 2))
:           +- LogicalRDD [id#4, num#5L], &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
+- Join LeftSemi, (id#4#172 = id#4#172)
   :- Project [id#4, num#5L, b AS source#137]
   :  +- LogicalRDD [id#4, num#5L], &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
   +- Project [id#4 AS id#4#172]
      +- Filter (isnotnull(num#5L) &amp;amp;&amp;amp; (num#5L = 2))
         +- LogicalRDD [id#4, num#5L], &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Note the line &lt;b&gt;+- Join LeftSemi, (id#4#172 = id#4#172)&lt;/b&gt; - this condition seems wrong, and I believe it causes the LeftSemi to return true for all rows in the left-hand-side table, thus failing to filter as the WHERE .. IN should. Compare with the non-buggy version, where both LeftSemi joins have&#160;distinct #-things on both sides:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&amp;gt;&amp;gt;&amp;gt; no_bug.explain()
...
== Optimized Logical Plan ==
Union
:- Project [id#4, num#5L, b AS source#142]
:  +- Join LeftSemi, (id#4 = id#4#173)
:     :- LogicalRDD [id#4, num#5L], &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
:     +- Project [id#4 AS id#4#173]
:        +- Filter (isnotnull(num#5L) &amp;amp;&amp;amp; (num#5L = 2))
:           +- LogicalRDD [id#4, num#5L], &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
+- Project [id#0, num#1L, a AS source#143]
   +- Join LeftSemi, (id#0 = id#4#173)
      :- LogicalRDD [id#0, num#1L], &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
      +- Project [id#4 AS id#4#173]
         +- Filter (isnotnull(num#5L) &amp;amp;&amp;amp; (num#5L = 2))
            +- LogicalRDD [id#4, num#5L], &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Best,&lt;br/&gt;
-Arttu&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13198671">SPARK-26078</key>
            <summary>WHERE .. IN fails to filter rows when used in combination with UNION</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mgaido">Marco Gaido</assignee>
                                    <reporter username="avoutilainen">Arttu Voutilainen</reporter>
                        <labels>
                            <label>correctness</label>
                    </labels>
                <created>Thu, 15 Nov 2018 16:40:45 +0000</created>
                <updated>Sat, 5 Jan 2019 15:12:49 +0000</updated>
                            <resolved>Sun, 16 Dec 2018 02:59:55 +0000</resolved>
                                    <version>2.3.1</version>
                    <version>2.4.0</version>
                                    <fixVersion>2.3.3</fixVersion>
                    <fixVersion>2.4.1</fixVersion>
                    <fixVersion>3.0.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>12</watches>
                                                                                                                <comments>
                            <comment id="16688460" author="mcheah" created="Thu, 15 Nov 2018 18:15:41 +0000"  >&lt;p&gt;As per other correctness issues we have seen as of late and as of other discussions around these kinds of things, I&apos;m elevating this to a blocker. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cloud_fan&quot; class=&quot;user-hover&quot; rel=&quot;cloud_fan&quot;&gt;cloud_fan&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rxin%40databricks.com&quot; class=&quot;user-hover&quot; rel=&quot;rxin@databricks.com&quot;&gt;rxin@databricks.com&lt;/a&gt;. We should look to get this into 2.4.1 and 3.0.&lt;/p&gt;</comment>
                            <comment id="16689040" author="cloud_fan" created="Fri, 16 Nov 2018 05:16:55 +0000"  >&lt;p&gt;looks like a bug when we rewrite correlated subquery, cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=viirya&quot; class=&quot;user-hover&quot; rel=&quot;viirya&quot;&gt;viirya&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mgaido&quot; class=&quot;user-hover&quot; rel=&quot;mgaido&quot;&gt;mgaido&lt;/a&gt; &lt;/p&gt;</comment>
                            <comment id="16689262" author="mgaido" created="Fri, 16 Nov 2018 10:18:40 +0000"  >&lt;p&gt;I&apos;ll investigate this immediately, thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cloud_fan&quot; class=&quot;user-hover&quot; rel=&quot;cloud_fan&quot;&gt;cloud_fan&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16689268" author="viirya" created="Fri, 16 Nov 2018 10:26:46 +0000"  >&lt;p&gt;I simply have a look for it, but don&apos;t have great fix yet. If &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mgaido&quot; class=&quot;user-hover&quot; rel=&quot;mgaido&quot;&gt;mgaido&lt;/a&gt; can come out a PR, I can help review it. Thanks.&lt;/p&gt;</comment>
                            <comment id="16689368" author="apachespark" created="Fri, 16 Nov 2018 12:38:28 +0000"  >&lt;p&gt;User &apos;mgaido91&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/23057&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23057&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16689370" author="apachespark" created="Fri, 16 Nov 2018 12:39:34 +0000"  >&lt;p&gt;User &apos;mgaido91&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/23057&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23057&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16716091" author="githubbot" created="Tue, 11 Dec 2018 03:40:25 +0000"  >&lt;p&gt;cloud-fan commented on a change in pull request #23057: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26078&quot; title=&quot;WHERE .. IN fails to filter rows when used in combination with UNION&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26078&quot;&gt;&lt;del&gt;SPARK-26078&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;SQL&amp;#93;&lt;/span&gt; Dedup self-join attributes on IN subqueries&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23057#discussion_r240464363&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23057#discussion_r240464363&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: sql/core/src/test/scala/org/apache/spark/sql/SubquerySuite.scala&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -1280,4 +1281,46 @@ class SubquerySuite extends QueryTest with SharedSQLContext &lt;/p&gt;
{
       assert(subqueries.length == 1)
     }
&lt;p&gt;   }&lt;br/&gt;
+&lt;br/&gt;
+  test(&quot;&lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26078&quot; title=&quot;WHERE .. IN fails to filter rows when used in combination with UNION&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26078&quot;&gt;&lt;del&gt;SPARK-26078&lt;/del&gt;&lt;/a&gt;: deduplicate fake self joins for IN subqueries&quot;) {&lt;br/&gt;
+    withTempView(&quot;a&quot;, &quot;b&quot;) {&lt;br/&gt;
+      def genTestViewWithName(name: String): Unit = &lt;/p&gt;
{
+        val df = spark.createDataFrame(
+          spark.sparkContext.parallelize(Seq(Row(&quot;a&quot;, 2), Row(&quot;b&quot;, 1))),
+          StructType(Seq(StructField(&quot;id&quot;, StringType), StructField(&quot;num&quot;, IntegerType))))
+        df.createOrReplaceTempView(name)
+      }
&lt;p&gt;+      genTestViewWithName(&quot;a&quot;)&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   nit:&lt;br/&gt;
   ```&lt;br/&gt;
   Seq(&quot;a&quot; -&amp;gt; 2, &quot;b&quot; -&amp;gt; 1).toDF(&quot;id&quot;, &quot;num&quot;).createTempView(&quot;a&quot;)&lt;br/&gt;
   Seq(&quot;a&quot; -&amp;gt; 2, &quot;b&quot; -&amp;gt; 1).toDF(&quot;id&quot;, &quot;num&quot;).createTempView(&quot;b&quot;)&lt;br/&gt;
   ```&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16716102" author="githubbot" created="Tue, 11 Dec 2018 03:45:07 +0000"  >&lt;p&gt;cloud-fan commented on a change in pull request #23057: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26078&quot; title=&quot;WHERE .. IN fails to filter rows when used in combination with UNION&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26078&quot;&gt;&lt;del&gt;SPARK-26078&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;SQL&amp;#93;&lt;/span&gt; Dedup self-join attributes on IN subqueries&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23057#discussion_r240465020&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23057#discussion_r240465020&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/optimizer/subquery.scala&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -92,18 +114,20 @@ object RewritePredicateSubquery extends Rule&lt;span class=&quot;error&quot;&gt;&amp;#91;LogicalPlan&amp;#93;&lt;/span&gt; with PredicateHelper {&lt;br/&gt;
           // Deduplicate conflicting attributes if any.&lt;br/&gt;
           dedupJoin(Join(outerPlan, sub, LeftAnti, joinCond))&lt;br/&gt;
         case (p, InSubquery(values, ListQuery(sub, conditions, _, _))) =&amp;gt;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;val inConditions = values.zip(sub.output).map(EqualTo.tupled)&lt;br/&gt;
+          val newSub = dedupSubqueryOnSelfJoin(values, sub)&lt;br/&gt;
+          val inConditions = values.zip(newSub.output).map(EqualTo.tupled)&lt;br/&gt;
           val (joinCond, outerPlan) = rewriteExistentialExpr(inConditions ++ conditions, p)&lt;br/&gt;
           // Deduplicate conflicting attributes if any.&lt;/li&gt;
	&lt;li&gt;dedupJoin(Join(outerPlan, sub, LeftSemi, joinCond))&lt;br/&gt;
+          dedupJoin(Join(outerPlan, newSub, LeftSemi, joinCond))&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   do we still need to dedup here?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16716106" author="githubbot" created="Tue, 11 Dec 2018 03:46:26 +0000"  >&lt;p&gt;cloud-fan commented on a change in pull request #23057: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26078&quot; title=&quot;WHERE .. IN fails to filter rows when used in combination with UNION&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26078&quot;&gt;&lt;del&gt;SPARK-26078&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;SQL&amp;#93;&lt;/span&gt; Dedup self-join attributes on IN subqueries&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23057#discussion_r240465174&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23057#discussion_r240465174&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/optimizer/subquery.scala&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -92,18 +114,20 @@ object RewritePredicateSubquery extends Rule&lt;span class=&quot;error&quot;&gt;&amp;#91;LogicalPlan&amp;#93;&lt;/span&gt; with PredicateHelper {&lt;br/&gt;
           // Deduplicate conflicting attributes if any.&lt;br/&gt;
           dedupJoin(Join(outerPlan, sub, LeftAnti, joinCond))&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   Looks like we don&apos;t need `dedupJoin`, but always dedup the subquery before putting it in a join.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16716765" author="githubbot" created="Tue, 11 Dec 2018 10:13:09 +0000"  >&lt;p&gt;mgaido91 commented on a change in pull request #23057: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26078&quot; title=&quot;WHERE .. IN fails to filter rows when used in combination with UNION&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26078&quot;&gt;&lt;del&gt;SPARK-26078&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;SQL&amp;#93;&lt;/span&gt; Dedup self-join attributes on IN subqueries&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23057#discussion_r240546881&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23057#discussion_r240546881&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/optimizer/subquery.scala&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -92,18 +114,20 @@ object RewritePredicateSubquery extends Rule&lt;span class=&quot;error&quot;&gt;&amp;#91;LogicalPlan&amp;#93;&lt;/span&gt; with PredicateHelper {&lt;br/&gt;
           // Deduplicate conflicting attributes if any.&lt;br/&gt;
           dedupJoin(Join(outerPlan, sub, LeftAnti, joinCond))&lt;br/&gt;
         case (p, InSubquery(values, ListQuery(sub, conditions, _, _))) =&amp;gt;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;val inConditions = values.zip(sub.output).map(EqualTo.tupled)&lt;br/&gt;
+          val newSub = dedupSubqueryOnSelfJoin(values, sub)&lt;br/&gt;
+          val inConditions = values.zip(newSub.output).map(EqualTo.tupled)&lt;br/&gt;
           val (joinCond, outerPlan) = rewriteExistentialExpr(inConditions ++ conditions, p)&lt;br/&gt;
           // Deduplicate conflicting attributes if any.&lt;/li&gt;
	&lt;li&gt;dedupJoin(Join(outerPlan, sub, LeftSemi, joinCond))&lt;br/&gt;
+          dedupJoin(Join(outerPlan, newSub, LeftSemi, joinCond))&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   I think we don&apos;t, let me remove it.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16716768" author="githubbot" created="Tue, 11 Dec 2018 10:15:15 +0000"  >&lt;p&gt;mgaido91 commented on a change in pull request #23057: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26078&quot; title=&quot;WHERE .. IN fails to filter rows when used in combination with UNION&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26078&quot;&gt;&lt;del&gt;SPARK-26078&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;SQL&amp;#93;&lt;/span&gt; Dedup self-join attributes on IN subqueries&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23057#discussion_r240547635&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23057#discussion_r240547635&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/optimizer/subquery.scala&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -92,18 +114,20 @@ object RewritePredicateSubquery extends Rule&lt;span class=&quot;error&quot;&gt;&amp;#91;LogicalPlan&amp;#93;&lt;/span&gt; with PredicateHelper {&lt;br/&gt;
           // Deduplicate conflicting attributes if any.&lt;br/&gt;
           dedupJoin(Join(outerPlan, sub, LeftAnti, joinCond))&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   I think it makes sense to dedup the subquery only when the join condition has not been created yet (so in the case of `InSubquery`). In this case, the condition is already there, so I think we still have to use `dedupJoin` (for `Exists`)&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16716779" author="githubbot" created="Tue, 11 Dec 2018 10:21:15 +0000"  >&lt;p&gt;SparkQA commented on issue #23057: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26078&quot; title=&quot;WHERE .. IN fails to filter rows when used in combination with UNION&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26078&quot;&gt;&lt;del&gt;SPARK-26078&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;SQL&amp;#93;&lt;/span&gt; Dedup self-join attributes on IN subqueries&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23057#issuecomment-446149132&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23057#issuecomment-446149132&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   **&lt;a href=&quot;#99968 has started&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Test build #99968 has started&lt;/a&gt;(&lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/99968/testReport)**&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/99968/testReport)**&lt;/a&gt; for PR 23057 at commit &lt;span class=&quot;error&quot;&gt;&amp;#91;`1beb40c`&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://github.com/apache/spark/commit/1beb40ce0aa21f20d46ce34ce227b0e444ace80b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/commit/1beb40ce0aa21f20d46ce34ce227b0e444ace80b&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16716780" author="githubbot" created="Tue, 11 Dec 2018 10:21:22 +0000"  >&lt;p&gt;AmplabJenkins commented on issue #23057: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26078&quot; title=&quot;WHERE .. IN fails to filter rows when used in combination with UNION&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26078&quot;&gt;&lt;del&gt;SPARK-26078&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;SQL&amp;#93;&lt;/span&gt; Dedup self-join attributes on IN subqueries&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23057#issuecomment-446149182&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23057#issuecomment-446149182&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Merged build finished. Test PASSed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16716781" author="githubbot" created="Tue, 11 Dec 2018 10:21:23 +0000"  >&lt;p&gt;AmplabJenkins commented on issue #23057: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26078&quot; title=&quot;WHERE .. IN fails to filter rows when used in combination with UNION&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26078&quot;&gt;&lt;del&gt;SPARK-26078&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;SQL&amp;#93;&lt;/span&gt; Dedup self-join attributes on IN subqueries&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23057#issuecomment-446149189&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23057#issuecomment-446149189&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Test PASSed.&lt;br/&gt;
   Refer to this link for build results (access rights to CI server needed): &lt;br/&gt;
   &lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins//job/testing-k8s-prb-make-spark-distribution-unified/5968/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins//job/testing-k8s-prb-make-spark-distribution-unified/5968/&lt;/a&gt;&lt;br/&gt;
   Test PASSed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16716786" author="githubbot" created="Tue, 11 Dec 2018 10:22:08 +0000"  >&lt;p&gt;AmplabJenkins removed a comment on issue #23057: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26078&quot; title=&quot;WHERE .. IN fails to filter rows when used in combination with UNION&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26078&quot;&gt;&lt;del&gt;SPARK-26078&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;SQL&amp;#93;&lt;/span&gt; Dedup self-join attributes on IN subqueries&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23057#issuecomment-446149182&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23057#issuecomment-446149182&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Merged build finished. Test PASSed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16716788" author="githubbot" created="Tue, 11 Dec 2018 10:22:08 +0000"  >&lt;p&gt;AmplabJenkins removed a comment on issue #23057: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26078&quot; title=&quot;WHERE .. IN fails to filter rows when used in combination with UNION&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26078&quot;&gt;&lt;del&gt;SPARK-26078&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;SQL&amp;#93;&lt;/span&gt; Dedup self-join attributes on IN subqueries&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23057#issuecomment-446149189&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23057#issuecomment-446149189&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Test PASSed.&lt;br/&gt;
   Refer to this link for build results (access rights to CI server needed): &lt;br/&gt;
   &lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins//job/testing-k8s-prb-make-spark-distribution-unified/5968/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins//job/testing-k8s-prb-make-spark-distribution-unified/5968/&lt;/a&gt;&lt;br/&gt;
   Test PASSed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16716935" author="githubbot" created="Tue, 11 Dec 2018 12:00:22 +0000"  >&lt;p&gt;SparkQA commented on issue #23057: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26078&quot; title=&quot;WHERE .. IN fails to filter rows when used in combination with UNION&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26078&quot;&gt;&lt;del&gt;SPARK-26078&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;SQL&amp;#93;&lt;/span&gt; Dedup self-join attributes on IN subqueries&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23057#issuecomment-446178058&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23057#issuecomment-446178058&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   **&lt;a href=&quot;#99968 has finished&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Test build #99968 has finished&lt;/a&gt;(&lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/99968/testReport)**&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/99968/testReport)**&lt;/a&gt; for PR 23057 at commit &lt;span class=&quot;error&quot;&gt;&amp;#91;`1beb40c`&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://github.com/apache/spark/commit/1beb40ce0aa21f20d46ce34ce227b0e444ace80b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/commit/1beb40ce0aa21f20d46ce34ce227b0e444ace80b&lt;/a&gt;).&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;This patch *&lt;b&gt;fails Spark unit tests&lt;/b&gt;*.&lt;/li&gt;
	&lt;li&gt;This patch merges cleanly.&lt;/li&gt;
	&lt;li&gt;This patch adds no public classes.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16716938" author="githubbot" created="Tue, 11 Dec 2018 12:01:04 +0000"  >&lt;p&gt;AmplabJenkins commented on issue #23057: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26078&quot; title=&quot;WHERE .. IN fails to filter rows when used in combination with UNION&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26078&quot;&gt;&lt;del&gt;SPARK-26078&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;SQL&amp;#93;&lt;/span&gt; Dedup self-join attributes on IN subqueries&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23057#issuecomment-446178243&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23057#issuecomment-446178243&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Merged build finished. Test FAILed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16716939" author="githubbot" created="Tue, 11 Dec 2018 12:01:05 +0000"  >&lt;p&gt;AmplabJenkins commented on issue #23057: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26078&quot; title=&quot;WHERE .. IN fails to filter rows when used in combination with UNION&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26078&quot;&gt;&lt;del&gt;SPARK-26078&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;SQL&amp;#93;&lt;/span&gt; Dedup self-join attributes on IN subqueries&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23057#issuecomment-446178252&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23057#issuecomment-446178252&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Test FAILed.&lt;br/&gt;
   Refer to this link for build results (access rights to CI server needed): &lt;br/&gt;
   &lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins//job/SparkPullRequestBuilder/99968/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins//job/SparkPullRequestBuilder/99968/&lt;/a&gt;&lt;br/&gt;
   Test FAILed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16716940" author="githubbot" created="Tue, 11 Dec 2018 12:01:09 +0000"  >&lt;p&gt;SparkQA removed a comment on issue #23057: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26078&quot; title=&quot;WHERE .. IN fails to filter rows when used in combination with UNION&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26078&quot;&gt;&lt;del&gt;SPARK-26078&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;SQL&amp;#93;&lt;/span&gt; Dedup self-join attributes on IN subqueries&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23057#issuecomment-446149132&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23057#issuecomment-446149132&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   **&lt;a href=&quot;#99968 has started&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Test build #99968 has started&lt;/a&gt;(&lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/99968/testReport)**&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/99968/testReport)**&lt;/a&gt; for PR 23057 at commit &lt;span class=&quot;error&quot;&gt;&amp;#91;`1beb40c`&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://github.com/apache/spark/commit/1beb40ce0aa21f20d46ce34ce227b0e444ace80b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/commit/1beb40ce0aa21f20d46ce34ce227b0e444ace80b&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16716941" author="githubbot" created="Tue, 11 Dec 2018 12:01:09 +0000"  >&lt;p&gt;AmplabJenkins removed a comment on issue #23057: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26078&quot; title=&quot;WHERE .. IN fails to filter rows when used in combination with UNION&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26078&quot;&gt;&lt;del&gt;SPARK-26078&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;SQL&amp;#93;&lt;/span&gt; Dedup self-join attributes on IN subqueries&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23057#issuecomment-446178243&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23057#issuecomment-446178243&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Merged build finished. Test FAILed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16716944" author="githubbot" created="Tue, 11 Dec 2018 12:01:47 +0000"  >&lt;p&gt;mgaido91 commented on issue #23057: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26078&quot; title=&quot;WHERE .. IN fails to filter rows when used in combination with UNION&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26078&quot;&gt;&lt;del&gt;SPARK-26078&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;SQL&amp;#93;&lt;/span&gt; Dedup self-join attributes on IN subqueries&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23057#issuecomment-446178436&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23057#issuecomment-446178436&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   retest this please&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16716946" author="githubbot" created="Tue, 11 Dec 2018 12:02:09 +0000"  >&lt;p&gt;AmplabJenkins removed a comment on issue #23057: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26078&quot; title=&quot;WHERE .. IN fails to filter rows when used in combination with UNION&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26078&quot;&gt;&lt;del&gt;SPARK-26078&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;SQL&amp;#93;&lt;/span&gt; Dedup self-join attributes on IN subqueries&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23057#issuecomment-446178252&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23057#issuecomment-446178252&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Test FAILed.&lt;br/&gt;
   Refer to this link for build results (access rights to CI server needed): &lt;br/&gt;
   &lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins//job/SparkPullRequestBuilder/99968/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins//job/SparkPullRequestBuilder/99968/&lt;/a&gt;&lt;br/&gt;
   Test FAILed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16716960" author="githubbot" created="Tue, 11 Dec 2018 12:07:03 +0000"  >&lt;p&gt;SparkQA commented on issue #23057: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26078&quot; title=&quot;WHERE .. IN fails to filter rows when used in combination with UNION&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26078&quot;&gt;&lt;del&gt;SPARK-26078&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;SQL&amp;#93;&lt;/span&gt; Dedup self-join attributes on IN subqueries&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23057#issuecomment-446179795&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23057#issuecomment-446179795&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   **&lt;a href=&quot;#99970 has started&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Test build #99970 has started&lt;/a&gt;(&lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/99970/testReport)**&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/99970/testReport)**&lt;/a&gt; for PR 23057 at commit &lt;span class=&quot;error&quot;&gt;&amp;#91;`1beb40c`&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://github.com/apache/spark/commit/1beb40ce0aa21f20d46ce34ce227b0e444ace80b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/commit/1beb40ce0aa21f20d46ce34ce227b0e444ace80b&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16716963" author="githubbot" created="Tue, 11 Dec 2018 12:07:30 +0000"  >&lt;p&gt;AmplabJenkins commented on issue #23057: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26078&quot; title=&quot;WHERE .. IN fails to filter rows when used in combination with UNION&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26078&quot;&gt;&lt;del&gt;SPARK-26078&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;SQL&amp;#93;&lt;/span&gt; Dedup self-join attributes on IN subqueries&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23057#issuecomment-446179922&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23057#issuecomment-446179922&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Merged build finished. Test PASSed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16716964" author="githubbot" created="Tue, 11 Dec 2018 12:07:32 +0000"  >&lt;p&gt;AmplabJenkins commented on issue #23057: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26078&quot; title=&quot;WHERE .. IN fails to filter rows when used in combination with UNION&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26078&quot;&gt;&lt;del&gt;SPARK-26078&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;SQL&amp;#93;&lt;/span&gt; Dedup self-join attributes on IN subqueries&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23057#issuecomment-446179930&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23057#issuecomment-446179930&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Test PASSed.&lt;br/&gt;
   Refer to this link for build results (access rights to CI server needed): &lt;br/&gt;
   &lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins//job/testing-k8s-prb-make-spark-distribution-unified/5970/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins//job/testing-k8s-prb-make-spark-distribution-unified/5970/&lt;/a&gt;&lt;br/&gt;
   Test PASSed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16716965" author="githubbot" created="Tue, 11 Dec 2018 12:08:09 +0000"  >&lt;p&gt;AmplabJenkins removed a comment on issue #23057: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26078&quot; title=&quot;WHERE .. IN fails to filter rows when used in combination with UNION&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26078&quot;&gt;&lt;del&gt;SPARK-26078&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;SQL&amp;#93;&lt;/span&gt; Dedup self-join attributes on IN subqueries&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23057#issuecomment-446179922&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23057#issuecomment-446179922&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Merged build finished. Test PASSed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16716966" author="githubbot" created="Tue, 11 Dec 2018 12:08:09 +0000"  >&lt;p&gt;AmplabJenkins removed a comment on issue #23057: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26078&quot; title=&quot;WHERE .. IN fails to filter rows when used in combination with UNION&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26078&quot;&gt;&lt;del&gt;SPARK-26078&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;SQL&amp;#93;&lt;/span&gt; Dedup self-join attributes on IN subqueries&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23057#issuecomment-446179930&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23057#issuecomment-446179930&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Test PASSed.&lt;br/&gt;
   Refer to this link for build results (access rights to CI server needed): &lt;br/&gt;
   &lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins//job/testing-k8s-prb-make-spark-distribution-unified/5970/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins//job/testing-k8s-prb-make-spark-distribution-unified/5970/&lt;/a&gt;&lt;br/&gt;
   Test PASSed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717118" author="githubbot" created="Tue, 11 Dec 2018 13:23:02 +0000"  >&lt;p&gt;cloud-fan commented on a change in pull request #23057: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26078&quot; title=&quot;WHERE .. IN fails to filter rows when used in combination with UNION&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26078&quot;&gt;&lt;del&gt;SPARK-26078&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;SQL&amp;#93;&lt;/span&gt; Dedup self-join attributes on IN subqueries&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23057#discussion_r240606988&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23057#discussion_r240606988&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/optimizer/subquery.scala&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -92,18 +114,20 @@ object RewritePredicateSubquery extends Rule&lt;span class=&quot;error&quot;&gt;&amp;#91;LogicalPlan&amp;#93;&lt;/span&gt; with PredicateHelper {&lt;br/&gt;
           // Deduplicate conflicting attributes if any.&lt;br/&gt;
           dedupJoin(Join(outerPlan, sub, LeftAnti, joinCond))&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   `dedupJoin` will evetually dedup the subquery IIUC.&lt;/p&gt;

&lt;p&gt;   What I&apos;d like to do is to unify `dedupJoin` and `dedupSubqueryOnSelfJoin`, so that the code will be consistent for all cases:&lt;br/&gt;
   ```&lt;br/&gt;
   val newSub = dedup(sub, values)&lt;br/&gt;
   // create join condition if any&lt;br/&gt;
   Join(outerPlan, newSub, ...)&lt;br/&gt;
   ```&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717215" author="githubbot" created="Tue, 11 Dec 2018 13:59:37 +0000"  >&lt;p&gt;mgaido91 commented on a change in pull request #23057: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26078&quot; title=&quot;WHERE .. IN fails to filter rows when used in combination with UNION&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26078&quot;&gt;&lt;del&gt;SPARK-26078&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;SQL&amp;#93;&lt;/span&gt; Dedup self-join attributes on IN subqueries&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23057#discussion_r240619938&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23057#discussion_r240619938&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/optimizer/subquery.scala&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -92,18 +114,20 @@ object RewritePredicateSubquery extends Rule&lt;span class=&quot;error&quot;&gt;&amp;#91;LogicalPlan&amp;#93;&lt;/span&gt; with PredicateHelper {&lt;br/&gt;
           // Deduplicate conflicting attributes if any.&lt;br/&gt;
           dedupJoin(Join(outerPlan, sub, LeftAnti, joinCond))&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   the main problem is that in the other cases, so when exists is there, the condition is already created. So we would need to complicate quite a lot the method in order to handle the 2 cases and I am not sure wether it is worth. For instance, the `values`, in the `Exists` case, should be taken from the conditions as those expressions referencing attributes from one side and the join condition needs to be rewritten. So I don&apos;t think that it is a good idea to have a common rewrite for both them: it would be overcomplicated IMHO.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717325" author="githubbot" created="Tue, 11 Dec 2018 15:00:06 +0000"  >&lt;p&gt;SparkQA commented on issue #23057: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26078&quot; title=&quot;WHERE .. IN fails to filter rows when used in combination with UNION&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26078&quot;&gt;&lt;del&gt;SPARK-26078&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;SQL&amp;#93;&lt;/span&gt; Dedup self-join attributes on IN subqueries&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23057#issuecomment-446232594&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23057#issuecomment-446232594&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   **&lt;a href=&quot;#99970 has finished&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Test build #99970 has finished&lt;/a&gt;(&lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/99970/testReport)**&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/99970/testReport)**&lt;/a&gt; for PR 23057 at commit &lt;span class=&quot;error&quot;&gt;&amp;#91;`1beb40c`&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://github.com/apache/spark/commit/1beb40ce0aa21f20d46ce34ce227b0e444ace80b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/commit/1beb40ce0aa21f20d46ce34ce227b0e444ace80b&lt;/a&gt;).&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;This patch *&lt;b&gt;fails Spark unit tests&lt;/b&gt;*.&lt;/li&gt;
	&lt;li&gt;This patch merges cleanly.&lt;/li&gt;
	&lt;li&gt;This patch adds no public classes.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717329" author="githubbot" created="Tue, 11 Dec 2018 15:01:00 +0000"  >&lt;p&gt;AmplabJenkins commented on issue #23057: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26078&quot; title=&quot;WHERE .. IN fails to filter rows when used in combination with UNION&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26078&quot;&gt;&lt;del&gt;SPARK-26078&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;SQL&amp;#93;&lt;/span&gt; Dedup self-join attributes on IN subqueries&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23057#issuecomment-446232914&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23057#issuecomment-446232914&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Merged build finished. Test FAILed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717330" author="githubbot" created="Tue, 11 Dec 2018 15:01:01 +0000"  >&lt;p&gt;AmplabJenkins commented on issue #23057: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26078&quot; title=&quot;WHERE .. IN fails to filter rows when used in combination with UNION&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26078&quot;&gt;&lt;del&gt;SPARK-26078&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;SQL&amp;#93;&lt;/span&gt; Dedup self-join attributes on IN subqueries&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23057#issuecomment-446232924&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23057#issuecomment-446232924&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Test FAILed.&lt;br/&gt;
   Refer to this link for build results (access rights to CI server needed): &lt;br/&gt;
   &lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins//job/SparkPullRequestBuilder/99970/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins//job/SparkPullRequestBuilder/99970/&lt;/a&gt;&lt;br/&gt;
   Test FAILed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717331" author="githubbot" created="Tue, 11 Dec 2018 15:01:09 +0000"  >&lt;p&gt;SparkQA removed a comment on issue #23057: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26078&quot; title=&quot;WHERE .. IN fails to filter rows when used in combination with UNION&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26078&quot;&gt;&lt;del&gt;SPARK-26078&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;SQL&amp;#93;&lt;/span&gt; Dedup self-join attributes on IN subqueries&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23057#issuecomment-446179795&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23057#issuecomment-446179795&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   **&lt;a href=&quot;#99970 has started&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Test build #99970 has started&lt;/a&gt;(&lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/99970/testReport)**&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/99970/testReport)**&lt;/a&gt; for PR 23057 at commit &lt;span class=&quot;error&quot;&gt;&amp;#91;`1beb40c`&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://github.com/apache/spark/commit/1beb40ce0aa21f20d46ce34ce227b0e444ace80b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/commit/1beb40ce0aa21f20d46ce34ce227b0e444ace80b&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717332" author="githubbot" created="Tue, 11 Dec 2018 15:01:09 +0000"  >&lt;p&gt;AmplabJenkins removed a comment on issue #23057: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26078&quot; title=&quot;WHERE .. IN fails to filter rows when used in combination with UNION&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26078&quot;&gt;&lt;del&gt;SPARK-26078&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;SQL&amp;#93;&lt;/span&gt; Dedup self-join attributes on IN subqueries&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23057#issuecomment-446232914&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23057#issuecomment-446232914&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Merged build finished. Test FAILed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717333" author="githubbot" created="Tue, 11 Dec 2018 15:02:10 +0000"  >&lt;p&gt;AmplabJenkins removed a comment on issue #23057: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26078&quot; title=&quot;WHERE .. IN fails to filter rows when used in combination with UNION&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26078&quot;&gt;&lt;del&gt;SPARK-26078&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;SQL&amp;#93;&lt;/span&gt; Dedup self-join attributes on IN subqueries&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23057#issuecomment-446232924&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23057#issuecomment-446232924&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Test FAILed.&lt;br/&gt;
   Refer to this link for build results (access rights to CI server needed): &lt;br/&gt;
   &lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins//job/SparkPullRequestBuilder/99970/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins//job/SparkPullRequestBuilder/99970/&lt;/a&gt;&lt;br/&gt;
   Test FAILed.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16717405" author="githubbot" created="Tue, 11 Dec 2018 15:41:54 +0000"  >&lt;p&gt;cloud-fan commented on a change in pull request #23057: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26078&quot; title=&quot;WHERE .. IN fails to filter rows when used in combination with UNION&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26078&quot;&gt;&lt;del&gt;SPARK-26078&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;SQL&amp;#93;&lt;/span&gt; Dedup self-join attributes on IN subqueries&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23057#discussion_r240663908&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23057#discussion_r240663908&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/optimizer/subquery.scala&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -92,18 +114,20 @@ object RewritePredicateSubquery extends Rule&lt;span class=&quot;error&quot;&gt;&amp;#91;LogicalPlan&amp;#93;&lt;/span&gt; with PredicateHelper {&lt;br/&gt;
           // Deduplicate conflicting attributes if any.&lt;br/&gt;
           dedupJoin(Join(outerPlan, sub, LeftAnti, joinCond))&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   ah thanks for the explanation! Makes sense to me.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16722362" author="cloud_fan" created="Sun, 16 Dec 2018 02:59:55 +0000"  >&lt;p&gt;Issue resolved by pull request 23057&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/23057&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23057&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16722363" author="githubbot" created="Sun, 16 Dec 2018 03:02:18 +0000"  >&lt;p&gt;asfgit closed pull request #23057: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26078&quot; title=&quot;WHERE .. IN fails to filter rows when used in combination with UNION&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26078&quot;&gt;&lt;del&gt;SPARK-26078&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;SQL&amp;#93;&lt;/span&gt; Dedup self-join attributes on IN subqueries&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/spark/pull/23057&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23057&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/optimizer/subquery.scala b/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/optimizer/subquery.scala&lt;br/&gt;
index e9b7a8b76e683..34840c6c977a6 100644&lt;br/&gt;
&amp;#8212; a/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/optimizer/subquery.scala&lt;br/&gt;
+++ b/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/optimizer/subquery.scala&lt;br/&gt;
@@ -19,7 +19,7 @@ package org.apache.spark.sql.catalyst.optimizer&lt;/p&gt;

&lt;p&gt; import scala.collection.mutable.ArrayBuffer&lt;/p&gt;

&lt;p&gt;-import org.apache.spark.sql.catalyst.InternalRow&lt;br/&gt;
+import org.apache.spark.sql.AnalysisException&lt;br/&gt;
 import org.apache.spark.sql.catalyst.expressions._&lt;br/&gt;
 import org.apache.spark.sql.catalyst.expressions.SubExprUtils._&lt;br/&gt;
 import org.apache.spark.sql.catalyst.expressions.aggregate._&lt;br/&gt;
@@ -43,31 +43,53 @@ import org.apache.spark.sql.types._&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;condition.&lt;br/&gt;
  */&lt;br/&gt;
 object RewritePredicateSubquery extends Rule&lt;span class=&quot;error&quot;&gt;&amp;#91;LogicalPlan&amp;#93;&lt;/span&gt; with PredicateHelper {&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private def dedupJoin(joinPlan: LogicalPlan): LogicalPlan = joinPlan match {&lt;br/&gt;
+&lt;br/&gt;
+  private def buildJoin(&lt;br/&gt;
+      outerPlan: LogicalPlan,&lt;br/&gt;
+      subplan: LogicalPlan,&lt;br/&gt;
+      joinType: JoinType,&lt;br/&gt;
+      condition: Option&lt;span class=&quot;error&quot;&gt;&amp;#91;Expression&amp;#93;&lt;/span&gt;): Join = 
{
+    // Deduplicate conflicting attributes if any.
+    val dedupSubplan = dedupSubqueryOnSelfJoin(outerPlan, subplan, None, condition)
+    Join(outerPlan, dedupSubplan, joinType, condition)
+  }
&lt;p&gt;+&lt;br/&gt;
+  private def dedupSubqueryOnSelfJoin(&lt;br/&gt;
+      outerPlan: LogicalPlan,&lt;br/&gt;
+      subplan: LogicalPlan,&lt;br/&gt;
+      valuesOpt: Option[Seq&lt;span class=&quot;error&quot;&gt;&amp;#91;Expression&amp;#93;&lt;/span&gt;],&lt;br/&gt;
+      condition: Option&lt;span class=&quot;error&quot;&gt;&amp;#91;Expression&amp;#93;&lt;/span&gt; = None): LogicalPlan = {&lt;br/&gt;
     // &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-21835&quot; title=&quot;RewritePredicateSubquery should not produce unresolved query plans&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-21835&quot;&gt;&lt;del&gt;SPARK-21835&lt;/del&gt;&lt;/a&gt;: It is possibly that the two sides of the join have conflicting attributes,&lt;br/&gt;
     // the produced join then becomes unresolved and break structural integrity. We should&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;// de-duplicate conflicting attributes. We don&apos;t use transformation here because we only&lt;/li&gt;
	&lt;li&gt;// care about the most top join converted from correlated predicate subquery.&lt;/li&gt;
	&lt;li&gt;case j @ Join(left, right, joinType @ (LeftSemi | LeftAnti | ExistenceJoin(_)), joinCond) =&amp;gt;&lt;/li&gt;
	&lt;li&gt;val duplicates = right.outputSet.intersect(left.outputSet)&lt;/li&gt;
	&lt;li&gt;if (duplicates.nonEmpty) {&lt;/li&gt;
	&lt;li&gt;val aliasMap = AttributeMap(duplicates.map 
{ dup =&amp;gt;
-          dup -&amp;gt; Alias(dup, dup.toString)()
-        }
&lt;p&gt;.toSeq)&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;val aliasedExpressions = right.output.map 
{ ref =&amp;gt;
-          aliasMap.getOrElse(ref, ref)
-        }&lt;/li&gt;
	&lt;li&gt;val newRight = Project(aliasedExpressions, right)&lt;/li&gt;
	&lt;li&gt;val newJoinCond = joinCond.map { condExpr =&amp;gt;&lt;/li&gt;
	&lt;li&gt;condExpr transform {&lt;/li&gt;
	&lt;li&gt;case a: Attribute =&amp;gt; aliasMap.getOrElse(a, a).toAttribute&lt;br/&gt;
+    // de-duplicate conflicting attributes.&lt;br/&gt;
+    // &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26078&quot; title=&quot;WHERE .. IN fails to filter rows when used in combination with UNION&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26078&quot;&gt;&lt;del&gt;SPARK-26078&lt;/del&gt;&lt;/a&gt;: it may also happen that the subquery has conflicting attributes with the outer&lt;br/&gt;
+    // values. In this case, the resulting join would contain trivially true conditions (eg.&lt;br/&gt;
+    // id#3 = id#3) which cannot be de-duplicated after. In this method, if there are conflicting&lt;br/&gt;
+    // attributes in the join condition, the subquery&apos;s conflicting attributes are changed using&lt;br/&gt;
+    // a projection which aliases them and resolves the problem.&lt;br/&gt;
+    val outerReferences = valuesOpt.map(values =&amp;gt;&lt;br/&gt;
+      AttributeSet.fromAttributeSets(values.map(_.references))).getOrElse(AttributeSet.empty)&lt;br/&gt;
+    val outerRefs = outerPlan.outputSet ++ outerReferences&lt;br/&gt;
+    val duplicates = outerRefs.intersect(subplan.outputSet)&lt;br/&gt;
+    if (duplicates.nonEmpty) {&lt;br/&gt;
+      condition.foreach { e =&amp;gt;&lt;br/&gt;
+          val conflictingAttrs = e.references.intersect(duplicates)&lt;br/&gt;
+          if (conflictingAttrs.nonEmpty) {&lt;br/&gt;
+            throw new AnalysisException(&quot;Found conflicting attributes &quot; +&lt;br/&gt;
+              s&quot;${conflictingAttrs.mkString(&quot;,&quot;)} in the condition joining outer plan:\n  &quot; +&lt;br/&gt;
+              s&quot;$outerPlan\nand subplan:\n  $subplan&quot;)&lt;br/&gt;
           }&lt;/li&gt;
	&lt;li&gt;}&lt;/li&gt;
	&lt;li&gt;Join(left, newRight, joinType, newJoinCond)&lt;/li&gt;
	&lt;li&gt;} else 
{
-        j
       }&lt;/li&gt;
	&lt;li&gt;case _ =&amp;gt; joinPlan&lt;br/&gt;
+      val rewrites = AttributeMap(duplicates.map 
{ dup =&amp;gt;
+        dup -&amp;gt; Alias(dup, dup.toString)()
+      }
&lt;p&gt;.toSeq)&lt;br/&gt;
+      val aliasedExpressions = subplan.output.map &lt;/p&gt;
{ ref =&amp;gt;
+        rewrites.getOrElse(ref, ref)
+      }
&lt;p&gt;+      Project(aliasedExpressions, subplan)&lt;br/&gt;
+    } else &lt;/p&gt;
{
+      subplan
+    }
&lt;p&gt;   }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;   def apply(plan: LogicalPlan): LogicalPlan = plan transform {&lt;br/&gt;
@@ -85,17 +107,16 @@ object RewritePredicateSubquery extends Rule&lt;span class=&quot;error&quot;&gt;&amp;#91;LogicalPlan&amp;#93;&lt;/span&gt; with PredicateHelper {&lt;br/&gt;
       withSubquery.foldLeft(newFilter) {&lt;br/&gt;
         case (p, Exists(sub, conditions, _)) =&amp;gt;&lt;br/&gt;
           val (joinCond, outerPlan) = rewriteExistentialExpr(conditions, p)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// Deduplicate conflicting attributes if any.&lt;/li&gt;
	&lt;li&gt;dedupJoin(Join(outerPlan, sub, LeftSemi, joinCond))&lt;br/&gt;
+          buildJoin(outerPlan, sub, LeftSemi, joinCond)&lt;br/&gt;
         case (p, Not(Exists(sub, conditions, _))) =&amp;gt;&lt;br/&gt;
           val (joinCond, outerPlan) = rewriteExistentialExpr(conditions, p)&lt;/li&gt;
	&lt;li&gt;// Deduplicate conflicting attributes if any.&lt;/li&gt;
	&lt;li&gt;dedupJoin(Join(outerPlan, sub, LeftAnti, joinCond))&lt;br/&gt;
+          buildJoin(outerPlan, sub, LeftAnti, joinCond)&lt;br/&gt;
         case (p, InSubquery(values, ListQuery(sub, conditions, _, _))) =&amp;gt;&lt;/li&gt;
	&lt;li&gt;val inConditions = values.zip(sub.output).map(EqualTo.tupled)&lt;/li&gt;
	&lt;li&gt;val (joinCond, outerPlan) = rewriteExistentialExpr(inConditions ++ conditions, p)&lt;br/&gt;
           // Deduplicate conflicting attributes if any.&lt;/li&gt;
	&lt;li&gt;dedupJoin(Join(outerPlan, sub, LeftSemi, joinCond))&lt;br/&gt;
+          val newSub = dedupSubqueryOnSelfJoin(p, sub, Some(values))&lt;br/&gt;
+          val inConditions = values.zip(newSub.output).map(EqualTo.tupled)&lt;br/&gt;
+          val (joinCond, outerPlan) = rewriteExistentialExpr(inConditions ++ conditions, p)&lt;br/&gt;
+          Join(outerPlan, newSub, LeftSemi, joinCond)&lt;br/&gt;
         case (p, Not(InSubquery(values, ListQuery(sub, conditions, _, _)))) =&amp;gt;&lt;br/&gt;
           // This is a NULL-aware (left) anti join (NAAJ) e.g. col NOT IN expr&lt;br/&gt;
           // Construct the condition. A NULL in one of the conditions is regarded as a positive&lt;br/&gt;
@@ -103,7 +124,10 @@ object RewritePredicateSubquery extends Rule&lt;span class=&quot;error&quot;&gt;&amp;#91;LogicalPlan&amp;#93;&lt;/span&gt; with PredicateHelper {&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;           // Note that will almost certainly be planned as a Broadcast Nested Loop join.&lt;br/&gt;
           // Use EXISTS if performance matters to you.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;val inConditions = values.zip(sub.output).map(EqualTo.tupled)&lt;br/&gt;
+&lt;br/&gt;
+          // Deduplicate conflicting attributes if any.&lt;br/&gt;
+          val newSub = dedupSubqueryOnSelfJoin(p, sub, Some(values))&lt;br/&gt;
+          val inConditions = values.zip(newSub.output).map(EqualTo.tupled)&lt;br/&gt;
           val (joinCond, outerPlan) = rewriteExistentialExpr(inConditions, p)&lt;br/&gt;
           // Expand the NOT IN expression with the NULL-aware semantic&lt;br/&gt;
           // to its full form. That is from:&lt;br/&gt;
@@ -118,8 +142,7 @@ object RewritePredicateSubquery extends Rule&lt;span class=&quot;error&quot;&gt;&amp;#91;LogicalPlan&amp;#93;&lt;/span&gt; with PredicateHelper {&lt;br/&gt;
           // will have the final conditions in the LEFT ANTI as&lt;br/&gt;
           // (A.A1 = B.B1 OR ISNULL(A.A1 = B.B1)) AND (B.B2 = A.A2) AND B.B3 &amp;gt; 1&lt;br/&gt;
           val finalJoinCond = (nullAwareJoinConds ++ conditions).reduceLeft(And)&lt;/li&gt;
	&lt;li&gt;// Deduplicate conflicting attributes if any.&lt;/li&gt;
	&lt;li&gt;dedupJoin(Join(outerPlan, sub, LeftAnti, Option(finalJoinCond)))&lt;br/&gt;
+          Join(outerPlan, newSub, LeftAnti, Option(finalJoinCond))&lt;br/&gt;
         case (p, predicate) =&amp;gt;&lt;br/&gt;
           val (newCond, inputPlan) = rewriteExistentialExpr(Seq(predicate), p)&lt;br/&gt;
           Project(p.output, Filter(newCond.get, inputPlan))&lt;br/&gt;
@@ -140,16 +163,16 @@ object RewritePredicateSubquery extends Rule&lt;span class=&quot;error&quot;&gt;&amp;#91;LogicalPlan&amp;#93;&lt;/span&gt; with PredicateHelper 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {       e transformUp {
         case Exists(sub, conditions, _) =&amp;gt;
           val exists = AttributeReference(&quot;exists&quot;, BooleanType, nullable = false)()
-          // Deduplicate conflicting attributes if any.
-          newPlan = dedupJoin(
-            Join(newPlan, sub, ExistenceJoin(exists), conditions.reduceLeftOption(And)))
+          newPlan =
+            buildJoin(newPlan, sub, ExistenceJoin(exists), conditions.reduceLeftOption(And))
           exists
         case InSubquery(values, ListQuery(sub, conditions, _, _)) =&amp;gt;
           val exists = AttributeReference(&quot;exists&quot;, BooleanType, nullable = false)()
-          val inConditions = values.zip(sub.output).map(EqualTo.tupled)
-          val newConditions = (inConditions ++ conditions).reduceLeftOption(And)
           // Deduplicate conflicting attributes if any.
-          newPlan = dedupJoin(Join(newPlan, sub, ExistenceJoin(exists), newConditions))
+          val newSub = dedupSubqueryOnSelfJoin(newPlan, sub, Some(values))
+          val inConditions = values.zip(newSub.output).map(EqualTo.tupled)
+          val newConditions = (inConditions ++ conditions).reduceLeftOption(And)
+          newPlan = Join(newPlan, newSub, ExistenceJoin(exists), newConditions)
           exists
       }     }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;diff --git a/sql/core/src/test/scala/org/apache/spark/sql/SubquerySuite.scala b/sql/core/src/test/scala/org/apache/spark/sql/SubquerySuite.scala&lt;br/&gt;
index 5088821ad7361..c95c52f1d3a9c 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/sql/core/src/test/scala/org/apache/spark/sql/SubquerySuite.scala&lt;br/&gt;
+++ b/sql/core/src/test/scala/org/apache/spark/sql/SubquerySuite.scala&lt;br/&gt;
@@ -22,6 +22,7 @@ import scala.collection.mutable.ArrayBuffer&lt;br/&gt;
 import org.apache.spark.sql.catalyst.expressions.SubqueryExpression&lt;br/&gt;
 import org.apache.spark.sql.catalyst.plans.logical.
{Join, LogicalPlan, Sort}
&lt;p&gt; import org.apache.spark.sql.test.SharedSQLContext&lt;br/&gt;
+import org.apache.spark.sql.types._&lt;/p&gt;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; class SubquerySuite extends QueryTest with SharedSQLContext {&lt;br/&gt;
   import testImplicits._&lt;br/&gt;
@@ -1280,4 +1281,40 @@ class SubquerySuite extends QueryTest with SharedSQLContext &lt;/p&gt;
{
       assert(subqueries.length == 1)
     }
&lt;p&gt;   }&lt;br/&gt;
+&lt;br/&gt;
+  test(&quot;&lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26078&quot; title=&quot;WHERE .. IN fails to filter rows when used in combination with UNION&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26078&quot;&gt;&lt;del&gt;SPARK-26078&lt;/del&gt;&lt;/a&gt;: deduplicate fake self joins for IN subqueries&quot;) {&lt;br/&gt;
+    withTempView(&quot;a&quot;, &quot;b&quot;) &lt;/p&gt;
{
+      Seq(&quot;a&quot; -&amp;gt; 2, &quot;b&quot; -&amp;gt; 1).toDF(&quot;id&quot;, &quot;num&quot;).createTempView(&quot;a&quot;)
+      Seq(&quot;a&quot; -&amp;gt; 2, &quot;b&quot; -&amp;gt; 1).toDF(&quot;id&quot;, &quot;num&quot;).createTempView(&quot;b&quot;)
+
+      val df1 = spark.sql(
+        &quot;&quot;&quot;
+          |SELECT id,num,source FROM (
+          |  SELECT id, num, &apos;a&apos; as source FROM a
+          |  UNION ALL
+          |  SELECT id, num, &apos;b&apos; as source FROM b
+          |) AS c WHERE c.id IN (SELECT id FROM b WHERE num = 2)
+        &quot;&quot;&quot;.stripMargin)
+      checkAnswer(df1, Seq(Row(&quot;a&quot;, 2, &quot;a&quot;), Row(&quot;a&quot;, 2, &quot;b&quot;)))
+      val df2 = spark.sql(
+        &quot;&quot;&quot;
+          |SELECT id,num,source FROM (
+          |  SELECT id, num, &apos;a&apos; as source FROM a
+          |  UNION ALL
+          |  SELECT id, num, &apos;b&apos; as source FROM b
+          |) AS c WHERE c.id NOT IN (SELECT id FROM b WHERE num = 2)
+        &quot;&quot;&quot;.stripMargin)
+      checkAnswer(df2, Seq(Row(&quot;b&quot;, 1, &quot;a&quot;), Row(&quot;b&quot;, 1, &quot;b&quot;)))
+      val df3 = spark.sql(
+        &quot;&quot;&quot;
+          |SELECT id,num,source FROM (
+          |  SELECT id, num, &apos;a&apos; as source FROM a
+          |  UNION ALL
+          |  SELECT id, num, &apos;b&apos; as source FROM b
+          |) AS c WHERE c.id IN (SELECT id FROM b WHERE num = 2) OR
+          |c.id IN (SELECT id FROM b WHERE num = 3)
+        &quot;&quot;&quot;.stripMargin)
+      checkAnswer(df3, Seq(Row(&quot;a&quot;, 2, &quot;a&quot;), Row(&quot;a&quot;, 2, &quot;b&quot;)))
+    }
&lt;p&gt;+  }&lt;br/&gt;
 }&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 48 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|s00jgw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12344117">2.4.1</customfieldvalue>
    <customfieldvalue id="12339177">3.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>