<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:58:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-23365] DynamicAllocation with failure in straggler task can lead to a hung spark job</title>
                <link>https://issues.apache.org/jira/browse/SPARK-23365</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Dynamic Allocation can lead to a spark app getting stuck with 0 executors requested when the executors in the last tasks of a taskset fail (eg. with an OOM).&lt;/p&gt;

&lt;p&gt;This happens when &lt;tt&gt;ExecutorAllocationManager&lt;/tt&gt; s internal target number of executors gets out of sync with &lt;tt&gt;CoarseGrainedSchedulerBackend&lt;/tt&gt; s target number.  &lt;tt&gt;EAM&lt;/tt&gt; updates the &lt;tt&gt;CGSB&lt;/tt&gt; in two ways: (1) it tracks how many tasks are active or pending in submitted stages, and computes how many executors would be needed for them.  And as tasks finish, it will actively decrease that count, informing the &lt;tt&gt;CGSB&lt;/tt&gt; along the way.  (2) When it decides executors are inactive for long enough, then it requests that &lt;tt&gt;CGSB&lt;/tt&gt; kill the executors &amp;#8211; this also tells the &lt;tt&gt;CGSB&lt;/tt&gt; to update its target number of executors: &lt;a href=&quot;https://github.com/apache/spark/blob/4df84c3f818aa536515729b442601e08c253ed35/core/src/main/scala/org/apache/spark/scheduler/cluster/CoarseGrainedSchedulerBackend.scala#L622&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/4df84c3f818aa536515729b442601e08c253ed35/core/src/main/scala/org/apache/spark/scheduler/cluster/CoarseGrainedSchedulerBackend.scala#L622&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;So when there is just one task left, you could have the following sequence of events:&lt;br/&gt;
(1) the &lt;tt&gt;EAM&lt;/tt&gt; sets the desired number of executors to 1, and updates the &lt;tt&gt;CGSB&lt;/tt&gt; too&lt;br/&gt;
(2) while that final task is still running, the other executors cross the idle timeout, and the &lt;tt&gt;EAM&lt;/tt&gt; requests the &lt;tt&gt;CGSB&lt;/tt&gt; kill them&lt;br/&gt;
(3) now the &lt;tt&gt;EAM&lt;/tt&gt; has a target of 1 executor, and the &lt;tt&gt;CGSB&lt;/tt&gt; has a target of 0 executors&lt;/p&gt;

&lt;p&gt;If the final task completed normally now, everything would be OK; the next taskset would get submitted, the &lt;tt&gt;EAM&lt;/tt&gt; would increase the target number of executors and it would update the &lt;tt&gt;CGSB&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;But if the executor for that final task failed (eg. an OOM), then the &lt;tt&gt;EAM&lt;/tt&gt; thinks it &lt;a href=&quot;https://github.com/apache/spark/blob/4df84c3f818aa536515729b442601e08c253ed35/core/src/main/scala/org/apache/spark/ExecutorAllocationManager.scala#L384-L386&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;doesn&apos;t need to update anything&lt;/a&gt;, because its target is already 1, which is all it needs for that final task; and the &lt;tt&gt;CGSB&lt;/tt&gt; doesn&apos;t update anything either since its target is 0.&lt;/p&gt;

&lt;p&gt;I think you can determine if this is the cause of a stuck app by looking for&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;yarn.YarnAllocator: Driver requested a total number of 0 executor(s).
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;in the logs of the ApplicationMaster (at least on yarn).&lt;/p&gt;

&lt;p&gt;You can reproduce this with this test app, run with &lt;tt&gt;--conf &quot;spark.dynamicAllocation.minExecutors=1&quot; --conf &quot;spark.dynamicAllocation.maxExecutors=5&quot; --conf &quot;spark.dynamicAllocation.executorIdleTimeout=5s&quot;&lt;/tt&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.SparkEnv

sc.setLogLevel(&lt;span class=&quot;code-quote&quot;&gt;&quot;INFO&quot;&lt;/span&gt;)

sc.parallelize(1 to 10000, 1000).count()

val execs = sc.parallelize(1 to 1000, 1000).map { _ =&amp;gt; SparkEnv.get.executorId}.collect().toSet
val badExec = execs.head
println(&lt;span class=&quot;code-quote&quot;&gt;&quot;will kill exec &quot;&lt;/span&gt; + badExec)

sc.parallelize(1 to 5, 5).mapPartitions { itr =&amp;gt;
  val exec = SparkEnv.get.executorId
  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (exec == badExec) {
    &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(20000) &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; enough that all the other tasks finish, and the executors cross the idle timeout
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// now cause the executor to oom
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; buffers = Seq[Array[&lt;span class=&quot;code-object&quot;&gt;Byte&lt;/span&gt;]]()
    &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt;(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) {
      buffers :+= &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Array[&lt;span class=&quot;code-object&quot;&gt;Byte&lt;/span&gt;](1e8.toInt)
    }


    itr
  } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
    itr
  }
}.collect()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;b&gt;EDIT&lt;/b&gt;: I adjusted the repro to cause an OOM on the bad executor, since &lt;tt&gt;sc.killExecutor&lt;/tt&gt; doesn&apos;t play nice with dynamic allocation in other ways.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13137333">SPARK-23365</key>
            <summary>DynamicAllocation with failure in straggler task can lead to a hung spark job</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="irashid">Imran Rashid</assignee>
                                    <reporter username="irashid">Imran Rashid</reporter>
                        <labels>
                    </labels>
                <created>Fri, 9 Feb 2018 03:27:39 +0000</created>
                <updated>Tue, 29 Dec 2020 04:14:40 +0000</updated>
                            <resolved>Tue, 27 Feb 2018 19:13:15 +0000</resolved>
                                    <version>2.1.2</version>
                    <version>2.2.1</version>
                    <version>2.3.0</version>
                                    <fixVersion>2.3.1</fixVersion>
                    <fixVersion>2.4.0</fixVersion>
                                    <component>Scheduler</component>
                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="16363130" author="apachespark" created="Tue, 13 Feb 2018 22:14:05 +0000"  >&lt;p&gt;User &apos;squito&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/20604&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/20604&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16379143" author="vanzin" created="Tue, 27 Feb 2018 19:13:15 +0000"  >&lt;p&gt;Issue resolved by pull request 20604&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/20604&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/20604&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16411894" author="irashid" created="Fri, 23 Mar 2018 18:52:44 +0000"  >&lt;p&gt;This is mostly a duplicate of  &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-21834&quot; title=&quot;Incorrect executor request in case of dynamic allocation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-21834&quot;&gt;&lt;del&gt;SPARK-21834&lt;/del&gt;&lt;/a&gt;, though I&apos;m not marking it as such since both had committed changes, and I think this change is still good as useful cleanup.&lt;/p&gt;

&lt;p&gt;The change from &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-21834&quot; title=&quot;Incorrect executor request in case of dynamic allocation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-21834&quot;&gt;&lt;del&gt;SPARK-21834&lt;/del&gt;&lt;/a&gt; is actually sufficient to solve the problem described above.&lt;/p&gt;</comment>
                            <comment id="17255799" author="apachespark" created="Tue, 29 Dec 2020 04:14:40 +0000"  >&lt;p&gt;User &apos;Ngone51&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/30956&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/30956&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13097475">SPARK-21834</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 46 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3pzbb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>