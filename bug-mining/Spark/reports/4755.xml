<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:52:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-20356] Spark sql group by returns incorrect results after join + distinct transformations</title>
                <link>https://issues.apache.org/jira/browse/SPARK-20356</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;I&apos;m experiencing a bug with the head version of spark as of 4/17/2017. After joining to dataframes, renaming a column and invoking distinct, the results of the aggregation is incorrect after caching the dataframe. The following code snippet consistently reproduces the error.&lt;/p&gt;

&lt;p&gt;from pyspark.sql import SparkSession&lt;br/&gt;
import pyspark.sql.functions as sf&lt;br/&gt;
import pandas as pd&lt;/p&gt;

&lt;p&gt;spark = SparkSession.builder.master(&quot;local&quot;).appName(&quot;Word Count&quot;).getOrCreate()&lt;/p&gt;

&lt;p&gt;mapping_sdf = spark.createDataFrame(pd.DataFrame([&lt;br/&gt;
    &lt;/p&gt;
{&quot;ITEM&quot;: &quot;a&quot;, &quot;GROUP&quot;: 1}
&lt;p&gt;,&lt;br/&gt;
    &lt;/p&gt;
{&quot;ITEM&quot;: &quot;b&quot;, &quot;GROUP&quot;: 1}
&lt;p&gt;,&lt;/p&gt;
    {&quot;ITEM&quot;: &quot;c&quot;, &quot;GROUP&quot;: 2}
&lt;p&gt;]))&lt;/p&gt;

&lt;p&gt;items_sdf = spark.createDataFrame(pd.DataFrame([&lt;br/&gt;
    &lt;/p&gt;
{&quot;ITEM&quot;: &quot;a&quot;, &quot;ID&quot;: 1}
&lt;p&gt;,&lt;br/&gt;
    &lt;/p&gt;
{&quot;ITEM&quot;: &quot;b&quot;, &quot;ID&quot;: 2}
&lt;p&gt;,&lt;/p&gt;
    {&quot;ITEM&quot;: &quot;c&quot;, &quot;ID&quot;: 3}
&lt;p&gt;]))&lt;/p&gt;

&lt;p&gt;mapped_sdf = \&lt;br/&gt;
    items_sdf.join(mapping_sdf, on=&apos;ITEM&apos;).select(&quot;ID&quot;, sf.col(&quot;GROUP&quot;).alias(&apos;ITEM&apos;)).distinct()&lt;/p&gt;

&lt;p&gt;print(mapped_sdf.groupBy(&quot;ITEM&quot;).count().count())  # Prints 2, correct&lt;br/&gt;
mapped_sdf.cache()&lt;br/&gt;
print(mapped_sdf.groupBy(&quot;ITEM&quot;).count().count())  # Prints 3, incorrect&lt;/p&gt;

&lt;p&gt;The next code snippet is almost the same after the first except I don&apos;t call distinct on the dataframe. This snippet performs as expected:&lt;/p&gt;

&lt;p&gt;mapped_sdf = \&lt;br/&gt;
    items_sdf.join(mapping_sdf, on=&apos;ITEM&apos;).select(&quot;ID&quot;, sf.col(&quot;GROUP&quot;).alias(&apos;ITEM&apos;))&lt;/p&gt;

&lt;p&gt;print(mapped_sdf.groupBy(&quot;ITEM&quot;).count().count())  # Prints 2, correct&lt;br/&gt;
mapped_sdf.cache()&lt;br/&gt;
print(mapped_sdf.groupBy(&quot;ITEM&quot;).count().count())  # Prints 2, correct&lt;/p&gt;

&lt;p&gt;I don&apos;t experience this bug with spark 2.1 or event earlier versions for 2.2&lt;/p&gt;</description>
                <environment>&lt;p&gt;Linux mint 18&lt;br/&gt;
Python 3.5&lt;/p&gt;</environment>
        <key id="13064425">SPARK-20356</key>
            <summary>Spark sql group by returns incorrect results after join + distinct transformations</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="viirya">L. C. Hsieh</assignee>
                                    <reporter username="ckipers">Chris Kipers</reporter>
                        <labels>
                            <label>correctness</label>
                    </labels>
                <created>Mon, 17 Apr 2017 16:30:37 +0000</created>
                <updated>Tue, 14 May 2019 06:17:18 +0000</updated>
                            <resolved>Wed, 19 Apr 2017 08:03:04 +0000</resolved>
                                    <version>2.2.0</version>
                                    <fixVersion>2.2.0</fixVersion>
                    <fixVersion>2.3.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="15972544" author="emtl97" created="Tue, 18 Apr 2017 11:52:44 +0000"  >&lt;p&gt;really quite dangerous bug&lt;/p&gt;</comment>
                            <comment id="15972753" author="hvanhovell" created="Tue, 18 Apr 2017 14:18:45 +0000"  >&lt;p&gt;Here is a reproduction in scala:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;val df1 = Seq((&quot;a&quot;, 1), (&quot;b&quot;, 1), (&quot;c&quot;, 2)).toDF(&quot;item&quot;, &quot;group&quot;)
val df2 = Seq((&quot;a&quot;, 1), (&quot;b&quot;, 2), (&quot;c&quot;, 3)).toDF(&quot;item&quot;, &quot;id&quot;)
val df3 = df1.join(df2, Seq(&quot;item&quot;)).select($&quot;id&quot;, $&quot;group&quot;.as(&quot;item&quot;)).distinct()

df3.unpersist()
val agg_without_cache = df3.groupBy($&quot;item&quot;).count()
agg_without_cache.show()

df3.cache()
val agg_with_cache = df3.groupBy($&quot;item&quot;).count()
agg_with_cache.show()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15973100" author="jobevers" created="Tue, 18 Apr 2017 17:17:22 +0000"  >&lt;p&gt;Commit 5ed397baa758c29c54a853d3f8fee0ad44e97c14 doesn&apos;t seem to have this issue.&lt;/p&gt;</comment>
                            <comment id="15973455" author="dkbiswal" created="Tue, 18 Apr 2017 20:45:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=viirya&quot; class=&quot;user-hover&quot; rel=&quot;viirya&quot;&gt;viirya&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hvanhovell&quot; class=&quot;user-hover&quot; rel=&quot;hvanhovell&quot;&gt;hvanhovell&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cloud_fan&quot; class=&quot;user-hover&quot; rel=&quot;cloud_fan&quot;&gt;cloud_fan&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=smilegator&quot; class=&quot;user-hover&quot; rel=&quot;smilegator&quot;&gt;smilegator&lt;/a&gt;&lt;br/&gt;
I took a quick look and it seems the issue started happening after this &lt;a href=&quot;https://github.com/apache/spark/pull/17175&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;pr&lt;/a&gt;. We are&lt;br/&gt;
changing the output partitioning information of InMemoryTableScanExec as part of the fix ( id, item -&amp;gt; item, item) causing a missing shuffle in the operators&lt;br/&gt;
above InMemoryTableScan. Changing to use the child&apos;s output partitioning like before fixes the issue. &lt;/p&gt;

&lt;p&gt;I am a little new to this code &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; And this is what i have found so far. Hope this helps.&lt;/p&gt;</comment>
                            <comment id="15973793" author="viirya" created="Wed, 19 Apr 2017 00:28:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dkbiswal&quot; class=&quot;user-hover&quot; rel=&quot;dkbiswal&quot;&gt;dkbiswal&lt;/a&gt; Thanks for pinging me. I will look into this.&lt;/p&gt;</comment>
                            <comment id="15973902" author="viirya" created="Wed, 19 Apr 2017 02:02:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hvanhovell&quot; class=&quot;user-hover&quot; rel=&quot;hvanhovell&quot;&gt;hvanhovell&lt;/a&gt; I can&apos;t reproduce it with your example code. They both output:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;+----+-----+
|item|count|
+----+-----+
|   1|    2|
|   2|    1|
+----+-----+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Am I missing something?&lt;/p&gt;</comment>
                            <comment id="15973928" author="viirya" created="Wed, 19 Apr 2017 02:30:32 +0000"  >&lt;p&gt;I think I found the reason of the issue. I am working on it.&lt;/p&gt;</comment>
                            <comment id="15973929" author="dkbiswal" created="Wed, 19 Apr 2017 02:31:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=viirya&quot; class=&quot;user-hover&quot; rel=&quot;viirya&quot;&gt;viirya&lt;/a&gt; Did you try from spark-shell or from one of our query suites ? I could reproduce it from spark-shell fine. From our query suites i had to force the number of shuffle partitions to reproduce it.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;test(&lt;span class=&quot;code-quote&quot;&gt;&quot;cache defect&quot;&lt;/span&gt;) {
    withSQLConf(&lt;span class=&quot;code-quote&quot;&gt;&quot;spark.sql.shuffle.partitions&quot;&lt;/span&gt; -&amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;200&quot;&lt;/span&gt;) {
      val df1 = Seq((&lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;, 1), (&lt;span class=&quot;code-quote&quot;&gt;&quot;b&quot;&lt;/span&gt;, 1), (&lt;span class=&quot;code-quote&quot;&gt;&quot;c&quot;&lt;/span&gt;, 2)).toDF(&lt;span class=&quot;code-quote&quot;&gt;&quot;item&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;group&quot;&lt;/span&gt;)
      val df2 = Seq((&lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;, 1), (&lt;span class=&quot;code-quote&quot;&gt;&quot;b&quot;&lt;/span&gt;, 2), (&lt;span class=&quot;code-quote&quot;&gt;&quot;c&quot;&lt;/span&gt;, 3)).toDF(&lt;span class=&quot;code-quote&quot;&gt;&quot;item&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;)
      val df3 = df1.join(df2, Seq(&lt;span class=&quot;code-quote&quot;&gt;&quot;item&quot;&lt;/span&gt;)).select($&lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;, $&lt;span class=&quot;code-quote&quot;&gt;&quot;group&quot;&lt;/span&gt;.as(&lt;span class=&quot;code-quote&quot;&gt;&quot;item&quot;&lt;/span&gt;)).distinct()

      df3.explain(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)

      df3.unpersist()
      val agg_without_cache = df3.groupBy($&lt;span class=&quot;code-quote&quot;&gt;&quot;item&quot;&lt;/span&gt;).count()
      agg_without_cache.show()

      df3.cache()
      val agg_with_cache = df3.groupBy($&lt;span class=&quot;code-quote&quot;&gt;&quot;item&quot;&lt;/span&gt;).count()
      agg_with_cache.explain(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
      agg_with_cache.show()
    }
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15973936" author="viirya" created="Wed, 19 Apr 2017 02:34:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dkbiswal&quot; class=&quot;user-hover&quot; rel=&quot;dkbiswal&quot;&gt;dkbiswal&lt;/a&gt; Yeah, right. Thanks. We need to force the partition to reproduce this.&lt;/p&gt;</comment>
                            <comment id="15973996" author="apachespark" created="Wed, 19 Apr 2017 03:31:02 +0000"  >&lt;p&gt;User &apos;viirya&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/17679&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/17679&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 30 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3dp3z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>