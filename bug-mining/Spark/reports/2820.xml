<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:35:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-11700] Memory leak at SparkContext jobProgressListener stageIdToData map</title>
                <link>https://issues.apache.org/jira/browse/SPARK-11700</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;it seems that there is  A SparkContext jobProgressListener memory leak.*. Bellow i describe the  steps i do to reproduce that. &lt;/p&gt;

&lt;p&gt;I have created a java webapp trying to abstractly Run some Spark Sql jobs that read data from HDFS (join them) and Write them To ElasticSearch using ES hadoop connector. After a Lot of consecutive runs  i noticed that my heap space was full so i got an out of heap space error.&lt;/p&gt;

&lt;p&gt;At the attached file &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; AbstractSparkJobRunner &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; the &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; void run(T jobConfiguration, ExecutionLog executionLog) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception  &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; runs each time an Spark Sql Job is triggered.  So tried to reuse the same SparkContext for a number of consecutive runs. If some rules apply i try to clean up the SparkContext by first calling &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; killSparkAndSqlContext &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;. This code eventually runs &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (sparkContextThreadLock) {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (javaSparkContext != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                LOGGER.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! CLEARING SPARK CONTEXT!!!!!!!!!!!!!!!!!!!!!!!!!!!&quot;&lt;/span&gt;);
                javaSparkContext.stop();
                javaSparkContext = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
                sqlContext = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;

                &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.gc();
            }
            numberOfRunningJobsForSparkContext.getAndSet(0);
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;.&lt;/p&gt;

&lt;p&gt;So at some point in time i suppose that if no other SparkSql job should run i should kill the sparkContext  (The AbstractSparkJobRunner.killSparkAndSqlContext  runs) and this should be garbage collected from garbage collector. However this is not the case, Even if in my debugger shows that my JavaSparkContext object is null see attached picture &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; SparkContextPossibleMemoryLeakIDEA_DEBUG.png &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;.&lt;/p&gt;

&lt;p&gt;The jvisual vm shows an incremental heap space even when the garbage collector is called. See attached picture &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; SparkHeapSpaceProgress.png &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;.&lt;/p&gt;

&lt;p&gt;The memory analyser Tool shows that a big part of the retained heap to be assigned to _jobProgressListener see attached picture &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; SparkMemoryAfterLotsOfConsecutiveRuns.png &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;  and summary picture &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; SparkMemoryLeakAfterLotsOfRunsWithinTheSameContext.png &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;. Although at the same time in Singleton Service the JavaSparkContext is null.  &lt;/p&gt;
</description>
                <environment>&lt;p&gt;Ubuntu 14.04 LTS, Oracle JDK 1.8.51 Apache tomcat 8.0.28. Spring 4&lt;/p&gt;</environment>
        <key id="12912529">SPARK-11700</key>
            <summary>Memory leak at SparkContext jobProgressListener stageIdToData map</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davies">Davies Liu</assignee>
                                    <reporter username="p02096">Kostas papageorgopoulos</reporter>
                        <labels>
                            <label>leak</label>
                            <label>memory-leak</label>
                    </labels>
                <created>Thu, 12 Nov 2015 17:06:37 +0000</created>
                <updated>Mon, 30 Nov 2015 18:32:43 +0000</updated>
                            <resolved>Mon, 30 Nov 2015 18:32:43 +0000</resolved>
                                    <version>1.5.0</version>
                    <version>1.5.1</version>
                    <version>1.5.2</version>
                                    <fixVersion>1.6.0</fixVersion>
                                    <component>Spark Core</component>
                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                                                                                <comments>
                            <comment id="15006895" author="p02096" created="Mon, 16 Nov 2015 16:39:52 +0000"  >&lt;p&gt;One workaround to minimize the effect is to Keep the JavaSparkContext forever alive. (Never stop it inside a JVM process that is long running ) and configure the following options &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; 
OPTION                         DEFAULT DESCRIPTION  
spark.ui.retainedJobs	1000	How many jobs the Spark UI and status APIs remember before garbage collecting.
spark.ui.retainedStages 1000 How many stages the Spark UI and status APIs remember before garbage collecting.
spark.worker.ui.retainedExecutors	1000	How many finished executors the Spark UI and status APIs remember before garbage collecting.
spark.worker.ui.retainedDrivers	1000	How many finished drivers the Spark UI and status APIs remember before garbage collecting.
spark.sql.ui.retainedExecutions	1000	How many finished executions the Spark UI and status APIs remember before garbage collecting.
spark.streaming.ui.retainedBatches	1000	How many finished batches the Spark UI and status APIs remember before garbage collecting.&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;  to very small numbers  in order to have the &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;JobProgressListener&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; relevant maps cleaned. &lt;/p&gt;</comment>
                            <comment id="15012292" author="yhuai" created="Wed, 18 Nov 2015 23:02:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zsxwing&quot; class=&quot;user-hover&quot; rel=&quot;zsxwing&quot;&gt;zsxwing&lt;/a&gt; take a look?&lt;/p&gt;</comment>
                            <comment id="15012326" author="zsxwing" created="Wed, 18 Nov 2015 23:17:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=p02096&quot; class=&quot;user-hover&quot; rel=&quot;p02096&quot;&gt;p02096&lt;/a&gt; could you check if there is any map in JobProgressListener that has more than 1000 items?&lt;/p&gt;</comment>
                            <comment id="15013158" author="p02096" created="Thu, 19 Nov 2015 08:44:56 +0000"  >&lt;p&gt;Hi Shixiong Zhu. To my understanding the problem lies to the JobProgressListener.stageIdToData map.Even if i stop the JavaSparkContext and nullify it, a long time after that ,the heap space has the picture attached &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12772004/SparkMemoryAfterLotsOfConsecutiveRuns.png&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12772004/SparkMemoryAfterLotsOfConsecutiveRuns.png&lt;/a&gt; .&lt;/p&gt;

&lt;p&gt;My application has a configured heap of 1gb. This heap is exceeded a lot jobs before 1000 consecutive Spark job runs. So i have to limit all the above configuration options to 5. According to the source code The &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; spark.ui.retainedStages &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; makes the difference for the stageIdToData map. However i would expect that when the JavaSparkContext is nullified all of the relevant objects of SparkContext to be garbage collected and free up my heap space. This does not happen so i have to keep the JavaSparkContext alway alive inside my program and have the above configurations to a small number&lt;/p&gt;

&lt;p&gt;To my understanding What i would suggest is to have the following code in the JobProgressListener. When the application End event is fired (The sparkContext is stopped) all the relevant maps of the jobProgressListener to be cleared.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
override def onApplicationEnd(applicationEnd: SparkListenerApplicationEnd) {
     activeJobs.clear()
     completedJobs.clear()
     failedJobs.clear()
     jobIdToData.clear()
     jobGroupToJobIds.clear()

    &lt;span class=&quot;code-comment&quot;&gt;// Stages:
&lt;/span&gt;     pendingStages.clear()
     activeStages.clear()
     completedStages.clear()
     skippedStages.clear()
     failedStages.clear()
     stageIdToData.clear()
     stageIdToInfo.clear()
     stageIdToActiveJobIds.clear()
     poolToActiveStages.clear()
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15014022" author="zsxwing" created="Thu, 19 Nov 2015 17:53:50 +0000"  >&lt;p&gt;Even if maps in jobProgressListener are cleared, the SparkContext is still there. Could you check the subclasses of &lt;tt&gt;AbstractSparkJobRunner&lt;/tt&gt; and see if there is any one keeping a reference to SparkContext? You can also just take a look who keeps the reference in the heap dump.&lt;/p&gt;</comment>
                            <comment id="15014195" author="zsxwing" created="Thu, 19 Nov 2015 19:23:12 +0000"  >&lt;p&gt;Yeah, just found the issue is in this line: &lt;a href=&quot;https://github.com/apache/spark/blob/v1.5.2/sql/core/src/main/scala/org/apache/spark/sql/SQLContext.scala#L202&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/v1.5.2/sql/core/src/main/scala/org/apache/spark/sql/SQLContext.scala#L202&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;SQL doesn&apos;t provide an API to clear `tlSession` in 1.5.2. So every SQLContext created will be stored in a ThreadLocal var, but the user cannot clear it.&lt;/p&gt;</comment>
                            <comment id="15014196" author="zsxwing" created="Thu, 19 Nov 2015 19:23:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davies&quot; class=&quot;user-hover&quot; rel=&quot;davies&quot;&gt;davies&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15014234" author="zsxwing" created="Thu, 19 Nov 2015 19:43:36 +0000"  >&lt;p&gt;And for 1.6.0 and master, in this line &lt;a href=&quot;https://github.com/apache/spark/blob/962878843b611fa6229e3ee67bb22e2a4bc283cd/sql/core/src/main/scala/org/apache/spark/sql/execution/SparkPlan.scala#L38&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/962878843b611fa6229e3ee67bb22e2a4bc283cd/sql/core/src/main/scala/org/apache/spark/sql/execution/SparkPlan.scala#L38&lt;/a&gt; because SparkPlan.currentContext won&apos;t be cleared, it will leak one SQLContext in a thread.&lt;/p&gt;</comment>
                            <comment id="15018469" author="davies" created="Fri, 20 Nov 2015 18:28:12 +0000"  >&lt;p&gt;So there is at most one SQLContext leak per thread, I think it&apos;s fine.&lt;/p&gt;</comment>
                            <comment id="15022455" author="deanwampler" created="Mon, 23 Nov 2015 16:58:56 +0000"  >&lt;p&gt;Actually, memory leaks like this aren&apos;t acceptable, IMHO. First, the object graph held by the SQLContext, including the SparkContext can accumulate lots of data, such as metrics data, in large, long-running jobs (In this case, setting &quot;spark.ui.retainedJobs = some_reasonable_N and spark.ui.retainedStages = some_reasonable_N can help). It gets worse for streaming jobs. Second, allowing some memory leaks inevitably makes it harder to track down more painful leaks when they occur. &lt;/p&gt;</comment>
                            <comment id="15022527" author="p02096" created="Mon, 23 Nov 2015 17:22:36 +0000"  >&lt;p&gt;I agree on that. Setting spark.ui.retainedJobs=SmallNumber and spark.ui.retainedStages = SmallNumber can do the workaround by retaining the SparkContext alive along with the JVM. (This does not lead to a a good resource management when having a  Spark cluster in Stanadlone mode though.).&lt;br/&gt;
However i strongly believe that The user of SparkContext and SqlContext should remain unaware of the internal structures. I believe that a design that cleans up the memory structures (or even flush them to a configurable storage if the user can get a business value out of them )&lt;/p&gt;

&lt;p&gt;either &lt;br/&gt;
1.the application Ends,  (The sparkContext is stopped) &lt;br/&gt;
2 a Job Finishes within the SparkContext or SqlContext.&lt;/p&gt;

&lt;p&gt;should be taken into account.&lt;/p&gt;

&lt;p&gt;Either the case when killing a SparkContext inside a JVM , the Garbage collector should be able clean up all it&apos;s memory structures&lt;/p&gt;
</comment>
                            <comment id="15028235" author="apachespark" created="Thu, 26 Nov 2015 05:59:02 +0000"  >&lt;p&gt;User &apos;davies&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/9990&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/9990&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15032220" author="davies" created="Mon, 30 Nov 2015 18:32:43 +0000"  >&lt;p&gt;Issue resolved by pull request 9990&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/9990&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/9990&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12772001" name="AbstractSparkJobRunner.java" size="20644" author="p02096" created="Thu, 12 Nov 2015 17:11:56 +0000"/>
                            <attachment id="12772002" name="SparkContextPossibleMemoryLeakIDEA_DEBUG.png" size="246603" author="p02096" created="Thu, 12 Nov 2015 17:13:18 +0000"/>
                            <attachment id="12772003" name="SparkHeapSpaceProgress.png" size="150268" author="p02096" created="Thu, 12 Nov 2015 17:13:18 +0000"/>
                            <attachment id="12772004" name="SparkMemoryAfterLotsOfConsecutiveRuns.png" size="187574" author="p02096" created="Thu, 12 Nov 2015 17:13:18 +0000"/>
                            <attachment id="12772005" name="SparkMemoryLeakAfterLotsOfRunsWithinTheSameContext.png" size="196465" author="p02096" created="Thu, 12 Nov 2015 17:13:18 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10431"><![CDATA[Important]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 51 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2ob5j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12333083">1.6.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>