<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:47:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-17110] Pyspark with locality ANY throw java.io.StreamCorruptedException</title>
                <link>https://issues.apache.org/jira/browse/SPARK-17110</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;In Pyspark 2.0.0, any task that accesses cached data non-locally throws a StreamCorruptedException like the stacktrace below:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;WARN TaskSetManager: Lost task 7.0 in stage 2.0 (TID 26, 172.31.26.184): java.io.StreamCorruptedException: invalid stream header: 12010A80
        at java.io.ObjectInputStream.readStreamHeader(ObjectInputStream.java:807)
        at java.io.ObjectInputStream.&amp;lt;init&amp;gt;(ObjectInputStream.java:302)
        at org.apache.spark.serializer.JavaDeserializationStream$$anon$1.&amp;lt;init&amp;gt;(JavaSerializer.scala:63)
        at org.apache.spark.serializer.JavaDeserializationStream.&amp;lt;init&amp;gt;(JavaSerializer.scala:63)
        at org.apache.spark.serializer.JavaSerializerInstance.deserializeStream(JavaSerializer.scala:122)
        at org.apache.spark.serializer.SerializerManager.dataDeserializeStream(SerializerManager.scala:146)
        at org.apache.spark.storage.BlockManager$$anonfun$getRemoteValues$1.apply(BlockManager.scala:524)
        at org.apache.spark.storage.BlockManager$$anonfun$getRemoteValues$1.apply(BlockManager.scala:522)
        at scala.Option.map(Option.scala:146)
        at org.apache.spark.storage.BlockManager.getRemoteValues(BlockManager.scala:522)
        at org.apache.spark.storage.BlockManager.get(BlockManager.scala:609)
        at org.apache.spark.storage.BlockManager.getOrElseUpdate(BlockManager.scala:661)
        at org.apache.spark.rdd.RDD.getOrCompute(RDD.scala:330)
        at org.apache.spark.rdd.RDD.iterator(RDD.scala:281)
        at org.apache.spark.api.python.PythonRDD.compute(PythonRDD.scala:63)
        at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:319)
        at org.apache.spark.rdd.RDD.iterator(RDD.scala:283)
        at org.apache.spark.scheduler.ResultTask.runTask(ResultTask.scala:70)
        at org.apache.spark.scheduler.Task.run(Task.scala:85)
        at org.apache.spark.executor.Executor$TaskRunner.run(Executor.scala:274)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
        at java.lang.Thread.run(Thread.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The simplest way I have found to reproduce this is by running the following code in the pyspark shell, on a cluster of 2 slaves set to use only one worker core each:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;x = sc.parallelize([1, 1, 1, 1, 1, 1000, 1, 1, 1], numSlices=9).cache()
x.count()

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; time
def waitMap(x):
    time.sleep(x)
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; x

x.map(waitMap).count()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Or by running the following via spark-submit:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;from pyspark &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; SparkContext
sc = SparkContext()

x = sc.parallelize([1, 1, 1, 1, 1, 1000, 1, 1, 1], numSlices=9).cache()
x.count()

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; time
def waitMap(x):
    time.sleep(x)
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; x

x.map(waitMap).count()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;Cluster of 2 AWS r3.xlarge slaves launched via ec2 scripts, Spark 2.0.0, hadoop: yarn, pyspark shell&lt;/p&gt;</environment>
        <key id="12997963">SPARK-17110</key>
            <summary>Pyspark with locality ANY throw java.io.StreamCorruptedException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="joshrosen">Josh Rosen</assignee>
                                    <reporter username="tomerk">Tomer Kaftan</reporter>
                        <labels>
                    </labels>
                <created>Wed, 17 Aug 2016 16:59:36 +0000</created>
                <updated>Wed, 7 Sep 2016 02:34:21 +0000</updated>
                            <resolved>Tue, 6 Sep 2016 22:08:00 +0000</resolved>
                                    <version>2.0.0</version>
                                    <fixVersion>2.0.1</fixVersion>
                    <fixVersion>2.1.0</fixVersion>
                                    <component>PySpark</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="15425595" author="wm624" created="Wed, 17 Aug 2016 23:31:02 +0000"  >&lt;p&gt;It seems that it is a network I/O timeout, because there is one entry sleeps too long and the connection is reset by remote. Is it a configuration problem? If you run it locally, it works fine.&lt;/p&gt;</comment>
                            <comment id="15425752" author="tomerk" created="Thu, 18 Aug 2016 01:18:29 +0000"  >&lt;p&gt;It is with the default configuration settings, and this worked fine with spark 1.6.0. Still, it&apos;s not unthinkable to me that the default configurations have changed since 1.6. &lt;br/&gt;
It should happen with any wait time greater than the spark.locality.wait setting (forcing the task to be launched on a different node than the one the data was cached on).&lt;/p&gt;

&lt;p&gt;The initial workload we came across this in had each task taking ~20 seconds, and this error would consistently happen near the end of the stage, as soon as tasks began being executed non-locally. That workload also ran fine in spark 1.6.&lt;/p&gt;</comment>
                            <comment id="15425925" author="wm624" created="Thu, 18 Aug 2016 05:35:50 +0000"  >&lt;p&gt;The network layer of Spark must have some change for dealing with long running tasks, as you described it should not be cluster network issue. I can try to debug it and find what&apos;s going on here. &lt;/p&gt;</comment>
                            <comment id="15431139" author="radostyle@gmail.com" created="Mon, 22 Aug 2016 16:36:41 +0000"  >&lt;p&gt;Is there a workaround for this issue?  I&apos;m affected by it.&lt;/p&gt;</comment>
                            <comment id="15435418" author="tomerk" created="Wed, 24 Aug 2016 18:14:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=radostyle%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;radostyle@gmail.com&quot;&gt;radostyle@gmail.com&lt;/a&gt; Unfortunately we haven&apos;t been able to find any for our project other than staying with spark 1.6 for the time being.&lt;/p&gt;</comment>
                            <comment id="15436120" author="gen" created="Thu, 25 Aug 2016 02:00:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=radostyle%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;radostyle@gmail.com&quot;&gt;radostyle@gmail.com&lt;/a&gt;, It seems spark scala doesn&apos;t have this bug in version 2.0.0&lt;/p&gt;</comment>
                            <comment id="15440786" author="wm624" created="Sat, 27 Aug 2016 05:57:41 +0000"  >&lt;p&gt;I set up a two-node cluster, one master, one worker, 48 cores. 1G memory. pyspark run the above code works fine. No exception. It seems that this bug has been fix in latest master branch. Can you upgrade and try again?&lt;/p&gt;</comment>
                            <comment id="15440817" author="tomerk" created="Sat, 27 Aug 2016 06:20:38 +0000"  >&lt;p&gt;Hi Miao, &lt;/p&gt;

&lt;p&gt;That setup wouldn&apos;t cause this bug to appear (However, I can try the most recent master tomorrow anyway just in case someone else has fixed it)&lt;/p&gt;

&lt;p&gt;I should have explicitly specified 2 slaves, not 2 nodes (as I suppose that is too ambiguous. I&apos;ve updated the description). It is also critical that each slave is set to use &lt;b&gt;only 1 worker core&lt;/b&gt; (as I did specify above) for this example.&lt;/p&gt;

&lt;p&gt;This is because this specific example &amp;amp; setup is designed to cause (non-deterministically, but with high probability) a situation where one of the pyspark workers reads data non-locally, which is what I have observed to cause this error consistently.&lt;/p&gt;

&lt;p&gt;To provide a mental model of how this example &amp;amp; code snippet forces this situation:&lt;br/&gt;
1. The workers initially cache the data, forcing it to be stored in memory locally. Worker A contains the large number (1000), Worker B contains only small numbers (1).&lt;br/&gt;
2. The two workers each process their local numbers one at a time.&lt;br/&gt;
3. Once Worker A hits the large wait, Worker B continues on to process all of its local data&lt;br/&gt;
4. Because Worker A is taking so long to finish its task (1000 seconds, but it can be set much smaller), the spark.locality.wait setting leads Worker B to begin processing data that is stored on Worker A&lt;br/&gt;
5. Worker B attempts to read non-local data not stored on that node, leading the stream corrupted exception to occur. &lt;/p&gt;

&lt;p&gt;The case in which this does not happen is the one run every few times where Worker A processes the large number (1000) last, as then there will be no data remaining on Worker A to attempt to launch on Worker B.&lt;/p&gt;</comment>
                            <comment id="15445029" author="wm624" created="Mon, 29 Aug 2016 07:02:36 +0000"  >&lt;p&gt;Can you post a sample configuration? It could be simpler to reproduce this issue.&lt;/p&gt;</comment>
                            <comment id="15445591" author="gen" created="Mon, 29 Aug 2016 11:26:07 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;I tried the similar code in python, scala, java and with different StorageLevel. Only pyspark threw the error when spark wanted to launch non node-locality tasks. As In Python, stored objects will always be serialized with the Pickle library. I guess this bug is related to pickle serialization.&lt;/p&gt;</comment>
                            <comment id="15446666" author="tomerk" created="Mon, 29 Aug 2016 18:27:38 +0000"  >&lt;p&gt;Hi Miao, all that is needed using the fully default configurations with 2 slaves is to just set the number of worker cores per slave to 1.&lt;/p&gt;

&lt;p&gt;That is, putting the following in /spark/conf/spark-env.sh&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;SPARK_WORKER_CORES=1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;More concretely (if you&#8217;re looking for exact steps), the way I start up the cluster &amp;amp; reproduce this example is as follows.&lt;/p&gt;

&lt;p&gt;I use the Spark EC2 scripts from the PR here:&lt;br/&gt;
&lt;a href=&quot;https://github.com/amplab/spark-ec2/pull/46&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/amplab/spark-ec2/pull/46&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I launch the cluster on 2 r3.xlarge machines (but any machine should work, though you may need to change a later sed command):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;./spark-ec2 -k ec2_ssh_key -i path_to_key_here -s 2 -t r3.xlarge launch temp-cluster --spot-price=1.00 --spark-version=2.0.0 --region=us-west-2 --hadoop-major-version=yarn
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I update the number of worker cores and launch the pyspark shell:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;sed -i&lt;span class=&quot;code-quote&quot;&gt;&apos;f&apos;&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&apos;s/SPARK_WORKER_CORES=4/SPARK_WORKER_CORES=1/g&apos;&lt;/span&gt; /root/spark/conf/spark-env.sh
~/spark-ec2/copy-dir ~/spark/conf/
~/spark/sbin/stop-all.sh
~/spark/sbin/start-all.sh
~/spark/bin/pyspark
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And then I run the example I included at the start:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;x = sc.parallelize([1, 1, 1, 1, 1, 1000, 1, 1, 1], numSlices=9).cache()
x.count()

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; time
def waitMap(x):
    time.sleep(x)
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; x

x.map(waitMap).count()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15461441" author="apachespark" created="Sat, 3 Sep 2016 17:46:07 +0000"  >&lt;p&gt;User &apos;JoshRosen&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/14952&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/14952&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15468773" author="joshrosen" created="Tue, 6 Sep 2016 22:08:00 +0000"  >&lt;p&gt;Issue resolved by pull request 14952&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/14952&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/14952&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15469295" author="tomerk" created="Wed, 7 Sep 2016 02:34:21 +0000"  >&lt;p&gt;Thanks all who helped out with this!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 10 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i32fmn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12336857">2.0.1</customfieldvalue>
    <customfieldvalue id="12335644">2.1.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>