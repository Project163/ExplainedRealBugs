<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:48:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-17337] Incomplete algorithm for name resolution in Catalyst paser may lead to incorrect result</title>
                <link>https://issues.apache.org/jira/browse/SPARK-17337</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;While investigating &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-16951&quot; title=&quot;Alternative implementation of NOT IN to Anti-join&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-16951&quot;&gt;&lt;del&gt;SPARK-16951&lt;/del&gt;&lt;/a&gt;, I found an incorrect results case from a NOT IN subquery. I thought originally it is an edge case. Further investigation found this is a more general problem.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13001680">SPARK-17337</key>
            <summary>Incomplete algorithm for name resolution in Catalyst paser may lead to incorrect result</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hvanhovell">Herman van H&#246;vell</assignee>
                                    <reporter username="nsyca">Nattavut Sutyanyong</reporter>
                        <labels>
                            <label>correctness</label>
                    </labels>
                <created>Wed, 31 Aug 2016 14:40:15 +0000</created>
                <updated>Wed, 11 Jan 2017 20:43:56 +0000</updated>
                            <resolved>Fri, 4 Nov 2016 20:36:52 +0000</resolved>
                                    <version>2.0.0</version>
                                    <fixVersion>2.0.2</fixVersion>
                    <fixVersion>2.1.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15452415" author="nsyca" created="Wed, 31 Aug 2016 14:42:04 +0000"  >&lt;p&gt;This problem originated from the Case 1 documented in &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-16951&quot; title=&quot;Alternative implementation of NOT IN to Anti-join&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-16951&quot;&gt;&lt;del&gt;SPARK-16951&lt;/del&gt;&lt;/a&gt;. The script illustrates the problem&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Seq(1,2).toDF(&quot;c1&quot;).createOrReplaceTempView(&quot;t1&quot;)
Seq(1).toDF(&quot;c2&quot;).createOrReplaceTempView(&quot;t2&quot;)

scala&amp;gt; sql(&quot;select * from (select t2.c2+1 as c3 from t1 left join t2 on t1.c1=t2.c2) t3 where c3 not in (select c2 from t2)&quot;).show
+----+
|  c3|
+----+
|   2|
|null|
+----+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The correct answer is 1 row of (2). From the plan below, the incorrect portion of the plan is the LeftAnti, rewritten from the NOT IN subquery, is pushed down below the (T1 LOJ T2) operation. Because LeftAnti predicate is evaluated to unknown (or null) if any argument of a comparison operator in the predicate is null, e.g. NULL = &amp;lt;value&amp;gt; is evaluated to unknown (which is equivalent to false in the context of a predicate), the LeftAnti predicate cannot be pushed down into a LOJ operation.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;scala&amp;gt; sql(&quot;select * from (select t2.c2+1 as c3 from t1 left join t2 on t1.c1=t2.c2) t3 where c3 not in (select c2 from t2)&quot;).explain(true)
== Parsed Logical Plan ==
&apos;Project [*]
+- &apos;Filter NOT &apos;c3 IN (list#124)
   :  +- &apos;SubqueryAlias list#124
   :     +- &apos;Project [&apos;c2]
   :        +- &apos;UnresolvedRelation `t2`
   +- &apos;SubqueryAlias t3
      +- &apos;Project [(&apos;t2.c2 + 1) AS c3#123]
         +- &apos;Join LeftOuter, (&apos;t1.c1 = &apos;t2.c2)
            :- &apos;UnresolvedRelation `t1`
            +- &apos;UnresolvedRelation `t2`

== Analyzed Logical Plan ==
c3: int
Project [c3#123]
+- Filter NOT predicate-subquery#124 [(c3#123 = c2#77)]
   :  +- SubqueryAlias predicate-subquery#124 [(c3#123 = c2#77)]
   :     +- Project [c2#77]
   :        +- SubqueryAlias t2
   :           +- Project [value#75 AS c2#77]
   :              +- LocalRelation [value#75]
   +- SubqueryAlias t3
      +- Project [(c2#77 + 1) AS c3#123]
         +- Join LeftOuter, (c1#3 = c2#77)
            :- SubqueryAlias t1
            :  +- Project [value#1 AS c1#3]
            :     +- LocalRelation [value#1]
            +- SubqueryAlias t2
               +- Project [value#75 AS c2#77]
                  +- LocalRelation [value#75]

== Optimized Logical Plan ==
Project [(c2#77 + 1) AS c3#123]
+- Join LeftOuter, (c1#3 = c2#77)
   :- Project [value#1 AS c1#3]
   :  +- Join LeftAnti, (isnull(((c2#77 + 1) = c2#77)) || ((c2#77 + 1) = c2#77))
   :     :- LocalRelation [value#1]
   :     +- LocalRelation [c2#77]
   +- LocalRelation [c2#77]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15452419" author="nsyca" created="Wed, 31 Aug 2016 14:43:18 +0000"  >&lt;p&gt;@hvanhovell has observed that by disabling the rule &lt;tt&gt;PushPredicateThroughJoin&lt;/tt&gt; will solve this problem. The predicate is pushed down because the code thinks all the columns in the LeftAnti predicate reference to the T2, the right table of (T1 LOJ T2). The fact is some of the C2#77 in the LeftAnti predicate are from the T2 in the NOT IN subquery.&lt;/p&gt;

&lt;p&gt;However, &lt;tt&gt;PushPredicateThroughJoin&lt;/tt&gt; is not the root cause of the problem. The problem is the identifier &lt;tt&gt;&lt;a href=&quot;#75 AS c2#77&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;value#75 AS c2#77&lt;/a&gt;&lt;/tt&gt; is used in two places from the two unrelated references of &lt;tt&gt;SubqueryAlias t2&lt;/tt&gt;. This can be demonstrated by replacing the T2 in the subquery by a different name, SQ in the example below. We will not see the LeftAnti predicate pushed down below the LOJ.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Seq(1).toDF(&quot;cx&quot;).createOrReplaceTempView(&quot;sq&quot;)

scala&amp;gt; sql(&quot;select * from (select t2.c2+1 as c3 from t1 left join t2 on t1.c1=t2.c2) t3 where c3 not in (select cx from sq)&quot;).explain(true)

...

== Optimized Logical Plan ==
Project [(c2#77 + 1) AS c3#137]
+- Join LeftAnti, (isnull(((c2#77 + 1) = cx#133)) || ((c2#77 + 1) = cx#133))
   :- Join LeftOuter, (c1#3 = c2#77)
   :  :- LocalRelation [c1#3]
   :  +- LocalRelation [c2#77]
   +- LocalRelation [cx#133]
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15452604" author="apachespark" created="Wed, 31 Aug 2016 15:52:08 +0000"  >&lt;p&gt;User &apos;nsyca&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/14899&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/14899&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15474253" author="nsyca" created="Thu, 8 Sep 2016 16:01:55 +0000"  >&lt;p&gt;The same problem surfaced in different symptoms was discussed in &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-13801&quot; title=&quot;DataFrame.col should return unresolved attribute&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-13801&quot;&gt;&lt;del&gt;SPARK-13801&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-14040&quot; title=&quot;Null-safe and equality join produces incorrect result with filtered dataframe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-14040&quot;&gt;&lt;del&gt;SPARK-14040&lt;/del&gt;&lt;/a&gt;, and &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-17154&quot; title=&quot;Wrong result can be returned or AnalysisException can be thrown after self-join or similar operations&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-17154&quot;&gt;&lt;del&gt;SPARK-17154&lt;/del&gt;&lt;/a&gt;. The problem reported here is a specific pattern. We shall find a solution that addresses the root cause. I am considering closing this JIRA as a duplicate.&lt;/p&gt;</comment>
                            <comment id="15634694" author="apachespark" created="Thu, 3 Nov 2016 23:51:06 +0000"  >&lt;p&gt;User &apos;hvanhovell&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/15761&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/15761&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15634741" author="nsyca" created="Fri, 4 Nov 2016 00:13:38 +0000"  >&lt;p&gt;As commented in the PR, the code was nicely done but the bigger problem remains there, tracked by &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-17154&quot; title=&quot;Wrong result can be returned or AnalysisException can be thrown after self-join or similar operations&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-17154&quot;&gt;&lt;del&gt;SPARK-17154&lt;/del&gt;&lt;/a&gt;. I made a few attempts to fix the root cause of the problem surfaced in many symptoms but it has taken me long and not yet as clean as I want. Also I am seeing &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kousuke&quot; class=&quot;user-hover&quot; rel=&quot;kousuke&quot;&gt;kousuke&lt;/a&gt; keeps refining his work through a series of PRs for that so I hesitate to try competing with his solution.&lt;/p&gt;</comment>
                            <comment id="15637167" author="hvanhovell" created="Fri, 4 Nov 2016 17:56:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nsyca&quot; class=&quot;user-hover&quot; rel=&quot;nsyca&quot;&gt;nsyca&lt;/a&gt; You are right to say that this is part of a larger set of problems which we should address and which given the amount of attempts made to fix this proves that it it non-trivial. It is not a problem to have different (competing) PRs for this problem, this usually leads to solutions. So please submit a PR is feel that this is a better solution.&lt;/p&gt;

&lt;p&gt;However, for this ticket I just want to solve the correctness issue at hand.&lt;/p&gt;</comment>
                            <comment id="15637186" author="nsyca" created="Fri, 4 Nov 2016 18:01:48 +0000"  >&lt;p&gt;Totally agreed on your approach. We should close off any potential incorrect results at the soonest possible.&lt;/p&gt;

&lt;p&gt;Thanks for the advise on the approach of different/competing PRs. I am relatively new to the community and try to be careful not to break any etiquette of the community.&lt;/p&gt;</comment>
                            <comment id="15637600" author="apachespark" created="Fri, 4 Nov 2016 20:36:05 +0000"  >&lt;p&gt;User &apos;hvanhovell&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/15772&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/15772&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12998523">SPARK-17154</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 2 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i332jr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311620" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Shepherd</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>hvanhovell</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>