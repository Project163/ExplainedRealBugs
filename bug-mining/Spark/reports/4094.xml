<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:47:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-17758] Spark Aggregate function  LAST returns null on an empty partition </title>
                <link>https://issues.apache.org/jira/browse/SPARK-17758</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;My Environment &lt;br/&gt;
Spark 2.0.0  &lt;/p&gt;

&lt;p&gt;I have included the physical plan of my application below.&lt;br/&gt;
Issue description&lt;br/&gt;
The result from  a query that uses the LAST function are incorrect. &lt;/p&gt;

&lt;p&gt;The output obtained for the column that corresponds to the last function is null .  &lt;/p&gt;

&lt;p&gt;My input data contain 3 rows . &lt;/p&gt;

&lt;p&gt;The application resulted in  2 stages &lt;/p&gt;

&lt;p&gt;The first stage consisted of 3 tasks . &lt;/p&gt;

&lt;p&gt;The first task/partition contains 2 rows&lt;br/&gt;
The second task/partition contains 1 row&lt;br/&gt;
The last task/partition contain  0 rows&lt;/p&gt;

&lt;p&gt;The result from the query executed for the LAST column call is NULL which I believe is due to the  PARTIAL_LAST on the last partition . &lt;/p&gt;

&lt;p&gt;I believe that this behavior is incorrect. The PARTIAL_LAST call on an empty partition should not return null .&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;== Physical Plan ==
InsertIntoHiveTable MetastoreRelation default, bdm_3449_tgt20, true, false
+- *Project [last(C3_1)#51 AS field#102, cast(round(max(C3_0)#50, 0) as int) AS field1#103, cast(round(max(C3_0)#50, 0) as int) AS field2#104]
   +- SortAggregate(key=[], functions=[max(C3_0#40),last(C3_1#41, false)], output=[max(C3_0)#50,last(C3_1)#51])
      +- SortAggregate(key=[], functions=[partial_max(C3_0#40),partial_last(C3_1#41, false)], output=[max#91,last#92])
         +- *Project [CAST(sum(C1_0) AS DOUBLE)#27 AS C3_0#40, last(C1_1)#28 AS C3_1#41]
            +- SortAggregate(key=[], functions=[sum(cast(C1_0#17 as bigint)),last(C1_1#18, false)], output=[CAST(sum(C1_0) AS DOUBLE)#27,last(C1_1)#28])
               +- Exchange SinglePartition
                  +- SortAggregate(key=[], functions=[partial_sum(cast(C1_0#17 as bigint)),partial_last(C1_1#18, false)], output=[sum#95L,last#96])
                     +- *Project [field1#7 AS C1_0#17, field#6 AS C1_1#18]
                        +- HiveTableScan [field1#7, field#6], MetastoreRelation default, bdm_3449_src, alias
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;Spark 2.0.0&lt;/p&gt;</environment>
        <key id="13009098">SPARK-17758</key>
            <summary>Spark Aggregate function  LAST returns null on an empty partition </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hvanhovell">Herman van H&#246;vell</assignee>
                                    <reporter username="tafranky@gmail.com">Franck Tago</reporter>
                        <labels>
                            <label>correctness</label>
                    </labels>
                <created>Sun, 2 Oct 2016 04:16:18 +0000</created>
                <updated>Wed, 5 Oct 2016 23:06:20 +0000</updated>
                            <resolved>Wed, 5 Oct 2016 23:06:04 +0000</resolved>
                                    <version>2.0.0</version>
                                    <fixVersion>2.0.2</fixVersion>
                    <fixVersion>2.1.0</fixVersion>
                                    <component>Input/Output</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15543097" author="tafranky@gmail.com" created="Mon, 3 Oct 2016 18:42:15 +0000"  >&lt;p&gt;I tested the behavior of the min and max function with sort aggregate and an empty partition and the results were correct. &lt;/p&gt;

&lt;p&gt;I would also note that this issue is not reproducible in spark version 1.6&lt;/p&gt;</comment>
                            <comment id="15543175" author="hvanhovell" created="Mon, 3 Oct 2016 19:20:57 +0000"  >&lt;p&gt;Why should last return a non null result? It returns the last observation it encounters (which is pretty random in a clustered environment)? Last is only deterministic when you have sorted on the column you are calling last on.&lt;/p&gt;</comment>
                            <comment id="15543488" author="tafranky@gmail.com" created="Mon, 3 Oct 2016 21:30:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hvanhovell&quot; class=&quot;user-hover&quot; rel=&quot;hvanhovell&quot;&gt;hvanhovell&lt;/a&gt; It should return a  non null  value in this case because the null  value  is a false representation of my data . &lt;/p&gt;

&lt;p&gt;My initial  input source  had 3 rows . &lt;/p&gt;

&lt;p&gt;a,1&lt;br/&gt;
b,2&lt;br/&gt;
c,10&lt;/p&gt;

&lt;p&gt;From  observations show &lt;/p&gt;

&lt;p&gt;partition 1  contains 2 rows  &lt;br/&gt;
a,1&lt;br/&gt;
b,2 &lt;/p&gt;

&lt;p&gt;partition 2 contains 1 row  &lt;br/&gt;
c,10  &lt;/p&gt;

&lt;p&gt;partition  3 contains  0 rows &lt;/p&gt;

&lt;p&gt;why should  last return  null in this case  . &lt;/p&gt;

&lt;p&gt;I understand that last would not be deterministic but why should should it return null in this case ?&lt;/p&gt;</comment>
                            <comment id="15543738" author="hvanhovell" created="Mon, 3 Oct 2016 23:23:50 +0000"  >&lt;p&gt;Yeah, you have a point there. It seems to be merging the results the empty partition. We&apos;ll need to add a flag to &lt;tt&gt;Last&lt;/tt&gt; aggregate, and figure out merging. This will be fun to test.&lt;/p&gt;</comment>
                            <comment id="15543926" author="tafranky@gmail.com" created="Tue, 4 Oct 2016 00:47:39 +0000"  >&lt;p&gt;is there any workaround that you could think of?  &lt;/p&gt;

&lt;p&gt;One  simple solution cold be to call repartition on the data frame  in order to remove the empty partition but performance wise that is  just terrible .  &lt;/p&gt;

&lt;p&gt;I am not sure that i comprehend why the concept of an empty partition is even allowed in the spark ecosystem .  Any documentation on why empty partitions are allowed would be greatly appreciated.&lt;/p&gt;</comment>
                            <comment id="15543947" author="hvanhovell" created="Tue, 4 Oct 2016 00:56:47 +0000"  >&lt;p&gt;You could write your own UDAF.&lt;/p&gt;

&lt;p&gt;Partitions can be come empty for various reasons:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Data Skew&lt;/li&gt;
	&lt;li&gt;A filter applied to the partition can make it empty. Spark pipelines operators, so a filter could effectively prune the partition but we would still aggregate it.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15544003" author="tafranky@gmail.com" created="Tue, 4 Oct 2016 01:25:34 +0000"  >&lt;p&gt;Thanks for the pointer &lt;br/&gt;
Is it possible to write a UDAF  which supports  the combiner like  functionality . I am referring to the partial_last , partial_min  .. &lt;/p&gt;</comment>
                            <comment id="15544011" author="hvanhovell" created="Tue, 4 Oct 2016 01:28:32 +0000"  >&lt;p&gt;We do, you have to implement a &lt;tt&gt;merge&lt;/tt&gt; method which combines partial results. See &lt;a href=&quot;https://databricks.com/blog/2015/09/16/apache-spark-1-5-dataframe-api-highlights.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://databricks.com/blog/2015/09/16/apache-spark-1-5-dataframe-api-highlights.html&lt;/a&gt; for an example.&lt;/p&gt;</comment>
                            <comment id="15546215" author="apachespark" created="Tue, 4 Oct 2016 18:22:07 +0000"  >&lt;p&gt;User &apos;hvanhovell&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/15348&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/15348&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15547292" author="tafranky@gmail.com" created="Wed, 5 Oct 2016 01:22:39 +0000"  >&lt;p&gt;My first impression after taking a look at  First.scala leads me to conclude that the issue  depicted here should not happen for the First aggregate function call . &lt;/p&gt;

&lt;p&gt;Is that correct ?&lt;/p&gt;</comment>
                            <comment id="15547300" author="hvanhovell" created="Wed, 5 Oct 2016 01:28:38 +0000"  >&lt;p&gt;That is correct. First keeps track of the fact that its value has been set. Last does not.&lt;/p&gt;</comment>
                            <comment id="15550239" author="yhuai" created="Wed, 5 Oct 2016 23:06:05 +0000"  >&lt;p&gt;Issue resolved by pull request 15348&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/15348&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/15348&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 6 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i34c8v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>