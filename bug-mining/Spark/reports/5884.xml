<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:00:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-24987] Kafka Cached Consumer Leaking File Descriptors</title>
                <link>https://issues.apache.org/jira/browse/SPARK-24987</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Setup:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Spark 2.3.1&lt;/li&gt;
	&lt;li&gt;Java 1.8.0 (112)&lt;/li&gt;
	&lt;li&gt;Standalone Cluster Manager&lt;/li&gt;
	&lt;li&gt;3 Nodes, 1 Executor per&#160;node.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Spark 2.3.0 introduced a new mechanism for caching Kafka consumers (&lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-23623?page=com.atlassian.jira.plugin.system.issuetabpanels%3Aall-tabpanel&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SPARK-23623?page=com.atlassian.jira.plugin.system.issuetabpanels%3Aall-tabpanel&lt;/a&gt;) via KafkaDataConsumer.acquire.&lt;/p&gt;

&lt;p&gt;It seems that there are situations (I&apos;ve been trying to debug it, haven&apos;t been able to find the root cause as of yet) where cached consumers remain &quot;in use&quot; throughout the life time of the task and are never released. This can be identified by the following&#160;line of the stack trace:&lt;/p&gt;

&lt;p&gt;at org.apache.spark.sql.kafka010.KafkaDataConsumer$.acquire(KafkaDataConsumer.scala:460)&lt;/p&gt;

&lt;p&gt;Which points to:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (existingInternalConsumer.inUse) {
  &lt;span class=&quot;code-comment&quot;&gt;// If consumer is already cached but is currently in use, then &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; a &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; consumer
&lt;/span&gt;  NonCachedKafkaDataConsumer(newInternalConsumer)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;Meaning the existing consumer created for that `TopicPartition` is still in use for some reason. The weird thing is that you can see this for very old tasks which have already finished successfully.&lt;/p&gt;

&lt;p&gt;I&apos;ve traced down this leak using file leak detector, attaching it to the running Executor JVM process. I&apos;ve emitted the list of open file descriptors which &lt;a href=&quot;https://gist.github.com/YuvalItzchakov/cdbdd7f67604557fccfbcce673c49e5d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;you can find here&lt;/a&gt;, and you can see that the majority of them are epoll FD used by Kafka Consumers, indicating that they aren&apos;t closing.&lt;/p&gt;

&lt;p&gt;&#160;Spark graph:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
kafkaStream
&#160; .load()
&#160; .selectExpr(&lt;span class=&quot;code-quote&quot;&gt;&quot;CAST(key AS STRING)&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;CAST(value AS STRING)&quot;&lt;/span&gt;)
&#160; .as[(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;)]
&#160; .flatMap {...}
&#160; .groupByKey(...)
&#160; .mapGroupsWithState(GroupStateTimeout.ProcessingTimeTimeout())(...)
&#160; .foreach(...)
&#160; .outputMode(OutputMode.Update)
&#160; .option(&lt;span class=&quot;code-quote&quot;&gt;&quot;checkpointLocation&quot;&lt;/span&gt;,
sparkConfiguration.properties.checkpointDirectory)
&#160; .start()
&#160; .awaitTermination()&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;Spark 2.3.1&lt;/p&gt;

&lt;p&gt;Java(TM) SE Runtime Environment (build 1.8.0_112-b15)&lt;br/&gt;
 Java HotSpot(TM) 64-Bit Server VM (build 25.112-b15, mixed mode)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</environment>
        <key id="13176073">SPARK-24987</key>
            <summary>Kafka Cached Consumer Leaking File Descriptors</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="Yuval.Itzchakov">Yuval Itzchakov</assignee>
                                    <reporter username="Yuval.Itzchakov">Yuval Itzchakov</reporter>
                        <labels>
                    </labels>
                <created>Wed, 1 Aug 2018 10:15:38 +0000</created>
                <updated>Fri, 24 May 2019 04:13:31 +0000</updated>
                            <resolved>Sat, 4 Aug 2018 19:46:01 +0000</resolved>
                                    <version>2.2.2</version>
                    <version>2.3.0</version>
                    <version>2.3.1</version>
                                    <fixVersion>2.3.2</fixVersion>
                    <fixVersion>2.4.0</fixVersion>
                                    <component>Structured Streaming</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16568022" author="apachespark" created="Fri, 3 Aug 2018 09:51:06 +0000"  >&lt;p&gt;User &apos;YuvalItzchakov&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/21983&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/21983&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16569112" author="apachespark" created="Sat, 4 Aug 2018 07:32:04 +0000"  >&lt;p&gt;User &apos;YuvalItzchakov&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/21997&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/21997&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16569432" author="yuval.itzchakov" created="Sun, 5 Aug 2018 10:51:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cody%40koeninger.org&quot; class=&quot;user-hover&quot; rel=&quot;cody@koeninger.org&quot;&gt;cody@koeninger.org&lt;/a&gt; Is there any chance this will make it in time for 2.3.2? This is a critical fix for us (or more generally for all users of the Kafka source).&lt;/p&gt;</comment>
                            <comment id="16569491" author="cody@koeninger.org" created="Sun, 5 Aug 2018 15:10:00 +0000"  >&lt;p&gt;It was merged to branch-2.3&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/spark/commits/branch-2.3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/commits/branch-2.3&lt;/a&gt;&lt;/p&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13178683">SPARK-25106</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13235112">SPARK-27818</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13143419">SPARK-23623</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 15 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3wk9b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>