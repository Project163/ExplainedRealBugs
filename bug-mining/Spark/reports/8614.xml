<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:30:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-39976] NULL check in ArrayIntersect adds extraneous null from first param</title>
                <link>https://issues.apache.org/jira/browse/SPARK-39976</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;This is very likely a regression from &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-36829&quot; title=&quot;Refactor collectionOperation related Null check related code&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-36829&quot;&gt;&lt;del&gt;SPARK-36829&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;When using &lt;tt&gt;array_intersect(a, b)&lt;/tt&gt;, if the first parameter contains a &lt;tt&gt;NULL&lt;/tt&gt; value and the second one does not, an extraneous &lt;tt&gt;NULL&lt;/tt&gt; is present in the output. This also leads to &lt;tt&gt;array_intersect(a, b) != array_intersect(b, a)&lt;/tt&gt; which is incorrect as set intersection should be commutative.&lt;/p&gt;

&lt;p&gt;Example using PySpark:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-python&quot;&gt;
&amp;gt;&amp;gt;&amp;gt; a = [1, 2, 3]
&amp;gt;&amp;gt;&amp;gt; b = [3, &lt;span class=&quot;code-keyword&quot;&gt;&lt;span class=&quot;code-object&quot;&gt;None&lt;/span&gt;&lt;/span&gt;, 5]
&amp;gt;&amp;gt;&amp;gt; df = spark.sparkContext.parallelize(data).toDF([&lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;b&quot;&lt;/span&gt;])
&amp;gt;&amp;gt;&amp;gt; df.show()
+---------+------------+
|        a|           b|
+---------+------------+
|[1, 2, 3]|[3, null, 5]|
+---------+------------+

&amp;gt;&amp;gt;&amp;gt; df.selectExpr(&lt;span class=&quot;code-quote&quot;&gt;&quot;array_intersect(a,b)&quot;&lt;/span&gt;).show()
+---------------------+
|array_intersect(a, b)|
+---------------------+
|                  [3]|
+---------------------+

&amp;gt;&amp;gt;&amp;gt; df.selectExpr(&lt;span class=&quot;code-quote&quot;&gt;&quot;array_intersect(b,a)&quot;&lt;/span&gt;).show()
+---------------------+
|array_intersect(b, a)|
+---------------------+
|            [3, null]|
+---------------------+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Note that in the first case, &lt;tt&gt;a&lt;/tt&gt; does not contain a &lt;tt&gt;NULL&lt;/tt&gt;, and the final output is correct: &lt;tt&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;3&amp;#93;&lt;/span&gt;&lt;/tt&gt;. In the second case, since &lt;tt&gt;b&lt;/tt&gt; does contain &lt;tt&gt;NULL&lt;/tt&gt; and is now the first parameter.&lt;/p&gt;

&lt;p&gt;The same behavior occurs in Scala when writing to Parquet:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-scala&quot;&gt;
scala&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; a = Array[java.lang.Integer](1, 2, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, 4)
a: Array[Integer] = Array(1, 2, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, 4)

scala&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; b = Array[java.lang.Integer](4, 5, 6, 7)
b: Array[Integer] = Array(4, 5, 6, 7)

scala&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; df = Seq((a, b)).toDF(&lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;b&quot;&lt;/span&gt;)
df: org.apache.spark.sql.DataFrame = [a: array&amp;lt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&amp;gt;, b: array&amp;lt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&amp;gt;]

scala&amp;gt; df.write.parquet(&lt;span class=&quot;code-quote&quot;&gt;&quot;/tmp/simple.parquet&quot;&lt;/span&gt;)

scala&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; df = spark.read.parquet(&lt;span class=&quot;code-quote&quot;&gt;&quot;/tmp/simple.parquet&quot;&lt;/span&gt;)
df: org.apache.spark.sql.DataFrame = [a: array&amp;lt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&amp;gt;, b: array&amp;lt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&amp;gt;]

scala&amp;gt; df.show()
+---------------+------------+
|              a|           b|
+---------------+------------+
|[1, 2, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, 4]|[4, 5, 6, 7]|
+---------------+------------+


scala&amp;gt; df.selectExpr(&lt;span class=&quot;code-quote&quot;&gt;&quot;array_intersect(a,b)&quot;&lt;/span&gt;).show()
+---------------------+
|array_intersect(a, b)|
+---------------------+
|            [&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, 4]|
+---------------------+


scala&amp;gt; df.selectExpr(&lt;span class=&quot;code-quote&quot;&gt;&quot;array_intersect(b,a)&quot;&lt;/span&gt;).show()
+---------------------+
|array_intersect(b, a)|
+---------------------+
|                  [4]|
+---------------------+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</description>
                <environment></environment>
        <key id="13475001">SPARK-39976</key>
            <summary>NULL check in ArrayIntersect adds extraneous null from first param</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="angerszhu">angerszhu</assignee>
                                    <reporter username="navkumar">Navin Kumar</reporter>
                        <labels>
                            <label>correctness</label>
                    </labels>
                <created>Thu, 4 Aug 2022 04:57:17 +0000</created>
                <updated>Mon, 15 Aug 2022 12:55:12 +0000</updated>
                            <resolved>Mon, 15 Aug 2022 12:55:12 +0000</resolved>
                                    <version>3.3.0</version>
                                    <fixVersion>3.3.1</fixVersion>
                    <fixVersion>3.4.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17575177" author="zing" created="Thu, 4 Aug 2022 09:53:43 +0000"  >&lt;p&gt;I can reproduce this case , i will try to fix it.&lt;/p&gt;</comment>
                            <comment id="17575398" author="tgraves" created="Thu, 4 Aug 2022 18:34:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cloud_fan&quot; class=&quot;user-hover&quot; rel=&quot;cloud_fan&quot;&gt;cloud_fan&lt;/a&gt; &#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=angerszhuuu&quot; class=&quot;user-hover&quot; rel=&quot;angerszhuuu&quot;&gt;angerszhuuu&lt;/a&gt;&#160; who worked on original issue. This sounds like correctness to me so we should add label if so.&lt;/p&gt;</comment>
                            <comment id="17576729" author="apachespark" created="Mon, 8 Aug 2022 12:00:07 +0000"  >&lt;p&gt;User &apos;AngersZhuuuu&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/37436&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/37436&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17576730" author="apachespark" created="Mon, 8 Aug 2022 12:00:56 +0000"  >&lt;p&gt;User &apos;AngersZhuuuu&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/37436&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/37436&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 14 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z17g4w:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>