<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:29:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-38309] SHS has incorrect percentiles for shuffle read bytes and shuffle total blocks metrics</title>
                <link>https://issues.apache.org/jira/browse/SPARK-38309</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;&lt;b&gt;Background&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;In &lt;a href=&quot;https://github.com/apache/spark/pull/26508&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this PR&lt;/a&gt; (&lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26260&quot; title=&quot;Task Summary Metrics for Stage Page: Efficient implementation for SHS when using disk store.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26260&quot;&gt;&lt;del&gt;SPARK-26260&lt;/del&gt;&lt;/a&gt;) the SHS stage metric percentiles were updated to only include successful tasks when using disk storage. It did this by making the values for each metric negative when the task is not in a successful state. This approach was chosen to avoid breaking changes to disk storage. See &lt;a href=&quot;https://github.com/apache/spark/pull/26508#issuecomment-554540314&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this comment&lt;/a&gt; for context.&lt;/p&gt;

&lt;p&gt;To get the percentiles, it reads the metric values, starting at 0, in ascending order. This filters out all tasks that are not successful because the values are less than 0. To get the percentile values it scales the percentiles to the list index of successful tasks. For example if there are 200 tasks and you want percentiles &lt;span class=&quot;error&quot;&gt;&amp;#91;0, 25, 50, 75, 100&amp;#93;&lt;/span&gt; the lookup indexes in the task collection are &lt;span class=&quot;error&quot;&gt;&amp;#91;0, 50, 100, 150, 199&amp;#93;&lt;/span&gt;.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Issue&lt;/b&gt;&lt;br/&gt;
For metrics 1) shuffle total reads and 2) shuffle total blocks, the above PR incorrectly makes the metric indices positive. This means tasks that are not successful are included in the percentile calculations. The percentile lookup index calculation is still based on the number of successful task so the wrong task metric is returned for a given percentile. This was not caught because the unit test only verified values for one metric, executorRunTime.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Steps to Reproduce&lt;/b&gt;&lt;br/&gt;
&lt;em&gt;SHS UI&lt;/em&gt;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Find a spark application in the SHS that has failed tasks for a stage with shuffle read.&lt;/li&gt;
	&lt;li&gt;Navigate to the stage UI.&lt;/li&gt;
	&lt;li&gt;Look at the max shuffle read size in the summary metrics&lt;/li&gt;
	&lt;li&gt;Sort the tasks by shuffle read size descending. You&apos;ll see it doesn&apos;t match step 3.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13040393/13040393_image-2022-02-23-14-19-33-255.png&quot; height=&quot;389&quot; width=&quot;789&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;API&lt;/em&gt;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;For the same stage in the above repro steps, make a request to the task summary endpoint (e.g. /api/v1/applications/application_1632281309592_21294517/1/stages/6/0/taskSummary?quantiles=0,0.25,0.5,0.75,1.0)&lt;/li&gt;
	&lt;li&gt;Look at the shuffleReadMetrics.readBytes and shuffleReadMetrics.totalBlocksFetched. You will see -2 for at least some of the lower percentiles and the positive values will also be wrong.&lt;/li&gt;
&lt;/ol&gt;
</description>
                <environment></environment>
        <key id="13430301">SPARK-38309</key>
            <summary>SHS has incorrect percentiles for shuffle read bytes and shuffle total blocks metrics</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="robreeves">Rob Reeves</assignee>
                                    <reporter username="robreeves">Rob Reeves</reporter>
                        <labels>
                            <label>correctness</label>
                    </labels>
                <created>Wed, 23 Feb 2022 22:18:40 +0000</created>
                <updated>Tue, 8 Mar 2022 18:46:06 +0000</updated>
                            <resolved>Tue, 8 Mar 2022 18:46:06 +0000</resolved>
                                    <version>3.1.0</version>
                                    <fixVersion>3.1.3</fixVersion>
                    <fixVersion>3.3.0</fixVersion>
                    <fixVersion>3.2.2</fixVersion>
                                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17497076" author="apachespark" created="Wed, 23 Feb 2022 23:56:13 +0000"  >&lt;p&gt;User &apos;robreeves&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/35637&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/35637&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17497077" author="apachespark" created="Wed, 23 Feb 2022 23:57:31 +0000"  >&lt;p&gt;User &apos;robreeves&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/35637&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/35637&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17503121" author="mridulm80" created="Tue, 8 Mar 2022 18:46:06 +0000"  >&lt;p&gt;Issue resolved by pull request 35637&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/35637&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/35637&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13040393" name="image-2022-02-23-14-19-33-255.png" size="159215" author="robreeves" created="Wed, 23 Feb 2022 22:19:34 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 36 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0zvxs:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>