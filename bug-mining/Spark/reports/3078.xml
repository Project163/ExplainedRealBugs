<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:37:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-13101] Dataset complex types mapping to DataFrame  (element nullability) mismatch</title>
                <link>https://issues.apache.org/jira/browse/SPARK-13101</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;There seems to be a regression between 1.6.0 and 1.6.1 (snapshot build). By default a scala &lt;tt&gt;Seq[Double]&lt;/tt&gt; is mapped by Spark as an ArrayType with nullable element&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; |-- valuations: array (nullable = true)
 |    |-- element: double (containsNull = true)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This could be read back to as a Dataset in Spark 1.6.0&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    val df = sqlContext.table(&lt;span class=&quot;code-quote&quot;&gt;&quot;valuations&quot;&lt;/span&gt;).as[Valuation]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;But with Spark 1.6.1 the same fails with&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    val df = sqlContext.table(&lt;span class=&quot;code-quote&quot;&gt;&quot;valuations&quot;&lt;/span&gt;).as[Valuation]

org.apache.spark.sql.AnalysisException: cannot resolve &lt;span class=&quot;code-quote&quot;&gt;&apos;&lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(valuations as array&amp;lt;&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;&amp;gt;)&apos;&lt;/span&gt; due to data type mismatch: cannot &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt; ArrayType(DoubleType,&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) to ArrayType(DoubleType,&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Here&apos;s the classes I am using&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Valuation(tradeId : &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;,
                     counterparty: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;,
                     nettingAgreement: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;,
                     wrongWay: &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;,
                     valuations : Seq[&lt;span class=&quot;code-object&quot;&gt;Double&lt;/span&gt;], &lt;span class=&quot;code-comment&quot;&gt;/* one per scenario */&lt;/span&gt;
                     timeInterval: Int,
                     jobId: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;)  &lt;span class=&quot;code-comment&quot;&gt;/* used &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; hdfs partitioning */&lt;/span&gt;

val vals : Seq[Valuation] = Seq()
val valsDF = sqlContext.sparkContext.parallelize(vals).toDF
valsDF.write.partitionBy(&lt;span class=&quot;code-quote&quot;&gt;&quot;jobId&quot;&lt;/span&gt;).mode(SaveMode.Overwrite).saveAsTable(&lt;span class=&quot;code-quote&quot;&gt;&quot;valuations&quot;&lt;/span&gt;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;even the following gives the same result&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;val valsDF = vals.toDS.toDF
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12935342">SPARK-13101</key>
            <summary>Dataset complex types mapping to DataFrame  (element nullability) mismatch</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cloud_fan">Wenchen Fan</assignee>
                                    <reporter username="deenar">Deenar Toraskar</reporter>
                        <labels>
                    </labels>
                <created>Sat, 30 Jan 2016 08:58:03 +0000</created>
                <updated>Mon, 8 Feb 2016 20:06:28 +0000</updated>
                            <resolved>Mon, 8 Feb 2016 20:06:12 +0000</resolved>
                                    <version>1.6.1</version>
                                    <fixVersion>1.6.1</fixVersion>
                    <fixVersion>2.0.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                                                                                <comments>
                            <comment id="15125084" author="joshrosen" created="Sat, 30 Jan 2016 21:23:01 +0000"  >&lt;p&gt;I&apos;m temporarily marking this as a 1.6.1 blocker so that we make sure to investigate and triage before cutting an RC. /cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=marmbrus&quot; class=&quot;user-hover&quot; rel=&quot;marmbrus&quot;&gt;marmbrus&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15126678" author="marmbrus" created="Mon, 1 Feb 2016 18:05:24 +0000"  >&lt;p&gt;/cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lian+cheng&quot; class=&quot;user-hover&quot; rel=&quot;lian cheng&quot;&gt;lian cheng&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cloud_fan&quot; class=&quot;user-hover&quot; rel=&quot;cloud_fan&quot;&gt;cloud_fan&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15126890" author="lian cheng" created="Mon, 1 Feb 2016 19:42:42 +0000"  >&lt;p&gt;I think this is expected behavior. The problem in snippet mentioned in the JIRA description is that it tries to convert a nullable DataFrame field into a non-nullable Dataset field, which shouldn&apos;t be allowed. This can be further illustrated by the following spark-shell snippet:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;// Converting non-nullable DF field to nullable DS field, OK
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Rec(a: Array[&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;])
val df = Seq(Array(0)).map(Tuple1(_)).toDF(&lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;)
df.printSchema
df.as[Rec]

&lt;span class=&quot;code-comment&quot;&gt;// Converting nullable DF field to non-nullable DS field, failure
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Rec(a: Array[Int])
val df = Seq(Array(0: &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;)).map(Tuple1(_)).toDF(&lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;)
df.printSchema
df.as[Rec]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15126894" author="lian cheng" created="Mon, 1 Feb 2016 19:45:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=deenar&quot; class=&quot;user-hover&quot; rel=&quot;deenar&quot;&gt;deenar&lt;/a&gt; I also tried the last two snippets you provided and they both work. Maybe the issue you hit has already been fixed in branch-1.6? The commit I was using is &lt;a href=&quot;https://github.com/apache/spark/commit/96e32db5cbd1ef32f65206357bfb8d9f70a06d0a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/commit/96e32db5cbd1ef32f65206357bfb8d9f70a06d0a&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15126932" author="lian cheng" created="Mon, 1 Feb 2016 20:09:07 +0000"  >&lt;p&gt;The reason why 1.6.0 allows this illegal situation is that we didn&apos;t do nullability check there.&lt;/p&gt;

&lt;p&gt;Another tricky thing here is about Parquet. When writing Parquet files, all non-nullable fields are converted to nullable fields intentionally. This behavior is for better interoperability with Hive. So in your case, after writing the &lt;tt&gt;Valuation&lt;/tt&gt; records into a Parquet file and then reading them back, the &lt;tt&gt;valuations&lt;/tt&gt; field becomes a nullable array. One possible workaround for your use case is to use &lt;tt&gt;Seq[java.lang.Double]&lt;/tt&gt; for the &lt;tt&gt;valuations&lt;/tt&gt; field.&lt;/p&gt;</comment>
                            <comment id="15126976" author="deenar" created="Mon, 1 Feb 2016 20:32:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lian+cheng&quot; class=&quot;user-hover&quot; rel=&quot;lian cheng&quot;&gt;lian cheng&lt;/a&gt; Thanks for the explanation now makes sense. But I would like to warn you that this is going cause a lot of issues to people who are migrating from Datasets to Dataframes, given that Parquet is the most widely used format with SparkSQL.  A better option would be to change the behaviour of Parquet writer too. I would hate to use java primitives every time I want a non-nullable field in my model classes.&lt;/p&gt;

&lt;p&gt;I guess the root cause is the decision in the Parquet writer to convert all non-nullable fields to nullable fields. I know there have been discussions about this before, but many times the nullability of the field has functional impact. &lt;br/&gt;
&amp;gt;&amp;gt; Another tricky thing here is about Parquet. When writing Parquet files, all non-nullable fields are converted to nullable fields intentionally. This behavior is for better interoperability with Hive.&lt;/p&gt;

&lt;p&gt;I think you should do what is correct.&lt;/p&gt;</comment>
                            <comment id="15126982" author="deenar" created="Mon, 1 Feb 2016 20:36:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lian+cheng&quot; class=&quot;user-hover&quot; rel=&quot;lian cheng&quot;&gt;lian cheng&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=joshrosen&quot; class=&quot;user-hover&quot; rel=&quot;joshrosen&quot;&gt;joshrosen&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=marmbrus&quot; class=&quot;user-hover&quot; rel=&quot;marmbrus&quot;&gt;marmbrus&lt;/a&gt;&lt;br/&gt;
Alternatively could we have a option supported by the Parquet writer that turns the non-nullable to nullable conversion off. This would satisfy my requirements and would be cleaner too.&lt;/p&gt;

&lt;p&gt;&amp;gt;&amp;gt; Another tricky thing here is about Parquet. When writing Parquet files, all non-nullable fields are converted to nullable fields intentionally. This behavior is for better interoperability with Hive&lt;/p&gt;</comment>
                            <comment id="15127021" author="lian cheng" created="Mon, 1 Feb 2016 21:02:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=deenar&quot; class=&quot;user-hover&quot; rel=&quot;deenar&quot;&gt;deenar&lt;/a&gt; Just had an offline discussion with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=marmbrus&quot; class=&quot;user-hover&quot; rel=&quot;marmbrus&quot;&gt;marmbrus&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cloud_fan&quot; class=&quot;user-hover&quot; rel=&quot;cloud_fan&quot;&gt;cloud_fan&lt;/a&gt;. At last, we agreed that nullability should only be considered as an optimization rather than part of the type system. So in your case, this kind of conversion should be allowed as long as the underlying data doesn&apos;t really contain nulls. So the proposed changes are:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Allow converting nullable DF fields to non-nullable DS fields&lt;/li&gt;
	&lt;li&gt;Add runtime nullability check for array fields and map fields (currently we only do the runtime nullability check for product type fields)&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;And I like the idea of adding an option to disable the non-nullable-to-nullable Parquet writer conversion behavior, but that can be tracked by another ticket.&lt;/p&gt;</comment>
                            <comment id="15129347" author="apachespark" created="Tue, 2 Feb 2016 23:37:03 +0000"  >&lt;p&gt;User &apos;cloud-fan&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/11035&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/11035&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15129649" author="apachespark" created="Wed, 3 Feb 2016 02:32:05 +0000"  >&lt;p&gt;User &apos;cloud-fan&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/11042&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/11042&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15131429" author="marmbrus" created="Thu, 4 Feb 2016 00:13:39 +0000"  >&lt;p&gt;Issue resolved by pull request 11042&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/11042&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/11042&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15137581" author="marmbrus" created="Mon, 8 Feb 2016 20:06:12 +0000"  >&lt;p&gt;Issue resolved by pull request 11035&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/11035&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/11035&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 41 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2s6q7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12334009">1.6.1</customfieldvalue>
    <customfieldvalue id="12329449">2.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>