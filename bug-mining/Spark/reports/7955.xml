<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:26:18 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-35486] MemoryConsumer reservations that trigger a partial self-spill can fail even if memory is available</title>
                <link>https://issues.apache.org/jira/browse/SPARK-35486</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;When a memory reservation triggers a self-spill, ExecutionMemoryPool#releaseMemory() will immediately notify waiting tasks that memory has been freed. If there are any waiting tasks with less than 1/2N of the memory pool, they may acquire the newly-freed memory before the current task has a chance to do so. This will cause the original memory reservation to fail. If the initial spill did not release all available memory, the reservation could have been satisfied by asking it to spill again.&lt;/p&gt;

&lt;p&gt;For example, the following test fails when added to MemoryManagerSuite:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-scala&quot;&gt;
test(&lt;span class=&quot;code-quote&quot;&gt;&quot;SPARK-35486: memory freed by self-spilling is taken by another task&quot;&lt;/span&gt;) {
    &lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; memoryManager = createMemoryManager(1000L)
    &lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; t1MemManager = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TaskMemoryManager(memoryManager, 1)
    &lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; t2MemManager = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TaskMemoryManager(memoryManager, 2)
    &lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; c1 = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TestPartialSpillingMemoryConsumer(t1MemManager)
    &lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; c2 = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TestMemoryConsumer(t2MemManager)
    &lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; futureTimeout: Duration = 20.seconds

    &lt;span class=&quot;code-comment&quot;&gt;// t1 acquires 1000 bytes. This should succeed immediately.
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; t1Result1 = Future { c1.acquireMemory(1000L) }
    assert(ThreadUtils.awaitResult(t1Result1, futureTimeout) === 1000L)
    assert(c1.getUsed() === 1000L)

    &lt;span class=&quot;code-comment&quot;&gt;// t2 attempts to acquire 500 bytes. This should block since there is no memory available.
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; t2Result1 = Future { c2.acquireMemory(500L) }
    Thread.sleep(300)
    assert(!t2Result1.isCompleted)
    assert(c2.getUsed() === 0L)

    &lt;span class=&quot;code-comment&quot;&gt;// t1 attempts to acquire 500 bytes, causing its existing reservation to spill partially. t2 is
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// first in line &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the freed memory.
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;//
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// SPARK-35486: This currently causes the reservation to fail. Instead, t1 should &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; again,
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// causing the rest of the reservation to spill.
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; t1Result2 = Future { c1.acquireMemory(500L) }

    &lt;span class=&quot;code-comment&quot;&gt;// The spill should release enough memory &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; both t1&apos;s and t2&apos;s reservations to be satisfied.
&lt;/span&gt;    assert(ThreadUtils.awaitResult(t2Result1, futureTimeout) === 500L)
    &lt;span class=&quot;code-comment&quot;&gt;// SPARK-35486: This assertion fails: 0L != 500L.
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// assert(ThreadUtils.awaitResult(t1Result2, futureTimeout) === 500L)
&lt;/span&gt;  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
/**
 * A TestMemoryConsumer which, when asked to spill, releases only enough memory to satisfy the
 * request rather than releasing all its memory.
 */
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;TestPartialSpillingMemoryConsumer &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; TestMemoryConsumer {
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; TestPartialSpillingMemoryConsumer(TaskMemoryManager memoryManager, MemoryMode mode) {
    &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;(memoryManager, mode);
  }
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; TestPartialSpillingMemoryConsumer(TaskMemoryManager memoryManager) {
    &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;(memoryManager);
  }

  @Override
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; spill(&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; size, MemoryConsumer trigger) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
    &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; used = getUsed();
    &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; released = &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.min(used, size);
    free(released);
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; released;
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13379839">SPARK-35486</key>
            <summary>MemoryConsumer reservations that trigger a partial self-spill can fail even if memory is available</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ankurd">Ankur Dave</assignee>
                                    <reporter username="ankurd">Ankur Dave</reporter>
                        <labels>
                    </labels>
                <created>Fri, 21 May 2021 18:58:34 +0000</created>
                <updated>Wed, 26 May 2021 07:20:11 +0000</updated>
                            <resolved>Tue, 25 May 2021 10:14:34 +0000</resolved>
                                    <version>2.4.8</version>
                    <version>3.0.2</version>
                    <version>3.1.1</version>
                                    <fixVersion>3.2.0</fixVersion>
                                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17349455" author="apachespark" created="Fri, 21 May 2021 19:40:52 +0000"  >&lt;p&gt;User &apos;ankurdave&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/32625&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/32625&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17350948" author="ngone51" created="Tue, 25 May 2021 10:14:34 +0000"  >&lt;p&gt;Issue resolved by&#160;&lt;a href=&quot;https://github.com/apache/spark/pull/32625&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/32625&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17351581" author="apachespark" created="Wed, 26 May 2021 07:19:26 +0000"  >&lt;p&gt;User &apos;gengliangwang&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/32672&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/32672&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17351583" author="apachespark" created="Wed, 26 May 2021 07:20:11 +0000"  >&lt;p&gt;User &apos;gengliangwang&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/32672&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/32672&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 24 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0r9rk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>